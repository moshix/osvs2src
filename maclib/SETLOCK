*%/*                                                                    00050002
         MACRO                                                          00100002
&NAME    SETLOCK &REQUEST,&TYPE=,&ADDR=,&MODE=,&DISABLE,&RELATED=,     X00150002
               &REGS=,&BRANCH=                                          00200002
         GBLC  &MESSAGE                                                 00250002
         LCLA   &INDEX,&INDEX0                                          00300002
         LCLA  &OFSET,&MASK,&BYTE,&I                                    00302002
         LCLB  &ADVALID,&COND(4)                                        00304002
         LCLB  &TYPEREG                                                 00304402
         LCLC  &MESSAG2,&REG,&RADDR,&BRADR(4)                           00306002
         LCLC  &INSTR,&AREA                                             00308002
         AIF   ('&REQUEST' EQ 'TEST').TEST                              00310002
&INDEX   SETA  0                                                        00350002
         AIF   (T'&RELATED NE 'O').RELATED                              00400002
.*       IHB001  RELATED OPERAND REQUIRED, NOT SPECIFIED                00450002
         IHBERMAC 1006,RELATED                                          00500002
         MEXIT                                                          00550002
.RELATED ANOP                                                           00600002
         AIF   (T'&BRANCH EQ 'O').NOBRNAM                               00610002
.*       IHB280 BRANCH INVALID WITH OBTAIN/RELEASE                      00620002
         IHBERMAC 1020,BRANCH,&REQUEST                                  00630002
         MEXIT                                                          00640002
.NOBRNAM ANOP                                                           00642002
         AIF   ('&REQUEST' EQ 'OBTAIN').OBTAIN                          00650002
         AIF   ('&REQUEST' EQ 'RELEASE').RELEASE                        00700002
         IHBERMAC 24                                                    00750002
         MEXIT                                                          00800002
.OBTAIN  AIF   ('&DISABLE' EQ '').OBTAIN2                               00850002
         AIF   ('&DISABLE' NE 'DISABLED').ERROD                         00860002
.OBTAIN2 ANOP                                                           00870002
         AIF   ('&MODE' EQ 'COND').COND      COND REQUIRES NO INCREMENT 00900002
         AIF   ('&MODE' EQ 'UNCOND').UNCOND                             00950002
         AIF   ('&MODE' NE '').MODERR                                   01000002
.*       IHB001  MODE OPERAND REQUIRED, NOT SPECIFIED                   01050002
         IHBERMAC 1006,MODE                                             01100002
         MEXIT                                                          01150002
.MODERR  ANOP                                                           01200002
.*       IHB002  INVALID MODE OPERAND SPECIFIED - XXX                   01250002
               IHBERMAC 1001,MODE,&MODE                                 01300002
         MEXIT                                                          01350002
.ERROD   ANOP                                                           01400002
         AIF   ('&DISABLE' EQ 'DISABLED').ERROD1                        01450002
.*       IHB244  INVALID POSIT-NL XXX OPERAND                           01500002
.INVLDIS IHBERMAC 1008,&DISABLE,1                                       01550002
         MEXIT                                                          01600002
.ERROD1  ANOP                                                           01650002
&MESSAGE SETC  'COND OR SUSPEND LOCK OBTAIN'                            01670002
.*       IHB280  DISABLE INVALID WITH COND OR SUSPEND LOCK OBTAIN       01700002
         IHBERMAC 1020,&DISABLE,&MESSAGE                                01750002
         MEXIT                                                          01800002
.UNCOND  ANOP                                                           01850002
&INDEX   SETA  (&INDEX+12)              INCREMENT TO UNCOND OBTAIN      01900002
         AGO   .REGS                                                    01950002
.RELEASE AIF   ('&MODE' NE '').ERRMOD                                   02000002
         AIF   ('&DISABLE' EQ 'DISABLED').TESTSUP  TEST FOR SUSPEND REQ 02050002
         AIF   ('&DISABLE' EQ '').RELSE                                 02100002
.*       IHB244  INVALID POSIT-NL XXX OPERAND                           02150002
         IHBERMAC 1008,&DISABLE,1                                       02200002
         MEXIT                                                          02250002
.ERRMOD  ANOP                                                           02300002
.*       IHB280               MODE INVALID WITH RELEASE                 02350002
         IHBERMAC 1020,MODE,RELEASE                                     02400002
         MEXIT                                                          02450002
.RELSE   ANOP                                                           02500002
&INDEX   SETA  (&INDEX+24)              INCREMENT TO RELEASE W/O DISBLE 02550002
         AGO   .REGS                                                    02600002
.TESTSUP AIF   ('&TYPE' EQ 'CMS').ERRDIS                                02650002
         AIF   ('&TYPE' EQ 'LOCAL').ERRDIS                              02700002
&INDEX   SETA  (&INDEX+36)              INCREMENT TO RELEASE DISABLE    02750002
         AGO   .REGS                                                    02800002
.ERRDIS  ANOP                                                           02850002
.*       IHB280  DISABLE INVALID WITH CMS/LOCAL                         02900002
         IHBERMAC 1020,&DISABLE,&TYPE                                   02950002
         MEXIT                                                          03000002
.COND    ANOP                                                           03010002
         AIF   ('&DISABLE' NE '').ERROD                                 03020002
.REGS    ANOP                                                           03050002
         AIF   ('&REGS' EQ 'SAVE').TYPE SAVE IS VALID PARAMETER         03100002
         AIF   ('&REGS' EQ 'USE').TYPE  USE IS VALID PARAMETER          03150002
         AIF   ('&REGS' EQ '').TYPE     PARAMETER IS NOT REQUIRED       03200002
.*       IHB002 INVALID REGS OPERAND SPECIFIED - XXX                    03250002
         IHBERMAC 1001,REGS,&REGS                                       03300002
         MEXIT                                                          03350002
.TYPE    ANOP                                                           03400002
&INDEX0  SETA  &INDEX                                                   03410002
         AIF   ('&TYPE' EQ 'DISP').CODE HIGHEST LOCK INCREMENT NOT REQD 03450002
&INDEX   SETA  (&INDEX+48)              INCREMENT FOR 1 SPIN LOCK ENTRY 03500002
         AIF   ('&TYPE' EQ 'IOSCAT').CODEA                              03550002
&INDEX   SETA  (&INDEX+48)                                              03600002
         AIF   ('&TYPE' EQ 'IOSUCB').CODEA                              03650002
&INDEX   SETA  (&INDEX+48)                                              03700002
         AIF   ('&TYPE' EQ 'IOSLCH').CODEA                              03750002
&INDEX   SETA  (&INDEX+48)                                              03800002
         AIF   ('&TYPE' EQ 'IOSYNCH').CODEA                             03850002
&INDEX   SETA  (&INDEX+48)                                              03900002
         AIF   ('&TYPE' EQ 'TPNCB').CODEA                               03950002
&INDEX   SETA  (&INDEX+48)                                              04000002
         AIF   ('&TYPE' EQ 'TPDNCB').CODEA                              04050002
&INDEX   SETA  (&INDEX+48)                                              04100002
         AIF   ('&TYPE' EQ 'TPACBDEB').CODEA                            04150002
&INDEX   SETA  (&INDEX+48)                                              04200002
         AIF   ('&TYPE' EQ 'ASM').CODEA                                 04250002
&INDEX   SETA  (&INDEX+48)                                              04300002
         AIF   ('&TYPE' EQ 'SALLOC').CODE                               04350002
&INDEX   SETA  (&INDEX+48)                                              04400002
         AIF   ('&TYPE' EQ 'SRM').CODE                                  04410002
&INDEX   SETA  (&INDEX+48)                                              04500002
         AIF   ('&TYPE' EQ 'CMS').CODE                                  04550002
&INDEX   SETA  (&INDEX+36)                                              04600002
         AIF   ('&TYPE' EQ 'LOCAL').CODE                                04650002
&INDEX   SETA  &INDEX+36-&INDEX0                                        04660002
         AIF   ('&REQUEST' NE 'RELEASE').BADTYPE                        04670002
         AIF   (T'&ADDR NE 'O').ERRADD                                  04672002
         AIF   ('&TYPE' EQ 'SPIN').RSPIN                                04680002
         AIF   ('&TYPE' EQ 'ALL').RALL                                  04690002
         AIF   ('&TYPE'(1,1) NE '(').BADTYPE                            04692002
         AIF   ('&TYPE'(K'&TYPE,1) EQ ')').RREG                         04694002
.BADTYPE AIF   ('&TYPE' NE '').INVTYP                                   04700002
.*       IHB001 TYPE OPERAND REQUIRED NOT SPECIFIED                     04750002
         IHBERMAC 1006,TYPE                                             04800002
         MEXIT                                                          04850002
.INVTYP  ANOP                                                           04900002
.*       IHB002  INVALID TYPE OPERAND SPECIFIED                         04950002
         IHBERMAC 1001,TYPE,&TYPE                                       05000002
         MEXIT                                                          05050002
.CODE    AIF   ('&ADDR' NE '').ERRADD                                   05100002
         AIF   ('&REGS' EQ 'SAVE').SAVE1                                05150002
         AIF   ('&REGS' EQ 'USE').USE1                                  05200002
&NAME    L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 05250002
         AIF   ('&TYPE' EQ 'LOCAL').LOAD                                05270002
         LM    11,13,&INDEX.(13)        LOAD ADDRESS OF THE LOCKWORD,   05300002
*                                       CLHT AND LOCK RTNS ENTRY POINT  05350002
         AGO   .MNLCODE                                                 05400002
.SAVE1   ANOP                                                           05450002
&NAME    LR    15,13                    LOAD SAVE AREA ADDRESS          05500002
         STM   11,14,0(15)              SAVE REGISTERS                  05550002
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 05600002
         AIF   ('&TYPE' EQ 'LOCAL').LOAD                                05620002
         LM    11,13,&INDEX.(13)        LOAD ADDRESS OF THE LOCKWORD,   05650002
*                                       CLHT AND LOCK RTNS ENTRY POINT  05700002
         AGO   .MNLCODE                                                 05750002
.USE1    ANOP                                                           05800002
&NAME    LR    15,11                    SAVE REGISTER 11                05850002
         LR    0,12                     SAVE REGISTER 12                05900002
         LR    1,13                     SAVE REGISTER 13                05950002
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 06000002
         AIF   ('&TYPE' EQ 'LOCAL').LOAD                                06020002
         LM    11,13,&INDEX.(13)        LOAD ADDRESS OF THE LOCKWORD,   06050002
*                                       CLHT AND LOCK RTNS ENTRY POINT  06100002
         AGO   .MNLCODE                                                 06150002
.LOAD    ANOP                                                           06160002
&INDEX   SETA  (&INDEX+8)                                               06170002
         L     13,&INDEX.(0,13)        LOAD ADDRESS OF LOCK RTN         06180002
         AGO   .MNLCODE                                                 06190002
.ERRADD  ANOP                                                           06200002
.*       IHB280 ADDR INVALID WITH TYPE=XXX                              06250002
&MESSAGE SETC  'TYPE='.'&TYPE'                                          06300002
         IHBERMAC 1020,ADDR,&MESSAGE                                    06350002
         MEXIT                                                          06400002
.CODEA   ANOP                                                           06450002
&INDEX   SETA  (&INDEX+4)     INCREMENT PAST LK ADDR                    06500002
         AIF   ('&ADDR' EQ '(11)').MR11 LOCKWORD ADDRESS ALREADY LOADED 06550002
         AIF   ('&ADDR' NE '').ADRLA                                    06600002
.*       IHB001 ADDR OPERAND REQUIRED NOT SPECIFIED                     06650002
         IHBERMAC 1006,ADDR                                             06700002
         MEXIT                                                          06750002
.ERREG1  ANOP                                                           06800002
&MESSAGE SETC  'REGISTER NOTATION'                                      06850002
.*       IHB280 REGISTER NOTATION INVALID WITH ADDR                     06900002
         IHBERMAC 1020,&MESSAGE,ADDR                                    06950002
         MEXIT                                                          07000002
.ADRLA   ANOP                                                           07050002
         AIF   ('&ADDR'(1,1) EQ '(').ERREG1                             07100002
         AIF   ('&REGS' EQ 'SAVE').SAVE2                                07150002
         AIF   ('&REGS' EQ 'USE').USE2                                  07200002
&NAME    LA    11,&ADDR                 LOCKWORD ADDRESS                07250002
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 07300002
         LM    12,13,&INDEX.(13)        LOAD CLHT & ENTRY POINT ADDRESS 07350002
         AGO   .MNLCODE                                                 07400002
.SAVE2   ANOP                                                           07450002
&NAME    LR    15,13                    LOAD SAVE AREA ADDRESS          07500002
         STM   11,14,0(15)              SAVE REGISTERS                  07550002
         LA    11,&ADDR                 LOCKWORD ADDRESS                07600002
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 07650002
         LM    12,13,&INDEX.(13)        LOAD LOCKWORD AND CLHT ADDRESS  07700002
         AGO   .MNLCODE                                                 07750002
.USE2    ANOP                                                           07800002
&NAME    LR    15,11                    SAVE REGISTER 11                07850002
         LR    0,12                     SAVE REGISTER 12                07900002
         LR    1,13                     SAVE REGISTER 13                07950002
         LA    11,&ADDR                 LOCKWORD ADDRESS                08000002
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 08050002
         LM    12,13,&INDEX.(13)        LOAD LOCKWORD AND CLHT ADDRESS  08100002
         AGO   .MNLCODE                                                 08150002
.MR11    ANOP                                                           08200002
         AIF   ('&REGS' EQ 'SAVE').SAVE3                                08250002
         AIF   ('&REGS' EQ 'USE').USE3                                  08300002
&NAME    L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 08350002
         LM    12,13,&INDEX.(13)        LOAD CLHT & ENTRY POINT ADDRESS 08400002
         AGO   .MNLCODE                                                 08450002
.SAVE3   ANOP                                                           08500002
&NAME    LR    15,13                    LOAD SAVE AREA ADDRESS          08550002
         STM   11,14,0(15)              SAVE REGISTERS                  08600002
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 08650002
         LM    12,13,&INDEX.(13)        LOAD LOCKWORD AND CLHT ADDRESS  08700002
         AGO   .MNLCODE                                                 08750002
.USE3    ANOP                                                           08800002
&NAME    LR    15,11                    SAVE REGISTER 11                08850002
         LR    0,12                     SAVE REGISTER 12                08900002
         LR    1,13                     SAVE REGISTER 13                08950002
         L     13,PSALITA-FLC(0,0)      ADDRESS OF LOCK INTERFACE TABLE 09000002
         LM    12,13,&INDEX.(13)        LOAD LOCKWORD AND CLHT ADDRESS  09050002
.MNLCODE ANOP                                                           09100002
         AIF   ('&MODE' EQ 'UNCOND').BALCK                              09110002
.MNLCOD2 ANOP                                                           09120002
         BALR  14,13                    BRANCH ENTER LOCK ROUTINE       09150002
.MNLCOD3 ANOP                                                           09170002
         AIF   ('&REGS' EQ 'SAVE').SAVE4                                09200002
         AIF   ('&REGS' NE 'USE').ENDIT                                 09250002
         LR    11,15                    RESTORE REGISTER 11             09300002
         LR    15,13                    PUT RETURN CODE IN REGISTER 15  09350002
         LR    12,0                     RESTORE REGISTER 12             09400002
         LR    13,1                     RESTORE REGISTER 13             09450002
         AGO   .ENDIT                                                   09500002
.BALCK   ANOP                                                           09506002
         AIF   ('&DISABLE' EQ '').MNLCOD2                               09512002
         AIF   ('&TYPE' EQ 'LOCAL').ERROD1                              09518002
         AIF   ('&TYPE' EQ 'CMS').ERROD1                                09524002
         BAL   14,4(0,13)              BRANCH TO LOCK RTN AT DIS ENTRY  09530002
*        NOTE: YOU HAVE JUST SAID THAT YOU ARE DISABLED                 09536002
         AGO   .MNLCOD3                                                 09542002
.SAVE4   ST    13,16(0,15)              STORE RETURN CODE               09550002
         LM    11,15,0(15)              RESTORE REGS - RC IN REG 15     09600002
         MEXIT                                                          09610002
.RALL    ANOP                                                           09660002
         AIF   ('&NAME' EQ '').RALLNN                                   09670002
&NAME    DC    0H'0'                                                    09670602
.RALLNN  AIF   (T'&REGS EQ 'O').RCMS                                    09680602
         AIF   ('&REGS' EQ 'SAVE').RALLS                                09690602
         LR    15,11              SAVE REG11                            09692602
         LR    0,12               SAVE REG12                            09693002
         LR    1,13               SAVE REG13                            09693402
         AGO   .RCMS                                                    09693502
.RALLS   ANOP                                                           09693602
         LR    15,13              SAVE AREA ADDRESS                     09693702
         STM   11,14,0(15)        SAVE REG11 THRU R14                   09693802
.RCMS    ANOP                                                           09694102
         TM    PSAHLHI-FLC+3(0),2       IS CMS LOCK HELD?      @ZA35343 09694503
         BZ    IHB&SYSNDX.A       NO: SKIP CMS LOCK RELEASE             09694703
         SETLOCK RELEASE,TYPE=CMS,RELATED=&RELATED                      09694903
IHB&SYSNDX.A DC   0H'0'                                                 09695103
         TM    PSAHLHI-FLC+3(0),1       IS LOCAL LOCK HELD?    @ZA35343 09695303
         BZ    IHB&SYSNDX.B       NO: SKIP LOCAL LOCK RELEASE           09696002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=&RELATED                    09696402
IHB&SYSNDX.B DC   0H'0'                                                 09696802
         AGO   .RSPINC                                                  09696902
.RSPIN   ANOP                                                           09697002
         AIF   ('&NAME' EQ '').RSPINNN                                  09697102
&NAME    DC    0H'0'                                                    09697602
.RSPINNN AIF   (T'&REGS EQ 'O').RSPINC                                  09698002
         AIF   ('&REGS' EQ 'SAVE').RSPINS                               09698402
         LR    15,11              SAVE REG11                            09698802
         LR    0,12               SAVE REG12                            09698902
         LR    1,13               SAVE REG13                            09700702
         AGO   .RSPINC                                                  09702702
.RSPINS  ANOP                                                           09703102
         LR    15,13              SAVE AREA ADDRESS                     09703502
         STM   11,14,0(15)        SAVE REGS 11 THRU 14                  09703902
.RSPINC  ANOP                                                           09704302
         L     13,PSALITA-FLC(0,0) GET LOCK INTERFACE TABLE ADDR        09704402
         LM    11,13,&INDEX.(13)  GET PARM & EP ADDR FROM TABLE         09704502
         N     11,PSAHLHI-FLC(0,0)      KEEP ONLY SPIN LOCKS            09706703
*                                        HELD                  @ZA35343 09707403
         BZ    *+10               EXIT IF NONE HELD                     09708103
         AIF   (T'&DISABLE EQ 'O').RSPINE                               09708803
         AIF   ('&DISABLE' NE 'DISABLED').INVLDIS                       09709503
         MVI   PSAMPSW-FLC(0),X'00'     INDICATE RETURN                 09710203
*                                        DISABLED              @ZA35343 09710903
         AGO   .RSPINR                                                  09711603
.RSPINE  ANOP                                                           09712303
         MVI   PSAMPSW-FLC(0),X'03'     INDICATE RETURN                 09713003
*                                        ENABLED               @ZA35343 09713703
.RSPINR  ANOP                                                           09715202
         BALR  14,13              LINK TO LOCK MANAGER                  09715302
         AIF   (T'&REGS EQ 'O').RSPINX                                  09715502
         AIF   ('&REGS' EQ 'USE').RSPINU                                09715902
         LM    11,14,0(15)        RESTORE REGS 11 THRU 14               09716302
.RSPINX  MEXIT                                                          09716702
.RSPINU  ANOP                                                           09717102
         LR    11,15              RESTORE REG11                         09717202
         LR    12,0               RESTORE REG12                         09717302
         LR    13,1               RESTORE REG13                         09717502
         MEXIT                                                          09717902
.RREG    ANOP                                                           09827802
         AIF   ('&NAME' EQ '').RREGNN                                   09827902
&NAME    DC    0H'0'                                                    09828002
.RREGNN  AIF   (T'&REGS EQ 'O').RREGC                                   09828102
         AIF   ('&REGS' EQ 'SAVE').RREGS                                09828202
         LR    15,11              SAVE REG11                            09828302
         LR    0,12               SAVE REG12                            09828602
         LR    1,13               SAVE REG13                            09828702
         AGO   .RREGC                                                   09828802
.RREGS   ANOP                                                           09828902
         LR    15,13              SAVE AREA ADDRESS                     09829302
         STM   11,14,0(15)        SAVE REGS 11 THRU 14                  09829502
.RREGC   ANOP                                                           09829902
         LR    11,&TYPE(1)        PUT STRING IN PROPER REGISTER         09830002
         N     11,PSAHLHI-FLC(0,0)      ARE ALL SPECIFIED               09830103
*                                        LOCKS HELD?           @ZA35343 09830203
         CR    11,&TYPE(1)        COMPARE WITH INPUT                    09830603
         BE    IHB&SYSNDX.A       ALL ARE HELD: RELEASE                 09830703
         ABEND X'073',DUMP,,SYSTEM   NOT ALL HELD: ABEND                09830803
IHB&SYSNDX.A DC   0H'0'                                                 09830903
         LA    12,2               MASK TO CHECK FOR CMS                 09831003
         NR    12,&TYPE(1)        IS CMS RELEASE REQUESTED?             09831102
         BZ    IHB&SYSNDX.B       NO: GO TO CHECK FOR LOCAL             09831502
         SETLOCK RELEASE,TYPE=CMS,RELATED=&RELATED                      09831902
IHB&SYSNDX.B DC   0H'0'                                                 09832302
         LA    12,1               MASK TO CHECK FOR LOCAL               09832402
         NR    12,&TYPE(1)        IS LOCAL RELEASE REQUESTED?           09832502
         BZ    IHB&SYSNDX.C       NO: SKIP LOCAL RELEASE                09832602
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=&RELATED                    09832702
IHB&SYSNDX.C DC   0H'0'                                                 09833102
         L     13,PSALITA-FLC(0,0) GET LOCK INTERFACE TABLE ADDRESS     09833202
         LM    11,13,&INDEX.(13)  GET PARM & EP ADDR FROM TABLE         09833302
         NR    11,&TYPE(1)        ANY SPIN LOCK SPECIFIED?              09833402
         BZ    IHB&SYSNDX.D       NO: EXIT                              09833502
         AIF   (T'&DISABLE EQ 'O').RREGE                                09833602
         AIF   ('&DISABLE' NE 'DISABLED').INVLDIS                       09833702
         MVI   PSAMPSW-FLC(0),X'00'     INDICATE RETURN                 09833803
*                                        DISABLED              @ZA35343 09833903
         AGO   .RREGCMS                                                 09834003
.RREGE   ANOP                                                           09834103
         MVI   PSAMPSW-FLC(0),X'03'     INDICATE RETURN                 09834203
*                                        ENABLED               @ZA35343 09834303
.RREGCMS ANOP                                                           09834502
         BALR  14,13              LINK TO LOCK MANAGER                  09834602
IHB&SYSNDX.D DC    0H'0'                                                09834702
         AIF   (T'&REGS EQ 'O').RREGX                                   09834802
         AIF   ('&REGS' EQ 'USE').RREGU                                 09834902
         LM    11,14,0(15)        RESTORE REGS 11 THRU 14               09835002
.RREGX   MEXIT                                                          09835102
.RREGU   ANOP                                                           09835202
         LR    11,15              RESTORE REG11                         09835302
         LR    12,0               RESTORE REG12                         09835402
         LR    13,1               RESTORE REG13                         09835502
         MEXIT                                                          09835602
.TEST    ANOP                                                           09835702
         AIF   (T'&MODE EQ 'O').TSTDIS                                  09835802
.*       IHB280 MODE INVALID WITH TEST                                  09835902
         IHBERMAC 1020,MODE,TEST                                        09836002
         MEXIT                                                          09836102
.TSTDIS  AIF   (T'&DISABLE EQ 'O').TSTADR                               09836202
.*       IHB280 DISABLED INVALID WITH TEST                              09836302
         IHBERMAC 1020,DISABLED,TEST                                    09836402
         MEXIT                                                          09836502
.TSTADR  AIF   (T'&ADDR EQ 'O').TSTREG                                  09836602
         AIF   ('&ADDR'(1,1) NE '(').TSTBADR                            09836702
         AIF   ('&ADDR'(K'&ADDR,1) EQ ')').TSTREG                       09836802
.*       IHB002  INVALID ADDR OPERAND SPECIFIED- XXX                    09836902
.TSTBADR IHBERMAC 1001,ADDR,&ADDR                                       09837002
         MEXIT                                                          09837102
.TSTREG  AIF   (T'&REGS EQ 'O').TSTBR                                   09837202
         AIF   ('&REGS'(1,1) NE '(').TSTBREG                            09837302
         AIF   ('&REGS'(K'&REGS,1) EQ ')').TSTBR                        09837402
.*       IHB002  INVALID REGS OPERAND SPECIFIED- XXX                    09837502
.TSTBREG IHBERMAC 1001,REGS,&REGS                                       09837602
         MEXIT                                                          09837702
.TSTBR   AIF   (T'&BRANCH EQ 'O').TSTTYPE                               09837802
         AIF   (N'&BRANCH EQ 2).TSTCOND                                 09837902
.*       IHB247 INCORRECT NUMBER OF BRANCH VALUES                       09838002
.TINVBR  IHBERMAC 1012,BRANCH                                           09838102
         MEXIT                                                          09838202
.TSTCOND ANOP                                                           09838302
         AIF   ('&BRANCH(1)' EQ 'HELD').TSTTYPE                         09838402
         AIF   ('&BRANCH(1)' EQ 'NOTHELD').TSTTYPE                      09838502
.INVCOND ANOP                                                           09839002
.*       IHB002 INVALID BRANCH OPERAND SPECIFIED- XXX                   09839402
         IHBERMAC 1001,BRANCH,&BRANCH(1)                                09839702
         MEXIT                                                          09839802
.TSTTYPE ANOP                                                           09840002
         AIF   (T'&TYPE EQ 'O').ERTTYP                                  09850002
&BYTE    SETA  2                                                        09855902
&OFSET   SETA  0                                                        09856502
&MASK    SETA  16                                                       09857102
         AIF   ('&TYPE' EQ 'DISP').TNAMSYS                              09857702
&OFSET   SETA  &OFSET+4                                                 09858302
&MASK    SETA  &MASK/2                                                  09858902
         AIF   ('&TYPE' EQ 'ASM').TNAMC                                 09859502
&OFSET   SETA  &OFSET+4                                                 09860102
&MASK    SETA  &MASK/2                                                  09860702
         AIF   ('&TYPE' EQ 'SALLOC').TNAMSYS                            09861302
&OFSET   SETA  &OFSET+4                                                 09861902
&MASK    SETA  &MASK/2                                                  09862502
         AIF   ('&TYPE' EQ 'IOSYNCH').TNAMC                             09863102
&OFSET   SETA  &OFSET+4                                                 09863702
&MASK    SETA  &MASK/2                                                  09863802
         AIF   ('&TYPE' EQ 'IOSCAT').TNAMC                              09864002
&BYTE    SETA  3                                                        09880102
&OFSET   SETA  &OFSET+4                                                 09880202
&MASK    SETA  128                                                      09880302
         AIF   ('&TYPE' EQ 'IOSUCB').TNAMC                              09880602
&OFSET   SETA  &OFSET+4                                                 09886002
&MASK    SETA  &MASK/2                                                  09886102
         AIF   ('&TYPE' EQ 'IOSLCH').TNAMC                              09886402
&OFSET   SETA  &OFSET+4                                                 09888702
&MASK    SETA  &MASK/2                                                  09889102
         AIF   ('&TYPE' EQ 'TPNCB').TNAMC                               09889502
&OFSET   SETA  &OFSET+4                                                 09891402
&MASK    SETA  &MASK/2                                                  09892202
         AIF   ('&TYPE' EQ 'TPDNCB').TNAMC                              09893902
&OFSET   SETA  &OFSET+4                                                 09897502
&MASK    SETA  &MASK/2                                                  09897902
         AIF   ('&TYPE' EQ 'TPACBDEB').TNAMC                            09898702
&OFSET   SETA  &OFSET+4                                                 09901502
&MASK    SETA  &MASK/2                                                  09901702
         AIF   ('&TYPE' EQ 'SRM').TNAMSYS                               09902102
&OFSET   SETA  &OFSET+4                                                 09903302
&MASK    SETA  &MASK/2                                                  09903402
         AIF   ('&TYPE' EQ 'CMS').TNAMSYS                               09903602
&OFSET   SETA  &OFSET+4                                                 09906002
&MASK    SETA  &MASK/2                                                  09906102
         AIF   ('&TYPE' EQ 'LOCAL').TNAMSYS                             09906302
         AIF   (T'&ADDR EQ 'O').TALL                                    09913002
.*       IHB280 ADDR INVALID WITH TYPE=ALL/REG                          09913102
.TADINVL ANOP                                                           09913202
&MESSAGE SETC  'TYPE='.'&TYPE'                                          09913702
         IHBERMAC 1020,ADDR,&MESSAGE                                    09913802
         MEXIT                                                          09913902
.TALL    AIF   ('&TYPE' EQ 'ALL').TALLC                                 09915902
         AIF   ('&TYPE' EQ 'SPIN').TALLC                                09917902
.TREG    ANOP                                                           09923802
         AIF   ('&TYPE'(1,1) NE '(').TTYPINV                            09924002
         AIF   ('&TYPE'(K'&TYPE,1) EQ ')').TREGC                        09924202
.*       IHB002 INVALID TYPE OPERAND SPECIFIED- XXX                     09924802
.TTYPINV IHBERMAC 1001,TYPE,&TYPE                                       09924902
         MEXIT                                                          09925002
.*       IHB001 TYPE OPERAND REQUIRED NOT SPECIFIED                     09935002
.ERTTYP IHBERMAC 1006,TYPE                                              09935402
         MEXIT                                                          09935802
.TNAMSYS ANOP                                                           09936802
         AIF   (T'&ADDR NE 'O').TADINVL                                 09936902
.TNAMC   ANOP                                                           10085602
         AIF   (T'&REGS EQ 'O').TNAMC1                                  10085702
.*       IHB280 REGS INVALID WITH TYPE=NAME                             10085802
&MESSAGE SETC 'TYPE='.'&TYPE'                                           10085902
         IHBERMAC 1020,REGS,&MESSAGE                                    10088102
         MEXIT                                                          10090102
.TNAMC1  ANOP                                                           10090802
         AIF   ('&NAME' EQ '').TNAMNN                                   10092502
&NAME    DC    0H'0'                                                    10092802
.TNAMNN  AIF   (T'&BRANCH NE 'O').TNAMCB                                10094402
         SR    15,15                    PRESET LOCK HELD RETURN CODE    10096402
.TNAMCB  AIF   (T'&ADDR EQ 'O').TNAMTM                                  10098402
         C     &ADDR(1),PSACLHT-FLC+&OFSET.(0,0)                        10100403
*                                       CHECK LKWD ADDR IN CLHT@ZA35343 10100703
         AIF   (T'&BRANCH EQ 'O').TNAMARC                               10100802
         AIF   ('&BRANCH(1)' EQ 'HELD').TNAMABH                         10101202
         BNE   &BRANCH(2)               BRANCH NOT HELD                 10101602
         MEXIT                                                          10101702
.TNAMABH BE    &BRANCH(2)               BRANCH HELD                     10101902
         MEXIT                                                          10102002
.TNAMARC BE    *+8                      BRANCH HELD                     10102102
         LA    15,4(0,0)                SET R. C. LOCK NOT HELD         10102202
         MEXIT                                                          10103202
.TNAMTM  TM    PSAHLHI-FLC+&BYTE.(0),&MASK                              10103603
*                                       TEST BIT IN CPU LK HELD         10103803
*                                        STRING                @ZA35343 10103903
         AIF   (T'&BRANCH EQ 'O').TNAMTRC                               10104002
         AIF   ('&BRANCH(1)' EQ 'HELD').TNAMTBH                         10104402
         BZ    &BRANCH(2)               BRANCH NOT HELD                 10104802
         MEXIT                                                          10104902
.TNAMTBH BO    &BRANCH(2)               BRANCH HELD                     10105002
         MEXIT                                                          10105102
.TNAMTRC BO    *+8                      BRANCH HELD                     10106902
         LA    15,4(0,0)                SET R. C. LOCK NOT HELD         10108902
         MEXIT                                                          10109302
.TALLC   ANOP                                                           10209602
         AIF   (T'&REGS NE 'O').TALLCR                                  10213602
.*       IHB001 WITH TYPE=ALL, REGS OPERAND REQUIRED NOT SPECIFIED      10214402
&MESSAGE SETC  'WITH TYPE='.'&TYPE'.', REGS'                            10215002
         IHBERMAC 1006,&MESSAGE                                         10215202
         MEXIT                                                          10215402
.TALLCR  ANOP                                                           10215602
         AIF   ('&NAME' EQ '').TALLCNA                                  10215802
&NAME    DC    0H'0'                                                    10215902
.TALLCNA ANOP                                                           10216002
         AIF   (T'&BRANCH NE 'O').TALLCNS                               10216202
         SR    15,15               PRESET R. C. AT LEAST ONE LOCK HELD  10217302
.TALLCNS AIF   ('&TYPE' EQ 'SPIN').TSPINC                               10219702
         L     &REGS(1),PSAHLHI-FLC(0,0) GET CPU LOCKS HELD             10220003
*                                        STRING                @ZA35343 10220203
         AGO   .TALLCOM                                                 10220403
.TSPINC  LA    &REGS(1),4(0,0)     GET VALUE TO GENERATE MASK           10220603
         LCR   &REGS(1),&REGS(1)   GENERATE MASK TO CHECK ONLY SPIN LKS 10220803
         N     &REGS(1),PSAHLHI-FLC(0,0) KEEP ONLY HELD SPIN            10221003
*                                        LOCKS,IF ANY          @ZA35343 10221203
.TALLCOM ANOP                                                           10221802
         LTR   &REGS(1),&REGS(1)   CHECK FOR ZERO                       10222002
         AIF   (T'&BRANCH EQ 'O').TALLRC                                10222302
         AIF   ('&BRANCH(1)' EQ 'HELD').TALLBH                          10223302
         BZ    &BRANCH(2)          BRANCH NO LOCK HELD                  10224402
         MEXIT                                                          10227802
.TALLBH  BNZ   &BRANCH(2)          BRANCH AT LEAST ONE LOCK HELD        10229802
         MEXIT                                                          10230202
.TALLRC  BNZ   *+8                 BRANCH AT LEAST ONE LOCK HELD        10230602
         LA    15,4(0,0)           SET R. C. NO LOCK HELD               10231202
         MEXIT                                                          10231302
.TREGC   ANOP                                                           10242702
         AIF (T'&BRANCH EQ 'O').TREGCNB                                 10243102
         AIF (T'&REGS NE 'O').TREGCBR                                   10243502
.*       IHB001 WITH BRANCH OPTION OF TYPE=REG,REGS REQUIRED NOT SPECI- 10243902
.*       FIED                                                           10244402
&MESSAGE SETC  'WITH BRANCH OPTION OF TYPE='.'&TYPE'.', REGS'           10244502
         IHBERMAC 1006,&MESSAGE                                         10244702
         MEXIT                                                          10245102
.TREGCBR ANOP                                                           10245502
         AIF   ('&NAME' EQ '').TREGCNN                                  10245902
&NAME    DC    0H'0'                                                    10246202
.TREGCNN LR    &REGS(1),&TYPE(1)        SAVE INPUT STRING               10256202
         N     &REGS(1),PSAHLHI-FLC(0,0) COMPARE TO LOCKS HELD          10258703
*                                        STRING                @ZA35343 10259403
         CR    &REGS(1),&TYPE(1)        ARE ALL SPECIFIED LOCKS HELD    10259503
         AIF   ('&BRANCH(1)' EQ 'HELD').TREGCBH                         10259603
         BNE   &BRANCH(2)               BRANCH NOT ALL HELD             10259703
         MEXIT                                                          10259803
.TREGCBH BE    &BRANCH(2)               BRANCH ALL HELD                 10259902
         MEXIT                                                          10260302
.TREGCNB ANOP                                                           10260402
         AIF   ('&NAME' EQ '').TREGRNN                                  10260602
&NAME    DC    0H'0'                                                    10260702
.TREGRNN LR    15,&TYPE(1)              SAVE INPUT STRING               10261102
&REG     SETC  '&TYPE(1)'                                               10261202
         AIF   (T'&REGS EQ 'O').TREGCNR                                 10261302
&REG     SETC  '&REGS(1)'                                               10262002
         LR    &REG,&TYPE(1)            MOVE STRING IN WORK REGISTER    10262402
.TREGCNR N     &REG,PSAHLHI-FLC(0,0)    COMPARE TO LOCKS HELD           10262803
*                                        STRING                @ZA35343 10262903
         XR    15,&REG                  SET RC=0 IF ALL HELD            10263202
         BZ    *+8                      EXIT ALL HELD                   10263302
         LA    15,4(0,0)                SET RC NOT ALL HELD             10263402
         MEXIT                                                          10263602
.ENDIT   ANOP                                                           10338402
         MEND                                                           10340602
* */                                                                    10342802
*  SETLOCK :                                                            10345002
*  MACRO                                                                10347202
*  KEYS(TYPE,ADDR,MODE,DISABLED,RTCD,RETADDR,REGS,RELATED);             10349402
*  ANS('?'||MACLABEL||'SETLOCKP '||MACLIST||MACKEYS||';');              10351602
*% END;                                                                 10401602
