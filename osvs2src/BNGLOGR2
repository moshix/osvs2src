 TITLE 'BNGLOGER - MVS LOGGER MODULE - WRITES TO SYS1.DEMFLOG D.S.'     00050007
         PRINT OFF                                                      00100007
         MACRO                                                          00100407
&NAME    BNGHJN &LABEL,&HJN                                             00100807
         LCLC  &HJA,&HJB                                                00101207
&HJA     SETC  '&SYSPARM'(1,4)                                          00101607
&HJB     SETC  '&SYSPARM'(5,4)                                          00102007
         AIF   ('&LABEL' EQ '').NOBRNCH                                 00102407
         B     &LABEL .                 BR AROUND CONSTANTS             00102807
         SPACE 2                                                        00103207
.NOBRNCH ANOP                                                           00103607
         AIF   ('&NAME' EQ '').NOLABEL                                  00104007
         DC    C'&NAME' .              MODULE IDENTIFIER                00104407
.NOLABEL ANOP                                                           00104807
         DC    X'&HJA' .                DATE OF MODIFICATION            00105207
         AIF   ('&HJN' NE 'HJN').DATE                                   00105607
         DC    X'&HJB' .                HJN OF MODIFICATION             00106007
.DATE    ANOP                                                           00106407
         AIF   ('&LABEL' EQ '').NOLBL                                   00106807
         SPACE 2                                                        00107207
&LABEL   DS    0H                                                       00107607
.NOLBL   ANOP                                                           00108007
         MEND                                                           00108407
         PRINT ON                                                       00108807
*********************************************************************** 00109207
*                                                                     * 00150007
* MODULE NAME = BNGLOGER                                              * 00200007
*                                                                     * 00250007
* DESCRIPTIVE NAME = MVS LOGGER FUNCTION OF DEMF RECORDING SUSBSYSTEM * 00300007
*                                                                     * 00350007
* COPYRIGHT = NONE                                                    * 00400007
*                                                                     * 00450007
* STATUS = RELEASE 1, LEVEL 1                                         * 00500007
*                                                                     * 00550007
* FUNCTION =   THIS MODULE IS PART OF THE DISPLAY EXCECPTION MONITOR. * 00600007
*              FACILITY.  IT RUNS AS A SYSTEM TASK THAT IS STARTED    * 00650007
*              FROM THE OPERATOR CONSOLE.  IT IS POSTED BY THE LOGREC * 00700007
*              RECORDER MODULE, SVC 76, AND WILL WRITE TO THE DEMF    * 00750007
*              DATA SET, RECORDS WHICH HAVE BEEN QUEUED IN A BUFFER   * 00800007
*              AREA BY THE SVC 76 ROUTINE.  THESE RECORDS ARE TELE-   * 00850007
*              PROCESSING MDR AND OBR RECORDS WHICH WILL LATER BE     * 00900007
*              RETRIEVED, FORMATTED, AND SENT TO A REMOTE TERMINAL    * 00950007
*              WHICH HAS MADE A REQUEST FOR INFORMATION ABOUT THE     * 01000007
*              ERROR ACTIVITY  FOR A GIVEN LINE OR LINES.  THIS       * 01050007
*              MODULE DOES NOT HANDLE THE RETRIEVAL AND FORMATTING    * 01100007
*              FUNCTIONS.  WHEN POSTED, IT WILL DETERMINE WHICH       * 01150007
*              BUFFER OR BUFFERS HAVE BEEN FILLED , AND WILL WRITE    * 01200007
*              THEM OUT TO THE DEMF DATA SET.  THE RECORDS ARE GROUPED* 01250007
*              ACCORDING TO LINE ADDRESS, AND WRITTEN TO A BDAM DATA  * 01300007
*              SET.  AFTER COMPLETION OF THE WRITE, THE MODULE WILL   * 01350007
*              ISSUE A WAIT  ON AN ECB WHICH WILL BE POSTED BY SVC 76 * 01400007
*              WHEN IT HAS AGAIN FILLED A BUFFER.                     * 01450007
*              THIS MODULE ALSO INITIALIZES THE COMMON DATA AREA IN   * 01500007
*              THE NUCLEUS  WITH THE BUFFER AREA ADDRESS AND SETS A   * 01550007
*              FLAG TO BE TESTED BY SVC 76 TO DETERMINE IF DEMF IS    * 01600007
*              ACTIVE.  A GETMAIN IS DONE FOR A BUFFER AREA.  IF ANY  * 01650007
*              ERROR CONDITIONS ARE ENCOUNTERED, A MESSAGE WILL BE    * 01700007
*              ISSUED AND THE STAE ROUTINE IS ENTERED TO RESET SYSTEM * 01750007
*              FLAGS AND TERMINATE LOGGING.                           * 01800007
*                                                                     * 01850007
* NOTES = NONE                                                        * 01900007
*                                                                     * 01950007
*    DEPENDENCIES = NONE                                              * 02000007
*                                                                     * 02050007
*    RESTRICTIONS = NONE                                              * 02100007
*                                                                     * 02150007
*    REGISTER CONVENTIONS = SEE REGISTERS EQU'S BELOW                 * 02200007
*                                                                     * 02250007
*    PATCH LABEL = PTCHAREA  (12 FULL WORDS)                          * 02300007
*                                                                     * 02350007
* MODULE TYPE = CONTROL                                               * 02400007
*                                                                     * 02450007
*    PROCESSOR = ASSEMBLER H                                          * 02500007
*                                                                     * 02550007
*    MODULE SIZE = 11920 DECIMAL BYTES                                * 02600007
*                                                                     * 02650007
*    ATTRIBUTES = SERIALLY REUSABLE                                   * 02700007
*                                                                     * 02750007
* ENTRY POINT = BNGLOGER                                              * 02800007
*                                                                     * 02850007
*    PURPOSE = SEE FUNCTION                                           * 02900007
*                                                                     * 02950007
*    LINKAGE = START COMMAND FROM SYSTEM OPERATOR.                    * 03000007
*              POST MACRO ISSUED BY IFBSVC76 ROUTINE (SVC 76).        * 03050007
*                                                                     * 03100007
* INPUT = ONE OR MORE INCIDENT RECORDS QUEUED IN THE BUFFER AREA,     * 03150007
*         AND THE CORRESPONDING BYTE IN THE BUFFER TABLE HAVING ITS   * 03200007
*         HIGH ORDER BIT SET TO ONE.                                  * 03250007
*                                                                     * 03300007
* OUTPUT = DEPENDING ON THE INPUT, ZERO, ONE OR MORE RECORDS WRITTEN  * 03350007
*          TO THE SYS1.DEMFLOG DATA SET.                              * 03400007
*                                                                     * 03450007
* EXIT-NORMAL = REGISTER 15 RETURN CODES RETURNED TO CALLER :         * 03500007
*               00 - OPERATION PERFORMED AS REQUESTED                 * 03550007
*                                                                     * 03600007
* EXIT-ERROR = NONE                                                   * 03650007
*                                                                     * 03700007
* EXTERNAL REFERENCE = SEE BELOW                                      * 03750007
*                                                                     * 03800007
*    ROUTINES = NONE                                                  * 03850007
*                                                                     * 03900007
*    DATA AREAS = BUFFER AREA USED BY IFBSVC76 AND BNGLOGER.          * 03950007
*                                                                     * 04000007
*    CONTROL BLOCK = CVT,IFBDCB00                                     * 04050007
*                                                                     * 04100007
* TABLES = CTRLTBL  - USED BY TRT IN IFBSVC76 TO FIND FREE BUFFER     * 04150007
*          BUFFTBL  - USED BY TRT IN IFBSVC76 TO FIND FREE BUFFER     * 04200007
*                                                                     * 04250007
* MACROS = CVT,DCB,GETMAIN,FREEMAIN,ESTAE,ENQ,DEQ,OPEN,CLOSE,WTO,WTOR,* 04300007
*          WAIT,READ,WRITE,CHECK,TIME,IHAPSA,MODESET.                 * 04350007
*                                                                     * 04400007
* CHANGE ACTIVITIES AS FOLLOWS:                                       * 04450007
* CHANGE 01  11/15/77  PROLOGUE ADDED                                 * 04450107
* CHANGE 02  02/24/78  BNGHJN MACRO ADDED                             * 04450207
*C200500                                                       @OZ29853 04450307
*A078000,178500,183500                                         @OZ29853 04450407
*A074500,157000,157500,163000                                  @OZ29866 04450507
*C149500,153500,377000,378500                                  @OZ29866 04450607
*                                                                     * 04550007
*********************************************************************** 04600007
         EJECT                                                          04650007
********                *****   REGISTER EQUATES   ****           ****  04700007
R0       EQU   0                       REGISTER 0                       04750007
R1       EQU   1                       REGISTER 1                       04800007
R2       EQU   2                       REGISTER 2                       04850007
R3       EQU   3                       REGISTER 3                       04900007
R4       EQU   4                       REGISTER 4                       04950007
R5       EQU   5                       REGISTER 5                       05000007
R6       EQU   6                       REGISTER 6                       05050007
R7       EQU   7                       REGISTER 7                       05100007
R8       EQU   8                       REGISTER 8                       05150007
R9       EQU   9                       REGISTER 9                       05200007
R10      EQU   10                      REGISTER 10                      05250007
R11      EQU   11                      REGISTER 11                      05300007
R12      EQU   12                      REGISTER 12                      05350007
R13      EQU   13                      REGISTER 13                      05400007
R14      EQU   14                      REGISTER 14                      05450007
R15      EQU   15                      REGISTER 15                      05500007
*                                                                       05550007
SAVEREG  EQU   13                      SAVE AND CONSTANT AREA REG.      05600007
BASEREG  EQU   12                      MODULE BASE REG.                 05650007
BUFFREG  EQU   11                      DEMF BUFFER AREA REG.            05700007
CVTREG   EQU   3                       CVT BASE REG.                    05750007
RETREG   EQU   14                      RETURN REGISTER                  05800007
ENTREG   EQU   15                      ENTRY REGISTER                   05850007
IFBREG   EQU   10                      IFBDCB NUCLEUS CSECT REGISTER.   05900007
DATAREG  EQU   8                       RECORD POINTER REGISTER.         05950007
LINKREG  EQU   2                       LINKAGE REGISTER.                06000007
BASERG2  EQU   6                       SECOND BASE REGISTER.            06050007
SLOTREG  EQU   3                                                        06100007
BCTREG   EQU   4                                                        06150007
*                                                                       06200007
*                                                                       06250007
*                                                                       06300007
********                 ***** MISCELLANEOUS EQUATES *****              06350007
         CVT   DSECT=YES                                                06400007
         PRINT NOGEN                                                    06450007
         IHAPSA                                                         06500007
         PRINT GEN                                                      06550007
*                                                                       06600007
DCBDISP  EQU   16                      LOGREC DCB DISP. IN IFBDCB CSECT 06650007
OPENBIT  EQU   16                      DCB OPEN BIT.                    06700007
DCBOFLGS EQU   48                      DISP IN DCB TO OPEN FLAGS.       06750007
         SPACE 2                                                        06800007
ONE      EQU   1                   FOR DISPLACEMENT                     06850007
TWO      EQU   2                   FOR DISPLACEMENT                     06900007
EIGHT    EQU   8                   FOR DISPLACEMENT                     06950007
TWEL     EQU   12                  FOR DISPLACEMENT                     07000007
PRESIZE  EQU   7                   PREFIX LENGTH OF DEMFILE RECORD      07050007
MDR      EQU   X'91'               MDR RECORD TYPE                      07100007
OBRBT    EQU   X'30'               OBR - BTAM RECORD TYPE               07150007
OBRTC    EQU   X'34'               OBR - TCAM RECORD TYPE               07200007
DDIDISP  EQU   64                  DISP IN LONG OBR TO DEV DEP INFO     07250007
ZERO     EQU   0                                                        07300007
M3270EP  EQU   X'03'               MDR 3270 EP MODE                     07350007
OBRNA1   EQU   X'E0'               UNWANTED OBRS: SDR CTRS,TEMP,SHORT   07400007
OBRNA2   EQU   X'60'               UNWANTED OBRS: CTR OVFLO, EOD        07450007
OBRCCTT  EQU   X'01'          OBR TCAM 3270 SW; ON IF CC/TT    @OZ29866 07455007
*                             VALID                            @OZ29866 07460007
ODEVCOM  EQU   X'40'          OBR DEVICE CLASS = COMMUNICATONS @OZ29866 07465007
ODEVUNT2 EQU   X'90'          OBR UNIT TYPE = SYNC ADAPT TYP 2 @OZ29866 07470007
ODEVNOT2 EQU   X'60'          OBR UNIT TYPE=NOT SYNC ADAP 2    @OZ29866 07475007
ODEVMOD3 EQU   X'07'          OBR MODEL BITS = BISYNCH 3       @OZ29866 07480007
ODEVNOT3 EQU   X'08'          OBR MODEL BITS = NOT BISYNCH 3   @OZ29866 07485007
BTAMSYN  EQU   X'32'          OBR BTAM CONTROL CHARACTER: SYN  @OZ29866 07490007
         EJECT                                                          07500007
BNGLOGER CSECT                                                          07550007
*                                                                       07600007
         STM   R14,R12,12(R13)         SAVE REGISTERS.                  07650007
         LR    R12,R15                 LOAD FIRST BASE REG.             07700007
         USING BNGLOGER,BASEREG,BASERG2  NOTIFY ASM OF BASE REGS.       07750007
*                                                                       07800007
BNGLOGR2 BNGHJN SKIPID                                         @OZ29853 07820007
         LA    BASERG2,BNGLOGER+4095     INITIALIZE                     07850007
         LA    BASERG2,1(BASERG2)      SECOND BASE REGISTER.            07900007
***                                                                     07950007
         GETMAIN   R,LV=96,SP=0        GET STORAGE FOR SAVE AREA.       08000007
***                                                                     08050007
         ST    SAVEREG,4(R1)           PERFORM SAVE AREA CHAINING.      08100007
         ST    R1,8(SAVEREG)           POINT LSA TO HSA.                08150007
         LR    SAVEREG,R1              R13 NOW POINTS TO NEW SAVE.      08200007
         USING SAVE,SAVEREG            EST. ADDRESSABILITY.             08250007
***                                                                     08300007
         GETMAIN   R,LV=4096,SP=241    GET BUFFER AREA STORAGE.         08350007
***                                                                     08400007
         LR    BUFFREG,R1              POINT BUFFREG TO BUFF AREA.      08450007
         USING BUFFER,BUFFREG      SET UP BUFFER ADDRESSABILITY         08500007
         SPACE 2                                                        08550007
*  INITIALIZATION OF BUFFER CONTROL AREA                                08600007
         SPACE 2                                                        08650007
         MVI   BUFFLAG1,ZERO       CLEAR FLAG1                          08700007
         MVI   BUFFLAG2,ZERO       CLEAR FLAG2                          08750007
         SPACE 2                                                        08800007
*                                                                       08850007
*****              LOCATE IFBDCB CSECT IN NUCLEUS AND INITIALIZE  ****  08900007
*****              CONSTANTS IN THE DEMF AREA.                    ****  08950007
*                                                                       09000007
         L     CVTREG,CVTPTR       FIND CVT                             09050007
         USING CVTMAP,CVTREG       ESTABLISH CVT ADDRESSABILITY         09100007
         L     IFBREG,CVTDCB       GET POINTER TO LOGREC DCB            09150007
         DROP  CVTREG                                                   09200007
         LA    CVTREG,DCBDISP      DISP OF LOGREC DCB IN IFBDCB00       09250007
         SR    IFBREG,CVTREG       POINT TO START OF MODULE             09300007
         USING IFBDCB,IFBREG           ESTABLISH DSECT ADDRESSABILITY   09350007
         SPACE 1                                                        09400007
         STM   IFBREG,BASEREG,ESTAEP    SAVE REGS A,B,C                 09450007
         ST    BASERG2,ESTAEP+TWEL      SAVE REG 6                      09500007
         ESTAE STAERTN,CT,PARAM=ESTAEP,XCTL=NO,PURGE=QUIESCE,ASYNCH=YESX09550007
               ,TERM=YES                                                09600007
         SPACE 1                                                        09650007
         MODESET KEY=ZERO          PROTECT KEY ZERO                     09700007
         TS    IFBFLGS1            IS DEMF ALREADY ACTIVE?(TEST HI BIT) 09750007
         BC    4,REJECT                YES, CAN'T HAVE ANOTHER          09800007
         SPACE 1                                                        09850007
         ST    BUFFREG,IFBBUFP         ST BUFF AREA PTR IN COMM AREA    09900007
         MVC   BUFBYTES(L'BUFFTBL),BUFFTBL  BUSY BYTES TO COMM AREA     09950007
         SPACE 1                                                        10000007
         LA    R7,PRESIZE          INIT PREFIX SIZE                     10050007
         STH   R7,BUFPRESZ         STORE IN BUFFER CONTROL              10100007
         LA    R7,BUFECB               POINT TO DEMF TASK ECB.          10150007
         ST    R7,ECBPTR               INIT. ECB LIST.                  10200007
         SPACE 1                                                        10250007
         USING PSA,0                                                    10300007
         MVC   IFBASCBP,PSAAOLD    MOVE ASCB PTR INTO DCB EXTENSION     10350007
         MODESET KEY=NZERO         PROTECTION KEY TCB                   10400007
         SPACE 2                                                        10450007
***                                                                     10500007
         OPEN  (LOGDCB,UPDAT)          OPEN DEMF DATA SET               10550007
***                                                                     10600007
         TM    LOGDCB+DCBOFLGS,OPENBIT DCB OPENED O.K.?                 10650007
         BZ    ERROPEN                 BR IF NO TO ERROR RTN.           10700007
***                                                                     10750007
         WTOR  'BNG900A DEMF ACTIVE. REPLY ''END DEMF'' TO TERMINATE.',X10800007
               REPLY,8,STOPECB,ROUTCDE=(1)                              10850007
***                                                                     10900007
WAITLOG  EQU   *                                                        10950007
         XC    BUFECB(4),BUFECB        CLEAR ECB FOR WAIT.              11000007
*   RESET ALL WTO ERROR FLAGS                                           11050007
         NI    BUFFLAG1,FOXS-(BUFBIGRC+BUFBIGRW+BUFBFULL+BUFBFULW)      11100007
WAIT2    EQU   *                                                        11150007
***                                                                     11200007
         WAIT  ECBLIST=ECBPTR          WAIT FOR SVC 76 POST.            11250007
***                                                                     11300007
         TM    STOPECB,X'40'       DID OPER REQUEST END?                11350007
         BO    CHEKSTOP            BR IF YES TO TEST REPLY.             11400007
*********************************************************************** 11450007
*                                                                     * 11500007
*              THE FOLLOWING CODE FINDS THE BUFFERS FILLED BY SVC     * 11550007
*              76 AND BRANCHES TO THE BDAM WRITE ROUTINE PUT          * 11600007
*              THE RECORD IN ITS 'BUCKET'.  AFTER THIS, THE BUFFER    * 11650007
*              TABLE IS SEARCHED AGAIN, IN CASE ANOTHER BUFFER WAS    * 11700007
*              FILLED DURING THE TIME WE WERE EXECUTING .  A NO-HIT   * 11750007
*              TABLE SEARCH RESULTS IN A WAIT FOR ANOTHER POST.       * 11800007
*                                                                     * 11850007
*********************************************************************** 11900007
*                                                                       11950007
FINDBUF  EQU   *                                                        12000007
         SR    R1,R1                   ZERO REGISTERS FOR               12050007
         SR    R2,R2                   TRT INSTRUCTION.                 12100007
***                                                                     12150007
         LA    R3,BUFBYTES             POINT TO BUSY BYTES              12200007
         TRT   ZERO(BUFFS,R3),CTRLTBL     SEARCH FOR ACTIVE BUFFER.     12250007
***                                                                     12300007
         BC    8,WAITLOG               NO ACTIVE ENTRIES, GO WAIT.      12350007
         BC    4,BUFOUND               BR IF BUFFER FOUND.              12400007
         MVI   EOTIND,X'FF'            INDICATE BUFFER FOUND IS LAST.   12450007
BUFOUND  EQU   *                                                        12500007
         SPACE 2                                                        12550007
*  MESSAGE HANDLER                                                      12600007
         SPACE 2                                                        12650007
         ST    R1,CURRBUF          SAVE CURRENT BUFFER PTR              12700007
         TM    BUFFLAG1,BUFNOLOG+BUFBIGRC+BUFBFULL ANY ON?              12750007
         BZ    NOMSG                                                    12800007
         SPACE 2                                                        12850007
         TM    BUFFLAG1,BUFNOLOG+BUFNOLGW   LOGREC RECORDING            12900007
         BC    9,SKIP1             SKIP IF BOTH OR NEITHER BIT ON       12950007
         WTO   'BNG907I SYS1.LOGREC RECORDING OF DEMF RECORDS INHIBITEDX13000007
               .',ROUTCDE=(2)                                           13050007
         OI    BUFFLAG1,BUFNOLGW   INHIBIT WTO SECOND TIME              13100007
SKIP1    EQU   *                                                        13150007
         TM    BUFFLAG1,BUFBIGRC+BUFBIGRW    RECORD TOO BIG             13200007
         BC    9,SKIP2             SKIP IF BOTH OR NEITHER BIT ON       13250007
         WTO   'BNG908I SYS1.LOGREC RECORD(S) TOO BIG FOR DEMF BUFFER. X13300007
               RECORD(S) LOST.',ROUTCDE=(2)                             13350007
         OI    BUFFLAG1,BUFBIGRW   INHIBIT WTO SECOND TIME              13400007
SKIP2    EQU   *                                                        13450007
         TM    BUFFLAG1,BUFBFULL+BUFBFULW    BUFFERS FULL               13500007
         BC    9,NOMSG             SKIP IF BOTH OR NEITHER BIT ON       13550007
         WTO   'BNG909I DEMF BUFFERS FULL. RECORD(S) LOST.',ROUTCDE=(2) 13600007
         OI    BUFFLAG1,BUFBFULW   INHIBIT WTO SECOND TIME              13650007
NOMSG    EQU   *                                                        13700007
         SPACE 2                                                        13750007
*  TEST FOR ACCEPTABLE INPUT RECORD TYPES                               13800007
         SPACE 2                                                        13850007
         L     R1,CURRBUF          POINT TO BUFFER BYTE TABLE HIT       13900007
         LR    DATAREG,R2              LOAD BUFF DISP IN MULTIPLIER.    13950007
         MH    DATAREG,BUFSIZE         REG2 INDEX CONTAINS BUFF NO.     14000007
         SH    DATAREG,BUFSIZE         DECREMENT TO CONV TO DISP.       14050007
         AR    DATAREG,BUFFREG         REG8 NOW POINTS TO ACTIVE BUFF.  14100007
         USING BTCAM,DATAREG       DSECT ADDRESSABILITY                 14150007
         CLI   BTTYPE,MDR          MDR RECORD TYPE?                     14200007
         BNE   OBR1                NO, TEST FOR OBR                     14250007
         SPACE 2                                                        14300007
* HERE FOR MDR TYPE                                                     14350007
         CLI   MDRSWTCH,M3270EP    3270 EP MODE?                        14400007
         BE    RECOK               YES, PROCESS IT                      14450007
         B     COMPL               NO, TERMINATE PROCESSING THIS RECORD 14500007
         SPACE 2                                                        14550007
OBR1     EQU   *                                                        14600007
         TM    BTSWTCH,OBRNA1      ANY UNWANTED OBR TYPES?              14650007
         BC    5,COMPL             YES, TERMINATE PROCESSING THIS       14700007
         SPACE 2                                                        14750007
*  HERE OBR RECORDS                                                     14800007
         SPACE 2                                                        14850007
* COMMON BTAM-TCAM PROCESSING                                           14900007
         LA    R7,DDIDISP+PRESIZE(DATAREG)  POINT TO DEV DEP   @OZ29866 14950007
*                                           INFORMATION        @OZ29866 14960007
         SR    R9,R9               CLEAR WORK REG                       15000007
         IC    R9,BTDDDWD          DEV DEP DATA LENGTH (IN DWORDS)      15050007
         SLL   R9,3                MULT BY 8 TO GET BYTES               15100007
         LA    R7,0(R7,R9)         ADDR PAST DEV DEP DATA               15150007
         SR    R9,R9               CLEAR WORK REG                       15200007
         IC    R9,BTSDRCT          GET STAT BYTE COUNT                  15250007
         LA    R7,0(R7,R9)         ADDR OF SENSE BYTES                  15300007
         MVC   BTPOLL,BTCCTT       MOVE POLLING CHARS IN OBR   @OZ29866 15350007
         SPACE 2                                                        15400007
* OBR-BTAM PROCESSING FOR COMMON DISPLAY FORMAT                         15450007
         CLI   BTTYPE,OBRBT        OBR-BTAM RECORD TYPE?                15500007
         BNE   OBR2                NO, TEST FOR OBR-TCAM                15550007
         MVC   BTSENSE1,ZERO(R7)   MOVE TO SENSE 1 FROM CALC. ADDR.     15600007
         MVC   BTBTOP,ONE(R7)      MOVE BTAM OP CODE                    15650007
         MVI   BTSENSE2,ZERO       CLEAR SENSE BYTE 2                   15700007
         SPACE 2                                               @OZ29866 15701007
*    TEST DEVICE TYPE FIELD IN OBR FOR BISYNCH 3 DEVICES.      @OZ29866 15702007
*    IF ALL TESTS OK, THEN CHECK CC IN BTCCTT (BTPOLL)         @OZ29866 15703007
         SPACE 1                                               @OZ29866 15704007
         CLI   BTDEVTP2,ODEVCOM    OBR DEV TYPE=COMMUNICATONS? @OZ29866 15705007
         BNE   OBR12               NO, SET F'S                 @OZ29866 15706007
         TM    BTDEVTP3,ODEVUNT2   OBR UNIT TYPE=SYNC ADAPT 2? @OZ29866 15707007
         BNO   OBR12               NO, SET F'S                 @OZ29866 15708007
         TM    BTDEVTP3,ODEVNOT2   OBR UNIT OTHER THAN SYN 2?  @OZ29866 15709007
         BNZ   OBR12               YES, SET F'S                @OZ29866 15710007
         TM    BTDEVTP0,ODEVMOD3   OBR MODEL BITS = BISYNCH 3? @OZ29866 15711007
         BNO   OBR12               NO, SET F'S                 @OZ29866 15712007
         TM    BTDEVTP0,ODEVNOT3   OBR MODEL BITS OTHER THAN   @OZ29866 15713007
*                                  BSC 3 ?                     @OZ29866 15714007
         BNZ   OBR12               YES, SET F'S                @OZ29866 15715007
         SPACE 2                                               @OZ29866 15716007
*    HERE IF DEVICE IS BISYNCH 3, NOW CHECK FOR VALID CC       @OZ29866 15717007
         SPACE 1                                               @OZ29866 15718007
         CLC   BTPOLL(ONE),BTPOLL+ONE    ARE BYTES EQUAL?      @OZ29866 15719007
         BNE   OBR12               NO, SO INVALID CC, SET FF'S @OZ29866 15720007
         CLI   BTPOLL,BTAMSYN      BTAM CONTROL CHAR? (SYN)    @OZ29866 15721007
         BE    OBR12               YES, SET FF'S               @OZ29866 15722007
         CLI   BTPOLL,ZERO         IS CU POLL CHAR ZERO?       @OZ29866 15723007
         BE    OBR12               YES, CONTROL UNIT IS VALID  @OZ29866 15724007
*    HERE IS VALID CC, JUST SET TERM FF                        @OZ29866 15725007
         MVI   BTPOLL+ONE,FOXS     INSERT FF TERM POLL CHAR    @OZ29866 15726007
         B     RECOK               PROCESS IT                           15750007
OBR12    EQU   *                                               @OZ29866 15760007
         MVC   BTPOLL,HEXFF        INSERT F'S INTO OBR         @OZ29866 15770007
         B     RECOK               PROCESS IT                  @OZ29866 15780007
         SPACE 2                                                        15800007
* OBR-TCAM PROCESSING FOR COMMON DISPLAY FORMAT                         15850007
*                                                                       15900007
OBR2     EQU   *                                                        15950007
         CLI   BTTYPE,OBRTC        OBR TCAM RECORD TYPE?                16000007
         BNE   COMPL               NO, TERMINATE PROCESSING THIS RECORD 16050007
         TM    BTFLAG,OBRNA2       UNWANTED RECORD TYPES?               16100007
         BC    5,COMPL             YES,TERM PROCESSING THIS RECORD      16150007
         MVC   BTSENSE1,ONE(R7)    MOVE SECOND SENSE TO FIRST           16200007
         MVI   BTSENSE2,ZERO       CLEAR SECOND SENSE BYTE              16250007
         MVC   BTCCW,BTTCOP        MOVE TCAM OP CODE INTO CCW 6TH BYTE  16300007
         TM    BTSWTCH,OBRCCTT     ARE CU/TERM POLL CHARS VALID@OZ29866 16310007
         BO    RECOK               YES, CONTINUE               @OZ29866 16320007
         MVC   BTPOLL,HEXFF        INSERT F'S INTO OBR         @OZ29866 16330007
         SPACE 2                                                        16350007
RECOK    EQU   *                                                        16400007
         ST    R1,CURRBUF              SAVE CURRENT BUFFER DISP IN TBL. 16450007
         BAL   LINKREG,EMFWRT          GO WRITE RECORD IN DEMF DATASET. 16500007
         L     R1,CURRBUF              POINT TO LAST TBL BYTE HIT.      16550007
         SPACE 2                                                        16600007
COMPL    EQU   *                                                        16650007
         NI    0(R1),X'7F'             RESET BUFFER ACTIVE INDICATOR.   16700007
         TM    EOTIND,X'FF'            WAS LAST HIT ON END OF TABLE?    16750007
         BZ    FINDBUF                 BR IF NO TO SCAN TBL AGAIN.      16800007
         MVI   EOTIND,X'00'            IF YES RESET LAST BYTE IND.      16850007
         B     WAITLOG                 AND GO TO WAIT FOR NEXT POST.    16900007
CHEKSTOP EQU   *                                                        16950007
         OC    REPLY(ENDSIZE),CAPS     FOLD REPLY TO CAPITALS           17000007
         CLC   REPLY(ENDSIZE),ENDDEMF  DID OPER REPLY CORRECTLY?        17050007
         BE    RETURN                  IF YES BR TO GO AWAY.            17100007
         XC    REPLY(ENDSIZE),REPLY    NO, INIT FOR REISSUE OF WTOR.    17150007
         XC    STOPECB(4),STOPECB      CLEAR ECB FOR WAIT.              17200007
         WTOR  'BNG901A INVALID REPLY. TO TERMINATE DEMF, ENTER ''END DX17250007
               EMF''.',REPLY,8,STOPECB,ROUTCDE=(1)                      17300007
         B     WAIT2               GO WAIT FOR SVC 76 OR END.           17350007
REJECT   DS    0H                                                       17400007
         WTO   'BNG902I DEMF ALREADY ACTIVE. REQUEST IGNORED.',        X17450007
               ROUTCDE=(2)                                              17500007
         B     RETURN1                                                  17550007
RETURN   EQU   *                                                        17600007
         ENQ   (BNGADR,BUFFRADR,E,6,SYSTEMS),RET=NONE  ENQ ON BUFFER    17650007
         MODESET KEY=ZERO          PROTECTION KEY ZERO                  17700007
         NI    IFBFLGS1,X'7F'   INDICATE DEMF NO LONGER ACTIVE.         17750007
         MODESET KEY=NZERO         PROTECTION KEY TCB                   17800007
         DEQ   (BNGADR,BUFFRADR,6,SYSTEMS),RET=HAVE  DEQ ON BUFFER      17850007
         TM    LOGDCB+DCBOFLGS,OPENBIT  OPEN FAILURE?          @OZ29853 17860007
         BZ    RETURN2                  YES, GO TO RETURN2     @OZ29853 17870007
         TM    STAEFLAG,STAEON     STAE EXIT ENTERED?                   17900007
         BO    STAE1               YES, PRINT ABNORM MSG                17950007
         WTO   'BNG903I DEMF BEING TERMINATED.',ROUTCDE=(2)             18000007
         B     STAE2               SKIP ABNORM MSG                      18050007
STAE1    EQU   *                                                        18100007
         WTO   'BNG910I DEMF BEING ABNORMALLY TERMINATED.',ROUTCDE=(2)  18150007
STAE2    EQU   *                                                        18200007
         CLOSE (LOGDCB)                                                 18250007
RETURN1  EQU   *                                                        18300007
         MODESET KEY=NZERO         PROTECTION KEY TCB                   18350007
RETURN2  EQU   *                                               @OZ29853 18370007
         TM    STAEFLAG,STAEON     STAE EXIT ENTERED?                   18400007
         BO    STAE3               YES, SKIP STAE CANCEL                18450007
         STAE  0                                                        18500007
STAE3    EQU   *                                                        18550007
         FREEMAIN R,LV=4096,SP=241,A=(BUFFREG)                          18600007
         TM    STAEFLAG,STAEON          STAE EXIT ENTERED?              18650007
         BO    STAE4                    YES, TERMINATE                  18700007
         L     SAVEREG,HSAPTR      RELOAD REG 13.                       18750007
         L     R1,EIGHT(SAVEREG)   LOAD ADDR OF SAVE AREA               18800007
         FREEMAIN R,LV=96,SP=0,A=(R1)                                   18850007
         LM    R14,R12,REGSAVE     RESTORE REGISTERS.                   18900007
STAE4    EQU   *                                                        18950007
         SR    R15,R15             INDICATE ZERO RETURN CODE.           19000007
         BR    R14                 RETURN TO SYSTEM.                    19050007
         SPACE 5                                                        19100007
STAERTN  EQU   *                   STAE EXIT ROUTINE                    19150007
         USING STAERTN,R15         ESTABLISH TEMP ADDR.                 19200007
         C     R0,STAETEST         TEST FOR SDWA CORE                   19250007
         BE    NOSDWA              NO SDWA, USE REG 1                   19300007
         L     R2,ZERO(R1)         PTR TO PARMS                         19350007
NOSDWA   EQU   *                                                        19400007
         LM    IFBREG,BASEREG,ZERO(R2) RESTORE REGS A,B,C               19450007
         L     BASERG2,TWEL(R2)    RESTOR REG 6                         19500007
         DROP  R15                 DROP TEMP ADDR.                      19550007
         USING BNGLOGER,BASEREG,BASERG2  RESTORE ORIG ADDR              19600007
         OI    STAEFLAG,STAEON     SET STAE ERROR FLAG                  19650007
         B     RETURN              GO TO NORMAL TERMINATION             19700007
         SPACE 5                                                        19750007
ERROPEN  EQU   *                                                        19800007
***                                                                     19850007
         WTO   'BNG904I ERROR OPENING SYS1.DEMFLOG DATA SET. DEMF NOT AX19900007
               CTIVATED.',ROUTCDE=(2)                                   19950007
***                                                                     20000007
         B     RETURN                                          @OZ29853 20050007
***                                                                     20100007
         EJECT                                                          20150007
* THIS ROUTINE WILL WRITE TO DISK A VARIABLE LTH MDR OR OBR RECORD.     20200007
*                                                                       20250007
         USING EMFSLOT,SLOTREG     SETUP TO PROCESS A SLOT IN CTRL REC. 20300007
EMFWRT   STM   0,15,EMFSAVE                                             20350007
         TM    7(DATAREG),X'30'    IF THIS IS ANY OBR RECORD            20400007
         BNO   EMFLOG4             FOR A                                20450007
         CLI   61(DATAREG),X'10'   GRAPHICS DEVICE, ALTER THE           20500007
         BNE   EMFLOG4             UNIT ADDR SO ALL 3277'S FALL         20550007
         NI    3(DATAREG),B'11100000'   INTO COMMON CTRL UNIT BUCKET.   20600007
EMFLOG4  DS    0H                                                       20650007
         XC    EMFREL,EMFREL       SET RELATIVE BLK ADDR TO ZERO.       20700007
EMFLOG5  READ  ECBA3,DI,LOGDCB,EMFCTRL,4096,0,EMFREL  READ ZERO BLK.    20750007
         CHECK ECBA3                                                    20800007
         LA    SLOTREG,EMFSLOT1    POINT TO 1ST ENTRY IN CTRL BLK.      20850007
         SR    BCTREG,BCTREG       SETUP TO LOOP ON NBR                 20900007
         IC    BCTREG,EMFENTS      OF ENTRIES.                          20950007
         LTR   BCTREG,BCTREG                                            21000007
         BZ    EMFLOG15            MUST BE 1ST ERROR OF THE DAY.        21050007
EMFLOG10 CLC   EMFPORT,1(DATAREG)  IS THIS ENTRY EQUAL OUR ITEM TO LOG? 21100007
         BE    EMFLOG40            YES. GO READ DATA BLOCK.             21150007
         LA    SLOTREG,SLOTLTH(SLOTREG)     NO. LOOP TO NEXT SLOT.      21200007
         BCT   BCTREG,EMFLOG10                                          21250007
         OC    EMFNEXT,EMFNEXT     NOT IN THIS BLK.  ANOTHER BLK EXIST? 21300007
         BZ    EMFLOG15            NO.  CREATE A CONTROL ENTRY.         21350007
         MVC   EMFREL,EMFNEXT+1    YES. SETUP TO READ THAT              21400007
         B     EMFLOG5               CHAIN RECORD.                      21450007
EMFLOG15 BAL   LINKREG,EMFGETAD    GET A NEW BLOCK ADDRESS.             21500007
         STCM  0,7,EMFBLK          STORE AS DATA BLK ADDRESS.           21550007
         LA    0,DATAREA1          ZERO OUT THE DATA AREA.              21600007
         LH    1,H4096                                                  21650007
         LA    14,*                                                     21700007
         SR    15,15                                                    21750007
         MVCL  0,14                                                     21800007
         MVC   DATPORT,1(DATAREG)  INITIALIZE HEADER                    21850007
         TIME  DEC                                                      21900007
         STCM  0,15,DATTIME        PORTION OF THE                       21950007
         STCM  1,15,DATDATE        DATA RECORD.                         22000007
         LA    0,DATSLOT1                                               22050007
         SR    1,1                                                      22100007
         IC    1,0(DATAREG)        MOVE THE DATA TO BE LOGGED           22150007
         LR    14,DATAREG          INTO THE FIRST SLOT.                 22200007
         LR    15,1                                                     22250007
         MVCL  0,14                                                     22300007
         MVC   DATLTH+1(1),DATSLOT1  SET TOTAL LTH = THIS DATA.         22350007
         WRITE ECBB7,DI,LOGDCB,DATAREA1,4096,0,EMFBLK  WRITE DATA BLK.  22400007
         CHECK ECBB7                                                    22450007
         OC    EMFREL,EMFREL       IS CTRL RECORD ZERO IN CORE?         22500007
         BZ    EMFLOG20            YES.  CONTINUE.                      22550007
         XC    EMFREL,EMFREL       NO.  RE-READ IT.                     22600007
         READ  ECBB15,DI,LOGDCB,EMFCTRL,4096,0,EMFREL                   22650007
         CHECK ECBB15                                                   22700007
EMFLOG20 DS    0H                                                       22750007
         CLI   EMFENTS,254         IS CTRL BLOCK FULL?                  22800007
         BE    EMFLOG30            YES. GO CREATE OVERFLOW.             22850007
         LA    SLOTREG,EMFSLOT1    NO. LOCATE NEXT                      22900007
         SR    BCTREG,BCTREG       AVAILABLE                            22950007
         IC    BCTREG,EMFENTS      SLOT.                                23000007
         LTR   BCTREG,BCTREG                                            23050007
         BZ    EMFLOG26            MUST BE 1ST ERROR OF THE DAY.        23100007
EMFLOG25 LA    SLOTREG,SLOTLTH(SLOTREG)                                 23150007
         BCT   BCTREG,EMFLOG25                                          23200007
         IC    BCTREG,EMFENTS      ADD 1 TO NBR                         23250007
EMFLOG26 LA    BCTREG,1(BCTREG)    OF ENTRIES IN                        23300007
         STC   BCTREG,EMFENTS      THIS BLOCK.                          23350007
EMFLOG27 MVC   EMFPORT,1(DATAREG)  FILL IN THE PORT ADDRESS,            23400007
         MVC   EMFBLKS,H1       SET TOTAL BLOCKS = 1,                   23450007
         MVC   EMFHITS,H1       TOTAL HITS = 1,                         23500007
         MVC   EMFSTART,EMFBLK     AND THE DATA BLK ADDR AS             23550007
         MVC   EMFEND,EMFBLK       1ST AND LAST IN THE CHAIN.           23600007
         WRITE ECBB23,DI,LOGDCB,EMFCTRL,4096,0,EMFREL  REWRITE CTRL BLK 23650007
         CHECK ECBB23                                                   23700007
         LM    0,15,EMFSAVE                                             23750007
         BR    LINKREG                                                  23800007
EMFLOG30 BAL   LINKREG,EMFGETAD    GET A NEW BLK ADDR FOR NEW CTRL BLK. 23850007
         STCM  0,7,EMFREL          STORE THE NEW ADDRESS.               23900007
         WRITE ECBC3,DI,LOGDCB,EMFCTRL,4096,0,EMFREL  WRITE OLD CTRL    23950007
         CHECK ECBC3                                                    24000007
         MVC   EMFNEXT+1(3),EMFREL    PROMOTE THE BACK CHAIN FIELD.     24050007
         XC    EMFREL,EMFREL       RESET ADDR TO ZERO CTRL RECORD.      24100007
         OC    EMFFIRST,EMFFIRST   IF THIS WAS THE 1ST TIME             24150007
         BNZ   EMFLOG35            TO CREATE AN OVERFLOW, ALSO          24200007
         MVC   EMFFIRST,EMFNEXT    PROMOTE 1ST ADDR IN CHAIN.           24250007
EMFLOG35 MVI   EMFENTS,X'00'                                            24300007
         LA    0,EMFSLOT1          ZERO OUT THE COUNT AND DATA          24350007
         LA    1,EMFBLOCK-EMFSLOT1                                      24400007
         LA    14,*                                                     24450007
         LA    15,0                                                     24500007
         MVCL  0,14                                                     24550007
         LA    SLOTREG,EMFSLOT1    POINT TO 1ST SLOT,                   24600007
         MVI   EMFENTS,1           SET NBR ENTRIES = 1,                 24650007
         B     EMFLOG27            AND GO MAKE CTRL ENTRY.              24700007
EMFLOG40 MVC   EMFBLK,EMFEND       MOVE ADDR OF NEWEST BLK IN CHAIN.    24750007
         READ  ECBD2,DI,LOGDCB,DATAREA1,4096,0,EMFBLK  READ DATA BLK.   24800007
         CHECK ECBD2                                                    24850007
         LH    1,DATLTH            IS THERE ENOUGH ROOM                 24900007
         SR    0,0                 LEFT IN THIS BLOCK                   24950007
         IC    0,0(DATAREG)        FOR THIS DATA ITEM?                  25000007
         AR    1,0                                                      25050007
         C     1,=A(DATEND-DATSLOT1)                                    25100007
         BH    EMFLOG50            NO. GO BUILD DATA BLK CHAIN.         25150007
EMFLOG45 LA    0,DATSLOT1          YES.                                 25200007
         AH    0,DATLTH            POINT TO NEXT AVAILABLE POSITION.    25250007
         SR    1,1                                                      25300007
         IC    1,0(DATAREG)                                             25350007
         LH    15,DATLTH                                                25400007
         AR    15,1                                                     25450007
         STH   15,DATLTH                                                25500007
         LR    14,DATAREG                                               25550007
         LR    15,1                                                     25600007
         MVCL  0,14                MOVE IN THE ITEM TO BE LOGGED.       25650007
         WRITE ECBD17,DI,LOGDCB,DATAREA1,4096,0,EMFBLK  REWRITE DATA.   25700007
         CHECK ECBD17                                                   25750007
         LH    1,EMFHITS                                                25800007
         LA    1,1(1)              ADD 1 TO NBR HITS ON THIS LINE.      25850007
         STH   1,EMFHITS                                                25900007
         WRITE ECBD22,DI,LOGDCB,EMFCTRL,4096,0,EMFREL  REWRITE CTRL BLK 25950007
         CHECK ECBD22                                                   26000007
         LM    0,15,EMFSAVE                                             26050007
         BR    LINKREG                                                  26100007
EMFLOG50 BAL   LINKREG,EMFGETAD    GET A NEW BLOCK ADDRESS.             26150007
         STCM  0,7,EMFNEW          SAVE IT.                             26200007
         STCM  0,7,DATFWD          MAKE IT NEW FORWARD ADDRESS.         26250007
         WRITE ECBE4,DI,LOGDCB,DATAREA1,4096,0,EMFBLK  UPDATE OLD BLK.  26300007
         CHECK ECBE4                                                    26350007
         XC    DATFWD,DATFWD       FIX UP NEW BLOCK WITH NO FORWARD     26400007
         MVC   DATBACK,EMFBLK      CHAIN, BACK CHAIN POINTS TO OLD FULL 26450007
         MVC   EMFBLK,EMFNEW       BLOCK, AND SETUP TO USE NEW ADDRESS. 26500007
         MVC   EMFEND,EMFNEW       MAKE CTRL BLK POINT TO NEW BLOCK.    26550007
         LH    1,EMFBLKS           ADD 1 TO NBR BLKS IN CHAIN.          26600007
         LA    1,1(1)                                                   26650007
         STH   1,EMFBLKS                                                26700007
         XC    DATLTH,DATLTH                                            26750007
         LA    0,DATSLOT1                                               26800007
         LA    1,DATEND-DATSLOT1                                        26850007
         LA    14,*                                                     26900007
         SR    15,15                                                    26950007
         MVCL  0,14                ZERO OUT THE DATA RECORD.            27000007
         B     EMFLOG45            GO MAKE ENTRY IN NEW BLOCK.          27050007
*  THIS SUBROUTINE WILL ACQUIRE AND RETURN IN REGISTER 0 A USABLE       27100007
*  DISK ADDRESS, EVEN IF IT HAS TO TAKE THE OLDEST BLOCK OUT OF THE     27150007
*  LONGEST CHAIN AND RE-USE IT.                                         27200007
EMFGETAD DS    0H                                                       27250007
         MVC   SAVECTL,EMFREL      SAVE ADDR OF THIS CTRL BLK.          27300007
         ST    SLOTREG,SAVESLOT    SAVE ITS POSITION IN THE BLK.        27350007
         MVC   SAVEBLK,EMFBLK                                           27400007
         OC    EMFREL,EMFREL       IS CTRL BLK ZERO IN CORE?            27450007
         BZ    EMFGET10            YES.                                 27500007
         XC    EMFREL,EMFREL       NO.  RESET REL BLK ADDR AND READ IT. 27550007
         READ  ECBG3,DI,LOGDCB,EMFCTRL,4096,0,EMFREL                    27600007
         CHECK ECBG3                                                    27650007
EMFGET10 L     1,EMFLAST           IS THE LAST USED ADDRESS             27700007
         LA    1,1(1)              EQUAL TO THE TOTAL NUMBER            27750007
         C     1,EMFTOTAL          OF BLKS ALLOCATED TO THE FILE?       27800007
         BE    EMFGET30            YES. GO PURGE AN OLD BLOCK.          27850007
         ST    1,EMFLAST           NO. ASSIGN A NEW NUMBER.             27900007
         SRL   1,2                 COMPUTE LAST-USED PLUS 25%           27950007
         A     1,EMFLAST                                                28000007
         C     1,EMFTOTAL          IF RESULT IS LESS THAN TOTAL NBR     28050007
         BL    EMFGET15            RECORDS, FILE ISN'T 80% FULL YET.    28100007
         TM    BUFFLAG2,BUF80P     WAS 80 PCT WTO WRITTEN ONCE?         28150007
         BNZ   EMFGET15            ONLY WRITE 80% MSG TO OPER ONCE.     28200007
         WTO   'BNG905I DEMF DATA SET IS 80 PERCENT FULL.',ROUTCDE=(2)  28250007
         OI    BUFFLAG2,BUF80P     SET 80-PCT-WTO FLAG                  28300007
EMFGET15 WRITE ECBG17,DI,LOGDCB,EMFCTRL,4096,0,EMFREL  REWRITE CTRL BLK 28350007
         CHECK ECBG17                                                   28400007
         MVC   EMFNEW,EMFLAST+1    RETURN REQUESTED ADDRESS.            28450007
EMFGET20 DS    0H                                                       28500007
         L     SLOTREG,SAVESLOT    RESTORE POINTER TO SLOT BEING USED.  28550007
         CLC   SAVECTL,EMFREL      SAME REC WE CAME IN WITH?            28600007
         BE    EMFGET25                                                 28650007
         MVC   EMFREL,SAVECTL      NO. RESTORE CTRL BLK NBR.            28700007
         READ  ECBG20,DI,LOGDCB,EMFCTRL,4096,0,EMFREL  REFRESH CTRL BLK 28750007
         CHECK ECBG20                                                   28800007
EMFGET25 DS    0H                                                       28850007
         CLC   SAVEBLK,EMFBLK      IS DATA BLK SAME ONE WE CAME IN WITH 28900007
         BE    EMFGET28            YES. GET OUT.                        28950007
         MVC   EMFBLK,SAVEBLK      RESTORE BLOCK ADDRESS.               29000007
         READ  ECBG28,DI,LOGDCB,DATAREA1,4096,0,EMFBLK                  29050007
         CHECK ECBG28                                                   29100007
EMFGET28 DS    0H                                                       29150007
         SR    0,0                                                      29200007
         ICM   0,7,EMFNEW                                               29250007
         BR    LINKREG             RETURN TO CALLER WITH NEW ADDR IN 0. 29300007
EMFGET30 TM    BUFFLAG2,BUF100P    WAS 100 PCT WTO WRITTEN ONCE?        29350007
         BNZ   EMFGET35            YES, SKIP WTO                        29400007
         WTO   'BNG906I DEMF DATA SET IS 100 PERCENT FULL. GOING INTO RX29450007
               E-USE MODE.',ROUTCDE=(2)                                 29500007
         OI    BUFFLAG2,BUF100P    SET 100-PCT-WTO FLAG                 29550007
EMFGET35 LA    SLOTREG,EMFSLOT1    POINT TO 1ST SLOT IN CTRL BLK.       29600007
         SR    BCTREG,BCTREG       SETUP TO LOOP ON NBR                 29650007
         IC    BCTREG,EMFENTS      OF ENTRIES IN BLOCK.                 29700007
         LR    1,SLOTREG           PRIME A WORK REGISTER.               29750007
EMFGET37 CLC   EMFBLKS,(EMFBLKS-EMFPORT)(1)  IS THIS BUCKET LONGER      29800007
         BNH   EMFGET40                          THAN PREVIOUS?         29850007
         LR    1,SLOTREG           YES. SAVE ITS ADDRESS.               29900007
EMFGET40 LA    SLOTREG,SLOTLTH(SLOTREG)                                 29950007
         BCT   BCTREG,EMFGET37     HERE WE HAVE LONGEST/OLDEST BUCKET.  30000007
         LR    SLOTREG,1           POINT TO LONGEST/OLDEST.             30050007
         MVC   EMFBLK,EMFSTART         READ FIRST BLOCK.                30100007
         READ  ECBH13,DI,LOGDCB,DATAREA1,4096,0,EMFBLK                  30150007
         CHECK ECBH13                                                   30200007
         MVC   EMFNEW,EMFSTART     SAVE ADDR BEING FREED UP.            30250007
         MVC   EMFSTART,DATFWD     NOW 2ND BLK BECOMES 1ST BLOCK.       30300007
         LH    0,EMFBLKS                                                30350007
         BCTR  0,0                 REDUCE NBR BLKS THIS CHAIN BY 1.     30400007
         STH   0,EMFBLKS                                                30450007
         WRITE ECBH17,DI,LOGDCB,EMFCTRL,4096,0,EMFREL                   30500007
         CHECK ECBH17                                                   30550007
         MVC   EMFBLK,EMFSTART         READ NEW FIRST BLOCK.            30600007
         READ  ECBH20,DI,LOGDCB,DATAREA1,4096,0,EMFBLK                  30650007
         CHECK ECBH20                                                   30700007
         XC    DATBACK,DATBACK     ZERO BACK-CHAIN OF NEW 1ST BLK.      30750007
         MVC   EMFBLK,EMFSTART         REWRITE NEW FIRST BLOCK.         30800007
         WRITE ECBH24,DI,LOGDCB,DATAREA1,4096,0,EMFBLK                  30850007
         CHECK ECBH24                                                   30900007
         B     EMFGET20                                                 30950007
         EJECT                                                          31000007
********           *****    CONSTANTS AND DEFINED AREAS    *****        31050007
****                                                                    31100007
LOGDCB   DCB   DDNAME=DEMFLOG,DSORG=DA,MACRF=(RIC,WIC),OPTCD=R,RECFM=F  31150007
****                                                                    31200007
CTRLTBL  DC    XL128'00'               DUMMY PORTION OF TABLE.          31250007
         DC    XL40'0102030405060708090A0B0C0D0E0F101112131415161718191X31300007
               A1B1C1D1E1F202122232425262728'                           31350007
         DC    XL88'00'               DUMMY AREA.                       31400007
***                                                                     31450007
BUFFTBL  DC    XL41'000102030405060708090A0B0C0D0E0F1011121314151617181X31500007
               91A1B1C1D1E1F20212223242526277F'                         31550007
BUFFS    EQU   40                  SIZE OF BUFFTBL-1                    31600007
***                                                                     31650007
EOTIND   DC    X'00'                   CURRENT BUFF LAST INDICATOR.     31700007
CURRBUF  DC    F'0'                    PTR TO CURRENT BUFFER BYTE.      31750007
BUFSIZE  DC    H'100'                  BUFFER SIZE VALUE.               31800007
ECBPTR   DC    F'0'                    EMF TASK ECB PTR.                31850007
STOPTR   DC    X'80'               END OF ECB LIST IND.                 31900007
         DC    AL3(STOPECB)        TERMINATION ECB.                     31950007
STOPECB  DC    F'0'                                                     32000007
REPLY    DC    D'0'                                                     32050007
CAPS     DC    X'4040404040404040' TO FOLD REPLY INTO CAPS              32100007
H4096    DC    H'4096'             CONSTANT                             32150007
H1       DC    H'1'                CONSTANT                             32200007
HEXFF    DC    X'FFFF'             DISPLAYS REQUIRE X'FFFF' IN OBR REC  32250007
FOXS     EQU   X'FF'               FOR RESETTING FLAGS                  32300007
ENDDEMF  DC    C'END DEMF'         EXACT REPLY MESSAGE TO TERM DEMF     32350007
BNGADR   DC    C'BNGLOGER'         QNAME FOR ENQ AND DEQ                32400007
BUFFRADR DC    C'BUFFER'           RNAME FOR ENQ AND DEQ                32450007
ESTAEP   DC    4F'0'               ESTAE PARMS (REG SAVE)               32500007
STAETEST DC    F'12'               STAE STORAGE TYPE TEST               32550007
STAEFLAG DC    X'00'               SWITCH SET WHEN ESTAE ENTERED        32600007
STAEON   EQU   X'80'               USED WHEN ESTAE ENTERED              32650007
ENDSIZE  EQU   8                   LENGTH OF 'END DEMF' MESSAGE         32700007
PTCHAREA DC    12F'0'              PATCH AREA                           32750007
         LTORG                                                          32800007
SAVESLOT DS    F                   SAVE POINTER TO SLOT IN USE.         32850007
SAVECTL  DS    CL3                 SAVE CTRL REC ADDRESS.               32900007
SAVEBLK  DS    CL3                 SAVE DATA BLK ADDRESS.               32950007
EMFREL   DS    CL3                 RELATIVE BLK FOR CTRL REC I/O        33000007
EMFBLK   DS    CL3                 REL BLK FOR DATA RECORD I/O          33050007
         DS    0F                                                       33100007
         DC    X'00'                                                    33150007
EMFNEW   DS    CL3                 SAVE AREA FOR NEW RELATIVE BLK ADDR  33200007
EMFSAVE  DS    16F                                                      33250007
         DS    D                                                        33300007
EMFCTRL  DS    0C                  I/O AREA COR CONTROL RECORDS.        33350007
EMFLAST  DS    F                   LAST USED BLOCK ADDRESS.             33400007
EMFTOTAL DS    F                   TOTAL BLOCKS IN DATASET.             33450007
EMFFIRST DS    F                   FIRST CTRL BLK IN CTRL CHAIN.        33500007
EMFNEXT  DS    F                   NEXT (BACKWARD) CTRL BLK IN CHAIN.   33550007
EMFENTS  DS    C                   NBR ENTRIES IN THIS CTRL BLK.        33600007
EMFRSVD  DS    CL15                RESERVED FOR FUTURE USE.             33650007
EMFSLOT1 DS    CL16          1ST OF 254 16-BYTE SLOTS IN CTRL BLK.      33700007
SLOTLTH  EQU   *-EMFSLOT1          LENGTH OF ONE SLOT.                  33750007
         ORG   EMFCTRL+4096        REST OF BLOCK                        33800007
EMFBLOCK EQU   *                   ENF OF CONTROL BLOCK.                33850007
DATAREA1 DS    0C                  AREA TO READ 1ST DATA BLOCK INTO.    33900007
DATPORT  DS    CL6                 PORT AND LIB ADDRESS                 33950007
DATTIME  DS    CL4                 TIME OF ERROR.                       34000007
DATDATE  DS    CL4                 DATE OF ERROR.                       34050007
DATFWD   DS    CL3                 FORWARD CHAIN ADDRESS.               34100007
DATBACK  DS    CL3                 BACKWARD CHAIN ADDRESS.              34150007
DATLTH   DS    CL2                 NBR BYTES USED IN THIS BLOCK.        34200007
         DS    CL10         RESERVED FOR FUTURE USER                    34250007
DATSLOT1 DS    C                   DATA BEGINS HERE.                    34300007
         ORG   DATAREA1+4096                                            34350007
DATEND   EQU   *                   END OF DATA BLOCK                    34400007
         SPACE 2                                                        34450007
********           *****     DSECTS     *****              *****        34500007
         SPACE 2                                                        34550007
IFBDCB   DSECT                                                          34600007
IFBWORK  DS    89F                     ORIG IFBDCB CSECT CODE.          34650007
IFBBUFP  DS    1F                      BUFFER AREA POINTER.             34700007
IFBASCBP DS    1F                      MVS ASCB POINTER                 34750007
         DS    4F                      RESERVED                         34800007
IFBFLGS1 DS    XL1                     DEMF                             34850007
IFBFLGS2 DS    XL1                      STATUS                          34900007
IFBFLGS3 DS    XL1                       FLAGS                          34950007
IFBFLGS4 DS    XL1                                                      35000007
         SPACE 2                                                        35050007
SAVE     DSECT                                                          35100007
SAVERSVD DC    F'0'                    RESERVED                         35150007
HSAPTR   DC    F'0'                    HIGHER SAVE AREA PTR.            35200007
LSAPTR   DC    F'0'                    LOWER SAVE AREA PTR.             35250007
REGSAVE  DC    15F'0'                  SAVE FOR REGS 14-12              35300007
WORKAREA DC    6F'0'                   WORK AREA FOR EMF.               35350007
         SPACE 2                                                        35400007
EMFSLOT  DSECT                     DSECT FOR ONE CONTROL SLOT           35450007
EMFPORT  DS    CL6                 PORT ADDRESS AND/OR LIB NAME.        35500007
EMFBLKS  DS    CL2                 NBR BLKS IN THIS DETAIL CHAIN.       35550007
EMFHITS  DS    CL2                 TOTAL NBR HITS ON THIS LINE.         35600007
EMFSTART DS    CL3                 1ST BLOCK IN THIS CHAIN. (OLDEST)    35650007
EMFEND   DS    CL3                 LAST BLOCK IN THIS CHAIN. (NEWEST)   35700007
         SPACE 2                                                        35750007
BUFFER   DSECT                                                          35800007
         DS    4000C                                                    35850007
BUFECB   DS    1F                  TASK ECB                             35900007
BUFPOSTL DS    3F                  POST LIST (MVS)                      35950007
BUFPRESZ DS    1H                  PREFIX SIZE                          36000007
BUFBYTES DS    41C                 BUSY BYTES                           36050007
BUFFLAG1 DS    XL1                 DEMF BUFFER FLAGS 1                  36100007
*  1... .... (X'80')  BUFNOLOG  DO NOT WRITE TO LOGREC IF ON EMFILE     36150007
*  .1.. .... (X'40')  BUFBIGRC  RECORD TOO BIG FOR BUFFER               36200007
*  ..1. .... (X'20')  BUFBFULL  BUFFERS FULL                            36250007
*                                                                       36300007
*  .... 1... (X'08')  BUFNOLGW    NO LOGREC RECORD IF ON EMFILE         36350007
*  .... .1.. (X'04')  BUFBIGRW    RECORD TOO BIG FOR BUFFER             36400007
*  .... ..1. (X'02')  BUFBFULW    BUFFERS FULL                          36450007
BUFFLAG2 DS    XL1                 DEMF BUFFER FLAGS 2                  36500007
*  .1.. .... (X'40')  BUF80P      SET WHEN 80 PERCENT WTO WRITTEN       36550007
*  ..1. .... (X'20')  BUF100P     SET WHEN 100 PERCENT WTO WRITTEN      36600007
         SPACE 2                                                        36650007
BUFNOLOG EQU   X'80'               NO LOGREC RECORD IF SENT TO EMFILE   36700007
BUFBIGRC EQU   X'40'               RECORD TOO BIG FOR BUFFER            36750007
BUFBFULL EQU   X'20'               BUFFERS FULL                         36800007
BUFNOLGW EQU   X'08'               WTO 'NOLOGREC' MSG                   36850007
BUFBIGRW EQU   X'04'               WTO 'RECORD TOO BIG' MSG             36900007
BUFBFULW EQU   X'02'               WTO 'BUFFERS FULL' MSG               36950007
         SPACE 1                                                        37000007
BUF80P   EQU   X'40'               WTO '80 PERCENT' MSG                 37050007
BUF100P  EQU   X'20'               WTO '100 PERCENT' MSG                37100007
         SPACE 2                                                        37150007
BTCAM    DSECT                                                          37200007
         DS    CL7                 PREFIX                               37250007
BTTYPE   DS    CL1                 MDR:91, OBR-BTAM:30, OBR-TCAM:34     37300007
         DS    CL2                 RESERVED                             37350007
BTSWTCH  DS    CL1                 OBR SWITCHES                         37400007
MDRSWTCH DS    CL1                 MDR SWITCHES                         37450007
         DS    CL32                RESERVED                             37500007
BTCCW    DS    CL1                 CCW BYTE 6 FOR TCAM OP CODE          37550007
         DS    CL10                RESERVED                             37600007
BTDDDWD  DS    CL1                 DEV DEP DATA LENGTH (IN DWORDS)      37650007
         DS    CL1                 RESERVED                    @OZ29866 37700007
BTCCTT   DS    CL2                 CU/TERM POLLING CHARS       @OZ29866 37707007
BTDEVTP0 DS    CL1                 DEVICE TYPE BYTE 0          @OZ29866 37714007
BTDEVTP1 DS    CL1                 DEVICE TYPE BYTE 1          @OZ29866 37721007
BTDEVTP2 DS    CL1                 DEVICE TYPE BYTE 2          @OZ29866 37728007
BTDEVTP3 DS    CL1                 DEVICE TYPE BYTE 3          @OZ29866 37735007
BTSDRCT  DS    CL1                 STAT. BYTE COUNT                     37750007
         DS    CL3                 RESERVED                             37800007
BTPOLL   DS    CL2                 POLL ADDRESS (X'CCTT')      @OZ29866 37850007
         DS    CL2                 RESERVED                             37900007
* START OF DEVICE DEPENDENT DATA                                        37950007
         DS    CL5                 RESERVED                             38000007
BTTCOP   DS    CL1                 TCAM TP OP CODE                      38050007
BTFLAG   DS    CL1                 OBR/SDR FLAG                         38100007
         DS    CL2                 RESERVED                             38150007
BTBTOP   DS    CL1                 BTAM OP CODE                         38200007
BTSENSE1 DS    CL1                 SENSE BYTE 1                         38250007
BTSENSE2 DS    CL1                 SENSE BYTE 2                         38300007
         DS    CL6                 RESERVED                             38350007
         END   BNGLOGER                                                 38400007
