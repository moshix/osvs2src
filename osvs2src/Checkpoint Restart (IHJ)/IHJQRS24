         TITLE 'IHJQRS24 - AOS/2 REPMAINS - IGC0905B'                   00370000
*                                                                       00380000
* STATUS -                                                              00390000
*                                                                       00392000
* FUNCTION-                                                             00394000
*    THIS ROUTINE PERFORMS CLEANUP PROCESSING SUCH AS RESETTING         00396000
*    KEYS ON PAGES WITHIN THE REGION,FREEING STORAGE FOR CONTROL        00398000
*    BLOCKS WHICH ARE NO LONGER NEEDED, AND IF ERROR PROCESSING         00398400
*    IS INDICATED, REINITIALIZING THE REGION TO ALLOW FOR PROPER        00398800
*    TERMINATION OF THE RESTART REQUEST.                                00399202
*    THIS MODULE DETECTS THE FOLLOWING ERRORS AND SETS A                00399407
*    MESSAGE CODE TO INDICATE THE TYPE OF ERROR AS FOLLOWS:             00399607
*        ERROR CODE     ERROR TYPE                                      00399807
*    1).    202         SET LOCK ERROR                                  00400007
*    2).    217         FINDPAGE ERROR                                  00400207
*                                                                       00400502
* ENTRY POINTS                                                          00401002
*          IGC0905B                                                     00401502
*                                                                       00402002
* INPUT-                                                                00449900
*    GPR12-CONTAINS ADDRESS OF THE RESTART WORK AREA                    00459900
*    ERROR CODE IN RSTWA                                                00469900
*                                                                       00479900
* OUTPUT-                                                               00489900
*    GPR1-CONTAINS THE ADDRESS OF RSTWA                                 00491900
*                                                                       00493900
* EXTERNAL REFERENCES                                                   00495900
*         FINDPAGE                                                      00497900
*         SPIE C/R ROUTINE                                       Y02076 00498002
*                                                                       00498300
* EXITS, NORMAL-                                                        00498700
*    XCTL TO JFCB PROCESSOR (IGC0G05B) TO REBUILD OPEN DATA SET TABLES  00499100
*                                                                       00499500
* EXITS, ERROR-                                                         00499600
*    XCTL TO IGC0V05B TO CONCLUDE ERROR PROCESSING.                     00499707
*                                                                       00533200
* TABLES/WORK AREAS                                                     00543200
*                                                                       00543702
*    RSTWA                                                              00553202
*                                                                       00553702
*    RPMWA                                                              00554202
*                                                                       00563200
*    TCB-TCBFLGS6                                                Y02076 00565202
*    .   TCBMSS                                                         00565600
*    .   TCBOTC                                                         00566000
*    .   TCBPKF                                                         00566400
*                                                                       00577600
*    RB-RBSIZE                                                          00587602
*    .  RBLINK                                                          00588002
*                                                                       00588400
*    SPQE-SPQEFLGS                                                      00588800
*    .    SPDQEPTR                                                      00592500
*    .    SPQEAD                                                        00594500
*    .    SPQEID                                                        00594900
*                                                                       00595300
*    DQE-DQFQEPTR                                                       00595700
*    .   DQEPTR                                                         00596102
*    .   DQEBLKAD                                                Y02076 00596602
*    .   DQELNTH                                                 Y02076 00596702
*                                                                       00597102
*    FQE-FQEPTR                                                         00646202
*                                                                       00656200
*    CVT-CVTPVTP                                                        00666202
*    .   CVTCSPIE                                                Y02076 00666702
*                                                                       00676200
*    PVT-PVTPFP2                                                 Y02076 00686202
*                                                                       00688200
*    XPTE-XPTPROT                                                       00690200
*                                                                       00692200
*    CDE-CDCHAIN                                                 Y02076 00694202
*    .   CDXLMJP                                                 Y02076 00694602
*                                                                       00695000
*    LLE-LLECHN                                                  Y02076 00695402
*                                                                       00695800
*    SCB-SCBCHAIN                                                       00695902
*                                                                       00696000
*    XTLST-XTLLNTH                                               Y02076 00712802
*                                                                Y02076 00713302
*    FOE-FOEFLNKF                                                Y02076 00713802
*                                                                Y02076 00714302
*    SSCR-SSCRID                                                 Y02076 00714802
*    .    SSCRFLG1                                               Y02076 00715302
*                                                                Y02076 00715802
*    PSA-PSALITA                                                 Y02076 00716302
*                                                                Y02076 00716802
*    SDWA-SDWARCDE                                               Y02076 00717302
*    .    SDWARTYA                                               Y02076 00717802
*                                                                       00722800
* ATTRIBUTES                                                            00724800
*    ENABLED,KEY 0 SUPERVISOR STATE                                     00726800
*                                                                       00728800
* CHARACTER CODE DEPENDENCY                                             00729200
*    NONE                                                               00729300
*                                                                       00729400
* NOTES                                                                 00735000
*    APPLICABILITY-AOS/2                                                00737000
*    SIZE- 4K DESIGN POINT                                              00739000
*    TYPE-LOAD                                                          00739400
*    RESIDENCE- SYSTEM LINK PACK AREA                                   00739800
*                                                                       00740200
* VS2-REL 3 - CHANGES/DELETIONS:                                        00743202
* 011168,014248,014281-014645                                   ZA01488 00745202
*                                                                       00746302
*APAR OZ31482 HAS BEEN FLAGGED AS @ZSUT222                     @ZSUT222 00746807
*C008160,008179,009489,009497,011107,011119,011152,011165      @ZSUT222 00747307
*C011560,011760,014270,015544,015562,016194,016203             @ZSUT222 00747607
*A008189-008209,009507-009527,011110-011116,011166-011168      @ZSUT222 00747907
*A015490,015502,015526-015538,015745                           @ZSUT222 00748807
*D011088,011092,011235                                         @ZA33625 00748907
*C011127,A011130-011139                                        @ZA33625 00749007
         EJECT                                                          00749302
IGC0905B CSECT                                                          00752302
         BALR  RB,N0               ESTABLISH ADDRESSABILITY             00755300
         USING *,RB                BASE REG=11                          00765300
         USING RSTWA,RC            BASE FOR RESTART W.A.                00767300
         USING RPMWA1,RA           BASE FOR REPMAIN W.A.                00769300
         USING TCB,R5              TCB                                  00769700
         B     RM5BEGIN            BRANCH AROUND EYE CATCHER   @Z30ESHP 00770100
         DC    H'0'                PAD 2 BYTES OF ZERO                  00774402
         DC    CL8'IGC0905B'       MODULE NAME                 @ZSUT222 00774807
         DC    CL8'&SYSDATE'       LAST DATE SHIPPED           @ZSUT222 00775107
         DC    CL8'@ZA33625'       LAST CODE SHIPPED           @ZSUT222 00775407
         DC    CL8'@SU80700'       SELECTABLE UNIT ID          @ZSUT222 00775707
RM5BEGIN XC    LOCLOCK,LOCLOCK     CLEAR LOC LOCK SWITCH       @Z30ESHP 00776007
RM5START L     RA,RSMWOFST         OFFSET TO REPMAIN W.A.               00776307
         AR    RA,RC               TO ESTABLISH BASE FOR WA             00777200
         L     R5,RSTCBAD          ADDR OF TCB                          00779200
         MVI   SWITCH,N0           CLEAR SWITCH                         00779600
         LH    R1,RSRETCOD         GET ERROR INDICATOR                  00780100
         LTR   R1,R1               PREVIOUS ERROR                       00780202
         BZ    R8A1                NO-BRANCH                            00785100
         MVI   SWITCH,N1           SET FIRST PASS ERROR SWITCH          00789100
*                                                                       00789500
* FREE SUBPOOLS FOR STC,INITIATOR,AND P/P                               00789902
*                                                                       00790000
R8B0     L     RF,LOCLOCK          IS LOCAL LOCK HELD          @Z30ESHP 00804000
         LTR   RF,RF               IS IT SET                   @Z30ESHP 00806000
         BNZ   R8B0B               BR IF YES                   @Z30ESHP 00814000
         LA    RF,CKSAVAR          GET REG SAVE ADDR           @ZSUT222 00816007
         STM   R0,RF,N0(RF)        SAVE REGS                   @Z30ESHP 00816400
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                @Z30ESHP,00816800
               RELATED=(REL,IGC0905B(XCTLA))                   @Z30ESHP 00817200
         LTR   RD,RD               LOCK SUCCESSFUL             @Z30ESHP 00817600
         LM    R0,RF,N0(RF)        RESTORE REGS                @Z30ESHP 00817700
         BZ    R8B0A               BR IF LOCK OK               @Z30ESHP 00817800
         MVI   RSRETCOD+N1,ERR202  SET LOCK ERROR              @ZSUT222 00817907
         MVC   RSREGSAV(8),MODID   SAVE NAME OF MODULE THAT    @ZSUT222 00818907
*                                  HAS DETECTED THE ERROR.     @ZSUT222 00819907
         STM   0,15,RSREGSAV+8     SAVE CURRENT REGISTERS.     @ZSUT222 00820907
         B     PREXCTL             BR TO ERROR EXIT            @Z30ESHP 00824600
R8B0A    ST    RF,LOCLOCK          SET LOCAL LOCK SWITCH       @Z30ESHP 00826600
         L     RF,CVTADDR(N0,N0)   GET CVT ADR                 @Z30ESHP 00827000
         USING CVTMAP,RF                                       @Z30ESHP 00827100
         L     R7,CVTTCBP          GET PTR TO NEXT TCB         @Z30ESHP 00827200
         LA    R7,CURASOFS(R7)     ADR CURR ASCB ADR           @Z30ESHP 00830900
         L     R7,N0(R7)           CURR ASCB ADR               @Z30ESHP 00832900
         ST    R7,USERASCB         SAVE FOR FREEMAIN           @Z30ESHP 00833300
R8B0B    L     R5,RSTCBAD          GET ADDR OF P/P TCB         @Z30ESHP 00834600
         LA    R6,N2               SET CONTROL COUNT=2                  00838300
         L     R3,RPMMSS1          GET FIRST SPQE TO BE FREED           00842000
R8B1     LTR   R3,R3               ANY SPQE'S TO BE FREED        Y02076 00862002
         BZ    R8G1                NO-BRANCH                            00872000
         USING SPQESECT,R3         SPQE                                 00874000
         TM    SPQEFLGS,SPQEOWN    IS SUBPOOL OWNED                     00874100
         BO    R8C1                YES- BRANCH                          00874200
         SR    R4,R4               SET INHIBIT DQE FREE SWITCH          00888200
         B     R8C2                FREE SPQE                            00898200
R8C1     L     R4,SPDQEPTR         GET ADDR OF FIRST DQE                00900200
R8C2     MVC   CKSAVAR(N4),SPQEAD  SAVE ADDR OF NEXT SPQE               00900600
         LA    R8,SPQESIZE         LENGTH OF SPQE                Y02076 00901002
         BAL   R2,FREEMA           FREE SPQE                   @Z30ESHP 00901400
R8D1     LTR   R4,R4               ANY DQE'S                     Y02076 00901902
         BZ    R8E1                NO-DO NEXT SPQE                      00902000
         USING DQESECT,R4          DQE                                  00902100
         L     R9,DQFQEPTR         GET THE FIRST FQE                    00906800
R8D2     MVC   CKSAVAR+N4(N4),DQEPTR SAVE ADDR OF NEXT DQE              00908800
         LA    R8,N16              SET FREEMAIN LENGTH=LEN OF DQE/FQE   00910800
         LR    R3,R4               ADDR OF AREA TO BE FREED             00911200
         BAL   R2,FREEMA           FREE DQE                    @Z30ESHP 00911300
         LR    R7,R9               GET FQE ADDRESS                      00911400
         USING FQESECT,R7          FQE                                  00923000
R8D3     LA    R7,N0(R7)           CLEAR HIGH BYTE OF FQE               00933000
         LTR   R7,R7               ANY FQE'S                            00933400
         BZ    R8D4                NO-BRANCH                            00933800
         MVC   CKSAVAR+N8(N4),FQEPTR SAVE ADDR OF NEXT FQE              00934202
         LR    R3,R7               ADDR OF AREA TO BE FREED             00934600
         BAL   R2,FREEMA           FREE FQE                    @Z30ESHP 00934700
         L     R7,CKSAVAR+N8       GET ADDR OF NEXT FQE                 00934800
         B     R8D3                PROCESS NEXT FQE                     00938700
R8D4     L     R4,CKSAVAR+N4       GET ADDR OF NEXT DQE                 00940700
         B     R8D1                PROCESS DQE                          00941100
R8E1     L     R3,CKSAVAR          GET ADDR OF NEXT SPQE                00941500
         B     R8B1                LOOP PROCESS SPQE                    00941900
         DROP  R7                  FQE                                  00942300
*                                                                       00942400
*        RESTORE STORAGE PROTECT KEYS                                   00942500
*                                                                       00946400
*                                                                       00948400
R8A1     L     R3,TCBMSS           GET FIRST P/P SPQE                   00948800
         LA    RF,CKSAVAR          GET SAVEAREA ADDR           @ZSUT222 00948907
         STM   R0,RF,N0(RF)        SAVE REGS                     Y02076 00949107
R8A1A    SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02076,00949202
               RELATED=(LOCAL,IGC0905B(R8B1A))                   Y02076 00949302
         LTR   RD,RD               SETLOCK ERROR                 Y02076 00949402
         LM    R0,RF,N0(RF)        RESTORE REGS                  Y02076 00949502
         BZ    R8A1B               IF NO ERROR, BR               Y02076 00949602
         MVI   RSRETCOD+N1,ERR202  STORE SETLOCK ERROR CODE    @ZSUT222 00949707
         MVC   RSREGSAV(8),MODID   SAVE NAME OF MODULE THAT    @ZSUT222 00950707
*                                  HAS DETECTED THE ERROR.     @ZSUT222 00951707
         STM   0,15,RSREGSAV+8     SAVE CURRENT REGISTERS.     @ZSUT222 00952707
         B     RM5START            START OVER AGAIN              Y02076 00953707
R8A1B    SR    R2,R2               CLEAR REG                            00954707
R8A2     LTR   R3,R3               ANY SPQE'S                    Y02076 00955707
         BZ    R8B                 NO-BRANCH                            00956707
         SPACE 1                                                        00960100
         SR    R6,R6               CLEAR SUBPOOL0 SWITCH                00970100
         CLI   SPQEID,N0           SPQE FOR SP0                         00970200
         BNE   R8A3                NO-CHECK FOR SP252                   01008500
         LR    R9,R3               SAVE ADDR OF SPQE                    01018500
         L     R3,SPDQEPTR         GET ADDR OF OWNER SPQE               01028500
         BAL   R6,R8A4             SET R6 TO INDICATE SUBPOOL ZERO      01038502
*                                  AND GO TO PROCESS DQE                01040500
R8A3     CLI   SPQEFLGS,SPSHARE    SPQE SHARED                          01042500
         BO    R8A7                YES-PROCESS NEXT SPQE                01044500
R8A4     L     R4,SPDQEPTR         GET FIRST DQE                        01046500
R8A5     LTR   R4,R4               ANY DQE'S                     Y02076 01046702
         BZ    R8A6C               NO-BRANCH                            01059500
         L     R7,DQEBLKAD         GET BLOCK ADDR                       01069500
         L     R8,DQELNTH          GET LENGTH OF DQE                    01071500
         LA    R8,N0(R7,R8)        GET END ADDR OF BLOCK                01071900
         IC    R2,TCBPKF           GET PROTECT KEY                      01072000
         O     R2,F8               SET FETCH PROTECT ON                 01072100
         CLI   SPQEID,N252         SUBPOOL 252                          01072200
         BNE   R8A6                NO-BRANCH                            01076500
         N     R2,F7               SET FETCH PROTECT OFF         YA2091 01078502
R8A6     LR    R1,R7               SAVE ADDR OF PAGE FOR FINDAGE/SSK    01080502
         TM    TCBFLGS6,TCBRV      IS THIS A V=R TASK                   01080600
         BO    R8A6A               YES-BRANCH                           01080700
         L     RF,CVTPTR           LOCATE THE CVT                       01091300
         USING CVT,RF              CVT                                  01101300
         L     RF,CVTPVTP          GET ADDR OF THE PVT                  01101700
         DROP  RF                  CVT                                  01102100
         USING PVT,RF              PVT                                  01105600
         L     RF,PVTPFP           LOAD ADDR OF FINDPAGE         Y02076 01107602
         DROP  RF                  PVT                                  01108000
         BALR  RE,RF               BRANCH TO FINDPAGE                   01108400
         LTR   RF,RF               NORMAL RETURN                 Y02076 01109702
         BZ    R8A6D               BR YES                        Y02076 01110202
         MVI   RSRETCOD+N1,ERR217  SET ERROR CODE--'217'       @ZSUT222 01110707
         MVC   RSREGSAV(8),MODID   SAVE NAME OF MODULE THAT    @ZSUT222 01111007
*                                  HAS DETECTED THE ERROR.     @ZSUT222 01111307
         STM   0,15,RSREGSAV+8     SAVE CURRENT REGISTERS.     @ZSUT222 01111607
         B     R8B                 GO RELEASE LOCAL LOCK       @ZSUT222 01111907
R8A6D    EQU   *                                               @ZA33625 01112707
         USING XPTE,R1             XPTE                        @ZA33625 01113007
         STC   R2,XPTPROT          PUT KEY IN XPTE             @ZA33625 01113307
         DROP  R1                  XPTE                        @ZA33625 01113607
         LRA   R1,N0(R7)           PAGE IN CORE                @ZA33625 01113907
         BNZ   R8A6B               NO-BRANCH                            01114700
R8A6A    LA    RD,N6               LOAD REG WITH CHANGE & REFERENCE     01114800
*                                  BIT MASK                             01114900
         OR    R2,RD               SET KEY TO TURN ON REFERENCE         01115000
*                                  AND CHANGE BITS                      01115100
         LA    RF,CKSAVAR          GET SAVEAREA ADDR           @ZSUT222 01115207
         STM   R0,RF,N0(RF)        SAVE REGS                     Y02076 01115402
R8A6A1   SETLOCK OBTAIN,TYPE=SALLOC,MODE=UNCOND,                 Y02076,01115602
               RELATED=(SALLOC,IGC0905B(R8A6A2))                 Y02076 01115702
         LTR   RD,RD               SETLOCK ERROR                 Y02076 01116202
         LM    R0,RF,N0(RF)        RESTORE REGS                  Y02076 01116302
         BZ    R8A6A1B             IF NO ERROR, BR               Y02076 01116402
         MVI   RSRETCOD+N1,ERR202  STORE SETLOCK ERROR CODE    @ZSUT222 01116507
         MVC   RSREGSAV(8),MODID   SAVE NAME OF MODULE THAT    @ZSUT222 01116607
*                                  HAS DETECTED THE ERROR.     @ZSUT222 01116707
         STM   0,15,RSREGSAV+8     SAVE CURRENT REGISTERS.     @ZSUT222 01116807
         B     R8B1A               GO RELEASE LOCAL LOCK         Y02076 01116907
R8A6A1B  LRA   R1,N0(R7)           PAGE IN CORE                 ZA00601 01117007
         BNZ   R8A6A2                   BR IF NOT               ZA01488 01117107
         SSK   R2,R1               SET KEY ON EACH HALF KEY     ZA00601 01117207
         LA    R1,N2048(R1)        GET NEXT HALF PAGE                   01117307
         SSK   R2,R1               SET KEY                              01117407
         STM   R0,RF,N0(RF)        SAVE REGS                     Y02076 01117507
R8A6A2   SETLOCK RELEASE,TYPE=SALLOC,                            Y02076,01117607
               RELATED=(SALLOC,IGC0905B(R8A6A1))                 Y02076 01117707
         LM    R0,RF,N0(RF)        RESTORE REGS                  Y02076 01118002
         LA    RD,OFF-N6           SET MASK FOR ANDING                  01118200
         NR    R2,RD               RESET REG2 TO ORIGINAL KEY           01121300
R8A6B    AH    R7,H4096            GET ADDR OF NEXT PAGE                01125700
         CR    R7,R8               ANY MORE PAGES LEFT                  01127900
         BL    R8A6                YES-BRANCH                           01130100
         L     R4,DQEPTR           GET NEXT DQE                         01132300
         B     R8A5                LOOP-PROCESS DQE                     01134500
R8A7     L     R3,SPQEAD           GET NEXT SPQE                        01136700
         B     R8A2                BRANC                                01138900
R8A6C    LTR   R6,R6               SP0 SWITCH SET                       01141100
         BZ    R8A7                NO-BRANCH                            01143300
         LR    R3,R9               RESTORE P/P SP0 SPQE                 01145500
         B     R8A7                GET NEXT SPQE-BRANCH                 01155500
R8B      EQU   *                   ISSUE SETLOCK                 Y02076 01155902
         LA    RF,CKSAVAR          GET SAVEAREA ADDR           @ZSUT222 01156007
         STM   R0,RF,N0(RF)        SAVE REGS                     Y02076 01156207
R8B1A    SETLOCK RELEASE,TYPE=LOCAL,                             Y02076,01156302
               RELATED=(LOCAL,IGC0905B(R8A1A))                   Y02076 01156802
         LM    R0,RF,N0(RF)        RESTORE REGS                  Y02076 01157302
         CLI   RSRETCOD+N1,N0      ANY ERRORS ENCOUNTERED        Y02076 01157802
         BNE   RM5START            IF YES, START OVER AGAIN      Y02076 01157902
         B     R8B0                BRANCH                               01158100
*                                                                       01160100
*                                                                       01160500
*                                                                       01160900
R8G1     BCTR  R6,N0               DECREMENT CONTROL COUNT              01161300
         LTR   R6,R6               WERE INITIATORS SPQE'S SAVED         01161400
         BH    R8F1                BRANCH-FREE INIT SPQE'S              01161500
         BE    R8F2                BRANCH-FREE P/P SPQE'S               01161600
         B     R8F2A               BRANCH                               01165700
R8F2     L     R3,RPMMSS3          GET ADDR OF P/P SPQE                 01167700
         B     R8B1                BRANCH-FREE SPQE                     01169700
R8F1     L     R3,RPMMSS2          GET ADDR OF INITIATOR SPQE           01169800
         B     R8B1                BRANCH FREE SPQE                     01169900
R8F2A    L     RF,LOCLOCK          IS LOCAL LOCK HELD          @Z30ESHP 01171900
         LTR   RF,RF               IS IT ZERO                  @Z30ESHP 01173900
         BZ    RMFCD               BR IF NOT HELD              @Z30ESHP 01175900
         LA    RF,CKSAVAR          GET ADR OF REG SAV AREA     @ZSUT222 01176007
         STM   R0,RF,N0(RF)        SAVE REGS                   @Z30ESHP 01177800
         SETLOCK RELEASE,TYPE=LOCAL,                           @Z30ESHP,01179800
               RELATED=(SET,IGC0905B(R8B0))                    @Z30ESHP 01182100
         LM    R0,RF,N0(RF)        RESTORE REGS                @Z30ESHP 01182200
         XC    LOCLOCK,LOCLOCK     CLEAR LOCK SWITCH           @Z30ESHP 01182700
         DROP  R3,R4               SPQE,DQE                             01183700
*                                                                       01184100
*                                                                       01185900
*                                                                       01187700
RMFCD    L     R3,RPMCDE           GET ADDR OF CDE                      01189500
         USING CDENTRY,R3          CDE                                  01191300
RMFCD1   LA    R3,N0(R3)           CLEAR HIGH BYTE                      01193100
         LTR   R3,R3               ANY CDE'S TO BE FREED                01194900
         BZ    RMFRLLE             NO-BRANCH                            01196700
         LA    R8,CDELEN           GET LENGTH OF CDE             Y02076 01198502
         L     R7,CDCHAIN          SAVE ADDR OF NEXT CDE                01200300
         TM    CDATTR,CDMIN        IS THIS A MINOR CDE                  01202100
         BO    RMFCD2              YES-NO EXTENT LIST,BRANCH            01203900
         L     R4,CDXLMJP          SAVE ADDR OF EXTENT LIST             01205700
         BAL   R2,FREEM            FREE CDE                             01207500
         LR    R3,R4               GET ADDR OF EXTENT LIST              01209300
         L     R8,XTLLNTH-XTLST(R3) GET LENGTH OF EXTENT LIST           01211100
RMFCD2   BAL   R2,FREEM            FREE EXTENT LIST                     01212900
         LR    R3,R7               RESTORE CDE PTR                      01214700
         B     RMFCD1              LOOP TO FREE NEXT CDE                01216500
         DROP  R3                  CDE                                  01218300
*                                                                       01220100
*        ROUTINE TO FREE LLE'S                                          01221900
*                                                                       01223700
RMFRLLE  L     R3,RPMLLE           GET ADDR OF FIRST LLE                01225500
         USING LLE,R3              LLE                                  01227300
RMREP    LTR   R3,R3               ANY LLE'S TO BE FREED         Y02076 01229102
         BZ    RPMFRRB             NO-BRANCH TO FREE RB                 01239100
         LA    R8,N8               GET LENGTH OF LLE                    01249100
         L     R7,LLECHN           SAVE ADDR OF NEXT LLE                01249200
         BAL   R2,FREEM            FREE LLE                             01249300
         LR    R3,R7               GET ADDR OF NEXT LLE                 01249400
         B     RMREP               LOOP-PROCESS LLE                     01259400
         DROP  R3                  LLE                                  01269400
*                                                                       01269500
*        ROUTINE TO FREE RB'S                                           01272800
*                                                                       01274800
RPMFRRB  L     R3,RPMRB            GET FIRST RB TO BE FREED             01275200
         USING RBSECT,R3           RB                                   01275600
         LA    R3,N0(R3)           CLEAR HIGH BYTE                      01276000
         LTR   R3,R3               ANY RB'S TO BE FREED                 01276100
         BZ    RMFRFOE             NO-BRANCH TO FREE FOE'S       Y02076 01276202
RMRBFREE LH    R8,RBSIZE           GET LENGTH OF RB                     01284500
         SLL   R8,N3               CONVERT TO BYTES                     01286500
         L     R4,RBLINK           SAVE ADDR OF NEXT RB                 01288500
         S     R3,KRBPREFX         GET ADDR OF PREFIX                   01290500
         BAL   R2,FREEM            FREE RB                              01292500
         LA    R3,N0(R4)           GET NEXT RB                          01292900
         CR    R3,R5               ANY MORE RB'S                        01293000
         BNE   RMRBFREE            YES-FREE RB                          01302300
*                                                                Y02076 01304302
*        ROUTINE TO FREE FOE'S                                   Y02076 01306302
*                                                                Y02076 01308302
RMFRFOE  L     R3,RPMFOE           GET ADDR OF FIRST FOE                01338200
         USING FOE,R3              FOE                                  01338600
RMFOEF   LA    R3,N0(R3)           CLEAR HIGH BYTE                      01339000
         LTR   R3,R3               FOE POINTER=0                        01339400
         BZ    RMFOEL              YES-BRANCH                           01339500
         LA    R8,FOELEN           GET LENGTH OF FOE                    01339600
         L     R7,FOEFLNKF         SAVE ADDR OF NEXT FOE                01339700
         BAL   R2,FREEM            FREE THE FOE                         01348300
         LR    R3,R7               GET ADDR OF NEXT FOE                 01350300
         B     RMFOEF              PROCESS NEXT FOE                     01352300
RMFOEL   XC    RPMFOE(N4),RPMFOE   SET FOE HEADER IN RPMW=0             01354300
         B     R9A0                BRANCH                               01356300
         DROP  R3                  FOE                                  01356700
*                                                                       01356800
*        SUBROUTINE TO FREE CORE FROM SUBPOOL 255                       01356902
*                                                                       01358000
*        REGISTER INPUT                                                 01360002
*              R2  RETURN ADDRESS                                       01360102
*              R3  ADDRESS OF CORE TO BE FREED                          01360202
*              R8  LENGTH OF CORE TO BE FREED                           01362602
*                                                                       01364600
*                                                                       01366600
*                                                                       01366700
*  ENTRY PT FOR FREEMAIN OF 16 BYTE CELLS FOR VSM BLOCKS       @Z30ESHP 01366800
*                                                                       01366900
FREEMA   L     R0,SP255            SUBPOOL ID                  @Z30ESHP 01374200
         L     R7,USERASCB         GET USER ASCB ADR           @Z30ESHP 01380200
         FREEMAIN P,A=(R3),BRANCH=YES                          @Z30ESHP 01380600
         B     FREEMB              BR TO CONTINUE              @Z30ESHP 01381000
FREEM    DS    0H                  RTN TO FREE BLOCKS                   01381800
         LR    R1,R3               GET ADDR OF BLOCK TO BE FREED        01389100
         L     R0,SP255            INDICATE SP=255                      01396400
         OR    R0,R8               GET LENGTH OF BLOCK TO BE FREED      01406400
         FREEMAIN R,LV=(0),A=(1)   FREE BLOCK                           01416400
FREEMB   LA    R3,N0(R3)           CLEAR HIGH BYTE             @Z30ESHP 01418400
         C     R3,RSCORE           WAS THIS THE LAST BLOCK RESTORED     01420400
         BCR   NOTEQ,R2            NO-RETURN TO CALLER                  01422400
R9A0     CLI   SWITCH,N1           ERROR SWITCH ON                      01424400
         BE    PREXCTL                  IF ERRS-BR TO EXIT      ZA01488 01424802
         LR    R1,RC               GET ADDRESS OF                Y02076 01425002
         A     R1,RSBFOFST         SSCR BUFFER                   Y02076 01425102
         USING SSCR,R1             SSCR                          Y02076 01425302
         LA    R2,SPIEID           ESTABLISH SPIE CODE           Y02076 01425402
         CH    R2,SSCRID           SPIE SSCR                     Y02076 01425502
         BNE   XCTLA               BR NO                         Y02076 01425602
         NI    SSCRFLG1,OFF-SSCRCKRS SET CK/RS FLG TO RS         Y02076 01426302
         DROP  R1                  SSCR                          Y02076 01426502
         L     RF,CVTPTR           GET CVT ADDRESS               Y02076 01426602
         USING CVTMAP,RF           CVT                           Y02076 01426702
         L     RF,CVTCSPIE         GET @ OF SPIE RS RTN          Y02076 01426802
         DROP  RF                  CVT                           Y02076 01426902
         LA    RD,CKSAVAR          GET REG SAVE AREA @         @ZSUT222 01427007
         BALR  RE,RF               CALL SPIE RESTART RTN         Y02076 01427407
         MVC   RSPIE(N4),TCBPIE    SAVE PIE ANCHOR               Y02076 01427507
         XC    TCBPIE(N4),TCBPIE   PREVENT USER SPIE FROM        Y02076 01427607
*                                  GETTING CONTROL               Y02076 01427707
         B     XCTLA               GO XCTL                       Y02076 01427802
*                                                                       01428002
PREXCTL  EQU   *                   ERROR EXIT ENTRY              YM7843 01548002
         MVC   RPMN40,RPMN40A      SETUP MODULE NAME FOR XCTL  @ZSUT222 01549007
         MVI   RPMN40+N4,CHARV     SET XCTL TO IGC0V05B                 01549607
         B     ERRXCTL                                         @ZSUT222 01550207
*                                                                       01550807
*        XCTL  INTERFACE FOR ALL EXITS                                  01551407
*                                                                       01552007
XCTLA    EQU   *                                               @ZSUT222 01552607
         MVC   RPMN40,RPMN40A      SETUP MODULE NAME FOR XCTL  @ZSUT222 01553207
ERRXCTL  EQU   *                                               @ZSUT222 01553807
         L     RF,LOCLOCK          GET LOCK SWITCH             @ZSUT222 01554407
         LTR   RF,RF               IS LOCL LOCK HELD           @Z30ESHP 01555007
         BZ    XCTLAA              BR IF NO                    @Z30ESHP 01555607
         LA    RF,CKSAVAR          GET REGSAVE ADR             @ZSUT222 01556207
         STM   R0,RF,N0(RF)        SAVE REGS                   @Z30ESHP 01558200
         SETLOCK RELEASE,TYPE=LOCAL,                           @Z30ESHP,01558300
               RELATED=(SET,IGC0905B(R8B0))                    @Z30ESHP 01558400
         LM    R0,RF,N0(RF)        RESTORE REGS                @Z30ESHP 01559600
         XC    LOCLOCK,LOCLOCK     CLEAR LOCK SWITCH           @Z30ESHP 01561600
XCTLAA   LA    RF,RPMN40           LOAD ADDR OF XCTL NAME      @Z30ESHP 01561700
         ST    RF,RP40XCTL         STORE IN WORK AREA                   01562900
         LA    RF,RP40XCTL         GET ADDR. OF WORK AREA FIELD         01564100
         LR    R1,RC               LOAD ADDR OF RESTART W.A.            01565300
         XCTL  SF=(E,(15))         XCTL TO NEXT LOAD                    01567300
         EJECT                                                          01569502
*                                                                       01571702
*        DEFINED  CONSTANTS                                             01572502
*                                                                       01573302
RPMN40A  DC    CL8'IGC0G05B'       NAME OF NEXT REPMAIN LOAD            01574102
MODID    DC    CL8'IGC0905B'       MODULE ID                   @ZSUT222 01574507
         DS    0F                  ALIGNMENT                            01574902
SP250    DC    X'FA001000'         GETMAIN CONSTANT FOR 4K FROM SP250   01575702
SP255    DC    X'FF000000'         GET CORE FROM LSQA                   01576502
KRBPREFX DC    AL4(RBPRFLNA)       LENGTH OF RB PREFIX                  01577302
F7       DC    F'7'                MASK FOR PROTECT OFF          YA2091 01578502
F8       DC    F'8'                MASK FOR FETCH PROTECT ON            01579702
RETCOD12 DC    H'12'               RTM NO-RTCA-ENTRY CODE        Y02076 01580902
H4096    DC    H'4096'             PAGE UPDATE                          01582102
PATCH    EQU   *                   END OF MODULE                        01583302
RM5LEN   EQU   PATCH-IGC0905B      LENGTH OF MODULE                     01584502
RM5PALEN EQU   RM5LEN/10           LENGTH OF PATCH AREA                 01585702
RM5PATCH DS    XL(RM5PALEN)        10 PERCENT ALLOWANCE FOR PATCH AREA  01586902
         SPACE 2                                                        01588102
*                                                                       01589302
*        GENERAL EQUATES                                                01590502
*                                                                       01591702
N0       EQU   0                   0                                    01592902
N1       EQU   1                   1                                    01594102
N2       EQU   2                   2                                    01595302
N3       EQU   3                   3                                    01596502
N4       EQU   4                   4                                    01597702
N6       EQU   6                   6                                    01598902
N8       EQU   8                   8                                    01600102
N16      EQU   16                  LENGTH OF DQE/FQE                    01601302
N24      EQU   24                  LENGTH OF CDE                        01602502
N252     EQU   252                 SUBPOOL 252                          01603700
N2048    EQU   2048                LENGTH OF HALF PAGE                  01604900
SPIEID   EQU   X'102'              SPIE SSCR ID                  Y02076 01605402
NOTEQ    EQU   7                   CONDITION CODE                       01614900
OFF      EQU   X'FF'               ONE BYTE OF ALL FOXES                01615300
CHARV    EQU   C'V'                CHARACTER FOR ERROR XCTL             01616900
SPQESIZE EQU   16                  LENGTH OF SPQE                Y02076 01619102
CDELEN   EQU   32                  CDE LENGTH                    Y02076 01619302
ERR217   EQU   217                 FIND PAGE ERROR CODE        @ZSUT222 01619407
ERR202   EQU   202                 SETLOCK ERROR CODE          @ZSUT222 01620307
CVTADDR  EQU   X'10'               CVT ADDR                    @Z30ESHP 01622307
CURASOFS EQU   X'0C'               OFFSET FOR CURR ASCB        @Z30ESHP 01623200
*                                                                       01629200
*        REGISTER EQUATES                                               01632800
*                                                                       01636400
R0       EQU   0                   REG 0                                01640000
R1       EQU   1                   REG 1                                01643600
R2       EQU   2                   REG 2                                01647200
R3       EQU   3                   REG 3                                01650800
R4       EQU   4                   REG 4                                01654400
R5       EQU   5                   REG 5                                01658000
R6       EQU   6                   REG 6                                01661600
R7       EQU   7                   REG 7                                01665200
R8       EQU   8                   REG 8                                01668800
R9       EQU   9                   REG 9                                01672400
RA       EQU   10                  REG 10                               01676000
RB       EQU   11                  REG 11                               01679600
RC       EQU   12                  REG 12                               01683200
RD       EQU   13                  REG 13                               01686800
RE       EQU   14                  REG 14                               01690400
RF       EQU   15                  REG 15                               01694000
         EJECT                                                          01697600
*                                                                       01701200
*        DSECT FOR REPMAIN WORK AREA                                    01704800
*                                                                       01708400
RPMWA1   DSECT                                                          01712000
         SPACE 1                                                        01715600
RPMERAS1 DS    F                   TEMP SAVE AREA                Y02076 01719202
RMNEOV   DS    F                   TO TEST IF EOV OCCURRED              01722800
RSBFSTAD DS    F                   ADDRESS OF DATA                      01726400
RSBFLWA  DS    F                   NUMBER OF BYTES REMAINING IN BUFFER  01730000
RPMMSS1  DS    F                   ADDR OF NEW L-SHAPED PROG MSS CHAIN  01733600
RPMMSS2  DS    F                   ADDRESS OF NEW INIT MSS CHAIN        01737200
RPMMSS3  DS    F                   ADDRESS OF NEW P/P MSS CHAIN         01740800
RPMRB    DS    F                   ADDRESS OF RESTORED RB CHAIN         01744400
RPMLLE   DS    F                   ADDRESS OF RESTORE LLE CHAIN         01748000
RPMCDE   DS    F                   ADDRESS OF RESTORE CDE CHAIN         01751600
RPMDEB   DS    F                   ADDRESS OF RESTORED DEB CHAIN        01755200
RPMFOE   DS    F                   ADDRESS OF RESTORED FOE CHAIN        01758800
RSCORE   DS    F                   ADDR OF CORE ACQUIRED BY LAST GETMN. 01762400
RSW001   DS    F                   POINTER TO NEXT BYTE AVAILABLE CORE  01766000
RSW002   DS    F                   POINTER TO REPMAIN SYNAD ROUTINE     01769600
RPLNT    DS    F                   LENGTH OF BLOCK                      01773200
RMADEOV  DS    F                   SAVE AREA FOR INFORMATION NEEDED     01776800
         DS    0D                  ALIGNMENT                            01780400
CKSAVAR  DS    16F                 GENERAL SAVE AREA                    01784000
RPMN40   DS    D                   MODULE NAME FOR XCTL                 01787600
RP40XCTL DC    F'0'                POINTER TO XCTL PARAMETER LIST       01791200
RSSWIT1  DS    X'00'               BIG BLOCK INDICATOR                  01794800
SWITCH   EQU   RSW001              ERROR SWITCH                         01798400
         TITLE 'IHJQRS24 - RESTART WORK AREA'                           01802000
* RESTART WORK AREA                                                     01805600
         IEEVRSWA                                                       01809200
LOCLOCK  EQU   RSERAS00            LOCK SWITCH                 @Z30ESHP 01811200
USERASCB EQU   RSERAS01            USER ASCB ADDR              @Z30ESHP 01811600
         IHAGDA                                                @Z30ESHP 01812000
         IHALDA                                                @Z30ESHP 01812400
         IHAWSAVT                                              @Z30ESHP 01812500
         TITLE 'IHJQRS24 - CONTROL VECTOR TABLE'                        01812802
* CONTROL VECTOR TABLE                                                  01816402
         CVT   DSECT=YES,PREFIX=NO                                      01820000
         TITLE 'IHJQRS24 - PAGE VECTOR TABLE'                           01823600
* PAGE VECTOR TABLE                                                     01827200
         IHAPVT                                                         01830800
         TITLE 'IHJQRS24 - TASK CONTROL BLOCK'                          01834400
* TASK CONTROL BLOCK                                                    01838000
         IKJTCB                                                         01841600
         TITLE 'IHJQRS24 - SUBSYSTEM CHECKPOINT RECORD'          Y02076 01845202
* SUBSYSTEM CHECKPOINT RECORD                                    Y02076 01848802
         IHJSSCR                                               , Y02076 01852402
         TITLE 'IHJQRS24 - REQUEST BLOCK'                               01856000
* REQUEST BLOCK - S.V.R.B.,I.R.B.,P.R.B.                                01859600
         IKJRB                                                          01863200
         TITLE 'IHJQRS24 - SUBPOOL QUEUE ELEMENT'                       01866800
* SUBPOOL QUEUE ELEMENT                                                 01870400
         IHASPQE                                                        01874000
         TITLE 'IHJQRS24 - PREFERENTIAL STORAGE AREA'            Y02076 01877602
* PREFERENTIAL STORAGE AREA                                      Y02076 01881202
         IHAPSA                                                         01884802
         TITLE 'IHJQRS24 - DESCRIPTOR QUEUE ELEMENT'                    01888400
* DESCRIPTOR QUEUE ELEMENT                                              01892000
         IHADQE                                                         01895600
         TITLE 'IHJQRS24 - FREE QUEUE ELEMENT'                          01899200
* FREE QUEUE ELEMENT                                                    01902800
         IHAFQE                                                         01906400
         TITLE 'IHJQRS24 - CONTENTS DIRECTORY ENTRY'                    01910000
* CONTENTS DIRECTORY ENTRY                                              01913600
         IHACDE                                                         01917200
         TITLE 'IHJQRS24 - EXTENT LIST'                                 01920800
* EXTENT LIST                                                           01924400
         IHAXTLST                                                       01928000
         TITLE 'IHJQRS24 - LOAD LIST ELEMENT'                           01931602
* LOAD LIST ELEMENT                                                     01935200
         IHALLE                                                         01938800
         TITLE 'IHJQRS24 - FIX OWNERSHIP ELEMENT'                       01942400
* FIX OWNERSHIP ELEMENT                                                 01946000
         IHAFOE                                                         01949600
         TITLE 'IHJQRS24 - EXTERNAL PAGE TABLE'                         01953200
* EXTERNAL PAGE TABLE                                                   01956800
         IHAXPTE                                                        01960400
         END                                                            01964007
