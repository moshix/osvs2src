IEBBAM   CSECT                                                   S20201 00200020
         TITLE 'IEBBAM  IEBCOPY BUFFER ALLOCATION'                      00400020
         SPACE 1                                                 S20201 00600020
*A401000                                                         A38728 00610000
*C814000                                                         A41780 00650000
*C114000,752000                                                  A44144 00700000
*A750500-751500                                                  A44144 00750000
*D666000                                                         A50938 00760000
*A668500                                                         A50938 00770000
*C668000,670000-672000                                           A50938 00780000
*A123000,123500,142600,143200,276000,282100-283200,303000      @ZA26248 00780199
*A401500,406200-407200,411000,442100-443900,614600,615200      @ZA26248 00783199
*C398000,410000                                                @ZA26248 00786199
*D278000,280000                                                @ZA26248 00789199
*****************************************************************S20201 00800020
*TITLE- IEBCOPY BUFFER ALLOCATION- IEBBAM                        S20201 01000020
* 192000,196000,222000,458000,246000-258000,264000,276000-278000 X010XX 01050000
* 386000,418000-438000                                           X010XX 01100000
*                                                                S20201 01200020
* CODE FROM IEBDSCPY HAS BEEN MOVED INTO THIS NEW MODULE TO      S20201 01400020
* MAINTAIN DESIGN POINT                                          S20201 01600020
*                                                                S20201 01800020
*STATUS- CHANGE LEVEL 000                                        S20201 02000020
*                                                                S20201 02200020
*FUNCTION/OPERATION- THIS MODULE ALLOCATES BUFFER AREAS          S20201 02400020
*                                                                S20201 02600020
*ENTRY POINT- ENTERED AT IEBBAM                                  S20201 02800020
*                                                                S20201 03000020
*INPUT- OPENED DCB'S                                             S20201 03200020
*                                                                S20201 03400020
*OUTPUT- ALLOCATED I/O BUFFERS                                   S20201 03600020
*                                                                S20201 03800020
*EXITS- NORMAL RETURN TO CALLER (IEBDSCPY)                       S20201 04000020
*****************************************************************S20201 04200020
         EJECT                                                          04400020
R0       EQU   0                                                 S20201 04600020
R1       EQU   1                                                 S20201 04800020
R2       EQU   2                                                 S20201 05000020
R3       EQU   3                                                 S20201 05200020
R4       EQU   4                  POINTER TO IEBMCA              S20201 05400020
R5       EQU   5                                                 S20201 05600020
R6       EQU   6                                                 S20201 05800020
R7       EQU   7                                                 S20201 06000020
R8       EQU   8                                                 S20201 06200020
R9       EQU   9                                                 S20201 06400020
R10      EQU   10                                                S20201 06600020
R11      EQU   11                                                S20201 06800020
R12      EQU   12                 BASE REGISTER                  S20201 07000020
R13      EQU   13                                                S20201 07200020
R14      EQU   14                                                S20201 07400020
R15      EQU   15                                                S20201 07600020
L3       EQU   3                                                 S20201 07800020
KL       EQU   8                                                 S20201 08000020
BL       EQU   256                                               S20201 08200020
KBLEN    EQU   KL+BL                                             S20201 08400020
CON12    EQU   12                                                S20201 08600020
FF       EQU   X'FF'                                             S20201 08800020
DIV2     EQU   1                                                 S20201 09000020
TKOFLO   EQU   X'20'                                             S20201 09200020
DBOFF    EQU   4                                                 S20201 09400020
TKOFUDGE EQU   12                                                S20201 09600020
P1       EQU   1                                                 S20201 09800020
X0       EQU   0                                                 S20201 10000020
TABLEN   EQU   10                                                S20201 10200020
NAMLEN   EQU   8                                                 S20201 10400020
SXTN     EQU   NAMLEN+NAMLEN                                     S20201 10600020
NMDISP   EQU   2                                                 S20201 10800020
L2       EQU   2                                                 S20201 11000020
L4       EQU   4                                                 S20201 11200020
CH8      EQU   C'8'                                              A44144 11400000
CHAINBK  EQU   4                                                 S20201 11600020
CHAINTHS EQU   8                                                 S20201 11800020
RETCOD4  EQU   4                                                 S20201 12000020
RETCOD8  EQU   8                                                 S20201 12200020
OFF22    EQU   22                 OFFSET OF 22                   X010XX 12250000
C1       EQU   1                                               @ZA26248 12300099
C4       EQU   4                                               @ZA26248 12330099
         EJECT                                                          12400020
         SAVE  (14,12),,*                                        S20201 12600020
         BALR  R12,R0             ESTABLISH ADDRESSABILITY       S20201 12800020
         USING START,R12                                         S20201 13000020
         USING IEBMCA,R4                                         S20201 13200020
         USING IHADCB,R3                                         X010XX 13250000
START    EQU   *                                                 S20201 13400020
         ST    R13,SV2+CHAINBK    SET UP SAVE AREA LINKAGE       S20201 13600020
         LA    R10,SV2                                           S20201 13800020
         ST    R10,CHAINTHS(R13)                                 S20201 14000020
         LR    R13,R10                                           S20201 14200020
         SR    R5,R5     CLEAR REG 5                           @ZA26248 14260099
         ST    R5,CCWAREA  CLEAR CCWAREA POINTER               @ZA26248 14300099
* FIRST, DETERMINE IF ENOUGH CORE IS AVAILABLE TO CONTAIN AT     S20201 14400020
* LEAST TWO DIRECTORY BLOCKS + FLAGS - THIS IS AN ABSOLUTE       S20201 14600020
* MINIMUM REQUIREMENT.                                           S20201 14800020
         LA    R5,KBLEN+CON12     SIZE OF 1 BLOCK + KEYLENGTH+12 S20201 15000020
         AR    R5,R5              DOUBLE IT                      S20201 15200020
         L     R7,SVHI            ADDR OF HIGHEST CORE + 1       S20201 15400020
         SR    R7,R5              CALC ADDR OF LOW END OF BUFFER S20201 15600020
         C     R7,LOCOR           WOULD THIS OVLAY EXISTNG TABLESS20201 15800020
         BNH   NOCORE             IF SO, WRT ERMSG AND GET NEXT  S20201 16000020
*                                 COPY OPER.                     S20201 16200020
         SPACE 1                                                 S20201 16400020
* MANDATORY MINIMUM CORE IS AVAILABLE. NOW CHECK FOR             S20201 16600020
* COMPRESS-IN-PLACE                                              S20201 16800020
         TM    COMDCDSW,COMPRESS  COMPRESS-IN-PLACE SPECIFIED    S20201 17000020
         BZ    ALLOCONT           NO, CONTINUE WITH ALLOCATION   S20201 17200020
         TM    COMDCDSW,SELECTSC+EXCLUDES   IS THIS IN FULL      S20201 17400020
*                                 COPY MODE                      S20201 17600020
         BZ    LDOUT              YES - GET OUTPUT TRACK CAPACITYS20201 17800020
         B     CMPERR1            NO - GO SET UP AND WRITE ERROR S20201 18000020
*                                  MESSAGE                       S20201 18200020
         SPACE 1                                                 S20201 18400020
ALLOCONT EQU   *                                                 S20201 18600020
* DETERMINE LARGEST (INPUT OR OUTPUT) BLOCKSIZE + KEYLEN         S20201 18800020
         SR    R6,R6                                             X010XX 18850000
         SR    R10,R10                                           X010XX 18900000
         TM    ULLDST,UNLOAD      ON UNLOAD                      X010XX 18950000
         BZ    BAM00100           ALSO USE UNLOADED DS BLKSIZE   X010XX 18960000
         LA    R3,ULOADDCB        GET BSAM WRITE DCB             X010XX 18970000
         LH    R10,DCBBLKSI       GET BLKSIZE                    X010XX 18980000
BAM00100 EQU   *                                                 X010XX 18990000
         LH    R8,OBLKSIZE        OUTPUT BLOCKSIZE               S20201 19000020
         LA    R3,OUTDCB          ADDR OF OUTPUT DCB             S20201 19400020
         IC    R6,DCBKEYLE        GET KEYLENGTH FROM OUTPUT DCB  S20201 19800020
         AR    R8,R6              CALC OUTPUT BLKSIZE+KEYLEN     S20201 20000020
         LA    R8,CON12(R8)       ADD CONSTANT OF 12             X010XX 20050000
         CR    R8,R10             ULOAD DCB BLKSIZE GT THIS VALUEX010XX 20100000
         BH    BAM00200           NO,USE THIS VALUE              X010XX 20150000
         LR    R8,R10             ELSE USE ULOAD BLKSIZE         X010XX 20160000
BAM00200 TM    ULLDST,LOAD        ON LOAD                        X010XX 20170000
         BZ    BAM00210           ALSO USE LOAD DCB BLKSIZE      X010XX 20180000
         LA    R3,LOADDCB         GET BSAM READ DCB              X010XX 20190000
         LH    R10,DCBBLKSI       GET BLKSIZE                    X010XX 20192000
BAM00210 EQU   *                                                 X010XX 20194000
         LH    R9,IBLKSIZE        INPUT BLOCKSIZE                S20201 20200020
         LA    R3,INDCB                                          S20201 20400020
         IC    R6,DCBKEYLE                                       S20201 20600020
         AR    R9,R6              CALC INPUT BLKSIZE+KEYLEN      S20201 20800020
         LA    R9,CON12(R9)       ADD CONSTANT OF 12             X010XX 20850000
         CR    R9,R10             LOAD BLKSIZE GT THIS VALUE     X010XX 20900000
         BH    BAM00220           NO,USE THIS VALUE              X010XX 20950000
         LR    R9,R10             ELSE USE LOAD BLKSIZE          X010XX 20960000
BAM00220 EQU   *                                                 X010XX 20970000
         CR    R9,R8              COMP INPUT VS. OUTPUT          S20201 21000020
         BNH   USEOUT             IF NOT HIGHER, USE OUTPUT SIZE S20201 21200020
         LR    R8,R9              ELSE USE INPUT SIZE INSTEAD    S20201 21400020
         SPACE 1                                                 S20201 21600020
USEOUT   EQU   *                  DETERMINE IF SIZE USED EXCEEDS S20201 21800020
*                                 MINIMUM FOR TWO DIRCTY BLKS    S20201 22000020
         LR    R9,R8                                             S20201 22400020
         AR    R9,R9              DOUBLE SIZE                    S20201 22600020
         CR    R9,R5              IS 2 X SIZE GRTR TH MINIMUM REQS20201 22800020
*                                 FOR TWO DIRECTORY BLOCKS       S20201 23000020
         BH    SETMAX             YES, SEE IF ENOUGH CORE FOR NEWS20201 23200020
*                                 MANDATORY MINIMUM              S20201 23400020
         SPACE 1                                                 S20201 23600020
         LA    R10,KBLEN+CON12    NO - STILL USE DIRCTY BLKSIZE  S20201 23800020
         ST    R10,MAXBLK         SET LENGTH OF 1 MIN BFR AREA   S20201 24000020
         ST    R5,MINSIZ          SET LENGTH OF 1 PAIR OF MIN BFRS20201 24200020
*                                 AREAS                          S20201 24400020
TR2BLKS  EQU   *                                                 X010XX 24450000
         SPACE 1                                                 S20201 26000020
* NOW SEE IF 2 OF THE LARGEST CURRENT (INPUT OR OUTPUT) DEVICE   S20201 26200020
* BLOCKSIZES ARE GREATER THAN  THE MINIMUM BUFFER SIZE           X010XX 26400000
* ALREADY KNOWN TO BE AVAILABLE                                  S20201 26600020
         SR    R1,R1                                             X010XX 26650000
         TM    ULLDST,UNLOAD      ON UNLOAD                      X010XX 26700000
         BO    BAM00270           ONLY INPUT DEVTYPE MATTERS     X010XX 26750000
         L     R1,OUTCHAR+DBOFF   GET OUTPUT TRACK-BLOCKSIZE     S20201 26800020
BAM00270 TM    ULLDST,LOAD        ON LOAD                        X010XX 26850000
         BO    CKDBSZ             ONLY OUTPUT DEVTYPE MATTERS    X010XX 26900000
         C     R1,INCHAR+DBOFF    IS IT LESS THAN INPUT          S20201 27000020
         BNL   CKDBSZ             NO, USE IT                     S20201 27200020
         L     R1,INCHAR+DBOFF    YES, USE INPUT TRACK-BLOCKSIZE S20201 27400020
CKDBSZ   LA    R1,CON12(R1)  ALLOW ROOM FOR FLAG AND COUNT FLD @ZA26248 27600099
         L     R7,SVHI            ADDR OF HICORE + 1             S20201 27650099
         SLL   R1,C1         DOUBLE TRACK SIZE                 @ZA26248 27700099
         CR    R1,R10        IS TWO TRK GREATER THAN ONE BLOCK @ZA26248 27750099
         BH    BAM00274        NO, USE ONE BLOCK               @ZA26248 27800099
         LR    R1,R10          USE ONE BLOCK                   @ZA26248 27850099
BAM00274 EQU   *                                               @ZA26248 27900099
         LR    R0,R1          RESERVE SPACE FOR ONE            @ZA26248 27950099
*                             CCW PER 128 BYTES                @ZA26248 28000099
         SRL   R0,C4                                           @ZA26248 28050099
         SR    R7,R0                                           @ZA26248 28100099
         SRL   R7,C4           PUT ON DOUBLE WORD BOUNDARY     @ZA26248 28150099
         SLL   R7,C4                                           @ZA26248 28200099
         ST    R7,CCWAREA                                      @ZA26248 28250099
         SR    R7,R1              SUBTR 2 X LARGEST TRACK BLKSIZES20201 28400020
         SR    R7,R1                                             S20201 28600020
         C     R7,LOCOR           ENOUGH CORE FOR 2 TRKS (APPR.) S20201 28800020
         BNH   TRYHALF            NO - TRY FOR 1/2 OF WHATEVER ISS20201 29000020
*                                  AVAILABLE                     S20201 29200020
         LR    R10,R1             YES - SET TO ALLOCATE 2 TRKS   S20201 29400020
         OI    FLG2,TRKS2         INDICATE USING 2 TRKLENGT BFRS S20201 29600020
         NI    FLG2,FF-MBUSED                                    S20201 29800020
         B     SETBCB             GO TEST FOR OUTPUT TRK OVFLO   S20201 30000020
         SPACE 1                                                 X010XX 30050000
*  NOW TRY TO GET 4 BLOCKSIZES IF NOT AVAILABLE,USE MIN BUFFERS  X010XX 30100000
TRYHALF  L     R7,SVHI            ADDR OF HIGH CORE + 1          S20201 30200020
         XC    CCWAREA(C4),CCWAREA  CLEAR CCWAREA POINTER      @ZA26248 30300099
         LR    R3,R7                                             S20201 30400020
         S     R3,LOCOR           CALC AMT OF AVAILANLE SPACE    S20201 30600020
         LR    R6,R5              GET MINIMUM BUFFERPAIR SIZE    X010XX 30650000
         AR    R6,R6              DOUBLE IT TO 4 BLOCKS          X010XX 30700000
         CR    R3,R6              ENOUGH SPACE FOR THAT          X010XX 30750000
         BNH   USEMIN             NO,USE MINIMUM BUFFERS         X010XX 30760000
         SPACE 1                                                 X010XX 30770000
*ALLOCATE THE LARGER OF 4 BLOCKSIZES AND HALF THE AVAILABLE SPACEX010XX 30780000
         SRL   R3,DIV2            DIVIDE BY 2                    S20201 30800020
         LR    R2,R7              ADDR OF HIGH CORE + 1          S20201 31000020
         SR    R7,R3              CALC LOW ADDR OF THIS SPACE    S20201 31200020
         SR    R2,R6              SUBTR LENGTH OF DOUBLE MIN BFR S20201 31400020
*                                  PAIR                          S20201 31600020
         CR    R7,R2              IS HICOR-LOCOR/2 LESS THAN     S20201 31800020
*                                 HICOR-2 BFR PAIR               S20201 32000020
         BNL   USE2BLK2           IF NOT, THEN THE AMOUNT OF CORES20201 32200020
*                                  FOR USING 2 BFRS OF 2         S20201 32400020
*                                 BLOCKSIZES EACH IS LARGER, SO  S20201 32600020
*                                  IT WILL BE USED FOR ALLOC.    S20201 32800020
         SRL   R3,DIV2            CALC SIZE OF 1/2 BUFFER AREA   S20201 33000020
*                                  (MAY TRUNCATE,BUT THIS IS OK) S20201 33200020
         LR    R10,R3             GET SIZE INTO R10 FOR SETUP OF S20201 33400020
*                                  BCB                           S20201 33600020
         B     XTRK2              GO RESET TRKS2 AND SET UP BCB  S20201 33800020
SETMAX   EQU   *                  MINIMUM CORE REQUIRED IS TWICE S20201 34000020
*                                 LARGEST (BLKSIZE+KEYLEN+12)    S20201 34200020
         L     R7,SVHI            ADDR OF HIGHEST AVAIL CORE + 1 S20201 34400020
         SR    R7,R9              CALC ADDR OF START OF MIN BFR  S20201 34600020
         C     R7,LOCOR           ENOUGH SPACE FOR MINIMUM BUFFERS20201 34800020
         BNH   NOCORE             NO - WRT ERMSG AND GO TO NXT   S20201 35000020
*                                  COPY OPER.                    S20201 35200020
         ST    R8,MAXBLK          SET LENGTH OF 1 MIN BFR AREA   S20201 35400020
         ST    R9,MINSIZ          SET LENGTH OF 1 PAIR OF MIN BFRS20201 35600020
         LR    R5,R9              SET UP MIN LENGTH TO USE IN TRYS20201 35800020
*                                  FOR LARGER AREA               S20201 36000020
         LR    R10,R8                                            S20201 36200020
         B     TR2BLKS            TRY FOR AT LEAST DOUBLE-SIZE   S20201 36400020
*                                  BUFFERS                       S20201 36600020
         SPACE 1                                                 S20201 36800020
USE2BLK2 EQU   *                                                 S20201 37000020
*                 ONE TRK IS GT. 1 BLK ,BUT NOT ENOUGH CORE FOR  X010XX 37200000
*                 2 TRKS IS AVAILABLE.  FURTHERMORE, 1/2 OF      S20201 37400020
*                 AVAILABLE CORE IS LESS THAN 4 BLOCKSIZES. SINCES20201 37600020
*                  LARGER BUFFERS ENHANCE PERFORMANCE, SPACE FOR S20201 37800020
*                 4 BLOCKSIZES WILL BE ALLOCATED IN THIS CASE.   S20201 38000020
*                 AVAILABILITY CHECKED IN 306000 ETC             X010XX 38050000
         LR    R7,R2              SET UP WHAT WILL BE LOW ADDR   S20201 38200020
*                                  IN BCB                        S20201 38400020
         LR    R10,R5             GET LENGTH OF 1 BFR AREA       S20201 38450000
*                                  FOR LATER                     S20201 38500000
         B     XTRK2              NOW GO HANDLE JUST AS IF AREA  X010XX 38600000
*                                 TO BE ALLOCATED IS GREATER     S20201 38800020
*                                  THAN 2 TRKS                   S20201 39000020
         SPACE 2                                                 S20201 39200020
LDOUT    EQU   *                  SET TO ALLOCATE FOR            S20201 39400020
*                 COMPRESS-IN-PLACE.  MANDATORY BUFFER REQ'MENT  S20201 39600020
*              IS TWO 1-TRACK BUFFERS, TRY FOR 4 FIRST         @ZA26248 39800099
         L     R10,OUTCHAR+DBOFF  GET OUTPUT TRACK-BLOCKSIZE     S20201 39850099
         LA    R10,CON12(R10)     ADD 12 TO SIZE BEING USED      A38728 39900099
         SLL   R10,C1         DOUBLE THE BUFFER SIZE           @ZA26248 39950099
         LR    R9,R10                                            S20201 40000099
         AR    R9,R9              DOUBLE THE SIZE OF 1 TRACK     S20201 40050099
         L     R7,SVHI            ADDR OF HICORE + 1             S20201 40100099
         LR    R0,R9          ALLOW ROOM FOR CCW               @ZA26248 40150099
         SRA   R0,C4          PER 128 BYTES OF BUFFER          @ZA26248 40200099
         SR    R7,R0                                           @ZA26248 40250099
         SRL   R7,C4          PUT ON DDOUBLE WORD              @ZA26248 40300099
         SLL   R7,C4                                           @ZA26248 40350099
         ST    R7,CCWAREA     SET POINTER TO CCW AREA          @ZA26248 40400099
         SR    R7,R9              CALC WHERE BFRS WOULD START    S20201 40450099
         C     R7,LOCOR           SPACE FOR TWO 2-TRACK BFRS   @ZA26248 40500099
         BNH   NOCOREC1           NO - GO TRY 1 TRK BUF        @ZA26248 40550099
         BNH   NOCOREC            NO - GO WRT ERROR MSG          S20201 41200020
         OI    FLG2,MBUSED        INDICATE NO BUFFER-SQUEEZING   S20201 41400020
*                                  ALLOWED                       S20201 41600020
*                                 GO RESET 'TRKS2' AND           X010XX 41800000
*                                  ALLOCATE BCB                  S20201 42000020
         SPACE 1                                                 S20201 42200020
XTRK2    NI    FLG2,FF-TRKS2      RESET INDICATOR OF 2-TRK ALLOC.S20201 44000020
         B     SETBCB             GO SET UP BCB                  S20201 44200020
NOCOREC1 L     R10,OUTCHAR+DBOFF  GET OUTPUT TRACK-BLOCKSIZE   @ZA26248 44210099
         LA    R10,CON12(R10)     ADD 12 TO SIZE BEING USED    @ZA26248 44219099
         LR    R9,R10                                          @ZA26248 44228099
         AR    R9,R9              DOUBLE THE SIZE OF 1 TRACK   @ZA26248 44237099
         L     R7,SVHI            ADDR OF HICORE + 1           @ZA26248 44246099
         LR    R0,R9          ALLOW ROOM FOR CCW               @ZA26248 44255099
         SRA   R0,C4          PER 128 BYTES OF BUFFER          @ZA26248 44264099
         SR    R7,R0                                           @ZA26248 44273099
         SRL   R7,C4          PUT ON DDOUBLE WORD              @ZA26248 44282099
         SLL   R7,C4                                           @ZA26248 44291099
         ST    R7,CCWAREA     SET POINTER TO CCW AREA          @ZA26248 44300099
         SR    R7,R9              CALC WHERE BFRS WOULD START  @ZA26248 44309099
         C     R7,LOCOR           SPACE FOR TWO 1-TRACK BFRS   @ZA26248 44318099
         BNH   NOCOREC            NO - GO WRT ERROR MSG        @ZA26248 44327099
         OI    FLG2,MBUSED        INDICATE NO BUFFER-SQUEEZING @ZA26248 44336099
*                                  ALLOWED                     @ZA26248 44345099
*                                 GO RESET 'TRKS2' AND         @ZA26248 44354099
*                                  ALLOCATE BCB                @ZA26248 44363099
        B      XTRK2                                           @ZA26248 44372099
         SPACE 1                                                 S20201 44400020
USEMIN   EQU   *                  ALLOCATE MINIMUM SIZES INTO BCBS20201 44600020
         OI    FLG2,MBUSED        INDIC NO 'SQUEEZING' OF BFR    S20201 44800020
*                                  ALLOWED                       S20201 45000020
         NI    FLG2,FF-TRKS2                                     S20201 45200020
         L     R7,SVHI            COMPUTE STARTING ADDR+1 OF BCB S20201 45400020
         S     R7,MINSIZ                                         S20201 45600020
SETBCB   TM    ULLDST,UNLOAD      ON UNLOAD                      X010XX 45800000
         BO    SETBCB1            DONT CARE FOR OVERFLOW         X010XX 45850000
         LA    R3,OUTDCB          ADDR OF OUTDCB                 X010XX 45900000
         TM    DCBRECFM,TKOFLO    IS TRACK OVERFLOW SPECIFIED ON S20201 46000020
*                                  OUTPUT                        S20201 46200020
         BZ    SETBCB1            NO - BCB CAN NOW BE ALLOCATED  S20201 46400020
*              IF YES, IT IS NECESSARY TO ADD TO THE SIZE OF THE S20201 46600020
*              SECOND (OR ''OUTPUT'') BUFFER AREA TO ACCOMMODATE S20201 46800020
*              ENOUGH EXTRA SPACE FOR ADDITIONAL SEGMENTATION    S20201 47000020
*              OF OUTPUT RECORDS.                                S20201 47200020
         C     R10,OUTCHAR+DBOFF  IS ''INPUT'' BFR GT OUTPUT     S20201 47400020
*                                  TRACKSIZE                     S20201 47600020
         BH    CALC12X            YES - NEED TO COMPUTE A        S20201 47800020
*                                  FUDGE FACTOR                  S20201 48000020
         LA    R9,TKOFUDGE        NO - SET FUDGE FACTOR TO 12,   S20201 48200020
*                                 TO ALLOW FOR ONE EXTRA SEGMENT S20201 48400020
*                                 IF NEEDED                      S20201 48600020
ADDX     LR    R8,R10             SET TO CALC LENGTH OF          S20201 48800020
*                                  INPUT+OUTPUT+FUDGE FACTOR     S20201 49000020
         AR    R8,R8                                             S20201 49200020
         AR    R8,R9              ADD FUDGE FACTOR TO TWICE      S20201 49400020
*                                  INPUT BFRLEN                  S20201 49600020
         L     R2,SVHI            GET ADDR OF HIGHEST AVAIL-     S20201 49800020
*                                  ABLE CORE + 1                 S20201 50000020
         SR    R2,R8              SUBTR TOTAL ADJUSTED BUFFER    S20201 50200020
*                                  LENGTH                        S20201 50400020
         C     R2,LOCOR           IS ENOUGH EXTRA CORE SPACE     S20201 50600020
*                                  AVAILABLE                     S20201 50800020
         BNH   TSTMXB             IF NOT, SEE IF IT IS POSSIBLE  S20201 51000020
*                                  TO SHORTEN THE LENGTH OF THE  S20201 51200020
*                                 ''INPUT'' BUFFER,THEREBY EFFEC-S20201 51400020
*                                  TIVELY INCREASING THE LENGTH  S20201 51600020
*                                  OF THE OUTPUT BUFFER          S20201 51800020
         SR    R7,R9              ELSE ADJUST POIMTER TO START OFS20201 52000020
*                                  BUFFER AREA  BY NUMBER OF     S20201 52200020
*                                  BYTES IN FUDGE FACTOR         S20201 52400020
SETMB    OI    FLG2,MBUSED        INHIBIT FUTURE DE-ALLOCATION   S20201 52600020
         B     SETBCB1            NOW GO SET UP BCB              S20201 52800020
         SPACE 1                                                 S20201 53000020
TSTMXB   C     R10,MAXBLK         IS LENGTH OF ''INPUT'' BUFFER  S20201 53200020
*                                  GT THE MINIM. ALLOWABLE SIZE  S20201 53400020
         BNH   NOCORE             IF NOT,CANT SHORTEN IT -       S20201 53600020
*                                 GO WRITE MSG                   S20201 53800020
         SR    R10,R9             YES - DECREASE LENGTH OF       S20201 54000020
*                                  ''INPUT'' BFR BY FUDGE FACTOR S20201 54200020
         C     R10,MAXBLK         WAS TOO MUCH TAKEN OUT OF THIS S20201 54400020
*                                  BUFFER                        S20201 54600020
         BL    NOCORE             YES - WRT ERROR MESSAGE        S20201 54800020
         B     SETMB              NO - GO SET UP TO ALLOCATE BCB S20201 55000020
         SPACE 1                                                 S20201 55200020
CALC12X  SR    R8,R8                                             S20201 55400020
         L     R5,OUTCHAR+DBOFF   GET LENGTH OF TRACK-BLOCKSIZE  S20201 55600020
*                                  FROM DEVTYPE AREA             S20201 55800020
         LR    R9,R10             LENGTH OF INPUT BUFFER AREA    S20201 56000020
         DR    R8,R5              DIV TRK-BLKSIZE INTO INPUT     S20201 56200020
*                                 BUFFERSIZE                     S20201 56400020
         LTR   R8,R8              ANY REMAINDER                  S20201 56600020
         BZ    ADDONE             NO, DONT ADD TWO TO QUOTIENT   S20201 56800020
         LA    R9,P1(R9)          ADD 1 TO QUOTIENT, AND THEN -  S20201 57000020
ADDONE   LA    R9,P1(R9)          ADD 1 TO QUOTIENT              S20201 57200020
         SR    R8,R8                                             S20201 57400020
         LA    R5,TKOFUDGE        GET FIDGE FACTOR FOR 1 SEGMENT S20201 57600020
         MR    R8,R5              MPLY BY NBR OF OUTPUT TRACK-BLKS20201 57800020
*                                  SIZES (CEILING + 1) WHICH FIT S20201 58000020
*                                  INTO INPUT BUFFER LENGTH.     S20201 58200020
*                                  THIS YIELDS MAXIMUM SUM OF    S20201 58400020
*                                  12-BYTE SEGMENTATION FACTORS  S20201 58600020
*                                  TO BE ADDED TO LENGTH OF      S20201 58800020
*                                  OUTPUT BUFFER                 S20201 59000020
         B     ADDX               ADD THIS MUCH TO TOTAL BFR LNGTS20201 59200020
SETBCB1  BCTR  R7,R0              SUBTR 1 FROM ADDR IN R7        S20201 59400020
         ST    R7,BCB             SET STARTING ADDR OF FIRST     S20201 59600020
*                                  BUFFER AREA                   S20201 59800020
         ST    R7,HICOR           SET AS ADDR+1 OF HIGHEST       S20201 60000020
*                                  AVAILABLE CORE                S20201 60200020
         AR    R7,R10             ADD KENGTH OF 1 BFR AREA       S20201 60400020
         ST    R7,ENDFST1         SET ADDR OF END OF 1ST BUFFER  S20201 60600020
         LA    R7,P1(R7)          ADD 1 TO GET ADDR OF START OF  S20201 60800020
*                                  SECOND BUFFER                 S20201 61000020
         ST    R7,BEGFST2         SET STARTING ADDR OF 2ND BFR   S20201 61200020
         ST    R10,BUFSIZ         SAVE LENGTH OF 1 BUFFER AREA   S20201 61400020
         AR    R7,R10         GET END OF SECOND BUFFER         @ZA26248 61460099
         ST    R7,END2ND2     SET POINTER TO END SEC BUFFER    @ZA26248 61500099
         DROP  R3                                                S20201 61600020
*        END OF BUFFER ALLOCATION                                S20201 61800020
         EJECT                                                          62000020
* PREPARE TO SCAN INPUT DIRECTORY ENTRIES FOR MEMBERS TO BE      S20201 62200020
* COPIED FROM THE ''CURRENT'' INPUT DATA SET -                   S20201 62400020
         TM    COMDCDSW,SELECTSC  IS THIS A SELECTIVE COPY       S20201 62600020
         BZ    SETNNCT1           IF NOT, GO CLEAR NEWNAME COUNT S20201 62800020
         L     R7,CTAD            ADDR OF CTLTAB TO VARIOUS AREASS20201 63000020
         ST    R7,BUMP                                           S20201 63200020
         ST    R7,NMAD                                           S20201 63400020
         TM    FLG3,FTINGP        HAS INDD-GROUP INITIALIZION    S20201 63600020
*                                  OCCURRED                      S20201 63800020
         BO    TESUF              YES,CHECK CNT OF UNFOUND MBRS  S20201 64000020
         OI    FLG3,FTINGP        SET INDD-GROUP-INITIALIZED SW. S20201 64200020
         LH    R7,NNCT1           ANY NEWNAMES                   S20201 64400020
         LTR   R7,R7                                             S20201 64600020
         BZ    ASRT1              IF NOT, GO SORT SETAB ALPH. BY S20201 64800020
*                                  MEMBERNAME                    S20201 65000020
         L     R7,BUMP            ADDR OF SETAB                  S20201 65200020
         L     R6,BCB             SET UP TO EXTRACT OLD/NEWNAME  S20201 65400020
*                                 PAIRS                          S20201 65600020
         LA    R6,X0(R6)          ADDR OF BFR - SET HI ORDER BYTES20201 65800020
*                                  TO ZERO                       S20201 66000020
TSB2     TM    X0(R7),SEBIT2      IS THIS A RENAMED MEMBER       S20201 66200020
         BO    SVNOLD             IF SO, SAVE OLD/NEW NAME PAIRS S20201 66400020
NLST     LA    R7,TABLEN(R7)      POINT TO NXT SETAB ENTRY       A50938 66800000
         C     R7,SESTOP          IS THIS THE LAST ENTRY         A50938 66850000
         BL    TSB2               IF NOT LAST ENTRY DONE,LOOP    A50938 67000000
*                                 TO TEST NEXT                   A50938 67200000
         B     ASRT1              IF SO, DO ALPH. SORT OF TABLE  S20201 67400020
SVNOLD   LA    R8,SXTN(R6)        ADD 16 TO CURR. BUFFER ADDR    S20201 67600020
         C     R8,ENDFST1         IF THIS EXCEEDS AVAIL BFR AREA,S20201 67800020
         BNL   NOCORENN           GO WRT MSG AND TERM.           S20201 68000020
         MVC   X0(NAMLEN,R6),NMDISP(R7)  MOVE OLDNAME TO BUFFER  S20201 68200020
         MVC   NAMLEN(NAMLEN,R6),TABLEN+NMDISP(R7)  NEWNAME TO   S20201 68400020
*                                 BUFFER                         S20201 68600020
         LA    R6,SXTN(R6)        POINT TO NXT AVAIL BFR AREA    S20201 68800020
         LA    R7,TABLEN(R7)      SKIP OLDN. AND                 S20201 69000020
         B     NLST               GO SEE IF NEWNAME IS LAST ENTRYS20201 69200020
SETNNCT1 XC    NNCT1(L2),NNCT1    SET NEWNAME COUNT TO 0         S20201 69400020
         XC    ENCT(L2),ENCT      SET CTLTAB ENTRY-COUNT TO 0    S20201 69600020
         L     R8,LOCOR           ADDR OF LOWEST YET-UNUSED CORE S20201 69800020
         ST    R8,CTAD            INIT WHERE TO BLD CTLTAB       S20201 70000020
*                                 (EXCL/FULL)                    S20201 70200020
         ST    R8,BUMP            INIT POINTER USED WHILE BLDG   S20201 70400020
*                                  TLTAB                         S20201 70600020
         TM    COMDCDSW,EXCLUDES  IS THIS AN EXCLUSIVE COPY      S20201 70800020
         BZ    SBFLGS             IF NOT, GO PREPARE TO READ     S20201 71000020
*                                 INPUT DIR                      S20201 71200020
         MVC   NMAD(L4),SEBEGIN   SET ADDR OF NAMES FROM ADDR OF S20201 71400020
*                                  SETAB                         S20201 71600020
         TM    FLG3,SORTDONE      WAS ALPH SORT DONE (CURRENT    S20201 71800020
*                                  INDD GRP)                     S20201 72000020
         BO    SBFLGS             IF SO, GO SET UP I/O FLAGS     S20201 72200020
         B     ASRT1              ELSE GO DO ALPH SORT OF SETAB  S20201 72400020
TESUF    SR    R8,R8                                             S20201 72600020
         CH    R8,UFCT            IS COUNT OF UNFOUND MBRS = 0   S20201 72800020
         BNE   SBFLGS             IF NOT, LOOK FOR MORE ON THIS  S20201 73000020
*                                 IN DS                          S20201 73200020
         STH   R8,INDDCT          ELSE SET TO SKIP REST OF       S20201 73400020
*                                  INPUT DD'S                    S20201 73600020
* AT THIS POINT, SET UP TO WRT INFORMATIVE MSG SAYING ALL        S20201 73800020
*        SELECTED MEMBERS WERE FOUND, AND NOT ALL INPUT          S20201 74000020
*        DATA SETS WERE REQUIRED.                                S20201 74200020
*        LINK TO WRT MSG                                         S20201 74400020
         B     TOTERM1            GO TO TERMINATE CURR INDD GROUPS20201 74600020
         EJECT                                                          74800020
SLMSGGSC EQU   *                                                 S20201 75000020
         CLI   RCBUF,CH8          IS COMPLETION CODE 8 OR HIGHER A44144 75050000
         BNL   DONTSET            YES- DON'T SET RETURN CODE     A44144 75100000
         MVI   RCBUF,CH8          SET COMPLETION CODE            A44144 75150000
DONTSET  EQU   *                                                 A44144 75200000
         MVI   VTMFLG1,UNUSEND    INDICATE UNUSUAL TERMINATION OFS20201 75400020
*                                 THIS COPY STEP/OPERATION       S20201 75600020
SLMSG    EQU   *                                                 S20201 75800020
         LA    R15,RETCOD8        SET RETURN CODE=8              S20201 76000020
         B     RETMAIN            TO RETURN TO IEBDSCPY          S20201 76200020
TOTERM1  EQU   *       CURR INDD-GROUP SUCCESSFULLY COMPLETED -  S20201 76400020
*                                 NEXT CARD                      S20201 76600020
         MVI   PARAMS,MSGULLD     MSG COULD BE CHANGED           X010XX 76650000
         MVI   COPDISP,OFF22      AT DISPLACEMENT OF 22          X010XX 76700000
         MVI   MSG1+P1,M48        MSG CODE                       S20201 76800020
         B     SLMSG              GO TO SET LAST MSG INDICATOR   S20201 77000020
NOCORE   EQU   *    CANT GET MIN I/O BFR SPACE - GET NXT COPY CD S20201 77200020
         MVI   MSG1+P1,M40        MSG CODE                       S20201 77400020
         B     SLMSGGSC           SET RC TO 4, WRT MSG, TERMINATES20201 77600020
NOCOREC  EQU   *    NOT ENUF CORE FOR I/O BFRS DURING COMPRESS   S20201 77800020
         MVI   MSG1+P1,M41        MSG CODE                       S20201 78000020
         B     SLMSGGSC           SET RC TO 4, WRT MSG, TERMINATES20201 78200020
NOCORENN EQU   *   OLD/NEW NAMES DONT ALL FIT IN BFR-NXT COPY CD S20201 78400020
         MVI   MSG1+P1,M43        MSG CODE                       S20201 78600020
         B     SLMSGGSC           SET RC TO 4, WRT MSG, TERMINATES20201 78800020
ASRT1    EQU   *                                                 S20201 79000020
         SR    R15,R15            SET RETURN CODE=0              S20201 79200020
         B     RETMAIN            TO RETURN TO IEBDSCPY          S20201 79400020
CMPERR1  EQU   *                  CANNOT COMPRESS WITH SELECT/   S20201 79600020
*                                 EXCLUDE                        S20201 79800020
         MVI   MSG1+P1,M39        MSG CODE                       S20201 80000020
         B     SLMSGGSC           SET RC TO 4,WRT MSG,TERMINATE  S20201 80200020
SBFLGS   EQU   *                                                 S20201 80400020
         LA    R15,RETCOD4        SET RETURN CODE=4              S20201 80600020
RETMAIN  L     R13,SV2+CHAINBK    RESTORE PTR TO SAVEAREA        S20201 80800020
         RETURN (14,12),,RC=(15)  RETURN TO BRANCHTABLE IN DSCPY S20201 81000020
PATCHLN  EQU   (*-START)/20       5 PER-CENT PATCH AREA LENGTH   S20201 81200020
PATCH    DC    XL(PATCHLN)'00'    PATCH AREA                     A41780 81400000
         EJECT                                                          81600020
IEBMCA   DSECT                                                   S20201 81800020
         IEBMCA                                                  S20201 82000020
         DCBD  DSORG=PS                                          S20201 82200020
         END                                                            82400020
