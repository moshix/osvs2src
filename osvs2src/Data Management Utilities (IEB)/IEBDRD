READ     TITLE 'IEBCOPY  READ ROUTINE- IEBDRD WITH TRACK OVERFLOW'      00200019
IEBDRD   CSECT                                                          00400019
*C 298440                                                      @YM06446 00402002
*A 298440-298492                                               @YM06435 00410002
*A 298100-298420,845394                                        @YM06434 00450002
*C 299500,299800,299600,299988                                 @YM06434 00452002
*D 299600,299900,299980,299992                                 @YM06434 00454002
*A 298500-299992                                               @YM06433 00456002
*D320500-321500                                                  A34431 00460021
*D460400-461600                                                  A36080 00520021
*D699200                                                         A37873 00560021
*C845200                                                         A41780 00570021
*C455200-455800,458420-459000,462600-466500                      A41741 00570121
* 600000,789000                                                  X010XX 00570200
*A685100                                                        OY01181 00579202
*A508510-508560                                                 OY01185 00588202
*A419500-421498                                                 YA01454 00591202
*C420000                                                        YA01454 00594202
*A294020-296000                                                 YL026VD 00596202
*A178200-178840                                                @ZA00915 00596402
*A224000-225500                                                @ZA04404 00596699
*A359930-360630                                                @ZA10909 00596799
*A156500-157999,158499-158939,294088-294099,294232-294455      @ZA26248 00597799
*A294841-295927,296341-297838,298045,436500-437999,            @ZA26248 00598199
*A438499-439889,830500-836984,884500-885999,886499             @ZA26248 00598599
*D158000,294500,296000,298000,438000,886000                    @ZA26248 00598999
         SPACE 1                                                        00600019
*TITLE- IEBCOPY READ ROUTINE- IEBDRD                                  * 00800019
*                                                                     * 01000019
*STATUS- CHANGE LEVEL 001                                             * 01200019
*                                                                     * 01400019
*FUNCTION/OPERATION-  THIS MODULE READS DIRECTORIES, MEMBER DATA OR   * 01600019
*       NOTE LISTS FROM THE OUTPUT DATA SET, THE INPUT DATA SET,      * 01800019
*       SYSUT3 AND SYSUT4 DATA SETS. IT  STARTS READING INTO THE      * 02000019
*       LOCATION POINTED TO BY 'READNEXT' AND READS UNTIL AN          * 02200019
*       END OF FILE IS READ OR THE BUFFERS ARE FULL.                  * 02400019
*                                                                     * 02600019
*ENTRY POINTS- ENTERED AT IEBDRD FOR NORMAL READ                      * 02800019
*                                                                     * 03400019
*INPUT- SWITCH NAMED 'STATUS' IS SET BY CALLER TO TELL READ ROUTINE   * 03600019
*       WHICH DATA SET IS BEING READ  (INPUT OR OUTPUT).              * 03800019
*       SWITCH NAMED 'SENSE' IS SET BY CALLER TO TELL READ ROUTINE    * 04000019
*       WHICH DATA SET IS BEING READ (SYSUT3,SYSUT4 OR NOTE LIST).    * 04200019
*       BUFFER CONTROL BLOCK NAMED 'BCB' IS SET TO POINT TO BUFFERS   * 04400019
*       WHERE DATA IS TO BE READ.                                     * 04600019
*       'READNEXT' IS SET TO ADDRESS WHERE DATA IS TO BE READ.        * 04800019
*       INITIALIZE FDAD IN PROPER DCB BEFORE FIRST READ BY CALLER     * 05000019
*                                                                     * 05200019
*OUTPUT- DATA IS READ INTO LOCATION SPECIFIED. LAST RECORD IN A       * 05400019
*       BUFFER AND LAST RECORD IN LAST BUFFER (LASTREC AND ENDPROC    * 05600019
*       RESPECTIVELY) ARE SET IN FLAG FIELD FOR PROPER RECORD. IOB IS * 05800019
*       UPDATED FOR EACH READ                                         * 06000019
*       'RDGSW' SET TO SHOW READ BEING DONE.                          * 06050019
*       'RDEOF' SWITCH SET WHEN END OF FILE READ                      * 06100019
*       SYNADAF MACRO GIVEN TO CLARIFY HARD I/O ERRORS                * 06150019
*                                                                     * 06200019
*EXTERNAL ROUTINES- PCI APPENDAGE IGG019C8, EXCP, WAIT, SYNADAF MACRO,* 06300019
*                                                                     * 06600019
*EXITS- RETURN TO CALLER ON SUCCESSFUL READ                           * 06900019
*       ENTER MODULE WHICH GIVES SYNADAF AND PREPARES AND ISSUES      * 07200019
*     MESSAGE IDENTIFYING THE I/O ERROR.                              * 07500019
*                                                                     * 07800019
*TABLES/WORK AREAS-                                                   * 08000019
*       -BCB-       POINTERS TO BUFFERS                               * 08200019
*       -IOB-       NEEDED BY EXCP- INIOB,OUTIOB,UT3IOB,UT4IOB        * 08400019
*       -EVENTCB-   EVENT CONTROL BLOCK FOR EXCP                      * 08600019
*       -RDPTR1-    ADDRESS OF CURRENT CCW                            * 08800019
*       -RDPTR2-    ADDRESS OF NEXT CCW                               * 09000019
*       -SV4-       REGISTER SAVE AREA USED IN IEBMCA                 * 09200019
*                                                                     * 09400019
*ATTRIBUTES- SERIAL REUSABLE                                          * 09600019
*                                                                     * 09800019
         EJECT                                                          10000019
*                                                                     * 11400019
*              SYMBOLIC REGISTERS FOR READ ROUTINE                    * 11600019
*                                                                     * 11800019
*                     BASE ADDRESS REGISTER 12, COMMON AREA- 4        * 12000019
*                                                                     * 12200019
         SPACE 1                                                        12400019
GR0   EQU 0                                                             12600019
GR1   EQU 1                                                             12800019
GR2   EQU 2                                                             13000019
GR3      EQU   3                  POINTER TO END OF BUFFER              13200019
GR4      EQU   4                  COMMON AREA POINTER                   13400019
GR5      EQU   5                  POINTER TO IOB                        13600019
GR6      EQU   6                  POINTER TO START OF RECORD            13800019
GR7   EQU 7                                                             14000019
GR8   EQU 8                                                             14200019
GR9      EQU   9                  POINTER TO END OF NXT REC TO BE READ  14400019
GR10  EQU 10                                                            14600019
GR11     EQU   11                                                       14800019
GR12     EQU   12        BASE ADDRESS REGISTER                          15000019
GR13     EQU   13                                                       15200019
GR14     EQU   14                                                       15400019
GR15     EQU   15                                                       15600019
C1       EQU   1                                               @ZA26248 15650099
R0       EQU   0                                               @ZA26248 15659099
R2       EQU   2                                               @ZA26248 15668099
R1       EQU   1                                               @ZA26248 15677099
R3       EQU   3                                               @ZA26248 15686099
C2       EQU   2                                               @ZA26248 15695099
L5       EQU   5                                               @ZA26248 15704099
C4       EQU   4                                               @ZA26248 15713099
R5       EQU   5                                               @ZA26248 15722099
R6       EQU   6                                               @ZA26248 15731099
R7       EQU   7                                               @ZA26248 15740099
R8       EQU   8                                               @ZA26248 15749099
R9       EQU   9                                               @ZA26248 15758099
R10      EQU   10                                              @ZA26248 15767099
R11      EQU   11                                              @ZA26248 15776099
*                                                              @ZA26248 15785099
C5       EQU   5                                               @ZA26248 15794099
C6       EQU   6                                               @ZA26248 15803099
C7       EQU   7                                               @ZA26248 15812099
C8       EQU   8                                               @ZA26248 15821099
C9       EQU   9                                               @ZA26248 15830099
C10      EQU   10                                              @ZA26248 15839099
C12      EQU   12                                              @ZA26248 15848099
KBLEN    EQU   256+8          DIRECTORY PLUS KEY               @ZA26248 15857099
*                                                              @ZA26248 15866099
         EJECT                                                          15899919
         SAVE  (14,12),,*                                               16000019
         BALR  GR12,GR0                GET ADDRESSABILITY               16200019
         USING START,GR12                                               16400019
         USING IEBMCA,4                                                 16600019
START    EQU   *                                                        16800019
         ST    GR13,SV5+P4             POINTER TO OLD SAVE AREA IN NEW  17000019
         LA    GR15,SV5                                                 17200019
         ST    GR15,X8(GR13)           POINTER TO NEW SAVE AREA IN OLD  17500019
         LR    GR13,GR15                                                17800019
         LA    GR3,SECTOR              RESTORE THE ADDRESSES   @ZA00915 17820002
         ST    GR3,SSECTOR              IN THE SET/READ SECTOR @ZA00915 17840002
         MVI   SSECTOR,X'23'            CCWS TO VIRTUAL, IS    @ZA00915 17860002
         ST    GR3,RSECTOR              CHANGED TO REAL BY     @ZA00915 17880002
         MVI   RSECTOR,X'22'            IGG019FT               @ZA00915 17884002
         LA    GR9,ERREPTST            EXCP RETURN ADDRESS-INITIALIZE   17900019
         OI    AOS,PCI                 TURN ON PCI PROC FLAG     X010XX 17950000
         OI    WSFLAG,RDGSW            SET READING SWITCH               18000019
         LA    GR6,RDCW11              GET 1ST CCW ADDRESS              18020019
         LA    GR7,RDCW21              GET 2ND CCW ADDRESS              18040019
         STM   GR6,GR7,RDPTR1          INITIALIZE POINTERS              18060019
         L     GR5,READNEXT            WHERE TO START READ              18080019
         MVC   X1(L3,GR7),READNEXT+P1  INIT SECOND CHAIN TO      X010XX 18090000
         MVC   X9(L3,GR7),READNEXT+P1  POINT WITHIN BUFFER       X010XX 18100000
         MVI   X0(GR5),ZERO            INITIALIZE F BYTE                18110019
         LA    GR5,X4(GR5)             SPACE POINTER OVER FMBB          18140019
         ST    GR5,X0(GR6)             STORE ADDRESS WHERE COUNT READ   18170019
         TM    SENSE,SENSE3            SPECIAL READ 1 RECORD AT A TIME  18200019
         BO    SPECIAL                 YES                              18400019
         TM    STATUS,STAT4            READING INPUT MEMBER             18600019
         BZ    DIRECTB                 NO                               18700019
SETBLK   EQU   *                                                        18900019
         SR    GR10,GR10                                                18950019
         LA    GR11,INDCB                                               19000019
         USING IHADCB,GR11                                              19050019
         IC    GR10,DCBKEYLE           GET KEY LN. FROM DCB             19130019
         AH    GR10,IBLKSIZE           KEY LN + BLOCKSIZE               19190019
         TM    DCBRECFM,OVERFLOW       INPUT TRK OVERFLOW               19210019
         BO    TRKOVFL                 YES-GO TO SPECIAL READ SUB/RTN.  19230019
         STH   GR10,RDCW12+P6          SET INTO RKD CCW BYTE COUNT      19260019
         STH   GR10,RDCW22+P6          SET INTO RKD CCW BYTE COUNT      19290019
         SRL   GR10,X11                DIV BY 2K                 X010XX 19300000
         STC   GR10,RDL1               STORE MAX LENGTH IN LIST  X010XX 19310000
         OI    RDL1,X80                RESTORE OPTION BIT        X010XX 19312000
         STC   GR10,RDL2               STORE MAX LENGTH IN LIST  X010XX 19314000
         OI    RDL2,X80                RESTORE OPTION BIT        X010XX 19316000
         LA    GR11,OUTDCB             GET OUTPUT DCB PTR.              19320019
         TM    DCBRECFM,OVERFLOW       OVERFLOW ON OUTPUT ONLY          19340019
         BZ    GETADDR                 NO-CONTINUE                      19360019
         OI    FLG1,STOPEND1           YES - USE ONLY 1ST BUFFER        19380019
         B     GETADDR                 CONTINUE                         19400019
         SPACE 1                                                        19600019
DIRECTB  EQU   *                                                        19800019
         MVC   RDCW12+P6(L2),MAXRECI   MAXIMUM DIRECTORY RECORD SIZE    20000019
         MVC   RDCW22+P6(L2),MAXRECI   SIZE = 264 BYTES                 20200019
         MVI   RDL1,X80                RESTORE LENGTH LT 2K      X010XX 20250000
         MVI   RDL2,X80                RESTORE LENGTH LT 2K      X010XX 20300000
         SPACE 1                                                        20400019
GETADDR  EQU   *                                                        20600019
         LA    GR8,X8                                                   20800019
         AR    GR5,GR8                 POINT TO KEY/DATA FIELD          21000019
         SPACE 1                                                        21200019
SETUPALL EQU   *                                                        21400019
         ST    GR5,X8(GR6)             STORE IN FIRST RKD CCW           21500019
         MVI   X0(GR6),RCMT            RESTORE RC-MT OP CODE            21600019
         ST    GR8,X4(GR6)             RESTORE COUNT                    21700019
         MVI   X4(GR6),FLAG40          SET CC                           21800019
*                                      MAY HAVE CHANGED CCW             22150019
         MVI   X8(GR6),RKD             RESTORE RKD OP CODE              22250019
         MVI   X12(GR6),FLAG68         SET CC,SLI,PCI                   22350019
         TM    STATUS,STAT4       READING MEMBER?              @ZA04404 22400099
         BO    AROUND             YES,KEEP OPTION BITS IN CCW  @ZA04404 22450099
         NI    X12(GR6),X'DF'     NO,TURN OFF SLI BIT          @ZA04404 22500099
AROUND   EQU   *                                               @ZA04404 22550099
         TM    SENSE,SENSE4            READING FOR COMPRESS             22800019
         BO    SETSCAN                 YES, USE OUTDCB                  22900019
         TM    STATUS,STAT1+STAT4      READING INPUT DIRECTORY OR MEMBR 23000019
         BC    MIXONE,SPLUT4           YES                              23200019
         TM    STATUS,STAT2            READING OUTPUT DIRECTORY         23400019
         BO    SPLUT3                  ESTABLISH CORRECT DCB AND IOB    23900019
         LA    GR5,UT4IOB              PUT CORRECT IOB IN GR5 LEAVE IT  24400019
         B     GETGOING                SET UP FOR EXCP                  24600019
         SPACE 1                                                        24800019
SETSCAN  EQU   *                                                        24840019
         L     GR5,RDPTR2              START OF NEXT CCW CHAIN TO DO    24880019
         MVC   X0(L12,GR5),X0(GR6)     MAKE BOTH CCW CHAINS THE SAME    24900019
         TM    STATUS,STAT2            READING OUTPUT DIRECTORY         24930019
         BZ    SPLUT4                  NO-XFER TO READ INPUT MEMBER     24940019
         SPACE 1                                                        24960019
SPLUT3   EQU   *                                                        25000019
         LA    GR5,OUTIOB              PUT CORRECT IOB IN GR5 LEAVE IT  25200019
         B     GETGOING                SET UP FOR EXCP                  25400019
SPLUT4   EQU   *                                                        25600019
         LA    GR5,INIOB               PUT CORRECT IOB IN GR5 LEAVE IT  25800019
GETGOING EQU   *                                                        26000019
         L     GR7,DCB4IOB(GR5)        DCB POINTER FROM IOB             26200019
         LA    GR7,X0(GR7)             CLEAR HIGH ORDER BYTE            26300019
         MVC   IOBMCCHH(L8,GR5),DISKADR(GR7) MOVE FDAD TO IOB SEEK ADR  26400019
         SPACE 1                                                        26600019
IOBCAWST EQU   *                                                        26800019
         OI    IOBFLGS(GR5),NONSEQEN   SET COMD CHAIN-UNRELATED FLAGS   27000019
         LA    GR6,IOBCCHHR(GR5)       PICK CCHHR OUT OF IOB            27200019
         LA    GR1,CCW1                STARTING CCW                     27400019
         ST    GR6,X0(GR1)             STORE SEARCH ID CCHHR            27600019
         MVI   X0(GR1),SIDEQ           RESTORE SIDEQ OP CODE            27800019
         ST    GR1,READLIST            BEGIN OF CHAIN            X010XX 27802000
*                                        (FOR EXTEND LIST)       X010XX 27802400
         MVI   READLIST,X03            LENGTH OF CHAIN           X010XX 27804000
         L     GR6,RDPTR1              PTR TO FIRST CHAIN        S20201 27805020
         LA    GR6,X0(GR0,GR6)         CLEAR HIGH ORDER BYTE     S20201 27810020
         TM    SENSE,SENSE7            READING FIRST RECORD OF A S20201 27815020
*                                        TRACK OVERFLOW MEMBER   S20201 27820020
         BNO   NOTFIRST                NO, GO AROUND             S20201 27825020
         LA    GR8,X8                  LOAD CONSTANT OF 8        S20201 27830020
         SR    GR6,GR8                 SUBTRACT 8 FROM POINTER   S20201 27835020
*                                 IN RDPTR1 SO THAT NOP AND      S20201 27840020
*                                 POSSIBLY RS CCW WILL BE        S20201 27845020
*                                 CONSTRUCTED IN THE CORRECT     S20201 27850020
*                                 CCW SLOT                       S20201 27855020
NOTFIRST EQU   *                                                 S20201 27860020
         MVI   X16(GR6),NOP            CONSTRUCT NOP CCW         S20201 27865020
*                                        AFTER FIRST CHAIN       S20201 27870020
         LA    GR8,DEVOFF(GR0,GR5)     GET PTR TO DEVTYPE INFO   S20201 27875020
         TM    X1(GR8),RPS             IS THIS AN RPS DEVICE     S20201 27880020
         BNO   NOTRPS                  NO, GO ON                 S20201 27885020
         SPACE 1                                                 S20201 27890020
*   IF RPS IS SUPPORTED A SET SECTOR  CCW CHAIN IS               S20201 27895000
* APPENDED TO THE NORMAL CCW CHAIN                               S20201 27900000
         SPACE 1                                                 S20201 27905020
         LA    GR1,SSECTOR             PTR TO SET SECTOR CCW     S20201 27910020
         ST    GR1,READLIST            BEGIN OF CHAIN            X010XX 27912000
*                                        (FOR EXTEND LIST)       X010XX 27912400
         MVI   READLIST,X04            LENGTH OF CHAIN           X010XX 27914000
         MVC   X16(L4,GR6),RSECTOR     REPLACE NOP WITH RS       S20201 27915020
         LA    GR6,SCTOFF(GR0,GR5)     LOAD PTR TO CURRENT       S20201 27920020
*                                        SECTOR VALUE            S20201 27925020
         MVC   SECTOR(L1),X0(GR6)      MOVE VALUE TO ''SECTOR''  S20201 27930020
         TM    SENSE,SENSE3            READ ONE RECORD ONLY      S20201 27935020
         BNO   NOTRPS                  NO, GO ON                 S20201 27940020
         TM    SENSE,SENSE2            READING NOTELIST          S20201 27945020
         BNO   NOTRPS                  NO, GO ON                 S20201 27950020
         MVI   SECTOR,X0               SET SECTOR VALUE TO 0     S20201 27955020
*                                      (DON'T KNOW CORRECT       S20201 27960020
*                                      VALUE)                    S20201 27965020
NOTRPS   EQU   *                                                 S20201 27970020
         ST    GR1,IOBCAW(GR5)         ADDRESS FIRST CCW TO BE DONE     28000019
         SPACE 1                                                        28200019
BUILDTIC EQU   *                                                        28400019
         MVC   CCW3+P1(L3),RDPTR1+P1   MOVE ADDRESS TO TIC CCW          28600019
         SPACE 1                                                        28800019
         SPACE 1                                                        29200019
STRTIO   EQU   *                                                        29400019
         TM    AOS,PCI                 NEED PCI HANDLING        YL026VD 29402002
         BO    STRTIOVR                YES, DO EXCPVR           YL026VD 29404002
         EXCP  (GR5)                   ISSUE EXCP READ MACRO    YL026VD 29406002
         WAIT  1,ECB=EVENTCB           ISSUE WAIT MACRO         YL026VD 29408002
         BR    GR9                     RETURN FROM READING      YL026VD 29408402
STRTIOVR ST    GR5,IOBVRPTR                                     YL026VC 29408699
*              TEST TO SEE IF COMMAND CHANNING ONLY            @ZA26248 29408899
*              SHOULD BE USED AND IF IT CAN BUILD              @ZA26248 29411899
*              ALTERNATE SET OF CCWS TO PERFORM                @ZA26248 29414899
*              OPERATION.                                      @ZA26248 29417899
*                                                              @ZA26248 29420899
*              REGISTER R6, R7, R1, R0, R5                     @ZA26248 29423899
*                                                              @ZA26248 29426899
*                                                              @ZA26248 29429899
         TM    COMDCDSW,COMPRESS IF COMPRESS USE COMMAND CHAIN @ZA26248 29432899
         BO    BX25                                            @ZA26248 29435899
         TM    FLG2,TRKS2 TEST IF A 2 TRACK BUF                @ZA26248 29438899
*              ALLOCATED YES, PROCEED                          @ZA26248 29441899
*                                                              @ZA26248 29444899
         BZ    BX2                                             @ZA26248 29447899
*                                                              @ZA26248 29450899
BX25     TM    STATUS,STAT1+STAT2+STAT3 ONLY HANDLE            @ZA26248 29453899
         BZ    BX2            NO USE PCI                       @ZA26248 29456899
*                                                              @ZA26248 29459899
BX20     NI    AOS,X'FF'-PCI  TURW                             @ZA26248 29462899
*                                                              @ZA26248 29465899
         L     R1,CCWAREA     POINTER OF WHERE TO BUILD CCWS   @ZA26248 29468899
         LM    R6,R7,DRCCW1   MODELCCW                         @ZA26248 29471899
         L     R5,CCW3        GET CCW PLANED TO BE USED        @ZA26248 29474899
*                                                              @ZA26248 29477899
         L     R5,X0(X0,R5)   GET BUFFER ADDRESS               @ZA26248 29480899
         LA    R5,X0(X0,R5)   WHICH IS +4 TO JUMP FMBB         @ZA26248 29483899
BX6      EQU   *                                               @ZA26248 29486899
         LA    R0,KBLEN+C12(R5)    TEMP ADVANCE TO NEXT SLOT   @ZA26248 29489899
         TM    FLG7,DM        MERGING DIRECTORIES              @ZA26248 29492899
         BZ    BUF2ND         NO ASSUME BUFFER NOT SPLIT       @ZA26248 29495899
*                                                              @ZA26248 29498899
         C     R0,ENDFST1     EXCEED FIRST BUFFER              @ZA26248 29501899
         BNL   BX5            YES, GO READ THESE BUFFERS       @ZA26248 29504899
BX7      LA    R0,X4          BACK UP TO FLAG FIELD            @ZA26248 29507899
         SR    R5,R0                                           @ZA26248 29510899
         MVI   X0(R5),X0        CLEAR FLAG                     @ZA26248 29513899
         AR    R5,R0          INCREMENT TO PATH AREA.          @ZA26248 29516899
         STM   R6,R7,X0(R1)                                    @ZA26248 29519899
         STCM  R5,C7,X1(R1)   INSERT ADDRESS                   @ZA26248 29522899
         LA    R1,X8(X0,R1)   BUMP TO NEXT CCW SLOT            @ZA26248 29525899
         C     R1,SVHI        TEST IF USED UP CCW AREA         @ZA26248 29528899
         BNL   BX5            YES, GO READ WHAT'S BUILT        @ZA26248 29531899
*                                                              @ZA26248 29534899
         LA    R5,KBLEN+C12(R5) ADVANCE TO NEXT SLOT IN BUFFER @ZA26248 29537899
*                                                              @ZA26248 29540899
         B     BX6            LOOP BACK                        @ZA26248 29543899
BUF2ND   C     R0,END2ND2      EXCEEDED END 2ND BUFFER         @ZA26248 29546899
         BNH   BX7            NO, CONTINUE BUILD               @ZA26248 29549899
*                                                              @ZA26248 29552899
*                                                              @ZA26248 29555899
*                                                              @ZA26248 29558899
BX5      EQU   *              PREPARE TO READ THIS LOAD        @ZA26248 29561899
*                                                              @ZA26248 29564899
         LA    R0,X8          BACK UP TO LAST CCW              @ZA26248 29567899
         SR    R1,R0                                           @ZA26248 29570899
         NI    X4(R1),X'FF'-CC      TURN OFF COMD CHAIN        @ZA26248 29573899
*                                                              @ZA26248 29576899
         L     R5,X0(X0,R1)   GET ADDRESS LAST BUFFER          @ZA26248 29579899
         LA    R0,X4          BACK UP TO                       @ZA26248 29582899
         LA    R5,X0(X0,R5)   FLAG FIELD                       @ZA26248 29585899
         SR    R5,R0                                           @ZA26248 29588899
*                                                              @ZA26248 29591899
         MVI   X0(R5),LASTREC+ENDPROC                          @ZA26248 29594899
*                                                              @ZA26248 29597899
         MVC   CCW3+X1(L3),CCWAREA+X1                          @ZA26248 29600899
*                                                              @ZA26248 29603899
         L     R5,IOBVRPTR    GET IOB                          @ZA26248 29606899
BX9      EXCP  (R5)           REQUEST IO BE DONE               @ZA26248 29609899
*                                                              @ZA26248 29612899
         WAIT  1,ECB=EVENTCB  WAIT FOR COMPLETION              @ZA26248 29615899
         USING DXIOB,R5                                        @ZA26248 29618899
         L     R6,IOBCSW  GET LAST CCW+8                       @ZA26248 29621899
         LA    R6,X0(R6)      CLEAR OP FIELD                   @ZA26248 29624899
         DROP  R5                                              @ZA26248 29627899
         LA       R0,X8 BACK UP TO CCW                         @ZA26248 29630899
         SLR   R6,R0                                           @ZA26248 29633899
*                                                              @ZA26248 29636899
         CLI   EVENTCB,INTRCEPT                                @ZA26248 29639899
         BE    BX9            YES-REISSUE EXCP                 @ZA26248 29642899
*                                                              @ZA26248 29645899
         MVC   CURRCCW2+X1(L3),X1(R6)                          @ZA26248 29648899
         CLI   EVENTCB,PERMIO TEXT FOR ERRORS                  @ZA26248 29651899
         BNE   BX8            NO, CONTINUE PROCESSION          @ZA26248 29654899
*                                                              @ZA26248 29657899
         TM    IOBCSWST(R5),UNCHK                              @ZA26248 29660899
         BNO   BX8            YES ERROR                        @ZA26248 29663899
*                                                              @ZA26248 29666899
         SR    R6,R0          GO BACK TO GOOD CCCW             @ZA26248 29669899
         C     R6,CCWAREA     TEST THAT ENDED IN CCWAREA       @ZA26248 29672899
         BL    BX13           NO, GET OUT                      @ZA26248 29675899
         C     R6,SVHI                                         @ZA26248 29678899
         BH    BX13           NO ,GET OUT                      @ZA26248 29681899
BX8      NI    X4(R6),X'FF'-CC                                 @ZA26248 29684899
*                                                              @ZA26248 29687899
         LA    R0,X4          SETR0 TO BACK TO FLAG            @ZA26248 29690899
         L     R6,CCWAREA     GET FIRST CCW                    @ZA26248 29693899
BX11     L     R1,X0(X0,R6)   GET BUFFER                       @ZA26248 29696899
         SLR   R1,R0          BACK TO FLAG                     @ZA26248 29699899
         MVC   X1(L3,R1),IOBMCCHH(R5)                          @ZA26248 29702899
         MVC   IOBCCHHR(L5,R5),X4(R1) MOVE CCHHR TO IOB FOR    @ZA26248 29705899
*                                     POSSIBLE RESTART         @ZA26248 29708899
*                                                              @ZA26248 29711899
*                         IF READING OUTPUT DIRECTORY COUNT DIR@ZA26248 29714899
*                               BLOCKS, FIND HIGHEST R         @ZA26248 29717899
         TM    STATUS,STAT2   TEST IF READING OUT DIR          @ZA26248 29720899
         BZ    BX12        BRANCH NO                           @ZA26248 29723899
*                                                              @ZA26248 29726899
         CLC   IOBRECNO(L1,R5),NDBTR IS CURRENT REC HIGH       @ZA26248 29729899
         BL    BX14                                            @ZA26248 29732899
         MVC   NDBTR(L1),IOBRECNO(R5) SET NEW HIGH             @ZA26248 29735899
*                                                              @ZA26248 29738899
BX14     TM    TAG,CTOUT      CHECK COUNTING DIR BLOCKS        @ZA26248 29741899
         BZ    BX12   BRANCH  NOT CNT  DIRECTORY               @ZA26248 29744899
         LH    R7,DIRBCNT     INCREMENT COUNT                  @ZA26248 29747899
         LA    R7,X1(X0,R7)   OF                               @ZA26248 29750899
         STH   R7,DIRBCNT     DIRECTORY BLOCKS                 @ZA26248 29753899
*                                                              @ZA26248 29756899
BX12     TM    X4(R6),CC                                       @ZA26248 29759899
         BZ    BX13A                                           @ZA26248 29762899
         LA    R6,X8(X0,R6)                                    @ZA26248 29765899
         B     BX11                                            @ZA26248 29768899
BX13A    TM    SENSE,SENSE4     TEST FOR SCANNING              @ZA26248 29771899
         BNO   BX13             BRANCH IF NOT SCANNING         @ZA26248 29774899
         CLI   EVENTCB,OKCODE     IF NOT EOF OR EXETENT        @ZA26248 29777899
         BE    BX20             CONTINUE SCANNING              @ZA26248 29780899
         B     BX13          REACHED ENDING CONDITION, GET OUT @ZA26248 29783899
BX2      L     GR5,IOBVRPTR                                    @ZA26248 29786899
         OI    AOS,PCI                                         @ZA26248 29789899
         LR    GR1,GR5                                          YL026VD 29792899
         EXCPVR (1),SUBSYS             ISSUE EXCPVR READ MACRO  YL026VD 29795899
         WAIT  1,ECB=EVENTCB           ISSUE WAIT MACRO                 29798899
BX13     OI    AOS,PCI        FAKE PCI                         @ZA26248 29801899
         L     GR6,IOBVRPTR            ADDR OF IOB JUST USED   @YMO6434 29810002
         LA    GR6,C35(GR6)            ADDR OF CCHHR           @YM06434 29820002
         STCM  GR6,X7,CCW1+X1          STORE INTO SIDEQ CCW    @YM06434 29830002
         LA    GR6,CCW1                GET ADDR OF SIDEQ CCW   @YM06434 29840002
         STCM  GR6,X7,CCW2+X1         STORE VIRT INTO TIC BACK @YM06434 29842002
         LA    GR6,SECTOR              FOR SET/READ SECT & NOP @YM06446 29844002
         STCM  GR6,X7,SSECTOR+X1       STORE IN SET SECTOR     @YM06435 29844402
         STCM  GR6,X7,RSECTOR+X1       STORE IN READ SECTOR    @YM06435 29846002
         MVI   RSECTOR,X22             RESTORE OP CODE         @YM06435 29848002
         STCM  GR6,X7,RDCW13+X1        MOVE ADDR TO 1ST NO-OP  @YM06435 29848402
         MVI   RDCW13,X03              RESTORE OP CODE         @YM06435 29848802
         MVC   RDCW23(L4),RDCW13       RESTORE SECOND NO-OP    @YM06435 29849202
         L     GR6,RDPTR1              GET CURRENT READ CCW    @YM06433 29850002
         L     GR7,CURRCCW1                                    @YM06433 29900002
         STCM  GR7,X7,X1(GR6)          STORE VIRT RD CT ADDR   @YM06434 29950002
         LA    GR7,X8(GR7)                                     @YM06433 29970002
         STCM  GR7,X7,X9(GR6)          STORE VIRT RD K/D ADDR  @YM06434 29980002
         L     GR6,RDPTR2                                      @YM06433 29992002
         L     GR7,CURRCCW2                                    @YM06433 29994002
         STCM  GR7,X7,X1(GR6)          STORE VIRT RD CT ADDR   @YM06434 29996002
         LA    GR7,X8(GR7)                                     @YM06433 29998402
         STCM  GR7,X7,X9(GR6)          STORE VIRT RD K/D ADDR  @YM06434 29998802
         BR    GR9                     RETURN FROM READING              30000019
         SPACE 1                                                        30200019
ERREPTST EQU   *                                                        30400019
         L     GR6,RDPTR2              ADDRESS OF LAST CCW EXECUTED     30600019
*     SET POINTER IN GR7 TO LAST RECORD FLAG FIELD                      30800019
         L     GR7,X0(GR6)             GET ADDRESS FIELD FROM CCW       31000019
         LA    GR7,X0(GR7)             CLEAR OP CODE                    31200019
         LA    GR8,X4                  SIZE OF FMBB                     31400019
         SR    GR7,GR8                 BACK UP TO FLAG FIELD            31600019
         CLI   EVENTCB,OKCODE          ERRORS                           31800019
         BNE   TESTERR                 MAYBE- CHECK FOR END OF FILE     32000019
GOT7F    EQU   *                                                        32020019
         TM    SENSE,SENSE3            SPECIAL READ              A34431 32040020
         BNO   CHKMISS                 NO, CHECK FOR MISSED PCI  A34431 32060020
         TM    SENSE,SENSE1            READING FROM SYSUT3       A34431 32080020
         BO    UPDTESCT                YES, UPDATE SECTOR VALUE  A34431 32100020
         B     RESTREGS                NO, MUST BE EITHER NOTE   A34431 32120020
*                                       LIST OR RC REQUEST -     A34431 32140020
*                                       RETURN TO CALLER         A34431 32160020
CHKMISS  EQU   *                                                 A34431 32180020
         TM    X0(GR7),ENDPROC         LAST RECORD IN (BUFFERS FULL)    32200019
         BO    NOERRS                  YES-PREPARE TO EXIT              32250019
         B     BUILDTIC                NO, PCI MISSED - RESTART  S20201 32350020
*                                      I/O                       S20201 32450020
         SPACE 1                                                        32600019
NOERRS   EQU   *                                                        32800019
         L     GR8,DCB4IOB(GR5)        POINTER TO DCB FROM IOB          33000019
         LA    GR8,X0(GR8)             CLEAR HIGH ORDER BYTE            33900019
         MVC    DISKADR(L8,GR8),X1(GR7) MOVE FDAD TO DCB                34800019
         TM    STATUS,STAT4            MEMBER                           35860019
         BZ    EXIT                    NO, EXIT                         35880019
         TM    COMDCDSW,COMPRESS       IS A COMPRESS BEING DONE         35900019
         BZ    EXIT                    NO-EXIT                          35934019
         SR    GR2,GR2                                                  35941019
         IC    GR2,X9(GR7)             GET KEY LN                       35948019
         MVC   WKA1(L2),X10(GR7)       MOVE DATA LN TO FULL WORD BNDRY  35955019
         AH    GR2,WKA1                KEY LN + DATA LN                 35962019
         LA    GR2,X12(GR2)            + FMBB + COUNT FIELD SIZE        35969019
         AR    GR2,GR7                 POINT TO END OF RECORD           35976019
         ST    GR2,EOREAD              SAVE FOR WRITE SET UP            35983019
         CLC   EOREAD,END2ND2     IS END OF RECORD             @ZA10909 35993099
*                                 OUTSIDE THE BUFFER?          @ZA10909 36003099
         BL    EXIT               INSIDE                       @ZA10909 36013099
         L     GR2,END2ND2        OUTSIDE, A RECORD >          @ZA10909 36023099
         BCTR  GR2,GR0            BLKSIZE HAS BEEN READ,       @ZA10909 36033099
         ST    GR2,EOREAD         SET REAL END OF BUFFER       @ZA10909 36043099
*                                 AND LET IEBWSU TEST          @ZA10909 36053099
*                                 AND GIVE MSG188I             @ZA10909 36063099
EXIT   EQU  *                                                           39200019
         TM    SENSE,SENSE3            READ ONLY ONE RECORD      S20201 39210020
         BNO   UPDTESCT                NO, UPDATE SECTOR VALUE   S20201 39220020
         TM    SENSE,SENSE1            READING FROM SYSUT3       S20201 39225020
         BO    UPDTESCT                YES, UPDATE SECTOR VALUE  S20201 39230020
         B     RESTREGS                NO, MUST BE EITHER NOTE   S20201 39235020
*                                       LIST OR RC REQUEST -     S20201 39240020
*                                       DON'T UPDATE SECTOR      S20201 39245020
UPDTESCT EQU   *                                                 S20201 39250020
         LA    GR6,SCTOFF(GR0,GR5)     LOAD PTR TO CURRENT       S20201 39260020
*                                      SECTOR SLOT               S20201 39270020
         MVC   X0(L1,GR6),SECTOR       UPDATE TO LAST SECTOR     S20201 39280020
*                                        READ                    S20201 39290020
RESTREGS EQU   *                                                 S20201 39300020
         L     GR13,SV5+P4             POINTER TO SAVE AREA             39400019
         RETURN (14,12)                RETURN TO CALLER                 39700019
         SPACE 1                                                        40000019
TESTERR  EQU   *                                                        40200019
         CLI   EVENTCB,OUTEXT          EXTENT VIOLATED                  40400019
         BE    GETEXTEN                YES                              40600019
TESTPIO  EQU   *                                                 A37873 40650020
         CLI   EVENTCB,PERMIO          PERMANENT I/O ERROR              40700019
         BNE   TESTINT                 NO, GO AROUND                    40800019
         TM    IOBCSWST(GR5),UNCHK     UNIT CHECK                       40900019
         BO    IOERR                   YES                              41000019
         TM    IOBCSWST(GR5),UNEX      UNIT EXCEPTION (EOF)             41100019
         BZ    IOERR                   NO, I/O ERROR                    41200019
ERREOF   EQU   *                                                        41900019
         CLC   X10(L2,GR7),ZROS        TEST TO SEE IF RDPTR2    YA01454 41950002
*                                       POINTS TO THE EOF       YA01454 42000002
*                                       RECORD                  YA01454 42008002
         BE    EOFIN                   YES, SET LAST RECORD READYA01454 42016002
*                                      IF NOT, PCI HAS MISSED   YA01454 42024002
*                                       AND RDPTR1 POINTS TO THEYA01454 42032002
*                                       EOF RECORD              YA01454 42040002
         L     GR8,RDPTR1              GET CURRENT READ CCW     YA01454 42048002
*                                       ADDRESS                 YA01454 42056002
         L     GR7,X0(GR8)             GET CURRENT READ DATA    YA01454 42064002
*                                       ADDRESS                 YA01454 42072002
         LA    GR7,X0(GR7)             CLEAR COMMAND CODE       YA01454 42080002
         LA    GR8,X4                  SIZE OF FMBB             YA01454 42088002
         SR    GR7,GR8                 BACK UP TO FLAG FIELD    YA01454 42096002
         MVC   X1(L3,GR7),IOBMCCHH(GR5) MOVE MBB FROM IOB TO    YA01454 42104002
*                                       RECORD                  YA01454 42112002
EOFIN    MVI   X0(GR7),LASTREC+ENDPROC SET LAST RECORD READ IN  YA01454 42120002
*                                       BUFFER                  YA01454 42128002
ERRNLAST EQU   *                                                        42150019
         OI    FLG2,RDEOF              SET EOF READ SWITCH              42200019
         TM    STATUS,STAT2            READING OUTPUT DIRECTORY         42400019
         BZ    NOERRS                  NO                               42600019
         TM    TAG,CTOUT               COUNTING DIRECTORY BLOCKS        42800019
         BZ    NOERRS                  NO                               43000019
         LH    GR6,DIRBCNT             DIRECTORY BLOCK COUNT            43200019
         BCTR  GR6,GR0                 COUNT INCLUDED EOF RECORD        43400019
         STH   GR6,DIRBCNT             ACCURATE COUNT                   43600019
*                               COMPUTE TRACK BALANCE AFTER EOF@ZA26248 43650099
*                               ON OUT PUT DIRECTORY           @ZA26248 43657099
*                            R2, R8, R10, R1, R6 AVABLE GR5=IOB@ZA26248 43664099
         TM    SENSE,SENSE4   DON'T COMPUTE TRK BAL UNLESS     @ZA26248 43671099
         BZ    BX16           SCANNING.                        @ZA26248 43678099
         LA    GR10,OUTCHAR   ADDRESS OF DEVTAB CONSTANTS      @ZA26248 43685099
         USING DEVTAB,GR10                                     @ZA26248 43692099
*                                                              @ZA26248 43699099
         LA    R2,KBLEN       LENGTH OF DIRECTORY BLOK AND KEY @ZA26248 43706099
         SR R8,R8             CLEAR REG                        @ZA26248 43713099
         IC    R8,OVERI       OVERHEAD NOT LAST REC            @ZA26248 43720099
         TM    DEVFLAG,HALFOVER TWOBYTE OVERHEAD               @ZA26248 43727099
         BNO   NOTTWO         NOTTWO                           @ZA26248 43734099
         LH    R8,OVERI       GET TWO BYTE OVERHEAD            @ZA26248 43741099
NOTTWO   EQU   *                                               @ZA26248 43748099
         TM    DEVFLAG,TOLFAC TEST TOLERANCE FACTOR            @ZA26248 43755099
         BZ    NOTOLER        NO,                              @ZA26248 43762099
*                                                              @ZA26248 43769099
         MH    R2,TOLER       ADJUST FOR SPEED OF DRIVE        @ZA26248 43776099
         SRL   R2,C9          DIVIDE BY 512                    @ZA26248 43783099
NOTOLER  EQU   *                                               @ZA26248 43790099
         AR    R2,R8          ADD OVERHEAD                     @ZA26248 43797099
         LH    R1,TRKCAP      GET CAP OF TRACK                 @ZA26248 43804099
         SR    R6,R6          CLEAR REQ                        @ZA26248 43811099
         IC    R6,IOBRECNO(R5) GET RECORD NO                   @ZA26248 43818099
         BCTR  R6,R0          DECREMENT BY 1                   @ZA26248 43825099
         LR    R3,R2          SET UP ODD REG FOR MULTIPLY      @ZA26248 43832099
         MR    R2,R6          GET SPACE USED THIS TRACK        @ZA26248 43839099
         SR    R1,R3          COMPUTE AMT REMAINING            @ZA26248 43846099
*                                                              @ZA26248 43853099
*                             COMPUTE OVERHEAD OF EOR          @ZA26248 43860099
         IC    R6,OVERK       GET OVERHEAD OF KEY              @ZA26248 43867099
         SR    R8,R6          EOF IS NOT KEYED                 @ZA26248 43874099
*                                                              @ZA26248 43881099
         CLI   DEVCODE+3,X'08' IS IT A 2314?                   @ZA26248 43888099
         BE    ADDONE         YES,SKIP ADD OF ONE BYTE         @ZA26248 43895099
         LA    R2,C1          ADD 1 TO KL+DL OF EOF            @ZA26248 43902099
ADDONE   TM    DEVFLAG,TOLFAC TEST TO SEE IF TOLERANCE         @ZA26248 43909099
         BZ    BX15           REQUIRED N                       @ZA26248 43916099
         MH    R2,TOLER       ALLOW FOR VARIATIONS IN DRIVE    @ZA26248 43923099
         SRL   R2,C9          DIVIDE BY 512                    @ZA26248 43930099
*                                                              @ZA26248 43937099
BX15     AR    R2,R8          ADD OVERHEAD                     @ZA26248 43944099
*                                                              @ZA26248 43951099
         SR    R1,R2          REDUCE TRK BALANCE               @ZA26248 43958099
         STH   R1,OUTDS1+C4   UPDATE TRK BAL FOR WSU           @ZA26248 43965099
*                                                              @ZA26248 43972099
BX16     EQU   *                                               @ZA26248 43979099
         B     NOERRS         RETURN- EOF READ AND FLAGGED     @ZA26248 43986099
         SPACE 1                                                        44000019
GETEXTEN EQU   *                                                        44200019
         L     GR3,DCB4IOB(GR5)        DCB POINTER FROM IOB             45200019
         L     GR6,DEBPTR(GR3)         GET DEB POINTER FROM DCB         45400019
         LA    GR6,X0(GR6)             CLEAR FLAGS                      45500019
         SR    GR8,GR8                                           A41741 45520021
         IC    GR8,IOBMCCHH(GR5)        OBTAIN 'M' FROM IOB      A41741 45540021
         LA    GR8,X1(GR8)              UP 'M' BY ONE            A41741 45560021
         STC   GR8,IOBMCCHH(GR5)        STORE NEW 'M'            A41741 45580021
         CLC   IOBMCCHH(L1,GR5),DEBEXTNM(GR6) COMPARE 'M'- EXTENT NMBR  45600019
         BL    BUMPM                   GO AROUND IF LOW                 45840019
*          END OF EXTENTS REACHED WITHOUT EOF                    A41741 45842021
*          NEXT INSTRUCTIONS WILL SET UP EOF IN BUFFER           A41741 45842121
         BCTR  GR8,GR0                  RESET 'M'                A41741 45842221
         STC   GR8,IOBMCCHH(GR5)        RESTORE 'M'              A41741 45842321
         IC    GR8,IOBRECNO(GR5)        OBTAIN 'R' FROM IOB      A41741 45842421
         LA    GR8,X1(GR8)              UP 'R' BY ONE            A41741 45842821
         STC   GR8,IOBRECNO(GR5)        STORE NEW 'R'            A41741 45843221
         L     GR6,RDPTR1              ADDR OF NEXT CCW          A41741 45843621
*     SET POINTER IN GR7 TO LAST RECORD FLAG FIELD               A41741 45844021
         L     GR7,X0(GR6)             GET ADDRESS FLD FROM CCW  A41741 45846021
         LA    GR7,X0(GR7)             CLEAR OP CODE             A41741 45848021
         LA    GR8,X4                  SIZE OF FMBB              A41741 45850021
         SR    GR7,GR8                 BACK UP TO FLAG FIELD     A41741 45860021
         MVI   X0(GR7),LASTREC+ENDPROC SET LAST REC READ IN BFR  A41741 45870021
         MVC   X1(L8,GR7),IOBMCCHH(GR5) SET UP EOF RECORD ADDR   A41741 45880021
         XC    X9(L3,GR7),X9(GR7)       SET KEY-DATA-LEN ZERO    A41741 45890021
         B     ERRNLAST                BRANCH AS IF END OF FILE  A41741 45900021
         SPACE 1                                                        45920019
BUMPM    EQU   *                                                        45930019
         SLA   GR8,X4             MULTIPLY BY 16 BYTES/EXTENT    A41741 46260021
         AR    GR8,GR6           POINTER TO CORRECT EXTENT BLOCK A41741 46400021
         MVC  IOBBCCHH(L6,GR5),EXTBBDEB(GR8) NEXT EXTENT BBCCHH  A41741 46600021
*                                                  TO IOB        A41741 46650021
         MVI   IOBRECNO(GR5),ZERO      RESET TO RECORD 0 FOR SEARCH     46800019
         MVI SECTOR,X0                 SET ''SECTOR'' TO 0       S20201 46900020
*                                        (USED ONLY IF RPS)      S20201 47000020
         B     BUILDTIC                GET I/O RESTARTED         S20201 47100020
         SPACE 1                                                        47200019
         SPACE 1                                                        49400019
TESTINT  EQU   *                                                        49600019
         CLI   EVENTCB,INTRCEPT        INTERCEPT POSTED                 49800019
         BE    STRTIO                  YES-RE-ISSUE EXCP                50000019
         SPACE 1                                                        50200019
IOERR    EQU   *                                                        50400019
         L     GR15,VIEBDSRE           ENTRY POINT IN DSCPY TO   A33288 50500020
*                                        TRANSFER CONTROL TO     A33288 50600020
*                                        IEBIOE                  A33288 50700020
         BALR  GR14,GR15               GO TO IDENTIFY THE I/O ERROR     50800019
IEBDRDR  EQU   *                                                 A33288 50803020
         ENTRY IEBDRDR                                           A33288 50806020
         LA    GR11,INDCB              LOAD PTR TO INDCB                50810019
         TM    DCBRECFM,OVERFLOW       INPUT TRACK OVERFLOW             50820019
         BO    GOT7FTOV                YES, ERROR CAN BE IGNORED -      50830019
*                                         CONTINUE TRACK OVERFLOW       50840019
*                                         PROCESSING                    50850019
         SR    GR8,GR8            IF ERROR IGNORED,             OY01185 50851002
         IC    GR8,IOBRECNO(GR5)  DIMINISH RECNO                OY01185 50852002
         BCTR  GR8,GR0            NOT TO DROP A RECORD          OY01185 50853002
         STC   GR8,IOBRECNO(GR5)  NEXT TO THE ONE WITH DATA CHCKOY01185 50854002
         MVC   DCBFDAD(L8),IOBMCCHH(GR5)    PUT IT ALSO IN DCB  OY01185 50855002
         B     GOT7F                   IF IEBIOE RETURNS CONTROL,       50860019
*                                        ERROR CAN BE IGNORED           50920019
         EJECT                                                          51000019
SPECIAL  EQU   *                       READING 1 RECORD AT A TIME       51200019
*                                                                     * 51400019
*                         FROM INPUT DIRECTORY NOT IN CORE= SYSUT3    * 51600019
*                     OR THE COUNT + DATA OF THE NOTELIST RECORD (RCKD) 52000019
*                  OR READS TO SCAN FOR 'HOLES' FOR COMPRESS          * 52400019
*                  GR6 CONTAINS POINTER TO FIRST CCW (RDPTR1)         * 52800019
         SPACE 1                                                        52850000
         NI    AOS,FF-PCI              TURN OFF PCI PROC FLAG    X010XX 52900000
         SPACE 1                                                        53200019
         TM    SENSE,SENSE2            READING NOTELIST                 53600019
         BO    NOTESL                  YES, READ CKD FROM INPUT         54000019
         TM    SENSE,SENSE1            READING FROM SYSUT3       A34431 54100020
         BNO   RCONLY                  NO, MUST BE A RC REQUEST  A34431 54200020
*                                       FOR INPUT DATA SET       A34431 54300020
         L     GR5,ADWK                GET PTR FOR SYSUT3               54400019
         LA    GR5,X12(GR5)            SPACE OVER COUNT + FMBB FIELDS   54800019
         ST    GR5,X0(GR6)             STORE IN CCW DATA ADDRESS        55200019
         MVI   X0(GR6),RDMT            RESTORE RD-MT OP CODE            55600019
         LA    GR5,UT3IOB              SYSUT3 IOB                       56000019
         LH    GR7,UT3LRECL            SIZE OF SYSUT3 RECORDS           56400019
         SPACE 1                                                        56800019
SET4READ EQU   *                                                        57200019
         STH   GR7,X6(GR6)             STORE LENGTH TO BE READ          57600019
         MVI   X4(GR6),FLAG60          SET SLI AND CC FLAGS      S20201 57700020
         LA    GR7,X16(GR0,GR6)        GET POINTER TO NOP/TIC/RS S20201 57800020
*                                        CCW SLOT                S20201 57900020
         ST    GR7,X8(GR0,GR6)         PLACE IN RKD SLOT TO ACT  S20201 58000020
*                                        AS NOP                  S20201 58100020
         MVI   X8(GR6),TIC             COMPLETE CONSTRUCTION     S20201 58200020
*                                        OF TIC CCW              S20201 58300020
         B     GETGOING                SET UP AND ISSUE READ            58400019
         SPACE 1                                                        58800019
NOTESL   EQU   *                                                        59200019
         LA    GR5,INIOB               INPUT IOB                        59600019
         LA    GR7,MAXNOTE             MAXIMUM C+K+D NOTELIST    X010XX 60000000
         MVI   X0(GR6),RCKD            SET RCKD OP CODE                 60400019
         B     SET4READ                SET UP CCWS                      60800019
         SPACE 1                                                 A34431 61000020
RCONLY   EQU   *                                                 A34431 61200020
         LA    GR5,INIOB               POINTER TO INPUT IOB      A34431 61400020
         LA    GR7,X8                  LOAD LENGTH OF COUNT      A34431 61600020
*                                       FIELD                    A34431 61800020
         MVI   X0(GR6),RCMT            SET RC M/T OP CODE        A34431 62000020
         B     SET4READ                SET UP CCW'S              A34431 62200020
         EJECT                                                          62400019
*                                                                       62600019
*********************************************************************** 62800019
*                                                                     * 63000019
*              TRACK OVERFLOW  SUB-ROUTINE                            * 63200019
*                                                                     * 63400019
*********************************************************************** 63600019
*                                                                       63800019
*        SET UP SPECIAL CCWS-READ ONE RECORD AT A TIME                  64000019
*                                                                       64400019
*        GR10 - HAS DATA AND KEY LENGTH                                 64500019
         USING DXIOB,GR5                                                64600019
TRKOVFL  EQU   *                                                        64800019
         NI    AOS,FF-PCI              TURN OFF PCI PROC FLAG    X010XX 64850000
         ST    GR5,RDCW11              SET-UP DATA ADDRESS-DUMMY-       65000019
         MVI   RDCW11,RKD              SET RKD OP CODE                  65100019
         STH   GR10,RDCW11+P6          SET LENGTH FOR READ              65200019
         MVI   RDCW11+P4,FLAG70        SET CC,SLI,SKIP                  65300019
*                                                                       65600019
         ST    GR5,RDCW12              DATA ADDRESS                     65800019
         MVI   RDCW12,RCKDMT           SET RCKD-MT OP CODE              66000019
         LA    GR10,X8(GR10)           ADD LENGTH OF COUNT FIELD        66200019
         STH   GR10,RDCW12+P6          SET LENGTH TO BE READ            66400019
         MVI   RDCW12+P4,FLAG20        SET SLI FLAG              S20201 66700020
*                                                                       67000019
         LA    GR5,INIOB               INPUT IOB                        67200019
         TM    STATUS,STAT8            EOF LAST READ                    67230019
         BZ    SKIPREAD                NO- READ WITH K/D AND SKIP       67260019
         LA    GR10,RDCW12             YESUSE 2ND CCW TO START WITH     67290019
         ST    GR10,RDPTR1             STORE FOR TIC SET UP             67320019
         OI    SENSE,SENSE7            SET FIRST RECORD OF A     S20201 67327020
*                                        TRACK OVERFLOW MEMBER   S20201 67334020
*                                        SWITCH                  S20201 67341020
SKIPREAD EQU   *                                                        67350019
         BAL   GR9,GETGOING            GO SET-UP FOR I/O                67400019
*        RETURN HERE AFTER EXCP COMPLETED                               67600019
         NI    STATUS,FF-STAT8         TURN OFF FIRST RECORD SWITCH     67650019
         NI    SENSE,FF-SENSE7         TURN OFF SENSE7           S20201 67670020
         LA    GR10,RDCW11             PT. TO 1ST CCW                   67700019
         ST    GR10,RDPTR1             STOW FOR TIC                     67750019
         L     GR7,RDCW12              GET DATA ADDRESS                 67810019
         LA    GR7,X0(GR7)             CLEAR OP CODE                    67870019
         LA    GR8,X4                  LENGTH OF FMBB FIELD             67930019
         SR    GR7,GR8                 POINT BACK TO BEGINNING          67990019
         MVI   X0(GR7),ZERO            CLEAR FLAG BYTE                  68060019
         MVC   X1(L3,GR7),DXDAADDR     FETCH MBB FROM IOB               68130019
*        FIND  ACTUAL NUMBER OF BYTES READ                              68200019
         IC    GR8,X9(GR7)             GET KEY LN                       68250019
         LR    GR10,GR8                SAVE IT                          68300019
         LA    GR8,X8(GR8)             ADD COUNT FIELD LN               68380019
         LH    GR6,RDCW12+P6           GET COUNT STARTED WITH           68460019
         LPR   GR6,GR6                 MAKE SURE IT'S POSITIVE  OY01181 68500002
         SH    GR6,IOBCNT              SUB. COUNT READ - FROM IOB       68550019
         SR    GR6,GR8                 TAKE OFF KL AND COUNT LENGTH     68650019
         STH   GR6,WKA1                SAVE UM                          68750019
         MVC   X10(L2,GR7),WKA1        PLACE ACTUAL NUMBER OF DATA      68850019
*                                        BYTES READ INTO COUNT FIELD    68950019
*                                        (COUNT FIELD READ INTO CORE    69050019
*                                         TELLS NUMBER OF BYTES IN      69150019
*                                         FIRST SEGMENT ONLY)           69250019
         CLI   EVENTCB,OKCODE          ERROR POSTED                     69350019
         BE    GOT7FTOV                NO, I/O OK                A37873 69400020
         CLI   EVENTCB,OUTEXT          OUT OF EXTENT POSTED      A37873 69450020
         BNE   TESTPIO                 NO, GO TEST FOR PERMANENT A37873 69500020
*                                       I/O ERROR                A37873 69550020
         LA    GR3,RDCW12              LOAD PTR TO RCKD CCW      A37873 69600020
         ST    GR3,RDPTR1              STORE AS FIRST CCW SO     A37873 69650020
*                                       THAT RKD CCW WILL BE     A37873 69700020
*                                       SKIPPED- IF THIS WAS NOT A37873 69750020
*                                       DONE, FIRST RECORD IN    A37873 69800020
*                                       NEW EXTENT WOULD BE      A37873 69850020
*                                       SKIPPED                  A37873 69900020
         B     GETEXTEN                GO FIND NEXT EXTENT       A37873 69950020
*        GO FIND NEXT BUFFER AND SEE RECORD WILL FIT                    70000019
GOT7FTOV EQU   *                                                        70300019
         LA    GR8,X12(GR6,GR10)       ADD KL + DL + 12                 70500019
         AR    GR8,GR7                 POINT TO END OF RECORD JUST READ 70800019
*                                                                       71000019
         AH    GR10,IBLKSIZE           GET WHAT WILL BE NEXT ONE        71200019
         LA    GR10,X12(GR8,GR10)      POINT TO END OF NEXT ONE TO READ 71400019
*                                                                       71600019
         LA    GR11,OUTDCB             GET OUTPUT DCB ADDR.             71800019
         TM    DCBRECFM,OVERFLOW       IS OUTPUT OVERFLOW ALLOWED       72000019
         BO    ONEPRBFS                YES-USE ONLY ONE LOGICAL BUFFER  72200019
         TM    FLG1,P2FLG1             ARE BUFFERS SPLIT                72400019
         BZ    SECBUF                  NO-NOT SPLIT                     72600019
         TM    FLG1,IN2ND              INTO SECOND BUFFER ALREADY       72800019
         BO    SECBUF                  YES-CHECK 2ND ONE                73000019
         C     GR10,ENDFST1            NO-AT END OF FIRST YET           73200019
         BNH   CONTINU                 NO-GO ON                         73400019
         OI    X0(GR7),LASTREC         OTHERWISE SET LAST IN BUFFER     73600019
         L     GR8,BEGFST2             GET NEXT ONE                     73800019
         OI    FLG1,IN2ND              SET IN 2ND BUFFER SWITCH         74000019
*        PREPARE TO ISSUE EXCP AGAIN                                    74200019
CONTINU  EQU   *                                                        74400019
         LA    GR8,X4(GR8)             BUMP PASSED FMBB                 74500019
         ST    GR8,RDCW12              STOW WHERE TO GO                 74600019
         MVI   RDCW12,RCKDMT           RESET RCKD-MT OP CODE            74800019
         LA    GR11,INDCB              GET INPUT DCB                    75000019
         MVC   DCBFDAD(L8),X1(GR7)     MOVE IN PREVIOUS MBBCCHHR        75200019
         B     GETGOING                GO DO UM AGAIN                   75400019
*        OUTPUT NOT OVERFLOW                                            75600019
SECBUF   EQU   *                                                        75800019
         C     GR10,END2ND2            END OF ALL BUFFER SPACE          76000019
         BNH   CONTINU                 NO-GO GET SOMEMORE               76200019
         OI    X0(GR7),LASTREC+ENDPROC SET FLAGS FOR LAST RECORD        76400019
         B     NOERRS                  NO MORE ROOM EXIT                76600019
*        OUTPUT IS OVERFLOW USE ONLY ONE LOGICAL BUFFER                 76800019
ONEPRBFS EQU   *                                                        77000019
         C     GR10,ENDFST1            END OF 1ST BUFFER                77200019
         BNH   CONTINU                 NO, CONTINUE PROCESSING          77400019
         OI    X0(GR7),LASTREC+ENDPROC YES, NO MORE ROOM                77600019
         B     NOERRS                  EXIT                             77800019
         SPACE 2                                                        78300019
MAXRECI  DC    H'264'                  MAXIMUM DIRECTORY SIZE KEY+DATA  79000019
         SPACE 1                                                        81400019
         SPACE 1                                                        83000019
*                             READING CCWS MODEL               @ZA26248 83050099
*                                                              @ZA26248 83070099
DRCCW1   CCW   X'9E',0,X'40',KBLEN+X8 READ COUNT KEY AND DATA  @ZA26248 83090099
*        LENGTH FIELD MODIFIED TO BLOK SIZE AND 8              @ZA26248 83110099
*                             FOR OTHER INPUTS.                @ZA26248 83130099
*              DIRECTOR, WRITING CCW MODEL                     @ZA26248 83150099
*                                                              @ZA26248 83170099
DWCCW1   CCW   X'31',R0CNTF,X'60',5  SERCH ON FIRST CNT        @ZA26248 83190099
DWCCW2   CCW   X'08',DWCCW1,X'00',1  TIC UNTIL FOUND           @ZA26248 83210099
DWCCW3   CCW   X'08',DWCCW4,X'00',1  TIC AROUND CNT            @ZA26248 83230099
R0CNTF   DC    D'0'                                            @ZA26248 83250099
DWCCW4   CCW   X'0D',0,X'40',KBLEN  WRITE KEY AND DATA         @ZA26248 83270099
*                                                              @ZA26248 83290099
*        DWCCW4 REPEATS AS MANY TIMES AS BLOCKS/TRACK          @ZA26248 83310099
TRKSWL   EQU   DWCCW4-DWCCW1  LENGTH OF TRACK SWITCH MODEL     @ZA26248 83330099
*                                                              @ZA26248 83350099
*        OUTPUT CCW MODEL USED IN PLACE DWCCW4                 @ZA26248 83370099
DACCW4   CCW   X'1D',0,X'60',0                                 @ZA26248 83390099
*                                                              @ZA26248 83410099
CC       EQU   X'60'          COMMAND CHAIN                    @ZA26248 83430099
R0OFSET  EQU   R0CNTF-DWCCW1                                   @ZA26248 83450099
DCCW3OST EQU   DWCCW3-DWCCW1                                   @ZA26248 83470099
PATCHLN  EQU   (*-START)/20            5 PERCENT PATCH AREA LENGTH      83700019
PATCH    DC    XL(PATCHLN)'00'         PATCH AREA                A41780 84520021
         EJECT                                                          84521019
*   THE FOLLOWING EQUATES ARE USED TO REFER TO SYMBOLIC LOCATIONS PLUS  84522019
*  A CONSTANT                                                           84523019
P1       EQU   1                                                        84524019
P4       EQU   4                                                        84525019
P6       EQU   6                                                        84526019
*   THE FOLLOWING EQUATES ARE USED IN INSTRUCTIONS WHICH REQUIRE LENGTH 84527019
*  SPECIFICATIONS SUCH AS MVC                                           84528019
L1       EQU   1                                                        84529019
L2       EQU   2                                                        84530019
L3       EQU   3                                                        84531019
L4       EQU   4                                                 S20201 84531520
L6       EQU   6                                                        84532019
L8       EQU   8                                                        84533019
L12      EQU   12                                                       84534019
*   THE FOLLOWING EQUATES ARE USED AS DISPLACEMENT CONSTANTS            84535019
X0       EQU   0                                                        84536019
X1       EQU   1                                                        84537019
X4       EQU   4                                                        84538019
X6       EQU   6                                                        84539019
X7       EQU   7                                               @YM06434 84539402
X8       EQU   8                                                        84540019
X9       EQU   9                                                        84541019
X10      EQU   10                                                       84542019
X11      EQU   11                                                X010XX 84542400
X12      EQU   12                                                       84543019
X16      EQU   16                                                       84544019
C35      EQU   35                OFFSET INTO IOB OF CCHHR      @YM06434 84544402
*   THE FOLLOWING ARE MISC EQUATES                                      84545019
FF       EQU   X'FF'                                                    84546019
X80      EQU   X'80'                                             X010XX 84546400
X03      EQU   X'03'                                             X010XX 84546800
X04      EQU   X'04'                                             X010XX 84546900
X22      EQU   X'22'                                           @YM06435 84548102
RDMT     EQU   X'86'                                                    84550802
RCKDMT   EQU   X'9E'                                                    84552002
RKD      EQU   X'0E'                                                    84553202
RCMT     EQU   X'92'                                                    84554402
RCKD     EQU   X'1E'                                                    84555602
NOP      EQU   X'03'                                                    84556802
SIDEQ    EQU   X'31'                                                    84558002
TIC      EQU   X'08'                                                    84559202
ZERO     EQU   0                                                        84560402
MIXONE   EQU   5                                                        84561602
OKCODE   EQU   X'7F'                                                    84562802
PERMIO   EQU   X'41'                                                    84564002
INTRCEPT EQU   X'44'                                                    84565202
OUTEXT   EQU   X'42'                                                    84566402
UNCHK    EQU   X'02'                                                    84567602
UNEX     EQU   X'01'                                                    84568802
FLAG20   EQU   X'20'                                             S20201 84570002
FLAG40   EQU   X'40'                                                    84571202
FLAG60   EQU   X'60'                                             S20201 84572402
FLAG68   EQU   X'68'                                                    84573602
FLAG70   EQU   X'70'                                                    84574802
RPS      EQU   X'10'                                             S20201 84576020
MAXNOTE  EQU   1291                    MAXIMUM NOTELIST LENGTH   X010XX 84586000
         EJECT                                                          84600019
         DCBD  DSORG=PS                                                 84800019
DISKADR  EQU   DCBFDAD-IHADCB          MBBCCHHR RECORD JUST READ        85000019
DEBPTR   EQU   DCBDEBAD-IHADCB         DEB POINTER IN DCB               85200019
OVERFLOW EQU   X'20'              OVERFLOW FLAG IN DCBRECFM             85300019
         EJECT                                                          85400019
IECDSECT DSECT                                                          85600019
         IECDSECT                                                       85800019
         SPACE 1                                                        86000019
DCB4IOB  EQU   IOBDCBPT-DXIOB-1        POINTER TO DCB IN IOB            86200019
IOBCAW   EQU   IOBSIOCC-DXIOB          STARTING CCW ADDRESS (CAW) IOB   86400019
IOBCSWST EQU   IOBSTAT0-DXIOB          CSW STATUS IN IOB                86600019
IOBFLGS  EQU   IOBFLAG1-DXIOB          FLAGS IN IOB, READ AFTER EOF     86800019
NONSEQEN EQU   X'42'                   COMD CHAINING, UNRELATED FLAGS   87000019
IOBMCCHH EQU  DXDAADDR-DXIOB           MBBCCHH IN IOB                   87200019
IOBBCCHH EQU  DXDAADDR-DXIOB+1         BBCCHH IN IOB                    87400019
IOBCCHHR EQU  DXDAADDR-DXIOB+3         CCHHR IN IOB                     87600019
IOBRECNO EQU  DXDAADDR-DXIOB+7         RECORD NUMBER (R) IN IOB         87800019
         SPACE 1                                                        88000019
DEBEXTNM EQU   DXDEBUSR-DXDEB          NUMBER OF EXTENTS FROM DEB       88200019
EXTBBDEB EQU   DXDEBBIN-DXDEB          BBCCHH FOR START OF EXTENT DEB   88400019
DEVTAB   DSECT                                                 @ZA26248 88450099
*                                                              @ZA26248 88460099
*     DIRECT ACCESS DEVICE TABLE OVERLAY  OUTCHAR IN IEBMCA    @ZA26248 88470099
*                                                              @ZA26248 88480099
DEVCODE  DS    F                DEVICE CODE FROM UCB           @ZA26248 88490099
MAXSIZE  DS    F                MAXIMUM SIZE UNKEYED BLOCK     @ZA26248 88500099
MAXCC    DS    H                NUMBER OF CYLINDER             @ZA26248 88510099
MAXHH    DS    H                NUMBER OF TRACKS               @ZA26248 88520099
TRKCAP   DS    H                MAXIMUM TRACK LENGTH           @ZA26248 88530099
OVERI    DS    XL1              OVERHEAD NOT LAST RECORD       @ZA26248 88540099
OVERL    DS    XL1              OVERHEAD LAST RECORD           @ZA26248 88550099
OVERK    DS    XL1              OVERHEAD REDUCTION FOR NON-KEY @ZA26248 88560099
DEVFLAG  DS    XL1              APPLY TOLERANCE FACTOR NOT LST @ZA26248 88570099
TOLER    DS    H                GAP LENGTH CALCULATE TOLERANCE @ZA26248 88580099
TOLFAC   EQU   X'01'            TOLERANCE FACTOR TO BE ADDED   @ZA26248 88590099
HALFOVER EQU   X'08'            TWO BYTE OVERHEAD              @ZA26248 88600099
*                                                            * @ZA26248 88610099
*       END OF DEVTAB OVERLAY                                * @ZA26248 88620099
*                                                            * @ZA26248 88630099
         EJECT                                                          88699919
IEBMCA   DSECT                                                          88800019
         IEBMCA                                                         89000019
         SPACE 1                                                        89200019
         END                                                            89400019
