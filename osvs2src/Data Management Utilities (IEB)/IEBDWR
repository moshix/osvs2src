WRTE     TITLE 'IEBCOPY  WRITE ROUTINE- IEBDWR'                         00300019
IEBDWR   CSECT                                                          00600019
         SPACE 1                                                        00900019
*TITLE- IEBCOPY WRITE ROUTINE- IEBDWR                                 * 00910019
*A 315004319620-319800                                         @YM04451 00910402
*A 315550-315640                                               @YM06447 00910802
*D 315424                                                      @YM06447 00911602
*A 315424,315464,319100-320100                                 @YM06435 00914002
*A 080910,315020-315084                                        @YM06434 00915602
*A 080990-080994,315100-318600                                 @YM06433 00917202
*C 309100                                                      @YM06433 00918802
*D611400                                                         A35473 00920402
*C716000                                                         A41780 00922002
*C366000                                                        OY01184 00923602
*A309020-312000                                                 YL026VD 00925202
*C687200                                                        YL026VD 00926802
*C309060                                                        YM06949 00927202
*A309044                                                        YM06949 00927602
*A129500-130700                                                @ZA00915 00927802
*D190700-190720,209900-209920                                  @ZA01672 00928002
*A080997,309100-309322,315002-315008,702100-706600             @ZA26248 00928199
*D709000,716000                                                @ZA26248 00928299
*                                                                     * 00928402
*STATUS- CHANGE LEVEL 001                                             * 00930019
*                                                                     * 00940019
*FUNCTION/OPERATION- THIS MODULE WRITES DIRECTORIES OR MEMBER DATA TO * 00950019
*       THE OUTPUT DATA SET. THE SPILL FILES, SYSUT3 AND SYSUT4 CAN   * 00960019
*       ALSO BE WRITTEN. IT STARTS WRITING FROM THE RECORD POINTED TO * 00970019
*       BY 'WRTNEXT' AND STOPS AFTER WRITING THE RECORD THAT HAS THE  * 00980019
*       'ENDPROC' SWITCH SET IN THE FLAG FIELD.                       * 00990019
*                                                                     * 01000019
*ENTRY POINTS- ENTERED AT IEBDWR                                      * 01010019
*                                                                     * 01020019
*INPUT- SWITCH NAMED 'TAG' IS SET BY CALLER TO TELL IEBDWR WHICH DATA * 01030019
*      SET IS BEING WRITTEN. 'TAG5' SET IF TO READ BACK CHECK.        * 01040019
*                    ALWAYS READ BACK CHECKS DIRECTORY BLOCKS AFTER   * 01050019
*       WRITING. WILL READ BACK CHECK ENTIRE DATA SET WRITTEN IF      * 01060019
*       'TAG5' SWITCH SET IN 'TAG' BEFORE ENTRY TO IEBDWR.            * 01070019
*       'WRTNEXT' POINTS TO STARTING RECORD TO BE WRITTEN.            * 01080019
*       'WRTOVR' SWITCH SET IN FLAG FIELD AHEAD OF RECORD TO BE       * 01090019
*      WRITTEN IF TO WRITE 'SPECIAL' COUNT/KEY/DATA FOR A SEGMENT OF  * 01100019
*      AN OVERFLOW RECORD.                                            * 01110019
*       'LASTREC' SWITCH SET IN FLAG OF LAST RECORD IN CURRENT BUFFER.* 01120019
*       'ENDPROC' SWITCH SET IN FLAG OF LAST RECORD TO BE WRITTEN.    * 01130019
*                                                                     * 01140019
*OUTPUT- MBBCCHHR IN FDAD OF DCB SET TO REFLECT LAST RECORD THAT WAS  * 01150019
*       SUCCESSFULLY WRITTEN.                                         * 01160019
*       'RDGSW' IN SWITCH 'WSFLAG' RESET BECAUSE ARE WRITING NOT      * 01170019
*      READING. PCI APPENDAGE USES THIS SWITCH TO DETERMINE WHETHER   * 01180019
*      ARE READING OR WRITING.                                        * 01190019
*                                                                     * 01200019
*EXTERNAL ROUTINES- PCI APPENDAGE IGG019C8, EXCP WRITE, WAIT, SYNADAF,* 01210019
*                                                                     * 01230019
*EXITS- NORMAL RETURN TO CALLER ON LINK REGISTER.                     * 01240019
*       ENTRY TO SYNADAF ROUTINE ON HARD I/O ERROR. (IEBIOE)          * 01250019
*                                                                     * 01260019
*TABLES/WORK AREAS-                                                   * 01270019
*       -BCB-      POINTERS TO BUFFERS                                * 01280019
*       -IOB-      NEED BY EXCP- OUTIOB,UT3IOB,UT4IOB                 * 01290019
*       -EVENTCB-  EVENT CONTROL BLOCK FOR EXCP                       * 01300019
*       -DCB-      OUTDCB,UT3DCB,UT4DCB FOR UPDATING FDAD MBBCCHHR    * 01310019
*       -WRPTR1-   ADDRESS OF CURRENT CCW                             * 01320019
*       -WRPTR2-   ADDRESS OF NEXT CCW                                * 01330019
*       -SV4-      REGISTER SAVE AREA IN IEBMCA COMMUNICATION AREA    * 01340019
*       -LASTADDR- MBBCCHHR USED TO PREPARE FOR HEAD SWITCH/RETRY     * 01350019
*       -WRCNT-    NUMBER OF RECORDS WRITTEN.                         * 01360019
*                                                                     * 01370019
*ATTRIBUTES- SERIAL REUSABLE.                                         * 01380019
         EJECT                                                          01390019
*                                                                     * 01800019
*                  SYMBOLIC REGISTERS FOR WRITE ROUTINE               * 02100019
*                                                                     * 02400019
*           BASE ADDRESS REGISTER 12, COMMON AREA REGISTER 4          * 02700019
*                                                                     * 03000019
GR0      EQU   0                                                        03300019
GR1      EQU   1                                                        03600019
GR2      EQU   2                                                        03900019
GR3      EQU   3                                                        04200019
GR4      EQU   4                       POINTER TO COMMUNICATIONS AREA   04500019
GR5      EQU   5                                                        04800019
GR6      EQU   6                                                        05100019
GR7      EQU   7                                                        05400019
GR8      EQU   8                                                        05700019
GR9      EQU   9                                                        06000019
GR10     EQU   10                                                       06300019
GR11     EQU   11                                                       06600019
GR12     EQU   12                      BASE ADDRESS REGISTER            06900019
GR13     EQU   13                                                       07200019
GR14     EQU   14                                                       07500019
GR15     EQU   15                                                       07800019
SAV4     EQU   4                  SAVE AREA DISPLACEMENT                07809019
SAV8     EQU   8                  SAVE AREA DISPLACEMENT                07818019
XFF      EQU   X'FF'              RESETS SWITCHES                       07827019
LEN4     EQU   4                  LENGTH OF 4                           07836019
X68      EQU   X'68'              PCI  FLAG                             07845019
X03      EQU   X'03'              NOP COMMAND                           07854019
LEN8     EQU   8                  LENGTH OF 8                           07863019
LEN0     EQU   0                  LENGTH OF 0                           07872019
X1D      EQU   X'1D'              WRITE  C/K/D                          07881019
X60      EQU   X'60'              CC/SLI FLAGS                   S20201 07890020
LEN12    EQU   12                 LENGTH OF 12                          07899019
X0D      EQU   X'0D'              WRITE KEY DATA                        07908019
LEN6     EQU   6                  LENGTH OF 6                           07917019
L264     EQU   264                LENGTH OF 264                         07926019
X01      EQU   X'01'              WRITE SPECIAL C/K/D                   07935019
LEN9     EQU   9                  LENGTH OF 9                           07944019
LEN2     EQU   2                  LENGTH OF 2                           07953019
LEN10    EQU   10                 LENGTH OF 10                          07962019
LEN7     EQU   7                  LENGTH OF 7                           07971019
LEN1     EQU   1                  LENGTH OF 1                           07980019
X31      EQU   X'31'              OP CODE                               07989019
LEN3     EQU   3                  LENGTH OF 3                           07998019
X08      EQU   X'08'              TIC                                   08007019
X7F      EQU   X'7F'              SUCCESSFUL                            08016019
LEN5     EQU   5                  LENGTH OF 5                           08025019
MS5      EQU   5                  MASK OF 5                             08034019
X80      EQU   X'80'                                             X010XX 08036000
X04      EQU   X'04'                                             X010XX 08038000
X78      EQU   X'78'              PCP SKIP SLI                          08043019
X41      EQU   X'41'              I/O ERROR                             08052019
X42      EQU   X'42'              EXTENT ADDR VIOLATED                  08061019
LEN16    EQU   16                 LENGTH OF 16                          08070019
X00      EQU   X'00'              RECORD NUMBER = 0                     08079019
LEN11    EQU   11                                                X010XX 08081000
RPS      EQU   X'10'              RPS INDICATOR                  S20201 08089020
C35      EQU   35                                              @YM06434 08091002
C7       EQU   7                                               @YM06433 08099002
C1       EQU   1                                               @YM06433 08099402
LEN20    EQU   20                                              @ZA26248 08099799
         EJECT                                                          08100019
         SAVE  (14,12),,*                                               08200019
         BALR  GR12,GR0           ESTABLISH ADDRESSABILITY              08400019
         USING START,GR12                                               08700019
         USING IEBMCA,GR4                                               09000019
         SPACE 1                                                        09300019
         SPACE 1                                                        11100019
START    EQU   *                                                        11400019
         ST    GR13,SV5+SAV4      POINTER TO OLD SAVE AREA IN NEW       11800019
         LA    GR15,SV5                                                 12200019
         ST    GR15,SAV8(GR13)    POINTER TO NEW SAVE AREA IN OLD       12500019
         LR    GR13,GR15               POINTER TO NEW SAVE AREA         12900019
         LA    GR3,SECTOR              RESTORE THE ADDRESSES   @ZA00915 12950002
         ST    GR3,SSECTOR              IN THE SET/READ SECTOR @ZA00915 13000002
         MVI   SSECTOR,X'23'            CCWS TO VIRTUAL, IS    @ZA00915 13050002
         ST    GR3,RSECTOR              CHANGED TO REAL BY     @ZA00915 13060002
         MVI   RSECTOR,X'22'            IGG019FT               @ZA00915 13070002
         NI    WSFLAG,XFF-RDGSW   RESET READING SWITCH                  13100019
         OI    AOS,PCI            TURN ON PCI PROCESSING FLAG    X010XX 13150000
         TM    FORM,ERASE              ENTERED TO ERASE A TRACK(S)      13400019
*                                        USED ONLY FOR TRACK OVFLOW     13600019
         BO    ERASEIT                 YES, GO TO ERASE RTN             13800019
         XC    WRPCICNT(LEN4),WRPCICNT CLEAR PCI COUNT BUFFER           14000019
         LA    GR8,WRCW11              FETCH 1ST CCW IN LIST            14200019
         LA    GR9,WRCW21              FETCH 2ND CCW IN LIST            14300019
         MVC   LEN1(LEN3,GR9),WRTNEXT+LEN1   INIT SECOND CHAIN   X010XX 14350000
*                                 TO POINT WITHIN BUFFER         X010XX 14360000
         STM   GR8,GR9,WRPTR1          INITIALIZE CCW CONTROL           14400019
         NI    TAG,XFF-TAG6       RESET TAG6                            14700019
         L     GR6,WRTNEXT             WHERE TO WRITE FROM              15000019
         LA    GR7,LEN4(GR6)      SPACE OVER FMBB TO START COUNT        15300019
         MVI   LEN4(GR8),X68      RESET PCI FLAG                        15600019
         TM    TAG,TAG4                WRITING SYSUT3                   16250019
         BO    UT3WRT             YES                                   16300019
         TM    TAG,TAG1                WRITING OUTPUT DIRECTORY         16350019
         BO    OUTDIR             YES- WRITE KEY/DATA NOT COUNT         16650019
         ST    GR7,LEN0(GR8)      STORE START OF COUNT IN CCW ADR.      16950019
         TM    LEN0(GR6),WRTOVR   OVERFLOW SEGMENT                      17250019
         BO    WRTSPECL           YES- WRITE SPECIAL C/K/D OP CODE      17550019
         MVI   LEN0(GR8),X1D      MAKE OP CODE WRITE C/K/D              17850019
         TM    TAG,TAG2                PROCESSING MEMBER                18600019
         BO    MEMBPROS           YES                                   18700019
         LA    GR3,UT4IOB              SYSUT4 IOB ADDRESS               18960019
         LH    GR1,UT4LRECL            SYSUT4 RECORD SIZE               19020019
         B     STRSPILL                SET UP CCW AND IOB               19080019
         SPACE 1                                                        19140019
UT3WRT   EQU   *                                                        19200019
         NI    AOS,XFF-PCI        TURN OFF PCI PROCESSING FLAG   X010XX 19250000
         LA    GR3,UT3IOB              SYSUT3 IOB ADDRESS               19260019
         LH    GR1,UT3LRECL            SYSUT3 RECORD SIZE               19320019
         L     GR6,ADWK                FETCH SYSUT3 BUFFER PTR.         19380019
         MVI   LEN4(GR8),X60           SET CC/SLI - ONLY ONE     S20201 19420020
*                                        RECORD WRITE            S20201 19460020
         LA    GR7,LEN4(GR6)      SPACE OVER FMBB                       19500019
         TM    FLG2,FMTSPL             FORMAT WRITE                     19560019
         BO    UT3FMTWT                YES-XFER                         19620019
         LA    GR10,LEN12(GR6)    NO-SKIP TO COUNT FIELD                19680019
         ST    GR10,LEN0(GR8)     STORE INTO CCW DATA ADDR              19740019
         MVI   LEN0(GR8),X0D      SET WRITE KEY/DATA OP CODE            19800019
         STH   GR1,LEN6(GR8)      STOW BYTE COUNT                       19860019
         OI    TAG,TAG6                INDICATE NON-FORMAT WRITE        19920019
         B     SETUPIOB                GO TO SET UP IOB                 19980019
UT3FMTWT EQU   *                                                        20040019
         ST    GR7,LEN0(GR8)      STORE INTO CCW DATA ADDR.             20100019
         MVI   LEN0(GR8),X1D      SET WRITE  C/K/D                      20160019
         SPACE 1                                                        20220019
STRSPILL EQU   *                                                        20280019
         LA    GR1,LEN8(GR1)      ALLOW 8 BYTE COUNT FIELD              20340019
         STH   GR1,LEN6(GR8)      COUNT SYSUT3/4 TO WRITE               20400019
         B     SETUPIOB                SET UP IOB FIELDS                20460019
         SPACE 1                                                        20520019
OUTDIR   EQU   *                                                        20580019
         LA    GR1,LEN12(GR6)     SPACE OVER FMBBCCHHR                  20640019
         ST    GR1,LEN0(GR8)      STOW IN CCW DATA ADDR.                20700019
         MVI   LEN0(GR8),X0D      WRITE KEY/DATA OP CODE                20760019
         LA    GR1,L264           FETCH COUNT                           20820019
         STH   GR1,LEN6(GR8)      STORE COUNT IN CCW                    20880019
         LA    GR3,OUTIOB              OUTPUT IOB ADDRESS               20940019
         B     SETUPIOB                SET UP CCWS AND IOB              21000019
WRTSPECL EQU   *                                                        21060019
         MVI   LEN0(GR8),X01      WRITE SPECIAL C/K/D CCW OP CODE       21120019
         SPACE 1                                                        21180019
         SPACE 1                                                        21600019
MEMBPROS EQU   *                                                        21900019
         SR    GR1,GR1                                                  22200019
         IC    GR1,LEN9(GR6)      GET KEY SIZE                          22500019
         LA    GR1,LEN8(GR1)      ADD 8 FOR COUNT SIZE                  22800019
         MVC   WKA1(LEN2),LEN10(GR6)   MOVE IN DATA LENGTH              23100019
         AH    GR1,WKA1                BOUNDARY OK NOW TO ADD FROM      23400019
         STH   GR1,LEN6(GR8)      TOTAL LENGTH OF MEMBER READ           23800019
         LA    GR3,OUTIOB              LOAD POINTER TO OUTPUT IOB       24300019
         SR    GR1,GR1            CLEAR REG                      X010XX 24350000
         LA    GR5,OUTDCB         LOAD POINTER TO DCB            X010XX 24400000
         IC    GR1,KEYDCB(GR0,GR5)  INSERT KEY LENGTH            X010XX 24450000
         AH    GR1,OBLKSIZE       ADD BLOCK SIZE                 X010XX 24500000
         LA    GR1,LEN8(GR0,GR1)  ADD COUNT FIELD LENGTH         X010XX 24550000
         SRL   GR1,LEN11          DIV BY 2K                      X010XX 24600000
         STC   GR1,WRL1           STORE MAX LENGTH IN LIST       X010XX 24650000
         OI    WRL1,X80           RESTORE OPTION BIT             X010XX 24700000
         STC   GR1,WRL2           STORE MAX LENGTH IN LIST       X010XX 24750000
         OI    WRL2,X80           RESTORE OPTION BIT             X010XX 24800000
         SPACE 1                                                        24900019
SETUPIOB EQU   *                                                        25200019
         L     GR5,DCB4IOB(GR3)        DCB ADDRESS FROM IOB             25400019
         LA    GR5,LEN0(GR5)      CLEAR HIGH ORDER BYTE                 25600019
         LA    GR1,CCW1           POINTER TO SEARCH EQUAL ID CCW X010XX 25800000
         ST    GR1,WRITLIST       BEGIN OF CHAIN(FOR EXTEND LIST)X010XX 25802000
         ST    GR1,RBLIST         BEGIN OF CHAIN(FOR EXTEND LIST)X010XX 25804000
         MVI   WRITLIST,X03       LENGTH OF CHAIN                X010XX 25804400
         MVI   RBLIST,X03         LENGTH OF CHAIN                X010XX 25804800
         LA    GR2,LEN16(GR8)          LOAD PTR TO STOP CCW SLOT S20201 25806020
         ST    GR2,LEN8(GR0,GR8)       STORE IN TIC CCW SLOT     S20201 25812020
         MVI   LEN8(GR8),X08           RESTORE TIC OP CODE       S20201 25818020
         MVI   LEN16(GR8),X03          SET STOP CCW TO NOP       S20201 25824020
         LA    GR2,DEVOFF(GR0,GR3)     PTR TO DEVICE INFO        S20201 25830020
         TM    LEN1(GR2),RPS           IS THIS AN RPS DEVICE     S20201 25840020
         BNO   NOTRPS1                 NO, GO ON                 S20201 25850020
         SPACE 1                                                 S20201 25860020
*    IF RPS IS SUPPORTED A SET SECTOR  CCW IS                    S20201 25870000
* APPENDED TO THE NORMAL CCW CHAIN                               S20201 25880020
*                                                                S20201 25890020
         LA    GR1,SSECTOR        PTR TO SET SECTOR CCW          S20201 25900020
         ST    GR1,WRITLIST       BEGIN OF CHAIN(FOR EXTEND LIST)X010XX 25902000
         ST    GR1,RBLIST         BEGIN OF CHAIN(FOR EXTEND LIST)X010XX 25904000
         MVI   RBLIST,X04         LENGTH OF CHAIN                X010XX 25906000
         MVI   WRITLIST,X04       LENGTH OF CHAIN                X010XX 25908000
         LA    GR2,SCTOFF(GR0,GR3)     PTR TO CURRENT SECTOR     S20201 25910020
*                                        VALUE                   S20201 25920020
         MVC   SECTOR(LEN1),LEN0(GR2)  MOVE VALUE TO ''SECTOR''  S20201 25930020
         MVC   RDBKSAVE(LEN1),LEN0(GR2)  SAVE CURRENT SECTOR     S20201 25940020
*                                        VALUE IN CASE READ      S20201 25950020
*                                        BACK CHECK REQUIRED     S20201 25960020
         SPACE 1                                                 S20201 25970020
         MVC   LEN16(LEN4,GR8),RSECTOR REPLACE NOP CCW WITH RS   S20201 25980020
NOTRPS1  EQU   *                                                 S20201 25990020
         MVC   WRCW23(LEN4),WRCW13     MAKE STOP CCW'S EQUAL     S20201 25993020
*                                       (EITHER NOP OR RS)       S20201 25996020
         ST    GR1,IOBCAW(GR3)         ADDRESS OF START CCW INTO IOB    26000019
         LA    GR1,CCW1           LOAD PTR TO SIDEQ CCW          S20201 26050020
*                                   GR1 MAY HAVE POINTED TO      S20201 26100020
*                                   SET SECTOR CCW               S20201 26150020
         SR    GR2,GR2                                                  26200019
         IC    GR2,LEN4(GR7)      PICK UP 'R' FROM COUNT FIELD          26300019
         TM    TAG,TAG1+TAG6           DIRECTORY OR SYSUT3 NON FORMAT   26500019
         BM    ARNDRDEC                DO NOT CHANGE R WRITE KEY/DATA   26600019
         BCTR  GR2,GR0            DECREMENT FOR SEARCH                  26700019
ARNDRDEC EQU   *                                                        26800019
         MVC   DISKADR(LEN7,GR5),LEN1(GR6)  MOVE MBBCCHH TO FDAD IN DCB 27000019
         STC   GR2,DISKREC(GR5)        SET R FIELD IN FDAD OF DCB       27300019
         MVC   IOBMCCHH(LEN8,GR3),DISKADR(GR5) MBBCCHHR FDAD TO IOB     27600019
         MVC   LASTADDR(LEN8),DISKADR(GR5)  SAVE MBBCCHHR FOR RESTART   27900019
         OI    IOBFLGS(GR3),NONSEQEN   SET COMD CHAIN-UNRELATED IN IOB  28200019
         LA    GR6,IOBCCHHR(GR3)       CCHHR FROM IOB                   28500019
         ST    GR6,LEN0(GR1)      STORE SEARCH ID ADDRESS               28800019
         MVI   LEN0(GR1),X31      RESTORE OP CODE                       29100019
         NI    TAG,XFF-TAG6       RESET TAG6                            29400019
         SPACE 1                                                        29700019
TRY      EQU   *                                                        30000019
         SR    GR5,GR5                 CLEAR REGISTER            S20201 30010020
         IC    GR5,IOBRECNO(GR0,GR3)   LOAD SEARCH RECORD        S20201 30020020
*                                        NUMBER                  S20201 30030020
         LTR   GR5,GR5                 RECORD NUMBER = 0         S20201 30040020
         BZ    ZEROSCTR                YES, UPDATE ''SECTOR''    S20201 30050020
         TM    TAG,TAG1                WRITING OUTPUT DIRECTORY  S20201 30060020
         BNO   ARND1                   NO, GO AROUND             S20201 30070020
         CLI   IOBRECNO(GR3),LEN1      UPDATING RECORD 1         S20201 30080020
         BNE   ARND1                   NO, GO AROUND             S20201 30090020
ZEROSCTR EQU   *                                                 S20201 30100020
         MVI   SECTOR,X00              SET ''SECTOR'' = 0        S20201 30110020
ARND1    EQU   *                                                 S20201 30120020
         MVC   CCW3+LEN1(LEN3),WRPTR1+LEN1  SET UP TIC ADDRESS          30200019
         MVI   CCW3,X08           MAKE SURE ITS A TIC                   30400019
         SPACE 1                                                        30600019
RESTART  EQU   *                                                        30900019
         TM    AOS,PCI                 NEED PCI HANDLING        YL026VD 30902002
         BO    RESTART1                YES, DO EXCPVR           YL026VD 30904002
         LR    GR1,GR3                 SET IOB ADDRESS          YM06949 30904402
         EXCP  (1)                     ISSUE WRITE EXCP         YM06949 30906002
         WAIT  1,ECB=EVENTCB           WAIT MACRO               YL026VD 30908002
         B     SAME1                                            YL026VD 30908402
         SPACE 1                                                        30908802
RESTART1 ST    GR3,IOBVRPTR                                    @YM06433 30910002
*                             THIS ROUTINE  REPLACES PCI       @ZA26248 30910199
*                             CHANNEL PROGRAMS WITH SINGEL     @ZA26248 30912199
*                             COMMAND CHAIN OF CCW'S TO WRITE  @ZA26248 30914199
*                             TOTAL BUFFERS AND SIMULATES      @ZA26248 30916199
*                             PCI ROUTINE. IT IS USED IF TWO   @ZA26248 30918199
*                             FULL TRK BUFFERS OR COMPRESSING  @ZA26248 30920199
*                                                              @ZA26248 30922199
         L     GR6,CCWAREA    GET ADDESS OF CCWAREA TO TEST IF @ZA26248 30924199
         LTR   GR6,GR6        IT IS PRESENT. IF NOT, USE PCI   @ZA26248 30926199
         BZ    BX49           BRANCH NO CCWAREA  USE PCI       @ZA26248 30928199
BX48     TM    TAG,TAG6       TEST IF THIS REENTRY FOR RDBACK  @ZA26248 30930199
         BO    BX51           YES, WE ALREADY PERFORMED EXIT   @ZA26248 30932199
         STM   GR5,GR13,PCISAVE    SAVE REGS                   @ZA26248 30934199
*                                                              @ZA26248 30936199
         NI    AOS,X'FF'-PCI  TURN OFF PCI                     @ZA26248 30938199
*                                                              @ZA26248 30940199
         L     GR5,WRPTR1     GET ADDRESS OF WHERE TO          @ZA26248 30942199
         L     GR5,LEN0(GR5)  WRITE FROM CCW                   @ZA26248 30944199
         LA    GR5,LEN0(GR5)  CLER OP CODE                     @ZA26248 30946199
*                                                              @ZA26248 30948199
         LA    GR0,X04        CONSTANT 4 TO BACK UP            @ZA26248 30950199
         TM    TAG,TAG1       TEST IF WRITING OUTPUT DIR BLKS  @ZA26248 30952199
         BNO   BX42           BRANCH IF NOT                    @ZA26248 30954199
         LA    GR0,LEN12      SET UP TO SKIP FMBBCCHHRKDD      @ZA26248 30956199
BX42     SR    GR5,GR0        TO FMBB                          @ZA26248 30958199
BX47     L     GR6,CCWAREA    GET ADDESS WHERE TO              @ZA26248 30960199
         TM    TAG,TAG1       TEST WRITING DIRECTORY           @ZA26248 30962199
         BZ    BX43           BRANCH NOT                       @ZA26248 30964199
         LA    GR6,DWRTL-LEN8(GR6) INCREMENT TO FIRST WRITE    @ZA26248 30966199
BX43     EQU   *                                               @ZA26248 30968199
*                             BUILD CCW'S                      @ZA26248 30970199
         STCM  GR6,C7,CCW3+C1 INITLISE TIC TO WRITES           @ZA26248 30972199
         L     GR6,CCWAREA                                     @ZA26248 30974199
*                                                              @ZA26248 30976199
*                                                              @ZA26248 30978199
BX25     LR    GR8,GR6        SAVE WHERE TO BUILD RD BACK TO.  @ZA26248 30980199
         MVC   R0CNTF(LEN5),LEN4(GR5)  SAVE CCHHR FOR READ     @ZA26248 30982199
BX38     EQU   *                       BACK CHECK              @ZA26248 30984199
         TM    TAG,TAG1       TEST FOR DIRECTORY WRITE OUTPUT  @ZA26248 30986199
         BO    BX33           BRANCH YES                       @ZA26248 30988199
         MVC   LEN0(LEN8,GR6),DACCW4   MOVE IN MODEL CCW       @ZA26248 30990199
*                                                              @ZA26248 30992199
         MVI   LEN0(GR6),X1D  SET WRITE COUNT KEY DATA         @ZA26248 30994199
         TM    LEN0(GR5),WRTOVR  TEST TRACK OVERFLOW           @ZA26248 30996199
         BZ    BX36           BRANCH NO TRAK OVERFLOW          @ZA26248 30998199
         MVI   LEN0(GR6),X01  SET WRITE SPECIAL                @ZA26248 31000199
BX36     EQU   *                                               @ZA26248 31002199
         SR    GR10,GR10      CLEAR REG                        @ZA26248 31004199
         IC    GR10,LEN9(GR5) GET KEY  LENGTH                  @ZA26248 31006199
         LH    GR9,LEN10(GR5)  GET DATA LENGTH                 @ZA26248 31008199
         LA    GR9,LEN8(GR9,GR10) ADD LENGTH OF COUNT KEY DATA @ZA26248 31010199
         STH   GR9,LEN6(GR6)  SET LENGTH IN CCW                @ZA26248 31012199
         LA    GR7,LEN4(GR5)  INCREMENT TO COUNT FIELD         @ZA26248 31014199
         B     BX34                                            @ZA26248 31016199
BX33     EQU   *                                               @ZA26248 31018199
         MVC   LEN0(DWRTL,GR6),DWCCW4  SET UP DIR WRITE CCWS   @ZA26248 31020199
         STCM  GR6,C7,LEN9(GR6)        SET TIC ADDRESS         @ZA26248 31022199
         LA    GR7,LEN4(GR5)           INCREMENT TO CCHHR FLD  @ZA26248 31024199
         STCM  GR7,C7,LEN1(GR6)        SET SERCH ADDRESS       @ZA26248 31026199
         LA    GR6,LEN8+LEN8(GR6)     INCREMENT OVER SERCH TIC @ZA26248 31028199
*                             BUILD WRITE KEY DATA             @ZA26248 31030199
*                                                              @ZA26248 31032199
         LA    GR7,LEN12(GR5) INCREMENT TO KEY FIELD           @ZA26248 31034199
*                                                              @ZA26248 31036199
BX34     STCM  GR7,C7,LEN1(GR6)  SET ADDRESS OF KEY DATA       @ZA26248 31038199
*                                                              @ZA26248 31040199
         LA    GR6,LEN8(GR6)  INCREMENT NEXT CCW LOCATION      @ZA26248 31042199
         TM    LEN0(GR5),ENDPROC+LASTREC    TEST LAST RECORD   @ZA26248 31044199
         BZ    BX35           NOT LAST RECORD CONT.            @ZA26248 31046199
*                                                              @ZA26248 31048199
         BO    BX29           YES, ALL READY TO BREAK CHAIN    @ZA26248 31050199
*                             + RD BACKCHECK                   @ZA26248 31052199
         L     GR5,BEGFST2    GETSTART SECOND BUFFER           @ZA26248 31054199
*                                                              @ZA26248 31056199
BX28     LA    GR0,LEN4        INDICATE HH SWITCH              @ZA26248 31058199
         SR    GR9,GR9                                         @ZA26248 31060199
         TM    TAG,TAG5+TAG1+TAG3  TEST FOR RD BACK            @ZA26248 31062199
         BZ    BX50           BRANCH ON NOT RDBACK             @ZA26248 31064199
         IC    GR9,LEN8(GR5)  GET RECORD NO.                   @ZA26248 31066199
*                                                              @ZA26248 31068199
         LA    GR9,LEN20(GR9) ROOM FOR 1 RD BK,TRK SW,ETC      @ZA26248 31070199
BX50     LA    GR9,LEN8(GR9) ROOM FOR 1 TRK SW, 1 REC+NOP      @ZA26248 31072199
         SLL   GR9,LEN3      MULTIPLY BY 8 TO GET SPACE REQ.   @ZA26248 31074199
*                             TO BUILD RD BACK CCW'S           @ZA26248 31076199
         AR    GR9,GR6        COMPUTE CURRENT THERORETICAL     @ZA26248 31078199
*                             END                              @ZA26248 31080199
         C     GR9,SVHI       TEST IF ROOM FOR CCW'S           @ZA26248 31082199
         BH    BX29          BRANCH ON NO ROOM                 @ZA26248 31084199
         CLI   LEN8(GR5),LEN1 IS NEXT RECORD R1                @ZA26248 31086199
         BNE   BX38           YES,GO BUILD RD BACK & CHANGE HH @ZA26248 31088199
BX30     BAL   GR10,RDBACX    LINK BUILD RD BACK CCW'S         @ZA26248 31090199
         B     BX25                                            @ZA26248 31092199
RCKD     EQU   X'1E'          RD COUNT KEY & DATA              @ZA26248 31094199
RKD      EQU   X'0E'          RD KEK AND DATA COMMAND          @ZA26248 31096199
*                             RD BACK AND CONDITIONALLY HEAD   @ZA26248 31098199
*                             SWITCH CCW BUILD SUBROUTINE      @ZA26248 31100199
*                             IF RO=O JUST DO RD BACK          @ZA26248 31102199
*                             GR5=RECORD FLAG FIELD            @ZA26248 31104199
*                             GR6=WHERE NEXT CCW GOES          @ZA26248 31106199
*                             GR8=FIRST CCW TO RD BACK         @ZA26248 31108199
*                                                              @ZA26248 31110199
RDBACX   EQU   *                                               @ZA26248 31112199
         LR    GR11,GR6                                        @ZA26248 31114199
         TM    TAG,TAG5+TAG1+TAG3  TEST FOR RD BACK            @ZA26248 31116199
*              BRANCH ON NO RD BACK REQUIRED                   @ZA26248 31118199
         BZ    BX37                                            @ZA26248 31120199
         MVC   LEN0(LEN8,GR6),DCCWHA SET READ HA TO CROSS INDX @ZA26248 31122199
         LA    GR6,LEN8(GR6) ADVANCE TO NEXT CCW SLOT          @ZA26248 31124199
         MVC   LEN0(TRKSWL,GR6),DWCCW1 MOVE TRACK SW CCW'S     @ZA26248 31126199
         MVI   LEN0(GR6),X31 SET COMMAND SEARCH ID EQUAL NO MT @ZA26248 31128199
         SR    GR1,GR1            CLEAR REG                    @ZA26248 31130199
         IC    GR1,R0CNTF+LEN4-DWCCW1(GR6) BACK UP R BY ONE    @ZA26248 31132199
         BCTR  GR1,GR0            REDUCE BY ONE                @ZA26248 31134199
         STC   GR1,R0CNTF+LEN4-DWCCW1(GR6)                     @ZA26248 31136199
*          CCHH   AND       RECNO ALLREADY IN R0CNTF           @ZA26248 31138199
         STCM  GR6,C7,LEN1+LEN8(GR6)   SET TIC ADDRESS         @ZA26248 31140199
*                                                              @ZA26248 31142199
         LA    GR1,R0CNTF-DWCCW1(GR6)   INCREMENT CCH          @ZA26248 31144199
*                                                              @ZA26248 31146199
         STCM  GR1,C7,LEN1(GR6)   SET ADDRESS IN SERCH         @ZA26248 31148199
*                                                              @ZA26248 31150199
         LA    GR1,TRKSWL(GR6)   ADDR NEXT CCW AREA            @ZA26248 31152199
         STCM  GR1,C7,DCCW3OST+LEN1(GR6)    TIC AROUN CCHHR    @ZA26248 31154199
         LR    GR6,GR1                                         @ZA26248 31156199
BX32     TM    TAG,TAG1       CHECK FOR WRITING OUTPUT DIR     @ZA26248 31158199
         BZ    BX44           BRANCH NOT WRITING  OF RECORD    @ZA26248 31160199
         LA    GR8,LEN8+LEN8(GR8)  INCREMENT OVER SERCH TIC    @ZA26248 31162199
BX44     MVC   LEN0(LEN8,GR6),LEN0(GR8) WRITE CCW OF RECORD    @ZA26248 31164199
*                             TO BE CHECKED                    @ZA26248 31166199
SKIP     EQU   X'10'          SUPPRESS TRANSFR BIT             @ZA26248 31168199
X22      EQU   X'22'           READ SECTOR OP CODE             @ZA26248 31170199
         OI    LEN4(GR6),SKIP SET NO TRANSFR                   @ZA26248 31172199
         MVI   LEN0(GR6),RKD  SET RD KEY & DATA                @ZA26248 31174199
         CLI   LEN0(GR8),X0D  WRITE KEY DATA                   @ZA26248 31176199
         BE    BX31                                            @ZA26248 31178199
         MVI   LEN0(GR6),RCKD                                  @ZA26248 31180199
BX31     EQU   *                                               @ZA26248 31182199
RDCNT    EQU   X'12'         RD COUN COMMAND CODE              @ZA26248 31184199
         LH    GR1,LEN6(GR6) GET RECORD LENGTH                 @ZA26248 31186199
         CH    GR1,=H'8'     IF IT IS EIGHT DO RD COUNT        @ZA26248 31188199
         BNE   BX45                                            @ZA26248 31190199
         MVI   LEN0(GR6),RDCNT SET READ COUNT COMMAND          @ZA26248 31192199
BX45     LA    GR6,LEN8(GR6)  INCREMENT TO NEXT CCW'S          @ZA26248 31194199
         LA    GR8,LEN8(GR8)                                   @ZA26248 31196199
*                                                              @ZA26248 31198199
         CR    GR8,GR11       TEST RD BACKS ALL BUILD          @ZA26248 31200199
         BL    BX32           BRANCH NOT ALL DONE              @ZA26248 31202199
*                                                              @ZA26248 31204199
BX37     LTR   GR0,GR0        TEST FOR HEAD SWITCH             @ZA26248 31206199
         BZR  GR10            ZERO=NO HEAD SWITCH              @ZA26248 31208199
*                                                              @ZA26248 31210199
         MVC   LEN0(TRKSWL,GR6),DWCCW1  MOVE TRAC SWITCH CCW'S @ZA26248 31212199
*                                                              @ZA26248 31214199
         MVC   R0OFSET(LEN4,GR6),LEN4(GR5)  MOVE CCHH          @ZA26248 31216199
         MVI   R0OFSET+LEN4(GR6),X00   SET R0                  @ZA26248 31218199
*                                                              @ZA26248 31220199
         STCM  GR6,C7,LEN1+LEN8(GR6)   SET TIC ADDRESS         @ZA26248 31222199
*                                                              @ZA26248 31224199
         LA    GR8,R0CNTF-DWCCW1(GR6)   INCREMENT CCH          @ZA26248 31226199
*                                                              @ZA26248 31228199
         STCM  GR8,C7,LEN1(GR6)   SET ADDRESS IN SERCH         @ZA26248 31230199
*                                                              @ZA26248 31232199
         LA    GR8,TRKSWL(GR6)   ADDR NEXT CCW AREA            @ZA26248 31234199
         STCM  GR8,C7,DCCW3OST+LEN1(GR6)    TIC AROUN CCHHR    @ZA26248 31236199
*                                                              @ZA26248 31238199
         LR    GR6,GR8        ADVANCE TO NEXT SLOT             @ZA26248 31240199
*                                                              @ZA26248 31242199
         BR    GR10           RETURN                           @ZA26248 31244199
*                                                              @ZA26248 31246199
BX29     EQU   *              RD BACK AND BREAK CHAIN          @ZA26248 31248199
         SR    GR0,GR0                                         @ZA26248 31250199
         BAL   GR10,RDBACX    GO BUILD RD BACK CCWS            @ZA26248 31252199
         MVC   LEN0(LEN8,GR6),WRCW13 TERM WITH RD SECTOR/NOP   @ZA26248 31254199
         EXCP  (GR3)       PERFORM THE WRITES                  @ZA26248 31256199
         WAIT  1,ECB=EVENTCB                                   @ZA26248 31258199
         USING DXIOB,GR3                                       @ZA26248 31260199
         L     GR6,IOBCSW       GET CSW                        @ZA26248 31262199
         LA    GR6,LEN0(GR6)                                   @ZA26248 31264199
         DROP  GR3                                             @ZA26248 31266199
         LA    GR7,LEN8         LENGTH OF CCW                  @ZA26248 31268199
         SR    GR6,GR7         BACK UP ONE CCW                 @ZA26248 31270199
XB1      EQU   X'B1'      SEARCH ID EQUAL MT COMMAND           @ZA26248 31272199
         CLI   LEN0(GR6),XB1    IS IT A SERCH                  @ZA26248 31274199
         BNE   BX39                                            @ZA26248 31276199
         LA    GR6,TRKSWL(GR6)    SEARCH INREMENT TO WRITE     @ZA26248 31278199
         B     BX39                                            @ZA26248 31280199
BX41     SR    GR6,GR7          BACK UP ONE CCW                @ZA26248 31282199
BX39     CLI   LEN0(GR6),X22    IS IT A RD SECTOR              @ZA26248 31284199
         BE    BX41             BRANCH YES                     @ZA26248 31286199
         CLI   LEN0(GR6),X03    IS IT A NOP                    @ZA26248 31288199
         BE    BX41             BRANCH YES                     @ZA26248 31290199
         L     GR7,LEN0(GR6)    GET AREA LAST WRITTEN OR TRIED @ZA26248 31292199
         STCM  GR7,C7,CURRCCW1+LEN1   SAVE FOR TERMINATION     @ZA26248 31294199
         STCM  GR7,C7,CURRCCW2+LEN1   SAVE FOR TERMINATION     @ZA26248 31296199
         LA    GR1,LEN4      CONSTANT TO STEP BACK TO FLAG FLD @ZA26248 31298199
         TM    TAG,TAG1               IS THIS OUTPUT DIR WRITE @ZA26248 31300199
         BNO   BX40                   BRANCH ON NO             @ZA26248 31302199
         LA    GR1,LEN8(GR1) CONSTANT TO REACH FLAG FIELD      @ZA26248 31304199
BX40     SR    GR7,GR1                BACK UP TO FLAG FIELD    @ZA26248 31306199
         MVC   LASTADDR(LEN8),LEN1(GR7)                        @ZA26248 31308199
         CLI   EVENTCB,X7F   CHECK IF COMPLETED NORMAL         @ZA26248 31310199
         BE    BX46                    BRANCH ON NORMAL        @ZA26248 31312199
         SR    GR0,GR0       BACK UP R BY ONE ON ABNORMAL      @ZA26248 31314199
         IC    GR0,LASTADDR+LEN7       GET LAST WROTE REC NO.  @ZA26248 31316199
         BCTR  GR0,GR0                 REDUCE BY ONE           @ZA26248 31318199
         STC   GR0,LASTADDR+LEN7       POINT REC-1             @ZA26248 31320199
         B     BX27                    EXIT FOR ERROR HANDLING @ZA26248 31322199
BX46     TM    LEN0(GR7),ENDPROC TST WROTE LAST RECORD WRITTEN @ZA26248 31324199
         BO    BX27                    BRANCH YES, EXIT        @ZA26248 31326199
         MVC   IOBMCCHH(LEN8,GR3),LEN1(GR5)  SET SEEK ADDRESS  @ZA26248 31328199
         SR    GR0,GR0            CLEAR REG                    @ZA26248 31330199
         IC    GR0,IOBRECNO(GR3)  GET RECORD NO OF NEXT RECORD @ZA26248 31332199
         BCTR  GR0,GR0            BACK UP ONE RECORD           @ZA26248 31334199
         STC   GR0,IOBRECNO(GR3)  FOR SERCH PREVIOUS           @ZA26248 31336199
         L     GR6,CCWAREA   RESET TO START OF CCW AREA        @ZA26248 31338199
         B     BX43  IOB POINTS TO PREVIOUS REC SO USE SCH CNT @ZA26248 31340199
BX35     SR    GR10,GR10     CLEAR REG                         @ZA26248 31342199
         IC    GR10,LEN9(GR5) GET KEY LENGTH                   @ZA26248 31344199
         AH    GR5,LEN10(GR5) INCREMENT BY RECORD LENGTH       @ZA26248 31346199
         LA    GR5,LEN12(GR5,GR10) FMBBCCHHKLDL + KEY AND DATA @ZA26248 31348199
         B     BX28                                            @ZA26248 31350199
BX49     EQU   *                                               @ZA26248 31352199
         LR    GR1,GR3                                          YL026VD 31354199
         EXCPVR (1),SUBSYS       ISSUE WRITE/READ ON PROPER IOB YL026VD 31356199
         WAIT  1,ECB=EVENTCB                                            31358199
         B     BX51                                            @ZA26248 31360199
BX27     EQU   *                                               @ZA26248 31362199
         LM    GR5,GR13,PCISAVE                                @ZA26248 31364199
BX51     EQU   *                                               @ZA26248 31366199
         OI    AOS,PCI            RESTORE PCI BIT              @YM04451 31501002
         L     GR10,IOBVRPTR      GET ADDR OF IOB LAST USED    @YM06434 31502002
         LA    GR10,C35(GR10)     GET ADDRESS OF CCHHR         @YM06434 31504002
         STCM  GR10,C7,CCW1+C1    STORE VIRT INTO SIDEQ CCW    @YM06434 31506002
         LA    GR10,CCW1          GET ADDRESS OF SIDEQ CCW     @YM06434 31508002
         STCM  GR10,C7,CCW2+C1    STORE VIRT INTO TIC BACK     @YM06434 31508402
         TM    TAG,TAG6           READ BACK CHECKING           @YM06433 31510002
         BZ    ISWRITE            NO, JUST DID WRITE           @YM06433 31520002
         LA    GR10,LASTADDR      ADR OF READ BACK CHECK COUNT @YM06433 31530002
         STCM  GR10,C7,RDCKCW11+C1 RESTORE VIRTUAL ADDRESS     @YM06433 31540002
         STCM  GR10,C7,RDCKCW12+C1 RESTORE VIRTUAL ADDRESS     @YM06433 31542002
         STCM  GR10,C7,RDCKCW21+C1 RESTORE VIRTUAL ADDRESS     @YM06433 31544002
         STCM  GR10,C7,RDCKCW22+C1 RESTORE VIRTUAL ADDRESS     @YM06433 31546002
         LA    GR10,SECTOR        ADRRESS OF 'SECTOR'          @YM06447 31555002
         STCM  GR10,C7,RDCKCW13+C1 RESTORE VIRTUAL ADDRESS     @YM06447 31564002
         STCM  GR10,C7,RDCKCW23+C1 RESTORE VIRTUAL ADDRESS     @YM06435 31573002
         B     SAME1              GO CHECK COMPLETION          @YM06433 31582002
ISWRITE  L     GR10,WRPTR1        GET ADDR OF WRITE CCW        @YM06433 31591002
         L     GR5,CURRCCW1       GET VIRTUAL DATA ADDRESS     @YM06433 31600002
         STCM  GR5,C7,LEN1(GR10)  STORE VIRTUAL ADDRESS        @YM06433 31610002
         L     GR10,WRPTR2        GET ADDR OF WRITE CCW        @YM06433 31800002
         L     GR5,CURRCCW2       GET VIRTUAL DATA ADDRESS     @YM06433 31850002
         STCM  GR5,C7,LEN1(GR10)  STORE VIRTUAL ADDRESS        @YM06433 31860002
         LA    GR10,WRCW13        GET VIRTUAL NO-OP ADDR       @YM06435 31910002
         STCM  GR10,C7,WRCW13+C1  STORE IN 1ST NO-OP           @YM06435 31960002
         STCM  GR10,C7,WRCW12+C1  STORE IN 1ST TIC             @YM04451 31970002
         LA    GR10,WRCW23        GET VIRTUAL NO-OP ADDR       @YM04451 31980002
         STCM  GR10,C7,WRCW22+C1  STORE IN 2ND TIC             @YM04451 31990002
         STCM  GR10,C7,WRCW23+C1  STORE IN 2ND NO-OP           @YM06435 32010002
         SPACE 1                                                        34200019
SAME1    EQU   *                                                        34500019
         CLI   EVENTCB,X7F        I/O COMPLETED OK                      34800019
         BNE   CHKERRX                 NO- CHECK FOR ERROR              35100019
GOT7F    EQU   *                                                        35200019
         TM    TAG,TAG6                READ BACK CHECKING               35400019
         BZ    WRTCHKS            NO- JUST WROTE                        35600019
ERRRDBK  EQU   *                                                        35800019
         L     GR10,WRPCICNT           COUNT OF RECORDS WRITTEN         36000019
         LTR   GR10,GR10               ALL DONE                         36300019
         BNP   RETRNS             YES,EXIT                      OY01184 36600002
         MVC   CCW3(LEN4),RDCKPTR1  SET UP TIC FOR NEXT WRITE           36900019
         MVI   CCW3,X08           RESTORE TIC OP CODE                   37200019
         MVC   IOBCCHHR(LEN5,GR3),LASTADDR  MOVE SEEK ADDR. TO IOB      37500019
         B     RESTART                 ISSUE READ                       37800019
         SPACE 1                                                        38100019
WRTCHKS  EQU   *                                                        38400019
         TM    TAG,TAG4                SYSUT3                           38500019
         BO    RETRNS             IF SO, AM ALL DONE WRITING RECORD     38600019
         L     GR5,WRPTR2              GET CCW OF PCI JUST PROCESSED    38700019
         L     GR6,LEN0(GR5)      GET WRITE ADDRESS                     38800019
         LA    GR6,LEN0(GR6)      CLEAR OP CODE                         38900019
         LA    GR5,LEN4           SET NUMBER OF BYTES BEFORE POINTER    39000019
         TM    TAG,TAG1                WRITING DIRECTORY                39420019
         BZ    NOTDIRTY                NO-XFER                          39440019
         LA    GR5,LEN12          SKIP BACK TO FLAG BYTE                39460019
NOTDIRTY EQU   *                                                        39480019
         SR    GR6,GR5            POINT TO FLAG PRECEEDING CCHHR        39500019
         MVC   IOBMCCHH(LEN8,GR3),LASTADDR  MOVE IN SEEK ADDRESS        39600019
         TM    LEN0(GR6),ENDPROC  WROTE VERY LAST RECORD                39700019
         BZ    TRY                NO- GO WRITE- PCI LATE                39800019
         TM    TAG,TAG2                MEMBERS                          39940019
         BZ    RDBKTEST                NO-GO TEST FOR READ BACKING      39980019
         MVC   OUTFDAD(LEN8),LEN1(GR6) YES-SAVE LAST MBBCCHHR           40020019
RDBKTEST EQU   *                                                        40060019
         TM    TAG,TAG1+TAG3+TAG5      WROTE DIRECTORY OR READ BACK ON  40100019
         BC    MS5,RDBKCKRT       YES- READ BACK CHECK                  40300019
         SPACE 1                                                        40500019
RETRNS   EQU   *                                                        40700019
         LA    GR6,SCTOFF(GR0,GR3)     PTR TO SECTOR SAVE SLOT   S20201 40750020
         MVC   LEN0(LEN1,GR6),SECTOR   SAVE LAST SECTOR VALUE    S20201 40800020
RETRNS1  EQU   *                                                 S20201 40850020
         L     GR13,SV5+SAV4      POINTER TO SAVE AREA                  40900019
         RETURN (14,12)                RETURN TO CALLER                 41100019
         SPACE 1                                                        41700019
RDBKCKRT EQU   *                                                        42000019
         L     GR5,WRTNEXT             START BEGIN FOR REBACK CHECKING  42300019
         LA    GR3,UT4IOB              IOB FOR SYSUT4                   42600019
         TM    TAG,TAG3                WRITING OUTPUT DIRECTORY SYSUT4  42900019
         BO    GOTIOBD            YES- IOB POINTER SET IN GR3           43200019
         LA    GR3,OUTIOB              IOB FOR OUTPUT DATA SET          43500019
         SPACE 1                                                        43800019
GOTIOBD  EQU   *                                                        44100019
         MVC   SECTOR(LEN1),RDBKSAVE   RESTORE INITIAL SECTOR    S20201 44200020
*                                         VALUE FOR READBACK     S20201 44300020
*                                         CHECK                  S20201 44400020
         MVC   IOBMCCHH(LEN8,GR3),LEN1(GR5) SET UP MBBCCHHR IN IOB      44700019
         SR    GR7,GR7                                                  45300019
         IC    GR7,LEN8(GR5)      GET RECORD NUMBER (R)                 45600019
         BCTR  GR7,GR0            DECREMENT RECORD NUMBER BY 1          45900019
         STC   GR7,IOBRECNO(GR3)       STORE NEW RECORD NUMBER FOR SEEK 46200019
         LTR   GR7,GR7                 IS SEARCH RECORD          S20201 46250020
*                                        NUMBER = 0              S20201 46300020
         BNZ   ARND2                   NO, GO AROUND             S20201 46350020
         MVI   SECTOR,X00              SET ''SECTOR'' = 0        S20201 46400020
ARND2    EQU   *                                                 S20201 46450020
         LA    GR2,IOBCCHHR(GR3)       POINT TO SEARCH ADDRESS          46500019
         ST    GR2,CCW1                STORE SEARCH ADDRESS IN CCW1     46800019
         MVI   CCW1,X31           RESTORE OP CODE FOR SEARCH ID=        47100019
         LA    GR6,RDCKCW11                                             47400019
         ST    GR6,RDCKPTR1            STORE POINTER TO START READ BACK 47700019
         LA    GR7,RDCKCW21                                             48000019
         ST    GR7,RDCKPTR2            STORE POINTER TO SECOND CCW LIST 48300019
         ST    GR6,CCW3                SET UP TIC TO RDCKOW11           48600019
         MVI   RDCKCW13,X03       INITIALIZE NOP                        48700019
         LA    GR6,DEVOFF(GR0,GR3)     PTR TO DEVTYPE INFO       S20201 48710020
         TM    LEN1(GR6),RPS           IS THIS AN RPS DEVICE     S20201 48720020
         BNO   NOTRPS2                 NO, GO ON                 S20201 48730020
         SPACE 1                                                 S20201 48740020
         MVC   RDCKCW13(LEN4),RSECTOR  REPLACE NOP WITH RS CCW   S20201 48750020
NOTRPS2  EQU   *                                                 S20201 48760020
         MVI   RDCKCW12+LEN4,X78  INITIALIZE PCI SKIP SLI               48800019
         OI    TAG,TAG6                SET FOR READ BACK CHECKING       48900019
         MVI   CCW3,X08           RESTORE TIC OP CODE                   49200019
         B     RESTART                 START READ BACK CHECKING         49500019
         SPACE 1                                                        49800019
CHKERRX  EQU   *                                                        50100019
         TM    TAG,TAG2+TAG3+TAG4      MEMBER SYSUT4 SYSUT3             50500019
         BZ    ERROR4             NO                                    50700019
         CLI   EVENTCB,X41        I/O ERROR                             50900019
         BE    EOFTEST                 YES-TEST FOR WHOM AND WHY        51100019
         CLI   EVENTCB,X42        EXTENT ADDRESS VIOLATED-OUTPUT        51300019
         BNE   ERROR4                  YES- TYPE 4 ERROR END OF EXTENT  51600019
         LA    GR5,RDCKPTR1            READ PTR.                        51900019
         TM    TAG,TAG6                READ BACK CHECKING               52200019
         BO    RDCKING            YES                                   52500019
         LA    GR5,WRPTR1              WRITE PTR.                       52800019
         SPACE 1                                                        53100019
RDCKING  EQU   *                                                        53400019
         MVC   CCW3+LEN1(LEN3),LEN1(GR5) MOVE CORRECT ADDR. TO TIC      53700019
         SR    GR6,GR6                                                  54000019
         LR    GR8,GR3                                                  54100019
         L     GR7,DCB4IOB(GR8)        GET DCB POINTER FROM IOB         54200019
         LA    GR7,LEN0(GR7)      CLEAR HIGH ORDER BYTE                 54400019
         IC    GR6,IOBMCCHH(GR8)       OBTAIN M (EXTENT NUMBER)         54600019
         L     GR5,DEBPTR(GR7)         POINTER TO DEB                   55800019
         SR    GR7,GR7                                                  56100019
         IC    GR7,LEN16(GR5)     GET NUMBER OF EXTENTS FROM DEB        56400019
         LA    GR6,LEN1(GR0,GR6)       UP EXTENT NUMBER BY 1            56500019
         CR    GR6,GR7                 EXTENTS EXCEEDED                 56700019
         BL    ARND                    NO                               56780019
         MVI   IOBECBCD(GR8),ENDEXT    SET END EXTENT CODE IN IOB       56860019
         B     ERROR4                  GO TO ERROR ANALYSIS ROUTINE     56940019
ARND     EQU   *                                                        57020019
         STC   GR6,IOBMCCHH(GR8)       STORE NEW M                      57200019
         SLA   GR6,LEN4           MULTIPLY EXTENT BY 16                 57400019
         AR    GR6,GR5                 ADD TO START OF DEB TO GET ADDR  57600019
         MVC   IOBBCCHH(LEN6,GR8),EXTBBDEB(GR6)  SEEK ADDRESS           57900019
         MVI   IOBRECNO(GR8),X00  MAKE RECORD NUMBER R=0                58200019
         LA    GR9,IOBCCHHR(GR8)       POINTER TO CCHHR FOR SEARCH      58500019
         ST    GR9,CCW1                STORE SEARCH ADDRESS POINTER     58800019
         MVI   CCW1,X31           RESTORE SEARCH ID = OP CODE           59800019
         B     RESTART                 WRITE SOME MORE                  60900019
EOFTEST  EQU   *                                                        60930019
         TM    TAG,TAG3+TAG6           SYSUT4+READ BACKING              60960019
         BO    UNCHECK                 YES- CHECK UNIT EXCEPTION        60990019
         TM    TAG,TAG2+TAG6           MEMBER + READ BACKING            61020019
         BZ    ERROR4                  NO-MUST BE ERROR CAN'T BE OTHER  61050019
UNCHECK  EQU   *                                                        61080019
         TM    IOBCSWST(GR3),X01  EOF                                   61110019
         BO    ERRRDBK                 CHECK TO SEE IF VALIDITY  A35473 61130021
*                                        CHECKING IS COMPLETED   A35473 61150021
*                                                                       61170019
         SPACE 1                                                        61200019
         SPACE 1                                                        62200019
ERROR4   EQU   *                                                        63200019
         LR    GR5,GR3                 GET IOB ADDRESS FOR SYNADAF      63700019
         L     GR15,VIEBDSWE           ENTRY POINT IN DSCPY TO   A33288 64000020
*                                        TRANSFER CONTROL TO     A33288 64300020
*                                        IEBIOE                  A33288 64600020
         BALR  GR14,GR15               GO TO IDENTIFY THE I/O ERROR     65200019
IEBDWRR  EQU   *                                                 A33288 65220020
         ENTRY IEBDWRR                                           A33288 65240020
         B     GOT7F                   IF IEBIOE RETURNS CONTROL,       65280019
*                                        ERROR CAN BE IGNORED           65360019
         EJECT                                                          65440019
*********************************************************************** 65520019
*                                                                     * 65600019
*     THIS ROUTINE IS USED BY IEBWSU WHEN SETTING UP OVERFLOW RECORDS * 65680019
*  AND WRITING CANNOT BE DONE TO THE END OF A CYLINDER OR EXTENT      * 65760019
*  BOUNDRY.  THIS HAPPENS BECAUSE THE CROSSING OF THESE BOUNDRIES     * 65840019
*  WITH SEGMENTS IS NOT ALLOWED.  IF THE REMAINING TRACKS ARE NOT     * 65920019
*  ERASED, READING OF THE DATA CANNOT BE DONE PROPERLY.               * 66000019
*                                                                     * 66080019
*  INPUT - FIRSTERS CONTAINS THE TTR OF THE FIRST TRACK TO            * 66160019
*          BE ERASED                                                  * 66240019
*        - LASTERS CONTAINS THE TTR OF THE LAST TRACK TO BE           * 66320019
*          ERASED                                                     * 66400019
*                                                                     * 66480019
*  OUTPUT- ALL TRACKS FROM FIRSTERS TO AND INCLUDING LASTERS ARE      * 66560019
*          ERASED                                                     * 66640019
*                                                                     * 66720019
*********************************************************************** 66800019
         SPACE 2                                                        66880019
ERASEIT  EQU   *                                                        66960019
         NI    AOS,XFF-PCI             TURN OFF PCI PROCESS FLAG X010XX 67010000
         LA    GR2,OUTIOB              LOAD PTR TO IOB                  67040019
         MVI   IOBFLGS(GR2),NONSEQEN   SET COMMAND CHAIN-UNRELATED      67120019
         LA    GR7,CCW1                LOAD PTR TO SIDEQ                67200019
         LA    GR8,DEVOFF(GR0,GR2)     PTR TO DEVTYPE INFO       S20201 67206020
         TM    LEN1(GR8),RPS           IS THIS AN RPS DEVICE     S20201 67212020
         BNO   NOTRPSER                NO, GO ON                 S20201 67218020
         SPACE 1                                                 S20201 67224020
*   IF RPS IS SUPPORTED A SET SECTOR  CCW  IS                    S20201 67230000
*  APPENDED TO THE NORMAL CCW CHAIN                              S20201 67236020
*                                                                S20201 67242020
         LA    GR7,SSECTOR             PTR TO SET SECTOR CCW     S20201 67248020
         MVI   SECTOR,X00              SET SECTOR VALUE TO 0     S20201 67254020
         SPACE 1                                                 S20201 67260020
NOTRPSER EQU   *                                                 S20201 67266020
         ST    GR7,IOBCAW(GR0,GR2)  STORE  IN  IOB CAW                  67280019
         LA    GR2,IOBCCHHR(GR0,GR2) BUMP PTR TO SEEK ADDRESS           67360019
         ST    GR2,CCW1                STORE IN SIDEQ CCW               67440019
         MVI   CCW1,X31           RESTORE SIDEQ  OP CODE                67520019
         LA    GR6,ERSCCW              LOAD PTR TO ERASE CCW            67600019
         ST    GR6,CCW3                MAKE TIC PT TO ERASE             67680019
         MVI   CCW3,X08           RESTORE TIC OP CODE                   67760019
         L     GR11,FIRSTERS           LOAD TTR OF FIRST TRACK          67840019
*                                        TO BE ERASED                   67920019
         SPACE 1                                                        68000019
ERSLOOP  EQU   *                                                        68080019
         L     GR15,VTTOCC             LOAD PTR TO CONVERT RTN          68160019
         LA    GR1,OUTDCB              LOAD PTR TO OUTPUT DCB           68240019
         LA    GR2,OUTIOB              LOAD PTR TO                      68320019
         LA    GR2,IOBMCCHH(GR0,GR2)   IOB  SEEK  ADDRESS               68400019
         LR    GR0,GR11                LOAD TTR TO BE CONVERTED         68480019
         BALR  GR14,GR15               GO TO CONVERT ROUTINE            68560019
         SPACE 1                                                        68640019
         EXCP  OUTIOB                  ISSUE EXCP FOR ERASE     YL026VD 68720002
         SRL   GR11,LEN16         SHIFT OUT  RN OF TTRN                 68800019
         LA    GR11,LEN1(GR0,GR11)  BUMP TT BY ONE                      68880019
         SLL   GR11,LEN16         SHIFT  BACK FOR TTRN                  68960019
         WAIT  1,ECB=EVENTCB           WAIT FOR I/O TO COMPLETE         69040019
         SPACE 1                                                        69120019
         CLI   EVENTCB,X7F        I/O  OK                               69200019
         BE    ERASEOK                 YES, GO AROUND                   69280019
         SPACE 1                                                        69310019
         LA    GR3,OUTIOB              LOAD PTR TO IOB                  69340019
         B     ERROR4                  GO TO ERROR RTN                  69370019
         SPACE 1                                                        69400019
ERASEOK  EQU   *                                                        69440019
         CL    GR11,LASTERS            MORE TO ERASE                    69520019
         BNH   ERSLOOP                 NO, CONTINUE                     69600019
         SPACE 1                                                        69680019
         B     RETRNS1                 RETURN                    S20201 69880020
         SPACE 1                                                        70200019
*                             READING CCWS MODEL               @ZA26248 70210099
*                                                              @ZA26248 70240099
DRCCW1   CCW   X'9E',0,X'40',KBLEN+X8 READ COUNT KEY AND DATA  @ZA26248 70270099
*        LENGTH FIELD MODIFIED TO BLOK SIZE AND 8              @ZA26248 70300099
*                             FOR OTHER INPUTS.                @ZA26248 70330099
*              DIRECTOR, WRITING CCW MODEL                     @ZA26248 70360099
*                                                              @ZA26248 70390099
DWCCW1   CCW   X'B1',R0CNTF,X'60',5  SERCH ON FIRST CNT        @ZA26248 70420099
DWCCW2   CCW   X'08',DWCCW1,X'00',1  TIC UNTIL FOUND           @ZA26248 70450099
DWCCW3   CCW   X'08',DWCCW4,X'00',1  TIC AROUND CNT            @ZA26248 70480099
R0CNTF   DC    D'0'                                            @ZA26248 70510099
DWCCW4   CCW   X'B1',*,X'60',5 SEARCH FOR COUNT OF DIRECTORY   @ZA26248 70540099
         CCW   X'08',*,X'60',1      TIC TO SERCH ID            @ZA26248 70570099
         CCW   X'0D',0,X'60',KBLEN WRITE KEY+DATA CC AND SLI   @ZA26248 70600099
DWRTL    EQU   *-DWCCW4      LENGTH OF DIRECTORY WRITE CCW'S   @ZA26248 70630099
*        DWCCW4 REPEATS AS MANY TIMES AS BLOCKS/TRACK          @ZA26248 70660099
TRKSWL   EQU   DWCCW4-DWCCW1  LENGTH OF TRACK SWITCH MODEL     @ZA26248 70690099
*                                                              @ZA26248 70720099
*        OUTPUT CCW MODEL USED IN PLACE DWCCW4                 @ZA26248 70750099
DACCW4   CCW   X'1D',0,X'60',0                                 @ZA26248 70780099
DCCWHA  CCW   X'1A',*,X'70',16   READ HA CC SLI AND SKIP       @ZA26248 70810099
*                                                              @ZA26248 70840099
CC       EQU   X'60'          COMMAND CHAIN                    @ZA26248 70870099
R0OFSET  EQU   R0CNTF-DWCCW1                                   @ZA26248 70900099
DCCW3OST EQU   DWCCW3-DWCCW1                                   @ZA26248 70930099
*                                                              @ZA26248 70960099
PATCHLN  EQU   (*-START)/20            5 PER-CENT PATCH AREA LENGTH     70990099
PATCH    DC    XL(PATCHLN)'00'         PATCH AREA                A41780 71020099
*                                                              @ZA26248 71050099
DEVTAB   DSECT                                                 @ZA26248 71080099
*                                                              @ZA26248 71110099
*     DIRECT ACCESS DEVICE TABLE OVERLAY  OUTCHAR IN IEBMCA    @ZA26248 71140099
*                                                              @ZA26248 71170099
DEVCODE  DS    F                       DEVICE CODE FROM UCB    @ZA26248 71200099
MAXSIZE  DS    F                       MAX SIZE UNKEYED BLOCK  @ZA26248 71230099
MAXCC    DS    H                       NUMBER OF CYLINDER      @ZA26248 71260099
MAXHH    DS    H                       NUMBER OF TRACKS        @ZA26248 71290099
TRKCAP   DS    H                       MAXIMUM TRACK LENGTH    @ZA26248 71320099
OVERI    DS    XL1                     OVERHEAD NOT LAST RCD   @ZA26248 71350099
OVERL    DS    XL1                     OVERHEAD LAST RECORD    @ZA26248 71380099
OVERK    DS    XL1           OVERHEAD REDUCTION FOR NON-KEY    @ZA26248 71410099
DEVFLAG  DS    XL1           APPLY TOLERANCE FACTOR NOT LAST   @ZA26248 71440099
TOLER    DS    H             GAP LENGTH CALCULATE TOLERANCE    @ZA26248 71470099
TOLFAC   EQU   X'01'         TOLERANCE FACTOR TO BE ADDED      @ZA26248 71500099
HALFOVER EQU   X'08'                                    S20201 @ZA26248 71530099
*                                                              @ZA26248 71560099
*       END OF DEVTAB OVERLAY                                  @ZA26248 71590099
*                                                              @ZA26248 71620099
KBLEN   EQU  256+8    DIRECTORY BLOCK PLUS KEY                 @ZA26248 71650099
X8      EQU  X'08'                                             @ZA26248 71680099
         EJECT                                                          72300019
IEBMCA   DSECT                                                          72600019
         IEBMCA                                                         72900019
         EJECT                                                          73200019
         DCBD  DSORG=PS                                                 73500019
         EJECT                                                          73800019
IECDSECT DSECT                                                          74100019
         IECDSECT                                                       74400019
         SPACE 1                                                        74700019
IOBCAW   EQU   IOBSIOCC-DXIOB          STARTING CCW ADDRESS (CAW) IOB   75000019
DCB4IOB  EQU   IOBDCBPT-DXIOB-1        POINTER TO DCB IN IOB            75100019
IOBCSWST EQU   IOBSTAT0-DXIOB          CSW STATUS IN IOB                75300019
IOBMCCHH EQU   DXDAADDR-DXIOB          MBBCCHHR IN IOB                  75600019
IOBBCCHH EQU   DXDAADDR-DXIOB+1        BBCCHHR IN IOB                   75900019
IOBCCHHR EQU   DXDAADDR-DXIOB+3        CCHHR IN IOB                     76200019
IOBRECNO EQU   DXDAADDR-DXIOB+7        R OF MBBCCHHR IN IOB             76500019
IOBFLGS  EQU   IOBFLAG1-DXIOB          FLAG AREA IN IOB                 76800019
IOBECBCD EQU   IOBECBPT-DXIOB          ECB CODE IN IOB                  76900019
ENDEXT   EQU   X'42'                   END OF EXTENT CODE IOB/ECB       77000019
NONSEQEN EQU   X'42'                   IOB FLAGS                        77100019
         SPACE 1                                                        77400019
EXTBBDEB EQU   DXDEBBIN-DXDEB          BBCCHH FOR START OF EXTENT DEB   77700019
         SPACE 1                                                        78000019
DISKADR  EQU   DCBFDAD-IHADCB          MBBCCHHR RECORD JUST WRITTEN     78300019
DISKREC  EQU   DCBFDAD-IHADCB+7        R FIELD IN FDAD OF DCB           78600019
DEBPTR   EQU   DCBDEBAD-IHADCB         DEB POINTER IN DCB               78900019
KEYDCB   EQU   DCBKEYLE-IHADCB    KEY LENGTH IN DCB                     78950000
         END                                                            79200019
