VWSU     TITLE 'IEBCOPY -WRITE SETUP ROUTINE-IEBWSU'                    00100019
IEBWSU   CSECT                                                          00200019
*D905000-908000,916000-921000                                    A33288 00250021
*C933000                                                         A41780 00260021
*C536000,539000                                                  A41760 00260121
*C665000-666000,883000,888000,941000-942000                      A38720 00260221
*C665000-666000,883000,888000,941000-942000                      A38720 00260400
*A057764-057768,662100-662600,795500-795700,                     A38720 00270021
*A535500-535984,538500-538920                                    A41760 00270121
*A887500,888500,941500,942100                                    A38720 00280021
*D540000-543000                                                  A41760 00280121
*A429500-429800,651500,667500-667600,690500-690600,695500        A44345 00282121
*A697500-697600,702500                                           A44345 00284121
*C311000,319000,415000                                           A44345 00286121
*D715000                                                         A44345 00288121
*A308500-308600,312500                                           A45136 00290121
*A057104,057880,362020-362740,872500                             A45142 00292121
*D361000                                                         A45142 00294121
*A736500-737960                                                  X010XX 00294500
*D737000                                                         X010XX 00296100
*A057772,852500-852800,898500-898600,899500                      A44144 00310000
*C057780,899000                                                  A44144 00320000
*A472300-472600                                                @ZA01712 00330003
*C448270,448729                                                @ZA10902 00330199
*D448756-448783                                                @ZA10902 00330299
*A448741,448744                                                @ZA13707 00330399
*A448741,448744                                                @ZA13751 00340399
*A105500,111300,111600,202100-202600,215500,505800             @ZA26248 00340499
*C110000,202000,203000,215000,512000                           @ZA26248 00342499
*D091000,092000,189000-201000,218000-237000                    @ZA26248 00344499
*A797300-798300,849300-849600           (ORG)@XA16941,@YA19690,@ZA27766 00345499
*C798400,895000                         (ORG)@XA16941,@YA19690,@ZA27766 00346499
*A057920-057960,538630-538750           @XA20499,@YA19841,(ORG)@ZA16486 00347499
*C538600,538780                         @XA20499,@YA19841,(ORG)@ZA16486 00348499
*********************************************************************** 00350000
*TITLE-  WRITE SETUP-IEBWSU                                             00400019
*                                                                     * 00500019
*STATUS- CHANGE LEVEL 001                                             * 00600019
*                                                                     * 00700019
*FUNCTION/OPERATION- THIS MODULE PROCESSES RECORDS TO PREPARE THE     * 00800019
*       COUNT FIELDS FOR THE OUTPUT TARGET ADDRESS. RECORDS ARE       * 00900019
*       GENERALLY PROCESSED STARTING WITH THE RECORD POINTED TO BY    * 01000019
*       'WRTNEXT' AND CONTINUE THRU THE RECORD WHICH HAS THE          * 01100019
*       'ENDPROC' FLAG ON.                                            * 01200019
*                                                                     * 01300019
*ENTRY POINT- ENTERED AT IEBWSU                                       * 01400019
*                                                                     * 01500019
*INPUT- POINTER TO FIRST RECORD IN BUFFER TO PROCESS IN 'WRTNEXT'     * 01600019
*       'FORCEWRT' SWITCH SET TO MAKE IEBVWS PURGE THE BUFFERS        * 01700019
*       'USERTTR' SWITCH SET WHEN DATA SET HAS USER TTRS TO PROCESS   * 01800019
*       'NOTELST' SWITCH SET WHEN DATA SET HAS NOTE LIST TTR TO DO    * 01900019
*                                                                     * 02000019
*OUTPUT- 'READNEXT'-POINTS TO SPACE IN BUFFER AFTER LAST RECORD DONE  * 02100019
*        'NOWRT' SWITCH SET IF EOF OF PRESENT MEMBER PROCESSED BUT    * 02200019
*    BUFFER HAS ROOM FOR MORE RECORDS FROM NEXT MEMBER, IF ANY, SO    * 02300019
*    BUFFER WAS NOT WRITTEN.                                          * 02400019
*                                                                     * 02500019
*EXTERNAL ROUTINES- IEBDWR WRITE ROUTINE, SYSTEM TTR/CCHH CONVERSION  * 02600019
*        ROUTINES,IEBVMS -MESSAGE WRITER ROUTINE                        02700019
*                                                                     * 02800019
*EXITS- RETURN TO CALLER ON NORMAL COMPLETION                         * 02900019
*                                                                     * 03000019
*TABLES/WORK AREAS-                                                   * 03100019
*        -IEBMCA- COPY COMMUNICATIONS AREA                              03200019
*        -SAVERGS- REGISTER SAVE AREA                                 * 03300019
*                                                                     * 03400019
*ATTRIBUTES- SERIAL REUSABLE                                          * 03500019
*                                                                     * 03600019
         EJECT                                                          03700019
*                                                                     * 03800019
*                         SYMBOLIC REGISTERS FOR IEBWSU               * 03900019
*                                                                     * 04000019
*                                                                       04100019
GR0      EQU   0                                                        04200019
GR1      EQU   1                  DCB ADDRESS                           04300019
GR2      EQU   2                                                        04400019
GR3      EQU   3                                                        04500019
GR4      EQU   4                  COMMUNICATIONS AREA (IEBMCA) ADDRESS  04600019
GR5      EQU   5                                                        04700019
GR6      EQU   6                  TTRN ADDRESS                          04800019
GR7      EQU   7                  DEVICE CHARACTERISTIC TABLE ADDRESS   04900019
GR8      EQU   8                                                        05000019
GR9      EQU   9                                                        05100019
GR10     EQU   10                 LINKAGE POINTER FROM SUBROUTINES      05200019
GR11     EQU   11                                                       05300019
GR12     EQU   12                 BASE REGISTER                         05400019
GR13     EQU   13                                                       05500019
GR14     EQU   14                                                       05600019
GR15     EQU   15                                                       05700019
W4       EQU   4                                                        05702019
W8       EQU   8                                                        05704019
W0       EQU   0                                                        05706019
W10      EQU   10                                                       05708019
W2       EQU   2                                                        05710019
W24      EQU   24                                                A45142 05710421
W276     EQU   276                                                      05712019
XFF      EQU   X'FF'                                                    05714019
X00      EQU   X'00'                                                    05716019
W3       EQU   3                                                        05718019
W9       EQU   9                                                        05720019
W12      EQU   12                                                       05722019
W5       EQU   5                                                        05724019
W1       EQU   1                                                        05726019
MS8      EQU   8                                                        05728019
X80      EQU   X'80'                                                    05730019
SVC55    EQU   55                                                       05732019
X7F      EQU   X'7F'                                                    05734019
MS9      EQU   9                                                        05736019
W25      EQU   25                                                       05738019
W30      EQU   30                                                       05740019
W256     EQU   256                                                      05742019
MS1      EQU   1                                                        05744019
MSGCLR   EQU   C' '                                                     05746019
W120     EQU   120                                                      05748019
W7       EQU   7                                                        05750019
W29      EQU   29                                                       05752019
W40      EQU   40                                                       05754019
W27      EQU   27                                                       05756019
W68      EQU   68                                                       05758019
W76      EQU   76                                                       05760019
W85      EQU   85                                                       05762019
W13      EQU   13                                                       05764019
W98      EQU   98                                                       05766019
W28      EQU   28                                                       05768019
W99      EQU   99                                                       05770019
W93      EQU   93                                                       05772019
W51      EQU   51                                                       05774019
W17      EQU   17                                                       05776019
W53      EQU   53                                                A38720 05776421
W64      EQU   64                                                A38720 05776821
RTCD     EQU   C'4'                                              A44144 05777200
RTCDE    EQU   C'8'                                              A44144 05778000
DBOFF    EQU   4                  OFFSET IN DEVTYPE TO TRACKSIZE A45142 05788021
W6       EQU   6                                               @ZA16486 05792099
W36      EQU   36                                              @ZA16486 05796099
*                                                                       05800019
         SAVE  (14,12),,*                                               05900019
         BALR  GR12,GR0           ESTABLISH ADDRESSABILITY              06000019
*                                                                       06100019
         USING START,GR12                                               06200019
         USING IEBMCA,4                                                 06300019
         USING IHADCB,GR1                                               06400019
         USING DEVTAB,GR7                                               06500019
*                                                                       06600019
START    EQU   *                                                        06700019
         ST    GR13,SAVERGS+W4                                          06800019
         LA    GR15,SAVERGS                                             06900019
         ST    GR15,W8(GR13)      POINTER TO NEW SAVE AREA IN OLD       07000019
         LR    GR13,GR15                                                07100019
*                                                                       07200019
         TM    WSFLAG,FORCEWRT         BUFFER TO BE PURGED              07300019
         BZ    MEMBER                  NO-GO TEST FOR MEMBER FIRST      07400019
         L     GR5,LASTMREC            POINTER TO LAST RECORD IN BUFFER 07500019
         MVI   W0(GR5),LASTREC+ENDPROC SET LAST RECORD FLAGS            07600019
         B     MUSTWRTE                WRITE BUFFER                     07700019
         EJECT                                                          07800019
*                                                                       07900019
*********************************************************************** 08000019
*        MEMBER OUTPUT                                                  08100019
*********************************************************************** 08200019
*                                                                       08300019
MEMBER   EQU   *                                                        08400019
         L     GR5,READNEXT            GET FIRST INPUT ENTRY            08500019
         LA    GR5,W0(GR5)        LOP OFF HI BYTE                       08600019
         LA    GR6,OUTDS1              TTRNLL ADDRESS                   08700019
         LA    GR1,OUTDCB              DCB PTR                          08800019
         TM    TAG,TAG2                WRITING MEMBER                   08900019
         BZ    DIRTY                   NO-GO TEST DIRECTORY             09000019
         TM    FLG3,REBLK              REBLOCKING                       09300019
         BO    REBLKING                YES-XFER                         09400019
         TM    DCBRECFM,OVERFLOW       OUTPUT TRKOVERFLOW               09500019
         BO    TRKOVER                 YES-XFER TO PROCESS              09600019
*                                                                       09700019
RECYCLE1 EQU   *                                                        09800019
         LA    GR7,OUTCHAR             GET DEVICE CHARACTERISTICS       09900019
         BAL   GR10,GOTRKBAL           GO TO TRACK BALANCE              10000019
         BAL   GR10,CHKFIRST      CHECK FOR FIRST RECORD OF A    A34431 10030020
*                                  MEMBER PROCESSING             A34431 10060020
         TM    WSFLAG,USERTTR          USER TTR TO PROCESS              10100019
         BZ    NOTNOTE1                NO-XFER                          10200019
         BAL   GR10,CHKUTTRS           GO TO CHECK FOR USER TTRS        10300019
NOTNOTE1 EQU   *                                                        10400019
         BAL   GR10,CONVERT            GO CONVERT TO MBBCCHHR-OUTPUT    10500019
         ST    GR5,LASTMREC  SAVE LAST RECORD PROCESSED        @ZA26248 10550099
         BAL   GR10,RECLNVAL           GO VALIDATE RECORD LENGTH        10600019
         BAL   GR10,UPDATE             GO SEE IF MORE RECORDS           10700019
         B     RECYCLE1                YES-TRY SOME MORE                10800019
         CLC   W10(W2,GR5),ZROS   AT- EOF                               10900019
         BNE   MUSTWR      NO, MUST BE NO MORE ROOM IN BUFFER  @ZA26248 11000099
         BAL   GR10,MORERUUM           YES-GO SEE IT WE CAN READ AGAIN  11030099
MUSTWR   TM    COMDCDSW,COMPRESS       COMPRESS                @ZA26248 11060099
         BO    COMPRS                  YES-XFER                @ZA26248 11090099
MUSTWRTE EQU   *                  NO ROOM WRITE OUT                     11200019
         MVC   READNEXT(W4),WRTNEXT RESET BUFFER POINTERS               11300019
         LA    GR10,GOBACK             RETURN TO CALLER AFTER WRITING   11400019
         B     WRITEUM            GO WRITE IT                           11500019
*                                                                       11600019
*********************************************************************** 11700019
*        DIRECTORY                                                      11800019
*********************************************************************** 11900019
*                                                                       12000019
DIRTY    EQU   *                                                        12100019
         TM    TAG,TAG1                DIRECTORY OUTPUT                 12200019
         BZ    TUT3                    NO-GO TEST FOR SYSUT4            12300019
         LA    GR7,OUTCHAR             DEVICE CHARACTERISTS             12400019
RECYCLE2 EQU   *                                                        12500019
         BAL   GR10,GOTRKBAL           TRK BAL. FIRST                   12600019
         BAL   GR10,CONVERT            CONVERT IT                       12700019
         BAL   GR10,UPDATE        GO SEE IF MORE                        12800019
         B     RECYCLE2                YES- TRY AGAIN                   12900019
         CLC   W10(W2,GR5),ZROS   EOF ONLY FROM SYSUT4                  13000019
         BNE   MUSTWRTE                NO EOF FOR OUTPUT MUST WRITE IT  13100019
         C     GR5,WRTNEXT             SYSUT4 - AT START OF BUFFER      13200019
         BE    GOBACK                           YES-GO BACK TO CALLER   13300019
         LA    GR11,W276          NO- GO BACK PREVIOUS                  13400019
         SR    GR5,GR11                         RECORD                  13500019
         MVI   W0(GR5),LASTREC+ENDPROC  AND WRITE IT OUT                13600019
         B     MUSTWRTE                WRITE BUFFER                     13700019
*                                                                       13800019
*********************************************************************** 13900019
*        SYSUT3                                                         14000019
*********************************************************************** 14100019
*                                                                       14200019
TUT3     EQU   *                                                        14300019
         TM    TAG,TAG4                IS IT SYSUT3                     14400019
         BZ    TUT4                    NO-GO TEST NEXT ONE              14500019
         L     GR5,ADWK           GET PTR TO SYSUT3 RECORD              14600019
         LA    GR7,UT3CHAR             UT3-OUTPUT CHARACTERISTICS       14700019
         LA    GR6,UT3DS1                 -TTRNLL                       14800019
         LA    GR1,UT3DCB                 -DCB                          14900019
         BAL   GR10,GOTRKBAL           BALANCE IT                       15000019
         BAL   GR10,CONVERT            CONVERT IT                       15100019
         MVI   W0(GR5),LASTREC+ENDPROC INDIC NO MORE RECS IN BFRS       15200019
         LA    GR10,GOBACK             RETURN TO CALLER AFTER WRITING   15300019
         B     WRITEUM            WRITE IT                              15400019
*                                                                       15500019
*********************************************************************** 15600019
*        SYSUT4                                                         15700019
*********************************************************************** 15800019
*                                                                       15900019
TUT4     EQU   *                                                        16000019
         LA    GR7,UT4CHAR             UT4-OUTPUT CHARACTERISTICS       16100019
         LA    GR6,UT4DS1                 -TTRNLL                       16200019
         LA    GR1,UT4DCB                 -DCB                          16300019
RECYCLE3 EQU   *                                                        16400019
         BAL   GR10,GOTRKBAL           BALANCE IT                       16500019
         BAL   GR10,CONVERT       CONVERT IT                            16600019
         BAL   GR10,UPDATE             SEE IF SOME MORE                 16700019
         B     RECYCLE3                YES TRY AGAIN                    16800019
         B     MUSTWRTE                NO- MUST WRITE                   16900019
*                                                                       17000019
*********************************************************************** 17100019
*        REBLOCKED RECORDS                                            * 17200019
*********************************************************************** 17300019
*                                                                       17400019
REBLKING EQU   *                                                        17500019
         LA    GR7,OUTCHAR             FETCH DEV. CHARACT. TABLE PTR.   17600019
RECYCLE7 EQU   *                                                        17700019
         BAL   GR10,GOTRKBAL           GO TO TRACK BALANCE              17800019
         BAL   GR10,CHKFIRST      CHECK FOR FIRST RECORD OF A    A34431 17830020
*                                  MEMBER PROCESSING             A34431 17860020
         BAL   GR10,CONVERT            CONVERT TTR TO MBBCCHHR          17900019
         BAL   GR10,UPDATE             SEE IF MORE RECORDS              18000019
         B     RECYCLE7                YES-XFER                         18100019
         B     MUSTWRTE                NO- MUST WRITE                   18200019
*                                                                       18300019
*********************************************************************** 18400019
*        COMPRESS IN PLACE                                              18500019
*********************************************************************** 18600019
*                                                                       18700019
COMPRS   EQU   *                                                        18800019
*       IF COMPRESSING WRITE ALL COMPLETE TRKS AND MOVE PARTIAL@ZA26248 20200099
*       TRK TO FRONT OF THE BUFFER                             @ZA26248 20220099
         MVI   W0(GR5),X00        TURN OFF LAST RECORD IND.    @ZA26248 20240099
         L     GR5,LASTTRK           SET UP TO MOVE ALL OF THE @ZA26248 20260099
         MVI   W0(GR5),X00        PARTIAL TRK THAT MAY BE IN   @ZA26248 20280099
         BAL   GR10,UPDATE        THE BUFFER                   @ZA26248 20300099
         ST    GR5,READNEXT          SET WHERE TO MOVE FROM    @ZA26248 20320099
         L     GR5,LASTTRK   YES,FIND END OF LAST WHOLE TRACK  @ZA26248 20340099
         MVI   W0(GR5),LASTREC+ENDPROC TURN ON LAST RECORD IN BUFFER    20400019
         BAL   GR10,WRITEUM            WRITE IT OUT                     20500019
         L     GR2,READNEXT            FETCH PTR. TO NEXT RECORD        20600019
         L     GR8,EOREAD              PTR. TO END RECORDS READ         20700019
         L     GR3,BCB                 WHERE TO MOVE TO                 20800019
         LA    GR3,W0(GR3)        LOP OFF HI BYTE                       20900019
         LR    GR5,GR3                 SAVE ADDRESS FOR RECYCLE         21000019
         SR    GR8,GR2                 FIND LENGTH OF MUVE              21100019
         LR    GR11,GR8                ADD LENGTH OF MOVE TO WHERE      21200019
         AR    GR11,GR5                IT IS GOING TO BE MOVED TO       21300019
         ST    GR11,EOREAD             AND SAVE AS LOGICAL END OF BUF.  21400019
         ST    GR11,READNEXT SET WHERE TO START READING        @ZA26248 21500099
         LA    GR10,GOBACK             EXIT ADDRESS FOR MOVE   @ZA26248 21530099
         B     MOVEUM                  GO MOVE RECORDS                  21600019
*                                                                       21700019
*                                                                       23800019
*********************************************************************** 23900019
*        TRACK OVERFLOW RECORDS                                         24000019
*********************************************************************** 24100019
*                                                                       24200019
TRKOVER  EQU   *                                                        24300019
         NI    FLG1,XFF-STOPEND1  TURN OFF STOP AFTER 1ST BUFFER        24400019
         OI    WSFLAG,RETRNOVR         SET OVERFLOW FLAG                24500019
         L     GR9,BEGFST2        INITIALIZE POINTER                    24600019
         MVI   SEGKLDL+W3,X00     TURN OFF ALL INTERNAL FLAGS           24700019
         ST    GR9,WRTNEXT        WRITE FROM SECOND BUFFER              24800019
RECYCLE5 EQU   *                                                        24900019
         TM    WSFLAG,USERTTR          NOTE/LIST USER TTRS       A44345 24950021
         BZ    NOTNOTE4                NO-XFER                   A44345 24960021
         OI    WSFLAG,NTELSTRC         RECORD MAY BE NOTELIST    A44345 24962021
         BAL   GR10,CHKUTTRS           GO PROCESS NOTE/USER TTRS A44345 24970021
         NI    WSFLAG,XFF-NTELSTRC     IF NOTELIST, THEN IT'S    A44345 24972021
*                                          UPDATED               A44345 24972421
NOTNOTE4 EQU   *                                                 A44345 24980021
         LA    GR7,OUTCHAR             PT. TO DEVICE TABLE              25000019
         BAL   GR10,GOTRKBAL           GET TRK BAL.                     25100019
*                                                                       25200019
*        RETURN +0 - RECORD WILL FIT AND MAY BE A SEGMENT               25300019
*                  - LENGTH FOUND IN INPUT BUFFER                       25400019
*        RETURN +4 - RECORD WILL NOT FIT MUST MAKE SEGMENT              25500019
*                  - LENGTH IN GR0                                      25600019
         B     WILLFIT            SEE IF AT LEAST 1 SEGMENT MADE        25700019
         LR    GR8,GR0                 GET LENGTH OF SEGMENT            25800019
         TM    SEGKLDL+W3,WRTOVR  FIRST SEGMENT                         25900019
         BO    NOTFSEG                 NO-XFER                          26000019
*        FIRST SEGMENT                                                  26100019
         OI    SEGKLDL+W3,WRTOVR  SET FLAG TO INDICATE AT               26200019
*                                      LEAST ONE SEG                    26300019
         MVC   SEGTTRN(W4),OUTDS1 SAVE 1ST TTRN FOR NOTELIST PROC.      26400019
         MVC   SEGKLDL(W3),W9(GR5) SAVE INPUT KEY AND DATA LENGTHS      26500019
         MVI   W9(GR5),X00        ZERO INPUT KEY LN. FOR NEXT PASS      26600019
         MVC   WRTPROC(W4),WRTNEXT  INITIALIZE SEGMENT PTR.             26700019
         LA    GR2,W12(GR5)       UPDATE PRESENT INPUT                  26800019
         ST    GR2,READPROC       PAST FMBBCCHHRKDD FOR MOVING DATA     26900019
         L     GR3,WRTPROC                                              27000019
         ST    GR3,LASTSEG             INITIALIZE LAST SEGMENT PTR      27100019
         IC    GR9,SEGKLDL             GET ORIGINAL KEY LN.             27200019
         STC   GR9,W9(GR3)        PLACE IN FIRST SEGMENT ONLY           27300019
         B     SEGPROC                 GO PROCESS SEGMENT               27400019
*        MORE THAN ONE SEGMENT                                          27500019
NOTFSEG  EQU   *                                                        27600019
         L     GR3,WRTPROC             FETCH PTR TO NEXT SEGMENT        27700019
         MVI   W9(GR3),X00        MAKE KEY LN ZERO                      27800019
         L     GR2,READPROC            FETCH PTR TO NEXT DATA           27900019
*        CREAT SEGMENT                                                  28000019
SEGPROC  EQU   *                                                        28100019
         MVI   W0(GR3),WRTOVR     TURN ON SEG FLAG ONLY- OUTPUT         28200019
         STH   GR8,WKA1                MOVE                             28300019
         MVC   W10(W2,GR3),WKA1   DATA LENGTH TO SEGMENT                28400019
         MVC   WKA1(W2),W10(GR5)  GET INPUT LENGTH                      28500019
         LH    GR9,WKA1                ON FULL WORD BOUNDARY            28600019
         SR    GR9,GR8                 TAKE AWAY AMOUNT THAT THIS SEG   28700019
         STH   GR9,WKA1                WILL USE                         28800019
         MVC   W10(W2,GR5),WKA1   STOW BACK AS AMOUNT LEFT              28900019
*        UPDATE POINTER AND MOVE DATA TO OUTPUT BUFFER                  29000019
FINALSEG EQU   *                                                        29100019
         LR    GR5,GR3                 GET OUTPUT PTR. TO CONVERT       29200019
         LR    GR9,GR2                 SAVE INPUT DATA PTR.             29300019
         BAL   GR10,CONVERT            CONVERT SEGMENT                  29400019
         LR    GR2,GR9                 RESTORE INPUT DATA PTR.          29500019
         L     GR9,WRTNEXT             GET BEGIN OF 1ST SEGMENT         29600019
*        ALL SEGMENTS OF A RECORD MUST BE ON SAME CYL.,BIN AND EXTENT   29700019
         LA    GR15,W5            COMPARE MBBCCH FOR 2321               29720019
         CLI   OUTUCBDV,A2321          IS OUTPUT DEVICE A 2321          29740019
         BE    DONTSUB                 YES, GO AROUND                   29760019
         BCTR  GR15,GR0                COMPARE MBBCC FOR OTHER DEVICES  29780019
DONTSUB  EQU   *                                                        29800019
         EX    GR15,COMPSEGS           ALL SEGMENTS WITHIN SAME BOUNDRY 29820019
         L     GR5,READNEXT            FETCH INPUT AGAIN                29900019
         BNE   RESTART                 NO MUST START OVER-MUST BE SAME  30000019
*                                                                       30100019
         ST    GR3,LASTSEG             SAVE LAST SEG PTR.               30200019
         LA    GR3,W12(GR3)       BUMP PASS FMBBCCHHR FOR OUTPUT        30300019
         LA    GR9,W0(GR8,GR3)    PT. TO NEXT SEG.                      30400019
         ST    GR9,WRTPROC             SAVE IT FOR NEXT PASS            30500019
         L     GR9,READPROC            FETCH THIS DATA ADDRESS          30600019
         LA    GR9,W0(GR8,GR9)    ADD LENGTH OF MOVE                    30700019
         ST    GR9,READPROC            UPDATE FOR NEXT SEG.             30800019
         LTR   GR8,GR8            IS DATA LENGTH ZERO            A45136 30850021
         BZ    NULLDATA           YES, BRANCH AROUND             A45136 30860021
         BAL   GR10,MOVEUM             MOVE DATE FROM INPUT TO OUTPUT   30900019
         TM    SEGKLDL+W3,WRTOVR  ARE WE AT LAST SEG.                   31000019
         BO    NOTNOTE4                NO-XFER GETNEXT ONE       A44345 31100021
*        LAST SEGMENT-RESTORE INPUT FOR NOTE LIST AND BUFFER UPDATING   31200019
NULLDATA EQU   *                                                 A45136 31250021
         MVC   W9(W3,GR5),SEGKLDL RESTORE KEY AND DATA LENGTHS          31300019
         L     GR9,OUTDS1              YES-MUST SET                     31400019
         MVC   OUTDS1(W4),SEGTTRN TTRN TO FIRST SEGMENT ONLY            31500019
         ST    GR9,SEGTTRN             SAVE THIS ONE                    31600019
         BAL   GR10,CHKFIRST      CHECK FOR FIRST RECORD OF A    A34431 31630020
*                                  MEMBER PROCESSING             A34431 31660020
         TM    WSFLAG,USERTTR          NOTE/LIST USER TTRS              31700019
         BZ    NOTNOTE3                NO-XFER                          31800019
         BAL   GR10,CHKUTTRL           GO PROCESS NOTE/USER TTRS A44345 31900021
NOTNOTE3 EQU   *                                                        32000019
         BAL   GR10,RECLNVAL           GO VALIDATE RECORD LENGTH        32100019
         MVC   OUTDS1(W4),SEGTTRN  RESTORE TTRN                         32200019
SEGDONE  EQU   *                                                        32300019
         TM    W0(GR5),LASTREC+ENDPROC LASTRECORD PROCESSED             32400019
         BZ    RECYCLE6                NO-XFER TO UPDATE POINTERS       32500019
         MVC   WRTNEXT(W4),BEGFST2  RESET WRTNEXT FOR WRITING           32600019
         BAL   GR10,WRITEUM       GO WRITE BUFFER-FULL                  32700019
         L     GR5,BCB                 RESET                            32800019
         LA    GR5,W0(GR5)        LOP OFF HI BYTE                       32900019
         ST    GR5,READNEXT            EVERYTHING                       33000019
         ST    GR5,WRTNEXT             FOR RE-READ                      33100019
         B     GOBACK                  RETURN TO CALLER                 33200019
*                                                                       33300019
WILLFIT  EQU   *                                                        33400019
         TM    SEGKLDL+W3,WRTOVR  HAS AT LEAST 1 SEG. BEEN MADE         33500019
         BO    LASTONE                 YES-XFER THIS MUST BE LAST ONE   33600019
*        NORMAL RECORD-NO OVERFLOW                                      33700019
         MVC   WKA1(W2),W10(GR5)  GET INPUT DATA LENGTH                 33800019
         L     GR3,WRTNEXT        WRITE PTR.                            33900019
         MVC   W0(W12,GR3),W0(GR5) MOVE TO OUTPUT FMBBCCHHR             34000019
         SR    GR8,GR8                                                  34100019
         IC    GR8,W9(GR5)         GET KEY LN.                          34200019
         AH    GR8,WKA1                ADD DATA LN.                     34300019
         LA    GR2,W12(GR5)        ON BOTH INPUT AND OUTPUT             34400019
         MVC   SEGTTRN(W4),OUTDS1  SAVE 1ST TTRN FOR NOTELIST PROC.     34500019
         MVC   SEGKLDL(W3),W9(GR5) SAVE INPUT KEY AND DATA LENGTHS      34600019
         ST    GR2,READPROC            SAVE DATA PTR. FOR UPDATE        34700019
        B     FINALSEG                GO PROCESS AS SEG.                34800019
*        LAST  SEGMENT                                                  34900019
LASTONE  EQU   *                                                        35000019
         NI    SEGKLDL+W3,XFF-WRTOVR TURN OFF SEG. FLAG                 35100019
         L     GR3,WRTPROC             FETCH NEXT SEGMENT PTR           35200019
         MVC   W0(W12,GR3),W0(GR5) MOVE TO OUTPUT FMBBCCHHR             35300019
         L     GR2,READPROC            GET PTR. TO NEXT DATA            35400019
         MVC   WKA1(W2),W10(GR5)   GET LENGTH OF MOVE                   35500019
         LH    GR8,WKA1                PLACE IN REG 8 FOR MOVEUM        35600019
         B     FINALSEG                PROCESS LAST SEGMENT             35700019
RECYCLE6 EQU   *                       MORE INPUT DATA                  35800019
         L     GR5,READPROC            FETCH NEXT INPUT DATA PTR.       35900019
         ST    GR5,READNEXT            UPDATE INPUT START PTR.          36000019
         MVI   SEGKLDL+W3,X00     RESET INTERNAL CONTROL FLAG           36200019
         SR    GR2,GR2            CLEAR REGISTER                 A45142 36202021
         IC    GR2,W9(GR5)        GET KEY SIZE IF ANY            A45142 36204021
         MVC   WKA1(W2),W10(GR5)  MOVE IN DATA LENGTH            A45142 36206021
         AH    GR2,WKA1           ADD DATA LENGTH TO KEY SIZE    A45142 36208021
         LA    GR2,W24(GR2)       ALLOW FOR COUNT FIELD +FMBB    A45142 36210021
*                               AND FIDGE FACTOR FOR 1 SEGMENT   A45142 36212021
         SR    GR8,GR8                                           A45142 36214021
         L     GR7,OUTCHAR+DBOFF  GET TRACKSIZE FROM DEVTYPE AR  A45142 36216021
         LH    GR9,WKA1           GET DATA LENGTH                A45142 36218021
         DR    GR8,GR7            DIVIDE LENGTH WITH TRACKSIZE   A45142 36220021
         LA    GR7,W12            AND                            A45142 36222021
         MR    GR8,GR7            MULTIPLY QUOTIENT WITH 12      A45142 36224021
*                                 BYTES FIDGE FACTOR             A45142 36226021
         AR    GR2,GR9            AND ADD TO TOTAL SIZE          A45142 36228021
         L     GR8,WRTPROC        START OF RECORD IN BUFFER      A45142 36230021
         AR    GR8,GR2            ADD TOTAL SIZE RECORD MAY HAVE A45142 36232021
         C     GR8,END2ND2        STILL WITHIN BUFFER            A45142 36234021
         BNH   FITSINB            YES-IT WILL FIT                A45142 36236021
         L     GR3,LASTSEG        NO-WRITE BUFFER OUT            A45142 36238021
         MVI   W0(GR3),LASTREC+ENDPROC  SET LAST RECORD FLAGS    A45142 36240021
         MVC   WRTNEXT(W4),BEGFST2 RESET BUFFER POINTER          A45142 36242021
         BAL   GR10,WRITEIT       WRITE AND RETURN               A45142 36244021
         B     RECYCLE5                GO TRY NEXT RECORD        A45142 36254021
FITSINB  EQU   *                                                 A45142 36264021
         MVC   WRTNEXT(W4),WRTPROC  UPDATE OUTPUT PTR.           A45142 36274021
         B     RECYCLE5                GO TRY NEXT RECORD               36300019
RESTART  EQU   *                                                        36400019
*      DETERMINATION IS NOW MADE TO SEE IF IT IS NECCESSARY TO ERASE    36500019
*  ANY UNUSED TRACKS.  IF IT IS, IEBDWR IS CALLED TO DO THE ERASING.    36600019
*                                                                       36700019
         SPACE 1                                                        36800019
         L     GR2,LASTSEG             LOAD PTR TO LAST SEG WITHIN      36900019
*                                        BOUNDRY                        37000019
         LA    GR2,W1(GR0,GR2)    BUMP PASSED F                         37100019
         BAL   GR10,GETCCOTT           GET TTR OF LAST SEGMENT          37200019
*                                        WITHIN BOUNDRY                 37300019
         MVC   LASTERS(W4),WKA1   SAVE TTR                              37400019
         LA    GR2,W1(GR0,GR9)    GET PTR TO MBBCCHHR OF FIRST SEG      37500019
         BAL   GR10,GETCCOTT           GET TTR OF FIRST SEG             37700019
         MVC   FIRSTERS(W4),WKA1  SAVE TTR                              37800019
         CLI   FIRSTERS+W2,W1     IS FIRST SEGMENT'S R=1                37900019
         BE    ERSNEED                 YES, THIS TRACK IS FIRST         38100019
         SPACE 1                                                        38200019
         LH    GR2,FIRSTERS            LOAD TT OF TTRN OF FIRST SEG     38300019
         LA    GR2,W1(GR0,GR2)    UP TT BY ONE                          38400019
         STH   GR2,FIRSTERS            STORE BACK UPDATED TT            38500019
         SPACE 1                                                        38600019
ERSNEED  EQU   *                                                        38700019
         XR    GR2,GR2                 CLEAR WORK REG                   38800019
         STH   GR2,FIRSTERS+W2    CLEAR RN OF TTRN                      38900019
         STH   GR2,LASTERS+W2                                           39000019
         CLC   FIRSTERS(W2),LASTERS FIRST TRACK HIGHER THAN LAST        39100019
         BH    CLEARFGS                YES, NO ERASE NEEDED             39200019
         SPACE 1                                                        39300019
*   IT IS NOW NECESSARY TO CALL IEBDWR TO ERASE ALL TRACKS FROM         39400019
*  FIRSTERS TO AND INCLUDING LASTERS                                    39500019
         SPACE 1                                                        39600019
         OI    FORM,ERASE              TURN ON ERASE FLAG FOR DWR       39700019
         L     GR15,VIEBDWR            LOAD PTR TO DWR                  39800019
         BALR  GR14,GR15               GO TO DWR                        39900019
         SPACE 1                                                        40000019
         NI    FORM,XFF-ERASE     TURN OFF ERASE FLAG                   40100019
         B     CLEARFGS           GO RESET FLAGS                        40200019
         SPACE 2                                                        40300019
GETCCOTT EQU   *                                                        40400019
         L     GR15,VCCOTT             LOAD PTR TO CONVERT ROUTINE      40500019
         BALR  GR14,GR15               CONVERT TO TTR                   40600019
         BR    GR10                    RETURN                           40700019
         SPACE 2                                                        40800019
CLEARFGS EQU   *                                                        40900019
         MVI   SEGKLDL+W3,X00     TURN OFF ALL FLAGS                    41000019
         MVI   W2(GR6),X00        RESTART AT BEGIN. OF TRK              41100019
         LH    GR14,TRKCAP        RESTART WITH                          41200019
         STH   GR14,W4(GR6)       FULL TRK                              41300019
         MVC   W9(W3,GR5),SEGKLDL RESTORE KEY AND DATA LENGTHS          41400019
         B     NOTNOTE4                GO TRY THIS ONE AGAIN     A44345 41500021
*                                                                       41600019
*********************************************************************** 41700019
*                                                                     * 41800019
*                   TRACK BALANCE SUB-ROUTINE                         * 41900019
*                                                                     * 42000019
*********************************************************************** 42100019
*                                                                       42200019
*        INPUT REGISTERS                                                42300019
*              GR1 - ADDRESS OF DCB                                     42400019
*              GR5 - ADDRESS OF RECORD TO BE PROCESSED                  42500019
*              GR6 - ADDRESS OF TTRN                                    42600019
*              GR7 - ADDRESS OF DEVICE CHARACTERIST TABLE               42700019
*              GR10- RETURN ADDRESS                                     42800019
*        WORK REGISTERS                                                 42900019
*              GR2,3,8,9,11,14 AND 15                                   43000019
*                                                                       43100019
*        EXITS GR10+0 - NORMAL EXIT                                     43200019
*              GR10+4 - RECORD WILL NOT FIT ON THE CURRENT TRACK        43300019
*                     - RETURN FOR COMPRESS AND TRACK OVERFLOW          43400019
*                                                                       43500019
GOTRKBAL EQU   *                                                        43600019
         MVC   WKA1(W2),W10(GR5)  MOVE IN DATA LENGTH                   43700019
         SR    GR9,GR9                                                  43800019
         IC    GR9,W9(GR5)        PICK UP KEY LENGTH IF ANY             43900019
         LH    GR8,WKA1                DATA SIZE                        44000019
         AR    GR8,GR9                 ADD KEY LENGTH IF ANY            44100019
*                                                                     * 44200019
*   CALCULATE THE SPACE REQUIRED TO WRITE DATA AS LAST RECORD. FOR    * 44300019
* BEST DIRECT ACCESS SPEED RECORDS SHOULD BE AS BIG AS POSSIBLE,      * 44400019
* IDEALLY MAXIMUM FOR TRACK.                                          * 44500019
*                                                                       44600019
         SR    GR3,GR3                                                  44700019
         IC    GR3,OVERL               OVERHEAD FOR LAST RECORD         44800019
         TM    DEVFLAG,HALFOVER        TWO BYTE OVERHEAD FOR     S20201 44809020
*                                        THIS DEVICE             S20201 44818020
         BNO   NOTTWO             NO, USE ONE BYTE             @ZA10902 44827099
*                                        OVERHEAD                S20201 44836020
         SPACE 1                                                 S20201 44845020
         LH    GR3,OVERI               LOAD TWO BYTE OVERHEAD    S20201 44854020
*                                        (OVERHEAD LAST =        S20201 44863020
*                                         OVERHEAD NOT LAST)     S20201 44872020
NOTTWO   OC    WKA1(W2),WKA1      IS DATA LENGTH ZERO (EOF)    @ZA10902 44872999
         BNZ   NOTTWO1                 NO, GO ON                 S20201 44873820
         CLI   DEVCODE+3,X'08'    IS IT A 2314?                @ZA13751 44874199
         BE    NOTTWO1            YES,DON'T ADD ONE BYTE       @ZA13751 44874499
         SPACE 1                                                 S20201 44874720
         LA    GR8,W1(GR0,GR8)         YES, ADD 1 TO KEYLEN PLUS S20201 44879220
*                                       DATA LENGTH FOR EOF      S20201 44880120
         SPACE 1                                                 S20201 44881020
NOTTWO1  EQU   *                                                 S20201 44890020
         AR    GR3,GR8                 ADD TOTAL RECORD KEY+DATA SIZE   44900019
         SR    GR15,GR15                                                45000019
         LTR   GR9,GR9                 IS THERE A KEY                   45100019
         BNZ   AKEY                    YES                              45200019
         IC    GR15,OVERK              OVERHEAD IF A KEY                45300019
         SR    GR3,GR15                SUBTRACT KEY OVERHEAD            45400019
AKEY     EQU   *                                                        45500019
         LH    GR14,W4(GR6)       TRACK BALANCE                         45600019
         CR    GR3,GR14                WILL THIS TRK HOLD THIS RECORD   45700019
         BH    NOFIT                   NO- RECORD WILL NOT FIT ON TRACK 45800019
*                                                                       45900019
NEWBAL   EQU   *                                                        46000019
         TM    DEVFLAG,TOLFAC          TOLERANCE FACTOR TO BE ADDED     46100019
         BZ    NOTOLER            NO                                    46200019
         MH    GR8,TOLER               MULTIPLY KL+DL BY TOLERANCE      46300019
         SRL   GR8,W9             (KL+DL)*TOLERANCE/512                 46400019
*                                                                       46500019
NOTOLER  EQU   *                                                        46600019
         SR    GR11,GR11                                                46700019
         IC    GR11,OVERI              TRACK OVERHEAD NOT LAST RECORD   46800019
         TM    DEVFLAG,HALFOVER        TWO BYTE OVERHEAD FOR     S20201 46810020
*                                        THIS DEVICE             S20201 46820020
         BNO   NOTTWO2                 NO, USE ONE BYTE OVERHEAD S20201 46830020
         SPACE 1                                                 S20201 46840020
         LH    GR11,OVERI              LOAD TWO BYTE OVERHEAD    S20201 46850020
         SPACE 1                                                 S20201 46860020
NOTTWO2  EQU   *                                                 S20201 46870020
         AR    GR8,GR11                ADD KL+DL+OVERHEAD               46900019
         SR    GR8,GR15                SUBTRACT KEY OVERHEAD IF NO KEY  47000019
         SR    GR14,GR8                COMPUTE NEW TRK BALANCE          47100019
         STH   GR14,W4(GR6)       NEW TRK BALANCE- MAY BE NEGATIVE      47200019
         BNM   *+8                     GR14 NEGATIVE           @ZA01712 47230003
         OI    W4(GR6),X'80'           YES INDICATE IT         @ZA01712 47260003
         SR    GR2,GR2                                                  47300019
         IC    GR2,W2(GR6)        OBTAIN 'R' FROM TTRN                  47400019
         LA    GR2,W1(GR2)        ADD 1 TO 'R'                          47500019
         STC   GR2,W2(GR6)        STORE BACK UPDATED 'R'                47600019
         BR    GR10               RETURN TO CALLER + 0                  47700019
*                                                                       47800019
NOFIT    EQU   *                                                        47900019
         TM    TAG,TAG1           DIRECTORY OUTPUT               A36049 47909000
         BZ    NOPRBLM            NO, GO ON                      A36049 47918000
         CLC   W2(W1,GR6),NDBTR   WAS LAST 'R' FROM TTRN LOWER   A36049 47927000
*                                 THAN CURRENT MAX NUMBER OF     A36049 47936000
*                                 BLOCKS PER TRACK               A36049 47945000
         BNL   NOPRBLM            N0, G0 0N                      A36049 47954000
         OI    FLG4,REDASD        YES, INDIC WRITING OF WARNING  A36049 47963000
*                                 MSG                            A36049 47972000
         B     NEWBAL             RECORD WILL STILL FIT          A36049 47981000
NOPRBLM  EQU   *                                                 A36049 47990000
         TM    WSFLAG,RETRNOVR         OVERFLOW RECORDS-OUTPUT          48000019
         BZ    NOOVERFL                NO-NORMAL RECORD                 48100019
         CLC   W10(W2,GR5),ZROS   EOF                                   48200019
         BE    NEXTTRK                 YES-XFER                         48300019
         SR    GR3,GR8                 FETCH OVERHEAD IF ANY            48400019
         LR    GR0,GR14           SAVE TRL. BAL.                        48500019
         LA    GR2,W1(GR3,GR9)    ADD KL.+1                             48600019
         SR    GR14,GR2           WILL IT FIT                           48700019
         BNP   NEXTTRK                 NO-IF 0 OR -                     48800019
         SR    GR0,GR3            FIND ACTUAL LENGTH THAT WILL          48900019
         SR    GR14,GR14          ZERO AS TRK BAL LEFT                  49000019
         LA    GR10,W4(GR10)      RETURN TO CALLER+4                    49100019
         B     NEWBAL                  AFTER CALCULATING NEW BAL        49200019
NEXTTRK  EQU   *                                                        49300019
         LH    GR14,TRKCAP             FETCH TOTAL TRK LENGTH           49400019
         STH   GR14,W4(GR6)       STOW FOR TRK BAL                      49500019
         LH    GR2,W0(GR6)        GET TT                                49600019
         LA    GR2,W1(GR2)        TT+1                                  49700019
         STH   GR2,W0(GR6)        STOW BACK                             49800019
         MVI   W2(GR6),X00        MAKE R ZERO                           49900019
         B     GOTRKBAL                MAY OR MAY NOT FIT -RETRY        50000019
NOOVERFL EQU   *                                                        50100019
         LH    GR2,W0(GR6)        OBTAIN TT                             50200019
         LA    GR2,W1(GR2)        ADD 1 TO TT                           50300019
         STH   GR2,W0(GR6)        STOW TT+1                             50400019
         MVI   W2(GR6),X00        MAKE R ZERO                           50500019
         LH    GR14,TRKCAP             GET NEW TRK BALANCE              50600019
         TM    TAG,TAG2      WRITING MEMBER DATA                 A36074 50630020
         BZ    NEWBAL        NO, CALC. NEW TRACK BALANCE         A36074 50660020
         TM    COMDCDSW,COMPRESS  IS COMPRESS BEING DONE                50700019
         BZ    NEWBAL                  NO-CALCULATE NEW TRK BAL.        50800019
         MVC   LASTTRK(W4),LASTMREC SAVE LAST RECORD ADDRESS   @ZA26248 50850099
         TM    TAG,TAG8                FIRST TIME AFTER MCM-1ST RECORD  50880099
         BO    NEWBAL                  YES-PROCESS AS NEW RECORD        50910099
         STH   GR14,W4(GR6)       STORE TRK CAPACITY FOR NEXT RECORD    50940099
         B     NEWBAL        GO PROCESS RECORD ON NEXT TRACK   @ZA26248 50970099
*                                                                       51300019
*********************************************************************** 51400019
*                                                                     * 51500019
*                   CONVERT SUB-ROUTINE                               * 51600019
*                                                                     * 51700019
*********************************************************************** 51800019
*                                                                       51900019
*        INPUT  REGISTERS                                               52000019
*              GR1 - ADDRESS OF DCB                                     52100019
*              GR6 - ADDRESS OF TTRN                                    52200019
*              GR10- RETURN ADDRESS                                     52300019
*        WORK REGISTERS                                                 52400019
*              GR0,2,14,15                                              52500019
*                                                                       52600019
CONVERT  EQU   *                                                        52700019
         L     GR0,W0(GR6)        FETCH TTRN                            52800019
         LA    GR2,W1(GR5)        ADDRESS OF MBBCCHHR IN BUFFER         52900019
         L     GR15,VTTOCC             ADDRESS OF CONVERSION ROUTINE    53000019
         BALR  GR14,GR15               CONVERT TTRN FROM R0 INTO (GR2)  53100019
         LTR   GR15,GR15               EOF EXTENTS                      53200019
         BCR   MS8,GR10           BRANCH NOT END YET                    53300019
         LR    GR2,GR1                 SAVE DCB ADDRESS - EOV           53400019
         OI    DCBOFLGS,X80       TURN ON WRITING FLAG                  53500019
         TM    TAG,TAG2           WRITING MEMBER DATA            A41760 53550021
         BZ    CALLEOV            NO                             A41760 53560021
         MVC   WKA1(W8),DCBFDAD   SAVE DCB FULL DISK ADDRESS     A41760 53570021
         MVC   WKA1+W8(W2),DCBTRBAL   SAVE DCB TRACK BALANCE     A41760 53580021
         MVC   WKA1+W10(W4),DCBRELAD  SAVE LAST REC TTRN         A41760 53592021
         MVC   DCBFDAD(W8),ERPLMFD  POINT TO PREVIOUS VALID EOF  A41760 53594021
*             WHEN DIRECTORY LAST TIME WAS WRITTEN TO OUTPUT DS  A41760 53596021
         MVC   DCBTRBAL(W2),ERPTB SET PREVIOUS VALID TR BALANCE  A41760 53598021
         MVC   DCBRELAD(W4),ERPTTR  SET PREVIOUS VALID LAST REC  A41760 53598421
CALLEOV  SVC   SVC55              CALL EOV                       A41760 53600021
         LR    GR1,GR2                 RETURN DCB ADDRESS - EOV         53700019
         NI    DCBOFLGS,X7F       TURN OFF WRITING FLAG                 53800019
         TM    TAG,TAG2           WRITING MEMBER DATA            A41760 53850021
         BO    RESTORE            RETRY CONVERSION             @ZA16486 53860099
         TM    TAG,TAG3           WRITING OUT DIR ON SYSUT4?   @ZA16486 53863099
         BZ    CONVERT            NO,RETRY CONVERSION          @ZA16486 53866099
         L     GR2,DCBDEBAD       PICK UP DEB ADDRESS          @ZA16486 53869099
         MVC   UT4FDAD+1(W6),W36(GR2) REINIT EXTENT START      @ZA16486 53872099
         B     CONVERT            RETRY CONVERSION             @ZA16486 53875099
RESTORE  MVC   DCBFDAD(W8),WKA1   RESTORE DCB FULL DISK ADDR   @ZA16486 53878099
         MVC   DCBTRBAL(W2),WKA1+W8   RESTORE DCB TRACK BALANCE  A41760 53890021
         MVC   DCBRELAD(W4),WKA1+W10  RESTORE LAST REC TTRN      A41760 53892021
         B     CONVERT            RETRY CONVERSION                      53900021
*                                                                       54000019
*********************************************************************** 54100019
*                                                                     * 54200019
*                  RECORD CONTROL SUB-ROUTINE                         * 54300019
*                                                                     * 54400019
*********************************************************************** 54500019
*                                                                       54600019
*        INPUT REGISTERS                                                54700019
*              GR5 - ADDRESS OF RECORD TO BE PROCESSED                  54800019
*              GR10- RETURN ADDRESS                                     54900019
*        EXITS GR10+0 - MORE RECORDS TO PROCESS                         55000019
*              GR10+4 - NO MORE RECORDS TO PROCESS                      55100019
*        WORK REGISTERS  GR11                                           55200019
*                                                                       55300019
UPDATE   EQU   *                                                        55400019
         TM    W0(GR5),ENDPROC+LASTREC LAST RECORD FLAG ON              55500019
         BZ    UPRECPTR           MORE RECORDS IN THIS BUFFER           55600019
         BO    W4(GR10)           LAST RECORD IN LAST BUFFER            55700019
         L     GR5,BEGFST2             START OF SECOND BUFFER           55800019
         OI    FLG1,IN2ND         SET TO INDICATE IN LAST BUFFER        55900019
         BR    GR10                    HANDLE NEXT RECORD               56000019
UPRECPTR EQU   *                                                        56100019
         SR    GR11,GR11                                                56200019
         IC    GR11,W9(GR5)       GET KEY LENGTH                        56300019
         MVC   WKA1(W2),W10(GR5)  DATA LENGTH- NO ADDRESSING PROBLEM    56400019
         AH    GR11,WKA1               ADD KEY + DATA LENGTH            56500019
         LA    GR11,W12(GR11)     +FMBB +COUNT                          56600019
         AR    GR5,GR11                FIND START OF NEXT RECORD        56700019
         BR    GR10               ANALYZE NEXT RECORD                   56800019
*                                                                       56900019
*********************************************************************** 57000019
*                                                                     * 57100019
*                  END OF FILE SUB-ROUTINE                            * 57200019
*                                                                     * 57300019
*********************************************************************** 57400019
*        INPUT REGISTERS                                                57500019
*              GR1 - ADDRESS OF DCB                                     57600019
*              GR5 - ADDRESS OF RECORD TO BE PROCESSED                  57700019
*              GR10- RETURN ADDRESS                                     57800019
*        EXITS GR10+0 - IF NO MORE ROOM IN THE BUFFER TO READ           57900019
*              RETURN TO CALLER - IF THERE IS MORE ROOM TO READ         58000019
*        WORK REGISTERS                                                 58100019
*              GR6,7,9,AND 11                                           58200019
*                                                                       58300019
MORERUUM EQU   *                                                        58400019
         SR    GR11,GR11                                                58500019
         IC    GR11,W9(GR5)       GET EOF KEY SIZE IF ANY               58600019
         SR    GR7,GR7                                                  58700019
         IC    GR7,DCBKEYLE            GET KEY LENGTH OF RECORDS        58800019
         LA    GR6,W12(GR5)       GET ADDRESS COUNT FIELD + FMBB        58900019
         AR    GR6,GR11                ADD KEY TO LOCATE END OF EOF     59000019
         AH    GR7,IBLKSIZE            MAX. BLOCKSIZE + KEY LN          59100019
         LA    GR7,W12(GR7)       ALLOW FOR COUNT FIELD + FMBB          59200000
         TM    ULLDST,LOAD             IS A LOAD BEING DONE      X010XX 59250000
         BNO   WSU07010                NO, GO AROUND             X010XX 59260000
         LR    GR9,GR1                 SAVE OUTPUT DCB POINTER   X010XX 59270000
         LA    GR1,LOADDCB             LOAD POINTER TO LOAD DCB  X010XX 59280000
         LH    GR11,DCBBLKSI           OBTAIN LOAD DCB BLKSIZE   X010XX 59290000
         LA    GR1,W8                  LOAD OVERLAP READ LENGTH  X010XX 59292000
         SR    GR11,GR1                SUBTRACT OVERLAP LENGTH   X010XX 59294000
*                                         FROM LOAD DCB BLKSIZE  X010XX 59296000
         CR    GR11,GR7                IS THE LOAD DCB BLKSIZE - X010XX 59298000
*                                         OVERLAP LENGTH LARGER  X010XX 59298400
*                                         THAN MAXIMUM DIRECT    X010XX 59298800
*                                         ACCESS RECORD LENGTH   X010XX 59299200
         BNH   WSU07000                NO, GO AROUND             X010XX 59299600
         LR    GR7,GR11                SET MAXIMUM RECORD LENGTH X010XX 59299700
*                                         TO LOAD DCB BLKSIZE -  X010XX 59299800
*                                         OVERLAP LENGTH         X010XX 59299900
WSU07000 EQU   *                       RESTORE DCB POINTER       X010XX 59333200
         LR    GR1,GR9                 RESTORE POINTER TO OUTPUT X010XX 59343200
*                                         DCB                    X010XX 59353200
WSU07010 EQU   *                       FIND                      X010XX 59363200
         AR    GR7,GR6                 END OF MAXIMUM NEXT RECORD       59366700
         L     GR9,END2ND2             END OF SECOND (LOWER) BUFFER     59400019
         TM    FLG1,P2FLG1+IN2ND       IN LAST BUFFER OF 2 OR ONLY 1    59500019
         BC    MS9,GOTLIMIT       YES                                   59600019
         LA    GR10,GONEXTBF           IF NO ROOM GO TO NEXT BUFFER     59700019
         L     GR9,ENDFST1             END OF FIRST BUFFER              59800019
GOTLIMIT EQU   *                       TEST IF OUT OF BUFFER            59900019
         CR    GR7,GR9                 WILL NEXT RECORD EXCEED BUFFER   60000019
         BNH   DONOWRTS                NO- CAN READ MORE INTO BUFFER    60100019
         BR    GR10                    EITHER RETURN OR GET NEXT ONE    60200019
GONEXTBF EQU   *                                                        60300019
         MVI   W0(GR5),LASTREC    SET ONLY LASTREC IN BUFFER FLAG       60400019
         L     GR6,BEGFST2             SET AT START OF SECOND BUFFER    60500019
         OI    FLG1,IN2ND              SET FLAG TO SHOW IN LAST BUFFER  60600019
         B     SETNOWRT                SET THAT HAVE NOT WRITTEN        60700019
DONOWRTS EQU   *                                                        60800019
         MVI   W0(GR5),X00        RESET ENDPROC,LASTREC FLAGS           60900019
SETNOWRT EQU   *                                                        61000019
         OI    WSFLAG,NOWRT            SET FLAG EOF IN BUFFER MORE ROOM 61100019
         ST    GR5,LASTMREC            SAVE POINTER TO LAST RECORD      61200019
         ST    GR6,READNEXT            START OF NEXT RECORD             61300019
         B     GOBACK                  RETURN                           61400019
*                                                                       61500019
*                                                                       61600019
*********************************************************************** 61700019
*                                                                     * 61800019
*                   NOTE LIST/USER TTR SUB-ROUTINE                    * 61900019
*                                                                     * 62000019
*********************************************************************** 62100019
*                                                                       62200019
*********************************************************************** 62300019
*                                                                     * 62400019
*     IF USER TTR'S ARE PRESENT IN ANY MEMBER, THIS SECTION OF CODE   * 62500019
*   WILL BE EXECUTED.  THIS SECTION CONSISTS OF AN INNER LOOP TO      * 62600019
*   PROCESS NOTELISTS AND AN OUTTER LOOP TO PROCESS USER TTR'S.       * 62700019
*   EACH INPUT RECORD'S TTR IS CHECKED AGAINST EACH USER AND NOTELIST * 62800019
*   TTR AND UPDATED AND FLAGGED WHEN FOUND.  FLAGGING IS DONE SO THAT * 62900019
*   ONCE A TTR IS UPDATED IT IS NOT CHECKED FOR AGAIN.  FLAGS         * 63000019
*   INDICATING THAT USER TTR'S HAVE BEEN UPDATED ARE IN THE           * 63100019
*   COMMUNICATION AREA.  NOTELIST TTRX'S ARE FLAGGED IN THE HIGH      * 63200019
*   ORDER BIT OF THE FIELD.  NOTELIST TTR FLAGS ARE CLEARED BEFORE    * 63300019
*   WRITING THE NOTELIST TO THE OUTPUT DATA SET.                      * 63400019
*                                                                     * 63500019
* *** NOTE THAT IF THE HIGH ORDER BIT OF THE TTRX FIELD IS USED,      * 63600019
*   THE TTR WILL NOT BE UPDATED AND THE HIGH ORDER BIT WILL BE SET    * 63700019
*   TO ZERO AT THE END OF PROCESSING.                                 * 63800019
*                                                                     * 63900019
*********************************************************************** 64000019
*                                                                       64100019
CHKUTTRS EQU   *                                                        64200019
         LR    GR0,GR1            SAVE ''OUTPUT'' DCB PTR.              64300019
         LA    GR1,INDCB               POINTER TO INPUT DCB             64400019
         LR    GR2,GR5                 POINTER TO FMBBCCHHR IN BUFFER   64500019
         LA    GR2,W1(GR0,GR2)    BUMP PASSED F                         64600019
         L     GR15,VCCOTT             ADDRESS OF CONVERSION RTN        64700019
         BALR  GR14,GR15               GET INPUT TTR                    64800019
         LR    GR1,GR0            RETURN ''OUTPUT''                     64900019
         SPACE                                                          65000019
         MVC   SAVETTR0(W3),WKA1  MOVE TTR FOR TEST                     65100019
CHKUTTRL EQU   *                                                 A44345 65150021
         NI    UTTRFLAG,XFF-NOTELIST TURN OFF NOTELIST PTR FOUND FLAG   65200019
         L     GR7,IDEAD               DIRECTORY ENTRY POINTER          65300019
         IC    GR3,TTRNUMB(GR0,GR7) NUMBER OF USER TTR'S                65400019
         SLL   GR3,W25            GET NUMBER OF USER TTR'S AS A         65500019
         SRL   GR3,W30            FULL REGISTER BINARY VALUE            65600019
*                                      (STRIP OFF ALIAS AND NUMBER      65700019
*                                         OF HALF WORDS OF USER DATA)   65800019
         LA    GR7,TTRDIRC(GR0,GR7) START OF USER TTR FIELD             65900019
OUTLOOP  EQU   *                                                        66000019
         CLI   W3(GR7),X00        IS THIS TTRN A NOTELIST POINTER       66100019
         BE    CARRYON                 NO, BRANCH AROUND                66200019
         L     GR2,AMSG           LOAD PTR TO MSG CSECT          A38720 66210021
         USING IEBWSUMG,GR2       ADDRESSABILITY TO MSG CSECT    A38720 66220021
         LA    GR8,MSGNO176       LOAD PTR TO MSG                A38720 66250021
         DROP  GR2                                               A38720 66260021
         TM    UTTRFLAG,NOTELIST       WAS A PREVIOUS TTRN A NOTELIST   66300019
*                                         POINTER                       66400019
         BO    GIVEMSG                 ERROR, MORE THAN ONE      A38720 66500021
*                                NOTELIST POINTER IS ILLEGAL     A38720 66600021
         OI    UTTRFLAG,NOTELIST       SET NOTELIST PTR FOUND SWITCH    66700019
         TM    WSFLAG,NTELSTRC    CHECKING FOR NOTELIST RECORD   A44345 66750021
         BO    FORNOTE            YES, BRANCH AROUND             A44345 66760021
         XR    GR8,GR8                 CLEAR REGISTER                   66800019
         L     GR9,ADNL                POINTER TO NOTELIST              66900019
         IC    GR8,W9(GR0,GR9)    LOAD KEY LENGTH                       67000019
         AR    GR9,GR8                 BUMP NOTELIST POINTER BY KEY     67100019
         LA    GR9,W12(GR0,GR9)   LENGTH+FMBB+COUNT FIELD               67200019
         TM    INDCB+RECFM,FIXREC IS INPUT FIXED OR UNDEFINED           67300019
         BO    GETNUMB            YES - GO AROUND                       67400019
         LA    GR9,W8(GR0,GR9)    BUMP PAST BIG AND LITTLE              67500019
*                                         LL FIELDS PLUS 2 RESERVED     67600019
*                                         BYTES                         67700019
GETNUMB  EQU   *                                                        67800019
         IC    GR8,W3(GR0,GR7)    INSERT NUMBER OF NOTELIST TTRX'S      67900019
INNRLOOP EQU   *                                                        68000019
         TM    W0(GR9),REPFLAG    HAS THIS TTR BEEN UPDATED             68100019
         BO    NOTEDECR                YES, GO ON                       68200019
         CLC   W0(W3,GR9),SAVETTR0  ARE TTR'S EQUAL                     68300019
         BNE   NOTEDECR                NO, GO ON                        68400019
         MVC   W0(W3,GR9),OUTDS1  PUT IN OUTPUT TTR                     68500019
         OI    W0(GR9),REPFLAG    SET REPLACED FLAG                     68600019
NOTEDECR EQU   *                                                        68700019
         LA    GR9,W4(GR0,GR9)    INCREMENT TO NEXT TTRX                68800019
         BCT   GR8,INNRLOOP            LOOP TILL DONE                   68900019
CARRYON  EQU   *                                                        69000019
         TM    WSFLAG,NTELSTRC    CHECKING FOR NOTELIST RECORD   A44345 69050021
         BO    USERDECR           YES, BRANCH TO OUTER LOOP      A44345 69060021
         STC   GR3,CONMASK             STORE FOR CONVERSION             69100019
         TR    CONMASK(W1),BITSWAP TRANSLATE INTO A MASK                69200019
         IC    GR8,CONMASK             LOAD MASK                        69300019
         EX    GR8,TESTREP             HAS THIS TTR BEEN UPDATED        69400019
         BO    USERDECR                YES, GO TO END OF OUTTER LOOP    69500019
FORNOTE  EQU   *                                                 A44345 69550021
         CLC   W0(W3,GR7),SAVETTR0  ARE TTR'S EQUAL                     69600019
         BNE   USERDECR                NO, GO TO END OF OUTTER LOOP     69700019
         TM    WSFLAG,NTELSTRC    CHECKING FOR NOTELIST RECORD   A44345 69750021
         BO    NOTEUPDT           YES, BRANCH TO MOVE NOTELIST   A44345 69760021
         MVC   W0(W3,GR7),OUTDS1  PUT IN OUTPUT TTR                     69800019
         OC    UTTRFLAG(W1),CONMASK SET REPLACED FLAG                   69900019
         CLI   W3(GR7),X00        HAVE I JUST UPDATED A NOTELIST        70000019
*                                        POINTER TTR                    70100019
         BE    USERDECR                NO, GO ON                        70200019
NOTEUPDT EQU   *                                                 A44345 70250021
         ST    GR10,RETSAVE            SAVE REGISTERS                   70300019
         ST    GR3,RETSAVE+W4                                           70400019
         ST    GR7,RETSAVE+W8                                           70500019
         BAL   GR10,NOTENOW            RESET FLAGS AND MOVE NOTELIST    70600019
*                                        TO BUFFER                      70700019
         L     GR10,RETSAVE            RESTORE REGISTERS                70800019
         L     GR3,RETSAVE+W4                                           70900019
         L     GR7,RETSAVE+W8                                           71000019
USERDECR EQU   *                                                        71100019
         LA    GR7,W4(GR0,GR7)    INCREMENT TO NEXT TTRN                71200019
         BCT   GR3,OUTLOOP             LOOP TILL DONE                   71300019
         BR    GR10                    GET NEXT RECORD                  71400019
*                                                                     * 71600019
*    CLEAR FLAGS IN NOTELIST TTRX'S IN WORKAREA AND MOVE TO BUFFER    * 71700019
*                                                                     * 71800019
NOTENOW  EQU   *                                                        71900019
         XR    GR8,GR8                 CLEAR REGISTER                   72000019
         L     GR9,ADNL                POINTER TO NOTELIST              72100019
         IC    GR8,W9(GR0,GR9)    LOAD KEY LENGTH                       72200019
         AR    GR9,GR8                 BUMP NOTELIST POINTER BY KEY     72300019
         LA    GR9,W12(GR0,GR9)   LENGTH+FMBB+COUNT FIELD               72400019
         TM    INDCB+RECFM,FIXREC      IS RECFM FIEXD OR UNDEFINED      72500019
         BO    NUMBGET                 YES, GO AROUND                   72600019
         LA    GR9,W8(GR0,GR9)    BUMP POINTER PASSED LL FIELDS         72700019
NUMBGET  EQU   *                                                        72800019
         IC    GR8,W3(GR0,GR7)    INSERT NUMBER OF NOTELIST TTRX'S      72900019
CLEARFLG EQU   *                                                        73000019
         NI    W0(GR9),XFF-REPFLAG CLEAR FLAGS                          73100019
         LA    GR9,W4(GR0,GR9)    BUMP TO NEXT TTRX                     73200019
         BCT   GR8,CLEARFLG            CONTINUE CLEARING                73300019
         L     GR2,ADNL                POINTER TO NOTELIST RECORD       73400019
         LA    GR2,W12(GR0,GR2)   SPACE OVER NOTELIST COUNT+FMBB        73500019
         LA    GR3,W12(GR5)       START OF NOTELIST IN OUTPUT AREA      73600019
         IC    GR8,W3(GR0,GR7)    INSERT NUMBER OF NOTELIST      X010XX 73650000
*                                      TTRX'S                    X010XX 73700000
         SLL   GR8,W2             AND MULTIPLY BY 4              X010XX 73750000
         TM    INDCB+RECFM,FIXREC IS INPUT PDS RECFM FIXED OR    X010XX 73760000
*                                      UNDEFINED                 X010XX 73770000
         BO    WSU08000           YES, GO AROUND                 X010XX 73780000
         LA    GR8,W8(GR0,GR8)    ADD LENGTH OF BIG AND LITTLE   X010XX 73790000
*                                      LL FIELDS                 X010XX 73792000
WSU08000 EQU   *                                                 X010XX 73794000
         STH   GR8,WKA1           SAVE NOTELIST DATA SIZE        X010XX 73796000
         SR    GR8,GR8                                                  73800019
         IC    GR8,W9(GR5)        NOTELIST MIGHT JUST HAVE A KEY        73900019
         AH    GR8,WKA1                TOTAL SIZE OF NOTELIST           74000019
*                                                                       74100019
*********************************************************************** 74200019
*                                                                     * 74300019
*                   MOVE SUB-ROUTINE                                  * 74400019
*                                                                     * 74500019
*********************************************************************** 74600019
*                                                                       74700019
*        INPUT REGISTERS                                                74800019
*              GR2 -ADDRESS OF WHERE TO MOVE FROM                       74900019
*              GR3 -ADDRESS OF WHERE TO MOVE TO                         75000019
*              GR8 -LENGTH OF MOVE                                      75100019
*        EXIT  GR10+0                                                   75200019
*        WORK REGISTERS                                                 75300019
*              GR9 AND 11                                               75400019
*                                                                       75500019
MOVEUM   EQU   *                                                        75600019
         LR    GR9,GR8                 SAVE TOTAL SIZE                  75700019
         SRL   GR8,W8             DIVIDE BY 256                         75800019
         LTR   GR8,GR8                                                  75900019
         BC    MS8,MOVE1          LESS THAN 256 BYTES DO IN 1 MOVE      76000019
         LA    GR11,W256          MOVE CONSTANT                         76100019
MOVE256  EQU   *                                                        76200019
         MVC   W0(W256,GR3),W0(GR2)  MOVE 256 BYTES                     76300019
         LA    GR2,W256(GR2)                                            76400019
         LA    GR3,W256(GR3)      UP TO AND FROM POINTERS               76500019
         SR    GR9,GR11                AMT. REMAINING TO MUVE           76600019
         BCT   GR8,MOVE256             MORE 256 BYTE BLOCKS TO MOVE     76700019
         LTR   GR9,GR9                 CAME OUT EVEN-NO MORE            76800019
         BCR   MS8,GR10           YES- NONE LEFT TO MOVE- EXIT          76900019
MOVE1    EQU   *                                                        77000019
         BCTR  GR9,GR0            DECREMENT FOR EXECUTE                 77100019
         EX    GR9,MOVENOTE       MOVE LAST ONES                        77200019
         BR    GR10                    EXIT LOOP                        77300019
*                                                                       77400019
*********************************************************************** 77500019
*                                                                     * 77600019
*                   RECORD LENGTH VALIDATION SUB-ROUTINE              * 77700019
*                                                                     * 77800019
*********************************************************************** 77900019
*                                                                       78000019
*        INPUT REGISTERS                                                78100019
*              GR1 - ADDRESS OF OUTPUT DCB                              78200019
*              GR5 - ADDRESS OF RECORD TO BE PROCESSED                  78300019
*              GR6 - ADDRESS OF TTRN                                    78400019
*              GR10- RETURN ADDRESS                                     78500019
*        WORK  REGISTRES                                                78600019
*              GR2,3,8,9,11,14,AND 15                                   78700019
*        EXITS GR10+0                                                   78800019
*                                                                       78900019
*                                                                       79000019
RECLNVAL EQU   *                                                        79100019
         L     GR2,AMSG                LOAD PTR TO MSG CSECT            79200019
         USING IEBWSUMG,GR2            ADDRESSABILITY TO MSG CSECT      79300019
         TM    SENSE,SENSE5            PREVIOUS RECORD A SHORT 1        79400019
         BO    FXBLKSTD                YES-XFER TO TEST IF THIS IS EOF  79500019
         LA    GR8,MSGNO188            LOAD PTR TO MSG           A38720 79550021
         CLC   W10(W2,GR5),IBLKSIZE    INPUT VS. INPUT BLOCKSIZE A38720 79560021
         BH    GIVEMSG                 XFER-IF INPUT REC HI      A38720 79570021
         LR    GR11,GR6                GET OUTPUT TTRN PTR.             79600019
         LA    GR8,MSGNO175            LOAD PTR TO LONG MSG             79700019
         LA    GR7,OUTCHAR        DEVICE CHARACTERISTICS       @ZA27766 79730099
         CLC   W10(W2,GR5),TRKCAP RECORD EXCEED TRACK CAPACITY @ZA27766 79800099
         BNH   VSBLKSZ            NO,GO TEST AGAINST BLKSIZE   @ZA27766 79810099
         OI    VTMFLG1,UNUSEND    YES,SET ERROR FLAG           @ZA27766 79820099
         B     CONSTMSG           GO AND GIVE MSG IEB175I      @ZA27766 79830099
VSBLKSZ  CLC   W10(W2,GR5),OBLKSIZE INPUT VS. OUTPUT BLOCKSIZE @ZA27766 79840099
         BH    CONSTMSG                XFER-IF INPUT HI                 79900019
         BCR   MS8,GR10           RTN. TO CALLER IF EQUAL               80000019
         CLC   W10(W2,GR5),ZROS   IS THIS AN EOF RECORD (DATA LEN = O)  80100019
         BCR   MS8,GR10           YES-RTN TO CALLER                     80200019
         TM    DCBRECFM,VARUNDF        UNDEFINED OR VARIABLE LN. REC.   80300019
         BCR   MS1,GR10           YES-RTN TO CALLER                     80400019
         LA    GR8,MSGNO174            LOAD PTR TO SHORT MSG            80500019
         TM    DCBRECFM,FIXBLKS        FIXED BLOCK STANDARD             80600019
         BZ    CONSTMSG                IF FIXED                         80700019
         BM    FIXBLK                  IF FIXED BLOCK                   80800019
         ST    GR6,WARNTTRN            SAVE THIS TTRN FOR NEXT PASS     80900019
         OI    SENSE,SENSE5            FBS-SET SHORT REC. FLAG          81000019
FIXBLK   EQU   *                                                        81200019
         CLC   W10(W2,GR5),OUTLRECL INPUT LN. VS OUTPUT LRECL           81300019
         BL    CONSTMSG                LESS THAN LRECL                  81400019
         BCR   MS8,GR10           EQ- RTN. TO CALLER                    81500019
         MVC   WKA1(W2),W10(GR5)  GET DATA LN OF RECORD                 81600019
         SR    GR2,GR2                                                  81700019
         LH    GR3,WKA1                                                 81800019
         LH    GR9,OUTLRECL            FETCH OUTPUT LRECL               81900019
         DR    GR2,GR9                 IS INPUT AN                      82000019
         LTR   GR2,GR2                 INTERGRAL OF LRECL               82100019
         BCR   MS8,GR10           YES-RTN. TO CALLER                    82200019
CONSTMSG EQU   *                                                        82300019
         L     GR2,AMSG                LOAD PTR TO MSG CSECT            82400019
         MVI   MSGBUF,MSGCLR                                            82500019
         MVC   MSGBUF+W1(W120),MSGBUF  CLEAR MESSAGE BUFFER             82600019
         MVC   MSGBUF+W1(W7),W0(GR8)  FETCH MSG. NO.                    82700019
         MVC   MSGBUF+W10(W29),WARNINRC STANDARD HEADER                 82800019
         MVC   MSGBUF+W40(W27),W7(GR8)  SHORT OR GREATER MSG            82900019
         MVC   MSGBUF+W68(W8),NAMEMSG  DDNAME MSG HEADER                83000019
         L     GR9,NXTINDS             FETCH POINTER TO CURRENT INDD    83100019
         MVC   MSGBUF+W76(W8),W2(GR9)  DDNAME TO MSG                    83200019
         MVC   MSGBUF+W85(W13),TTRNMSG TTRN HEADER                      83300019
         SR    GR2,GR2                 INITIALIZE                       83400019
         SR    GR3,GR3                 WORK REGISTERS                   83500019
         SR    GR14,GR14               FOR CONVERSION OF TTRN TO        83600019
         SR    GR15,GR15               PRINTABLE HEX.                   83700019
         LA    GR9,W4             NO. OF BYTES TO CONVERT               83800019
CONVHEX  EQU   *                                                        83900019
         IC    GR2,W0(GR11,GR15)  FETCH FIRST CHARACTER                 84000019
         SRDL  GR2,W4             SAVE BOTH INTEGERS                    84100019
         IC    GR2,NUM(GR2)            FETCH HEX EQUIVALENT FOR 1ST NO. 84200019
         STC   GR2,MSGBUF+W98(GR14) STOW IN MSG                         84300019
         SRL   GR3,W28            FIND SECOND HALF                      84400019
         IC    GR3,NUM(GR3)            FETCH HEX EQU.                   84500019
         STC   GR3,MSGBUF+W99(GR14) STOW IN NEXT SLOT IN MSG            84600019
         LA    GR15,W1(GR15)      UPDATE INDEX TO NO. TO CONVERT        84700019
         LA    GR14,W2(GR14)      INDEX TO PLACE IN MSG                 84800019
         BCT   GR9,CONVHEX        LOOP UNTIL ALL CONVERTED              84900019
         TM    VTMFLG1,UNUSEND    IS IT REC'S LONGER THATN TRK @ZA27766 84930099
         BO    MSGTERM1           YES,TERMINATE AFTER MSG      @ZA27766 84960099
         MVI   MSG1,IOERF+LASTMSG      INDICATE SYNAD + LAST MSG        85000019
         L     GR15,VIEBVMS       FETCH MSG. WRITER ADDRESS             85100019
         BALR  GR14,GR15               GO                               85200019
         CLI   RCBUF,RTCD         IS RETURN CODE 4 OR HIGHER     A44144 85250000
         BNL   DONTSET            YES-DON'T SET RETURN CODE      A44144 85260000
         MVI   RCBUF,RTCD         SET RETURN CODE=4              A44144 85270000
DONTSET  EQU   *                                                 A44144 85280000
         BR    GR10                    RTN. TO CALLER                   85300019
FXBLKSTD EQU   *                                                        85400019
         LA    GR8,MSGNO174            POINT TO SHORT MSG               85500019
         NI    SENSE,XFF-SENSE5   RESET SHORT REC. FLAG                 85600019
         L     GR11,WARNTTRN           FETCH SAVED TTRN                 85700019
         CLC   W10(W2,GR5),ZROS   THIS ONE EOF                          85800019
         BCR   MS8,GR10           YES- RTN TO CALLER                    85900019
         B     CONSTMSG           OTHERWISE GET MESSAGE                 86000019
         DROP  GR2                                                      86100019
*                                                                       86200019
*********************************************************************** 86300019
*                                                                     * 86400019
*                  CALL WRITE AND RETURN                              * 86500019
*                                                                     * 86600019
*********************************************************************** 86700019
*                                                                       86800019
WRITEUM  EQU   *                                                        86900019
         NI    WSFLAG,XFF-FORCEWRT-NOWRT-RETRNOVR   RESET FOR           87000019
*                                 RE-ENTRY TO IEBWSU                    87100019
         NI    FLG1,XFF-IN2ND     RESET SECOND SWITCH                   87200019
WRITEIT  EQU   *                                                 A45142 87250021
         L     GR15,VIEBDWR            WRITE ROUTINE ADDRESS            87300019
         BALR  GR14,GR15               WRITE BUFFER                     87400019
         BR    GR10               RETURN TO CALLER OF SUBROUTINE        87500019
*                                                                       87600019
*                                                                       87700019
GOBACK   EQU   *                                                        87800019
         L     GR13,SAVERGS+W4    PICK UP POINTER TO REGISTERS          87900019
         RETURN (14,12)                RETURN TO CALLER                 88000019
*                                                                       88100019
         EJECT                                                          88200019
GIVEMSG  EQU   *                                                 A38720 88300021
         L     GR2,AMSG                LOAD PTR TO MSG CSECT            88400019
         USING IEBWSUMG,GR2            ADDRESSABILITY TO MSG CSECT      88500019
         MVI   MSGBUF,MSGCLR      CLEAR                                 88600019
         MVC   MSGBUF+W1(W120),MSGBUF   BUFFER                          88700019
         MVC   MSGBUF+W1(W7),W0(GR8)  FETCH MSG. NO.             A38720 88750021
         MVC   MSGBUF+W10(W53),MEMBMSG  STANDARD HEADER          A38720 88800021
         MVC   MSGBUF+W64(W30),W7(GR8)  NOTELIST OR GREATER MSG  A38720 88850021
         L     GR3,NXTINDS             POINTER TO INDD NAME             88900019
         MVC   MSGBUF+W51(W8),W2(GR3) PLACE DDNAME IN BUFFER            89000019
         SPACE 1                                                        89100019
         L     GR3,IDEAD               POINTER TO MEMBER NAME           89200019
         MVC   MSGBUF+W17(W8),W0(GR3) MOVE MEMBER NAME TO BUFFER        89300019
         SPACE 1                                                        89400019
MSGTERM1 MVI   MSG1,IOERF+LASTMSG INDICATE SYNAD + LAST MSG    @ZA27766 89500099
         L     GR15,VIEBVMS            LOAD PTR TO MSG WRITER           89600019
         BALR  GR14,GR15               ISSUE ERROR MSG                  89700019
         SPACE 1                                                        89800019
         CLI   RCBUF,RTCDE        IS RETURN CODE 8 OR HIGHER     A44144 89850000
         BNL   DONOTSET           YES-DON'T SET RETURN CODE      A44144 89860000
         MVI   RCBUF,RTCDE        SET RETURN CODE=8              A44144 89900000
DONOTSET EQU   *                                                 A44144 89950000
         MVI   VTMFLG1,UNUSEND         SET SWITCH FOR VTM               90000019
         L     GR15,VIEBVTM            LOAD PTR TO VTM                  90100019
         BALR  GR14,GR15               BRANCH TO VTM  (NO RETURN)       90200019
         DROP  GR2                                                      90300019
         SPACE 2                                                 A34431 90308020
CHKFIRST EQU   *                                                 A34431 90316020
         TM    WSFLAG,FRSTMREC    WAS FIRST RECORD OF A MEMBER   A34431 90324020
*                                  JUST PROCESSED                A34431 90332020
         BCR   W8,GR10            NO, RETURN                     A34431 90340020
         SPACE 1                                                 A34431 90348020
         NI    WSFLAG,XFF-FRSTMREC TURN OFF FIRST RECORD OF A    A34431 90356020
*                                    MEMBER SWITCH               A34431 90364020
         MVC   SVTTR(W3),OUTDS1   ESTABLISH MEMBER TTR           A34431 90372020
         BR    GR10               RETURN TO CALLER               A34431 90380020
         EJECT                                                   A34431 90388020
         EJECT                                                          90400019
TESTREP  TM    UTTRFLAG,X00       TM  INSTRUCTION EXECUTED BY VWS       90900019
CONMASK  DC    X'00'                   MASK FIELD                       91000019
BITSWAP  EQU   *-1                                                      91100019
         DC    X'804020'               TRANSLATE FIELD                  91200019
REPFLAG  EQU   X'80'                   FLAG FOR TTR'S REPLACED          91300019
*                                        REPLACED                       91400019
MOVENOTE MVC   W0(W1,GR3),W0(GR2) MOVE FOR LESS THAN 256 BYTES          91460019
COMPSEGS CLC   W1(W0,GR9),W1(GR5) COMPARE INST FOR TRK OV-FLOW          91520019
AMSG     DC    A(IEBWSUMG)        ADDR OF WSU MESSAGE CSECT             92200019
NUM      DC    CL16'0123456789ABCDEF'  PRINTABLE HEX CONVERSION TABLE   92300019
FIXREC   EQU   X'80'              FIXED AND UNDEFINED BIT OF RECFM      92400019
*                                 IN DCB                                92500019
VARUNDF  EQU   X'40'                   UNDEFINED/VARIABLE-RECFM         92600019
FIXBLKS  EQU   X'18'                   FIXED BLOCKED STANDARD-RECFM     92700019
OVERFLOW EQU   X'20'                   OVERFLOW FLAG DCBRECFM           92800019
TTRNUMB  EQU   11                      START OF TTR COUNT IN DIRECTORY  92900019
TTRDIRC  EQU   12                      START OF USER TTR FIELD IN D.E.  93000019
         DS    0F                                                       93100019
PATCHLN  EQU   (*-START)/20       5 PER CENT PATCH LENGTH               93200019
PATCH    DC    XL(PATCHLN)'00'         PATCH AREA                A41780 93300021
         EJECT                                                          93400019
IEBWSUMG CSECT                                                          93500019
* FOLLOWING DC'S ARE MESSAGE SEGMENTS WHICH ARE PUT TOGETHER WHEN WSU   93530019
* IS TO SET UP ITS OWN WARNING/ERROR MSGS.                              93560019
MSGNO174 DC    C'IEB174IA SHORT LENGTH RECORD      '                    93600019
MSGNO175 DC    C'IEB175IGREATER THAN OUTPUT BLKSIZE'                    93700019
WARNINRC DC    C'** WARNING ** INPUT RECORD IS'                         93800019
NAMEMSG  DC    C'-DDNAME='                                              93900019
TTRNMSG  DC    C'-OUTPUT TTRN='                                         94000019
MSGNO176 DC    C'IEB176IMORE THAN ONE NOTELIST POINTER'          A38720 94100021
MSGNO188 DC    C'IEB188IRECORDS GREATER THAN BLKSIZE  '          A38720 94150021
MEMBMSG  DC    C'MEMBER          IN DATASET REFERENCED'          A38720 94200021
         DC    C' BY          HAS'                               A38720 94210021
         EJECT                                                          94300019
DEVTAB   DSECT                                                          94400019
*                                                                     * 94500019
*   DIRECT ACCESS DEVICE TABLE OVERLAY                                * 94600019
*         OUTCHAR1, UT3CHAR, UT4CHAR BYFFERS IN IEBMCA                * 94700019
*                                                                     * 94800019
DEVCODE  DS    F                       DEVICE CODE FROM UCB             94900019
MAXSIZE  DS    F                       MAXIMUM SIZE UNKEYED BLOCK       95000019
MAXCC    DS    H                       NUMBER OF CYLINDERS              95100019
MAXHH    DS    H                       NUMBER OF TRACKS PER CYLINDER    95200019
TRKCAP   DS    H                       MAXIMUM TRACK LENGTH             95300019
OVERI    DS    XL1                     OVERHEAD FOR NOT LAST RECORD     95400019
OVERL    DS    XL1                     OVERHEAD FOR LAST RECORD         95500019
OVERK    DS    XL1                     OVERHEAD REDUCTION FOR NON-KEYED 95600019
DEVFLAG  DS    XL1                     APPLY TOLERANCE FACTOR NOT LAST  95700019
TOLER    DS    H                       GAP LENGTH CALCULATION TOLERANCE 95800019
HALFOVER EQU   X'08'                   OVERHEAD LAST=OVERHEAD    S20201 95820020
*                                      NOT LAST AND IS A TWO     S20201 95840020
*                                      BYTE FIELD                S20201 95860020
TOLFAC   EQU   X'01'                   TOLERANCE FACTOR TO BE ADDED     95900019
*                                                                     * 96000019
*   END OF DEVTAB OVERLAY                                             * 96100019
*                                                                     * 96200019
         DCBD  DSORG=PO                                                 96300019
RECFM    EQU   DCBRECFM-IHADCB         RECFM FIELD OFFSET IN DCB        96400019
         EJECT                                                          96500019
IEBMCA   DSECT                                                          96600019
         IEBMCA                                                         96700019
OUTUCBDV EQU   OUTCHAR+3  DEVICE CODE INFORMATION                       96730019
A2321    EQU   X'05'      DEVICE CODE FOR A 2321                        96760019
         END                                                            96800019
