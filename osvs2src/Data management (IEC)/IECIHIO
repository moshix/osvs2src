         TITLE 'IECIHIO - INTRODUCTORY COMMENTS'                        00052002
IECIHIO  CSECT                                                          00054002
         ENTRY IECVHHK1                                                 00060002
         ENTRY IECVHHK2                                                 00070002
         ENTRY IECHK4                                                   00080002
         ENTRY IECHK5                                                   00090002
         EJECT                                                          01900002
*                                                                       02050002
*****************************************************************       02100002
*                                                                       02150002
*        MODULE NAME - IECIHIO                                          02200002
*                                                                       02250002
*        DESCRIPTIVE NAME - HALT I/O SUBROUTINE                         02300002
*                                                                       02350002
*        COPYRIGHT - NONE                                               02400002
*                                                                       02450002
*        STATUS - CHANGE LEVEL - 0.0                                    02500002
*                                                                       02550002
*        LOAD MODULE NAME - IEANUCXX                                    02600002
*                                                                       02650002
*        CSECT NAME - IECIHIO                                           02700002
*                                                                       02750002
*        FUNCTION - THE FUNCTION OF THIS MODULE IS TO HALT I/O          02800002
*              TO A SPECIFIC DEVICE WHEN CALLED ON TO DO SO BY          02850002
*              CERTAIN SYSTEM ROUTINES.                                 02900002
*                                                                       02950002
*        OPERATION - THE MODULE RECEIVES CONTROL AT ENTRY POINT         03000002
*              IECIHIO FROM EITHER SVC 16 OR SVC 33.                    03050002
*              THE DEVICE IS CHECKED TO SEE IF IT WAS LAST              03250002
*              STARTED ON THIS CPU. IF NOT THE SYSTEM IPC FUNCTION      03300002
*              IS USED TO INVOKE THE HIO ROUTINE ON THE CORRECT CPU.    03350002
*              WHEN THIS IS THE CORRECT CPU THE HALT DEVICE I/O         03400002
*              INSTRUCTION (HDV) IS ISSUED TO STOP I/O ON THE           03450002
*              DEVICE. IF THE DEVICE RESPONDS OTHER THAN CC=1 THE       03500002
*              I/O IS ASSUMED TO HAVE BEEN STOPPED. CC=1 WILL CAUSE     03550002
*              THE ROUTINE TO CHECK THE LOGOUT PENDING FLAG IN          03600002
*              THE CSW. IF ON THE ROUTINE WILL CAUSE SYSTEM             03650002
*              ENABLEMENT ON THE SPECIFIC CHANNEL ALLOWING THE          03700002
*              LOGOUT AND THEN INTERFACE WITH THE IOS INTERRUPT         03750002
*              HANDLER TO DEAL WITH THE INTERRUPT. (IF THIS WAS         03800002
*              AN IPC ENTRY TO HIO THE RELEASE OF THE UCB LOCK          03850002
*              NECESSARY TO CALL THE INTERRUPT HANDLER CAN NOT BE       03900002
*              DONE SINCE THE LOCK IS HELD BY THE OTHER CPU. IN         03950002
*              THIS CASE IPC IS RETURNED TO THUS ALLOWING THIS CPU      04000002
*              TO RETURN TO NORMAL PROCESSING AN TAKE THE INTERRUPT     04050002
*              WHEN POSSIBLE.) AFTER THE LOGOUT HAS BEEN CLEARED        04100002
*              THE HDV IS AGAIN ISSUED THIS TIME GIVING GOOD            04150002
*              STATUS.                                                  04200002
*              IF LOGOUT PENDING IS NOT ON THE CSW IS CHECKED FOR       04250002
*              CHANNEL ERRORS (CCC,ICC,CDC) AND IF ANY ARE PRESENT      04300002
*              CONTROL IS PASSED TO CCH FOR APPROPRIATE ACTION.         04350002
*              CCH MAY RETURN +0 INDICATING RETRY THE HDV, OR +4        04400002
*              INDICATING DO NOT RETRY THE HDV. TWO SUCCESSIVE          04450002
*              CHANNEL ERRORS WILL CAUSE CONTROL TO BE RETURNED         04500002
*              TO THE CALLER WITH A 04 RETURN CODE.                     04550002
*              IF AN IPC IS NECESSARY THE RETURN CODE FROM IPC IS       04600002
*              CHECKED TO DETERMINE THE SUCCESS OF THE OPERATION.       04650002
*              IF THE RETURN CODE IS NOT 0 OR 8 THE I/O IS ASSUMED      04700002
*              STOPPED. A RETURN CODE OF 8 WILL CAUSE THE ROUTINE       04750002
*              TO RETRY THE IPC A FINITE NUMBER OF TIMES IF             04800002
*              EQUIP CK, OPER INTV, OR RECIV CK IS PRESENT IN THE       04850002
*              STATUS. (OTHER STATUS IS TREATED AS HAVING STOPPED       04900002
*              THE DEVICE.) A 0 RETURN CODE WILL CAUSE THE ROUTINE      04950002
*              TO CHECK THE RETURN BYTE IN THE FRR SAVE AREA. IF        05000002
*              THIS BYTE IS ZERO THE DEVICE WAS STOPPED, IF 4 THE       05050002
*              ROUTINE TOOK TWO SUCCESSIVE CHANNEL ERRORS IN THE        05100002
*              OTHER CPU AND A CODE 4 RETURN TO CALLER IS DONE, IF      05150002
*              8 THE CHANNEL NEEDED TO LOGOUT ON THE OTHER CPU AND      05200002
*              THE IPC WILL BE RETRIED A FINITE NUMBER OF TIMES IN      05250002
*              HOPES THAT THE LOGOUT WILL HAVE CLEARED. FAILURE TO      05300002
*              CLEAR WILL RESULT IN A RETURN CODE OF 8 TO THE CALLER.   05350002
*                                                                       05400002
*        NOTES -                                                        05403000
*              PATCH AREA -                                             05406000
*              HIOPATCH                                        @YM05573 05409000
*                                                                       05412000
*        MODULE TYPE - PROCESSING                                       05415000
*                                                                       05418000
*            PROCESSOR - ASSEMBLERXF                                    05421000
*                                                                       05424000
*            MODULE SIZE - 1024 DECIMAL                                 05427000
*                                                                       05430000
*            ATTRIBUTES -                                               05433000
*              SUPERVISOR STATE                                         05436000
*              KEY 0                                                    05439000
*              RESIDENT                                                 05442000
*              REENTRANT                                                05445000
*              DAT ON                                                   05450000
*              DISABLED FOR EXTERNAL INTERRUPTS                         05460000
*              DISABLED FOR I/O INTERRUPTS (WITH ONE EXCEPTION)         05470000
*                                                                       05480000
*        ENTRY POINTS - IECIHIO                                         05490000
*                       IECIHIO2 - USED AS AN ENTRY FOR IPC PURPOSES    05500002
*                                                                       05550002
*           PURPOSE = SEE FUNCTION                                      05560000
*                                                                       05570000
*           LINKAGE =                                                   05580000
*                                                                       05590000
*           INPUTS -                                                    05600000
*              REG2 - IOSB ADDRESS OR ZERO                              05650002
*              REG7 - UCB ADDRESS                                       05700002
*              REG14 - RETURN ADDRESS                                   05750002
*              REG13 - ADDRESS OF A 16 WORD SAVE AREA                   05800002
*              REG15 - ENTRY POINT (IECIHIO)                            05850002
*                                                                       05900002
*              (FOR IPC ENTRY REG1 CONTAINS THE ADDRESS OF THE          05950002
*              FRR SAVE AREA, REG15 CONTAINS THE ADDRESS OF             06000002
*              IECIHIO2, AND REG14 CONTAINS THE IPC RETURN ADDRESS)     06050002
*                                                                       06100002
*           OUTPUTS -                                                   06150000
*              RETURN CODE IN REG15                                     06200002
*                  0 - NORMAL - DEVICE STOPPED                          06250002
*                  4 - CHANNEL ERRORS - CHANNEL ERRORS OCCURED ON       06300002
*                                       TWO SUCCESSIVE HDV COMMANDS.    06350002
*                  8 - IPC FAILED - UNABLE TO HALT THE DEVICE FROM      06400002
*                                   THE OTHER CPU                       06450002
*                                                                       06500002
*           EXITS - NORMAL - TO CALLER (REG15 = 0)                      06510000
*                                                                       06520000
*           EXITS - ERROR  - TO CALLER (REG15 ^= 0)                     06530000
*                                                                       06540000
*        EXTERNAL REFERENCES -                                          06550002
*           ROUTINES - IPC                                              06600000
*                      SETLOCK                                          06650000
*                      I/O INTERRUPT HANDLER                            06700000
*                                                                       06750002
*           DATA SETS = NONE                                            06800000
*                                                                       06850002
*           DATA AREAS = NONE                                           06900000
*                                                                       06950002
*        TABLES/WORKAREAS -                                             07000002
*              FRR WORKAREA                                             07050002
*                                                                       07100002
*        MAPPING MACROS USED                                            07150002
*              UCB                                                      07200002
*              CVT                                                      07250002
*              LCCA                                                     07300002
*              PCCA                                                     07350002
*              PSA                                                      07400002
*              FRRS                                                     07450002
*              SAVT                                                     07500002
*        CHANGE ACTIVITY - NONE                                         08050000
*                                                                       08100002
*****************************************************************       08250002
*                                                                       08300002
         EJECT                                                          08350002
*                                                                       08400002
*****************************************************************       08450002
*        REGISTER EQUATES                                               08500002
*****************************************************************       08550002
*                                                                       08600002
REG0     EQU   0                       REGISTER 0                       08650002
REG1     EQU   1                       REGISTER 1                       08700002
CNTREG1  EQU   2                       CHAN ERR CNTR                    08750002
CNTREG   EQU   3                       IPC COUNTER REGISTER             08800002
WKREG4   EQU   4                       WORK REG                         08850002
WKREG5   EQU   5                       WORK REG                         08900002
WKREG6   EQU   6                       WORK REG                         08950002
UCBREG   EQU   7                       UCB POINTER                      09000002
BASEREG  EQU   8                       PROG BASE REG                    09050002
FRREG    EQU   9                       FRR AREA POINTER                 09100002
INDREG   EQU   10                      IPC OR NORMAL IND                09150002
REG11    EQU   11                      REGISTER 11                      09200002
EPREG    EQU   12                      EP FOR IPC CALL                  09250002
SAVEREG  EQU   13                      SAVE AREA PTR                    09300002
RETREG   EQU   14                      RETURN PTR                       09350002
REG15    EQU   15                      REGISTER 15                      09400002
         SPACE 5                                                        09450002
*                                                                       09500002
*****************************************************************       09550002
*        CONTROL REGISTER EQUATE                                        09600002
*****************************************************************       09650002
*                                                                       09700002
IOCTL    EQU   2                       CHANNEL ENABLE CTL REG           09750002
         EJECT                                                          09800002
*                                                                       09850002
*****************************************************************       09900002
*        DATA AND DISPLACEMENT EQUATES                                  09950002
*****************************************************************       10000002
*                                                                       10050002
SAVDISP  EQU   0                       DISP INTO SAVE AREA TO           10100002
*                                      STORE REGISTERS                  10150002
MAXCNT   EQU   512                     MAX TIMES TO RETRY IPC           10200002
ZERO     EQU   0                       ZERO                             10250002
ONE      EQU   1                       ONE                              10300002
TWO      EQU   2                       TWO                              10350002
FOUR     EQU   4                       FOUR                             10400002
EIGHT    EQU   8                       EIGHT                            10450002
NOCSW    EQU   11                      CC^=1 MASK                       10500002
R2DISP   EQU   8                       DISP INTO SAVE AREA OF           10550002
*                                      REGISTER 2                       10600002
COD      EQU   X'C0'                   COMPARE FOR C0D ABEND            10610002
CSWLOP   EQU   X'04'                   LOGOUT PENDING IND               10650002
STATUS1  EQU   4                       DISP TO FIRST STAT BYTE          10700002
STATUS2  EQU   5                       DISP TO STAT BYTE 2              10750002
CHANERR  EQU   X'0E'                   CHANNEL ERR IND                  10800002
*                                      CCC,ICC,CDC                      10850002
BSYORCUE EQU   X'30'                   BUSY OR CU END                   10900002
NOTZERO  EQU   7                       CC^=0 MASK                       10950002
TIMES4   EQU   2                       SHIFT TO X 4                     11000002
IPCRET   EQU   8                       IPC FAILED RET CODE              11050002
IPCTERM  EQU   12                      ABNORMAL TERMINATION OCCURRED    11060002
*                                      ON SHOULDER TAPPED CPU           11070002
LOPCOD   EQU   8                       LOGOUT PEND FRR CODE             11100002
CCHRET   EQU   4                       CHAN ERR RET CODE                11150002
CCHCODE  EQU   4                       CHAN ERR IPC FRR CODE            11200002
LO8      EQU   8                       SHIFT QUANT                      11300002
IOENAB   EQU   X'02'                   I/O ENABLE                       11350002
HIOIND   EQU   X'18'                   CCH HIO INDICATOR                11400002
DEVACTV1 EQU   X'A2'                   CPACTV,BSY,PST                   11450002
DEVACTV2 EQU   X'40'                   SNSACTV                          11500002
ALLON    EQU   X'FF'                   BYTE WITH ALL BITS ON            11550002
TRANMODE EQU   X'04'                   TRANSLATION MODE                 11560002
         TITLE 'IECIHIO - INITIAL ENTRY SETUP'                          11600002
*                                                                       11650002
*****************************************************************       11700002
*        HALT I/O SUBROUTINE                                            11750002
*        THIS IS THE INITIAL PROGRAM SETUP FOR IECIHIO.                 11800002
*        REGISTERS ARE STORED AND THE FRR IS SET.                       11850002
*****************************************************************       11900002
*                                                                       11950002
         USING PSA,0                                                    12000002
         STM   REG0,RETREG,SAVDISP(SAVEREG)  SAVE REGISTERS 0-14        12050002
         LR    BASEREG,REG15           LOAD BASE REGISTER               12100002
         USING IECIHIO,BASEREG                                          12150002
         USING UCB,UCBREG                                               12200002
         SR    INDREG,INDREG           INDICATE NORMAL                  12250002
         LA    CNTREG,MAXCNT           LOAD IPC RETRY CNT               12300002
         SR    CNTREG1,CNTREG1         CLEAR CHAN ERR CNTR              12350002
         LA    WKREG4,HIOFRR           LOAD FRR ADDRESS                 12400002
         SETFRR A,FRRAD=(4),PARMAD=(9),WRKREGS=(5,6)                    12450002
         USING FRRAREA,FRREG                                            12500002
         ST    SAVEREG,FRRSAVE         STORE SAVE REG                   12550002
         ST    UCBREG,FRRUCB           STORE UCB PTR                    12600002
         TITLE 'IECIHIO - ISSUE HDV WHEN ON RIGHT CPU'                  12650002
*                                                                       12700002
*****************************************************************       12750002
*        CHECK THAT THIS IS RIGHT CPU AND IF SO ISSUE HDV.              12800002
*        CHECK HDV CONDITION CODE AND PERFORM PROCESSING                12850002
*        INDICATED.                                                     12900002
*****************************************************************       12950002
*                                                                       13000002
         USING PCCA,WKREG4                                              13050002
HIOCPUCK L     WKREG4,PSAPCCAV         LOAD PCCA ADDRESS                13100002
         CLC   PCCACPUA+ONE(ONE),UCBCPU COMPARE CPU ADDRESSES           13150002
*                                      TO SEE IF THIS IS THE            13200002
*                                      CORRECT CPU                      13250002
         BNE   HIOIPC1                 NOT CORRECT-GO IPC               13300002
         DROP  WKREG4                                                   13350002
HIOHIO   LH    WKREG5,UCBCHAN          LOAD LAST PATH STARTED           13400002
         SPACE                                                          13410003
         BAL   RETREG,HIOCK1           BRAN TO CINTER HOOK RT1 @Y30CQLG 13420003
         SPACE                                                          13430003
IECVHHK2 HDV   ZERO(WKREG5)            ISSUE HALT DEVICE                13450002
         SPACE                                                          13460003
         BAL   RETREG,HIOCK2      CALL CRH HOOK ROUTINE 2     @Y30CQLG  13470003
         SPACE                                                          13480003
         BC    NOCSW,HIORTRN2          NO CSW STORED-RETURN             13500002
         TM    FLCCSW,CSWLOP           CSW STORED-LOP CHECK             13550002
         BO    HIOLOP                  YES- LOGOUT PENDING              13600002
HIOCCHCK TM    FLCCSW+STATUS2,CHANERR  ANY CHANNEL ERRORS               13650003
         BNZ   HIOCCH                  YES - GO IFACE TO CCH            13700002
         TM    FLCCSW+STATUS1,BSYORCUE CONTROL UNIT BSY OR              13750002
*                                      CONTROL UNIT END                 13800002
         BZ    HIORTRN2            EVERYTHING OK, CONTINUE     @OZ00762 13850003
         SPACE                                                          13860003
         OI    FRRFLA,FRRBACK      CU BZY MAY CAUSE INTERLOCK  @OZ00762 13870003
         B     HIORTRN3            BETTER BACK OUT TO ENABLE   @OZ00762 13880003
         TITLE 'IECIHIO - TERMINATION CODE'                             13900002
*                                                                       13950002
*****************************************************************       14000002
*        TERMINATION ROUTINE. SET RETURN CODE, DELETE THE FRR,          14050002
*        RESTORE REGS IF NEEDED, RETURN TO CALLER OR IPC                14100002
*****************************************************************       14150002
*                                                                       14200002
HIORTRN2 SR    REG15,REG15             SET 0 RET CODE                   14250002
HIORTRN  NC    UCBSFLS(TWO),ACTIVOFF   SET UCB ACTIVE FLAGS 0           14300002
HIORTRN3 L     SAVEREG,FRRSAVE         RELOAD SAVE AREA PTR             14350002
         LTR   INDREG,INDREG       IPC (SHOLDER TAP) CALL      @OZ00762 14351003
         BNZ   HIORTRN1            YES, SET RC OTHER CPU       @OZ00762 14352003
         TM    FRRFLA,FRRBACK      SHOULD I BACK OUT, NO HALT  @OZ00762 14353003
         BZ    HIORTRN1            NO, I/O HALTED OK           @OZ00762 14354003
         LA    REG15,ALLON         X'FF' INDICATE NOT HALTED   @OZ00762 14355003
*                                  CALLER SHOULD ENABLE & RTRY @OZ00762 14356003
HIORTRN1 EQU   *                                                        14357003
         L     RETREG,FRRIPCR      RELOAD R14 INCASE IPC CALL  @ZM30185 14358003
         NI    FRRFLA,ALLON-FRRSHTP    RESET SHOULDER TAP ACTIVE        14360003
         SETFRR D,WRKREGS=(5,6)                                         14400002
         LTR   INDREG,INDREG           IPC CALL                         14450002
         BCR   NOTZERO,RETREG          YES-RETURN                       14500002
         LM    REG0,RETREG,SAVDISP(SAVEREG)  RESTORE REGS               14550002
         BR    RETREG                  RETURN TO CALLER                 14600002
         TITLE 'IECIHIO - ISSUE IPC TO CORRECT CPU'                     14650002
*                                                                       14700002
*****************************************************************       14750002
*        THIS SECTION DETERMINES WHICH CPU SHOULD BE SIGNALED           14800002
*        AND SETS UP TO ISSUE THE RISGNL MACRO TO INVOKE IPC.           14850002
*        THE IPC RETURNS ARE INTERROGATED (INCLUDING THE FRR            14900002
*        AREA CODE) AND APPROPRIATE ACTION TAKEN.                       14950002
*****************************************************************       15000002
*                                                                       15050002
HIOIPC1  SR    WKREG5,WKREG5           CLEAR REG                        15100002
         IC    WKREG5,UCBCPU           GET LAST CPU STARTED             15150002
         SLL   WKREG5,TIMES4           MULT TIMES 4 FOR INDX            15200002
         L     WKREG6,FLCCVT           CVT PTR                          15250002
         USING CVT,WKREG6                                               15300002
         L     WKREG6,CVTPCCAT         LOAD PCCA VECTOR TABLE           15350002
         DROP  WKREG6                                                   15400002
         L     REG1,ZERO(WKREG5,WKREG6) LOAD PCCA ADDR OF CPU           15450002
*                                      WHICH LAST STARTED I/O           15500002
         LA    EPREG,IECIHIO2          LOAD IPC ENTRY POINT             15550002
         LR    REG11,FRREG             LOAD FRR AREA AS PARM            15600002
         MVI   FRRLOP,EIGHT            PRIME RETURN CODE                15650002
         RISGNL SERIAL,CPU=(1),EP=(12),PARM=(11)                        15700002
         LTR   REG15,REG15             IS RETURN CODE 0                 15750002
         BNZ   HIORC8CK                NO GO CK FOR 8                   15800002
         CLI   FRRLOP,EIGHT            CODE 8 RETURNED                  15850002
         BL    HIORCSET                NO - GET CODE AND RETURN         15900002
         BH    HIOABEND                IF HIGH, ABEND TO FORCE          15910002
*                                      FRR ENTRY - SHOULDER TAPPED      15920002
*                                      CPU ABNORMALLY TERMINATED        15930002
HIODECTR BCT   CNTREG,HIOIPC1          RETRY MAX TIMES                  15950002
HIORCSET SR    REG15,REG15             CLEAR RET CODE REG               16000002
         IC    REG15,FRRLOP            LOAD RETURN CODE                 16050002
         B     HIORTRN3                RETURN TO CALLER                 16100002
*                                                                       16150002
*******************                                                     16200002
*        RETURN CODE 8 FROM IPC - CHECK STATUS                          16250002
*******************                                                     16300002
*                                                                       16350002
HIORC8CK CH    REG15,HWD8              RETURN CODE 8                    16400002
         BNE   HIORTRN2                NO - RETURN,CODE 0               16450002
         N     REG0,NONRTY             CHECK STATUS FOR EQUIP CK        16500002
*                                      RECEV CK, OR OPER INTV           16550002
         BZ    HIORTRN2                NOT ON-RETURN                    16600002
         B     HIODECTR                YES - RETRY IF NEEDED            16650002
         SPACE 2                                                        16660002
HIOABEND ABEND X'C0D',DUMP,STEP,SYSTEM                                  16670002
         TITLE 'IECIHIO - LOGOUT PENDING CODE'                          16700002
*                                                                       16750002
*****************************************************************       16800002
*        THIS SECTION HANDLES THE OCCURANCE OF LOGOUT PENDING           16850002
*        IN RESPONSE TO THE HDV INSTRUCTION. IF LOP OCCURS              16900002
*        DURING AN IPC CALL CONTROL IS RETURNED TO THE CALLING          16950002
*        CPU AND THE IPC IS RETRIED (IN THE HOPE THAT THE LOGOUT        17000002
*        WILL OCCUR WHEN THE OTHER CPU IS RELEASED). IF LOP             17050002
*        OCCURS DURING NORMAL PROCESSING THE SYSTEM IS ENABLED          17100002
*        TO ONLY ALLOW THE LOGOUT AND AFTER THE LOGOUT CONTROL          17150002
*        IS GIVEN TO THE I/O SLIH TO HANDLE THE CONDITION.              17200002
*        UPON RETURN THE HDV IS REISSUED.                               17250002
*****************************************************************       17300002
*                                                                       17350002
HIOLOP   LTR   INDREG,INDREG           IPC CALL                         17400002
         BZ    HIOLOP1                 NO - SET FOR I/O SLIH            17450002
         MVI   FRRLOP,LOPCOD           SET LOP CODE IN FRR              17500002
*                                      AREA FOR RETURN                  17550002
         B     HIORTRN1                RETURN TO CALLER CODE=0          17600002
HIOLOP1  STCTL IOCTL,IOCTL,FRRCTL1     SAVE CURRENT I/O REG             17650002
         SRL   WKREG5,LO8              SHIFT OUT LO 8 BITS              17800002
*                                      OF ADDR USED IN HDV              17850002
*                                      LEAVING CHANNEL                  17900002
         L     WKREG6,HION             LOAD -0 IN WORK REG              17950002
         SRL   WKREG6,ZERO(WKREG5)     SHIFT TO ENABLE RIGHT            18000002
*                                      CHANNEL                          18050002
         ST    WKREG6,FRRCTL2          STORE TEMP I/O CNTRL             18100002
*                                      REGISTER                         18150002
         LCTL  IOCTL,IOCTL,FRRCTL2     LOAD TEMP I/O CTL REG            18200002
         MVC   FRRPSW(FOUR),FLCINPSW+FOUR  SAVE CURRENT I/O NEW         18250002
IECHK4   NOPR  ZERO                    DSS HOOK FOR PSW CHANGE          18260002
         MVC   FLCINPSW+FOUR(FOUR),HIOPSW  MOVE IN TEMP PSW             18300002
IECVHHK1 STOSM FRRSYSMK,IOENAB         SET FOR I/O ENABLED              18350002
         B     IECVHHK1                LOOP WAITING FOR INT             18400002
IECHK5   NOPR  ZERO                    DSS HOOK FOR PSW CHANGE          18410002
INTENT   MVC   FLCINPSW+FOUR(FOUR),FRRPSW  RESTORE I/O NEW PSW          18450002
         LCTL  IOCTL,IOCTL,FRRCTL1     RELOAD I/O CTL REG               18500002
         IC    REG11,FLCIOPSW          GET MASK AT INT                  18510002
         N     REG11,SYSDISM           INSURE DISABLED                  18520002
         STNSM FRRSYSMK,TRANMODE       SET MASK TO ZERO                 18530002
         EX    REG11,EXSTOSM           STOSM NEW VALUE                  18540002
         BAL   WKREG4,HIOFUCB          GET UCBLOCK ADDRESS              18590002
R1       SETLOCK RELEASE,TYPE=IOSUCB,ADDR=(11),RELATED=(UCB,SVC33(GETLO*18700002
               CK),SVC16(GETLOCK)),DISABLED                             18750002
         LA    REG11,IRTHIO            SET FOR SLIH CALL                18800002
         L     WKREG5,ADIECINT         LOAD I/O SLIH ADDRESS            18850002
         LR    SAVEREG,FRREG           SAVE FRR REG ACROSS SLIH         18900002
         ST    BASEREG,FRRCTL1         SAVE BASE REG                    18950002
         OI    FRRFLA,FRRIOS           SET IOS ACTIVE SW FOR FRR        18960002
         SPACE                                                          18970003
         BAL   RETREG,HIOCK3           CHECK IF CRH IS ACTIVE  @Y30CQLG 18980003
         SPACE                                                          18990003
         BAL   WKREG4,FOUR(WKREG5)     GO TO I/O SLIH TO                19000002
* HIOCK3  RETURNS HERE IF CRH IS ACTIVE                        @Y30CQLG 19020003
*                                      HANDLE LOGOUT. THE +4 ENTRY      19050002
*                                      WILL CAUSE ENTRY AFTER THE       19057002
*                                      INTERRUPT HANDLER HAS SET UP     19064002
*                                      THE ENVIRONMENT BYTE AND WILL    19071002
*                                      THEREFORE INDICATE HIO ENTRY     19078002
*                                      WHEN THE BYTE IS STORED FROM     19085002
*                                      REGISTER 11.                     19092002
         LR    FRREG,SAVEREG           RELOAD FRR REG                   19100002
         NI    FRRFLA,ALLON-FRRIOS     RESET IOS ACTIVE SW              19110002
         L     BASEREG,FRRCTL1         RELOAD BASE REG                  19150002
         L     UCBREG,FRRUCB           RELOAD UCB ADDRESS               19160002
         SR    INDREG,INDREG       REZERO IPC CALL INDICATOR   @YM05572 19180002
         BAL   WKREG4,HIOFUCB          GO FIND UCBLOCK ADDRESS          19210002
O1       SETLOCK OBTAIN,TYPE=IOSUCB,MODE=UNCOND,ADDR=(11),RELATED=(UCB,*19350002
               SVC33(FREELOCK),SVC16(FREELOCK))                         19400002
         B     HIOHIO                  RETRY HDV                        19450002
         TITLE 'IECIHIO - CHANNEL ERROR CODE'                           19500002
*                                                                       19550002
*****************************************************************       19600002
*        THIS SECTION OF CODE IS INVOKED IF A CHANNEL ERROR             19650002
*        IS DETECTED IN THE STATUS RETURNED FROM THE HDV.               19700002
*        CCH IS CALLED AND AFTER PROCESSING THE ERROR MAY RETURN        19750002
*        +0 INDICATING RETRY THE HDV OR +4 INDICATING DON'T RETRY       19800002
*        THE COMMAND.                                                   19850002
*****************************************************************       19900002
*                                                                       19950002
HIOCCH   L     REG15,ADCCH             LOAD CCH ADDRESS                 20000002
         LA    REG1,HIOIND             LOAD HIO INDICATOR       YM00995 20050002
         LR    WKREG4,RETREG           SAVE RET ADDRESS                 20100002
         LR    REG0,CNTREG1            SAVE COUNTER                     20150002
         LR    WKREG6,WKREG5           LOAD DEV ADDR FOR CCH    YM00995 20160002
         L     CNTREG1,FRRSAVE         LOAD SAVE AREA ADDR              20200002
         L     CNTREG1,R2DISP(CNTREG1) LOAD ORIG CONTENTS OF            20250002
*                                      REG 2                            20300002
         L     SAVEREG,PSALCCAV        LOAD LCCA ADDRESS                20350002
         USING LCCA,SAVEREG                                             20400002
         L     SAVEREG,LCCACPUS        LOAD WSAC ADDRESS                20450002
         DROP  SAVEREG                                                  20500002
         USING WSAC,SAVEREG                                             20550002
         L     SAVEREG,WSACIOS         LOAD IOS SAVEAREA PTR            20600002
         DROP  SAVEREG                                                  20650002
         OI    FRRFLA,FRRCCH           SET CCH ACTIVE SW FOR FRR        20660002
         BALR  RETREG,REG15            GO TO CCH                        20700002
         NI    FRRFLA,ALLON-FRRCCH     RESET CCH ACTIVE SWITCH          20710002
         B     HIORTY                  +0 RETURN - RETRY HDV            20750002
*                                                                       20800002
********************                                                    20850002
*        +4 RETURN - DON'T RETRY                                        20900002
********************                                                    20950002
*                                                                       21000002
HIORC2   LR    RETREG,WKREG4           RESTORE RETURN ADDR              21050002
         LA    REG15,CCHRET            LOAD CHAN ERR RET CODE           21100002
         LTR   INDREG,INDREG           IPC CALL                         21150002
         BZ    HIORTRN                 NO - RETURN TO CALLER            21200002
         MVI   FRRLOP,CCHCODE          YES - SET FRR CODE               21250002
         B     HIORTRN1                RETURN TO IPC                    21300002
*                                                                       21350002
********************                                                    21400002
*        +0 RETURN - RETRY                                              21450002
********************                                                    21500002
*                                                                       21550002
HIORTY   LR    RETREG,WKREG4           RELOAD RETURN ADDRESS            21600002
         LTR   CNTREG1,REG0            FIRST TRY                        21650002
         BNZ   HIORC2                  NO - GET OUT                     21700002
         LA    CNTREG1,ONE             YES - SET RETRY IND              21750002
         B     HIOHIO                  RETRY THE HDV                    21800002
         TITLE 'IECIHIO - IPC ENTRY'                                    21850002
*                                                                       21900002
*****************************************************************       21950002
*        THIS ROUTINE IS GIVEN CONTROL IN THE DESIRED CPU AFTER         22000002
*        THE IPC IS ISSUED. IT USES THE FRR WORK AREA TO GET            22050002
*        INFORMATION (UCB ADDRESS) PASSED FROM THE CALLING CPU.         22100002
*        AFTER SETTING UP AS IF THIS WERE A NORMAL ENTRY THE            22150002
*        ROUTINE BRANCHES INTO THE MAINLINE HIO ROUTINE CODE TO         22200002
*        PROCESS THE REQUEST.                                           22250002
*****************************************************************       22300002
*                                                                       22350002
IECIHIO2 LR    BASEREG,REG15           GET ENTRY POINT ADDR             22400002
         LA    REG15,IECIHIO2-IECIHIO  GET DISP INTO MODULE             22450002
         SR    BASEREG,REG15           RESET BASEREG TO FRONT           22500002
         SR    INDREG,INDREG           CLEAR INDICATOR                  22550002
         BCTR  INDREG,0                SET TO -1                        22600002
         SR    CNTREG1,CNTREG1         CLEAR CHAN ERR IND               22650002
         DROP  FRREG                                            YM02358 22652002
         L     FRREG,FLCCVT            LOAD CVT POINTER         YM02358 22660002
         USING CVT,FRREG                                        YM02358 22670002
         L     FRREG,CVTPCCAT          LOAD PCCA POINTER        YM02358 22680002
         CLI   PSACPUPA+ONE,ZERO       IS PSA FOR CPU ZERO      YM02358 22690002
         BNE   HIO20100                NO - USE ZERO            YM02358 22692002
         LA    FRREG,FOUR(FRREG)       INCR TO CPU 1 PCCA       YM02358 22694002
         DROP  FRREG                                            YM02358 22696002
HIO20100 L     FRREG,ZERO(FRREG)       LOAD PCCA POINTER        YM02358 22698002
         USING PCCA,FRREG                                       YM02358 22698402
         L     FRREG,PCCAPSAV          LOAD VIRT PSA ADDR OF    YM02358 22698802
*                                      OTHER CPU                YM02358 22699602
         DROP  FRREG                                            YM02358 22699702
         USING FRRAREA,FRREG                                    YM02358 22699802
         AR    FRREG,REG1              SET FRR AREA PTR         YM02358 22700002
         L     UCBREG,FRRUCB           SET UCB REG                      22750002
         LA    WKREG4,HIOFRR           LOAD FRR ADDRESS                 22800002
         SETFRR A,FRRAD=(4),WRKREGS=(5,6)                               22850002
         MVI   FRRLOP,ZERO             SET FRR CODE 0                   22900002
         ST    RETREG,FRRIPCR          SAVE IPC RETURN ADDR             22910002
         OI    FRRFLA,FRRSHTP          SET SHOULDER TAP CODE            22920002
*                                      IN CONTROL                       22930002
         B     HIOCPUCK                PREPARE FOR HDV                  22950002
         EJECT                                                          22953003
         TITLE 'CRH HOOK ROUTINE 1'                                     22954003
***************************************************************@Y30CQLG 22956003
*                                                              @Y30CQLG 22959003
*           CRH HOOK ROUTINE 1: CHECKS IF CINTER ACTIVE        @Y30CQLG 22962003
*              AND IF SO, DOES A DIAGNOSE TO SET UP THE        @Y30CQLG 22965003
*              CHANNEL RECONFIGURATION HARDWARE                @Y30CQLG 22968003
*                                                              @Y30CQLG 22971003
***************************************************************@Y30CQLG 22974003
         SPACE                                                          22977003
         USING CRCA,REG11                                      @Y30CQLG 22980003
         USING CVT,WKREG6                                      @Y30CQLG 22983003
HIOCK1   L     WKREG6,FLCCVT                                   @Y30CQLG 22986003
         L     REG11,CVTCRCA       CHECK FOR ADDR TO CRCA      @Y30CQLG 22989003
         SPACE                                                          22990003
         LTR   REG11,REG11         IS CRH ACTIVE ?, HAVE BASE  @Y30CQLG 22992003
         BZR   RETREG              NO, RETURN                  @Y30CQLG 22995003
         SPACE                                                          22997003
         TM    UCBFLB,UCBIORST     I/O PATH FROM INOP CPU ?    @Y30CQLG 23000003
         BZR   RETREG              NO, RETURN                  @Y30CQLG 23002003
         SPACE                                                          23003003
         STCM  WKREG5,TWO,CRCAMCWF INDICATE CHANNEL ADDR IN MCW@Y30CQLG 23004003
         OI    CRCAMCWF,CRCAMCWI+CRCAMCWM  TURN ON BITS 26 + 27@Y30CQLG 23006003
         STH   WKREG5,CRCACHAN     STORE CHANNEL + UNIT ADDR   @Y30CQLG 23008003
         ICM   WKREG5,TWO,CHAN6    INDICATE CHANNEL 6, CRCA    @Y30CQLG 23010003
         OI    CRCAFLG1,CRCADIAG   INDICATE OUTSTANDING DIAGNOS@Y30CQLG 23012003
         SPACE                                                          23013003
         DC    X'8300'             DIAGNOSE INSTR              @Y30CQLG 23014003
         DC    S(CRCAMCW)          HALF WRD ADDR OF MCW        @Y30CQLG 23016003
         SPACE                                                          23017003
         BR    RETREG              RETURN TO CALLER            @Y30CQLG 23018003
         SPACE                                                          23019003
         DROP  REG11                                           @Y30CQLG 23020003
         DROP  WKREG6                                          @Y30CQLG 23022003
         EJECT                                                          23024003
         TITLE 'HIOCK2 -    CRH HOOK 2 ROUTINE'                         23026003
***************************************************************@Y30CQLG 23028003
*                                                              @Y30CQLG 23030003
*           CRH HOOK ROUTINE 2: TURNS OFF CRH AND DEDIAGNOSES @Y30CQLG  23032003
*                               HANDLES LOG OUT PENDING        @Y30CQLG 23050003
***************************************************************@Y30CQLG 23052003
         SPACE                                                          23054003
         USING CRCA,REG11                                      @Y30CQLG 23056003
         USING CVT,WKREG6                                      @Y30CQLG 23058003
         SPACE                                                          23059003
HIOCK2   L     WKREG6,FLCCVT                                   @Y30CQLG 23060003
         L     REG11,CVTCRCA       CHECK FOR ADDR TO CRCA      @Y30CQLG 23062003
         LTR   REG11,REG11         IS CRH ACTIVE ?             @Y30CQLG 23064003
         BNZ   HIOCK202            YES, CONTINUE               @Y30CQLG 23066003
         SPACE                                                          23067003
HIOCK201 SPM   RETREG              NO, RESET CONDITION CODE    @Y30CQLG 23068003
         BR    RETREG              AND RETURN                  @Y30CQLG 23070003
         SPACE                                                          23071003
HIOCK202 TM    UCBFLB,UCBIORST     IS I/O RESTART BIT ON ?     @Y30CQLG 23072003
         BZ    HIOCK201            NO, RETURN                  @Y30CQLG 23074003
         SPACE                                                          23075003
         SPM   RETREG              RESET CONDITION CODE        @Y30CQLG 23076003
         BC    NOCSW,HIOCK203      NO CSW STORED,DEDIAG + RET  @Y30CQLG 23078003
         SPACE                                                          23079003
         TM    FLCCSW,CSWLOP       CHANNEL LOGOUT PENDING ?    @Y30CQLG 23080003
         BO    HIOLOP              YES- LOGOUT PENDING LOOP    @Y30CQLG 23082003
         SPACE                                                          23083003
         XI    CRCAMCWF,CRCAMCWM   TURN OFF BIT 27 TO DEDIAG   @Y30CQLG 23084003
         SPACE                                                          23085003
         DC    X'8300'             DEDIAGNOSE TURN OFF CRH     @Y30CQLG 23086003
         DC    S(CRCAMCW)          ADDR OF MCW                 @Y30CQLG 23088003
         SPACE                                                          23089003
         XI    CRCAFLG1,CRCADIAG   INDICATE DIAG NOT OUTSTANDNG@Y30CQLG 23090003
         LH    WKREG5,UCBCHAN      RELOAD LAST ACTUAL PATH     @Y30CQLG 23092003
         B     HIOCCHCK            RETURN TO MAINLINE HIO      @Y30CQLG 23094003
         SPACE                                                          23096003
HIOCK203 XI    CRCAMCWF,CRCAMCWM   TURN OFF BIT 27 TO DEDIAG   @Y30CQLG 23100003
         SPACE                                                          23101003
         DC    X'8300'             DEDIAGNOSE, TURN OFF CRH    @Y30CQLG 23103003
         DC    S(CRCAMCW)                                               23104003
         SPACE                                                          23105003
         XI    CRCAFLG1,CRCADIAG   INDICATE DIAG NOT OUTSTANDNG@Y30CQLG 23106003
         LH    WKREG5,UCBCHAN      RELOAD LAST ACTUAL PATH     @Y30CQLG 23109003
         B     HIORTRN2            NO CSW STORED-RETURN        @Y30CQLG 23112003
         SPACE                                                          23113003
         DROP  REG11                                           @Y30CQLG 23115003
         DROP  WKREG6                                          @Y30CQLG 23118003
         EJECT                                                          23121003
         TITLE 'HIOCK3 - CRH HOOK 3 ROUTINE'                            23124003
***************************************************************@Y30CQLG 23127003
*                                                              @Y30CQLG 23130003
*        CRH HOOK 3                                            @Y30CQLG 23133003
*                                                              @Y30CQLG 23136003
***************************************************************@Y30CQLG 23150003
         SPACE                                                          23151003
         USING CRCA,WKREG4                                     @Y30CQLG 23152003
         USING CVT,WKREG6                                      @Y30CQLG 23153003
         SPACE                                                          23153503
HIOCK3   L     WKREG6,FLCCVT                                   @Y30CQLG 23154003
         L     WKREG4,CVTCRCA      CHECK FOR ADDR TO CRCA      @Y30CQLG 23155003
         LTR   WKREG4,WKREG4       IS CRH ACTIVE ?             @Y30CQLG 23156003
         BZR   RETREG              RETURN TO MAINLINE          @Y30CQLG 23157003
         SPACE                                                          23158003
         TM    CRCAFLG1,CRCADIAG   IS THERE AN OUTSTANDING DIAG@Y30CQLG 23159003
         BNOR  RETREG              NO, RETURN TO MAINLINE      @Y30CQLG 23160003
         SPACE                                                          23161003
         OI    CRCAFLG1,CRCAHIO    INDICAT TO CRH SLIH FROM HIO@Y30CQLG 23162003
         L     WKREG5,CRCACINT     ADDR CRH SLIH, IECVCINT     @Y30CQLG 23163003
         BALR  WKREG4,WKREG5       BRANCH TO IECVCINT FOR LGOUT@Y30CQLG 23164003
         B     FOUR(RETREG)        RETURN PAST THE BAL TO SLIH @Y30CQLG 23165003
         SPACE                                                          23165503
         DROP  WKREG4                                          @Y30CQLG 23166003
         DROP  WKREG6                                          @Y30CQLG 23167003
         EJECT                                                          23168003
         TITLE 'HIOCK4 - CRH HOOK 4 ROUTINE FOR FRR'                    23169003
***************************************************************@Y30CQLG 23170003
*                                                              @Y30CQLG 23171003
*        CRH HOOK 4 FRR HOOK                                   @Y30CQLG 23172003
*                                                              @Y30CQLG 23173003
***************************************************************@Y30CQLG 23174003
         SPACE                                                          23175003
         USING CRCA,REG11                                      @Y30CQLG 23176003
         USING CVT,WKREG6                                      @Y30CQLG 23177003
         SPACE                                                          23177503
HIOCK4   L     WKREG6,FLCCVT                                   @Y30CQLG 23178003
         L     REG11,CVTCRCA       CHECK FOR ADDR TO CRCA      @Y30CQLG 23179003
         LTR   REG11,REG11         IS CRH ACTIVE ?             @Y30CQLG 23180003
         BZR   RETREG              NO, RETURN                  @Y30CQLG 23181003
         SPACE                                                          23181503
         TM    CRCAFLG1,CRCADIAG   IS THERE AN OUTSTANDING DIAG@Y30CQLG 23182003
         BNOR  RETREG              NO, RETURN                  @Y30CQLG 23183003
         SPACE                                                          23184003
         XI    CRCAMCWF,CRCAMCWM   TURN OFF BIT 27 TO DEDIAG   @Y30CQLG 23185003
         SPACE                                                          23185503
         DC    X'8300'             DIAG INSTR                  @Y30CQLG 23186003
         DC    S(CRCAMCW)          MCW ADDR                    @Y30CQLG 23187003
         SPACE                                                          23187503
         XI    CRCAFLG1,CRCADIAG   INDICATE NO DIAG            @Y30CQLG 23188003
         SPACE                                                          23189003
         BR    RETREG              RETURN                      @Y30CQLG 23200003
         SPACE                                                          23203003
         DROP  REG11                                           @Y30CQLG 23206003
         DROP  WKREG6                                          @Y30CQLG 23212003
         TITLE 'IECIHIO - FUNCTIONAL RECOVERY ROUTINE'                  23218003
*                                                                       23224003
*****************************************************************       23230003
*        THE HALT I/O SUBROUTINE FUNCTIONAL RECOVERY ROUTINE.           23236003
*****************************************************************       23242003
*                                                                       23250002
         USING SDWA,CNTREG                                              23260002
HIOFRR   BALR  BASEREG,0               SET TEMPORARY BASE               23300002
         USING *,BASEREG                                                23310002
         L     BASEREG,HIOADDR         COMMON CSECT BASE                23320002
         USING IECIHIO,BASEREG                                          23330002
         LR    CNTREG,REG1             TRANSFER SDWA ADDRESS            23340002
         LR    CNTREG1,RETREG          SAVE RTM RETURN ADDRESS          23340102
         L     FRREG,SDWAPARM          GET FRR WORKAREA                 23340402
         L     UCBREG,FRRUCB           GET UCB PTR             @OZ01912 23340503
         SPACE                                                          23340703
         BAL   RETREG,HIOCK4           CHECK IF CRH            @Y30CQLG 23340803
         SPACE                                                          23340903
         CLI   SDWACMPC,COD            IECIHIO ISSUE SVC D              23341003
         BE    HIOR200                 BRANCH YES, SHOULDER TAP ABEND   23341202
         BAL   WKREG4,HIOFUCB          GO GET ADDRESS OF UCBLOCK        23342002
         SPACE 1                                                        23344002
*   GET THE UCBLOCK IN CASE HIO GAVE IT UP                              23346002
         SPACE 1                                                        23348002
         SETLOCK OBTAIN,TYPE=IOSUCB,MODE=UNCOND,                       *23348402
               ADDR=(11),RELATED=(UCB,HIOFRR)                           23348802
         L     WKREG4,FRRPSW           LOAD SAVED IONPSW                23349202
         LTR   WKREG4,WKREG4           WAS IT SAVED                     23349602
         BZ    HIOR100                 BRANCH NO                        23349702
         ST    WKREG4,FLCINPSW+FOUR    YES,RESTORE IT                   23349802
         LCTL  IOCTL,IOCTL,FRRCTL1     RESTORE CONTROL REG 2            23349902
         SPACE 1                                                        23366602
*   ISSUE ASYNCHRONOUS SVC DUMP IF BUFFER AVAILABLE                     23376602
         SPACE 1                                                        23378602
HIOR100  LA    REG15,LO8               INSURE AN SDUMP RETURN CODE      23380602
         L     WKREG4,CVTPTR           CVT ADDRESS                      23382602
         USING CVT,WKREG4                                               23383002
         L     WKREG5,CVTSDBF          BUFFER ADDRESS                   23383102
         LTR   REG0,WKREG5             IS IT AVAILABLE                  23383202
         BNP   HIOR120                 BRANCH NO                        23388802
         O     REG0,HION               'OR' IN LOCK BIT                 23390802
         CS    WKREG5,REG0,CVTSDBF     COMPARE/SWAP ON BUFFER           23392802
         BNE   HIOR120                 BRANCH IF CAN'T GET IT           23393202
         DROP  WKREG4                                                   23393602
         USING SDBUF,WKREG5                                             23394002
         LA    WKREG4,SDBDATA          BUFFER DATA ADDRESS              23394102
         ST    WKREG4,SDBDATAD         STORE IT FOR SDUMP               23394202
         LA    WKREG4,SDBDL            DATA LENGTH                      23394302
         STH   WKREG4,SDBDLN           SDUMP NEEDS IT TOO               23408202
         MVC   SDBUCB,UCBPXST          MOVE UCB TO BUFFER               23418202
         LA    SAVEREG,SDWAVRA         GIVE SDUMP A SAVE AREA           23420202
         XC    SDBLAST,SDBLAST         ZERO END OF ENTRIES IND.         23420302
         DROP  WKREG5                                                   23420602
         L     WKREG4,PSAAOLD          GET CURRENT ASID                 23421002
         LH    WKREG4,ASCBASID-ASCB(WKREG4) * AND PASS IT TO SDUMP      23421402
*****                                                                   23421802
*   INVOKE DUMP                                                         23421902
*****                                                                   23422002
         SDUMP HDR='IOS-IECIHIO ERROR',ASID=(WKREG4),                  *23426702
               SDATA=(PSA,TRT),                                        *23428702
               BUFFER=YES,                                             *23430702
               BRANCH=YES,                                             *23431102
               LIST=HIOADDR                                             23431202
         SPACE 1                                                        23431302
HIOR120  STC   REG15,SDWAVRA           SAVE SDUMP RETURN CODE           23431402
         MVC   SDWAMODN,HIONAME        MODULE NAME TO SDWA              23436002
         MVI   SDWAURAL,SDBDL+ONE      LENGTH OF DATA                   23440002
         MVC   SDWAVRA+ONE(SDBDL),UCBPXST MOVE UCB TO SDWA              23440402
         TM    FRRFLA,FRRIOS+FRRCCH+FRRSHTP WAS CONTROL IN IOS,         23440502
         BNZ   HIOR170                 * CCH,OR SHOULDER TAPPED         23440602
*                                      * CPU - BRANCH YES               23440702
*   PERCOLATE TO CALLER'S RECOVERY ROUTINE                              23452502
*                                                                       23462502
HIOR130  SETRP RECORD=YES,RC=0,WKAREA=(CNTREG)                          23464502
         NC    UCBSFLS(TWO),ACTIVOFF   RESET UCB STATUS FLAGS           23470402
         BR    CNTREG1                 RETURN TO RTM                    23472402
         SPACE 1                                                        23476302
*   DETERMINE IF RETRY POSSIBLE                                         23478302
         SPACE 1                                                        23480302
HIOR170  TM    FRRFLA,FRRSHTP          IF IN SHOULDER TAPPED CPU,       23484202
         BO    HIOR190                 * RETRY TO EXIT WITH RC=12       23486202
         TM    FRRFLA,FRRECURS         PERCOLATE IF RETRY               23488202
         BO    HIOR130                 * RECURSION - BRANCH YES         23498502
         TM    SDWAERRC,SDWAPERC       THIS FRR PERCOLATED TO           23508502
         BZ    HIOR130                 BRANCH NO - PERCOLATE            23508602
         XC    SDWASR02(SDWASR11-SDWASR02),SDWASR02                     23508702
         STM   UCBREG,FRREG,SDWASR07   SET RETRY REGISTERS              23512102
         LA    REG0,HIOHIO             RETRY ADDRESS                    23514102
         SPACE 1                                                        23514502
HIOR180  SETRP RETADDR=(0),            *                               *23514902
               RETREGS=YES,            * RETRY THE HDV                 *23515302
               RECORD=YES,             * SEQUENCE                      *23515402
               RC=4,                   *                               *23515502
               WKAREA=(CNTREG)         *                                23515602
         BR    CNTREG1                 RETURN TO RTM                    23521002
         SPACE 1                                                        23521402
*   FAILURE IN SHOULDER TAPPED CPU - GO BACK TO CALLING CPU             23521802
*   WITH RETURN CODE 12 AND ABEND CODE                                  23522202
         SPACE 1                                                        23522302
HIOR190  STM   UCBREG,FRREG,SDWASR07   RETRY REGISTERS                  23522502
         LA    REG0,HIORTRN            RETRY ADDRESS                    23525902
         MVC   SDWASR14,FRRIPCR        INSURE REG14 VALID               23527902
         MVI   FRRLOP,IPCTERM          SET RETURN CODE OF 12            23528302
         MVC   FRRIPCR,SDWAABCC        MOVE COMPLETION CODE TO          23528702
*                                      * FRR WORKAREA                   23529102
         B     HIOR180                 GO SETRP                         23529202
         SPACE 1                                                        23529302
HIOR200  MVC   SDWAABCC,FRRIPCR        SET ORIGINAL INTERUPT CODE       23529402
         LA    REG15,IPCTERM           SHOW SHOULDER TAP ABEND          23532802
*                                      * IN SDWA                        23534802
         B     HIOR120                 SET RECORDING AREA FOR PERC.     23535202
         TITLE 'IECIHIO - MULTIPLE EXPOSURE LOCK LOCATION'              23536402
*                                                                       23539802
*****************************************************************       23543202
*        THIS ROUTINE GETS THE ADDRESS OF THE LOCK IN THE BASE          23546602
*        EXPOSURE FOR MULTIPLE EXPOSURE DEVICES.                        23550002
*****************************************************************       23600002
*                                                                       23650002
HIOFUCB  LA    REG11,UCBLOCK           ADDRESS OF UCB LOCK              23700002
         TM    UCBWGT,UCBMTPXP         MULTIPLE EXPOSURE DEVICE         23750002
         BZR   WKREG4                  BRANCH YES                       23800002
         L     SAVEREG,UCBBASE         GO BACK TO BASE UCB              23850002
         LA    REG11,UCBLOCK-UCB(SAVEREG) USE LOCK OF BASE UCB          23900002
         BR    WKREG4                  RETURN                           23950002
         TITLE 'IECIHIO - CONSTANTS AND MISCELANEOUS DATA'              24050002
*                                                                       24100002
*****************************************************************       24150002
*        CONSTANTS AND EXECUTES                                         24200002
*****************************************************************       24250002
*                                                                       24300002
EXSTOSM  STOSM FRRSYSMK,ZERO           EXECUTED TO RESTORE MASK         24302002
         DS    0F                                                       24310002
SYSDISM  DC    X'000000FD'             DISABLE I/O INT MASK             24320002
HIOPSW   DS    0D                                                       24350002
         DC    A(IECHK5)               SECOND HALF                      24400002
ADCCH    DC    V(IGFCCHCR)             CCH EP ADDR                      24450002
ADIECINT DC    V(IECINT)               IECINT EP ADDR                   24500002
***************************************************************         24502002
HIOADDR  DC    A(IECIHIO)              CSECT ENTRY POINT                24510002
         DC    X'80'                   LAST ENTRY INDICATOR             24520002
         DC    AL3(IECIEND)            END OF CSECT                     24530002
***************************************************************         24532002
HIONAME  DC    CL8'IECIHIO '           MODULE NAME                      24540002
HION     DC    X'80000000'             -0                               24550002
NONRTY   DC    X'80000021'             EQUIP CK, OPER INTV,             24600002
*                                      RECIV CK BITS IN STATUS          24650002
HWD8     DC    H'8'                    RETURN CODE COMPARE              24700002
ACTIVOFF DC    X'499F'                 BSY,PST,ACTV,SACTV OFF           24750002
*                                      PSNS,SAP,SPST OFF                24800002
CHAN6    DC    X'06'                   FOR CINTER CHANNEL 6    @Y30CQLG 24810003
HIOPATCH DC    ((*-IECIHIO)/20)X'00'   PATCH AREA              @YM05573 24820002
IECIEND  EQU   *                       END OF IECIHIO                   24850002
         EJECT                                                          24900002
         TITLE 'IECIHIO - FRRAREA DSECT'                                25000002
FRRAREA  DSECT                                                          25050002
FRRSAVE  DS    F                       REG 13 SAVE                      25100002
FRRUCB   DS    F                       UCB REG SAVE                     25150002
FRRBYTES DS    0F                      FOUR BYTES                       25200002
FRRLOP   DS    CL1                     IPC RETURN CODE                  25250002
FRRSYSMK DS    CL1                     SYS MASK STORE                   25300002
FRRFLA   DS    XL1                     FLAG BYTE                        25350002
FRRSHTP  EQU   X'80'                   SHOULDER TAP CODE ACTIVE         25360002
FRRIOS   EQU   X'40'                   IOS ENTERED AND ACTIVE           25370002
FRRCCH   EQU   X'20'                   CCH ENTERED AND ACTIVE           25380002
FRRECURS EQU   X'10'                   RETRY RECURSION                  25390002
FRRBACK  EQU   X'08'          TO INDICATE BACKOUT EG CU BZY    @OZ00762 25391003
         DS    XL1                     RESERVED                         25392002
FRRCTL1  DS    F                       SAVE FOR I/O CTL REG             25400002
FRRIPCR  EQU   *                       FRRCTL2 USED FOR IPC RTN         25410002
*                                      * ADDRESS WHEN IN SHOULDER       25420002
*                                      * MODE                           25430002
FRRCTL2  DS    F                       BUILD TEMP I/O CTL REG           25450002
FRRPSW   DS    F                       I/O PSW ADDRESS                  25500002
*                                                                       25510002
         TITLE 'IECIHIO - ASCB DSECT'                                   25520002
         IHAASCB                                                        25530002
*                                                                       25550002
         TITLE 'IECIHIO - FRRS DSECT'                                   25600002
         IHAFRRS                                                        25650002
*                                                                       25700002
         TITLE 'IECIHIO - SAVE-WORK AREA DSECT'                         25750002
         IHAWSAVT CLASS=CPU,DSECT=YES                                   25800002
*                                                                       25850002
         TITLE 'IECIHIO - UCB DSECT'                                    25900002
         IEFUCBOB PREFIX=YES,LIST=YES                                   25950002
*                                                                       26000002
         TITLE 'IECIHIO - CVT DSECT'                                    26050002
         CVT   DSECT=YES,LIST=NO                                        26100002
*                                                                       26150002
         TITLE 'IECIHIO - LCCA DSECT'                                   26200002
         IHALCCA                                                        26250002
*                                                                       26300002
         TITLE 'IECIHIO - IRT DSECT'                                    26350002
         IECDIRT                                                        26400002
*                                                                       26450002
         TITLE 'IECIHIO - PCCA DSECT'                                   26500002
         IHAPCCA                                                        26550002
*                                                                       26600002
         TITLE 'IECIHIO - PSA DSECT'                                    26650002
         IHAPSA                                                         26700002
*                                                                       26750002
         TITLE 'IECIHIO - SDWA DSECT'                                   26760002
         IHASDWA                                                        26770002
*                                                                       26780002
         TITLE 'IECIHIO - SDUMP BUFFER DSECT'                           26790002
SDBUF    DSECT                                                          26792002
SDBDATAD DS    A                       DATA ADDRESS                     26794002
SDBDLN   DS    H                       DATA LENGTH                      26796002
SDBDATA  EQU   *                       DATA BEGINNING                   26798002
SDBUCB   DS    XL(UCBCURPX+(UCBBASE-UCBOB)) UCB                         26798402
SDBDL    EQU   *-SDBDATA               LENGTH OF DATA                   26798802
SDBLAST  DS    XL6                     END OF ENTRIES INDICATOR         26799202
         EJECT                                                          26799303
         TITLE 'CRCA DSECT'                                             26799403
         IECDCRCA                                              @Y30CQLG 26799603
         END                                                            26800002
