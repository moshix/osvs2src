         TITLE 'IECIOSCN - INPUT/OUTPUT SUPERVISOR'                     00010002
*****************************************************************       00020002
*                                                               *       00030002
* MODULE NAME = IECIOSAM                                        *       00040002
*                                                               *       00050002
* DESCRIPTIVE NAME = INPUT/OUTPUT SUPERVISOR                    *       00060002
*                                                               *       00065002
* COPYRIGHT = NONE                                              *       00080002
*                                                               *       00082002
* STATUS = CHANGE LEVEL 00         OCTOBER 18, 1974             *       00092003
*                                                               *       00102002
* FUNCTION = 1. MANAGE I/O ACTIVITY BY:                         *       00120002
*                A. STARTING NEW I/O REQUESTS                   *       00130002
*                B. HANDLING INTERRUPTS                         *       00140002
*                C. RESTARTING QUEUED I/O REQUESTS              *       00150002
*            2. PROVIDE A SINGLE DISABLED EXIT (DIE) FOR USE    *       00160002
*                BY THE CALLERS OF IOS                          *       00170002
*            3. SUPPORT THE ERP'S (ERROR RECOVERY PROCEDURES)   *       00180002
*                THAT ARE PROVIDED                              *       00190002
**                                                             **       00200002
* NOTES = NONE                                                  *       00210002
*                                                               *       00220002
*    DEPENDENCIES = NONE                                        *       00230002
*                                                               *       00240002
*    RESTRICTIONS = NONE                                        *       00250002
*                                                               *       00260002
*    REGISTER CONVENTIONS = SEE EQUATES                         *       00266002
*                                                               *       00272002
*    PATCH LABEL = IOSPATCH                                     *       00290002
*                                                               *       00300002
* MODULE TYPE = I/O CONTROL                                     *       00301002
*                                                               *       00310002
*    PROCESSOR = ASSEMBLER F                                    *       00320002
*                                                               *       00330002
*    MODULE SIZE = 11384 DECIMAL BYTES                          *       00340002
*                                                               *       00350002
*    ATTRIBUTES = DISABLED, KEY 0, SUPERVISOR STATE, RESIDENT   *       00370002
*                                                               *       00375002
* ENTRY POINTS = IECVSTIO - FROM THE STARTIO MACRO              *       00380002
*                IECHNSCH - FROM THE SRB DISPATCHER             *       00390002
*                IECINT   - FROM THE I/O FLIH                   *       00400002
*                IECIPC   - FROM INTER PROCESSOR COMM.          *       00410002
*                IECFRR   - FROM RTM                            *       00430002
*                                                               *       00435002
*    PURPOSE = SEE FUNCTION                                     *       00440002
*                                                               *       00450002
*    LINKAGE = REGISTER 14 RETURN ADDRESS                       *       00470002
*              REGISTER 15 ENTRY ADDRESS                        *       00475002
*                                                               *       00480002
*    INPUT = IECVSTIO -                                         *       00490002
*         REGISTER  0 = TCB PARAMETER                           *       00500002
*                   1 = SRB PARAMETER                           *       00510002
*                  14 = RETURN ADDRESS                          *       00520002
*                  15 = ADDRESS OF IECVSTIO                     *       00530002
*                                                               *       00550002
*            IECHNSCH -                                         *       00552002
*         REGISTER  0 = SRB ADDRESS                             *       00560002
*                   1 = IOSB ADDRESS                            *       00570002
*                  14 = RETURN ADDRESS                          *       00580002
*                  15 = ADDRESS OF IECHNSCH                     *       00590002
*                                                               *       00600002
*            IECINT -                                           *       00620002
*         REGISTER  4 = RETURN ADDRESS                          *       00620602
*                   5 = ADDRESS OF IECINT                       *       00630802
*                                                               *       00640702
*            IECIPC -                                           *       00649702
*         REGISTER 14 = RETURN ADDRESS                          *       00658702
*                                                               *       00667702
*            IECFRR -                                           *       00676702
*         REGISTER 1 = SDWA ADDRESS                             *       00685741
*                  14 = RTM RETURN ADDRESS                      *       00694702
*                                                               *       00703702
*                IECDVOID                                       *       00712702
*                IECDSIAB                                       *       00721702
*                IECDIOCX                                       *       00730702
*                IECDATB                                        *       00739702
*                IECDLCH                                        *       00748702
*                                                               *       00757702
*    OUTPUT = NONE                                              *       00766702
*                                                               *       00775702
*    EXIT-NORMAL = RETURN TO CALLER                             *       00810002
*                                                               *       00815002
*    EXIT-ERROR = NONE                                          *       00830002
*                                                               *       00835002
* EXTERNAL REFERENCES =                                         *       00850002
*                                                               *       00855002
*    ROUTINES = IECVSMGR                                        *       00870002
*                                                               *       00875002
*    DATA SETS = NONE                                           *       00890002
*                                                               *       00895002
*    DATA AREAS = NONE                                          *       00910002
*                                                               *       00915002
* TABLES = IRT                                                  *       00930002
*                                                               *       00935002
* MACROS = SCHEDULE,SETLOCK,SETRP,HOOK,TRAS,SETFRR,SDUMP        *       00950041
*                                                               *       00955002
* CHANGE ACTIVITY = NONE                                        *       00970002
*D310400,310480                                                @ZA02102 00980003
*****************************************************************       00990002
         TITLE 'IECIOSCN - IOS - IPIB DSECT'                            00995002
         IECDIPIB                                                       01000002
         TITLE 'IECIOSCN - IOS - FRR DSECT'                             01010002
         IHAFRRS                                                        01020002
         TITLE 'IECIOSCN - IOS - CRCA DSECT'                            01023003
         IECDCRCA                                                       01026003
         TITLE 'IECIOSCN - IOS - COMMON SYSTEM DATA AREA DSECT'         01030002
         IHACSD                                                         01040002
         TITLE 'IECIOSCN - IOS - SAVE AREA VECTOR TABLE'                01050002
         IHAWSAVT CLASS=CPU,DSECT=YES                                   01060002
         TITLE 'IECIOSCN - IOS - IOSB DSECT'                            01070002
         IECDIOSB                                                       01080002
         TITLE 'IECIOSCN - IOS - UCB DSECT'                             01090002
         IEFUCBOB PREFIX=YES,LIST=YES                                   01100002
         TITLE 'IECIOSCN - IOS - ERP WORK AREA DSECT'                   01110002
         IECDERWA                                                       01120002
         TITLE 'IECIOSCN - IOS - IOS QUEUE ELEMENT DSECT'               01140002
         IECDIOQ                                                        01140102
         TITLE 'IECIOSCN - IOS - CVT DSECT'                             01152102
         CVT     DSECT=YES                                              01167802
         TITLE 'IECIOSCN - IOS - LCCA DSECT'                            01175902
         IHALCCA                                                        01181902
         TITLE 'IECIOSCN - IOS - IRT DSECT'                             01191802
         IECDIRT                                                        01210002
         TITLE 'IECIOSCN - IOS - SRB DSECT'                             01215002
         IHASRB                                                         01230002
         TITLE 'IECIOSCN - IOS - PCCA DSECT'                            01235002
         IHAPCCA                                                        01250002
         TITLE 'IECIOSCN - IOS - CAT TABLE DSECT'                       01255002
         IECDCAT                                                        01270002
         TITLE 'IECIOSCN - IOS - ASCB VECTOR TABLE'                     01275002
         IHAASVT                                                        01290002
         TITLE 'IECIOSCN - IOS - ASCB DSECT'                            01295002
         IHAASCB                                                        01310002
         TITLE 'IECIOSCN - SDWA DSECT'                                  01315002
         IHASDWA                                                        01320002
         TITLE 'IECIOSCN - VARIABLE RECORDING AREA MAPPING'             01330002
****************************************************************        01340002
*                                                              *        01350002
*        THIS SECTION MAPS THE VARIABLE RECORDING AREA         *        01360002
*        OF THE SDWA AS USED BY IECIOSAM                       *        01370002
*                                                              *        01380002
*****************************************************************       01390002
         SPACE 1                                                        01400002
         ORG   SDWAVRA                                                  01410002
VRECORD  DS    0F                                                       01420002
VRECIND  DS    X                   VALID DATA INDICATORS                01430002
VRECIOQV EQU   X'80'               IOQ HAS BEEN INSERTED                01440002
VRECUCBV EQU   X'40'               UCB HAS BEEN INSERTED                01450002
*        EQU   X'3F'               RESERVED                             01460002
VRECDURC DS    X                   SVC DUMP RETURN CODE                 01470002
VRECDRCI EQU   X'FF'               INITIALIZATION CONSTANT FOR          01480002
*                                  *VRECDURC TO INDICATE THAT AN        01490002
*                                  *SDUMP WAS NOT TAKEN                 01500002
         DS    XL2                 RESERVED                             01510002
VRECIOQ  DS    XL(IOQL)            IOQ AREA                             01520002
VRECUCBP DS    XL(UCBCURPX)        UCB PREFIX AREA                      01530002
VRECUCBB DS    XL(UCBDEV-UCBOB)    UCB BASE AREA                        01540002
VRECUSE  EQU   *-VRECORD           LENGTH OF VARIABLE RECORDING         01550002
*                                  *AREA USED FOR RECORDING             01560002
         ORG   VRECUCBP            ORG BACK TO UCB PREFIX AREA          01570002
VRECSAVE DS    XL(72)              REGISTER SAVE AREA FOR               01580002
*                                  *BRANCH ENTRY TO SDUMP               01590002
*                                  *(USED BEFORE UCB IS MOVED           01600002
*                                  *INTO THE AREA)                      01610002
         TITLE 'IECIOSCN - FRR PARAMETER AREA DSECT'                    01630002
****************************************************************        01635002
*                                                              *        01650002
*        THIS DSECT DESCRIBES IECIOSAM'S USAGE OF THE          *        01655041
*        FRR PARAMETER AREA                                    *        01670002
*                                                              *        01675002
****************************************************************        01690002
         SPACE 1                                                        01695002
FRRPARM  DSECT                                                          01700002
FRR1STA  DS    A                   POINTER TO FIRST LEVEL FRR           01713202
*                                  *PARAMETER AREA OR 0                 01730002
FRRFLA   DS    X                   INDICATORS                  @ZA27189 01733341
FRRIOS   EQU   X'80'               INDICATOR TO QVA EXIT RTN   @ZA27189 01734341
*                                  *THAT IT HAS BEEN CALLED    @ZA27189 01735341
*                                  *FOR LCH VERIFICATION       @ZA27189 01736341
FRRREC   EQU   X'40'               IF ON AT ENTRY TO FRR RRN   @ZA27189 01737341
*                                  *THEN A RECURSIVE ERROR HAS @ZA27189 01738341
*                                  *OCCURED                    @ZA27189 01739341
FRR2ND   EQU   X'20'               THIS A SECOND LEVEL FRR     @ZA27189 01740341
*                                  *PARAMETER AREA             @ZA27189 01741341
FRRDMPB  EQU   X'10'               SVC DUMP BUFFER HAS BEEN    @ZA27189 01742341
*                                  *RESERVED BUT CALL OF SDUMP @ZA27189 01743341
*                                  *HAS NOT YET BEEN DONE      @ZA27189 01744341
         DS    AL3                 RESERVED                    @ZA27189 01745341
FRRNO1   DS    F                   DON'T USE - THIS FRR AREA   @ZA27189 01746341
*                                  *IS PASSED TO THE STORAGE            01750002
*                                  *MANAGER FRR IN CERTAIN              01760002
*                                  *ERROR CASES AND THIS FIELD          01770002
*                                  *IS RESERVED FOR IT'S USE            01780002
*                                  *AND MUST NOT BE USED BY             01790002
*                                  *IECIOSAM                            01800002
FRRDUMPA DS    F                   CONTENTS OF REGISTER SWAPPED         01940002
*                                  *INTO CVTSDBF FIELD VIA CS           01950002
*                                  *INSTRUCTION                         01960002
FRRNO2   DS    X                   DON'T USE FOR SAME REASON AS         01970002
*                                  *FIELD FRRNO1 ABOVE                  01980002
FRRRET   DS    AL3                 RTM RETURN ADDRESS                   01990002
FRRSAVR0 DS    F                   SAVE AREA FOR FRR 200 BYTE           02000002
*                                  WORK AREA ADDRESS                    02010002
FRRLEN   EQU   *-FRRPARM           LENGTH OF FRR PARAMETER AREA         02020002
         TITLE 'IECIOSCN - QVPL DSECT'                                  02030002
****************************************************************        02040002
*        THE FOLLOWING IS THE DSECT OF THE 200 BYTE WORK AREA           02050002
*        PASSED BY RTM. IT IS USED AS THE PARAMATER AND SAVE AREAS      02060002
*        WHICH ARE PASSED TO THE QUEUE VERIFICATION ROUTINE.            02070002
****************************************************************        02080002
         IHAQVPL                                                        02090002
         SPACE 5                                                        02100002
QVWORKS  DS    XL(QVPLWASZ)        WORK AREA FOR QVA                    02110002
QVSAVE   DS    18F                 SAVE AREA FOR CALLED ROUTINES        02120002
QFRRSDWA DS    F                   SDWA BACK POINTER                    02130002
***                                                           ***       02140002
***      REMAINDER OF WORK AREA UNUSED                        ***       02150002
***                                                           ***       02160002
         TITLE 'IECIOSCN - IOS - PSA DSECT'                             02170002
         IHAPSA                                                         02180002
         TITLE 'IECIOSCN - IOS - DSECT OF THE CSW'                      02190002
****************************************************************        02200002
*                                                              *        02210002
*              THIS DESCRIBES THE FIELDS USED IN THE CSW       *        02220002
*                                                              *        02230002
****************************************************************        02240002
         ORG   FLCCSW              POSITION AT THE CSW                  02260002
CSWFLAGS DS    C                   FLAG BYTE                            02270002
CSWKEY   EQU   X'F0'               KEY USED IN OPERATION                02280002
CSWRES   EQU   X'08'               RESERVED                             02290002
CSWLOP   EQU   X'04'               CHANNEL LOGOUT PENDING               02300002
CSWDCC   EQU   X'03'               DEFERRED CONDITION CODE              02310002
         SPACE 1                                                        02320002
CSWCCWAD DS    AL3                 CCW ADDRESS                          02330002
         SPACE 1                                                        02340002
CSWSTATS DS    0H                  STATUS BYTES                         02350002
CSWUNST  DS    C                   UNIT STATUS BYTE                     02360002
CSWATTEN EQU   X'80'               ATTENTION                            02370002
CSWSTMOD EQU   X'40'               STATUS MODIFIER                      02380002
CSWCUE   EQU   X'20'               CONTROL UNIT END                     02390002
CSWBSY   EQU   X'10'               BUSY                                 02400002
CSWCE    EQU   X'08'               CHANNEL END                          02410002
CSWDE    EQU   X'04'               DEVICE END                           02420002
CSWUCK   EQU   X'02'               UNIT CHECK                           02430002
CSWUEX   EQU   X'01'               UNIT EXECPTION                       02440002
         SPACE 1                                                        02450002
CSWCHST  DS    C                   CHANNEL STATUS BYTE                  02460002
CSWPCI   EQU   X'80'               PROGRAM-CONTROLLED INTERRUPT         02470002
CSWILN   EQU   X'40'               INCORRECT LENGTH                     02480002
CSWPGMCK EQU   X'20'               PROGRAM CHECK                        02490002
CSWPRCK  EQU   X'10'               PROTECTION CHECK                     02500002
CSWCDCK  EQU   X'08'               CHANNEL DATA CHECK                   02510002
CSWCCCK  EQU   X'04'               CHANNEL CONTROL CHECK                02520002
CSWICCK  EQU   X'02'               CHANNEL INTERFACE CHECK              02530002
CSWCCK   EQU   X'01'               CHAINING CHECK                       02540002
         SPACE 1                                                        02549002
CSWRCNT  DS    H                   RESIDUAL CHECK                       02558002
***                                                          ***        02567002
*              COMBINED EQUATES                                *        02576002
***                                                          ***        02585002
CSWPCAT  EQU   CSWPCI+CSWCDCK+CSWCCCK+CSWICCK                           02594002
*                                  PCI, CHANNEL DATA, CHANNEL           02603002
*                                  *CONTROL AND INTERFACE CONTRL        02612002
CSWATUCK EQU   CSWATTEN+CSWUCK     ATTENTION AND UNIT CHECK             02621002
CSWCAT   EQU   CSWCDCK+CSWCCCK+CSWICCK                                  02630002
*                                  CHANNEL DATA, CHANNEL CONTROL        02639002
*                                  *OR INTERFACE CONTROL CHECK          02648002
CSWITF   EQU   CSWUCK+CSWUEX       UNIT CHECK AND UNIT EXCEPTION        02657002
         TITLE 'IECIOSCN - IOS - VOID DSECT'                            02666002
         IECDVOID                                                       02690002
         TITLE 'IECIOSCN - IOS - ATTENTION TABLE DSECT'                 02695002
         IECDATB                                                        02710002
         TITLE 'IECIOSCN - IOS - SRB-IOSB ALLOCATION BLOCK DSECT'       02715002
         IECDSIAB                                                       02730002
         TITLE 'IECIOSCN - IOS - LCH TABLE DSECT'                       02735002
         IECDLCH                                                        02750002
         TITLE 'IECIOSCN - DUMP BUFFER DSECT'                           02756002
****************************************************************        02762002
*                                                              *        02770002
*        THIS DSECT DESCRIBES IECIOSAM'S USAGE OF THE          *        02780002
*        SVC DUMP BUFFER                                       *        02790002
*                                                              *        02800002
****************************************************************        02810002
         SPACE 1                                                        02820002
DUMPBUF  DSECT                                                          02830002
DUMPDAT1 DS    XL4                 ADDRESS OF DATA AREA 1 IN            02840002
*                                  *BUFFER                              02850002
DUMPLEN1 DS    XL2                 LENGTH OF DATA IN DATA AREA 1        02870002
DUMPIND1 DS    X                   VALID DATA INDICATORS                02875002
DUMPIRTV EQU   X'80'               IRT HAS BEEN INSERTED                02880002
DUMPUCBV EQU   X'40'               UCB HAS BEEN INSERTED                02890002
DUMPIOQV EQU   X'20'               IOQ HAS BEEN INSERTED                02900002
DUMPIOSV EQU   X'10'               IOSB HAS BEEN INSERTED               02910002
DUMPLCHV EQU   X'08'               LCH, 12 BYTE BLOCK HEADER AND        02920002
*                                  *FIRST 2K 12 BYTE BLOCK PAGE         02930002
*                                  *HAVE BEEN INSERTED                  02940002
*        EQU   X'07'               RESERVED                             02950002
         DS    X                   RESERVED                             02960002
DUMPIRT  DS    XL(IRTEL)           IRT AREA                             02970002
DUMPUCBP DS    XL(UCBCURPX)        UCB PREFIX AREA                      02980002
DUMPUCBB DS    XL(UCBDEV-UCBOB)    UCB BASE AREA                        02990002
DUMPIOQ  DS    XL(IOQL)            IOQ AREA                             03000002
DUMPIOSB DS    XL(IOSEND-IOSB)     IOSB AREA                            03010002
DUMPLCHH DS    XL(LCHEL)           LCH HEADER AREA                      03020002
DUMP12BH DS    XL(16)              STORAGE MANAGER 12 BYTE BLOCK        03030002
*                                  *HEADER AREA                         03040002
DUMP12PG DS    XL(2048)            FIRST PAGE OF STORAGE MANAGER        03050002
*                                  *12 BYTE BLOCK POOL                  03060002
DUMPU1   EQU   *-DUMPIND1          ACTUAL NUMBER OF BYTES USED          03070002
*                                  *IN DATA AREA 1                      03080002
DUMPEND  DS    XL6                 SIX BYTES OF 0'S TO INDICATE         03090002
*                                  *LAST USED AREA OF DUMP              03100002
*                                  *BUFFER                              03120002
DUMPLEN  EQU   *-DUMPBUF           TOTAL LENGTH OF DUMP BUFFER          03125002
*                                  *REFERENCED BY IECIOSAM              03130002
         TITLE 'IECIOSCN - IOS - IOCOMEX DSECT'                         03140002
         IECDIOCX                                                       03150002
         TITLE 'IECIOSCN - IOS - SAVE AREA DSECT'                       03160002
****************************************************************        03170002
*                                                              *        03190002
*              THIS DSECT DESCRIBES THE USE OF THE 16 WORD     *        03196002
*              SAVE AREA IN THE LCCA.                          *        03210002
*                                                              *        03220002
****************************************************************        03230002
SAVEAREA DSECT                                                          03235002
SVAREA00 DS    0D                  BEGINING OF SAVE AREA                03250002
***                                                          ***        03260002
*              SAVE AREA FOR ESMINTF1, ESMINTF3, ESMINTG1      *        03270002
*              AND ESMINTG3                                    *        03280002
***                                                          ***        03290002
         DS    14F                 USED TO INTERFACE WITH THE           03297002
*                                  *IOS STORAGE MANAGER                 03304002
SVAREA05 DS    F                   REGISTER SAVE AREA                   03320002
SVAREA06 DS    F                   REGISTER SAVE AREA                   03326002
         TITLE 'IECIOSCN -  IOS - IOS CHANNEL PROGRAM AREA'             03332002
ICPA     DSECT                                                          03350002
****************************************************************        03357002
*                                                              *        03364002
*              THIS IS A DESCRIPTION OF THE IOS CHANNEL PROGRAM*        03380002
*              AREA THAT IS PROVIDED AND THE EQUATES USED TO   *        03390002
*              FILL IN THIS AREA.                              *        03400002
*                                                              *        03410002
****************************************************************        03420002
IN1FSTHF DS    0F                  FIRST HALF OF FIRST CCW              03430002
IN1CC    DS    X                   COMMAND CODE OF FIRST CCW            03440002
IN1DA    DS    AL3                 DATA ADDRESS OF FIRST CCW            03450002
IN1SNDHF DS    0F                  SECOND HALF OF FIRST CCW             03460002
IN1FLS   DS    X                   FLAGS IN FIRST CCW                   03469002
         DS    X                   RESERVED                             03478002
IN1CNT   DS    H                   COUNT FIELD IN FIRST CCW             03487002
         SPACE 2                                                        03496002
IN2FSTHF DS    0F                  FIRST HALF OF SECOND CCW             03505002
IN2CC    DS    X                   COMMAND CODE OF SECOND CCW           03514002
IN2DA    DS    AL3                 DATA ADDRESS OF SECOND CCW           03523002
IN2SNDHF DS    0F                  SECOND HALF OF SECOND CCW            03532002
IN2FLS   DS    X                   FLAGS IN SECOND CCW                  03541002
         DS    X                   RESERVED                             03550002
IN2CNT   DS    H                   COUNT FIELD IN SECOND CCW            03559002
         SPACE 2                                                        03572002
IN3FSTHF DS    0F                  FIRST HALF OF THIRD CCW              03590002
IN3CC    DS    X                   COMMAND CODE OF THIRD CCW            03600002
IN3DA    DS    AL3                 DATA ADDRESS OF THIRD CCW            03610002
IN3SNDHF DS    0F                  SECOND HALF OF THIRD CCW             03620002
IN3FLS   DS    X                   FLAGS IN THIRD CCW                   03630002
         DS    X                   RESERVED                             03640002
IN3CNT   DS    H                   COUNT FIELD IN THIRD CCW             03650002
         SPACE 2                                                        03660002
IN4FSTHF DS    0F                  FIRST HALF OF FOURTH CCW             03670002
IN4CC    DS    X                   COMMAND CODE OF FOURTH CCW           03680002
IN4DA    DS    AL3                 DATA ADDRESS OF FOURTH CCW           03690002
IN4SNDHF DS    0F                  SECOND HALF OF FOURTH CCW            03700002
IN4FLS   DS    X                   FLAGS IN FOURTH CCW                  03710002
         DS    X                   RESERVED                             03711002
IN4CNT   DS    H                   COUNT FIELD IN FOURTH CCW            03721002
***                                                          ***        03731002
*              EQUATES FOR THIS AREA                           *        03741002
***                                                          ***        03751002
SNSCC    EQU   X'04'               SENSE COMMAND CODE                   03761002
SEEKCC   EQU   X'07'               SEEK COMMAND CODE                    03771002
TICCC    EQU   X'08'               TIC COMMAND CODE                     03781002
RHACC    EQU   X'1A'               READ HOME ADDRESS COMMAND            03791002
RRZCC    EQU   X'16'               READ RECORD 0 COMMAND CODE           03801002
TIECC    EQU   X'1B'               TRACK IN ERROR COMMAND CODE          03811002
SFMCC    EQU   X'1F'               SET FILE MASK COMMAND CODE           03821002
RLSCC    EQU   X'94'               RELEASE COMMAND CODE                 03831002
RESVCC   EQU   X'B4'               RESERVE COMMAND CODE                 03841002
FLCD     EQU   X'80'               CHAIN DATA FLAG                      03851002
FLCC     EQU   X'40'               CHAIN COMMAND FLAG                   03861002
FLSLI    EQU   X'20'               SURPRESS LENGTH INCICATOR FLAG       03871002
FLSKIP   EQU   X'10'               SKIP DATA TRANSFER FLAG              03881002
FLPCI    EQU   X'08'               PCI FLAG                             03891002
LGHCCW   EQU   8                   LENGTH OF A CCW                      03901002
LGHRHA   EQU   X'05'               LENGTH OF READ HOME ADDRESS          03911002
LGHRRZ   EQU   X'04'               LENGTH OF READ RECORD 0              03921002
         TITLE 'IECIOSCN - IOS - DSECT OF CHANNEL TABLE ENTRY'          03931002
****************************************************************        03941002
*                                                              *        03951002
*              THIS DSECT DESCRIBES THE ENTRIES IN THE CHANNEL *        03961002
*              TABLE.                                          *        03971002
*                                                              *        03981002
****************************************************************        03991002
CHT      DSECT                                                          04001002
         DS    C                   RESERVED                             04011002
CHTTYPE  DS    C                   TYPE OF CHANNEL SPECIFIED            04021002
         SPACE 1                                                        04031002
*   CODE DEFINITION FOR CHTTYPE                                         04041002
         SPACE 1                                                        04051002
CHTMPX   EQU   1                   BYTE MULTIPLEXOR CHANNEL             04061002
CHTHSMPX EQU   2                   HI-SPEED MULTIPLEXOR CHANNEL         04071002
CHTSEL   EQU   3                   SELECTOR CHANNEL                     04081002
CHTBMPX  EQU   4                   BLOCK MULTIPLEXOR CHANNEL            04091002
         SPACE 1                                                        04101002
CHTMASK  DS    H                   CHANNEL MASK FOR (IRTCHMSK)          04111002
CHTCSM   DS    A                   ADDRESS OF CHANNEL SEARCH MOD        04121002
         SPACE 1                                                        04131002
CHTEL    EQU   8                   SIZE OF ENTRY IN BYTES               04141002
CHTELP2  EQU   3                   SIZE OF ENTRY IN POWERS OF 2         04151002
         TITLE 'IECIOSCN - DSECT OF CHANNEL SEARCH MODULE TABLE ENTRY'  04161002
****************************************************************        04171002
*                                                              *        04181002
*              THIS DSECT DESCRIBES THE ENTRIES IN THE CHANNEL *        04191002
*              SEARCH MODULE TABLE.                            *        04201002
*                                                              *        04211002
****************************************************************        04221002
CSME     DSECT                                                          04231002
CSMEOF   DS    H                   ROUTINE OFFSET                       04241002
CSMELCH  DS    H                   LCH ENTRY OFFSET                     04260002
CSMEL    EQU   4                   LENGTH OF CSME ENTRY                 04270002
         TITLE 'IECIOSCN - IOS - REGISTER DEFINITION'                   04275002
*****************************************************************       04290002
*                                                               *       04300002
*        THE FOLLOWING IS THE REGISTER DEFINITION FOR BASIC IOS *       04310002
*                                                               *       04320002
*****************************************************************       04330002
WRK0     EQU   0                   WORK REGISTER 0                      04340002
WRK1     EQU   1                   WORK REGISTER 1                      04350002
IOSBR    EQU   2                   IOSB REGISTER                        04360002
LCCAR    EQU   3                   LCCA REGISTER (CONTAINS IRT)         04370002
LNKR     EQU   4                   LINK REGISTER                        04380002
BASEA    EQU   5                   BASE REGISTER A                      04390002
WRK6     EQU   6                   WORK REGISTER 6                      04400002
UCBR     EQU   7                   UCB REGISTER                         04410002
BASEB    EQU   8                   BASE REGISTER B                      04420002
BASEC    EQU   9                   BASE REGISTER C                      04430002
WRKA     EQU   10                  WORK REGISTER 10                     04440002
WRKB     EQU   11                  WORK REGISTER 11                     04450002
IOQR     EQU   11                  IOQE REGISTER                        04460002
WRKC     EQU   12                  WORK REGISTER 12                     04470002
SAVR     EQU   13                  LCCA SAVE AREA REGISTER              04480002
WRKEVEN  EQU   14                  EVEN OF PAIR WORK REGISTER           04490002
WRKODD   EQU   15                  ODD OF PAIR WORK REGISTER            04500002
         TITLE 'IECIOSCN - IOS - IOS COMMON EQUATES'                    04510002
****************************************************************        04520002
*                                                              *        04530002
*              THE FOLLOWING IS THE COMMON EQUATES FOR BASIC   *        04540002
*              IOS                                             *        04550002
*                                                              *        04560002
****************************************************************        04570002
F        EQU   X'F'                CONSTANT VALUE                       04580002
FF       EQU   X'FF'               CONSTANT VALUE                       04590002
X80      EQU   X'80'               BIT FOR USE IN BITMAP CHECK          04595002
IOINTER  EQU   X'02'               I/O INTERRUPT BIT IN PSW             04610002
EXTINT   EQU   X'01'               EXTERNAL INTERRUPT BIT IN PSW        04615002
SHRSUBCH EQU   X'80'               LOWEST SHARED SUBCHANNEL ADDR        04630002
X20      EQU   X'20'               160 BYTE BLK IND                     04635002
X40      EQU   X'40'               OR MASK FOR DEF STAT INTS    YM01352 04640002
EC3211   EQU   X'10'               3211 EQUIP CK INDICATION             04650002
XFA      EQU   X'FA'              OS TRACE ACTIVE MASK         @Y30CQLF 04655003
MM3211   EQU   X'02'               3211 MECHANICAL MOTION IND           04660002
ZERO     EQU   0                   CONSTANT VALUE                       04680002
CK3800   EQU   X'10'               CANCEL KEY IN SENSE         @Y40MPLG 04684040
ONE      EQU   1                   CONSTANT VALUE                       04686002
TWO      EQU   2                   CONSTANT VALUE                       04692002
THREE    EQU   3                   CONSTANT VALUE                       04700002
FOUR     EQU   4                   CONSTANT VALUE                       04710002
FIVE     EQU   5                   CONSTANT VALUE                       04715002
SEVEN    EQU   7                   CONSTANT VALUE                       04720002
EIGHT    EQU   8                   CONSTANT VALUE                       04740002
TWELVE   EQU   12                  CONSTANT VALUE                       04745002
FIFTEEN  EQU   15                  CONSTANT VALUE                       04752003
TWENTY   EQU   20                  CONSTANT VALUE                       04760002
TWENTY4  EQU   24                  CONSTANT VALUE                       04765002
N192     EQU   192                                                      04770002
NXTIOQ   EQU   0                   RETURN VECTOR                        04790002
NXTCHN   EQU   2                   LENGTH OF ENTRY IN TCH TABLE         04800002
NXTLCH   EQU   4                   RETURN VECTOR                        04810002
MSASID   EQU   1                   ASID OF MASTER SCHEDULER             04820002
BYTE123  EQU   7                   STCM INSTRUCTION MASK FOR   @YM06828 04822002
*                                  STORING BYTES 1,2,3         @YM06828 04824002
***                                                           ***       04827002
*              VECTOR RETURN EQUATES TO ETCH1                   *       04834002
***                                                           ***       04850002
NENQ     EQU   0                   NO ENQUEUE, NO SHOULDER TAP          04851002
ENQNST   EQU   4                   ENQUEUE, NO SHOULDER TAP             04861002
ENQST    EQU   8                   ENQUEUE, SHOULDER TAP                04871002
***                                                           ***       04881002
*              VECTOR RETURN EQUATES FOR DEVICE RESERVE TEST    *       04900002
***                                                           ***       04903002
RCPURPTH EQU   0                   RIGHT CPU - RIGHT PATH               04911802
RCPUWPTH EQU   4                   RIGHT CPU - WRONG PATH               04930002
WCPUXPTH EQU   8                   WRONG CPU - PATH IMMATERIAL          04940002
***                                                          ***        04950002
*              CHANNEL CHECK HANDLER EQUATES                   *        04960002
***                                                          ***        04970002
CCHSSAS  EQU   0                   CC=1 ON SIO STAND ALONE SEEK         04980002
CCHTSAS  EQU   4                   CC=1 ON TIO STAND ALONE SEEK         04990002
CCHSSEN  EQU   8                   CC=1 ON SIO SENSE                    05000002
CCHSIO   EQU   16                  CC=1 ON SIO                          05010002
CCHINT   EQU   20                  INTERRUPT                            05020002
CCHHIO   EQU   24                  CC=1 ON HIO                          05029002
CCHEOS2  EQU   28                  SECOND ENTRY (END OF SENSE)          05038002
***                                                          ***        05047002
*              IOS STORAGE MANAGER EQUATES                     *        05056002
***                                                          ***        05065002
ISMENT1  EQU   0                   GETBLOCK FOR 40 OR 160 BYTES         05074002
ISMENT2  EQU   4                   FREEBLOCK FOR 40 OR 160 BYTES        05083002
ISMENT3  EQU   8                   PURGE/FREE                           05092002
ISMENT4  EQU   12                  GETBLOCK FOR 12 BYTES                05101002
ISMENT5  EQU   16                  FREEBLOCK FOR 12 BYTES               05110002
         SPACE 1                                                        05119002
ISMSZ3   EQU   160                 LARGE SIZED BLOCKS                   05128002
         SPACE 1                                                        05137002
ISM12PAG EQU   12                  OFFSET IN STORAGE MANAGER'S          05150002
*                                  *12 BYTE BLOCK HEADER TO THE         05160002
*                                  *FIELD CONTAINING THE ADDRESS        05170002
*                                  *OF THE FIRST PAGE                   05180002
ISM12HLN EQU   16                  LENGTH OF STORAGE MANAGER'S          05190002
*                                  *12 BYTE BLOCK HEADER                05200002
ISM12PGL EQU   2048                LENGTH OF A STORAGE MANAGER          05210002
*                                  *12 BYTE BLOCK PAGE                  05220002
         TITLE 'IECIOSCN - IOS - IOS COMMUNICATIONS AREA'               05230002
IECIOSCN CSECT                                                          05250002
IOS      DS    0D                  LOWEST ADDRESS IN IOS MODULE         05258002
         ENTRY IECIXAVL            MAKE IOCOM ADDRESS EXTERNAL          05266002
         ENTRY IOCCATLK            MAKE CAT LOCK EXTERNAL               05274002
         ENTRY IOCSYNCH            MAKE IOSYNC LOCK EXTERNAL            05282002
         ENTRY IECVDVT                 MAKE DEVICE TABLE EXTERN@Y30CQLF 05282803
         ENTRY IECVHK1A                MAKE                    @Y30CQLF 05283603
         ENTRY IECVHK1B                    CRH                 @Y30CQLF 05284403
         ENTRY IECVHK2A                       HOOKS            @Y30CQLF 05285203
         ENTRY IECVHK2B                            EXTERNAL    @Y30CQLF 05286003
         ENTRY IECVHK3A                                        @Y30CQLF 05286803
         ENTRY IECVHK3B                                        @Y30CQLF 05287603
         ENTRY IECVSRB                 SRB SCHEDULE FOR CRH    @Y30CQLF 05288403
         IECDIOCM CSECT=YES                                             05290002
         TITLE 'IECIOSCN - IOS - VOID CSECT'                            05298002
         IECDVOID CSECT=YES                                             05320002
         TITLE 'IECIOSCN - IOS - DEVICE TABLE'                          05325002
IECVDVT  DS    0F                  DEVICE TABLE                         05340002
         SPACE 1                                                        05348002
*****************************************************************       05356002
*                                                               *       05364002
*              THE DEVICE TABLE CONTAINS THE ADDRESSES OF THE   *       05372002
*              START I/O SUBROUTINE, TRAP CODE AND SENSE        *       05390002
*              SUBROUTINE BY DEVICE CLASS. IT IS ACCESSED VIA   *       05400002
*              AN INDEX IN THE UCB (UCBDTI).                    *       05410002
*                                                               *       05420002
*****************************************************************       05430002
         SPACE 1                                                        05440002
DVT      DS    0F                                                       05450002
DVTSIO   DS    A                   ADDRESS OF SIO MODULE                05460002
DVTTRAP  DS    A                   ADDRESS OF TRAP CODE ROUTINE         05470002
DVTSENSE DS    A                   ADDRESS OF SENSE ROUTINE             05480002
         ORG   DVT                                                      05490002
         SPACE 1                                                        05500002
*        UNIT RECORD ENTRY                                              05510002
         SPACE 1                                                        05520002
DVTUR    DC    A(EUNITIO1)         UNIT RECORD SIO SUBROUTINE           05530002
         DC    A(EDTUR)            UNIT RECORD TRAP CODE                05540002
         DC    A(ISNSR250)         UNIT RECORD SENSE SUBROUTINE         05550002
         SPACE 1                                                        05560002
*        TELEPROCESSING ENTRY                                           05570002
         SPACE 1                                                        05580002
DVTTP    DC    A(EUNITIO1)         TELEPROCESSING SIO SUBROUTINE        05590002
         DC    A(EDTTP)            TELEPROCESSING TRAP CODE             05600002
         DC    A(ISNSR250)         TELEPROCESSING SNS SUBROUTINE        05610002
         SPACE 1                                                        05620002
*        GRAPHICS ENTRY                                                 05630002
         SPACE 1                                                        05640002
DVTGR    DC    A(EUNITIO1)         GRAPHICS SIO SUBROUTINE              05650002
         DC    A(EDTGRAPH)         GRAPHICS TRAP CODE                   05660002
         DC    A(ISNSR250)         GRAPHICS SENSE SUBROUTINE            05670002
         SPACE 1                                                        05680002
*        TAPE ENTRY                                                     05690002
         SPACE 1                                                        05700002
DVTTAPE  DC    A(ETAPEIO1)         TAPE SIO SUBROUTINE                  05710002
         DC    A(EDTTAPE)          TAPE TRAP CODE                       05715002
         DC    A(ISNSR250)         TAPE SENSE SUBROUTINE                05730002
         SPACE 1                                                        05740002
*        DIRECT ACCESS (2314) ENTRY                                     05747002
         SPACE 1                                                        05754002
DVT2314  DC    A(EDAIO1)           DA (2314) SIO SUBROUTINE             05770002
         DC    A(EDTDASD)          DA (2314) TRAP CODE                  05776002
         DC    A(ISNSR200)         DA (2314) SENSE SUBROUTINE           05790002
         SPACE 1                                                        05800002
*        DIRECT ACCESS (NON 2314) ENTRY                                 05810002
         SPACE 1                                                        05820002
DVT3330  DC    A(EDAIO1)           DA (NON 2314) SIO SUBROUTINE         05830002
         DC    A(EDTDASD)          DA (NON 2314) TRAP CODE              05840002
         DC    A(ISNSR250)         DA (NON 2314) SNS SUBROUTINE         05850002
         SPACE 1                                                        05860002
*        DRUM ENTRY                                                     05870002
         SPACE 1                                                        05880002
DVTDRUM  DC    A(EDRUMIO1)         DRUM SIO SUBROUTINE                  05890002
         DC    A(EDT2305)          DRUM TRAP CODE                       05900002
         DC    A(ISNSR250)         DRUM SENSE SUBROUTINE                05910002
         SPACE                                                          05911003
*        DSM ENTRY                                             @Y30LPLC 05912003
         SPACE                                                          05913003
DVTDSM   DC    A(EUNITIO1)         DSM SIO SUBROUTINE          @Y30LPLC 05914003
         DC    A(EDTUR)            DSM TRAP CODE ROUTINE       @Y30LPLC 05915003
         DC    A(ISNSR150)         DSM SENSE SUBROUTINE        @Y30LPLC 05916003
         SPACE                                                          05916300
*        VECTOR PROCESSOR (3838) ENTRY                         @G29ANLO 05916600
         SPACE 1                                                        05916900
DVT3838  DC    A(EUNITIO1)         3838 SIO SUBROUTINE         @G29ANLO 05917200
         DC    A(EDTUR)            3838 TRAP CODE ROUTINE      @G29ANLO 05917500
         DC    A(ISNSR150)         3838 SENSE SUBROUTINE       @G29ANLO 05917800
         SPACE                                                          05918100
*        3330V ENTRY                                           @G24LPLN 05918400
         SPACE                                                          05918700
DVT3330V DC    A(EVDAIO1)          3330V SIO SUBROUTINE        @G24LPLN 05919000
         DC    A(EDTVDA)           3330V TRAP CODE ROUTINE     @G24LPLN 05919300
         DC    A(ISNSR250)         3330V SENSE SUBROUTINE      @G24LPLN 05919600
         TITLE 'IECIOSCN - IOS - COMMON CONSTANTS FOR BASIC IOS'        05920002
****************************************************************        05930002
*                                                              *        05940002
*              THE FOLLOWING IS THE COMMON CONSTANTS FOR       *        05950002
*              BASIC IOS                                       *        05960002
*                                                              *        05970002
****************************************************************        05980002
CONDXXXX DS    0D                  DOUBLE WORD BOUNDRY                  05990002
COND0001 CCW   X'03',COND0001,X'30',1  IMM CCW SKELETON                 06000002
COND0002 CCW   X'04',COND0002,X'30',1  SPECIAL SENSE CCW       @ZA06061 06005000
CONFXXXX DS    0F                  FULL WORD BOUNDRY                    06010002
CONF0001 DC    X'8FFFFFFF'         MASK TO REMOVE CONTROL UNIT          06020002
*                                  *BITS FROM CSW                       06030002
CONF0002 DC    X'10000020'         MASK FOR STORAGE MANAGEMENT          06040002
*                                  *INTERFACE (1-160 BYTE BLOCK)        06050002
CONF0003 DC    X'0000FF3F'         ALL BUT PCI AND INCORRECT            06060002
*                                  *LENGTH IN CSW STATUS                06070002
CONF0004 DC    A(IECFRR)           ADDRESS OF FRR ROUTINE               06080002
***                                                          ***        06090002
*              THE FOLLOWING ARE VECTORS FOR RESTART           *        06100002
***                                                          ***        06105002
CONF0005 DC    A(IRSTR060)         FOR SEEK                             06120002
         DC    A(IRSTR060)         FOR SENSE                            06130002
         DC    A(IRSTR060)         FOR DATA TRANSFER                    06140002
         DC    A(IRSTR300)         FOR END OF TABLE                     06150002
CONF0006 DC    X'0000'             FOR SEEK                             06155002
         DC    AL1(UCBBSY+UCBACTV+UCBPST+UCBSAP+UCBPSNS) STATUS         06161002
         DC    X'00'               FILL                                 06170002
         DC    X'0000'             FOR SENSE                            06179002
         DC    AL1(UCBBSY+UCBACTV) STATUS                               06188002
         DC    X'00'               FILL                                 06200002
         DC    X'0000'             FOR DATA TRANSFER                    06220002
         DC    AL1(UCBPST+UCBBSY+UCBACTV+UCBPSNS) STATUS                06226002
         DC    X'00'               FILL                                 06232002
CONF0007 DC    A(IRSTR120)         FOR SEEK                             06250002
         DC    A(IRSTR140)         FOR SENSE                            06251002
         DC    A(IRSTR130)         FOR DATA TRANSFER                    06262002
CONF0008 DC    A(IRSTR190)         FOR SEEK                             06280002
         DC    A(IRSTR200)         FOR SENSE                            06290002
         DC    A(IRSTR160)         FOR DATA TRANSFER                    06300002
CONF0009 DC    A(ETCH1)            FOR SEEK                             06310002
         DC    A(ESENSE3)          FOR SENSE                   @ZA16177 06320041
         DC    A(ETCH1)            FOR DATA TRANSFER                    06330002
***                                                          ***        06340002
*              END OF RESTART VECTORS                          *        06350002
***                                                          ***        06360002
CONF0010 DC    AL1(FLCC)           SECOND HALF OF READ HOME             06370002
         DC    AL3(LGHRHA)         *ADDRESS CCW                         06380002
CONF0011 DC    AL1(FLSLI)          SECOND HALF OF READ RECORD           06390002
         DC    AL3(LGHRRZ)         *0 CCW                               06400002
CONF0012 DC    AL1(SNSCC)          FIRST HALF OF THE SILLY SENSE        06410002
         DC    AL3(0)              *CCW COMMAND                         06420002
CONF0013 DC    AL1(FLSKIP+FLSLI)   SECOND HALF OF THE SILLY             06421002
         DC    AL3(4)              *SENSE CCW COMMAND                   06440002
CONF0014 DC    F'65536'            LOGICAL 1 FOR OPTIMIZER              06450002
CONF0015 DC    X'00000F00'         MASK TO 'AND' OFF CU/DEV      M01051 06455002
CONF00F0 DC    X'0000F000'         UCBCHM AND UCBPMSK ADJUSTMENT        06490003
CONF0017 DC    V(TRSIO)            ADDRESS OF TRACE (SIO)               06500002
CONF0018 DC    V(IECVSLCH)         ADDRESS OF SENSE LCH'S               06505002
CONF0020 DC    AL1(FLCC+FLSLI)     SECOND HALF OF THE                   06520002
         DC    AL3(6)              *DATA TRANSFER SEEK COMMAND          06530002
CONF0021 DC    AL1(FLCC+FLSLI)     SECOND HALF OF THE                   06540002
         DC    AL3(1)              *SET FILE MASK/TIE COMMANDS          06550002
CONF0022 DC    AL1(FLSLI)          SECOND HALF OF THE                   06560002
         DC    AL3(6)              *STAND ALONE SEEK COMMAND            06570002
CONF0023 DC    AL1(FLSLI+FLSKIP)   SECOND HALF OF THE                   06580002
         DC    AL3(1)              *STAND ALONE RESERVE/RELEASE         06590002
*                                  *COMMANDS                            06600002
CONF0024 DC    AL1(FLCC+FLSLI+FLSKIP) SECOND HALF OF THE                06610002
         DC    AL3(1)              *DATA TRANSFER RESERVE/RELEASE       06620002
*                                  *COMMANDS                            06630002
CONF0025 DC    X'0000F3FF'         MASK OUT CE/DE                       06640002
CONF0028 DC    X'00FFFFFF'         MASK TO ISOLATE ADDRESSES            06647002
CONF0029 DC    X'30000020'         MASK FOR STORAGE MANAGEMENT          06654002
*                                  *INTERFACE (3-160 BYTE BLOCKS)       06661040
CONF0030 DC    X'00000FF0'         MASK TO AND OFF DEV           M01051 06670402
CONF0031 DC    X'0000FFFF'         MASK OFF FOR 16 BIT         @Z30ANLA 06679403
CONF0032 DC    F'4096'             SENSE LOOP COUNT            @ZA10792 06684400
CONXF0   DC    X'000000F0'         PATH MASK TESTER                     06690002
CONX0F   DC    X'0000000F'         MASK TO REMOVE SEL SUB CHANNEL BITS  06700041
*                                  *FROM COPY OF LCHTCH ENTRY  @ZA31965 06708041
CONF0035 DC    V(TRIO)            ADDRESS OF OS TRACE ROUTINE  @Y30CQLF 06726003
CONF0036 DC    A(ISENS800)        ADDRESS OF SENSE2 SUBROUTINE @ZA16177 06728041
CONFHDET DC    V(IECVHDET)         ADDR OF HOT I/O DETECTION   @ZA30350 06728641
         WXTRN IECVHDET                                        @ZA30350 06729041
CONHXXXX DS    0H                  HALF WORD BOUNDRY                    06730002
CONH0001 MVC   IOSSNS-IOSB(ONE,WRKEVEN),EWASNS-EWA(WRK1)                06750002
*                                  MOVE SENSE DATA FROM EWA TO          06760002
*                                  *IOSB VIA EXECUTE                    06770002
CONH0002 DC    AL2(CSWCAT)         MASK TO REMOVE ALL BUT CAT           06780002
*                                  *ERRORS FROM CSW                     06786002
CONH0003 STOSM PSASYMSK-PSA(WRK0),ZERO 'OR' ORIGINAL SYSTEM MASK IN     06792002
CONH0004 DC    H'8'                CONSTANT VALUE                       06810002
CONH0005 DC    AL2(IOSSNSBD)       SIMULATED EQUIP. CHECKS              06816002
CONH0006 MVC   EWASNS-EWA(ONE,WRKA),EWASNS-EWA(WRKC)                    06822002
*              MOVE SENSE DATA TO NEW EWA                               06830002
CONBXXXX DS    0C                  BYTE BOUNDRY                         06840002
CONB0002 DC    X'0006'             CHANNEL & INTERFACE CNTRL CK@ZA01911 06848003
         SPACE 1                                                        06850002
         MODID BR=NO                                                    06890041
         TITLE 'IECIOSCN - IOS - STARTIO INTERFACE'                     06940002
*********ESTIO1**************************************************       06950002
*                                                               *       06970002
* FUNCTION                                                      *       06980002
*    INTERFACE BETWEEN STARTIO MACRO AND CHANNEL SCHEDULER.     *       06990002
*    FORMATS THE SRB/IOSB BASED ON THE INPUT PARAMETERS. SETS   *       07000002
*    UP PARAMETERS FOR ENTRY TO CHANNEL SCHEDULER.              *       07010002
*                                                               *       07020002
* ENTRY POINTS                                                  *       07030002
*         ESTIO1                                                *       07040002
* INPUT                                                         *       07050002
*    REGISTERS                                                  *       07060002
*              WRK0    =TCB ADDRESS                             *       07070002
*              WRK1    =SRB ADDRESS                             *       07080002
*              LCCAR   =CVT ADDRESS                             *       07090002
*              SAVR    =CALLER'S SAVE AREA                      *       07100002
*              WRKEVEN =RETURN ADDRESS                          *       07110002
*              WRKODD  =ADDRESS OF IECVSTIO                     *       07120002
*                                                               *       07130002
*              WRK0 POSITIVE = TCB ADDRESS                      *       07140002
*                   NEGATIVE = USE CURRENT TCB ADDRESS          *       07150002
*                   ZERO     = USE ZERO FOR THE TCB ADDRESS     *       07156002
*                                                               *       07170002
*              WRK1 POSITIVE = SRB ADDRESS                      *       07178002
*                   NEGATIVE = SRB ALL FORMATTED NO TCB         *       07186002
*                                                               *       07194002
*    FIELDS                                                     *       07202002
*              CVTTCBP  SRBPARM                                 *       07210002
*                                                               *       07218002
*    LOCKS                                                      *       07240002
*              NONE                                             *       07250002
*                                                               *       07260002
* OUTPUT                                                        *       07270002
*    REGISTERS                                                  *       07276002
*              WRK0    =SRB ADDRESS                             *       07290002
*              WRK1    =IOSB ADDRESS                            *       07300002
*              WRKA    =DESTROYED                               *       07310002
*              WRKB    =DESTROYED                               *       07320002
*              SAVR    =CALLER'S SAVE AREA                      *       07330002
*              WRKEVEN =RETURN ADDRESS                          *       07340002
*              WRKODD  =ADDRESS OF IECHNSCH                     *       07346002
*                                                               *       07360002
*    FIELDS                                                     *       07370002
*              SRBPTCB                                          *       07380002
*                                                               *       07390002
*    LOCKS                                                      *       07400002
*              NONE                                             *       07410002
*                                                               *       07420002
* EXTERNAL REFERENCES                                           *       07430002
*    NONE                                                       *       07440002
*                                                               *       07450002
* EXITS                                                         *       07460002
*    TO IECHNSCH                                                *       07465002
*                                                               *       07480002
* TABLES/WORKAREAS                                              *       07485002
*    CVT                                                        *       07500002
*    IOSB                                                       *       07510002
*    SRB                                                        *       07519002
*                                                               *       07528002
*****************************************************************       07537002
         EJECT                                                          07546002
***                                                           ***       07555002
*              INDICATE ADDRESSABILITY                          *       07564002
***                                                           ***       07573002
         USING CVTMAP,LCCAR        INDICATE CVT ADDRESSABILITY          07582002
         USING SRBSECT,WRKA        INDICATE SRB ADDRESSABILITY          07591002
         USING *,WRKODD            INDICATE BASE ADDRESSABILITY         07600002
         ENTRY IECVSTIO            MAKE ENTRY POINT EXTERNAL            07609002
         SPACE 1                                                        07630002
***                                                           ***       07640002
*              INITIALIZE SRB/IOSB                              *       07650002
***                                                           ***       07660002
IECVSTIO LPR   WRKA,WRK1           SET SRB POSITIVE                     07670002
         LTR   WRK1,WRK1           IS SRB PARAMETER NEGATIVE?           07680002
         BM    ISTIO20             YES - NO TCB PARAMETER               07690002
         SPACE 1                                                        07700002
         LTR   WRK0,WRK0           IS TCB PARM POSITIVE OR ZERO?        07710002
         BNM   ISTIO10             YES - USE AS IS                      07720002
         SPACE 1                                                        07730002
         L     WRKB,CVTTCBP        GET POINTER TO CURRENT TCB           07740002
         L     WRK0,FOUR(WRKB)     GET ADDRESS CURRENT TCB              07750002
ISTIO10  ST    WRK0,SRBPTCB        SET TCB ADDRESS IN SRB               07760002
         SPACE 1                                                        07770002
***                                                           ***       07780002
*              SET UP FOR ENTRY TO CHANNEL SCHEDULER            *       07790002
***                                                           ***       07800002
ISTIO20  L     WRK1,SRBPARM        GET IOSB ADDRESS INTO REG 1          07810002
         LR    WRK0,WRKA           GET SRB ADDRESS INTO REG 0           07820002
         LA    WRKODD,IECHNSCH     ESTABLISH ADDRESSABILITY             07830002
*                                  *FOR CHANNEL SCHEDULER AND           07840002
*                                  *FALL THROUGH                        07850002
         SPACE 1                                                        07860002
***                                                           ***       07870002
*              DROP ADDRESSABILITY                              *       07880002
***                                                           ***       07890002
         SPACE 1                                                        07900002
         DROP  LCCAR,WRKA,WRKODD   RESET ADDRESSABILITY                 07910002
         TITLE 'IECIOSCN - IOS - CHANNEL SCHEDULER SUBROUTINE'          07920002
*********ECHSCHD1************************************************       07930002
*                                                               *       07940002
* FUNCTION                                                      *       07950002
*    INITIALIZATION AND DEVICE AVAILABILITY TESTS               *       07960002
*                                                               *       07970002
* ENTRY POINTS                                                  *       07980002
*         ECHSCHD1                                              *       07990002
*                                                               *       08000002
* INPUTS                                                        *       08010002
*    REGISTERS                                                  *       08020002
*              WRK0    =SRB ADDRESS                             *       08030002
*              WRK1    =IOSB ADDRESS                            *       08040002
*              SAVR    =CALLER'S SAVE AREA                      *       08050002
*              WRKEVEN =RETURN ADDRESS                          *       08060002
*              WRKODD  =ADDRESS OF IECHNSCH                     *       08070002
*                                                               *       08080002
*    FIELDS                                                     *       08090002
*              IOCORMGT LCCACPUS PSALCCAV WSACIOS               *       08100002
*                                                               *       08110002
*    LOCKS                                                      *       08120002
*              UCBLOCK MUST BE OBTAINABLE                       *       08130002
*              LCHLOCK MUST BE HELD OR OBTAINABLE               *       08140002
*                                                               *       08150021
* EXTERNAL REFERENCES                                           *       08160002
*    ESETUP1                                                    *       08170002
*    ETCH1                                                      *       08180002
*    EQUEE1                                                     *       08190002
*                                                               *       08200002
* EXITS                                                         *       08210002
*    +0 =REQUEST STARTED, COMPLETED OR ENQUEUED                 *       08220002
*                                                               *       08230021
* TABLES/WORKAREAS                                              *       08240002
*    FLC                                                        *       08248002
*    FRRS                                                       *       08256002
*    IOQ                                                        *       08264002
*    IOSB                                                       *       08272002
*    IRT                                                        *       08280002
*    LCCA                                                       *       08288002
*    PCCA                                                       *       08310002
*    SVAREA                                                     *       08320002
*    UCB                                                        *       08330002
*    WSAC                                                       *       08340002
*                                                               *       08350021
*****************************************************************       08360002
         EJECT                                                          08368002
***                                                           ***       08376002
*              ESTABLISH IOS ENVIRONMENT AND ADDRESSABILITY     *       08384002
***                                                           ***       08392002
         USING FLC,0               SET LOW CORE ADDRESSABILITY          08400002
         USING IECHNSCH,WRKODD                                          08408002
         ENTRY IECHNSCH            MAKE ENTRY POINT EXTERNAL            08416002
         SPACE 1                                                        08440002
ECHSCHD1 DS    0H                                                       08441002
IECHNSCH STNSM PSASYMSK,FF-IOINTER-EXTINT                               08450002
*                                  DISABLE AND SAVE CURRENT MASK        08459002
         L     LCCAR,PSALCCAV      POINT AT THE LCCA                    08470002
         USING LCCA,LCCAR          INDICATE LCCA ADDRESSABILITY         08480002
         SPACE 1                                                        08500002
         STM   SAVR,WRKEVEN,IRTRTNSV SAVE FOR EXIT, REGISTER            08506002
*                                  *13 NOT ALTERED ACROSS STARTIO       08512002
*                                  *INTERFACE                           08520002
         IC    WRKA,PSASYMSK       SAVE THE SYSTEM MASK TO BE           08530002
         STC   WRKA,IRTSYMSK       RESTORED ON EXIT                     08540002
         MVI   IRTCMRST,FF         INDICATE IOS ACTIVE ON CPU           08550002
         MVI   IRTENVR,IRTCHENT    INDICATE ENTRY FROM CHAN SCHD        08560002
         LA    WRKA,IECHNSCH-IOS   LOAD OFFSET TO START OF IOS          08570002
         SLR   WRKODD,WRKA         SET TO BEGINNING OF IOS              08580002
         LR    BASEA,WRKODD        SET FIRST BASE REGISTER              08590002
         LA    BASEB,4094          LOAD OTHER OFFSET VALUES IN          08600002
         LR    BASEC,BASEB         *OTHER TWO BASE REGISTERS            08610002
         ALR   BASEB,BASEA         SET BASE REGISTER B                  08620002
         ALR   BASEC,BASEB         SET BASE REGISTER C                  08630002
         SPACE 1                                                        08640002
         USING IOS,BASEA           INDICATE REAL BASEA                  08650002
         USING IOS+4094,BASEB      INDICATE REAL BASEB                  08661002
         USING IOS+8188,BASEC      INDICATE REAL BASEC                  08670002
         DROP  WRKODD                                                   08680002
         SPACE 1                                                        08700002
***                                                           ***       08710002
*              SET UP FRR FOR RECOVERY                          *       08720002
***                                                           ***       08730002
         SETFRR A,                SET UP FRR FOR RECOVERY              *08740002
               FRRAD=CONF0004,    *ADDRESS OF THE IOS FRR              *08750002
               PARMAD=(WRKA),     *REGISTER FOR SAVE AREA              *08760002
               WRKREGS=(WRKB,WRKC) *WORK REGISTERS                      08770002
         SPACE 1                                                        08780021
         OI    PSASUP3,PSAIOSUP    SET SUPER BIT TO INSURE              08785002
*                                  FRR ENTRY DISABLED                   08790002
         ST    WRKA,IRTFRRWA       SAVE FRR WORK AREA ADDRESS           08810002
         L     SAVR,LCCACPUS       POINT AT LCCA SAVE AREA TABLE        08815002
         USING WSAC,SAVR           INDICATE WSAC ADDRESSABILITY         08830002
         SPACE 1                                                        08831002
         L     SAVR,WSACIOS        POINT AT IOS SAVE AREA               08850002
         USING SVAREA00,SAVR       INDICATE SVAREA ADDRESSABILITY       08860002
         SPACE 1                                                        08870002
***                                                           ***       08880021
*              GET AN IOQE                                      *       08890002
***                                                           ***       08896002
         L     WRKODD,IOCORMGT     GET ADDRESS OF STORAGE MANAGER       08902002
         STM   WRK0,WRK1,SVAREA05  SAVE SRB/IOSB ACROSS INTERFACE       08910002
         OI    IRTFLB,IRTSMGR+IRT12GT STORAGE MANAGER ACTIVE FOR        08920002
*                                  *12 BYTE GET                         08930002
         BAL   WRKEVEN,ISMENT4(WRKODD) ENTER STORAGE MANAGER            08950002
         SPACE 1                                                        08960002
         USING IOQ,IOQR                                                 08970002
         SPACE 1                                                        08980002
         NI    IRTFLB,FF-IRTSMGR-IRT12GT STORAGE MANAGER NOT            08990002
*                                  *ACTIVE FOR 12 BYTE GET              09000002
         ST    IOQR,IRTIOQ         STORE IOQE ADDRESS                   09010002
         LM    WRK0,WRK1,SVAREA05  RESTORE SRB/IOSB                     09012002
         SLR   WRKA,WRKA           ZERO WORK REGISTER                   09020002
         ST    WRKA,IOQLNK         SHOW IOQE NOT INITIALIZED            09030002
         MVI   IOQFLB,IOQALOC      SHOW IOQE ALLOCATED         @G24LPLN 09035000
         SPACE 1                                                        09040002
***                                                           ***       09060021
*              INITIALIZE IOQ  AND REGISTERS                    *       09061002
***                                                           ***       09080002
         BAL   LNKR,ESETUP1        GO TO INITIALIZATION                 09090002
         OI    IRTFLA,IRTIOQA      SHOW AN ACTIVE IOQE                  09100002
         OI    IRTENVR,IRTCSINT    INDICATE CHANNEL SCHEDULER           09106002
*                                  *INITIALIZATION COMPLETE             09112002
         SPACE 1                                                        09130021
***                                                           ***       09140002
*              DETERMINE IF REQUEST CAN BE STARTED OR ENQUEUE IT*       09148002
***                                                           ***       09156002
         USING IOSB,IOSBR          SHOW ADDRESSABILITY TO IOSB          09164002
         USING UCB,UCBR            SHOW ADDRESSABILITY TO UCB           09172002
         SPACE 1                                                        09181002
         TM    UCBFLA,FF           UCBBSY+UCBNRY+UCBPST+UCBPSNS+        09200002
*                                  UCBCUB+UCBSAP+UCBACTV+UCBQISCE       09210002
*                                  *IS DEVICE AVAILABLE?                09217002
         BNZ   ICHSCH30            NO - TEST FURTHER                    09224002
ICHSCH10 LR    WRK0,WRKC           SAVE LCH ADDRESS             YM01751 09231002
         LR    WRK1,SAVR           SAVE REG 13 ACROSS INTERFACE         09250002
         LA    WRKB,UCBLOCK        POINT AT THE UCBLOCK                 09255002
         ST    WRKB,IRTUCB         SET TO THE LOCK TO BE HELD           09270002
         SETLOCK OBTAIN,           GET THE UCBLOCK                     *09277002
               TYPE=IOSUCB,                                            *09284002
               MODE=UNCOND,                                            *09291002
               ADDR=(11),                                              *09310002
               RELATED=(UCB,IECIOSAM(IFRUCB20))                         09315002
         SPACE 1                                                        09321002
         OI    IRTFLA,IRTULCK      SHOW UCB LOCK OBTAINED               09340002
         LR    WRKC,WRK0           RESTORE LCH ADDRESS                  09350002
         LR    SAVR,WRK1           RESTORE REG 13                       09360002
         L     IOQR,IRTIOQ         RESTORE IOQE ADDRESS                 09370002
         TM    UCBFLA,FF           UCBBSY+UCBNRY+UCBPST+UCBPSNS+        09380002
*                                  UCBCUB+UCBSAP+UCBACTV+UCBQISCE       09390002
*                                  *IS DEVICE AVAILABLE?                09400002
         BNZ   ICHSCH30            NO - TEST FURTHER                    09410002
         SPACE 1                                                        09420002
***                                                           ***       09430002
*              GO START THIS REQUEST NOW                        *       09440002
***                                                           ***       09450002
ICHSCH20 BAL   LNKR,ETCH1          GO FIND A PATH TO START              09460002
         SPACE 1                                                        09470002
*   ETCH1 RETURNS ON TWO VECTORS (+0 AND +4). THE RETURNS HAVE          09480002
*   MEANING ONLY TO CHANNEL RESTART.                                    09490002
         SPACE 1                                                        09500002
         B     ICHSCH60            GO PREPARE FOR EXIT                  09510002
*        B     ICHSCH60            GO PREPARE FOR EXIT                  09520002
         SPACE 3                                                        09530002
***                                                           ***       09540002
*              CHANNEL SCHEDULER COMPLETE - PREPARE FOR EXIT    *       09550002
***                                                           ***       09560002
ICHSCH60 BAL   LNKR,ERSTART2       GO TO CHANNEL RESTART                09570002
         SPACE 1                                                        09580002
***                                                           ***       09590002
*              DELETE THE FRR ROUTINE                           *       09600002
***                                                           ***       09610002
         NI    PSASUP3,FF-PSAIOSUP RESET SUPER BIT                      09620002
         SPACE 1                                                        09630002
         SETFRR D,                 DELETE THE FRR ROUTINE              *09640002
               WRKREGS=(WRKB,WRKC) *WORK REGISTERS                      09650002
         LM    SAVR,WRKEVEN,IRTRTNSV RESTORE REGISTERS 13,14            09660002
         IC    WRKC,IRTSYMSK       GET ORIGINAL SYSTEM MASK             09670002
         EX    WRKC,CONH0003       SET THE ORIGINAL SYSTEM MASK         09680002
         BR    WRKEVEN             RETURN TO CALLER                     09690002
         EJECT                                                          09700002
***                                                           ***       09710002
*              TEST OF UCBFLA FOR STARTABILITY                  *       09720002
***                                                           ***       09730002
         USING IOQ,IOQR            INDICATE IOQE ADDRESSABILITY         09740002
         SPACE 1                                                        09747002
ICHSCH30 TM    UCBFLA,FF-UCBNRY-UCBQISCE IS UCB BUSY WITH ANOTHER       09754002
*                                  REQUEST                              09761002
         BNZ   ICHSCH40            YES - GO ENQUEUE                     09780002
         SPACE 1                                                        09785002
         TM    UCBFLA,UCBNRY+UCBQISCE NOT READY OR QUIESCED             09800002
         BZ    ICHSCH10            NO - GET LOCK TRY AGAIN              09806002
         SPACE 1                                                        09812002
         TM    IOSPKEY,IOSPGDPX    IS THIS DUPLEXED REQUEST             09830002
         BO    ICHSCH70            YES - SPECIAL HANDLING               09836002
         TM    UCBFLA,UCBNRY       QUIESCE ONLY                 @YM0998 09842002
         BO    ICHSCH38            NO - NOT READY              @ZA08444 09850040
         TM    IOSOPT,IOSQISCE     IS THIS QUIESCE OWNER                09870002
         BZ    ICHSCH80            NO - GO ENQUEUED            @ZA06074 09876000
         SPACE 1                                                        09882002
ICHSCH34 TM    IRTFLA,IRTULCK      IS THE UCBLOCK HELD         @ZA08444 09900040
         BZ    ICHSCH10            NO - GO GET THE LOCK AND TRY         09905002
*                                  *AGAIN                               09920002
         B     ICHSCH20            GO START REQUEST                     09930002
ICHSCH38 TM    IOSOPT,IOSRELSE     IS THIS A RELEASE REQUEST   @ZA08444 09932040
         BO    ICHSCH34            GO START THE RELEASE        @ZA08444 09936040
         SPACE 3                                                        09940002
***                                                           ***       09950002
*              DEVICE IS LOGICALLY BUSY - ENQUEUE REQUEST       *       09958002
***                                                           ***       09966002
ICHSCH40 OI    IOQFLA,IOQLBSY      INDICATE LOGICALLY BUSY FOR          09974002
*                                  RESOURCE MANAGER                     09982002
         TM    IRTFLA,IRTULCK      IS THE UCBLOCK HELD                  10000002
         BZ    ICHSCH50            NO - DO NOT FREE UCBLOCK             10008002
         SPACE 1                                                        10016002
         BAL   LNKR,EFRUCBL1       GO FREE THE UCBLOCK                  10024002
         SPACE 1                                                        10032002
         L     IOQR,IRTIOQ         RESTORE IOQE ADDRESS                 10040002
ICHSCH50 BAL   LNKR,EQUEE1         GO ENQUEUE THE REQUEST               10050002
         SPACE 1                                                        10050541
         TM    UCBFLA,FF-UCBNRY-UCBQISCE  DEVICE STILL ACTIVE? @ZA16812 10051041
         BNZ   ICHSCH60            YES - GO EXIT               @ZA16812 10051541
         SPACE 1                                                        10052041
         SLR   WRK6,WRK6           ZERO REGISTER               @ZA16812 10052541
         IC    WRK6,UCBCHA         GET CHANNEL NUMBER          @ZA16812 10053041
         LA    WRKC,X80            GET BIT MASK                @ZA16812 10053541
         SLL   WRKC,24             MOVE MASK TO HIGH-ORDER BIT @ZA16812 10054041
         SRL   WRKC,0(WRK6)        SHIFT TO PROPER CHANNEL BIT @ZA16812 10054541
         L     WRK0,IRTCHMSK       GET CURRENT CHANNEL MASK    @ZA16812 10055041
ICHSCH55 LR    WRKODD,WRK0         COPY CURRENT MASK           @ZA16812 10055541
         OR    WRKODD,WRKC         SET CHANNEL BIT FOR REDRIVE @ZA16812 10056041
         CS    WRK0,WRKODD,IRTCHMSK  SWAP IF CURRENT MASK      @ZA16812 10056541
*                                    HASN'T CHANGED            @ZA16812 10057041
         BNE   ICHSCH55            SWAP FAILED - TRY AGAIN     @ZA16812 10057541
         SPACE 1                                                        10058041
         B     ICHSCH60            GO EXIT FROM CHANNEL SCHEDULER       10060002
         EJECT                                                          10070002
***                                                           ***       10080002
*              SPECIAL HANDLING OF ASM DUPLEXED REQUESTS        *       10100002
***                                                           ***       10109002
ICHSCH70 MVI   IOSCOD,IOSDPXC      SPECIAL COMPLETION CODE              10118002
ICHSCH75 BAL   LNKR,ESCHDIO1       GO RETURN SRB/IOSB          @ZA06074 10122000
         SPACE 1                                                        10136002
         B     ICHSCH60            GO PREPARE FOR EXIT                  10145002
         SPACE 1                                                        10146000
ICHSCH80 CLI   UCBTBYT3,UCB3DACC   DIRECT ACCESS?              @ZA06074 10147000
         BNE   ICHSCH40            NO - GO ENQUEUE             @ZA06074 10148000
         TM    UCBTBYT2,UCBRVDEV   3330V?                      @ZA06074 10149000
         BZ    ICHSCH40            NO - GO ENQUEUE             @ZA06074 10150000
         MVI   IOSCOD,IOSMIHCA     SHOW LOST INTERRUPT         @ZA06074 10151000
         B     ICHSCH75            GO SCHEDULE SRB             @ZA06074 10152000
         SPACE 1                                                        10154002
***                                                           ***       10163002
*              DROP ALL BUT BASE ADDRESSABILITY                 *       10172002
***                                                           ***       10181002
         DROP  IOSBR,LCCAR,UCBR,IOQR                                    10190002
         TITLE 'IECIOSCN - IOS - INITIALIZATION SUBROUTINE'             10199002
*********ESETUP1*************************************************       10220002
*                                                               *       10226002
* FUNCTION                                                      *       10240002
*    1. INITIALIZE REGISTERS.                                   *       10248002
*    2. SET UCB ADDRESSES TO THE BASE FOR MULTIPLE              *       10256002
*       EXPOSURE DEVICES.                                       *       10264002
*    3. INCREMENT THE TOTAL LCH COUNT FOR THE RESOURCE MGR.     *       10272002
*    4. INITIALIZE THE INPUT/OUTPUT QUEUE ELEMENT (IOQE).       *       10290002
*    5. INITIALIZE THE INPUT/OUTPUT SUPERVISOR BLOCK (IOSB).    *       10300002
*                                                               *       10310002
* ENTRY POINTS                                                  *       10320002
*         ESETUP1                                               *       10330002
*                                                               *       10340002
* INPUT                                                         *       10350002
*    REGISTERS                                                  *       10360002
*              WRK0    =SRB ADDRESS                             *       10370002
*              WRK1    =IOSB ADDRESS                            *       10380002
*              BASEA   =BASE ADDRESS A                          *       10390002
*              BASEB   =BASE ADDRESS B                          *       10400002
*              BASEC   =BASE ADDRESS C                          *       10410002
*              WRKA    =DESTROYED                               *       10415000
*              IOQR    =IOQE ADDRESS                            *       10430002
*                                                               *       10440002
*    FIELDS                                                     *       10450002
*              IOSUCB   UCBWGT   CVTASVT  ASCBDP                *       10460002
*                                                               *       10470002
*    LOCKS                                                      *       10478002
*              NONE                                             *       10486002
*                                                               *       10494002
* OUTPUT                                                        *       10502002
*    REGISTERS                                                  *       10510002
*              WRK0    =DESTROYED                               *       10522002
*              WRK1    =DESTROYED                               *       10532002
*              IOSBR   =IOSB ADDRESS                            *       10550002
*              UCBR    =UCB ADDRESS                             *       10556002
*              WRKA    =ZERO                                    *       10562002
*              WRKC    =LCH ADDRESS                             *       10580002
*              WRKEVEN =DESTROYED                               *       10586002
*              WRKODD  =DESTROYED                               *       10600002
*                                                               *       10610002
*    FIELDS                                                     *       10620002
*              IOSSRB   IOSUCB   IOSCOD   IOSCSW   IOSCC        *       10630002
*              IOSPCHN  IOQIOSB  IOQPRI   IOQFLGA               *       10640002
*                                                               *       10650002
*    LOCKS                                                      *       10660002
*              NONE                                             *       10670002
*                                                               *       10680002
* EXTERNAL REFERENCES                                           *       10690002
*    NONE                                                       *       10700002
*                                                               *       10710002
* EXITS                                                         *       10720002
*    BR  LNKR  RETURN TO CALLER                                 *       10730002
*                                                               *       10740002
* TABLES/WORKAREAS                                              *       10750002
*    ASCB                                                       *       10760002
*    CVT                                                        *       10770002
*    IOCOM                                                      *       10780002
*    IOQE                                                       *       10790002
*    IOSB                                                       *       10800002
*    LCH                                                        *       10810002
*    UCB                                                        *       10815002
*                                                               *       10830002
*****************************************************************       10830202
         EJECT                                                          10840202
***                                                           ***       10855202
*              INDICATE ALL BUT BASE ADDRESSABILITY             *       10865202
***                                                           ***       10871202
         SPACE 1                                                        10890002
         USING IOSB,IOSBR          INDICATE IOSB ADDRESSABILITY         10900002
         USING LCCA,LCCAR          INDICATE LCCA ADDRESSABILITY         10910002
         USING UCB,UCBR            INDICATE UCB ADDRESSABILITY          10920002
         USING IOQ,IOQR            INDICATE IOQ ADDRESSABILITY          10930002
         SPACE 1                                                        10940002
***                                                           ***       10950002
*              INITIALIZE THE REGISTERS                         *       10960002
***                                                           ***       10962002
ESETUP1  LR    IOSBR,WRK1          SET UP IOSB REGISTER                 10972702
         ST    WRK0,IOSSRB         INSURE IOSB POINTS AT SRB            10990002
         L     UCBR,IOSUCB         SET UP UCB REGISTER                  10995002
         LA    WRKEVEN,UCBPRFX     GET LENGTH OF UCB PREFIX             11010002
         SLR   UCBR,WRKEVEN        POINT AT START OF PREFIX             11020002
         SPACE 1                                                        11030002
***                                                           ***       11040002
*              IF MULTIPLE EXPOSURE DEVICE, ADJUST UCB TO BASE  *       11050002
***                                                           ***       11060002
         TM    UCBWGT,UCBMTPXP     MULTIPLE EXPOSURE DEVICE?            11070002
         BZ    ISETUP10            NO - BYPASS CHANGE TO BASE           11077002
         L     UCBR,UCBBASE        PICK UP BASE EXPOSURE ADDRESS        11084002
         LR    WRKODD,UCBR         COPY UCB ADDRESS                     11092002
         ALR   WRKODD,WRKEVEN      POINT AT COMMON SECTION              11110002
         ST    WRKODD,IOSUCB       INSURE IOSB POINTS AT BASE           11112002
         SPACE 1                                                        11130002
***                                                           ***       11140002
*              INITIALIZE THE IOSB                              *       11147002
***                                                           ***       11154002
ISETUP10 ST    WRKA,IOSCC          ZERO OUT SIO CONDITION CODE+         11161002
         NI    IOSFLA,FF-IOSEX     RESET IOSB EXCEPTION                 11170002
         OI    IOSOPT2,IOSIGP      MARK ELIGIBLE FOR SIGP      @ZA18121 11175041
         ST    WRKA,IOSCSW+THREE   ZERO OUT CSW FIELD IN IOSB           11180002
         MVI   IOSCOD,IOSNRMC      INITIALIZE TO X'7F'                  11190002
         ST    WRKA,IOSPCHN        ZERO OUT PCI CHAIN FIELD             11210002
         SPACE 1                                                        11220002
***                                                           ***       11230021
*              ADD ONE TO RESOURCE MGR TOTAL I/O COUNT          *       11240002
***                                                           ***       11250002
         L     WRKC,IOCLCHTB       GET ADDRESS OF LCH'S                 11260002
         IC    WRKA,UCBLCI         GET LCH INDEX                        11270002
         SLL   WRKA,LCHELP2        MULTIPLY BY LENGTH OF LCH            11280002
         ALR   WRKC,WRKA           POINT AT PROPER LCH                  11280102
         ST    WRKC,IRTLCHAD       STORE LCH ADDRESS                    11291202
         USING LCH,WRKC            INDICATE LCH ADDRESSABILITY          11300002
         SPACE 1                                                        11320002
         L     WRKEVEN,LCHTOTAL    GET CURRENT COUNT                    11327002
ISETUP20 LR    WRKODD,WRKEVEN      COPY IT                              11334002
         AL    WRKODD,CONF0014     LOGICALLY ADD ONE TO COUNT           11350002
         CS    WRKEVEN,WRKODD,LCHTOTAL  ATTEMPT STORE UPDATED CNT       11357002
         BNE   ISETUP20            NOT SUCESSFUL - TRY AGAIN            11370002
         DROP  WRKC                                                     11372002
         EJECT                                                          11381002
***                                                           ***       11400021
*              INITIALIZE THE IOQE                              *       11410002
***                                                           ***       11420021
         ST    IOSBR,IOQIOSB       SHOW IOQ ASSOCIATED WITH IOSB        11422002
*  THE IOQ MUST KEEP FLAG IOQALOC IN IOQFLB SO THE IECVSMGR WILL        11426040
*  ACCEPT IT WHEN IT IS FREED                                  @Y40FPLG 11427040
         NI    IOQFLA,ZERO         ZERO ALL FLAGS EXCEPT       @G24LPLN 11428000
         NI    IOQFLB,IOQALOC+IOQHOLD  *ALLOCATED AND HOLD     @G24LPLN 11429000
         BR    LNKR                RETURN TO CALLER                     11610002
         SPACE 1                                                        11630002
***                                                           ***       11640002
*              DROP ALL BUT BASE ADDRESSABILITY                 *       11650002
***                                                           ***       11660002
         DROP  IOSBR,LCCAR,UCBR,IOQR                                    11666002
         TITLE 'IECIOSCN - IOS - TEST CHANNEL SUBROUTINE'               11672002
*********ETCH1***************************************************       11680002
*                                                               *       11700002
* FUNCTION                                                      *       11710002
*    DETERMINES IF THERE IS A PATH FROM THIS CPU THRU WHICH AN  *       11720002
*    I/O REQUEST MAY BE STARTED. IF THERE IS NOT AN AVAILABLE   *       11730002
*    PATH, IT DETERMINES IF THERE IS A CHANCE THE REQUEST COULD *       11740002
*    BE STARTED FROM THE OTHER CPU. IF THERE IS, THE OTHER CPU  *       11750002
*    IS 'SHOULDER TAPPED' TO CAUSE CHANNEL RESTART TO BE        *       11757002
*    ENTERED.                                                   *       11764002
*    ALSO USED BY VARY PROCESSOR TO DETERMINE THE STATUS OF     *       11771002
*    A CHANNEL BY ISSUING A TCH FOLLOWED BY A DIRECT RETURN.    *       11790002
*                                                               *       11792002
* ENTRY POINT                                                   *       11810002
*         ETCH1                                                 *       11812002
*         ETCH100                                               *       11830002
*                                                               *       11839002
* INPUT                                                         *       11848002
*    REGISTERS                                                  *       11857002
*              IOSBR   =IOSB ADDRESS                            *       11866002
*              LCCAR   =LCCA ADDRESS (INCLUDING IRT)            *       11875002
*              LNKR    =RETURN ADDRESS                          *       11884002
*              BASEA   =BASE ADDRESS A                          *       11893002
*              UCBR    =UCB ADDRESS                             *       11902002
*              BASEB   =BASE ADDRESS B                          *       11911002
*              BASEC   =BASE ADDRESS C                          *       11930002
*              IOQR    =IOQE ADDRESS                            *       11940002
*              WRKC    =LCH ADDRESS                             *       11950002
*              SAVR    =LCCA SAVE AREA                          *       11960002
*              (INPUT TO IECTCHMP IS CHANNEL ADDRESS IN WRK6.   *       11965002
*               RETURN IS ON WRKEVEN.)                          *       11971002
*                                                               *       11990002
*    FIELDS                                                     *       12000002
*              UCBFLC   LCHTCH   IOSOPT   CATFLG   UCBSTAT      *       12010002
*              UCBCHM   IOSAPMSK UCBCHAN  IRTUCB   IRTFLA       *       12020002
*              IOQFLA   IRTTCHSV                                *       12030002
*                                                               *       12040002
*    LOCKS                                                      *       12050002
*              UCBLOCK MUST BE HELD                             *       12060002
*                                                               *       12063002
* OUTPUT                                                        *       12072002
*    REGISTERS                                                  *       12082002
*              WRK0    =CAT ADDRESS                             *       12100002
*              WRK1    =DESTROYED                               *       12108002
*              WRK6    =UNIT ADDRESS                            *       12116002
*              WRKA    =DESTROYED                               *       12124002
*              WRKC    =CHANNEL PROGRAM ADDRES                  *       12132002
*              WRKEVEN =DESTROYED                               *       12150002
*              WRKODD  =DESTROYED                               *       12160002
*                                                               *       12170002
*    FIELDS                                                     *       12180002
*                                                               *       12190002
*              IRTUCB   IOSEX    IOSCOD                         *       12200002
*                                                               *       12210002
*    LOCKS                                                      *       12218002
*              UCBLOCK FREED                                    *       12226002
*                                                               *       12234002
* EXTERNAL REFERENCES                                           *       12245002
*    NONE                                                       *       12260002
*                                                               *       12270002
* EXITS                                                         *       12280002
*    +0 = NOT ALL CHANNELS ARE BUSY                             *       12290002
*    +4 = ALL CHANNELS RETURNED A BUSY CONDITION                *       12296002
*    (RETURN IS BR  14 FOR ETCH100 ENTRY)                       *       12302002
*                                                               *       12310002
* TABLES/WORKAREAS                                              *       12330002
*    NONE                                                       *       12338002
*                                                               *       12346002
*****************************************************************       12354002
         EJECT                                                          12362002
***                                                           ***       12372002
*              INDICATE ALL BUT BASE ADDRESSABILITY             *       12390002
***                                                           ***       12392002
         SPACE 1                                                        12410002
         USING IOSB,IOSBR          INDICATE IOSB ADDRESSABILITY         12420002
         USING LCCA,LCCAR          INDICATE LCCA ADDRESSABILITY         12430002
         USING UCB,UCBR            INDICATE UCB ADDRESSABILITY          12432002
         USING IOQ,IOQR            INDICATE IOQ ADDRESSABILITY          12450002
         USING LCH,WRKC            INDICATE LCH ADDRESSABILITY          12460002
         SPACE 1                                                        12470021
***                                                           ***       12480002
*              INITIALIZATION                                   *       12482002
***                                                           ***       12500002
         SPACE 1                                                        12510002
ETCH1    ST    LNKR,IRTTCHSV       SAVE RETURN REGISTER                 12520002
         OI    IRTFLB,IRTCHBSY     SET ALL CHANNELS BUSY                12521002
         NI    UCBFLA,FF-UCBCUB    RESET UCBCUB FLAG                    12531002
         TM    UCBFLC,UCBITF       DID UNIT CHECK, WLR OR UNIT          12550002
*                                  EXCEPTION OCCUR ON PREVIOUS          12560002
*                                  INTERRUPT?                           12570002
         BO    ITCH240             YES - HANDLE AS INTERCEPT            12577002
         SPACE 1                                                        12584002
***                                                             ***     12591002
*              TEST IF I/O RESTART HAS DETERMINED THERE ARE       *     12600002
*              NO PATHS AVAILABLE                                 *     12610002
***                                                             ***     12620802
ITCH003  TM    UCBFLB,UCBIORST     IS DEV RESTART INTERCEPTED? @ZA12388 12624800
         BO    ITCH199             YES - GO TERMINATE REQUEST           12640002
         SPACE 1                                                        12650002
***                                                           ***       12685002
*              FIND AN AVAILABLE PATH                           *       12691002
***                                                           ***       12710002
ITCH005  OI    IOSOPT2,IOSHTP      MARK ELIGIBLE               @ZA18121 12715041
*                                  FOR SHOULDER TAP            @ZA18121 12718041
         L     WRKA,LCHTCH         GET ADDRESS OF CHANNEL LIST @ZA10766 12721041
         TM    IOSPATH,IOSGDP      GUARANTEED DEVICE PATH?              12730002
         BO    ITCH160             YES - GO TEST FOR CORRECT CHAN       12735002
         SPACE 1                                                        12740002
ITCH010  LH    WRK6,ZERO(WRKA)     GET NEXT CHANNEL FROM LIST           12760002
         LTR   WRK6,WRK6           END OF LIST?                         12768002
         BM    ITCH070             YES - TEST FOR SHOULDER TAP          12776002
         SPACE 1                                                        12784002
         TM    IOSPATH,IOSGDP      GUARANTEED DEVICE PATH               12792002
         BO    ITCH070             YES - EXIT FROM ETCH1                12801002
         SPACE 1                                                        12810002
         L     WRK1,PSAPCCAV       GET ADDRESS OF PCCA                  12820002
         USING PCCA,WRK1           INDICATE ADDRESSABILITY              12840002
         SPACE 1                                                        12845002
         LA    WRKEVEN,PCCACAT     GET ADDRESS OF CAT                   12851002
         LR    WRKODD,WRK6         COPY CHANNEL ADDRESS TO USE          12870002
         SRL   WRKODD,EIGHT        *AS AN INDEX INTO THE CAT            12871002
         SLL   WRKODD,CATELP2      MULTIPLY BY LENGTH OF CAT TABLE      12890002
         ALR   WRKEVEN,WRKODD      POINT AT CAT ENTRY                   12895002
         USING CAT,WRKEVEN         INDICATE CAT ADDRESSABILITY          12910002
         SPACE 1                                                        12917002
         TM    CATFLG,CATNOP+CATNGEN+CATNCPU                            12924002
*                                  TEST AVAILABILITY BITS               12931002
         BNZ   ITCH034             NOT AVAILABLE - TRY NEXT PATH        12941002
         SPACE 1                                                        12960002
***                                                           ***       12965002
*              IF RESERVED, TEST FOR CORRECT CPU AND PATH       *       12970002
***                                                           ***       12980002
         TM    UCBFLB,UCBRESVH     IS DEVICE RESERVED?                  13000002
         BZ    ITCH020             NO - TEST IF ONLINE                  13007002
         SPACE 1                                                        13014002
         BAL   LNKR,ITCH210        TEST RESERVED PATH                   13022002
         SPACE 1                                                        13040002
         B     ITCH020             CORRECT CPU AND PATH - START         13046002
         B     ITCH034             WRONG PATH - GET NEXT ONE            13052002
         B     ITCH070             WRONG CPU - EXIT WITH SH. TAP        13070002
         SPACE 3                                                        13071002
***                                                           ***       13082002
*              DETERMINE IF PATH IS ONLINE                      *       13093402
***                                                           ***       13101402
ITCH020  LR    WRK0,WRKEVEN        SAVE CAT ADDRESS                     13111802
         SLR   WRKODD,WRKODD                                            13130002
         IC    WRKODD,UCBCHM       GET UCB OFFLINE MASK                 13130402
         LR    WRKEVEN,WRK6        COPY CHANNEL AND MASK                13140002
         N     WRKEVEN,CONX0F      REMOVE SEL SUB CHANNEL BITS @ZA31965 13145041
         CLI   PSACPUSA+ONE,ZERO   IN CPU 0?                            13150002
         BNE   ITCH025             NO - GO SHIFT FOR CPU 1              13160002
         SPACE 1                                                        13170002
         SLL   WRKEVEN,TWO         SHIFT FOR CPU 0                      13180002
         SPACE 3                                                        13190002
ITCH025  SLL   WRKEVEN,TWO         SHIFT FOR CPU 1                      13200002
ITCH030  STC   WRKEVEN,IOQPTH      SAVE PATH MASK INDICATOR             13210002
         TM    IOSOPT,IOSAPR       IS APR ACTIVE                        13220002
         BO    ITCH035             YES - GO SET NEW MASK                13230002
ITCH032  NR    WRKODD,WRKEVEN      SEE IF THIS PATH IS OFFLINE          13240002
         BZ    ITCH040             NO - CONTINUE                        13250002
         SPACE 1                                                        13260002
***                                                           ***       13270002
*              PATH IS OFFLINE                                  *       13280002
***                                                           ***       13290002
         NI    IRTFLB,FF-IRTCHBSY  INSURE RESTART WILL TRY NEXT         13300002
*                                  REQUEST                              13310002
ITCH034  LA    WRKA,NXTCHN(WRKA)   UP TO NEXT CHANNEL                   13320002
         B     ITCH010             TRY NEXT PATH                        13330002
         SPACE 5                                                        13340002
***                                                           ***       13350002
*              CREATE NEW ANDING MASK USING UCBCHM AND IOSAPMSK *       13360002
***                                                           ***       13370002
ITCH035  TM    UCBFLB,UCBRESVH     IS DEVICE RESERVED                   13380002
         BO    ITCH038             YES - ZERO APR MSK AND RETURN        13390002
         SLR   WRKEVEN,WRKEVEN     CLEAR REG                            13400002
         IC    WRKEVEN,IOSAPMSK    INSERT APR MASK                      13410002
         OR    WRKODD,WRKEVEN      SET NEW MASK FOR AND                 13420002
         IC    WRKEVEN,IOQPTH      RESET PATH TO TEST                   13430002
         C     WRKODD,CONXF0       ARE ALL PATHS NO GO                  13440002
         BNE   ITCH032             NO - GO TO PATH TEST                 13450002
         IC    WRKODD,UCBCHM       RESET MASK REG                       13460002
ITCH038  MVI   IOSAPMSK,ZERO       RESET APR MASK                       13470002
         B     ITCH032             RETURN TO PATH TEST                  13480002
         EJECT                                                          13490002
***                                                           ***       13500002
*              ISSUE THE TEST CHANNEL INSTRUCTION               *       13510002
***                                                           ***       13520002
         ENTRY IECVIHK1                                                 13530002
IECVIHK1 EQU   *                   HOOK LABEL FOR TCH INST              13540002
ITCH040  TCH   0(WRK6)             ISSUE TEST CHANNEL                   13550002
         BC    8+1,ITCH050         NOT BUSY OR INTERRUPT       @ZA15746 13555000
*                                  PENDING, DON'T SET BUSY BIT @ZA15746 13560000
         SPACE 1                                                        13570002
         LR    WRKEVEN,WRK0        GET ADDRESS OF CAT                   13580002
         OI    CATFLA,CATBSY       SET CHANNEL BUSY SO SHOULDER         13590002
*                                  TAP WON'T BE DONE TO US              13600002
         DROP  WRKEVEN                                                  13610002
         SPACE 1                                                        13620002
         B     ITCH034             TRY NEXT PATH                        13630002
         SPACE 3                                                        13640002
ITCH050  NI    IRTFLB,FF-IRTCHBSY  RESET ALL CHANNELS BUSY              13650002
          NI     UCBFLA,FF-UCBCUB                              @YM8079  13655002
         ST    WRKA,IRTCHNL        SAVE CHANNEL LIST POINTER            13660002
         TM    ONE(WRKA),FF-F      SEL SUBCHNL SPECIFIED                13670002
         BNZ   ITCH065             YES - SET DEV ADDR                   13680002
ITCH053  IC    WRK6,UCBUA          GET CONTROL UNIT AND DEVICE          13690002
*                                  ADDRESS                              13700002
***                                                           ***       13710002
*              BRANCH TO THE DEVICE DEPENDENT SIO SUBROUTINE    *       13720002
***                                                           ***       13730002
         L     WRKODD,UCBEXTPT     LOAD EXTENTION PTR                   13740002
         USING UCBCMEXT,WRKODD                                          13750002
         LH    WRKC,UCBCCWOF       POINT AT THE CHANNEL PROGRAM         13760002
         SLL   WRKC,THREE                                      @ZA16150 13765041
         A     WRKC,IOCIOSCP       *AREA FOR THIS UCB                   13770002
         SLR   WRKEVEN,WRKEVEN                                          13780002
         IC    WRKEVEN,UCBDTI      GET INDEX TO DEVICE TABLE            13790002
         DROP  WRKODD                                                   13800002
         L     WRKODD,DVTSIO(WRKEVEN)                                   13810002
*                                  GET ADDRESS OF SIO ROUTINE           13820002
         BALR  LNKR,WRKODD         GO TO SIO ROUTINE                    13830002
         SPACE 3                                                        13840002
***                                                           ***       13850002
*              THERE ARE 3 VECTOR RETURNS TO TEST CHANNEL       *       13860002
*              +0 = REQUEST STARTED, ENQUEUE NOT NEEDED         *       13870002
*              +4 = REQUEST STARTED, ENQUEUE NEEDED             *       13880002
*              +8 = REQUEST NOT STARTED, TRY NEXT PATH          *       13890002
***                                                           ***       13900002
ITCH059  B     ITCH090             GO EXIT - NO ENQUEUE        @ZA06063 13905000
         B     ITCH070             GO EXIT - ENQUEUE FIRST              13920002
*        B     ITCH060             TRY NEXT PATH                        13930002
ITCH060  L     WRKA,IRTCHNL        RESTORE CHANNEL LIST ADDRESS         13940002
         B     ITCH034             TRY NEXT PATH                        13950002
         SPACE 2                                                        13970002
ITCH065  MVZ   UCBUA,ONE(WRKA)     MOVE IN CU IF ONE IN TBL             13975002
         B     ITCH053             GET ADDRESS TO START                 13980002
         SPACE 5                                                        13990002
***                                                           ***       14000002
*              VARY PROCESSOR TCH INSTRUCTION                   *       14010002
***                                                           ***       14020002
         ENTRY IECTCHMP                                                 14030002
IECTCHMP DS    0H                  COMPATIBILITY LABEL                  14040002
ETCH100  TCH   0(WRK6)             TEST CHANNEL                         14050002
         BR    WRKEVEN             RETURN TO CALLER                     14062002
         EJECT                                                          14070002
***                                                           ***       14090002
*              EXIT FROM TEST CHANNEL                           *       14100002
***                                                           ***       14107002
ITCH070  BAL   LNKR,EFRUCBL1       GO FREE UCBLOCK                      14114002
         SPACE 1                                                        14130002
         L     IOQR,IRTIOQ         RESTORE IOQE ADDRESS                 14135002
         SPACE 1                                                        14141002
***                                                           ***       14150002
*              ENQUEUE REQUEST IF NECESSARY                     *       14160002
***                                                           ***       14170002
         TM    IOQFLA,IOQENQ       IS IOQE ENQUEUED?                    14190002
         BO    ITCH080             YES - DON'T ENQUEUE IT AGAIN         14196002
         OI    IOQFLA,IOQLBSY+IOQPBSY    SET PHYSICAL BUSY     @YM5507  14202041
         SPACE 1                                                        14220002
         L     WRK1,IRTLCHAD       SET FOR ENQ CALL            @YM01627 14225002
         BAL   LNKR,EQUEE2         NO - GO ENQUEUE REQUEST              14230002
         SPACE 1                                                        14250002
***                                                           ***       14251002
*              IF ELIGIBLE, TRY TO HAVE OTHER CPU START REQUEST *       14260002
***                                                           ***       14269002
ITCH080  L     WRKC,IRTLCHAD       LOAD LCH ADDRESS            @YM01627 14278002
         TM    IOSOPT2,IOSHTP      IS IT ELIGIBLE SHOULDER TAP?         14287002
         BO    ITCH100             YES - ATTEMPT IT                     14310002
         SPACE 1                                                        14311002
***                                                           ***       14388002
*              DETERMINE WHICH VECTOR TO RETURN ON              *       14396002
***                                                           ***       14411002
ITCH090  L     LNKR,IRTTCHSV       RESTORE RETURN REGISTER              14430002
         TM    IRTFLB,IRTCHBSY     ARE ALL CHANNELS BUSY                14440002
         BO    NXTLCH(LNKR)        YES - RETURN TO TRY NEXT LCH         14450002
         B     NXTIOQ(LNKR)        NO - TRY NEXT ON QUEUE               14460002
         EJECT                                                          14470002
***                                                           ***       14478002
*              DETERMINE IF SHOULDER TAP WOULD BE EFFECTIVE     *       14486002
***                                                           ***       14494002
ITCH100  LH    WRKA,PSACPUSA       GET PHYSICAL CPU ADDRESS             14502002
         SLR   WRKB,WRKB           SET TO CPU A                         14520002
         CR    WRKA,WRKB           ARE WE IN CPU A?                     14530002
         BNE   ITCH110             NO - WRKB OK                         14540002
         SPACE 1                                                        14550002
         LA    WRKB,ONE            YES IN A. POINT AT B                 14555002
ITCH110  SLL   WRKB,TWO            MULTIPLY BY LENGTH OF VECTOR         14560002
         L     WRKA,CVTPTR         GET CVT POINTER                      14580002
         USING CVTMAP,WRKA         INDICATE CVT ADDRESSABILITY          14582002
         SPACE 1                                                        14592002
         L     WRKEVEN,CVTLCCAT    GET LCCA VECTOR TABLE ADDRESS        14610002
         L     WRKODD,CVTPCCAT     GET PCCA VECTOR TABLE ADDRESS        14620002
         DROP  WRKA                                                     14630002
         SPACE 1                                                        14640002
         L     WRKEVEN,0(WRKEVEN,WRKB)                                  14650002
*                                  GET LCCA OTHER CPU                   14660002
         LTR   WRKEVEN,WRKEVEN     VALID                                14665002
         BZ    ITCH090             NO - EXIT                            14670002
         L     WRK1,0(WRKODD,WRKB)                                      14690002
*                                  GET PCCA OTHER CPU                   14695002
         LTR   WRK1,WRK1           VALID                                14700002
         BZ    ITCH090             NO - EXIT                            14710002
         LA    WRKODD,PCCACAT-PCCA(WRK1)                                14720002
*                                  POINT AT CAT OTHER CPU               14730002
         L     WRKA,LCHTCH         GET CHANNEL LIST POINTER             14750002
         SPACE 1                                                        14760002
***                                                           ***       14770002
*              DETERMINE IF CHANNEL AVAILABLE OTHER CPU         *       14780002
         TM    IOSPATH,IOSGDP      GUAR. DEVICE PATH REQ?      @ZA03601 14790040
         BNO   ITCH115             NO,CONTINUE TEST CHAN AVAIL @ZA03601 14791040
         SPACE                                                          14792040
         LH    WRK6,ZERO(WRKA)     GET THE PATH                @ZA03601 14793040
         B     ITCH145             AND BYPASS CHANNEL TESTS    @ZA03601 14794040
ITCH115  IC    WRK0,UCBCHM         GET CHANNEL MASK            @ZA03601 14795040
         LA    WRKC,X'80'               GET PRIMARY PATH BIT   @ZA03601 14800540
         CLI   PSACPUSA+1,ZERO          CPU0?                  @ZA03601 14801040
         BNE   ITCH120                  NO-SHIFT FOR ZERO      @ZA03601 14801540
         SRL   WRKC,TWO                 YES-SHIFT FOR ONE      @ZA03601 14802040
ITCH120  NR    WRK0,WRKC                LOGICAL PRIM.PATH AVAIL@ZA03601 14802540
         BZ    ITCH143             YES - GO TEST CHANNEL       @ZA05679 14803040
ITCH125  LA    WRKC,X'40'               GET SECONDARY PATH BIT @ZA03601 14803540
         IC    WRK0,UCBCHM              GET CHAN MASK          @ZA03601 14804040
         CLI   PSACPUSA+1,ZERO          CPU0?                  @ZA03601 14804540
         BNE   ITCH130                  NO-SHIFT FOR ZERO      @ZA03601 14805040
         SRL   WRKC,TWO                 YES-SHIFT FOR ONE      @ZA03601 14805540
ITCH130  NR    WRK0,WRKC                LOGICAL SEC. PATH      @ZA03601 14806040
         BNZ   ITCH090             NO- EXIT                    @ZA03601 14806540
ITCH140  EQU   *                                               @ZA05679 14807040
         LA    WRKA,NXTCHN(WRKA)        BUMP PATH POINTER      @ZA05679 14807240
ITCH143  EQU   *                                               @ZA05679 14807440
         LH    WRK6,ZERO(WRKA)          GET PATH               @ZA05679 14807640
         LTR   WRK6,WRK6                END OF PATH TBL        @ZA03601 14808040
         BM    ITCH090                  YES-EXIT               @ZA03601 14808540
         LR    WRKC,WRK6                LET'S IOSLATE CHAN     @ZA03601 14810040
         SRL   WRKC,EIGHT               BY SHIFTING            @ZA03601 14810540
         SLL   WRKC,CATELP2             MULTIPLY BY CAT ENTRY  @ZA03601 14811040
         ALR   WRKC,WRKODD              ADDR OF OTHER CPU CAT  @ZA03601 14811540
         TM    CATFLA-CAT(WRKC),CATBSY  CHAN BSY OTHER CPU     @ZA03601 14812040
         BO    ITCH125                  YES                    @ZA03601 14812540
         TM    CATFLG-CAT(WRKC),CATNOP+CATNGEN+CATNCPU         @ZA05670 14813040
*                                       CHAN OPER.ON OTHER CPU?@ZA03601 14813540
         BNZ   ITCH125                  NO                     @ZA03601 14814040
ITCH145  SRL   WRK6,EIGHT               GET CHAN NO.           @ZA03601 14816540
*************  HOOK - CHANNEL RECONFIGURATION HARDWARE  *******@Y30CQLF 15163003
* CRH OVERLAYS THIS INSTRUCTION WITH THE BRANCH AT IECVHK1B.   @Y30CQLF 15164041
*************                                           *******@Y30CQLF 15165003
IECVHK1A L     WRKC,IOCCTBL       POINT AT THE CHANNEL TABLE   @Y30CQLF 15166003
         TM    IOSOPT2,IOSIGP     OK TO SIGP?(SIGP BEFORE?)    @ZA18121 15166341
         BZ    ITCH090              NO           (YES)         @ZA18121 15166641
         SPACE 1                                               @Y30CQLF 15167003
         USING CHT,WRKC            INDICATE CHT ADDESSSABILITY          15173202
         SPACE 1                                                        15184402
         SLL   WRK6,CHTELP2        COMPUTE OFFSET TO THE ENTRY          15195602
         L     WRK0,IRTCHMSK-LCCA(WRKEVEN) POINT AT OTHER CHANNEL MASK  15201202
         LH    WRKC,CHTMASK(WRK6)  LOAD THIS CHANNEL'S MASK             15212402
         SLL   WRKC,16             SHIFT TO HIGH HALF FOR MASK          15223602
         DROP  WRKC                                                     15234802
         SPACE 1                                                        15240402
         NI    IOSOPT2,FF-IOSIGP   MARK INELIGIBLE FOR SIGP    @ZA27026 15245441
ITCH158  LR    WRKODD,WRK0              COMPARE & SWAP THI     @ZA03601 15254340
         OR    WRKODD,WRKC         *CHANNEL'S INDICATOR                 15262802
         CS    WRK0,WRKODD,IRTCHMSK-LCCA(WRKEVEN)                       15274002
*                                  LOOP UNTIL IT IS SUCCESSFUL          15285202
         BNE   ITCH158                  TRY AGAIN              @ZA03601 15290840
         SPACE 1                                                        15302002
         TM    IRTCMRST-LCCA(WRKEVEN),FF   IS IOS ACTIVE OTHER CPU?     15313202
         BO    ITCH090             YES - RETURN                         15324402
         OI    IRTCMRST-LCCA(WRKEVEN),FF   SET IOS ACTIVE       @YM6900 15331402
         SPACE 1                                                        15340002
***                                                           ***       15360002
*              SHOULDER TAP OTHER CPU                           *       15367002
***                                                           ***       15374002
         LR    WRKA,WRKEVEN        SAVE LCCA ADDRESS            YM01752 15381002
         RPSGNL     SIO,CPU=(1)                                         15400002
*****                                                           *****   15405002
*              PROCESS RETURN CODE.                                 *   15420002
*****                                                           *****   15426002
         LTR   WRKODD,WRKODD       TEST RETURN CODE             YM01752 15432002
         BZ    ITCH090             RETURN - DONT SET OTHER ACTV YM01752 15440040
*                                  SIGP DIDN'T GO,NON-ZERO R.C.@ZA03601 15441040
         OI    IOSOPT2,IOSIGP      SET ELIGIBLE FOR SIGP       @ZA18121 15441341
         NI    IRTCMRST-LCCA(WRKA),ZERO SET IOS IN-ACTIVE      @ZA10766 15441600
         B     ITCH090             RETURN                               15470002
         SPACE 1                                               @Y30CQLF 15471003
*************  HOOK - CHANNEL RECONFIGURATION HARDWARE  *******@Y30CQLF 15472003
* CRH OVERLAYS THE INSTRUCTION AT IECVHK1A WITH THIS BRANCH.   @Y30CQLF 15473003
*************                                           *******@Y30CQLF 15474003
IECVHK1B B     ITCH300                 GO TO HOOK CODE         @Y30CQLF 15475003
*************                                           *******@Y30CQLF 15476003
         EJECT                                                          15480002
***                                                           ***       15488002
*              THIS SUBROUTINE INSURES THE CORRECT CPU          *       15496002
***                                                           ***       15504002
ITCH160  LH    WRK6,ZERO(WRKA)     GET NEXT CHANNEL FROM LIST           15512002
         LTR   WRK6,WRK6           END OF LIST?                         15530002
         BM    ITCH198             YES - TERMINATE                      15535002
         SPACE 1                                                        15540002
         CLC   IOSAFF,PSACPUSA+ONE CORRECT CPU?                         15550002
         BNE   ITCH200             NO -  IS CORRECT CPU ALIVE?          15570002
         SPACE 1                                                        15575002
         NI    IOSOPT2,FF-IOSHTP   CORRECT CPU - NO SHOULDER TAP        15580002
         LR    WRKEVEN,WRK6        COPY CHANNEL TO WORK REG             15600002
         N     WRKEVEN,CONF0030    ISOLATE CHANNEL NUMBER        M01051 15605002
         LH    WRK1,IOSPATH        GET REQUESTED PATH                   15620002
         TM    ONE(WRKA),FF-F      SELECTOR SUBCH                M01051 15625002
         BZ    ITCH164             NO AND OFF CU ALSO            M01051 15630002
         N     WRK1,CONF0030       AND OFF DEV ONLY              M01051 15640002
         B     ITCH166             GO COMPARE                    M01051 15650002
ITCH164  N     WRK1,CONF0015       ISOLATE CHANNEL NUMBER        M01051 15660002
ITCH166  CR    WRKEVEN,WRK1        CORRECT CHANNEL?              M01051 15670002
         BE    ITCH170             YES - NOW TEST RESERVED              15690002
         SPACE 1                                                        15698002
         NI    IRTFLB,FF-IRTCHBSY  NO - RESET ALL CHANNELS BUSY         15706002
         LA    WRKA,NXTCHN(WRKA)   POINT AT NEXT CHANNEL IN LIST        15714002
         B     ITCH160             TRY NEXT PATH                        15722002
         SPACE 3                                                        15740002
ITCH170  TM    UCBFLB,UCBRESVH     IS DEVICE RESERVED?                  15742002
         BZ    ITCH195             NO - CONTINUE                YM01677 15750002
         BAL   LNKR,ITCH210        YES - TEST FOR CORRECT PATH          15770002
         SPACE 1                                                        15780002
         B     ITCH195             CORRECT CPU AND PATH - START YM01677 15790002
         B     ITCH180             WRONG PATH - TERMINATE               15800002
*        B     ITCH180             WRONG CPU - TERMINATE                15810002
         SPACE 3                                                        15818002
ITCH180  MVI   IOSCOD,IOSGDPRD     GDP RESERVED WRONG PATH              15826002
ITCH190  BAL   LNKR,ESCHDIO1       SCHEDULE THE SRB                     15834002
         SPACE 1                                                        15842002
         L     LNKR,IRTTCHSV       RESTORE RETURN REGISTER              15850002
         BR    LNKR                RETURN +0                            15858002
         SPACE 3                                                        15866002
ITCH195  L     WRK1,PSAPCCAV       LOAD PCCA ADDR               YM01677 15874002
         SRL   WRKEVEN,EIGHT       ISOLATE CHANNEL NUMBER      @ZA31965 15890041
         SLL   WRKEVEN,CATELP2     CALCULATE CAT DISPLACEMENT  @ZA31965 15896041
         LA    WRK0,PCCACAT(WRKEVEN) LOAD CAT ADDRESS FOR RET   YM01677 15910002
         LR    WRKEVEN,WRK0        CAT ADDRESS TO WRKEVEN      @ZA30350 15915041
         USING CAT,WRKEVEN                                     @ZA30350 15915841
         TM    CATFLG,CATDSABL     CHANNEL DISABLED            @ZA30350 15916641
         BNO   ITCH040             NO-START PATH               @ZA30350 15917441
         DROP  WRKEVEN                                         @ZA30350 15918241
         DROP  WRK1                                                     15920002
         SPACE 3                                                        15930002
ITCH198  MVI   IOSCOD,IOSGDPCC     REQUESTED PATH NOT FOUND             15940002
         B     ITCH190             GO TERMINATE REQUEST                 15950002
         SPACE 3                                                        15960002
***                                                           ***       15970002
*              TERMINATE REQUEST FOR I/O RESTART                *       15980002
***                                                           ***       15990002
************* CHANNEL RECONFIGURATION HARDWARE SUPPORT ********@Y30CQLF 15995003
ITCH199  L     WRKA,CVTPTR             GET ADDRESS OF CVT      @Y30CQLF 16000003
         USING CVTMAP,WRKA             ESTABLISH ADDRESSABILITY@Y30CQLF 16001003
         L     WRKA,CVTCRCA            GET ADDRESS OF CRCA     @Y30CQLF 16002003
         LTR   WRKA,WRKA               CRH ACTIVE ?            @Y30CQLF 16003003
         BZ    ITCH199A            NO, SEE IF DRIVER IS EXCP   @ZA01911 16004003
         NI    UCBFLB,FF-UCBIORST  CRH ACTIVE, RESET RESTART   @ZM34510 16005003
*                                  FLAG                                 16007003
         B     ITCH005              GO TRY AND RESTART REQUEST @ZA04573 16008040
         SPACE                                                          16009003
ITCH199A CLI   IOSDVRID,IOSXCPID   IS DRIVER EXCP?             @ZA01911 16009503
         BE    ITCH199B            YES, SET UNIQUE CODE FOR    @ZA01911 16010003
*                                  DOUBLE PASS THRU APPENDAGE           16010503
         MVI   IOSCOD,IOSMIHCA     SET CODE FOR I/O RESTART    @ZA01911 16011003
*                                  INTERCEPT CONDITION                  16011503
         B     ITCH190             AND TERMINATE THE REQUEST   @ZA01911 16012003
         SPACE                                                          16012503
ITCH199B MVI   IOSCOD,IOSMIHC      INSURE TWO PASSES THRU ABE  @ZA01911 16013003
         MVC   IOSTATUS(TWO),CONB0002 MOVE SIMULATED STATUS FOR         16013503
*                                  CHANNEL CONTROL CHK & INTER-         16014003
*                                  FACE CONTROL CHECK                   16014503
         L     WRKB,IOSERP         GET EWA PTR FROM IOSB       @ZA05981 16014640
         LTR   WRKB,WRKB           IS THERE AN EWA             @ZA05981 16014740
         BNZ   ITCH199G            YES - GO INITIALIZE IT      @ZA05981 16014840
         BAL   LNKR,ESMINTG3       INTERFACER WITH SMGR TO GET @ZA01911 16015003
*                                  A 160 BYTE BLK/EWA                   16015503
         ST    WRKB,IOSERP         SAVE EWA ADDRESS IN IOSB    @ZA01911 16016003
ITCH199G EQU   *                                               @ZA05981 16016240
         LH    WRKA,IOSUCB+2       GET UCBOB ADDRESS           @ZA01911 16016503
         STH   WRKA,EWAUCB-EWA+1(WRKB) SAVE UCBOB ADDR IN EWA  @ZA01911 16017003
         OI    EWARGFG1-EWA(WRKB),EWANORTY SET NO-RETRY FLAG   @ZA01911 16017503
         OI    EWARGFG2-EWA(WRKB),EWACCPU INDICATE CPU ERROR   @ZA01911 16018003
         IC    WRKA,UCBCPU         SAVE CPUID, OF THE LAST     @ZA01911 16018503
         STC   WRKA,EWACPU-EWA(WRKB) I/O THAT WAS ATTEMPTED    @ZA01911 16019003
         LH    WRKA,UCBCHAN        SAVE UNIT ADDRESS OF THE             16019503
         STH   WRKA,EWACHA-EWA(WRKB) LAST I/O THAT WAS ATTEMPTD@ZA01911 16020003
         OI    EWAXCSW1-EWA(WRKB),EWACSQV SET SEQ.CODE IS INVAL@ZA01911 16020503
         OI    EWAXCSW2-EWA(WRKB),EWACSEQ SET CHAN DEP SEQ CODE@ZA01911 16021003
         B     ITCH190             SCHEDULE ASYN PROCESSING FOR@ZA01911 16021503
*                                  POST STATUS                          16022003
*              TEST IF REQUESTED CPU IS ON-LINE                 *       16040002
***                                                           ***       16060002
ITCH200  NI    IRTFLB,FF-IRTCHBSY  RESET ALL CHANNELS BUSY              16065002
         L     WRKA,CVTPTR         POINT AT CVT                         16070002
         USING CVTMAP,WRKA         INDICATE CVT ADDRESSABILITY          16090002
         SPACE 1                                                        16096002
         SLR   WRKODD,WRKODD       ZERO REGISTER FOR USING              16102002
         IC    WRKODD,IOSAFF       GET CORRECT CPU NUMBER               16110002
         SLL   WRKODD,2            MULTIPLY TO INDEX INTO TABLE         16120002
         A     WRKODD,CVTPCCAT     POINT AT THE PCCA VECTOR TABLE       16130002
         L     WRKODD,ZERO(WRKODD) POINT AT CORRECT PCCA                16140002
         LTR   WRKODD,WRKODD       IS PCCA THERE                        16150002
         BZ    ITCH198             NO - TERMINATE IN ERROR              16160002
************* CHANNEL RECONFIGURATION HARDWARE SUPPORT ********@Y30CQLF 16162003
         L     WRKEVEN,CVTCRCA     GET ADDRESS OF CRCA         @Y30CQLF 16165003
         LTR   WRKEVEN,WRKEVEN     CRH ACTIVE ?                @Y30CQLF 16170003
         BNZ   ITCH070                 YES,GO TRY SHOULDER TAP @Y30CQLF 16175003
***************************************************************@Y30CQLF 16177003
         L     WRKA,CVTCSD         POINT AT SYSTEM DATA AREA            16180002
         DROP  WRKA                                                     16188002
         USING CSD,WRKA            INDICATE CSD ADDRESSABILITY          16196002
         SPACE 1                                                        16204002
         LH    WRKEVEN,CSDCPUAL    GET CPU ALIVE MASK                   16212002
         DROP  WRKA                                                     16220002
         SPACE 1                                                        16228002
         LH    WRKODD,PCCACAFM-PCCA(WRKODD)                             16236002
*                                  GET MASK FOR CORRECT CPU             16250002
         NR    WRKEVEN,WRKODD      TEST IF CPU ALIVE                    16260002
         BNZ   ITCH070             YES - EXIT FROM ETCH1                16280002
         SPACE 1                                                        16286002
***                                                           ***       16292002
*              REQUESTED CPU IS OFF-LINE                        *       16300002
***                                                           ***       16310002
         MVI   IOSCOD,IOSGDPCO     GDP - CPU OFFLINE                    16330002
         B     ITCH190             GO TERMINATE REQUEST                 16340002
         EJECT                                                          16350002
***                                                           ***       16360002
*              INSURE THE RESERVED PATH TO A SHARED DASD        *       16370002
***                                                           ***       16380021
ITCH210  CLC   PSACPUSA+ONE(ONE),UCBCPU IS IT CORRECT CPU?              16385002
         BE    ITCH230             SAME CPU - CONTINUE                  16400002
ITCH220  NI    IRTFLB,FF-IRTCHBSY  RESET ALL CHANNELS BUSY              16410002
         B     WCPUXPTH(LNKR)      RETURN - WRONG CPU                   16420002
         SPACE 3                                                        16430002
***                                                           ***       16440002
*              CORRECT CPU - TEST PATH                          *       16450002
***                                                           ***       16460002
ITCH230  TM    UCBFLB,UCBCRHRV         RESERVED ON DEAD CPU    @Y30CQLF 16465003
         BO    ITCH220                 YES,GO SHOULDER TAP     @Y30CQLF 16472003
         LR    WRKODD,WRK6         GET ATTEMPTED PATH                   16480002
         N     WRKODD,CONF0015     ISOLATE CHANNEL ADDRESS              16489002
         LH    WRK0,UCBCHAN        GET LAST PATH STARTED                16498002
         N     WRK0,CONF0015       ISOLATE CHANNEL ADDRESS              16507002
         CR    WRKODD,WRK0         ARE THEY EQUAL?                      16516002
         BE    RCPURPTH(LNKR)      YES - RETURN OK                      16525002
         NI    IRTFLB,FF-IRTCHBSY  NO - RESET ALL CHANNELS BUSY         16534002
         B     RCPUWPTH(LNKR)      RETURN - WRONG PATH                  16543002
         EJECT                                                          16552002
***                                                           ***       16561002
*              INTERCEPT CODE                                   *       16570002
***                                                           ***       16579002
ITCH240  TM    UCBFLC,UCBWAA       IS EWA PRESENT              @ZA12388 16580000
         BZ    ITCH270             NO - BRANCH                 @ZA12388 16581000
         SPACE 1                                                        16582000
         L     WRKC,UCBIOQ         GET ADDRESS OF EWA          @ZA12388 16583000
         MVI   IOSCOD,IOSFINTC     SET INTERCEPT CODE                   16597002
         USING EWA,WRKC            SINDICATE EWA ADDRESSABILITY         16606002
         SPACE 1                                                        16615002
         MVC   IOSCSW,EWASCSW      MOVE CSW TO IOSB                     16630002
         MVC   IOSSNS,EWASNS       MOVE SENSE TO IOSB                   16640002
         TM    EWAFLG1,EWABDSNS    DID SENSE FAIL?                      16660002
         BZ    ITCH250             NO - CONTINUE                        16662002
         SPACE 1                                                        16680002
         MVC   IOSSNS,CONH0005     SIMULATE EQUIP. CHECK                16682002
         SPACE 1                                                        16690002
***                                                           ***       16700002
*              TEST IF REQUEST ALREADY HAS A WORK AREA          *       16710002
***                                                           ***       16720002
ITCH250  L     WRKA,IOSERP         GET CURRENT WORK AREA                16730002
         LTR   WRKA,WRKA           TEST FOR ONE                         16740002
         BZ    ITCH260             BRANCH IF NONE                       16750002
         SPACE 1                                                        16760002
         OC    EWAFLG1-EWA(ONE,WRKA),EWAFLG1 COPY FLAG1 OVER            16780002
         MVC   EWACHA-EWA(TWO,WRKA),EWACHA COPY CHANNEL ADDRESS         16785002
         MVC   EWACPU-EWA(ONE,WRKA),EWACPU COPY CPU ADDRESS OVER        16790002
         DROP  WRKC                                                     16800002
         SPACE 1                                                        16810002
         L     WRK1,UCBEXTPT       LOAD EXTENTION POINTER               16820002
         USING UCBCMEXT,WRK1                                            16830002
         IC    WRK1,UCBSNSCT       GET SENSE BYTE COUNT                 16840002
         BCTR  WRK1,0              SUBTRACT ONE                         16850002
         EX    WRK1,CONH0006       COPY SENSE BYTES OVER                16860002
         LR    WRK1,WRKC           PREPARE TO FREE WORK AREA            16870002
         BAL   LNKR,ESMINTF3       GO FREE IT                           16880002
         SPACE 1                                                        16890002
         LR    WRKC,WRKA           USE CURRENT WORK AREA                16900002
         B     ITCH265             GO RESET FLAGS                       16910002
         SPACE 1                                                        16920002
ITCH260  ST    WRKC,IOSERP         STORE ERP WORK AREA ADDRESS          16930002
         SH    WRKC,CONH0004       BACK UP 8 IN FRONT OF EWA            16940002
         MVC   ZERO(TWO,WRKC),IOSASID SET ASID FOR STOR. MGMT           16950002
         SPACE 1                                                        16970002
ITCH265  NI    UCBFLC,FF-UCBITF-UCBWAA RESET FLAGS                      16975002
         BAL   LNKR,ESCHDIO1       GO SCHEDULE SRB                      16980002
         L     LNKR,IRTTCHSV       RESTORE RETURN REGISTER              17000002
         BR    LNKR                RETURN +0                            17008002
         SPACE 1                                                        17010000
ITCH270  NI    UCBFLC,FF-UCBITF    RESET INTERCEPT FLAG        @ZA12388 17012000
         B     ITCH003             CONTINUE WITH REQUEST       @ZA12388 17014000
         EJECT                                                 @Y30CQLF 17016003
*************  HOOK - CHANNEL RECONFIGURATION HARDWARE  *******@Y30CQLF 17016503
* IF THE CRH FUNCTION IS ACTIVE THE CRH TEST CHANNEL HOOK      @Y30CQLF 17017003
* ROUTINE IS CALLED TO ATTEMPT TO START AN I/O REQUEST.        @Y30CQLF 17017503
*************                                           *******@Y30CQLF 17018003
ITCH300  L     WRKC,IOCCTBL       EXECUTE OVERLAID INSTRUCTION @Y30CQLF 17018503
         L     WRKA,CVTPTR        GET ADDRESS OF CVT           @ZA34207 17019041
         USING CVTMAP,WRKA        ESTABLISH ADDRESSABILITY     @ZA34207 17019341
         L     WRKA,CVTCRCA       GET ADDRESS OF CRCA          @ZA34207 17019641
         LTR   WRKA,WRKA          CRH ACTIVE ?                 @ZA34207 17019941
         BZ    IECVHK1A+FOUR      CRH NOT ACTIVE - RETURN      @Y30CQLF 17020241
         LR    WRK1,WRKA           SET WRK1 FOR HOOK ROUTINE   @ZA34207 17020541
         USING CRCA,WRK1          ESTABLISH ADDRESSABILITY     @Y30CQLF 17021503
         L     WRKODD,CRCACRH1    GET ADDRESS OF HOOK ROUTINE  @Y30CQLF 17022003
         BALR  WRKEVEN,WRKODD     CALL HOOK ROUTINE            @Y30CQLF 17022503
         B     ITCH090            EXIT FROM TEST CHANNEL ROUTIN@Y30CQLF 17023003
         B     ITCH070             HANDLE +4 RETURN            @ZM30442 17023503
***                                                          ***        17024002
*              DROP ALL BUT BASE ADDRESSABILITY                *        17032002
***                                                          ***        17040002
         DROP  WRK1,IOSBR,LCCAR,UCBR,IOQR,WRKA                 @ZA34207 17048041
         TITLE 'IECIOSCN - IOS - SIO SUBROUTINE'                        17056002
*********ESIO1***************************************************       17080002
*                                                               *       17087002
*                                                               *       17094002
* FUNCTION                                                      *       17110002
*    1. SETS UP THE CAW                                         *       17120002
*    2. ISSUES THE SIO INSTRUCTION                              *       17130002
*    3. TRACES THE RESULTS                                      *       17140002
*    4. STORES THE RESULTS IN THE IOSB                          *       17150002
*    5. SETS THE UCB RESERVE FLAG                               *       17155002
*    6. UPDATES THE MF/1 SIO COUNTS ON CC=0                     *       17160002
*                                                               *       17180002
* ENTRY POINTS                                                  *       17186002
*         ESIO1 - EXIT TO POST SIO (SIOF)                       *       17192002
*         ESIO2 - RETURN TO CALLER (SIOF)                       *       17210002
*         ESIO099 - EXIT TO POST SIO (SIO)                      *       17215002
*         ESIO100 - RETURN TO CALLER (SIO)                      *       17220002
*                                                               *       17230002
* INPUT                                                         *       17250002
*    REGISTERS                                                  *       17256002
*              WRK0    =CAT ADDRESS  (PASSED THRU DEV DEP RTN ) *       17262002
*              IOSBR   =IOSB ADDRESS                            *       17280002
*              LCCAR   =LCCA ADDRESS (INCLUDING IRT)            *       17289002
*              LNKR    =RETURN ADDRESS                          *       17298002
*              BASEA   =BASE ADDRESS A                          *       17307002
*              WRK6    =DEVICE ADDRESS                          *       17316002
*              UCBR    =UCB ADDRESS                             *       17325002
*              BASEB   =BASE ADDRESS B                          *       17334002
*              BASEC   =BASE ADDRESS C                          *       17343002
*              IOQR    =IOQE ADDRESS                            *       17352002
*              WRKC    =ADDRESS OF CHANNEL PROGRAM              *       17361002
*                                                               *       17380002
*    FIELDS                                                     *       17390002
*              CATSIOCT IOSCKEY  UCBFLC   IRTIOQ   UCBMFCNT     *       17400002
*                                                               *       17410002
*    LOCKS                                                      *       17420002
*              UCBLOCK                                          *       17430002
*                                                               *       17440002
* OUTPUT                                                        *       17450002
*    REGISTERS                                                  *       17460002
*              WRK1    =DESTROYED                               *       17470002
*              WRKA    =DESTROYED                               *       17480002
*              WRKC    =SIO/SIOF CONDITION CODE                @ZA10149 17485000
*              WRKEVEN =DESTROYED                               *       17500002
*                                                               *       17510002
*    FIELDS                                                     *       17520002
*              CATSIOCT IOSCC    UCBCHA   UCBCPU   UCBFLA       *       17530002
*              UCBFLC   UCBIOQ   UCBMFCNT                       *       17540002
*                                                               *       17550002
*    LOCKS                                                      *       17560002
*              UCBLOCK                                          *       17570002
*                                                               *       17580002
* EXTERNAL REFERENCES                                           *       17590002
*    CVTTRACE                                                   *       17600002
*                                                               *       17610002
* EXITS                                                         *       17620002
*    +0 =SIO ISSUED                                             *       17630002
*                                                               *       17640002
* TABLES/WORKAREAS                                              *       17650002
*    CAT                                                        *       17660002
*    CVT                                                        *       17670002
*    FLC                                                        *       17680002
*    IOQ                                                        *       17690002
*    IOSB                                                       *       17700002
*    UCB                                                        *       17710002
*                                                               *       17720002
*****************************************************************       17730002
         EJECT                                                          17740002
***                                                           ***       17750021
*              INDICATE ALL BUT BASE ADDRESSABILITY             *       17760002
***                                                           ***       17770002
         USING IOSB,IOSBR          INDICATE IOSB ADDRESSABILITY         17780002
         USING LCCA,LCCAR          INDICATE LCCA ADDRESSABILITY         17790002
         USING UCB,UCBR            INDICATE UCB  ADDRESSABILITY         17795002
         USING IOQ,IOQR            INDICATE IOQE ADDRESSABILITY         17800002
         SPACE 1                                                        17810002
         ENTRY IECHK1              MAKE ENTRY POINT EXTERNAL            17830002
         ENTRY IECHK8              MAKE ENTRY POINT EXTERNAL            17835002
         SPACE 1                                                        17850002
*                                                                       17855002
         CNOP  2,4                                                      17860002
*                                  FORCE ESIO3 TO WORD BDY              17870002
***                                                           ***       17890002
*              SET UP THE CAW                                   *       17895002
***                                                           ***       17900002
ESIO1    LA    LNKR,EPOSTIO1       SET EXIT FOR POST SIO                17920002
ESIO2    ST    WRKC,FLCCAW         SET THE CAW                          17930002
         STCM  WRKC,SEVEN,IOSCSWCA SAVE CAW CONTENTS                    17940002
         MVZ   FLCCAW(ONE),IOSCKEY SET THE CHAN PROG PROTECT KEY        17945002
         SPACE 1                                                        17950002
***                                                           ***       17960002
*              ISSUE THE SIOF INSTRUCTION                        *      17970002
***                                                           ***       17980002
         SIOF  ZERO(WRK6)          START THE CHANNEL PROGRAM            17990002
         SPACE 1                                                        18010021
***                                                           ***       18020002
*              THE INSTRUCTION FOLLOWING THE SIO MUST BE        *       18022002
*              LABELED 'IECHK1' FOR DSS.                        *       18030002
*              SAVE OFF THE SIO CONDITION CODE                  *       18050002
***                                                           ***       18060002
IECHK1   BALR  WRKC,0              SET THE CONDITION CODE               18061002
         SPACE 1                                                        18063003
*************  HOOK - CHANNEL RECONFIGURATION HARDWARE  *******@Y30CQLF 18065003
* CRH OVERLAYS THIS INSTRUCTION WITH THE BRANCH AT IECVHK2B.   @Y30CQLF 18067003
*************                                           *******@Y30CQLF 18069003
IECVHK2A STH   WRK6,UCBCHAN       SET LAST PATH STARTED        @Y30CQLF 18071003
         SPACE 1                                                        18073003
         SRL   WRKC,TWENTY4        SET IN HI-ORDER BYTE                 18080002
         STC   WRKC,IOSCC          STORE CONDITION CODE IN IOSB         18086002
         SPACE 1                                                        18092002
***                                                           ***       18110002
*              FILL IN UCB INFO ABOUT THIS SIO                  *       18110202
***                                                           ***       18130021
         ST    IOQR,UCBIOQ         SET LAST IOQE STARTED                18140002
         MVC   UCBCPU,PSACPUSA+ONE SET LAST CPU STARTED                 18145002
         SPACE 1                                                        18170002
***                                                           ***       18180002
*              'HOOK' THE SIO FOR GTF                           *       18190002
***                                                           ***       18198002
         HOOK  EID=IECSIO                                               18206002
         SPACE 1                                                        18214002
***                                                           ***       18222002
*              SET UCB RESERVE/RELEASE INDICATOR IF NECESSARY   *       18230002
***                                                           ***       18240002
         BC    4+2+1,ESIO3         IF SIO FAILED, DO NOT CHANGE         18250002
         SPACE 1                                                        18270002
         TM    IOQFLB,IOQRESV      WAS CCW A RESERVE?                   18276002
         BZ    ISIO010             NO, CHECK FOR A RELEASE              18282002
         SPACE 1                                                        18290002
         OI    UCBFLB,UCBRESVH     SHOW DEVICE RESERVED                 18300002
         OI    UCBFL4,UCBRESVP     SHOW RESERVE IS PENDING     @ZA12415 18305000
ISIO010  TM    IOQFLB,IOQRLSE      WAS CCW A RELEASE?                   18310002
         BZ    ESIO3               NO, CLEAR RESERVE/RELEASE FLAG       18320002
         SPACE 1                                                        18340002
         NI    UCBFLB,FF-UCBRESVH  CLEAR UCB RESERVED FLAG              18342002
         NI    UCBFL4,FF-UCBRESVP  CLEAR PENDING RESERVE FLAG  @ZA12415 18351000
         SPACE 1                                                        18360002
***                                                           ***       18368002
*              SET IOQR AND CONDITION CODE AND EXIT             *       18376002
***                                                           ***       18384002
ESIO3    EQU   *                   TRACE / MF-1 HOOK ADDRESS            18392002
         B     ISIO050             ASSEMBLED AS TRACE ACTIVE            18400002
*                                  RESET AFTER IPL                      18410002
         SPACE 1                                                        18420002
ISIO020  SLL   WRKC,TWENTY4        SHIFT BACK                           18430002
*              RESET UCB UNSOLICITED DEVICE END INDICATOR               18440002
         NI    UCBFLC,FF-UCBUDE    CLEAR UCB FLAG               YM01243 18450002
         SPM   WRKC                SET COND CODE INTO PSW               18460002
         BR    LNKR                RETURN TO CALLER                     18470002
         SPACE 1                                                        18480002
***                                                           ***       18493202
*              UPDATE THE MF/1 SIO COUNTERS                     *       18510002
***                                                           ***       18516002
ESIO4    B     ISIO030             INSTR. TO ACTIVATE MF/1              18522002
ISIO41   L     IOQR,IRTIOQ         INSTR. TO DEACTIVATE MF/1   @ZA03249 18530040
ISIO42   B      ISIO050            DEACTIVATE MF/1, TRACE ON   @ZA03249 18535040
         SPACE 1                                                        18540002
*************  HOOK - CHANNEL RECONFIGURATION HARDWARE  *******@Y30CQLF 18541003
* CRH OVERLAYS THE INSTRUCTION AT IECVHK2A WITH THIS BRANCH.   @Y30CQLF 18542003
*************                                           *******@Y30CQLF 18543003
IECVHK2B B     ISIO0200           GO TO HOOK CODE              @Y30CQLF 18544003
***************************************************************@Y30CQLF 18545003
         SPACE 1                                                        18546003
ISIO030  TM    IOSCC,IOSCC3        TEST SIO CONDITION CODE              18550002
         BNZ   ISIO040             CC NE 0, NO COUNTS                   18560002
         LR    WRKA,WRK0           GET CAT ADDRESS                      18580002
         USING CAT,WRKA            INDICATE CAT ADDRESSABILITY          18590002
         SPACE 1                                                        18600002
         LH    WRKEVEN,CATSIOCT    GET CURRENT CHANNEL COUNT            18610002
         LA    WRKEVEN,ONE(WRKEVEN) INCREMENT COUNT                     18617002
         STH   WRKEVEN,CATSIOCT    STORE UPDATED COUNT                  18624002
         DROP  WRKA                                                     18631002
         L     WRKA,UCBEXTPT       LOAD EXTENTION POINTER               18640002
         USING UCBCMEXT,WRKA                                            18650002
         LH    WRKEVEN,UCBMFCNT    GET CURRENT UCB COUNT                18660002
         LA    WRKEVEN,ONE(WRKEVEN) INCREMENT COUNT                     18670002
         STH   WRKEVEN,UCBMFCNT    STORE UPDATED COUNT                  18680002
ISIO040  L      WRKB,CVTPTR        GET ADDRESS OF CVT          @ZA03249 18682040
         USING  CVTMAP,WRKB        INDICATE CVT ADDRESSABILITY          18684040
         CLI    CVTTRACE+1,XFA     CHECK IF TRACE ON           @ZA03249 18686040
         BE     ISIO049            TRACE ON -- GO PROCESS      @ZA03249 18688040
         L     IOQR,IRTIOQ         PICK UP ACTIVE IOQE                  18690040
         B     ISIO020             RETURN TO MAIN FLOW                  18700002
ISIO049  MVC    ISIO41(FOUR),ISIO42 ALLOW TRACE WHEN MF/1 OFF  @ZA03249 18705040
         SPACE 1                                                        18710002
***                                                           ***       18720002
*              TRACE THE SIO                                    *       18730002
*              NOTE : LIKE MF/1, SIO TRACE CAN BE DEACTIVATED   *       18740002
*              BY USING THE INSTRUCTION FOLLOWING 'ESIO4'       *       18760002
*              SIO TRACE IS ONLY ACTIVE DURING THE IPL SEQUENCE *       18765002
*              AND THE INSTRUCTION AT 'ESIO3' IS REPLACED AS    *       18770002
*              SOON AS THE IPL SEQUENCE IS COMPLETE. MF/1 TRACE *       18780602
*              IS THE ONLY TRACE SUPPORTED DURING NORMAL SYSTEM *       18793002
*              OPERATION.                                       *       18802002
***                                                           ***       18811002
ISIO050  L     WRK1,IOSSRB         SET SRB ADDRESS TO REG 1             18820002
         L     WRKA,CONF0017       GET ADDRESS OF SIO TRACE             18830002
         L     WRKB,CVTPTR         GET ADDRESS OF CVT                   18840002
         SPACE 1                                                        18860002
         BAL   WRKB,CVTTRACE       GO OUT TO TRACE                      18870002
         SPACE 1                                                        18880002
         IC    WRKC,IOSCC          RE-INSERT SIO COND CODE              18890002
         L     IOQR,IRTIOQ         PICK UP ACTIVE IOQ                   18900002
         B     ISIO020             RETURN TO MAIN FLOW                  18910002
         DROP  WRKB                DROP CVT ADDRESSABILITY              18920002
         SPACE 3                                                        18930002
**********                                                              18940002
*        START I/O INSTRUCTION FOR DEVICES WHICH SHOULD NOT             18950002
*        USE THE SIOF INSTRUCTION. (CURRENTLY SHARED DA IS              18960002
*        THE ONLY CLASS OF DEVICES USING THE SIO INSTRUCTION.)          18970002
*        AFTER STARTING THE I/O CONTROL IS TRANSFERED TO IECHK1         18980002
*        FOR COMMON PROCESSING.                                         18990002
*        NOTE: THIS ROUTINE IS NOW ALSO USED FOR THE SET MODE  @ZA04849 18993040
*        COMMAND ON READ/WRITE TAU                             @ZA04849 18996040
**********                                                              19000002
         SPACE 1                                                        19010002
ESIO099  LA    LNKR,EPOSTIO1       GET ADDR FOR POST SIO RETURN         19020002
ESIO100  ST    WRKC,FLCCAW         SET CAW                              19030002
         MVZ   FLCCAW(ONE),IOSCKEY SET CALLERS PROT KEY                 19040002
***                                                           ***       19050002
*              ISSUE SIO INSTRUCTION                            *       19060002
***                                                           ***       19070002
         SIO   ZERO(WRK6)          START THE I/O OP                     19080002
IECHK8   B     IECHK1              GO TO COMMON PROCESSING              19090002
         SPACE 3                                                        19100002
*************  HOOK - CHANNEL RECONFIGURATION HARDWARE  *******@Y30CQLF 19100503
* IF THE CRH FUNCTION IS ACTIVE THE CRH SIO HOOK ROUTINE IS    @Y30CQLF 19101003
* CALLED TO UPDATE THE UCB.                                    @Y30CQLF 19101503
*************                                           *******@Y30CQLF 19102003
ISIO0200 STH   WRK6,UCBCHAN       EXECUTE OVERLAID INSTRUCTION @Y30CQLF 19102503
         L     WRK1,CVTPTR        GET ADDRESS OF CVT           @Y30ZQLF 19103003
         USING CVTMAP,WRK1        ESTABLISH ADDRESSABILITY     @Y30CQLF 19103503
         L     WRK1,CVTCRCA       GET ADDRESS OF CRCA          @Y30CQLF 19104003
         LTR   WRK1,WRK1          CRH ACTIVE ?                 @Y30CQLF 19104503
         BZ    ISIO0210           CRH NOT ACTIVE - RESTORE CC  @Y30CQLF 19105003
         USING CRCA,WRK1          ESTABLISH ADDRESSABILITY     @Y30CQLF 19105503
         L     WRKODD,CRCACRH2    GET ADDRESS OF HOOK ROUTINE  @Y30CQLF 19106003
         BALR  WRKEVEN,WRKODD     CALL HOOK ROUTINE            @Y30CQLF 19106503
ISIO0210 SPM   WRKC                    RESTORE CONDITION CODE  @Y30CQLF 19107003
         B     IECVHK2A+FOUR      RETURN TO MAINLINE           @Y30CQLF 19107503
         DROP  WRK1                                            @Y30CQLF 19108003
***                                                           ***       19110002
*              DROP ALL BUT BASE ADDRESSABILITY                 *       19120002
***                                                           ***       19130002
         DROP  IOSBR,LCCAR,UCBR,WRKA                                    19140002
         TITLE 'IECIOSCN - IOS - POST SIO SUBROUTINE'                   19151002
*********EPOSTIO1************************************************       19170002
*                                                               *       19178002
* FUNCTION                                                      *       19186002
*    INSPECTS THE STATUS OF AN SIO OPERATION                    *       19194002
*     A. CC=0                                                   *       19202002
*        1. MARKS THE CHANNEL BUSY IN THE CAT IF A SELECTOR     *       19220002
*           CHANNEL                                             *       19227002
*        2. SETS UCB FLAGS                                      *       19234002
*        3. FREES THE UCBLOCK                                   *       19241002
*        4. DEQUEUES REQUEST FROM THE LCH                       *       19250002
*                                                               *       19270002
*     B. CC=1                                                   *       19275002
*        1. UPDATES SYSTEM RESOURCE MANAGER COUNT               *       19281002
*        2. IF CHANNEL ERRORS OR STATUS STORED, LETS SLIH       *       19291002
*           HANDLE                                              *       19310002
*        3. DETERMINES IF ATTENTION OCCURRED                    *       19320002
*        4. ATTEMPTS RETRY IF POSSIBLE                          *       19330002
*                                                               *       19340002
*     C. CC=2                                                   *       19346002
*        1. MARKS CHANNEL BUSY IN THE CAT                       *       19352002
*                                                               *       19370002
*     D. CC=3                                                   *       19380002
*        1. INVOKES WTO IF NECESSARY                            *       19390002
*        2. ATTEMPTS RETRY IF POSSIBLE                          *       19398002
*                                                               *       19406002
* ENTRY POINTS                                                  *       19414002
*         EPOSTIO1  NORMAL ENTRY POINT                          *       19422002
*         EPOSTIO2  ENTRY TO CC=0 PROCESSING                    *       19440002
*         EPOSTIO3  ENTRY TO CC=1 PROCESSING                    *       19450002
*         EPOSTIO4  ENTRY TO CC=1 PROCESSING W/O SETTING THE    *       19460002
*                   CSW                                         *       19470002
*                                                               *       19480002
* INPUT                                                         *       19490002
*    REGISTERS                                                  *       19500002
*              WRK0    =CAT ADDRESS                             *       19510002
*              IOSBR   =IOSB ADDRESS                            *       19520002
*              LCCAR   =LCCA ADDRESS                            *       19530002
*              BASEA   =BASE ADDRESS A                          *       19535002
*              WRK6    =UNIT ADDRESS                            *       19541002
*              UCBR    =UCB ADDRESS                             *       19560002
*              BASEB   =BASE ADDRESS B                          *       19566002
*              BASEC   =BASE ADDRESS C                          *       19572002
*              IOQR    =IOQE ADDRESS                            *       19590002
*              SAVR    =LCCA SAVE AREA                          *       19600002
*                                                               *       19610002
*    FIELDS                                                     *       19620002
*              CHTMASK  CHTTYPE  FLCCAW   FLCCSW   IOQPTH       *       19621002
*              IOSPATH  IOSPKEY  IRTDDSV  IRTIOQ   UCBCHM       *       19630002
*              UCBFL5   UCBPMSK                                 *       19640002
*                                                               *       19650002
*    LOCKS                                                      *       19670002
*              UCBLOCK                                                  19680002
*              LCHLOCK MAY BE HELD                              *       19690002
*                                                               *       19700002
* OUTPUT                                                        *       19710002
*    REGISTERS                                                  *       19720002
*              WRK0    =DESTROYED                               *       19730002
*              LNKR    =DESTROYED                               *       19736002
*              WRK6    =DESTROYED                               *       19742002
*              WRK9    =DESTROYED                               *       19760002
*              WRKA    =DESTROYED                               *       19770002
*              IOQR    =ACTIVE IOQE                             *       19780002
*              WRKC    =DESTROYED                               *       19790002
*              WRKEVEN =DESTROYED                               *       19800002
*              WRKODD  =DESTROYED                               *       19810002
*                                                               *       19820002
*    FIELDS                                                     *       19830002
*              CATFLG   IOQFLA   IOSCOD   IOSFLA   IOSOPT       *       19840002
*              IOSPROC  IOSSRB   IRTCHMSK SRBPARM  SRBPTCB      *       19850002
*              UCBFLA   UCBFLC   UCBPMSK                        *       19860002
*                                                               *       19870002
*    LOCKS                                                      *       19880002
*              UCBLOCK MAY BE FREED                             *       19886002
*              LCHLOCK UNCHANGED                                *       19892002
* EXTERNAL REFERENCES                                           *       19910002
*    NONE                                                       *       19918002
*                                                               *       19926002
* EXITS                                                         *       19934002
*    +0 - NO ENQUEUE, NO SHOULDER TAP                           *       19942002
*    +4 - ENQUEUE, NO SHOULDER TAP                              *       19950002
*    +8 - ENQUEUE, SHOULDER TAP                                 *       19970002
*                                                               *       19976002
* TABLES/WORKAREAS                                              *       19990002
*    CAT                                                        *       19995002
*    CHT                                                        *       20010002
*    IOCOM                                                      *       20018002
*    IOQ                                                        *       20026002
*    IOSB                                                       *       20034002
*    IRT                                                        *       20050002
*    PSA                                                        *       20060002
*    SRB                                                        *       20068002
*    UCB                                                        *       20076002
*                                                               *       20084002
*****************************************************************       20092002
         TITLE  'IECIOSCN - IOS - POST SIO SUBROUTINE  CC=0'            20100002
***                                                           ***       20120002
