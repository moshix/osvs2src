    TITLE 'IECVCRHH - CHANNEL RECONFIGURATION HARDWARE HOOK ROUTINES'   00050003
*********************************************************************** 00100003
*                                                                       00150003
*  MODULE NAME - IECVCRHH                                               00200003
*                                                                       00250003
*  DESCRIPTIVE NAME - CHANNEL RECONFIGURATION HARDWARE (CRH) HOOKS      00300003
*                                                                       00350003
*  COPYRIGHT - NONE                                                     00400003
*                                                                       00450003
*  STATUS - CHANGE LEVEL 0.0  OCTOBER 8, 1974                           00500003
*                                                                       00550003
*  FUNCTION - THIS MODULE PERFORMS THE FUNCTIONS NECESSARY TO CAUSE     00600003
*             IOS MAINLINE MODULE IECIOSCN TO USE THE CHANNEL           00650003
*             RECONFIGURATION HARDWARE (CRH) ON A 168MP SYSTEM.         00700003
*                                                                       00720003
*  NOTES - DEPENDENCIES                                                 00800003
*             THIS MODULE IS EXTREMELY DEPENDENT UPON THE OPERATION     00850003
*             OF IOS MAINLINE IECIOSCN. ANY CHANGES MADE TO THE         00858003
*             SUBROUTINES HOOKED BY THE CRH FUNCTION OR BRANCHED        00866003
*             TO FROM IECVCRH1 MUST BE EVALUATED FOR INCLUSION IN THIS  00874003
*             MODULE.                                                   00882003
*                                                                       00890003
*          PATCH AREA                                                   00900003
*             THE IOS PATCH AREA WITH LABEL IOSPATCH IS USED.           00950003
*                                                                       01000003
*          RESTRICTIONS                                                 01003003
*             SEE DEPENDENCIES                                          01006003
*                                                                       01009003
*          REGISTER CONVENTIONS                                         01012003
*             THE SAME EQUATES FOR REGISTERS AS IOS MAINLINE            01015003
*             SEE PROLOGUE FOR EACH ENTRY POINT                         01018003
*                                                                       01021003
* MODULE TYPE - I/O CONTROL                                             01024003
*                                                                       01027003
*          PROCESSOR - PLS2                                             01030003
*                                                                       01033003
*          MODULE SIZE - 1050 DECIMAL BYTES                             01036003
*                                                                       01039003
*          ATTRIBUTES - KEY 0,SUPERVISOR STATE,NUCLEUS RESIDENT,        01042003
*                       REUSEABLE                                       01050003
*                                                                       01060003
*  ENTRY POINTS -                                                       01070003
*             IECVCRCA - CRH COMMUNICATIONS AREA.                       01100003
*                                                                       01150003
*             IECVCRH1 - HOOK ROUTINE FOR IOS MAINLINE TCH SUBROUTINE.  01200003
*                                                                       01250003
*             IECVCRH2 - HOOK ROUTINE FOR IOS MAINLINE SIO SUBROUTINE.  01300003
*                                                                       01350003
*             IECVCRH3 - HOOK ROUTINE FOR IOS SENSE SUBROUTINE.         01400003
*                                                                       01410003
*  OPERATION - SEE PROLOGUE FOR EACH ENTRY POINT.                       01420003
*                                                                       01450003
*  INPUT REGISTERS - SEE PROLOGUE FOR EACH ENTRY POINT.                 01600003
*                                                                       01650003
*  OUTPUT REGISTERS - SEE PROLOGUE FOR EACH ENTRY POINT.                01652003
*                                                                       01654003
* EXTERNAL REFERENCES                                                   01656003
*                                                                       01658003
*     ROUTINES - IECVCRH1 USES SOME OF THE INTERNAL SUBROUTINES         01660003
*             IN IOS MAINLINE,SEE PROLOGUE FOR IECVCRH1.                01662003
*                                                                       01664003
*     DATA SETS - NONE                                                  01666003
*                                                                       01668003
*     DATA AREAS - NONE                                                 01670003
*                                                                       01672003
* TABLES - THE CRH COMMUNICATION AREA IECVCRCA                          01674003
*                                                                       01676003
* MACROS - NO EXECUTEABLE MACROS                                        01678003
*                                                                       01680003
* CHANGE ACTIVITY - NONE                                                01682003
*                                                                       01700003
*********************************************************************** 01720003
           IECDCAT                                                      01750003
           EJECT                                                        01800003
           CVT   DSECT=YES,LIST=YES                                     01850003
           EJECT                                                        01900003
           EWAMAP ,                                            @ZA16177 01910041
           EJECT                                                        01920041
           IECDIOCM                                                     01950003
           EJECT                                                        02000003
           IECDIOQ                                                      02050003
           EJECT                                                        02100003
           IECDIOSB                                                     02150003
           EJECT                                                        02200003
           IHALCCA                                                      02250003
           EJECT                                                        02300003
           IECDIRT                                                      02350003
           EJECT                                                        02400003
           IECDLCH                                                      02450003
           EJECT                                                        02500003
           IHAPCCA                                                      02550003
           EJECT                                                        02600003
           IHAPSA                                                       02650003
           EJECT                                                        02700003
           IEFUCBOB PREFIX=YES,LIST=YES                                 02750003
         EJECT                                                          02800003
IECVCRHH CSECT                                                          02850003
         ENTRY IECVCRCA                                                 02900003
         ENTRY IECVCRH1                                                 02950003
         ENTRY IECVCRH2                                                 03000003
         ENTRY IECVCRH3                                                 03100003
         IECDCRCA DSECT=NO                                              03200003
         EJECT                                                          03300003
         MODID BR=NO                                                    03350041
    TITLE 'IECVCRH1 - CRH TEST CHANNEL HOOK ROUTINE'                    03400003
*********************************************************************** 03500003
* ENTRY NAME - IECVCRH1                                                 03600003
*                                                                       03700003
* DESCRIPTIVE NAME - CRH TEST CHANNEL HOOK ROUTINE                      03800003
*                                                                       03900003
* FUNCTION -  FIND A PATH TO A GIVEN DEVICE THRU A CHANNEL              04400003
*          RECONFIGURATION HARDWARE CONNECTION.  THIS PROGRAM           04500003
*          PERFORMS THE SAME FUNCTION AS THE TCH SUBROUTINE             04550003
*          IN IOS MAINLINE MODULE IECIOSCN.                             04600003
*                                                                       04650003
* OPERATION - IF THE IOS MAINLINE SUBROUTINE FOR TEST CHANNEL           04700003
*             HAS BEEN UNABLE TO FIND A PATH TO A DEVICE ON             04710003
*             THE ALIVE CPU AND ATTEMPTS TO SHOULDER TAP THE            04720003
*             DEAD CPU TO FIND A PATH TO THE DEVICE, IECVCRH1           04730003
*             RECEIVES CONTROL THROUGH A HOOK IN IOS MAINLINE           04740003
*             IECIOSCN.  BECAUSE THIS PROGRAM ACTS AS AN EXTENSION      04750003
*             TO IOS MAINLINE, IT FUNCTIONS AS CLOSELY AS POSSIBLE      04760003
*             TO THE CORRESPONDING TEST CHANNEL SUBROUTINE              04770003
*             IN IECIOSCN.                                              04780003
*                                                                       04800003
* NOTES - DEPENDENCIES                                                  04900003
*             THIS PROGRAM RECEIVES CONTROL THRU A HOOK IN IOS          05000003
*             MAINLINE AND PERFORMS THE SAME FUNCTION AS THE            05100003
*             TCH SUBROUTINE IN IECIOSCN, THEREFORE IT IS ENTIRELY      05200003
*             DEPENDENT ON IOS MAINLINE MODULE IECIOSCN.                05300003
*                                                                       05400003
*         PATCH AREA                                                    05500003
*             THE IOS PATCH AREA WITH LABEL IOSPATCH IS USED.           05600003
*                                                                       05700003
* INPUT - REGISTERS                                                     07000003
*             IECVCRH1 HAS THE SAME EQUATES FOR REGISTERS AS IOS        07100003
*             MAINLINE MODULE IECIOSCN. WHEN IECVCRH1 RECEIVES          07200003
*             CONTROL IT EXPECTS THE FOLLOWING REGISTER CONTENTS.       07300003
*               WRK1    (REGISTER  1) - ADDRESS OF CRCA                 07400003
*               IOSBR   (REGISTER  2) - ADDRESS OF IOSB                 07500003
*               LCCAR   (REGISTER  3) - ADDRESS OF LCCA                 07600003
*               UCBR    (REGISTER  7) - ADDRESS OF UCB                  07700003
*               WRKEVEN (REGISTER 14) - RETURN ADDRESS                  07800003
*               WRKODD  (REGISTER 15) - ADDRESS OF IECVCRH1             07900003
*                                                                       07905003
* OUTPUT - REGISTERS                                                    07910003
*            SAME AS ON ENTRY                                           07915003
*                                                                       07920003
*   EXIT - NORMAL - RETURN TO HOOK IN IOS MAINLINE                      07925003
*                                                                       07930003
*   EXIT - ERROR - NONE                                                 07935003
*                                                                       07940003
* EXTERNAL REFERENCES                                                   07945003
*                                                                       07950003
*        ROUTINES - IECVCRH1 BRANCHES TO TWO INTERNAL SUBROUTINES       07955003
*               IN IOS MAINLINE WHICH DO NOT EXPECT TO BE CALLED        07960003
*               EXTERNALLY. THEREFORE IECVCRH1 SETS UP THEIR BASE       07965003
*               REGISTERS BEFORE CALLING THEM.                          07970003
*                   IECVCRH1 BRANCHES TO ENTRY POINT IECVSRB TO         07975003
*               SCHEDULE AN SRB TO TERMINATE A GDP REQUEST AND          07980003
*               BRANCHES TO ENTRY POINT IECVDVT PLUS AN OFFSET          07985003
*               TO GET I/O STARTED TO A DEVICE.                         07990003
*                                                                       08000003
*********************************************************************** 08050003
         EJECT                                                          08100003
IECVCRH1 EQU   *                                                        08200003
*********************************************************************** 08300003
*                                                                     * 08400003
*        ESTABLISH ADDRESSABILITY AND ENVIRONMENT                     * 08500003
*                                                                     * 08600003
*********************************************************************** 08700003
         USING IECVCRH1,WRKODD                                          08800003
         STM   WRK0,WRKODD,CRH1SAVE    SAVE CALLERS REGISTERS IN        08900003
*                                      INTERNAL SAVE AREA               09000003
         LR    BASEA,WRKODD            SET UP ACTUAL BASE REGISTER      09100003
         DROP  WRKODD                                                   09200003
         USING IECVCRH1,BASEA                                           09300003
*                                                                       09400003
         USING FLC,ZERO                                                 09500003
         USING IOSB,IOSBR              INDICATE                         09600003
         USING UCB,UCBR                     CONTROL                     09700003
         USING LCCA,LCCAR                       BLOCK                   09800003
         USING IECVCRCA,WRK1                        ADDRESSABILITY      09900003
*                                                                       10000003
*                                                                       10100003
         L     WRKC,IRTLCHAD           PICK UP SAVED POINTER TO LCH     10200003
         USING LCH,WRKC                INDICATE ADDRESSABILITY          10300003
         L     IOQR,IRTIOQ             RESTORE POINTER TO IOQ           10400003
         USING IOQ,IOQR                INDICATE ADDRESSABILITY          10500003
         MVI   IRTENVR,IRTSHTP         INDICATE SHOULDER TAP ENVIRON.   10600003
         OI    IRTFLB,IRTCHBSY         SET ALL CHANNELS BUSY            10700003
         NI    UCBFLA,FF-UCBCUB    TURN OFF CNTRL UNIT BUSY    @OZ05977 10750041
         L     WRKA,LCHTCH             GET ADDRESS OF CHANNEL LIST      10800003
         NI    IOSOPT2,FF-IOSHTP       NO SHOULDER TAP         @ZM30442 10850003
         EJECT                                                          10900003
*********************************************************************** 11000003
*                                                                     * 11100003
*        GUARANTEED DEVICE PATH PROCESSING                            * 11200003
*                                                                     * 11300003
*********************************************************************** 11400003
         TM    IOSPATH,IOSGDP          GUARANTEED DEVICE PATH REQUEST   11500003
         BNO   CRH1100                 NO,GO CHECK IF CHANNEL AVAILABLE 11600003
***                                                                 *** 11700003
*        FIND REQUESTED CHANNEL                                       * 11800003
***                                                                 *** 11900003
CRH1010  LH    WRK6,ZERO(WRKA)         GET NEXT CHANNEL FROM LIST       12000003
         LTR   WRK6,WRK6               END OF LIST                      12100003
         BM    CRH1065                 YES - TERMINATE REQUEST          12200003
*                                                                       12300003
         LR    WRKEVEN,WRK6            COPY CHANNEL TO WORK REGISTER    12400003
         N     WRKEVEN,DEVMASK         AND OFF DEVICE ADDRESS           12500003
         LH    WRK0,IOSPATH            GET REQUESTED PATH               12600003
         TM    ONE(WRKA),FF-F          SELECTOR SUBCHANNEL              12700003
         BZ    CRH1030                 NO - AND OFF CONTROL UNIT ALSO   12800003
         N     WRK0,DEVMASK            AND OFF DEVICE ADDRESS           12900003
         B     CRH1040                 GO COMPARE                       13000003
CRH1030  N     WRK0,CUMASK             AND OFF DEVICE AND CU ADDRESSES  13100003
*                                                                       13200003
CRH1040  CR    WRKEVEN,WRK0            REQUESTED CHANNEL                13300003
         BE    CRH1050                 YES - GO CHECK IF RESERVED       13400003
         NI    IRTFLB,FF-IRTCHBSY      NO - TURN OFF ALL CHANNELS BUSY  13500003
         LA    WRKA,NXTCHN(WRKA)       POINT AT NEXT CHANNEL IN LIST    13600003
         B     CRH1010                 TRY NEXT PATH                    13700003
*                                                                       13800003
***                                                                 *** 13900003
*  GDP REQUESTED CHANNEL FOUND - CHECK IF CORRECT PATH RESERVED       * 14000003
***                                                                 *** 14100003
CRH1050  TM    UCBFLB,UCBCRHRV     DEVICE RESERVED THROUGH CRH          14220041
         BNO   CRH1055                 NO - GET CAT ENTRY ADDR @ZA10497 14260041
         LR    WRKODD,WRK6             COPY CHANNEL TO WORK REGISTER    14400003
         N     WRKODD,CUMASK           AND OFF CONTROL UNIT ADDRESS     14500003
         LH    WRK0,UCBCHAN            GET LAST PATH STARTED            14600003
         N     WRK0,CUMASK             AND OFF CONTROL UNIT ADDRESS     14700003
         CR    WRKODD,WRK0             CORRECT CHANNEL                  14800003
         BE    CRH1060                 YES - GET CAT ENTRY ADDRESS      14900003
         MVI   IOSCOD,IOSGDPRD         GUARANTEED DEVICE PATH RESERVED  15000003
*                                      WRONG PATH                       15100003
         B     CRH1070                 GO TERMINATE I/O REQUEST         15200003
*                                                                       15250003
CRH1055  TM    UCBFLB,UCBRESVH     IS DEVICE RESERVED BY OTHER @ZA10497 15260041
         BO    CRH1065             CPU, YES TERMINATE REQUEST  @ZA10497 15270041
***                                                                 *** 15300003
* PUT CAT ENTRY ADDRESS IN REGISTER 0 FOR INTERFACE WITH IOS MAINLINE * 15350003
***                                                                 *** 15358003
CRH1060  SRL   WRKEVEN,EIGHT-CATELP2   GET CAT ENTRY DISPLACEMENT       15366003
         A     WRKEVEN,CRCACAT         ADD TO CAT TABLE ADDRESS         15374003
         LR    WRK0,WRKEVEN            PUT ADDRESS IN REGISTER 0        15390003
         B     CRH1400                 GO MAKE CRH CONNECTION           15395003
         EJECT                                                          15400003
*********************************************************************** 15500003
*                                                                     * 15600003
*   GUARANTEED DEVICE PATH PROCESSING FAILED - TERMINATE I/O REQUEST *  15700003
*                                                                     * 15800003
*********************************************************************** 15900003
***                                                                 *** 16000003
*  INTERFACE TO SUBROUTINES IN IOS MAINLINE - THE SIO SUBROUTINES     * 16100003
*  ARE INTERNAL SUBROUTINES WHICH DO NOT EXPECT TO BE CALLED FROM     * 16200003
*  OUTSIDE OF IOS MAINLINE, THEREFORE THIS END OF THE INTERFACE MUST  * 16300003
*  SETUP ALL OF THE REGISTERS THAT THE DEVICE DEPENDENT SIO ROUTINES  * 16400003
*  EXPECT, INCLUDING THE THREE BASE REGISTERS.                        * 16500003
***                                                                 *** 16600003
CRH1065  MVI   IOSCOD,IOSGDPCC         REQUESTED PATH NOT FOUND         16650003
CRH1070  L     WRKODD,TERM                                              16700003
         LM    BASEB,BASEC,HISBASES    SET UP BASE REGISTERS FOR IOS    16800003
         L     BASEA,HISBASEA          MAINLINE                         16900003
         BALR  LNKR,WRKODD             GO TO SUBROUTINE IN IOS TO       17000003
*                                      TERMINATE THE I/O REQUEST        17100003
***                                                                 *** 17200003
*        RESTORE MY BASE AND GO EXIT                                  * 17300003
***                                                                 *** 17400003
CRH1090  L     WRKEVEN,FLCCVT          GET ADDRESS OF CVT               17500003
         USING CVTMAP,WRKEVEN          INDICATE ADDRESSABILITY          17600003
         L     WRK1,CVTCRCA            RESTORE ADDRESS OF CRCA          17700003
         DROP  WRKEVEN                 FREE CVT BASE REGISTER           17800003
         L     BASEA,CRCACRH1          RESTORE MY BASE                  17900003
         NI    IRTFLB,FF-IRTCHBSY      ENSURE MAINLINE TCH ROUTINE      18000003
*                                      WILL EXIT                        18100003
         B     CRH1900                 GO EXIT                          18200003
         EJECT                                                          18300003
*********************************************************************** 18400003
*                                                                     * 18500003
*        CHECK IF CHANNEL AVAILABLE                                   * 18600003
*                                                                     * 18700003
*********************************************************************** 18800003
CRH1100  LH    WRK6,ZERO(WRKA)         GET NEXT CHANNEL FROM LIST       18900003
         LTR   WRK6,WRK6               END OF LIST                      19000003
         BM    CRH1800                 YES - GO RETURN                  19100003
         L     WRKEVEN,CRCACAT         GET SAVED ADDRESS OF CAT         19200003
         LR    WRKODD,WRK6             COPY CHANNEL ADDRESS TO USE      19300003
*                                      AS AN INDEX INTO CAT             19400003
         SRL   WRKODD,EIGHT            ISOLATE CHANNEL NUMBER           19500003
         SLL   WRKODD,CATELP2          MULTIPLY BY LENGTH OF CAT TABLE  19600003
         ALR   WRKEVEN,WRKODD          POINT AT CAT ENTRY               19700003
         USING CAT,WRKEVEN             INDICATE ENTRY ADDRESSABILITY    19800003
*                                                                       19900003
         TM    CATFLG,CATNOP+CATNGEN+CATNCPU  TEST AVAILABILITY BITS    20000003
         BZ    CRH1200                 YES - GO CHECK IF RESERVED       20100003
*                                                                       20200003
         LA    WRKA,NXTCHN(WRKA)       BUMP TO NEXT CHANNEL             20300003
         B     CRH1100                 GO CHECK OUT NEXT CHANNEL        20400003
*                                                                       20500003
*********************************************************************** 20600003
*                                                                     * 20700003
*        RESERVED DEVICE PROCESSING                                   * 20800003
*                                                                     * 20900003
*********************************************************************** 21000003
CRH1200  TM    UCBFLB,UCBCRHRV         DEVICE RESERVED BY CRH           21120041
         BNO   CRH1250                 NO - GO TEST IF ONLINE  @ZA10497 21160041
***                                                                 *** 21300003
*        TEST FOR CORRECT CHANNEL                                     * 21400003
***                                                                 *** 21500003
         LR    WRKODD,WRK6             COPY CHANNEL TO WORK REGISTER    21600003
         N     WRKODD,CUMASK           AND OFF CONTROL UNIT ADDRESS     21700003
         LH    WRK0,UCBCHAN            GET LAST PATH STARTED            21800003
         N     WRK0,CUMASK             AND OFF CONTROL UNIT AND DEVICE  21900003
*                                                                       22000003
         CR    WRKODD,WRK0             CORRECT CHANNEL                  22100003
         BE    CRH1300                 YES-GO CHECK OF PATH OFFLINE     22200003
         NI    IRTFLB,FF-IRTCHBSY      TURN OFF ALL CHANNELS BUSY FLAG  22300003
         LA    WRKA,NXTCHN(WRKA)       BUMP TO NEXT CHANNEL             22400003
         B     CRH1100                 GO CHECK OUT NEXT CHANNEL        22500003
CRH1250  TM    UCBFLB,UCBRESVH     IS DEVICE RESERVED BY OTHER @ZA10497 22530041
         BO    CRH1800             CPU, YES EXIT               @ZA10497 22560041
         EJECT                                                          22600003
*********************************************************************** 22700003
*                                                                     * 22800003
*        MAKE SURE PATH IS ONLINE                                     * 22900003
*                                                                     * 23000003
*********************************************************************** 23100003
CRH1300  LR    WRK0,WRKEVEN            SAVE CAT ADDRESS                 23200003
         SLR   WRKODD,WRKODD           ZERO REGISTER                    23300003
         IC    WRKODD,UCBCHM           GET UCB OFFLINE MASK             23400003
         LR    WRKEVEN,WRK6            COPY CHAN. AND MASK TO WORK REG. 23500003
***                                                                 *** 23600003
* NOTE: THIS MODULE SUBSTITUTES FOR A SHOULDER TAP TO THE OTHER CPU   * 23700003
*       BECAUSE THE OTHER CPU IS DEAD. THEREFORE THE TEST FOR ONLINE  * 23800003
*       PATHS CHECKS TO MAKE SURE THE PATH SELECTED IS ONLINE TO THE  * 23900003
*       DEAD CPU - THAT IS THE CPU WE ARE NOT RUNNING ON.             * 24000003
***                                                                 *** 24100003
         CLI   PSACPUSA+ONE,ZERO       RUNNING ON CPU 0                 24200003
         BE    CRH1320                 YES - SHIFT FOR CPU 1            24300003
         SLL   WRKEVEN,TWO             SHIFT FOR CPU 0                  24400003
CRH1320  SLL   WRKEVEN,TWO             SHIFT FOR CPU 1                  24500003
         STC   WRKEVEN,IOQPTH          SAVE PATH MASK                   24600003
         TM    IOSOPT,IOSAPR           IS ALTERNATE PATH RETRY ACTIVE   24700003
         BNO   CRH1340                 NO - GO CHECK IF PATH IS OFFLINE 24800003
***                                                                 *** 24900003
* ALTERNATE PATH RETRY ACTIVE - CREATE NEW ANDING MASK USING IOSAPMSK * 25000003
***                                                                 *** 25100003
         TM    UCBFLB,UCBCRHRV         IS DEVICE RESERVED               25200003
         BO    CRH1330                 YES - ZERO APR MASK              25300003
         SLR   WRKEVEN,WRKEVEN         ZERO REGISTER                    25400003
         IC    WRKEVEN,IOSAPMSK        GET APR MASK                     25500003
         OR    WRKODD,WRKEVEN          SETUP NEW MASK FOR ANDING        25600003
         IC    WRKEVEN,IOQPTH          RESET PATH TO TEST               25700003
         C     WRKODD,PATHMASK         ARE ALL PATHS NO GO              25800003
         BNE   CRH1340                 NO - GO CHECK IF PATH IS OFFLINE 25900003
         IC    WRKODD,UCBCHM           RESET UCB MASK                   26000003
CRH1330  MVI   IOSAPMSK,ZERO           ZERO APR MASK                    26100003
*                                                                       26200003
CRH1340  NR    WRKODD,WRKEVEN          CHECK IF THIS PATH IS OFFLINE    26300003
         BZ    CRH1400                 NO - GO ISSUE TCH                26400003
*                                                                       26500003
         NI    IRTFLB,FF-IRTCHBSY      TURN OFF ALL CHANNELS BUSY       26600003
         LA    WRKA,NXTCHN(WRKA)       BUMP TO NEXT CHANNEL IN LIST     26700003
         B     CRH1100                 GO CHECK OUT NEXT CHANNEL        26800003
         EJECT                                                          26900003
*********************************************************************** 27000003
*                                                                     * 27100003
*        CONNECT CHANNEL RECONFIGURATION HARDWARE                     * 27200003
*                                                                     * 27300003
*********************************************************************** 27400003
CRH1400  STH   WRK6,CRCACHAN           SAVE THE CHOSEN PATH             27500003
***                                                                 *** 27600003
*        SET UP MCW TO CONNECT CRH TO CHOSEN PATH                     * 27700003
***                                                                 *** 27800003
         STCM  WRK6,TWO,CRCAMCWF       STORE CHANNEL NUMBER IN SECOND   27900003
*                                      NIBBLE OF MCW CRH FUNCTION BYTE  28000003
         OI    CRCAMCWF,CRCAMCWI+CRCAMCWM  TURN ON BIT 26 TO INDICATE   28100003
*                                      CRH MCW AND BIT 27 TO MAKE CRH   28200003
*                                      CONNECTION                       28300003
***                                                                 *** 28400003
*   SET UP WORK REGISTER TO USE CHANNEL 6 WHEN ISSUING TCH AND SIO    * 28500003
***                                                                 *** 28600003
         L     WRK6,CHAN6              LOAD CHANNEL 6 INTO PATH REG     28700003
***                                                                 *** 28800003
*  MAKE CHANNEL RECONFIGURATION HARDWARE CONNECTION TO CHOSEN CHANNEL * 28900003
***                                                                 *** 29000003
         OI    CRCAFLG1,CRCADIAG       INDICATE CRH CONNECTION          29100003
         DC    X'8300'                 ISSUE DIAGNOSE TO MAKE CRH       29200003
         DC    S(CRCAMCW)              CONNECTION                       29300003
         EJECT                                                          29400003
*********************************************************************** 29500003
*                                                                     * 29600003
*        ISSUE TEST CHANNEL ACROSS CRH CONNECTION                     * 29700003
*                                                                     * 29800003
*********************************************************************** 29900003
IECVCHK1 EQU   *                       HOOK                             30000003
         ENTRY IECVCHK1                                                 30100003
CRH1500  TCH   ZERO(WRK6)              ISSUE TEST CHANNEL               30200003
         BC    EIGHT+FOUR+ONE,CRH1510  IF NOT BUSY GO CALL DEVICE       30300003
*                                      DEPENDENT SIO SUBROUTINE         30400003
***                                                                 *** 30500003
*  CHANNEL BUSY - TRY NEXT PATH UNLESS GDP REQUEST                    * 30600003
***                                                                 *** 30700003
         LR    WRKEVEN,WRK0            RESTORE CAT BASE ADDR   @ZM34511 30750003
         OI    CATFLA,CATBSY           INDICATE CHANNEL BUSY            30800003
         TM    IOSPATH,IOSGDP          GUARANTEED DEVICE PATH           30900003
         BO    CRH1800                 YES - GO DISCONNECT CRH AND      31000003
*                                      RETURN                           31100003
         LA    WRKA,NXTCHN(WRKA)       BUMP TO NEXT CHANNEL IN LIST     31200003
         B     CRH1100                 GO CHECK OUT NEXT CHANNEL        31300003
***                                                                 *** 31400003
*  CHANNEL NOT BUSY - GET CONTROL UNIT AND DEVICE ADDRESS             * 31500003
***                                                                 *** 31600003
CRH1510  NI    IRTFLB,FF-IRTCHBSY      TURN OFF ALL CHANNELS BUSY FLAG  31700003
         ST    WRKA,IRTCHNL            SAVE CHANNEL LIST POINTER        31800003
         TM    ONE(WRKA),FF-F          SELECT SUBCHANNEL SPECIFIED      31900003
         BZ    CRH1520                 NO - SKIP                        32000003
         MVZ   UCBUA,ONE(WRKA)         MOVE IN CONTROL UNIT IF IN LIST  32100003
CRH1520  IC    WRK6,UCBUA              GET CONTROL UNIT AND DEVICE      32200003
         EJECT                                                          32300003
*********************************************************************** 32400003
*                                                                     * 32500003
*        CALL DEVICE DEPENDENT SIO SUBROUTINE IN IOS MAINLINE         * 32600003
*                                                                     * 32700003
*********************************************************************** 32800003
         L     WRKODD,UCBEXTPT         LOAD POINTER TO UCB EXTENSION    33000003
         USING UCBCMEXT,WRKODD         INDICATE ADDRESSABILITY          33100003
         LH    WRKC,UCBCCWOF                                            33200003
         SLL   WRKC,THREE                                      @ZA16150 33250041
         SLR   WRKEVEN,WRKEVEN                                          33300003
         IC    WRKEVEN,UCBDTI          GET INDEX INTO DEVICE TABLE      33400003
         L     WRKODD,FLCCVT           GET ADDRESS OF CVT               33500003
         USING CVTMAP,WRKODD           INDICATE ADDRESSABILITY          33600003
         L     WRKODD,CVTIXAVL         GET ADDRESS OF IOCOM             33700003
         USING IOCOM,WRKODD            INDICATE ADDRESSABILITY          33800003
         A     WRKC,IOCIOSCP           POINT AT CHANNEL PROGRAM AREA    33900003
         DROP  WRKODD                                                   34000003
***                                                                 *** 34100003
*  INDEX INTO DEVICE TABLE TO GET ADDRESS OF DEVICE DEPENDENT ROUTINE * 34200003
***                                                                 *** 34300003
         L     WRKODD,DVT              GET ADDRESS OF DEVICE TABLE      34400003
         L     WRKODD,ZERO(WRKODD,WRKEVEN) GET ADDRESS OF SIO ROUTINE   34500003
***                                                                 *** 34600003
*  INTERFACE TO SUBROUTINES IN IOS MAINLINE - THE SIO SUBROUTINES     * 34700003
*  ARE INTERNAL SUBROUTINES WHICH DO NOT EXPECT TO BE CALLED FROM     * 34800003
*  OUTSIDE OF IOS MAINLINE, THEREFORE THIS END OF THE INTERFACE MUST  * 34900003
*  SETUP ALL OF THE REGISTERS THAT THE DEVICE DEPENDENT SIO ROUTINES  * 35000003
*  EXPECT, INCLUDING THE THREE BASE REGISTERS.                        * 35100003
***                                                                 *** 35200003
         LM    BASEB,BASEC,HISBASES    SETUP BASE REGISTERS FOR IOS     35300003
         L     BASEA,HISBASEA          MAINLINE                         35400003
         BALR  LNKR,WRKODD             GO TO DEVICE DEPENDENT SIO       35500003
*                                      SUBROUTINE                       35600003
         EJECT                                                          35700003
*********************************************************************** 35800003
*                                                                     * 35900003
*     RETURN FROM DEVICE DEPENDENT SIO SUBROUTINE IN IOS MAINLINE     * 36000003
*                                                                     * 36100003
*********************************************************************** 36200003
***                                                                 *** 36300003
*                                                                     * 36400003
*     +0 - REQUEST STARTED,ENQUEUE NOT NEEDED                         * 36500003
*     +4 - REQUEST STARTED,ENQUEUE NEEDED                             * 36600003
*     +8 - REQUEST NOT STARTED,TRY NEXT PATH                          * 36700003
*        REQUEST IS ALREADY ENQUEUED THEREFORE +4 RETURN IS NOT       * 36800003
*        POSSIBLE.                                                    * 36900003
***                                                                 *** 37000003
CRH1700  LA    LNKR,TWO(LNKR)          PLUS ZERO RETURN                 37100003
         LA    LNKR,TWO(LNKR)          PLUS FOUR RETURN                 37170003
         LA    LNKR,TWO(LNKR)          PLUS EIGHT RETURN                37240003
         L     WRKEVEN,FLCCVT          GET CVT ADDRESS                  37310003
         USING CVTMAP,WRKEVEN          INDICATE ADDRESSABILITY          37400003
         L     WRK1,CVTCRCA            RESTORE ADDRESS OF CRCA          37500003
         DROP  WRKEVEN                 FREE CVT BASE REGISTER           37600003
         L     BASEA,CRCACRH1          RESTORE MY BASE                  37700003
         LA    WRKODD,CRH1700          GET +0 RETURN ADDRESS            37800003
         SR    LNKR,WRKODD             SUBTRACT FROM RETURN VECTOR      37900003
         CLM   LNKR,THREE,TOO          CHECK IF +8(NOT STARTED)RETURN   38000003
         BNE   CRH1750                 NO - GO DISCONNECT CRH           38100003
***                                                                 *** 38200003
*    I/O REQUEST NOT STARTED, TRY TO FIND ANOTHER PATH UNLESS GDP     * 38300003
***                                                                 *** 38400003
         TM    IOSPATH,IOSGDP          CHECK IF GUARANTEED DEVICE PATH  38500003
         BO    CRH1800                 YES - GO DISCONNECT CRH          38600003
         L     WRKA,IRTCHNL            RESTORE CHANNEL LIST ADDRESS     38700003
         LA    WRKA,NXTCHN(WRKA)       BUMP TO NEXT CHANNEL IN LIST     38800003
         B     CRH1100                 GO CHECK OUT NEXT CHANNEL        38900003
***                                                                 *** 38910003
*    SET UP TO RETURN +0 OR +4 DEPENDING ON RETURN                    * 38920003
***                                                                 *** 38930003
CRH1750  CLM   LNKR,THREE,FORE         CHECK PLUS FOUR RETURN  @ZM30442 38933003
         BNE   CRH1800                 NOT PLUS FOUR,ZERO      @ZM30442 38936003
         A     LNKR,RETURN             ADD RETURN VALUE FROM   @ZM30442 38940003
         ST    LNKR,RETURN             DEVICE DEPEND. ROUTINE  @ZM30442 38960003
*                                      TO RETURN ADDRESS       @ZM30442 38980003
         EJECT                                                          39000003
*********************************************************************** 39100003
*                                                                     * 39200003
*        DISCONNECT CHANNEL RECONFIGURATION HARDWARE AND RETURN       * 39300003
*                                                                     * 39400003
*********************************************************************** 39500003
CRH1800  NI    IOSOPT2,FF-IOSHTP       INDICATE NOT ELIGIBLE FOR        39600003
*                                      SHOULDER TAP                     39700003
         NI    CRCAMCWF,CRCAMCWB       TURN OFF BIT 27 IN MCW TO        39800003
*                                      BREAK CRH CONNECTION             39900003
         DC    X'8300'                 ISSUE DIAGNOSE TO BREAK CRH      40000003
         DC    S(CRCAMCW)              CONNECTION                       40100003
         NI    CRCAFLG1,FF-CRCADIAG    INDICATE NO CRH CONNECTION       40200003
***                                                                 *** 40300003
*     EXIT LINKAGE                                                    * 40400003
***                                                                 *** 40500003
CRH1900  LM    WRK0,WRKODD,CRH1SAVE    RESTORE CALLERS REGISTERS FROM   40600003
*                                      INTERNAL SAVE AREA               40700003
         BR    WRKEVEN                 RETURN                           40800003
         EJECT                                                          40900003
    TITLE 'IECVCRH2 - CRH SIO HOOK ROUTINE'                             41000003
*********************************************************************** 41100003
* ENTRY NAME - IECVCRH2                                                 41200003
*                                                                       41300003
* DESCRIPTIVE NAME - CRH SIO HOOK ROUTINE                               41400003
*                                                                       41500003
* FUNCTION - THIS ENTRY PROCESSES ALL SIOS DONE ACROSS A CRH            41550003
*         CONNECTION.                                                   41600003
*                                                                       41650003
* OPERATION -  IF THE SIO IN IOS MAINLINE WAS THRU A CHANNEL            42000003
*           RECONFIGURATION HARDWARE CONNECTION,THIS PROGRAM            42080003
*           ENSURES THAT THE PATH STORED IN THE UCB IS THE              42160003
*           ACTUAL ADDRESS OF THE DEVICE. IF THE CONDITION CODE         42240003
*           WAS ZERO, THE UCBIORST FLAG IS TURNED ON TO INDICATE        42320003
*           THE LAST PATH STARTED FOR THAT DEVICE WAS THROUGH CRH.      42400003
*           IF THE CONDITION CODE WAS ONE,IECVCRH2 CHECKS WHETHER       42420003
*           A SENSE THROUGH CRH IS REQUIRED.                            42440003
*                                                                       42460003
* NOTES - DEPENDENCIES                                                  42500003
*             THIS PROGRAM RECEIVES CONTROL THRU A HOOK IN THE IOS      42600003
*             MAINLINE SIO SUBROUTINE, THEREFORE IT IS ENTIRELY         42700003
*             DEPENDENT ON IOS MAINLINE MODULE IECIOSCN.                42800003
*                                                                       42900003
*         PATCH AREA                                                    43000003
*             THE IOS PATCH AREA WITH LABEL IOSPATCH IS USED.           43100003
*                                                                       43200003
* INPUT - REGISTERS                                                     43700003
*             IECVCRH2 HAS THE SAME EQUATES FOR REGISTERS AS IOS        43800003
*             MAINLINE MODULE IECIOSCN. WHEN IECVCRH2 RECEIVES          43900003
*             CONTROL IT EXPECTS THE FOLLOWING REGISTER CONTENTS.       44000003
*               WRK1    (REGISTER  1) - ADDRESS OF CRCA                 44100003
*               IOSBR   (REGISTER  2) - ADDRESS OF IOSB                 44200003
*               UCBR    (REGISTER  7) - ADDRESS OF UCB                  44300003
*               IOQR    (REGISTER 11) - ADDRESS OF IOQE                 44400003
*               WRKEVEN (REGISTER 14) - RETURN ADDRESS                  44500003
*               WRKODD  (REGISTER 15) - ADDRESS OF IECVCRH2             44600003
*                                                                       44609003
* OUTPUT - REGISTERS                                                    44618003
*            SAME AS ON ENTRY                                           44627003
*                                                                       44636003
*   EXIT - NORMAL - RETURN TO HOOK IN IOS MAINLINE                      44645003
*                                                                       44654003
*   EXIT - ERROR - NONE                                                 44663003
*                                                                       44672003
* EXTERNAL REFERENCES - NONE                                            44681003
*                                                                       44690003
*********************************************************************** 44700003
         EJECT                                                          44800003
IECVCRH2 EQU   *                                                        44900003
*********************************************************************** 45000003
*                                                                     * 45100003
*        ESTABLISH ADDRESSABILITY AND ENVIRONMENT                     * 45200003
*                                                                     * 45300003
*********************************************************************** 45400003
         USING IECVCRH2,WRKODD         INDICATE ADDRESSABILITY          45500003
         USING IOSB,IOSBR              INDICATE                         46200003
         USING LCCA,LCCAR                                      @ZA16177 46250041
         USING UCB,UCBR                    CONTROL                      46300003
         USING IOQ,IOQR                        BLOCK                    46400003
         USING IECVCRCA,WRK1                     ADDRESSABILITY         46500003
***                                                                 *** 46600003
*     CHECK IF THIS SIO WAS ACROSS CRH CONNECTION                     * 46700003
***                                                                 *** 46800003
         NI    IRTENVR,FF-IRTCRHIN     IN CASE NON-CRH CC-1    @ZA16177 46850041
         TM    CRCAFLG1,CRCADIAG       IS A CRH CONNECTION OUTSTANDING  46900003
         BNO   CRH2600                 NO - GO RETURN - I/O NOT ACROSS  47000003
*                                      CRH CONNECTION                   47100003
         ST    WRK6,CRH2SAV6           SAVE SIO ADDRESS        @ZM30449 47150003
         EJECT                                                          47200003
*********************************************************************** 47300003
*                                                                     * 47400003
*        PROCESS I/O ACROSS CRH CONNECTION                            * 47500003
*                                                                     * 47600003
*********************************************************************** 47700003
         SPM   WRKC                    SET UP CONDITION CODE FROM SIO   47800003
         BC    EIGHT,CRH2300           SKIP IF CONDITION CODE ZERO      47900003
         BC    TWO+ONE,CRH2500         SKIP IF CC IS 2 OR 3             48000003
***                                                                 *** 48100003
*     CONDITION CODE ONE - CHECK WHETHER SENSE REQUIRED               * 48200003
***                                                                 *** 48300003
         TM    CSWUNST,CSWCE       CHANNEL END ?               @ZA16179 48330041
         BO    CRH2000             YES, TURN ON IORST          @ZA16179 48380041
         TM    CSWUNST,CSWBSY          BUSY CONDITION ?                 48430041
         BZ    CRH2100                 NO, BRANCH AROUND       @ZA16179 48480041
CRH2000  OI    UCBFLB,UCBIORST         SET FOR LATER INTERRUPT @ZA16177 48530041
CRH2100  TM    CSWUNST,CSWUCK          UNIT CHECK ?            @ZA16177 48580041
         BNO   CRH2200                 NO,CHECK FOR CHANNEL ERRORS      48630041
         OI    UCBFLB,UCBCRHSN         YES, INDICATE CRH SENSE REQUIRED 48680041
         OI    IRTENVR,IRTCRHIN        STATUS FROM CRH PATH    @ZA16177 48730041
CRH2200  TM    CSWCHST,CSWCHER         CHANNEL ERRORS ?                 48780041
         BZ    CRH2500                 NO, SENSE NOT REQUIRED           48830041
         OI    UCBFLB,UCBCRHSN         YES, INDICATE CRH SENSE REQUIRED 48880041
         OI    IRTENVR,IRTCRHIN        STATUS FROM CRH PATH    @ZA16177 48930041
         B     CRH2500                 GO PUT REMOTE CHANNEL IN UCBCHAN 49200003
***                                                                 *** 49300003
*     CONDITION CODE ZERO - I/O STARTED                               * 49400003
***                                                                 *** 49500003
CRH2300  OI    UCBFLB,UCBIORST         INDICATE CRH I/O STARTED         49600003
         SPACE 1                                                        49700003
         TM    IOQFLB,IOQRESV          WAS CCW A RESERVE                49800003
         BZ    CRH2400                 NO - GO CHECK IF RELEASE         49900003
         OI    UCBFLB,UCBRESVH+UCBCRHRV  YES - INDICATE DEVICE RESERVED 50000003
*                                              ACROSS CRH CONNECTION    50100003
CRH2400  TM    IOQFLB,IOQRLSE          WAS CCW A RELEASE                50200003
         BZ    CRH2500                 NO - GO PUT CHANNEL IN UCB       50300003
         NI    UCBFLB,FF-UCBRESVH-UCBCRHRV  YES - CLEAR RESERVE FLAGS   50400003
***                                                                 *** 50500003
*     PUT ACTUAL REMOTE CHANNEL ADDRESS IN UCB FOR TRACE FACILITY     * 50600003
***                                                                 *** 50700003
CRH2500  ICM   WRK6,TWO,CRCACHAN       GET SAVED CHANNEL ADDRESS        50800003
         STH   WRK6,UCBCHAN            EXECUTE OVERLAID HOOK INSTRUTION 50900003
*                                      USING ACTUAL PATH TO DEVICE      51000003
         L     WRK6,CRH2SAV6           RESTORE SIO ADDRESS     @ZM30449 51050003
*                                                                       51100003
*********************************************************************** 51200003
*                                                                     * 51300003
*        RETURN                                                       * 51400003
*                                                                     * 51500003
*********************************************************************** 51600003
CRH2600  BR    WRKEVEN                 RETURN                           51800003
         EJECT                                                          51900003
    TITLE 'IECVCRH3 - CRH SENSE HOOK ROUTINE'                           52000003
*********************************************************************** 52100003
* ENTRY NAME - IECVCRH3                                                 52200003
*                                                                       52300003
* DESCRIPTIVE NAME - CRH SENSE HOOK ROUTINE                             52400003
*                                                                       52500003
* FUNCTION -  ISSUE A SENSE SIO TO A GIVEN DEVICE THRU A CHANNEL        53000003
*             RECONFIGURATION HARDWARE CONNECTION, IF I/O WAS           53100003
*             STARTED FOR THAT DEVICE THRU CRH.                         53200003
*                                                                       53300003
* OPERATION - IECVCRH3 CHECKS WHETHER THE SENSE MUST BE ISSUED          53310003
*          THROUGH A CRH CONNECTION AND IF SO MAKES THE CRH             53320003
*          CONNECTION TO THE REQUIRED CHANNEL, ISSUES THE SENSE SIO,    53330003
*          SAVES THE CONDITION CODE AND BREAKS THE CRH CONNECTION.      53340003
*          IF THE SENSE SIO WAS SUCESSFUL, IECVCRH3 INDICATES           53350003
*          THE LAST PATH STARTED TO THE DEVICE WAS THROUGH CRH.         53360003
*                                                                       53370003
* NOTES - DEPENDENCIES                                                  53400003
*             THIS PROGRAM RECEIVES CONTROL THRU A HOOK IN IOS          53500003
*             MAINLINE, THEREFORE IT IS ENTIRELY DEPENDENT ON           53600003
*             IOS MAINLINE MODULE IECIOSCN.                             53700003
*                                                                       53800003
*         PATCH AREA                                                    53900003
*             THE IOS PATCH AREA WITH LABEL IOSPATCH IS USED.           54000003
*                                                                       54100003
* INPUT - REGISTERS                                                     54700003
*             IECVCRH3 HAS THE SAME EQUATES FOR REGISTERS AS IOS        54800003
*             MAINLINE MODULE IECIOSCN. WHEN IECVCRH3 RECEIVES          54900003
*             CONTROL IT EXPECTS THE FOLLOWING REGISTER CONTENTS.       55000003
*               WRK1    (REGISTER  1) - ADDRESS OF CRCA                 55100003
*               WRK6    (REGISTER  6) - DEVICE ADDRESS FOR SENSE        55200003
*               UCBR    (REGISTER  7) - ADDRESS OF UCB                  55300003
*               WRKEVEN (REGISTER 14) - RETURN ADDRESS                  55400003
*               WRKODD  (REGISTER 15) - ADDRESS OF IECVCRH3             55500003
*                                                                       55509003
* OUTPUT - REGISTERS                                                    55518003
*            SAME AS ON ENTRY                                           55527003
*                                                                       55536003
*   EXIT - NORMAL - RETURN TO HOOK IN IOS MAINLINE                      55545003
*                                                                       55554003
*   EXIT - ERROR - NONE                                                 55563003
*                                                                       55572003
* EXTERNAL REFERENCES - NONE                                            55581003
*                                                                       55590003
*********************************************************************** 55600003
         EJECT                                                          55700003
IECVCRH3 EQU   *                                                        55800003
*********************************************************************** 55900003
*                                                                     * 56000003
*        ESTABLISH ADDRESSABILITY AND ENVIRONMENT                     * 56100003
*                                                                     * 56200003
*********************************************************************** 56300003
         USING IECVCRH3,WRKODD         INDICATE ADDRESSABILITY          56400003
         STM   WRK0,WRKODD,CRH3SAVE    SAVE CALLERS REGISTERS IN        56500003
*                                      INTERNAL SAVE AREA               56600003
         DROP  WRKODD                                                   56700003
         LR    BASEA,WRKODD            SET UP ACTUAL BASE REGISTER      56800003
         USING IECVCRH3,BASEA                                           56900003
*                                                                       57000003
         USING UCB,UCBR                INDICATE CONTROL                 57100003
         USING IECVCRCA,WRK1                BLOCK ADDRESSABILITY        57200003
         USING EWA,WRKB                                        @ZA16177 57300041
         USING FLC,0                                           @ZA16177 57340041
*********************************************************************** 57380041
*        CHECK IF CRH SENSE REQUIRED                                  * 57420041
*********************************************************************** 57460041
         NI    UCBFLB,FF-UCBCRHSN      RESET FLAG              @ZA16177 57500041
         CLC   EWACPU,PSACPUSA+ONE     CRH SENSE NEEDED ?      @ZA16177 57540041
         BNE   CRH3100                 YES, SET IORST          @ZA16177 57580041
         SPACE 1                                                        57620041
         NI    UCBFLB,FF-UCBIORST      INSURE IORST IS OFF     @ZA16177 57660041
         B     CRH3300                 GO START SENSE          @ZA16177 57700041
         SPACE 1                                                        57740041
CRH3100  OI    UCBFLB,UCBIORST         SET IORST ON FOR CRH IO @ZA16177 57780041
         TM    CRCAFLG1,CRCADIAG       IS A CRH CONNECTION OUTSTANDING? 57900003
*                                      ( SIO GET A CONDITION CODE 1 ? ) 58000003
         BO    CRH3200                 YES-SKIP MAKING CRH CONNECTION   58100003
*                                      BUT USE CHANNEL 6 TO ISSUE SENSE 58200003
         EJECT                                                          58300003
*********************************************************************** 58400003
*                                                                     * 58500003
*        CONNECT CHANNEL RECONFIGURATION HARDWARE                     * 58600003
*                                                                     * 58700003
*********************************************************************** 58800003
         STH   WRK6,CRCACHAN           SAVE THE CHOSEN PATH             58900003
***                                                                 *** 59000003
*        SETUP MCW TO CONNECT CRH TO CHOSEN PATH                      * 59100003
***                                                                 *** 59200003
         STCM  WRK6,TWO,CRCAMCWF       STORE CHANNEL NUMBER IN SECOND   59300003
*                                      NIBBLE OF MCW CRH FUNCTION BYTE  59400003
         OI    CRCAMCWF,CRCAMCWI+CRCAMCWM  TURN ON BIT 26 TO INDICATE   59500003
*                                      CRH MCW AND BIT 27 TO MAKE CRH   59600003
*                                      CONNECTION                       59700003
***                                                                 *** 59800003
*  MAKE CHANNEL RECONFIGURATION HARDWARE CONNECTION TO CHOSEN CHANNEL * 59900003
***                                                                 *** 60000003
         OI    CRCAFLG1,CRCADIAG       INDICATE CRH CONNECTION          60100003
         DC    X'8300'                 ISSUE DIAGNOSE TO MAKE CRH       60200003
         DC    S(CRCAMCW)              CONNECTION                       60300003
***                                                                 *** 60400003
*   SETUP WORK REGISTER TO USE CHANNEL 6 WHEN ISSUING SENSE SIO       * 60500003
***                                                                 *** 60600003
CRH3200  N     WRK6,CHANMASK           AND OFF CHANNEL NUMBER           60700003
         O     WRK6,CHAN6              OR CHANNEL 6 INTO CHOSEN PATH    60800003
         EJECT                                                          60900003
*********************************************************************** 61000003
*                                                                     * 61100003
*        ISSUE SENSE SIO                                              * 61200003
*                                                                     * 61300003
*********************************************************************** 61400003
CRH3300  SIO   ZERO(WRK6)             ISSUE SENSE SIO                   61500003
         BALR  WRKA,ZERO              SAVE CONDITION CODE FROM SIO      61600003
*    ONE LINE DELETED FOR OZ16177                              @ZA16177 61700041
         TM    CRCAFLG1,CRCADIAG      CRH SENSE ?                       61750041
         BNO   CRH3500                NO, LEAVE CRH SENSE FLAG ALONE    61800041
*   FOUR LINES DELETED FOR OZ16177                             @ZA16177 61850041
*********************************************************************** 63100003
*                                                                     * 63200003
*        DISCONNECT CHANNEL RECONFIGURATION HARDWARE AND RETURN       * 63300003
*                                                                     * 63400003
*********************************************************************** 63500003
         NI    CRCAMCWF,CRCAMCWB       TURN OFF BIT 27 IN MCW TO        63600003
*                                      BREAK CRH CONNECTION             63700003
         DC    X'8300'                 ISSUE DIAGNOSE TO BREAK CRH      63800003
         DC    S(CRCAMCW)              CONNECTION                       63900003
         NI    CRCAFLG1,FF-CRCADIAG    INDICATE NO CRH CONNECTION       64000003
***                                                                 *** 64100003
*             EXIT LINKAGE                                            * 64200003
***                                                                 *** 64300003
CRH3500  SPM   WRKA                    RESTORE CONDITION CODE           64400003
         LM    WRK0,WRKODD,CRH3SAVE    RESTORE CALLERS REGISTERS FROM   64500003
*                                      INTERNAL SAVE AREA               64600003
         BR    WRKEVEN                 RETURN                           64700003
         EJECT                                                          64800003
*********************************************************************** 64900003
*                                                                     * 65000003
*             REGISTER EQUATES (SAME AS IOS MAINLINE - IECIOSCN)      * 65100003
*                                                                     * 65200003
*********************************************************************** 65300003
WRK0     EQU   0                       WORK REGISTER 0                  65400003
WRK1     EQU   1                       WORK REGISTER 1                  65500003
IOSBR    EQU   2                       IOSB REGISTER                    65600003
LCCAR    EQU   3                       LCCA REGISTER (CONTAINS IRT)     65700003
LNKR     EQU   4                       LINK REGISTER                    65800003
BASEA    EQU   5                       BASE REGISTER                    65900003
WRK6     EQU   6                       WORK REGISTER 6                  66000003
UCBR     EQU   7                       UCB REGISTER                     66100003
BASEB    EQU   8                       BASE REGISTER B                  66200003
BASEC    EQU   9                       BASE REGISTER C                  66300003
WRKA     EQU   10                      WORK REGISTER 10                 66400003
WRKB     EQU   11                      WORK REGISTER 11                 66500003
IOQR     EQU   11                      IOQE REGISTERS                   66600003
WRKC     EQU   12                      WORK REGISTER 12                 66700003
SAVR     EQU   13                      LCCA SAVE AREA REGISTER          66800003
WRKEVEN  EQU   14                      EVEN OF PAIR WORK REGISTER       66900003
WRKODD   EQU   15                      ODD OF PAIR WORK REGISTER        67000003
*********************************************************************** 67100003
*                                                                     * 67200003
*                   EQUATES                                           * 67300003
*                                                                     * 67400003
*********************************************************************** 67500003
ZERO     EQU   0                       ZERO                             67600003
ONE      EQU   1                       ONE                              67700003
NXTCHN   EQU   2                       LENGTH OF ENTRY IN TCH TABLE     67800003
TWO      EQU   2                       TWO                              67900003
THREE    EQU   3                       THREE                            68000003
FOUR     EQU   4                       FOUR                             68100003
FIVE     EQU   5                       FIVE                             68200003
EIGHT    EQU   8                       EIGHT                            68300003
F        EQU   X'F'                                                     68400003
FF       EQU   X'FF'                                                    68500003
CSWUNST  EQU   FLCCSW+FOUR                                              68600003
CSWCHST  EQU   FLCCSW+FIVE                                              68700003
CSWUCK   EQU   X'02'                                                    68800003
CSWCHER  EQU   X'0E'                                                    68900003
CSWBSY   EQU   X'10'                                                    69000003
CSWCE    EQU   X'08'                                           @OZ05693 69050041
         EJECT                                                          69100003
*********************************************************************** 69200003
*                                                                     * 69300003
*       INTERNAL  SAVE  AREAS                                         * 69400003
*                                                                     * 69500003
*********************************************************************** 69600003
***                                                                 *** 69700003
*              IECVCRH1 SAVE AREA FOR CALLERS REGISTERS                 69800003
***                                                                 *** 69900003
CRH1SAVE DS    0F                                                       70000003
         DS    5F                                                       70100003
HISBASEA DS    F                       IOS MAINLINE BASEA               70200003
         DS    2F                                                       70300003
HISBASES DS    2F                      IOS MAINLINE BASEB AND BASEC     70400003
         DS    4F                                                       70500003
RETURN   DS    2F                                                       70550003
***                                                                 *** 70600003
*              IECVCRH2 SAVE AREA FOR CALLERS REGISTERS                 70700003
***                                                                 *** 70800003
CRH2SAV6 DS    F                                               @YM30449 70900003
***                                                                 *** 71000003
*              IECVCRH3 SAVE AREA FOR CALLERS REGISTERS                 71100003
***                                                                 *** 71200003
CRH3SAVE DS    16F                                                      71300003
*                                                                       71400003
*********************************************************************** 71500003
*                                                                     * 71600003
*        CONSTANTS                                                    * 71700003
*                                                                     * 71800003
*********************************************************************** 71900003
         DS    0F                      GET WORD BOUNDARY                72000003
CHAN6    DC    X'00000600'             CHANNEL 6                        72100003
DEVMASK  DC    X'00000FF0'             MASK TO AND OFF DEVICE ADDRESS   72200003
CUMASK   DC    X'00000F00'             MASK TO AND OFF DEVICE AND       72300003
*                                      CONTROL UNIT ADDRESS             72400003
CHANMASK DC    X'000000FF'             MASK TO AND OFF CHANNEL NUMBER   72500003
PATHMASK DC    X'000000F0'             PATH MASK TESTER                 72600003
TERM     DC    V(IECVSRB)              ADDRESS OF I/O TERMINATION       72700003
*                                      SUBROUTINE IN IOS MAINLINE       72800003
DVT      DC    V(IECVDVT)              ADDRESS OF DEVICE TABLE          72900003
TOO      DC    H'2'                    TWO                              73000003
FORE     DC    H'4'                    FOUR                             73050003
       END                                                              73100003
