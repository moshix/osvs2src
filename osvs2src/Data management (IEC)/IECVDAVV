DAVV     TITLE '   IECVDAVV - PROLOGUE          '                       00050002
****************************************************************        00100002
*                                                              *        00110002
* MODULE NAME = IECVDAVV                                       *        00112002
*                                                              *        00120002
* DESCRIPTIVE NAME = DIRECT ACCESS VOLUME VERIFICATION         *        00122002
*                                                              *        00130002
* COPYRIGHT = NONE                                             *        00132002
*                                                              *        00140002
*                                                              *        00150002
* STATUS                                                       *        00200002
*    CHANGE LEVEL 00                                           *        00250002
*                                                              *        00300002
* FUNCTION                                                     *        00350002
*    DAVV RECEIVES CONTROL FROM POST STATUS VIA THE EXIT EF-   *        00400002
*    FECTOR AND ERP ROUTER WHEN IOSPROC OF THE IOSB CONTAINS   *        00450002
*    X'10'.  THE DAVV FUNCTION  IS TO VERIFY THAT THE PROPER   *        00500002
*    VOLUME IS  MOUNTED ON A  DIRECT ACCESS DEVICE.  THIS IS   *        00550002
*    DONE WHEN AN  UNSOLICITED DEVICE  END INTERRUPT HAS OC-   *        00600002
*    CURRED AND THE ATTENTION INDEX IN THE UCB IS ZERO.  THE   *        00650002
*    THE  VOLUME  LABEL IS  READ AND COMPARED  TO THE VOLUME   *        00700002
*    SERIAL IN THE UCB. IF THEY DO NOT MATCH, A DISMOUNT AND   *        00750002
*    MOUNT MESSAGE ARE ISSUED FOR THE  CORRECT VOLUME.  DAVV   *        00800002
*    DOES ITS OWN ERROR  RECOVERY AND INTERFACES WITH IGE00-   *        00850002
*    25C TO PRINT AN INTERVENTION REQUIRED MESSAGE.            *        00900002
*    IF THE DEVICE IS A PAGE PACK, CONTROL IS RECEIVED DIRECTLY*        00910003
*    FROM POST STATUS IS SRB MODE AND IN PLACE OF ISSUING      *        00920003
*    WTO'S, CONTROL RETURNS TO POST STATUS TO ENTER A          *        00930003
*    RESTARTABLE WAIT STATE.                                   *        00940003
*                                                              *        00950002
* NOTES = SEE BELOW                                            *        00952002
*                                                              *        00954002
*    DEPENDENCIES = NONE                                       *        00956002
*                                                              *        00960002
*    RESTRICTIONS = NONE                                       *        00962002
*                                                              *        00964002
*    REGISTER CONVENTIONS = SEE BELOW FOR REGISTER EQUATES     *        00966002
*                                                              *        00968002
*    PATCH LABEL = NONE                                        *        00968402
*                                                              *        00970002
* MODULE TYPE = INTEGRITY OF SYSTEM                            *        00972002
*                                                              *        00974002
*    PROCESSOR = ASSEMBLER                                     *        00976002
*                                                              *        00978002
*    MODULE SIZE = HEX 6B4 BYTES                               *        00978402
*                                                              *        00978802
* ATTRIBUTES                                                   *        00980802
*    RESIDENT                                                  *        00982802
*    REENTRANT                                                 *        00984802
*    RUNS ENABLED                                              *        00986802
*    RUNS IN KEY 0                                             *        00988802
*    RUNS IN SUPERVISOR STATE                                  *        00990802
*                                                              *        00992802
* ENTRY POINT =                                                *        01000002
*    IECVDAVV - FROM THE ERP ROUTER                            *        01050002
*               OR POST STATUS IN SRB MODE                     @ZA00904 01055003
*    DAVVESTA - FROM RTM FOR RECOVERY PROCESSING               *        01060002
*                                                              *        01100002
*    LINKAGE = NORMAL                                                   01103002
*                                                                       01106002
*    PURPOSE = SEE FUNCTION                                             01110002
*                                                                       01130002
*    INPUT =                                                      *     01150002
*    REGISTER  1 - ADDRESS OF IOSB                             *        01200002
*    REGISTER 13 - ADDRESS OF ESA1 SAVE AREA                   *        01250002
*    ADDRESS OF UCB IN IOSB                                    *        01300002
*    ADDRESS OF ERP WORK AREA IN IOSB                          *        01350002
*    UCBUDE ON AS FIRST TIME SWITCH                            *        01400002
*    UCBDAVV ON TO INDICATE DAVV IN CONTROL                    *        01450002
*    UCBQISCE ON TO PREVENT OTHER I/O ON DEVICE                *        01500002
*                                                              *        01550002
*    OUTPUT =                                                  *        01600002
*    UCBQISCE OFF UPON COMPLETION                              *        01650002
*    UCBDAVV  OFF UPON COMPLETION                              *        01700002
*    MESSAGES - SEE BELOW                                      *        01750002
*                                                              *        01800002
*    EXITS NORMAL = BR 14 TO DISPATCHER                        *        02100002
*                                                              *        02200002
*    EXITS ERROR = NONE                                        *        02250002
*                                                              *        02350002
* EXTERNAL REFERENCES                                          *        02355002
*    SVC F - ERREXCP                                           *        02360002
*    SVC 57 - DOM                                              *        02365002
*   RESIDENT XCTL ROUTINE (TO IGE0025C)                        *        02370002
*                                                              *        02375002
*    DATA SETS =                                               *        02380002
*                                                              *        02385002
*    DATA AREAS =                                              *        02390002
*                                                              *        02395002
* TABLES/WORKAREAS                                             *        02400002
*    ASCB                                                      *        02450002
*    ASXB                                                      *        02500002
*    CVT                                                       *        02550002
*    ERP WORKAREA                                              *        02600002
*    IOSB                                                      *        02650002
*    IRT                                                       *        02700002
*    LCCA                                                      *        02750002
*    PSA                                                       *        02800002
*    SIRB                                                      *        02850002
*    UCB                                                       *        02900002
*                                                              *        02950002
* MESSAGES                                                     *        03350002
*   IEA606I ADR,BAD VOLUME LABEL,CM,STAT,SENSBBBBBB,SER        *        03400002
*   IEA604A D ADR,SER                                          *        03450002
*   IEA605A M ADR,SER                                          *        03500002
*                                                              *        03550002
* MACROS = SDUMP,SETLOCK,SETRP,ESTAE,WTO,SETFRR,IOSINTRP       *        03555003
*                                                              *        03570002
* CHANGE ACTIVITY = NONE                                       *        03580002
*                                                              *        03590002
****************************************************************        03600002
         TITLE '   IECVDAVV - DSECTS            '                       03650002
         IHAASCB                                                        03700002
         EJECT                                                          03750002
         IHAASXB                                                        03800002
         EJECT                                                          03850002
         CVT   DSECT=YES,LIST=NO                                        03900002
         EJECT                                                          03950002
         IECDERWA                                                       04000002
         EJECT                                                          04010003
         IECDIOCM                                              @ZA24442 04020003
         EJECT                                                          04050002
         IECDIOSB                                                       04100002
         EJECT                                                          04150002
         IHALCCA                                                        04200002
         EJECT                                                          04250002
         IECDIRT                                                        04300002
         EJECT                                                          04310002
         IHASDWA                                                        04320002
         EJECT                                                          04330002
         IECDSIAB                                                       04340002
         EJECT                                                          04383302
         IHAPSA                                                         04400002
         EJECT                                                          04450002
         IHARB                                                          04500002
         EJECT                                                          04510002
FX       DSECT                                                          04512002
         DS    XL4                                                      04514002
         DS    XL150                                                    04516002
         ORG   FX+4                                                     04520002
****************************************************************        04530002
*                                                              *        04540002
*   THIS AREA IS USED TO MAP THE PERMANENT I/O ERROR MESSAGE.  *        04542002
*   IT IS MAPPED INTO THE EXTENDED ERP WORK AREA.              *        04543003
*                                                              *        04548002
****************************************************************        04548402
         SPACE 1                                                        04548802
ERRBUF   DS    0F                                                       04549602
BUFLNG   DS    H                   MESSAGE LENGTH                       04549702
BUFMCS   DS    XL2                 MCS FLAG                             04549802
BUFID    DS    CL8                 MESSAGE ID - CONSTANT                04549902
BUFCUA   DS    CL3                 DEVICE ADDRESS - VARIABLE            04566602
         DS    CL1                 ',' - CONSTANT                       04576602
BUFTXT   DS    CL16                MESSAGE TEXT - CONSTANT              04578602
         DS    CL1                 ',' - CONSTANT                       04580602
BUFOP    DS    CL2                 COMMAND CODE - VARIABLE              04582602
         DS    CL1                 ',' - CONSTANT                       04583002
BUFCSW   DS    CL4                 CSW STATUS - VARIABLE                04583102
         DS    CL1                 ',' - CONSTANT                       04583202
BUFSNS1  DS    CL10                5 SENSE BYTES - VARIABLE             04588802
         DS    CL1                 ',' - CONSTANT                       04590802
BUDVOL   DS    CL6                 VOLUME SERIAL - VARIABLE             04592802
         ORG   FX+76               SKIP FIRST SAVE AREA        @ZA24442 04592903
ERRSA    DS    16F                 SAVE AREA FOR IOSINTRP      @ZA24442 04593003
         EJECT                                                          04593202
         ORG   FX+4                                                     04593602
****************************************************************        04594002
*                                                              *        04594102
*   THIS AREA IS USED TO MAP THE DISMOUNT AND MOUNT MESSAGES   *        04594202
*   THEY ARE MAPPED INTO THE EXTENDED SAVE AREA OF THE SIRB    *        04594302
*   WHICH IS AVAILABLE ONLY IN VS2/2.                          *        04608202
*                                                              *        04618202
****************************************************************        04628202
         SPACE 1                                                        04630202
MNTBUF   DS    0F                                                       04634202
DMBUFL   DS    H                   MESSAGE LENGTH                       04634602
DMMCSF   DS    XL2                 MCS FLAGS                            04635002
DMMSGID  DS    CL8                 MESSAGE ID - CONSTANT                04635402
DMACT    DS    CL2                 ACTION D OR M                        04635802
DMCUA    DS    CL3                 DEVICE ADDR - VARIABLE               04635902
         DS    CL1                 ',' - CONSTANT                       04636002
DMVOL    DS    CL6                 VOLUME SERIAL - VARIABLE             04640602
         EJECT                                                          04645402
         IEFUCBOB LIST=YES,PREFIX=YES                                   04650002
         EJECT                                                          04700002
***                                                           ***       04750002
*   DSECT DESCRIBES USAGE OF SVC DUMP 4K BUFFER                 *       04800002
***                                                           ***       04850002
         SPACE 2                                                        04900002
SDBUF    DSECT                                                          04950002
SDBDATAD DS    A                   DATA ADDRESS                         05000002
SDBDLN   DS    H                   DATA LENGTH                          05050002
SDBDATA  EQU   *                                                        05100002
SDBSIB   DS    XL(SIABEL)          SRB/IOSB                             05150002
SDBEWA   DS    XL(SIABEL)          DAVV WORKAREA                        05200002
SDBUCB   DS    XL(UCBCURPX+(UCBBASE-UCBOB)) UCB                         05250002
SDBDL    EQU   *-SDBDATA                                                05300002
SDBLAST  DS    XL6                 END OF USAGE INDICATOR               05350002
         SPACE 5                                                        05356003
*  FRR USER PARAMETER MAP                                      @ZA00904 05362003
         SPACE                                                          05368003
FRRPARM  DSECT                                                 @ZA00904 05374003
FRRBASE  DS    A                   MAINLINE BASE REG           @ZA00904 05380003
FRRIOSB  DS    A                   IOSB POINTER                @ZA00904 05386003
         DS    4F                  NOT USED                    @ZA00904 05392003
         EJECT                                                          05400002
         IHAFRRS                                                        05450002
         TITLE '   IECVDAVV - EQUATES           '                       06800002
REG0     EQU   0                   USED IN CS INSTRUCTION               06850002
PARMRG   EQU   1                   IOSB INPUT ADDRESS                   06900002
IOSBRG   EQU   2                   IOSB ADDRESS THRUOUT DAVV            06950002
*        EQU   3                   NOT USED                             07000002
FRRREG   EQU   4                   FRR PARM RETURN             @ZA00904 07050003
BASERG   EQU   5                   BASE REGISTER                        07100002
ERPWA    EQU   6                   ADDRESS OF ERP WORK AREA             07150002
UCBREG   EQU   7                   ADDRESS OF UCB                       07200002
WRKRG1   EQU   8                   WORK REGISTER 1                      07250002
WRKRG2   EQU   9                   WORK REGISTER 2                      07300002
CCWREG   EQU   10                  CHANNEL PROGRAM ADDRESS              07350002
SIRBRG   EQU   11                  ADDR OF MSG BUFFER IN SIRB           07400002
IRTREG   EQU   12                  IRT ADDR FOR CS INSTR.               07450002
LLSAVE   EQU   13                  SAVE AREA ADDRESS                    07500002
RTRNRG   EQU   14                  RETURN REGISTER                      07550002
LINKRG   EQU   15                  LINKING REGISTER                     07600002
         SPACE 1                                                        07650002
*        MISCELLANEOUS EQUATES                                          07700002
         SPACE 1                                                        07750002
D0       EQU   0                   DISPLACEMENT OF 0                    07800002
D1       EQU   1                   DISPLACEMENT OF 1                    07850002
D2       EQU   2                   DISPLACEMENT OF 2                    07900002
D3       EQU   3                   DISPLACEMENT OF 3                    07950002
EXIT     EQU   3                   SVC 3 SYMBOLIC                       07960002
D4       EQU   4                   DISPLACEMENT OF 4                    08000002
D5       EQU   5                   DISPLACEMENT OF 5                    08050002
D6       EQU   6                   DISPLACEMENT OF 6                    08100002
D7       EQU   7                   DISPLACEMENT OF 7                    08150002
D8       EQU   8                   DISPLACEMENT OF 8                    08200002
D9       EQU   9                   DISPLACEMENT OF 9                    08250002
D11      EQU   11                  LENGTH OF 11                @ZA06506 08255003
D12      EQU   12                  DISPLACEMENT OF 12                   08260002
D13      EQU   13                  DISPLACEMENT OF 13                   08300002
D16      EQU   16                  DISPLACEMENT OF 16                   08350002
D28      EQU   28                  DISPLACEMENT OF 28                   08400002
D31      EQU   31                  DISPLACEMENT OF 31                   08450002
D62      EQU   62                  COUNT OF 62                          08500002
C512     EQU   512                 FOR ADJUSTING TO UCB PREFIX          08510002
FIVE     EQU   X'05'               COUNT FOR SEARCH                     08550002
TEN      EQU   10                  COUNT FOR READ                       08600002
LASTIND  EQU   X'80'               END OF LIST INDICATOR                08650002
MASKFF   EQU   X'FF'               FF FOR BUFFER AREA                   08700002
MASK00   EQU   X'00'               ZERO VALUE FOR COMPARES              08750002
SILI     EQU   X'20'               SILI FLAG                            08800002
CMCHNSLI EQU   X'60'               COMMAND CHAIN AND SILI FLAGS         08850002
READOP   EQU   X'06'               READ DATA COMMAND                    08900002
TICOP    EQU   X'08'               TIC COMMAND                          08950002
SIDOP    EQU   X'31'               SEARCH ID EQUAL COMMAND              09000002
RDR0OP   EQU   X'16'               READ RECORD ZERO COMMAND             09050002
R3       EQU   X'03'               RECORD 3 INDICATOR                   09100002
WINCHST  EQU   X'0A'               WINCHESTER DEVICE                    09150002
CSWUEX   EQU   X'01'               UNIT EXCEPTION                       09200002
CSWUCK   EQU   X'02'               UNIT CHECK                           09250002
WTOID    EQU   253                 IGE0025C ID FOR XCTL                 09300002
DISP     EQU   X'F0'               DISPLACEMENT FOR TRANSLATE           09350002
DISID    EQU   C'4'                DISMOUNT MSG CODE                    09400002
MNTID    EQU   C'5'                MOUNT MSG CODE                       09450002
DISMOUNT EQU   C'D'                DISMOUNT ACTION                      09500002
MOUNT    EQU   C'M'                MOUNT ACTION                         09550002
ERREXCP  EQU   15                  SVC F - ISSUED FOR I/O               09600002
DAVRCURS EQU   X'80'               ESTAE - RETRY RECURSION              09610002
DAVRCTA  EQU   X'40'               RCTA NOT PROVIDED TO ESTAE           09620002
DISABLE  EQU   X'FC'               STNSM DISABLE MASK                   09630002
*                                  * DISABLES I/O AND EXTERNAL          09640002
         TITLE '   IECVDAVV - INITIALIZATION AND CCW BUILD'             09650002
IECVDAVV CSECT                                                          09700002
         USING FX,SIRBRG                                                09702002
         USING PSA,0                                                    09710002
         BALR  BASERG,0            SET ADDRESSABILITY                   09750002
         USING DAVVEP,BASERG                                            09800002
DAVVEP   EQU   *                   DAVV ADDRESSABILITY LABEL            09805003
         MODID                                                          09815003
         SPACE 1                                                        09850002
         ST    PARMRG,D0(LLSAVE)   SAVE IOSB ADDRESS                    09900002
         STM   LLSAVE,RTRNRG,D4(LLSAVE)                                 09950002
         LR    IOSBRG,PARMRG       PUT IOSB ADDRESS IN REG 2            09960002
         SPACE 1                                                        10000002
         ESTAE DAVVESTA,ASYNCH=NO  SET ESTAE ROUTINE                    10100002
         SPACE 1                                                        10150002
         USING IOSB,IOSBRG                                              10250002
         L     UCBREG,IOSUCB       PUT UCB IN REG 7 FROM IOSB           10300002
         LA    WRKRG1,C512         ADDRESS UCB PREFIX                   10310002
         SR    UCBREG,WRKRG1                                            10320002
         USING UCB,UCBREG                                               10350002
         L     ERPWA,IOSERP        PUT ERP W.A. ADDR IN REG 6           10400002
         USING EWA,ERPWA                                                10450002
         L     SIRBRG,EWAEXT       LOAD WORK AREA               @YM7181 10460002
         B     DAVPROC             SKIP ALTERNATE ENTRY CODE   @ZA00904 10461003
         SPACE 1                                                        10462003
*********************************************************************** 10463003
*  ALTERNATE ENTRY POINT--CALLED DIRECTLY BY IECVPST IN SRB MODE WHEN * 10464003
*  UNSOLICITED DEVICE END IS FROM A PAGE PACK (UCBPGFL ON)            * 10465003
*********************************************************************** 10466003
         ENTRY IECVDAV2                                        @ZA00904 10467003
IECVDAV2 STM   REG0,LINKRG,0(LLSAVE) SAVE IECVPST REGISTERS    @ZA00904 10468003
         LR    BASERG,LINKRG       SET BASE REGISTER           @ZA00904 10469003
         LA    WRKRG1,IECVDAV2-DAVVEP AND ESTABLISH            @ZA00904 10470003
         SR    BASERG,WRKRG1          ADDRESSABILITY AT DAVVEP @ZA00904 10471003
         LR    IOSBRG,PARMRG       SET IOSB POINTER            @ZA00904 10472003
         L     UCBREG,IOSUCB       SET UCB POINTER             @ZA00904 10473003
         LA    WRKRG1,C512         ADJUST                      @ZA00904 10474003
         SR    UCBREG,WRKRG1          FOR PREFIX               @ZA00904 10475003
         L     ERPWA,IOSERP        SET ERP WORK AREA POINTER   @ZA00904 10476003
         L     SIRBRG,EWAEXT       SET EXTEND WORK AREA POINTER@ZA00904 10477003
*                                     USED IN THIS ENTRY       @ZA00904 10478003
*                                     FOR A SAVE AREA          @ZA00904 10479003
         ST    LLSAVE,4(SIRBRG)    SAVE RETURN SA POINTER      @ZA00904 10480003
         SETFRR A,FRRAD=DAVFRRA,PARMAD=(FRRREG),                       *10480603
               WRKREGS=(WRKRG1,WRKRG2),                                *10482003
               RELATED=(DAVFRR,IECVDAVV(DAVFRRTY,DAVRRY,DAVWAIT2))      10483003
         USING FRRPARM,FRRREG                                  @ZA00904 10484003
         ST    BASERG,FRRBASE      SAVE BASE AND IOSB          @ZA00904 10485003
         ST    IOSBRG,FRRIOSB         REGS FOR FRR             @ZA00904 10486003
         SPACE 1                                                        10500002
DAVPROC  TM    UCBFLC,UCBUDE       FIRST TIME THROUGH?                  10550003
         BZ    DAVSNTRY            NO, GO TO SECON ENTRY                10600002
         CLI   UCBVOLI,MASK00      HAS THERE BEEN A MOUNT REQ.          10650002
*                                  SINCE THE DE INTERRUPT?              10700002
         BE    DAVVSAM             YES,VERIFICATION NOT NEEDED @Y30LPLC 10750003
         TM    UCBDMCT,UCBMOUNT    MOUNT BIT SET?                       10800002
         BO    DAVVSAM             YES,VERIFICATION NOT NEEDED @Y30LPLC 10850003
         SPACE 1                                                        10900002
         MVI   IOSCOD,IOSNRMC      SET COMPLETION CODE TO 7F            10950002
         SPACE 1                                                        11000002
****************************************************************        11010002
*        BUILD CHANNEL PROGRAM TO READ VOLUME SERIAL           *        11050002
****************************************************************        11060002
         SPACE 1                                                        11100002
         MVI   EWACNTR1,MASK00     SET ERROR COUNT TO ZERO              11150002
         XC    IOSEEK(D7),IOSEEK   ZERO MBBCCHHR IN IOSB                11200002
DAVRSET  MVI   IOSEEK+D7,R3        SET RECORD NUMBER TO 3               11250002
         LA    CCWREG,EWDCCW1      INIT REG WITH ADDR OF CHANNEL        11300002
*                                  PROGRAM AND PUT IN IOSB LATER        11350002
         LRA   WRKRG1,IOSEEK+D3    GET ADDR OF SEARCH ARGUMENT          11400002
         ST    WRKRG1,D0(CCWREG)   AND PUT IN SEARCH CCW                11500002
         MVI   D0(CCWREG),SIDOP    SET OP CODE TO SID                   11550002
         LA    WRKRG1,FIVE                                              11600002
         ST    WRKRG1,D4(CCWREG)   SET COUNT TO 5 IN SEARCH CCW         11650002
         MVI   D4(CCWREG),CMCHNSLI SET COMMAND CHAIN AND SILI           11700002
         LRA   CCWREG,D0(CCWREG)   GET REAL ADDR OF CHAN PGM            11750002
         ST    CCWREG,EWDCCW2      AND STORE IN TIC CCW                 11800002
         ST    CCWREG,IOSRST       AND NOW IN IOSB CHAN PGM ADDR        11850002
         LA    CCWREG,EWDCCW2      INCR TO TIC CCW                      11900002
         MVI   D0(CCWREG),TICOP    MOVE TIC OP CODE TO TIC CCW          11950002
         LA    CCWREG,EWDCCW3      INCR TO READ CCW                     12000002
         LA    WRKRG2,EWDSAVS      GET REAL ADDRESS OF BUFFER           12050002
         MVI   D0(WRKRG2),MASKFF   MOVE FF TO FIRST BYTE OF BUFFER      12060002
         MVC   D1(D9,WRKRG2),D0(WRKRG2)                                 12070002
*                                  MOVE FF TO REST OF BUFFER            12080002
         LRA   WRKRG2,D0(WRKRG2)   AND STORE IN READ CCW                12100002
         ST    WRKRG2,D0(CCWREG)                                        12150002
         MVI   D0(CCWREG),READOP   MOVE READ DATE OP CODE TO CCW        12200002
         ALR   WRKRG1,WRKRG1       DOUBLE 5 COUNT FOR 10 COUNT          12250002
         ST    WRKRG1,D4(CCWREG)   SET SILI INDICATOR                   12300002
         SPACE 1                                                        12350002
         OI    IOSFLA,IOSERR       SET RETRY INDICATOR ON               12400002
         OI    IOSOPT,IOSQISCE     SET QUIESCE FLAG FOR IOS             12450002
         SPACE 2                                                        12650002
****************************************************************        12660002
*  INTERFACE TO SVC F TO READ VOLUME LABEL OR RETRY ERROR             * 12670003
*  FOR BRANCH ENTRY BY IECVPST, RETURN IS BY A BRANCH TABLE           * 12673003
****************************************************************        12680002
         SPACE 1                                                        12690002
DAVSVCF  TM    UCBSTAB,UCBPGFL     SRB ENTRY?                  @ZA00904 12691003
         BZ    DAVSVCF1            NO--ISSUE SVC               @ZA00904 12692003
DAVFRRTY SETFRR D,WRKREGS=(WRKRG1,WRKRG2),                             *12693003
               RELATED=(DAVFRR,IECVDAVV(IECDAV2))              @ZA00904 12694003
         L     ERPWA,IOSERP        GET EWP WORK AREA PTR       @ZA00904 12694303
         L     SIRBRG,EWAEXT       GET EXTENDED WA PTR         @ZA00904 12694603
         L     LLSAVE,4(SIRBRG)    RESTORE SAVE AREA POINTER   @ZA00904 12695003
         LM    REG0,LINKRG,0(LLSAVE) RESTORE REGISTERS         @ZA00904 12696003
         TM    IOSFLA-IOSB(PARMRG),IOSERR  RETRY READ?         @ZA00904 12697003
         BNO   D4(RTRNRG)          NO--RETURN TO EXIT          @ZA00904 12698003
         BR    RTRNRG              YES--RETRY READ             @ZA00904 12699003
DAVSVCF1 EQU   *                                                        12700003
         L     PARMRG,D0(LLSAVE)   INIT REG 1 WITH IOSB                 12710002
         SVC   ERREXCP             TO IOS TO READ VOL LABEL             12750002
         L     RTRNRG,D8(LLSAVE)   RESTORE REG 14                       12800002
         BR    RTRNRG              RETURN TO DISPATCHER                 12850002
         SPACE                                                          12855003
************************************************************** @Y30LPLC 12860003
*    VSAM INTERFACE FOR SS1. TURN OFF UCBAMV FLAG IF A MOUNT   @Y30LPLC 12865003
*    REQUEST HAS BEEN MADE.                                    @Y30LPLC 12870003
************************************************************** @Y30LPLC 12875003
         SPACE                                                          12880003
DAVVSAM  EQU   *                                               @Y30LPLC 12885003
         NI    UCBFL5,MASKFF-UCBAMV INDICATE COMPARISON CHECK- @Y30LPLC 12890003
*                                   ING NOT COMPLETE FLAG.     @Y30LPLC 12895003
         SPACE 2                                                        12900002
****************************************************************        12910002
*    THIS IS CLEAN UP CODE PRIOR TO EXITING.  UCBQISCE AND     *        12920002
*    UCBDAVV ARE RESET WHILE HOLDING THE UCB LOCK. THE IRT     *        12930002
*    RESTART  CHANNEL MASK IS USED TO COMPARE AND  SWAP TO     *        12940002
*    SET AN INDICATOR FOR THIS PATH NOW BEING AVAILABLE.       *        12942002
****************************************************************        12944002
         SPACE 1                                                        12946002
DAVENDUP EQU   *                                                        12950002
         MVI   IOSCOD,IOSNRMC      SET COMPLETION CODE TO 7F            13000002
         NI    IOSFLA,MASKFF-IOSERR RESET RETRY INDICATOR               13050002
         SPACE 1                                                        13100002
         LR    WRKRG1,LLSAVE       SAVE REG 13 ACROSS SETLOCK           13150002
DAVSUCB  SETLOCK  OBTAIN,TYPE=IOSUCB,ADDR=UCBLOCK,MODE=UNCOND,         *13200002
               RELATED=(DAVUCB,IECVDAVV(DAVSUCB1))                      13250002
         LR    LLSAVE,WRKRG1       RESTORE REG 13                       13300002
         SPACE 1                                                        13350002
         NI    UCBFLA,MASKFF-UCBQISCE                                   13400002
         NI    UCBFL4,MASKFF-UCBDAVV                                    13450002
*                                  RESET QUIESCE AND DAVV IND.          13500002
         SR    WRKRG1,WRKRG1       CLEAR WORK REG                       13550002
         IC    WRKRG1,UCBCHA       LAST STARTED CHANNEL ADDR            13600002
         L     IRTREG,PSALCCAV                                          13700002
         USING LCCA,IRTREG                                              13750002
         LA    IRTREG,LCCAIRT      GET IRT ADDR AND                     13800002
         USING IRT,IRTREG          ESTABLISH ADDRESSABILITY             13850002
         LA    WRKRG2,D1           INIT REG WITH 1                      13900002
         SLL   WRKRG2,D31          SHIFT TO HIGH ORDER BIT              13950002
         SRL   WRKRG2,D0(WRKRG1)   SHIFT TO PROPER CHAN LOCATION        14000002
         L     WRKRG1,IRTCHMSK     GET IRT CHANNEL MASK                 14050002
DAVCSET  LR    REG0,WRKRG2         PREPARE TO MERGE                     14100002
         OR    REG0,WRKRG1         SET THIS CHANNEL IND                 14150002
         CS    WRKRG1,REG0,IRTCHMSK                                     14200002
*                                  IF MASKS ARE NOT EQUAL, BRANCH       14250002
         BNE   DAVCSET             TO SWAP AGAIN.                       14300002
*                                  IF EQUAL, REPLACE IRTMASK            14350002
*                                  WITH MASK WITH THIS CHANNEL          14400002
*                                  INDICATED IN IT.                     14450002
         SPACE 1                                                        14500002
         LR    WRKRG1,LLSAVE       SAVE REG 13 ACROSS SETLOCK           14550002
DAVSUCB1 SETLOCK  RELEASE,TYPE=IOSUCB,ADDR=UCBLOCK,                    *14600002
               RELATED=(DAVUCB,IECVDAVV(DAVSUCB))                       14650002
         SPACE 1                                                        14710002
*   SIMULATE AN INTERRUPT TO INSURE IOS WILL REDRIVE DEVICE    *        14720002
         SPACE 1                                                        14750002
         L     SIRBRG,EWAEXT       RESTORE SIRBREG             @ZA24442 14752003
         LA    LLSAVE,ERRSA        GET SAVE AREA               @ZA24442 14756003
         L     WRKRG2,IOSUCB       GET BASE UCB ADDRESS                 14760003
         IOSINTRP UCB=(WRKRG2),VAR=1,BRANCH=YES                @ZA24442 14764003
         LR    LLSAVE,WRKRG1       RESTORE REG 13              @ZA24442 14768003
         SPACE 1                                                        14780002
         B     DAVSVCF             BRANCH TO ISSUE SVC F FOR            14800002
*                                  TERMINATION PROCESSING               14850002
         TITLE '   IECVDAVV - SECOND ENTRY PROCESSING '                 14900002
****************************************************************        14910002
*    SECOND ENTRY IS INDICATED BY THE UCBUDE INDICATOR BEING   *        14920002
*    OFF. ENTRY HERE INDICATE THAT THE VOLUME LABEL WAS JUST   *        14930002
*    READ OR DAVV ISSUED A DISMOUNT/MOUNT MESSAGE.             *        14940002
****************************************************************        14942002
         SPACE 1                                                        14944002
DAVSNTRY EQU   *                                                        14950002
         TM    IOSFLC,IOSDVMNT     DAVV ISSUE MOUNT MESSAGE?            15000002
         BZ    DAVERRCK            NO, GO CHECK FOR READ ERRORS         15050002
         NI    IOSFLC,MASKFF-IOSDVMNT                                   15100002
*                                  RESET DAVV ISSUED MOUNT IND.         15150002
         LA    PARMRG,EWDCCW8      PICK UP MESSAGE IDS                  15250002
         DOM   MSGLIST=(1)         DELETE MESSAGES                      15300002
         B     DAVRSET             BRANCH TO CONTINUS SETTING           15400002
*                                  UP TO READ VOLUME SERIAL             15450002
         TITLE '   IECVDAVV - ERROR HANDLING     '                      15500002
****************************************************************        15510002
*    IF NO ERROR OCCURRED WHILE READING THE VOLUME LABEL,      *        15520002
*    THE LABEL READ IS COMPARED TO THE LABEL IN THE  UCB.      *        15530002
****************************************************************        15540002
         SPACE 1                                                        15542002
DAVERRCK EQU   *                                                        15550002
         LH    WRKRG1,IOSTATUS     GET CSW STATUS                       15600002
         N     WRKRG1,CDUATN       IF OTHER THAN CHE, DVE, UNIT         15650002
         BNZ   DAVUCK              EXCPTN, ATTN, WLR BRANCH             15700002
         SPACE 1                                                        15750002
         TM    IOSFLC,IOSDVALT     ALT TRACK PROCESSING IN PROG-        15800002
         BO    DAVALT              RESS, YES GO HANDLE                  15850002
         SPACE 1                                                        15900002
         TM    IOSTSA,CSWUEX       IF UNIT EXCEPTION, BRANCH TO         15950002
         BO    DAVINCR             CONTINUE RETRY                       16000002
         SPACE 1                                                        16050002
*        COMPARE VOLUME SERIALS                                         16100002
         SPACE 1                                                        16150002
         LA    WRKRG1,EWDSAVS      GET ADDR OF INPUT BUFFER             16200002
         LA    WRKRG1,D4(WRKRG1)   INCR TO VOL SERIAL                   16250002
         LA    WRKRG2,UCBVOLI      GET EXPECTED VOL SER ADDR            16300002
         CLC   D0(D6,WRKRG1),D0(WRKRG2)     VOL SERS MATCH?             16350002
*                                  YES, BRANCH TO INTERFACE WITH        16400002
         BE    DAVENDUP            SVC F TO TERMINATE PROCESSING        16450002
         TITLE '   IECVDAVV - ERROR HANDLING     '                      16500002
****************************************************************        16510002
*    THIS LABEL IS NOT REFERENCED BUT FALL THROUGH TO HERE     *        16520002
*    IS DONE IF THE VOLUME SERIAL DID NOT MATCH BUT NO ERR     *        16530002
*    OCCURRED DURING THE I/O.                                  *        16540002
****************************************************************        16542002
         SPACE 1                                                        16544002
DAVERR   EQU   *                                                        16550002
         TM    IOSOPT,IOSBYP       TEST IF LAST I/O WAS A RECALI-       16600002
         BZ    DAVDISMT            BRATE BY TESTING IOS BYPASS          16650002
         SPACE 1                   PREFIX INDICATOR.                    16700002
         NI    IOSOPT,MASKFF-IOSBYP-IOSDEP                              16750002
*                                  RESET BYPASS CHAN PGM PRFX           16800002
         LA    WRKRG1,EWDCCW1      AND DEVICE END POST IND.             16850002
         LRA   WRKRG1,D0(WRKRG1)   GET REAL ADDR OF CHAN PGM            16900002
         ST    WRKRG1,IOSRST       AND RESTORE FOR SID IN IOSB          16950002
DAVINCR  SR    WRKRG1,WRKRG1       CLEAR WORK REG TO INCREMENT          17000002
         IC    WRKRG1,EWACNTR1     ERROR COUNTER BY 1                   17050002
         LA    WRKRG1,D1(WRKRG1)                                        17100002
         STC   WRKRG1,EWACNTR1                                          17150002
         CLI   EWACNTR1,TEN        IF # RETRYS EQUAL TO 10 ?            17200002
         BNE   DAVSVCF             NO, BRANCH TO RETRY VIA SVC F        17250002
         SPACE 1                                                        17300002
****************************************************************        17310002
*        THIS CODE SETS UP A PERMANENT I/O ERROR MESSAGE.      *        17350002
*        IT IS BUILT IN THE SIRB EXTENDED SAVE AREA.           *        17400002
****************************************************************        17410002
         SPACE 1                                                        17450002
         OI    IOSFLC,IOSRWERR     INDICATE PERM ERROR         @ZA00904 17500003
         TM    UCBSTAB,UCBPGFL     ERROR ON PAGE PACK?         @ZA00904 17550003
         BO    DAVWAIT             YES--RESTARTABLE WAIT       @ZA00904 17600003
         MVC   BUFLNG(D62),ERRMSG   MOVE ERROR MSG TO BUFFER AREA       18050002
         MVC   EWDCCWA(D2),UCBCHAN MOVE DEVICE ADDR TO WORK AREA        18150002
         UNPK  EWDCCW9(D5),EWDCCWA(D3)      UNPACK                      18200002
         TR    EWDCCW9+D1(D3),TRANTAB-DISP                              18250002
*                                  TRANSLATE WHAT WAS UNPACKED          18300002
         MVC   BUFCUA,EWDCCW9+D1   MOVE DEVICE ADDR TO BUFFER           18350002
         L     CCWREG,IOSCC        GET CCW ADDR FROM CSW                18400002
         LA    CCWREG,D0(CCWREG)   ZERO HIGH ORDER BYTE                 18450002
         LTR   CCWREG,CCWREG       IF ZERO CCW ADDRESS, ** IS IN        18500002
         BE    DAVERMS1            BUFFER. CONTINUE UNPK AT CSW         18550002
*                                  STATUS.                              18600002
         LA    WRKRG1,D8           LOAD WITH 8                          18700002
         SR    CCWREG,WRKRG1       DECR TO START OF CCW, UNPK           18750002
         UNPK  EWDCCW9(D3),D0(D2,CCWREG)                                18800002
         TR    EWDCCW9(D1),TRANTAB-DISP                                 18850002
         MVC   BUFOP,EWDCCW9       TRANSLATE AND MOVE TO BUFFER         18900002
         SPACE 1                                                        18950002
*   UNPK CSW STATUS AND 5 SENSE BYTES; THEN TRANSLATE IT ALL            19000002
         SPACE 1                                                        19050002
DAVERMS1 UNPK  EWDCCW8(D5),IOSTATUS(D3) EXECUTED UNPACK                 19100002
         UNPK  EWDCCW8+D4(D11),EWDSNS(D6)                      @ZA06506 19150003
         TR    EWDCCW8(D16),TRANTAB-DISP                                19200002
         MVC   BUFCSW,EWDCCW8      MOVE CSW STATUS TO BUFFER            19250002
         MVC   BUFSNS1,EWDCCW8+D4  MOVE SENSE TO BUFFER                 19300002
         MVC   BUDVOL,UCBVOLI      MOVE VOL SER TO BUFFER               19350002
         SPACE 1                                                        19400002
         WTO   MF=(E,ERRBUF)     ISSUE I/O ERROR MSG                    19500002
         ST    PARMRG,EWDCCW8      SAVE MSG ID                          19550002
         SPACE 2                                                        19600002
         NI    IOSFLA,MASKFF-IOSERR RESET RETRY INDICATOR               19650002
         B     DAVMNT              GO TO ISSUE MOUNT MSG                19700002
         EJECT                                                          19710002
****************************************************************        19760002
*  THIS CODE SETS UP AND  ISSUES A DISMOUNT  MESSAGE WHEN THE  *        19800002
*  VOLUME SERIAL READ DOES NOT MATCH THE VOLUME SERIAL IN THE  *        19850002
*  UCB.                                                        *        19900002
****************************************************************        19902002
         SPACE 1                                                        19904002
DAVDISMT EQU   *                                                        19910002
         NI    IOSFLC,MASKFF-IOSRWAIT+IOSRWVID  CLEAR WAIT BITS         19960003
*                                  AND INDICATE WRONG VOL ID   @ZA00904 20010003
         TM    UCBSTAB,UCBPGFL     ERROR ON PAGE PACK?         @ZA00904 20060003
         BO    DAVWAIT             YES--RESTARTABLE WAIT       @ZA00904 20110003
         MVC   DMBUFL(D28),DISMSG  MOVE DISMOUNT MSG TO BUFR            20550002
         MVC   DMCUA(D3),UCBNAME   MOVE UNIT NAME TO MSG BUFFER         20600002
         MVC   DMVOL,EWDSAVS+D4    MOVE VOL SERIAL TO MSG BUFFER        20650002
         SPACE 1                                                        20800002
         WTO   MF=(E,MNTBUF)       ISSUE DISMOUNT MESSAGE               20900002
         ST    PARMRG,EWDCCW8      SAVE MSG ID                          20950002
         SPACE 3                                                        21050002
****************************************************************        21060002
*  THIS CODE SETS UP AND ISSUES A MOUNT MESSAGE FOR THE VOL-   *        21150002
*  UME SERIAL IN THE UCB. SIRBRG HAS THE ADDR OF THE MSG BUF   *        21200002
****************************************************************        21202002
         SPACE 1                                                        21204002
DAVMNT   EQU   *                                                        21210002
         MVC   DMBUFL(D28),DISMSG                                       21350002
         MVC   DMCUA(D3),UCBNAME   MOVE UNIT NAME TO MSG BUFFER         21360002
         MVC   DMVOL,UCBVOLI       MOVE MSG AND VOL SER TO BUFFR        21400002
         MVI   DMACT,MOUNT         INSURE CORRECT ACTION - M            21450002
         MVI   DMMSGID+D5,MNTID    INSURE CORRECT ID                    21500002
         SPACE 1                                                        21550002
****************************************************************        21560002
*   THE NOT READY FLAG IS NOT SET BEFORE ISSUING MOUNT.  NO    *        21600002
*   I/O WILL BE ALLOWED ON THIS DEVICE WITH THE UCB QUIESCE    *        21650002
*   FLAG ON WITH THE  EXCEPTION OF DAVV I/O  (IOSQISCE ON).    *        21700002
****************************************************************        21710002
         SPACE 1                                                        21750002
         WTO   MF=(E,MNTBUF)     ISSUE MOUNT MESSAGE                    21850002
         ST    PARMRG,EWDCCW8+D4   SAVE MESSAGE ID                      21900002
         OI    EWDCCW8+D4,LASTIND  SET LAST IND ON                      21910002
         OI    IOSFLC,IOSDVMNT     SET DAVV ISSUED MOUNT IND.           21950002
         SPACE 1                                                        22000002
****************************************************************        22010002
*  GET UCB LOCK TO SET DAVV WAITING INDICATOR AND SRB ADDRESS  *        22050002
*  IN UCBIOQ FOR RESTARTING DAVV                               *        22100002
****************************************************************        22110002
         SPACE 1                                                        22150002
         LR    WRKRG2,LLSAVE       SAVE REG 13 ACCROSS SETLOCK          22200002
DAVSUCB2 SETLOCK  OBTAIN,TYPE=IOSUCB,ADDR=UCBLOCK,MODE=UNCOND,         *22250002
               RELATED=(DAVUCB,IECVDAVV(DAVSUCB3))                      22300002
         SPACE 1                                                        22350002
         L     WRKRG1,IOSSRB       GET SRB ADDRESS AND STORE            22400002
         ST    WRKRG1,UCBIOQ       IN UCB                               22450002
         OI    UCBFL4,UCBWDAV      SET DAVV WAITING FOR DE INT.         22500002
         SPACE 1                                                        22550002
SUBSUCB3 SETLOCK  RELEASE,TYPE=IOSUCB,ADDR=UCBLOCK,                    *22600002
               RELATED=(DAVUCB,IECVDAVV(DAVSUCB2))                      22650002
         LR    LLSAVE,WRKRG2       RESTORE REG 13                       22700002
         SPACE 1                                                        22750002
         L     RTRNRG,D8(LLSAVE)   RESTORE REGISTER 14                  22800002
         BR    RTRNRG              RETURN TO DISPATCHER                 22850002
DAVALT   EQU   *                   ALTERNATE TRACK PROCESSING           22900002
         NI    IOSFLC,MASKFF-IOSDVALT  RESET ALT TRACK PROC. IND        22950002
DAVAMOVE LA    WRKRG1,IOSEEK       GET IOSB SEEK ADDRESS                23000002
         LA    WRKRG2,EWDRZRO      GET ALT TRK CCHH AND MOVE TO         23050002
         MVC   D3(D4,WRKRG1),D0(WRKRG2)     IOSB SEEK FIELD             23100002
         MVI   EWACNTR1,D0         RESET ERROR COUNT TO 0               23150002
         B     DAVRSET             BRANCH TO READ VOLUME SERIAL         23200002
         EJECT                                                          23250002
****************************************************************        23260002
*      IF AN ERROR OCCURRED DURING THE READ OF THE VOLUME      *        23270002
*      LABEL IT IS ANALYZED  HERE FOR FURTHER PROCESSING.      *        23280002
****************************************************************        23290002
         SPACE 1                                                        23292002
DAVUCK   EQU   *                   UNIT CHECK HANDLING                  23300002
         TM    IOSTSA,CSWUCK       IF NO UNIT CHECK,                    23350002
         BZ    DAVINCR             BRANCH TO CONTINUE RETRY             23400002
         TM    EWDSNS0,EWDSKCK     TEST FOR SEEK CHECK                  23450002
         BZ    DAVINTV             NO, GO CHECK INTERVENTION REQ        23500002
         LA    WRKRG1,EWDCCW4      GET ADDR OF RECALIBRATE CCW          23550002
         MVC   D0(D16,WRKRG1),RECAL MOVE CCWS TO CHAN PGM AREA          23600002
         LRA   WRKRG1,D0(WRKRG1)   GET CHAN PGM REAL ADDRESS            23650002
         ST    WRKRG1,IOSRST       AND STORE IN CCW ADDR OF IOSB        23700002
         OI    IOSOPT,IOSDEP+IOSBYP SET DEVICE END POST AND BY-         23750002
*                                  PASS CHAN PGM PREFIX IND.            23800002
         B     DAVINCR             BRANCH TO RETRY VIA SVC F            23850002
         SPACE 2                                                        23900002
DAVINTV  EQU   *                   INTERVENTION REQ. PROCESSING         23950002
         TM    EWDSNS0,EWDINT      IS INTERVENTION REQUIRED?            24000002
         BO    DAVXCTL             YES, GO PREPARE FOR XCTL             24050002
         TM    EWDSNS0,EWDTCC      IF NO TRACK CONDITION CHECK,         24100002
         BZ    DAVINCR             GO PREPARE FOR RETRY                 24150002
         SPACE 1                                                        24200002
         CLI   UCBTBYT4,WINCHST    IS THIS A WINCHESTER?                24250002
         BZ    DAVAMOVE            NO, GO MOVE ALT TRACK CCHH           24300002
         SPACE 1                                                        24350002
****************************************************************        24360002
*        RECORD ZERO MUST BE READ FOR WINCHESTER DEVICES.      *        24400002
*        OTHERWISE IT IS READ BY THE INTERRUPT HANDLER.        *        24450002
****************************************************************        24460002
         SPACE 1                                                        24500002
         LA    CCWREG,EWDCCW6      GET ADDRESS OF RECORD 0 CCW          24550002
         LA    WRKRG2,EWDRZRO      GET ADDRESS OF READ BUFFER           24600002
         LRA   WRKRG2,D0(WRKRG2)   GET ITS REAL ADDRESS                 24650002
         ST    WRKRG2,D0(WRKRG1)   AND PUT IN CCW                       24700002
         MVI   D0(CCWREG),RDR0OP   SET READ R0 OP CODE IN CCW           24750002
         LA    WRKRG2,D4                                                24800002
         ST    WRKRG2,D4(CCWREG)   SET COUNT TO 4                       24850002
         MVI   D4(CCWREG),SILI     SET SILI IND. IN CCW                 24900002
         LRA   CCWREG,D0(CCWREG)   GET REAL ADDR OF CHAN PGM            24950002
         ST    CCWREG,IOSRST       AND STORE  IN IOSB                   25000002
         OI    IOSFLC,IOSDVALT     SET ALT TRACK PROCESSING IND.        25050002
         B     DAVSVCF             BRANCH TO ISSUE SVC F                25100002
         EJECT                                                          25150002
****************************************************************        25210002
*  THIS CODE INTERFACES WITH IGE0025C VIA THE RESIDENT XCTL    *        25250002
*  ROUTINE TO  ISSUE AN  INTERVENTION  REQUIRED MSG.  SVC F    *        25300002
*  ISSUED BY WTO WILL CAUSE ERREXCP TO ISSUE STARTIO.          *        25302002
****************************************************************        25310002
         SPACE 1                                                        25350002
DAVXCTL  EQU   *                                                        25360002
         NI    IOSFLC,MASKFF-IOSRWAIT  CLEAR WAIT BITS         @ZA00904 25368003
         OI    IOSFLC,IOSRWIR      INDICATE INTV REQ           @ZA00904 25376003
         TM    UCBSTAB,UCBPGFL     ERROR ON PAGE PACK?         @ZA00904 25384003
         BO    DAVWAIT             YES--RESTARTABLE WAIT       @ZA00904 25392003
         L     SIRBRG,EWAEXT       GET EWA EXTENSION           @ZA29090 25393003
         LA    LLSAVE,ERRSA        GET SAVE AREA FOR IOSGEN    @ZA29090 25394003
         L     WRKRG2,IOSUCB       GET BASE UCB ADDRESS        @ZA29090 25395003
         IOSGEN UCBFLG,UCB=(WRKRG2),TABLE=UCBNRY,VAR=ON,               *25396003
               REG=COND            SET UCB NOT READY           @ZA29090 25397003
         MVC   EWDCCW9(D6),UCBVOLI PUT VOLUME SER IN ERP W.A.           25400002
         LA    LLSAVE,WTOID        GET NAME OF IGE0025C                 25450002
         OI    IOSFLA,IOSERR       SET RETRY INDICATOR FOR SVC F@YM6832 25460002
         NI    IOSFLB,MASKFF-IOSMSG SET INT. REQ. MSG IND.              25500002
         L     RTRNRG,D16          GET ADDRESS OF CVT                   25550002
         USING CVT,RTRNRG                                               25600002
         L     RTRNRG,CVTXTLER     GET ADDR OF XCTL ROUTINE             25650002
         DROP  RTRNRG                                                   25700002
         BR    RTRNRG              GO TO XCTL ROUTINE                   25750002
         SPACE 1                                                        25752002
****************************************************************        25754402
*    ESTAE RETRY ROUTINES - ENTRY DAVESVCF - SVC 15, SVC 3     *        25756002
*                                DAVESVC3 - SVC 3 ONLY         *        25758002
****************************************************************        25758102
         SPACE 1                                                        25758802
DAVESVCF BALR  BASERG,0            SET BASE FOR RETRY CODE ONLY         25759202
         USING *,BASERG                                                 25759602
         L     SIRBRG,PSAAOLD      CURRENT ASCB                         25759702
         USING ASCB,SIRBRG                                              25759802
         L     SIRBRG,ASCBASXB     ASCB EXTENSION                       25762802
         USING ASXB,SIRBRG                                              25766702
         L     SIRBRG,ASXBSIRB     THIS ASCB SIRB                       25767702
         USING RBBASIC,SIRBRG                                           25768702
         L     PARMRG,RBSIRBWA     LOAD IOSB ADDRESS FOR SVC 15         25769702
         SVC   ERREXCP             ENTER IOS TO FREE RESOURCES          25772002
DAVESVC3 SVC   EXIT                EXIT SIRB PROCESSING                 25774002
         USING DAVVEP,BASERG                                            25775003
         SPACE 1                                                        25776002
*********************************************************************** 25793003
*   INTERFACE TO RESTARTABLE WAIT ROUTINE IN IECVPST                  * 25794003
*       UCBLOCK OBTAINED TO SET DAVV WAITING INDICATOR AND TO SAVE    * 25795003
*       SRB ADDRESS IN UCBIOQ--USED TO RESTART DAVV AFTER INTERRUPT   * 25796003
*       AND PSW RESTART, FOR INTERVENTION REQUIRED, ONLY              * 25797003
*       UCBNRY IS SET.                                                * 25797303
*********************************************************************** 25798003
         SPACE                                                          25799003
DAVWAIT  LR    WRKRG2,LLSAVE       SAVE R13 ACROSS SETLOCK     @ZA00904 25800003
DAVRW10  SETLOCK OBTAIN,TYPE=IOSUCB,ADDR=UCBLOCK,MODE=UNCOND,          *25801003
               RELATED=(DAVUCB,IECVDAVV(DAVRW20))              @ZA00904 25802003
         TM    IOSFLC,IOSRWIR      INTV. REQ.                  @ZA00904 25802103
         BNO   DAVRW14             NO--DO NOT SET UCBNRY       @ZA00904 25802203
         OI    UCBFLA,UCBNRY       SET DEVICE NOT READY        @ZA00904 25802303
         B     DAVRW20             RELEASE LOCK                @ZA00904 25802403
DAVRW14  MVC   UCBIOQ,IOSSRB       SET SRB ADDRESS IN UCB      @ZA00904 25803003
         OI    UCBFL4,UCBWDAV      SET DAVV WAITING FOR D.E.   @ZA00904 25804003
DAVRW20  SETLOCK RELEASE,TYPE=IOSUCB,ADDR=UCBLOCK,                     *25805003
               RELATED=(DAVUCB,IECVDAVV(DAVRW10))              @ZA00904 25806003
         LR    LLSAVE,WRKRG2       RESTORE R13                 @ZA00904 25807003
DAVWAIT2 SETFRR D,WRKREGS=(WRKRG1,WRKRG2),                             *25808003
               RELATED=(DAVFRR,IECVDAVV(IECVDAV2))             @ZA00904 25809003
         L     ERPWA,IOSERP        GET ERP WORKAREA PTR        @ZA00904 25809303
         L     SIRBRG,EWAEXT       GET EXTENDED WA PTR         @ZA00904 25809603
         L     LLSAVE,4(SIRBRG)    RESTORE CALLERS R13         @ZA00904 25810003
         LM    REG0,LINKRG,0(LLSAVE) RESTORE REGISTERS         @ZA00904 25811003
         B     D12(RTRNRG)         RETURN FOR RESTARTABLE WAIT @ZA00904 25812003
         EJECT                                                          25813003
         TITLE '   IECVDAVV ESTAE ROUTINE   '                           25833302
****************************************************************        25843302
*   DAVV ESTAE ROUTINE - THIS RECOVERY ROUTINE HAS TWO         *        25847302
*   FUNCTIONS -                                                *        25849302
*        1. IN  CASE OF AN  ERROR SITUATION,  TERMINATE THE    *        25849702
*           VOLUME VERIFICATION, RECORD THE ERROR AND ISSUE    *        25849802
*           SVC  DUMP IF POSSIBLE,  AND CAUSE  A RETRY SUCH    *        25849902
*           THAT AN SCV F, SVC 3 SEQUENCE WILL BE EXECUTED.    *        25866602
*           THIS INSURES THAT GLOBAL IOS  RESOURCES USED BY    *        25876602
*           DAVV WILL BE RELEASED AND UCB STATUS INDICATORS    *        25878602
*           WHICH MAY BE ON WILL GET CLEARED. THESE ACTIONS    *        25880602
*           ARE  PERFORMED BY  THE DAVV  ERROR  TERMINATION    *        25882602
*           CODE IN THE POST STATUS IOS COMPONENT(IECVPST).    *        25883002
*           THE ERROR SITUATION IS INDICATED BY IOSERR=OFF,    *        25883102
*           IOSEX=1, AND IOSCOD=X'45'.                         *        25883202
*                                                              *        25888802
*        2. IN CASE A PAGE  FAULT  ERROR  OCCURS IN  EITHER    *        25890802
*           DAVV OR A  FUNCTION  CALLED BY DAVV,   LOGIC IS    *        25892802
*           ENTERED SUCH THAT THE SYSTEM  WILL BE PLACED IN    *        25893202
*           A '022' WAIT STATE IN ORDER TO ALLOW THE  OPER-    *        25893602
*           ATOR TO VISUALLY VERIFY THE VOLUME.  THE SYSTEM    *        25894002
*           WILL RESUME NORMAL  OPERATION ONCE THE OPERATOR    *        25894102
*           PRESSES THE RESTART KEY.                           *        25894202
*                                                              *        25899002
*           TO PLACE THE ENTIRE  SYSTEM IN A DISABLED,  RE-    *        25900702
*           COVERABLE WAIT STATE,  AN INTERFACE TO THE STOP    *        25902402
*           AND RESTART  SUBROUTINE IS  EFFECTED.  THIS RE-    *        25904102
*           QUIRES HOLDING THE RESTART RESOURCE AND A PHYS-    *        25905802
*           ICAL  DISABLED  STATE.  AN FRR  IS SET TO COVER    *        25907502
*           THIS ENVIRONMENT.                                  *        25907902
*                                                              *        25909202
*   NOTE - THE RECOVERABILITY OF THE SIRB IS INSURED BY THE    *        25910902
*          ESTAE SET BY THE ERP LOADER(IECVERPL).  THUS, NO    *        25912602
*          SECONDARY RECOVERY ROUTINE IS SET.                  *        25914302
*                                                              *        25916002
*                                                              *        25917702
*   INPUT - REG 0  - 12 IF NO RTCA                             *        25919402
*           REG 1  - RTCA ADDRESS IF (REG 0) NOT 12            *        25921102
*           REG14 - RTM RETURN ADDRESS                         *        25922802
*                                                              *        25924502
*   DATA    - PSAAOLD -CURRENT ASCB, PSAYMSK,PSACUPLA          *        25926202
*   FIELDS    ASCBASXB -ASCB EXTENSION                         *        25927902
*             ASXBSIRB -SIRB                                   *        25929602
*             RBSIRBWA -SIRB EXTENDED WORK AREA                *        25931302
*             IOSB - IOSFLA,IOSUCB,IOSERP,IOSUSE               *        25933002
*             SDWA - PARM,ERRA,MODN,VRA,URAL,DPVA              *        25934702
*             UCB  - UCBFLA,UCBFL4                             *        25936402
*             CVT  - CVTSDBF,DVTRSTWD,CVTSTPRS                 *        25938102
*                                                              *        25939802
*   OUTPUT  - SVC DUMP TO SYS1.DUMP IF SDUMP BUFFER AVAILABLE. *        25941502
****************************************************************        25943202
         EJECT                                                          25944902
         USING SDWA,UCBREG                                              25946602
         SPACE 2                                                        25948302
DAVVESTA BALR BASERG,0             TEMPORARY BASE                       25950002
         USING *,BASERG                                                 25951702
         LA    WRKRG1,*-DAVVEP                                          25953402
         SR    BASERG,WRKRG1       BACK OFF TO COMMON BASE              25955102
         USING DAVVEP,BASERG                                            25956802
         SPACE 1                                                        25958502
         LR    IRTREG,RTRNRG       SAVE RTM RETURN ADDRESS              25960202
         L     SIRBRG,PSAAOLD      CURRENT ASCB                         25961902
         USING ASCB,SIRBRG                                              25962302
         L     SIRBRG,ASCBASXB     ASCB EXTENSION                       25962702
         USING ASXB,SIRBRG                                              25963102
         L     SIRBRG,ASXBSIRB     THIS ASCB SIRB                       25963602
         USING RBBASIC,SIRBRG                                           25967002
         L     IOSBRG,RBSIRBWA     IOSB ADDRESS                         25967802
         LA    WRKRG1,D12          * CODE OF 12 INDICATES NO            25970402
         CR    REG0,WRKRG1         * RTCA PRESENT                       25972102
         BE    DAVES250            * BRANCH IF NO RTCA                  25973802
         LR    UCBREG,PARMRG       RTCA BASE                            25975502
         SPACE 1                                                        25977202
*   TEST FOR RECURSION - SET IOSB FLAGS FOR PERMANENT ERROR    *        25979202
         SPACE 1                                                        25981202
DAVES100 TM    IOSUSE,DAVRCURS     TEST FOR RETRY RECURSION             25983202
         BO    DAVES300            BRANCH YES                           25987202
         OI    IOSUSE,DAVRCURS     SET RECURSION FLAG                   25989202
         NI    IOSFLA,MASKFF-IOSERR RESET IOSERR - NO I/O RETRY         25989302
         OI    IOSFLA,IOSEX        SET IOSEX - PERMANENT ERROR          25989402
         MVI   IOSCOD,IOSABNC      SET ABNORMAL COMPLETION CODE         25990002
         SPACE 1                                                        25990402
*   TEST FOR MOUNT MESSAGES OUTSTANDING                                 25990802
         SPACE 1                                                        25991202
         TM    IOSFLC,IOSDVMNT     MOUNT MSG INDICATOR ON               25994102
         BZ    DAVES150            BRANCH NO, MSG NOT ISSUED            25996102
         SPACE 1                                                        25998102
*   DELETE DISMOUNT/MOUNT MESSAGE ISSUED BY DAVV                        25998502
         SPACE 1                                                        25998902
         L     PARMRG,IOSERP       WORKAREA ADDRESS                     25999302
         LA    PARMRG,EWDCCW8-EWA(PARMRG) MESSAGE IDS                   25999702
         DOM   MSGLIST=(1)                                              25999802
         NI    IOSFLC,MASKFF-IOSDVMNT RESET MSG INDICATOR               25999902
         SPACE 1                                                        26003302
*   TEST FOR PERMANENT PAGE FAULT ERROR (I/0 ERROR ONLY)                26005302
         SPACE 1                                                        26005702
DAVES150 TM    SDWAERRA,SDWAPGIO   PAGING I/O ERROR OCCUR       @YM6535 26006102
         BZ    DAVES400            BRANCH NO                            26006502
         EJECT                                                          26006602
****************************************************************        26009602
*   PERMANENT PAGING I/O ERROR - DYNAMIC DIRECT ACCESS VOLUME  *        26010302
*   VERIFICATION MUST BE SUSPENDED.  THE OPERATOR IS GIVEN AN  *        26011302
*   OPPORTUNITY FOR VISUAL  VERIFICATION VIA A '022' DISABLED  *        26012302
*   WAIT STATE.  THIS IS ACHIEVED VIA AN  INTERFACE  WITH THE  *        26013302
*   SYSTEM STOP AND RESTART SUBROUTINE.  THE RESTART RESOURCE  *        26014302
*   (CVTRSTWD)  MUST FIRST BE ACQUIRED  VIA COMPARE AND SWAP.  *        26015302
*   IF IN USE, FURTHER VERIFICATION IS BYPASSED. IF AVAILABLE  *        26016302
*   THE SYSTEM  STOP IS RECORDED  PRIOR TO  ENTERING THE  S/R  *        26017302
*   ROUTINE.  AN FRR IS  ESTABLISHED TO  RELEASE THE RESOURCE  *        26018302
*   AND  RE-ENABLE  THE SYSTEM IN CASE OF AN ERROR SITUATION.  *        26019302
****************************************************************        26019702
         SPACE 1                                                        26020302
         L     CCWREG,CVTPTR       CVT ADDRESS                          26022202
         USING CVT,CCWREG                                               26023402
         STNSM PSASYMSK,DISABLE    SYSTEM MUST BE DISABLED BEFORE       26025402
*                                  INTERFACING WITH STOP/RESTART        26025502
         SPACE 1                                                        26026302
*   SET AN FRR TO COVER DISABLEMENT AND THE RESTART RESOURCE   *        26028302
         SPACE 1                                                        26028702
         SETFRR A,FRRAD=DAVESFRA,PARMAD=(WRKRG1),                      *26030002
               WRKREGS=(WRKRG1,WRKRG2)                                  26030802
         EJECT                                                          26031202
         STM   BASERG,UCBREG,D0(WRKRG1) SAVE BASE,SDWA SWITCH,          26031602
         STM   CCWREG,IRTREG,D12(WRKRG1) * CVT,SIRB,AND RTNADDR         26032402
         SPACE 1                                                        26033302
*   ACQUIRE RESTART RESOURCE                                            26034302
         SPACE 1                                                        26035302
         LH    REG0,PSACPULA       LOGICAL CPUID                        26036302
         SLL   REG0,D16            SHIFT TO HIORDER BYTES               26037302
         L     WRKRG2,DAVSRSCD     DAVV STOP/RESTART CODE               26038302
         OR    REG0,WRKRG2         PLACE IN LOW ORDER BYTES             26039302
         SR    PARMRG,PARMRG       COMPARE AND SWAP FOR ZEROS           26040302
         CS    PARMRG,REG0,CVTRSTWD *                                   26041302
         BNE   DAVES170            BRANCH IF RESOURCE ALREADY           26042302
*                                  * HELD - FORGET VERIFICATION         26043302
         MVI   D0(WRKRG1),MASKFF   INDICATE RESOURCE HELD FOR FRR       26044302
         L     ERPWA,IOSERP        WORKAREA ADDRESSABILITY              26045302
         STCK  DAVTIME             TIME STAMP RECORD                    26046302
         SPACE 1                                                        26047302
*   INVOKE THE ASYNCHRONOUS RECORDING FACILITY                          26048302
         SPACE 1                                                        26049302
         LA    LLSAVE,EWAFLG1      PROVIDE A SAVE AREA FOR RECORD       26050302
         RECORD TYPE=LOGREC,RCVRY=SETFRR,HEADER=YES,LENGTH=16,         *26051302
               PARMADR=DAVLOGBF                                         26052302
*   IGNORE RETURN CODES FROM RECORD FACILITY                            26053302
         L     REG0,DAVWAITC       WAIT STATE CODE = 022                26054303
         SR    PARMRG,PARMRG       CLEAR QUIESCE INDICATOR              26055302
         L     LINKRG,CVTSTPRS     SUBROUTINE ENTRY POINT               26056302
         BALR  RTRNRG,LINKRG       ENTER S/R SUBROUTINE                 26057302
         SPACE 1                                                        26058302
*   IGNORE RETURN CODES FROM STOP AND RESTART SUBROUTINE                26059302
         SPACE 1                                                        26060302
DAVES165 SR    PARMRG,PARMRG       ZERO A REGISTER                      26061302
         ST    PARMRG,CVTRSTWD     FREE THE RESTART RESOURCE            26062302
         DROP  CCWREG                                                   26063302
DAVES170 SETFRR D,WRKREGS=(WRKRG1,WRKRG2)                               26073302
         IC    WRKRG1,PSASYMSK     RESTORE OLD PSW MASK                 26073702
         EX    WRKRG1,DAVESENA     ISSUE STOSM                          26074102
         LA    REG0,DAVESVCF       ADDRESS OF RETRY ROUTINE             26074202
         LTR   UCBREG,UCBREG       DOES RTCA EXIST                      26074302
         BZ    DAVES200            BRANCH NO, USE STAE RETRY INTFC      26074902
DAVES180 SETRP RETADDR=(0),RC=4,FRESDWA=YES,WKAREA=(UCBREG)             26075302
         USING SDWA,UCBREG                                              26075702
         SPACE 1                                                        26076102
****************************************************************        26076502
*   RETURN TO RTM - REG 0 IS PRIMED WITH RETRY ADDRESS AND     *        26076902
*   IS SET TO 4 TO INSURE A  RETRY IN CASE AN RTCA WAS NOT     *        26078902
*   PROVIDED AND THE OLD STAE RETRY INTERFACE IS USED.         *        26079002
****************************************************************        26080202
         SPACE 1                                                        26090002
DAVES200 LA    LINKRG,D4           RC=4 IN CASE STAE RETRY INTFC        26091202
         LR    RTRNRG,IRTREG       RESTORE RETURN ADDRESS               26092402
         BR    RTRNRG              RETURN TO RTM                        26093602
         SPACE 1                                                        26094802
*   RTCA DOES NOT EXIST                                                 26096002
         SPACE 1                                                        26097202
DAVES250 SR    UCBREG,UCBREG       CLEAR RTCA BASE                      26098402
         OI    IOSUSE,DAVRCTA      INDICATE NO RCTA                     26099602
         B     DAVES100            CONTINUE RECOVERY LOGIC              26100802
         SPACE 1                                                        26102002
*   RETRY RECURSION DETECTED, RETRY TO SVC 3 ONLY                       26103202
         SPACE 1                                                        26104402
DAVES300 LA    REG0,DAVESVC3       RETRY ADDRESS IS TO SVC 3            26105602
         L     WRKRG1,IOSUCB       UCB ADDRESS                          26106802
*   LAST GASP EFFORT TO SAVE UCB - LOCK NOT ACQUIRED           *        26108002
         NI    UCBFLA-UCBOB(WRKRG1),MASKFF-UCBQISCE                     26109202
         NI    UCBFL4-UCBOB(WRKRG1),MASKFF-UCBDAVV                      26110402
         LTR   UCBREG,UCBREG       DOES RTCA EXIST                      26111602
         BZ    DAVES200            BRANCH NO - USE STAE RETRY           26112802
         B     DAVES180            YES, USE SETRP,NO RECORDING          26114002
         EJECT                                                          26115202
****************************************************************        26115602
*   INITIATE SYSTEM DUMP  - THE DUMP MUST BE ASYNCHRONOUS IN   *        26116402
*   THAT THE SIRB FOR THE MEMORY (MASTER SCHEDULER) IS  TIED   *        26117602
*   UP BY DAVV.  DUMP BUFFER WILL CONTAIN THE SRB, IOSB, EWA   *        26118802
*   AND UCB.                                                   *        26119202
****************************************************************        26119602
         SPACE 2                                                        26120002
DAVES400 L     WRKRG1,CVTPTR       CVT ADDRESS                          26121202
         USING CVT,WRKRG1                                               26122402
         L     WRKRG2,CVTSDBF      DUMP BUFFER ADDRESS                  26123602
         LA    WRKRG2,D0(WRKRG2)   CLEAR HI BYTE                        26124802
         L     CCWREG,DAVESCON     LOAD CONSTANT WITH LOCK BIT          26126002
         OR    CCWREG,WRKRG2       'OR' IN ADDRESS OF BUFFER            26127202
         SPACE 1                                                        26128402
*   COMPARE AND SWAP TO GAIN SOLE POSESSION OF BUFFER FOR DUMP          26129602
         SPACE 1                                                        26130802
         CS    WRKRG2,CCWREG,CVTSDBF ACQUIRE OWNERSHIP OF SDUMP         26132002
         BNE   DAVES450            * 4K BUFFER - BRANCH IF IN USE       26133202
         DROP  WRKRG1                                                   26134402
         USING SDBUF,WRKRG2                                             26135602
         LA    PARMRG,SDBDATA      DATA AREA BETINNING                  26136802
         ST    PARMRG,SDBDATAD     STORE IN 1ST WORD OF BUFFER          26138002
         L     CCWREG,IOSSRB       SRB ADDRESS(CONTIGOUS WITH           26139202
*                                  IOSB AS PER SIAB MAP MACRO)          26140402
         MVC   SDBSIB,D0(CCWREG)   MOVE SRB/IOSB TO BUFFER              26141602
         L     CCWREG,IOSERP       DAVV WORKAREA ADDRESS                26142802
         MVC   SDBEWA,D0(CCWREG)   MOVE WORKAREA TO BUFFER              26144002
         L     CCWREG,IOSUCB       UCB ADDRESS                          26145202
         LA    WRKRG1,UCBCURPX     BACK OFF TO REAL PREFIX              26146402
         SR    CCWREG,WRKRG1       *                                    26147602
         MVC   SDBUCB,D0(CCWREG)   MOVE UCB TO BUFFER - PREFIX,         26148802
*                                  BASE, DA SEGMENT                     26150002
         LA    PARMRG,SDBDL                                             26151202
         STH   PARMRG,SDBDLN       STORE TOTAL DATA LENGTH              26152402
         XC    SDBLAST,SDBLAST     INDICATE END OF DATA                 26153602
         SPACE 1                                                        26154802
*   ISSUE SVC DUMP - ASID FIELD OF PARAMETER LIST SERIALIZED BY *       26156002
*   SDUMP BUFFER LOCK (ASID CURRENTLY CONSTANT ANYWAY).         *       26157202
         SPACE 1                                                        26158402
         L     ERPWA,IOSERP        WORKAREA ADDRESSABILTY               26159602
         LA    LLSAVE,EWAFLG1      PROVIDE A SAVEAREA FOR SDUMP         26160802
         SDUMP HDR='DAVV ERROR',ASID=IOSASID,SDATA=(PSA,TRT),          *26162002
               LIST=DAVVRNGE,BUFFER=YES,BRANCH=YES                      26163202
         STC   LINKRG,IOSUSE+D1    SAVE SDUMP RETURN CODE               26164402
         SPACE 2                                                        26165602
DAVES450 LA    REG0,DAVESVCF       RETRY TO SVCF,SVC3 LOGIC             26166802
         LTR   UCBREG,UCBREG       RTCA EXIST                           26168002
         BZ    DAVES200            BRANCH NO,NO RECORDING               26169202
         MVC   SDWAMODN,DAVVNAME   SET MODULE NAME IN RTCA              26170402
         MVC   SDWAVRA(IOSEND-IOSB),IOSB MOVE IOSB TO RTCA              26171602
         MVI   SDWAURAL,IOSEND-IOSB LENGTH OF DATA                      26172802
         OI    SDWADPVA,SDWAHEX    PRINT IN HEX                         26174002
         SETRP RETADDR=(0),RECORD=YES,WKAREA=(UCBREG),RC=4,FRESDWA=YES  26175202
         B     DAVES200            GO EXIT                              26176402
         EJECT                                                          26177602
*****************************************************************       26178002
*   FRR ROUTINE TO PROTECT RESTART RESOURCE AND DISABLEMENT     *       26178802
*****************************************************************       26179202
         SPACE 2                                                        26181202
         USING SDWA,PARMRG                                              26182402
         DROP  UCBREG                                                   26183002
DAVESFRR L     WRKRG1,SDWAPARM     LOAD FRR WORKAREA ADDRESS            26183602
         LM    BASERG,UCBREG,D0(WRKRG1) LOAD BASE,SDWA SWITCH,          26184802
         LM    CCWREG,IRTREG,D12(WRKRG1) *CVT,SIRB,RTM RETURN           26186002
*                                        * FOR ESTAE RETRY              26187202
         STM   BASERG,UCBREG,SDWASR05 UPDATE REGS IN FRR SDWA           26188402
         STM   CCWREG,IRTREG,SDWASR10 *                                 26189602
         CLI   D0(WRKRG1),MASKFF   WAS THE RESTART RESOURCE             26190802
         LA    REG0,DAVES170       * HELD                      @YM06124 26192002
         BNE   DAVFR100            * BRANCH NO                          26193202
         LA    REG0,DAVES165                                   @YM06124 26194402
DAVFR100 SETRP RETADDR=(REG0),RETREGS=YES,RC=4                          26195602
         BR    RTRNRG              RETURN TO RTM                        26196802
         EJECT                                                          26196903
*********************************************************************** 26197003
*  DAVV FRR ROUTINE FOR BRANCH ENTRY UNDER AN SRB.  THIS ROUTINE IS   * 26197103
*  SIMILAR TO 'DAVVESTA' EXCEPT THAT AN RTCA (SDWA) IS ALWAYS PRESENT * 26197203
*  ON ENTRY, NO MESSAGES WILL HAVE BEEN ISSUED AND NEED DOM, AND      * 26197303
*  AN I/O ERROR ON THE PAGE PACK IS NOT APPLICABLE.                   * 26197403
*********************************************************************** 26197503
         SPACE                                                          26197603
DAVFRR   LR    UCBREG,PARMRG       COPY SDWA PTR FROM PARM REG @ZA00904 26197703
         USING SDWA,UCBREG                                     @ZA00904 26197803
         L     FRRREG,SDWAPARM     POINT TO FRR PARMS          @ZA00904 26197903
         L     BASERG,FRRBASE      RESTORE BASE                @ZA00904 26198003
         L     IOSBRG,FRRIOSB        AND IOSB POINTER          @ZA00904 26198103
         ST    BASERG,SDWASRSV+4*BASERG  SAVE CRITICAL         @ZA00904 26198203
         ST    IOSBRG,SDWASRSV+4*IOSBRG    REGS FOR RETRY      @ZA00904 26198303
         LR    IRTREG,RTRNRG       SAVE RETURN ADDRESS         @ZA00904 26198403
         L     ERPWA,IOSERP        POINT TO ERP WORK AREA      @ZA00904 26198503
         L     SIRBRG,EWAEXT         THEN TO EXTENDED WA       @ZA00904 26198603
         LA    LLSAVE,D16(SIRBRG)    AND USE THIS AS SAVE AREA @ZA00904 26198703
         ST    SIRBRG,SDWASRSV+4*SIRBRG  SAVE FOR RETRY        @ZA00904 26198803
         TM    IOSUSE,DAVRCURS       TEST FOR RETRY RECURSION  @ZA00904 26198903
         BO    DAVFRRR               YES--DO NOT DUMP          @ZA00904 26199003
         OI    IOSUSE,DAVRCURS       SET RECURSION FLAG        @ZA00904 26199103
         OI    IOSFLA,IOSERR         SET TO RETRY I/O          @ZA00904 26200203
*  ATTEMPT TO TAKE AN SVCDUMP                                  @ZA00904 26200303
         L     WRKRG1,CVTPTR         CVT ADDRESS               @ZA00904 26200403
         USING CVT,WRKRG1                                      @ZA00904 26200503
         L     WRKRG2,CVTSDBF      DUMP BUFFER ADDRESS         @ZA00904 26200603
         LA    WRKRG2,D0(WRKRG2)   CLEAR HI BYTE               @ZA00904 26200703
         L     CCWREG,DAVESCON     LOAD CONSTANT WITH LOCK BIT @ZA00904 26200803
         OR    CCWREG,WRKRG2       'OR' IN ADDRESS OF BUFFER   @ZA00904 26200903
         SPACE 1                                                        26201003
*   COMPARE AND SWAP TO GAIN SOLE POSESSION OF BUFFER FOR DUMP @ZA00904 26201103
         SPACE 1                                                        26201203
         CS    WRKRG2,CCWREG,CVTSDBF ACQUIRE OWNERSHIP OF SDUMP@ZA00904 26201303
         BNE   DAVFRR10            BUFFER IN USE--SKIP DUMP    @ZA00904 26201403
         DROP  WRKRG1                                          @ZA00904 26201503
         USING SDBUF,WRKRG2                                    @ZA00904 26201603
         LA    PARMRG,SDBDATA      DATA AREA BEGINNING         @ZA00904 26201703
         ST    PARMRG,SDBDATAD     STORE IN 1ST WORD OF BUFFER @ZA00904 26202303
         L     CCWREG,IOSSRB       SRB ADDRESS(CONTIGOUS WITH  @ZA00904 26202403
*                                  IOSB AS PER SIAB MAP MACRO) @ZA00904 26202503
         MVC   SDBSIB,D0(CCWREG)   MOVE SRB/IOSB TO BUFFER     @ZA00904 26202603
         L     CCWREG,IOSERP       DAVV WORKAREA ADDRESS       @ZA00904 26202703
         MVC   SDBEWA,D0(CCWREG)   MOVE WORKAREA TO BUFFER     @ZA00904 26202803
         L     CCWREG,IOSUCB       UCB ADDRESS                 @ZA00904 26202903
         LA    WRKRG1,UCBCURPX     BACK OFF TO REAL PREFIX     @ZA00904 26203003
         SR    CCWREG,WRKRG1       *                           @ZA00904 26203103
         MVC   SDBUCB,D0(CCWREG)   MOVE UCB TO BUFFER - PREFIX,@ZA00904 26203203
*                                  BASE, DA SEGMENT            @ZA00904 26203303
         LA    PARMRG,SDBDL                                    @ZA00904 26203403
         STH   PARMRG,SDBDLN       STORE TOTAL DATA LENGTH     @ZA00904 26203503
         XC    SDBLAST,SDBLAST     INDICATE END OF DATA        @ZA00904 26203603
         SPACE 1                                               @ZA00904 26203703
*   ISSUE SVC DUMP - ASID FIELD OF PARAMETER LIST SERIALIZED * @ZA00904 26203803
*   BY SDUMP BUFFER LOCK (ASID CURRENTLY CONSTANT ANYWAY).   * @ZA00904 26203903
         SPACE 1                                                        26204003
         L     ERPWA,IOSERP        WORKAREA ADDRESSABILTY      @ZA00904 26204103
         SDUMP HDR='DAVV ERROR',ASID=IOSASID,SDATA=(PSA,TRT),          *26204203
               LIST=DAVVRNGE,BUFFER=YES,BRANCH=YES             @ZA00904 26204303
         STC   LINKRG,IOSUSE+D1    SAVE SDUMP RETURN CODE      @ZA00904 26204403
DAVFRR10 MVC   SDWAMODN,DAVVNAME   SET MODULE NAME IN SDWA     @ZA00904 26204503
         MVC   SDWAVRA(IOSEND-IOSB),IOSB MOVE IOSB TO SDWA     @ZA00904 26204603
         MVI   SDWAURAL,IOSEND-IOSB LENGTH OF DATA             @ZA00904 26204703
         OI    SDWADPVA,SDWAHEX    PRINT IN HEX                @ZA00904 26204803
         SETRP RETADDR=DAVFRRTY,RECORD=YES,WKAREA=(UCBREG),RC=4,       *26204903
               FRESDWA=YES,RETREGS=YES                         @ZA00904 26205003
         LR    RTRNRG,IRTREG       RESTORE RETURN ADDRESS      @ZA00904 26205203
         BR    RTRNRG              RETURN TO RTM               @ZA00904 26205303
         SPACE 2                                                        26205403
*  RECURSION EXIT ROUTINE                                               26205503
DAVFRRR  SETRP RETADDR=DAVRRY,WKAREA=(UCBREG),RC=4,FRESDWA=YES,        *26205603
               RETREGS=YES                                     @ZA00904 26205703
         LR    RTRNRG,IRTREG       RESTORE RETURN ADDRESS      @ZA00904 26205803
         BR    RTRNRG              RETURN TO RTM               @ZA00904 26205903
         EJECT                                                          26206003
*********************************************************************** 26206103
*  RETRY ROUTINE AFTER RECURSION TO FRR FOR ENTRY IN SRB MODE.        * 26206203
*        RETURN TO IECVPST IS ON +8 VECTOR SO THAT THE IOSB WILL NOT  * 26206303
*        BE FREED AND HENCE ALLOW THE PAGE PACK TO BE USED WHEN THE   * 26206503
*        WRONG PACK MAY BE MOUNTED.                                   * 26206603
*********************************************************************** 26206703
         SPACE                                                          26206803
DAVRRY   SETFRR D,WRKREGS=(WRKRG1,WRKRG2),                             *26206903
               RELATED=(DAVFRR,IECVDAVV(IECDAV2))              @ZA00904 26207003
         L     ERPWA,IOSERP        GET ERP WORKAREA PTR        @ZA00904 26207103
         L     SIRBRG,EWAEXT       GET EXTENDED WA PTR         @ZA00904 26207203
         L     LLSAVE,4(SIRBRG)    RESTORE SAVE AREA POINTER   @ZA00904 26207303
         LM    REG0,LINKRG,0(LLSAVE) RESTORE REGISTERS         @ZA00904 26207503
         B     D8(RTRNRG)          RETURN WITHOUT FREEING      @ZA00904 26207603
*                                  THE IOSB AND WORKAREAS      @ZA00904 26207703
         TITLE '   IECVDAVV - CONSTANTS          '                      26207803
****************************************************************        26207903
*   I/O ERROR MESSAGE - WTO LIST FORM USED TO FORMAT MSG       *        26208003
****************************************************************        26208103
         SPACE 1                                                        26208303
ERRMSG   WTO   'IEA606I DEV,BAD VOLUME LABEL,**, CSW,SENSBBBBBB,VOLSER'*26208403
               ,ROUTCDE=(1,4),DESC=4,MF=L                               26208503
         SPACE 2                                                        26208603
****************************************************************        26208703
*   DISMOUNT/MOUNT MESSAGE - WTO LIST FORM USED TO FORMAT MSG           26208802
****************************************************************        26210002
         SPACE 1                                                        26250002
DISMSG   WTO   'IEA604A D DEV,VOLSER',ROUTCDE=(1),DESC=2,MF=L  @ZA09511 26300003
         SPACE 2                                                        26350002
RECAL    CCW   19,1,CMCHNSLI,1     RECALIBRATE CCW                      26400002
         CCW   03,1,0,1            NOOP CCW                             26450002
         SPACE 1                                                        26500002
CDUATN   DC    X'000072BF'         CHE,DVE,UEX,ATTN,WLR MASK            26550002
TRANTAB  DC    C'0123456789ABCDEF' TRANSLATE TABLE                      26600002
         EJECT                                                          26602002
*   CONSTANTS FOR ESTAE RECOVERABILITY ROUTINE                          26610002
         SPACE 1                                                        26620002
DAVVNAME DC    CL8'IECVDAVV'       MODULE AND CSECT NAME                26630002
DAVESFRA DC    A(DAVESFRR)         FRR ROUTINE ADDRESS                  26632002
DAVFRRA  DC    A(DAVFRR)           SRB FRR ROUTINE ADDR        @ZA00904 26633003
*****                                                                   26634002
* THE FOLLOWING THREE CONSTANTS MUST BE KEPT CONTIGUOUS                 26636002
*****                                                                   26638002
DAVVRNGE DC    A(IECVDAVV)         DAVV CODE RANGE                      26640002
         DC    X'80'               LAST ENTRY INDICATOR                 26642002
         DC    AL3(DAVVEND)        DAVV CODE END                        26644002
*****                                                                   26644402
DAVESCON DC    X'80000000'         CONSTANT FOR BUFFER LOCKING          26646002
DAVSRSCD DC    X'0000C4E2'         DAVV STOP/RESTART CODE = DS          26648002
DAVLOGBF DC    X'82400000'         * LOGREC RECORD FOR ENTERING         26648402
         DC    A(DAVLOGDA)         * THE SYSTEM STOP AND RESTART        26648802
DAVLOGDA DC    F'8'                * ROUTINE. RECORD COMPLETE           26649202
DAVWAITC DC    X'00000022'         * EXCEPT FOR TIME STAMP.             26649603
DAVTIME  DC    XL8'00'             * SERIALIZED VIA STOP AND            26679803
*                                  * RESTART RESOURCE.                  26689803
         SPACE 1                                                        26699802
DAVESENA STOSM PSASYMSK,D0         EXECUTED STOSM TO RE-ENABLE          26749802
DAVVEND  EQU   *                   END OF DAVV CODE                     26759802
         END                                                            26799802
