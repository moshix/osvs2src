         TITLE 'IECVGENA - IOSGEN SUBROUTINE (UCBFLG,SWAP,VARY)'        00050003
*****************************************************************       00100003
*                                                               *       00150003
*                                                               *       00200003
* MODULE NAME = IECVGENA                                        *       00250003
*                                                               *       00300003
* DESCRIPTIVE NAME = IOSGEN RESIDENT SUBROUTINE                 *       00350003
*                                                               *       00400003
* COPYRIGHT = NONE                                              *       00450003
*                                                               *       00500003
* STATUS = OS/VS2 RELEASE 2, CHANGE LEVEL 00                    *       00550003
*                                                               *       00600003
* FUNCTION =                                                    *       00650003
*    IOSGEN SUBROUTINE PERFORMS ALL FUNCTIONS WHICH REQUIRE     *       00700003
*    A LOCK FOR:                                                *       00750003
*         UCBFLG - (UCB LOCK)                                   *       00800003
*         SWAP  - (UCB AND LCH LOCKS)                          @ZA12145 00850003
*         VARY  - (UCB LOCK)                                    *       00900003
*    IN ADDITION IT PERFORMS AN OUT-OF-LINE FUNCTION TO        @ZA16163 00910003
*    SIMULATE INTERRUPTS (IOSINTRP)                            @ZA16163 00920003
*                                                               *       00950003
* NOTES =                                                       *       01000003
*    DEPENDENCIES = EBCDIC                                      *       01050003
*    RESTRICTIONS = NONE                                        *       01100003
*    REGISTER CONVENTIONS = SEE REGISTER DEFINITIONS            *       01150003
*    PATCH LABEL = PATCHID                                      *       01200003
*                                                               *       01250003
* MODULE TYPE = SUBROUTINE                                      *       01300003
*    PROCESSOR = ASSEMBLER                                      *       01350003
*    MODULE SIZE = B00 HEX BYTES                                *       01400003
*    ATTRIBUTES = RESIDENT, REENTRANT, KEY 0, SUPERVISOR STATE  *       01450003
*                                                               *       01500003
* ENTRY POINT = IECVGENA                                        *       01550003
*    PURPOSE = ALL FUNCTIONS                                    *       01600003
*    LINKAGE = BRANCH REGISTER 15                               *       01650003
*                                                               *       01700003
*    INPUT =                                                    *       01750003
*    INPUT VARIES BY FUNCTION AS FOLLOWS:                       *       01800003
*         ALL FUNCTIONS - REG 13 CONTAINS ADDRESS OF SAVE AREA. *       01850003
*                         REG 14 CONTAINS RETURN ADDRESS.       *       01900003
*                         REG 15 CONTAINS ENTRY POINT ADDRESS.  *       01950003
*         UCBFLG - REG 5 CONTAINS THE APPROPRIATE DISPLACEMENT  *       02000003
*                  OFF OF LABEL 'BRUCBFLG'.                     *       02050003
*                  REG 4 CONTAINS ADDRESS OF UCB PREFIX.        *       02100003
*         SWAP - REG 4 CONTAINS ADDRESS OF 'TO' UCB PREFIX.     *       02150003
*                REG 5 CONTAINS ADDRESS OF IOCOM.               *       02200003
*                REG 6 CONTAINS ADDRESS OF 'FROM' UCB PREFIX.   *       02250003
*                REG 8 CONTAINS ADDRESS OF 36 WORD WORK AREA.  @ZA12145 02300003
*                REG 12 CONTAINS ADDRESS OF CVT.                *       02350003
*         VARY - REG 4 CONTAINS ADDRESS OF UCB PREFIX.          *       02400003
*                REG 5 CONTAINS ADDR OF 8 BYTE PARAMETER:       *       02450003
*                BYTE                                           *       02500003
*                1-2   HEXIDECIMAL DEVICE ADDRESS.              *       02550003
*                3     FUNCTION CODE                            *       02600003
*                      00 - VARY OFFLINE CONDITIONALLY          *       02650003
*                      04 - VARY ONLINE                         *       02700003
*                      80 - VARY OFFLINE UNCONDITIONALLY        *       02750003
*                4     PHYSICAL CPU ID                          *       02800003
*                5     UNUSED                                   *       02850003
*                6-8   EBCDIC DEVICE ADDRESS                    *       02900003
*                REG 6 CONTAINS THE ADDRESS OF THE CVT          *       02950003
*     IOSINTRP - REG1                                          @ZA16163 02960003
*                      IF POSITIVE, UCB ADDRESS                @ZA16163 02970003
*                      IF NEGATIVE, DEVICE ADDRESS             @ZA16163 02980003
*                                                               *       03000003
*    OUTPUT =                                                   *       03050003
*    OUTPUT VARIES BY FUNCTION AS FOLLOWS:                      *       03100003
*         UCBFLG - NONE                                         *       03150003
*         SWAP - RETURN CODE IN FIRST WORD OF WORKAREA         @ZA12145 03200003
*                00 - SUCCESSFUL SWAP                          @ZA12145 03250003
*                04 - SWAP FAILED                              @ZA12145 03300003
*         VARY - RETURN CODE IN REG 15                          *       03350003
*                00 - SUCCESSFUL VARY                           *       03400003
*                04 - VARY OFFLINE UNCONDITIONAL                *       03450003
*                     LAST PATH VARIED OFFLINE                  *       03500003
*                08 - VARY OFFLINE CONDITIONAL                  *       03550003
*                     LAST PATH CANNOT BE VARIED OFFLINE        *       03600003
*                12 - INVALID PATH SPECIFIED                    *       03650003
*                20 - DEVICE PATH IS RESERVED                   *       03700003
*          IOSINTRP - NONE                                     @ZA16163 03720003
*                                                               *       03750003
*    EXITS-NORMAL =                                             *       03800003
*       RETURN TO CALLER VIA REG 14.                            *       03850003
*                                                               *       03900003
*    EXITS-ERROR =                                              *       03950003
*       FUNCTIONAL RECOVERY ROUTINE.                            *       04000003
*                                                               *       04050003
* EXTERNAL REFERENCES =                                         *       04100003
*    ROUTINES =                                                 *       04150003
*         IECVSMGR  (BRANCH ENTRY)                              *       04200003
*         SETLOCK                                               *       04250003
*         SETFRR                                                *       04300003
*    DATA AREAS =                                               *       04350003
*         VARYPARM (INTERNAL)                                   *       04400003
*         SWAPWORK (INTERNAL)                                   *       04450003
*         GENAFRRS (INTERNAL)                                   *       04500003
*    CONTROL BLOCKS =                                           *       04550003
*         IEFUCBOB PREFIX=YES                                   *       04600003
*         IHAPSA                                                *       04650003
*         CVT                                                   *       04700003
*         IECDIOCM                                              *       04750003
*         IHALCCA                                               *       04800003
*         IECDIRT                                               *       04850003
*         IHAWSAVT                                              *       04900003
*         IECDLCH                                               *       04950003
*         IECDIOQ                                               *       05000003
*         IECDIOSB                                              *       05050003
*         IHAFFRS                                               *       05100003
*         IHASDWA                                               *       05150003
*                                                               *       05200003
* TABLES =                                                      *       05250003
*    UCBFLG - NONE                                              *       05300003
*    VARY - 8 BYTE PARAMETER                                    *       05350003
*    SWAP - 144 BYTE WORK AREA                                 @ZA12145 05400003
*                                                               *       05450003
* MACROS =                                                      *       05500003
*    SETLOCK                                                    *       05550003
*    SETFRR                                                    @ZA12145 05558003
*    RISGNL                                                    @ZA12145 05566003
*                                                               *       05600003
* CHANGE ACTIVITY = NONE                                        *       05650003
*                                                               *       05700003
*****************************************************************       05750003
*/*FIX12145: CHART                                                   */ 05800003
*/*IOSGEN:  E IOSGEN                                                 */ 05850003
*/*         P SAVE REGISTERS AND ESTABLISH ADDRESSABILITY            */ 05900003
*/*         P GET 'TO' UCB PTR                                       */ 05950003
*/*         P GET 'FROM' UCB PTR                                     */ 06000003
*/*         P GET WORKAREA PTR                                       */ 06050003
*/*         P GET ADRESS OF IECVGENA                                 */ 06250003
*/*         S IECVGENA: CALL GENA TO DO SWAP                         */ 06300003
*/*         P RESTORE REGISTERS                                      */ 06350003
*/*         R EXIT                                                   */ 06400003
*/*GENA:    E IECVGENA                                               */ 06450003
*/*         P ESTABLISH ADDRESSABILITY                               */ 06500003
*/*         P TURN ON NOT READY BIT IN 'TO' UCB (USING C&S LOGIC)    */ 06510003
*/*         D (NO,,YES,NOSWAP) 'TO' ADDR = 'FROM' ADDR ?             */ 06516003
*/*         P TURN ON NOT READY BIT IN 'FROM' UCB (USING CS LOGIC)   */ 06530003
*/*         P SAVE R13 (SAVEAREA PTR) AND R14 (RETURN PTR)           */ 06540003
*/*         S ADDFRR: SET FRR                                        */ 06550003
*/*         P SET SWAP ACTIVE FLAG FOR FRR                           */ 06557003
*/*          P SAVE FRR AREA ADD AND SWAP WKAREA ADDR                */ 06600003
*/*TSTPSNS:  D (NO,,YES,TSTPSNS)    SENSE PENDING ON 'FROM' DEV ?    */ 06630003
*/*          D (NO,,YES,TSTPSNS)    SENSE PENDING ON 'TO' DEV ?      */ 06660003
*/*          P GET LOCKWORD ADDRESS                                  */ 06690003
*/*          L SETLOCK: OBTAIN IOSUCB 'FROM'                         */ 06750003
*/*          P TURN ON UCB LOCK HELD INDICATOR & SAVE LOCKWORD       */ 06800003
*/*          D (NO,,YES,%UNLOCK2)  'FROM' UCB ACTIVE BITS ON ?       */ 06850003
*/*          D (NO,,YES,%UNLOCK2)  'TO' UCB ACTIVE BITS ON ?         */ 06880003
*/*STOPCPU:  P GET CPU ADDR & ADDR OF PCCA                           */ 06950003
*/*          P SET REGS FOR RTN-ENTRY PT, PARM PTR, SAVE AREA PTR    */ 06960003
*/*          L RISGNL:  SERIAL DISABLE OTHER CPU                     */ 07000003
*/*          P SAVE RET CODE, REESTABLISH BASE                       */ 07010003
*/*          D (NO,,YES,%SENTRY) SIGP FAIL ?                         */ 07050003
*/*%SIGPRET: S RELUCBLK: RELEASE IOSUCB 'FROM'                       */ 07100003
*/*          D (NO,,YES,TSTPSNS) SWAP UCBS ACTV ?                    */ 07110003
*/*          D (NO,,YES,BADRET)  DID SWAP FAIL ?                     */ 07200003
*/*          P SET PARM REG FOR SWAP LCH                             */ 07204003
*/*          S SWAPLCH:  GO SWAP LCHS                                */ 07208003
*/*GOODRET:  P SET GOOD RETURN CODE FOR DDR                          */ 07212003
*/*CLEANUP:  P SAVE RET ADDR AND SAVE AREA ADDR                      */ 07216003
*/*          S DELFRR:  GO DELETE FRR                                */ 07220003
*/*          P RESTORE SAVE AREA ADDR                                */ 07224003
*/*          R RETURN                                                */ 07228003
*/*BADRET:   P (,CLEANUP) SET BAD RETURN CODE                        */ 07232003
*/*NOSWAP:   P SET GOOD RETURN CODE FOR DDR                          */ 07233003
*/*          R RETURN                                                */ 07234003
*/*SWAPLCH:  E SWAPLCH                                               */ 07236003
*/*         D (NO,,YES,LCHSAME)  LCH INDICES THE SAME ?              */ 07300003
*/*         P SAVE REGISTERS                                         */ 07305003
*/*         P GET IOCOM ADDR                                         */ 07310003
*/*         P COPY 'FROM ' UCB ADDR                                  */ 07320003
*/*         S LOCKLCH:  GO GET 'FROM' LCH LOCK                       */ 07350003
*/*         P TURN ON LCH LOCK HELD INDICATOR                        */ 07380003
*/*         P TURN ON LCH SWAP STARTED FLAG                          */ 07450003
*/*         P GET LCH ADDR                                           */ 07510003
*/*%ADJUST: P ADJUST UCB PTR TO COMMON SECTION                       */ 07520003
*/*%NXTIOQE: P GET IOQE PTR FROM LCH                                 */ 07550003
*/*          D (YES,,NO,DQEXIT)   IS THERE AN IOQE ?                 */ 07580003
*/*          P GET IOSB ADDR                                         */ 07650003
*/*          D (YES,,NO,%NXTIOQE) IOSB RELATED TO 'FROM' DEV ?       */ 07700003
*/*          P SAVE IOQ ADDR                                         */ 07750003
*/*          P GET AND SAVE DEQ RETURN PTR                           */ 07800003
*/*          S (,%ADJUST) CALLIOS: CALL RTN TO GO TO IOS DEQ RTN     */ 07850003
*/*DQEXIT:   P RE-ADJUST UCB PTR TO PREFIX                           */ 07860003
*/*          S UNLCKLCH:  GO TO RTN TO RELEASE LCH LOCK              */ 07900003
*/*          P TURN OFF LOCK HELD INDICATOR                          */ 07930003
*/*          D (YES,,NO,LCHEXIT)   ANY IOQ'S ON CHAIN ?              */ 08000003
*/*          P COPY 'TO' UCB ADDR                                    */ 08050003
*/*          S LOCKLCH:  GO GET 'TO' LCH LOCK                        */ 08100003
*/*          P TURN ON LCH LOCK HELD INDICATOR                       */ 08120003
*/*%NEXTNQ:  P GET IOQ PTR FROM WORKAREA                             */ 08150003
*/*          D (YES,,NO,NQEXIT)    IS THERE AN IOQ ?                 */ 08200003
*/*          P RESET QUEUE PTR                                       */ 08250003
*/*          P GET ADDR OF ENQ RTN                                   */ 08300003
*/*          S (,%NEXTNQ) CALLIOS: CALL RTN TO GO TO IOS ENQ RTN     */ 08350003
*/*NQEXIT:   S UNLCKLCH: GO TO RTN TO RELEASE LCH LOCK               */ 08400003
*/*          P TURN OFF LCH LOCK HELD INDICATOR                      */ 08450003
*/*LCHEXIT:  P TURN ON LCH SWAP ENDED FLAG                           */ 08500003
*/*          P RESTORE REGS                                          */ 08510003
*/*LCHRET:   R RETURN                                                */ 08516003
*/*LCHSAME:  P (,LCHRET) TURN ON SWAP STATUS FLAGS                   */ 08530003
*/*%SENTRY:  D (NO,,YES,BADRET) RC = 8;   CPU BROKEN?                */ 08700003
*/*          S (,%SIGPRET)  SIGPRTN: BAL TO SIGP ROUTINE             */ 08800003
*/*%UNLOCK2: S (,TSTPSNS)  RELULOCK: GO RELEASE 'FROM' UCB LOCK      */ 08870003
*/*SIGPRTN:  E SIGPRTN                                               */ 08900003
*/*          P SAVE REGISTERS AND ESTABLISH ADDRESSABILITY           */ 08950003
*/*          P GET PARM ADDR                                         */ 08960003
*/*          P ADJUST UCB'S TO COMMON SECTION                        */ 08980003
*/*          D (NO,,YES,%SETACT)   'TO' UCB ACTIVE ?                 */ 09000003
*/*          P GET UCB LOOKUP TABLE ADDR                             */ 09100003
*/*%NXTUCB:  P GET UCB ADDR                                          */ 09150003
*/*          P SET SWAP STARTED BIT                                  */ 09200003
*/*          D (MIXD,,ONES,%EOTBL,ZERO,%UPDATE)  ADDR VALID ?        */ 09250003
*/*          D (NO,,YES,%FRMEQTO)  IS THIS 'FROM' UCB ?              */ 09300003
*/*          D (NO,%UPDATE,YES,%TOEQFRM)  IS THIS 'TO' UCB ?         */ 09350003
*/*%UPDATE:  P (,%NXTUCB)  INCREMENT UCB ADDR PTR                    */ 09400003
*/*%FRMEQTO: P (,%UPDATE) SET 'FROM' ADDR = 'TO' ADDR IN TABLE       */ 09450003
*/*%TOEQFRM: P (,%UPDATE) SET 'TO' ADDR = 'FROM' ADDR IN TABLE       */ 09500003
*/*%EOTBL:   P COPY 'FROM' UCB TO WORKAREA                           */ 09550003
*/*          P COPY 'TO' UCB TO 'FROM' UCB                           */ 09600003
*/*          P COPY WORKAREA TO 'TO' UCB                             */ 09650003
*/*          P SWAP IOQ FIELDS                                       */ 09700003
*/*          P SWAP UCBJBNR,UCBFL5 EXCEPT MONT & NALOC BITS          */ 09750003
*/*          P SWAP UCBTBYT2 EXCEPT VLPWR BIT                        */ 09800003
*/*          D (YES,,NO,%NOTTAPE)   TAPE ?                           */ 09850003
*/*          P SWAP UCBDVSHR                                         */ 09900003
*/*%NOTTAPE: P SWAP UCBFL4                                           */ 09950003
*/*          P COPY 'FROM' EXTENSION FIELDS TO WORKAREA              */ 10000003
*/*          P COPY 'TO' EXTENSION FIELDS TO 'FROM'                  */ 10050003
*/*          P COPY WORKAREA TO 'TO' EXTENSION FIELDS                */ 10100003
*/*          P SWAP 'VARY PENDING' BIT                               */ 10150003
*/*          P SWAP DEVICE STATISTICS TABLE                          */ 10200003
*/*          P SET SWAP ENDED BIT                                    */ 10250003
*/*SIGRET:   P RESTORE REGS AND SET RETURN CODE                      */ 10290003
*/*          R EXIT                                                  */ 10350003
*/*%SETACT:  P (,SIGRET)SET UCB ACTIVE INDICATOR                     */ 10360003
*/*FRRTN:    E FRRTN                                                 */ 10400003
*/*          P ESTABLISH ADDRESSABILITY                              */ 10450003
*/*          P GET FRR WORKAREA                                      */ 10500003
*/*          L SETRP:  RECORD = YES                                  */ 10550003
*/*          D (YES,,NO,%LOCK2)    DO WE HOLD UCB LOCK ?             */ 10600003
*/*          P SET BIT IN SDWA TO FREE UCB LOCK                      */ 10650003
*/*          P (,%SDWAREC) SAVE LOCKWORD IN SDWA                     */ 10660003
*/*%LOCK2:   D (YES,,NO,%SDWAREC)   DO WE HOLD LCH LOCK?             */ 10700003
*/*          P SET BIT IN SDWA TO FREE LCH LOCK                      */ 10750003
*/*          P SAVE LOCKWORD IN SDWA                                 */ 10760003
*/*%SDWAREC: P PUT DATA INTO SDWA VARIABLE RECORDING AREA            */ 10800003
*/*          D (YES,,NO,%WHERE)   CAN WE TAKE DUMP ?                 */ 10850003
*/*          P PUT FRR PARM AREA AND SDWA INTO BUFFER                */ 10860003
*/*          L SDUMP:      IECVGENA ERROR                            */ 10900003
*/*%WHERE:   D (YES,,NO,%RET)      SWAP FUNCTION ACTIVE              */ 10920003
*/*          D (PART,,DONE,%RET)   WHAT IS STATE OF SWAP ?           */ 10940003
*/*          P SET AND SAVE RETRY REGISTERS                          */ 11000003
*/*          L SETRP  RC = 4;  RETRY                                 */ 11050003
*/*%RET:     R RETURN TO RTM                                         */ 11100003
*/*RELUCBLK: P GET ADDRESS OF UCB                                    */ 11150003
*/*          L SETLOCK:    RELEASE IOSUCB 'FROM'                     */ 11200003
*/*          P TURN OFF UCB LOCK HELD INDICATOR                     */  11250003
*/*          R RETURN                                                */ 11300003
*/*LOCKLCH:  E LOCKLCH                                               */ 11350003
*/*          P GET CORRECT LCH                                       */ 11400003
*/*          P SAVE REGISTERS AROUND SETLOCK                         */ 11450003
*/*          L SETLOCK:   OBTAIN IOSLCH                              */ 11500003
*/*          P SHOW LCH LOCK HELD IN IRT                             */ 11550003
*/*          P SAVE LOCKWORD IN FRR WORKAREA                         */ 11600003
*/*          P SAVE LCCA ADDR IN FRR WORKAREA                        */ 11650003
*/*          P RESTORE REGISTERS                                     */ 11700003
*/*          R RETURN                                                */ 11750003
*/*UNLCKLCH: E UNLCKLCH                                              */ 11800003
*/*          P SAVE REGISTERS AROUND SETLOCK                         */ 11850003
*/*          P POINT AT LOCK                                         */ 11900003
*/*          L SETLOCK:     RELEASE IOSLCH                           */ 11950003
*/*          P TURN OFF LCH LOCK HELD INDIC'S IN IRT & FRRAREA       */ 12000003
*/*          P RESTORE REGISTERS                                     */ 12050003
*/*          R RETURN                                                */ 12100003
*/*ADDFRR:   E ADDFRR                                                */ 12150003
*/*          P GET FRR ROUTINE ADDRESS                               */ 12200003
*/*          L SETFRR  ADD                                           */ 12250003
*/*          P SAVE GENA ENTRY POINT, PARM REG AND SAVE AREA ADDR    */ 12300003
*/*          R RETURN                                                */ 12350003
*/*DELFRR:   E DELFRR                                                */ 12400003
*/*          L SETFRR     DELETE                                     */ 12450003
*/*          R RETURN                                                */ 12500003
         TITLE 'IECVGENA - EXTERNAL MAPPING MACROS'                     12550003
         IEFUCBOB PREFIX=YES,LIST=YES                                   12600003
         EJECT                                                          12650003
         IHAPSA                                                         12700003
         EJECT                                                          12750003
         CVT   DSECT=YES                                                12800003
         EJECT                                                          12850003
         IECDIOCM                                                       12900003
         EJECT                                                          12950003
         IHALCCA                                                        13000003
         EJECT                                                          13050003
         IECDIRT                                                        13100003
         EJECT                                                          13150003
         IHAWSAVT CLASS=CPU                                             13200003
         EJECT                                                          13250003
         IECDIOSB                                                       13300003
         EJECT                                                          13350003
         IECDLCH                                                        13400003
         EJECT                                                          13450003
         IECDIOQ                                                        13500003
         EJECT                                                          13550003
         IHAASCB                                                        13600003
         EJECT                                                          13650003
         IHAFRRS                                                        13700003
         EJECT                                                          13750003
         IHASDWA                                                        13800003
         TITLE 'IECVGENA - INTERNAL MAPPING MACROS'                     13850003
*****************************************************************       13900003
*                                                               *       13950003
*        VARY PATH PARAMETER DSECT                              *       14000003
*                                                               *       14050003
*        FUNCTIONAL RECOVERY ROUTINE PARAMETER DUMP DSECT       *       14100003
*                                                               *       14150003
*****************************************************************       14200003
         SPACE                                                          14250003
VARYPARM DSECT                                                          14300003
SFRRPARM EQU   VARYPARM            (FRR) START FRR PARM DUMP            14350003
VARYCHAN DS    XL2                 BINARY CHANNEL/UNIT ADDRESS          14400003
         ORG   VARYCHAN                                                 14450003
VARYCHA  DS    XL1                 BINARY CHANNEL ADDRESS               14500003
VARYUA   DS    XL1                 BINARY UNIT ADDRESS                  14550003
VARYFUNC DS    XL1                 FUNCTION CODE                        14600003
VARYOFFC EQU   X'00'               VARY OFFLINE CONDITIONALLY           14650003
VARYOFFU EQU   X'80'               VARY OFFLINE UNCONDITIONALLY         14700003
VARYON   EQU   X'04'               VARY ONLINE                          14750003
VARYCPU  DS    XL1                 CPUID                                14800003
VARYWORK DS    XL4                 WORK AREA                            14850003
         ORG   VARYWORK                                                 14900003
VARYWCHA DS    XL1                 WORK CHANNEL ADDRESS                 14950003
VARYWUA  DS    XL1                 WORK UNIT ADDRESS                    15000003
VARYWACU EQU   X'F0'               ALT CONTROL UNIT INDICATOR           15050003
VARYWRSV DS    XL2                 RESERVED                             15100003
EFRRPARM EQU   *                   (FRR) END FRR PARM DUMP              15150003
VARYSIZE EQU   *-VARYPARM          LENGTH OF DSECT                      15200003
LFRRPARM EQU   VARYSIZE            (FRR) PARAMETER LENGTH               15250003
         EJECT                                                          15300003
*****************************************************************       15350003
*                                                               *       15400003
*        SWAP WORK AREA DSECT                                   *       15450003
*                                                               *       15500003
*        FUNCTIONAL RECOVERY ROUTINE SAVE AREA DUMP DSECT       *       15550003
*                                                               *       15600003
*****************************************************************       15650003
         SPACE                                                          15700003
SWAPWORK DSECT                                                          15750003
SFRRSAVE EQU   SWAPWORK            (FRR) START FRR SAVE AREA DUMP       15800003
SWAPRC   DS    0F                  RTN CODE FOR DDR   @ZA12145,@ZA25951 15810003
SWAPQPTR DS    1F                  IOQE CHAIN QUEUE HEADER              15840003
SWAPIOS  DS    1F                  ADDRESS OF IOS ROUTINE               15870003
SWAPR15  DS    1F                  IOSGEN REG 15 SAVE AREA              15900003
         DS    2F                  RESERVED           @ZA12145,@ZA25951 15930003
SWAPSAVE DS    15F                 REGISTER SAVE AREA                   16000003
SWAPSSAV DS    0F                  REG SAVE AREA FOR SIGP RTN  @ZA12145 16008003
         DS    3F                  REGISTERS 0 - 2             @ZA12145 16011003
SWAPSR03 DS    1F                  REGISTER 3                  @ZA12145 16012003
SWAPSR04 DS    1F                  REGISTER 4                  @ZA12145 16014003
         DS    1F                  REGISTER 5                  @ZA12145 16017003
SWAPSR06 DS    1F                  REGISTER 6                  @ZA12145 16020003
         DS    6F                  REGISTERS 7 - 12            @ZA12145 16023003
SWAPSR13 DS    1F                  REGSITER 13                 @ZA12145 16026003
         DS    2F                  REGISTERS 14 - 15           @ZA12145 16029003
EFRRSAVE EQU   *                   (FRR) END FRR SAVE AREA DUMP         16050003
SWAPSIZE EQU   *-SWAPWORK          LENGTH OF DSECT                      16100003
LFRRSAVE EQU   SWAPSIZE            (FRR) SAVE AREA LENGTH               16150003
         EJECT                                                          16200003
*****************************************************************       16250003
*                                                               *       16300003
*        FRR PARAMETER AREA DSECT                               *       16350003
*                                                               *       16400003
*****************************************************************       16450003
         SPACE                                                          16500003
GENAFRRS DSECT                                                          16550003
GENAFBAS DS    1F                  BASE ADDRESS OF IECVGENA             16600003
GENAFLOK DS    1F                  LOCK WORD ADDRESS           @ZA12145 16650003
GENAFR05 DS    1F                  PARAMTER PTR                         16750003
GENAFR13 DS    1F                  REG SAVE AREA PTR                    16800003
GENAWORK DS    1F                  ADDRESS OF SWAP WORK AREA   @ZA12145 16810003
GENAFLAG DS    XL1                 STATUS INDICATOR            @ZA12145 16850003
GFRRLLOK EQU   X'80'               LCH LOCK HELD               @ZA12145 16900003
GFRRULOK EQU   X'40'               UCB LOCK HELD               @ZA12145 16950003
GFRRACTV EQU   X'20'               SIGP RTN FOUND ACTIVE UCB   @ZA12145 17000003
GFRRSWAP EQU   X'10'               SWAP FUNCTION ACTIVE        @ZA12145 17050003
GFRRLST  EQU   X'08'               LCH SWAP STARTED            @ZA12145 17100003
GFRRLEND EQU   X'04'               LCH SWAP ENDED              @ZA12145 17150003
GFRRUST  EQU   X'02'               UCB SWAP STARTED            @ZA12145 17200003
GFRRUEND EQU   X'01'               UCB SWAP ENDED              @ZA12145 17250003
GFRRSTAT EQU   X'0F'               TOTAL STATUS OF SWAP        @ZA12145 17300003
GENAFLG2 DS    XL1                 FLAGS                       @ZA12145 17308003
GFRRBRCH EQU   X'80'               SIGP RTN ENTERED VIA BALR   @ZA12145 17316003
GFRRRSV  EQU   X'7F'               RESERVED                    @ZA12145 17324003
         DS    XL2                 RESERVED                    @ZA12145 17350003
GENASIZE EQU   *-GENAFRRS          LENGTH OF DSECT                      17400003
         EJECT                                                          17450003
*****************************************************************       17500003
*                                                               *       17550003
*        FRR 4K BUFFER DSECT                                    *       17600003
*                                                               *       17650003
*****************************************************************       17700003
         SPACE                                                          17750003
SDBF     DSECT                                                          17800003
SDBFPTR  DS    1A                  (FRR) POINTER TO DUMP START          17850003
SDBFCNT  DS    1H                  (FRR) BUFFER BYTE COUNT              17900003
SDBFSTRT DS    0H                  (FRR) START OF SVC DUMP              17950003
         DS    1H                  (FRR) RESERVED HALFWORD              18000003
SDBFPARM DS    XL8                 (FRR) 8 BYTE PARAMETER               18050003
SDBFSAVE DS    18F                 (FRR) REGS AT ENTRY                  18100003
SDBFSDWA DS    (SDWALEN/4)F        (FRR) CONTENTS OF SDWA               18150003
SDBFRRWA DS    6F                  (FRR) FRR 6-WORD PARM AREA  @ZA12145 18200003
*                                  SEE SDBFLNTH FOR BUFFER LENGTH       18250003
         TITLE 'IECVGENA - REGISTER DEFINITIONS'                        18300003
*****************************************************************       18350003
*                                                               *       18400003
*        REGISTER DEFINITIONS                                   *       18450003
*                                                               *       18500003
*        SPECIAL NOTES:                                         *       18550003
*              SAVE REGISTERS 0,1,10,11,12,13,14,15             *       18600003
*              ACROSS IOS STORAGE MANAGER INTERFACE.            *       18650003
*              REGISTER 13 IS NOT DESTROYED.                    *       18700003
*                                                               *       18750003
*              REGISTERS 11,12,13, AND 14 ARE DESTROYED         *       18800003
*              ACROSS SETLOCK INTERFACE.                        *       18850003
*                                                               *       18900003
*        REGISTER USAGE BY FUNCTION:                            *       18950003
*              C - COMMEN TO ALL FUNCTIONS                      *       19000003
*              U - UCBFLG                                       *       19050003
*              V - VARY                                         *       19100003
*              S - SWAP                                         *       19150003
*              F - FRR SUBROUTINES                              *       19200003
*              I - IOSINTRP                                    @ZA16163 19220003
*                                                               *       19250003
*****************************************************************       19300003
         SPACE                                                          19350003
LOC0     EQU   0                   (U,S) LOW CORE PTR                   19400003
         SPACE                                                          19450003
RSRC1    EQU   1                   (U) RESOURCE PTR                     19500003
CPU1     EQU   1                   (S) CPU ADDRESS             @ZA12145 19550003
LCH1     EQU   RSRC1               (S) LCH PTR                          19600003
WORK1    EQU   1                   (S) WORK REGISTER           @ZA12145 19650003
RUCB     EQU   1                   (I) UCB/DEVICE ADDRESS      @ZA16163 19670003
         SPACE                                                          19700003
WORK2    EQU   2                   (C)  EVEN WORK REG                   19750003
*                                  (U,V) SAVE13 WHILE UCBLOCK HELD      19800003
REG      EQU   2                   (I) TEMP WORK REGISTER      @ZA16163 19820003
         SPACE                                                          19850003
WORK3    EQU   3                   (C) ODD WORK REG                     19900003
FRRWA3   EQU   3                   (S) ADDR OF FRR WORKAREA    @ZA12145 19910003
*                                  (U,V) RTN14 WHILE UCBLOCK HELD       19950003
         SPACE                                                          20000003
UCB4     EQU   4                   (U,V) UCB PTR                        20050003
UCBTO4   EQU   UCB4                (S) 'TO' UCB PTR                     20100003
         SPACE                                                          20150003
PARM5    EQU   5                   (U) VARIATION REG                    20200003
*                                  (V) PARAMETER POINTER                20250003
IOCOM5   EQU   PARM5               (S) IOCOM PTR                        20300003
         SPACE                                                          20350003
CVT6     EQU   6                   (V) CVT POINTER                      20400003
UCBFROM6 EQU   CVT6                (S) 'FROM' UCB PTR                   20450003
         SPACE                                                          20500003
WORK7    EQU   7                   (U,V) WORK REG                       20550003
UCBOPT7  EQU   WORK7               (S) 'OPTIONAL' UCB PTR               20600003
         EJECT                                                          20650003
WORK8    EQU   8                   (U,V) WORK REG                       20700003
*                                  (S) *WORK AREA PTR                   20750003
         SPACE                                                          20800003
LINK9    EQU   9                   (C) LINK REG                         20850003
         SPACE                                                          20900003
WORK10   EQU   10                  (V) WORK REG                         20950003
*                                  (C) *LINK REG TO FRR SUBROUTINES     21000003
         SPACE                                                          21050003
BLKLOK11 EQU   11                  (C) LOCK WORD REG                    21100003
*                                  (C) WORK REG                         21150003
*                                  (U) RESOURCE BLOCK SIZE REG          21200003
IOQE11   EQU   BLKLOK11            (S) IOQE PTR                         21250003
         SPACE                                                          21300003
WORK12   EQU   12                  (C) WORK REG                         21350003
*                                  (S) *CVT PTR (MUST POINT TO CVT      21400003
*                                  *UPON RETURN)                        21450003
         SPACE                                                          21500003
SAVE13   EQU   13                  (C) SAVE AREA PTR                    21550003
*                                  WORK REG WHEN LOCK IS HELD           21600003
         SPACE                                                          21650003
RTN14    EQU   14                  (C) RETURN REG                       21700003
*                                  WORK REG WHEN LOCK IS HELD           21750003
         SPACE                                                          21800003
BASE15   EQU   15                  (C) BASE REG                         21850003
*                                  (U) ENTRY POINT TO I/O STORAGE MGR   21900003
*                                  (S) ENTRY POINT TO IOS ROUTINES      21950003
RC15     EQU   15                  (S) RETURN CODE AFTER RISGNL@ZA12145 22000003
         TITLE 'IECVGENA - MISCELLANEOUS EQUATES'                       22100003
*****************************************************************       22150003
*                                                               *       22200003
*        MISCELLANEOUS EQUATES                                  *       22250003
*                                                               *       22300003
*        EQUATE USAGE BY FUNCTION:                              *       22350003
*              U - UCBFLG                                       *       22400003
*              V - VARY                                         *       22450003
*              S - SWAP                                         *       22500003
*              F - FRR SUBROUTINES                              *       22550003
*                                                               *       22600003
*****************************************************************       22650003
         SPACE                                                          22700003
XFF      EQU   X'FF'               (C) 'AND'ING BASE                    22750003
BLKSIZE  EQU   X'20'               (U) RESOURCE BLKSIZE CONSTANT        22800003
*                                  *FOR STORAGE MGR                     22850003
RTNCD04  EQU   4                   (V) RETURN CODE OF 4                 22900003
RTNCD08  EQU   8                   (V) RETURN CODE OF 8                 22950003
RTNCD12  EQU   12                  (V) RETURN CODE OF 12                23000003
RTNCD20  EQU   20                  (V) RETURN CODE OF 20                23050003
RETURNCD EQU   60                  (V) REG 15 DISPLACEMENT IN           23100003
*                                  *SAVEAREA                            23150003
SWRESV0  EQU   X'00'               (V) SOFTWARE RESERVE TEST            23200003
K01      EQU   1                   (C) CONSTANT OF 1                    23250003
K02      EQU   2                   (C) CONSTANT OF 2                    23300003
K03      EQU   3                   (S) CONSTANT OF 3           @ZA12145 23350003
K04      EQU   4                   (C) CONSTANT OF 4                    23400003
K08      EQU   8                   (C) CONSTANT OF 8                    23450003
K10      EQU   10                  (S) CONSTANT OF 10          @ZA12145 23500003
K20      EQU   20                  (S) CONSTANT OF 20          @ZA12145 23550003
K80      EQU   80                  (S) CONSTANT OF 80          @ZA12145 23560003
K256     EQU   256                 (S) CONSTANT OF 256         @ZA12145 23600003
K512     EQU   512                 (S) CONSTANT OF 512         @ZA12145 23650003
ID3400   EQU   X'03'               (S) 3400 SERIES ID          @ZA12145 23700003
ID3DA    EQU   X'20'               (S) UCB3DACC                @ZA12145 23750003
ID3TA    EQU   X'80'               (S) UCB3TAPE                @ZA12145 23800003
MSKON    EQU   X'0104'             (S) 'ON' MASK FOR UCBMONT & UCBNALOC 23850003
*                                                              @ZA12145 23900003
MSK80    EQU   X'80'               (S) 'ON' MASK FOR UCBDVSHR  @ZA12145 23950003
MSK7F    EQU   X'7F'               (S) 'OFF' MASK FOR UCBDVSHR @ZA12145 24000003
MSK02    EQU   X'02'               (S) 'ON' MASK FOR ICBVLPWR           24050003
*                                                     @XL03167,@ZA12145 24100003
MSKFD    EQU   X'FD'               (S) 'OFF' MASK FOR CBVLPWR           24150003
*                                                     @XL03167,@ZA12145 24200003
MSK03    EQU   B'0011'             (S) MASK FOR CLM INSTR.              24250003
*                                                     @XL03167,@ZA12145 24300003
IOSORG   EQU   4094                (S) IOS BASE ADDR INCR               24350003
LOCKS0   EQU   0                   (FRR) INIT SDWA LOCK FLGS            24400003
FMIDTEST EQU   0                   (FRR) TEST VALID MEMMORY             24450003
ACTIVA   EQU   UCBBSY+UCBPSNS+UCBACTV                 @ZA29054,@ZA12145 24500003
*                                  (S) UCB ACTIVE BITS         @ZA12145 24600003
ZERO     EQU   0                   (S) DISPLACEMENT OF 0       @ZA12145 24650003
MASKOF   EQU   X'0F'               (I) BYTE 'AND'ING MASK      @ZA16163 24660003
CSWDE    EQU   X'04'               (I) DEVICE END CSW STATUS   @ZA16163 24668003
PSWMCEC  EQU   X'0C'               (I) MACHINE CH+EC MODE MASK @ZA16163 24676003
PSWDIS   EQU   X'FC'               (I) DISABLE SYSTEM MASK     @ZA16163 24684003
         TITLE 'IECVGENA - ENTRY POINTS AND ADDRESSABILITY'             24700003
*****************************************************************       24750003
*                                                               *       24800003
*        ESTABLISH ADDRESSABILITY                               *       24850003
*                                                               *       24900003
*****************************************************************       24950003
         SPACE                                                          25000003
IECVGENA CSECT                                                          25050003
         USING IECVGENA,BASE15                                          25100003
         USING UCB,UCB4                                                 25150003
MAINTAIN EQU   *                   MAINTENANCE REFERENCE                25200003
         SPACE                                                          25250003
*****************************************************************       25300003
*                                                               *       25350003
*        ENTRY POINT BRANCH TABLE  (REGISTER 15)                *       25400003
*              0 - SWAP                                         *       25450003
*              4 - VARY                                         *       25500003
*              8 - IOSINTRP                                    @ZA16163 25550003
*             12 - RESERVED FOR EXPANSION                       *       25600003
*             16 - UCBFLG ALL INDICATORS 'ON' OR 'OFF'          *       25650003
*                                                               *       25700003
*****************************************************************       25750003
         SPACE                                                          25800003
         B     SWAP                SWAP                                 25850003
         SPACE                                                          25900003
IECIVARY B     VARYPATH            VARY                                 25950003
         SPACE                                                          26000003
         B     SIMINT              IOSINTRP                    @ZA16163 26050003
         SPACE                                                          26100003
         B     NOLOCK              RESERVED FOR EXPANSION               26150003
         SPACE                                                          26200003
IECIFLOK BAL   LINK9,GETLOKSV      UCBFLG                               26250003
*                                  *GO OBTAIN LOCK (SAVE 13 & 14)       26300003
         TITLE 'IECVGENA -  UCBFLG BRANCH TABLE AND EXECUTION'          26350003
*****************************************************************       26400003
*                                                               *       26450003
*        UCBFLG                                                 *       26500003
*        NORMAL BRANCH TABLE VALUES FOR IECVGENA.               *       26550003
*        THESE VALUES ARE DISPLACEMENTS IN REGISTER 5 FROM      *       26600003
*        LABEL 'BRUCBFLG'.                                      *       26650003
*        USED ONLY WHEN DISPLACEMENT FROM REGISTER 15 IS        *       26700003
*        LABEL 'LOK' ENTRY POINT.                               *       26750003
*        LABELS AT BRANCHES EQUAL 3 CHARACTER SUFFIX OF         *       26800003
*        EQUATES IN IOSGEN FOR DISPLACEMENT FROM REG 5.         *       26850003
*              0 - UCBFLG UCBNRY 'ON' (CONDITIONALLY)           *       26900003
*              4 - UCBFLG UCBNRY 'ON' (UNCONDITIONALLY)         *       26950003
*              8 - UCBFLG UCBNRY + UCBITF 'OFF'                 *       27000003
*             12 - UCBFLG UCBNRY 'OFF'                          *       27050003
*             20 - UCBFLG UCBTICBT 'ON'                         *       27100003
*             28 - UCBFLG UCBTICBT 'OFF'                        *       27150003
*             36 - UCBFLG UCBDDRSW 'ON'                         *       27200003
*             44 - UCBFLG UCBDDRSW 'OFF'                        *       27250003
*             52 - UCBFLG UCBQISCE 'ON'                         *       27300003
*             60 - UCBFLG UCBQISCE 'OFF'                        *       27350003
*             68 - UCBFLG UCBIVRR 'ON'                          *       27400003
*             76 - UCBFLG UCBIVRR 'OFF'                         *       27450003
*             84 - UCBFLG UCBIVRS 'ON'                          *       27500003
*             92 - UCBFLG UCBIVRS 'OFF'                         *       27550003
*            100 - UCBFLG UCBIORST 'ON'                         *       27600003
*            108 - UCBFLG UCBIORST 'OFF'                        *       27650003
*            116 - UCBFLG UCBITF 'ON'                           *       27700003
*            124 - UCBFLG UCBITF 'OFF'                          *       27750003
*            128 - UCBFLG UCBRVRS- UCBNRY,UCBIVRS 'ON'  @OZ03863*       27800003
*                                  UNDER SAME LOCK      @OZ03863*       27850003
*            136 - UCBFLG UCBRVRS- UCBNRY,UCBIVRS 'OFF' @OZ03863*       27900003
*                                  UNDER SAME LOCK      @OZ03863*       27950003
*                                                               *       28000003
*****************************************************************       28050003
         SPACE                                                          28100003
         USING PSA,LOC0                                         Y30CQLB 28150003
         USING CVT,WORK12                                       Y30CQLB 28200003
         SPACE                                                          28250003
         B     BRUCBFLG(PARM5)     BRANCH TO SELECTED OPERATION         28300003
         SPACE                                                          28350003
BRUCBFLG B     IECIFNRC            UCBNRY 'ON' CONDITIONALLY            28400003
         SPACE                                                          28450003
         B     IECIFNRN            UCBNRY 'ON' UNCONDITIONALLY          28500003
         SPACE                                                          28550003
         B     IECIFNIS            SPECIAL TAPE CALL                    28600003
         SPACE                                                          28650003
IECIFNRF NI    UCBFLA,XFF-UCBNRY   TURN NOT READY 'OFF'                 28700003
         B     UNLOCK              GO RELEASE LOCK                      28750003
         SPACE                                                          28800003
IECIFTIN OI    UCBFLC,UCBTICBT     TURN CE/DE INTERRUPT 'ON'            28850003
         B     UNLOCK              GO RELEASE LOCK                      28900003
         SPACE                                                          28950003
IECIFTIF NI    UCBFLC,XFF-UCBTICBT TURN CE/DE INTERRUPT 'OFF'           29000003
         B     UNLOCK              GO RELEASE LOCK                      29050003
         SPACE                                                          29100003
IECIFDDN OI    UCBFLC,UCBDDRSW     TURN VOLUME SWITCH PENDING           29150003
*                                  *'ON'                                29200003
         B     UNLOCK              GO RELEASE LOCK                      29250003
         SPACE                                                          29300003
IECIFDDF NI    UCBFLC,XFF-UCBDDRSW TURN VOLUME SWITCH PENDING           29350003
*                                  *'OFF'                               29400003
         B     UNLOCK              GO RELEASE LOCK                      29450003
         SPACE                                                          29500003
IECIFQIN OI    UCBFLA,UCBQISCE     TURN QUIESCE DEVICE 'ON'             29550003
         B     UNLOCK              GO RELEASE LOCK                      29600003
         SPACE                                                          29650003
IECIFQIF NI    UCBFLA,XFF-UCBQISCE TURN QUIESCE DEVICE 'OFF'            29700003
         B     UNLOCK              GO RELEASE LOCK                      29750003
         SPACE                                                          29800003
IECIFIVN OI    UCBFLC,UCBIVRR      TURN INTERV REQ MSG SENT 'ON'        29850003
         B     UNLOCK              GO RELEASE LOCK                      29900003
         SPACE                                                          29950003
IECIFIVF NI    UCBFLC,XFF-UCBIVRR  TURN INTERV REQ MSG SENT 'OFF'       30000003
         B     UNLOCK              GO RELEASE LOCK                      30050003
         SPACE                                                          30100003
IECIFRSN OI    UCBFLC,UCBIVRS      TURN INTERV REQ MSG NEEDED 'ON'      30150003
         B     UNLOCK              GO RELEASE LOCK                      30200003
         SPACE                                                          30250003
IECIFRSF EQU   *                                                        30300003
         NI    UCBFLC,XFF-UCBIVRS  TURN INTERV REQ MSG NEEDED 'OFF'     30350003
         B     UNLOCK              GO RELEASE LOCK                      30400003
         SPACE                                                          30450003
IECIFION EQU   *                                               @Y30CQLB 30500003
         L     WORK12,FLCCVT       GET CVT POINTER             @Y30CQLB 30550003
         B     IECIFIO1            GO TEST IF CRH IS ACTIVE    @Y30CQLB 30600003
         SPACE                                                          30650003
IECIFIOF EQU   *                                               @Y30CQLE 30700003
         L     WORK12,FLCCVT       GET CVT POINTER             @Y30CQLE 30750003
         B     IECIFIO2            GO TEST IF CRH IS ACTIVE    @Y30CQLB 30800003
         SPACE                                                          30850003
IECIFITN OI    UCBFLC,UCBITF       TURN INTERCEPT 'ON'                  30900003
         B     UNLOCK              GO RELEASE LOCK                      30950003
         SPACE                                                          31000003
IECIFITF B     INTRCEPT            TURN INTERCEPT 'OFF'                 31050003
         SPACE                                                          31100003
IECIFRVN OI    UCBFLC,UCBIVRS      TURN 'ON' MSG. ISSUED       @OZ03863 31150003
         B     IECIFNRN            GO TEST NOT READY  @OZ06201,@ZA12398 31200003
         SPACE                                                          31250003
IECIFRVF NI    UCBFLA,XFF-UCBNRY   TURN 'OFF' NOT READY        @OZ03863 31300003
         NI    UCBFLC,XFF-UCBIVRS  TURN 'OFF' MSG. ISSUED      @OZ03863 31350003
         B     UNLOCK              GO RELEASE LOCK                      31400003
         EJECT                                                          31450003
         SPACE 5                                                        31500003
IECIFIO1 EQU   *                                                        31550003
         SPACE                                                          31600003
         L     SAVE13,CVTCRCA      GET ADDRESS OF CRCA,IF ANY  @Y30CQLB 31650003
         LTR   SAVE13,SAVE13       IS CRH ACTIVE NOW?          @Y30CQLE 31700003
         BNZ   UNLOCK              YES, LET CRH SET            @Y30CPLB 31750003
         SPACE                                                          31800003
         OI    UCBFLB,UCBIORST     TURN I/O RESTART 'ON'       @Y30CQLB 31850003
         B     UNLOCK              GO RELEASE LOCK                      31900003
         SPACE                                                          31950003
IECIFIO2 EQU   *                                                        32000003
         L     SAVE13,CVTCRCA      GET ADDRESS OF CRCA,IF ANY  @Y30CQLB 32050003
         LTR   SAVE13,SAVE13       IS CRH ACTIVE ?             @Y30CQLB 32100003
         BNZ   UNLOCK              YES,LET CRH SET U           @Y30CQLB 32150003
         DROP  LOC0,WORK12                                     @Y30CQLB 32200003
         NI    UCBFLB,XFF-UCBIORST TURN I/O RESTART 'OFF'      @Y30CQLB 32250003
         B     UNLOCK              GO RELEASE LOCK             @Y30CQLB 32300003
         TITLE 'IECVGENA - (UCBFLG) NOT READY /ON/ COND. AND UNCOND.'   32350003
*****************************************************************       32400003
*                                                               *       32450003
*  TURN NOT READY 'ON' EITHER CONDITIONALLY OR UNCONDITIONALLY. *       32500003
*  ALL TESTS MADE IN CALLERS PROGRAM ARE  REPEATED AFTER LOCK   *       32550003
*  ACQUISITION.                                                 *       32600003
*                                                               *       32650003
*****************************************************************       32700003
         SPACE                                                          32750003
IECIFNRC TM    UCBFLC,UCBUDE       IS THERE UNSOLICED DEV END           32800003
         BO    UNLOCK              YES, EXIT IMMEDIATELY                32850003
         SPACE                                                          32900003
IECIFNRN OI    UCBFLA,UCBNRY       TURN NOT READY 'ON'                  32950003
         SPACE                                                          33000003
         B     UNLOCK              GO RELEASE LOCK                      33050003
         TITLE 'IECVGENA - (UCBFLG) SPECIAL TAPE CALL AND UCBITF OFF'   33100003
*****************************************************************       33150003
*                                                               *       33200003
*        SPECIAL TAPE CALL                                      *       33250003
*              TURN NOT READY AND INTERCEPT CONDITION 'OFF'.    *       33300003
*              ALL TESTS MADE IN CALLERS PROGRAM ARE REPEATED   *       33350003
*              AFTER LOCK ACQUISITION.                          *       33400003
*                                                               *       33450003
*        TURN INTERCEPT CONDITION 'OFF'.                        *       33500003
*                                                               *       33550003
*        RELEASE RESOURCES IF NECESSARY.                        *       33600003
*                                                               *       33650003
*****************************************************************       33700003
         SPACE                                                          33750003
IECIFNIS TM    UCBTBYT3,UCB3TAPE   IS IT A TAPE DEVICE                  33800003
         BNO   UNLOCK              NO, EXIT IMMEDIATELY                 33850003
         SPACE                                                          33900003
         TM    UCBFLA,UCBNRY       IS IT NOT READY CONDITION            33950003
         BNO   UNLOCK              NO, EXIT IMMEDIATELY                 34000003
         SPACE                                                          34050003
         TM    UCBFLC,UCBITF       IS IT INTERCEPT CONDITION            34100003
         BNO   UNLOCK              NO, EXIT IMMEDIATELY                 34150003
         SPACE                                                          34200003
         NI    UCBFLA,XFF-UCBNRY   TURN NOT READY 'OFF'                 34250003
         SPACE                                                          34300003
INTRCEPT TM    UCBFLC,UCBWAA       IS WORK AREA APPENDED                34350003
         BNO   NOWAA               NO, SKIP RESOURCE RELEASE CODE       34400003
         SPACE                                                          34450003
         L     RSRC1,UCBIOQ        GET ADDR OF ERP WORK AREA            34500003
         LA    BLKLOK11,BLKSIZE    GET BLOCK SIZE OF RESOURCE           34550003
         SPACE                                                          34600003
         USING PSA,LOC0                                                 34650003
         L     SAVE13,PSALCCAV     GET PTR TO LCCA IN PSA               34700003
         DROP  LOC0                                                     34750003
         SPACE                                                          34800003
         USING LCCA,SAVE13                                              34850003
         L     SAVE13,LCCACPUS     GET ADDR OF CPU SAVE AREA            34900003
*                                  *PTR FROM LCCA                       34950003
         USING WSAC,SAVE13                                              35000003
         L     SAVE13,WSACIOS      GET ADDR OF IOS SAVE AREA            35050003
*                                  *IN WSAC                             35100003
         DROP  SAVE13                                                   35150003
         SPACE                                                          35200003
         STM   WORK10,RSRC1,0(SAVE13)  SAVE REGS 10-1                   35250003
         SPACE                                                          35300003
         USING CVT,BASE15                                               35350003
         L     BASE15,CVTPTR       GET CVTPTR                           35400003
         L     BASE15,CVTIXAVL     GET PTR TO IOCOM IN CVT              35450003
         SPACE                                                          35500003
         USING IOCOM,BASE15                                             35550003
         L     BASE15,IOCORMGT     GET ADDR OF IOS STG MGR              35600003
         SPACE                                                          35650003
         BAL   RTN14,K04(BASE15)   CALL IOS STORAGE MANAGER             35700003
         SPACE                                                          35750003
         LM    WORK10,RSRC1,0(SAVE13)  RESTORE REGS 10-1                35800003
         SPACE                                                          35850003
         USING IECVGENA,BASE15     RE-ESTABLISH ADDRESSABILITY          35900003
         SPACE                                                          35950003
         NI    UCBFLC,XFF-UCBWAA   TURN WORK AREA APPENDED 'OFF'        36000003
         SPACE                                                          36050003
NOWAA    NI    UCBFLC,XFF-UCBITF   TURN INTERCEPT CONDITION 'OFF'       36100003
         SPACE                                                          36150003
         B     UNLOCK              GO RELEASE LOCK AND RETURN           36200003
         TITLE 'IECVGENA - (VARY) ESTABLISH ADDRESSABILITY'             36250003
*****************************************************************       36300003
*                                                               *       36350003
*        ESTABLISH ADDRESSABILITY                               *       36400003
*                                                               *       36450003
*        ACQUIRE UCB LOCK                                       *       36500003
*                                                               *       36550003
*        THE FOLLOWING USINGS APPEAR AT CSECT NAME:             *       36600003
*              USING IECVGENA,BASE15                            *       36650003
*              USING UCB,UCB4                                   *       36700003
*                                                               *       36750003
*****************************************************************       36800003
         SPACE                                                          36850003
         USING VARYPARM,PARM5                                           36900003
         USING CVT,CVT6                                                 36950003
         SPACE                                                          37000003
VARYPATH BAL   LINK9,GETLOKSV      GO OBTAIN LOCK (SAVE 13 & 14)        37050003
         TITLE 'IECVGENA - (VARY)(CONDITIONAL) RESERVE TESTS'           37100003
*****************************************************************       37150003
*                                                               *       37200003
*        VARY OFFLINE CONDITIONALLY RESERVED DEVICE TESTS       *       37250003
*                                                               *       37300003
*****************************************************************       37350003
         SPACE                                                          37400003
         SPACE                                                          37450003
         CLI   VARYFUNC,VARYOFFC REQUEST FOR ONLINE OR OFFLINE @ZA10460 37500003
*                                UNCONDITIONAL                 @ZA10460 37550003
         BNE   APTSERCH            YES, SKIP RESERVED TESTS    @ZA10460 37600003
         TM    UCBTBYT3,UCB3DACC   IS THIS DA DEVICE                    37650003
         BNO   APTSERCH            NO, GO FIND DEVICE ADDR              37700003
         SPACE                                                          37750003
         TM    UCBTBYT2,UCBRR      IS THIS SHARED DEVICE                37800003
         BNO   APTSERCH            NO, GO FIND DEVICE ADDR              37850003
         SPACE                                                          37900003
         CLC   UCBCPU(K01),VARYCPU  LAST SIO THIS CPU                   37950003
         BNE   APTSERCH            NO, GO FIND DEVICE ADDR              38000003
         SPACE                                                          38050003
         TM    UCBFLB,UCBRESVH     HARDWARE RESRVE OUTSTANDING?@YM03341 38100003
         BO    SETRC20             YES, GO SET RETURN CODE FOR @YM03341 38150003
*                                  *RESERVED DEVICE                     38200003
         TM    UCBFLA,UCBSAP+UCBACTV  STAND ALONE SEEK                  38250003
*                                  *OR DATA TRANSFER                    38300003
         BZ    APTSERCH            NO, GO FIND DEVICE ADDR              38350003
         SPACE                                                          38400003
SETRC20  LA    WORK8,RTNCD20       RETURN CODE = 20                     38450003
*                                  *DEVICE IS RESERVED                  38500003
         SPACE                                                          38550003
         B     SETRTNCD            GO SET ERROR RETURN CODE             38600003
         TITLE 'IECVGENA - (VARY) SEARCH AND VERIFY UNIT ADDRESS'       38650003
*****************************************************************       38700003
*                                                               *       38750003
*        SEARCH AND VERIFY UNIT ADDRESS                         *       38800003
*                                                               *       38850003
*****************************************************************       38900003
         SPACE                                                          38950003
APTSERCH SLR   WORK10,WORK10       CLEAR WORK REG                       39000003
         IC    WORK10,UCBLCI       GET LCH INDEX                        39050003
         SLL   WORK10,LCHELP2      MULTIPLY INDEX BY POWER OF 2         39100003
         SPACE                                                          39150003
         L     WORK8,CVTILCH       GET LCH TABLE PTR                    39200003
         USING LCH,WORK8                                                39250003
         L     WORK8,LCHTCH(WORK10)  GET PTR                            39300003
*                                  *TO AVAILABLE PATH TABLE             39350003
         DROP  WORK8                                                    39400003
         SPACE                                                          39450003
APTNEXT  LH    WORK10,0(WORK8)     GET APT ENTRY                        39500003
         SPACE                                                          39550003
         LTR   WORK10,WORK10       IS THIS END OF TABLE                 39600003
         BP    BUILDDEV            NO, GO CHECK DEV ADDR                39650003
         SPACE                                                          39700003
         LA    WORK8,RTNCD12       SET RETURN CODE = 12                 39750003
*                                  *INVALID DEVICE ADDR                 39800003
         B     SETRTNCD            GO SET ERROR RETURN CODE             39850003
         SPACE                                                          39900003
BUILDDEV STH   WORK10,VARYWCHA     SAVE CHANNEL AND POSSIBLE ALT CU     39950003
         SPACE                                                          40000003
         TM    VARYWUA,VARYWACU    IS THIS A SHARED SELECTOR            40050003
*                                  *SUBCHANNEL OF THE 2870              40100003
         BNO   NOALTCU             NO, GET FULL UNIT ADDRESS            40150003
         SPACE                                                          40200003
         MVN   VARYWUA(K01),VARYUA  SET UNIT ADDR                       40250003
         SPACE                                                          40300003
         B     CHECKDEV            GO, CHECK DEVICE ADDR                40350003
         SPACE                                                          40400003
NOALTCU  MVC   VARYWUA(K01),VARYUA  SET FULL CONTROL UNIT ADDR          40450003
         SPACE                                                          40500003
CHECKDEV CLC   VARYCHAN(K02),VARYWCHA  ARE DEV ADDRS EQUAL              40550003
         BE    BUILDBIT            YES, GO BUILD PATH BIT               40600003
         SPACE                                                          40650003
         LA    WORK8,K02(WORK8)    POINT TO NEXT ENTRY                  40700003
         SPACE                                                          40750003
         B     APTNEXT             GO GET NEXT ENTRY                    40800003
         TITLE 'IECVGENA - (VARY) BUILD PATH BIT'                       40850003
*****************************************************************       40900003
*                                                               *       40950003
*        BUILD PATH BIT FOR ALL FUNCTIONAL REQUESTS             *       41000003
*                                                               *       41050003
*****************************************************************       41100003
         SPACE                                                          41150003
BUILDBIT SLR   WORK8,WORK8         CLEAR WORK REG                       41200003
         IC    WORK8,VARYCPU       GET CPU ID                           41250003
         ALR   WORK8,WORK8         DOUBLE CPU ADDR                      41300003
         SPACE                                                          41350003
         N     WORK10,PATHBMSK     ISOLATE PATH BIT                     41400003
         SLL   WORK10,12           ALIGN PATH BIT                       41450003
         SRL   WORK10,0(WORK8)     ALIGN BIT TO CPU                     41500003
         TITLE 'IECVGENA - (VARY) SET PATH ON/OFF LINE'                 41550003
*****************************************************************       41600003
*                                                               *       41650003
*        SET PATH ON/OFF LINE                                   *       41700003
*                                                               *       41750003
*****************************************************************       41800003
         SPACE                                                          41850003
         LH    WORK8,UCBCHM        GET CHANNEL MASK                     41900003
         N     WORK8,HOHWMASK      AND OUT HI ORDER HALFWORD            41950003
         SPACE                                                          42000003
         CLI   VARYFUNC,VARYON     VARY ONLINE                          42050003
         BNE   OFFLINE             NO, GO DO OFFLINE                    42100003
         SPACE                                                          42150003
         X     WORK10,GENMASK      SET ANDING MASK             @YM08184 42200003
         NR    WORK10,WORK8        MAKE COMPOSITE ONLINE MASK  @YM08184 42250003
         SPACE                                                          42300003
         L     LINK9,UCBEXTPT      GET UCB EXT PTR                      42350003
         LA    LINK9,0(LINK9)      CLEAR HIGH ORDER BYTE                42400003
         USING UCBCMEXT,LINK9                                           42450003
         XC    UCBPMSK,UCBPMSK     ZERO MESSAGES ISSUED MASK            42500003
         DROP  LINK9                                                    42550003
         SPACE                                                          42600003
         L     WORK8,CVTCRCA       GET ADDRESS OF CRCA,IF ANY   Y30CQLB 42650003
         LTR   WORK8,WORK8         IS CRH ACTIVE NOW?           Y30CQLB 42700003
         BNZ   SETRC00             YES, BYPASS-LET CRH SET UCB  Y30CQLB 42750003
         SPACE                                                          42800003
         NI    UCBFLB,XFF-UCBIORST MAKE DEVICE AVAILABLE FOR I/O        42850003
         SPACE                                                          42900003
         B     SETRC00             GO SET SUCCESSFUL COMPLETION         42950003
         SPACE                                                          43000003
OFFLINE  OR    WORK10,WORK8        MAKE COMPOSITE OFFLINE MASK          43050003
         OR    WORK8,WORK10        MAKE COPY OF MASK                    43100003
         SPACE                                                          43150003
         X     WORK8,PATHTEST      ARE ALL PATHS OFFLINE                43200003
         BZ    LASTPATH            YES, GO SET LAST PATH                43250003
         SPACE                                                          43300003
SETRC00  SLR   WORK8,WORK8         SET SUCCESSFUL RETURN CODE           43350003
         SPACE                                                          43400003
         B     SETMASK             GO SET OFFLINE CHANNEL MASK          43450003
         SPACE                                                          43500003
LASTPATH CLI   VARYFUNC,VARYOFFU   OFFLINE UNCONDITIONALLY              43550003
         BE    OFFUNCON            YES, GO SET RETURN CODE              43600003
         SPACE                                                          43650003
         LA    WORK8,RTNCD08       SET RETURN CODE = 8                  43700003
*                                  *LAST PATH CANT BE SET OFFLINE       43750003
         B     SETRTNCD            GO SET ERROR RETURN CODE             43800003
         SPACE                                                          43850003
OFFUNCON LA    WORK8,RTNCD04       SET RETURN CODE = 4                  43900003
*                                  *LAST PATH HAS BEEN SET OFFLINE      43950003
         TITLE 'IECVGENA - (VARY) SET PATH MASK AND RETURN CODE'        44000003
*****************************************************************       44050003
*                                                               *       44100003
*        SET PATH PATH MASK AND RETURN CODE                     *       44150003
*                                                               *       44200003
*****************************************************************       44250003
         SPACE                                                          44300003
SETMASK  SLL   WORK10,16           ALIGN PATH MASK                      44350003
         SPACE                                                          44400003
UPDATCHM L     WORK7,UCBCHM        GET EXISTING CHNL MASK               44450003
         L     LINK9,CSANDCHM      GET ANDING MASK                      44500003
         SPACE                                                          44550003
         NR    LINK9,WORK7         ZERO CHANNEL MASK                    44600003
         OR    LINK9,WORK10        SET NEW CHANNEL MASK                 44650003
         SPACE                                                          44700003
         CS    WORK7,LINK9,UCBCHM  ATTEMPT TO UPDATE MASK               44750003
         BNE   UPDATCHM            LOOP UNTIL SWAP HAS COMPLETED        44800003
         SPACE                                                          44850003
SETRTNCD ST    WORK8,RETURNCD(WORK2)  SET RETURN CODE                   44900003
*                                  *IN REG 15 SAVE AREA                 44950003
         B     UNLOCK              GO RELEASE UCBLOCK                   45000003
*                                  *AND RETURN TO CALLER                45050003
         SPACE                                                          45100003
         DROP  PARM5,CVT6                                               45150003
         TITLE 'IECVGENA - (UCBFLG AND VARY) OBTAIN UCB LOCK'           45200003
*****************************************************************       45250003
*                                                               *       45300003
*        OBTAIN UCB LOCK SUBROUTINE                             *       45350003
*                                                               *       45400003
*        SAVE UCB LOCK WORD ADDRESS IN FRR PARAMETER            *       45450003
*                                                               *       45500003
*****************************************************************       45550003
         SPACE                                                          45600003
GETLOKSV LR    WORK2,SAVE13        SAVE SAVEAREA PTR                    45650003
         LR    WORK3,RTN14         SAVE RETURN ADDR PTR                 45700003
         SPACE                                                          45750003
         TM    UCBWGT,UCBMTPXP     DOES DEVICE HAVE MULT EXP            45800003
         BNO   GETLOCK             NO MULTIPLE EXPOSURES                45850003
         SPACE                                                          45900003
         L     BLKLOK11,UCBBASE    GET BASE UCB ADDR                    45950003
         SPACE                                                          46000003
         USING UCB,BLKLOK11                                             46050003
         LA    BLKLOK11,UCBLOCK    GET UCB LOCK WORD ADDR               46100003
*                                  *FROM BASE UCB                       46150003
         B     BASELOCK            GO RELEASE LOCK                      46200003
         DROP  BLKLOK11                                                 46250003
         SPACE                                                          46300003
GETLOCK  LA    BLKLOK11,UCBLOCK    GET UCB LOCK WORD ADDR               46350003
         SPACE                                                          46400003
BASELOCK LR    WORK7,BLKLOK11      SAVE LOCK WORD ADDR FOR FRR          46450003
         SPACE                                                          46500003
OBTNLOCK SETLOCK OBTAIN,TYPE=IOSUCB,MODE=UNCOND,ADDR=(11),             X46550003
               RELATED=(UCB,IECVGENA(RELSLOCK,IOSGEN))                  46600003
         SPACE                                                          46650003
         SPACE                                                          46700003
         BAL   RTN14,ADDFRR        GO SET FRR                           46750003
         USING GENAFRRS,WORK12                                          46800003
         ST    WORK7,GENAFLOK      SAVE UCB LOCK WORD ADDR     @ZA12145 46850003
         OI    GENAFLAG,GFRRULOK   SET UCB LOCK HELD INDICATOR @ZA12145 46950003
         BR    LINK9               RETURN TO INTERNAL CALLER            47000003
         TITLE 'IECVGENA - (UCBFLG AND VARY) RELEASE UCB LOCK'          47050003
*****************************************************************       47100003
*                                                               *       47150003
*        RELEASE UCB LOCK                                       *       47200003
*                                                               *       47250003
*****************************************************************       47300003
         SPACE                                                          47350003
UNLOCK   TM    UCBWGT,UCBMTPXP     DOES DEVICE HAVE MULT EXP            47400003
         BNO   NOMTPXP             NO MULTIPLE EXPOSURES                47450003
         SPACE                                                          47500003
         L     BLKLOK11,UCBBASE    GET BASE UCB ADDR                    47550003
         SPACE                                                          47600003
         USING UCB,BLKLOK11                                             47650003
         LA    BLKLOK11,UCBLOCK    GET UCB LOCK WORD ADDR               47700003
*                                  *FROM BASE UCB                       47750003
         B     DELETFRR            GO RELEASE LOCK                      47800003
         DROP  BLKLOK11                                                 47850003
         SPACE                                                          47900003
NOMTPXP  LA    BLKLOK11,UCBLOCK    GET UCB LOCK WORD ADDR               47950003
DELETFRR BAL   RTN14,DELFRR        GO DELETE FRR                        48000003
         SPACE                                                          48050003
         SPACE                                                          48100003
RELSLOCK SETLOCK RELEASE,TYPE=IOSUCB,ADDR=(11),                        X48150003
               RELATED=(UCB,IECVGENA(OBTNLOCK,IOSGEN))                  48200003
         SPACE                                                          48300003
         LR    SAVE13,WORK2        RESTORE SAVEAREA PTR                 48350003
         LR    RTN14,WORK3         RESTORE RETURN ADDR PTR              48400003
         SPACE                                                          48450003
         B     NOLOCK              GO RETURN TO CALLER                  48500003
         SPACE                                                          48550003
         DROP  UCB4                                                     48600003
         DROP  WORK12                                                   48620003
         TITLE 'IECVGENA - (SWAP) ESTABLISH ADDRESSABILITY'             48650003
*****************************************************************       48700003
*                                                               *       48750003
*        ESTABLISH ADDRESSABILITY                               *       48800003
*                                                               *       48850003
*        SAVE SAVE AREA POINTER FOR FRR.                        *       48900003
*                                                               *       48950003
*        GET UCB LOCK FOR 'FROM ' UCB                          @ZA12145 49000003
*                                                              @ZA12145 49050003
*        TEST PENDING SENSE AND OTHER UCB ACTIVE BITS;         @ZA12145 49100003
*        LOOPING UNTIL BOTH UCB'S ARE FOUND TO BE              @ZA12145 49150003
*        INACTIVE, THEN PREPARE TO STOP THE OTHER CPU          @ZA12145 49200003
*                                                               *       49250003
*        THE FOLLOWING USINGS APPEAR AT CSECT NAME:             *       49300003
*              USING IECVGENA,BASE15                            *       49350003
*                                                               *       49400003
*****************************************************************       49450003
         SPACE                                                          49500003
         USING PSA,LOC0                                        @ZA12145 49550003
         USING GENAFRRS,FRRWA3                                 @ZA12145 49600003
         USING SWAPWORK,WORK8                                  @ZA12145 49700003
SWAP     EQU   *                                               @ZA12145 49750003
         SPACE 2                                                        49753003
*  TURN ON UCBNRY IN FROMUCB AND TOUCB USING COMPARE AND SWAP LOGIC     49754003
         L     WORK2,UCBCHAN-UCB(UCBTO4)  GET FIELD TO UPDATE  @ZA12145 49756003
SWAP001  LR    WORK3,WORK2            PUT INTO CONTROL REG     @ZA12145 49759003
         O     WORK3,NOTREADY         TURN ON UCBNRY BIT       @ZA12145 49762003
         CS    WORK2,WORK3,UCBCHAN-UCB(UCBTO4) SET FLAG IN UCB @ZA12145 49765003
         BNE   SWAP001                                         @ZA12145 49768003
         CR    UCBTO4,UCBFROM6        ARE UCB ADDRS EQUAL ?    @ZA12145 49771003
         BE    NOSWAP                 YES, EXIT IMMEDIATELY    @ZA12145 49774003
         L     WORK2,UCBCHAN-UCB(UCBFROM6) NO,SET OTHR NOT RDY @ZA12145 49777003
SWAP002  LR    WORK3,WORK2            PUT INTO CONTROL REG     @ZA12145 49780003
         O     WORK3,NOTREADY         TURN ON UCBNRY BIT       @ZA12145 49783003
         CS    WORK2,WORK3,UCBCHAN-UCB(UCBFROM6)  SET FROM UCB @ZA12145 49786003
         BNE   SWAP002                                         @ZA12145 49789003
         SPACE                                                          49794003
         LR    WORK2,SAVE13           SAVE SAVEAREA PTR        @ZA12145 49800003
         LR    PARM5,RTN14            SAVE RET ADDR PTR        @ZA12145 49850003
         BAL   RTN14,ADDFRR           GO SETFRR                @ZA12145 49900003
         LR    FRRWA3,WORK12          GET ADDR OF FRR WORK AREA@ZA12145 49903003
         ST    WORK8,GENAWORK         SAVE WORK AREA ADDR      @ZA12145 49906003
         OI    GENAFLAG,GFRRSWAP      TO LET FRR RTN KNOW WE'RE IN      49910003
*                                     SWAP                     @ZA12145 49920003
         SPACE                                                          50000003
TESTPSNS TM    UCBFLA-UCB(UCBFROM6),UCBPSNS  PENDING SENSE ON FROM DEV  50050003
         BO    TESTPSNS               YES, LOOP TILL CLEAR     @ZA12145 50100003
         TM    UCBFLA-UCB(UCBTO4),UCBPSNS    PENDIING SENSE ON TO DEV   50150003
         BO    TESTPSNS               YES, LOOP TILL CLEAR     @ZA12145 50200003
         SPACE                                                          50250003
         USING UCB,UCBFROM6           SET ADDR ABILITY TO FROM UCB      50300003
         LA    BLKLOK11,UCBLOCK       LOCKWORD                 @ZA12145 50450003
SWAPGETU SETLOCK OBTAIN,TYPE=IOSUCB,ADDR=(11),MODE=UNCOND,             C50500003
               RELATED=(UCB,IECVGENA(SWAPRELU,IOSGEN))         @ZA12145 50550003
         OI    GENAFLAG,GFRRULOK      TURN ON LOCK HELD INDIC  @ZA12145 50650003
         ST    BLKLOK11,GENAFLOK      SAVE LOCK WORD ADDR      @ZA12145 50670003
         SPACE                                                          50700003
*****************************************************************       50710003
*        TEST ALL UCB ACTIVE BITS (UCBBSY,UCBPSNS, AND          *       50720003
*         UCBACTV (ALL IN UCBFLA).                              *       50726003
*        WHEN ALL ACTIVE BITS ARE OFF IN BOTH UCB'S, PROCEED   @ZA12145 50740003
*        WITH THE SWAP; OTHERWISE, RELEASE THE LOCK AND RETURN  *       50750003
*        TO THE PENDING SENSE TESTS.                            *       50760003
*****************************************************************       50770003
         SPACE                                                          50780003
         TM    UCBFLA-UCB(UCBFROM6),ACTIVA                     @ZA12145 50800003
         BNZ   ACTIVE                                          @ZA12145 50850003
         TM    UCBFLA-UCB(UCBTO4),ACTIVA                       @ZA12145 50900003
         BZ    STOPCPU                                         @ZA12145 51250003
ACTIVE   BAL   LINK9,RELULOK          NO, RELEASE LOCK         @ZA12145 51260003
         B     TESTPSNS                                        @ZA12145 51270003
         EJECT                                                          51300003
STOPCPU  EQU   *                                                        51350003
         SPACE                                                          51353003
         SPACE                                                          51359003
         SR    WORK2,WORK2            CLEAR REGISTER           @ZA12145 51362003
         LH    WORK2,PSACPUSA         GET CPU ADDR             @ZA12145 51370003
         LA    CPU1,K01               GET MASK-REVERSE CPUIDS  @ZA12145 51410003
         XR    WORK2,CPU1             GET OTHER CPU-ID         @ZA12145 51420003
         SLL   WORK2,K02              MULTIPLY BY FOUR         @ZA12145 51450003
         L     WORK12,FLCCVT          GET CVT ADDR             @ZA12145 51500003
         USING CVT,WORK12                                      @ZA12145 51550003
         L     WORK12,CVTPCCAT        GET PCCAVT ADDR          @ZA12145 51600003
         DROP  WORK12                                          @ZA12145 51650003
         L     CPU1,ZERO(WORK2,WORK12)  GET PCCA ADDR FOR THIS CPU      51700003
*                                                              @ZA12145 51750003
         LTR   CPU1,CPU1              ADDR EQUAL ZERO ?        @ZA12145 51760003
         BZ    BALRSIGP               YES, BALR TO SIGP RTN    @ZA12145 51770003
         LA    WORK12,GENASIGP         GET ADDR OF SIGP RTN    @ZA12145 51800003
         LA    IOQE11,SWAPSAVE+K20     ADR OF FRRWA FOR SIGPRTN@ZA12145 51810003
         MVC   SWAPSAVE+K20(GENASIZE),0(FRRWA3)                @ZA12145 51820003
*                  MOVE TO SWAPAREA SO THAT SIGPRTN CAN USE IT @ZA12145 51850003
*                  SAVE REGISTERS NEEDED BY SIGP ROUTINE       @ZA12145 51865003
         STM   FRRWA3,BASE15,SWAPSR03 SAVE REGISTERS           @ZA12145 51870003
         SPACE                                                          51930003
         RISGNL SERIAL,CPU=(1),EP=(12),PARM=(11)               @ZA12145 51950003
         LR    WORK2,RC15             SAVE RET CODE            @ZA12145 52100003
         LM    FRRWA3,BASE15,SWAPSR03 RESTORE REGISTERS        @ZA12145 52150003
         MVC   0(GENASIZE,FRRWA3),SWAPSAVE+K20 RESTORE IN STACK@ZA12145 52160003
         LTR   WORK2,WORK2                                     @ZA12145 52200003
         BZ    RELLOCK                RETURN CODE GOOD         @ZA12145 52240003
         CH    WORK2,EIGHT                                     @ZA12145 52280003
         BE    ERRORET                FUNCTION UNSUCCESSFUL    @ZA12145 52320003
BALRSIGP ST    FRRWA3,SWAPSR03        SAVE FRRWA ADDR          @ZA12145 52340003
         LR    WORK1,FRRWA3           ADDR OF PARM FOR SIGPRTN @ZA12145 52360003
         LA    WORK12,GENASIGP         GET ADDR OF SIGP RTN    @ZA12145 52400003
         OI    GENAFLG2,GFRRBRCH      SET BALR INDICATOR       @ZA12145 52430003
         BALR  RTN14,WORK12           BRANCH ENTER SIGP RTN    @ZA12145 52450003
         SPACE                                                          52470003
         L     FRRWA3,SWAPSR03        RESTORE FRR WROKAREA ADDR@ZA12145 52475003
         L     BASE15,GENAFBAS        RESTORE ADDRESSABILITY   @ZA12145 52480003
         NI    GENAFLG2,XFF-GFRRBRCH  TURN OFF BALR INDICATOR  @ZA12145 52486003
         SPACE                                                          52492003
RELLOCK  BAL   LINK9,RELULOK          GO RELEASE LOCK          @ZA12145 52500003
         SPACE                                                          52504003
         TM    GENAFLAG,GFRRACTV      WAS SWAP ATTEMPTED?      @ZA12145 52508003
         BZ    TSTSTAT                YES, BRANCH AROUND       @ZA12145 52516003
         NI    GENAFLAG,GFRRACTV      NO, TURN OFF FLAG AND DO          52524003
         B     TESTPSNS               WHOLE PROCEDURE AGAIN    @ZA12145 52532003
         EJECT                                                          52541003
TSTSTAT  TM    GENAFLAG,GFRRUEND      SWAP FAIL                @ZA12145 52547003
         BZ    ERRORET2             YES, SET ERROR RETURN      @ZA12145 52553003
         SPACE 2                                                        52557003
         LR    WORK12,FRRWA3        FRR WKAREA ADR FOR SWAPLCH @ZA12145 52597003
         BAL   RTN14,SWAPLCH        GO, SWAP LCH'S             @ZA12145 52601003
         EJECT                                                          52617003
GOODRET  SR    WORK2,WORK2            INDICATE TO DDR THAT     @ZA12145 52621003
         ST    WORK2,SWAPRC           SWAP WAS SUCCESSFUL      @ZA12145 52628003
         B     CLEANUP                GO TO RETURN             @ZA12145 52635003
         SPACE 2                                                        52650003
ERRORET  BAL   LINK9,RELULOK          GO RELEASE LOCK          @ZA12145 52700003
ERRORET2 LA    WORK2,K04              INDICATE TO DDR THAT     @ZA12145 52710003
         ST    WORK2,SWAPRC           SWAP FAILED              @ZA12145 52750003
CLEANUP  L     WORK2,GENAFR05         SAVE RETURN ADDR         @ZA12145 52760003
         L     WORK7,GENAFR13         SAVE SAVEAREA PTR        @ZA12145 52770003
         BAL   RTN14,DELFRR           GO TO DELETE FRR         @ZA12145 52800003
         LR    SAVE13,WORK7           RESTORE SAVE AREA PTR    @ZA12145 52820003
         BR    WORK2                  RETURN TO CALLER         @ZA12145 52850003
         SPACE                                                          52855003
         EJECT                                                          52900003
RELULOK  EQU   *                                               @ZA12145 52950003
         LA    BLKLOK11,UCBLOCK       LOCKWORD                 @ZA12145 53100003
SWAPRELU SETLOCK RELEASE,TYPE=IOSUCB,ADDR=(11),                @ZA12145C53150003
               RELATED=(UCB,IECVGENA(SWAPGETU,IOSGEN))         @ZA12145 53200003
         NI    GENAFLAG,XFF-GFRRULOK  TURN OFF LOCK HELD       @ZA12145 53250003
         BR    LINK9                  RET TO CALLER            @ZA12145 53350003
         SPACE 3                                                        53355003
NOSWAP   SR    WORK2,WORK2            INDICATE TO DDR THAT     @ZA12145 53360003
         ST    WORK2,SWAPRC           SWAP WAS SUCCESSFUL      @ZA12145 53370003
         BR    RTN14                  RETURN TO CALLER         @ZA12145 53380003
         EJECT                                                          53400003
*****************************************************************       53450003
*                                                               *       53500003
*        ESTABLISH ADDRESSABILITY TO CONTROL BLOCKS            @ZA12145 53550003
*        ACQUIRE LCH LOCK FOR TO UCB. THIS UCB NOW             @ZA29054 53600003
*        CONTAINS THE LCH INDEX FOR THE LCH THAT WILL          @ZA29054 53610003
*        CONTAIN ANY QUEUED REQUESTS RELATED TO THE            @ZA29054 53620003
*        FROM DEVICE.                                          @ZA29054 53630003
*                                                               *       53650003
*****************************************************************       53700003
         USING PSA,LOC0                                                 53750003
         USING UCB,UCBOPT7                                              53758003
         USING IOCOM,IOCOM5                                             53766003
         USING SWAPWORK,WORK8                                           53774003
         USING IOSB,WORK2                                               53782003
         USING LCH,LCH1                                                 53800003
         USING IOQ,IOQE11                                               53850003
         USING GENAFRRS,WORK12                                          53910003
SWAPLCH  CLC   UCBLCI-UCB(K01,UCBTO4),UCBLCI-UCB(UCBFROM6)              53930003
*                                  ARE LCH INDEXES THE SAME    @ZA12145 54000003
         BNE   DOSWAP              NO, CONTINUE TO SWAP LCH'S  @ZA12145 54010003
         OI    GENAFLAG,GFRRLST+GFRRLEND                       @ZA12145 54020003
*                  INDICATE GOOD SWAP IN SWAP STATUS BITS      @ZA12145 54030003
         B     LCHRET              EXIT IMMEDIATELY            @ZA12145 54040003
DOSWAP   STM   LOC0,BASE15,SWAPSSAV  SAVE REGISTERS            @ZA12145 54050003
         LR    UCBOPT7,UCBTO4      COPY 'TO' UCB               @ZA29054 54100003
         SPACE                                                          54200003
         L     PARM5,FLCCVT        GET CVT ADDR                @ZA12145 54250003
         USING CVT,PARM5                                       @ZA12145 54300003
         L     PARM5,CVTIXAVL      GET IOCOM ADDR              @ZA12145 54350003
         USING IOCOM,IOCOM5                                             54400003
         SPACE                                                          54450003
         BAL   LINK9,LOCKLCH       GO GET LCH LOCK                      54500003
         SPACE                                                          54520003
         OI    GENAFLAG,GFRRLST    SET SWAP STARTED FLAG       @ZA12145 54550003
         TITLE 'IECVGENA - (SWAP) LCH DEQUEUE ROUTINE'                  54600003
*****************************************************************       54650003
*                                                               *       54700003
*        DEQUEUE RELATED IOQE'S FROM LCH AND BUILD A QUEUE      *       54750003
*        IN PREPARATION FOR SUBSEQUENT ENQUEUE THE OTHER LCH.   *       54800003
*                                                               *       54850003
*****************************************************************       54900003
         SPACE                                                          54950003
         LR    WORK10,WORK8        POINT TO QUEUE HEADER                55000003
         LR    IOQE11,LCH1         COPY LCH ADDR                        55050003
ADJPRFX  AL    UCBFROM6,PREFIX     ADJUST TO COMMON UCB        @Y30ANLB 55100003
         SPACE                                                          55150003
NEXTIOQE L     IOQE11,IOQLNK       GET IOQE PTR                         55200003
         XC    IOQLNK-IOQ(K04,WORK10),IOQLNK-IOQ(WORK10)  CLEAR PTR     55250003
         SPACE                                                          55300003
         LTR   IOQE11,IOQE11       IS THERE AN IOQE                     55350003
         BNP   DQEXIT              NO, EXIT NOW                         55400003
         SPACE                                                          55450003
         L     WORK2,IOQIOSB       GET IOSB ADDR                        55500003
         SPACE                                                          55550003
         C     UCBFROM6,IOSUCB     IS THIS RELATED TO 'FROM' DEV        55600003
         BNE   NEXTIOQE            NO, GO CHECK NEXT IOQE               55650003
         SPACE                                                          55700003
         SL    UCBFROM6,PREFIX     ADJUST TO UCB PREFIX        @Y30ANLB 55750003
         SPACE                                                          55800003
         ST    IOQE11,IOQLNK-IOQ(WORK10)  SET BACK POINTER              55850003
         LR    WORK10,IOQE11       SAVE IOQE ADDR                       55900003
         SPACE                                                          55950003
         L     LINK9,IOCIOSDQ      GET DEQUEUE ROUTINE PTR              56000003
         ST    LINK9,SWAPIOS       SAVE FOR COMMON ROUTINE              56050003
         SPACE                                                          56100003
         BAL   LINK9,CALLIOS       GO CALL IOS                          56150003
         SPACE                                                          56200003
         B     ADJPRFX             GO GET NEXT IOQE PTR                 56250003
         SPACE                                                          56300003
DQEXIT   SL    UCBFROM6,PREFIX     ADJUST TO UCB PREFIX        @Y30ANLB 56350003
         SPACE                                                          56400003
         BAL   LINK9,UNLOKLCH      GO RELEASE LOCK                      56450003
         SPACE                                                          56500003
         OC    SWAPQPTR(K04),SWAPQPTR  ANY ON QUEUE                     56550003
         BZ    LCHEXIT             NO, EXIT IMMEDIATELY        @ZA12145 56600003
         TITLE 'IECVGENA - (SWAP) LCH ENQUEUE ROUTINE'                  56650003
*****************************************************************       56700003
*                                                               *       56750003
*        SAVE SAVE AREA POINTER FOR FRR.                        *       56800003
*                                                               *       56850003
*        ACQUIRE LCH LOCK FOR 'FROM' UCB.                       *       56900003
*                                                               *       56950003
*        ENQUEUE RELATED IOQE'S TO LCH AND REMOVE               *       57000003
*        EACH IOQE FROM TEMPORARY QUEUE.                        *       57050003
*                                                               *       57100003
*****************************************************************       57150003
         SPACE                                                          57200003
         LR    UCBOPT7,UCBFROM6    COPY 'FROM' UCB ADDR        @ZA29054 57250003
         SPACE                                                          57300003
         BAL   LINK9,LOCKLCH       GO GET LCH LOCK                      57450003
         SPACE                                                          57500003
NEXTNQ   L     IOQE11,SWAPQPTR     GET IOQE PTR                         57550003
         SPACE                                                          57600003
         LTR   IOQE11,IOQE11       ANY ON QUEUE                         57650003
         BZ    NQEXIT              NO, EXIT                             57700003
         SPACE                                                          57750003
         MVC   SWAPQPTR(K04),IOQLNK  RESET POINTER TO FIRST             57800003
         L     LINK9,IOCIOSEQ      GET ENQUEUE ROUTINE ADDR             57850003
         ST    LINK9,SWAPIOS       SAVE FOR COMMEN ROUTINE              57900003
         SPACE                                                          57950003
         BAL   LINK9,CALLIOS       GO CALL IOS                          58000003
         SPACE                                                          58050003
         B     NEXTNQ              GO GET NEXT IOQE PTR                 58100003
         SPACE                                                          58150003
NQEXIT   BAL   LINK9,UNLOKLCH      GO RELEASE LOCK                      58200003
LCHEXIT  OI    GENAFLAG,GFRRLEND   SET SWAP ENDED FLAG         @ZA12145 58250003
         LM    LOC0,BASE15,SWAPSSAV  RESTORE REGISTERS         @ZA12145 58260003
         SPACE                                                          58300003
LCHRET   BR    RTN14               RETURN TO CALLER            @ZA12145 58350003
         TITLE 'IECVGENA - (SWAP) CALL IOS ENQUEUE AND DEQUEUE'         58400003
*****************************************************************       58450003
*                                                               *       58500003
*        THIS IS A COMMON ROUTINE TO CALL IOS                   *       58550003
*        DEQUEUE AND ENQUEUE ROUTINES.                          *       58600003
*                                                               *       58650003
*        THE FOLLOWING REGISTERS MUST BE SET FOR IOS:           *       58700003
*              LCH1    - LCH ADDR                               *       58750003
*              WORK2   - IOSB ADDR (DEQUEUE ONLY)               *       58800003
*              WORK3   - LCCA ADDR                              *       58850003
*              UCBTO4  - RETURN ADDR                            *       58900003
*              IOCOM5  - IOS BASE A                             *       58950003
*              UCBOPT7 - UCB ADDR                               *       59000003
*              WORK8   - IOS BASE B                             *       59050003
*              LINK9   - IOS BASE C                             *       59100003
*              IOQE11  - IOQE ADDR                              *       59150003
*                                                               *       59200003
*    REGISTER 13 IS GUARANTEED TO REMAIN UNCHANGED BY THE       *       59210003
*     ENQUEUE AND DEQUEUE ROUTINES                              *       59220003
*                                                               *       59250003
*****************************************************************       59300003
         SPACE                                                          59350003
CALLIOS  STM   LINK9,UCBOPT7,SWAPSAVE  SAVE REGS                        59400003
         SPACE                                                          59450003
         LR    SAVE13,WORK8        SAVE SWAPAREA PTR                    59500003
         SPACE                                                          59550003
         LA    WORK8,IOSORG        GET IOS BASE ADDR INCR               59600003
         LR    LINK9,WORK8         COPY OFFSET VALUE                    59650003
         ALR   WORK8,IOCOM5        SET IOS BASE REG B                   59700003
         ALR   LINK9,WORK8         SET IOS BASE REG C                   59750003
         SPACE                                                          59800003
         L     BASE15,SWAPIOS-SWAPWORK(SAVE13)  GET ADDR                59850003
*                                  *OF IOS DEQUEUE                      59900003
*                                  *OR ENQUEUE ROUTINE                  59950003
         BALR  UCBTO4,BASE15        CALL IOS ROUTINE                    60000003
         SPACE                                                          60050003
         LR    WORK8,SAVE13        RESTORE SAVEAREA PTR                 60100003
         SPACE                                                          60150003
         LM    LINK9,UCBOPT7,SWAPSAVE  RESTORE REGS                     60200003
         SPACE                                                          60250003
         BR    LINK9               RETURN                               60300003
         TITLE 'IECVGENA - (SWAP) OBTAIN LCH ADDRESS AND LOCK'          60350003
*****************************************************************       60400003
*                                                               *       60450003
*        OBTAIN LCH ADDRESS                                     *       60500003
*                                                               *       60550003
*        OBTAIN LCH LOCK                                        *       60600003
*                                                               *       60650003
*        SAVE LCCA ADDRESS IN FRR PARAMETER                     *       60700003
*                                                               *       60750003
*****************************************************************       60800003
         SPACE                                                          60850003
         USING LCCA,WORK3                                               60870003
         USING IOQ,IOQE11                                               60900003
LOCKLCH  L     LCH1,IOCLCHTB       POINT AT LCH TABLE                   60950003
         SLR   WORK10,WORK10       CLEAR REG                            61000003
         IC    WORK10,UCBLCI       GET LCH INDEX                        61050003
         SLL   WORK10,LCHELP2      MULTIPLY BY LENGTH OF LCH            61100003
         ALR   LCH1,WORK10         POINT AT CORRECT LCH                 61150003
         SPACE                                                          61200003
         STM   IOQE11,RTN14,SWAPSAVE  SAVE REGS 11 THRU 14              61250003
         OI    GENAFLAG,GFRRLLOK   TURN ON LOCK HELD INDICATOR @ZA12145 61270003
         SPACE                                                          61300003
         LA    IOQE11,LCHLOCK      POINT AT THE LOCK                    61350003
         ST    IOQE11,GENAFLOK     SAVE LOCKWORD IN FRRWA      @ZA12145 61420003
         SPACE                                                          61450003
         SETLOCK OBTAIN,TYPE=IOSLCH,MODE=UNCOND,ADDR=(11),             *61500003
               RELATED=(LCH,IECVGENA(UNLOKLCH,IOSGEN))                  61550003
         SPACE                                                          61555003
         L     WORK3,PSALCCAV      GET VIRT ADDR OF LCCA                61560003
         L     IOQE11,GENAFLOK     RESTORE LOCK ADDRESS        @ZA29051 61570003
         ST    IOQE11,IRTLCH       SHOW WHICH LOCK HELD        @ZA29051 61580003
         OI    IRTFLA,IRTLLCK      SHOW LCH LOCK HELD          @ZA29051 61590003
         SPACE                                                          61600003
         LM    IOQE11,RTN14,SWAPSAVE  RESTORE REGS 11 THRU 14           62000003
         SPACE                                                          62050003
         BR    LINK9               RETURN TO CALLER                     62100003
         TITLE 'IECVGENA - (SWAP) RELEASE LCH LOCK ROUTINE'             62150003
*****************************************************************       62200003
*                                                               *       62250003
*        RELEASE LCH LOCK                                       *       62300003
*                                                               *       62350003
*****************************************************************       62400003
         SPACE                                                          62450003
UNLOKLCH STM   IOQE11,RTN14,SWAPSAVE  SAVE REGS 11 THRU 14              62500003
         SPACE                                                          62600003
         LA    IOQE11,LCHLOCK      POINT AT LOCK                        62650003
         NI    IRTFLA,XFF-IRTLLCK  TURN OFF LOCK HELD INDICATOR IN IRT  62660003
*                                  WHILE STILL DISABLED        @ZA29051 62670003
         SPACE                                                          62700003
         SETLOCK RELEASE,TYPE=IOSLCH,ADDR=(11),                        *62750003
               RELATED=(LCH,IECVGENA(LOCKLCH,IOSGEN))                   62800003
         SPACE                                                          63000003
         LM    IOQE11,RTN14,SWAPSAVE  RESTORE REGS 11 THRU 14           63050003
         NI    GENAFLAG,XFF-GFRRLLOK  TURN OFF LOCK HELD INDIC @ZA12145 63070003
         SPACE                                                          63100003
         BR    LINK9               RETURN TO CALLER                     63150003
         SPACE                                                          63200003
         DROP  LOC0,LCH1,WORK2,WORK3,IOCOM5,UCBOPT7,WORK8,IOQE11        63250003
         TITLE 'IECVGENA - SIMULATE I/O INTERRUPT'             @ZA16163 63252003
************************************************************** @ZA16163 63253003
*                                                            * @ZA16163 63254003
*  BUILD SPECIAL I/O OLD PSW FOR RETURN FROM FORCED INTERRUPT* @ZA16163 63255003
*                                                            * @ZA16163 63256003
************************************************************** @ZA16163 63257003
         SPACE                                                          63264003
         USING PSA,0                                           @ZA16163 63265003
SIMINT   STNSM PSASYMSK,PSWDIS     DISABLE FOR INTERRUPTS      @ZA16163 63266003
         LTR   RUCB,RUCB           IS UCB ADDR VALID?          @ZA16163 63267003
         BP    SIMUCB              YES--GO MOVE DEVICE ADDR    @ZA16163 63268003
         LPR   REG,RUCB            NO--GET DEVICE ADDR         @ZA16163 63269003
         STH   REG,FLCIOAA+1       SET DEVICE ADDR             @ZA16163 63270003
         B     SIMCONT             SKIP SETTING FROM UCB       @ZA16163 63271003
SIMUCB   MVC   FLCIOAA+1(K02),UCBCHAN-UCBOB(RUCB)              @ZA16163 63272003
*                                  *PUT DEVICE ADDR IN I/O ADDR@ZA16163 63273003
SIMCONT  NI    FLCIOAA+1,MASKOF    ZERO FIRST HALF             @ZA16163 63274003
*                                  *OF BYTE                    @ZA16163 63275003
         SPACE                                                          63286003
         IC    REG,PSASYMSK        GET SYSTEM MASK             @ZA16163 63288003
         STC   REG,FLCIOPSW        AND SET IN OLD PSW          @ZA16163 63290003
         ST    RTN14,FLCIOPSW+K04  STORE EXIT                  @ZA16163 63292003
*                                  *ADDR INTO I/O OLD PSW      @ZA16163 63294003
         SPACE                                                          63301003
         MVN   FLCIOPSW+K02(K01),FLCIOPSW+K04                           63301203
*                                  *SET PROGRAM MASK           @ZA16163 63301403
         NI    FLCIOPSW+K02,MASKOF ZERO REQUIRED BITS          @ZA16163 63301503
         XC    FLCIOPSW+K03(K02),FLCIOPSW+K03                           63301603
*                                  *ZERO REQUIRED FIELDS       @ZA16163 63301803
         MVI   FLCIOPSW+K01,PSWMCEC ALLOW MACHINE              @ZA16163 63302303
*                                  *CHECK INTERRUPTS           @ZA16163 63302803
         SPACE                                                          63304003
************************************************************** @ZA16163 63305003
*                                                            * @ZA16163 63305803
*        BUILD CSW FOR FORCED INTERRUPT                      * @ZA16163 63306603
*        SET UP DEVICE END IN CSW IF NECESSARY               * @ZA16163 63307403
*        GO TO I/O FIRST LEVEL INTERRUPT HANDLER VIA LPSW    * @ZA16163 63308203
*                                                            * @ZA16163 63309003
************************************************************** @ZA16163 63309803
         SPACE                                                          63312003
         SLR   REG,REG             CLEAR REG                   @ZA16163 63313003
         ST    REG,FLCCSW          ZERO FIRST WORD OF CSW      @ZA16163 63313703
         ST    REG,FLCCSW+K04      ZERO SECOND                 @ZA16163 63314403
         SPACE                                                          63316003
         LTR   RUCB,RUCB           IS UCB ADDR VALID?          @ZA16163 63317003
         BM    SIMLPSW             NO--SKIP UCB TEST           @ZA16163 63317803
         TM    UCBFLA-UCBOB(RUCB),UCBPST  IS POST FLAG ON      @ZA16163 63318603
         BO    SIMLPSW             YES, GIVE CHANNEL AVAILABLE @ZA16163 63319403
         SPACE                                                          63321003
         TM    UCBFLA-UCBOB(RUCB),UCBBSY+UCBNRY  ARE           @ZA16163 63322003
*                                  *BUSY OR NO READY 'ON'      @ZA16163 63322703
         BZ    SIMLPSW             NO, GIVE CHANNEL AVAILABLE  @ZA16163 63323403
         SPACE                                                          63325003
         OI    FLCCSW+K04,CSWDE MOVE DUMMY                     @ZA16163 63326003
*                                  *DEVICE END STATUS INTO CSW @ZA16163 63326603
         SPACE                                                          63328003
SIMLPSW  EQU   *                                               @ZA16163 63329003
         LPSW  FLCINPSW            GO TO I/O INTERRUPT ROUTINE @ZA16163 63329603
         SPACE                                                          63331003
*  THE I/O FLIH RETURNS DIRECTLY TO THE CALLER                 @ZA16163 63332003
         TITLE 'IECVGENA - ADD FRR SUBROUTINE'                          63333003
*****************************************************************       63350003
*                                                               *       63400003
*        ADD FRR TO FRR STACK                                   *       63450003
*              SAVE ENTRY POINT ADDRESS (REG 15)                *       63500003
*              SAVE PARAMETER POINTER (REG 5)                   *       63550003
*              SAVE SAVE AREA POINTER (REG 2)                   *       63600003
*              LOCK WORDS ARE SAVED IN LOCK SUBROUTINE          *       63650003
*                                                               *       63700003
*****************************************************************       63750003
         SPACE                                                          63800003
ADDFRR   LA    BLKLOK11,GENAFRR    GET FRR ROUTINE ADDR                 63850003
         SPACE                                                          63900003
         SETFRR A,FRRAD=(11),PARMAD=(12),WRKREGS=(12,13)                63950003
         SPACE                                                          64000003
         USING GENAFRRS,WORK12                                          64050003
         ST    BASE15,GENAFBAS     SAVE IECVGENA ENTRY POINT            64100003
         ST    PARM5,GENAFR05      SAVE PARAMETER PTR                   64150003
         ST    WORK2,GENAFR13      SAVE SAVE AREA PTR                   64200003
         DROP  WORK12                                                   64250003
         SPACE                                                          64300003
         BR    RTN14               RETURN TO CALLING SUBROUTINE         64350003
         TITLE 'IECVGENA - DELETE FRR SUBROUTINE'                       64400003
*****************************************************************       64450003
*                                                               *       64500003
*        DELETE FRR FROM FRR STACK                              *       64550003
*                                                               *       64600003
*****************************************************************       64650003
         SPACE                                                          64700003
DELFRR   SETFRR D,WRKREGS=(12,13)                                       64750003
         SPACE                                                          64800003
         BR    RTN14               RETURN TO CALLING SUBROUTINE         64850003
         TITLE 'IECVGENA - EPILOG'                                      64900003
*****************************************************************       64950003
*                                                               *       65000003
*        EPILOG                                                 *       65050003
*                                                               *       65100003
*****************************************************************       65150003
         SPACE                                                          65200003
NOLOCK   BR    RTN14               RETURN TO CALLER                     65250003
         TITLE 'IECVGENA - DEFINED CONSTANTS'                           65300003
*****************************************************************       65350003
*                                                               *       65400003
*        IECVGENA DEFINED CONSTANTS                             *       65450003
*                                                               *       65500003
*****************************************************************       65550003
         SPACE                                                          65600003
         DS    0F                                                       65650003
HOHWMASK DC    X'0000FF00'         (V) HIGH ORDER HALFWORD MASK         65700003
PATHTEST DC    X'0000F000'         (V) ALL PATHS OFFLINE MASK           65750003
PATHBMSK DC    X'0000000F'         (V) PATH BIT MASK                    65800003
CSANDCHM DC    X'00FFFFFF'         (V) CHANNEL ANDING MASK              65850003
GENMASK  DC    X'0000FFFF'         (V) PATH ANDING MASK        @YM08184 65900003
PREFIX   DC    F'512'              (S) UCB PREFIX/COMMON OFFSET@Y30ANLB 65950003
         SPACE                                                          66000003
         DROP  BASE15                                                   66050003
         TITLE 'IECVGENA - FUNCTIONAL RECOVERY ROUTINE'                 66100003
*****************************************************************       66150003
*                                                               *       66200003
*        FUNCTIONAL RECOVERY ROUTINE                            *       66250003
*                                                               *       66300003
*        ESTABLISH ADDRESSABILITY                               *       66350003
*                                                               *       66400003
*        PERFORM BASIC INITIALIZATION                           *       66450003
*                                                               *       66500003
*****************************************************************       66550003
         SPACE                                                          66600003
         USING IECVGENA,WORK12                                          66650003
         USING SDWA,SAVE13                                              66700003
         USING GENAFRRS,PARM5                                           66750003
         SPACE                                                          66800003
GENAFRR  LR    SAVE13,RSRC1        GET ADDR OF SDWA                     66850003
         LR    LINK9,RTN14         GET RETURN ADDR                      66900003
         L     PARM5,SDWAPARM      SET PTR TO PARAMETERS                66950003
         L     WORK12,GENAFBAS     REESTABLISH ADDRESSABILITY           67000003
         SPACE                                                          67050003
         SETRP RECORD=YES,WKAREA=(RSRC1)                       @ZA12145 67100003
         EJECT                                                          67150003
*****************************************************************       67200003
*                                                               *       67250003
*        RELEASE UCB LOCK                                       *       67300003
*                                                               *       67350003
*****************************************************************       67400003
         SPACE                                                          67450003
         TM    GENAFLAG,GFRRULOK   UCB LOCK HELD?              @ZA12145 67470003
         BZ    GENAFRR1            NO, TEST FOR LCH LOCK                67550003
         L     BLKLOK11,GENAFLOK   GET LOCKWORD ADDR           @ZA12145 67570003
         ST    BLKLOK11,SDWAIULW   SET UCB LOCKWORD                     67577003
         OI    SDWAACF4,SDWAIUCB   INDICATE UCBLOCK HELD       @ZA12145 67584003
         SPACE                                                          67600003
         B     GENAFRR2            GO FINISH UP                         67800003
         SPACE                                                          67850003
*****************************************************************       67900003
*                                                               *       67950003
*        RELEASE LCH LOCK                                       *       68000003
*                                                               *       68050003
*****************************************************************       68100003
         SPACE                                                          68150003
         USING LCCA,WORK3                                               68200003
         SPACE                                                          68250003
GENAFRR1 TM    GENAFLAG,GFRRLLOK   LCH LOCK HELD?              @ZA12145 68270003
         BZ    GENAFRR2            NO                          @ZA12145 68350003
         SPACE                                                          68400003
         L     BLKLOK11,GENAFLOK   GET LOCKWORD ADDR           @ZA12145 68420003
         ST    BLKLOK11,SDWAILLW   SET LCH LOCKWORD                     68450003
         OI    SDWAACF4,SDWAILCH   INDICATE LCH LOCK HELD      @ZA12145 68480003
         SPACE                                                          68550003
         DROP  WORK3                                                    68700003
         EJECT                                                          68750003
*****************************************************************       68800003
*                                                               *       68850003
*        RECORD VARIABLE INFORMATION                            *       68900003
*                                                               *       68950003
*****************************************************************       69000003
         SPACE                                                          69050003
GENAFRR2 LM    WORK7,WORK8,CSECTMOD  GET CSECT/MODULE NAME              69100003
         STM   WORK7,WORK8,SDWAVRA   STORE MODULE NAME                  69150003
         SPACE                                                          69200003
         LA    WORK2,K08           GET LENGTH OF VARIABLE AREA          69250003
         STC   WORK2,SDWAVRAL      SET LENGTH IN SDWA                   69300003
         SPACE                                                          69350003
         TM    SDWAERRC,SDWAPERC   HAS PERCOLATION OCCURED              69400003
         BO    GENAFRR3            YES, EXIT IMMEDIATELY                69450003
         SPACE                                                          69500003
*****************************************************************       69550003
*                                                               *       69600003
*        RECORD MODULE IDENTIFICATION                           *       69650003
*                                                               *       69700003
*****************************************************************       69750003
         SPACE                                                          69800003
         STM   WORK7,WORK8,SDWAMODN  SHOW MODULE NAME                   69850003
         STM   WORK7,WORK8,SDWACSCT  SHOW CSECT NAME                    69900003
         SPACE                                                          69950003
         CLI   SDWAFMID,FMIDTEST   HAS ADDRESS SPACE FAILED             70000003
         BNE   GENAFRR3            YES, SKIP DUMP                       70050003
         EJECT                                                          70100003
*****************************************************************       70150003
*                                                               *       70200003
*        CHECK 4K BUFFER AVAILABILITY                           *       70250003
*                                                               *       70300003
*****************************************************************       70350003
         SPACE                                                          70400003
         USING CVT,CVT6                                                 70450003
         SPACE                                                          70500003
         L     CVT6,CVTPTR         GET CVT PTR                          70550003
         L     WORK2,CVTSDBF       GET 4K BUFFER ADDR                   70600003
         LA    WORK2,0(WORK2)      CLEAR HIGH ORDER BYTE                70650003
         L     WORK3,LOCKSDBF      SET HIGH ORDER BIT ON                70700003
         OR    WORK3,WORK2         CREATE LOCKED BUFFER PTR             70750003
         SPACE                                                          70800003
         CS    WORK2,WORK3,CVTSDBF  ATTEMPT SWAP                        70850003
         BNZ   GENAFRR3            SWAP FAILED, EXIT NOW                70900003
         EJECT                                                          70950003
*****************************************************************       71000003
*                                                               *       71050003
*        SET UP DUMP BUFFER                                     *       71100003
*                                                               *       71150003
*****************************************************************       71200003
         SPACE                                                          71250003
         USING SDBF,WORK2                                               71300003
         USING SFRRPARM,WORK7                                           71350003
         USING SFRRSAVE,WORK8                                           71400003
         SPACE                                                          71450003
         LM    WORK7,WORK8,GENAFR05  GET PARAMETER AND                  71500003
*                                  *SAVE AREA POINTERS                  71550003
         SPACE                                                          71600003
         LA    WORK10,SDBFSTRT     POINT PAST HEADER                    71650003
         ST    WORK10,SDBFPTR      SHOW DUMP START POINT                71700003
         SPACE                                                          71750003
         LA    WORK10,SDBFLNTH     GET SIZE OF DUMP                     71800003
*                                  *MUST NOT EXCEED 4090 BYTES          71850003
         STH   WORK10,SDBFCNT      SHOW BYTE COUNT                      71900003
         SPACE                                                          71950003
         MVC   SDBFPARM(LFRRPARM),SFRRPARM  COPY POSSIBLE               72000003
*                                  *VARY PARAMETERS                     72050003
         MVC   SDBFSAVE(LFRRSAVE),SFRRSAVE  COPY 16/18                  72100003
*                                  *WORD SAVE AREA                      72150003
         SPACE                                                          72200003
         LA    BLKLOK11,SDWALEN    GET SDWA LENGTH                      72250003
         LR    BASE15,BLKLOK11     COPY SDWA LENGTH                     72300003
         LA    WORK10,SDBFSDWA     GET BUFFER LOCATION                  72350003
         LR    RTN14,SAVE13        POINT TO SDWA START                  72400003
         MVCL  WORK10,RTN14        COPY SDWA TO BUFFER                  72450003
         MVC   SDBFRRWA(GENASIZE),GENAFRRS                     @ZA12145 72460003
*                               SAVE 6-WORD FRR PARM AREA      @ZA12145 72470003
         SPACE                                                          72500003
         USING PSA,LOC0                                                 72850003
         L     WORK10,PSAAOLD      GET CURRENT ASCB ADDR                72900003
         DROP  LOC0                                                     72950003
         SPACE                                                          73000003
         USING ASCB,WORK10                                              73050003
         LH    BLKLOK11,ASCBASID   GET ASID                             73100003
         DROP  WORK10                                                   73150003
         EJECT                                                          73200003
*****************************************************************       73250003
*                                                               *       73300003
*        ISSUE ASYNCHRONOUS SVC DUMP                            *       73350003
*                                                               *       73400003
*****************************************************************       73450003
         SPACE                                                          73500003
         LR    WORK2,SAVE13        SAVESDWA ADDRESS            @ZA12145 73520003
         LA    SAVE13,SDWAVRA+K08  GET SAVE AREA IN VARIABLE            73550003
*                                  *RECORDING AREA OF SDWA              73600003
         SPACE                                                          73650003
         SDUMP ASID=(11),                                              *73700003
               SDATA=(RGN,LPA,TRT),                                    *73750003
               BUFFER=YES,                                             *73800003
               BRANCH=YES                                               73850003
         SPACE                                                          73900003
GENAFRR3 TM    GENAFLAG,GFRRSWAP   SWAP FUNCTION ACTIVE?       @ZA12145 73910003
         BZ    GENAFRR4            NO, SKIP RETRY              @ZA12145 73920003
         TM    GENAFLAG,GFRRSTAT   WHAT IS STATUS OF SWAP      @ZA12145 73950003
         BNO   GENAFRR4            BAD,PERC TO DDR TO TERMNATE @ZA12145 73980003
         L     BASE15,GENAFBAS     RESTORE BASE REG            @ZA12145 74020003
         L     WORK8,GENAWORK      RESTORE WORK AREA ADDR      @ZA12145 74030003
         LR    RSRC1,WORK2         RESTORE SDWA PTR            @ZA12145 74031003
         L     SAVE13,GENAFR13     RESTORE SAVE AREA ADDR      @ZA12145 74034003
         L     RTN14,GENAFR05      RESTORE RETURN ADDR         @ZA12145 74038003
         ST    PARM5,SDWASR03      SAVE RETRY REGS IN SDWA     @ZA12145 74042003
         STM   SAVE13,BASE15,SDWASR13                          @ZA12145 74046003
         SPACE                                                          74048003
         SETRP RC=4,RETADDR=GOODRET,RETREGS=YES,RECORD=YES     @ZA12145 74050003
         SPACE                                                          74070003
GENAFRR4 BR    LINK9               RETURN TO RECOVERY MANAGER           74100003
         SPACE                                                          74150003
         DROP  WORK2,PARM5,CVT6,WORK7,WORK8,SAVE13                      74200003
         TITLE 'IECVGENA - SIGP ROUTINE'                                74250003
*****************************************************************       74252003
*                                                               *       74254003
*        THIS ROUTINE GETS CONTROL VIA THE RISGNL MACRO WHEN    *       74256003
*        A MULTI-PROCESSOR; OR WHEN A UNI-PROCESSOR, IS ENTERED *       74258003
*        VIA BALR FROM THE SWAP ROUTINE.                      *@ZA12145 74259003
*        THE FUNCTION OF THIS ROUTINE IS TO SWAP THE UCB FIELDS,*       74262003
*        THE COMMON EXTENSION FIELDS AND THE DEVICE STATISTICS  *       74264003
*        TABLE.                                                 *       74266003
*        THIS CODE WAS MOVED OVER FROM IOSGEN WITH THE FOLLOWING*       74268003
*        ADDITIONS:                                             *       74270003
*        -1. SWAP STARTED AND ENDING FLAGS ARE SET AT THE       *       74272003
*            BEGINNING AND END OF THE SWAP TO BE TESTED BY THE  *       74274003
*            FRR IN CASE OF AN ERROR.                           *       74276003
*        -2. ALL ACTIVE BITS OF THE 'FROM' AND 'TO' UCB'S ARE   *       74278003
*            TESTED PRIOR TO BEGINNING THE SWAP TO MAKE SURE    *       74280003
*            THAT THE DEVICES ARE QUIESCED.                     *       74282003
*                                                               *       74284003
*****************************************************************       74286003
         SPACE                                                          74293003
GENASIGP EQU   *                                              *@ZA12145 74300003
         USING IECVGENA,BASE15                                *@ZA12145 74320003
         USING GENAFRRS,IOQE11                                *@ZA12145 74340003
         LR    IOQE11,WORK1           GET PARAMETER ADDRESS   *@ZA12145 74355003
         TM    GENAFLG2,GFRRBRCH      WHAT KIND OF ENTRY ?    *@ZA12145 74364003
         BNZ   BEGINSWP               IF BALR,DONT RELOAD REGS*@ZA12145 74368003
         L     BASE15,GENAFBAS        ESTABLISH ADDRESSABILITY*@ZA12145 74370003
         L     WORK8,GENAWORK         IF RISGNL,GET SWAPAREA  *@ZA12145 74372003
         USING SWAPWORK,WORK8                                 *@ZA12145 74376003
         L     UCBTO4,SWAPSR04        ADDR OF 'TO' UCB        *@ZA12145 74380003
         L     UCBFROM6,SWAPSR06      ADDR OF 'FROM' UCB      *@ZA12145 74384003
BEGINSWP L     WORK12,CVTPTR(0,0)     GET CVT PTR AGAIN        @ZA12145 74400403
         LA    UCBTO4,K512(0,UCBTO4)  ADJUST TO COMMON UCB     @ZA12145 74400603
         LA    UCBFROM6,K512(0,UCBFROM6) ADJUST TO COMMON UCB  @ZA12145 74400803
         SPACE                                                          74401003
*****************************************************************       74402003
*        TEST UCB ACTIVE BITS -UCBBSY,UCBPST,UCBPSNS,UCBSAP,    *       74404003
*                              UCBACTV,UCBASNS,UCBSPST.       *@ZA12145 74406003
*        IF ALL ARE OFF, PROCEED WITH SWAP; OTHERWISE SET FLAG  *       74408003
*        FOR CALLING ROUTINE INDICATING THAT THE SWAP WAS NOT   *       74410003
*        DONE.                                                  *       74412003
*****************************************************************       74414003
         SPACE                                                          74416003
         TM    UCBFLA-UCBOB(UCBFROM6),ACTIVA  'FROM' UCBFLA   *@ZA12145 74418003
         BNZ   SETACTV                IF ANY ON, GO SET FLAG  *@ZA12145 74428003
         TM    UCBFLA-UCBOB(UCBTO4),ACTIVA  'TO' UCBFLA       *@ZA12145 74438003
         BZ    SWAP0010               OKAY, PROCEED WITH SWAP *@ZA12145 74488003
SETACTV  OI    GENAFLAG,GFRRACTV      SET UCB ACTIVE FLAG     *@ZA12145 74498003
*                                     FOR CALLER              *@ZA12145 74508003
         B     SWAPRET2               EXIT IMMEDIATELY        *@ZA12145 74518003
         SPACE                                                          74650003
*****************************************************************       74700003
*                                                               *       74750003
*        SWAP UCB ADDRESSES IN UCB LOOK-UP TABLE               @ZA12145 74800003
*                                                               *       74850003
*****************************************************************       74900003
         SPACE                                                          74950003
SWAP0010 OI    GENAFLAG,GFRRUST  SET SWAP STARTED FLAG        *@ZA12145 75000003
         L     WORK2,CVTILK2-CVTMAP(0,WORK12)                  @ZA12145 75030003
*                                  *GET UCB LOOKUP TABLE ADDR  @ZA12145 75100003
SWAP0020 LH    UCBOPT7,0(0,WORK2)  GET UCB ADDR                @ZA12145 75150003
         LTR   UCBOPT7,UCBOPT7     IS THIS VALID ADDR          @ZA12145 75200003
         BZ    SWAP0040            NO, FILLER                  @ZA12145 75250003
         BM    SWAP0028            TEST FOR END OF TBL@Z30ANLB,@ZA12145 75280003
         SPACE                                                          75350003
SWAP0025 CR    UCBOPT7,UCBFROM6    IS THIS 'FROM' UCB @Z30ANLB,@ZA12145 75400003
         BNE   SWAP0030            NO, GO TEST 'TO'            @ZA12145 75430003
         STH   UCBTO4,0(0,WORK2)   SET EQUAL TO 'TO' ADDR      @ZA12145 75500003
         B     SWAP0040            CONTINUE                    @ZA12145 75550003
         SPACE                                                          75600003
SWAP0028 CH    UCBOPT7,SWAP0FF     END OF TABLE       @Z30AALB,@ZA12145 75650003
         BE    SWAP0050            YES, GO COPY BYTES @Z30AALB,@ZA12145 75690003
         N     UCBOPT7,SWAP0MSK   AND OFF PROP'D BITS @Z30AALB,@ZA12145 75730003
         B     SWAP0025            CONT MAIN PATH     @Z30ANLB,@ZA12145 75770003
SWAP0030 CR    UCBOPT7,UCBTO4      IS THIS 'TO' UCB            @ZA12145 75810003
         BNE   SWAP0040            NO, CONTINUE                         75850003
         STH   UCBFROM6,0(0,WORK2)  SET EQUAL TO 'FROM' ADDR   @ZA12145 75950003
SWAP0040 LA    WORK2,K02(0,WORK2)                              @ZA12145 76000003
*                                  *BUMP UCB LOOK UP TABLE PTR @ZA12145 76050003
         B     SWAP0020            GO CHECK NEXT UCB ADDR      @ZA12145 76100003
*********************************************************************** 76150003
*                                                                     * 76200003
*        CONSTANT FOR SWAP FUNCTION, LOCATED HERE TO ALLEVIATE AN     * 76250003
*        EXTRA BRANCH INSTRUCTION AROUND IT.                   @ZA12145 76300003
*                                                                     * 76350003
*********************************************************************** 76400003
         SPACE                                                          76450003
SWAP0MSK DS    0F                                     @Z30AALB,@ZA12145 76500003
         DC    X'0000'             FULLWORD AND'G MASK@Z30AALB,@ZA12145 76550003
SWAP0FF  DC    X'FFFF'             HALFWD CONST TO TST@Z30AALB,@ZA12145 76600003
*                                  *END OF UCB TABLE  @Z30AALB,@ZA12145 76650003
         SPACE                                                          76700003
*****************************************************************       76750003
*                                                               *       76800003
*        SAVE 'FROM' COMMON SEGMENT PLUS PORTION OF DEVICE      *       76850003
*        DEPENDENT SECTION IN 'WORK AREA'.                      *       76900003
*        SWAP UCB FIELDS FROM 'TO' TO 'FROM' DEVICES.          @ZA12145 76950003
*                                                               *       77000003
*****************************************************************       77050003
         SPACE                                                          77100003
SWAP0050 MVC   0(UCBDMCT-UCBOB,WORK8),0(UCBFROM6) COPY ALL BYTES        77150003
*                                  *POSSIBLE AFFECTED BY SWAP           77200003
*                                  *'FROM' TO 'WORK AREA'      @ZA12145 77250003
         MVC   UCBCHAN-UCBOB(K02,UCBFROM6),UCBCHAN-UCBOB(UCBTO4)        77300003
*                                                              @ZA12145 77350003
         MVC   UCBFLA-UCBOB(K01,UCBFROM6),UCBFLA-UCBOB(UCBTO4)          77400003
*                                                              @ZA12145 77450003
         MVC   UCBFLB-UCBOB(K01,UCBFROM6),UCBFLB-UCBOB(UCBTO4)          77500003
*                                                              @ZA12145 77550003
         MVC   UCBCHM-UCBOB(K01,UCBFROM6),UCBCHM-UCBOB(UCBTO4)          77600003
*                                                              @ZA12145 77650003
         MVC   UCBCNT-UCBOB(K01,UCBFROM6),UCBCNT-UCBOB(UCBTO4)          77700003
*                                                              @ZA12145 77750003
         MVC   UCBLCI-UCBOB(K01,UCBFROM6),UCBLCI-UCBOB(UCBTO4)          77800003
*                                                              @ZA12145 77850003
         MVC   UCBCPU-UCBOB(K01,UCBFROM6),UCBCPU-UCBOB(UCBTO4)          77900003
*                                                              @ZA12145 77950003
         MVC   UCBNAME-UCBOB(K03,UCBFROM6),UCBNAME-UCBOB(UCBTO4)        78000003
*                                                              @ZA12145 78050003
         MVC   UCBTBYT1-UCBOB(K01,UCBFROM6),UCBTBYT1-UCBOB(UCBTO4)      78100003
*                                                     @XL03167,@ZA12145 78150003
         MVC   UCBTBYT3-UCBOB(K01,UCBFROM6),UCBTBYT3-UCBOB(UCBTO4)      78200003
*                                                     @XL03167,@ZA12145 78250003
         MVC   UCBTBYT4-UCBOB(K01,UCBFROM6),UCBTBYT4-UCBOB(UCBTO4)      78300003
*                                                     @XL03167,@ZA12145 78350003
         MVC   UCBFLC-UCBOB(K01,UCBFROM6),UCBFLC-UCBOB(UCBTO4)          78400003
*                                                              @ZA12145 78450003
         SPACE                                                          78500003
*****************************************************************       78550003
*                                                               *       78600003
*        SWAP UCB FIELDS FROM 'WORK AREA' TO 'TO' DEVICE.      @ZA12145 78650003
*                                                               *       78700003
*****************************************************************       78750003
         SPACE                                                          78800003
         MVC   UCBCHAN-UCBOB(K02,UCBTO4),UCBCHAN-UCBOB(WORK8)  @ZA12145 78850003
         MVC   UCBFLA-UCBOB(K01,UCBTO4),UCBFLA-UCBOB(WORK8)    @ZA12145 78900003
         MVC   UCBFLB-UCBOB(K01,UCBTO4),UCBFLB-UCBOB(WORK8)    @ZA12145 78950003
         MVC   UCBCHM-UCBOB(K01,UCBTO4),UCBCHM-UCBOB(WORK8)    @ZA12145 79000003
         MVC   UCBCNT-UCBOB(K01,UCBTO4),UCBCNT-UCBOB(WORK8)    @ZA12145 79050003
         MVC   UCBLCI-UCBOB(K01,UCBTO4),UCBLCI-UCBOB(WORK8)    @ZA12145 79100003
         MVC   UCBCPU-UCBOB(K01,UCBTO4),UCBCPU-UCBOB(WORK8)    @ZA12145 79150003
         MVC   UCBNAME-UCBOB(K03,UCBTO4),UCBNAME-UCBOB(WORK8)  @ZA12145 79200003
         MVC   UCBTBYT1-UCBOB(K01,UCBTO4),UCBTBYT1-UCBOB(WORK8)         79250003
*                                                     @XL03167,@ZA12145 79300003
         MVC   UCBTBYT3-UCBOB(K01,UCBTO4),UCBTBYT3-UCBOB(WORK8)         79350003
*                                                     @XL03167,@ZA12145 79400003
         MVC   UCBTBYT4-UCBOB(K01,UCBTO4),UCBTBYT4-UCBOB(WORK8)         79450003
*                                                     @XL03167,@ZA12145 79500003
         MVC   UCBFLC-UCBOB(K01,UCBTO4),UCBFLC-UCBOB(WORK8)    @ZA12145 79550003
         SPACE                                                          79600003
*********************************************************************** 79650003
*  SWAP 'FROM' AND 'TO' UCBIOQ FIELDS                 @YM08050,@ZA12145 79700003
*********************************************************************** 79750003
         SPACE                                                          79800003
         LA    WORK1,K512(0,0)                        @YM08050,@ZA12145 79850003
         LR    WORK2,UCBFROM6                         @YM08050,@ZA12145 79900003
         SLR   WORK2,WORK1                            @YM08050,@ZA12145 79950003
         LR    WORK10,UCBTO4                          @YM08050,@ZA12145 80000003
         SLR   WORK10,WORK1                           @YM08050,@ZA12145 80050003
*                                                     @YM08040,@ZA12145 80100003
         XC    UCBIOQ-UCB(K04,WORK10),UCBIOQ-UCB(WORK2)                 80150003
*                                                     @YM08050,@ZA12145 80200003
         XC    UCBIOQ-UCB(K04,WORK2),UCBIOQ-UCB(WORK10)                 80250003
*                                                     @YM08050,@ZA12145 80300003
         XC    UCBIOQ-UCB(K04,WORK10),UCBIOQ-UCB(WORK2)                 80350003
         SPACE                                                          80400003
*****************************************************************       80450003
*                                                               *       80500003
*        UCBJBNR - SWAP ALL BUT UCBMONT.                       @ZA12145 80550003
*        UCBFL5  - SWAP ALL BUT UCBNALOC.                      @ZA12145 80600003
*                                                               *       80650003
*****************************************************************       80700003
         SPACE                                                          80750003
SWAP005A LA    WORK10,MSKON(0,0)   MASK TO LEAVE 'ON' @YM08050,@ZA12145 80800003
*                                  *UCBMONT AND UCBNALOC ONLY  @ZA12145 80850003
         LH    WORK1,SWAP0OFF      GET MASK TO TURN 'OFF'      @ZA12145 80900003
*                                  *UCBMONT AND UCBNALOC ONLY  @ZA12145 80950003
         LH    WORK2,UCBJBNR-UCBOB(0,UCBFROM6) GET 'FROM'      @ZA12145 81000003
*                                  *UCBJBNR AND UCBFL5         @ZA12145 81050003
         LH    WORK3,UCBJBNR-UCBOB(0,UCBTO4) GET 'TO'          @ZA12145 81100003
*                                  *UCBJBNR AND UCBFL5         @ZA12145 81150003
         NR    WORK10,WORK2        ONLY 'FROM' UCBMONT & UCBNALOC 'ON'  81200003
*                                  *TURN 'OFF' OTHER BITS IN 'FROM'     81250003
         NR    WORK1,WORK3         ONLY 'TO' UCBMONT & UCBNALOC 'OFF'   81300003
*                                  *LEAVE 'ON' OTHER BITS IN 'TO'       81350003
         OR    WORK10,WORK1        MERGE 'FROM' UCBMONT & UCBNALOC      81400003
*                                  *WITH 'TO' ALL OTHERS BITS           81450003
         STH   WORK10,UCBJBNR-UCBOB(0,UCBFROM6) SWAP 'TO'      @ZA12145 81500003
*                                  *UCBJBNR & UCBFL5           @ZA12145 81550003
         LA    WORK10,MSKON(0,0)   GET MASK TO LEAVE 'ON'      @ZA12145 81600003
*                                  *UCBMONT AND UCBNALOC ONLY  @ZA12145 81650003
         LH    WORK1,SWAP0OFF       GET MASK TO TURN 'OFF'     @ZA12145 81700003
*                                  *UCBMONT AND UCBNALOC ONLY  @ZA12145 81750003
         NR    WORK10,WORK3        ONLY 'TO' UCBMONT & UCBNALOC 'ON'    81800003
*                                  *TURN 'OFF' OTHER BITS IN 'TO'       81850003
         NR    WORK1,WORK2         ONLY 'FROM' UCBMONT & UCBNALOC 'OFF' 81900003
*                                  *LEAVE 'ON' OTHER BITS IN 'FROM'     81950003
         OR    WORK10,WORK1        MERGE 'TO' UCBMONT & UCBNALOC        82000003
*                                  *WITH 'FROM' ALL OTHERS BITS@ZA12145 82050003
         STH   WORK10,UCBJBNR-UCBOB(0,UCBTO4) SWAP 'FROM'      @ZA12145 82100003
*                                  *UCBJBNR & UCBFL5           @ZA12145 82150003
         SPACE                                                          82200003
*****************************************************************       82250003
*                                                               *       82300003
*        UCBTBYT2 - SWAP ALL BUT UCBVLPWR.                     @ZA12145 82350003
*                                                               *       82400003
*****************************************************************       82450003
         SPACE                                                          82500003
         TM    UCBTBYT3-UCBOB(WORK8),ID3TA TAPE?      @YM04197,@ZA12145 82550003
*                                  DEVICE?            @YM04197,@ZA12145 82600003
         BO    SWAP0051            YES, PERFORM SWAP  @YM04197,@ZA12145 82650003
         SPACE                                                          82700003
         TM    UCBTBYT3-UCBOB(WORK8),ID3DA     DASD?  @YM04197,@ZA12145 82750003
         BNO   SWAP0052            NO, BYPASS SWAP    @YM40197,@ZA12145 82800003
         SPACE                                                          82850003
SWAP0051 EQU   *                                      @YM04197,@ZA12145 82900003
         SPACE                                                          82950003
         LA    WORK10,MSK02(0,0)    MASK TO LEAVE 'ON'@XL03167,@ZA12145 83000003
*                                  *UCBVLPWR ONLY              @ZA12145 83050003
         LA    WORK1,MSKFD(0,0)    MASK TO TURN 'OFF' @XL03167,@ZA12145 83100003
*                                  *UCBVLPWR ONLY              @ZA12145 83150003
         IC    WORK2,UCBTBYT2-UCBOB(0,UCBFROM6) 'FROM'@XL03167,@ZA12145 83200003
*                                  *UCBVLPWR                   @ZA12145 83250003
         IC    WORK3,UCBTBYT2-UCBOB(0,UCBTO4) GET 'TO'@XL03167,@ZA12145 83300003
*                                  *UCBVLPWR                   @ZA12145 83350003
         NR    WORK10,WORK2        'FRM' UCBVLPWR 'ON'@XL03167,@ZA12145 83400003
*                                  *TURN 'OFF' OTHER BITS IN 'FROM'     83450003
         NR    WORK1,WORK3         'TO' UCBVLPWR 'OFF'@XL03167,@ZA12145 83500003
*                                  *LEAVE 'ON' OTHER BITS IN 'TO'       83550003
         OR    WORK10,WORK1   MERGE 'FROM' UCBVLPWR   @YM03167,@ZA12145 83600003
*                                  *WITH 'TO' ALL OTHERS BITS  @ZA12145 83650003
         STC   WORK10,UCBTBYT2-UCBOB(0,UCBFROM6) SWAP @XL03167,@ZA12145 83700003
*                                  *'TO' UCBVLPWR              @ZA12145 83750003
         LA    WORK10,MSK02(0,0)    MASK TO LEAVE 'ON'@XL03167,@ZA12145 83800003
*                                  *UCBVLPWR ONLY              @ZA12145 83850003
         LA    WORK1,MSKFD(0,0)    GET MASK TO TURN   @XL03167,@ZA12145 83900003
*                                  *'OFF' UCBVLPWR ONLY        @ZA12145 83950003
         NR    WORK10,WORK3        'TO' UCBVLPWR 'ON' @XL03167,@ZA12145 84000003
*                                  *TURN 'OFF' OTHER BITS IN 'TO'       84050003
         NR    WORK1,WORK2        'FROM' UCBVLPWR 'OFF@XL03167,@ZA12145 84100003
*                                  *LEAVE 'ON' OTHER BITS IN 'FROM'     84150003
         OR    WORK10,WORK1        MERGE 'TO' UCBVLPWR@XL03167,@ZA12145 84200003
*                                  *WITH 'FROM' ALL OTHERS BITS@ZA12145 84250003
         STC   WORK10,UCBTBYT2-UCBOB(0,UCBTO4) SWAP   @XL03167,@ZA12145 84300003
*                                  *'FROM' UCBVLPWR            @ZA12145 84350003
******************************************************@ZA12682,@ZA12145 84400003
*                                                     @ZA12682,@ZA12145 84450003
*        SWAP DIRECT ACCESS FLAG BYTE UCBFL4          @ZA12682,@ZA12145 84500003
*                                                     @ZA12682,@ZA12145 84550003
******************************************************@ZA12681,@ZA12145 84600003
         SPACE                                                          84650003
         XC    UCBFL4-UCBOB(K01,UCBTO4),UCBFL4-UCBOB(UCBFROM6)          84700003
*                                                     @ZA12682,@ZA12145 84750003
         XC    UCBFL4-UCBOB(K01,UCBFROM6),UCBFL4-UCBOB(UCBTO4)          84800003
*                                                     @ZA12682,@ZA12145 84850003
         XC    UCBFL4-UCBOB(K01,UCBTO4),UCBFL4-UCBOB(UCBFROM6)          84900003
*                                                     @ZA12682,@ZA12145 84950003
         SPACE                                                          85000003
*****************************************************************       85050003
*                                                               *       85100003
*        IF TAPE, UCBDVSHR MUST BE SWAPPED                     @ZA12145 85150003
*                                                               *       85200003
*****************************************************************       85250003
         SPACE                                                          85300003
SWAP0052 EQU   *                                      @YM04197,@ZA12145 85350003
         TM    UCBTBYT3-UCBOB(WORK8),ID3TA     IS THIS A TAPE  @ZA12145 85400003
         BNO   SWAP0055            NO, SKIP SWAP               @ZA12145 85450003
         LA    WORK10,MSK80(0,0)    GET UCBDVSHR 'ON' MASK     @ZA12145 85500003
         LA    WORK1,MSK7F(0,0)    GET UCBDVSHR 'OFF' MASK     @ZA12145 85550003
         IC    WORK2,UCBSTAB-UCBOB(0,UCBFROM6) GET 'FROM' BYTE @ZA12145 85600003
         IC    WORK3,UCBSTAB-UCBOB(0,UCBTO4) GET 'TO' BYTE     @ZA12145 85650003
         NR    WORK10,WORK3        LEAVE UCBDVSHR 'ON' IN 'TO' @ZA12145 85700003
         NR    WORK1,WORK2         TURN UCBDVSHR 'OFF' IN 'FRM'@ZA12145 85750003
         OR    WORK10,WORK1        MERGE TO GET 'FROM'         @ZA12145 85800003
         STC   WORK10,UCBSTAB-UCBOB(0,UCBFROM6) SWAP 'FROM'    @ZA12145 85850003
         LA    WORK10,MSK80(0,0)    GET UCBDVSHR 'ON' MASK     @ZA12145 85900003
         LA    WORK1,MSK7F(0,0)    GET UCBDVSHR 'OFF' MASK     @ZA12145 85950003
         NR    WORK10,WORK2        LEAVE UCBDVSHR 'ON' IN 'FRM'@ZA12145 86000003
         NR    WORK1,WORK3         TURN UCBDVSHR 'OFF' IN 'TO' @ZA12145 86050003
         OR    WORK10,WORK1        MERGE TO GET 'TO'           @ZA12145 86100003
         STC   WORK10,UCBSTAB-UCBOB(0,UCBTO4) SWAP 'TO'        @ZA12145 86150003
         SPACE                                                          86200003
*****************************************************************       86250003
*                                                               *       86300003
*        SAVE 'FROM' EXTENSION FIELDS IN WORK AREA.            @ZA12145 86350003
*        SWAP EXTENSION FIELDS FROM 'TO' TO 'FROM' DEVICE.     @ZA12145 86400003
*                                                               *       86450003
*****************************************************************       86500003
         SPACE                                                          86550003
SWAP0055 L     WORK2,UCBEXTPT-UCBOB(0,UCBFROM6) 'FROM' EXT PTR @ZA12145 86600003
         LA    WORK2,0(0,WORK2)    CLEAR OUT UCBFLC            @ZA12145 86650003
         L     WORK3,UCBEXTPT-UCBOB(0,UCBTO4) GET 'TO' EXT PTR @ZA12145 86700003
         LA    WORK3,0(0,WORK3)    CLEAR OUT UCBFLC            @ZA12145 86750003
         MVC   0(UCBASID-UCBCMEXT,WORK8),0(WORK2) COPY ALL OF  @ZA12145 86800003
*                                  *'FROM' EXT EXCEPT UCBASID  @ZA12145 86850003
*                                  *TO 'WORK AREA'             @ZA12145 86900003
         MVC   UCBETI-UCBCMEXT(K01,WORK2),UCBETI-UCBCMEXT(WORK3)        86950003
*                                                              @ZA12145 87000003
         MVC   UCBDTI-UCBCMEXT(K01,WORK2),UCBDTI-UCBCMEXT(WORK3)        87050003
*                                                              @ZA12145 87100003
         MVC   UCBSNSCT-UCBCMEXT(K01,WORK2),UCBSNSCT-UCBCMEXT(WORK3)    87150003
*                                                              @ZA12145 87200003
         MVC   UCBCCWOF-UCBCMEXT(K02,WORK2),UCBCCWOF-UCBCMEXT(WORK3)    87250003
*                                                              @ZA12145 87300003
         MVC   UCBPMSK-UCBCMEXT(K02,WORK2),UCBPMSK-UCBCMEXT(WORK3)      87350003
*                                                              @ZA12145 87400003
         MVC   UCBMFCNT-UCBCMEXT(K02,WORK2),UCBMFCNT-UCBCMEXT(WORK3)    87450003
*                                                              @ZA12145 87500003
         SPACE                                                          87550003
*****************************************************************       87600003
*                                                               *       87650003
*        SWAP EXTENSION FIELDS FROM 'WORK AREA' TO 'TO' DEVICE.@ZA12145 87700003
*                                                               *       87750003
*****************************************************************       87800003
         SPACE                                                          87850003
         MVC   UCBETI-UCBCMEXT(K01,WORK3),UCBETI-UCBCMEXT(WORK8)        87900003
*                                                              @ZA12145 87950003
         MVC   UCBDTI-UCBCMEXT(K01,WORK3),UCBDTI-UCBCMEXT(WORK8)        88000003
*                                                              @ZA12145 88050003
         MVC   UCBSNSCT-UCBCMEXT(K01,WORK3),UCBSNSCT-UCBCMEXT(WORK8)    88100003
*                                                              @ZA12145 88150003
         MVC   UCBCCWOF-UCBCMEXT(K02,WORK3),UCBCCWOF-UCBCMEXT(WORK8)    88200003
*                                                              @ZA12145 88250003
         MVC   UCBPMSK-UCBCMEXT(K02,WORK3),UCBPMSK-UCBCMEXT(WORK8)      88300003
*                                                              @ZA12145 88350003
         MVC   UCBMFCNT-UCBCMEXT(K02,WORK3),UCBMFCNT-UCBCMEXT(WORK8)    88400003
*                                                              @ZA12145 88450003
         SPACE                                                          88500003
******************************************************@ZA06377,@ZA12145 88550003
*                                                     @ZA06377,@ZA12145 88600003
*     SWAP UCBCHGS (VARY PENDING) BIT TO 'TO' DEVICE  @ZA06377,@ZA12145 88650003
*                                                     @ZA06377,@ZA12145 88700003
******************************************************@ZA06377,@ZA12145 88750003
         SPACE                                                          88800003
SWAP0M40 EQU   B'01000000'         'ON' MSK - UCBCHGS @ZA06377,@ZA12145 88850003
SWAP0MBF EQU   B'10111111'         'OFF' MSK - UCBCHGS@ZA06377,@ZA12145 88880003
         SPACE                                                          88950003
         LA    WORK10,SWAP0M40(0,0) UCBCHGS 'ON' MASK @ZA06377,@ZA12145 89000003
         LA    WORK1,SWAP0MBF(0,0)  UCBCHGS 'OFF' MASK@ZA06377,@ZA12145 89030003
         IC    WORK2,UCBSTAT-UCBOB(0,UCBFROM6) 'FROM' @ZA06377,@ZA12145 89100003
         IC    WORK3,UCBSTAT-UCBOB(0,UCBTO4) 'TO' BYTE@ZA06377,@ZA12145 89150003
         NR    WORK10,WORK3        LEAVE UCBCHGS 'ON' IN 'TO'           89200003
*                                                     @ZA06377,@ZA12145 89250003
         NR    WORK1,WORK2         TURN UCBCHGS 'OFF' IN 'FROM'         89300003
*                                                     @ZA06377,@ZA12145 89350003
         OR    WORK10,WORK1         MERGE TO GET 'FROM                  89400003
*                                                     @ZA06377,@ZA12145 89450003
         STC   WORK10,UCBSTAT-UCBOB(0,UCBFROM6) SWAP 'FROM'             89500003
*                                                     @ZA06377,@ZA12145 89550003
         LA    WORK10,SWAP0M40(0,0)   GET UCBCHGS 'ON' MASK             89600003
*                                                     @ZA06377,@ZA12145 89650003
         LA    WORK1,SWAP0MBF(0,0)   GET UCBCHGS 'OFF' MASK             89700003
*                                                     @ZA06377,@ZA12145 89750003
         NR    WORK10,WORK2         LEAVE UCBCHGS 'ON' IN 'FROM'        89800003
*                                                     @ZA06377,@ZA12145 89850003
         NR    WORK1,WORK3          TURN UCBCHGS 'OFF' IN 'TO'          89900003
*                                                     @ZA06377,@ZA12145 89950003
         OR    WORK10,WORK1         MERGE TO GET 'TO'                   90000003
*                                                     @ZA06377,@ZA12145 90050003
         STC   WORK10,UCBSTAT-UCBOB(0,UCBTO4) SWAP 'TO'                 90100003
*                                                     @ZA06377,@ZA12145 90150003
         SPACE                                                          90200003
*****************************************************************       90250003
*                                                               *       90300003
*        SWAP DEVICE STATISTICS TABLES                         @ZA12145 90350003
*                                                               *       90400003
*****************************************************************       90450003
         SPACE                                                          90500003
         TM    UCBTBYT3-UCBOB(UCBTO4),ID3DA                    @ZA12145 90550003
*                                  *IS THIS A DA DEVICE        @ZA12145 90600003
         BO    SWAPRET             YES, EXIT IMMEDIATELLY     *@ZA12145 90650003
         LR    UCBOPT7,UCBTO4   COPY 'TO' ADDR                 @ZA12145 90700003
         BAL   LINK9,SWAP0080   GO GET STATISTICS ADDR         @ZA12145 90750003
         LR    WORK2,WORK3   SAVE STAT ADDR                    @ZA12145 90800003
         LR    UCBOPT7,UCBFROM6   COPY 'FROM' ADDR             @ZA12145 90850003
         BAL   LINK9,SWAP0080   GO GET STATISTICS ADDR         @ZA12145 90900003
         TM    UCBTBYT3-UCBOB(UCBTO4),ID3TA                    @ZA12145 90950003
*                                  *IS THIS A TAPE             @ZA12145 91000003
         BNO   SWAP0070            NO, SKIP FURTHER TESTS      @ZA12145 91050003
         CLI   UCBTBYT4-UCBOB(UCBTO4),ID3400                   @ZA12145 91100003
*                                  *IS 'TO' A 3400 SERIES      @ZA12145 91150003
         BE    SWAP0060            YES, SWAP 20 BYTES          @ZA12145 91200003
         CLI   UCBTBYT4-UCBOB(UCBFROM6),ID3400                 @ZA12145 91250003
*                                  *IS 'FROM' A 3400 SERIES    @ZA12145 91300003
         BNE   SWAP0070            NO, SKIP LARGE SWAP         @ZA12145 91350003
SWAP0060 XC    0(K20,WORK2),0(WORK3)  *SWAP 20 BYTES           @ZA12145 91380003
         XC    0(K20,WORK3),0(WORK2)  *OF STATISTICS           @ZA12145 91450003
         XC    0(K20,WORK2),0(WORK3)  *TABLES                  @ZA12145 91500003
         B     SWAPRET             GO RETURN TO CALLER        *@ZA12145 91550003
SWAP0070 XC    0(K10,WORK2),0(WORK3)  *SWAP 10 BYTES           @ZA12145 91600003
         XC    0(K10,WORK3),0(WORK2)  *OF STATISTICS           @ZA12145 91650003
         XC    0(K10,WORK2),0(WORK3)  *TABLES                  @ZA12145 91700003
SWAPRET  OI    GENAFLAG,GFRRUEND   SET SWAP ENDED FLAG        *@ZA12145 91710003
SWAPRET2 S     UCBTO4,PREFIX    RESET UCB PTR TO PREFIX       *@ZA12145 91713003
         S     UCBFROM6,PREFIX  RESET UCB PTR TO PREFIX       *@ZA12145 91716003
         SR    RC15,RC15        SET RETURN CODE               *@ZA12145 91721003
         BR    RTN14            RETURN                        *@ZA12145 91722003
         DROP  IOQE11                                          @ZA12145 91730003
         SPACE                                                          91800003
*****************************************************************       91850003
*                                                               *       91900003
*        STATISTICS TABLE ENTRY LOOK UP SUBROUTINE             @ZA12145 91950003
*                                                               *       92000003
*****************************************************************       92050003
         SPACE                                                          92100003
SWAP0080 L     WORK10,CVTSTB-CVTMAP(0,WORK12)                  @ZA12145 92150003
*                                  *GET STATISTICS TABLE ADDR  @ZA12145 92200003
         L     WORK1,UCBEXTPT-UCBOB(0,UCBOPT7) GET EXT PTR     @ZA12145 92250003
         LA    WORK1,0(0,WORK1)  CLEAR HI ORDER BYTE           @ZA12145 92300003
         SLR   WORK3,WORK3        CLEAR REG                    @ZA12145 92350003
         IC    WORK3,UCBSTI-UCBCMEXT(0,WORK1)  GET INDEX       @ZA12145 92400003
SWAP0090 CLM   UCBOPT7,MSK03,0(WORK10) UCB IN THIS SEG?                 92450003
*                                                     @ZA06377,@ZA12145 92500003
         BL    SWAP0100            YES, CONTINUE               @ZA12145 92550003
         LA    WORK10,K02(0,WORK10)  NO, INCR INDEX            @ZA12145 92600003
         LA    WORK3,K256(0,WORK3)   NO, INCR INDEX            @ZA12145 92650003
         B     SWAP0090            CHECK NEXT SEGMENT          @ZA12145 92700003
SWAP0100 MH    WORK3,SWAP0H10     MULTIPLY BY 10               @ZA12145 92730003
         ALR   WORK3,WORK10        ADD TO BEGINNING OF         @ZA12145 92800003
         BR    LINK9                                           @ZA12145 92820003
*                                  *STATISTICS TABLE           @ZA12145 92850003
         SPACE                                                          93050003
*****************************************************************       93100003
*                                                               *       93150003
*        DEFINED CONSTANTS                                     @ZA12145 93200003
*                                                               *       93250003
*****************************************************************       93300003
         DS    0F                                                       93320003
         SPACE                                                          93350003
NOTREADY DC    X'00004000'         MASK FOR UCBNRY C&S        *@ZA12145 93370003
SWAP0H10 DC    H'10'               CONSTANT OF 10              @ZA12145 93400003
SWAP0OFF DC    X'FEFB'             'OFF' MASK UCBMONT/UCBNALOC @ZA12145 93430003
EIGHT    DC    H'8'                CONSTANT OF 8               @ZA12145 93500003
         EJECT                                                          93550003
*****************************************************************       93600003
*                                                               *       93650003
*        FRR DEFINED CONSTANTS                                  *       93700003
*                                                               *       93750003
*****************************************************************       93800003
         SPACE                                                          93850003
         LCLC  &ADATE                                                   93900003
&ADATE   SETC  '&SYSDATE'          ESTABLISH ASSEMBLY DATE              93950003
         DS    0F                                                       94000003
LOCKSDBF DC    X'80000000'         (FRR) CVTSDBF HI ORDER BIT ON        94050003
CSECTMOD DC    CL8'IECVGENA'       (FRR) CSECT AND MODULE NAME          94100003
ASSMDATE DC    CL8'&ADATE.'        (FRR) MODULE ASSEMBLY DATE           94150003
         SPACE                                                          94200003
         TITLE 'IECVGENA - PATCH AREA FOR MAINTENANCE'                  94250003
*****************************************************************       94300003
*                                                               *       94350003
*        PATCH AREA FOR MAINTENANCE                             *       94400003
*                                                               *       94450003
*        (12+((*+139-MAINTAIN)/140))A(0)                        *       94500003
*                                                               *       94550003
*****************************************************************       94600003
         SPACE                                                          94650003
         DS    0F                                                       94700003
PATCHID  DC    C'GENA'             CORE ID FOR PATCH AREA               94750003
         DC    (1+((*-MAINTAIN)/80))A(0)  MAINTENANCE AREA              94800003
         DC    C'GENA'             CORE ID FOR PATCH AREA               94850003
GENALNTH EQU   *-IECVGENA          (FRR) MODULE LENGTH                  94900003
SDBFLNTH EQU   (SDBFRRWA-SDBFSTRT)+GENALNTH  (FRR) LENGTH OF   @ZA12145 94950003
*                                  *DUMP BUFFER                         95000003
         SPACE                                                          95050003
         DROP  WORK12                                                   95100003
         SPACE                                                          95150003
         END                                                            95200003
