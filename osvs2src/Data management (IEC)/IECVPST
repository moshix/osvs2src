PST      TITLE '   IECVPST - PROLOGUE   '                               00050002
****************************************************************        00100002
*                                                              *        00150002
* MODULE NAME = IECVPST                                        *        00200002
*                                                              *        00250002
* DESCRIPTIVE NAME = POST STATUS                               *        00300002
*                                                              *        00350002
* COPYRIGHT = NONE                                             *        00400002
*                                                              *        00450002
* STATUS = CHANGE LEVEL 00                                     *        00500002
*                                                              *        00550002
* FUNCTION = POST STATUS IS AN EXTENSION OF IOS RUNNING        *        00600002
*            ENABLED. IT IS SCHEDULED BY IOS TO RUN UNDER      *        00650002
*            AN SRB FOR TERMINATING AN I/O REQUEST, AND        *        00700002
*            OPTIONALLY RUNS UNDER THE LOCAL LOCK. POST        *        00750002
*            STATUS INTERFACES WITH USER SPECIFIED EXITS       *        00800002
*            (NORMAL, ABNORMAL AND PCI), ATTENTION ROUTINES    *        00850002
*            AND DAVV FOR HANDLING UNSOLICITED DEVICE END      *        00900002
*            INTERRUPTS. POST STATUS ALSO INTERFACES WITH      *        00950002
*            DEVICE DEPENDENT ERROR ROUTINES AND HANDLES       *        01000002
*            THEIR RETURNS VIA SVC F.                          *        01050002
*                                                              *        01100002
* NOTES = NONE                                                 *        01150002
*                                                              *        01300002
*    DEPENDENCIES = NONE                                       *        01305002
*                                                              *        01310002
*    RESTRICTIONS = SVC F PROTECTS ITSELF FROM NON-AUTHORIZED  @ZA05814 01310540
*    USERS BY THE 'TESTAUTH' FUNCTION. IT ALLOWS ONLY SUPER-   @ZA05814 01311040
*    VISOR STATE CALLERS AND ABENDS ANY NON-SUPERVISOR STATE   @ZA05814 01312040
*    CALLER.                                                   @ZA05814 01313040
*                                                              *        01320002
*    REGISTER CONVENTIONS = SEE EQUATES WITHIN CSECT           *        01325002
*                                                              *        01330002
*    PATCH LABEL = IOSPATCH - LOCATED IN IECIOSCN              *        01335002
*                                                              *        01340002
* MODULE TYPE = CONTROL                                        *        01350002
*                                                              *        01400002
*    PROCESSOR = ASSEMBLER XF                                  *        01450002
*                                                              *        01500002
*    MODULE SIZE = 2500 DECIMAL BYTES                          *        01550002
*                                                              *        01600002
*    ATTRIBUTES = RESIDENT, REENTRANT, ENABLED, KEY 0,         *        01650002
*                 SUPERVISOR STATE                             *        01700002
*                                                              *        01750002
* ENTRY POINT = IECVPST                                        *        01800002
*               IGC015                                         *        01810002
*                                                              *        01830002
*    PURPOSE = SEE FUNCTION                                    *        01850002
*                                                              *        01900002
*    LINKAGE = R0 LOADED WITH SRB ADDRESS                      *        01950002
*              R1 LOADED WITH IOSB ADDRESS                     *        02000002
*              R15 LOADED WITH RETURN ADDRESS                  *        02050002
*                                                              *        02100002
*    INPUT = ADDRESS OF UCB IN IOSB                            *        02110002
*            ADDRESS OF ERP WORK AREA IN IOSB                  *        02110802
*            IOSFLA SET BY ERP AND DAVV                        *        02111602
*                                                              *        02112402
*    OUTPUT = COMPLETION CODE IN IOSB (IOSCOD)                 *        02113202
*             TRANSLATED CSW IN IOSB                           *        02114002
*                                                              *        02114802
*    EXIT-NORMAL = RETURN TO DISPATCHER                        *        02115602
*                                                              *        02116402
*    EXIT-ERROR = ABEND NON-SUPERVISOR STATE CALLERS OF SVC F  @ZA05814 02116640
*                                                              *        02118002
* EXTERNAL REFERENCES = NONE                                   *        02118802
*                                                              *        02120002
*    ROUTINES = NORMAL END APPENDAGE                           *        02121002
*               ABNORMAL END APPENDAGE                         *        02122002
*               PCI APPENDAGE                                  *        02123002
*               ATTENTION ROUTINE                              *        02124002
*               IECVSMGR - STORAGE MANAGER                     *        02125002
*               IECVDERP - DA ERROR PROCESSOR                  *        02126002
*               ADDRESS TRANSLATOR REAL TO VIRTUAL             *        02127002
*               STAGE II EXIT EFFECTOR                         *        02130002
*                                                              *        02131002
*    DATA SETS = NONE                                          *        02132002
*                                                              *        02133002
*    DATA AREAS = NONE                                         *        02134002
*                                                              *        02135002
* TABLES = NONE                                                *        02140002
*                                                              *        02142002
* MACROS = SCHEDULE, SETFRR, SETRP, STARTIO                    *        02144002
*           TESTAUTH,ABEND                                     @ZA05814 02144540
*                                                              *        02146002
* CHANGE ACTIVITY = NONE                                       *        02150002
*                                                              *        02157002
****************************************************************        02164002
         EJECT                                                          02171002
****************************************************************        02178002
*                                                              *        02185002
* ENTRY POINT = IGC015                                         *        02192002
*                                                              *        02200002
*        PURPOSE = SEE FUNCTION                                *        02250002
*                                                              *        02300002
*        LINKAGE = R1 LOADED WITH IOSB ADDRESS                 *        02350002
*                  R 14 LOADED WITH RETURN ADDRESS             *        02400002
*                                                              *        02450002
* INPUT = ADDRESS OF UCB IN IOSB                               *        02750002
*         ADDRESS OF ERP WORK AREA IN IOSB                     *        02800002
*         IOSERR (IOSFLA) SET BY ERP AND DAVV                  *        02850002
*                                                              *        02900002
* OUTPUT = COMPLETION CODE IN IOSB (IOSCOD)                    *        02950002
*          TRANSLATED CCW ADDRESS IN IOSB (IOSCSW)             *        03000002
*                                                              *        03050002
* EXIT-NORMAL = RETURN TO DISPATCHER                           *        03100002
*                                                              *        03150002
* EXIT-ERROR = NONE                                            *        03200002
*                                                              *        03250002
* EXTERNAL REFERENCES = NORMAL END APPENDAGE                   *        03300002
*                       ABNORMAL END APPENDAGE                 *        03350002
*                       PCI APPENDAGE                          *        03400002
*                       ATTENTION ROUTINE                      *        03450002
*                       IOS STORAGE MANAGER ROUTINE            *        03500002
*                       RESIDENT DIRECT ACCESS ERROR PROCEDURE *        03550002
*                       REAL TO VIRTUAL ADDRESS TRANSLATOR     *        03600002
*                       STAGE II EXIT EFFECTOR                 *        03650002
*                                                              *        03660002
*        CONTROL BLOCKS = ASCB     ASVT     ASXB     CVT       *        03670002
*                         ERPWA    IOMB     IOQ      IOSB      *        03680002
*                         IRT      LCCA     LCH      PSA       *        03690002
*                         SDWA     SRB      UCB                *        03692002
*                                                              *        03694002
* TABLES = NONE                                                *        03694402
*                                                              *        03694802
* MACROS = SCHEDULE, SETFRR, SETRP, STARTIO                    *        03696002
*                                                              *        03698002
* CHANGE ACTIVITY = AS FOLLOWS                                 *        03698102
*                                                              *        03698202
****************************************************************        03698402
         TITLE '   IECVPST - DSECTS     '                               03700002
         CVT   DSECT=YES,LIST=NO                                        03750002
         EJECT                                                          03800021
         IHAASCB                                                        03850021
         EJECT                                                          03860002
         IHAASVT                                                        03870002
         EJECT                                                          03900021
         IHAASXB                                                        03950021
         EJECT                                                          04000021
         DSECT                                                          04050021
         IEFUCBOB  LIST=YES,PREFIX=YES                                  04100002
         EJECT                                                          04150021
         IHASRB                                                         04200021
         EJECT                                                          04250021
         IECDIOSB                                                       04300021
         EJECT                                                          04350021
         IHAPSA                                                         04400021
         EJECT                                                          04450021
         IHALCCA                                                        04500021
         EJECT                                                          04550021
         IECDIRT                                                        04560002
         EJECT                                                          04570002
         IHAWSAVT  DSECT=YES,CLASS=CPU                                  04600021
         EJECT                                                          04650021
         IECDERWA                                                       04700021
         EJECT                                                          04750021
         IECDIOQ                                                        04800021
         EJECT                                                          04850021
         IECDIOCM                                                       04900021
         EJECT                                                          04950021
         IECDLCH                                                        04960002
         EJECT                                                          04970002
         IHAFRRS                                                        05000021
         EJECT                                                          05050021
         IHASDWA                                                        05060002
         EJECT                                                          05062002
         ILRIORB                                               @Z40WPLL 05063040
         EJECT                                                          05070002
FRRAREA  DSECT                                                          05100021
****************************************************************        05150021
*                                                              *        05200021
*  THIS FRR SAVE AREA IS FORMATTED AND USED BY POST STATUS     *        05250021
*  AND SVC F. IT IS SIX WORDS IN LENGTH.                       *        05300021
*                                                              *        05350021
****************************************************************        05400021
         SPACE 1                                                        05450021
         DS    0F                                                       05500021
FRRFLGA  DS    XL1                 POST STATUS INDICATORS               05550021
FRRLOCAL EQU   X'C0'               LOCAL LOCK HELD                      05600021
FRRLLHLD EQU   X'80'               POST STATUS GOT LOCAL LOCK           05650021
FRRSVCNT EQU   X'40'               SVC ENTRANCE                         05700021
FRRERPNT EQU   X'20'               DA ERP ENTERED                       05750021
FRRSYNCH EQU   X'10'               IOSYNCH LOCK HELD                    05800021
FRRCATLK EQU   X'08'               CAT LOCK HELD                        05850021
FRRSAF   EQU   X'04'               SAVE AREA ADDRESS EXITS     @ZA00904 05870040
FRRWDAV  EQU   X'02'               UCBWDAV ON ENTRY TO PSTWAIT @ZA00904 05900040
*        EQU   X'01'               RESERVED                             05903040
FRRFLGB  DS    XL1                 TRACKING INDICATORS                  05950021
FRRSECNT EQU   X'80'               FRR SECOND ENTRY FLAG                05960002
FRRECRSN EQU   X'40'               FRR RECURSION FLAG                   05970002
FRRIIOSB EQU   X'20'               IOS OWNS IOSB                        05972002
FRRUCBLK EQU   X'10'               UCB LOCK HELD               @ZA06077 05976040
*        EQU   X'1F'               RESERVED                             05980002
         DS    H                   RESERVED                             06000021
FRRSRB   DS    A                   SRB ADDRESS                          06050021
FRRSA    DS    A                   SAVE AREA ADDRESS           @ZA00904 06070040
FRRREGD  DS    A                   SAVE AREA FOR REG 13 IF SVC          06110002
*                                  F IS BRANCH ENTERED                  06120002
FRRDISP  DS    A                   DISP RETURN ADDR FOR P.S.            06130002
FRRTMRET DS    A                   RTM RETURN ADDRESS                   06150002
         SPACE 2                                                        06150140
*  THIS FRR SAVE AREA IS USED BY PSTWAIT FOR PROTECTING THE             06150240
*    RESTART RESOURCE                                                   06150440
FRRW     DSECT                                                          06150740
FRRWBASE DS    F                   BASE REG                    @ZA00904 06150940
FRRWCVT  DS    F                   CVT POINTER                 @ZA00904 06151240
FRRWIOSB DS    F                   IOSB POINTER                @ZA00904 06151440
FRRWSRSW DS    X                   RESOURCE HELD SWITCH        @ZA00904 06151640
         DS    XL11                                                     06152840
         EJECT                                                          06153340
         IHARB                                                 @ZA05822 06153840
         EJECT                                                          06155840
BUFFER   DSECT                                                          06160002
****************************************************************        06170002
*                                                              *        06180002
*  THIS BUFFER AREA IS FORMATTED AND USED BY POST STATUS FRR   *        06190002
*  FOR INITIALIZING THE 4K BUFFER USED BY SDUMP.               *        06192002
*                                                              *        06194002
****************************************************************        06196002
         SPACE 1                                                        06198002
         DS    0F                                                       06198402
BUFDATAD DS    A                   ADDRESS OF DATA IN BUFFER            06198802
BUFDATLG DS    H                   LENGTH OF DATA                       06199202
BUFDATA  DS    XL(IOSEND-IOSB)     DATA - IOSB FOR FRR                  06199602
BUFAD2   DS    A                   ADDRESS OF NEXT DATA        @ZA06077 06199740
BUFLEN2  DS    H                   LENGTH OF DATA              @ZA06077 06200240
BUFDATA2 DS    XL4                 DATA-HI LOCK HELD IND.      @ZA06077 06200740
BUFCNST  DS    XL6                 6 BYTE ZERO DELIMITER                06201240
         SPACE 3                                                        06201740
*  WORKAREA WITHIN SAVE AREA FOR RESTARTABLE WAIT SUBROUTINE            06202740
XPSA     DSECT                                                          06205740
XPSACD   DS    0H                  WAIT STATE REASON CODE      @ZA00904 06208740
XPSAWAIT DS    X                   DEFINED NEXT                @ZA00904 06211740
XPSAVID  EQU   X'80'                 WRONG VOL SER             @ZA00904 06214740
XPSAIR   EQU   X'40'                 INTERVENTION REQUIRED     @ZA00904 06217740
XPSACC3  EQU   X'20'                 CONDITION CODE 3          @ZA00904 06220740
XPSAERR  EQU   X'10'                 PERM READ ERROR           @ZA00904 06223740
*        DS    X                     PADDING                   @ZA00904 06226740
XPSADEV  DS    H                     DEVICE ADDRESS            @ZA00904 06229740
XRNPSW1  DS    2F                  RESTART NEW PSW SAVE AREA   @ZA00904 06232740
         TITLE '   IECVPST - EQUATES    '                               06235740
****************************************************************        06250021
*                                                              *        06300021
*                   REGISTERS  DEFINITIONS                     *        06350021
*                                                              *        06400021
****************************************************************        06450021
         SPACE 2                                                        06500021
SRBREG   EQU   0                   SRB ADDRESS                          06550021
REG0     EQU   0                   GENERAL REGISTER 0          @ZA00904 06560040
PARMRG   EQU   1                   PARM REGISTER CONTAINING IOSB        06600021
IOSBRG   EQU   2                   ADDRESS OF IOSB                      06650021
*        EQU   3                   NOT USED                             06700002
FRRSAV   EQU   4                   FRR WORKAREA SAVE                    06750021
BASERG   EQU   5                   BASE REGISTER FOR POST STATUS        06800021
*        EQU   6                   NOT USED                             06850021
UCBREG   EQU   7                   ADDRESS OF UCB;  ALSO USED           06900021
*                                  TO SAVE REG ACROSS SETLOCK           06950021
WRKRG1   EQU   8                   WORK REGISTER 1                      07000021
WRKRG2   EQU   9                   WORK REGISTER 2                      07050021
TRAREG   EQU   10                  XLTAE SUBROUTINE LINKAGE             07100021
CORERG   EQU   11                  CORE MGMNT INTERFACE REGISTER        07150021
SAVERG   EQU   11                  SAVE REGISTER FOR @SDWA     @ZA02135 07170003
SRBASE   EQU   12                  SRB BASE REG FOR SCHEDULE            07200021
LLSAVE   EQU   13                  ADDR OF LOCAL LOCK SAVE AREA         07250021
RTRNRG   EQU   14                  RETURN ADDRESS REGISTER              07300021
LINKRG   EQU   15                  CALLING ADDRESS REGISTER             07350021
         SPACE 1                                                        07400021
*        MISCELLANEOUS EQUATES                                          07450021
         SPACE 1                                                        07500021
D0       EQU   0                   DISPLACEMENT OF 0                    07550021
D1       EQU   1                   DISPLACEMENT OF 1                    07600021
D2       EQU   2                   DISPLACEMENT OF 2                    07650021
D3       EQU   3                   DISPLACEMENT OF 3                    07660002
D4       EQU   4                   DISPLACEMENT OF 4                    07700021
D5       EQU   5                   DISPLACEMENT OF 5                    07702002
D7       EQU   7                   DISPLACEMENT OF 7                    07710002
D8       EQU   8                   DISPLACEMENT OF 8                    07750021
D16      EQU   16                  DISPLACEMENT OF 16                   07800021
D24      EQU   24                  DISPLACEMENT OF 24                   07802002
D28      EQU   28                  DISPLACEMENT OF 24                   07810002
D31      EQU   31                  DISPLACEMENT OF 31                   07850021
D159     EQU   159                 DISPLACEMENT OF 159                  07855002
D512     EQU   512                 DISPLACEMENT OF 512                  07860002
CSWCUS   EQU   X'50'               BUSY - STATUS MODIFIER               07900021
CSWWLR   EQU   X'40'               INCORRECT LENGTH                     07950021
CSWUEX   EQU   X'01'               UNIT EXCEPTION                       08000021
CSWPCI   EQU   X'80'               PCI                                  08050021
MASK00   EQU   X'00'               CONSTANT OF ZERO                     08100021
MASK0F   EQU   X'0F'               MASK FOR TESTING CSW STATUS          08110002
MASKFF   EQU   X'FF'               MASK FOR RESETTING BITS              08150021
POSTCOD  EQU   X'60'               MASK TO TESTING IOSCOD               08160002
HEX3     EQU   X'03'               SYMBOLIC 3                  @ZA05814 08161040
NVALUSER EQU   X'20F'              SYSTEM ABEND CODE FOR NON-  @ZA05814 08163040
*                                   SUPERVISOR STATE CALLER OF @ZA05814 08166040
*                                   SVC F                      @ZA05814 08169040
CON4     EQU   4                   CONSTANT OF 4               @ZA05814 08172040
DISABLE  EQU   X'FC'               DISABLE I/O & EXTERNAL      @ZA00904 08175040
         TITLE '   IECVPST - INITIALIZATION  '                          08200002
IECVPST  CSECT                                                          08250021
         ENTRY IGC015                                                   08300021
         BALR  BASERG,D0           SET ADDRESSABILITY                   08350002
         USING *,BASERG                                                 08400021
         SPACE 1                                                        08450021
PSTBASE  LR    IOSBRG,PARMRG       PUT IOSB ADDRESS IN REG 2            08500021
         USING IOSB,IOSBRG         SET UP ADDRESSABILITY TO IOSB        08550021
         SPACE 1                                                        08650021
         USING FLC,SRBREG                                               08700021
         LA    TRAREG,PSTFRRTN     GET  FRR ROUTINE ADDRESS             08750021
         SETFRR  A,FRRAD=(TRAREG),PARMAD=(FRRSAV),                     *08800021
               WRKREGS=(WRKRG1,WRKRG2)                                  08850021
         USING FRRAREA,FRRSAV                                           08900021
         ST    SRBREG,FRRSRB       SAVE SRB ADDRESS                     09150021
         ST    RTRNRG,FRRDISP      SAVE DISP RETURN ADDR                09210002
         SPACE 1                                                        09220002
* TRANSLATE CCW ADDRESS IN CSW TO VIRTUAL ADDRESS                       09230002
         SPACE 1                                                        09240002
         BAL   TRAREG,PSTTRA       BRANCH TO XLATE CCW IN CSW           09242002
         EJECT                                                          09250002
* THE FOLLOWING TESTS DETERMINE WHETHER TO GET THE LOCAL LOCK  *        09300021
         SPACE 1                                                        09350021
         TM    IOSOPT,IOSPSLL      IF LOCK NOT WANTED (BIT ON)          09400021
         BO    PSTIOST             BRANCH AROUND GET LOCK               09450021
         SPACE 1                                                        09500021
*        GET LOCAL LOCK VIA SETLOCK MACRO                               09550021
         SPACE 1                                                        09600021
         BAL   RTRNRG,PSTLOCK      BRANCH TO GET LOCAL LOCK             09650021
         SPACE 1                                                        09700021
* TEST IF IOSB WAS GENERATED BY IOS FOR SPECIAL HANDLING                09750021
         SPACE 1                                                        09800021
PSTIOST  TM    IOSFLA,IOSIOSB      IF IOS GENERATED IOSB,               09850021
         BO    PSTIOSB             GO HANDLE SPECIALLY                  09900021
         SPACE 1                                                        09950021
PSTNRM   CLI   IOSCOD,IOSNRMC      IF COMP. CODE IS 7F, BRANCH          10000021
         BE    PSTXLT              TO CONTINUE NORMAL PROCESSING        10050021
         OI    IOSFLA,IOSEX        OTHERWISE, SET EXCEPTION FLAG        10100021
         CLI   IOSCOD,POSTCOD      ON INITIAL ENTRY, ALL COMP.          10150002
*                                  CODES OF X'4X' AND X'5F'             10200002
*                                  (X=0-F) ARE ROUTED TO THE            10250002
*                                  ABNORMAL EXIT AS NO ERP              10300002
*                                  PROCESSING IS REQUIRED.              10350002
         BL    PSTCODE             GO TO X'45' ENTRANCE TEST            10400002
         L     LINKRG,IOSABN       GET ADDRESS OF ABNORMAL EXIT         10450021
         B     PSTAPP              AND BRANCH TO GO TO ABE EXIT         10500021
         TITLE '    IECVPST - APPENDAGE INTERFACE  '                    10750002
PSTXLT   TM    IOSTSB,CSWPCI       PCI CONDITION IN CSW STATUS?         10800002
         BZ    PSTERR              NO, SKIP APPENDAGE                   10850021
         SPACE 1                                                        10900021
* INTERFACE WITH PCI APPENDAGE                                          10950021
         SPACE 1                                                        11000021
PSTPCI   LR    PARMRG,IOSBRG       PUT ADDRESS OF IOSB IN REG 1         11050021
         L     LINKRG,IOSPCI       GET ADDRESS OF PCI EXIT              11100021
         LTR   LINKRG,LINKRG       IF NO PCI APPENDAGE,                 11150021
         BZ    PSTERR              BRANCH AROUND                        11200021
         BALR  RTRNRG,LINKRG       GO TO APPENDAGE                      11250021
         SPACE 2                                                        11300021
PSTERR   TM    IOSFLA,IOSERR       IF ERP IN CONTROL, BRANCH TO         11350021
         BO    PSTEFF              INTERFACE WITH ERP                   11400002
         LH    WRKRG1,IOSTATUS     GET CSW STATUS                       11450021
         N     WRKRG1,CDUWPA       IF OTHER THAN CHE,CUE,DVE,  @ZA03292 11470040
         BNZ   PSTABE              WLR, PCI, ATTN, BRANCH               11500040
         SPACE 1                                                        11600021
* INTERFACE WITH CHANNEL END APPENDAGE                                  11650021
         SPACE 1                                                        11700021
PSTCHE   L     LINKRG,IOSNRM       GET NORMAL EXIT ADDR IN R15          11750021
         TM    IOSTSA,CSWUEX       IF UNIT EXCEPTION OR                 11800021
         BO    PSTSEX              GO TO SET IOSEX                      11850002
         TM    IOSTSB,CSWWLR       INCORRECT LENGTH,                    11900021
         BO    PSTSEX              GO TO SET IOSEX                      11950002
         B     PSTAPP              GO TO APPENDAGE                      12000021
         SPACE 1                                                        12050021
* INTERFACE WITH ABNORMAL END APPENDAGE                                 12100021
         SPACE 1                                                        12150021
PSTABE   L     LINKRG,IOSABN       GET ABNORMAL EXIT ADDRESS            12200021
PSTSEX   OI    IOSFLA,IOSEX        SET EXCEPTION INDICATOR              12250021
         SPACE 1                                                        12300021
         TM    IOSTSA,CSWCUS       IF BUSY - STATUS MODIFIER,           12350021
         BNO   PSTAPP              NO, GO TO APPENDAGE         @ZA20593 12400040
         CLI   IOSDVRID,IOSXCPID   YES, THEN IS DRIVER EXCP?   @ZA20593 12410040
         BNE   PSTZRTN             NO, BYPASS ABNORMAL EXIT    @ZA20593 12420040
         SPACE 1                                                        12450021
* INTERFACE WITH CORRECT APPENDAGE                                      12500021
         SPACE 1                                                        12550021
PSTAPP   LR    PARMRG,IOSBRG       PUT IOSB ADDRESS IN REG 1            12600021
         BALR  RTRNRG,LINKRG       GO TO CHE OR ABN EXIT                12650021
         SPACE 1                                                        12700021
****************************************************************        12750021
*                                                              *        12800021
*        CHANNEL END AND ABNORMAL END RETURN VECTOR TABLE      *        12850021
*                                                              *        12900021
         B     PSTZRTN             NORMAL                      *        12950002
         B     PSTFRTN             DO NOTHING                  *        13000021
         B     PSTERTN             RETRY                       *        13050021
         B     PSTTRTN             DDR PROCESSING REQUIRED     *        13100021
*                                  * RETURN +16 VECTOR IS HERE @Y30IPLB 13120003
         TM    FRRFLGA,FRRSVCNT    IF ENTRY BY SVC 15 THEN     @YM30155 13122003
         BNO   PSTRLS              RELEASE LOCAL LOCK AND EXIT @YM30155 13124003
         B     PSTRTN              IF NOT,BYPASS TERMINATION   @YM30155 13126003
*                                  CALL, RELEASE THE FRR, AND           13128003
*                                  THEN RETURN TO DISPATCHER.  @Y30IPLC 13130003
         SPACE                                                          13140003
*                                                              *        13150021
****************************************************************        13200021
         SPACE 1                                                        13250021
*        NORMAL RETURN BRANCHES HERE                                    13300021
         SPACE 1                                                        13350021
PSTZRTN  TM    IOSFLA,IOSEX        EXCEPTION LEFT ON BY EXIT,           13400021
         BO    PSTEFF              GO TO INTERFACE WITH ERPS            13450021
PSTAPR   BAL   RTRNRG,PSTSUB       GO TO SUBR TO FREE RESOURCES YM01041 13500002
         SPACE 1                                                        13550021
         NI    IOSOPT,MASKFF-IOSAPR  RESET APR ACTIVE INDICATOR         13700002
         SPACE 1                                                        13800021
*        SCHEDULE CALLER VIA SCHEDULE MACRO                             13850021
         SPACE 1                                                        13900021
PSTSCHC  EQU   *                   SCHEDULE CALLER                      13950002
         L     SRBASE,IOSSRB       GET SRB ADDRESS                      13952002
         TM    FRRFLGA,FRRSVCNT    IF NOT SVC ENTRANCE,                 13960002
         BZ    PSTBRCH             SKIP SCHEDULES                       13970002
         USING SRBSECT,SRBASE      ESTABLISH ADDRESSABILITY             14050021
*        SET UP SRB FOR SCHEDULE                                        14100021
         SPACE 1                                                        14150021
         MVZ   SRBPKF,IOSPKEY      MOVE PROTECT KEY TO SRB              14200021
         L     WRKRG1,IOSPGAD      MOVE USER TERM ADDRESS               14250021
         ST    WRKRG1,SRBEP        TO THE SRB                           14300021
         LR    PARMRG,SRBASE       PUT SRB ADDR IN REG 1                14350021
         TM    IOSPKEY,IOSLCL      IF USER NOT IN LOCAL MEMORY,         14400021
         BZ    PSTGSCHD            GO SCHED IN GLOBAL MEMORY            14450021
         SCHEDULE  SRB=(1)         SCHED IN LOCAL MEMORY                14500021
         B     PSTRTN              RELEASE LOCK                         14550002
PSTGSCHD SCHEDULE  SRB=(1),SCOPE=GLOBAL                                 14600021
         DROP  SRBASE                                                   14650021
         B     PSTRTN              BR AROUND REG 14 SETUP               14660002
PSTBRCH  LR    PARMRG,IOSBRG       PUT IOSB ADDR IN REG 1      @ZA10093 14665040
*                                                              @YM02469 14690102
         LNR   SRBREG,SRBASE       LOAD NEG INCASE REL LK NOT NEEDED    14690202
         SR    IOSBRG,IOSBRG       ZERO TO USE AS BR                    14690302
         TM    IOSOPT-IOSB(PARMRG),IOSPSLL+IOSTSLL CALLER WANT REL LK   14690402
         BZ    PSTRTN              NO BRANCH AROUND SETLOCK             14690602
*                                                              @YM02469 14690702
         LR    SRBREG,SRBASE       RESET                       @YM05458 14692702
PSTLLH   TM    FRRFLGA,FRRLLHLD    LOCK HELD                   @YM03287 14695202
         BZ    PSTRTN              NO                          @YM03287 14697202
         SPACE 1                                                        14700021
         SPACE 1                                                        14850021
*        RELEASE LOCAL LOCK                                             14900021
         SPACE 1                                                        14950021
PSTRLS   EQU   *                   RELEASE LOCAL LOCK                   15000002
         SETLOCK RELEASE,TYPE=LOCAL,                                   *15050021
               RELATED=(PSLCL,IECVPST(PSTLOCK))                         15100021
         SPACE 1                                                        15150021
PSTRTN   EQU   *                   PREPARE FOR RETURN TO CALLER         15200002
         TM    FRRFLGA,FRRSAF      IS THERE A SAVE AREA TO FREE@ZA00904 15200240
         BZ    PSTRTN1             NO--EXIT                    @ZA00904 15200440
*   GET CAT LOCK TO PROVIDE SAVE AREA FOR STORAGE MANAGER      @ZA00904 15200840
         L     TRAREG,D16          SET UP ADDRESSABILITY TO    @ZA00904 15201240
         USING CVT,TRAREG          THE IOCOM VIA THE CVT       @ZA00904 15201640
         L     TRAREG,CVTIXAVL                                 @ZA00904 15202040
         USING IOCOM,TRAREG                                    @ZA00904 15202440
         SPACE 1                                                        15202840
PSTCATO4 SETLOCK  OBTAIN,TYPE=IOSCAT,ADDR=IOCCATLK,MODE=UNCOND,        *15203240
               RELATED=(PSCAT,IECVPST(PSTCATR4))               @ZA00904 15203640
         OI    FRRFLGA,FRRCATLK    SET CAT LOCK HELD IND.      @ZA00904 15203840
         SPACE 1                                                        15204440
         USING PSA,0               GET LCCA SAVE AREA IN REG 13@ZA00904 15204840
         L     LLSAVE,PSALCCAV                                 @ZA00904 15205240
         USING LCCA,LLSAVE                                     @ZA00904 15205640
         L     LLSAVE,LCCACPUS                                 @ZA00904 15206040
         USING WSAC,LLSAVE                                     @AA00904 15206440
         L     LLSAVE,WSACIOS      ADDRESS OF IOS SAVE AREA    @ZA00904 15206840
         LR    WRKRG1,PARMRG       SAVE REG                    @ZA00904 15207240
         L     PARMRG,FRRSA        GET SAVEAREA TO FREE        @ZA00904 15207640
         XC    0(4,PARMRG),0(PARMRG)   CLEAR CHAIN PTR         @ZA00904 15208040
         L     CORERG,CORCNST2     INDICATE FREE 160 BYTES     @ZA00904 15208240
         L     LINKRG,COREMGR      GET STORAGE MANAGER ADDRESS @ZA00904 15208440
         BAL   RTRNRG,D4(LINKRG)   CALL FREE ENTRY             @ZA00904 15208740
         LR    PARMRG,WRKRG1       RESTORE REG                 @ZA00904 15209040
PSTCATR4 SETLOCK RELEASE,TYPE=IOSCAT,ADDR=IOCCATLK,                    *15209640
               RELATED=(PSTCAT,IECVPST(PSTCATO4))              @ZA00904 15216040
PSTRTN1  EQU   *                                               @ZA00904 15217040
         L     LLSAVE,FRRREGD      RESTORE REG 13 (VALID FOR            15219040
*                                  SVC F BRANCH ENTRANCE)               15220002
         L     RTRNRG,FRRDISP      RESTORE RETURN REGISTER              15230002
         SETFRR D,WRKREGS=(WRKRG1,WRKRG2)                               15250021
         LTR   IOSBRG,IOSBRG       IF REG IS ZERO, BRANCH RETURN        15310002
         BCR   D7,RTRNRG           NO, RETURN TO DISPATCHER             15320002
         DROP  IOSBRG                                           YM00152 15322002
         USING IOSB,PARMRG                                              15330002
         SPACE 1                                                        15330402
*        SWAP TO USERS KEY BEFORE BRANCHING TO HIM                      15332002
         MODESET  SWAPKEY,KEYADDR=IOSPKEY,WORKREG=8                     15340002
         SPACE 1                                                        15342002
         L     LINKRG,IOSPGAD      SET UP ADDR FOR BR RET      @ZA10093 15344040
         BR    LINKRG              TO CALLER VIA BRANCH                 15350002
         DROP  PARMRG                                           YM00152 15360002
         USING IOSB,IOSBRG                                      YM00152 15370002
         EJECT                                                          15370540
*********************************************************************** 15371040
*   IECVDAVV IS TO RECEIVE CONTROL.  IF THE UNSOLICITED DEVICE END    * 15372040
*       IS FROM A PAGE PACK, CALL DAVV DIRECTLY WHILE STILL IN SRB    * 15373040
*       MODE--THIS PATH IS TO PREVENT INTERLOCKS WHICH MIGHT OTHERWISE* 15374040
*       OCCUR IF THE LOCAL LOCK WERE ALREADY HELD AND A PAGE FAULT    * 15375040
*       OCCURRED.                                                     * 15376040
*********************************************************************** 15377040
         SPACE                                                          15378040
PSTDAVV1 L     UCBREG,IOSUCB       POINT TO UCB                @ZA00904 15379040
         USING UCBOB,UCBREG                                    @ZA00904 15380040
         TM    UCBSTAB,UCBPGFL     IS CALL FOR PAGE PACK       @ZA00904 15381040
         BZ    PSTEFF              NO--CALL THRU EXIT EFFECTOR @ZA00904 15382040
         BAL   RTRNRG,PSTLOCK      YES--GET SPECIAL SAVE AREA  @ZA00904 15383040
         LR    PARMRG,IOSBRG       SET IOSB POINTER            @ZA00904 15384040
         L     LINKRG,DAVALT       GET ALTERNATE DAVV ENTRY    @ZA00904 15385040
         BALR  RTRNRG,LINKRG       CALL IECVDAVV               @ZA00904 15386040
*********************************************************************** 15387040
*        SPECIAL DAVV RETURN VECTOR                                     15388040
*                                                                       15389040
         B     PSTGDPT             RETRY I/O                   @ZA00904 15390040
         B     PSTEWA              FREE IOSB AND EXIT          @ZA00904 15391040
         B     PSTRTN              EXIT DIRECTLY               @ZA00904 15392040
         B     PSTWAIT             CALL RESTARTABLE WAIT       @ZA00904 15393040
         TITLE '   IECVPST - ERP INTERFACE   '                          15400002
******************************************************************      15420002
*                                                                *      15430002
*  ERROR ROUTINE INTERFACE                                       *      15440002
*                                                                *      15442002
******************************************************************      15444002
         SPACE 1                                                        15446002
PSTEFF   TM    IOSFLA,IOSIOSB      IS THIS IOS IOSB?                    15448002
         BO    PSTEFFA             YES-BYPASS CHECK FOR IDR             15448402
         SPACE 1                                                        15448802
         TM    IOSPKEY,IOSIDR      PAGING I/O?                          15449202
         BZ    PSTEFFA             NO-USE LOCAL LOCK SAVE AREA          15449602
         SPACE 1                                                        15449702
*  PAGING I/O REQUEST - DO NOT USE LOCAL LOCK SAVE AREA AS              15449802
*  INTERLOCK COULD OCCUR                                                15449902
         SPACE 1                                                        15466602
         L     LLSAVE,IOSUSE       POINT AT IOMB                        15476602
         USING IORB,LLSAVE                                     @Z40WPLL 15477640
         SPACE 1                                                        15478640
         L     LLSAVE,IORSAVE      POINT AT USER'S SAVE AREA   @Z40WPLL 15479640
         B     PSTSKEP             CONTINUE                             15483002
         SPACE 3                                                        15483102
PSTEFFA  TM    FRRFLGA,FRRLOCAL    IF LOCAL LOCK  HELD,                 15483302
         BM    PSTDAVV             BRANCH AROUND                        15500021
         BAL   RTRNRG,PSTLOCK      GO TO GET LOCAL LOCK                 15550021
PSTDAVV  TM    IOSFLA,IOSIOSB      IF NOT AN IOS IOSB,                  15600021
         BZ    PSTSKEP             BRANCH AROUND TYPE TEST              15650021
         SR    WRKRG1,WRKRG1       ZERO WORK REGISTER                   15700021
         IC    WRKRG1,IOSPROC      GET PROCESS TYPE INDICATOR           15750021
         LTR   WRKRG1,WRKRG1       SPECIAL PROCESSING?                  15800021
         BP    PSTWTO              YES, SKIP ERP TESTS         @ZA00904 15820040
PSTSKEP  TM    IOSOPT,IOSNERP      ARE IBM ERPS TO BE USED?             15900021
         BO    PSTCODP             NO, SKIP ERP INTERFACE & POST        15950021
         L     WRKRG1,IOSERP       GET ADDRESS OF WORKAREA              16000002
         LTR   WRKRG1,WRKRG1       WORKAREA EXIST?                      16050021
         BNZ   PSTDAT              YES, SKIP CORE MGMNT INTRFACE        16100021
         SPACE 1                                                        16150021
* INTERFACE WITH CORE MANAGEMENT TO GET ERP WORKAREA                    16200021
         SPACE 1                                                        16250021
         L     LINKRG,COREMGR      GET ADDR OF CORE MGMNT RTN           16300021
         LH    CORERG,IOSASID      PUT ASID IN REG 11                   16350021
         SLL   CORERG,D16          SHIFT TO MIDDLE OF REGISTER          16400021
         SRL   CORERG,D8                                                16450021
         O     CORERG,CORCNST      INDICATE 1 BLOCK IN HIGH BYTE        16500021
*                                  AND SIZE (160) IN LOW BYTE           16550021
         BALR  RTRNRG,LINKRG       GO TO CORE MANAGEMENT                16600021
         SPACE 2                                                        16650021
         ST    CORERG,IOSERP       PUT ADDR OF ERP WA IN IOSB           16700021
         MVI   D0(CORERG),D0       ZERO FIRST BYTE OF WORKAREA          16750021
         MVC   D1(D159,CORERG),D0(CORERG)                      @YM03259 16800002
*                                  PROPOGATE TO ZERO A TOTAL OF         16850021
*                                  160 BYTES IN ERP WORKAREA            16900002
PSTDAT   L     UCBREG,IOSUCB       GET UCB ADDRESS                      16950021
         USING UCBOB,UCBREG                                             17000002
         TM    UCBTBYT3,UCB3DACC   IF NOT DIRECT ACCESS                 17050021
         BZ    PSTSCHE             GO SCHEDULE ERP                      17100021
         SPACE 1                                                        17150021
*        INTERFACE WITH DIRECT ACCESS ERP                               17200021
         SPACE 1                                                        17250021
         LR    PARMRG,IOSBRG       PUT IOSB ADDRESS IN REG 1            17300021
         L     LINKRG,DAERP        GET ADDRESS OF DA ERP                17350021
         BALR  RTRNRG,LINKRG       GO TO RESIDENT DA ERP                17400021
         EJECT                                                          17450002
****************************************************************        17500021
*                                                              *        17550021
*        DIRECT ACCESS ERP RETURN VECTOR TABLE                 *        17600021
*                                                              *        17650021
         B     PSTGDPT             RETRY RETURN                *        17700021
         B     PSTFTST             FETCH/PERM/FIXED ERROR     *@YM08292 17750002
         B     PSTWTO              ASYNC ERROR PROCESSING     *@ZA00904 17770040
         B     PSTPOST             POST RETURN                 *        17850021
*                                                              *        17900021
****************************************************************        17950021
         SPACE 2                                                        18000021
PSTPOST  BAL   RTRNRG,PSTSUB       GO TO SUBR TO FREE RESOURCES         18050021
         B     PSTEABN             GO TO INTRFC WITH ABN EXIT           18100021
         SPACE 2                                                        18100540
*  TEST FOR CALL TO IGE0025C (WTO ROUTINE) WHEN IOSB IS FOR THE PAGE  * 18101040
*        PACK--IF IT IS THEN ENTER A RESTARTABLE WAIT STATE.  THIS IS * 18102040
*        TO PREVENT A POSSIBLE INTERLOCK BETWEEN WAITING FOR LOCAL    * 18103040
*        LOCK AND A PAGE FAULT                                        * 18104040
         SPACE                                                          18105040
PSTWTO   CLI   IOSPROC,IOSAWTO     IS THIS A CALL TO 25C       @ZA00904 18106040
         BNE   PSTSCHE             NO--CONTINUE NORMAL         @ZA00904 18107040
         L     UCBREG,IOSUCB       GET UCB POINTER             @ZA00904 18108040
         TM    UCBTBYT3,UCB3DACC   IS THE DEVICE DIRECT ACCESS @ZA00904 18109040
         BZ    PSTSCHE             NO--CONTINUE NORMAL         @ZA00904 18110040
         TM    UCBSTAB,UCBPGFL     IS IT A PAGE PACK           @ZA00904 18111040
         BZ    PSTSCHE             NO--CONTINUE NORMAL         @ZA00904 18112040
         TM    UCBFLC,UCBIVRR      IS INTERVENTION REQUIRED    @ZA00904 18113040
         BZ    PSTWTO10            NO--CHECK CC 3              @ZA00904 18114040
         NI    IOSFLC,MASKFF-IOSRWAIT YES--CLEAR WAIT FLAG     @ZA00904 18115040
         OI    IOSFLC,IOSRWIR      INDICATE INTV. REQ          @ZA00904 18116040
         OI    UCBFLA,UCBNRY       SET NOT READY--RESET WHEN   @ZA33089 18117040
*                                    OPERATOR READY'S DEVICE   @ZA33089 18117140
         B     PSTWAIT             CALL RESTARTABLE WAIT       @ZA33089 18117240
PSTWTO10 TM    IOSCC,IOSCC3        CONDITION CODE 3?  @ZA00904,@ZA18100 18117540
         BNO   PSTSCHE             NO--PERM I/O ERROR IS ONLY CONDITION 18118040
*                                  LEFT-HANDLE NORMLY @ZA00904,@ZA18100 18119040
         SR    WRKRG1,WRKRG1       CLEAR REGISTER              @ZA26432 18119140
         SR    WRKRG2,WRKRG2       CLEAR REGISTER              @ZA26432 18119240
         IC    WRKRG1,UCBCHM       GET PATHS AVAILABLE FROM    @ZA26432 18119340
*                                  UCB CHANNEL MASK            @ZA26432 18119440
         IC    WRKRG2,IOSWTOPT     GET PATHS THAT HAVE CC3     @ZA26432 18119540
*                                  FROM IOSB                   @ZA26432 18119640
         OR    WRKRG1,WRKRG2       PATHS UNAVAILABLE|ATTEMPTED @ZA26432 18119740
         L     TRAREG,UCBEXTPT    GET ADDR OF COMMON EXTENSION @ZA30808 18119840
         USING UCBCMEXT,TRAREG                                 @ZA30808 18119940
         IC    WRKRG2,UCBPMSK      GET CC=3 PATHS              @ZA30808 18120040
         DROP  TRAREG                                          @ZA30808 18120140
         OR    WRKRG1,WRKRG2       UNAVAILABLE|CC=3            @ZA30808 18120240
         CH    WRKRG1,KF0          X'F0' = NO PATHS AVAILABLE  @ZA30808 18120840
         BNE   PSTSCHE             IF THERE ARE STILL PATHS    @ZA26432 18121640
*                                  AVAILABLE, ISSUE MESSAGE    @ZA26432 18121740
*                                  IF NOT, WAIT 02F            @ZA26432 18121840
         NI    IOSFLC,MASKFF-IOSRWAIT  CLEAR WAIT FLAG         @ZA00904 18121940
         OI    IOSFLC,IOSRWCC3     INDICATE CONDITION CODE 3   @ZA00904 18122040
         B     PSTWAIT             CALL RESTARTABLE WAIT       @ZA00904 18125040
         SPACE 2                                                        18150021
* INTERFACE WITH EXIT EFFECTOR TO SCHEDULE ERROR ROUTINE                18200021
         SPACE 1                                                        18250021
PSTSCHE  L     LINKRG,D16          SET UP ADDRESSABILITY TO CVT         18300021
         USING CVT,LINKRG                                               18350021
         TM    CVTOPTA,CVTNIP      BYPASS E.E. FOR NIP PROCSSNG?        18400021
         BO    PSTERC              YES, CONSIDER PERM ERROR             18450021
         DROP  LINKRG                                                   18500021
         L     SRBREG,IOSSRB       PUT SRB ADDRESS IN REG 0             18550021
         L     LINKRG,XITEFF       GET ADDRESS OF EXIT EFFECTOR         18600021
         SR    PARMRG,PARMRG       ZERO REGISTER 1                      18650021
         BALR  RTRNRG,LINKRG       GO TO EXIT EFFECTOR                  18700021
         B     PSTLLH              GO RETURN TO CALLER                  18750021
         SPACE                                                          18757002
* INTERFACE FOR PCI FETCH, IF IOSCOD=X71 GO TO PSTCHE,ELSE PSTEXT       18764002
         SPACE                                                          18771002
PSTFTST  CLI   IOSCOD,IOSFTCHC     IS IT A 71 FOR FETCH        @YM08292 18778002
         BNE   PSTEXT              NO, BRANCH PERM/FIXED ERROR @YM08292 18785002
         B     PSTCHE              YES, GO TO CHE APNDG WITH 71@YM08292 18792002
         TITLE '   IECVPST - APPENDAGE RETURNS 4,8,12  '                18800002
* DO NOTHING RETURN (+4) BRANCHES HERE                                  18850021
         SPACE 1                                                        18900021
PSTFRTN  LR    UCBREG,LINKRG       SAVE RETURN TO APPENDAGE             18910002
         BAL   RTRNRG,PSTSUB       GO TO SUBR TO FREE RESOURCES         18950002
         TM    FRRFLGA,FRRLLHLD    LOCAL LOCK HELD?                     19000021
         BZ    PSTAPRTN            NO, BRANCH AROUND RELEASE            19050021
         SPACE 1                                                        19100021
*        RELEASE LOCAL LOCK                                             19150021
         SPACE 1                                                        19200021
PSTRLS1  SETLOCK  RELEASE,TYPE=LOCAL,RELATED=(PSLCL,                   *19250021
               IECVPST(PSTLOCK))                                        19300021
         SPACE 1                                                        19350021
         XI    FRRFLGA,FRRLLHLD    RESET LOCAL LOCK HELD IND.           19400021
PSTAPRTN LR    LINKRG,UCBREG       RESTORE APPENDAGE RETURN             19410002
         LR    PARMRG,IOSBRG       RESTORE IOSB                @YM6180  19430002
         BALR  RTRNRG,LINKRG       RETURN TO APPENDAGE                  19450002
         SPACE 1                                                        19500021
****************************************************************        19550021
*                                                              *        19600021
*  ALL RETURNS FROM APPENDAGES AT THIS POINT ARE HANDLED THE   *        19650021
*  SAME IN THAT THEY ARE IGNORED.                              *        19700021
*                                                              *        19750021
         B     PSTRTN              RETURN TO DISPATCHER        *        19800021
         B     PSTRTN              FOR ALL RETUNS FROM THE     *        19850021
         B     PSTRTN              APPENDAGES                  *        19900021
         B     PSTRTN                                          *        19950021
*                                                              *        20000021
****************************************************************        20050021
         SPACE 1                                                        20100021
* RETRY RETURN BRANCHES HERE                                            20150021
         SPACE 1                                                        20200021
PSTERTN  BAL   RTRNRG,PSTSUB       GO TO SUBR TO FREE RESOURCES         20250021
         SPACE 1                                                        20300021
PSTSIO   TM    FRRFLGA,FRRLOCAL    LOCAL LOCK HELD?                     20350021
         BM    PSTSIOM             YES, SKIP GETTING LOCK               20400021
         TM    IOSPKEY,IOSIDR      PAGING I/O ?                @YM06764 20408002
         BZ    PSTSIOT             NO - GET LOCAL LOCK         @YM06764 20416002
         ST    BASERG,FRRREGD      SAVE BASE, FRRREGD NOT NEED @YM08289 20424002
         LR    LLSAVE,FRRSAV       SAVE R4 IN R13 FOR SIO      @YM08289 20432002
         B     PSTSIOM2            DO SIO THIS PATH (IDR) RTRY @YM08289 20440002
         SPACE                                                          20445002
PSTSIOT  BAL   RTRNRG,PSTLOCK      GO GET LOCAL LOCK                    20450002
PSTSIOM  L     PARMRG,IOSSRB       GET ADDRESS OF SRB FROM IOSB         20500021
         SPACE 1                                                        20550021
         STM   IOSBRG,BASERG,D0(LLSAVE) SAVE REGS                       20600002
         STARTIO SRB=(PARMRG),TCB=SRB                                   20650021
         LM    IOSBRG,BASERG,D0(LLSAVE) RESTORE REGS                    20700002
         SPACE 1                                                        20750021
         B     PSTLLH              BRANCH TO RELEASE LOCK               20800021
         SPACE 2                                                        20850021
* RETURN 12 SPECIFIES DDR PROCESSING REQUIRED AND IS USED ONLY          20900021
* BY THE PAGING SUPERVISOR.                                             20950021
         SPACE 1                                                        21000021
PSTTRTN  TM    FRRFLGA,FRRLOCAL    IF LOCAL LOCK HELD,                  21050002
         BM    PSTSKP              BRANCH AROUND GETTING IT             21100021
         BAL   RTRNRG,PSTLOCK      SUBROUTINE TO GET IT                 21150021
PSTSKP   MVI   IOSPROC,IOSADDR     SET IND. FOR DDR PROCESSING          21200021
         B     PSTSCHE             GO TO EXIT EFFECTOR INTERFCE         21250021
         SPACE                                                          21255002
PSTSIOM2 L     PARMRG,IOSSRB       GET ADDR OF SRB             @YM08289 21260002
         STARTIO SRB=(PARMRG),TCB=SRB                          @YM08289 21265002
         SPACE                                                          21270002
         LR    FRRSAV,LLSAVE       GET R4 TO ADDRESS FRR       @YM08289 21275002
         L     BASERG,FRRREGD      RESTORE BASE REG            @YM08289 21280002
         LA    IOSBRG,1            SET IOSBREG NOT ZERO TO DISP@YM08289 21285002
         B     PSTRTN              RETURN TO DISPATCHER        @YM08289 21290002
         TITLE '   IECVPST - IOS IOSB HANDLING    '                     21300002
****************************************************************        21350021
*                                                              *        21400021
*   THIS CODE IS BRANCHED INTO AS A VECTOR TABLE DEPENDING ON  *        21450021
*   THE CONTENTS OF AN INDEX IN THE IOSB (IOSPROC). THE  FOL-  *        21500021
*   LOWING CODE SETS UP TO DO THE BRANCH BASED ON  THE  INDEX  *        21550021
*   VALUES AS DESCRIBED BELOW:                                 *        21600021
*                                                              *        21650021
*   +0  - RESERVED - HANDLE AS NON-IOS GENERATED IOSB          *        21700021
*   +4  - PCI PROCESSING REQUIRED                              *        21750021
*   +8  - ATTENTION PROCESSING REQUIRED                        *        21800021
*   +12 - PURGE PROCESSING REQUIRED                            *        21850002
*   +16 - DAVV PROCESSING REQUIRED                             *        21900021
*   +20 - WTO PROCESSING REQUIRED                              *        21950021
*   ALL OTHER VALUES ARE CURRENTLY IGNORED                     *        22000021
*                                                              *        22050021
****************************************************************        22100021
         SPACE 1                                                        22150021
PSTIOSB  CLI   IOSCOD,IOSABNC      IF POST CODE IS X'45',               22160002
         BE    PSTERC              BYPASS PROCESSING                    22170002
         SPACE 1                                                        22180002
         SR    WRKRG1,WRKRG1       ZERO WORK REGISTER                   22200002
         IC    WRKRG1,IOSPROC      PICK UP INDEX                        22250021
         B     PSTIDX(WRKRG1)      BRANCH BASED ON INDEX                22300021
         SPACE 1                                                        22350021
****************************************************************        22400021
*                                                              *        22450021
PSTIDX   B     PSTNRM                                          *        22500021
         B     PSTHPCI                                         *        22550021
         B     PSTHATTN                                        *        22600021
         B     PSTPURG                                         *        22650002
         B     PSTDAVV1                                        *        22670040
         B     PSTEFF                                          *        22750021
         B     PSTHPCI                                         *        22760003
         B     PSTEFF                                          *        22770003
*                                                              *        22800021
****************************************************************        22850021
         SPACE 1                                                        23000021
* INTERFACE WITH PCI APPENDAGE                                          23050021
         SPACE 1                                                        23100021
PSTHPCI  LR    PARMRG,IOSBRG       PUT IOSB ADDRESS IN REG 1            23150002
         L     LINKRG,IOSPCI       GET PCI ENTRY ADDRESS                23200021
         BALR  RTRNRG,LINKRG       GO TO PCI APPENDAGE                  23250021
         SPACE 2                                                        23300021
PSTPCICH LR    TRAREG,LLSAVE       SAVE 13 ACROSS SETLOCK               23350002
* GET IOSYNCH LOCK WHILE INTERROGATING AND ADJUSTING PCI CHAIN          23400021
         SPACE 1                                                        23450021
         L     CORERG,D16          SET UP ADDRESSABILITY TO             23500002
         USING CVT,CORERG          THE IOCOM VIA THE CVT                23550021
         L     CORERG,CVTIXAVL                                          23600021
         USING IOCOM,CORERG                                             23650021
         LR    UCBREG,CORERG       SAVE IOCM ADDR ACROSS SETLOCK        23700021
         SPACE 1                                                        23750021
PSTSYNO  SETLOCK OBTAIN,TYPE=IOSYNCH,ADDR=IOCSYNCH,MODE=UNCOND,        *23800021
               RELATED=(PSSYN,IECVPST(PSTSYN1,PSTSYN2))                 23850021
         OI    FRRFLGA,FRRSYNCH    SET SYNCH LOCK HELD IND.             23900002
         LR    LLSAVE,TRAREG       RESTORE SAVE AREA ADDRESS            24000021
         LR    CORERG,UCBREG       RESTORE IOCM ADDRESS                 24050021
         SPACE 1                                                        24100021
PSTPCIL  L     WRKRG1,IOSIPIB      GET PCI CHAIN ADDRESS                24150002
         LTR   WRKRG1,WRKRG1       ANOTHER SRB EXIST?                   24200021
         BZ    PSTFREE             NO, GO TO RETURN SRB'S               24250021
         L     WRKRG2,IOSPCHN      GET ADDR OF ENDING STATUS SRB        24300021
         CR    WRKRG1,WRKRG2       IS NEXT SRB FOR FINAL STATUS         24350021
         BE    PSTADJ              YES, BRANCH TO CLEAN-UP              24400021
         SPACE 1                                                        24450021
         L     WRKRG2,IOSSRB       GET ADDRESS OF THIS SRB              24500021
         LR    IOSBRG,WRKRG1       PUT NEXT IOSB ADDR IN REG 2          24550021
         L     WRKRG1,IOSSRB-IOSB(WRKRG1)                               24600002
*                                  GET ADDRESS OF NEXT SRB              24650021
         ST    WRKRG1,D0(WRKRG2)   CHAIN SRB'S VIA FIRST WORD           24700021
         SR    WRKRG2,WRKRG2       ZERO WORK REGISTER                   24750021
         ST    WRKRG2,D0(WRKRG1)   ZERO FIRST WORD OF NEXT SRB          24800021
         TM    FRRFLGB,FRRECRSN    IF FRR IN CONTROL,                   24810002
         BO    PSTPCIL             CONTINUE CHAINING                    24820002
         SPACE 1                                                        24850021
* RELEASE IOSYNCH LOCK                                                  24900021
         SPACE 1                                                        24950021
         LR    TRAREG,LLSAVE       SAVE 13 ACROSS SETLOCK               25000021
PSTSYN1  SETLOCK  RELEASE,TYPE=IOSYNCH,ADDR=IOCSYNCH,                  *25050021
               RELATED=(PSSYN,IECVPST(PSTSYNO))                         25100021
         XI    FRRFLGA,FRRSYNCH    RESET SYNCH LOCK HELD IND.           25150002
         LR    LLSAVE,TRAREG       RESTORE SAVE AREA ADDRESS            25200021
         BAL   TRAREG,PSTTRA       TRANSLATE CSW               @YM07021 25220002
         B     PSTHPCI             BRANCH TO GO TO PCI EXIT             25250021
         SPACE 1                                                        25300021
PSTFREE  L     WRKRG2,IOSPCHN      GET ENDING STATUS IOSB ADDR          25350021
         USING IOSB,WRKRG2                                              25400021
         SR    WRKRG1,WRKRG1       ZERO WORK REGISTER                   25450021
         ST    WRKRG1,IOSPCHN      ZERO POINTER TO FIRST SRB            25500021
         DROP  WRKRG2                                                   25550021
         USING IOSB,IOSBRG         REESTABLISH ADDRESSABILITY           25600002
         SPACE 1                                                        25650021
* RELEASE IOSYNCH LOCK                                                  25700021
         SPACE 1                                                        25750021
         LR    TRAREG,LLSAVE       SAVE 13 ACROSS SETLOCK               25800021
PSTSYN2  SETLOCK  RELEASE,TYPE=IOSYNCH,ADDR=IOCSYNCH,                  *25850021
               RELATED=(PSSYN,IECVPST(PSTSYNO))                         25900021
         XI    FRRFLGA,FRRSYNCH    RESET SYNCH LOCK HELD IND.           25950002
         LR    LLSAVE,TRAREG       RESTORE SAVE AREA ADDRESS            26000021
         DROP  CORERG                                                   26050021
         SPACE 1                                                        26100021
* INTERFACE WITH STORAGE MANAGEMENT                                     26150002
         SPACE 1                                                        26200021
*  CHECK FOR FRR PROCESSING BEFORE GOING TO STORAGE MNGR       @ZA06077 26210040
         SPACE 1                                                        26220040
         TM    FRRFLGB,FRRECRSN    IF FRR IN CONTROL,          @ZA06077 26230040
         BO    PSTFRRSD            BRANCH BACK TO FRR CODE     @ZA06077 26240040
         TM    FRRFLGA,FRRLOCAL    LOCAL LOCK HELD?                     26250021
         BM    PSTCRM              YES, BYPASS GETTING IT               26300021
         SPACE 1                                                        26350021
         BAL RTRNRG,PSTLOCK        GO TO GET LOCAL LOCK                 26400021
         SPACE 1                                                        26450021
PSTCRM   L     PARMRG,FRRSRB       PUT FIRST SRB ADDR IN REG 1 @ZA06077 26452040
*        DELETED TWO INSTRUCTIONS FOR APAR                     @OZ08484 26500040
PSTCRMA  LA    RTRNRG,PSTLLH       SET UP RETURN TO RELEASE LOCK        26550002
         B     PSTSUBR             GO TO SUBR TO INTERFACE WITH         26600002
*                                  STORAGE MANAGEMENT                   26650002
         SPACE 1                                                        26700021
* SCHEDULE POST STATUS TO RUN UNDER THE ENDING STATUS SRB               26750021
         SPACE 1                                                        26800021
*                                  SET ENDING STATUS SRB ADDR           26850021
PSTADJ   L     SRBASE,IOSSRB-IOSB(WRKRG2) SRB ADDRESS                   26900002
         USING SRBSECT,SRBASE                                           26950021
         L     WRKRG1,FRRSRB       GET SCHEDULED SRB ADDRESS            27000021
*                                  MOVE ASCB ADDR TO E.S. SRB           27050021
         L     WRKRG2,SRBASCB-SRBSECT(WRKRG1)                           27100021
         ST    WRKRG2,SRBASCB                                           27150021
         L     WRKRG2,SRBCPAFF-SRBSECT(WRKRG1)                          27200021
         ST    WRKRG2,SRBCPAFF     MOVE CPU AFF AND ASID TO SRB         27250021
         LM    WRKRG2,TRAREG,SRBEP-SRBSECT(WRKRG1)                      27300021
         STM   WRKRG2,TRAREG,SRBEP MOVE EP AND RMTR TO SRB              27350021
*                                  MOVE PROTECT KEY TO SRB              27400021
         MVZ   SRBPKF,SRBPKF-SRBSECT(WRKRG1)                            27450021
         IC    WRKRG2,SRBPRIOR-SRBSECT(WRKRG1)                          27500021
         STC   WRKRG2,SRBPRIOR     MOVE PRIORITY TO SRB         YM01390 27550002
         LR    WRKRG2,PARMRG       SAVE SDWA PTR                        27570002
         LR    PARMRG,SRBASE       PUT SRB ADDR IN REG 1                27600021
         SCHEDULE SRB=(1),SCOPE=GLOBAL SCHEDULE POST STATUS             27650021
         SPACE 2                                                        27700021
         LR    PARMRG,WRKRG2       RESTORE SDWA PTR                     27720002
         B     PSTFREE             GO TO FREE IOSB CHAIN                27750021
         SPACE 2                                                        27800021
* ATTENTION HANDLING FOR IOS - IOSB                                     27850021
         SPACE 1                                                        27900021
PSTHATTN LR    PARMRG,IOSBRG       PUT IOSB ADDRESS IN REG 1            27910002
         L     LINKRG,IOSPGAD      GET ADDR OF ATTENTION RTN            27950002
         BALR  RTRNRG,LINKRG       GO TO ATTENTION ROUTINE              28000021
         SPACE 1                                                        28050021
****************************************************************        28100021
*                                                              *        28150021
*        BRANCH TABLE FOR ATTENTION ROUTINE RETURN             *        28200021
*                                                              *        28250021
         B     PSTNATN             NORMAL, PROCESSING COMPLETE *        28300021
         B     PSTSATN             RESCHEDULE TO PROPER MEMORY *        28350021
*                                                              *        28400021
****************************************************************        28450021
         SPACE 2                                                        28500021
*  NORMAL RETURN BRANCHES HERE AS DOES PURGE PROCESSING CLEANUP         28550002
         SPACE 1                                                        28600021
PSTNATN  TM    FRRFLGA,FRRLOCAL    IF LOCAL LOCK IS HELD,               28650021
         BM    PSTCRM              GO FREE IOS IOSB NORMALLY            28700021
         SPACE 1                                                        28750021
*  GET CAT LOCK TO PROVIDE SAVE AREA FOR CORE MANAGER. THIS IS          28800021
*  DONE BECAUSE ATTENTION AND PURGE PROCESSING IS DONE WHILE            28850002
*  RUNNING IN THE MASTER MEMORY                                         28852002
         SPACE 1                                                        28900021
         L     TRAREG,D16          SET UP ADDRESSABILITY TO             28950021
         USING CVT,TRAREG          THE IOCOM VIA THE CVT                29000021
         L     TRAREG,CVTIXAVL                                          29050021
         USING IOCOM,TRAREG                                             29100021
         SPACE 1                                                        29150021
PSTCATO  SETLOCK  OBTAIN,TYPE=IOSCAT,ADDR=IOCCATLK,MODE=UNCOND,        *29200021
               RELATED=(PSCAT,IECVPST(PSTCATR))                         29250021
         OI    FRRFLGA,FRRCATLK    SET CAT LOCK HELD IND.               29260002
         SPACE 1                                                        29300021
         USING PSA,0               GET LCCA SAVE AREA IN REG 13         29350021
         L     LLSAVE,PSALCCAV                                          29400021
         USING LCCA,LLSAVE                                              29450021
         L     LLSAVE,LCCACPUS                                          29500021
         USING WSAC,LLSAVE                                              29550021
         L     LLSAVE,WSACIOS      ADDRESS OF IOS SAVE AREA             29600021
         SPACE 1                                                        29650021
         L     PARMRG,FRRSRB       PUT SRB ADDR IN REG 1                29700021
         BAL   RTRNRG,PSTSUBR      GO TO CORE MANAGER                   29750021
         SPACE 1                                                        29800021
*  RELEASE CATLOCK                                                      29850021
         SPACE 1                                                        29900021
PSTCATR  SETLOCK  RELEASE,TYPE=IOSCAT,ADDR=IOCCATLK,                   *29950021
               RELATED=(PSTCAT,IECVPST(PSTCATO))                        30000021
         SPACE 1                                                        30050021
         DROP  TRAREG                                                   30100021
         DROP  LLSAVE                                                   30150021
         SPACE 1                                                        30200021
         B     PSTRTN              BRANCH TO RETURN                     30250021
         SPACE 1                                                        30300021
*  RE-SCHEDULE RETURN BRANCHES HERE - ASID RETURNED IN IOSASID          30350021
         SPACE 1                                                        30400021
PSTSATN  EQU   *                   RE-SCHEDULE ATTENTION ROUTINE        30450002
         L     SRBASE,IOSSRB       GET SRB ADDRESS                      30500021
         USING SRBSECT,SRBASE                                           30550021
         LH    WRKRG1,IOSASID      GET NEW ASID                         30600021
         STH   WRKRG1,SRBPASID     AND MOVE TO SRB                      30650021
         L     WRKRG2,D16          GET CVT ADDRESS                      30700002
         USING CVT,WRKRG2                                       VS02561 30750002
         L     WRKRG2,CVTASVT      GET ASVT ADDRESS                     30800021
         USING ASVT,WRKRG2         ADDRESSABILITY TO ASVT               30810002
         SLL   WRKRG1,D2           MULTIPLY ASID BY FOUR                30850021
         L     WRKRG2,ASVTFRST(WRKRG1) GET ASCB ADDRESS         VS02560 30900002
         ST    WRKRG2,SRBASCB      AND MOVE TO SRB                      30950021
         LR    PARMRG,SRBASE                                            31000021
         SPACE 1                                                        31050021
*   SCHEDULE POST STATUS INTO REQUESTED MEMORY                          31100021
         SCHEDULE  SRB=(1),SCOPE=GLOBAL                                 31150021
         SPACE 1                                                        31200021
         B     PSTLLH              GO TO RELEASE LOCK AND RETURN        31250021
         SPACE 1                                                        31300021
         EJECT                                                          31562002
PSTPURG  L     SRBASE,FRRSRB       GET SRB ADDRESS                      31570002
         USING SRBSECT,SRBASE                                           31580002
         MVC   SRBID(D4),IOSERP    CHAIN ERP W.A. FROM SRB              31590002
         B     PSTNATN             USE ATTENTION ROUTINE PROCESSING     31592002
*                                  TO GET LOCK AND FREE SRB/IOSB AND W. 31594002
         DROP  SRBASE                                          @ZA06650 31595040
         TITLE '   IECVPST - SVC F ENTRANCE  '                          31600002
*****************************************************************       31650021
*                                                               *       31700021
*    THIS IS THE SVC F ENTRANCE USED BY THE TRANSIENT ERPS TO   *       31750021
*    RETRY AND TO POST THE CALLER WHEN THE ERROR IS PERMANENT   *       31800021
*    OR FIXED. IF IOSERR IS ON UPON ENTRANCE,  A RETRY IS IN-   *       31850021
*    DICATED. IF IOSERR IS OFF AND IOSEX IS ON,  THE ERROR IS   *       31900021
*    CONSIDERED PERMANENT.  THE IOSB IS POSTED AND THE  USERS   *       31950021
*    ABNORMAL END APPENDAGE IS ENTERED.  IF IOSERR IS OFF AND   *       32000021
*    IOSEX IS OFF, THE ERROR HAS BEEN CORRECTED.  THE IOSB IS   *       32050021
*    POSTED WITH A 7F AND THE USER'S CHANNEL END APPENDAGE IS   *       32100021
*    ENTERED.  SVC F IS A TYPE I SVC AND IS ENTERED WITH  THE   *       32150021
*    LOCAL LOCK.                                                *       32200021
*    THIS SVC IS INTENDED ONLY FOR SUPERVISOR STATE CALLERS.   @ZA05814 32205040
*    ANY NON-SUPERVISOR STATE CALLER IS ABENDED.               @ZA05814 32210040
*                                                               *       32250021
*****************************************************************       32300021
         SPACE 1                                                        32350021
IGC015   BALR  BASERG,D0           ADDRESSABILITY TO SVC F              32400002
         USING *,BASERG                                                 32450021
PST015   S     BASERG,IGC015A      ADJUST BASE TO                       32500002
         USING PSTBASE,BASERG      POST STATUS ADDRESSABILTY            32550002
         LR    IOSBRG,PARMRG       PUT IOSB ADDRESS IF REG 2            32650002
         SPACE 1                                                        32700021
         LA    TRAREG,PSTFRRTN     GET FRR ROUTINE ADDRESS              32750021
         SETFRR A,FRRAD=(TRAREG),PARMAD=(FRRSAV),                      *32800021
               WRKREGS=(WRKRG1,WRKRG2)                                  32850021
         USING FRRAREA,FRRSAV      ADDRESSABILITY TO FRR AREA           32900021
         ST    LLSAVE,FRRREGD      SAVE REG D FOR BR ENTRY              32910002
         L     SRBREG,IOSSRB       GET SRB ADDR FROM IOSB               32920002
         ST    SRBREG,FRRSRB       SAVE SRB ADDRESS                     32950021
         ST    RTRNRG,FRRDISP      SAVE DISP RETURN ADDR                33010002
         OI    FRRFLGA,FRRSVCNT    INDICATE SVC ENTRANCE                33050021
         L     WRKRG1,PSATOLD      GET TCB ADDRESS             @ZA09252 33050740
         LTR   WRKRG1,WRKRG1       ARE WE RUNNING UNDER TCB ?  @ZA09252 33051440
         BZ    PSTUSROK            NO, BRANCH AROUND TESTAUTH  @ZA09252 33052140
*   TEST IF USER IS SUPERVISOR STATE-IF NOT ABEND HIM WITH 20F @ZA05814 33053040
         TESTAUTH  STATE=YES,RBLEVEL=1,BRANCH=YES CHECK STATE  @ZA05814 33056040
         LTR   LINKRG,LINKRG       IS CALLER OK                @ZA05814 33059040
         BZ    PSTUSROK            YES - GO RESTORE REGS       @ZA05814 33062040
         SETFRR D,WRKREGS=(WRKRG1,WRKRG2)  DELETE FRR          @ZA06077 33064040
         LA    PARMRG,NVALUSER     NO - ABEND HIM WITH 20F     @ZA05814 33068040
         ABEND (PARMRG),DUMP,,SYSTEM                           @ZA05814 33071040
         SPACE 2                                                        33074040
PSTUSROK EQU   *                                                        33080040
         L     IOSBRG,FRRSRB      GET SRB ADDRESS              @ZA05814 33081040
         LR    SRBREG,IOSBRG      RESTORE SRB POINTER          @ZA05814 33083040
         L     IOSBRG,SRBPARM-SRB(IOSBRG) RESTORE IOSB PTR     @ZA05814 33086040
         L     RTRNRG,FRRDISP      RESTORE DISP RETURN REG     @ZA05814 33090040
         SPACE 1                                                        33100021
* PUT LOCAL LOCK SAVE AREA IN REGISTER 13                               33150021
         SPACE 1                                                        33200021
         USING PSA,0                                                    33250021
         L     WRKRG1,PSAAOLD                                           33300021
         USING ASCB,WRKRG1                                              33350021
         L     WRKRG1,ASCBASXB                                          33400021
         USING ASXB,WRKRG1                                              33450021
         LA    LLSAVE,ASXBFLSA                                          33500021
         SPACE                                                          33502040
         L     WRKRG2,ASXBSIRB     GET SIRB PTR FROM ASXB      @ZA05822 33505040
         TM    RBSTAB2-RBBASIC(WRKRG2),RBFACTV   IS SIRB ACTIVE@ZA05822 33510040
         BZ    PSTCKERR                                                 33515040
         XC    RBIQEA+1-RBBASIC(D3,WRKRG2),RBIQEA+1-RBBASIC(WRKRG2)     33520040
*                                  ZERO SRB PTR IN SIRB        @ZA05822 33525040
PSTCKERR EQU   *                                               @ZA05822 33530040
         SPACE                                                          33535040
         DROP  WRKRG1                                                   33550021
         SPACE 1                                                        33600021
         TM    IOSFLA,IOSERR       IF ERROR ROUTINE IN CONTROL,         33650021
         BO    PSTGDPT             GO CHECK FOR GDP AND APR             33700021
         SPACE 1                                                        33750021
* PERMANENT OR FIXED ERROR HANDLED HERE                                 33800021
         SPACE 1                                                        33850021
PSTERC   EQU   *                                               @YM03811 33900002
         TM    IOSFLA,IOSIOSB      IOS GENERATED IOSB?                  33950021
         BO    PSTEWA              YES SEE IF EWA APPENDED     @YM06139 34150002
PSTEXT   TM    IOSFLA,IOSEX        IS ERROR PERMANENT?                  34200021
         BO    PSTCODP             YES, GO TEST FOR IOSCOD SET          34250021
         MVI   IOSCOD,IOSNRMC      FIXED ERROR, SET CODE TO 7F          34300021
         B     PSTCHE              AND GO TO CHE APPENDAGE              34350021
PSTEWA   L     PARMRG,IOSERP       LOAD EWA                    @YM06139 34357002
         LTR   PARMRG,PARMRG       IS THERE APPENDED EWA       @YM06139 34364002
         BZ    PSTCRM              NO                          @YM06139 34371002
         LA    RTRNRG,PSTCRM       YES LOAD RETURN ADDRESS     @YM06139 34378002
         B     PSTSUBR             GO TO SUBR TO INTERFACE WITH@YM06139 34385002
*                                  STORAGE MANAGER             @YM06139 34392002
         SPACE 1                                                        34400021
PSTCODP  CLI   IOSCOD,IOSNRMC      IF CODE IS NOT 7F, GO CHECK          34450021
         BNE   PSTCODI             FURTHER, OTHERWISE,                  34500021
         MVI   IOSCOD,IOSERRC      SET TO 41 AND GO TO ABE              34550021
         B     PSTEABN             APPENDAGE                            34600021
PSTCODI  CLI   IOSCOD,IOSFINTC     IF CODE IS NOT 7E, GO CHECK          34650021
         BNE   PSTCODF             FURTHER, OTHERWISE                   34700021
         MVI   IOSCOD,IOSINTC      SET TO 44 AND GO TO ABE              34750021
         B     PSTEABN             APPENDAGE                            34800021
PSTCODF  CLI   IOSCOD,IOSMIHC      IF CODE IS NOT 74, LEAVE AS          34850002
         BNE   PSTCODE             IS AND GO TO RETURN TO CALLER        34900002
         MVI   IOSCOD,IOSMIHCA     OTHERWISE SET CODE TO X'51'          34950002
         B     PSTEABN             GO TO ABE APPENDAGE                  34952002
PSTCODE  CLI   IOSCOD,IOSABNC      IF CODE IS 45 ON ENTRANCE,           34960002
         BE    PSTAPR              BYPASS APPENDAGE PROCESSING          34970002
         SPACE 1                                                        35000021
* INTERFACE WITH ABNORMAL END APPENDAGE                                 35050021
         SPACE 1                                                        35100021
PSTEABN  LR    PARMRG,IOSBRG       PUT IOSB ADDRESS IN REG 1            35150021
         L     LINKRG,IOSABN       GET ENTRY TO ABN EXIT                35200021
         BALR  RTRNRG,LINKRG       GO TO ABNORMAL END APPENDAGE         35250021
         SPACE 2                                                        35300021
****************************************************************        35350021
*                                                              *        35400021
*        ABNORMAL END APPENDAGE RETURN VECTOR TABLE            *        35450021
*                                                              *        35500021
         B     PSTAPR              NORMAL RETURN               *        35550021
         B     PSTFRTN             DO NOTHING RETURN           *        35600021
         B     PSTERTN             RETRY RETURN                *        35650021
         B     PSTTRTN             DDR PROCESSING REQUIRED     *        35700021
*                                  * RETURN +16 VECTOR IS HERE @Y30IPLB 35702003
         TM    FRRFLGA,FRRSVCNT    IF ENTRY BY SVC 15 THEN     @YM30155 35704003
         BNO   PSTRLS              RELEASE LOCAL LOCK AND EXIT @YM30155 35706003
         B     PSTRTN              IF NOT,BYPASS TERMINATION   @YM30155 35710003
*                                  CALL, RELEASE THE FRR, AND           35720003
*                                  THEN RETURN TO DISPATCHER.  @Y30IPLC 35730003
         SPACE                                                          35740003
*                                                              *        35750021
****************************************************************        35800021
         SPACE 1                                                        35850021
* RETRY REQUEST HANDLED HERE                                            35900021
         SPACE 1                                                        35950021
PSTGDPT  L     WRKRG2,IOSERP       GET ERP W.A. ADDR.                   36000021
         USING EWA,WRKRG2                                               36050021
         LTR   WRKRG2,WRKRG2       DOES EWA PTR = ZERO ?      @ZA19254  36060040
         BZ    PSTPATHT            YES, DONT SET EWA FLAGS    @ZA19254  36070040
         NI    EWAFLG1,MASKFF-EWABDSNS-EWASLIS                          36100021
*                                  RESET BAD SENSE INDICATOR            36150021
*                                  AND SILI SENSE INDICATOR             36200021
         MVI   EWASNSCT,MASK00     ZERO SENSE LOOP COUNT                36250021
         DROP  WRKRG2                                                   36300021
PSTPATHT TM    IOSPATH,IOSGDP      GUARANTEED DEVICE PATH     @ZA19254  36320040
         BO    PSTSIO              YES, GO SIO FOR RETRY                36400021
         BAL   RTRNRG,PSTRAPR      INTERFACE WITH APR                   36450021
         B     PSTSIO              GO SIO FOR RETRY                     36500021
         SPACE 1                                                        36550021
         TITLE '   IECVPST - GET LOCK SUBROUTINE  '                     36600002
****************************************************************        36610002
*     THIS SUBROUTINE GETS THE LOCAL  LOCK AND  PUTS THE       *        36620002
*     ADDRESS OF THE LOCAL LOCK SAVE AREA IN REGISTER 13.      *        36630002
****************************************************************        36640002
         SPACE 1                                                        36642002
PSTLOCK  EQU   *                   GET LOCAL LOCK                       36650002
         USING IORB,LLSAVE                                     @Z40WPLL 36651040
         TM    IOSOPT,IOSPSLL          LOCK NOT WANTED          @YM6764 36655002
         BNO   PSTLOCK1                YES IT'S WANTED          @YM6764 36660002
         TM    IOSPKEY,IOSIDR          PAGING IO                @YM6764 36665002
         BZ    PSTLOCK2                NO-GET LOCAL LOCK        @YM6764 36667040
         L     LLSAVE,IOSUSE           POINT AT IOMB            @YM6764 36675002
         L     LLSAVE,IORSAVE          POINT AT USER'S SAVE    @Z40WPLL 36677040
         BR    RTRNRG                  RETURN TO CALLER         @YM6764 36685002
PSTLOCK1 EQU   *                                                        36690002
         LR    LINKRG,RTRNRG       SAVE CALLERS RETURN                  36700021
         SETLOCK  OBTAIN,TYPE=LOCAL,MODE=UNCOND,                       *36750021
               RELATED=(PSLCL,IECVPST(PSTRLS,PSTRLS1))                  36800021
         SPACE 1                                                        36900021
         OI    FRRFLGA,FRRLLHLD    SET LOCAL LOCK HELD INDICATOR        36950021
         USING PSA,0               PUT ADDRESS OF LOCAL LOCK            37000021
         L     WRKRG1,PSAAOLD      SAVE AREA IN REGISTER 13             37050021
         USING ASCB,WRKRG1                                              37100021
         L     WRKRG1,ASCBASXB                                          37150021
         USING ASXB,WRKRG1                                              37200021
         LA    LLSAVE,ASXBFLSA                                          37250021
         DROP  WRKRG1                                                   37300021
         LR    RTRNRG,LINKRG       RESTORE CALLERS RETURN               37350021
         BR    RTRNRG              RETURN TO CALLER OF SUBR             37400021
         SPACE 2                                                        37400540
*   THE FOLLOWING TESTS DO NOT ALLOW THE LOCAL LOCK TO BE OBTAINED    * 37401040
*       IF THE IOSB IS FOR I/O TO THE PAGE PACK (BUT NOT THE PAGE     * 37402040
*       DATA SET--THEN IOSIDR WOULD BE ON).  THE REAL PURPOSE OF THE  * 37403040
*       CALL IS TO OBTAIN A SAVE AREA.                                * 37404040
PSTLOCK2 L     WRKRG1,IOSUCB       POINT TO UCB                @ZA10446 37405040
         TM    UCBTBYT3-UCBOB(WRKRG1),UCB3DACC                 @ZA10446 37405540
*                                  IS IT A DA UCB?             @ZA10446 37406040
         BZ    PSTLOCK1            NO--GET LOCK                @ZA00904 37407040
         TM    UCBSTAB-UCBOB(WRKRG1),UCBPGFL                   @ZA10446 37408040
*                                  IS IT A PAGE PACK?          @ZA10446 37408540
         BZ    PSTLOCK1            NO--GET LOCK                @ZA00904 37409040
         TM    FRRFLGA,FRRSAF      SAVE AREA ALREADY EXIST     @ZA00904 37410040
         BO    PSTLK10             YES--USE IT                 @ZA00904 37411040
         LR    WRKRG1,RTRNRG       SAVE RETURN ADDR            @ZA00904 37411640
*    GET CAT LOCK TO PROVIDE SAVE AREA FOR STORAGE MANAGER     @ZA00904 37413040
         L     SAVERG,D16          SET UP ADDRESSABILITY TO    @ZA10446 37414040
         USING CVT,SAVERG          THE IOCOM VIA THE CVT       @ZA10446 37414540
         L     SAVERG,CVTIXAVL                                 @ZA10446 37415040
         USING IOCOM,SAVERG                                    @ZA10446 37416040
         SPACE 1                                                        37417040
PSTCATO2 SETLOCK  OBTAIN,TYPE=IOSCAT,ADDR=IOCCATLK,MODE=UNCOND,        *37419040
               RELATED=(PSCAT,IECVPST(PSTCATR2))               @ZA00904 37420040
         OI    FRRFLGA,FRRCATLK    SET CAT LOCK HELD IND.      @ZA00904 37420640
         SPACE 1                                                        37422040
         USING PSA,0               GET LCCA SAVE AREA IN REG 13@ZA00904 37423040
         L     LLSAVE,PSALCCAV                                 @ZA00904 37424040
         USING LCCA,LLSAVE                                     @ZA00904 37425040
         L     LLSAVE,LCCACPUS                                 @ZA00904 37426040
         USING WSAC,LLSAVE                                     @ZA00904 37427040
         L     LLSAVE,WSACIOS      ADDRESS OF IOS SAVE AREA    @ZA00904 37428040
         LH    CORERG,IOSASID      CREATE INPUT PARM           @ZA00904 37429040
         SLL   CORERG,D8             FOR STORAGE MANAGER       @ZA00904 37430040
         O     CORERG,SMPARM         -- ONE 160 BYTE BLOCK     @ZA00904 37431040
         L     LINKRG,COREMGR      GET STORAGE MANAGER ADDRESS @ZA00904 37432040
         BALR  RTRNRG,LINKRG       GET STORAGE (A SAVE AREA)   @ZA00904 37433040
         ST    CORERG,FRRSA        SAVE STORAGE ADDRESS        @ZA00904 37434040
         L     SAVERG,D16          SET UP ADDRESSABILITY TO    @ZA10446 37435040
         USING CVT,SAVERG          THE IOCOM VIA THE CVT       @ZA10446 37435240
         L     SAVERG,CVTIXAVL                                 @ZA10446 37435440
         USING IOCOM,SAVERG                                    @ZA10446 37435640
PSTCATR2 SETLOCK RELEASE,TYPE=IOSCAT,ADDR=IOCCATLK,                    *37435840
               RELATED=(PSTCAT,IECVPST(PSTCATO2))              @ZA00904 37436040
         DROP  SAVERG                                          @ZA10446 37437040
         DROP  LLSAVE                                          @ZA00904 37438040
         NI    FRRFLGA,MASKFF-FRRCATLK  RESET LOCK FLAG        @ZA00904 37439040
         OI    FRRFLGA,FRRSAF      INDICATE SAVE AREA OBTAINED @ZA00904 37440040
         LR    RTRNRG,WRKRG1       RESTORE RETURN ADDR         @ZA00904 37441040
PSTLK10  L     LLSAVE,FRRSA        SET SAVE AREA POINTER       @ZA00904 37442040
         BR    RTRNRG              RETURN                      @ZA00904 37443040
         TITLE '   IECVPST - SUBR TO FREE RESOURCES  '                  37450002
****************************************************************        37460002
*   THIS SUBROUTINE INTERFACES WITH STORAGE MANAGER TO FREE    *        37470002
*   THE ERP WORKAREA (IOSERP) AND THEN THE SRB/IOSB.           *        37480002
****************************************************************        37490002
         SPACE 1                                                        37492002
PSTSUB   L     WRKRG1,IOSERP       GET ADDRESS OF ERP WORKAREA          37500021
         LTR   PARMRG,WRKRG1       WORKAREA EXIST?                      37550021
         BCR   D8,RTRNRG           NO, RETURN TO CALLER                 37600021
         SR    WRKRG1,WRKRG1       CLEAR WORK REGISTER                  37650021
         ST    WRKRG1,IOSERP       ZERO ERP WA ADDRESS                  37700021
         SPACE 1                                                        37750021
* THIS CHECK FOR THE LOCAL LOCK IS INSERTED HERE TO COVER THE           37800021
* CASE IN WHICH POST STATUS IS ENTERED WITH AN ERP WORK AREA            37850021
* APPENDED TO THE IOSB AND THE LOCAL LOCK NOT REQUESTED BUT             37900021
* THE ABNORMAL END APPENDAGE DECIDES THAT ERP PROCESSING OF             37950021
* THE ERROR IS NOT REQUIRED.                                            38000021
         SPACE 1                                                        38050021
         TM    FRRFLGA,FRRLOCAL    LOCAL LOCK HELD?                     38100002
         BM    PSTSUBR             YES, SKIP GETTING IT                 38150021
         LR    TRAREG,RTRNRG       SAVE CALLERS RETURN REG.             38200021
         BAL   RTRNRG,PSTLOCK      GO TO GET LOCAL LOCK                 38250021
         LR    RTRNRG,TRAREG       RESTORE CALLERS RETURN REG           38300021
         SPACE 1                                                        38350021
* INTERFACE WITH CORE MANAGEMENT TO FREE WORK AREA OR SRB/IOSB          38400002
* REGISTER 14 IS LEFT AS IS SO CORE  MANAGEMENT WILL RETURN TO          38450002
* CALLER OF THIS SUBROUTINE.                                            38500021
         SPACE 1                                                        38550021
PSTSUBR  L     LINKRG,COREMGR      GET ADDR OF CORE MGMNT RTN           38600021
         L     CORERG,CORCNST2     INDICATE BLOCK SIZE                  38650021
         B     D4(LINKRG)          GO TO CORE MANAGEMENT                38700021
         TITLE '   IECVPST - INTERFACE FOR TRANSLATION  '               38750002
PSTTRA   L     PARMRG,IOSCC        GET CCW ADDRESS FROM CSW             38800021
         LA    PARMRG,D0(PARMRG)   CLEAR HIGH ORDER BYTE                38850021
         LTR   PARMRG,PARMRG       ADDRESS ZERO ?                       38900021
         BCR   D8,TRAREG           YES, RETURN                          38950021
         BCTR  PARMRG,D0           DECREMENT BY ONE TO INSURE           39000002
*                                  PAGE BOUNDARY                        39050021
         L     LINKRG,D16          GET ADDRESS OF CVT                   39100021
         USING CVT,LINKRG                                               39150021
         L     LINKRG,CVTPTRV      GET ADDRESS OF CONVERT RTN           39200021
         DROP  LINKRG                                                   39250021
         BALR  RTRNRG,LINKRG       GO TO CONVERT ROUTINE                39300021
         SPACE 1                                                        39310002
         LTR   LINKRG,LINKRG       ZERO RETURN CODE?                    39320002
         BNZR  TRAREG              TRANSLATION UNSUCCESSFUL             39330002
*                                  LEAVE ADDRESS AS IS                  39340002
         SPACE 1                                                        39342002
         LA    PARMRG,D1(PARMRG)   INCR. VIRTUAL ADDR BY ONE            39350021
         IC    WRKRG1,IOSCC        SAVE CC ACROSS STORE                 39400021
         ST    PARMRG,IOSCC        PUT CCW ADDRESS BACK IN CSW          39450021
         STC   WRKRG1,IOSCC        PUT COND. CODE BACK                  39500021
         BR    TRAREG              RETURN TO CALLER                     39550002
         TITLE '   IECVPST - APR ROUTINE   '                            39600002
****************************************************************        39610002
*                                                              *        39620002
*  ALTERNATE PATH RETRY IS INITIATED ON ERP RETRY OF CHANNEL   *        39630002
*  ERRORS FOR ALL MULTI-PATH  DEVICES.  SHARED AND  RESERVED   *        39640002
*  CHECKS ARE MADE BY IOS AND THEREFORE, NOT DONE HERE. THIS   *        39642002
*  SUBROUTINE DETERMINES THE FAILING PATH AND SETS THE  COR-   *        39644002
*  RESPONDING INDICATOR IN THE  IOSAPMSK FIELD OF THE  IOSB.   *        39646002
*                                                              *        39648002
****************************************************************        39648402
         SPACE 2                                                        39648802
PSTRAPR  EQU   *                   APR                                  39650002
         TM    IOSTSB,MASK0F       ANY CHANNEL ERRORS?                  39660002
         BCR   D8,RTRNRG           NO,APR NOT NEEDED - RETURN           39670002
         SPACE 1                                                        39680002
         TM    IOSOPT,IOSAPR       APR ALREADY ACTIVE FOR THIS          39690002
         BO    PSTAPRA             REQUEST? YES NO INIT NEEDED          39692002
         OI    IOSOPT,IOSAPR       SET APR IN PROGRESS                  39694002
         XC    IOSAPMSK(D2),IOSAPMSK  INIT APR MASK TO ZERO             39696002
         SPACE 1                                                        39698002
*  ADDRESS ALTERNATE PATH TABLE TO DETERMINE PRIMARY OR SEC-   *        39698402
*  ONDARY PATH VIA CVT, IOCOM, AND LCHTABLE USING UCBLCI.      *        39698802
         SPACE 1                                                        39699202
PSTAPRA  L     WRKRG1,D16          POINT AT CVT                         39699602
         USING CVT,WRKRG1                                               39699702
         L     WRKRG1,CVTIXAVL                                          39699802
         USING IOCOM,WRKRG1                                             39699902
         L     WRKRG1,IOCLCHTB                                          39716602
         USING LCH,WRKRG1          LCH ADDRESSABILITY                   39718602
         L     UCBREG,IOSUCB       GET UCB ADDRESS              YM2588P 39720602
         SR    TRAREG,TRAREG                                            39722602
         IC    TRAREG,UCBLCI       GET LCH TABLE INDEX BYTE     YM2588P 39724602
         SLL   TRAREG,LCHELP2      MULTIPLY BY ENTRY LENGTH             39725402
         L     WRKRG1,LCHTCH(TRAREG) POINT TO ALT PATH TAB ENTRY        39725802
         SR    WRKRG2,WRKRG2       CLEAR WORK REG                       39728602
         L     TRAREG,IOSERP       SET ADDRESSABILITY TO EWA            39729002
         USING EWA,TRAREG                                               39729402
PSTAPRB  CLI   D0(WRKRG1),MASKFF   AT END OF TABLE?                     39730602
         BNE   PSTAPRC             NO, CONTINUE SEARCHING FOR           39732602
*                                  CORRECT ENTRY IN LCH TABLE           39733002
         NI    IOSOPT,MASKFF-IOSAPR RESET APR ACTIVE IND.               39733102
         BR    RTRNRG              RETURN                               39733202
         SPACE 1                                                        39738802
PSTAPRC  EQU   *                   SET FAILING PATH IN IOSB             39740802
         CLC   D0(D1,WRKRG1),EWACHA IS THIS THE FAILING PATH?           39743602
         BE    PSTAPRD             YES, CONTINUE                        39744002
         LA    WRKRG1,D2(WRKRG1)   NO,INCR TO NEXT TABLE ENTRY          39744102
         B     PSTAPRB             AND CONTINUE SEARCH                  39744202
PSTAPRD  IC    WRKRG2,D1(WRKRG1)   GET PATH INDICATOR                   39744302
         SLL   WRKRG2,D28          SHIFT OUT EXTRA BITS                 39758202
         SR    WRKRG1,WRKRG1                                            39760202
         IC    WRKRG1,EWACPU       GET FAILING CPU                      39768202
         SLL   WRKRG1,D1           MULTIPLY BY 2                        39770202
         SRL   WRKRG2,D0(WRKRG1)   SET TO CORRECT POSITION              39770602
         O     WRKRG2,IOSAPMSK     TURN FAILING PATH ON IN MASK         39771002
         SRL   WRKRG2,D16          MOVE TO LOW ORDER TWO BYTES          39771402
         STH   WRKRG2,IOSAPMSK     AND PUT IN IOSB - IOSAPMSK           39771802
         BR    RTRNRG              RETURN                               39771902
         TITLE '   IECVPST - FRR RETRY ROUTINE'                         39772002
****************************************************************        39772102
*                                                              *        39775402
*  THE POST STATUS FRR RETRY ROUTINE RECEIVES CONTROL AFTER    *        39777402
*  THE FRR ROUTINE HAS RETURNED TO RTM WITH RETRY SPECIFIED.   *        39777802
*                                                              *        39778202
****************************************************************        39778602
         SPACE 1                                                        39778702
PSTFRRTY EQU   *                   FRR RETRY                            39778802
         TM    FRRFLGB,FRRIIOSB    WAS IOSB IOS'S?                      39779402
         BO    PSTLLH              YES - NO SCHEDULE                    39779802
         SPACE 1                                                        39780202
         B     PSTSCHC             NO - GO SCHEDULE CALLER              39780602
         TITLE '   IECVPST - FRR ROUTINE   '                            39781302
****************************************************************        39782202
*                                                              *        39784202
*  THE POST STATUS FRR RECEIVES CONTROL DURING EXECUTION  OF   *        39784602
*  POST STATUS OR SVC F OR IS PERCOLATED TO FROM A LOWER FRR   *        39785002
*  IF A MACHINE CHECK OR UNEXPECTED PROGRAM CHECK OCCURS. IN   *        39785402
*  ALL CASES EXCEPT IF PERCOLATED TO THE FRR REQUESTS RECOR-   *        39785802
*  DING WITH THE IOSB IN THE  SDWA  VARIABLE  DATA AREA  AND   *        39785902
*  ALSO USES SDUMP TO PRINT THE IOSB.  IF THE IOSB IS AN IOS   *        39786102
*  IOSB, IT IS FREED. IN ALL OTHER CASES, THE IOSB IS POSTED   *        39790602
*  WITH A X'45' IN IOSCOD.                                     *        39792602
*                                                              *        39794602
****************************************************************        39795002
         SPACE 1                                                        39795102
PSTFRRTN EQU   *                   FRR ROUTINE                          39795402
         BALR  BASERG,D0           ESTABLISH ADDRESSABILITY             39797402
         USING *,BASERG                                                 39799402
PSTFRR   S     BASERG,FRRCNST      SET UP FOR POST STATUS               39799802
         SPACE 1                                                        39799902
         USING PSTBASE,BASERG      ADDRESSABILITY                       39800002
         USING SDWA,PARMRG         ESTABLISH ADDRESSABILITY TO          39828602
         L     FRRSAV,SDWAPARM     SDWA AND FRR                         39830602
         USING FRRAREA,FRRSAV                                           39830702
         ST    RTRNRG,FRRTMRET     SAVE RETURN REG TO SRM               39831002
         USING UCB,UCBREG          ADDRESSABILITY TO UCB                39832702
         LR    LLSAVE,REG0         USE 200-BYTE WORKAREA AS    @ZA06077 39832840
*                                     A SAVEAREA               @ZA06077 39833040
         L     IOSBRG,FRRSRB       GET SRB IN ORDER TO         @ZA00904 39833240
         L     IOSBRG,SRBPARM-SRB(IOSBRG)  GET IOSB ADDRESS             39833440
         TM    FRRFLGB,FRRSECNT    IF SECOND ENTRY FLAG ON     @ZA10508 39834040
         BO    PSTFRRDP            GO TO REQUEST ABEND         @ZA10508 39834940
         TM    FRRFLGB,FRRECRSN    IF RECURSION FLAG ON,                39835840
         BO    PSTFRRDP            GO TO REQUEST ABEND                  39836840
         OI    FRRFLGB,FRRECRSN    ELSE, SET RECURSION FLAG             39838802
         LA    TRAREG,PSTFRRTN     GET THIS FRR ADDRESS                 39840802
         SPACE 1                                                        39842802
         SETFRR  A,FRRAD=(TRAREG),PARMAD=(WRKRG1),                     *39843202
               WRKREGS=(WRKRG1,WRKRG2)                                  39843602
         SPACE 1                                                        39844002
*  COPY ALL INFORMATION FROM PRIMARY TO SECONDARY FRR                   39844140
         SPACE 1                                                        39845140
         MVC   FRRFLGA-FRRAREA(D24,WRKRG1),FRRFLGA    @ZA10508,@ZA06077 39847140
         NI    FRRFLGB-FRRAREA(WRKRG1),MASKFF-FRRECRSN         @ZA06077 39847940
*               TURN OFF RECURSION FLAG IN SECONDARY FRR       @ZA06077 39848740
         SPACE 1                                                        39849540
*   STORE PRIMARY FRR ADDR IN SECONDARY FRR AND SET SECOND     @ZA06077 39850340
*           ENTRY FLAG; STORE SECONDARY ADDR IN PRIMARY FRR    @ZA06077 39852240
         ST    FRRSAV,FRRREGD-FRRAREA(WRKRG1)                           39853240
         OI    FRRFLGB-FRRAREA(WRKRG1),FRRSECNT                         39858202
         ST    WRKRG1,FRRREGD                                  @ZA06077 39863240
         SPACE 1                                                        39868202
PSTFRRSK TM    IOSFLA,IOSIOSB      IF THIS IS AN IOS BUILT IOSB,        39878702
         BO    PSTFRRIO            BRANCH FOR SPECIAL HANDLING          39880702
         MVI   IOSCOD,IOSABNC      ELSE, SET COMP CODE TO X'45'         39881102
         SPACE 1                                                        39881202
PSTFRRSB LR    WRKRG2,PARMRG       SAVE SDWA ADDRESS                    39882902
         L     WRKRG1,IOSERP       GET ADDRESS OF ERP WORKAREA @ZA06077 39883340
         LTR   PARMRG,WRKRG1       WORKAREA EXIST ?            @ZA06077 39883740
         BZ    PSTFRRSH            NO,BRNCH AROUND CALLING SMGR@ZA06077 39884140
         L     LINKRG,COREMGR      GET ADDR OF CORE MGMT RTN   @ZA06077 39884540
         L     CORERG,CORCNST2     INDICATE BLOCK LENGTH       @ZA06077 39884940
         BAL   RTRNRG,D4(LINKRG)   GO TO STORAGE MANAGER       @ZA06077 39885340
PSTFRRSH LR    PARMRG,WRKRG2       RESTORE SDWA ADDRESS        @ZA06077 39885740
         SPACE 1                                                        39888102
PSTFRRSD TM    SDWAERRC,SDWAPERC   IF FRR HAS BEEN PERCOLATED TO,       39889802
         BO    PSTFRRVB            BR ARND DMP & SETRP@YM04948,@ZA06077 39890640
         SPACE 1                                                        39893202
         L     WRKRG1,D16          GET ADDRESS OF WORK BUFFER           39894902
         USING CVT,WRKRG1                                               39896602
         L     WRKRG2,CVTSDBF                                           39898302
         LA    WRKRG2,D0(WRKRG2)   CLEAR HIGH ORDER BYTE OF ADDR        39900002
         L     TRAREG,FRRBUFCT     GET SWAPPING CONSTANT                39902502
         OR    TRAREG,WRKRG2       SET HIGH ORDER BIT                   39912502
         SPACE 1                                                        39914502
*        IF HIGH-ORDER BIT IS NOT ON, SET IT, OTHERWISE                 39918402
*        DUMP CAN NOT BE TAKEN.                                         39920402
         SPACE 1                                                        39922402
         CS    WRKRG2,TRAREG,CVTSDBF                                    39926302
         BNE   PSTFRRVB            BR TO CONTINUE PROCESSING            39928302
         DROP  WRKRG1                                                   39930302
         SPACE 1                                                        39934202
         USING BUFFER,WRKRG2       ADDRESSABILITY TO 4K BUFFER          39958502
PSTFRRSC LA    WRKRG1,BUFDATA      ADDRESS DATA PORTION                 39958602
         ST    WRKRG1,BUFDATAD     AND STORE IN DATA ADDRESS            39958702
         LA    WRKRG1,IOSEND-IOSB  LENGTH OF DATA                       39960702
         STH   WRKRG1,BUFDATLG     SET LENGTH IN BUFFER HEADER          39961102
         MVC   BUFDATA,IOSB        MOVE IOSB TO BUFFER DATA AREA        39964502
         LA    WRKRG1,BUFDATA2     ADDRESS SECOND DATA AREA    @ZA06077 39964640
         ST    WRKRG1,BUFAD2       STORE IN SECOND DATA ADDR   @ZA06077 39964740
         LA    WRKRG1,D4           LENGTH OF DATA              @ZA06077 39964840
         STH   WRKRG1,BUFLEN2      SET LENGTH IN HEADER        @ZA06077 39964940
         MVC   BUFDATA2(D4),PSAHLHI MOVE DATA INTO BUFFER      @ZA06077 39965040
         XC    BUFCNST,BUFCNST     ZERO NEXT SIX BYTES                  39965240
         LH    WRKRG1,IOSASID      USER MEMORY                 @ZA30555 39965440
         SPACE 1                                                        39965640
*        ISSUE SDUMP TO PRINT IOSB ETAL.                                39965840
         SPACE 1                                                        39966040
         LR    TRAREG,PARMRG       SAVE SDWA ACROSS SDUMP               39966240
*                                                              @YM06751 39966602
         SDUMP HDR='IOS - POST STATUS ERROR',BUFFER=YES,ASID=(WRKRG1), *39969002
               BRANCH=YES,SDATA=(PSA,NUC,SQA,TRT),QUIESCE=NO   @ZA06077 39969540
         SPACE 1                                                        39971402
         LR    PARMRG,TRAREG       RESTORE SDWA ADDRESS                 39971802
         SPACE 1                                                        39972302
*        MOVE IOSB TO VARIABLE RECORDING AREA OF SDWA AND LENGTH        39972402
         SPACE 1                                                        39972502
PSTFRRVB MVI   SDWAURAL,IOSEND-IOSB SET LENGTH                          39975902
         MVC   SDWAVRA(IOSEND-IOSB),IOSB                                39977902
         OI    SDWADPVA,SDWAHEX    SET PRINT IN HEX IND.                39978002
         MVC   SDWAMODN,PSTNAME    PUT MODULE NAME IN SDWA VRA          39978302
         MVC   SDWACSCT,PTFNUM     PUT PTF NUMBER IN SDWA VRA           39978440
         MVC   SDWAREXN,FRRNAME    PUT FRR ROUTINE NAME IN SDWA VRA     39978540
         SPACE 1                                                        39978702
         SETRP RETADDR=PSTFRRTY,RETREGS=YES,RECORD=YES,RC=4             39979102
         USING SDWA,PARMRG         REESTABLISH ADDRESSABILITY           39980102
         SPACE 1                                                        39983002
PSTFRRIB TM    FRRFLGB,FRRIIOSB    IF THIS IS NOT AN IOS IOSB,          39984002
         BZ    PSTFRRLK            BRANCH AROUNG IOSB CHECKS            39985002
         CLI   IOSPROC,IOSADAVV    IF THIS IS NOT DAVV, BRANCH          39986002
         BNE   PSTFRRSM            AROUND FURTHER CHECKS       @ZA06077 39986540
PSTFRRUB L     UCBREG,IOSUCB       GET UCB ADDRESS                      39988002
         LA    WRKRG1,D512         ADDRESSABILITY TO PREFIX             39989002
         SR    UCBREG,WRKRG1                                            39990002
         TM    UCBFL4,UCBDAVV      IS DAVV IN CONTROL?                  39991002
         BZ    PSTFRRSM            NO,SKIP RESETTING FLAGS     @ZA06077 39991540
         SPACE 1                                                        39993002
****************************************************************        39994002
*                                                              *        39995002
*  THIS CODE GETS THE UCB LOCK SO THE FOLLOWING FLAGS IN THE   *        39996002
*  UCB CAN BE RESET: UCBDAVV; UCBWDAV; UCBQISCE; AND UCBUDE.   *        39997002
*  THE CHANNEL MASK OF THE LAST PATH STARTED IS SWAPPED WITH   *        39998002
*  THE IRT MASK TO INDICATE THE PATH IS NOW AVAILABLE.         *        39999002
*                                                              *        40000002
****************************************************************        40000202
         SPACE 1                                                        40002202
         LR    LINKRG,LLSAVE       SAVE REG 13 ACROSS SETLOCK           40002602
PSTFRR1  SETLOCK  OBTAIN,TYPE=IOSUCB,ADDR=UCBLOCK,MODE=UNCOND,         *40004202
               RELATED=(FRRUCB,IECVPST(PSTFRR2))                        40006202
         SPACE 1                                                        40006602
         OI    FRRFLGB,FRRUCBLK    SET UCB LOCK INDICATOR      @ZA06077 40006740
         L     WRKRG1,FRRREGD      GET SECONDARY FRR ADDR      @ZA06077 40008740
         OI    FRRFLGB-FRRAREA(WRKRG1),FRRUCBLK ALSO SET FLAG  @ZA06077 40010740
         NI    UCBFLA,MASKFF-UCBQISCE                                   40012740
         NI    UCBFL4,MASKFF-UCBDAVV-UCBWDAV                            40017002
         NI    UCBFLC,MASKFF-UCBUDE                                     40027902
         SPACE 1                                                        40037902
         SR    WRKRG1,WRKRG1                                            40038002
         IC    WRKRG1,UCBCHA       GET LAST STARTED CHAN ADDR           40038102
         USING PSA,0                                                    40039202
         L     CORERG,PSALCCAV                                          40041202
         USING LCCA,CORERG                                              40041302
         LA    CORERG,LCCAIRT      GET IRT ADDR AND ESTABLISH           40043402
         USING IRT,CORERG          ADDRESSABILITY                       40045402
         LA    WRKRG2,D1           INIT WRKREG WITH 1                   40047402
         SLL   WRKRG2,D31          SHIFT TO HIGH ORDER BIT              40047802
         SRL   WRKRG2,D0(WRKRG1)   SHIFT TO PROPER CHAN LOCATION        40052002
         L     WRKRG1,IRTCHMSK     GET IRT CHANNEL MASK                 40054002
PSTFRRST LR    SRBREG,WRKRG2       MOVE TO REG0 FOR C/S                 40056002
         OR    SRBREG,WRKRG1       SET THIS CHANNEL INDICATOR           40056402
         CS    WRKRG1,SRBREG,IRTCHMSK                                   40057202
         BNE   PSTFRRST            IF MASK IS NOT EQUAL, BRANCH         40057602
*                                  TO SWAP AGAIN                        40058002
PSTFRR2  SETLOCK  RELEASE,TYPE=IOSUCB,ADDR=UCBLOCK,                    *40058402
               RELATED=(FRRUCB,IECVPST(PSTFRR1))                        40058502
         SPACE 1                                                        40058602
         DROP  CORERG                                                   40059402
         SPACE 1                                                        40061402
         NI    FRRFLGB,MASKFF-FRRUCBLK TURN OFF UCB HOLD IND.  @ZA06077 40061540
         L     WRKRG1,FRRREGD     GET SECONDARY FRR ADDR       @ZA06077 40061740
         NI    FRRFLGB-FRRAREA(WRKRG1),MASKFF-FRRUCBLK         @ZA06077 40062240
*                         ALSO, TURN OFF IN SECONDARY FRR      @ZA06077 40062640
         LR    LLSAVE,LINKRG       RESTORE REG 13                       40063240
         SPACE 1                                                        40067202
PSTFRRSM LR    TRAREG,PARMRG       SAVE SDWA ADDRESS                    40068002
         L     PARMRG,FRRSRB       PUT SRB ADDR IN REG 1                40068802
         BAL   RTRNRG,PSTSUBR      GO FREE SRB/IOSB                     40069602
         LR    PARMRG,TRAREG       RESTORE SDWA ADDRESS                 40070002
         EJECT                                                          40070240
****************************************************************        40071202
*                                                              *        40072002
*   CLEANUP IS DONE HERE TO RETURN TO RTM. THE LOCKS HELD BY   *        40073902
*   POST STATUS  WILL BE INDICATED  IN THE SDWA SO  RTM WILL   *        40074302
*   RELEASE THEM.  ONE EXCEPTION TO  THIS IS IF THE  FRR WAS   *        40074702
*   ENTERED WITH THE LOCAL LOCK HAVING BEEN  OBTAINED BY THE   *        40075202
*   SVC HANDLER (SVC F ).                                      *        40076002
*                                                              *        40076802
****************************************************************        40077602
         SPACE 1                                                        40078402
PSTFRRLK EQU   *                   FRR EXIT                             40079202
         TM    FRRFLGA,FRRCATLK    IF CAT LOCK NOT HELD, DONT           40080002
         BZ    PSTFRRLD            SET INDICATOR                        40080440
         OI    SDWAACF3,SDWAICAT   SET CAT LOCK INDICATOR               40081602
         L     WRKRG1,D16          GET ADDRESSABILITY TO CAT LOCK       40082402
         USING CVT,WRKRG1                                               40083202
         L     WRKRG1,CVTIXAVL                                          40084002
         USING IOCOM,WRKRG1                                             40084802
         LA    WRKRG1,IOCCATLK                                          40085040
         ST    WRKRG1,SDWAICLW     PUT CAT LOCKWORD IN SDWA             40085240
         DROP  WRKRG1                                                   40087202
         SPACE 1                                                        40088002
*   SET UP REGISTERS FOR RETRY EXIT                                     40088802
         SPACE 1                                                        40089602
PSTFRRLD ST    IOSBRG,SDWASR02     PUT IOSB ADDR IN REG 2 AREA          40090402
         STM   FRRSAV,BASERG,SDWASR04                                   40091202
         TM    FRRFLGA,FRRSAF      IS THERE A SAVE AREA TO FREE@ZA00904 40091340
         BZ    PSTRTN2             NO--EXIT                    @ZA00904 40091440
         LR    WRKRG1,PARMRG       SAVE REG                    @ZA00904 40092040
         L     PARMRG,FRRSA        GET SAVEAREA TO FREE        @ZA00904 40095840
         XC    0(4,PARMRG),0(PARMRG)    CLEAR CHAIN PTR        @ZA00904 40096740
         L     CORERG,CORCNST2     INDICATE FREE 160 BYTES     @ZA00904 40096940
         L     LINKRG,COREMGR      GET STORAGE MANAGER ADDRESS @ZA00904 40097140
         BAL   RTRNRG,D4(LINKRG)   CALL FREE ENTRY             @ZA00904 40097340
         NI    FRRFLGA,MASKFF-FRRSAF  RESET SAVE AREA FLAG     @ZA00904 40097540
         LR    PARMRG,WRKRG1       RESTORE REG                 @ZA00904 40097740
PSTRTN2  EQU   *                                                        40099040
         SPACE 1                                                        40099340
         SETFRR  D,WRKREGS=(WRKRG1,WRKRG2)                              40100240
         SPACE 1                                                        40100540
         TM    SDWAERRA,SDWARKEY   IF PSW RESTART ERROR,                40100840
         BO    PSTFRRLA            GO SETRP TO PERCOLATE                40101140
         LH    WRKRG1,SDWAFMID     IF ERROR IS WRONG MEMORY,            40102040
         LTR   WRKRG1,WRKRG1       FALL THROUGH TO PERCOLATE            40102940
         BZ    PSTFRRLH            OTHERWISE BRANCH            @ZA06077 40103840
PSTFRRLA SETRP                     SETRP TO PERCOLATE                   40104740
         USING SDWA,PARMRG         REESTABLISH SDWA ADDRESSABILITY      40104840
         SPACE 1                                                        40104940
PSTFRRLB L     RTRNRG,FRRTMRET     RESTORE RETURN TO RTM                40105040
         BR    RTRNRG              RETURN TO RTM                        40105940
         SPACE 2                                                        40106040
PSTFRRLH TM    SDWAERRB,SDWACLUP   RETRY ALLOWED ?             @ZA06077 40106140
         BO    PSTFRRLA            NO, BRANCH TO PERCOLATE     @ZA06077 40106240
         B     PSTFRRLB            YES, BRANCH TO RETRY        @ZA06077 40106340
         EJECT                                                          40107140
****************************************************************        40107240
*                                                              *        40107340
*   PCI HANDLING IS DONE HERE. A X'45' COMPLETION CODE IS PUT  *        40107440
*   IN THE ENDING STATUS IOSB AND ALL IOS SRB/IOSB'S FREED.    *        40107540
*                                                              *        40107640
****************************************************************        40107702
         SPACE 1                                                        40108602
PSTFRRIO EQU   *                   IOS IOSB                             40109502
         OI    FRRFLGB,FRRIIOSB    SHOW IOS IOSB                        40109902
         CLI   IOSPROC,IOSAPCI     IF THIS IS NOT FOR PCI, RETURN       40110402
         BNE   PSTFRRSB            TO MAINLINE PROCESSING               40111302
         L     WRKRG2,IOSPCHN      GET ADDR OF ENDING STATUS IOSB       40112702
         MVI   IOSCOD-IOSB(WRKRG2),IOSABNC                              40114702
*                                  SET COMP CODE=X'45' IN ENDING        40116702
*                                  STATUS IOSB                          40118702
*                                  GO TO FREE PCI SRB/IOSB'S            40120702
         B     PSTPCICH            * RETURN WILL BE TO PSTFRRSD         40121102
*                                  * SINCE FRR IN CONTROL               40121202
         EJECT                                                          40121502
****************************************************************        40121902
*                                                              *        40122302
*   IF RECURSION IS ON, THE SECOND ENTRY FLAG IS CHECKED TO    *        40122602
*   DETERMINE WHICH RETRY EXIT TO TAKE.                        *        40123002
*                                                              *        40123102
****************************************************************        40125302
         SPACE 1                                                        40127302
PSTFRRDP EQU   *                   RECURSION TEST                       40129302
PSTFRRDM TM    FRRFLGA,FRRCATLK    IF CAT LOCK NOT HELD,                40134702
         BZ    PSTFRRDS            BRANCH AROUND SET                    40134802
         SPACE 1                                                        40135202
         L     WRKRG1,D16          GET ADDRESSABILITY TO IOCOM          40136502
         USING CVT,WRKRG1                                               40138502
         L     WRKRG1,CVTIXAVL                                          40138902
         USING IOCOM,WRKRG1                                             40139302
         SETRP FRELOCK=IOSCAT(IOCCATLK)                        @ZA06077 40139540
PSTFRRDS TM    FRRFLGA,FRRSYNCH    IF SYNCH LOCK NOT HELD,              40141102
         BZ    PSTFRRUA            BRANCH AROUND SET           @ZA06077 40141340
         SETRP FRELOCK=IOSYNCH(IOCSYNCH)                       @ZA06077 40141740
PSTFRRUA TM    FRRFLGB,FRRUCBLK    UCB LOCK HELD ?             @ZA06077 40141940
         BZ    PSTFRRDA            NO, BRANCH AROUND SET       @ZA06077 40142140
         LA    WRKRG1,UCBLOCK      GET ADDR OF UCB LOCK        @ZA06077 40142340
         ST    WRKRG1,SDWAIULW     AND STORE IN SDWA           @ZA06077 40142840
         OI    SDWAACF3,SDWAIUCB   SET UCB LOCK IND. IN SDWA   @ZA06077 40143140
         DROP  WRKRG1                                                   40144602
         SPACE 1                                                        40145502
         TM    FRRFLGB,FRRSECNT    SECOND ENTRY FLAG ON ?      @ZA06077 40145740
         BZ    PSTFRRSE            NO, BYPASS ABEND            @ZA06077 40145940
         SPACE 1                                                        40146140
*   REQUEST RTM TO ABEND CURRENT TASK IF ONE EXISTS                     40146402
         SPACE 1                                                        40147302
PSTFRRDA L     CORERG,FRRSRB       GET SRB ADDRESS                      40148202
         USING SRBSECT,CORERG                                           40149102
         L     WRKRG1,SRBPTCB      GET TCB ADDRESS FROM SRB             40150002
         LTR   WRKRG1,WRKRG1       IF NO TCB ADDR IN SRB, BRANCH        40155902
         BZ    PSTFRRSE            AROUND ABEND                @ZA06077 40156940
         LH    WRKRG2,IOSASID                                           40159902
         DROP  CORERG                                                   40160302
         LR    SAVERG,PARMRG       SAVE SDWA ADDRESSABILITY    @ZA02135 40161103
         SPACE 1                                                        40161902
*   CALLRTM TO ABEND CURRENT TASK                                       40163902
         SPACE 1                                                        40164302
         CALLRTM  TYPE=ABTERM,COMPCOD=X'0F2',ASID=(WRKRG2),TCB=(WRKRG1) 40164702
         SPACE 1                                                        40165102
         LR    PARMRG,SAVERG       RESTORE SDWA ADDRESSABILITY @ZA02135 40166903
         SPACE 1                                                        40167140
*          MAKE SURE THAT SYNCH LOCK HELD FLAG WAS NOT TURNED  @ZA06077 40167340
*           ON IN PRIMARY FRR                                  @ZA06077 40167540
         L     WRKRG1,FRRREGD      GET PRIMARY FRR ADDR        @ZA06077 40167740
         TM    FRRFLGA-FRRAREA(WRKRG1),FRRSYNCH                @ZA06077 40167940
         BZ    PSTFRRSE            BRANCH IF NOT ON            @ZA06077 40168140
         L     WRKRG1,D16          GET ADDRESSABILITY TO IOCOM @ZA06077 40168340
         USING CVT,WRKRG1                                      @ZA06077 40168540
         L     WRKRG1,CVTIXAVL                                 @ZA06077 40168940
         USING IOCOM,WRKRG1                                    @ZA06077 40169440
         SETRP FRELOCK=IOSYNCH(IOCSYNCH)                       @ZA06077 40169940
PSTFRRSE SETRP                     SETRP TO PERCOLATE                   40170940
         SPACE 1                                                        40172402
PSTFRRSF L     RTRNRG,FRRTMRET     RESTORE RETURN ADDR TO RTM           40172740
         BR    RTRNRG              RETURN TO RTM                        40189240
         TITLE 'IECVPST - RESTARTABLE WAIT SUBROUTINE'                  40189840
*********************************************************************** 40191140
*                                                                     * 40192940
*   THE PSTWAIT SUBROUTINE CALLS IEESTPRS IN ORDER TO PLACE THE SYSTEM* 40193540
*       IN A RESTARTABLE WAIT STATE.  THIS ROUTINE IS CALLED WHEN THE * 40193740
*       PAGE PACK IS NOT AVAILABLE AND A WTO WOULD NORMALLY HAVE BEEN * 40193940
*       ISSUED--INSTEAD THE WAIT STATE IS USED TO NOTIFY THE OPERATOR.* 40194140
*       PSAWTCOD CONTAINS THE EXACT REASON FOR THE WAIT.              * 40194340
*       IF THE RESTART RESOURCE WORD CVTRSTWD IS NOT AVAILABLE, THE   * 40194540
*       CPU ON WHICH THE CODE IS CURRENTLY RUNNING IS PLACED          * 40194740
*       DIRECTLY IN THE WAIT STATE.                                   * 40194940
*                                                                     * 40195340
*********************************************************************** 40195540
         SPACE 2                                                        40195740
PSTWAIT  BAL   RTRNRG,PSTLOCK      GET A SAVE AREA             @ZA00904 40195940
         L     TRAREG,CVTPTR                                   @ZA00904 40196140
         USING CVT,TRAREG                                      @ZA00904 40196340
         NI    FRRFLGA,MASKFF-FRRWDAV  CLEAR DAVVWAIT FLAG     @ZA00904 40196540
         L     UCBREG,IOSUCB           POINT TO UCB            @ZA00904 40196740
         USING UCBOB,UCBREG                                    @ZA00904 40196940
         TM    UCBFL4,UCBWDAV          TEST UCB DAVV FLAG      @ZA00904 40197140
         BNO   PSTWAITR                OFF - SKIP              @ZA00904 40197340
         OI    FRRFLGA,FRRWDAV         ON - SET INTERNAL FLAG  @ZA00904 40197540
PSTWAITR STNSM PSASYMSK,DISABLE    SYSTEM MUST BE DISABLED BEFORE       40197740
*                                   INTERFACING TO STOP/RESTART@ZA00904 40197940
*  SET AN FRR TO COVER DISABLEMENT AND THE RESTART RESOURCE             40198140
         SETFRR A,FRRAD=PSTWFRRA,PARMAD=(WRKRG1),                      *40198340
               WRKREGS=(WRKRG1,WRKRG2)                         @ZA00904 40198540
         USING FRRW,WRKRG1                                              40198740
         ST    BASERG,FRRWBASE     SAVE BASE REG               @ZA00904 40198940
         ST    IOSBRG,FRRWIOSB     IOSB REG AND                @ZA00904 40199140
         ST    TRAREG,FRRWCVT        CVT PTR FOR FRR           @ZA00904 40199340
*  SET SPECIFIC RESTARTABLE WAIT REASON FOR PSAWTCOD           @ZA00904 40199540
         USING XPSA,LLSAVE         BLD PSAWTCOD CDE IN SAV AREA@ZA00904 40199740
         XC    XPSACD(4),XPSACD    CLEAR FIELD                 @ZA00904 40199940
         MVC   XPSADEV,UCBCHAN     MOVE DEVICE ADDR            @ZA00904 40200140
         MVI   XPSAWAIT,XPSAVID    ASSUME WRONG VOL ID         @ZA00904 40200340
         TM    IOSFLC,IOSRWAIT     TEST REASON FOR WAIT        @ZA00904 40200540
         BZ    PSTWAIT2            WRONG VOL ID WAS RIGHT      @ZA00904 40200740
         MVI   XPSAWAIT,XPSAERR    ASSUME PERM ERROR           @ZA00904 40200940
         BO    PSTWAIT2            RIGHT AGAIN                 @ZA00904 40201340
         MVI   XPSAWAIT,XPSAIR     ASSUME INTV REQ             @ZA00904 40201540
         TM    IOSFLC,IOSRWIR      TEST FOR INTV REQ           @ZA00904 40201740
         BO    PSTWAIT2            RIGHT FINALLY               @ZA00904 40201940
         MVI   XPSAWAIT,XPSACC3    ONLY CASE LEFT IS CC3       @ZA00904 40202140
*  ACQUIRE RESTART RESOURCE                                             40202340
PSTWAIT2 LH    WRKRG2,PSACPULA     GET LOGICAL CPU ID AND      @ZA00904 40202540
         SLL   WRKRG2,D16            SHIFT TO HI BYTE          @ZA00904 40202740
         O     WRKRG2,PSTSRSCD     OR IN UNIQUE OWNER CODE     @ZA00904 40202940
         SR    PARMRG,PARMRG       COMPARE FOR ZERO CVTRSTWD   @ZA00904 40203140
         CS    PARMRG,WRKRG2,CVTRSTWD  SWAP IN CPUID & CODE    @ZA00904 40203340
         BNE   PSTRW05             GO STOP THIS CPU ONLY       @ZA00904 40203540
         MVI   FRRWSRSW,MASKFF     INDICATE RESOURCE HELD      @ZA00904 40203940
         MVC   PSAWTCOD(4),XPSACD  SET RESTART REASON          @ZA00904 40204140
         MVC   PSTDATA(4),XPSACD   REASON CODE AND UNIT ADDR   @ZA33089 40204340
*                                    TO LOGREC RECORD          @ZA33089 40204440
         STCK  PSTTIME             TIME STAMP RECORD           @ZA00904 40204540
         RECORD TYPE=LOGREC,RCVRY=SETFRR,HEADER=YES,LENGTH=20,         *40204640
               PARMADR=PSTLOGBF                                @ZA33089 40204740
         L     REG0,PSTWAITC       GET WAIT STATE CODE         @ZA00904 40204940
         SR    PARMRG,PARMRG       INDICATE NO STATUS AREA     @ZA00904 40205140
         L     LINKRG,CVTSTPRS     GET STOP ROUTINE ADDR       @ZA00904 40205340
         BALR  RTRNRG,LINKRG       CALL STOP/RESTART           @ZA00904 40205540
         LTR   LINKRG,LINKRG       DID IT WORK                 @ZA00904 40205740
         BZ    PSTRW10             YES--EXIT                   @ZA00904 40205940
PSTRW05  MVC   PSAWTCOD(4),XPSACD  SET RESTART REASON          @ZA00904 40206140
         MVC   XRNPSW1(8),FLCRNPSW NO--SAVE RESTART NEW PSW    @ZA00904 40206340
         MVC   FLCRNPSW(8),RSPSW2  SET PSW FOR 'PSTRESTR'      @ZA00904 40206540
         LPSW  RSPSW3              LOAD WAIT PSW               @ZA00904 40206740
PSTRESTR MVC   FLCRNPSW(8),XRNPSW1 OPERATOR HAS HIT RESTART KEY@ZA00904 40206940
*                                    RESTORE SAVED PSW         @ZA00904 40207140
         CLI   FRRWSRSW,MASKFF     WAS RESTART RESOURCE HELD   @ZA00904 40207340
         BNE   PSTRW20             NO--SKIP FREEING IT         @ZA00904 40207540
PSTRW10  SR    PARMRG,PARMRG       ZERO REG IN ORDER           @ZA00904 40207740
         ST    PARMRG,CVTRSTWD       TO ZERO RESOURCE          @ZA00904 40207940
         DROP  LLSAVE                                                   40208140
         DROP  TRAREG                                                   40208340
PSTRW20  SETFRR D,WRKREGS=(WRKRG1,WRKRG2)  DELETE FRR          @ZA00904 40208540
         IC    WRKRG1,PSASYMSK     GET ENTRY SYSTEM MASK       @ZA00904 40208740
         EX    WRKRG1,PSTENA         AND RESTORE IT            @ZA00904 40208940
         TM    FRRFLGA,FRRWDAV     IS DAVV WAIT FLAG ON        @ZA00904 40209140
         BO    PSTRTN              YES--EXIT TO WAIT DEVICE END@ZA00904 40209340
         TM    IOSCC,IOSCC3        CONDITION CODE 3?           @ZA30808 40209540
         BO    PSTCRM              YES, GO FREE IOSB & EXIT    @ZA30808 40209840
         B     PSTGDPT             NO--RETRY I/O               @ZA00904 40210140
         SPACE 2                                                        40210440
*********************************************************************** 40211040
*  FRR TO PROTECT RESTART RESOURCE WORD AND DISABLEMENT               * 40211440
*********************************************************************** 40211840
         SPACE                                                          40212240
         USING SDWA,PARMRG                                              40212640
PSTWFRR  L     WRKRG1,SDWAPARM     GET PARM LIST               @ZA00904 40213040
         USING FRRW,WRKRG1                                     @ZA00904 40213440
         L     BASERG,FRRWBASE     RESTORE KEY REGS AND        @ZA00904 40213840
         ST    BASERG,SDWAGRSV+4*BASERG  SAVE FOR RETRY        @ZA00904 40214240
         L     IOSBRG,FRRWIOSB                                 @ZA00904 40214640
         ST    IOSBRG,SDWAGRSV+4*IOSBRG                        @ZA00904 40215040
         L     TRAREG,FRRWCVT                                  @ZA00904 40215440
         ST    TRAREG,SDWAGRSV+4*TRAREG                        @ZA00904 40215840
         CLI   FRRWSRSW,MASKFF     WAS RESTART RESOURCE HELD   @ZA00904 40216240
         LA    REG0,PSTRW20        NO--SET RETRY ADDR          @ZA00904 40216640
         BNE   PSTWFRR2            EXIT                        @ZA00904 40217040
         LA    REG0,PSTRW10        YES--SET RETRY ADDR         @ZA00904 40217440
PSTWFRR2 SETRP RETADDR=(REG0),RETREGS=YES,RC=4                 @ZA00904 40217840
         BR    RTRNRG              EXIT TO RTM                 @ZA00904 40218240
         TITLE '   IECVPST - CONSTANTS     '                            40218640
         DS    0F                                                       40219040
IGC015A  DC    A(PST015-PSTBASE)   ADDRESSABILITY CONSTANT              40219440
FRRCNST  DC    A(PSTFRR-PSTBASE)   ADDRESSABILITY CONSTANT FOR FRR      40219840
DAERP    DC    V(IECVDERP)         DA ERP ADDRESS                       40220240
XITEFF   DC    V(IEA0EF00)         EXIT EFFECTOR ADDRESS                40220640
COREMGR  DC    V(IECVSMGR)         CORE MANAGER ADDRESS                 40221440
CDUWPA   DC    X'0000523F'         CHE,DVE,CUE,WLR,PCI,ATTN    @ZA03292 40221640
CORCNST  DC    X'10000020'         CORE MGMNT CONSTANT FOR R11          40231202
CORCNST2 DC    X'00000020'         CORE MGMNT CONSTANT FOR FREEING      40240602
FRRBUFCT DC    X'80000000'         CONSTANT FOR CS ON BUFFER ADDR       40242602
C02      DC    X'02'               CONSTANT FOR 02                      40250021
C04      DC    X'04'               CONSTANT FOR 04                      40300021
C10      DC    X'10'               CONSTANT FOR 10                      40350021
FRRNAME  DC    CL8'PSTFRRTN'       FRR NAME FOR FRR PROCESSING @ZA26432 40360040
PSTWFRRA DC    A(PSTWFRR)          FRR ROUTINE ADDR            @ZA00904 40361040
DAVALT   DC    V(IECVDAV2)         BRANCH ENTRY POINT FOR DAVV @ZA00904 40363040
SMPARM   DC    X'10000020'         ONE 160 BYTE BLOCK          @ZA00904 40366040
PSTSRSCD DC    X'0000',C'PS'       RESTART CODE                @ZA00904 40367040
PSTLOGBF DC    X'84830000'         LOGREC RECORD FOR ENTERING  @ZA09704 40369040
         DC    A(PSTLOGDA)          THE SYSTEM STOP/RESTART    @ZA00904 40372040
PSTLOGDA DC    F'12'                ROUTINE. RECORD COMPLETE   @ZA00904 40375040
PSTWAITC DC    X'0000002F'          EXCEPT FOR TIME STAMP,     @ZA00904 40377040
PSTTIME  DC    XL8'00'              REASON CODE, AND UNIT ADDR @ZA33089 40379040
PSTDATA  DC    F'0'                 WHICH ARE SERIALIZED BY    @ZA33089 40381040
*                                   THE RESTART RESOURCE WORD. @ZA33089 40383040
PSTENA   STOSM PSASYMSK,D0          EXECUTED TO RE-ENABLE      @ZA00904 40387040
RSPSW2   DC    X'040C0000',A(PSTRESTR) RESTART NEW PSW         @ZA00904 40390040
         DS    0D                  PSW MUST BE ON DWORD        @ZA00904 40393040
RSPSW3   DC    X'000E00000000002F'  WAIT STATE PSW             @ZA00904 40394040
KF0      DC    H'240'               CONSTANT X'FO'             @ZA26432 40395040
PSTPATCH DC    C'POST STATUS PATCH AREA'                       @ZA10093 40396040
         DC    10F'0'                                          @ZA10093 40397040
PSTNAME  DC    CL8'IECVPST'        CSECT NAME FOR FRR PROCESSING        40400040
         DC    CL8'&SYSDATE'                                            40450040
PTFNUM   DC    CL8'&SYSPARM '                                           40500040
         END                                                            40550040
