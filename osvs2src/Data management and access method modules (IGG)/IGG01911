1911 TITLE 'IGG01911-LAST LOAD OF SAM, PAM, AND EXCP OPEN EXECUTORS'    00020003
IGG01911 CSECT                                                          00024000
*                                                                       00026002
*MODULE NAME - IGG01911                                          Y02072 00026402
*                                                                       00026802
*DESCRIPTIVE NAME - SAM/EXCP LAST LOAD                           Y02072 00027202
*                                                                       00027602
*COPYRIGHT - NONE                                                Y02072 00027702
*                                                                       00027802
*RELEASE ACTIVITY - AS FOLLOWS:                                  Y02072 00027902
*                                                                       00037902
*          RELEASE 20 DELETIONS                                       * 00052000
*2964                                                            A36344 00053020
*2964                                                            S20038 00054020
*2964074000-074400                                               A30962 00055020
*2964030400-031000,041200,085400                                 S20201 00055520
*2964084600-084800,090600                                        M1557  00055720
*                                                                       00055802
*          RELEASE 21 DELETIONS                                       * 00056000
*0934093320-093400                                               M1630  00056121
*0934001000-001150,017550,045840-045960,093000-096100,097840-    M0474  00056321
*0934097960,108100                                               M0474  00056621
*0934003500,102480-102520,103400,105600-106400,107600-108600     S21042 00057021
*0934093400,094200,095600,096000                                 S21045 00058021
* 062000-062200                                                  A41465 00058421
*0934000950,093000,093760-093840                                 M1044  00059021
*0934093760-093800,093880-093920,094240-094400,095320            M1812  00059521
*                                                                       00059602
*        VS1 RELEASE 2 DELETIONS                                        00059702
*D59400                                                         XA02987 00059802
*                                                                       00061702
*        VS2 RELEASE 2 DELETIONS                                        00065602
*200-220,280-600,1400,1600,2800,16400-17500,41800-43600,         Y02072 00067502
*94240-94330,94480-94680,94920-95720,97600,105400,106000         Y02072 00069402
*                                                                YM4635 00069802
*                                                                YM4697 00070202
*D46000                                                          YM5778 00070602
*                                                                YM5940 00071002
*                                                                YM6506 00071102
*                                                                YM6583 00071202
*                                                                YM7595 00071302
*                                                                YM7889 00074902
*                                                                       00078602
*                                                                       00081403
*        VS2 RELEASE 3 DELETIONS/CHANGES                                00081503
*D086250-086300                                                @Z30TSMI 00081803
*                                                                       00082303
*        VS2 RELEASE 04 CHANGES/DELETIONS                               00084303
*A072300-072380                                                 ZA01361 00084703
*                                                                       00085802
*FUNCTION/OPERATION-                                                    00089402
*                                                                       00093002
*    - FOR ALL DATA SETS IT WILL ISSUE THE IECRES MACRO TO GET   Y02072 00096602
*      THE USERS COPY OF THE DCB REFRESHED.                      Y02072 00100202
*    - IT SETS BITS IN THE FORCE CLOSE AUDIT TRAIL TO            YM7595 00103802
*      INDICATE TO FORCE CLOSE THAT ANY FORCE CLOSE PROCESSING   Y02072 00107402
*      SHOULD BE DONE BY THE NORMAL CLOSE EXECUTORS AND FOR      YM7595 00111002
*      TAPE AND UNIT RECORD DEVICES THAT IOB CONSTRUCTION IS     YM7595 00114602
*      COMPLETED (BUFFER ADDRESSES TO CCWS).                     YM7595 00118202
*    - FOR PRINTERS IT WILL DELETE IGGMSG01 IF IT HAS BEEN       Y02072 00121802
*      LOADED AND ZERO THE FIELD ITS ADDRESS WAS IN.             Y02072 00125402
*    - IT WILL SET THE TYPE OF RELATED REQUEST IN THE IOBS       Y02072 00129002
*    - BUFFERS ARE PRIMED FOR QSAM INPUT BY BRANCHING TO THE EOB        00132602
*      MODULE.  THE CALLING SVRB IS TESTED TO DETERMINE IF A BALR       00136202
*      (IF KEY <8) OR SYNCH (IF KEY >7) IS TAKEN, THE LATTER     Y02072 00139802
*      ALLOWING THE EOB ROUTINE TO EXECUTE IN PROBLEM PROGRAM    Y02072 00143402
*      STATE, USER KEY.                                          Y02072 00147002
*    - A GETMAIN IS ISSUED IN USER KEY TO PROVIDE THE EOB RTN    Y02072 00150602
*      WITH A SAVEAREA IN SP 230. OPENS REGISTERS ARE SAVED IN   Y02072 00154202
*      THE SVRB EXTENDED SAVEAREA.                               Y02072 00157802
*                                                                       00161402
*ENTRY POINTS: ENTERED FROM STAGE 1 AND STAGE 3 EXECUTORS BY     Y02072 00165002
*              USE OF THE XCTL MACRO.                            Y02072 00175002
*                                                                       00180000
*INPUT: SEE DESCRIPTION OF REGISTERS, DCB(USERS).                       00200000
*                                                                       00220000
*OUTPUT: SEE DESCRIPTION OF REGISTERS,DCB(USERS),IOB(USERS).            00240000
*                                                                       00260000
*EXTERNAL ROUTINES - EOB ROUTINE, O/C/E RESIDENT ROUTINE         Y02072 00280002
*                                                                       00300000
*EXTERNAL REFERENCES - IGGMSG01                                  Y02072 00310002
*                                                                       00310402
*MACROS:ACTION - IECRES, DELETE, MODESET, EXCP, DMABCOND, XCTL,  Y02072 00310802
*                GETMAIN                                         Y02072 00311202
*                                                                       00311602
*MACROS:MAPPING - IECDSECS(MAIN,WTG,PREFX), DCBD, CVT, IEZDEB,   Y02072 00316302
*                 IEZIOB, IHAPSA, IKJTCB, IHARB, IGGBCB, IHACCW  Y02072 00318302
*                                                                       00330602
*EXITS-NORMAL-XCTL TO IGG0190S  (OPEN).                                 00335302
*                                                                       00340000
*EXITS-ERROR XCTL TO PROB DET (IGG0196M) FOR WTP AND 013 ABEND          00346021
*      INSUFFIEIENT BUFFERS AVAILABLE                                   00352021
*      IN BUFFER POOL TO SATISFY DCB BUFFER REQUIREMENTS          16059 00360016
*                                                                       00380000
*TABLES/WORKAREAS- WHERE TO GO TABLE (WTG)                              00400000
*                                                                       00420000
*      BYTE  0-7  NAME                                                  00440000
*      BYTE  8-10 RELATIVE DISK ADDRESS(TTR) OF FIRST RECORD            00460000
*      BYTE 11    CONCATENATION NUMBER                                  00480000
*      BYTE 12    ZERO                                                  00500000
*      BYTE 13    ALIAS INDICATOR AND USER DATA FIELD DESCRIPTOR.       00520000
*                        ALIAS INDICATOR 1 BIT                          00540000
*                        NUMBER OF TTRS IN USERS DATA FIELD 2 BITS      00560000
*      BYTE 14-16 TTR OF FIRST TEXT RECORD                              00580000
*      BYTE 17    ZERO                                                  00600000
*      BYTE 18-19 TTR OF NOTE LIST OR SCATTER LIST                      00620000
*      BYTE 20    TRANSLATION TABLE                                     00640000
*      BYTE 21    ZERO OR NUMBER OF ENTRIES IN THE NOTE LIST            00660000
*      BYTE 22-23 ATTRIBUTES                                            00680000
*      BYTE 24-26 TOTAL CONTIGUOUS MAIN STORAGE REQUIRED FOR MODULE     00700000
*      BYTE 27-28 LENGTH OF FIRST TEXT RECORD                           00720000
*      BYTE 29    LENGTH OF WTG TABLE (IN DOUBLE WORDS)                 00740000
*      BYTE 30-31 PATH THROUGH LOADS OF ROUTINES                        00760000
*      BYTE 32-34 IDTTR OF EXECUTOR FOR FIRST DCB                       00780000
*      BYTE 35    WORKAREA ADDRESS FOR FIRST DCB                        00800000
*      BYTE 36-39 TABLE OF IDTTR'S                                      00820000
*      BYTE 32+N(8) IDTTR OF EXECUTOR FOR  N TH DCB  (3 BYTES)          00840000
*                   WORKAREA ADDRESS FOR N TH DCB    (1 BYTE )          00860000
*                   IDTTR OF LAST ROUTINE LOAD       (3 BYTES)          00880000
*                   NOT USED                         (1 BYTE)           00900000
*                                                                       00920000
*ATTRIBUTES: REENTRANT, REUSABLE, RUNS IN SUPERVISOR STATE AND   Y02072 00940002
*            USER KEY UNLESS OTHERWISE SPECIFIED.                Y02072 00950002
*                                                                       00960000
         EJECT                                                          01010002
*********************************************************************** 01060000
*                                                                       01100000
*  REGISTER CONVENTIONS USED                                            01120002
*                                                                       01140000
*********************************************************************** 01160000
*                                                                       01180000
RDCB     EQU   2         DCB REGISTER                                   01200000
RBASE    EQU   3         BASE REGISTER                                  01220000
RCORE    EQU   4         WORK AREA ADDRESS                              01240000
RPAR     EQU   5         TOP OF PARAMETER LIST                          01260000
RWTG     EQU   6         TOP OF WTG TABLE                               01280000
RPARC    EQU   7         CURRENT PARAMETER                              01300000
RWTGC    EQU   8         CURRENT TRANS LOAD                             01320000
RTIOT    EQU   9         USED HERE AS WRK REG AND  COMM VECTOR ADDR.    01340000
RWK4     EQU   RTIOT     WORK REGISTER                           Y02072 01350002
RIOB     EQU   10        IOB REGISTER                                   01360002
RDEB     EQU   11        DEB ADDRESS                                    01380000
RB       EQU   12        WORK REG1  **                                  01400000
RWK2     EQU   RB        WORK REGISTER                           Y02072 01410002
RC       EQU   13        WORK REG2  **  USED IN IOB GENERATION          01420000
RSAVE    EQU   RC        REG USED TO PASS SAVE AREA TO EOB RTN   Y02072 01430002
RBUFADR  EQU   RC        ADDRESS OF CURRENT BUFFER               YM7595 01430102
RD       EQU   14        WORK REG3  **                                  01440000
R14      EQU   RD        PARAMETER RIGISTER                      Y02072 01450002
RWK3     EQU   RD        WORK REGISTER                           Y02072 01452002
RJ       EQU   15        WORK REG4                                      01460000
RE       EQU   0         WORK REG5                                      01480000
R0       EQU   RE        PARAMETER REGISTER                      Y02072 01490002
RF       EQU   1         WORK REG6                                      01500000
RWK1     EQU   RF        WORK REGISTER                           Y02072 01510002
R1       EQU   RF        PARAMETER REGISTER                             01512002
*                                                                       01520000
*                                                                       01540000
PARAR    EQU   RPARC                                                    01560000
*                                                                       01580000
*********************************************************************** 01600000
*                                                                       01620000
OUTP     EQU   X'0F'                                                    01660002
DEBOUTPT EQU   X'0F'                    PROCESSING TYPE, OUTPUT  Y02072 01710002
DEBUPDAT EQU   X'04'                    PROCESSING TYPE, UPDATE  Y02072 01720002
*                                         OR OUTIN               Y02072 01730002
DEBINOUT EQU   X'02'                    PROCESSING TYPE, INOUT   Y02072 01740002
SAVELG   EQU   72                      LENGTH OF SAVE AREA       S21045 01745021
KEYMASK  EQU   X'80'                    MASK TO DISTINGUISH      Y02072 01755002
*                                         BETWEEN USER AND       Y02072 01760002
*                                         SYSTEM KEYS            Y02072 01780002
*********************************************************************   01800000
*                                                                       01820000
*                                                                       01840000
* OFFSET FOR PARAMETER TESTS                                            01860000
*                                                                       01880000
ONE        EQU   X'01'                                                  01900000
FRTYATE    EQU   48                                                     01920000
DISPSN     EQU   X'0'                                                   01940000
*                                                                       01960000
*                                                                       01980000
*********************************************************************   02000000
*                                                                       02020000
* OFFSETS FOR DEB REFERENCE                                             02040000
*                                                                       02060000
*                                                                       02080000
BIN      EQU   36                                                       02100000
BEXT     EQU   38                                                       02120000
*                                                                       02140000
*                                                                       02160000
*                                                                       02180000
*********************************************************************   02200000
*                                                                       02220000
* MASK'S USED TO TEST OPTION FIELDS IN DCB                              02240000
*                                                                       02260000
*                                                                       02280000
*                                                                       02300000
LASTDCB    EQU   X'01'                                                  02320000
DOUBLE     EQU   X'01'                                                  02340000
*                                                                       02360000
*                                                                       02380000
STOWB      EQU   X'80'                                                  02400000
WRTCK      EQU   X'80'                                                  02420000
OVRFLO     EQU   X'20'                                                  02440000
PCI        EQU   X'20'                                                  02460000
MINKEY     EQU   X'01'                                                  02480000
CONCAT     EQU   X'FF'                                                  02500000
*                                                                       02520000
*********************************************************************   02540000
*                                                                       02560000
* MASKS FOR ACCESS METHODS IN SAM                                       02580000
*                                                                       02600000
QSAMB      EQU   X'01'                                                  02620000
BSAMBIT    EQU   X'00'                                                  02640000
PAM        EQU   X'02'                                                  02660000
PSAM       EQU   X'42'                                                  02680000
*                                                                       02700000
*                                                                       02720000
* MASKS FOR MACRO'S TO BE USED                                          02740000
*                                                                       02760000
PUTB       EQU   X'40'                                                  02780000
READB      EQU   X'20'                                                  02800000
CNTRLB   EQU   X'02'                                                    02820000
*                                                                       02840000
*********************************************************************   02860000
*                                                                       02880000
* MASKS FOR DEVICES TO BE SUPPORTED                                     02900000
*                                                                       02920000
DABIT    EQU   X'20'                                                    02940000
URBIT    EQU   X'40'                                                    02960000
TAPE     EQU   X'80'                    TAPE DEVICE              S20038 02970020
*                                                                       02980000
*                                                                       03000000
*********************************************************************   03020000
*                                                                       03026020
* BYTE COUNTS AS EQUATES                                                03032020
*                                                                       03038020
B0       EQU   0                        BYTE COUNT OF 0          S20201 03044020
B1       EQU   1                        BYTE COUNT OF 1          S20201 03050020
B2       EQU   2                        BYTE COUNT OF 2          S20201 03056020
B3       EQU   3                        BYTE COUNT OF 3          S20201 03062020
B4       EQU   4                        BYTE COUNT OF 4          S20201 03068020
B5       EQU   5                        BYTE COUNT OF 5          S20201 03074020
B8       EQU   8                        BYTE COUNT OF 8          S20201 03080020
B12      EQU   12                       BYTE COUNT OF 12         M0474  03083021
B56      EQU   56                       BYTE COUNT OF 56         S20201 03086020
B80      EQU   80                       BYTE COUNT OF 80         S20201 03092020
*                                                                       03098020
*                                                                       03104020
*********************************************************************   03120000
*                                                                       03140000
* MASKS FOR STATUS BITS TO BE TESTED                                    03160000
*                                                                       03180000
*                                                                       03200000
COMPLETE   EQU   X'80'                                                  03220000
FIRSTIOB   EQU   X'01'                                                  03240000
*                                                                       03260000
*                                                                       03280000
*                                                                       03300000
*********************************************************************   03320000
*                                                                       03340000
* MASKS FOR BUFFER TECHNIQUE'S                                          03360000
*                                                                       03380000
EXCHANGB   EQU   X'10'                                                  03400000
SIMPLEB    EQU   X'40'                                                  03420000
*                                                                       03440000
*********************************************************************   03460000
*                                                                       03480000
*                                                                       03500000
* MODES OF OPERATION FOR QSAM                                           03520000
*                                                                       03540000
LOCATEB    EQU   X'08'                                                  03560000
MOVEB      EQU   X'10'                                                  03580000
SUBSTUTB   EQU   X'04'                                                  03600000
*                                                                       03620000
FLGOFFST EQU   4                        OFFSET TO FLAG IN BCB    S19015 03625019
RAFLAG   EQU   X'80'                    RECORD AREA INDICATOR    S19015 03630019
SPANNED  EQU   X'08'                    SPANNED RECORDS          S19015 03635019
*                                                                       03640000
*********************************************************************   03660000
*                                                                       03680000
* OTHER MASKS                                                     OC022 03690000
*                                                                       03700000
UNUSED   EQU   X'80'                    DCB OPENED-NOT YET USED   OC022 03710000
*                                                                       03720000
*                                                                       03740000
*********************************************************************   03760000
*                                                                       03780000
*                                                                       03800000
* MASKS FOR RECORD FORMATS                                              03820000
*                                                                       03840000
*                                                                       03860000
STANDRDF   EQU   X'08'                                                  03880000
FORMATU    EQU   X'C0'                                                  03900000
FORMATF    EQU   X'80'                                                  03920000
FORMATV    EQU   X'40'                                                  03940000
FORMATD  EQU   X'20'                    D FORMAT RECORDS         S20038 03950020
*                                                                       03960000
*                                                                       03980000
*********************************************************************   04000000
*                                                                       04020000
*       COMMAND BYTES NEEDED                                            04040000
*                                                                       04060000
TIC      EQU   X'08'                                                    04080000
NOP      EQU   X'03'                                                    04100000
OABD066  EQU   66                                                S21042 04103021
NOPTIC   EQU   X'88'                    NOP TIC COMMAND          S20201 04106020
         EJECT                                                          04160002
         BALR  RBASE,0                                                  04420000
         USING SOP90,RBASE                                              04440000
         USING IHADCB,RDCB                                              04460000
         USING FORCORE,RCORE                                            04480000
SOP90    EQU   *                                                        04500000
*                                                                       04520000
         B     BEGIN                                             Y02072 04530002
         DC    C'IGG01911'              MODULE NAME              Y02072 04532002
         DC    C' ZA01361'              LAST SHIP CODE          ZA01361 04534003
         DC    C'02/25/75'              LAST DATE MODIFIED      ZA01361 04536003
BEGIN    DS    0H                                                Y02072 04538002
         L     RDCB,0(RPARC)            GET DCB ADDRESS                 04540000
         LA    RDCB,0(RDCB)             CLEAR HI BYTE                   04560000
         L     RCORE,4(RWTGC)           GET WRK AREA ADDRESS            04580000
         L     RDEB,DCBDEBAD            GET DEB ADDR             Y02072 04610002
         USING DEBBASIC,RDEB                                     Y02072 04612002
*                                                                       04614002
* ISSUE IECRES MACRO TO GET USERS COPY OF THE DCB REFRESHED      Y02072 04616002
*                                                                       04618002
         USING WTG,RWTG                                          Y02072 04618402
         IECRES  INIT,DCBCOPY=FRWKAR,STM=(R0,R14,WTGPREFX)       Y02072 04618802
         DROP  RWTG                                              Y02072 04619202
         MVC   DEBDCBB,DXUDCBAD+1       USERS DCB ADDR TO DEB    Y02072 04619602
*                                                                       04619702
* DELETE THE MESSAGE CSECT (IGGMSG01) IF IT HAS BEEN LOADED      Y02072 04619802
*                                                                       04619902
         L     RWK1,DXMSGADR            NO, GET MSG CSECT ADDR   Y02072 04630602
         LTR   RWK1,RWK1                WAS MSG CSECT LOADED     Y02072 04632602
         BZ    SOP70                    NO, DON'T DELETE         Y02072 04633002
         DELETE  EPLOC=MSGCSECT         YES, DELETE MSG CSECT    Y02072 04633102
         SR    RWK2,RWK2                PREPARE TO ZERO FIELD    Y02072 04634602
         ST    RWK2,DXMSGADR            INDICATE MSG CSECT HAS   Y02072 04636602
*                                         BEEN DELETED           Y02072 04638602
SOP70    EQU   *                                                 Y02072 04638702
         TM    JFCBMSK4,JFCBDUMY        DUMMY DATA SET           Y02072 04639302
         BO    SOPSTOP3                 YES, RETURN TO COM OPEN  Y02072 04639402
         TM    DCBMACF1,DCBMRECP        EXCP BEING USED          Y02072 04640002
         BO    SOPSTOP3                 YES, RETURN TO COM OPEN  Y02072 04641502
         SR    RWK1,RWK1                PREPARE REGISTER         YM4697 04641902
*                                                                       04643002
*  MUST CLEAR AUDIT TRAIL TO KEEP FORCE CLOSE EXECUTOR FROM      YM4697 04645002
*  TRYING TO FREEMAIN AN AREA NOT YET GETMAINED (AREA FOR QSAM   YM4697 04647002
*  BUFFER PRIMING)                                               YM4697 04649002
*                                                                       04651002
         ST    RWK1,DXATEXC2            CLEAR IN CASE FORCE      YM4697 04654002
*                                         EXECUTOR GET CONTROL   YM4697 04655502
         OI    FCAOPEN,FCAOCOPY         INDICATE TO FORCE CLOSE  Y02072 04657002
*                                         EXEC TO USE NORMAL     Y02072 04658502
*                                         CLOSE EXECUTORS        Y02072 04660002
         EJECT                                                          04660402
*                                                                       04661502
* SET THE TYPE OF RELEATED REQUEST (RR) FOR NORMAL SCHEDULING    Y02072 04663502
* DATA SETS WITH MORE THAN 1 IOB. THE TYPE OF RR SETTING DEFINES Y02072 04665502
* THE TIME IN THE PROCESSING OF THE CURRENT REQUEST THAT IOS CAN Y02072 04665902
* START THE NEXT RR. THIS IS CONTROLLED BY THE PROCESSING REQD   Y02072 04667302
* TO PREPARE THE NEXT RR FOR I/O INITIATION. (IE, IF CHAN END    Y02072 04669302
* APPENDAGE UPDATES THE NEXT IOB AFTER COMPLETION OF THE CURRENT Y02072 04669702
* IOB, I/O CANNOT BE STARTED FOR THE NEXT REQUEST UNTIL IOS HAS  Y02072 04670102
* RECEIVED CONTROL BACK FROM THE CHAN END APPENDAGE).            Y02072 04670502
* THE FOLLOWING MATRIX SHOWS THE TYPES OF RELATED REQUESTS.      Y02072 04670902
*                                                                       04671002
*                                _______________________________ Y02072 04671102
*                                | TYPE I | TYPE II | TYPE III | Y02072 04671202
* _______________________________|________|_________|__________| Y02072 04671302
* |ERP PROCESSING REQD           |        |    X    |          | Y02072 04671402
* |______________________________|________|_________|__________| Y02072 04671502
* |CE APPEND PROCESSING REQD     |        |    X    |          | Y02072 04671802
* |______________________________|________|_________|__________| Y02072 04671902
* |CE INTERRUPT REQD             |        |         |     X    | Y02072 04672002
* |______________________________|________|_________|__________| Y02072 04672102
* |SIO APPEND PROCESSING REQD    |   X    |         |          | Y02072 04672302
* |______________________________|________|_________|__________| Y02072 04672402
* |EOE APPEND PROCESSING REQD    |   X    |         |          | Y02072 04672702
* |______________________________|________|_________|__________| Y02072 04672802
*                                                                       04672902
*  NOTE: THE ONLY EXCEPTION TO THE ABOVE MATRIX IS FOR MAG TAPE. Y02072 04673002
*        UNIT EXCEPTION IS PRESENTED FROM TRYING TO WRITE OVER   Y02072 04673402
*        THE REFLECTIVE MARKER OR READING A TAPE MARK. TO KEEP   Y02072 04673802
*        IOS FROM STARTING THE NEXT RR IT IS NECESSARY FOR THE   Y02072 04674202
*        ERP TO MARK THIS IN PERMANENT ERROR. SINCE ERP PROCESS- Y02072 04674602
*        ING IS AFTER CE PROCESSING (AND SAM OUTPUT DATA SETS,   Y02072 04675202
*        SAM TAPE INPUT DATA SETS DO NOT HAVE CE APPENDAGES),    Y02072 04675602
*        THE TYPE MUST BE II.                                    Y02072 04676002
*                                                                       04676402
         L     RDCB,DXUDCBAD            USERS DCB ADDR           Y02072 04676802
         MODESET  KEYADDR=DXUKEY,WORKREG=15                      Y02072 04677202
*                                                                       04677602
* TEST FOR CHAINED SCHEDULING. ONLY ONE IOB (MIOB) SO REQUEST    Y02072 04678002
* IS UNRELATED.                                                  Y02072 04678902
*                                                                       04679702
         TM    DCBCIND2,DCBCNCHS        CHAIN SCHED BEING USED   Y02072 04681102
         BZ    SOP72                    NO, TEST FOR 1 IOB       Y02072 04682502
         L     RIOB,DCBIOBAD            GET MIOB ADDRESS         Y02072 04682602
         USING IOBQSAMC,RIOB                                     Y02072 04682902
         OI    IOBFLAG1,IOBUNREL        SET UNRELATED REQ FLAG   Y02072 04683302
         DROP  RIOB                                              Y02072 04683702
         L     RIOB,DCBIOBA             GET ICB ADDRESS          Y02072 04683802
         B     SOP88                    BYPASS RR SETTING        Y02072 04683902
*                                                                       04684002
* FOR NORMAL SCHEDULING, CHECK FOR MORE THAN 1 IOB. REQUEST IS   Y02072 04684402
* UNRELATED IF ONLY ONE.                                         Y02072 04684602
*                                                                       04685302
SOP72    EQU   *                                                 Y02072 04685502
         L     RIOB,DCBIOBA             GET FIRST IOB ADDR       YM5778 04685902
         USING IOBQSAMN,RIOB                                     Y02072 04686002
         IC    RWK1,DCBBUFNO            GET NO OF IOB'S (QSAM)   Y02072 04686102
         TM    DCBCIND2,DCBCNQSM        IS THIS QSAM             Y02072 04686202
         BO    SOP75                    YES, USE BUFNO           Y02072 04686302
         IC    RWK1,DCBNCP              USE NCP FOR BSAM         Y02072 04686402
SOP75    EQU   *                                                 Y02072 04686802
         CH    RWK1,ONEBUFER            USING ONLY ONE IOB       Y02072 04686902
         BNH   SOP88                    YES, BYPASS RR SETTING   YM6506 04687302
*                                                                       04692302
* MUST COMPARE ADDRESS IN USERS APPENDAGE VECTOR TABLE AGAINST   Y02072 04693702
* ADDRESSES IN IOS'S AVT TO SEE IF AN APPENDAGE HAS BEEN LOADED. Y02072 04695102
*                                                                       04696502
         L     RWK2,CVTPTR              GET THE CVT ADDR         Y02072 04697902
         USING CVTMAP,RWK2                                       Y02072 04699302
         L     RWK2,CVTXAPG             IOS'S APPENDAGE VECT TAB Y02072 04700702
         DROP  RWK2                                              Y02072 04702102
         USING IOSAPTAB,RWK2                                     Y02072 04703502
         L     RWK3,DEBAPPAD            GET USERS APP VCT TAB    Y02072 04727502
         DROP  RDEB                                              Y02072 04729002
         USING DEBAVT,RWK3                                       Y02072 04730502
         CLC   DEBSIOA,IOSAPPND         SIO APPEND LOADED        Y02072 04733502
         BNE   SOP88                    YES, DO NOT SET FLAGS    Y02072 04735002
*                                         IN IOB FOR TYPE I REQ  Y02072 04736502
*                                         (DEFAULT IS BITS OFF)  Y02072 04736602
         CLC   DEBEOEA,IOSAPPND         EOE APPEND LOADED        Y02072 04736902
         BNE   SOP88                    YES, DO NOT SET FLAGS    Y02072 04737302
         CLC   DEBCEA,IOSAPPND          WAS A CE APP LOADED      Y02072 04738002
         BNE   SOP82                    YES, GO TO SET TYPE II   Y02072 04739502
         TM    DCBDEVT,TAPE             IS THIS MAG TAPE         Y02072 04739902
         BO    SOP82                    YES, GO SET TYPE II      Y02072 04740302
SOP81    OI    IOBFLAG2,IOBRRT3         NO, MUST BE TYPE III REQ Y02072 04741002
         L     RIOB,IOBNIOBA            GET NEXT IOB             Y02072 04742502
         BCT   RWK1,SOP81               GO TO SET IN NEXT IOB    Y02072 04744002
*                                         IF MORE                Y02072 04745502
         B     SOP88                    COMPLETED SETTNG REL REQ Y02072 04747002
SOP82    OI    IOBFLAG2,IOBRRT2         SET TYPE II REL REQ      Y02072 04748502
         L     RIOB,IOBNIOBA            GET NEXT IOB             Y02072 04750002
         BCT   RWK1,SOP82               GO TO SET IN NEXT IOB    Y02072 04751502
*                                         IF MORE                Y02072 04753002
*                                                                       04754502
* EXIT THIS MODULE IF NOT USING QSAM.                            Y02072 04756002
*                                                                       04757502
SOP88    TM    DCBCIND2,DCBCNQSM        QSAM BEING USED          Y02072 04759002
         BZ    SOPSTOP2                 NO, RETURN TO COM OPEN   Y02072 04760502
         L     RIOB,DCBIOBA             GET IOB                  Y02072 04762002
         DROP  RWK2                                              Y02072 04763502
         DROP  RWK3                                              Y02072 04765002
         DROP  RIOB                                              Y02072 04766502
         EJECT                                                          04766902
         LR    RTIOT,RIOB               SAVE FOR WORK REGISTER          04768002
*                                                                       04769502
         XC    DCBEOBAD(8),DCBEOBAD     FORCE END OF BUFFER CONDITION   04771002
*                                                                       04772502
         SR    RB,RB                                                    04774002
         TM    DCBDEVT,X'20'            DCB USING A D.A. DEVICE         04775502
         BC    1,SOP901                 YES BRANCH                      04777002
*                                                                       04778502
         TM    DCBDEVT,X'40'            DCB USING U.R. DEVICE           04780000
         BO    SOP9X                    YES BRANCH                      04800000
*                                                                       04820000
         TM    DCBCIND1,X'01'           IS EXCHANGE BUFFERING USED      04840000
         BO    SOP901                   YES. BRANCH                     04860000
*                                                                       04880000
**********************************************************************  04900000
*        THIS SECTION WILL SET THE READ OR WRITE CCW'S UP WITH THE      04920000
*        BUFFER ADDRESS AND THE BLOCK SIZE FOR TAPE OR UNIT             04940000
*        RECORD EQUIPMENT                                               04960000
**********************************************************************  04980000
*                                                                       05000000
SOP9X    EQU   *                                                        05020000
         IC    RB,DCBBUFNO              GET NO. OF BUFFERS TO PRIME     05040000
         LR    RDEB,RB                  COPY BUFFER NUMBER              05060000
         LR    RD,RTIOT                 SAVE ADDRESS OF FIRST IOB/ICB   05080000
SOP900A  EQU   *                                                        05100000
*                                                                       05120000
         LA    RTIOT,32(RTIOT)          POINT TO CCW  ASSUME PCI        05140000
         TM    DCBCIND2,X'04'           PCI SCHEDULING USED             05160000
         BC    1,SOP900B                YES, BRANCH                     05180000
         LA    RTIOT,8(RTIOT)           ADJUST FOR NORMAL SCHEDULING    05200000
         TM    DCBMACRF,CNTRLB          CNTRL MACRO USED FOR INPUT      05220000
         BC    14,SOP900B               NO BRANCH                       05240000
         TM    DCBDEVT,X'40'        DCB USING U.R. DEVICE               05260000
         BC    14,SOP900B          NO BRANCH                            05280000
         LA    RTIOT,8(RTIOT)           ADJUST CHANNEL PROGRAM ADDRESS  05300000
*                                                                       05320000
SOP900B  EQU   *                                                        05340000
*                                                                       05360000
         L     RWK1,DCBBUFCB            ADDR OF BUF CNTRL BLK    YM7595 05360102
         USING BCBLK,RWK1                                               05360202
         L     RBUFADR,BCBBUFPT         ADDR OF NEXT AVAIL BUF   YM7595 05360302
         LTR   RBUFADR,RBUFADR          VALID BUFFER ADDRESS     YM7595 05360402
         BE    BUFERR                   NO, BRANCH TO ABEND       16059 05412002
         USING BUFFER,RBUFADR                                           05412502
         MVC   BCBBUFAD,BUFNXPTB        UPDATE TO NEXT AVAIL BUF YM7595 05412602
         USING CCW,RTIOT                                                05412702
         STCM  RBUFADR,B'0111',CCWADDRB  BUFFER ADDR TO CCW      YM7595 05412802
         MVC   CCWBYTE,DCBBLKSI         BYTE COUNT TO CCW        YM7595 05412902
         DROP  RWK1,RBUFADR,RTIOT                                       05413002
         L     RTIOT,0(RD)              GET THE NEXT IOB TO INITIALIZE  05500000
         LR    RD,RTIOT                 UPDATE IOB POINTER              05520000
         BCT   RB,SOP900A               IF MORE IOBS/ICBS CONTINUE.     05540002
         SPACE                                                          05540102
         MODESET  EXTKEY=DATAMGT                                        05540202
         SPACE                                                          05540302
         OI    FCAOPEN2,FCAOIOBC        INDIC BUFFERS CAN BE     YM7595 05540402
*                                         RETURNED TO BUF POOL   YM7595 05540502
         SPACE                                                          05540602
         MODESET  KEYADDR=DXUKEY,WORKREG=1                              05540702
         SPACE                                                          05540802
*                                                                       05560000
SOP901   EQU   *                                                        05580000
*                                                                       05600000
*                                                                       05620000
*                                                                       05640000
SOP902   EQU   *                                                        05660000
*                                                                       05680000
         TM    0(RPARC),OUTP            FILE FOR OUTPUT ONLY            05700000
         BC    14,SOP908                NO BRANCH                       05720000
*                                                                       05740000
         OI    DCBIOBA,X'42'           TURN ON OUTPUT BIT               05760000
         IC    RB,DCBOFFSW              GET WRITE CCW OFFSET            05780000
         TM    DCBCIND1,X'01'           EXCHANGE BUFFERING USED         05800000
         BC    8,SOP903                 NO BRANCH                       05820000
*                                                                       05840000
         LA    RD,0(RB,RIOB)            POINT TO WRITE CCW              05860002
         LH    RC,DCBEROPT+4            GET BLKNG FACTOR                05880000
         SLL   RC,3                     MULT. BY '8'                    05900000
         AR    RC,RD                    POINT TO LAST WRT CCW           05920000
         ST    RC,DCBLCCW               SET TO LAST CCW         XA02987 05930002
         ST    RC,DCBCCCW               FORCE END OF BLOCK COND XA02987 05940002
         B     SOP905                                                   05960000
*                                                                       05980000
SOP903   EQU   *                                                        06000000
*                                                                       06020000
         AR    RB,RIOB                  GET TO WRITE CCW                06040002
         L     RB,0(RB)                 GET BUFFER ADDRESS FROM CCW     06060000
         LA    RB,0(RB)                HI BYTE CLEARED                  06080000
*                                                                       06100000
         LH    RC,DCBBLKSI              GET BLOCK SIZE                  06120000
         AR    RC,RB                   CCOMPUTE EOB ADDRESS             06140000
         ST    RC,DCBEOBAD              STORE AS EOB ADDRESS            06160000
*                                                                       06180000
         TM    DCBRECFM,FORMATU         U RECORDS USED           A41465 06182021
         BC    1,SOP904                 YES, BRANCH              A41465 06182421
         TM    DCBDEVT,TAPE             TAPE DEVICE              S20038 06183020
         BZ    SOP90300                 NO, BRANCH               S20038 06186020
         TM    DCBRECFM,FORMATD         D FORMAT RECORDS         S20038 06189020
         BO    SOP903A                  YES, BRANCH              S20038 06192020
SOP90300 EQU   *                                                 S20038 06195020
*                                                                       06240000
         TM    DCBRECFM,FORMATV         V RECS USED                     06260000
         BC    8,SOP904                 NO BRANCH                       06280000
*                                                                       06300000
SOP903A  EQU   *                                                 S20038 06310020
         XC    0(8,RB),0(RB)            ZERO SMALL AND LARGE LL FIELDS  06320000
         MVI   1(RB),X'04'             INIT LARGE LL TO FOUR            06340000
         LA    RB,4(RB)                                                 06360000
         L     RC,DCBBUFCB              GET BUFCB ADDRESS        S19015 06361019
         LA    RC,DISPSN(RC)            CLEAR HI ORDER BYTE      S19015 06362019
         TM    FLGOFFST(RC),RAFLAG      RECORD AREA PRESENT      S19015 06363019
         BNO   SOP904                   NO,GOTO STORE RECAD      S19015 06364019
         TM    DCBRECFM,SPANNED         TEST IF SPANNED RECORD   S19015 06365019
*                                            FORMAT                     06366019
         BNO   SOP904                   NO,GOTO STORE RECAD      S19015 06367019
*                                                                       06368019
         O     RB,PRIME                 SET INDICATOR FOR 1ST    S19015 06369019
*                                       ENTRY                    S19015 06370019
*                                                                       06380000
SOP904   EQU   *                                                        06400000
         ST    RB,DCBRECAD             STORE FIRST RECORD ADDRESS       06420000
*                                                                       06440000
SOP905   EQU   *                                                        06460000
*                                                                       06480000
*********************************************************************** 06500000
*                                                                       06520000
*   SET UP FOR PUNCH RETRY OPTION 3 OR MORE BUFFERS                     06540000
*                                                                       06560000
*********************************************************************** 06580000
*                                                                       06600000
         CLI   DCBDEVT,X'45'            DEVICE A 2520?           A36344 06606020
         BE    SOP9051                                           A36344 06612020
         CLI   DCBDEVT,X'42'            THIS FOR THE 2540 PUNCH         06620000
         BC    7,SOPSTOP1               NO, BRANCH                      06640002
SOP9051  EQU   *                                                 A36344 06643020
         OI    DCBCIND1,UNUSED          SET BIT TO SHOW DCB NOT   OC022 06646000
*                                       YET USED                  OC022 06652000
         CLI   DCBBUFNO,X'03'           3 IOBS OR MORE                  06660000
         BC    4,SOPSTOP1               NO,BRAMCH                       06680000
         TM    DCBOPTCD,PCI             PCI SCHEDULING USED             06700000
         BC    1,SOPSTOP1               YES BRANCH                      06720000
*                                                                       06740000
         SR    RF,RF                                               9656 06780015
         IC    RF,DCBBUFNO             BUFNO = NUMBER OF IOB'S.    9656 06820015
         LR    RC,RIOB                  COPY FIRST IOB ADDRESS          06860002
         L     RIOB,0(RIOB)             GET TO NEXT IOB                 06920002
         L     RIOB,0(RIOB)            LINK TO NEXT IOB.           9656 06940002
*                                                                       06960000
*                                                                       06980000
SOP9063  EQU   *                                                        07000000
*                                                                       07020000
         LA    RD,4(RC)                 GET IOBS ECB ADDRESS            07040000
         ST    RD,12(RIOB)              STORE ECB ADDRESS IN CURR IOB   07060002
         OI    9(RIOB),X'01'            SET PUNCH RETRY FLG FOR IOS     07080002
         L     RIOB,0(RIOB)             UPDATE CURR IOB POINTER         07100002
         L     RC,0(RC)                 UPDATE TO CURR ECB ADDRESS      07120000
         BCT   RF,SOP9063               PROCESS ALL IOBS                07140000
         B     SOPSTOP1                 YES                             07160000
*                                                                       07180000
SOP908   EQU   *                                                        07200000
*                                                                       07220000
         TM    DCBRECFM,DCBRECV+DCBRECSB DATA SET VARIABLE SPAN ZA01361 07230003
         BNO   NOTVS                    NO, THEN BRANCH         ZA01361 07232003
         XC    DCBPRECL(1),DCBPRECL     ZERO BYTE FOR FIRST PASSZA01361 07234003
*                                       THROUGH GET PROCESSING  ZA01361 07236003
NOTVS    EQU   *                                                ZA01361 07238003
         TM    0(RPARC),X'03'           DCB FOR BACKWARDS INPUT         07240000
         BC    9,SOP909                 NO BRANCH                       07260000
*                                                                       07280000
*                                                                       07300000
         OI    DCBOFLGS,X'40'  SET BIT ON BEFORE PRIME BUFFERS    0279  07310013
         LR    RB,RIOB                  COPY IOB ADDRESS                07320002
         LA    RC,1                     GET A CONSTANT OF ONE           07340000
         LNR   RC,RC                    NEGATE ONE                      07360000
*                                                                       07380000
SOP908A  EQU   *                                                 A30962 07388020
         TM    DCBCIND2,X'04'  CHAIN SCHEDULING SUPPORTED        A30962 07396020
         BC    8,SOP908B  NO - BRANCH                            A30962 07404020
         STH   RC,X'1C'(RB)  STORE AS INCREMENT COUNT - ICB      A30962 07412020
         BC    15,SOP908C                                        A30962 07420020
SOP908B  EQU   *                                                 A30962 07428020
         STH   RC,X'24'(RB)  STORE AS INCREMENT COUNT - IOB      A30962 07436020
SOP908C  EQU   *                                                 A30962 07444020
         LR    RF,RB                    COPY IOB ADDRESS                07460000
         SR    RE,RE                                                    07480000
         IC    RE,DCBOFFSR              GET READ CCW OFFSET             07500000
         ALR   RF,RE                    POINT TO READ CCW               07520000
         LR    RD,RF                    COPY CCW ADDRESS                07540000
         L     RF,0(RF)                 GET BUFFER ADDRESS FROM CCW     07560000
         AH    RF,DCBBLKSI              ADD BLOCK SIZE TO ADDRESS       07580000
         BCTR  RF,0                     REDUCE ADDRESS BY ONE           07600000
         ST    RF,0(RD)                 RESTORE BUFFR ADDRESS TO CCW    07620000
         MVI   0(RD),X'0C'              READ BACK CMD BYTE              07640000
         L     RB,0(RB)                 GET NEXT IOB                    07660000
         BCT   RDEB,SOP908A             BRANCH IF MORE IOB/ICB'S        07680000
*                                                                       07700000
SOP909   EQU   *                                                        07720000
*                                                                       07740000
         TM    DCBCIND2,X'04'           PCI SCHEDULING USED             07760000
         BC    8,SOPPRIME               NO BRANCH                       07780000
*                                                                       07800000
*      THIS SECTION WILL INITIALIZE THE ICBS FOR PRIMING                07820000
*                                                                       07840000
*                                                                       07860000
         SR    RB,RB                                                    07880000
         IC    RB,DCBBUFNO              GET NUMBER OF BUFFERS           07900000
         LR    RTIOT,RB                 COPY NUMBER OF BUFFERS          07920000
         BCTR  RTIOT,0                  SUBTRACT 1 FROM BUFNO FOR LOOP  07940002
         L     RD,DCBIOBAD              GET MAIN IOB ADDRESS            07960000
         L     RC,0(RIOB)               GET SECOND ICB                  07980002
         MVC   9(3,RD),1(RIOB)          PUT 2ND ICB IN AS '1ST IOB'     08000002
         LA    RC,32(RC)                ADD BASIC ICB SIZE              08020000
         TM    DCBDEVT,DABIT            DCB USING DA DEVICE             08040000
         BC    8,SOP90900               NO  BRANCH                      08060000
*                                                                       08080000
         LA    RC,8(RC)                 ADD '8' TO SKIP MBB---R FLD     08100000
         TM    JFCBFLG2,JFCNRPS         ANY DEVICES NON-RPS      YM4635 08102002
         BO    NOTRRA                   YES, BRANCH              YM4635 08104002
         ST    RC,B80(RD)               PUT ICB CHP ADDR IN RCD  S20201 08106020
*                                       READY TIC                       08108020
         MVI   B80(RD),TIC              RESTORE TIC CMND         S20201 08110020
         B     SOP90901                 GO AROUND NEXT           S20201 08112020
NOTRRA   EQU   *                                                 S20201 08114020
         ST    RC,72(RD)                STORE CP STARTAD IN MIOBS TIC   08120000
         MVI   72(RD),TIC               RESTORE TIC CMD BYTE            08140000
         B     SOP90901                                                 08160000
*                                                                       08180000
SOP90900 EQU   *                                                        08200000
*                                                                       08220000
         ST    RC,32(RD)                STORE CP STARTAD IN M-IOB SLOT  08240000
*                                                                       08260000
SOP90901 EQU   *                                                        08280000
         L     RIOB,0(RIOB)             LINK TO NEXT ICB                08300002
         MVI   4(RIOB),X'00'                                            08320002
         IC    RB,2(RD)                 PICK UP INPUT NOP OFFSET        08340000
         LA    RC,0(RB,RIOB)            POINT TO NOP CCW                08360002
         TM    JFCBFLG2,JFCNRPS         ANY DEVICES NON-RPS      YM4635 08362002
         BO    NOTRRE                   YES, BRANCH              YM4635 08364002
         MVC   B1(B3,RC),B5(RC)         MOVE ADDR FROM RH OF     S20201 08366020
*                                       TIC/NOP OF RCD READY            08368020
*                                                                       08370020
NOTRRE   EQU   *                                                 S20201 08372020
*                                                                       08374020
         MVI   0(RC),TIC                STORE TIC CMD BYTE              08380000
*                                                                       08400000
         BCT   RTIOT,SOP90901           IF MORE ICBS RELOOP             08420000
*                                                                       08440000
         TM    DCBMACRF,X'15'          USING DATA, MOVE, OR      M1557? 08450020
*                                       SUBST MODE               M1557  08460020
         BC    5,SOP90903              YES,  BRANCH AROUND       M1557  08470020
*                                       LOCATE                   M1557  08480020
         MVI   0(RC),NOP                RESTORE NOP CMD IN LAST ICB     08500000
         ST    RC,12(RD)                STORE LAST NOP ADDR IN MAINIOB  08520000
*                                                                       08525020
         TM    JFCBFLG2,JFCNRPS         ANY DEVICES NON-RPS      YM4635 08535002
         BO    NOTRRG                   YES, BRANCH              YM4635 08537002
         LA    RB,B8(RC)                GET RD SECTOR CCW ADDR   S20201 08540020
         ST    RB,B0(RC)                PUT IN NOP/TIC CCW       S20201 08545020
         MVI   B0(RC),NOPTIC            PUT IN TIC CMND          S20201 08550020
NOTRRG   EQU   *                                                 S20201 08555020
         B     SOP90902                                                 08560000
SOP90903   EQU  *                                                       08580000
         L     RIOB,0(RIOB)                                             08600002
         MVI   4(RIOB),X'00'                                            08620002
**********************************************************************  08640000
*                                                                       08660000
*      PRIME ICBS BY SCHEDULING THE MAIN IOB FOR EXECUTION              08680000
*                                                                       08700000
**********************************************************************  08720000
*                                                                       08740000
SOP90902 EQU   *                                                        08760000
*                                                                       08780000
**********************************************************************  08800000
         MVI   12(RD),0                 CLEAR EXCP NEEDED FLAG @Z30TSMI 08810003
         EXCP  16(RD)                                                   08820000
**********************************************************************  08840000
*                                                                       08860000
         B     SOPSTOP1                 GO TO XCTL               Y02072 08880002
SOPPRIME EQU   *                                                        08980000
         SR    RB,RB                    CLEAR REG                       09000000
         IC    RB,DCBBUFNO              NO. OF IOBS TO PRIME            09020000
*                                                                       09040000
         TM    DCBMACRF,X'15'           USING DATA, MOVE, OR      M1557 09050002
*                                         SUBST MODE              M1557 09060002
         BC    5,SOP90A                 YES BRANCH                      09080000
*                                                                       09100000
         BCTR  RB,0                     REDUCE BY ONE                   09120000
         LTR   RB,RB                    MORE THAN 1 IOB                 09140000
         BZ    SOPSTOP1                 NO BRANCH                Y02072 09160002
*                                                                       09180000
SOP90A   EQU   *                                                        09200000
*                                                                       09250002
* MUST ISSUE A GETMAIN FOR A REG SAVE AREA FOR EOB ROUTINE       Y02072 09252002
* IN USER KEY TO PREVENT PGM CHECKS. IF THE LENGTH FOR THIS      YM4697 09254002
* GETMAIN IS CHANGED, THE FREEMIAN IN IGG020T1 (SAM/PAM/DAM      YM4697 09254402
* FORCE CLOSE EXECUTOR) MUST ALSO BE CHANGED.                    YM4697 09254802
*                                                                       09256002
         GETMAIN  R,LV=SAVELG,SP=230  ISSUE GETMAIN              Y02072 09258002
*                                                                       09260000
         SPACE                                                          09262002
         MODESET  EXTKEY=DATAMGT        KEY OF AUDIT TRAIL       YM4697 09264002
         SPACE                                                          09266002
         ST    R1,DXATEXC2              SAVE ADDR IN CASE FORCE  YM4697 09268002
*                                         CLO EXEC MUST FREEMAIN YM4697 09268402
         SPACE                                                          09268802
         MODESET  KEYADDR=DXUKEY,WORKREG=13  RESUME USER KEY     YM4697 09269202
         SPACE                                                          09269602
         LR    RSAVE,R1                 PREPARE FOR EOB ROUTINE  Y02072 09270002
         L     RIOB,0(RIOB)             GET NEXT IOB                    09280002
*                                                                       09284021
* THIS ROUTINE TESTS THE CALLING RB TO DETERMINE WHETHER TO BALR        09296002
* (IF KEY <8) OR SYNCH (IF KEY >7) TO EOB ROUTINE. OPENS         Y02072 09300002
* REGISTERS 2-12 ARE SAVED IN THE EXTENDED SVRB SAVEAREA.        Y02072 09302002
*                                                                       09320021
SOP92    EQU   *                                                 M0474  09324021
         ST    RIOB,DCBIOBA             ST IOB PTR IN DCB        M0474  09328002
         USING PSA,0                                             Y02072 09346002
         L     RWK3,PSATOLD             GET CURRENT TCB ADDR     Y02072 09346402
         DROP  0                                                 Y02072 09346802
         USING TCB,RWK3                                          Y02072 09347202
         L     RWK3,TCBRBP              NEED RB ADDR FOR SAVE    Y02072 09347602
*                                         AREA                   Y02072 09349702
         DROP  RWK3                                              Y02072 09352802
         USING RBSECT,RD                                         M0474  09354902
         SPACE 2                                                        09357002
         MODESET  EXTKEY=SUPR           KEY 0 TO STORE IN RB     Y02072 09359102
         SPACE 2                                                        09361202
         STM   RDCB,RB,RBEXSAVE+B4      SAVE OPEN REG 2-12 IN    M0474  09363302
*                                       SVRB+4                   M0474  09365402
*                                       THE 1ST WORD OF SAVEAREA IS     09367502
*                                       PARAMETER LIST IF CONCATENA-    09369602
*                                       TION OF UNLIKE ATTRIBUTES       09371702
         SPACE 2                                                        09373802
         MODESET  KEYADDR=DXUKEY,WORKREG=7  BACK TO USER KEY     Y02072 09375902
         SPACE 2                                                        09378002
         SR   RPARC,RPARC               ZERO R7                  M1630  09380102
         IC   RPARC,DCBOFFSR            INSERT CP OFFSET IN REG  M1630  09382202
*                                         FOR EOB                M1630  09384302
         TM    DXUKEY,KEYMASK           IS RB IN USER KEY        Y02072 09391202
         BO    PRB                      IF YES, BRANCH TO SYNCH  Y02072 09396002
         L     RJ,DCBEOB                LOAD PTR TO EOB MODULE   M0474  09408021
         LR    RBASE,RIOB               SET UP IOB PTR IN R3 FOR M0474  09412002
*                                       EOB                      M0474  09416021
         BALR  RD,RJ                    BR TO EOB                M0474  09420021
         USING *,RD                                              Y02072 09430002
         B     LOADREG                  BR TO LOAD ALL REGISTERS M1812  09439021
         DROP  RD                                                Y02072 09441002
         USING SOP90,RBASE                                       Y02072 09443002
PRB      EQU   *                                                 M0474  09444021
         L     RDCB,DXPDCBAD            USE PROTECTD COPY OF THE Y02072 09454002
*                                         DCB FOR FOLLOWING INST Y02072 09464002
         L     RJ,DCBEOB                LOAD EOB ADDRESS         M0474  09472021
         L     RDCB,DXUDCBAD            GET USERS COPY AGAIN     Y02072 09474002
         LR    RBASE,RIOB               PUT IOB IN R3 FOR EOB    M0474  09476002
         SYNCH (RJ)                     SYNCH TO EOB             M0474  09480021
         USING PSA,0                                             Y02072 09530002
LOADREG  L     RWK3,PSATOLD             GET CURRENT TCB ADDR     Y02072 09540002
         DROP  0                                                 Y02072 09550002
         USING TCB,RWK3                                          Y02072 09550402
         L     RWK3,TCBRBP              GET PTR TO SVRB          Y02072 09550802
         DROP  RWK3                                              Y02072 09551202
         USING RBSECT,RWK3                                       Y02072 09554002
         LM    RDCB,RB,RBEXSAVE+B4      RESTORE OPEN REGISTERS   M0474  09556021
*                                       2-12                     M0474  09560021
         DROP  RD                                                M0474  09564021
         L     RIOB,0(RIOB)             GET NEXT IOB                    09620002
         BCT   RB,SOP92                 MORE TO PRIME  BRANCH           09640000
*                                                                       09660000
         LR    R1,RSAVE                 BEGINNING ADDR TO FREE   Y02072 09670002
*                                                                       09680000
         FREEMAIN  R,A=(1),SP=230,LV=SAVELG  FREEMAIN SAVEAREA   Y02072 09690002
         SPACE                                                          09692002
         MODESET  EXTKEY=DATAMGT        KEY OF AUDIT TRAIL       YM4697 09694002
         SPACE                                                          09696002
         SR    RWK3,RWK3                PREPARE REGISTER         YM4697 09698002
         ST    RWK3,DXATEXC2            TO KEEP FORCE CLOSE EXEC YM4697 09698402
*                                         FROM TRYING TO FREE    YM4697 09698802
*                                         AN AREA ALREADY FREED  YM4697 09699202
         SPACE                                                          09699602
         MODESET  KEYADDR=DXUKEY,WORKREG=14  RESUME USER KEY     YM4697 09699702
         SPACE                                                          09699802
*                                                                       09700000
         ST    RTIOT,DCBIOBA           RESET DCB TO ORIGINAL IOB.       09720000
*                                      NEXT FUNCTION                    09740000
SOPSTOP1 EQU   *                                                        09780000
         NI    DCBIOBA,X'FE'            TURN OFF FIRST IOB BIT.         09800000
*                                                                       09820000
SOPSTOP2 EQU   *                        COME HERE TO MODESET     Y02072 09830002
         MODESET  EXTKEY=DATAMGT        DATA MGT KEY TO XCTL     Y02072 09832002
SOPSTOP3 EQU   *                        COME HERE IF IN KEY 5    Y02072 09834002
         MVI   0(RWTGC),X'00'           CLEAR WTG ENTRY                 09840000
*                                                                       09900000
RELOOP   LA    RWTGC,WGOFF(0,RWTGC)     INCREMENT CURR WTG ENTRY        09920000
         LA    RPARC,PLOFF(0,RPARC)     INCR CURRENT DCB ENTRY PRTR     09940000
         CLC   0(2,RWTGC),AMIDCNST      THIS RT NEEDED AGAIN            09960000
         BCR   8,RBASE                                                  09980000
*                                                                       10000000
         CLC   0(2,RWTGC),OPIDCNST      END OF TABLE                    10020000
         BC    7,RELOOP                 NO,CHECK NEXT ENTRY             10040000
*                                                                       10060000
         LR    RPARC,RPAR                                               10080000
         LA    RWTGC,WAOFF(0,RWTG)      REINITIALIZE WTG LIST PTR       10100000
ZCHEK    CLI   0(RWTGC),X'00'          IS THIS ENTRY COMPLETE           10120000
         BC    7,TCTLRTN                IF NOT TRANSFER CONTROL         10140000
*                                                                       10160000
         LA    RWTGC,WGOFF(0,RWTGC)     GET NEXT ENTRY                  10180000
         LA    RPARC,PLOFF(0,RPARC)                                     10200000
         BC    15,ZCHEK                                                 10220000
*                                                                       10240000
*                                                                 16059 10242016
BUFERR   EQU   *                                                  16059 10244016
         SPACE                                                          10246002
         MODESET  EXTKEY=DATAMGT        KEY OF OPEN WORKAREA     YM5940 10248002
         SPACE                                                          10248402
         DMABCOND OABD066,PDLOAD,RETURN=NONE,RES=NO,REGSAVE=YES  S21042X10250021
                                        CALL PROBLEM DETERMINATION      10254021
TCTLRTN  EQU   *                                                        10260000
         USING WTG,RWTG                                                 10310003
         USING WTGENTRY,RWTGC                                           10320003
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSCF*10360003
               MODID=WTGENTRY                                  @Z30TSCF 10370003
         DROP  RWTG,RWTGC                                      @Z30TSCF 10380003
**                                                                      10400000
*                                                                       10420000
WAOFF    EQU   32                                                       10440000
PLOFF    EQU   4                        OFFSET OF DCB ENTRIES           10460000
WGOFF    EQU   8                        OFFSET OF WTG ENTRIES           10480000
         DS    0F                       FULL WORD ALIGNMENT      S19015 10486019
PRIME    DC    X'40000000'              1ST ENTRY INDICATOR      S19015 10492019
OPIDCNST DC    C'0S'                                                    10500000
AMIDCNST DC    C'11'                                                    10520000
PDLOAD   DC    C'6M',VL3(IGG0196M)      PROBLEM DETERMINATION  @Z30TSCF 10570003
MSGCSECT DC    CL8'IGGMSG01'            NAME OF MSG CSECT        Y02072 10620002
ONEBUFER DC    H'1'                     FOR TESTING FOR ONE BUF  Y02072 10670002
PATCH    DC    0H'0',54X'00'            PATCH AREA               Y02072 10720002
END      EQU   *                        END OF MODULE            Y02072 10730002
         SPACE 4                                                        10740002
IOSAPTAB DSECT                          FOR IOS'S AVT <- CVT     Y02072 10750002
IOSAPPND DS    F                        FOR ADDRESSABILITY TO    Y02072 10760002
*                                         BRANCH BACK INST       Y02072 10770002
         TITLE 'CHANNEL COMMAND WORK DSECT'                      Y02072 10770102
         IHACCW                                                  Y02072 10770202
         TITLE 'BUFFER CONTROL BLOCK DSECT'                      Y02072 10770402
         IGGBCB  TYPE=SAM                                        Y02072 10770802
         TITLE 'IGG01911 - DCB DSECT'                            Y02072 10772002
         DCBD  DSORG=PS                                          Y02072 10774002
         TITLE 'IGG01911 - FORMAT OF OPEN WORKAREA'              Y02072 10780002
         IECDSECS  (MAIN,(IOB,NO)),WTG,PREFX,EXPAND=YES          Y02072 10830002
FORCORE  DSECT                                                   Y02072 10840002
         ORG   JFCBMASK                                          Y02072 10850002
         DS    4B                       FILLER                   Y02072 10860002
JFCBMSK4 DS    B                        JFCBMASK + 4             Y02072 10870002
JFCBDUMY EQU   X'20'                    INDICATES DD DUMMY       Y02072 10872002
         TITLE 'IGG01911 - FORCE CLOSE AUDIT TRAIL DSECT'               10874002
         IHAFCAUD  ORG=YES                                       Y02072 10876002
         TITLE 'IGG01911 - DEB DSECT'                            Y02072 10880002
         IEZDEB                                                  Y02072 10890002
         TITLE 'IGG01911 - IOB DSECT'                            Y02072 10892002
         IEZIOB                                                  Y02072 10894002
         TITLE 'IGG01911 - PSA DSECT'                            Y02072 10896002
         IHAPSA                                                  Y02072 10898002
         TITLE 'IGG01911 - TCB DSECT'                            Y02072 10898402
         IKJTCB                                                  Y02072 10898802
         TITLE 'IGG01911 - RB DSECT'                             Y02072 10899202
         IHARB                                                   Y02072 10899602
         TITLE 'IGG01911 - CVT DSECT'                            Y02072 10899702
CVT      DSECT                                                   Y02072 10899802
         CVT                                                     Y02072 10899902
         END                                                            10900000
