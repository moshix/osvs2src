         TITLE 'IGG0191F - OUTPUT, EXCHANGE BUFFER OPEN EXECUTOR '      00020002
*MODULE NAME - IGG0191F                                          Y02072 00020102
*                                                                       00020202
*DESCRIPTIVE NAME - BUILD IOBS                                   Y02072 00020302
*                                                                       00022002
*COPYRIGHT - NONE                                                Y02072 00024002
*                                                                       00024102
*CHANGE ACTIVITY - AS FOLLOWS:                                   Y02072 00024202
*                                                                       00024302
*          VS2 RELEASE 2 DELETIONS                               Y02072 00024502
*000350,040400,040600,041000,042280-042300,053400,056000,        Y02072 00026002
*060000-060200,060760,092000,09320022800,23400,69200,            Y02072 00027702
*74000,74600                                                     Y02072 00029702
*                                                                YM3914 00031702
*                                                                YM4697 00033702
*                                                                YM7595 00035702
*          RELEASE 20 DELETIONS                                         00037902
*0972                                                            S20038 00039602
*0972024600-024800,033800,052400,060600-060800,064200,067200,    S20201 00041302
*0972076600,082200,085400,085800                                 S20201 00043002
*          RELEASE 21 DELETIONS                                         00044702
*0082004400,074200,090400-090800,091600-093000,093200-093600     S21042 00046402
*                                                                       00048102
*STATUS CHANGE LEVEL 004                                                00056602
*                                                                       00057002
*FUNCTION                                                             * 00058302
*        1.GET CORE FOR IOB'S AND CHANNEL PROGRAMS                      00060000
*        2 CLEAR CORE                                                   00080000
*        3 CONSTRUCT IOBS AND CHANNEL PROGRAMS FOR DISK AND TAPE        00100000
*        4 IT SETS AN AUDIT TRAIL BIT IN THE OPEN WORKAREA       Y02072 00110002
*          INDICATING TO FORCE CLOSE THAT THE CORE GETMAINED FOR Y02072 00112002
*          THE IOB'S CAN BE FREEMAINED.                          Y02072 00116002
*                                                                     * 00120000
*ENTRY POINT                                                          * 00140000
*        IGG0191F  BY  XCTL                                             00160000
*                                                                     * 00180000
*INPUT                                                                * 00200000
*        SEE REGISTER DESCRIPTION                                     * 00220000
*                                                                     * 00240000
*OUTPUT                                                               * 00260000
*        SEE REGISTER DESCRIPTION                                     * 00280000
*        IOBS AND CHANNEL PROGRAMS                                    * 00300000
*                                                                     * 00320000
*EXTERNAL ROUTINES-NONE                                               * 00340000
*                                                                     * 00360000
*EXITS                                                                * 00380000
*        NORMAL BY XCTL TO IGG01924 LOAD EXECUTOR                       00400000
*                                                                     * 00420000
*        ERROR - XCTL TO PROB DET (IGG0196M) FOR WTP AND 013 ABEND      00440021
*                                                                     * 00460000
*TABLES/WORKAREAS                                                     * 00480000
*                                                                     * 00500000
*TABLES/WORKAREAS- WHERE TO GO TABLE (WTG)                              00520000
*                                                                       00540000
*      BYTE  0-7  NAME                                                  00560000
*      BYTE  8-10 RELATIVE DISK ADDRESS(TTR) OF FIRST RECORD            00580000
*      BYTE 11    CONCATENATION NUMBER                                  00600000
*      BYTE 12    ZERO                                                  00620000
*      BYTE 13    ALIAS INDICATOR AND USER DATA FIELD DESCRIPTOR.       00640000
*                        ALIAS INDICATOR 1 BIT                          00660000
*                        NUMBER OF TTRS IN USERS DATA FIELD 2 BITS      00680000
*      BYTE 14-16 TTR OF FIRST TEXT RECORD                              00700000
*      BYTE 17    ZERO                                                  00720000
*      BYTE 18-19 TTR OF NOTE LIST OR SCATTER LIST                      00740000
*      BYTE 20    TRANSLATION TABLE                                     00760000
*      BYTE 21    ZERO OR NUMBER OF ENTRIES IN THE NOTE LIST            00780000
*      BYTE 22-23 ATTRIBUTES                                            00800000
*      BYTE 24-26 TOTAL CONTIGUOUS MAIN STORAGE REQUIRED FOR MODULE     00820000
*      BYTE 27-28 LENGTH OF FIRST TEXT RECORD                           00840000
*      BYTE 29    LENGTH OF WTG TABLE (IN DOUBLE WORDS)                 00860000
*      BYTE 30-31 PATH THROUGH LOADS OF ROUTINES                        00880000
*      BYTE 32-34 IDTTR OF EXECUTOR FOR FIRST DCB                       00900000
*      BYTE 35    WORKAREA ADDRESS FOR FIRST DCB                        00920000
*      BYTE 36-39 TABLE OF IDTTR'S                                      00940000
*      BYTE 32+N(8) IDTTR OF EXECUTOR FOR  N TH DCB  (3 BYTES)          00960000
*                   WORKAREA ADDRESS FOR N TH DCB    (1 BYTE )          00980000
*                   IDTTR OF LAST ROUTINE LOAD       (3 BYTES)          01000000
*                   NOT USED                         (1 BYTE)           01020000
*                                                                       01030002
*MACROS ACTION - MODESET, GETMAIN, XCTL, DMABCOND, XCTLTABL      Y02072 01032002
*                                                                       01040000
*MACROS MAPPING - IECDSECS, IGGBCB, IHACCW, DCBD, IEZIOB,        Y02072 01050002
*                 IECDSECT, IHAFCAUD                             Y02072 01050402
*                                                                       01052002
*ATTRIBUTES                                                           * 01060000
*        REENTRANT,REUSABLE,RUNS IN USER KEY UNLESS              Y02072 01080002
*        OTHERWISE SPECIFIED,SUPER STATE                         Y02072 01082002
*                                                                     * 01100000
*NOTES                                                                * 01120000
*        ALL REG EQUATES HAVE AN 'R' AT BEGINNING OR END OF SYMBOL    * 01140000
*        THIS ROUTINE IS ONLY USED FOR EXCHANGE BUFFERING.IMBEDDED      01160000
*        CONSTANTS FROM THE INSTRUCTION STREAM ARE USED                 01180000
*                                                                     * 01200000
RDCB     EQU   2                       DCB                              01220000
RBASE    EQU   3                       BASE                             01240000
RCORE    EQU   4                       WORK AREA ADDRESS                01260000
RPAR     EQU   5                       TOP OF PARAMETER LIST            01280000
RWTG     EQU   6                       TOP OF WTG TABLE                 01300000
RPARC    EQU   7                       CURRENT PARAMETER                01320000
RWTGC    EQU   8                       CURRENT TRANSFER LOAD            01340000
RTIOT    EQU   9                       IOB COUNTER                      01360000
RBUFADR  EQU   10                      MAINTAINS ADDR OF NEXT    Y02072 01380002
*                                         AVAILABLE BUFFER       Y02072 01390002
RDEB     EQU   11                                                       01400000
RB       EQU   12                      CONSTANT 1(TAPE)RD CNT ADDR DISK 01420000
RWK2     EQU   RB                      WORK REGISTER             Y02072 01430002
RC       EQU   13                      BUFFER ADDRESS                   01440000
RD       EQU   14                                                       01460000
RJ       EQU   15                      CCW ADDRESS                      01480000
RWK1     EQU   RJ                      WORK REGISTER             YM7595 01490002
RE       EQU   0                       BLK FACTOR DURING CHP CONST      01500000
RF       EQU   1                       IOB ADDRESS                      01520000
DISK     EQU   X'20'                                                    01540000
PCI      EQU   X'20'                                                    01560000
DOUBLE   EQU   X'02'                                                    01580000
*****************************************************************  DMOR 01580120
*                                                                  DMOR 01580220
* OFFSETS, MASKS, INDICATORS, AND CCW COMMAND CODES                     01580320
*                                                                  DMOR 01580420
FLAGOFF  EQU   4                        CCW FLAG OFFSET          S20201 01580520
CNTOFF   EQU   7                        CCW BYTE COUNT OFFSET    S20201 01580620
CCWOFF   EQU   8                        CCW LENGTH               S20201 01580720
CHPOFF   EQU   24                       OFFSET TO CHP START ADDR S20201 01580820
D0       EQU   0                        DISP OF ZERO             S20201 01580920
D1       EQU   1                        DISP OF ONE              S20201 01581020
D2       EQU   2                        DISP OF TWO              S20201 01581120
D4       EQU   4                        DISP OF FOUR             S20201 01581220
D6       EQU   6                        DISP OF SIX              S20201 01581320
D8     EQU     8                        DISP OF EIGHT            S20201 01581420
CC       EQU   X'40'                    COMMAND CHAINING FLAG    S20201 01587502
SETSC    EQU   X'23'                    SET SECTOR CCW COMMAND   S20201 01590002
RDSC     EQU   X'22'                    READ SECTOR CCW COMMAND  S20201 01592502
NONCARN  EQU   X'20'                    NOW DISCONNECT INDICATOR S20201 01595002
FORMATD  EQU   X'20'                    D FORMAT RECORDS         S20038 01597502
L        EQU   X'40'                    BUFOFF=(L)               S20038 01600002
BLOCKED  EQU   X'10'                    BLOCKED RECORDS          S20038 01602502
USASCII  EQU   X'08'                    USASCII TAPE             S20038 01605002
ZERO     EQU   X'0'                     CONSTANT OF ZERO         S20038 01607502
OABD063  EQU   63                                                S21042 01610002
IGG0191F CSECT                                                          01612502
*                                                                       01615002
*                                                                       01617502
*                                                                       01620002
*                                                                       01622502
*                                                                       01625002
*                                                                       01627502
*                                                                       01630002
*                                                                       01632502
*                                                                       01635002
         BALR  RBASE,0                                                  01637502
         USING ENTRY1,RBASE                                             01640000
         USING IHADCB,RDCB                                              01660000
         USING FORCORE,RCORE                                            01680000
*                                                                     * 01700000
*********************************************************************** 01720000
*        THIS SECTION DETERMINES AMT OF CORE NEEDED FOR IOBS            01740000
*        AND CHANNEL PROGRAMS                                           01760000
*                                                                     * 01780000
*********************************************************************** 01800000
*                                                                     * 01820000
ENTRY1   EQU   *                                                        01840000
         B     BEGIN                    BR AROUND CONSTANTS      YM4697 01850002
         DC    C'IGG0191F'              MODULE NAME              Y02072 01852002
         DC    C' YM7595 '              LAST SHIP CODE           YM7595 01854002
         DC    C'02/08/74'              LAST DATE MODIFIED       YM7595 01856002
BEGIN    DS    0H                                                Y02072 01858002
         L     RDCB,0(0,RPARC)         DCB ADDRESS                      01860000
         L     RCORE,D4(RWTGC)          INIT O/C/E WORK AREA     S20201 01870020
         LA    RDCB,0(0,RDCB)           CLEAR BYTE ZERO                 01880000
**********************************************************************  01900000
*        TEST FOR MODES AND RECORD FORMATS NOT SUPPORTED FOR EXC BUFF   01920000
**********************************************************************  01940000
*                                                                       01960000
         TM    DCBOPTCD,USASCII         USASCII TAPE             S20038 01962020
         BZ    NEXTCHEK                 NO, BRANCH               S20038 01964020
         TM    DCBRECFM,FORMATD         D-FORMAT RECORDS         S20038 01966020
         BO    NOALLOW                  YES, GIVE SIMPLE BUFFER  S20038 01968020
         CLI   DCBBUFOF,ZERO            BLOCK PREFIX EQUAL ZERO  S20038 01970020
         BNE   NOALLOW                  NO, BRANCH - GIVE        S20038 01972020
*                                       SIMPLE BUFFERING.               01974020
NEXTCHEK EQU   *                                                 S20038 01976020
         TM    DCBMACRF+1,X'04'        TEST FOR SUBSTITUTE MODE         01980000
         BZ    MMODE                   BRANCH NOT SUBSTITUTE            02000000
*                                                                       02020000
         TM    DCBRECFM,X'C0'          TEST FOR  U RECORD               02040000
         BC    9,CONTINUE              BRANCH ON YES                    02060000
*                                                                       02080000
         TM    DCBRECFM,X'40'          TEST FOR  V RECORD               02100000
         BO    NOALLOW                 'V' NOT ALLOWED                  02120000
*                                                                       02140000
MMODE    EQU   *                                                        02160000
         TM    DCBMACRF+1,X'14'        TEST FOR MOVE OR SUBS MODE       02180000
         BM    CONTINUE                CONTINUE IF EITHER ONE           02200000
*                                                                       02220000
NOALLOW  EQU   *                                                        02240000
         NI    DCBCIND1,X'FE'          TURN OFF EXC BIT GOING TO SIMPL  02260000
         USING WTGENTRY,RWTGC                                    Y02072 02270002
         MVC   WTGID,SOP2               MOVE DISK ID TO WTG      Y02072 02272002
         TM    DCBDEVT,DISK            TEST FOR DISK                    02300000
         BO    RELOOP                                                   02320000
         MVC   WTGID,SOP5               TAPE ID TO WTG           Y02072 02330002
         DROP  RWTGC                                             Y02072 02340002
         B     RELOOP                                                   02360000
CONTINUE EQU   *                                                        02380000
         TM    DCBRECFM,X'50'           TEST FOR VB RECORD NOT ALLOWED  02400000
*                                       WITH MOVE MODE                  02420000
         BO    NOALLOW                  YES BRANCH                      02440000
         LA    RDEB,CCWOFF              LOAD CCW LENGTH CONSTANT S20201 02470020
         MVI   DCBCNTRL+3,X'01'        SET EOB IND FOR LOAD             02500000
*                                                                     * 02520000
*        DETERMINE BLOCKING FACTOR,BLOCKSIZE DIVIDED BY LRECL         * 02540000
*                                                                     * 02560000
         LH    RJ,DCBBLKSI             BLOCKSIZE IS ODD REG             02580000
         SR    RD,RD                   CLEAR REG                        02600000
         LH    RB,DCBLRECL             LOGICAL RECORD LENGTH            02620000
         DR    RD,RB                   GET BLOCK FACTOR IN RJ           02640000
         TM    DCBRECFM,X'90'          TEST FOR FB RECORD               02660000
         BO    E000                    BRANCH  YES                      02680000
         LA    RJ,1                    GET CONSTANT 1 FOR BLOCK FACTOR  02700000
E000     EQU   *                                                        02720000
         STH   RJ,DCBEROPT+4           PLACE BLOCKING FACTOR IN DCB     02740000
*                                                                     * 02760000
*                                                                     * 02780000
*        DETERMINE SEGMENT SIZE,BUFFERSIZE DIVIDED BY BLOCKING FACTOR * 02800000
*                                                                     * 02820000
*                                                                     * 02840000
         SR    RC,RC                   CLEAR REG                        02860000
         AH    RC,DCBBUFL              GET BUFFER LENGTH                02880000
         BC    6,F0000                 BRANCH THERE IS A BUFFER LENGTH  02900000
*                                                                       02920000
         STH   RB,DCBPRECL              USE LRECL AS SEG LENGTH         02940000
         B     F000A                                                    02960000
F0000    EQU   *                                                        02980000
         SR    RB,RB                   CLEAR REG                        03000000
         DR    RB,RJ                   GET SEGMENTED LENGTH             03020000
         STH   RC,DCBPRECL              PLACE SEG LENGTH IN DCB         03040000
F000A    EQU   *                                                        03060000
         TM    DCBBFALN,X'03'          IS ALIGNMENT SPECIFIED           03080000
         BZ    F0001                   NO-BRANCH                        03100000
         TM    DCBRECFM,X'90'          TEST FOR FB RECORD               03120000
         BC    14,F0001                BRANCH NOT FB NO ALIGNMENT       03140000
*                                                                       03160000
         NI    DCBPRECL+1,X'F8'        ROUND SEG LENGTH TO DBL WORDS    03180000
         CLC   DCBPRECL(2),DCBLRECL     COMPARE SEG LENGTH TO LRECL     03200000
         BL    NOALLOW                 SUPPLY SIMPLE BUFFERING          03220000
*                                                                     * 03240000
*        DETERMINE NO OF BUFFERS TIMES EIGHT AND HOLD IN REG          * 03260000
*                                                                     * 03280000
F0001    EQU   *                                                        03300000
         SR    RTIOT,RTIOT             CLEAR REG                        03320000
         IC    RTIOT,DCBBUFNO          GET NO. OF BUFFERS               03340000
         LR    RF,RTIOT                COPY BUFNO                       03360000
         MR    RE,RDEB                  MULTIPLY BY EIGHT        S20201 03380020
*                                                                       03400000
*        AT THIS POINT RJ=BLKF,RF=8N,RC=PRECL,RTIOT=BUFNO               03420000
*                                                                       03440000
         LR    RB,RJ                   COPY BLOCK F                     03460000
*                                                                       03480000
         TM    DCBDEVT,DISK            Q-DISK SUPPORTED                 03520000
         BO    E1B2                    YES-BRANCH                       03540000
*                                                                       03560000
         MVI   DCBCNTRL+3,X'02'        TAPE EOB ID FOR LOAD MODULE      03600000
*                                                                     * 03620000
         LA    RB,5(0,RB)              ADD 5 TO BF FOR TAPE             03640000
         B     E1B3                    BRANCH TO CALC AMT OF CORE       03660000
*                                                                       03680000
E1B2     EQU   *                                                        03700000
         LA    RB,10(0,RB)             ADD 10 TO BF FOR DISK            03720000
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O          S20201 03723020
*                                       DISCONNECT               S20201 03726020
         BO    E1B2A                    BRANCH IF YES            S20201 03729020
         LA    RB,D2(D0,RB)             INCREMENT FOR 2 CCWS     S20201 03732020
E1B2A    EQU   *                                                 S20201 03735020
         TM    DCBOPTCD,X'80'          Q- WRITE VALIDITY CHECK          03740000
         BZ    E1B3                    NO BRANCH                        03760000
*                                                                       03780000
         LA    RB,3(0,RB)              ADD 3 TO BF FOR WRITE CHECK      03800000
         TM    JFCBMASK+D6,NONCARN      ANY DEVICE W/O           S20201 03804020
*                                       DISCONNECT               S20201 03808020
         BO    E1B3                     BRANCH IF YES            S20201 03812020
         LA    RB,D1(D0,RB)             INCREMENT FOR 1 CCW      S20201 03816020
E1B3     EQU   *                                                        03820000
         LR    RC,RF                   BF + CONSTANTS TIMES 8N          03840000
         MR    RB,RB                   CALCULATE AMT OF CORE NEEDED     03860000
*                                      ANSWER IN REG C                  03880000
         LR    RB,RC                   COPY AMT USE WHEN CLEARING       03900000
*                                                                       03902020
* CHECK FOR DISCONNECT AND GET 1 DW IF FEATURE IS AVAILABLE        DMOR 03904020
*                                                                       03906020
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O          S20201 03908020
*                                       DISCONNECT               S20201 03910020
         BO    E1B3A                    BRANCH IF YES            S20201 03912020
         LA    RC,CCWOFF(D0,RC)         OTHERWISE INCREMENT      S20201 03914020
         LR    RB,RC                    COPY AMOUNT FOR CLEARING S20201 03916020
E1B3A    EQU   *                                                 S20201 03918020
*                                                                       03928002
*  THE FOLLOWING SAVES THE AMOUNT OF CORE GETMAINED FOR THE IOBS YM4697 03968002
*  IN THE FORCE CLOSE AUDIT TRAIL FOR THE FORCE CLOSE EXECUTOR.  YM4697 04018002
*                                                                       04028402
         ST    RC,DXATEXC2              SAVE LENGTH              YM4697 04028802
*                                                                       04029202
         MODESET  KEYADDR=DXUKEY,WORKREG=15  GET INTO USER KEY   Y02072 04030002
*                                                                       04040002
         GETMAIN R,LV=(RC),SP=0                                  Y02072 04060002
*                                                                     * 04080000
         MODESET  EXTKEY=DATAMGT       BACK TO DATA MANAG KEY    Y02072 04100002
*                                                                       04110002
*        THIS SECTION CLEARS CORE GOT,SETS IOBL SO CLOSE CAN REL CORE   04120000
*********************************************************************** 04140000
         ST    RF,DCBIOBA              ADDRESS OF FIRST IOB             04160000
         OI    FCAOPEN,FCAOIOB          INDIC IOB'S CAN BE FREED Y02072 04170002
*                                                                     * 04180000
         LR    RC,RF                   COPY ADDRESS FOR CLEARING        04200000
         LR    RJ,RB                   COPY AMOUNT                      04220000
*                                                                       04221020
* SET UP THETA ADDRESS IN CASE DISCONNECT FEATURE AVAILABLE        DMOR 04222020
*                                                                       04223020
         AR    RJ,RF                    GET LAST AREA ADDR       S20201 04224020
         SR    RJ,RDEB                  SUB ONE DW               S20201 04225020
         ST    RJ,DXCCW11               TEMP STORE SET THETA     S20201 04226020
*                                       ADDR                     S20201 04227020
         LR    RJ,RB                    RESTORE AMOUNT           S20201 04231020
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O          S20201 04232020
*                                       DISCONNECT               S20201 04233020
         BO    NOTDISCT                 BRANCH YES               S20201 04234020
         SR    RJ,RDEB                  DECREMENT ONE DW         S20201 04235020
NOTDISCT EQU   *                                                 S20201 04236020
         SR    RD,RD                   CLEAR REG                        04240000
         DR    RD,RTIOT                DIVIDE BY NO.OF BUFFERS          04260000
         SRL   RJ,3                    CONVERT TO DBL WORDS             04280000
         STC   RJ,DCBIOBL              STORE AMT FOR CLOSE              04300000
*                                                                     * 04320000
*        RB    HAS AMOUNT TO CLEAR                                    * 04340000
*                                                                     * 04360000
         BCTR  RB,0                    REDUCE AMOUNT BY ONE             04380000
         MODESET  KEYADDR=DXUKEY,WORKREG=15  GET INTO USER KEY   Y02072 04382002
         LA    RJ,255                  LOAD 255                         04400000
COMPARE  EQU   *                                                        04420000
         CR    RB,RJ                   Q-AMT TO CLEAR GREATER THAN 255  04440000
         BC    12,ONECLEAR             NO-BRANCH                        04460000
         EX    RJ,CLEAR                CLEAR 256 BYTES                  04480000
         SR    RB,RJ                   AMT TO CLEAR MINUS 255           04500000
         BCTR  RB,0                    SUBTRACT ONE MORE                04520000
         LA    RC,256(0,RC)            UPDATE AREA ADDRESS              04540000
*                                                                       04560000
         B     COMPARE                 TRY AGAIN                        04580000
*                                                                     * 04600000
CLEAR    EQU   *                                                        04620000
         XC    0(1,RC),0(RC)           CLEAR CORE                       04640000
*                                                                       04660000
ONECLEAR EQU   *                                                        04680000
         EX    RB,CLEAR                CLEARS LESS THAN 256             04700000
*                                                                       04720000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   04740000
*                                                                       04760000
*                                                                       04780000
*                                                                       04800000
*                                                                     * 04820000
*        AT THIS POINT RF IS ADDRESS OF CLEARED CORE                  * 04840000
*                                                                     * 04860000
         LR    RJ,RF                   REDUNDANT FOR 1 IOB BUT NEEDED   04880000
*                                                                       04900000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   04920000
*                                                                       04940000
*                                                                       04960000
*        CONSTRUCT COMMON IOB,ICB FIELDS HERE                           04980000
*                                                                       05000000
*        RF= RJ= FIRST IOB ADDRESS                                      05020000
*        OFFSET0                       LINK ADDRESS TO NEXT ICB,IOB     05040000
*        OFFSET4                       E C B                            05060000
*        OFFSET8                       IOS FLAGS                        05080000
*        OFFSET12                      ECB ADDRESS                      05100000
*        OFFSET 16                     CSW                              05120000
*        OFFSET24                      CHP START ADDRESS                05140000
*        OFFSET28                      DCB ADDRESS                      05160000
*                                                                       05180000
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   05200000
E1H3     EQU   *                                                      * 05220000
         LR    RF,RJ                   POSITION FOR NEXT IOB,ICB        05260000
         LA    RJ,4(0,RF)              ECB ADDRESS                      05280000
         ST    RJ,12(0,RF)             STORE IN IOB,ICB                 05300000
         MVI   0(RJ),X'7F'              INDICATE COMPLETE NO ERROR      05320000
         L     RWK2,DXUDCBAD            GET USERS DCB ADDR       Y02072 05330002
         USING IOBQSAMN,RF                                       Y02072 05340002
         ST    RWK2,IOBDCBPT            DCB ADDRESS TO IOB       Y02072 05350002
         DROP  RF                                                Y02072 05352002
         TM    DCBRECFM,X'10'           USING BLOCKED RECORDS           05360000
         BZ    E1H4                     NO-BRANCH                       05380000
*                                                                       05400000
         OI    8(RF),X'80'              TURN ON DC FLAG FOR IOS ERROR   05420000
*                                       RECOVERY ROUTINE                05440000
E1H4     EQU   *                                                        05460000
*                                                                       05480000
         L     RWK1,DCBBUFCB            ADDR OF BUFFER CNTRL BLK YM7595 05530002
         USING BCBLK,RWK1                                        YM7595 05540002
         L     RBUFADR,BCBBUFPT         NEXT AVAIL BUFFER        YM7595 05550002
         LTR   RBUFADR,RBUFADR          IS THERE A BUFFER ADDR   Y02072 05580002
         BZ    ABEND                    NO, ISSUE DMABCOND       Y02072 05590002
         USING BUFFER,RBUFADR                                    YM7595 05600002
         MVC   BCBBUFAD,BUFNXPTB        UPDATE BUF CNTRL BLK     YM7595 05610002
         DROP  RWK1,RBUFADR                                      YM7595 05612002
*                                                                       05620000
* RBUFADR CONTAINS BUFFER ADDRESS                                Y02072 05640002
*                                                                       05660000
         LA    RJ,32(RDEB,RF)          STARTAD FOR TAPE MB--R FOR DISK  05680000
         MVI   37(RF),X'01'            INC COUNT FOR LABELS             05700000
*                                                                     * 05720000
E1K4     EQU   *                                                        05740000
         ST    RJ,24(0,RF)             STORE STARTAD                    05760000
         TM    DCBDEVT,DISK             IS DEV TYPE DIR ACCESS   Y02072 05810002
         BO    E2F4                     YES, BR                  Y02072 05860002
         B     E2A21                    NO, BR                   Y02072 05870002
E2A2     EQU   *                                                        05880000
*                                                                     * 05900000
         LH    RE,DCBEROPT+D4           GET BLOCKING FACTOR      S20201 05910020
E2B4     EQU   *                                                        05920000
         USING CCW,RJ                                            Y02072 05930002
         ST    RBUFADR,CCWADDRA         ADDR TO CCW              Y02072 05932002
         MVI   0(RJ),X'01'             CMND BYTE FOR TAPE               05960000
*                                      NOT USED BY DISK CHP             05980000
         MVC   CCWBYTE,DCBLRECL         LOG REC LEN TO CHAN PGM  Y02072 06032002
         OI    CCWFLGS,CCWSLI           SILI BIT ON IN CHAN PGM  Y02072 06034002
         DROP  RJ                                                Y02072 06036002
         AH    RBUFADR,DCBPRECL         ADD SEG LEN TO ADDR      Y02072 06038002
         AR    RJ,RDEB                  ADD 8 TO POS CCW         S20201 06043020
         BCT   RE,E2B4                  MORE CCW'S TO BUILD      S20201 06046020
*                                                                       06049020
* CHECK FOR DISCONNECT FEATURE AND SET UP READ THETA CMND          DMOR 06052020
*                                                                       06055020
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O          S20201 06058020
*                                       DISCONNECT               S20201 06061020
         BO    E2B5                     BRANCH IF YES            S20201 06064020
         SR    RJ,RDEB                  DECREMENT CCW PTR        S20201 06067020
         OI    FLAGOFF(RJ),CC           SET COMMAND CHAIN FLAG   S20201 06070020
         AR    RJ,RDEB                  RESTORE CCW PTR          S20201 06073020
         L     RE,DXCCW11               RETRIEVE RD THETA ADDR   Y02072 06076002
         ST    RE,D0(D0,RJ)             PUT IN RD THETA ADDR     S20201 06079020
         MVI   CNTOFF(RJ),D1            SET BYTE COUNT TO ONE    S20201 06082020
         MVI   D0(RJ),RDSC              MOVE IN RD  SECTOR       S20201 06085020
*                                       COMMAND                  S20201 06088020
         AR    RJ,RDEB                  INCR POINTER             S20201 06091020
E2B5     EQU   *                                                 S20201 06094020
*                                                                     * 06100000
         TM    DCBDEVT,DISK            Q-DISK                           06120000
         BZ    E1H2                    BRANCH ON NO                     06140000
*                                                                       06160000
         TM    DCBOPTCD,X'80'          WRITE CHECK PRESENT              06180000
         BO    E2D3                    BRANCH ON YES                    06200000
*                                                                       06220000
*                                                                     * 06240000
E2E3     EQU   *                                                        06260000
E2F2     EQU   *                                                        06280000
*                                                                     * 06300000
         TM    DCBDEVT,DISK            Q-DISK                           06320000
         BZ    E1H2                    BRANCH NOT DISK                  06340000
*                                                                       06360000
         ST    RJ,0(0,RB)              WRT CKD ADDRESS TO PROPER CCW    06380000
         MVI   0(RB),X'1D'             PLACE CMND BYTE                  06400000
         AR    RJ,RDEB                  POS PTR TO NEXT ICB,IOB  S20201 06420020
*                                                                       06440000
E1H2     EQU   *                                                      * 06460000
         ST    RJ,0(0,RF)              STORE LINKAD IN IOB              06480000
         OI    0(RF),X'40'             TURN ON WRITE BIT FOR EOB RT     06500000
         BCT   RTIOT,E1H3              BRANCH IF MORE IOB,ICB TO MAKE   06520000
*                                                                     * 06540000
         L     RC,DCBIOBA              GET FIRST IOB ADDRESS            06560000
         MVC   1(3,RF),DCBIOBA+1       PLACE LAST LINKAD                06580000
         MVI   0(RC),X'41'              FIRST IOB AND WRITE BITS ON     06600000
         L     RB,24(0,RF)             GET STARTAD                      06620000
         LR    RD,RB                   COPY ADDRESS                     06640000
         SR    RB,RF                   GET WCPO                         06660000
         MODESET  EXTKEY=DATAMGT       BACK TO DATA MANAG KEY    Y02072 06662002
         STC   RB,DCBWCPO              STORE WRITE CHP OFFSET           06680000
         OI    FCAOPEN2,FCAOIOBC        IOBS COMPLETED           YM7595 06690002
         SR    RJ,RD                   GET WCPL                         06700000
         SR    RJ,RDEB                  CORRECT VALUE            S20201 06720020
         SRL   RJ,3                    DIVIDE BY EIGHT                  06740000
         STC   RJ,DCBWCPL              STORE WRITE CHP LENGTH           06760000
         XC    DCBPRECL(2),DCBPRECL     CLEAR COUNTER                   06780000
*                                                                     * 06800000
*                                                                       06820000
*                                                                       06840000
*                                                                       06860000
*                                                                       06880000
XCTL     EQU   *                                                        06900000
         USING WTGENTRY,RWTGC                                    Y02072 06910002
         MVC   WTGID,NXTEXEC            XCTL TO LOAD EXEC        Y02072 06912002
         DROP  RWTGC                                             Y02072 06914002
RELOOP   EQU   *                                                        06960000
         L     RCORE,4(0,RWTGC)        LOAD RCORE BASE                  06980000
         LA    RWTGC,8(0,RWTGC)             INCREMENT CURR WTG ENTRY    07000000
         LA    RPARC,4(0,RPARC)             INC CURRENT DCB ENTRY PTR   07020000
         CLC   0(2,RWTGC),AMIDCNST     Q- THIS RT NEEDED AGAIN          07040000
         BCR   8,RBASE                                                  07060000
*                                                                       07080000
         CLC   0(2,RWTGC),OPIDCNST     Q- END OF TABLE                  07100000
         BC    7,RELOOP                    NO-CHECK NEXT ENTRY          07120000
*                                                                       07140000
         LR    RPARC,RPAR                                               07160000
         LA    RWTGC,32(0,RWTG)             REINIT WTG LIST PTR         07180000
ZCHEK    EQU   *                                                        07200000
         CLI   0(RWTGC),X'00'               Q-IS THIS ENTRY COMPLETE    07220000
         BC    7,TCTLRTN                                                07240000
*                                                                       07260000
         LA    RWTGC,8(0,RWTGC)             GET NEXT ENTRY              07280000
         LA    RPARC,4(0,RPARC)                                         07300000
         B     ZCHEK                                                    07320000
*                                                                       07340000
TCTLRTN  EQU   *                                                        07360000
         MVC   6(2,RWTG),0(RWTGC)      STORE ID IN WTG TABLE            07380000
         LA    RJ,DXXCTL                SET UP FOR XCTL          S21042 07420021
         XC    DXXCTL,DXXCTL            CLEAR PARM LIST, NO DCB  Y02072 07430002
*                                         FOR LPALIB             Y02072 07432002
*                                                                       07440000
         XCTL  EPLOC=(RWTG),SF=(E,(15))                          Y02072 07460002
*                                                                       07480000
*                                                                       07500000
*                                                                       07520000
*                                                                       07540000
*                                                                       07560000
*                                                                       07580000
E2F4     EQU   *                                                        07600000
         MVC   0(8,RJ),DCBFDAD         MOVE MBBCCHHR FROM DCB TO IOB    07620000
         LA    RB,3(0,RJ)              ADDRESS FOR SRCH CCW             07640000
         AR    RJ,RDEB                  ADD 8 TO POSITION CCW    S20201 07660020
         ST    RJ,24(0,RF)             STORE STARTAD                    07680000
*                                                                       07700000
*                                      TO CONSTRUCT WRT(CKD) CCW        07720000
*                                                                     * 07740000
*        MAKE SRCH TIC      CCWS HERE                                 * 07760000
*                                                                     * 07780000
*                                                                       07781020
* IF DISCONNECT FEATURE ON ALL DEVICES, SET SECT USED IN CHP       DMOR 07782020
*                                                                       07783020
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O          S20201 07784020
*                                       DISCONNECT               S20201 07785020
         BO    E2J3                     BRANCH IF YES            S20201 07786020
         L     RE,DXCCW11               RETRIEVE SET THETA ADDR  S20201 07787020
         ST    RE,D0(D0,RJ)             PUT ADDR IN CCW          S20201 07788020
         OI    FLAGOFF(RJ),CC           SET CMND CHAIN BIT       S20201 07789020
         MVI   CNTOFF(RJ),D1            SET BYTE CNT TO ONE      S20201 07790020
         MVI   D0(RJ),SETSC             SET SECTOR CMND          S20201 07791020
         AR    RJ,RDEB                  INCREMENT CCW PTR        S20201 07792020
E2J3     EQU   *                                                 S20201 07793020
         ST    RB,0(0,RJ)              STORE SEARCH ADDRESS             07800000
         MVI   0(RJ),X'31'             PLACE SEARCH CMND BYTE           07820000
         MVI   4(RJ),X'40'             TURN ON CC FLAG                  07840000
         MVI   7(RJ),X'05'             SET COUNT OF 5                   07860000
*                                                                     * 07880000
*        SEARCH CCW COMPLETED                                         * 07900000
*                                                                     * 07920000
         ST    RJ,8(0,RJ)              STORE TIC ADDRESS                07940000
         MVI   8(RJ),X'08'             PLACE TIC CMND BYTE              07960000
*                                                                     * 07980000
*        TIC   CCW COMPLETED                                          * 08000000
*                                                                     * 08020000
         LA    RJ,16(0,RJ)             POSITION POINTER AT WR CKD CCW   08040000
E2J4     EQU   *                                                        08060000
*                   CONSTRUCT RIGHT HALF OF WRT CKD CCW HERE          * 08080000
*                   CMND BYTE & ADDRESS OF CCHHRKDLDL COMES LAST      * 08100000
*                                      AT E2G2 ADDRESS                * 08120000
         LR    RB,RJ                   COPY WRT(CKD) ADDRESS            08140000
         MVI   7(RJ),X'08'             PLACE COUNT OF EIGHT             08160000
         MVI   4(RJ),X'A0'             SET DC AND SIL FLAG ON           08180000
E1J4     EQU   *                                                        08200000
         AR    RJ,RDEB                  POSITION FOR WRITE CCW   S20201 08220020
*                                                                     * 08240000
*        NO DC FLAGS NEEDED ACCESS METHOD SETS FLAGS                  * 08260000
E2A21    EQU   *                                                      * 08280000
         SR    RJ,RF                   DERIVE OFFSW                     08300000
         MODESET  EXTKEY=DATAMGT       BACK TO DATA MANAG KEY    Y02072 08302002
         STC   RJ,DCBOFFSW             STORE OFFSET IN DCB              08320000
         MODESET  KEYADDR=DXUKEY,WORKREG=14  GET INTO USER KEY   Y02072 08322002
         AR    RJ,RF                   RESTORE CCW ADDRESS              08340000
         B     E2A2                                                     08360000
*                                                                     * 08380000
*                                                                     * 08400000
*                                                                     * 08420000
E2D3     EQU   *                                                        08440000
*********************************************************************** 08460000
*        MAKE  CHP FOR CHECKING WRITE HERE                            * 08480000
*********************************************************************** 08500000
*                                                                     * 08520000
         SR    RJ,RDEB                  BACKUP POINTER           S20201 08540020
         MVI   4(RJ),X'40'             TURN ON  CC  FLAG IN LAST CCW    08560000
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O          S20201 08561020
*                                       DISCONNECT               S20201 08562020
         BO    E2D3A                    BRANCH IF YES            S20201 08563020
*                                                                       08564020
* IF DISCONNECT FEATURE ON ALL DEVICES USE SET SECT COMMAND        DMOR 08565020
*                                                                       08566020
         MVC   D8(CCWOFF,RJ),D0(RJ)     MOVE READ SECTOR ONE CCW S20201 08567020
         AR    RJ,RDEB                  RESTORE CCW PTR          S20201 08568020
         MVI   D0(RJ),SETSC             CHANGE CMND TO SET       S20201 08569020
*                                       SECTOR                   S20201 08570020
E2D3A    EQU   *                                                 S20201 08571020
         AR    RJ,RDEB                  POSITION AT SRCH CCW     S20201 08581020
         MVI   7(RJ),X'05'             LENGTH FOR SRCH CCW              08600000
         MVI   4(RJ),X'40'             TURN ON CC FLAG                  08620000
*                                                                     * 08640000
*        ADDRESS OF  CCHHRKDLDL & CMND BYTE DONE LATER                * 08660000
*                                                                     * 08680000
         ST    RJ,8(0,RJ)              TIC ADDRESS                      08700000
         MVI   8(RJ),X'08'             PLACE TIC OP                     08720000
         MVC   22(2,RJ),DCBBUFL        MOVE BUFFER SIZE TO READ CCW     08740000
         MVI   20(RJ),X'10'            MOVE SKIP FLAG TO CCW            08760000
         MVI   16(RJ),X'86'            MOVE RD(D) CMND BYTE TO CCW      08780000
*                                                                     * 08800000
E2E51    EQU   *                                                        08820000
*                                                                       08840000
         LA    RD,24(0,RJ)             ADDR OF CCHHRKDD FOR SRCH        08860000
E2E5     EQU   *                                                        08880000
         ST    RD,0(0,RJ)              STORE IN SRCH CCW                08900000
         MVI   0(RJ),X'31'             PLACE SEARCH CMND BYTE           08920000
         LA    RJ,24(0,RJ)             ADDRESS CCHHRKLDLDL              08940000
         B     E2E3                                                     08960000
*                                                                       08980000
*                                                                       09000000
ABEND    EQU   *                                                        09020000
         MODESET  EXTKEY=DATAMGT       BACK TO DATA MANAG KEY    Y02072 09022002
         DMABCOND OABD063,PDLOAD,RETURN=NONE,RES=NO,REGSAVE=YES  S21042X09040021
                                        CALL PROBLEM DETERMINATION      09060021
         B     TCTLRTN                                           S21042 09080021
AMIDCNST DC    C'1F'                    THIS ID                         09100002
OPIDCNST DC    C'0S'                    END ID                          09120002
SOP2     DC    C'1D'                    ABNORMAL, DA WHEN EXCH   Y02072 09130002
*                                         BUFFERING UNSUPPORT    Y02072 09132002
SOP5     DC    C'1G'                    ABNORMAL, NON-DA WHEN EX Y02072 09134002
*                                         BUFFERING UNSUPPORT    Y02072 09136002
NXTEXEC  DC    C'14'                    3RD STAGE EXEC TO LOAD   Y02072 09138002
*                                         ACCESS METHOD RTNS     Y02072 09138402
PDLOAD   DC    C'6M'                    PROBLEM DETERMINATION    Y02072 09138802
         SPACE                                                          09139202
PATCH    DC    0H'0',50X'00'            PATCH AREA               Y02072 09184402
END      EQU   *                        END OF MODULE            Y02072 09274802
         IECDSECS (MAIN,(IOB,NO)),IOB,DCB,WTG,EXPAND=YES         Y02072 09320002
         ORG   WTGIDTTR                                          Y02072 09330002
WTGID    DS    CL2                      NEXT MOD ID              Y02072 09340002
         EJECT                                                          09350002
FORCORE  DSECT                                                   Y02072 09360002
         IHAFCAUD  ORG=YES                                       Y02072 09362002
         EJECT                                                          09364002
         IGGBCB  TYPE=SAM                                        Y02072 09370002
         EJECT                                                          09370402
         IHACCW  DSECT=YES                                       Y02072 09372002
         END                                                            09380000
