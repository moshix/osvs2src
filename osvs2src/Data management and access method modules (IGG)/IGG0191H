         TITLE 'IGG0191H, LEVEL 2 EXEC FOR D.A. WITH TRK OVFLOW.'       00032002
         MACRO                                                          00034002
&NAME    IF    &A,&IS=,&ISNOT=,&GOTO=                                   00040000
         LCLB  &NOERR                                                   00060000
&NOERR   SETB  1                                                        00080000
         AIF   ('&A' NE '').SKIP                                        00100000
         MNOTE 'TEST  ADDRESS NOT SPECIFIED.'                           00120000
&NOERR   SETB  0                                                        00140000
.SKIP    AIF   ('&GOTO' NE '').SKIP2                                    00160000
         MNOTE 'BRANCH ADDRESS MISSING.'                                00180000
&NOERR   SETB  0                                                        00200000
.SKIP2   AIF   ('&IS' NE '' OR '&ISNOT' NE '').SKIP3                    00220000
         MNOTE 'TEST CONDITION NOT SPECIFIED.'                          00240000
&NOERR   SETB  0                                                        00260000
.SKIP3   AIF   (&NOERR).SKIP4                                           00280000
         MEXIT                                                          00300000
.SKIP4   AIF   ('&IS' EQ '').NOIS                                       00320000
***                                                                     00340000
&NAME    TM    &A,&IS                                                   00360000
         BO    &GOTO                                                    00380000
***                                                                     00400000
         MEXIT                                                          00420000
.NOIS    ANOP                                                           00440002
***                                                                     00460000
&NAME    TM    &A,&ISNOT                                                00480000
         BZ    &GOTO                                                    00500000
***                                                                     00520000
         MEND                                                           00540000
IGG0191H CSECT                                                          00560000
*                                                                       00580000
*                                                                       00610002
*MODULE NAME - IGG0191H                                          Y02072 00612002
*                                                                       00614002
*DESCRIPTIVE NAME - BUILD IOBS                                   Y02072 00616002
*                                                                       00618002
*COPYRIGHT - NONE                                                Y02072 00618402
*                                                                       00618802
*CHANGE ACTIVITY - AS FOLLOWS:                                   Y02072 00619202
*                                                                       00619602
*          VS2 RELEASE 2 DELETIONS                               Y02072 00620402
*005500,044300,044420,044600-044720,060090-060120,062800,        Y02072 00620802
*075720,110370,126040,120200,120350,124400-124800,125400         Y02072 00620902
*100400,110340-110350,106000                                     YM1086 00622902
*                                                                YM2424 00624902
*                                                                YM4640 00625002
*                                                                YM7595 00627002
*                                                                       00627403
*          VS2 RELEASE 3 DELETIONS                                      00627803
*                                                              @Z30TSCF 00628203
*          RELEASE 20 DELETIONS                                       * 00629000
*0973020200-020800,043000,044600,045000-059800,063000,064200,    S20201 00629120
*0973067800-068000,068200,069200,070400,075800,076800,077800,    S20201 00629220
*0973079600,089200,092400,093400,097200,099200,100600,102200-    S20201 00629320
*0973102400,110400,111000,111400-111600,119600,125600-125800,    S20201 00629420
*0973126000-126200,129400,134800-135200,138000-138400,145600-    S20201 00629520
*0973145800                                                      S20201 00629620
*          RELEASE 21 DELETIONS                                       * 00630000
*0091042300,043000,075700,110360,120000,125000,127600-127700,    S21042 00630321
*0091132900,157400                                               S21042 00630621
*                                                                       00631002
*STATUS CHANGE LEVEL 007                                                00636001
*                                                                       00640000
*                                                                       00660000
* THIS EXECUTOR RUNS IN TANDEM WITH IGG0191S, WHICH COMPLETES DCB       00680000
* FIELDS THAT ARE KNOWN PRIOR TO GETTING CORE FOR THE IOB/CP'S.         00700000
*                                                                       00720000
* THE MAJOR FUNCTIONS OF THIS EXEC ARE-                                 00740000
*                                                                       00760000
* 1. STRUCTURE EACH IOB/CP WITH THE ADDRESSES AND FLAGS THAT ARE        00820002
*    KNOWN AT OPEN TIME.                                                00840000
* 2. COMPLETE THE RELATED DCB FIELDS.                                   00860002
* 3. REPEAT FOR EACH DCB BEING OPENED.                                  00880002
*                                                                       00900000
* ENTRY POINTS- FROM IGG0191S BY XCTL.                                  00920000
* EXITS- TO IGG01913 BY XCTL.                                           00940000
*                                                                       00960000
*                                                                       00980000
*INPUT-REGISTERS WITH THE ADDRESSES OF THE FOLLOWING-                   01000000
*   THE PARAMETER LIST  (POINTERS TO TOP AND CURRENT ENTRY).            01020000
*   THE WHERE-TO-GO TABLE (WTG) (POINTERS TO TOP AND CURRENT).          01040000
* EXTERNAL ROUTINES- NONE.                                              01060000
* ATTRIBUTES- REENTRANT, REUSABLE, RUNS IN USER KEY UNLESS       Y02072 01080002
*             OTHERWISE SPECIFIED, SUPER STATE                   Y02072 01090002
* TABLES/WORKAREAS-                                                     01100000
*                                                                       01110002
*MACROS : ACTION - MODESET, XCTL, XCTLTABL                       Y02072 01112002
*                                                                       01114002
*MACROS : MAPPING - IHACCW, IGGBCB, IECDSECS(DCB,WTG), IHAFCAUD         01116002
*                                                                       01120000
*TABLES/WORKAREAS- WHERE TO GO TABLE (WTG)                              01140000
*      BYTE  0-7  NAME                                                  01160000
*      BYTE  8-10 RELATIVE DISK ADDRESS(TTR) OF FIRST RECORD            01180000
*      BYTE 11    CONCATENATION NUMBER                                  01200000
*      BYTE 12    ZERO                                                  01220000
*      BYTE 13    ALIAS INDICATOR AND USER DATA FIELD DESCRIPTOR.       01240000
*                        ALIAS INDICATOR 1 BIT                          01260000
*                        NUMBER OF TTRS IN USERS DATA FIELD 2 BITS      01280000
*      BYTE 14-16 TTR OF FIRST TEXT RECORD                              01300000
*      BYTE 17    ZERO                                                  01320000
*      BYTE 18-19 TTR OF NOTE LIST OR SCATTER LIST                      01340000
*      BYTE 20    TRANSLATION TABLE                                     01360000
*      BYTE 21    ZERO OR NUMBER OF ENTRIES IN THE NOTE LIST            01380000
*      BYTE 22-23 ATTRIBUTES                                            01400000
*      BYTE 24-26 TOTAL CONTIGUOUS MAIN STORAGE REQUIRED FOR MODULE     01420000
*      BYTE 27-28 LENGTH OF FIRST TEXT RECORD                           01440000
*      BYTE 29    LENGTH OF WTG TABLE (IN DOUBLE WORDS)                 01460000
*      BYTE 30-31 PATH THROUGH LOADS OF ROUTINES                        01480000
*      BYTE 32-34 IDTTR OF EXECUTOR FOR FIRST DCB                       01500000
*      BYTE 35    WORKAREA ADDRESS FOR FIRST DCB                        01520000
*      BYTE 36-39 TABLE OF IDTTR'S                                      01540000
*      BYTE 32+N(8) IDTTR OF EXECUTOR FOR  N TH DCB  (3 BYTES)          01560000
*                   WORKAREA ADDRESS FOR N TH DCB    (1 BYTE )          01580000
*                   IDTTR OF LAST ROUTINE LOAD       (3 BYTES)          01600000
*                   NOT USED                         (1 BYTE)           01620000
*                                                                       01640000
*    WORKAREA- SEE 'FORCORE DSECT' (IECDSECT) IN THIS LISTING           01660000
*                                                                       01680000
*TABLES/WORKAREAS- PARAMETER LIST                                       01700000
*                                                                       01720000
*WORD ZERO                                                              01740000
*      BYTE  0    OPEN ATTRIBUTE  (INPUT, OUTPUT, UPDATE, IN/OUT,       01760000
*                                  OUT/IN, READ BACKWD, LEAVE , REREAD) 01780000
*      BYTES 1-3  DCB ADDRESS FOR FIRST DCB BEING OPENED.               01800000
*                                                                       01820000
*THE PARAMETER LIST HAS A ONE WORD ENTRY FOR EACH DCB BEING OPENED. THE 01840000
*FORMAT IS THE SAME AS WORD ZERO.                                       01860000
*END PARAMETER LIST.                                                    01880000
*                                                                       01900000
* REGISTER CONVENTIONS USED IN ALL OF OPEN-                             01920000
*                                                                       01940000
RDCB     EQU   2                        DCB REGISTER                    01960000
RBASE    EQU   3                        BASE REGISTER                   01980000
RCORE    EQU   4                        I/O SUPPORT WORK AREA           02000000
RPAR     EQU   5                        TOP OF PARAMETER LIST           02100000
RBUFADR  EQU   RPAR                     MAINTAINS ADDR OF NEXT   Y02072 02110002
*                                         AVAILABLE BUFFER       Y02072 02112002
RWTG     EQU   6                        TOP OF WTG TABLE                02120000
RPARC    EQU   7                        CURRENT PARAMETER               02140000
RWTGC    EQU   8                        CURRENT LOAD IN TRANSIENT AREA  02160000
RTIOT    EQU   9                        USED AS A WORK REG              02180000
RIOB     EQU   RTIOT                    USED AS IOB BASE REG WITH THE   02200000
*                                       IOB OVERLAY FROM FORECORE.      02220000
RUCB     EQU   10                       USED AS A WORK REG              02240000
RCPSIZE  EQU   RUCB                     USED TO CALCULATE AND HOLD THE  02260000
*                                       CHANNEL PGM SIZE.               02280000
RDEB     EQU   11                       DEB BASE REG.                   02300000
RB       EQU   12                       WORK REG.                       02320000
RCPBASE  EQU   RB                       CHANNEL PGM BASE REG USED WITH  02340000
*                                       'CPSEGMAP' DUMMY SECTION.       02360000
RC       EQU   13                       WORK REG.                       02380000
RSTEPPER EQU   RC                       POINTS TO THE CURRENT SEARCH    02400000
*                                       ADDRESS OR COUNT FIELD BEING    02420000
*                                       USED FOR CP CONSTRUCTION. WHEN  02440000
*                                       POINTING TO A COUNT FLD THE     02460000
*                                       'COUNTFLD' DUMMY SECTION IS     02480000
*                                       USED BASED ON THIS REG.         02500000
*                                                                       02520000
RE       EQU   0                        WORK REG. VOLATILE ACCROSS SVC. 02540000
RF       EQU   1                        WORK REG. VOLATILE ACCROSS SVC. 02560000
RD       EQU   14                       WORK REG. VOLATILE ACCROSS SVC. 02580000
RWK1     EQU   RD                       WORK REGISTER            Y02072 02590002
RJ       EQU   15                       WORK REG. VOLATILE ACCROSS SVC. 02600000
RA       EQU   RJ                       USED AS WORK REG         S20201 02605020
RVALCHK  EQU   RA                       VALIDITY CHK CP BASEREG, S20201 02610020
*                                       USES 'VCMAP' DSECT.             02615020
*                                                                       02620000
*                                                                       02640000
* MASK CONFIGURATIONS FOR TESTING THE HI ORDER BYTE OF EACH PARAMETER   02660000
* LIST ENTRY. SIGNIFICANCE IS THE SAME AS THE DEB OPEN ATTRIBUTE FIELD. 02680000
*                                                                       02700000
INPUT    EQU   X'0F'                    TEST MASKED BITS FOR ZEROS.     02720000
OUTPUT   EQU   X'0F'                    TEST MASKED BITS FOR ONES.      02740000
INOUT    EQU   X'03'                                                    02760000
OUTIN    EQU   X'07'                                                    02780000
RDBACK   EQU   X'01'                                                    02800000
UPDAT    EQU   X'04'                                                    02820000
LEAVE    EQU   X'10'                                                    02840000
REREAD   EQU   X'30'                                                    02860000
*                                                                       02880000
* COMMAND CODES FOR THE 2841 CONTROL UNIT.                              02900000
*                                                                       02920000
SRCHEQ   EQU   X'31'                    SEARCH EQUAL ID.                02940000
SRCHEQMT EQU   X'B1'                    SEARCH EQUAL ID IN MULTI-TRACK. 02960000
TIC      EQU   X'08'                    TRANSFER IN CHANNEL.            02980000
WCKD     EQU   X'1D'                    WRITE COUNT, KEY, AND DATA.     03000000
WSCKD    EQU   X'01'                    WRITE SPECIAL, COUNT,KEY,DATA.  03020000
SEEKCYL  EQU   X'0B'                    SEEK CYLINDER.                  03040000
READDATA EQU   X'06'                    READ DATA SINGLE TRACK.         03060000
RDDATAMT EQU   86                       MULTI-TRACK READ DATA.          03080000
READKD   EQU   14                       READ KEY AND DATA.              03100000
READCT   EQU   X'92'                    READ COUNT M/T MODE.            03120000
RDSC     EQU   X'22'                    SET THETA CCW COMMAND    S20201 03126020
SETSC    EQU   X'23'                    READ THETA CCW COMMAND   S20201 03132020
*                                                                       03140000
* CHANNEL COMMAND WORD FLAGS.                                           03160000
*                                                                       03180000
SKIP     EQU   X'10'                    SKIP FLAG.                      03200000
SILI     EQU   X'20'                    SUPPRESS INCORRECT LENGTH IND.  03220000
CC       EQU   X'40'                    COMMAND CHAIN.                  03240000
DC       EQU   X'80'                    DATA CHAIN.                     03260000
SILICC   EQU   X'60'                    SILI AND CC TOGETHER            03280000
SILICCSK EQU   X'70'                    SILI, CC, AND SKIP.             03300000
* END CCW FLAGS.                                                        03320000
*                                                                       03340000
* DISPLACEMENTS  AS EQUATES                                             03341020
*                                                                       03342020
D0       EQU   0                        DISPLACEMENT OF ZERO     S20201 03343020
D1       EQU   1                        DISPLACEMENT OF ONE      S20201 03344020
D2       EQU   2                        DISPLACEMENT OF TWO      S20201 03345020
D4       EQU   4                        DISPLACEMENT OF FOUR     S20201 03346020
D6       EQU   6                        DISPLACEMENT OF SIX      S20201 03347020
D8       EQU   8                        DISPLACEMENT OF EIGHT    S20201 03348020
D12      EQU   12                       DISPLACEMENT OF TWELVE   S20201 03349020
D15      EQU   15                       DISPLACEMENT OF FIFTEEN  S20201 03350020
CNTOFF   EQU   7                        CCW COUNT FIELD OFFSET   S20201 03351020
SXTN     EQU   16                       ADDITIONAL CHP LENGTH    S20201 03352020
*                                       FOR                      S20201 03353020
*                                       RECORD READY FEATURE            03354020
*                                                                       03360000
* MISCELLANEOUS ITEMS.                                                  03380000
*                                                                       03400000
COMPNOER EQU   X'7F'                   USED TO INIT. ECB.               03420000
DCANDCC  EQU   X'C0'                    USED TO SET IOBFLAG1.           03440000
IDLENGTH EQU   X'05'                    NMBR OF BYTES IN A 'CCHHR'.     03460000
POINT    EQU   X'04'                    DCBMACRF IF NOTE/POINT USED.    03480000
QSAM     EQU   X'01'                    QSAM BIT IN DCBIND2.            03500000
*                                                                       03520000
NPD2     EQU   5                        NOTE/POINT FOR PCI,UPD,T.O.     03540000
EPDT     EQU   9                        EOB FOR T.O.                    03560000
EGP2     EQU   8                        EOB FOR D.A. INPUT.             03580000
*                                                                       03600000
*                                                                       03620000
VALCHK   EQU   X'80'                    MASK TO DETERMINE IF WRITE      03640000
*                                       VALIDITY CHECK OPTION CALLED.   03660000
IOBSIZE  EQU   48                       LENGTH OF A STANDARD IOB WITH   03680000
*                                       BSAM/QSAM/BPAM EXTENSION.       03700000
IOBDBLWD EQU   6                        NMBR OF DBL WDS IN IOB.         03720000
OFFSW    EQU   24                       OFFSET OF CCW THAT WRITES DATA. 03740000
OFFSR    EQU   32                       OFFSET OF THE READ CCW THAT     03760000
*                                       RECEIVES THE BLOCK LENGTH TO    03780000
*                                       BE READ.                        03800000
CPSEGLEN EQU   32                       LENGTH OF ONE CP SEGMENT.       03820000
NOTZERO  EQU   7                        CONDITION MASK USED AFTER       03840000
*                                       ARITHMETIC INSTRUCTIONS FOR THE 03860000
*                                       NOT-ZERO TEST.                  03880000
BBCCHH   EQU   6                        MIN. SEEK LENGTH.               03900000
*                                                                       03920000
ZERO     EQU   X'00'                    AN IMMEDIATE BYTE OF ZERO'S.    03940000
B1       EQU   1                        BYTE COUNT OF ONE        S20201 03941020
TWO      EQU   2                        CONST OF TWO             S20201 03942020
B5       EQU   5                        BYTE COUNT OF FIVE       S20201 03943020
*                                                                       03944020
NORCDRY  EQU   X'20'                    NO RECORD READY MASK     S20201 03945020
RCDRYSL  EQU   48                       SEG LENGTH WHEN USING    S20201 03946020
*                                       RCD                      S20201 03947020
*                                       READY FEATURE                   03948020
*                                                                       03949020
*                                                                       03950020
*                                                                       03951020
VRCDS    EQU   X'40'                    V TYPE RCD MSK           S20201 03952020
*                                                                       03953020
*                                                                       03954020
EIGHT    EQU   8                        LENGTH OF A COUNT FIELD.        03960000
ANYZERO  EQU   14                       MASK FOR MIXED OR ZEROS.        03980000
FIRST    EQU   X'01'                    USED TO SET IOB FLAG IN FIRST   04000000
*                                       IOB AND INIT. 'R'.              04020000
READCPL  EQU   40                       NMBR OF BYTES IN READ CP.       04040000
RCPDBLWD EQU   5                        NMBR OF DBL WDS IN RCP.         04060000
REMNANT  EQU   READCPL-OFFSR            OFFSR+REMNANT=READCPL.          04080000
OPCODE   EQU   0                        OFFSET OF CCW OPCODE(IN CCW).   04100000
ADDRESS  EQU   0                        OFFSET OF ADDRESS IN CCW        04120000
*                                       (IMPLIES THAT THE ADDRESS MUST  04140000
*                                       BE PUT IN BEFORE THE OP CODE)   04160000
FLAGS    EQU   4                        CCW FLAG BYTE.                  04180000
LENFLD   EQU   6                        START OF LENGTH FLD IN CCW.     04200000
U        EQU   X'C0'                    CODE FOR DCBRECFM=U             04220000
OABD062  EQU   62                                                S21042 04230021
*                                                                       04240000
         BALR  RBASE,0                  ESTABLISH ADDRESSABILITY.       04260000
         USING SOP6,RBASE                                               04280000
         USING FORCORE,RCORE            OPEN COMMON WKAREA       S21042 04300021
         USING IHADCB,RDCB              DCB ADDRESSABILITY.             04320000
*                                                                       04340000
*                                                                       04360000
SOP6     EQU   *                                                        04380000
         B     BEGIN                    BRANCH AROUND MODULE ID  YM4640 04380102
         DC    C'IGG0191H'              MODULE NAME              YM4640 04380202
         DC    C'@Z30TSCF'              LAST SHIP CODE         @Z30TSCF 04380303
         DC    C'10/17/74'              LAST SHIP DATE         @Z30TSCF 04380403
BEGIN    DS    0H                       END OF MODULE ID         YM4640 04380502
*                                                                       04400000
         L     RDCB,0(RPARC)            GET DCB ADDRESS FROM PARM. LIST 04420000
         L     RDEB,DCBDEBAD            DEB ADDRESSABILITY.             04440000
         L     RCORE,D4(RWTGC)          GET WORK AREA ADDR       S20201 04450020
         ST    RPAR,DXREGSAV            SAVE REG SO IT CAN BE    Y02072 04460002
*                                         USED AS RBUFADR        Y02072 04470002
         LA    RDCB,0(RDCB)             HOUSEKEEP HI BYTE.              04480000
         SR    RUCB,RUCB                CLEAR REG                S20201 04680020
         IC    RUCB,DCBNCP              GET NO. OF IOBS REQUIRED S20201 04880020
         IF    DCBCIND2,ISNOT=QSAM,GOTO=SOP6L12                  S20201 05080020
         IC    RUCB,DCBBUFNO            IF QSAM USE BUFNO        S20201 05280020
SOP6L12  EQU   *                                                 S20201 05480020
         L     RIOB,DCBIOBA             GET FIRST IOB ADDRESS.          06000000
         MODESET  KEYADDR=DXUKEY,WORKREG=14 GET INTO USER KEY    Y02072 06008002
         USING SAMSIOB,RIOB            IOB ADDRESSABILITY READY.        06020000
         MVI   FLAG,FIRST               FLAG FIRST IOB             DM0I 06030000
*                                                                       06040000
BUILDIOB EQU   *                                                        06060000
*                                                                       06080000
* RIOB POINTS TO START OF AN IOB. USING THIS AS A BASE, GET THE CP      06100000
* START ADDRESS AND THE ADDRESS OF THE COUNT FIELDS AND S.A.'S.         06120000
*                                                                       06140000
*                                                                       06160000
         MVI   ECB,COMPNOER            INIT. ECB FOR QSAM.              06180000
         LA    RF,ECB                   INITIALIZE THE                  06200000
         ST    RF,IOBECBPT              ECB POINTER.                    06220000
*                                                                       06240000
         OI    IOBFLAG1,DCANDCC         INDICATE COMMAND AND DATA CHAIN 06260000
         DROP  RIOB                                              Y02072 06262002
         L     RWK1,DXUDCBAD            GET USERS DCB ADDR       Y02072 06270002
         USING SAMSIOB,RIOB                                      Y02072 06272002
         ST    RWK1,IOBDCBPT-1          INIT DCB PT IN IOB.      Y02072 06280002
         MVC   IOBSEEK(8),DCBFDAD       INIT. ALL IOB FDAD'S. SUPPORTS  06286013
*                                       EVERYBODY INCLUDING 2321.       06292013
         LA    RCPBASE,CHANPGM          GET CHP ADDR             S20201 06296020
         ST    RCPBASE,IOBSTART-D1      PUT IN IOB               S20201 06300020
*                                                                       06304020
* TEST FOR INPUT ONLY                                                   06308020
*                                                                       06312020
         USING DEB,RDEB                 DEB ADDRESSABILITY       S20201 06316020
         IF    DEBOPATB,ISNOT=OUTPUT,GOTO=RCPREQD                       06320000
         DROP  RDEB                                              S20201 06330020
BUILDWCP EQU   *                                                        06340000
         SR    RCPBASE,RCPBASE         NEEDED ON 2ND PASS.              06360000
         IC    RCPBASE,DCBWCPO          NEED OFFSET TO BUILD            06380000
         AR    RCPBASE,RIOB             WRITE CP BASE ADDRESS.          06400000
         USING WCPMAP,RCPBASE                                           06440000
         SR    RSTEPPER,RSTEPPER       NEEDED ON 2ND PASS.              06460000
         IC    RSTEPPER,DCBWCPL         BUILD ADDRESS OF COUNT FIELDS   06480000
         SLL   RSTEPPER,3               APPENDED TO WCP.                06500000
         AR    RSTEPPER,RCPBASE         ADDRESS OF FIRST COUNT FIELD.   06520000
         USING COUNTFLD,RSTEPPER                                        06540000
*                                                                       06560000
*   RIOB = IOB ADDRESS.                                                 06580000
*   RCPBASE = CHANNEL PROGRAM ADDRESS.                                  06600000
*   RSTEPPER = COUNT FIELD AND S.A. ADDRESS.                            06620000
*                                                                       06640000
* IOB INITIALIZED EXCEPT FOR LINK FIELD.                                06660000
*                                                                       06680000
* BUILD WRITE CHANNEL PROGRAMS.  THE CORRECT NUMBER OF CP SEGMENTS IS   06700000
* THAT WHICH CAN BE BUILT UP TO THE FIRST COUNT FIELD APPENDED TO THIS  06720000
* IOB.                                                                  06740000
*                                                                       06760000
*                                                                       06770020
* CHECK FOR RCD READY FEATURE AND SET UP SET THETA COMMAND IF           06780020
* THE FEATURE IS ON ALL THE DATA SETS DEVICES                           06790020
*                                                                       06800020
*                                                                       06805020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 06810020
*                                       READY                    S20201 06815020
         BO    NOFET3                   BRANCH IF YES            S20201 06820020
         BAL   RD,SOP6STA               GO BUILD SET SECTOR CCW  S20201 06825020
         AH    RCPBASE,DBLWDLEN         INCR BASE FOR SET SECTOR S20201 06830020
NOFET3   EQU   *                                                 S20201 06835020
CCW1     EQU   *                                                        06840000
         LA    RD,IOBSEEK+3             GET ADDRESS OF CCHHR IN IOB.    06860000
         ST    RD,SRCHADDR              PUT IN FIRST SEARCH COMMAND.    06880000
         MVI   SRCHOPCD,SRCHEQ          SET OP CODE = SEARCH.           06900000
*                                                                       06940000
* BUILD  FIRST  TIC CCW.                                                06960000
*                                                                       06980000
CCW2     EQU   *                                                        07000000
         ST    RCPBASE,TICADDR          STORE ADDRESS OF PREVIOUS SRCH. 07020000
         MVC   SRCHFLAG(B5),FLAGLEN     FLAGS, LEN, TIC OP CODE  S20201 07040020
*                                                                       07060000
*                                                                       07080000
         LR    RVALCHK,RSTEPPER         COPY PTR TO BEGINNING OF COUNTS 07100000
*                                       AND S.A.'S. WILL BE USED FOR    07120000
*                                       VAL CHK CP ADDRESSABILITY (IF   07140000
*                                       NEEDED) AND TO FLAG THE LAST    07160000
*                                       CCW OF THE WRITE SEGMENTS.      07180000
*                                                                       07200000
         IF    DCBOPTCD,ISNOT=VALCHK,GOTO=FLAGLAST                      07220000
*                                                                       07240000
* VALIDITY CHECK IS CALLED. BUILD THE VAL CHK CP SEGMENT WHILE ADDR-    07260000
* ESSABILITY IS AVAILABLE. CCW'S TO BE BUILT ARE A SEEK (CCW7), SEARCH  07280000
* (CCW8), TIC (CCW9) AND READ DATA (CCW10).                             07300000
*                                                                       07320000
         SH    RVALCHK,VALCKLEN         BACK UP TO BEGINNING OF VAL CHK 07340000
*                                       CP.                             07360000
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 07362020
*                                       READY                    S20201 07364020
         BO    FEAT7                    BRANCH IF YES            S20201 07366020
         SH    RVALCHK,DBLWDLEN         DECREMENT ADDITIONAL CCW S20201 07368020
*                                       SINCE FEATURES WRITE CHK        07370020
*                                       CHP LARGER                      07372020
FEAT7    EQU   *                                                 S20201 07374020
         USING VCMAP,RVALCHK            VAL CHK SEGMENT ADDRESSABILITY. 07380000
*                                                                       07400000
CCW7     EQU   *                        BUILD SEEK COMMAND. SEEK        07420000
*                                       ADDRESS SAME AS CCHH IN FIRST   07440000
*                                       COUNT FIELD.                    07460000
         LA    RD,IOBSEEK+1             POINTS TO IOB SEEK ADDR.        07480000
         ST    RD,SEEKADDR                                              07500000
         MVI   SEEKOPCD,SEEKCYL                                         07520000
         MVI   SEEKFLAG,CC              COMMAND CHAIN.                  07540000
         MVI   SEEKLEN,BBCCHH           LENGTH OF A 'BBCCHH'.           07560000
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 07562020
*                                       READY                    S20201 07564020
         BO    NOFET9                   BRANCH IF YES            S20201 07566020
         DROP  RIOB                                              S20201 07568020
         USING FORCORE,RCORE            OPEN COMMON WKAREA       S21042 07570021
         L     RD,DXCCW11               GET SECTOR ADDR          Y02072 07572002
         USING SAMSIOB,RIOB                                      S20201 07574020
         ST    RD,D8(RVALCHK)           PUT IN CCW               S20201 07576020
         OI    D12(RVALCHK),CC          TURN ON COMMAND CHAIN    S20201 07578020
         MVI  D15(RVALCHK),B1           SET BYTE COUNT TO ONE    S20201 07580020
         MVI   D8(RVALCHK),SETSC        PUT IN CCW CMND          S20201 07582020
         AH    RVALCHK,DBLWDLEN         INCREMENT RVALCHK BASE   S20201 07584020
*                                       REG                      S20201 07586020
*                                       TO ELIMINATE SET SECTOR         07588020
*                                       OFFSETS IN DSECT                07590020
NOFET9   EQU   *                                                 S20201 07592020
CCW8     EQU   *                        BUILD SEARCH ID EQUAL WITH SAME 07600000
*                                       CCHH AS THE SEEK.               07620000
         ST    RSTEPPER,VCSRCHAD        ADDRESS OF FIRST COUNT FIELD.   07640000
         MVI   VCSRCHOP,SRCHEQ          OP CODE.                        07660000
*                                                                       07700000
CCW9     EQU   *                        BUILD A TIC BACK TO CCW8.       07720000
         LA    RD,VCSRCH                ADDRESS OF SEARCH.              07740000
         ST    RD,VCTICAD               PUT IN TIC ADDRESS.             07760000
         MVC   VCSRCHFL(B5),FLAGLEN     FLAGS, LEN, TIC OP CODE  S20201 07780020
* TIC COMPLETE. NO FLAGS REQ'D.                                         07800000
*                                                                       07820000
CCW10    EQU   *                        BUILD READ DATA WITH SKIP.      07840000
         MVI   VCRDOP,READKD            TO READ DATA + KEYS (IF ANY).   07860000
         MVI   VCRDFLAG,SKIP            SKIP FLAG.                      07880000
* SKIP ON MAKES ADDRESS IMMATERIAL, LENGTH WILL BE SET AT EOB TIME.     07900000
*                                                                       07920000
* VALIDITY CHECK CP IS BUILT.                                           07940000
*                                                                       07943020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 07946020
*                                       READY                    S20201 07949020
         BO    FEATL17                  BRANCH IF YES            S20201 07952020
         SH    RVALCHK,DBLWDLEN         IF YES RVALCHK WAS INCR  S20201 07955020
*                                       TO WRT CHK PGM PLUS  8  TO      07958020
*                                       ELIMINATE SET SECTOR OFF-       07961020
*                                       SETS AND NOW MUST BE RE-        07964020
*                                       STORED                          07967020
FEATL17  EQU   *                                                 S20201 07970020
         ST    RVALCHK,PARASITE         PUT VAL CHK CP ADDRESS IN       07980000
*                                       R.H. OF CCW2.                   08000000
         MVI   PARASITE,TIC             PUT IN TIC OP CODE, OK BECAUSE  08020000
*                                       BITS 37-39=0.                   08040000
*                                                                       08060000
* PARASITE TIC IN CCW2 WILL BE USED TO TRANSFER-IN-CHANNEL AROUND ANY   08080000
* UNUSED CP SEGMENTS WHEN WRITE CHECK IS CALLED.                        08100000
*                                                                       08120000
         DROP  RVALCHK                  RELINQUISH VC CP ADDRESS.       08140000
*                                                                       08160000
FLAGLAST EQU   *                                                        08180000
*                                                                       08200000
         SH    RVALCHK,DBLWDLEN         THE CCW BEFOR THE VAL CHK CP    08220000
*                                       (OR THE S.A.'S AND COUNT FLDS)  08240000
*                                       IS THE END OF THE WRITE SEGMENT 08260000
*                                       CP'S. POINT TO IT.              08280000
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 08282020
*                                       READY                    S20201 08284020
         BO    NOFETFLG                 BRANCH IF YES            S20201 08286020
         ST    RVALCHK,PARASITE         PUT RD SECT ADDR IN      S20201 08288020
*                                       PARASIT                  S20201 08290020
         MVI   PARASITE,TIC             PUT IN TIC CMND          S20201 08292020
         SH    RVALCHK,DBLWDLEN         BACK UP TO NULL OP CD    S20201 08294020
NOFETFLG EQU   *                                                 S20201 08296020
         MVI   0(RVALCHK),WSCKD         FLAG LAST CCW4 OP CODE BYTE     08300000
*                                       WITH A NON-ZERO VALUE.          08320000
*                                                                       08340000
         LA    RF,NULLOPCD              ADDRESS OF CCW WHICH RECEIVES   08360000
         BAL   RE,GETBUFAD              BUFFER ADDRESS.                 08380000
*                                                                       08400000
         MVC   KEYLENTH(1),DCBKEYLE     KEY WILL BE WRITTEN ON FIRST    08420000
*                                       RECORD SEGMENT ONLY.            08440000
*                                                                       08460000
CCW3     EQU   *                        ALL FIRST TIME LOGIC IS DONE.   08480000
*                                       BEGIN HERE WITH A LOOP TO BUILD 08500000
*                                       THE REST OF CP SEG 1 (CCW'S 3   08520000
*                                       AND 4) AND ALL REMAINING SEG-   08540000
*                                       MENTS (MADE UP OF CCW'S 5,6,3,4 08560000
*                                       IN THAT ORDER.)                 08580000
*                                                                       08600000
         ST    RSTEPPER,COUNTADR        FILL IN COUNT FIELD ADDRESS.    08620000
         MVI   COUNTLEN,EIGHT           LENGTH OF A COUNT FIELD.        08640000
         MVI   WRTFLAG,DC               DATA CHAIN TO NEXT CCW.         08660000
*                                                                       08680000
CCW4     EQU   *                        THIS IS THE CCW THAT WRITES THE 08700000
*                                       DATA. NOTHING IS KNOWN AT OPEN  08720000
*                                       TIME EXCEPT THAT IT IS COMMAND  08740000
*                                       CHAINED, AND THE FIRST CCW4     08760000
*                                       WILL HAVE THE BUFFER ADDRESS IF 08780000
*                                       QSAM IS USED                    08800000
*                                       IF IT IS THE LAST CCW4, THE OP  08820000
*                                       CODE BYTE HAS BEEN SET TO NON-  08840000
*                                       ZERO.                           08860000
*                                                                       08880000
         MVI   RECORD,FIRST             INIT. 'R' TO 1.                 08900000
         CLI   NULLOPCD,ZERO            IS THIS THE LAST CP SEGMENT?    08940000
         BNE   THRULOOP                 YES. BRANCH TO DO FINAL LOGIC.  08960000
*                                                                       08980000
* PREPARE TO BUILD NEXT CP SEGMENT. ADVANCE THE CP ADDR REG TO NEXT CP, 09000000
* AND MOVE THE COUNT FIELD AND S.A. POINTER TO NEXT S.A.                09020000
*                                                                       09040000
         LA    RCPBASE,CPSEGLEN(RCPBASE)   POINT TO NEXT SEGMENT.       09060000
         LA    R13,EIGHT(R13)           POINT TO NEXT S.A.         DM0I 09070000
R13      EQU   13                       13                         DM0I 09080000
*                                       THE COUNT FIELD OVERLAY IS NOT  09100000
*                                       VALID UNTIL RSTEPPER IS BUMPED  09120000
*                                       8 MORE.                         09140000
*                                                                       09160000
CCW5     EQU   *                        SEARCH                          09180000
*                                                                       09200000
         ST    RSTEPPER,SRCHADDR        PUT IN POINTER TO SEARCH ADDR.  09220000
*                                                                       09260000
CCW6     EQU   *                        TIC                             09280000
*                                                                       09300000
         ST    RCPBASE,TICADDR          STORE ADDRESS OF CCW5.          09320000
         MVC   SRCHFLAG(B5),FLAGLEN     FLAGS, LEN, AND TIC OP   S20201 09330020
*                                       CODE                     S20201 09340020
*                                                                       09360000
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 09365020
*                                       READY                    S20201 09370020
         BNO   FEATAX                   BRANCH IF NO             S20201 09375020
         IF    DCBOPTCD,ISNOT=VALCHK,GOTO=PTRUPBY8                      09380000
*                                                                       09400000
* VAL CHK CALLED. NEED A PARASITE SEARCH ADDRESS IN CCW6 (TIC) TO BE    09420000
* USED FOR RECONSTRUCTION OF CCW5 AT EOB TIME.                          09440000
FEATAX   EQU   *                                                 S20201 09450020
*                                                                       09460000
         ST    RSTEPPER,PARASITE        PUT IN SEARCH ADDRESS.          09480000
*                                       SEARCH OP CODE IS IMPLIED, AND  09500000
*                                       FILLED IN AT EOB.               09520000
*                                                                       09540000
PTRUPBY8 EQU   *                                                        09560000
         LA    R13,EIGHT(R13)           POINT TO NEXT COUNT FIELD  DM0I 09580000
*                                       OVERLAY NOW APPLIES.            09600000
*                                                                       09620000
         B     CCW3                     CLOSE THE LOOP FOR BUILDING     09640000
*                                       CCW'S.                          09660000
*                                                                       09680000
THRULOOP EQU   *                        CCW'S ARE BUILT. FINAL LOGIC TO 09700000
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 09705020
*                                       READY                    S20201 09710020
         BO    NOFET19                  BRANCH IF YES            S20201 09715020
         BAL   RD,SOP6RTA               GO BUILD READ SECTOR CCW S20201 09720020
NOFET19  EQU   *                                                 S20201 09725020
         USING DEB,RDEB                                          S20201 09730020
*                                                                       09740000
*                                                                       09760000
*                                                                       09780000
         IF    DEBOPATB,IS=OUTPUT,GOTO=NEXTIOB                          09800000
*  MUST DROP RDEB BECAUSE  THE FORECORE DSECT LAYOUT PRODUCES A         09820000
* SMALLER OFFSET WITH RDEB FOR 'CHANPGM'. RIOB IS THE DESIRED REG.      09840000
         DROP  RDEB                                                     09860000
         B     BUILDRCP                 TO BUILD  RECORD READ CHAN.DM0I 09880000
RCPREQD  EQU   *                                                        09900000
         USING RCPOVLAY,RCPBASE                                         09940000
         LA    RSTEPPER,RDCCW           STEPPER+8=NEXT IOB.             09960000
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 09963020
*                                       READY                    S20201 09966020
         BO    NOFET25                  BRANCH IF YES            S20201 09969020
         LA    RSTEPPER,SXTN(RSTEPPER)  INCR FOR RCD READY       S20201 09972020
NOFET25  EQU   *                                                 S20201 09975020
BUILDRCP EQU   *                                                        09980000
         LA    RCPBASE,CHANPGM          READ CP CONTIG. TO IOB.         10000000
         USING RCPOVLAY,RCPBASE                                         10020000
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICESW/O RCD READY S20201 10046020
         BO    NOTRR2A                  BRANCH IF YES            S20201 10052020
         BAL   RD,SOP6STA               GO BUILD SET SECTOR CCW  S20201 10058020
         AH    RCPBASE,DBLWDLEN         INCR BASE FOR SET SECTOR S20201 10064020
NOTRR2A  EQU   *                                                 S20201 10070020
CCWA     EQU   *                                                        10080000
         LA    RD,IOBSEEK+3             SEARCH ON IOB FDAD.             10100000
         ST    RD,SRCHCCW+ADDRESS       FILL IN SEARCH ADDRESS.         10120000
         MVI   SRCHCCW+OPCODE,SRCHEQ    SEARCH OP CODE .                10140000
         MVC   SRCHCCW+FLAGS(4),FLAGLEN SET COMMAND CHAIN ON, LENGTH=   10160000
*                                       5=L'CCHHR.                      10180000
CCWB     EQU   *                                                        10200000
         LA    RD,SRCHCCW               GET SEARCH CCW ADDR      S20201 10210020
         ST    RD,TICCCW+ADDRESS        PUT IN TIC CCW           S20201 10220020
         MVC   SRCHCCW+FLAGS(B5),FLAGLEN FLAGS,LEN TIC OP CODE   S20201 10230020
CCWC     EQU   *                                                        10260000
         MVI   SKIPCCW+OPCODE,READDATA  CCW TO SKIP OVER PREVIOUS.      10280000
         MVI   SKIPCCW+FLAGS,SKIP+SILI+CC                               10300000
         MVI   SKIPCCW+LENFLD+1,NOTZERO                                 10320000
CCWD     EQU   *                                                        10340000
         IF    DCBCIND2,IS=QSAM,GOTO=TESTBUF                            10360000
         MVI   RKDCCW+OPCODE,READKD     CCWE, USING THE QSAM DECISION.  10380000
         CLI   DCBNCP,ZERO+1                                            10400000
         B     DECIDE                   IF MORE THAN ONE IOB.           10420000
TESTBUF  MVI   RDCCW+OPCODE,READDATA    CCWE, USING THE QSAM DECISION.  10440000
         CLI   DCBBUFNO,ZERO+1                                          10460000
DECIDE   BH    IOBAREQD                 READ INTO NEXT IOB IF THERE     10480000
*                                       IS ONE.                         10500000
         DROP  RIOB                                              YM1086 10502002
         L     RDCB,DXUDCBAD            USERS COPY OF DCB        Y02072 10510002
         LA    RD,DCBFDAD+3             ONLY ONE IOB. READ COUNT INTO   10520000
*                                       DCBFDAD.                        10540000
         L     RDCB,0(RPARC)            PROTECTED COPY OF DCB    Y02072 10550002
         B     STOREIT                                                  10560000
IOBAREQD EQU   *                                                        10580000
         USING SAMSIOB-8,RSTEPPER       STEPPER+8=NEXT IOB.             10620000
         LA    RD,IOBSEEK+3             NEXT IOB SEEK.                  10640000
         DROP  RSTEPPER                                                 10660000
         USING SAMSIOB,RIOB             RESUME ON CURRENT IOB.          10680000
STOREIT  ST    RD,RDCTCCW+ADDRESS                                       10700000
         MVI   RDCTCCW+OPCODE,READCT                                    10720000
         MVI   RDCTCCW+FLAGS,CC+SILI    COMMAND CHAIN AND SILI FLAGS ON 10740000
         MVI   RDCTCCW+LENFLD+1,IDLENGTH                                10760000
CCWE     EQU   *                                                        10780000
* OP CODE ALREADY SET AS REQ'D BY BSAM OR QSAM. MAY BE CHANGED AS       10800000
* REQ'D BY KEY LENGTH, ACCORDING TO WHETHER IT IS OR IS NOT ZERO.       10820000
         CLI   DCBKEYLE,ZERO                                            10840000
         BNE   OPCODEOK                 OP CODE OK                 DM0I 10860000
         MVI   RDCCW+OPCODE,READDATA                                    10880000
OPCODEOK EQU   *                                                        10900000
         TM    DCBRECFM,U                                               10920000
         BC    ANYZERO,NOSILI           BRANCH IF NOT 'U' RECORDS.      10940000
         OI    RDCCW+FLAGS,SILI         NEED SILI BIT FOR 'U' RCDS.     10960000
NOSILI   EQU   *                                                        10980000
         LA    RF,RDCCW                 POINT TO CCW WHICH RECEIVES     11000000
         BAL   RE,GETBUFAD              BUFFER ADDRESS.                 11020000
*                                                                       11021020
* IF RCD READY FEATURE USED BUILD A READ SECTOR COMMAND                 11022020
*                                                                       11023020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 11024020
*                                       READY                    S20201 11025020
         BO    NOFET29                  BRANCH IF YES            S20201 11026020
         TM    DCBRECFM,VRCDS           V TYPE RCDS              S20201 11027020
         BZ    NOSILIX                  BRANCH IF NO             S20201 11028020
         OI    RDCCW+FLAGS,SILI         TURN ON SILI BIT         S20201 11029020
NOSILIX  EQU   *                                                 S20201 11030020
*                                                                       11031020
* MUST DROP RIOB TO USE RCORE                                           11032002
         DROP  RIOB                                              S20201 11033020
         USING FORCORE,RCORE            OPEN COMMON WKAREA       S21042 11036021
         L     RD,DXCCW11               GET THETA ADDR           Y02072 11037002
         ST    RD,RRSADDR               PUT IN CCW               S20201 11038020
         OI    RDCCW+FLAGS,CC           CMND CHAIN PREVIOUS CCW  S20201 11039020
         MVI   RRSCNT,B1                SET BYTE COUNT TO ONE    S20201 11040020
         MVI   RRSCMND,RDSC             PUT IN CCW CMND          S20201 11041020
         DROP  RCORE                                             S20201 11042020
NOFET29  EQU   *                                                 S20201 11043020
         USING SAMSIOB,RIOB                                      S20201 11044020
NEXTIOB  EQU   *                        TEST FOR ANOTHER IOB TO BE      11060000
*                                       BUILT.                          11080000
         BCTR  RUCB,RE                  DECR IOB COUNT           S20201 11090020
         LTR   RUCB,RUCB                HAVE ALL IOBS BEEN BUILT S20201 11100020
*                                       FLAGGED.                        11120000
         BNP   ALLBUILT                 YES BRANCH TO CLOSE IOB  S20201 11150020
*                                      CHAIN AND THEN DO WTG LOGIC.     11180000
* MORE IOB'S TO BE BUILT.                                               11200000
         LA    RD,EIGHT(RSTEPPER)       NEXT IOB STARTS AFTER LAST      11220000
*                                       COUNT FLD OF THE PREVIOUS.      11240000
         O     RD,LINK                  FORWARD CHAIN TO NEXT IOB.      11260000
*                                       OR'ING PRESERVES THE FLAG.      11280000
         ST    RD,LINK                  STORE THE PREPARED LINK FIELD.  11300000
*                                                                       11320000
         LR    RIOB,RD                  NOW HAVE ADDRESSABILITY FOR THE 11340000
*                                       NEXT IOB.                       11360000
*                                                                       11380000
         B     BUILDIOB                 GO BACK AND BUILD IT.           11400000
*                                                                       11420000
ALLBUILT EQU   *                                                        11440000
         MVC   LINK+1(3),DCBIOBA+1      LINK LAST IOB TO THE FIRST.     11460000
         USING DEB,RDEB                                          S20201 11470020
*                                                                       11480000
* TEST FOR OUTPUT ONLY.                                                 11500000
         IF    DEBOPATB,IS=OUTPUT,GOTO=ALLTHRU                          11520000
         DROP  RDEB                                              S20201 11530020
* LINK LAST IOB'S READ COUNT CCW TO FIRST IOB. NOT DONE IF ONLY 1 IOB.  11540000
         L     RA,DCBIOBA               GET FIRST IOB'S ADDRESS.        11560000
         CR    RA,RIOB                  ONLY 1 IOB IF CURRENT = FIRST.  11580000
         BE    ALLTHRU                  BRANCH IF 1 IOB.                11600000
         LA    RA,IOBSEEK-SAMSIOB+3(RA) FIRST IOB'S SEEK ADDRESS.       11620000
         ST    RA,RDCTCCW+ADDRESS                                       11640000
         MVI   RDCTCCW+OPCODE,READCT    OP CODE GOES IN AFTER ADDRESS.  11660000
ALLTHRU  EQU   *                        EVERY THING DONE.               11680000
*                                                                       11700000
*                                                                       11860000
         DROP  RIOB                                                     11880000
*******************  WTG LOGIC GOES HERE. **********************        11900000
*                                                                       11920000
STOPSOP6 EQU   *                                                        11940000
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 11950002
         SPACE                                                          11960002
         L     RCORE,4(RWTGC)           GET WORK AREA ADDRESSABILITY.   11980000
         USING FORCORE,RCORE            OPEN COMMON WKAREA       S21042 12000021
         OI    FCAOPEN2,FCAOIOBC        IOBS COMPLETED           YM7595 12000402
         L     RPAR,DXREGSAV            RELOAD REGISTER          YM2424 12002002
         USING WTGENTRY,RWTGC                                    Y02072 12010002
         MVC   WTGIDTTR,LOADEXEC        NEXT MOD               @Z30TSCF 12012003
         TM    DCBRECFM,X'80'           VARIABLE RECORD FORMAT    22688 12025018
         BO    RELOOP                   NO,BRANCH                 22688 12030018
         MVC   WTGIDTTR,OPENVREC        GO TO 1916             @Z30TSCF 12032003
RELOOP   LA    RWTGC,WGOFF(0,RWTGC)     INCREMENT CURRENT WTG ENTRY.    12060000
         LA    RPARC,PLOFF(0,RPARC)     INCREMENT CURRENT DCB ENTRY PTR 12080000
         CLC   0(2,RWTGC),AMIDCNST      IS THIS RTN NEEDED AGAIN?       12100000
         BCR   EGP2,RBASE               RETURN TO OPEN             DM0I 12120000
*                                                                       12140000
         CLC   0(2,RWTGC),OPIDCNST      END OF TABLE?                   12160000
         BC    7,RELOOP                 NO, CHECK NEXT ENTRY.           12180000
*                                                                       12200000
         LR    RPARC,RPAR                                               12220000
         LA    RWTGC,WAOFF(0,RWTG)      REINIT. WTG LIST PTR.           12240000
ZCHEK    CLI   0(RWTGC),X'00'           IS THIS ENTRY COMPLETE?         12260000
         BC    7,TCTLRTN                IF NOT TRANSFER CONTROL.        12280000
*                                                                       12300000
         LA    RWTGC,WGOFF(0,RWTGC)     GET NEXT ENTRY.                 12320000
         LA    RPARC,PLOFF(0,RPARC)                                     12340000
         B     ZCHEK                    ZERO CHECK                 DM0I 12360000
*                                                                       12380000
TCTLRTN  EQU   *                                                        12400000
         USING WTG,RWTG                                                 12450003
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSCF*12500003
               MODID=WTGENTRY                                  @Z30TSCF 12510003
         DROP  RWTGC,RWTG                                      @Z30TSCF 12520003
*                                                                       12544020
* END WTG LOGIC                                                         12548020
*                                                                       12552020
* SET SECTOR BUILD RTN                                                  12556020
*                                                                       12560020
SOP6STA  EQU   *                                                 S20201 12564020
*                                                                       12568020
         L     RE,DXCCW11               GET THETA ADDR           S20201 12572020
         ST    RE,D0(RCPBASE)           PUT IN CCW               S20201 12576020
         OI    FLAGS(RCPBASE),CC        TURN ON CMND CHAIN       S20201 12580020
         MVI   CNTOFF(RCPBASE),B1       SET BYTE COUNT TO ONE    S20201 12584020
         MVI   D0(RCPBASE),SETSC        PUT IN SET SECT CMND     S20201 12588020
         BR    RD                       RETURN                   S20201 12592020
*                                                                       12594020
* READ SECTOR BUILD ROUTINE                                             12596020
*                                                                       12598020
         USING WCPMAP,RCPBASE                                    S20201 12600020
SOP6RTA  EQU   *                                                 S20201 12602020
         L     RE,DXCCW11               GET THETA ADDR           Y02072 12604002
         ST    RE,WRSADDR               PUT IN CCW               S20201 12606020
*                                                                       12608020
         OI    NULLFLAG,CC              TURN ON PREVIOUS CCW     S20201 12610020
*                                       CMND                     S20201 12612020
*                                       CHAIN                           12614020
         MVI   WRSCNT,B1                SET BYTE COUNT TO ONE    S20201 12616020
         MVI   WRSCMND,RDSC             PUT IN CCW CMND          S20201 12618020
         BR    RD                       RETURN                   S20201 12620020
         DROP  RCPBASE                                           S20201 12622020
*                                                                       12624020
GETBUFAD EQU   *                                                 S20201 12626020
         IF    DCBCIND2,ISNOT=QSAM,GOTO=RETURN                          12640000
         L     RWK1,DCBBUFCB            ADDR OF BUF CNTRL BLK    YM7595 12690002
         USING BCBLK,RWK1                                               12692002
         L     RBUFADR,BCBBUFPT         ADDR NEXT AVAIL BUFFER   YM7595 12694002
         LTR   RBUFADR,RBUFADR          IS THERE AN ADDR         Y02072 12700002
         BC    NOTZERO,AVAIL            BRANCH IF BUFF AD NOT 0.        12740000
         L     RPAR,DXREGSAV            RELOAD REG FOR PROB DET  YM2424 12740402
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 12742002
         SPACE                                                          12752002
         DMABCOND OABD062,PDLOAD,RETURN=NONE,RES=NO,REGSAVE=YES  S21042X12760021
                                        013 ABEND                       12780021
         B     TCTLRTN                  GO XCTL                  S21042 12800021
AVAIL    EQU   *                                                        12810402
         USING BUFFER,RBUFADR                                           12810802
         MVC   BCBBUFAD,BUFNXPTB        UPDATE WITH NEXT AVAIL   YM7595 12811202
*                                         BUFFER                 YM7595 12811602
         USING CCW,RF                                            Y02072 12811702
         STCM  RBUFADR,B'0111',CCWADDRB  BUFER ADDR TO CCW       Y02072 12812002
         MVC   CCWBYTE,DCBBLKSI         INIT CCW LENGTH                 12860002
         DROP  RF,RWK1,RBUFADR                                          12870002
RETURN   LR    RF,RE                                                    12880000
         BR    RF                       EXIT                       DM0I 12900000
*                                                                       12920000
TWOCON   DC    H'2'                     CONSTANT OF TWO          S20201 12940020
DBLWDLEN DC    H'8'                     LENGTH OF A DOUBLE WORD.        12960000
VALCKLEN DC    H'32'                    VALIDITY CHK CP LENGTH.         12980000
FLAGLEN  DC    X'40'                    COMMAND CHAIN FLAG.             13000000
         DC    X'00'                    SPACER                          13020000
         DC    H'5'                     LENGTH OF A 'CCHHR'.            13040000
         DC    X'08'                    TIC OP CODE              S20201 13050020
*                                                                       13060000
*                                                                       13080000
* WTG CONSTANTS AND EQUATES.                                            13100000
*                                                                       13120000
WAOFF    EQU   32                                                       13140000
PLOFF    EQU   4                                                        13160000
WGOFF    EQU   8                                                        13180000
OPIDCNST DC    C'0S'                    ID                         DM0I 13200000
AMIDCNST DC    C'1H'                    ID                         DM0I 13220000
LOADEXEC DC    C'13',VL3(IGG01913)      NEXT EXEC              @Z30TSCF 13230003
OPENVREC DC    C'16',VL3(IGG01916)      NEXT EXEC              @Z30TSCF 13232003
PDLOAD   DC    C'6M',VL3(IGG0196M)      PROB DETERMINATION     @Z30TSCF 13234003
*                                                                       13240000
* END WTG CONSTANTS.                                                    13260000
*                                                                       13280000
PATCH    DC    25H'0'                   PATCH AREA               YM4640 13330002
END      EQU   *                        END OF MODULE            Y02072 13390002
         EJECT                                                          13390403
CVT      DSECT                                                 @Z30TSCF 13390803
         CVT                                                   @Z30TSCF 13391203
         EJECT                                                          13392002
         IGGBCB  TYPE=SAM                                               13394002
         EJECT                                                          13400002
         IHACCW  DSECT=YES                                       Y02072 13410002
         EJECT                                                          13412002
*                                                                       13420000
* READ CHANNEL PROGRAM OVERLAY.  CCW FIELDS ARE ACCESSED BY ABSOLUTE    13440000
* OFFSETS FROM THE CCW NAME.                                            13460000
*                                                                       13480020
RCPOVLAY DSECT                                                          13500020
SRCHCCW  DS    D                        SEARCH CCW                 DM0I 13540000
*        TIC    (CCWB)                                                  13560000
TICCCW   DS    D                        TIC                        DM0I 13580000
*        READ DATA WITH SKIP  (CCWC)                                    13600000
SKIPCCW  DS    D                        SKIP CCW                   DM0I 13620000
*        READ COUNT (CCWD)                                              13640000
RDCTCCW  DS    D                        READCCW                    DM0I 13660000
*        READ DATA (CCWE)                                               13680000
RDCCW    DS    D                        READ CCW                   DM0I 13700000
*        READ KEY AND DATA (ALTERNATE CCWE)                             13720000
RKDCCW   EQU   RDCCW                                                    13740000
*                                                                       13741020
* READ SECTOR COMMAND, USED ONLY WITH RECORD READY FEATURE              13742020
*                                                                       13743020
RRSCMND  DS    F                        READ SECTOR COMMAND      S20201 13744020
RRSADDR  EQU   RRSCMND                  SECTOR ADDR              S20201 13745020
RRSFLAG  DS    XL1                      FLAG FIELD               S20201 13746020
         DS    CL2                      FILLER                   S20201 13747020
RRSCNT   DS    XL1                      BYTE COUNT ONLY ONE BYTE S20201 13748020
RCCHHR   DS    D                        ADDR OF READ CNT WHEN    S20201 13749020
*                                       USING                    S20201 13750020
*                                       RECORD READY FEATURE            13751020
*                                                                       13752020
* END READ CP CCW DEFINITION                                            13760000
* FOLLOWING IS A MAP OF A WRITE CHANNEL PROGRAM (WCP) SEGMENT.          13780000
*                                                                       13800020
WCPMAP   DSECT                                                          13820020
*                                                                       13840020
*        SEARCH  (CCW1 OR 5)                                            13860000
*                                                                       13880000
SRCHADDR DS    F                        SEARCH                     DM0I 13900000
SRCHOPCD EQU   SRCHADDR                 OP CODE IS HI ORDER BYTE.       13920000
SRCHFLAG DS    XL1                      SEARCH FLAG                DM0I 13940000
         DS    CL2                      FLAG                       DM0I 13960000
SRCHLEN  DS    XL1                      LENGTHS NORMALLY FIT IN 1 BYTE. 13980000
*                                                                       14000000
*        TIC   (CCW2 OR 6)                                              14020000
*                                                                       14040000
TICADDR  DS    F                        TIC                        DM0I 14060000
TICOPCD  EQU   TICADDR                  TIC  OP                    DM0I 14080000
UNUSED   DS    F                        ONLY REQUIRES BITS 37-39 = 0.   14100000
PARASITE EQU   UNUSED                   MAY BE USED TO STORE AN ADDRESS 14120000
*                                       BUT THE ABOVE RESTRICTION       14140000
*                                       LIMITS THE OP CODES THAT MAY    14160000
*                                       BE STORED IN THE HI BYTE.       14180000
*                                                                       14200000
*        WRITE  (CCW3)                                                  14220000
*                                                                       14240000
COUNTADR DS    F                        COUNT FIELD ADDRESS.            14260000
WRTOPCD  EQU   COUNTADR                                                 14280000
WRTFLAG  DS    XL1                      FLAG FIELD.                     14300000
         DS    CL2                      SPACER.                         14320000
COUNTLEN DS    XL1                      COUNT FIELD LENGTH (NORMALLY 8) 14340000
*                                                                       14360000
*        NULL OP CODE  (CCW4)           OP PROPAGATED FROM WRITE CCW.   14380000
*                                                                       14400000
DATAADDR DS    F                        ADDRESS OF BLOCK OF DATA TO BE  14420000
*                                       WRITTEN.                        14440000
NULLOPCD EQU   DATAADDR                 USED AS A FLAG TO SIGNAL LAST   14460000
*                                       SEGMENT.                        14480000
NULLFLAG DS    XL1                      NULL FLAG                  DM0I 14500000
         DS    XL1                      SPACER.                         14520000
DATALEN  DS    H                        2 BYTES HOLDS DATA LENGTH.      14540000
*                                                                       14544020
* READ SECTOR COMMAND USED ONLY WITH RECORD READY FEATURE               14548020
*                                                                       14552020
WRSCMND  DS    F                        READ SECTOR COMMAND      S20201 14556020
WRSADDR  EQU   WRSCMND                  SECTOR ADDR              S20201 14560020
WRSFLAG  DS    XL1                      FLAG FIELD               S20201 14564020
         DS    CL2                      FILLER                   S20201 14568020
WRSCNT   DS    XL1                      BYTE COUNT FIELD         S20201 14572020
*                                                                       14576020
*                                                                       14580020
*                                                                       14584020
*                                                                       14588020
* FOLLOWING IS THE VALIDITY CHECK CHANNEL PROGRAM OVERLAY.              14600000
*                                                                       14620000
VCMAP    DSECT                                                          14640000
*        SEEK  (CCW7)                                                   14660000
SEEKADDR DS    F                        SEEK ADDRESS               DM0I 14680000
SEEKOPCD EQU   SEEKADDR                                                 14700000
SEEKFLAG DS    XL1                      FLAG                       DM0I 14720000
         DS    CL2                      COUNT                      DM0I 14740000
SEEKLEN  DS    XL1                      SEEK LENGTH                DM0I 14760000
*                                                                       14780000
*        SEARCH (CCW8)                  LABELS PREFIXED BY 'VC' (VAL    14800000
VCSRCH   EQU   *                        CHECK).                         14820000
VCSRCHAD DS    F                        SEARCH ADDRESS             DM0I 14840000
VCSRCHOP EQU   VCSRCHAD                 SEARCH OP                  DM0I 14860000
VCSRCHFL DS    XL1                      FLAGS.                          14880000
         DS    CL2                      COUNT                      DM0I 14900000
VCSRCHLE DS    XL1                      LENGTH.                         14920000
*                                                                       14940000
*        TIC   (CCW9)                                                   14960000
VCTICAD  DS    F                        TIC                        DM0I 14980000
VCTICOP  EQU   VCTICAD                  TIC ADDRESS                DM0I 15000000
NOTUSED  DS    F                        NOT USED                   DM0I 15020000
*                                                                       15040000
*        READ DATA (CCW10)                                              15060000
VCRDAD   DS    F                        RECORD ADDRESS             DM0I 15080000
VCRDOP   EQU   VCRDAD                   RECORD ADDR.               DM0I 15100000
VCRDFLAG DS    XL1                      NORMALLY SKIP.                  15120000
VCRDLEN  DS    FL3                      RECORD LENGTH              DM0I 15140000
*                                                                       15160000
* FOLLOWING IS AN OVERLAY OF THE COUNT FIELD.                           15180000
*                                                                       15200000
COUNTFLD DSECT                                                          15220000
*                                                                       15240000
CYLINDER DS    H                        CYLINDER ADDRESS (CC).          15260000
HEAD     DS    H                        HEAD ADDRESS     (HH).          15280000
RECORD   DS    XL1                      RECORD NUMBER    (R).           15300000
KEYLENTH DS    XL1                      KEY LENGTH       (KL).          15320000
DLDL     DS    H                        DATA LENGTH      (DLDL).        15340000
*                                                                       15360000
* END COUNT FIELD. (CCHHRKDD)                                           15380000
*                                                                       15400000
*                                                                       15420000
* DIRECT ACCESS DEVICE TABLE OVERLAY                                    15440000
*                                                                       15460000
DEVTAB   DSECT                                                          15480000
DEVSIZE  DS    F                       MAX SIZ FOR DEVICE.              15500000
TRKCAP   DS    H                       TRACK CAPACITY.                  15520000
OVERI    DS    XL1                     OVERHEAD FOR NOT-LAST RECORD.    15540000
OVERL    DS    XL1                     OVERHEAD FOR LAST RECORD.        15560000
OVERK    DS    XL1                     OVERHEAD REDUCTION FOR NON-KEY   15580000
*                                      RECORDS.                         15600000
DEVFLAG  DS    XL1                      DEVICE FLAG                DM0I 15620000
TOLER    DS    H                       TOLERANCE/512 USED FOR VARIABLE  15640000
*                                       GAP LENGTH CALCULATIONS.        15660000
* END DEVTAB OVERLAY.                                                   15680000
*                                                                       15700000
*                                                                       15720000
         IECDSECS MAIN,DCB,WTG,PREFX,EXPAND=YES                @Z30TSCF 15800003
         ORG   WTGIDTTR                                          Y02072 15850002
WTGID    DS    CL2                      NEXT MODS ID             Y02072 15860002
*                                                                       15880000
* IOB OVERLAY                                                           15900000
* THE FORECORE DSECT IOB OVERLAY IS USED WITH THE FOLOWING ADDITIONS-   15920000
*                                                                       15940000
* BSAM/BPAM/QSAM IOB EXTENSION-                                         15960000
SAMSIOB  EQU   DXIOB-8                  START OF SAM'S IOB.             15980000
LINK     EQU   SAMSIOB                  FORWARD CHAIN FIELD (TO NEXT    16000000
*                                       IOB).                           16020000
FLAG     EQU   LINK                     HI BYTE OF LINK USED AS FLAG.   16040000
ECB      EQU   DXIOB-4                  ECB                        DM0I 16060000
* END EXTENSION DEFINITIONS                                             16080000
*                                                                       16100000
IOBSEEK  EQU   DXDAADDR                 SEEK ADDRESS               DM0I 16120000
CHANPGM  EQU   DXDAADDR+8               START OF CHANNEL PROGRAM.       16140000
*                                       LENGTH MAY VARY.                16160000
* END IOB DEFINITIONS.                                                  16180000
*                                                                       16200000
DEB      EQU   DXDEB                                                    16220000
DEBOPATB EQU   DXDEBSYS                 DEB ADDRESS                DM0I 16240000
         EJECT                                                          16250002
FORCORE  DSECT                                                          16250402
         IHAFCAUD ORG=YES                                               16252002
         END                                                            16260000
