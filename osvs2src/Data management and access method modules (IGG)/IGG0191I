         TITLE ' IGG0191I    BUFFER CONSTRUCTION      '                 00020000
IGG0191I CSECT                                                          00024000
*MODULE NAME - IGG0191I                                          Y02072 00026002
*                                                                       00028002
*DESCRIPTIVE NAME - BUFFER BUILDER                               Y02072 00030002
*                                                                       00032002
*COPYRIGHT - NONE                                                Y02072 00032402
*                                                                       00032802
*CHANGE ACTIVITY - AS FOLLOWS:                                   Y02072 00033202
*                                                                       00034002
*          VS 2 RELEASE 2 DELETIONS                              Y02072 00044002
*000221,000805,032900,033100-033200,037179,037201-037348,043692, Y02072 00046002
*043788,044400,049360,000480-000517,009600,043620-043632,        Y02072 00046402
*043656-043788,049397,079200,52200,75000,75870,75900,77000-77200 Y02072 00048402
*          VS2 RELEASE 3 DELETIONS                                      00050402
*C037441,037474,037507                                          ZA01275 00050802
*A036908,036912                                                 ZA01373 00051202
*                                                              @Z30TSCF 00051303
*           VS2 RELEASE 4 DELETIONS                                     00051737
*C036400,032360,032380                                         @XA01495 00051837
*A037626-037630,037940-037956                                  @XA01495 00051937
*         RELEASE 20 DELETIONS                                       *  00052002
*0281001400-001600,003000-003100,051400-067200,071200-072800,    S20201 00052320
*0281078600-080720,098600                                        S20201 00052620
*0281036400,038800,039500-040140                                 A30808 00053020
*0281014600,037000,082800-086800                                 S20016 00054020
*0281036845-036854                                               M0017  00055020
*0281063600                                                      A30962 00055520
*0281034800-035400,036809-037151,081260,081290,081320,081350     M3415  00055720
*                                                                 M5005 00055820
*                                                                 M4843 00055920
*          RELEASE 21 DELETIONS                                       * 00056000
*0892                                                            A48163 00056421
*A                                                              SA52300 00060821
*                                                               SA56446 00061221
*0892003400,074600-075000,075850,075880,078300-081200,082000-    S21042 00064901
*0892082200                                                      S21042 00068801
*D000280-000460,000600,050600-051000,067400-067600               XM6327 00070801
*D036804-036860,037355                                           YM3034 00072800
*                                                               SA67354 00074802
*C442380                                                       @ZA12970 00075737
*                                                                       00076601
*STATUS CHANGE LEVEL 010                                        ZA01373 00080502
*                                                                       00084401
*FUNCTION/OPERATION- THIS ROUTINE SUPPLEMENTS THE INITIAL OPEN ROUTINE. 00088301
*      IT PERFORMS GENERAL AND SPECIFIC FUNCTIONS FOR THE SEQUENTIAL    00092201
*      ACCESS METHOD                                                    00096101
*      IT DETERMINES THE NUMBER OF BUFFERS NEEDED AND ISSUES A'GETMAIN' 00100000
*      FOR THE CORRECT AREA AND STORES THE ADDRESS IN THE DCB.          00120000
*                                                                       00180000
*      IF A RECORD AREA IS NEEDED FOR LOGICAL RECORD PROCESSING         00190021
*      OF VARIABLE LENGTH SPANNED RECORDS, IT DETERMINES THE SIZE       00192021
*      AND ISSUES A GETMAIN FOR THE RECORD AREA.  IT PUTS THE ADDRESS   00194021
*      OF THE RECORD AREA IN THE BUFFER CONTROL BLOCK AND SETS FLAGS    00196021
*      TO INDICATE THE PRESENCE OF A RECORD AREA.                       00198021
*                                                                       00198402
*      IT ALSO SETS AUDIT TRAIL BITS IN THE OPEN WORKAREA AFTER  Y02072 00198802
*      ACQUIRING RESOURCES IN CASE OF A FORCE CLOSE SITUATION.   Y02072 00199202
*                                                                       00199602
*ENTRY POINT- IGG0191I ENTERED FROM IGG0191A BY XCTL                    00200000
*                                                                       00220000
*INPUT: SEE DESCRIPTION OF REGISTERS.                                   00240000
*OUTPUT: SEE DESCRIPTION OF REGISTERS.                                  00260000
*EXTERNAL ROUTINES: NONE.                                               00280000
*EXIT NORMAL  XCTL TO IGG0193I                                          00300020
*                                                                       00320000
*EXITS-ERROR CALL PROB DET (IGG0196M) FOR WTP AND 013 ABEND             00340021
*                                                                       00350002
*MACROS - ACTION : MODESET, XCTL, GETMAIN, DMABCOND, XCTLTABL    Y02072 00352002
*                                                                       00354002
*MACROS - MAPPING : IKJTSB, IHAASCB, IEZJSCB, IKJTCB, DCBD,      Y02072 00356002
*                   IECDSECS, CVT, IEFUCBOB, IGGBCB, IGGPARML    Y02072 00358002
*                                                                       00360000
*TABLES/WORKAREAS: WHERE TO GO TABLE(WTG)                               00380000
*      BYTE  0-7  NAME                                                  00400000
*      BYTE  8-10 RELATIVE DISK ADDRESS(TTR) OF FIRST RECORD            00420000
*      BYTE 11    CONCATENATION NUMBER                                  00440000
*      BYTE 12    ZERO                                                  00460000
*      BYTE 13    ALIAS INDICATOR AND USER DATA FIELD DESCRIPTOR.       00480000
*                        ALIAS INDICATOR 1 BIT                          00500000
*                        NUMBER OF TTRS IN USERS DATA FIELD 2 BITS      00520000
*      BYTE 14-16 TTR OF FIRST TEXT RECORD                              00540000
*      BYTE 17    ZERO                                                  00560000
*      BYTE 18-19 TTR OF NOTE LIST OR SCATTER LIST                      00580000
*      BYTE 20    TRANSLATION TABLE                                     00600000
*      BYTE 21    ZERO OR NUMBER OF ENTRIES IN THE NOTE LIST            00620000
*      BYTE 22-23 ATTRIBUTES                                            00640000
*      BYTE 24-26 TOTAL CONTIGUOUS MAIN STORAGE REQUIRED FOR MODULE     00660000
*      BYTE 27-28 LENGTH OF FIRST TEXT RECORD                           00680000
*      BYTE 29    LENGTH OF WTG TABLE(IN DOUBLE WORDS)                  00700000
*      BYTE 30-31 PATH THROUGH LOADS OF ROUTINES                        00720000
*      BYTE 32-34 IDTTR OF EXECUTOR FOR FIRST DCB                       00740000
*      BYTE 35    ADDRESS OF STORAGE FOR DCB                            00760000
*      BYTE 36-39 TABLE OF IDTTR'S                                      00780000
*      BYTE 32+N(8) IDTTR OF EXECUTOR FOR  N TH DCB (3 BYTES)           00800000
*                   ADDRESS OF STORAGE FOR DCB      (1 BYTE )           00820000
*                   IDTTR OF LAST ROUTINE LOAD      (3 BYTES)           00840000
*                   NOT USED                        (1 BYTE )           00860000
*                                                                       00880000
*      WORKAREA- SEE 'FORCORE DSECT' (IECDSECT) IN THIS LISTING         00900000
*                                                                       00920000
*ATTRIBUTES: REENTRANT, REUSABLE, RUNS IN DATAMANAGEMENT KEY     Y02072 00940002
*            UNLESS OTHERWISE SPECIFIED, SUPER STATE             Y02072 00950002
*                                                                       00952002
*  REGISTER CONVENTIONS USED THROUGH OUT ALL OPEN PASSES                01060000
*                                                                       01080000
*********************************************************************** 01100000
*                                                                       01120000
*                                                                       01140000
RE       EQU   0                       WORK/PARAMETER REGISTER          01160000
RWK1     EQU   RE                       WORK REGISTER            Y02072 01170002
RF       EQU   1                       WORK/PARAMETER REGISTER          01180000
RWK2     EQU   RF                       WORK REGISTER            Y02072 01190002
RDCB     EQU   2                       ADDR OF USERS DCB                01200000
RBASE    EQU   3                       BASE REGISTER                    01220000
RCORE    EQU   4                       ADDR OF OPEN WORK AREA           01240000
RPAR     EQU   5                       PARAMETER LIST                   01260000
RWTG     EQU   6                       START OF WTG                     01280000
RPARC    EQU   7                       CURRENT ENTRY IN PARAMETER LIST  01300000
RWTGC    EQU   8                       CURRENT ENTRY IN WTG TABLE       01320000
RTIOT    EQU   9                       TIOT ADDR/WORK REGISTER          01340000
RWK3     EQU   RTIOT                    WORK REGISTER            Y02072 01350002
RUCB     EQU   10                      UCB ADDR/WORK REGISTER           01360000
RDEB     EQU   11                      DEB ADDRESS                      01380000
RA       EQU   11                                                       01400000
RB       EQU   12                      WORK REGISTER                    01420000
RC       EQU   13                      WORK REGISTER                    01440000
RD       EQU   14                       TCB ADDR/WORK/PARAMETER  S20016 01450020
*                                       REG                      S20016 01460020
RJ       EQU   15                      WORK/PARAMETER REGISTER          01480000
RWK4     EQU   RJ                       WORK REGISTER            Y02072 01490002
* MASK'S TO TEST PARAMETER LIST WITH                                    01500000
*                                                                       01520000
OUTP       EQU   X'0F'                                                  01540000
*                                                                       01560000
*********************************************************************   01580000
*                                                                       01600000
*                                                                       01620000
* OFFSET FOR PARAMETER TESTS                                            01640000
*                                                                       01660000
DISPSN     EQU   X'0'                                                   01680000
*                                                                       01700000
*                                                                       01720000
*********************************************************************   01740000
*                                                                       01760000
* MASK'S USED TO TEST OPTION FIELDS IN DCB                              01780000
*                                                                       01800000
*                                                                       01820000
*                                                                       01840000
DOUBLE     EQU   X'01'                  ALIGNMENT BIT                   01860021
*                                                                       01880000
C2       EQU   2                        GENERAL CONSTANT 2       S20201 01886020
C6       EQU   6                        GENERAL CONSTANT 6       S20201 01892020
C3       EQU   3                        GENERAL CONSTANT 3       S21042 01894021
ZERO     EQU   0                        GENERAL CONSTANT 0       S21042 01896021
*                                                                       01900000
STOWB      EQU   X'80'                                                  01920000
OVRFLO     EQU   X'20'                                                  01940000
PCI        EQU   X'20'                                                  01960000
CONCAT     EQU   X'FF'                                                  01980000
*                                                                       02000000
QSAMODE  EQU   X'01'                    DENOTES QSAM IN DCBCIND2 M0017  02010020
BLKFLG   EQU   X'04'                    USED TO TELL CLOSE BLKD SA52300 02012021
*                                       BIT TURNED OFF          SA52300 02014021
*********************************************************************   02020000
*                                                                       02040000
* MASKS FOR ACCESS METHODS IN SAM                                       02060000
*                                                                       02080000
PAM        EQU   X'02'                                                  02100000
PSAM       EQU   X'42'                                                  02120000
QSAMB      EQU   X'01'                                                  02140000
*                                                                       02160000
*                                                                       02180000
* MASKS FOR MACRO'S TO BE USED                                          02200000
*                                                                       02220000
GETB       EQU   X'40'                                                  02240000
PUTB       EQU   X'40'                                                  02260000
READB      EQU   X'20'                                                  02280000
WRITEB     EQU   X'20'                                                  02300000
POINTB     EQU   X'04'                                                  02320000
CNTRLB     EQU   X'02'                                                  02340000
*                                                                       02360000
*                                                                       02380000
*********************************************************************   02400000
*                                                                       02420000
* MASKS FOR DEVICES TO BE SUPPORTED                                     02440000
*                                                                       02460000
DABIT    EQU   X'20'                                                    02480000
URBIT    EQU   X'40'                                                    02500000
TAPEB    EQU   X'80'                                                    02520000
TERM     EQU   X'4F'                    DCBDEVT FOR TS TASK      S20016 02521020
D1285    EQU   X'5A'               TEST DCBDEVT FOR 1285         S19017 02523019
*                                  DCBDEVT FOR 1287 IS X'5B'     S19017 02526019
D1288    EQU   X'5C'               TEST DCBDEVT FOR 1288         S19017 02529019
D1419    EQU   X'5D'                   DCBDEVT CODE FOR 1419     S19033 02532019
D1275    EQU   X'5F'                    DCBDEVT CODE FOR 1275    S19033 02535019
*                                                                       02540000
*                                                                       02560000
* MASKS FOR BUFFER TECHNIQUE'S                                          02580000
*                                                                       02600000
EXCHANGB   EQU   X'10'                                                  02620000
*                                                                       02670002
* MODES OF OPERATION FOR QSAM                                           02720000
*                                                                       02740000
LOCATEB    EQU   X'08'                                                  02760000
MOVEB      EQU   X'10'                                                  02780000
*                                                                       02800000
* MASKS USED FOR NEW BUFFER CONTROL BLOCK WHICH HAS A RECORD AREA       02800919
* ADDRESS                                                               02801819
* THE RECORD AREA IS PROVIDED IN SUPPORT OF QSAM LOCATE MODE OF         02802719
* OPERATION WITH LOGICAL RECORD INTERFACE FOR VARIABLE LENGTH           02803619
* SPANNED RECORDS                                                       02804519
*                                                                       02805419
LRECIND  EQU   X'60'                    LOGICAL REC INTERFACE   SA56446 02806321
FORMATVS EQU   X'48'                    VARIABLE LENGTH SPANNED  S19015 02807219
*                                           RECORD                      02808119
CTLINFO  EQU   32                       LENGTH OF CONTROL INFO   S19015 02809019
*                                            IN RECORD AREA             02809919
ADDRLEN  EQU   4                        LENGTH OF RECORD AREA    S19015 02810819
*                                       ADDR                     S19015 02811719
ADLEN    EQU   3                        LENGTH OF ADDR           S19015 02812619
FLGOFFST EQU   4                        OFFSET TO FLAG BYTE IN   S19015 02813519
*                                       BCB                      S19015 02814419
RAFLAG   EQU   X'80'                    RECORD AREA PRESENT      S19015 02815319
EXTND    EQU   X'40'                    BIT ON INCICATES BUFFER  A48163 02815721
*                                       CONTROL BLOCK HAS LENGTH        02816121
*                                       OF 16 BYTES                     02818021
ONE      EQU   1                        CONSTANT ONE             S19015 02820521
WDLEN    EQU   4                        FULLWORD LENGTH          S19015 02822421
DWDLEN   EQU   8                        LENGTH OF DOUBLEWORD     A48163 02822800
RAADOFST EQU   8                        RECORD AREA ADDR OFFSET  S19015 02824321
NOT      EQU   X'FF'                    MASK TO TURN OFF BITS    S19015 02826221
*                                                                       02828121
OABD061  EQU   61                                                S21042 02830021
IDTTR     EQU   5                       ID, TTR OF MOD FOR WTGT  XM6327 02830101
         EJECT                                                          02976002
         BALR  RBASE,0                                                  02980000
         USING START,RBASE                                              03000000
         USING IHADCB,RDCB                                              03020000
         USING FORCORE,RCORE                                            03040000
         USING DEB,RDEB                                                 03060000
         USING   TCB,RD                                                 03080000
         USING CVT,RTIOT                                                03100000
         USING UCBOB,RUCB                                               03120000
         USING WTGT,RWTG                                         Y02072 03130002
START    EQU   *                                                        03220000
*                                                                       03230002
         B     BEGIN                    BR AROUND CONSTANTS      Y02072 03232002
         DC    C'IGG0191I'              MOD NAME                 Y02072 03234002
         DC    C'@ZA01495'              LAST SHIP CODE         @ZA01495 03236037
         DC    C'04/30/75'              LAST DATE MODIFIED     @ZA01495 03238037
BEGIN    DS    0H                                               Y02072  03238402
*                                                                       03240000
         USING PARML,RPARC                                              03250002
         L     RDCB,PARDCBAD            GET DCB ADDRESS                 03260002
         L     RCORE,4(RWTGC)           GET WORK AREA                   03280000
         L     RDEB,DCBDEBAD            GET DEB ADDRESS                 03300000
*                                                                       03340000
*        THIS SECTION DETERMINES IF A BUFFER POOL                       03360000
*        MUST BE ACQUIRED BY OPEN < < < < < < < < < < < < <             03380000
*                                                                       03400000
         TM    DCBBUFCB+ADLEN,ONE       BUFCB SPECIFIED          S19015 03402019
         BNO   GETRALEN                 BRANCH TO GET RECORD     A48163 03412000
*                                       AREA ONLY                       03412421
A0015    EQU   *                                                 S19015 03416019
*                                                                       03418019
         SR    RB,RB                   CLEAR REG                        03420000
*                                                                       03440000
         IC    RB,DCBBUFNO              GET BUFFER NUMBER               03460000
*                                                                       03560000
A0010    EQU   *                                                        03580000
         LH    RC,DCBBUFL               GET BUFFER LENGTH EXPECTED      03590021
         LTR   RC,RC                    SPECIFIED                       03620000
         BNZ   A0011                    YES--USE IT            @ZA01495 03640037
*                                                                       03660000
         AH    RC,DCBBLKSI              USE BLOCK SIZE IF THERE         03680000
         BZ   TSOCHK                    BRANCH IF NO BLOCKSIZE   XM5359 03687121
         TM   DCBCIND2,QSAMB            IS IT QSAM               XM5359 03688221
         BO   A0011                     YES,BRANCH              SA52300 03689321
*                                                                       03690421
         TM   DCBDEVT,DCBDSGDA          DIRECT ACCESS DEVICE    ZA01373 03690802
         BNO  A0012                     BRANCH NOT DA DEVICE    ZA01373 03691202
         SR   RD,RD                                                     03691521
         IC   RD,DCBKEYLE               GET KEY LENGTH           XM5359 03692621
         AR   RC,RD                     BUFL EQ KEYLENGTH,BLKSI  XM5359 03693721
         B    A0012                     CONTINUE                 XM5359 03694821
*                                                                       03695921
TSOCHK   EQU  *                                                         03697021
         CLI   DCBDEVT,TERM             CHECK FOR TSO                   03698121
         BNE   DCBERROR                 BRANCH IF NOT                   03699221
*  TSO MODIFICATION - WHEN BLKSI IS NOT SPECIFIED, FOR QSAM, LRECL      03700321
*  IS ASSUMED IF THERE, OTHERWISE, USER'S TERMINAL LINE SIZE IS         03701421
*  ASSUMED, FOR BSAM USER'S TERMINAL LINE SIZE IS ASSUMED.              03702521
*                                                                       03703621
*                                                                       03704721
         TM    DCBCIND2,QSAMODE         TEST IF BSAM OR QSAM            03705821
         BNO   USELNSZ                  BRANCH IF BSAM                  03706921
         AH    RC,DCBLRECL              USE LRECL IF THERE              03708021
         BNZ   A0012                    BRANCH IF LRECL THERE           03709121
USELNSZ  EQU   *                                                        03710221
         USING PSA,0                                             Y02072 03710602
         L     RWK4,PSAAOLD             GET CURRENT ASCB ADDR    Y02072 03711002
         USING ASCB,RWK4                                         Y02072 03731902
         L     RWK3,ASCBTSB             GET TSB POINTER          Y02072 03732002
         DROP  RWK4                                              Y02072 03732102
         MODESET  EXTKEY=TCAM           KEY 6 TO ACCESS TSB      Y02072 03735402
         USING TSBASCBA,RWK3                                     Y02072 03737402
         SR    RC,RC                    CLEAR REGISTER          ZA01275 03744102
         IC    RC,TSBLNSZ               GET TSB LINE SIZE       ZA01275 03747402
         MODESET  EXTKEY=DATAMGT                                 Y02072 03749402
         STH   RC,DCBLRECL              SET LRECL TO LINE SIZE  ZA01275 03750702
*                                                                       03752702
*   THIS CODE WAS COPIED FROM IGG0196K. IT ADJUSTS BLOCKSIZE    SA52300 03754002
*   TO LRECL IF IT IS OUTPUT TO A UR DEVICE AND USES THIS VALUE SA52300 03757302
*   WHEN COMPUTING AMOUNT OF CORE NEEDED FOR A BUFFER POOL.     SA52300 03759302
*                                                                       03759702
A0011    EQU   *                                                SA52300 03760602
         TM    DCBCIND2,QSAMB           IS IT QSAM             @XA01495 03762637
         BNO   A0012                    NO CONTINUE            @XA01495 03763037
         TM    DCBRECFM,DCBRECBR        IS IT BLOCKED FORMAT?   SA52300 03763902
         BZ    A0012                    NO CONTINUE             SA52300 03767202
         TM    DCBDEVT,URBIT            IS IT UNIT RECORD?      SA52300 03770502
         BZ    A0012                    NO CONTINUE             SA52300 03773802
         TM    PAROPT,PAROUTPT          IS IT OUTPUT?           SA52300 03777102
         BZ    A0012                    NO CONTINUE             SA52300 03780402
         DROP  RPARC                                                    03782402
         TM    DCBRECFM,DCBRECU         IS IT UNDEF FORMAT      SA67354 03783702
         BNM   A0012                    YES, LEAVE BLKSIZE      SA67354 03787002
         TM    DCBRECFM,DCBRECV         IS IT VAR FORMAT        SA67354 03789002
         BO    A0011A                   YES, LEAVE BLKSIZE      SA67354 03789402
         LH    RC,DCBLRECL              USE LRECL TO BUILD BFR  SA52300 03790302
         STH   RC,DCBBLKSI              CHANGE BLOCKSIZE        SA52300 03793602
         LH    RC,DCBBUFL               GET BUFFER LENGTH EXPTD@XA01495 03794037
         LTR   RC,RC                    SPECIFIED              @XA01495 03794437
         BNZ   A0011A                   YES - USE IT           @XA01495 03794837
         LH    RC,DCBBLKSI              IF NOT RESTORE LRECL   @XA01495 03795637
A0011A   NI    DCBRECFM,X'FF'-DCBRECBR  TURN OFF BLOCKED BIT    SA52300 03796902
         OI    DCBCIND1,BLKFLG          TELL CLOSE              SA52300 03800202
*                                                                       03803502
*                                                                       03806802
*   RB HAS NO. OF BUFFERS DESIRED                                       03810102
*   RC HAS BUFFER SIZE TO BE SUPPLIED                                   03813402
*                                                                       03816702
*  *                                                                    03820000
*      AN INDICATOR IS BEING SET SO CLOSE KNOWS WHETHER OR NOT TO       03840000
*      FREE THE QSAM BUFFER POOL FOR THE CASE OF CONCATENATION WITH     03860000
*      UNLIKE ATTRIBUTES.  POOL IS NOW FREED AND REOBTAINED EVEN IF     03870020
*      USER SPECIFIES BUFFER LENGTH, SINCE USER HAS NO CHOICE ON DD *   03880020
*                                                                       03900000
*                                                                       03920000
A0012    EQU   *                                                 M4899  03930019
         OI    DCBCIND2,X'08'           SET BUFFER POOL INDICATOR       03940000
         LA    RC,7(0,RC)              ADJUST TO DBL WORD BY ADDING 7   04020000
         SRL   RC,3                    ROUND TO                         04040000
         SLL   RC,3                       DOUBLE WORD                   04060000
*                                                                       04080000
*                                                                       04100000
*                                                                       04120000
         LR    RD,RB                   SAVE LNGTH AND NUMBER            04140000
         LR    RJ,RC                     OF BUFFERS                     04160000
         MR    RD,RD                    COMPUTE LENGTH                  04180000
         LA    RJ,8(0,RJ)              ADD 8 FOR CNTRL BLK              04200000
         TM    DCBBFTEK,DOUBLE         DOUBLE WD. ALIGN.                04220000
         BC    14,A0030                YES, BRANCH              A48163  04240021
*                                                                       04260000
         LA    RJ,8(RJ)                 ADD 8 FOR FW ALIGNMENT          04280021
         OI    FCAOPEN,FCAOXTND         INDIC BCB EXTENDED       Y02072 04290002
*                                                                       04300000
A0030    EQU   *                                                        04320000
         TM    DCBBFTEK,LRECIND         LOGICAL REC INTERFACE   SA56446 04325021
         BNO   GETCORE                  NO,GOTO GETMAIN         SA56446 04335021
*                                                                       04335119
* LOGICAL RECORD INTERFACE TEST PRIOR TO GETMAIN. DETERMINE IF          04335219
* BUFFER CONTROL BLOCK HAS TO BE EXTENDED FOR A RECORD AREA.            04335321
* IF SO, ADD 8 BYTES TO THE BUFFER CONTROL BLOCK LENGTH.                04335721
*                                                                       04335819
         TM    DCBCIND2,QSAMB           QSAM DATA SET           SA56446 04335921
         BNO   DEFAULT                  NO,BR TO TURN OFF BITS  SA56446 04336021
         TM    DCBRECFM,FORMATVS        IS FORMAT VARIABLE       S19015 04336219
*                                       SPANNED                  S19015 04336319
         BNO   DEFAULT                  BRANCH NO TO TURN OFF    S19015 04336419
*                                           LOGICAL RECORD              04336519
*                                           INTERFACE INDICATOR         04336619
         TM    DCBMACRF,LOCATEB         LOCATE MODE              S19015 04336719
         BO    TSTFW                    BRANCH YES TO ADD RA LEN A48163 04336821
         TM    DCBMACRF+ONE,LOCATEB     LOCATE MODE              S19015 04336919
         BNO   DEFAULT                  BRANCH NO TO TURN OFF    S19015 04337019
*                                           LOGICAL RECORD              04337119
*                                           INTERFACE INDICATOR         04337219
TSTFW    EQU   *                                                 A48163 04338400
* LOGICAL RECORD INTERFACE IS SUPPORTED.  DETERMINE IF BUFFER    A48163 04338821
* CONTROL BLOCK MUST BE EXTENDED TO CONTAIN THE RECORD AREA      A48163 04339221
* ADDRESS.                                                              04339621
         TM    DCBBFTEK,DOUBLE          FULL WORD ALIGNMENT             04340021
         BO    GETCORE                  BRANCH YES -- BUFFER     A48163 04340121
*                                       CONTROL BLOCK HAS SPACE  A48163 04340221
*                                       FOR RECORD AREA ADDRESS  A48163 04340321
         LA    RJ,8(RJ)                 ADD 8 BYTES                     04340821
         OI    FCAOPEN,FCAOXTND         INDIC BCB EXTENDED       Y02072 04342402
         B     GETCORE                  GO GET BUFFER POOL SPACE A48163 04342800
*                                                                       04344800
*  LOGICAL RECORD INTERFACE PROCESSING IS NOT SUPPORTED.                04346800
*                                                                       04346921
DEFAULT  NI    DCBBFTEK,NOT-LRECIND     TURN OFF LOGICAL RECORD  A48163 04347221
*                                       INDICATOR                       04347600
GETCORE  EQU   *                                                 S19015 04359621
*                                                                       04360821
         SR    RF,RF                    HOUSEKEEP PARM REG 1.     DM0E  04364421
         SPACE 2                                                        04364502
         MODESET  KEYADDR=DXUKEY,WORKREG=14 GET INTO USER KEY    Y02072 04364802
         SPACE 2                                                        04377202
         GETMAIN R,LV=(15),SP=0                                  Y02072 04378802
         SPACE 2                                                        04402402
         TM    DCBBUFCB+ADLEN,ONE       BUFCB SPECIFIED          S19015 04403019
         BO    GETSTBUF                 NO, GO FORMAT POOL       A48163 04404000
*                                                                       04405019
         L     RJ,DCBBUFCB              YES, GET BUFCB ADDR      S19015 04406000
         OI    FLGOFFST(RJ),RAFLAG      SET FLAG TO INDICATE     S19015 04407019
*                                       RECORD AREA PRESENT             04408000
         ST    RF,RAADOFST(RJ)          STORE RECORD AREA ADDR   S19015 04409019
*                                                                       04410019
         LH    RJ,DCBLRECL              LOAD LRECL IN WORK REG   S19015 04411019
         LA    RJ,CTLINFO(RJ)           ADD 32 BYTES CONTROL     S19015 04412019
*                                       INFO                     S19015 04413019
         ST    RJ,DISPSN(RF)            STORE LRECL IN RECORD    S19015 04414019
*                                       AREA                     S19015 04415019
         XC    WDLEN(CTLINFO-4,RF),WDLEN(RF) CLR CONTROL FLDS  @ZA12970 04423837
*                                       IN RA                    S19015 04427702
         SPACE 2                                                        04429702
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 04430102
         SPACE 2                                                        04430502
         OI    FCAOPEN,FCAORECA         INDIC REC AREA GOTTEN    Y02072 04430902
         B     A0093                    EXIT                     Y02072 04431602
*                                                                       04435502
GETSTBUF EQU   *                                                 S19015 04439402
*                                                                       04443302
         ST    RF,DISPSN(RF)            STORE START ADDRESS      S19015 04447202
*                                       DM0E                     S19015 04451102
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 04455002
         STCM  RWK2,B'0111',DCBBUFCA    BCB ADDR TO DCB          Y02072 04457002
         MODESET  KEYADDR=DXUKEY,WORKREG=14 GET INTO USER KEY    Y02072 04459002
*                                                                       04460000
         STH   RB,4(0,RF)              STORE NO.OF BUF. IN BCB          04480000
         STH   RC,6(0,RF)              STORE LNGTH OF BUF. IN BCB       04500000
         SPACE 2                                                        04520002
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 04530002
         SPACE 2                                                        04532002
         OI    FCAOPEN,FCAOBUF          INDIC BUFFERS GOTTEN     Y02072 04534002
         SPACE 2                                                        04536002
         MODESET  KEYADDR=DXUKEY,WORKREG=14  BACK TO USER KEY    Y02072 04538002
         SPACE 2                                                        04538402
         LR    RUCB,RF                  GET ADDRESS IN WRK REG          04540000
         LA    RUCB,DWDLEN(0,RUCB)      GET ADDR +8 TO POINT TO         04540400
*                                       FIRST AVAILABLE BUFFER          04540800
* DETERMINE IF BUFFER CONTROL BLOCK IS EXTENDED.  IF SO, SET FLAGS      04542200
* AND UPDATE POINTER TO FIRST BUFFER.                                   04542400
         TM    DCBBFTEK,DOUBLE          FULL WORD ALIGNMENT      A48163 04543000
         BZ    TSTLRI                   NO, TEST LRI             A48163 04543200
         LA    RUCB,WDLEN(0,RUCB)       YES, OFFSET ADDR TO FW   A48163 04543400
         B     EXTEND                   GO SET EXTEND FLAG       A48163 04543600
TSTLRI   TM    DCBBFTEK,LRECIND         LRI SUPPORTED            A48163 04543900
         BNO   ALIGNED                  NO, BRANCH TO SAVE FIRST A48163 04544100
*                                       BUFFER ADDRESS                  04548500
         LA    RUCB,DWDLEN(0,RUCB)      YES, OFFSET TO NEXT DW   A48163 04551900
*                                                                       04554500
EXTEND   OI    FLGOFFST(RF),EXTND       SET FLAG TO INDICATE     A48163 04555721
*                                       BUFFER CONTROL BLOCK EXTENDED   04555800
*                                                                       04580000
*        THE NEXT SEQUENCE OF INSTRUCTIONS BUILDS A BUFFER POOL         04600000
*                                                                       04655019
ALIGNED  EQU   *                                                 S19015 04774019
*                                                                       04776019
         ST    RUCB,0(0,RF)             STORE BUFFER ADDRESS            04780000
         LR    RF,RUCB                  SAVE NEXT BUFF. ADDR            04800021
*                                                                       04820000
A0050    EQU   *                                                        04840000
         BCT   RB,A0060                 IF MORE, BRANCH          A48163 04842021
         B     SETLAST                  EXIT                     A48163 04844021
A0060    EQU   *                                                        04846021
         ALR   RUCB,RC                  UPDATE TO NEXT BUFFER           04850000
         ST    RUCB,0(RF)               STORE POINTER                   04852000
         ALR   RF,RC                    BUFFER LEN + BUFFER ADDR A48163 04854000
         B     A0050                    IF MORE BRANCH                  04860021
*                                                                       04889619
SETLAST  EQU   *                                                 S19015 04898619
         ST    RB,0(0,RF)               LAST LINK TO ZERO               04900000
         TM    DCBBFTEK,LRECIND         RECORD AREA NEEDED              04910000
         BNO   A0090                    NO,EXIT                         04920000
         L     RJ,DCBBUFCB              GET BUFFER CONTROL BLOCK A48163 04930000
         TM    FLGOFFST(RJ),EXTND       SPACE FOR RECORD AREA    A48163 04932000
*                                       ADDR AVAILABLE                  04934000
         BNO   A00100                   N0, ABEND                Y02072 04936002
*                                                                       04938000
GETRALEN EQU   *                                                        04938400
         LH    RJ,DCBLRECL              LOAD LRECL IN WORK REG   A48163 04938821
         LA    RJ,CTLINFO(RJ)           ADD 32 BYTES FOR CONTROL A48163 04939221
*                                       INFORMATION                     04939600
         B     GETCORE                  GO GET SPACE FOR RECORD  YM1262 04939702
*                                       AREA                            05030002
*                                                                       05075002
A0090    EQU   *                                                        05120000
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 05180002
         USING WTGENTRY,RWTGC                                    Y02072 05190002
A0093    MVC   WTGIDTTR,LOAD3I       NEXT MODS ID TO WTG TAB   @Z30TSCF 05200003
RELOOP   EQU   *                                                        06780000
         LA    RWTGC,WGOFF(0,RWTGC)     INCREMENT CURRENT WTG ENTRY     06800000
         LA    RPARC,PLOFF(0,RPARC)    INCR CURRENT DCB ENTRY PTR       06820000
         CLC   0(2,RWTGC),AMIDCNST      THIS RT NEEDED AGAIN            06840000
         BCR   8,RBASE                 RETURN TO INITIALIZE ANOTHER DCB 06860000
*                                                                       06880000
         CLC   0(2,RWTGC),OPIDCNST      END OF TABLE                    06900000
         BC    7,RELOOP                 NO, CHECK NEXT ENTRY            06920000
*                                                                       06940000
         LR    RPARC,RPAR                                               06960000
         LA    RWTGC,WAOFF(0,RWTG)     REINITIALIZE WTG LIST PTR        06980000
ZCHEK    CLI   0(RWTGC),X'00'          IS THIS ENTRY COMPLETE           07000000
         BC    7,TCTLRTN           IF NOT TRANSFER CONTROL              07020000
*                                                                       07040000
         LA    RWTGC,WGOFF(0,RWTGC)    GET NEXT ENTRY                   07060000
         LA    RPARC,PLOFF(0,RPARC)                                     07080000
         BC    15,ZCHEK                                                 07100000
A00100   EQU   *                                                        07410002
         SPACE 3                                                        07410102
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 07410402
         SPACE 3                                                        07412402
DCBERROR EQU   *                                                        07420000
*                                                                       07440000
         OI    DCBOFLGS,X'90'           TURN ON WRITE,OPEN BITS   10929 07450015
         DMABCOND OABD061,PDLOAD,RETURN=NONE,RES=NO,REGSAVE=YES  S21042X07460021
                                        CALL PROBLEM DETERMINATION      07470021
TCTLRTN  EQU   *                                                 S20201 07582020
         USING WTG,RWTG                                                 07584003
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSCF*07586003
               MODID=WTGENTRY                                  @Z30TSCF 07588003
         DROP  RWTGC,RWTG                                      @Z30TSCF 07590003
*                                                                       07591020
WAOFF    EQU   32                  OFFSET OF FIRST ENTRY IN WTG TABLE   07600000
PLOFF    EQU   4                   OFFSET OF DCB ENTRIES                07620000
WGOFF    EQU   8                   OFFSET OF WTG ENTRIES                07640000
OPIDCNST DC    C'0S'                                                    07660000
AMIDCNST DC    C'1I'                    THIS ROUTINE ID                 07680000
LOAD3I   DC    C'3I',VL3(IGG0193I)      NEXT MODS ID           @Z30TSCF 07730003
PDLOAD   DC    C'6M',VL3(IGG0196M)      PROB DETER             @Z30TSCF 07732003
         SPACE 2                                                        07742002
PATCH    DC    0H'0',50X'00'            PATCH AREA               Y02072 07782002
END      EQU   *                        END OF MODULE            Y02072 07832002
         EJECT                                                          07882002
         IGGPARML                                                       07932002
         EJECT                                                          08022002
         IHAPSA                                                  Y02072 08032002
         EJECT                                                          08064002
         IGGBCB  TYPE=SAM                                        Y02072 08070002
         EJECT                                                          08120002
         IKJTCB                                                , S20016 08123020
           DCBD  DSORG=PS                                               08140000
*                                                                       08160000
*                                                                       08180000
         IECDSECS MAIN,WTG,PREFX,EXPAND=YES                    @Z30TSCF 08210003
         ORG   WTGIDTTR                                          Y02072 08220002
WTGID    DS    CL2                      NEXT MOD ID              Y02072 08230002
         EJECT                                                          08230402
FORCORE  DSECT                                                   Y02072 08232002
         IHAFCAUD  ORG=YES                                       Y02072 08234002
         EJECT                                                          08244002
*   TASK CONTROL BLOCK                                                  08260000
TIOT     DSECT                                                          08700000
TIOELNGH DS    CL1                           LENGTH OF THIS ENTRY       08720000
TIOESTTA DS    CL1                           STATUS -A-                 08740000
TIOERLOC DS    CL2                           REL. LOC OF POOL           08760000
TIOEDDNM DS    2F                            DDNAME                     08780000
TIOEJFCB DS    1F                            JFCB DISK ADDR             08800000
TIOESTTB DS    0CL1                                                     08820000
TIOEFSRT DS    CL4                                                      08840000
         DS    CL1                                                      08860000
*        TIOT POOL ENTRY                                                08880000
TIOPNSLT DS    XL1                           NR.OF SLOTS FOR POOL       08900000
         DS    CL1                                                      08920000
TIOPNSRT DS    XL1                           NR.OF DEVICES (FILLED      08940000
*                                             SLOTS)                    08960000
TIOPPOOL DS    CL8                           POOL NAME                  08980000
TIOPSTTB DS    XL1                           STATUS OF SLOT             09000000
TIOPSLOT DS    XL3                           SRT ADDRESS OR EMPTY SLOT  09020000
TIOTFEND DS    1F                            FINAL END OF AN ENTRY      09040000
         SPACE 1                                                        09060000
SRT      DSECT                                                          09080000
         IEFUCBOB                                                       09100000
*   DATA EXTENT BLOCK  (UNTIL PROTIOS CHANGES)                          09120000
DEB      DSECT                                                          09140000
DEBNMSUB DS    0CL1                                                     09160000
DEBTCBAD DS    CL4                                                      09180000
DEBAMLNG DS    0CL1                                                     09200000
DEBDEBAD DS    CL4                                                      09220000
DEBOFLGS DS    0CL1                                                     09240000
DEBIRBAD DS    CL4                                                      09260000
DEBOPATB DS    0CL1                                                     09280000
DEBSYSPG DS    CL4                                                      09300000
DEBNMEXT DS    0CL1                                                     09320000
DEBUSRPG DS    CL4                                                      09340000
DEBPRIOR DS    0CL1                                                     09360000
DEBECBAD DS    CL4                                                      09380000
DEBPROTG DS    0CL1                                                     09400000
DEBDEBID DS    0CL1                                                     09420000
DEBDCBAD DS    CL4                                                      09440000
DEBEXSCL DS    0CL1                                                     09460000
DEBAPPAD DS    CL4                                                      09480000
DEBDVMOD DS    0CL1                                                     09500000
DEBUCBAD DS    CL4                                                      09520000
DEBTVLSQ DS    0CL2                VOL SEQ FOR TAPE                     09540000
DEBBINUM DS    CL2                                                      09560000
DEBTVLNM DS    0CL2                NO OF VOL FOR TAPE                   09580000
DEBSTRCC DS    CL2                                                      09600000
DEBSTRHH DS    CL2                                                      09620000
DEBENDCC DS    CL2                                                      09640000
DEBENDHH DS    CL2                                                      09660000
DEBNMTRK DS    CL2                                                      09680000
*  FOR ADDITIONAL EXTENT ON DIRECT ACCESS THE FOLLOWING FIELDS          09700000
*  WILL HAVE TO BE OFFSET ANOTHER 16 BYTES                              09720000
DEBVOLSQ DS    H                                                        09740000
DEBVOLNM DS    H                                                        09760000
*  FOR EACH SUBROUTINE LOADED BUMP THIS OFFSET BY 2                     09780000
DEBSUBID DS    H                                                        09800000
CVT      DSECT                                                          09820000
         CVT                                                            09840000
         SPACE 3                                                        11940020
         IEZJSCB                                                        12640020
         SPACE 3                                                        14740020
         IKJTSB                                                         15440020
         SPACE 3                                                        15490002
         IHAASCB                                                 Y02072 15540002
         SPACE 3                                                        15590002
WTGT     DSECT                                                   Y02072 16840002
XCTMODNM DS    CL8                      MODULE NAME              S20201 23840020
         DS    CL6                      *                        S20201 30840020
XCTTTR   DS    CL3                      TTR                      S20201 37840020
         DS    CL5                      *                        S20201 44840020
XCTATTRB DS    CL2                      ATTRIBUTES               S20201 51840020
XCTMODSZ DS    CL3                      MAIN STORAGE REQUIRED    S20201 58840020
XCTTXTLN DS    CL2                      LENGTH OF FIRST TEXT REC S20201 65840020
XWTGLENG DS    C                        *                        S20201 72840020
XWTGPATH DS    CL2                      *                        S20201 79840020
         END                                                            86840020
