  TITLE  'IGG0191J - BSAM, STAGE 2 OPEN EXEC, DIRECT ACCESS, OUTIN,    ,00021402
               INOUT'                                                   00021802
IGG0191J CSECT                                                          00021903
*MODULE NAME - IGG0191J                                          Y02072 00022202
*                                                                       00022602
*DESCRIPTIVE NAME - BUILD IOBS                                   Y02072 00022702
*                                                                       00022802
*COPYRIGHT - NONE                                                Y02072 00022902
*                                                                       00025002
*CHANGE ACTIVITY - AS FOLLOWS:                                   Y02072 00027002
*                                                                       00027402
*          VS2 RELEASE 2 DELETIONS                               Y02072 00027502
*000430,037400,037600,037800-038000,039860-040040,041360,        Y02072 00029602
*041420,041850,042650,042700,042750,045400,053690,055690,        Y02072 00031702
*056690,086000,086100,086105-086185,085300,57190,62800,          Y02072 00033802
*63800,86100                                                     Y02072 00043802
*                                                                YM4697 00045802
*                                                                YA3136 00046202
*                                                                       00046303
*          VS2 RELEASE 3 DELETIONS                                      00049403
*                                                              @Z30TSCF 00051403
*          RELEASE 20 DELETIONS                                       * 00053503
*0973012800,016400,017200-018800,020400-021600,024200-025400,    S20201 00056603
*0973026400-027000,029400,030200-037200,037600,038800-041400,    S20201 00059703
*0973042200,043600-048400,050000-054200,055400-055800,056600-    S20201 00062803
*0973057000,059200,063400,066800,071000,071400,073000,079000-    S20201 00065903
*0973083200                                                      S20201 00069003
*          RELEASE 21 DELETIONS                                       * 00072103
*0082041400,042700,055190,089010-089160                          A37507 00075203
*0082041390-044400,056190,084800-085800                          M0081  00078303
*                                                                A37507 00081403
* STATUS CHANGE LEVEL 009                                               00084503
*                                                                       00087603
*   THIS MODULE WAS SPLIT INTO IGG0196L FOR REL 21.                     00090703
*FUNCTION/OPERATION: THIS ROUTINE WILL GET CORE(GETMAIN) TO SET UP THE  00093803
*      NECESSARY IOB'S. IT WILL CLEAR THE CORE AND LINK THE IOB'S       00096903
*      TOGETHER.(DIRECT ACCESS)                                         00100000
*      IT SETS CODES  IN THE DCBCNTRL FIELD OF THE DCB. IT WILL         00110021
*      CONSTRUCT - THE SET SECTOR COMMAND (MERLIN/ZEUS)                 00120021
*                - THE SEARCH COMMAND                                   00130021
*                - THE TIC BACK TO SEARCH COMMAND                       00140021
*                - THE READ COMMANDS                                    00150021
*      IT SETS AN AUDIT TRAIL BIT IN THE OPEN WORKAREA           Y02072 00152002
*      INDICATING TO FORCE CLOSE THAT THE CORE GETMAINED FOR     Y02072 00154002
*      THE IOB'S CAN BE FREEMAINED.                              Y02072 00156002
*      IT THEN XCTL'S TO IGG0196L FOR COMPLETION OF THE IOB'S           00160021
*                                                                       00220000
*ENTRY POINTS:  IGG0191J BY XCTL FROM IGG0193I OR IGG0196B.             00230021
*                                                                       00260000
*INPUT: SEE DESCRIPTION OF REGISTERS, DCB(USERS).                       00280000
*                                                                       00300000
*OUTPUT: SEE DESCRIPTION OF REGISTERS, DCB(USERS), IOB(USERS).          00320000
*                                                                       00330002
*MACROS - ACTION : MODESET, GETMAIN, XCTL, XCTLTABL              Y02072 00332002
*                                                                       00334002
*MACROS - MAPPING : IECDSECS, DCBD, IEZIOB, IECDSECT, IHAFCAUD   Y02072 00336002
*                                                                       00340000
*EXTERNAL ROUTINES : NONE                                               00360000
*                                                                       00380000
*EXITS-NORMAL: XCTL TO IGG0196L                                         00400021
*                                                                       00420000
*EXITS-ERROR: NONE                                                      00440000
*                                                                       00460000
*TABLES/WORKAREAS: DUPE WTG TABLE************************************** 00480000
*      SEE DEVICETB DSECT.                                              00500000
*                                                                       00520000
*ATTRIBUTES: REENTRANT, REUSABLE, SUPERVISOR STATE,              Y02072 00540002
*            RUNS IN USER KEY UNLESS OTHERWISE SPECIFIED.        Y02072 00550002
*                                                                       00560000
* NOTES- THIS EXECUTOR DEALS WITH DIRECT ACCESS FOR IN/OUT - OUT/IN.    00580000
*                                                                       00600000
         SPACE 1                                                        00620000
*                                                                       00640000
*                                                                     * 00660000
*    2841  OP  CODES                                                  * 00680000
*                                                                     * 00700000
TIC      EQU   X'08'          TIC OP CODE                               00740000
WRTCK    EQU   X'80'                                                    00760000
SRCHE    EQU   X'31'          SEARCH OP CODE                            00780000
READATA  EQU   X'86'          READ DATA CCW                             00820000
READKEDA EQU   X'8E'                    READ KEY AND DATA OP CODE       00840000
READCOUN EQU   X'92'          READ COUNT OP CODE                        00860000
SETSC    EQU   X'23'                    SET SECTOR COMMAND       S20201 00885020
VFORMAT  EQU   X'40'                    MASK FOR V FORMAT        S20201 00895020
*                                                                     * 00900000
*********************************************************************** 00920000
*                                                                     * 00940000
*    CCW  CONSTRUCTION  EQUATES                                       * 00960000
*                                                                     * 00980000
SILI     EQU   X'20'                   SILI FLAG                        01020000
CMDSKPSL EQU   X'70'                    COMMAND SKIP AND SILI           01040000
COMSILI  EQU   X'60'         COMMAND AND SILI                           01060000
COMCHAIN EQU   X'40'          COMMAND CHAIN BIT                         01120000
ONE      EQU   1                                                        01180000
FIVE     EQU   5                                                        01220000
ATE8     EQU   8                                                        01260000
CC       EQU   X'40'                    COMMAND CHAIN            S20201 01280020
*********************************************************************** 01300000
*                                                                     * 01320000
*    MISC  EQUATES                                                    * 01340000
*                                                                     * 01360000
MINKEY   EQU   X'01'                                                    01380000
UFORMAT  EQU   X'C0'                    U  FORMAT TEST  MASK            01440000
BWCHP    EQU   4                        BASIC WRITE CHP LENGTH   S20201 01602020
BIOB     EQU   16                       BASIC IOB LENGTH         S20201 01604020
MAX      EQU   256                      MAX VALUE FOR LENGTH FLD S20201 01606020
NOERR    EQU   X'7F'                    ECB INDICATION OF NO     S20201 01608020
*                                       ERROR                    S20201 01610020
NONCARN  EQU   X'20'                    NO DISCONNECT USED       S20201 01612020
SDOPT    EQU   X'08'                    SEARCH DIRECT OPTION     S20201 01614020
*                                       BYTE                     S20201 01616020
UNRELFLG EQU   X'02'                   IOB UNRELATED FLG         A37507 01618021
*********************************************************************** 01620000
*                                                                       01621020
* DISPLACEMENTS AS EQUATES                                              01622020
*                                                                       01623020
D0       EQU   0                        DISPLACEMENT OF ZERO     S20201 01624020
D1       EQU   1                        DISPLACEMENT OF ONE      S20201 01625020
D2       EQU   2                        DISPLACEMENT OF TWO      S20201 01626020
D3       EQU   3                        DISPLACEMENT OF THREE    S20201 01627020
D4       EQU   4                        DISPLACEMENT OF FULLWORD S20201 01628020
D5       EQU   5                        DISPLACEMENT OF FIVE     S20201 01629020
D6       EQU   6                        DISPLACEMENT OF SIX      S20201 01630020
D8       EQU   8                        DISPLACEMENT OF DW       S20201 01632020
D12      EQU   12                       DISPLACEMENT OF THREE    S20201 01633020
*                                       WORDS                    S20201 01634020
D15      EQU   15                       DISPLACEMENT OF FIFTEEN  S20201 01635020
D24      EQU   24                       DISPLACEMENT OF SIX      S20201 01638020
*                                       WORDS                    S20201 01639020
D40      EQU   40                       DISPLACEMENT OF TEN      S20201 01640020
*                                       WORDS                    S20201 01641020
D43      EQU   43                       DISPLACEMENT OF CCHHR    S20201 01642020
*                                       IOB                      S20201 01643020
D44      EQU   44                       DISPLACEMENT OF CP PTR   S20201 01644020
FLAGOFF  EQU   4                        CCW FLAG OFFSET          S20201 01645020
CNTOFF   EQU   7                        CCW COUNT OFFSET         S20201 01646020
*********************************************************************** 01660000
*********************************************************************** 01680000
*                                                                       01700000
*                                                                       01750020
* REGISTER CONVENTIONS USED THROUGHOUT ALL OPEN PASSES                  01800020
*                                                                       01850020
*                                                                       01900000
*********************************************************************** 01920000
*                                                                       01940000
RE       EQU   0                                                        01960000
RF       EQU   1                        WORK REG ONE             S20201 01963020
RWK1     EQU   RF                      WORK REGISTER             Y02072 01965002
RDCB     EQU   2                        DCB REGISTER             S20201 01966020
RBASE    EQU   3                        BASE REGISTER            S20201 01969020
RCORE    EQU   4                        WORK AREA ADDR           S20201 01972020
RWTG     EQU   6                                                        01980000
RPARC    EQU   7                        CURRENT PARAMETER        S20201 01990020
*                                                                       02000000
RWTGC    EQU   8                                                        02020000
RWK2     EQU   9                       WORK REGISTER             Y02072 02070002
RUCB     EQU   10                       ADDRESS OF UCB           S20201 02100020
RDEB     EQU   11                       ADDRESS OF DEB           S20201 02140020
RB       EQU   12 2                                                     02180000
RWK3     EQU   RB                      WORK REGISTER             Y02072 02190002
RC       EQU   13 3                                                     02200000
RD       EQU   14 4                                                     02220000
RJ       EQU   15 5                                                     02240000
*                                                                       02260000
*                                                                       02280000
*********************************************************************** 02300000
*                                                                       02320000
*********************************************************************** 02340000
*                                                                       02360000
*                                                                       02380000
         USING SOP810,RBASE                                      S20201 02410020
         USING IHADCB,RDCB              REG 2 IS DCB             S20201 02420020
         USING FORCORE,RCORE            REG 4 IS WORK AREA ADDR  S20201 02430020
         BALR  RBASE,RE                 REG 3 IS BASE   RE=0     S20201 02440020
*                                                                       02450020
SOP810   EQU   *                                                 S20201 02460020
*                                                                       02470020
         B     BEGIN                    BR AROUND CONSTANTS      Y02072 02472002
         DC    C'IGG0191J'              MODULE NAME              Y02072 02474002
         DC    C'@Z30TSCF'              LAST SHIP CODE         @Z30TSCF 02476003
         DC    C'10/18/74'              LAST DATE MODIFIED     @Z30TSCF 02478003
BEGIN    DS    0H                                                Y02072 02478402
         L     RDCB,D0(RPARC)           GET DCB ADDR             S20201 02480020
         LA    RDCB,D0(RDCB)            CLEAR HI BYTE            S20201 02490020
         L     RCORE,D4(RWTGC)          GET WORK AREA ADDR       S20201 02500020
*                                                                       02560000
*                                                                       02580000
*                                                                       02600000
*                                                                       02620000
         SR    RD,RD                                                    02720000
         ST    RD,DCBCNTRL              CLEAR CONTROL            S20201 02730020
         NI    DCBCIND2,X'FE'           TURN OFF QSAM BIT IF ON         02740000
         MVI   DCBCNTRL+3,2             READ EOB RT ID                  02760000
         MVI   DCBCNTRL+2,1             ID OF WRT EOB RT.               02780000
         TM    DCBMACRF,X'04'           NOTE POINT USED                 02800000
         BC    1,SOP810A                YES BRANCH                      02820000
         TM    DCBMACRF+1,X'04'                                         02840000
         BC    14,SOP810B               NO BRANCH                       02860000
SOP810A  EQU   *                                                        02880000
         MVI   DCBCNTRL+1,5             NPDT ID NO.                     02900000
SOP810B  EQU   *                                                        02920000
         LA    RC,BIOB                  BASIC IOB SIZE           S20201 02930020
         LA    RD,BWCHP                 BASIC WRT CHP SIZE       S20201 02940020
*                                                                       02950020
*                                                                       02960000
*                                                                       02980000
*                                  BSAM USED                            03000000
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O          S20201 03010020
*                                       DISCONNECT               S20201 03020020
         BO    SOP811                   BRANCH IF YES            S20201 03030020
         LA    RC,D5(RC)                INCREMENT FOR 5 CCW      S20201 03040020
         LA    RD,D2(RD)                INCREMENT FOR 2 CCW      S20201 03050020
*                                                                       03060020
*                                                                       03070020
SOP811   EQU   *                                                 S20201 03080020
         TM    DCBOPTCD,WRTCK           WRITE CHK USED           S20201 03090020
         BNO   SOP815                   BRANCH IF NO             S20201 03100020
         LA    RC,D3(RC)                INCREMENT FOR 3 CCW      S20201 03110020
         LA    RD,D3(RD)                INCREMENT FOR 3 CCW      S20201 03120020
*                                                                       03140020
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O          S20201 03150020
*                                       DISCONNECT               S20201 03160020
         BO    SOP815                   BRANCH IF YES            S20201 03170020
         LA    RC,D1(RC)                IOB+1 DW                 S20201 03180020
         LA    RD,D1(RD)                WRT CHP +1  DW           S20201 03190020
SOP815   EQU   *                                                 S20201 03200020
*                                                                       03210020
         TM    JFCBMASK+D6,SDOPT       SEARCH DIRECT USED        S20201 03220020
         BZ    SOP816                   BRANCH IF NO             S20201 03230020
*                                       SD                       S20201 03240020
         LA    RC,D2(RC)                INCREMENT FOR TWO CCWS   S20201 03250020
SOP816   EQU   *                                                 S20201 03260020
*                                                                       03270020
* STORE DW LENGTHS THEN CALCULATE  IOB SIZE TIMES NO. OF IOBS           03280020
*                                                                       03290020
         STC   RC,DCBIOBL               IOB LENGTH               S20201 03300020
         STC   RD,DCBWCPL               WRITE CHP LENGTH         S20201 03310020
*                                                                       03320020
         SR    RUCB,RUCB                CLEAR REG                S20201 03330020
         IC    RUCB,DCBNCP              GET NO. OF CHPS          S20201 03340020
         LTR   RUCB,RUCB                BEEN SPECIFIED           S20201 03350020
         BNZ   SOP817                   BRANCH IF SPECIFIED      S20201 03360020
         LA    RUCB,ONE                 FURNISH ONE IF NOT       S20201 03370020
SOP817   EQU   *                                                 S20201 03380020
         LA    RDEB,ATE8                CONSTANT OF EIGHT        S20201 03390020
         MR    RB,RDEB                  IOB DW SIZE TIMES  8     S20201 03400020
         LR    RE,RC                    KEEP SIZE                S20201 03410020
         MR    RB,RUCB                  SIZE TIMES NO. OF IOBS   S20201 03420020
*                                                                       03430020
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O          S20201 03440020
*                                       DISCONNENT               S20201 03450020
         BO    SOP821                   BRANCH IF YES            S20201 03460020
         LA    RC,D8(RC)                INCREMENT 1 DW           S20201 03470020
SOP821   EQU   *                                                 S20201 03480020
         LR    RB,RC                    SAVE AMOUNT              S20201 03490020
         LR    RDEB,RE                  SAVE IOB SIZE            S20201 03500020
*                                                                       03550002
*  THE FOLLOWING SAVES THE AMOUNT OF CORE GETMAINED FOR THE IOBS YM4697 03560002
*  IN THE FORCE CLOSE AUDIT TRAIL FOR THE FORCE CLOSE EXECUTOR.  YM4697 03570002
*                                                                       03580002
         ST    RC,DXATEXC2              SAVE LENGTH              YM4697 03590002
         MODESET  KEYADDR=DXUKEY,WORKREG=9 GET INTO USER KEY     Y02072 03600002
*                                                                       03650002
         GETMAIN R,LV=(RC),SP=0                                  Y02072 03760002
*                                                                       03810002
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 03823202
*                                                                       03828802
*********************************************************************** 03834402
* THE FOLLOWING CODE WILL CLEAR STORAGE RECEIVED FROM GETMAIN           03840000
*                                                                       03860000
         ST    RF,DCBIOBA               ADDR IOB TO DCB          S20201 03878020
         OI    FCAOPEN,FCAOIOB          INDIC IOB'S CAN BE FREED Y02072 03880002
         LR    RD,RF                    COPY ADDRESS USE TO CLR  S20201 03887020
         LR    RE,RDEB                  RESTORE IOB SIZE         S20201 03896020
         LA    RDEB,ATE8                CONSTANT OF EIGHT        S20201 03905020
*                                                                       03914020
* SET UP THETA ADDRS, MAY BE USED LATER                                 03923020
*                                                                       03932020
         LR    RJ,RB                    COPY AMOUNT              S20201 03941020
         AR    RJ,RF                    GET AREA +1 ADDR         S20201 03950020
         SR    RJ,RDEB                  SUB 1 DW                 S20201 03959020
         ST    RJ,DXCCW11               TEMP STORE SET THETA     S20201 03968020
*                                       ADDR                     S20201 03977020
*                                                                       04013020
* CLEAR CORE HERE     RB=AMT    RD=ADDR                                 04022020
*                                                                       04031020
         MODESET  KEYADDR=DXUKEY,WORKREG=9 GET INTO USER KEY     Y02072 04031402
         LA    RJ,MAX                   CONSTANT OF 256          S20201 04040020
         B     CLEAR                    GO AROUND EXEC MODELS    S20201 04049020
SOP8LO   XC    D0(ONE,RD),D0(RD)        CLEARS REMAINIG BYTES    S20201 04058020
SOP8HI   XC    D0(MAX,RD),D0(RD)        CLEARS 256 BYTES         S20201 04067020
         AR    RD,RJ                    ADD 256 TO ADDR          S20201 04076020
CLEAR    SR    RB,RJ                    SUB 256 FROM AMT         S20201 04085020
         BH    SOP8HI                   IF AMT GT 256 BRANCH     S20201 04094020
         AR    RB,RJ                    CORRECT AMT              S20201 04103020
         BCTR  RB,RE                    REDUCE BY ONE BYTE       S20201 04112020
         EX    RB,SOP8LO                CLEAR REMAINING BYTES    S20201 04121020
         LR    RB,RF                    COPY ADDR                S20201 04130020
         USING IOBQSAMN,RF             USE IOB PREFIX DSECT      Y02072 04136002
         ST    RB,IOBNIOBA             STORE FIRST IOB ADDR IN   Y02072 04142002
*                                      FIRST IOB FOR THE CASE    M0081  04150021
*                                      OF ONE IOB - INSTRUCTION  M0081  04160021
*                                      UNNECESSARY IF MORE THAN  M0081  04170021
*                                      ONE IOB                   M0081  04180021
         DROP  RF                                                Y02072 04185002
         B     SOP830                  BYPASS LINKING IOB'S      M0081  04190021
*                                                                       04200021
*      BEGIN LOOP TO CONSTRUCT IOB'S                                    04210021
*                                                                       04220021
SOP829   EQU   *                                                 M0081  04230021
         LR    RB,RF                    GET POINTER TO LAST      M0081  04240021
*                                        IOB BUILT               M0081  04250021
         AR    RB,RE                   NEXT IOB TO BE BUILT      M0081  04260021
         USING IOBQSAMN,RF             ADDRESSABILITY FOR DSECT  Y02072 04265002
         ST    RB,IOBNIOBA             LINK IOB'S                Y02072 04270002
         DROP  RF                                                Y02072 04275002
         LR    RF,RB                   NEXT IOB TO BE BUILT      M0081  04280021
SOP830   EQU   *                       COME HERE IF FIRST IOB    M0081  04290021
         LA    RB,D4(RB)                PT TO ECB                S20201 04460020
         ST    RB,D12(RF)               PUT PTR IN IOB           S20201 04480020
         MVI   D0(RB),NOERR             INDICATE COMP NO ERROR   S20201 04500020
*                                                                       04520020
         L     RWK2,DXUDCBAD           GET USERS DCB ADDRESS     Y02072 04530002
         USING IOBNECB,RB                                        Y02072 04540002
         ST    RWK2,IOBDCBPT           DCB ADDR TO IOB           Y02072 04550002
         DROP  RB                                                Y02072 04552002
         LA    RB,D44(RB)               PT TO CHP STARTAD        S20201 04560020
         ST    RB,D24(RF)               PUT ADDR IN IOB          S20201 04580020
         MVC   D40(ATE8,RF),DCBFDAD     INITIALIZE IOBFDAD       S20201 04600020
*                                                                       04620020
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O          S20201 04640020
*                                       DISCONNECT               S20201 04660020
         BO    SOP831                   BRANCH IF YES            S20201 04680020
         BAL   RD,SOP8STA               IF NO GO BUILD SET CMND  S20201 04700020
*                                                                       04720020
* UPON RETURN SET UP TO BUILD SRCH CMND AND GO BUILD IT                 04740020
*                                                                       04760020
SOP831   EQU   *                                                 S20201 04780020
         LA    RC,D43(RF)               GET PTR TO CCHHR         S20201 04800020
         BAL   RD,SOP8SRTC              GO BUILD SRCH AND TIC    S20201 04820020
*                                                                       04860000
*    THE 'SEARCH AND TIC CCWS  HAVE NOW BEEN CONSTRUCTED.               04880000
*                                                                       04900000
*                                                                       04920000
         LA    RB,16(0,RB)              WRITE CCW POINTER               04960000
*                                                                       04980000
         LA    RC,D43(RF)               PT TO CCHHR              S20201 04983020
         AR    RC,RE                    NOW INCREMENT TO NEXT    S20201 04986020
*                                       IOB                      S20201 04989020
         CH    RUCB,CON1                IS THIS THE LAST IOB     S20201 04992020
         BNE   SOP832A                  BRANCH IF NO             S20201 04995020
         L     RC,DCBIOBA               GET FIRST IOB ADDR       S20201 04998020
         LA    RC,D43(RC)               PT TO CCHHR              S20201 05001020
SOP832A  EQU   *                                                 S20201 05004020
         CLI   DCBNCP,ONE               ONLY ONE IOB             S20201 05007020
         BH    SOP833                   BRANCH IF MORE           S20201 05010020
         L     RDCB,DXUDCBAD           GET USERS DCB ADDR        Y02072 05012002
         LA    RC,DCBFDAD+D3            IF NOT PT TO IOB CCHHR   S20201 05013020
         L     RDCB,0(RPARC)           GET PROTECTED COPY AGAIN  Y02072 05015002
SOP833   EQU   *                                                 S20201 05016020
         BAL   RD,SOP8READ              GO BUILD READ CCWS       S20201 05019020
         BCT   RUCB,SOP829                                              05319021
         USING IOBQSAMN,RF             ADDRESSABILITY FOR DSECT  Y02072 05369002
         MVC   IOBNIOBB,DCBIOBA+1      LINK LAST TO FIRST        A37507 05419021
         CLI   DCBNCP,ONE              ONE IOB?                  A37507 05469021
         BNE   NTONEIOB                NO - BRANCH               A37507 05519021
         OI    IOBFLAG1,IOBUNREL       YES - SET UNREL FLG       Y02072 05569002
NTONEIOB EQU   *                                                 A37507 05619021
         DROP  RF                                                Y02072 05669002
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 05671002
         USING WTGENTRY,RWTGC                                    Y02072 05681002
         MVC   WTGIDTTR,MOD196L         NEXT MOD               @Z30TSCF 05691003
         LR    RSTART,RBASE             RESTORE BASE REG         S20201 05920020
*                                                                       05940000
RELOOP   LA    RCWG,WGOFF(0,RCWG)      INCREMENT CURR WTG ENTRY         05960000
         LA    RCPL,PLOFF(0,RCPL)      INCR CURRENT DCB ENTRY POINTER   05980000
         CLC   0(2,RCWG),AMIDCNST      THIS RT NEEDED AGAIN             06000000
         BCR   EGHT,RSTART              BACK TO OPEN AGAIN         DM0I 06020000
         CLC   0(2,RCWG),OPIDCNST      END OF WTG TABLE                 06040000
         BC    7,RELOOP                NO,CHECK NEXT ENTRY              06060000
         LR    RCPL,RPL                                                 06080000
         LA    RCWG,WAOFF(0,RWG)       REINITIALIZE WTG LIST PTR        06100000
ZCHEK    CLI   0(RWTGC),X'00'          IS THIS ENTRY COMPLETE           06120000
         BC    7,TCTLRTN               IF NOT TRANSFER CONTROL          06140000
         LA    RCWG,WGOFF(0,RCWG)      GET NEXT ENTRY                   06160000
         LA    RCPL,PLOFF(0,RCPL)                                       06180000
         B     ZCHEK                    ZERO CHECK                 DM0I 06200000
**                                                                      06220000
TCTLRTN  EQU   *                                                        06240000
         USING WTG,RWTG                                                 06290003
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSCF*06340003
               MODID=WTGENTRY                                  @Z30TSCF 06390003
         DROP  RWTGC,RWTG                                      @Z30TSCF 06392003
**                                                                      06400000
RPL      EQU   5                                                        06520000
RWG      EQU   6                                                        06540000
RCPL     EQU   7                                                        06560000
RCWG     EQU   8                                                        06580000
RSTART   EQU   11                                                       06600000
WAOFF    EQU   32                                                       06620000
PLOFF    EQU   4                        OFFSET OF DCB ENTRIES      DM0I 06640000
WGOFF    EQU   8                       OFFSET OF WTG ENTRIES            06660000
OPIDCNST DC    C'0S'                    ID                         DM0I 06700000
AMIDCNST DC    C'1J'                    ID                         DM0I 06720000
MOD196L  DC    C'6L',VL3(IGG0196L)      NEXT MODULE            @Z30TSCF 06730003
*                                                                       06740000
*********************************************************************** 06760000
*                                                                       06780000
*    THIS SECTION OF CODE BUILDS A READ CHANNEL PROGRAM               * 06800000
*                                                                     * 06820000
*    R2 POINTS TO NEXT CCW ON ENTRY AND EXIT                          * 06840000
*                                                                     * 06860000
*    R4 IS RETURN -- R6 POINTS TO COUNT READ IN                       * 06880000
*                                                                       06900000
*                                                                     * 06920000
*********************************************************************** 06940000
*                                                                       06960000
SOP8READ MVI   7(RB),ONE                COUNT                           06980000
         MVI   0(RB),READATA            READ DATA OP CODE               07000000
         MVI   4(RB),CMDSKPSL           COMMAND CHAIN,SKIP,SILI         07020000
*                                                                       07040000
         MVI   15(RB),FIVE              COUNT                           07060000
         MVI   12(RB),COMSILI           COMMAND CHAIN,SILI              07080000
         TM    JFCBMASK+D6,NONCARN      ANY DEVICES W/O RCD      S20201 07084020
*                                       READY                    S20201 07088020
         BO    SOP8RD7                  BRANCH IF YES            S20201 07092020
         LR    RC,RF                    GET IOB PTR              S20201 07096020
         AR    RC,RE                    INCR TO NEXT IOB         S20201 07100020
         SR    RC,RDEB                  BACK UP ONE DW           S20201 07104020
         MVI   D15(RB),ATE8                                      S20201 07108020
SOP8RD7  EQU   *                                                 S20201 07112020
         ST    RC,D8(RB)                ADDRESS                  S20201 07116020
         MVI   8(RB),READCOUN           READ COUNT OP CODE              07120000
         AR    RB,RDEB                  INCREMENT PTR            S20201 07126020
         TM    JFCBMSK6,JFCSDRPS        SEARCH DIRECT            YA3136 07128002
         BO    SOP8RD8                  YES, READ DATA CCW       YA3136 07130002
*                                        BEFORE READ COUNT CCW   YA3136 07130402
         AR    RB,RDEB                  INCR PTR                 S20201 07132020
SOP8RD8  EQU   *                                                        07134002
         SR    RB,RF                    GET RD CCW OFFSET        S20201 07138020
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 07138402
         STC   RB,DCBOFFSR              PUT IN DCB               S20201 07144020
         MODESET  KEYADDR=DXUKEY,WORKREG=9 GET INTO USER KEY     Y02072 07144402
         AR    RB,RF                    RESTORE PTR              S20201 07150020
*                                                                       07160000
SOP8RD10 CLI   DCBKEYLE,MINKEY          ARE KEYS SPECIFIED              07180000
         BC    4,SOP8RD15               BRANCH ON NO (LESS THAN 1)      07200000
         MVI   0(RB),READKEDA           READ KEY AND DATA OP CODE       07220000
         B     SOP8RD18                 SKIP                       DM0I 07240000
SOP8RD15 MVI   0(RB),READATA            READ DATA OP CODE               07260000
SOP8RD18 TM    DCBRECFM,UFORMAT         U FORMAT SPECIFIED              07280000
         BNM   SOP8RDU                  BRANCH IF U FORMAT       S20201 07288020
         TM    DCBRECFM,VFORMAT          IS IT V FORMAT          S20201 07296020
         BNO   SOP8RD20                 IF NOT, DONT SET SILI    S20201 07304020
SOP8RDU  EQU   *                                                 S20201 07312020
         MVI   4(RB),SILI               SILI FLAG                       07320000
SOP8RD20 LA    RB,8(0,RB)               INCREMENT CCW POINTER           07340000
         BR    RD                       EXIT                       DM0I 07360000
*                                                                       07380000
*********************************************************************** 07400000
*                                                                       07420000
*                                                                       07440000
*********************************************************************** 07460000
*                                                                       07480000
*    THIS SECTION OF CODE BUILDS A SEARCH AND TIC CCW                 * 07500000
*                                                                       07520000
*                                                                       07540000
*    RC POINTS TO SEARCH ADDRESS-- RB POINTS TO NEXT CCW ON ENTRY     * 07560000
*   RB IS NOT CHANGED IN ROUTINE.-- RD  IS  RETURN--                  * 07580000
*                                                                     * 07600000
*********************************************************************** 07620000
SOP8SRTC ST    RC,0(0,RB)              SEARCH ADDRESS                   07640000
         MVI   0(RB),SRCHE             SEARCH OP CODE                   07660000
         MVI   7(RB),FIVE              COUNT                            07680000
         MVI   4(RB),COMCHAIN          COMMAND CHAIN                    07700000
*                                                                       07720000
*    TIC                                                                07740000
*                                                                       07760000
         LA    RC,5(0,RC)              SEARCH ADDRESS                   07780000
         ST    RB,8(0,RB)              TIC TO SEARCH                    07800000
         MVI   8(RB),TIC               TIC OP CODE                      07820000
         BR    RD                       EXIT                       DM0I 07840000
*********************************************************************** 07860000
*                                                                       07861020
* THIS RTN BUILDS SET THETA COMMANDS, RB POINTS TO CCW                  07862020
*                                                                       07863020
SOP8STA  EQU   *                                                 S20201 07864020
         L     RC,DXCCW11               GET SET THETA ADDR       S20201 07865020
         ST    RC,D0(RB)                PUT IN CCW               S20201 07866020
         OI    FLAGOFF(RB),CC           TURN ON COMMAND CHAIN    S20201 07867020
*                                       FLAG                     S20201 07868020
         MVI   CNTOFF(RB),ONE           SET COUNT TO ONE         S20201 07869020
         MVI   D0(RB),SETSC             PUT IN COMMAND           S20201 07870020
         AR    RB,RDEB                  INCREMENT PTR            S20201 07871020
         BR    RD                       RETURN                   S20201 07872020
*******************************************************************     07895020
***                                                                     07896020
CON1     DC    H'1'                     CONSTANT OF ONE          S20201 08350020
         SPACE 2                                                        08360000
EGHT     EQU   8                                                   DM0I 08380000
PATCH    DC    0H'0',50X'00'            PATCH AREA               Y02072 08390002
         SPACE 2                                                        08400000
         EJECT                                                          08450003
CVT      DSECT                                                 @Z30TSCF 08500003
         CVT                                                   @Z30TSCF 08550003
         EJECT                                                          08580002
         IECDSECS  (MAIN,(IOB,NO)),DCB,IOB,WTG,PREFX,EXPAND=YES         08610003
*                                                              @Z30TSCF 08610403
         ORG   WTGIDTTR                                          Y02072 08612002
WTGID    DS    CL2                      NEXT MODS ID             Y02072 08614002
FORCORE  DSECT                                                          08614102
         ORG   JFCBMASK                                                 08614202
         DS    6B                                                       08614302
JFCBMSK6 DS    B                        SIXTH BYTE OF JFCB MASK         08615102
         EJECT                                                          08616802
FORCORE  DSECT                                                   Y02072 08617602
         IHAFCAUD  ORG=YES                                       Y02072 08618402
DCBKEYL  EQU   DCBKEYLE                                                 08620000
         END                                                            09220000
