         TITLE ' IGG0191K INPUT DA EXECUTOR FOR PCI SCHEDULING'  S20201 00010020
IGG0191K CSECT                                                          00023000
*MODULE NAME - IGG0191K                                          Y02072 00023402
*                                                                       00023802
*DESCRIPTIVE NAME - BUILD IOBS                                   Y02072 00024202
*                                                                       00024602
*COPYRIGHT - NONE                                                Y02072 00024702
*                                                                       00024802
*CHANGE ACTIVITY - AS FOLLOWS:                                   Y02072 00024902
*                                                                       00026802
*          VS 2 RELEASE 2 DELETIONS                              Y02072 00028702
*000550,011000,052600,067800,068900-068950,077200,119600,129118, Y02072 00030602
*129306,133200,134800,143000,146400,161300                       Y02072 00040602
*                                                                YM2424 00050602
*                                                                YM4697 00052602
*                                                                YM6583 00052702
*                                                                YM7595 00054702
*                                                                       00056703
*          VS2 RELEASE 3 DELETIONS                                      00057103
*                                                              @Z30TSCF 00060103
*          RELEASE 20 DELETIONS                                         00064003
*1242000200,031400,040800-041000,050000-051000,055400-055600,    S20201 00067003
*1242056800-059800,068600-069000,084200,085800-086000,097200-    S20201 00070003
*1242097600,097800,099200-099400,101200-117600,120200,121000-    S20201 00073003
*1242121200,125400-125800                                        S20201 00076003
*          RELEASE 21 DELETIONS                                         00079003
*0216005200,134400,140800-141400,149810-149930,161200-161400     S21042 00082003
*                                                                       00085003
*STATUS CHANGE LEVEL 005                                                00088003
*                                                                       00091003
*FUNCTION/OPERATION -- THIS EXECUTOR BUILDS THE MAIN IOB & ICBS THAT    00094003
*                      WILL CONTROL THEIR ASSOCIATED CHANNEL PROGRAMS.  00097003
*                      IT ALSO CONSTRUCTS INPUT OR OUTPUT CHANNEL PROG. 00100000
*                      AND FILLS IN DEVICE DEPENDANT FIELDS IN THE DCB. 00120000
*                      FOR QSAM THE CHANNEL PROGRAMS INCLUDE THE BUFFER 00140000
*                      ADDRESS,THE PHYSICAL BLOCK SIZE AND ASSC FLAGS.  00160000
*                      ALL ICBS ARE LINKED TOGETHER                     00180000
*                      THE GETMAIN MACRO IS USED TO OBTAIN SPACE FOR    00200000
*                      THE IOB & ICBS.                                  00220000
*                      IT SETS AN AUDIT TRAIL BIT IN THE OPEN    Y02072 00230002
*                      WORKAREA INDICATING TO FORCE CLOSE THAT   Y02072 00232002
*                      THE CORE GETMAINED FOR THE IOB'S CAN BE   Y02072 00234002
*                      FREEMAINED.                               Y02072 00236002
*                                                                       00260000
*ENTRY POINTS  -   ENTERED AT IGG0191K FROM THE LEVEL ONE               00280000
*                      EXECUTOR IGG0191B VIA THE XCTL MACRO             00300000
*                                                                       00320000
*INPUT SUPPLIED-   USER DCB AND OPEN PARAMETERS -- SEE REGISTER USAGE   00340000
*                                                                       00360000
*OUTPUT GIVEN  -   MAIN IOB , ICBS AND CHANNEL PROGRAMS , DCB INITIAL   00380000
*                                                                       00400000
*                                                                       00420000
*EXTERNAL RTS. -   NONE                                                 00440000
*                                                                       00460000
*EXITS-NORMAL: XCTL TO IGG01910(IECOSLDA)    TO LOAD ROUTINES           00480000
*                                                                       00500000
*EXITS-ERROR: XCTL TO PROBLEM DETERMINATION FOR WTP AND 013 ABEND       00520021
*                                                                       00530002
*MACROS : ACTION - MODESET, GETMAIN, XCTL, XCTLTABL, DMABCOND    Y02072 00532002
*                                                                       00534002
*MACROS : MAPPING - IECDSECS, IEZIOB, IHAICB, IHACCW, IKJTCB,    Y02072 00536002
*                   IEZDEB, DCBD, IHAFCAUD, IGGBCB               Y02072 00538002
*                                                                       00540000
*TABLES/WORKAREAS- WHERE TO GO TABLE (WTG)                              00560000
*                                                                       00580000
*      BYTE  0-7  NAME                                                  00600000
*      BYTE  8-10 RELATIVE DISK ADDRESS(TTR) OF FIRST RECORD            00620000
*      BYTE 11    CONCATENATION NUMBER                                  00640000
*      BYTE 12    ZERO                                                  00660000
*      BYTE 13    ALIAS INDICATOR AND USER DATA FIELD DESCRIPTOR.       00680000
*                        ALIAS INDICATOR 1 BIT                          00700000
*                        NUMBER OF TTRS IN USERS DATA FIELD 2 BITS      00720000
*      BYTE 14-16 TTR OF FIRST TEXT RECORD                              00740000
*      BYTE 17    ZERO                                                  00760000
*      BYTE 18-19 TTR OF NOTE LIST OR SCATTER LIST                      00780000
*      BYTE 20    TRANSLATION TABLE                                     00800000
*      BYTE 21    ZERO OR NUMBER OF ENTRIES IN THE NOTE LIST            00820000
*      BYTE 22-23 ATTRIBUTES                                            00840000
*      BYTE 24-26 TOTAL CONTIGUOUS MAIN STORAGE REQUIRED FOR MODULE     00860000
*      BYTE 27-28 LENGTH OF FIRST TEXT RECORD                           00880000
*      BYTE 29    LENGTH OF WTG TABLE (IN DOUBLE WORDS)                 00900000
*      BYTE 30-31 PATH THROUGH LOADS OF ROUTINES                        00920000
*      BYTE 32-34 IDTTR OF EXECUTOR FOR FIRST DCB                       00940000
*      BYTE 35    WORKAREA ADDRESS FOR FIRST DCB                        00960000
*      BYTE 36-39 TABLE OF IDTTR'S                                      00980000
*      BYTE 32+N(8) IDTTR OF EXECUTOR FOR  N TH DCB  (3 BYTES)          01000000
*                   WORKAREA ADDRESS FOR N TH DCB    (1 BYTE )          01020000
*                   IDTTR OF LAST ROUTINE LOAD       (3 BYTES)          01040000
*                   NOT USED                         (1 BYTE)           01060000
*                                                                       01080000
*ATTRIBUTES: REENTRANT, REUSABLE, RUNS IN USER KEY               Y02072 01100002
*            UNLESS OTHERWISE SPECIFIED, SUPER STATE             Y02072 01110002
*                                                                       01120000
*                                                                       01140000
*********************************************************************** 01160000
*                                                                       01180000
*                                                                       01200000
*  REGISTER CONVENTIONS USED THROUGH OUT ALL OPEN PASSES                01220000
*                                                                       01240000
*********************************************************************** 01260000
*                                                                       01280000
RDCB     EQU   2         DCB REGISTER                                   01300000
RBASE    EQU   3         BASE REGISTER                                  01320000
RCORE    EQU   4         WORK AREA ADDRESS                              01340000
RPAR     EQU   5         TOP OF PARAMETER LIST                          01360000
RWTG     EQU   6         TOP OF WTG TABLE                               01380000
RPARC    EQU   7         CURRENT PARAMETER                              01400000
RWTGC    EQU   8         CURRENT TRANS LOAD                             01420000
RTIOT    EQU   9         USED HERE AS WRK REG AND  COMM VECTOR ADDR.    01440000
RUCB     EQU   10        USED HERE AS A COUNTER IN IOB GENERATION       01460000
RWK1     EQU   RUCB                     WORK REGISTER            Y02072 01470002
RDEB     EQU   11        DEB ADDRESS                                    01480000
RWK2     EQU   RDEB                     WORK REGISTER            Y02072 01490002
RB       EQU   12        WORK REG1  **                                  01500000
RWK3     EQU   RB                       WORK REGISTER            Y02072 01510002
RC       EQU   13        WORK REG2  **  USED IN IOB GENERATION          01520000
RBUFADR  EQU   RC        ADDR OF NEXT AVAILABLE BUFFER           YM7595 01530002
RD       EQU   14        WORK REG3  **                                  01540000
RWK5     EQU   RD                       WORK REGISTER            Y02072 01550002
RJ       EQU   15        WORK REG4                                      01560000
RE       EQU   0         WORK REG5                                      01580000
RF       EQU   1         WORK REG6                                      01600000
RWK6     EQU   RF                       WORK REGISTER            Y02072 01610002
*                                                                       01620000
*                                                                       01640000
PARAR    EQU   RPARC                                                    01660000
*                                                                       01680000
*********************************************************************** 01700000
*                                                                       01720000
*                                                                       01740000
*                                                                       01760000
*********************************************************************   01780000
* MASK'S TO TEST PARAMETER LIST WITH                                    01800000
INP      EQU   X'0F'                                                    01820000
OUTP       EQU   X'0F'                                                  01840000
UPDATE     EQU   X'04'                                                  01860000
INOUT      EQU   X'03'                                                  01880000
OUTIN      EQU   X'07'                                                  01900000
RDBACK     EQU   X'01'                                                  01920000
*                                                                       01940000
*                                                                       01960000
*********************************************************************   01980000
*                                                                       02000000
*                                                                       02020000
* OFFSET FOR PARAMETER TESTS                                            02040000
*                                                                       02060000
ONE        EQU   X'01'                                                  02080000
FRTYATE    EQU   48                                                     02100000
DISPSN     EQU   X'0'                                                   02120000
*                                                                       02140000
*                                                                       02160000
*********************************************************************   02180000
*                                                                       02200000
* OFFSETS FOR DEB REFERENCE                                             02220000
*                                                                       02240000
*                                                                       02260000
*                                                                       02280000
*                                                                       02300000
*                                                                       02320000
*********************************************************************   02340000
*                                                                       02360000
* MASK'S USED TO TEST OPTION FIELDS IN DCB                              02380000
*                                                                       02400000
*                                                                       02420000
*                                                                       02440000
DOUBLE     EQU   X'01'                                                  02460000
*                                                                       02480000
*                                                                       02500000
STOWB      EQU   X'80'                                                  02520000
WRTCK    EQU   X'80'                                                    02540000
OVRFLO     EQU   X'20'                                                  02560000
PCIB     EQU   X'20'                                                    02580000
MINKEY     EQU   X'01'                                                  02600000
CONCAT     EQU   X'FF'                                                  02620000
SRCHDIRB EQU   X'40'                                                    02640000
ONONYES  EQU   X'0C'                                                    02660000
*                                                                       02680000
*********************************************************************   02700000
*                                                                       02720000
* MASKS FOR ACCESS METHODS IN SAM                                       02740000
*                                                                       02760000
QSAMB      EQU   X'01'                                                  02780000
BSAMBIT    EQU   X'00'                                                  02800000
PAM        EQU   X'02'                                                  02820000
*                                                                       02840000
*                                                                       02860000
* MASKS FOR MACRO'S TO BE USED                                          02880000
*                                                                       02900000
GETB       EQU   X'40'                                                  02920000
PUTB       EQU   X'40'                                                  02940000
READB      EQU   X'20'                                                  02960000
WRITEB     EQU   X'20'                                                  02980000
POINTB     EQU   X'04'                                                  03000000
CNTRLB     EQU   X'02'                                                  03020000
*                                                                       03040000
*                                                                       03060000
*********************************************************************   03080000
*                                                                       03100000
* MASKS FOR DEVICES TO BE SUPPORTED                                     03120000
NORCDRY  EQU   X'20'                    NO RECORD READY MASK     S20201 03140020
*                                                                       03160000
*                                                                       03180000
*********************************************************************   03200000
*                                                                       03220000
* MASKS FOR STATUS BITS TO BE TESTED                                    03240000
*                                                                       03260000
*                                                                       03280000
EXCPN      EQU   X'30'                                                  03300000
COMPLETE EQU   X'60'                                                    03320000
FIRSTIOB   EQU   X'01'                                                  03340000
*                                                                       03360000
*                                                                       03380000
*                                                                       03400000
*********************************************************************   03420000
*                                                                       03440000
* MASKS FOR BUFFER TECHNIQUE'S                                          03460000
*                                                                       03480000
EXCHANGB   EQU   X'10'                                                  03500000
SIMPLEB    EQU   X'40'                                                  03520000
*                                                                       03540000
*********************************************************************   03560000
*                                                                       03580000
*                                                                       03600000
* MODES OF OPERATION FOR QSAM                                           03620000
*                                                                       03640000
LOCATEB    EQU   X'08'                                                  03660000
MOVEB      EQU   X'10'                                                  03680000
SUBSTUTB   EQU   X'04'                                                  03700000
*                                                                       03720000
*                                                                       03740000
*********************************************************************   03760000
*                                                                       03780000
*                                                                       03800000
* COMMAND BYTES FOR THE 2841                                            03820000
*                                                                       03840000
*       CONTROL UNIT                                                    03860000
*                                                                       03880000
*                                                                       03900000
*                                                                       03920000
SRCHE      EQU   X'31'                                                  03940000
WRTCKD     EQU   X'1D'                                                  03960000
RDC        EQU   X'92'                                                  03980000
RDKD       EQU   X'8E'                                                  04000000
RDD        EQU   X'86'                                                  04020000
NOP      EQU   X'03'                                                    04040000
TIC        EQU   X'08'                                                  04060000
SETSC    EQU   X'23'                    SET SECTOR CCW CMND      S20201 04070020
RDSC     EQU   X'22'                    RD SECTOR CCW CMND       S20201 04080020
TICNOP   EQU   X'88'                    RCD READY TIC NOP        S20201 04090020
*                                                                       04100020
*                                                                       04110020
*********************************************************************   04120000
*                                                                       04140000
*                                                                       04160000
* MASKS FOR RECORD FORMATS                                              04180000
*                                                                       04200000
*                                                                       04220000
STANDRDF   EQU   X'08'                                                  04240000
FORMATU    EQU   X'C0'                                                  04260000
FORMATF    EQU   X'80'                                                  04280000
FORMATV    EQU   X'40'                                                  04300000
BLOCKED    EQU   X'10'                                                  04320000
FSTANDRD EQU   X'88'                                                    04340000
FIXBKD   EQU   X'90'                                                    04360000
NOTPNTID EQU   X'05'                                                    04380000
FORMATVS EQU X'48'    VARIABLE SPANNED                           M3641  04390019
*                                                                       04400000
*                                                                       04420000
*********************************************************************   04440000
*                                                                       04460000
*                                                                       04480000
*   CHANNEL CONTROL WORD FLAGS                                          04500000
*                                                                       04520000
SKIP       EQU   X'10'                                                  04540000
SLI        EQU   X'20'                                                  04560000
PCI      EQU   X'08'                                                    04580000
CC         EQU   X'40'                                                  04600000
DATACH     EQU   X'A0'                                                  04620000
SLICC      EQU   X'60'                                                  04640000
SLICCSK    EQU   X'70'                                                  04660000
*                                                                       04680000
*                                                                       04700000
*********************************************************************   04720000
*                                                                       04740000
*                                                                       04760000
KEYS       EQU   X'01'                                                  04780000
QSAM       EQU   X'01'                                                  04800000
*                                                                       04820000
*                                                                       04840000
*********************************************************************   04860000
*                                                                       04880000
COMMTABL EQU   16                                                       04900000
OABD065  EQU   65                                                S21042 04910021
*                                                                       04920000
*********************************************************************   04940000
*                                                                       04960000
*                                                                       04980000
*                                                                       04985020
* MISCELLANEOUS EQUATES AND DISPLACEMENTS                               04990020
*                                                                       04995020
D0       EQU   0                        DISPLACEMENT OF 0        S20201 05000020
D1       EQU   1                        DISPLACEMENT OF 1        S20201 05005020
D2       EQU   2                        DISPLACEMENT OF 2        S20201 05010020
D3       EQU   3                        DISPLACEMENT OF 3        S20201 05015020
D4       EQU   4                        DISPLACEMENT OF 4        S20201 05020020
D5       EQU   5                        DISPLACEMENT OF 5        S20201 05025020
D6       EQU   6                        DISPLACEMENT OF 6        S20201 05030020
D7       EQU   7                        DISPLACEMENT OF 7        S20201 05035020
D8       EQU   8                        DISPLACEMENT OF 8        S20201 05040020
D15      EQU   15                       DISPLACEMENT OF 15       S20201 05045020
*                                                                       05050020
D40      EQU   40                       DISPLACEMENT OF 40       S20201 05055020
D51      EQU   51                       DISPLACEMENT OF 51       S20201 05060020
D52      EQU   52                       DISPLACEMENT OF 52       S20201 05065020
*                                                                       05070020
B0       EQU   0                        BYTE COUNT OF 0          S20201 05075020
B1       EQU   1                        BYTE COUNT OF 1          S20201 05080020
B3       EQU   3                        BYTE COUNT OF 3          S20201 05085020
B8       EQU   8                        BYTE COUNT OF 8          S20201 05090020
B16      EQU   16                       BYTE COUNT OF 16         S20201 05095020
*                                                                       05100020
IOBCEXCP EQU   X'80'                    IOBCNOPA FLAG            YM6583 05102002
RRRDNOP  EQU   64                       RCD READYS READ NOP      S20201 05105020
*                                       OFFSET                   S20201 05110020
*                                                                       05115020
*                                                                       05120000
*                                                                       05140000
         BALR  RBASE,0                  REG 3 IS BASE                   05160000
         USING SOPA,RBASE               ESTABLISH BASE REGISTER         05180000
         USING IHADCB,RDCB              REG 2 IS DCB                    05200000
         USING FORCORE,RCORE            REG 4 IS WORK AREA ADDR         05240000
*                                                                       05280000
*                                                                       05300000
SOPA     EQU   *                        FOR ADDRESSABILITY              05320000
*                                                                       05340000
         B     BEGIN                    BR AROUND CONSTANTS      Y02072 05350002
         DC    C'IGG0191K'              MODULE NAME              Y02072 05352002
         DC    C'@Z30TSCF'              LAST SHIP CODE         @Z30TSCF 05354003
         DC    C'10/17/74'              LAST DATE MODIFIED     @Z30TSCF 05356003
BEGIN    DS    0H                                                Y02072 05358002
*                                                                       05360000
         L     RDCB,0(RPARC)            GET DCB ADDRESS                 05380000
         LA    RDCB,0(RDCB)             CLEAR HI BYTE                   05400000
         L     RCORE,4(RWTGC)           GET WORK AREA ADDRESS           05420000
*                                                                       05440000
         SR    RC,RC                    READY A WORK REG                05460000
         SR    RDEB,RDEB                                                05480000
*                                                                       05500000
*                                                                       05520000
*                                                                       05580000
         ST    RC,DCBCNTRL                                              05600000
         SR    RTIOT,RTIOT                                              05620000
         IC    RTIOT,DCBNCP             GET NUMBER OF ICBS TO BUILD     05640000
*                                                                       05660000
*                                                                       06000000
SOPA003  EQU   *                                                        06020000
*                                                                       06040000
         LA    RF,64                    CONSTANT SIZE FOR ICB & CP.     06060000
*                                                                       06062020
* CHECK FOR RCD READY AND IF TO BE USED INCR ICB SIZE                   06064020
*                                                                       06066020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 06068020
*                                       READY                    S20201 06070020
         BO    SOPA03A                  BRANCH IF YES            S20201 06072020
         LA    RF,B8(RF)                INCR ICB SIZE            S20201 06074020
SOPA03A  EQU   *                                                 S20201 06076020
         MVI   DCBCNTRL+3,2             STORE INDEX FACTOR FOR PCI EOB  06080000
         TM    DCBMACRF,POINTB          NOTE/POINT TO BE USED           06100000
         BC    8,SOPA007                NO BRANCH                       06120000
*                                                                       06140000
SOPA005  EQU   *                                                        06160000
*                                                                       06180000
         MVI   DCBCNTRL+1,5             STORE INDEX FOR NOTE-POINT ID   06200000
*                                                                       06220000
SOPA007  EQU   *                                                        06240000
*                                                                       06260000
         TM    DCBCIND2,QSAMB           IS QSAM BEING USED              06280000
         BC    8,SOPA009                NO BRANCH                       06300000
*                                                                       06320000
         IC    RTIOT,DCBBUFNO           GET NO. OF ICBS TO GENERATE     06340000
SOPA009  EQU   *                                                        06360000
*                                                                       06380000
         LTR   RTIOT,RTIOT              HAS NO OF CPS BEEN SPECIFIED    06400000
         BC    8,NOPCI                  N O BRANCH                      06420000
         CH    RTIOT,CONONE             DOES BUFFER NO  = 1             06440000
*                                                                       06460000
         BC    8,NOPCI                  YES BRAN CH                     06480000
*                                                                       06500000
*                                                                       06520000
SOPA011  EQU   *                                                        06540000
*                                                                       06560000
         LR    RE,RF                    COPY ICB SIZE                   06580000
         SRL   RE,3                     DIVIDE BY EIGHT                 06600000
         STC   RE,DCBIOBL               SAVE FOR CLOSE                  06620000
         LR    RE,RTIOT                 PREPARE TO COMPUTE SPACE REQ.   06640000
         MR    RE,RE                    NO. ICBS BY THEIR SIZE          06660000
         LA    RF,80(RF)                ADD SPACE FOR MAIN IOB          06680000
*                                                                       06682020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 06684020
*                                       READY                    S20201 06686020
         BO    SOPA11A                  BRANCH IF YES            S20201 06688020
         LA    RF,B16(RF)               INCR MAIN IOB FOR SET    S20201 06690020
*                                       SECTS                    S20201 06692020
*                                       AND THETA VALUES                06694020
SOPA11A  EQU   *                                                 S20201 06696020
*                                                                       06698020
         LR    RB,RF                    SAVE FOR CLEARING RT.           06700000
         OI    DCBCIND2,DCBCNCHS        SET TRUE PCI INDICATOR   YM4697 06710002
*                                                                       06720000
*  THE FOLLOWING SAVES THE AMOUNT OF CORE GETMAINED FOR THE      YM4697 06730002
*  IOB AND ICBS IN THE FORCE CLOSE AUDIT TRAIL FOR THE FORCE     YM4697 06732002
*  EXECUTOR.                                                     YM4697 06734002
*                                                                       06736002
         ST    RF,DXATEXC2              SAVE LENGTH              YM4697 06738002
**********************************************************************  06740000
*                                                                       06760000
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 06770002
         GETMAIN R,LV=(RF),SP=0                                  Y02072 06780002
*                                                                       06800000
**********************************************************************  06840000
*                                                                       06845020
* OBTAIN AND TEMP SAVE THETA ADDRS MAY BE USED LATER                    06850020
*                                                                       06855020
         LR    RJ,RB                    GET AREA LENGTH          S20201 06860020
         AR    RJ,RF                    OBTAIN LAST AREA+1 ADDR  S20201 06865020
         LA    RE,B8                    CONSTANT                 S20201 06870020
         SR    RJ,RE                    BACK UP ONE DW           S20201 06875020
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 06877002
         ST    RJ,DXCCW11               TEMP STORE SET SECTORS   S20201 06880020
*                                       THETA ADDR                      06885020
**                                                                      06940000
*    THIS SECTION CLEARS THE SPACE RECIEVED FROM GETMAIN                06960000
**                                                                      06980000
*                                                                       07000000
         LR    RJ,RB                    RESTORE LENGTH TO CLEAR         07020000
         ST    RF,DCBIOBAD              STORE MAIN IOB ADDRESS          07040000
         OI    FCAOPEN,FCAOIOB          INDIC IOB'S CAN BE FREED Y02072 07050002
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 07052002
         BCTR  RJ,0                     REDUCE AMT BT ONE               07060000
         LA    RB,255                   GET MAX AMT CAN CLEAR           07080000
COMPARE  CR    RJ,RB                    IS AMT TO CLEAR GREATER 255     07100000
         BC    12,ONECLEAR              NO BRANCH                       07120000
*                                                                       07140000
         EX    RB,CLEAR                 CLEAR 256 BYTES                 07160000
         SR    RJ,RB                    SUBT 255 FROM AMT TO BE CLEARED 07180000
         BCTR  RJ,0                     SUBT ONE MORE BYTE              07200000
         LA    RF,256(RF)               UPDATE AREA ADDR BY 256         07220000
         B     COMPARE                                                  07240000
*                                                                       07260000
CLEAR    XC    0(1,RF),0(RF)            ACTUAL CLEAR INSTRUCTION        07280000
*                                                                       07300000
ONECLEAR EX    RJ,CLEAR                 CLEARS LESS THAN 256            07320000
*                                                                       07340000
*                                                                       07360000
*                                                                       07380000
         L     RB,DCBIOBAD              GET MAIN IOB ADDRESS            07400000
         LR    RC,RB                    SET UP WORK REG                 07420000
         LR    RD,RB                    SET UP WORK REG                 07440000
*                                                                       07460000
*                                                                       07480000
*    THIS SECTION OF CODE WILL BUILD THE MAIN IOB & CHANNEL PROGRAM     07500000
*                                                                       07520000
SOPA013  EQU   *                                                        07540000
*                                                                       07560000
         LA    RUCB,80(RB)              POINT TO FIRST ICB              07580000
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 07583020
*                                       READY                    S20201 07586020
         BO    SOPA13AX                 BRANCH IF YES            S20201 07589020
         LA    RUCB,B8(RUCB)            INCR FOR RD SECTOR       S20201 07592020
SOPA13AX EQU   *                                                 S20201 07595020
         ST    RUCB,8(RB)               STORE IN MAIN IOB               07600000
         LA    RD,4(RB)                 POINT TO ECB IN MAIN IOB        07620000
*                                                                       07640000
         MVI   0(RD),X'7F'              POST MAINIOB COMPLETE           07660000
*                                                                       07680000
         LA    RF,56(RB)                POINT TO CP START ADDRESS       07700000
         USING IOBQSAMC,RWK3                                     Y02072 07710002
         ST    RD,IOBECBPT              ECB ADDR TO IOB          Y02072 07720002
         ST    RF,IOBSTART              CHAN PGM ADDRESS TO IOB  Y02072 07730002
         L     RWK2,DXUDCBAD            GET USERS DCB ADDRESS    Y02072 07732002
         ST    RWK2,IOBDCBPT            DCB ADDRESS TO IOB       Y02072 07734002
         DROP  RWK3                                              Y02072 07736002
         MVC   48(8,RB),DCBFDAD         MOVE D.A. ADDRESS TO MAIN IOB   07740000
         LA    RUCB,51(RB)              POINT TO CCHHR IN MAIN IOB      07760000
*                                                                       07761020
* CHECK FOR RCD READY AND IF USED BUILD SET SECTOR                      07762020
*                                                                       07763020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 07764020
*                                       READY                    S20201 07765020
         BO    SOPA13A                  BRANCH IF YES            S20201 07766020
         L     RDEB,DXCCW11             GET SET SECTOR ADDR      S20201 07767020
         ST    RDEB,D0(RF)              PUT IN CCW               S20201 07768020
         MVI   D0(RF),SETSC             PUT SET SECT CCW CMND    S20201 07769020
         OI    D4(RF),CC                TURN ON CMND CHAIN       S20201 07770020
         MVI   D7(RF),B1                BYTE CNT EQS ONE         S20201 07771020
         LA    RB,B8(RB)                INCREMENT BY EIGHT       S20201 07772020
SOPA13A  EQU   *                                                 S20201 07773020
*                                                                       07774020
         ST    RUCB,56(RB)              STORE IN SRCH CCW               07780000
         MVI   56(RB),SRCHE             STORE SRCH EQUAL CMD BYTE       07800000
         LA    RUCB,56(RB)              POINT TO SRCH CCW               07820000
         ST    RUCB,64(RB)              STORE IN TIC CCW                07840000
         MVC   60(5,RB),SCCWCNST        STORE CC FLG,LEN = 5 ,TIC OP    07860000
*                                       IN TIC                          07875018
*                                                                       07880000
*                                                                       07900000
SOPA015  EQU   *                                                        07920000
*                                                                       07940000
         MVI   72(RB),TIC               STORE TIC CMD BYTE              07960000
*                                                                       07980000
*                                                                       08000000
         LA    RB,80(RB)                POINT TO FIRST ICB              08020000
         MODESET  EXTKEY=DATAMGT        DATA MANAG KEY FOR ST    Y02072 08030002
         ST    RB,DCBIOBA               STORE ICB ADDRESS               08040000
         MODESET  KEYADDR=DXUKEY,WORKREG=11  BACK TO USER KEY    Y02072 08050002
         LR    RC,RB                    COPY ICB ADDRESS                08060000
*                                                                       08080000
*                                                                       08100000
ICBLOOP  EQU   *                                                        08120000
*                                                                       08140000
*                                                                       08160000
         LTR   RTIOT,RTIOT              HAVE ALL ICBS BEEN GENERAED     08180000
         BC    8,SOPAEND                YES BRANCH                      08200000
*                                                                       08220000
*                                                                       08240000
************** CONSTRUCTION OF ICB & CP COMMENCE ********************** 08260000
*                                                                       08280000
*                                                                       08300000
         ST    RC,0(RB)                 STORE NEXT ICBAD IN LINK FLD.   08320000
         LR    RB,RC                    UPDATE TO NEXT ICB              08340000
         LA    RC,4(RB)                 POINT TO ECB IN ICB             08360000
         ST    RC,12(RB)                STORE ECB ADDRESS IN ICB        08380000
         MVI   4(RB),X'7F'              POST ECB COMPLETE FOR NOW       08400000
         LA    RC,D40(RB)               GET ICB CHP ADDR         S20201 08420020
         ST    RC,24(RB)                STORE CP ADDRESS IN ICB         08440000
         MVC   32(8,RB),DCBFDAD         STORE D.A. ADDRESS IN ICB       08460000
*                                                                       08480000
*                                                                       08500000
*        NOTE THAT THE DCB ADDRESS IS NOT STORED IN THE ICB             08520000
*                                                                       08540000
*                                                                       08560000
*                                                                       08620000
*                                                                       08640000
SOPA017  EQU   *                                                        08660000
*                                                                       08680000
*                                                                       08700000
SOPA019  EQU   *                                                        08720000
*                                                                       08740000
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 08752002
         MVI   DCBOFFSR,48              STORE READ DATA CCW OFFSET      08760000
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 08762002
         L     RUCB,DCBIOBAD                                            08780000
         MVI   2(RUCB),56               STORE READ NOP OFFSET           08800000
         LA    RE,99(RB)                POINT TO NEXT ICBS CCHHR FLD    08820000
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 08822020
*                                       READY                    S20201 08824020
         BO    SOPA19A                  BRANCH IF YES            S20201 08826020
         LA    RDEB,B8                  CONSTANT                 S20201 08828020
         AR    RE,RDEB                  INCR CCHHR PTR FOR RD    S20201 08830020
*                                       SECT                     S20201 08832020
SOPA19A  EQU   *                                                 S20201 08834020
*                                                                       08836020
         ST    RE,40(RB)                STORE IN THE CURR RD CNT CCW    08840000
         MVI   40(RB),RDC               STORE READ CMD BYTE (COUNT)     08860000
         MVC   44(4,RB),CCWCNSTS        STORE PCI,CC,SILI FLGSAND LEN   08880000
*                                                                       08890002
* MUST TEST FOR VIRTUAL ENVIRONMENT.  IF YES, TURN PCI FLAG OFF  Y02072 08892002
* IN CHAN PGM.  IF NO, LEAVE PCI FLAG ON.                        Y02072 08894002
*                                                                       08896002
         L     RDEB,DCBDEBAD            GET DEB ADDRESS          Y02072 08898002
         USING DEBBASIC,RDEB                                     Y02072 08898402
         L     RWK2,DEBTCBAD            GET THE TCB ADDRESS      Y02072 08898802
         DROP  RDEB                                              Y02072 08899202
         USING TCB,RWK2                                          Y02072 08899602
         TM    TCBFLGS6,TCBRV           JOB RUNNING VIRTUAL      Y02072 08899702
         BO    SOPA19C                  NO, LEAVE PCI ON         Y02072 08899802
         USING ICB,RWK3                                          Y02072 08899902
         NI    CCWFLGS,X'FF'-CCWPCI     YES, TURN PCI OFF        Y02072 08906602
         DROP  RWK3                                              Y02072 08908602
         DROP  RWK2                                              Y02072 08910602
SOPA19C  MVI   48(RB),RDD               STORE READ DATA CMD BYTE Y02072 08913302
         OI    52(RB),SLICC             TURN ON SILI AND CC FLAGS       08920000
         TM    DCBRECFM,X'C0'           U  TYPE RECORDS                 08940000
         BC    9,SOPA020A               YES  BRANCH                     08960000
*                                                                       08980000
         TM    DCBRECFM,X'40'           V  RECORDS                      09000000
         BC    1,SOPA020A               YES  BRANCH                     09020000
*                                                                       09040000
*                                                                       09060000
SOPA020  EQU   *                                                        09080000
*                                                                       09100000
         NI    52(RB),X'DF'             TURN SILI FLAG OFF              09120000
*                                                                       09140000
SOPA020A EQU   *                                                        09160000
*                                                                       09180000
*                                                                       09200000
         TM    DCBCIND2,QSAMB           DCB USING QSAM                  09220000
         BC    8,SOPA021                NO BRANCH                       09240000
*                                                                       09260000
         LA    RUCB,48(RB)              POINT TO READ DATA CCW          09280000
*                                                                       09290002
* THE FOLLOWING PUTS BUFFER ADDRESS AND BYTE COUNT IN CCW               09300002
*                                                                       09310002
         L     RWK6,DCBBUFCB            ADDR BUF CNTRL BLOCK     YM7595 09320002
         USING BCBLK,RWK6                                               09330002
         L     RBUFADR,BCBBUFPT         ADDR NEXT AVAIL BUFFER   YM7595 09340002
         LTR   RBUFADR,RBUFADR          BUFFER ADDR VALID        YM7595 09350002
         BZ    ABEND                    NO, GO ISSUE DMABCOND    YM7595 09352002
         USING BUFFER,RBUFADR                                           09354002
         MVC   BCBBUFAD,BUFNXPTB        UPDATE WITH NEXT AVAIL   YM7595 09356002
         USING CCW,RUCB                                                 09358002
         STCM  RBUFADR,B'0111',CCWADDRB  BUFFER ADDR TO CCW      YM7595 09358402
         MVC   CCWBYTE,DCBBLKSI         BYTE COUNT TO CCW        YM7595 09358802
         DROP  RUCB,RWK6,RBUFADR                                        09359202
         B     ICBCOMPT                                                 09360000
*                                                                       09380000
SOPA021  EQU   *                                                        09400000
*                                                                       09420000
         SR    RE,RE                                                    09440000
         IC    RE,DCBKEYLE              GET KEY LEN IF SPECIFIED        09460000
         LTR   RE,RE                    ARE KEYS SPECIFIED ?            09480000
         BC    8,ICBCOMPT               NO  BRANCH                      09500000
         MVI   48(RB),RDKD              STORE READ KEY&DATA CMD BYTE    09520000
*                                                                       09540000
ICBCOMPT EQU   *                                                        09560000
*                                                                       09580000
         LA    RD,56(RB)                POINT TO NOP CCW                09600000
         LA    RC,64(RB)                POINT TO NEXT POSSIBLE ICB      09620000
*                                                                       09640000
SOPA023  EQU   *                                                        09660000
*                                                                       09680000
ICBCOMON EQU   *                                                        09700000
*                                                                       09708020
* CHECK FOR RCD READY AND IF USED BUILD RD SECTOR                       09716020
*                                                                       09724020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 09732020
*                                       READY                    S20201 09740020
         BO    SOPA023A                 BRANCH IF YES            S20201 09748020
         LA    RC,B8(RC)                INCR ICB PTR             S20201 09756020
SOPA023A EQU   *                                                 S20201 09764020
         LA    RUCB,D40(RC)             PT TO NEXT ICBS CP       S20201 09774020
*                                                                       09800000
*                                                                       09820000
         ST    RUCB,0(RD)               STORE NEXT CP ADDR IN NOP CCW   09840000
         MVI   0(RD),NOP                STORE NOP CMD BYTE              09860000
         OI    4(RD),X'20'              SET SILI ON IN CCW              09880000
         MVI   7(RD),ONE                STORE LENGTH IN CCW             09900000
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 09904020
*                                       READY                    S20201 09908020
         BO    SOPA023D                 BRANCH IF YES            S20201 09912020
         L     RUCB,DXCCW11             GET RD SECTOR ADDR       Y02072 09916002
         ST    RUCB,D8(RD)              PUT IN CCW               S20201 09920020
         MVI   D8(RD),RDSC              PUT IN RD SECT CMND      S20201 09924020
         MVI   D15(RD),B1               SET BYTE CNT TO ONE      S20201 09928020
         MVC   D5(B3,RD),D1(RD)         MOVE ICB ADDR TO RH OF   S20201 09932020
*                                       CCW                      S20201 09936020
         LA    RUCB,D8(RD)              GET PTR TO RD SECT       S20201 09940020
         ST    RUCB,D0(RD)              PUT IN PREV CCW          S20201 09944020
         MVI   D0(RD),TICNOP            CHANGE CMND TO TIC       S20201 09948020
SOPA023D EQU   *                                                 S20201 09952020
*                                                                       09956020
*   AT THIS POINT A COMPLETE ICB AND CHANNEL PROGRAM IS GENERATED       09960000
*                                                                       09980000
*                                                                       10000000
*                                                                       10020000
         BCTR  RTIOT,0                  DECREMENT ICB COUNTER           10040000
         B     ICBLOOP                  REPEAT ICB LOOP                 10060000
*                                                                       10080000
*********************************************************************** 10100000
*                                                                       11780000
*                                                                       11800000
*                                                                       11820000
SOPAEND  EQU   *                                                        11840000
         SPACE                                                          11850002
         MODESET  EXTKEY=DATAMGT                                        11860002
         SPACE                                                          11870002
         OI    FCAOPEN2,FCAOIOBC        INDIC ICBS COMPLETED     YM7595 11880002
         SPACE                                                          11890002
         MODESET  KEYADDR=DXUKEY,WORKREG=10                             11900002
         SPACE                                                          11910002
         L     RUCB,DCBIOBA             GET FIRST ICB GENERATED         11980000
         ST    RUCB,0(RB)               TIE LAST ICB TO FIRST           12000000
         LA    RDEB,D40(RUCB)           GET FRST ICB CHP ADDR    S20201 12004020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD      S20201 12008020
*                                       READY                    S20201 12012020
         BO    SOPAXX                   BRANCH IF YES            S20201 12016020
         ST    RDEB,D4(RD)              PUT FIRST ICB CHP ADDR   S20201 12020020
*                                       IN                       S20201 12024020
*                                       RH OF TIC                       12028020
         B     SOPAXZ                   GO AROUND NEXT           S20201 12032020
SOPAXX   EQU   *                                                 S20201 12036020
*                                                                       12040000
         ST    RDEB,0(RD)               STORE IN NOP CCW OF LAST ICB    12060000
         MVI   0(RD),NOP                STORE NOP CMD BYTE              12080000
SOPAXZ   EQU   *                                                 S20201 12090020
*                                                                       12140000
         LA    RDEB,35(RUCB)            POINT TO FIRST ICBS CCHHR FLD   12160000
         ST    RDEB,40(RB)              STORE IN RD COUNT CCW           12180000
         MVI   40(RB),RDC               STORE READ CNT CMD BYTE         12200000
         L     RB,DCBIOBA               GET FIRST ICB                   12460000
         SR    RC,RC                                                    12480000
         L     RUCB,DCBIOBAD                                            12500000
         IC    RC,2(RUCB)               GET INPUT NOP OFFSET            12520000
*                                                                       12600000
NO       EQU   *                                                        12620000
*                                                                       12640000
         AR    RC,RB                    POIMT TO NOP CCW                12660000
*                                                                       12680000
         ST    RC,12(RUCB)              NOP ADDRESS IN MAIN IOB         12700000
         MVI   12(RUCB),IOBCEXCP        CAUSE EOB TO DO EXCP     YM6583 12710002
         MVC   32(8,RB),DCBFDAD         STORE MBBCCHHR IN ICB           12720000
         L     RB,0(RB)                 SPECIAL CONSIDERATIONS          12740000
         MVC   32(8,RB),DCBFDAD         STORE MBBCCHHR IN ICB           12760000
*                                                                       12780000
*                                                                       12800000
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 12810002
         TM    DCBDSORG,DCBDSGPO        DCB USING PAM            Y02072 12814002
         BZ    SOPAEND2                 NO BRANCH                Y02072 12816002
         MVI   NTPTINDX+1,5             STORE INDEX FOR          Y02072 12818002
*                                         NOTE-POINT ID          Y02072 12818402
*********************************************************************** 12820000
*                                                                       12880000
*        SELECT 3RD STAGE EXECUTOR                                      12884019
*                                                                       12884402
SOPAEND2 EQU   *                                                        12897702
         USING FORCORE,RCORE                                            12899702
         TM    DCBRECFM,FORMATVS           VARIABLE/SPANNED TEST A28683 12902402
         BO    UTEST                    POSSIBLE VS              A28683 12907102
         USING WTGENTRY,RWTGC                                    Y02072 12909102
LOAD13   MVC   WTGIDTTR,SOPSLDFT        GET NON-SPAN LOAD EXEC @Z30TSCF 12911103
         B     RELOOP                                            A28683 12916502
UTEST    TM    DCBRECFM,FORMATU         UNDEFINED TEST           A28683 12921202
         BO    LOAD13                   NOT VS                   A28683 12925902
         MVC   WTGIDTTR,SOP3            GET SPAN LOAD EXEC     @Z30TSCF 12927903
RELOOP   LA    RWTGC,WGOFF(0,RWTGC)     INCREMENT CURR WTG ENTRY        12940000
         LA    RPARC,PLOFF(0,RPARC)     INCR CURRENT DCB ENTRY PRTR     12960000
         CLC   0(2,RWTGC),AMIDCNST      THIS RT NEEDED AGAIN            12980000
         BCR   8,RBASE                                                  13000000
*                                                                       13020000
         CLC   0(2,RWTGC),OPIDCNST      END OF TABLE                    13040000
         BC    7,RELOOP                 NO,CHECK NEXT ENTRY             13060000
*                                                                       13080000
         LR    RPARC,RPAR                                               13100000
         LA    RWTGC,WAOFF(0,RWTG)      REINITIALIZE WTG LIST PTR       13120000
ZCHEK    CLI   0(RWTGC),X'00'          IS THIS ENTRY COMPLETE           13140000
         BC    7,TCTLRTN                IF NOT TRANSFER CONTROL         13160000
*                                                                       13180000
         LA    RWTGC,WGOFF(0,RWTGC)     GET NEXT ENTRY                  13200000
         LA    RPARC,PLOFF(0,RPARC)                                     13220000
         BC    15,ZCHEK                                                 13240000
*                                                                       13260000
TCTLRTN  EQU   *                                                        13280000
         USING WTG,RWTG                                                 13330003
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSCF*13380003
               MODID=WTGENTRY                                  @Z30TSCF 13430003
         DROP  RWTGC,RWTG                                      @Z30TSCF 13480003
*                                                                       14000000
*********************************************************************   14020000
*                                                                       14040000
ABEND    EQU   *                                                        14060000
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 14072002
         SPACE                                                          14074002
         DMABCOND OABD065,PDLOAD,RETURN=NONE,RES=NO,REGSAVE=YES  S21042X14080021
                                        CALL PROBLEM DETERMINATION      14100021
         B     TCTLRTN                                           S21042 14120021
*                                                                       14160000
*                                                                       14180000
*********************************************************************** 14200000
*                                                                       14220000
*                                                                       14240000
NOPCI    EQU    *                                                       14260000
*                                                                       14280000
         USING WTGENTRY,RWTGC                                    Y02072 14290002
         MVC   WTGIDTTR,SOP2           MUST GO TO NON PCI EXEC @Z30TSCF 14292003
         B      RELOOP                                                  14320000
         EJECT                                                          14340002
WAOFF    EQU   32                                                       14440000
PLOFF    EQU   4                        OFFSET OF DCB ENTRIES           14460000
WGOFF    EQU   8                        OFFSET OF WTG ENTRIES           14480000
AMIDCNST DC    C'1K'                                                    14500000
OPIDCNST DC    C'0S'                                                    14520000
SOPSLDFT DC    C'13',VL3(IGG01913)      NON-SPANNED EXEC       @Z30TSCF 14530003
SOP3     DC    C'16',VL3(IGG01916)      SPANNED RECORDS        @Z30TSCF 14532003
SOP2     DC    C'1D',VL3(IGG0191D)     ABNORMAL, PCI UNSUPPORT @Z30TSCF 14534003
PDLOAD   DC    C'6M',VL3(IGG0196M)      PROBLEM DETERMINATION  @Z30TSCF 14536003
*                                                                       14540000
*********************************************************************** 14560000
*      CONSTANTS AND RESERVED STORAGE.                                  14580000
*                                                                       14620000
CONONE   DC    H'1'                                                     14660000
CCWCNSTS DC    X'68000005'                                              14760000
SCCWCNST DC    X'4000000508'                                            14820000
PATCH    DC    0H'0',50X'00'            PATCH AREA               Y02072 14830002
END      EQU   *                        END OF MODULE            Y02072 14920002
         EJECT                                                          14930002
         IGGBCB  TYPE=SAM                                               14940002
         EJECT                                                          14970002
         DCBD  DSORG=PS                                                 15400002
NTPTINDX EQU   DCBCNTRL                 NOTE/POINT INDEX         Y02072 15450002
         EJECT                                                          15500003
CVT      DSECT                                                 @Z30TSCF 15550003
         CVT                                                   @Z30TSCF 15600003
         IECDSECS (MAIN,(IOB,NO)),IOB,WTG,PREFX,EXPAND=YES     @Z30TSCF 16130003
         ORG   WTGIDTTR                                          Y02027 16132002
WTGID    DS    CL2                      NEXT MOD ID              Y02072 16134002
         EJECT                                                          16134402
FORCORE  DSECT                                                   Y02072 16134802
         IHAFCAUD  ORG=YES                                       Y02072 16135202
         EJECT                                                          16136002
         IEZDEB                                                  Y02072 16140002
         EJECT                                                          16142002
         IKJTCB                                                  Y02072 16150002
         EJECT                                                          16150402
         IHAICB                                                  Y02072 16152002
         ORG   ICBR+1                                            Y02072 16154002
         IHACCW  DSECT=NO                                        Y02072 16156002
           END                                                          16160000
