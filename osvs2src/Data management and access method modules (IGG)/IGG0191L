  TITLE 'IGG0191L--STAGE TWO OPEN EXECUTOR FOR CREATE BDAM'      S19015 00010019
IGG0191L CSECT                                                          00020000
*                                                                     * 00030002
*MODULE NAME - IGG0191L                                               * 00040002
*                                                                     * 00050002
*DESCRIPTIVE NAME - STAGE TWO OPEN EXECUTOR FOR BDAM CREATE           * 00050402
*                                                                     * 00050802
*COPYRIGHT - NONE                                                     * 00051202
*                                                                     * 00051602
*CHANGE ACTIVITY                                                      * 00051702
*                                                                     * 00051802
*          RELEASE 19 CHANGES/DELETIONS                                 00052002
*1020005000-005600,026200,044400,044600-060400,066400,081600-    S19015 00054019
*1020084200,087600,088800,091000                                 S19015 00056019
*                                                                M3933  00058019
*          RELEASE 20 CHANGES/DELETIONS                                 00060002
*1180011400,017200,036600,080800                                 S20201 00064020
*          RELEASE 21 CHANGES/DELETIONS                                 00068002
*0072034600-034750                                               A42456 00072021
*                                                               SA53272 00074021
*017400-017520                                                  SA55520 00074402
*                                                               SA55544 00074802
*                                                               SA60763 00075202
*          RELEASE VS1-1 CHANGES/DELETIONS                              00076002
*          RELEASE VS2-1 CHANGES/DELETIONS                              00078002
*          RELEASE VS1-2 CHANGES/DELETIONS                              00080002
*          RELEASE VS2-2 CHANGES/DELETIONS                              00082002
*067200,067600-068960,073400-073600,077400,079000-079400,        Y02072 00086002
*080220-080260,080340                                            Y02072 00088002
*                                                                YM1140 00090002
*                                                                YM2886 00092002
*          RELEASE VS2-3 CHANGES/DELETIONS                              00092403
*                                                              @Z30TSMI 00092803
*          CHANGES SUBSEQUENT TO VS2-3                                  00093237
*C025320,089982                                                 ZA10231 00093637
*                                                                       00094002
*STATUS CHANGE LEVEL 010                                                00107003
*                                                                       00115019
*    THIS EXECUTOR IS SPLIT INTO IGG0199L AT RELEASE 19.THE NEW         00116002
*    EXECUTOR WILL BE XCTLED FROM THIS TO FINISH CCW CONSTRUCTION       00117019
*FUNCTIONS- THIS ROUTINE IS GIVEN CONTROL AFTER THE DEB HAS BEEN        00120000
*    CONSTRUCTED AND HAS THE FOLLOWING FUNCTIONS,                       00140000
*    1. OBTAIN CORE FOR IOB-CHANNEL PROGRAMS AND INITIALIZE THOSE AREAS 00160000
*       (AN AUDIT TRAIL BIT IS SET TO INDICATE CORE WAS OBTAINED FOR    00170002
*       THE IOBS. THIS BIT WILL BE INTERROGATED BY THE FORCE CLOSE      00172002
*       EXECUTOR, SHOULD AN ABEND OCCUR DURING OPEN PROCESSING.)        00174002
*    2. LOAD THE CHECK ROUTINE AND A WRITE ROUTINE.                     00180000
*                                                                       00200000
*ENTRY POINT- ENTRY IS TO THE FIRST BYTE OF CODE BY A XCTL ISSUED BY    00220000
*    THE PREVIOUS EXECUTOR.                                             00240000
*                                                                       00260000
*INPUT- REGISTERS 5,6,7,8 HAVE BEEN POSITIONED AS FOLLOWS,              00280000
*    5 = BEGINNING OF THE OPEN PARAMETER LIST                           00300000
*    6 = BEGINNING OF THE WHERE-TO-GO TABLE  (WTG)                      00320000
*    7 = CURRENT ENTRY IN THE PARAMETER LIST                            00340000
*    8 = CURRENT ENTRY IN THE WTG TABLE                                 00360000
*                                                                       00380000
*OUTPUT- THE SPECIFIED NUMBER OF IOB-CHANNEL PROGRAMS WILL BE LINKED TO 00400000
*    THE DCB, A CHECK AND A WRITE ROUTINE WILL HAVE BEEN LOADED AND     00420000
*    THEIR ADDRESSES INSERTED IN THE DCB AND THEIR ID'S INSERTED IN THE 00440000
*    DEB. THE REGISTERS 7 AND 8 WILL BE POSITIONED AT THE NEXT          00460000
*    NON-ZERO ENTRY IN THE PARAMETER LIST AND WTG TABLE.                00480000
*                                                                       00580000
*EXTERNAL ROUTINES-                                                     00600000
*                                                                       00620000
*EXIT- AT THE INSTRUCTION LABELED 'XCTLRTN', THE PARAMETERS FOR XCTL    00640000
*    ARE SET UP AND XCTL ISSUED FOR THE NEXT NON-ZERO ENTRY IN THE      00660000
*    WTG TABLE.                                                         00680000
*EXIT ABNORMAL-IF THE RECORD FORMAT IS NOT SPECIFIED (RECFM=0) OR       00680402
*    IF THE MACRF FIELD SPECIFIES EITHER INPUT MACRO(READ OR GET)       00680802
*    AN ERROR CONDITION EXISTS. CONTROL IS TRANSFERRED TO THE PROBLEM   00681202
*    DETERMINATION MODULE, IGG0196M, WHICH WILL ISSUE ABEND 013.        00681602
*                                                                       00682019
*    IF RECFM=F AND TRACK-OVERFLOW,IS SPECIFIED,EXECUTOR IGG0191M       00684019
*    WILL COMPLETE THE CONSTRUCTION OF IOBS AND CHANNEL PROGRAMS        00686019
*                                                                       00688019
*    OTHER THAN THE ABOVE,EXECUTOR IGG0199L WILL CONSTRUCT CHANNEL      00690019
*    PROGRAMS                                                           00692019
*                                                                       00700000
*TABLES/WORK AREA- 1. COMMUNICATION VECTOR TABLE (CVT) IS USED TO       00720000
*    LOCATE THE DIRECT ACCESS DEVICE TABLE, AND THE SVC DCB ADDRESS.    00740000
*    2.DIRECT ACCESS DEVICE TABLE (DADT) IS USED TO OBTAIN THE TRACK    00760000
*      LENGTH FOR THE DEVICE.                                           00780000
*    3.WHERE-TO-GO TABLE IS CONSTRUCTED BY THE INITIAL OPEN ROUTINE     00800000
*      AND CONSISTS OF,  2 BYTE ID OF THE FIRST EXECUTOR FOR THIS DCB   00820000
*                        3 BYTE TTR OF THAT EXECUTOR                    00840000
*                        3 BYTE ADDRESS OF A WORK AREA FOR THIS DCB     00860000
*    4.CORRESPONDING TO EACH ENTRY IN THE WTG TABLE IS AN ENTRY IN A    00880000
*      PARAMETER LIST,   1 BYTE ATTRIBUTE (INPUT, OUTPUT, UPDATE)       00900000
*                        3 BYTE DCB ADDRESS                             00920000
*                                                                       00940000
*ATTRIBUTES- THIS ROUTINE IS REENTRANT, EXECUTED ENABLED, PRIVILEGED.   00960002
*    IT WILL EXECUTE IN DATA MANAGEMENT KEY FOR ALL BUT IOB CHAINING    00970002
*    WHICH WILL EXECUTE IN USER KEY.                                    00972002
*                                                                       00974002
*MACROS - MODESET,GETMAIN,LOAD,XCTL                                     00976002
         EJECT                                                          00980000
*                                                                       01000000
*                                                                       01020000
*   REGISTER USAGE                                                      01040000
*                                                                       01060000
         USING STEPONE,RBASE                                            01080000
         USING DEBBASIC,RDEB                                            01100002
         USING IHADCB,RDCB                                              01120000
         USING FORCORE,RCORE                                     Y01021 01140000
         USING WTG,RWTG                                                 01150003
         USING WTGENTRY,RWTGC                                           01152003
*                                                                       01160000
RE       EQU   0         WORK/PARAMETER REGISTER                        01180000
RF       EQU   1         WORK/PARAMETER REGISTER                        01200000
RDCB     EQU   2         DCB ADDRESS                                    01220000
RBASE    EQU   3         BASE FOR THIS MODULE                           01240000
RCORE    EQU   4         DCB WORK AREA ADDRESS                          01260000
RPAR     EQU   5         POINTER TO THE PARAMETER LIST                  01280000
RWTG     EQU   6         POINTER TO THE WHERE-TO-GO TABLE               01300000
RPARC    EQU   7         CURRENT ENTRY IN PARAMETER LIST                01320000
RWTGC    EQU   8         CURRENT ENTRY IN WHERE-TO-GO TABLE             01340000
RTIOT    EQU   9         TIOT ADDRESS                                   01360000
RWORK    EQU   9         WORK REGISTER                           Y02072 01370002
RUCB     EQU   10        UCB ADDRESS                                    01380000
RDEB     EQU   11        DEB ADDRESS                                    01400000
RB       EQU   12        WORK REGISTER                                  01420000
RC       EQU   13        WORK REGISTER                                  01440000
RD       EQU   14        WORK REGISTER                                  01460000
RJ       EQU   15        WORK/PARAMETER REGISTER                        01480000
*                                                                       01500000
*                                                                       01520000
*                                                                       01540000
         BALR  RBASE,0                 ESTABLISH BASE FOR THIS MODULE   01560000
STEPONE  L     RDCB,0(0,RPARC)         LOAD DCB ADDRESS                 01580000
         L     RCORE,4(0,RWTGC)        LOAD ADDRESS OF DCB WORK AREA    01600000
         L     RDEB,DCBDEBAD           LOAD DEB ADDRESS FROM DCB        01620000
*                                                                       01640000
*   INITIALIZE THE DCB FIELDS REQUIRED FOR THE LOADING OF THE DATA SET  01660000
*                                                                       01680000
         TM    DCBRECFM,X'C0'           WAS RECORD FORMAT OMITTED       01700002
         BNZ   NOTOMIT                  NO, CHECK V OR F         S20201 01720020
         LA    RE,105                   INTERNAL RET CODE IN R0 SA55520 01730002
         B     CALLPD                   BR TO PROB DETERMINATON SA55520 01740002
NOTOMIT  EQU   *                                                 S20201 01755020
         CLI   DCBMACR1,0               READ OR GET SPECIFIED   SA60763 01757002
         BE    NOTREAD                  BR IF NOT, OK           SA60763 01759002
         LA    RE,229                   INTERNAL RET CODE IN R0 SA60763 01759402
         B     CALLPD                   BR TO PROB DETERMINATON SA60763 01759802
NOTREAD  EQU   *                                                        01770002
         IC    RB,DCBDEVT               GET DEVICE TYPE FROM THE DCB    01780002
         LA    RD,15                    USE THE LO-ORDER 4 BITS AS AN   01800002
         NR    RB,RD                    OFFSET TO A ONE BYTE OFFSET IN  01820000
         L     RC,CVTPTR(0,0)           THE DEVICE TABLE                01840000
         USING CVT,RC                                                   01860003
         L     RC,CVTZDTAB              GET DADT ADDRESS FROM CVT       01880002
         DROP  RC                                                       01900000
         IC    RD,0(RB,RC)              PICK UP OFFSET ENTRY IN DADT    01920002
         AR    RC,RD                    COMBINE OFFSET BYTE,TABLE ADDR. 01940002
         USING DVCT,RC                  EST DEV CHAR TAB BASE    Y02072 01950002
         MVC   DCBTRBAL,DVCTRKLN        INITIALIZE TRACK BALANCE Y02072 01960002
         DROP  RC                       DROP DEV CHAR TAB BASE   Y02072 01970002
         ST    RC,DCBDVTBL              AND DEVICE TABLE ADDRESS        01980000
         XC    DCBCIND1(2),DCBCIND1     CLEAR INDICATOR BYTES           02060002
*                                                                       02080000
*   CALCULATE THE SIZE OF EACH IOB REQUIRED AND MULTIPLY BY THE NO. OF  02100000
*    IOBS. GET CORE AND CLEAR THAT CORE TO ZERO.                        02120000
*                                                                       02140000
         LA    RC,SZFNOWC               SET IOB SIZE TO FORMAT F,NO WC  02160002
         LA    RD,SZWCF                 PRE-SET WRITE CHECK INCREMENT   02180002
         TM    JFCBMASK+D6,NONCARN      IS THIS A REC REDY       S20201 02182020
*                                       DEVICE                   S20201 02184020
         BO    NOTCARN1                 NO,SKIP TWO INSTRUCTIONS S20201 02186020
         LA    RC,CARN24(RE,RC)         YES, INCREMENT C.P. AND  S20201 02188020
         LA    RD,CARN16(RE,RD)         WRTCHK PGM SIZE          S20201 02190020
NOTCARN1 EQU   *                                                 S20201 02192020
         TM    DCBRECFM,VORU            IS RECORD FORMAT FIXED          02220002
         BNO   NOTV                     YES,USE PRESET VALUES           02230002
         LA    RD,SZWCV                 SET WC INCR FOR V,U RECORDS     02240002
         LA    RC,SZVORU(0,RC)          INCREMENT FOR V,U RECORDS       02250002
         TM    JFCBMASK+D6,NONCARN      ARE WE TOYING WITH RPS   S20201 02251020
         BO    NOTV                     NO,SKIP NEXT TWO         S20201 02252020
*                                       INSTRUCTIONS             S20201 02253020
         LA    RD,CARN8(RE,RD)          YES, ALLOW FOR WRTCHK    S20201 02254020
*                                       V/U CCW'S AND FOR V/U           02255020
         LA    RC,CARN8(RE,RC)          CCWS                     S20201 02256020
NOTV     TM    DCBRECFM,OFLOWOPT        IS TRACK OVERFLOW TO BE USED    02260002
         BC    8,TSTWCOPT               NO, GO TEST WRITE CHECK OPTION  02300000
         LA    RC,OFLOWSZ               SET BASIC IOB SIZE              02320002
         LA    RD,OFLWCSZ               AND WRITE CHECK INCREMENT       02340000
         TM    JFCBMASK+D6,NONCARN      DOES DEVICE HAVE RPS     S20201 02342020
         BO    NOTCARN2                 NO,SKIP FOLLOWING        S20201 02344020
*                                       INSTRUCTIONS             S20201 02346020
         LA    RC,OVFLCARN(RE,RC)       YES, ALLOW SPACE TO BLD  S20201 02348020
*                                       AN OVERFLOW CHAN PGM            02350002
         LA    RD,OVFCARWC(RE,RD)       WITH WRT CHK             S20201 02352020
NOTCARN2 EQU   *                                                 S20201 02354020
         LA    RF,2                     INITIALIZE SEGMENT COUNT        02360002
         L     RB,DCBDVTBL              LOAD DEVICE CHAR TAB    SA55544 02370002
         USING DVCT,RB                  ESTABLISH DEVTAB BASE   SA55544 02380002
         SR    RE,RE                    CLEAR R0                SA55544 02382002
         IC    RE,DVCOVLB               GET LAST BLK OVERHEAD   SA55544 02390002
         TM    DVCFLAGS,DVC2BOV         IS IT 2 BYTE OVERHEAD   SA55544 02400002
         BNO   NOT2BYTE                 BRANCH IF NOT 2 BYTES   SA55544 02410002
         LH    RE,DVCOVHD               ELSE LOAD BOTH BYTES    SA55544 02412002
         DROP  RB                       DROP DEV CHAR TAB BASE  SA55544 02412402
NOT2BYTE EQU   *                                                SA55544 02414002
         LH    RB,DCBTRBAL              LOAD TRACK BALANCE      SA55544 02416002
         SR    RB,RE                    SUBTR OVERHEAD OF LAST  SA55544 02418002
*                                       REC FROM TRK BALANCE    SA55544 02418802
         LH    RE,DCBBLKSI              SET REGISTER RE TO DATA SA55544 02420002
         BCTR  RE,0                     LENGTH MINUS ONE        SA55544 02440002
EACHSEG  SR    RE,RB                    (DATA LENGTH-1)-TRK LG  SA55544 02460002
         BC    12,OFLSZSET              ALL OVERFLOW SEGMENTS COUNTED   02480002
         LA    RC,OFLINCSZ(0,RC)        INCREMENT BOTH IOB SIZE         02500002
         LA    RD,OFLWCINC(0,RD)        REGISTERS                       02520000
         TM    JFCBMASK+D6,NONCARN      IS RPS FEATURED          S20201 02524020
         BO    NOTCARN3                 NO, SKIP RPS INSTRUCTION S20201 02528020
         LA    RC,OFCARSEG(RC)          YES, ALLOW FOR OVERFLOW ZA10231 02532037
NOTCARN3 EQU   *                                                 S20201 02536020
         LA    RF,1(0,RF)               INCREMENT SEGMENT COUNT         02540002
         B     EACHSEG                  LOOP                            02560002
*                                                                       02580000
OFLSZSET STC   RF,DCBEOBR+1             STORE SEGMENT COUNT IN DCB      02600002
*                                                                       02640000
TSTWCOPT TM    DCBOPTCD,WRTCHK          IS WRITE CHECK SPECIFIED        02720002
         BC    8,TSTNCP                 NO, GO DETERMINE NO. OF IOBS    02740000
         AR    RC,RD                    YES, ADD FOR WRITE CHECK CCWS   02760000
*                                                                       02800000
TSTNCP   SR    RB,RB                    INSERT NUMBER OF CHANNEL PGMS   02820002
         IC    RB,DCBNCP                                                02840000
         LTR   RB,RB                                                    02860000
         BC    7,*+8                                                    02880000
         LA    RB,1                     IF NOT SPECIFIED, ASSUME ONE    02900000
         STC   RB,DCBNCP                STORE DEFAULT IN DCB     S19015 02910019
         LR    RUCB,RB                  SAVE NO. OF CHANNEL PROGRAMS    02920002
         LR    RTIOT,RC                 SAVE IOB LENGTH                 02940002
         SRL   RTIOT,3                  DIVIDE FOR DOUBLE WORD COUNT    02960002
         STC   RTIOT,DCBIOBL            ST IOB LENGTH IN DOUBLE WORDS   02980002
         SLL   RTIOT,3                  RESTORE FULL IOB LENGTH         03000002
         MR    RB,RB                    MULTIPLY LENGTH X NUMBER        03020002
*                                                                       03040000
         TM    DCBRECFM,OFLOWOPT        IS TRACK OVERFLOW USED          03060002
         BC    8,GETIOBS                NO, GO TO GET CORE              03080000
         SR    RE,RE                    CLEAR REGISTER                  03100002
         L     RF,DCBDVTBL              GET ADDR OF THE DADT            03120002
         USING DVCT,RF                  EST DEV CHAR TAB BASE    Y02072 03130002
         SR    RB,RB                    CLEAR REGISTER                  03140002
         SR    RJ,RJ                    CLEAR REGISTER                  03160002
         IC    RJ,DVCOVLB               OVERHEAD FOR LAST RECORD Y02072 03180002
         TM    DVCFLAGS,DVC2BOV         TWO BYTE OVERHEAD USED   Y02072 03184002
         BNO   MZ0010                   BRANCH NO                S20201 03188020
         LH    RJ,DVCOVHD               GET TWO BYTE OVERHEAD    Y02072 03192002
MZ0010   EQU   *                                                 S20201 03196020
         IC    RE,DCBKEYLE              GET KEY LENGTH IF THERE IS ONE  03200002
         LTR   RE,RE                    TEST TO SEE IF THERE ARE KEYS   03220002
         BC    7,*+8                    YES GO ON, IF NOT               03240002
         IC    RB,DVCOVNK               GET OVERHEAD FOR KEYS    Y02072 03260002
         DROP  RF                       DROP DEV CHAR TAB BASE   Y02072 03270002
         SR    RJ,RB                    SUBTRACT KEY O'HEAD IF NO KEYS  03280002
         AR    RE,RJ                    ADD ON OVERHEAD                 03300002
         AH    RE,DCBBLKSI              DEVELOP KEY LENGTH PLUS DATA LG 03320002
         STH   RE,DCBOFFSR              STORE TOTAL LAST RECORD SIZE    03340002
         CH    RE,DCBTRBAL              COMPARE RECORD SIZE TO TRACK    03360002
         BNH   ADDERASE                 LENGTH. IF SMALLER BRANCH       03380000
         OI    DCBEOBW+3,X'FF'          MARK ERASE CCWS INCLUDED        03420002
ADDERASE EQU   *                                                        03440000
         LA    RC,ERSINC(0,RC)          ADD CORE FOR ERASE CCW  SA53272 03446002
         TM    JFCBMASK+D6,NONCARN      IS DEVICE RPS           SA53272 03452002
         BO    GETIOBS                  NO, GO GET CORE         SA53272 03458002
         LA    RC,CARN24(RE,RC)         YES, ADD MORE CORE FOR  SA53272 03464002
*                                       ERASE CCWS                      03470002
*                                                                       03480000
GETIOBS  EQU   *                        OBTAIN CORE FOR ALL IOBS AND    03500002
*                                       CHANNEL PROGRAMS                03520002
*                                                                       03530002
         MODESET  KEYADDR=DXUKEY,WORKREG=12  CHANGE TO USER KEY  Y02072 03532002
*                                                                       03534002
         LA    RE,SUBPOOL0              SET SUBPOOL NO. TO 0     Y02072 03540002
         SLL   RE,24                                                    03560000
         LR    RB,RC                    SAVE SIZE OF CORE        S20201 03562020
*                                       ACQUIRED                 S20201 03564002
         TM    JFCBMASK+D6,NONCARN      IS THIS RPS              S20201 03566020
         BO    GETSPACE                 NO, GO ISSUE A GETMAIN   S20201 03568020
         LA    RC,SECTAREA(0,RC)        ELSE INCREMENT FOR       S20201 03570020
*                                       SECTOR CORE              S20201 03572020
GETSPACE EQU   *                                                 S20201 03574020
         OR    RE,RC                    MOVE PARAMETER TO REGISTER 0    03580002
         GETMAIN R,LV=(0)                                               03600000
*                                                                       03620000
         MODESET  EXTKEY=DATAMGT        RETURN TO DATAMGT KEY    Y02072 03630002
*                                                                       03632002
         ST    RF,DCBIOBA               STORE FIRST IOB ADDRESS AND     03640002
         OI    DXATEXC1,FCAOIOB         SET AUDIT TRAIL BIT      Y02072 03642002
*                                       FOR FORCE CLOSE CLEANUP  Y02072 03644002
*                                       INDICATING IOBS GOTTEN   Y02072 03646002
         AR    RB,RF                    LOCATE SECTOR STORAGE    S20201 03650020
*                                       ADDR                     S20201 03660020
         LR    RE,RB                    SAVE SECTOR ADDRESS      S20201 03670020
         LR    RJ,RF                    SAVE ADDRESS OF IOB CORE        03700002
         IC    RD,CON255                SET BYTE COUNT FOR CLEAR INSTR. 03720002
         LR    RB,RC                    INITIALIZE RB TO TOTAL SIZE     03740002
*                                                                       03742002
         MODESET   KEYADDR=DXUKEY,WORKREG=13  CHANGE TO USER KEY TO    X03750002
                                        CHAIN THE IOBS           Y02072 03752002
LOOP     SH    RB,CON256                SUBTRACT LENGTH OF ONE CLEAR    03760002
         BC    12,LASTEX                IF ZERO OR MINUS GO FINISH CLR. 03780000
         EX    RD,CLRINST               EXECUTE A 256 BYTE CLEAR INSTR. 03800002
         LA    RF,256(0,RF)             INCREMENT THE AREA ADDRESS      03820002
         B     LOOP                     AND REPEAT                      03840000
*                                                                       03860000
CLRINST  XC    0(1,RF),0(RF)            EXECUTED-SET 256 BYTES TO ZERO  03880002
*                                                                       03900000
LASTEX   AR    RB,RD                    RESTORE RB TO LENGTH MINUS ONE  03920002
         EX    RB,CLRINST               AND CLEAR REMAINING LENGTH      03940000
*                                                                       03960000
*   LINK THE IOBS TOGETHER AND LINK THE FIRST ONE TO THE DCB.           03980000
*                                                                       04000000
         USING IOBBSAMN,RF              ESTABLISH IOB BASE              04020002
         LR    RF,RJ                    INITIALIZE TWO REGS TO IOB1     04040002
         ST    RE,IOBSTART              STORE SECTOR ADDRESS            04045002
*                                       TEMPORARILY                     04050002
         B     LINKIOB1                 GO TEST FOR LAST IOB FOUND      04060000
NEXTLINK AR    RJ,RTIOT                 INCREMENT BY IOB SIZE           04080002
         ST    RJ,IOBNIOBA              STORE AS FORWARD POINTER        04100002
         LR    RF,RJ                    INCREMENT IOB BASE TO NEXT IOB  04120002
LINKIOB1 OI    IOBFLAG2,IOBRRT3         MAKE EXCP RELATED REQ.   Y02072 04150002
*                                       PROCESSING TYPE 3        Y02072 04152002
         BCT   RUCB,NEXTLINK            TEST-ANY MORE IOBS BEYOND THIS  04154002
         L     RJ,DCBIOBA               NO, LOAD AND STORE ADDRESS OF   04160000
         ST    RJ,IOBNIOBA              IOB1 IN LAST IOB                04180002
         DROP  RF                                                       04180402
*                                                                       04182002
         MODESET  EXTKEY=DATAMGT        RETURN TO DATA MGT KEY   Y02072 04190002
*                                                                       04200002
         TM    DCBEOBW+3,X'FF'          ARE OVERFLOW ERASE CCWS NEEDED  04220002
         BC    12,NOERASE               NO, GO INITIALIZE IOBS          04240000
         AR    RF,RTIOT                 DEVELOP AND STORE THE ADDRESS   04260002
         ST    RF,DCBEOBW               OF THE ERASE CCWS               04280000
GETID2   MVC   WTGIDTTR,IDNEXT          ID OF NXT EXECUTOR FOR @Z30TSMI 04300003
         B     LDRTN                    THIS DCB, GO LOAD MODULES       04320000
*                                                                       04340000
*                                                                       04360000
NOERASE  EQU   *                                                        04380000
         TM    DCBRECFM,OFLOWOPT        IS OVERFLOW OPTION SELECTED     04400002
         BC    1,GETID2                 YES, GO MOVE NEXT ID-TTR        04420000
         MVC   WTGIDTTR,ID9L            MOVE ID OF IGG0199L    @Z30TSMI 04440003
*                                                                       06060000
*   LOAD THE CHECK ROUTINE AND THE PROPER WRITE ROUTINE.                06080000
*                                                                       06100000
LDRTN    EQU   *                                                        06120000
         IC    RUCB,DEBNMEXT            SET A REGISTER TO THE DEB       06140002
         SLL   RUCB,4                   SUBROUTINE ID FIELD             06160002
         LA    RUCB,DEBBASND-DEBBASIC(RUCB,RDEB)  POINT BEYOND   Y02072 06180002
*                                       DEVICE DEPENDENT SECTION Y02072 06190002
*                                       TO MODULE ID SECTION     Y02072 06192002
         SR    RF,RF                                                    06200000
         IC    RF,DEBAMLNG                                              06220000
         AR    RUCB,RF                                                  06240000
         LA    RC,IDCHK                 LOAD ADDR OF CHECK       S19015 06246019
*                                       ROUTINE ID               S19015 06252019
*                                                                       06260000
         TM    DCBRECFM,VORU            DETERMINE WHICH WRITE MODULE TO 06280002
         BC    1,LDWRTVU                LOAD                            06300000
         LA    RB,IDWRTF                POSITION POINTER TO WRITE F ID  06320002
         TM    DCBRECFM,OFLOWOPT        TRACK OVERFLOW TO BE USED       06340002
         BC    8,LDWRT                  NO, LOAD IGG019DA               06360000
         LA    RB,IDWRTOF               YES, LOAD IGG019DD              06380000
LDWRT    BAL   RTIOT,MODLOAD            GO TO THE LOAD ROUTINE          06400000
         IC    RF,DCBWRITE              SAVE TOP BYTE IN FIELD          06420002
         ST    RE,DCBWRITE              STORE WRITE ROUTINE ADDRESS     06440002
         STC   RF,DCBWRITE              IN THE DCB                      06460000
         LA    RB,IDCHK                 SET POINTER TO CHECK ROUTINE ID 06500002
         LR    RB,RC                    SET POINTER TO CHECK     S19015 06506019
*                                       ROUTINE I                S19015 06512019
         BAL   RTIOT,MODLOAD            GO LOAD CHECK                   06520000
         IC    RJ,DCBOPTCD              STORE THE ADDRESS IN THE DCB    06540002
         ST    RE,DCBCHECK              SAVING THE TOP BYTE             06560002
         STC   RJ,DCBOPTCD                                              06580000
         B     SCAN                     GO SCAN FOR ANOTHER DCB PARAM.  06600000
*                                       WHICH IS UNFINISHED             06620002
*                                                                       06621019
LDWRTVU  EQU   *                                                 S19015 06622019
*                                                                       06623019
*   THE FOLLOWING ROUTINE WILL CHECK FOR RECFM=VS AND BFTEK=R.          06624019
*    YES - LOAD 'CREAT BDAM WITH SOFTWARE TRACK-OVERFLOW' ROUTINES      06625019
*    NO  - LOAD NORMAL CREAT BDAM FORMAT V/U ROUTINE                    06626019
*                                                                       06627019
         TM    DCBBFTEK,SOFTTRK         TEST IF BFTEK=R IS       S19015 06628019
*                                       SPECIFIED                S19015 06629019
         BNO   LOADUV                   NO,GOTO LOAD NORMAL      S19015 06630019
*                                       ROUTINE                  S19015 06631019
*                                                                       06632019
*   WHEN RECFM=VS AND BFTEK=R,THE FOLLOWINGS ARE TO BE LOADED.          06633019
*        IGG019BR - WRITE ROUTINE                                       06634019
*        IGG019BS - CHECK ROUTINE                                       06635019
*        IGG019BT - C.E.A.                                              06636019
*                                                                       06637019
         LA    RB,IDBT                  LOAD ADDR OF C.E.A.      S19015 06638019
         BAL   RWORK,MODLOAD            GOTO LOAD ROUTINE        Y02072 06639002
         L     RWORK,DEBAPPAD           LOAD ADDR OF APP VECTOR  Y02072 06640002
*                                       TABLE                    S19015 06641019
         USING  DEBAVT,RWORK            ESTABLISH BASE FOR AVT   Y02072 06641402
         ST    RE,DEBCEA                STORE RTN ADDR IN AVT    Y02072 06642002
         ST    RE,DEBXCEA               STORE RTN ADDR IN AVT    Y02072 06644002
         DROP  RWORK                                             Y02072 06646002
         LA    RC,IDBS                   LOAD ADDR OF IGG019BS   S19015 06647701
         LA    RB,IDBR                   LOAD ADDR OF WRITE(VS)  S19015 06648002
         B     LDWRT                     GOTO LOAD WRITE ROUTINE S19015 06649002
*                                                                       06650019
*   NORMAL WRITE (CREATE BDAM) ROUTINE                                  06651019
*                                                                       06652019
LOADUV   EQU   *                                                 S19015 06653002
         LA    RB,IDWRTVU                LOAD ADDR OF NORMAL     S19015 06655002
*                                        WRITE RTN               S19015 06656002
         B     LDWRT                     GO BACK TO BRANCH TO LOAD      06660002
*                                                                       06680000
MODLOAD  EQU   *                        ROUTINE LOADS SPECIFIED MODULES 06700002
         MVC   6(2,RWTG),0(RB)          LOAD MODULE BY ID        Y02072 06740002
         LR    RE,RWTG                  SET PARAMETER REGISTER          06920002
         L     RF,CVTPTR(0,0)           GET THE LPALIB DCB ADDRESS      06940002
         USING CVT,RF                                                   06960003
         L     RF,CVTLINK               FROM THE CVT             YM1140 06980002
         DROP  RF                                                       07000000
*                                                                       07020000
         LOAD  EPLOC=(0),DCB=(1)        LOAD MODULE              Y02072 07040002
*                                                                       07060000
         MVC   0(2,RUCB),0(RB)          PUT SUBROUTINE ID IN THE DEB    07080002
         LA    RUCB,2(0,RUCB)           AND INCREMENT INDEX             07100000
         IC    RJ,DEBNMSUB              INCREMENT THE NUMBER OF         07120002
         LA    RJ,1(0,RJ)               SUBROUTINES FIELD IN THE DEB    07140000
         STC   RJ,DEBNMSUB                                              07160000
         BR    RTIOT                    RETURN TO THE BAL+4             07180002
*                                                                       07190002
*  GO TO PROBLEM DETERMINATION(IGG0196M) FOR WTP MESSAGE AND RET CODE   07200002
*                                                                       07210002
CALLPD   EQU   *                                                SA55520 07230002
         DMABCOND (0),PDLOAD,RETURN=NONE,RES=NO,REGSAVE=YES     SA55520 07232002
         B     XCTLRTN                  BRANCH TO XCTL          SA55520 07234002
*                                                                       07240000
*   SCAN THE DCB PARAMETER LIST FOR ANOTHER REQUEST FOR THIS EXECUTOR   07260000
*    IF NONE ARE FOUND TRANSER CONTROL TO THE FIRST EXECUTOR FOUND.     07280000
*                                                                       07300000
SCAN    EQU   *                                                         07320000
         LA    RWTGC,WGOFF(0,RWTGC)     INCREMENT WHERE-TO-GO INDEX AND 07400002
         LA    RPARC,PAROFF(0,RPARC)    PARAMETER LIST INDEX            07420000
         CLC   0(2,RWTGC),AMIDCNST      IS THIS EXECUTOR NAMED AGAIN    07440002
         BCR   8,RBASE                  YES, RETURN TO STARTING POINT   07460000
         CLC   0(2,RWTGC),OPIDCNST      THIS END OF WHERE-TO-GO TABLE   07480002
         BC    7,SCAN                   NO, CONTINUE SCAN        Y02072 07500002
*                                                                       07520000
         LR    RPARC,RPAR               RESET PARAMETER LIST INDEX AND  07540002
         LA    RWTGC,32(0,RWTG)         WHERE-TO-GO INDEX TO ENTRY ONE  07560000
SCAN4ANY CLI   0(RWTGC),0               IS THIS DCB COMPLETED           07580002
         BC    7,XCTLRTN                NO, XCTL TO NAMED EXECUTOR      07600000
         LA    RWTGC,WGOFF(0,RWTGC)     YES, INCREMENT BOTH INDEX REG.S 07620000
         LA    RPARC,PAROFF(0,RPARC)                                    07640000
         BC    15,SCAN4ANY              AND CONTINUE SCAN               07660002
*                                                                       07680000
XCTLRTN  EQU   *                                                        07700000
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSMI*07720003
               MODID=WTGENTRY           GO TO NEXT EXEC        @Z30TSMI 07770003
*                                                                       07800000
*********************************************************************** 07810002
*             CONSTANTS AND EQUATES                                     07820002
*********************************************************************** 07830002
*                                                                       07840000
WGOFF    EQU   8                       OFFSET OF ENTRIES IN WTG TABLE   07980000
PAROFF   EQU   4                       OFFSET OF ENTRIES IN PARAM. LIST 08000000
IDLENGTH EQU   2                        LEN OF ID PUT IN W-T-G   Y02072 08010002
TWO      EQU   2                        CONSTANT '2'             S19015 08028019
FIVE     EQU   5                        CONSTANT '5'             S19015 08030019
*                                                                       08032019
SUBPOOL0 EQU   0                        SUBPOOL 0 FOR USER KEY   Y02072 08032402
*                                                                       08036019
***************                                                         08040000
*                                                                       08060000
D6       EQU   6                        OFFSET TO JFCB REC REDY  S20201 08061020
*                                       BIT                      S20201 08062020
CARN8    EQU   8                        SIZE INCREMENT FOR       S20201 08063020
*                                       WRTCHK V/U               S20201 08064020
CARN16   EQU   16                       INCREMENT FOR REGULAR    S20201 08065020
*                                       WRTCHK                   S20201 08066020
CARN24   EQU   24                       CHAN PROG SIZE INCREMENT S20201 08067020
CARN32   EQU   32                       SIZE INCREMENT FOR V/U   S20201 08068020
TBOVHD   EQU   X'08'                    TWO BYTE OVERHEAD INDIC  S20201 08069020
NONCARN  EQU   X'20'                    REC REDY TEST BIT        S20201 08070020
OVFLCARN EQU   48                       BASIC SIZE FOR OVFLO &   S20201 08071020
*                                       RPS                      S20201 08072020
OVFCARWC EQU   8                        OVFLO WRTCHK INCREMENT   S20201 08073020
OFCARSEG EQU   16                       OVFLO SEGMENT INCREMENT  S20201 08074020
OFCARWC  EQU   8                        OVFLO WRTCHK SEGMENT     S20201 08075020
*                                       INCREMENT                S20201 08076020
SECTAREA EQU   8                        SECTOR STORAGE AREA SIZE S20201 08077020
CARN80   EQU   80                       IOB OFFSET TO STORE      S20201 08078020
*                                       SECTOR STORAGE ADDRESS   S20201 08079002
*                                                                       08100000
*                                                                       08170019
NULL     EQU   0                        CONSTANT '0'             S19015 08200019
SPANNING EQU   X'08'                    RECFM=S SPECIFIED        S19015 08230019
SOFTTRK  EQU   X'20'                    BFTEK=R SPECIFIED        S19015 08260019
*                                       VECTOR                   S19015 08380019
*                                                                       08440000
TRKL     EQU   4              OFFSET TO TRACK LENGTH IN DADT            08460000
OFFLGTH  EQU   25             OFFSET IN WTG TABLE TO MODULE LGTH        08470001
SZFNOWC  EQU   128            SIZE OF IOB-RECORD FORM F, NO WRT.CHECK   08480000
SZVORU   EQU   32             SIZE INCREMENT FOR FORMAT V OR U          08500002
SZWCF    EQU   48             SIZE INCREMENT FOR WRITE CHECK - FORMAT F 08520002
SZWCV    EQU   24             SIZE INCREMENT FOR WR CHECK - FORMAT V,U  08540002
OFLOWSZ  EQU   208            SIZE(BASE) FOR OVERFLOW OPTION IOB        08560002
OFLWCSZ  EQU   64        SIZE OF WRITE CHECK FOR OVERFLOW (2 SEGMENTS)  08580000
OFLINCSZ EQU   80        SIZE INCREMENT FOR EACH ADDITIONAL SEGMENT     08600000
OFLWCINC EQU   16        SIZE INCREMENT FOR WRITE CHECK (PER SEGMENT)   08620000
ERSINC   EQU   80        SIZE INCREMENT FOR ERASE CCWS                  08640000
*                                                                       08660000
OFLOWOPT EQU   X'20'          TRACK OVERFLOW OPTION                     08680000
WRTCHK   EQU   X'80'          WRITE CHECK OPTION                        08700000
VORU     EQU   X'40'          RECORD FORM IS VARIABLE OR UNKNOWN-UNSPEC 08720000
FIRST    EQU   1              FIRST IOB IN CORE OBTAINED BY GETMAIN     08740000
*                                                                       08780000
*                                                                       08860000
IDWRTF   DC    C'DA'                    MODULE ID OF WR-FORMAT F Y02072 08900002
IDWRTVU  DC    C'DB'                    MODULE ID OF FORMAT V,U  Y02072 08920002
IDCHK    DC    C'DC'                    MODULE ID OF CHECK RTN   Y02072 08940002
IDWRTOF  DC    C'DD'                    MODULE ID OF WRT OVFLO   Y02072 08960002
IDNEXT   DC    C'1M',VL3(IGG0191M)      TRK  OVERFLOW          @Z30TSMI 08980003
PDLOAD   DC    C'6M',VL3(IGG0196M)      PROB DETERMINATION MOD @Z30TSMI 08980403
*                                                                       08982019
*   FOLLOWINGS ARE FOR RECFM=VS AND BFTEK=R                             08984019
*                                                                       08986019
ID9L     DC    C'9L',VL3(IGG0199L)      ID/TTR OF NEXT EXEC    @Z30TSMI 08988003
IDBR     DC    C'BR'                    ID/TTR OF WRITE RTN      Y02072 08990002
IDBS     DC    C'BS'                    ID/TTR OF CHECK RTN      Y02072 08992002
IDBT     DC    C'BT'                    ID/TTR OF C.E.A.         Y02072 08994002
CON256   DC    H'256'                   CONSTANT                        08994402
CON255   DC    X'FF'                    CONSTANT 255                    08994802
OPIDCNST DC    C'0S'                    LAST WTG ENTRY (OPEN)           08994902
MODID    DC    CL6'IGG019'              MODULE ID                Y02072 08995202
AMIDCNST DC    C'1L'                    THIS EXECUTOR'S ID              08996002
FIX      DC    C'OZ10231'               LATEST FIX FLAG         ZA10231 08998037
DATE     DC    CL8'&SYSDATE'            DATE OF LATEST FIX      ZA10231 08998237
PATCH    DC    XL((*-IGG0191L)/20)'0'   5% PATCH AREA            Y02072 08998402
*                                                                       09000000
         EJECT                                                          09120000
*********************************************************************** 09130002
*                         DSECTS                                        09132002
*********************************************************************** 09134002
*                                                                       09160000
UCBTYPCD EQU   19             OFFSET TO TYPE CODE IN THE UCB            09180000
*                                                                       09200000
*                                                                       09220000
CVT      DSECT                                                          09240003
         CVT                                                            09260000
*                                                                       09280000
*                                                                       09300000
         DCBD  DSORG=(PS),DEVD=(DA)                                     09320000
         EJECT                                                          09322002
         IHADVCT   DSECT=YES                                     Y02072 09324002
         EJECT                                                          09328002
         IKJTCB                                                         09330001
         IEZIOB                                                  Y02072 09380002
         EJECT                                                          09430002
         IEZDEB                                                  Y02072 09480002
         EJECT                                                          10590000
         IECDSECS  (MAIN,(IOB,NO)),WTG,PREFX,EXPAND=YES        @Z30TSMI 10592003
FORCORE  DSECT                          WORKAREA DSECT CONTINUED Y02072 10602002
*****   THE FOLLOWING ARE AUDIT TRAIL BITS SET FOR FORCE CLOSE    ***** 10612002
         IHAFCAUD  ORG=YES                                       Y02072 10612802
         END                                                            10620000
