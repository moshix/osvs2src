    TITLE ' IGG0191Q - OPEN EXECUTOR FOR CHAINED SCHEDULING (TAPE-UR)'  00020004
IGG0191Q CSECT                                                          00021016
*MODULE NAME - IGG0191Q                                          Y02072 00021102
*                                                                       00021202
*DESCRIPTIVE NAME - BUILD IOBS                                   Y02072 00021302
*                                                                       00023302
*COPYRIGHT - NONE                                                Y02072 00025302
*                                                                       00027302
*CHANGE ACTIVITY - AS FOLLOWS:                                   Y02072 00027702
*                                                                       00028002
*        VS 2 RELEASE 2 DELETIONS                                Y02072 00030002
*000204,000600,011400,050300,050420-050480,065400,073600,117400  Y02072 00032002
*120350,120500,125400-125600,126200,130000                       Y02072 00042002
*                                                                YM4697 00052002
*                                                                YM6583 00052102
*                                                                       00052503
*        VS2 RELEASE 3 DELETIONS                                        00052903
*                                                              @Z30TSCF 00053303
*        VS2 RELEASE 4 DELETIONS                                        00053704
*                                                              @Z40MSMI 00053804
*        RELEASE 20 DELETIONS                                           00054002
*0485130700,131400,131800                                        M6128  00056002
*0485002800,005000-005200,120400,130800                          M5071  00058002
*0485130700                                                      M5898  00060002
*0485120250                                                      M6413  00062002
*        RELEASE 21 DELETIONS                                           00064002
*1300                                                            A45221 00066002
*1300107000-107600                                               A36955 00068002
*                                                               SA67354 00070002
*                                                                       00076002
*STATUS CHANGE LEVEL 007                                                00078002
*                                                                       00080000
*FUNCTION/OPERATION-- THIS ROUTINE GETS THE AMOUNT OF SPACE REQUIRED    00100000
*                     FOR THE MAIN IOB AND ICBS WITH THEIR CHANNEL      00120000
*                     PROGRAMS.TAPE AND UR ARE SUPPORTED BY THIS        00140004
*                     ROUTINE.THE ROUTINE ALSO GENERATES THE CHANNEL    00160000
*                     PROGRAMS REQUIRED,STORES THE ID'S OF THE EOB      00180000
*                     RTS NEEDED IN DCB(TEMPORARILY),AND INITIALIZES    00200000
*                     FIELDS IN THE DCB.                                00220000
*                     IT SETS AN AUDIT TRAIL BIT IN THE OPEN     Y02072 00230002
*                     WORKAREA INDICATING TO FORCE CLOSE THAT    Y02072 00232002
*                     THE CORE GETMAINED FOR THE IOB'S CAN BE    Y02072 00234002
*                     FREEMAINED.                                Y02072 00236002
*                                                                       00240000
*                                                                       00260000
*ENTRY POINT:  IGG0191Q FROM IGG0191T, IGG0191U, IGG0191V, IGG0193I,    00270004
*              IGG0196B OR IGG0196Q                                     00280004
*                                                                       00300000
*INPUT      --  SEE DESCRIPTION OF REGISTERS,USER DCB,WHERE TO GO TABLE 00320000
*               CURRENT ENTRY IN WHERE TO GO TABLE,USER PARAMETER LIST, 00340000
*               CURRENT ENTRY IN PARAMETER LIST,AND OPEN'S 536 BYTE     00360000
*               WORK AREA (SEE FORECORE DSECT) ASSOCIATED WITH EACH DCB 00380000
*                                                                       00400000
*OUTPUT     --  ICBS AND CHANNEL PROGRAMS ,MAIN IOB ,DCB INITIALIZATION 00420000
*                                                                       00440000
*EXTERNAL RTS.  IFG019RA.                                               00460004
*                                                                       00480000
*EXITS      --  NORMAL - IGG01913, IGG01916                             00500004
*               ABNORMAL - IGG0191G WHEN CHAINED SCHEDULING             00520004
*                          NOT SUPPORTABLE                              00526004
*                                                                       00530002
*MACROS : ACTION -- MODESET, GETMAIN, IECRES                            00532004
*                                                                       00534002
*MACROS : MAPPING -- IHACCW, DCBD, IECDSECS, IEZIOB, IEZDEB,            00536004
*                    IKJTCB, IGGPARML                                   00538004
*                                                                       00546002
*TABLES     --  SEE FORECORE DSECT ,DCB DSECT ; WHERE TO GO DSECT       00560000
*                                                                       00580000
*ATTRIBUTES --  RE-ENTRANT, RE-USABLE, ENABLED, RUNS IN DATA     Y02072 01140002
*               MANAGEMENT KEY UNLESS OTHERWISE SPECIFIED        Y02072 01180002
*               RUNS IN SUPERVISOR STATE                         Y02072 01190002
*                                                                       01200000
*NOTES      --  THIS EXECUTOR WILL GO TO IGG0191G IF CHAINED SCHEDULING 01220004
*               CANNOT BE SUPPORTED BUT THE USER IS CAPABLE OF RUNNING. 01240004
*                                                                       01260000
*               3800 PRINTER SUPPORT (@Z40MSMI) - OPTCD=J (DYNAMIC      01270004
*               SELECTION OF TRANSLATE TABLES) REQUIRES AN ADDITIONAL   01290004
*               CCW IN THE CHANNEL PROGRAM. WHEN IT IS REQUIRED THIS    01300004
*               MODULE WILL INCREASE THE ICB/CP SIZE TO BE GETMAINED    01310004
*               BY 8 BYTES PER ICB. THE NEW CHANNEL PROGRAM WILL BE:    01320004
*                  NOP/ASA                                              01330004
*                  NOP/SELECT TRANSLATE TABLE                           01340004
*                  WRITE                                                01350004
*                  NOP                                                  01352004
*                  NOP/TIC                                              01354004
*                                                                       01360000
*********************************************************************** 01380000
*                                                                       01400000
*  REGISTER CONVENTIONS USED THROUGH OUT ALL OPEN PASSES                01420000
*                                                                       01440000
*********************************************************************** 01460000
*                                                                       01480000
RDCB     EQU   2         DCB REGISTER                                   01500000
RBASE    EQU   3         BASE REGISTER                                  01520000
RCORE    EQU   4         WORK AREA ADDRESS                              01540000
RPAR     EQU   5         TOP OF PARAMETER LIST                          01560000
RWTG     EQU   6         TOP OF WTG TABLE                               01580000
RPARC    EQU   7         CURRENT PARAMETER                              01600000
RWTGC    EQU   8         CURRENT TRANS LOAD                             01620000
RTIOT    EQU   9         USED HERE AS WRK REG AND  COMM VECTOR ADDR.    01640000
RUCB     EQU   10        USED HERE AS A COUNTER IN IOB GENERATION       01660000
RDEB     EQU   11        DEB ADDRESS, WORKREG AND FOR MODESET           01680004
RB       EQU   12        WORK REG1  **                                  01700000
RC       EQU   13        WORK REG2  **  USED IN IOB GENERATION          01720000
RD       EQU   14        WORK REG3  **                                  01740000
RRET     EQU   RD                       RETURN ADDRESS REGISTER  Y02072 01752002
RJ       EQU   15        WORK REG4                                      01760000
RWK4     EQU   RJ                       WORK REGISTER            Y02072 01770002
RE       EQU   0         WORK REG5                                      01780000
RF       EQU   1         WORK REG6                                      01800000
RWK5     EQU   RF                       WORK REGISTER            Y02072 01810002
*                                                                       01820000
*                                                                       01880000
*********************************************************************** 01900000
*                                                                       01920000
*                                                                       01940000
*                                                                       01960000
* MASKS FOR DEVICES TO BE SUPPORTED                                     01980000
*                                                                       02000000
*                                                                       02020000
*                                                                       02040000
TAPEB    EQU   X'80'                                                    02060000
URBITS   EQU   X'40'                                                    02080000
PRINTER  EQU   X'48'                                                    02100000
*                                                                       02160000
*                                                                       02180000
*********************************************************************   02400000
*                                                                       02420000
*          CCW COMMAND CODES                                            02440004
*                                                                       02460000
WRITE    EQU   X'01'                    WRITE COMMAND                   02480004
PRTSPC1  EQU   X'09'                    PRINT AND SINGLE SPACE 1        02490004
READ     EQU   X'02'                    READ COMMAND                    02500004
READBACK EQU   X'0C'                    READ BACKWARDS COMMAND          02520004
TIC      EQU   X'08'                    TIC COMMAND                     02540004
NOP      EQU   X'03'                    NOP COMMAND                     02560004
EJCT     EQU   X'80'                    EJECT MODE FOR 1442             02570004
COLBIN   EQU   X'20'                    COLUMN BINARY MODE              02580004
STCK2    EQU   X'40'                    STACKER TWO MODE                02590004
*                                                                       02600000
*********************************************************************   02610004
*                                                                       02620004
*          MISCELLANEOUS EQUATES                                        02630004
*                                                                       02640004
TIMES8   EQU   3                        SHIFT VALUE TO MULTIPLY BY 8    02650004
ECBNORM  EQU   X'7F'                    CODE TO SET NORMAL COMPLETION   02660004
ICBLRD   EQU   7                        ICB LEN. FOR READ IN DBL WRDS   02690004
ICBLWT   EQU   8                        ICB LEN. FOR WRITE IN DBL WRDS  02700004
ICBLWA   EQU   9                        ICB LEN FOR 3800 IN DBL WRDS    02702004
WCPO     EQU   32                       CHANNEL PROG OFFSETS FOR DCB    02710004
NOPR     EQU   48                       NOP OFFSET FOR READ             02720004
NOPW     EQU   56                       NOP OFFSET FOR WRITE            02730004
NOPA     EQU   64                       NOP OFFSET FOR 3800             02740004
*********************************************************************   04660000
         EJECT                                                          04682004
         BALR  RBASE,0                                                  04720000
         USING SOPC,RBASE                                               04740000
         USING PARML,RPARC                                              04790004
         USING WTGENTRY,RWTGC                                           04792004
         USING WTG,RWTG                                                 04794004
*                                                                       04800000
*                                                                       04820000
SOPC     EQU   *                                                        04840000
*                                                                       04860000
         B     BEGIN                    BR AROUND CONSTANTS      Y02072 04870002
         DC    C'IGG0191Q'              MODULE NAME              Y02072 04872002
         DC    C'@Z40MSMI'              LAST SHIP CODE         @Z40MSMI 04874004
         DC    C'01/31/75'              LAST DATE MODIFIED     @Z40MSMI 04876004
BEGIN    DS    0H                                                YM4697 04878002
         SR    RE,RE                    INITIALIZE                      04880000
         L     RDCB,PARDCBAD            GET DCB ADDRESS                 04900004
         USING IHADCB,RDCB                                              04910004
         LA    RDCB,IHADCB              CLEAR HI BYTE                   04920004
         L     RCORE,WTGCORE-1          GET WRK AREA ADDRESS            04940004
         USING FORCORE,RCORE                                            04950004
*                                                                       04960000
*********************************************************************** 04980000
*                                                                       05000000
         MVC   WTGIDTTR,SOP5            NXT RTN IF CH SCH NOT PERMITTED 05030004
*                                                                       05200000
*                                                                       05220000
         TM    PAROPT,PAROUTPT-PARRDBCK DCB OPENED FOR OUT/IN OR IN/OUT 05240004
         BM    RELOOP                   YES BRANCH - NO CH SCHED        05260004
*                                                                       05280000
         BO    SOPC005                  BRANCH IF OPENED FOR OUTPUT     05300004
*                                                                       05320000
         TM    DCBMACF1,DCBMRCRL        IS CNTRL MACRO USED             05340004
         BO    RELOOP                   YES BRANCH  NO CH SCHEDULE      05360004
*                                                                       05380000
         LA    RF,ICBLRD                ICB SIZE IN DBL WRDS      19768 05400004
         B     SOPC007                                                  05420000
*                                                                       05440000
SOPC005  EQU   *                                                        05460000
*                                                                       05480000
         TM    DCBMACF2,DCBMRCTL        IS CNTRL MACRO USED             05500004
         BO    RELOOP                   YES BRANCH  NO CH SCHEDULE      05520004
*                                                                       05540000
         LA    RF,ICBLWT                ICB SIZE IN DBL WRDS      19768 05560004
*                                                                       05560404
*   FOR 3800 WITH OPTCODE = J SPACE MUST BE GOTTEN FOR AN EXTRA CCW     05562004
*                                                                       05564004
         CLI   DCBDEVT,DCBDVPR5         IS THIS A 3800         @Z40MSMI 05566004
         BNE   SOPC007                  NO - CONTINUE          @Z40MSMI 05568004
         TM    DCBOPTCD,DCBOPTJ         OPTCD=J SPECIFIED      @Z40MSMI 05570004
         BZ    SOPC007                  NO - CONTINUE          @Z40MSMI 05572004
         LA    RF,ICBLWA                ICB SIZE IN DBL WORDS  @Z40MSMI 05574004
*                                                                       05580000
SOPC007  EQU   *                                                        05600000
*                                                                       05620000
         STC   RF,DCBIOBL               STORE ICB&CP LEN IN DBL.WRDS.   05640000
         SLL   RF,TIMES8                GET LENGTH IN BYTES             05660004
*                                                                       05680000
         SR    RE,RE                                                    05700000
         IC    RE,DCBBUFNO              GET BUFFER NUMBER--QSAM PARA.   05720000
         TM    DCBCIND2,DCBCNQSM        IS QSAM BEING USED              05740004
         BO    SOPC013                  YES BRANCH                      05760004
*                                                                       05780000
         TM    DCBMACF1,DCBMRPT1        IS NOTE/POINT TO BE USED        05800004
         BO    SOPC009                  YES BRANCH                      05820004
         TM    DCBMACF2,DCBMRPT2        IS NOTE/POINT TO BE USED        05840004
         BZ    SOPC011                  NO BRANCH                       05860004
*                                                                       05880000
SOPC009  EQU   *                                                        05900000
*                                                                       05920000
         MVI   DCBRTN2,RTN6             STORE PCI NOTE/POINT ID INDEX   05940004
         TM    DCBDEVT,TAPEB            IS DCB USING TAPE               05960004
         BO    SOPC011                  YES BRANCH                      05980004
*                                                                       06000000
         MVI   DCBRTN2,RTN10            STORE DUMMY RT ID INDEX VALUE   06020004
*                                                                       06040000
SOPC011  EQU   *                                                        06060000
*                                                                       06080000
         IC    RE,DCBNCP                GET NUMBER OF ICBS TO GEN.      06100000
*                                                                       06120000
SOPC013  EQU   *                                                        06140000
*                                                                       06160000
         LR    RTIOT,RE                 SAVE NO. OF ICBS TO BUILD       06180000
*                                                                       06200000
         CH    RE,CONONE                IS NCP EQUAL TO 1 OR ZERO       06260004
         BNH   RELOOP                   YES BRANCH                      06300004
*                                                                       06320000
         MR    RE,RE                    COMPUTE AMT SPACE REQ FOR ICBS  06340000
         LA    RF,IOBEXTEN-IOBQSAMC(RF) SPACE REQ FOR MAIN IOB          06360004
         LR    RB,RF                    SAVE AMT TO CLEAR               06380000
         OI    DCBCIND2,DCBCNCHS        SET TRUE PCI INDICATOR   YM4697 06430002
*                                                                       06520000
*  THE FOLLOWING SAVES THE AMOUNT OF CORE GETMAINED FOR THE      YM4697 06520404
*  IOB AND ICBS IN THE FORCE CLOSE AUDIT TRAIL FOR THE FORCE     YM4697 06520802
*  EXECUTOR.                                                     YM4697 06521202
*                                                                       06521602
         ST    RF,DXATEXC2              SAVE LENGTH              YM4697 06521702
*                                                                       06521802
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 06522002
         GETMAIN R,LV=(RF),SP=0                                  Y02072 06540002
*                                                                       06540402
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 06554002
*                                                                       06560000
*********************************************************************** 06580000
*                                                                       06600000
*                                                                       06620000
         ST    RF,DCBIOBAD              SAVE MAIN IOB ADDRESS           06660000
         OI    FCAOPEN,FCAOIOB          INDIC IOB'S CAN BE FREED Y02072 06670002
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 06682002
*********************************************************************** 06732004
*                                                                       06782004
*        CLEAR THE AREA GETMAINED                                       06832004
*                                                                       06882004
         SR    RJ,RJ                    INDICATE CLEAR TO X'00'         06932004
         LR    RE,RF                    LOCATION TO CLEAR               06942004
         LR    RF,RB                    LENGTH TO CLEAR                 06952004
         MVCL  RE,RD                    CLEAR THE AREA                  06954004
*                                                                       06960000
*                                                                       06980000
*********************************************************************** 07000000
         L     RB,DCBIOBAD              GET MAIN IOB ADDRESS            07020000
         USING IOBQSAMC,RB                                              07030004
*                                                                       07080000
*     THIS SECTION OF CODE WILL BUILD THE MAIN IOB                      07100000
*                                                                       07120000
*                                                                       07140000
         LA    RUCB,IOBEXTEN            POINT TO FIRST ICB              07180004
         ST    RUCB,IOBCICB             STORE IN MAIN IOB               07200004
         LA    RD,IOBCECB               POINT TO ECB IN MAIN IOB        07220004
*                                                                       07240000
         MVI   IOBCECB,ECBNORM          POST MAIN IOB COMPLETE          07260004
*                                                                       07280000
*                                                                       07300000
         LA    RF,IOBEXTEN+ICBEXTEN-ICB POINT TO FIRST ICB CHANNEL PRG  07320004
*                                                                       07340000
         ST    RD,IOBECBPT              ECB ADDRESS TO IOB       Y02072 07360002
         ST    RF,IOBSTART              CHAN PGM ADDR TO IOB     Y02072 07370002
         L     RWK4,DXUDCBAD            GET USERS DCB ADDRESS    Y02072 07372002
         ST    RWK4,IOBDCBPT            DCB ADDRESS TO IOB       Y02072 07374002
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 07376402
*                                                                       07380000
*                                                                       07400000
         MVI   DCBWCPO,WCPO             MOVE IN FIRST OFFSET  AND       07420004
         MVC   DCBWCPL(3),DCBWCPO       PROPAGATE THE BYTE ACROSS       07440000
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 07442002
IOBOFF   MVI   IOBCINOP,NOPR            NOP OFFSET IN IOB         19768 07460004
         MVI   IOBCONOP,NOPR            NOP OFFSET IN IOB         19768 07480004
*                                                                       07500000
         OI    IOBFLAG1,IOBCMDCH        INDICATE COMMAND CHAINING       07510004
*                                                                       07520000
*   ASSUME TAPE OR CARD READER CHANNEL PROGRAM FOR OFFSETS STORED       07540000
*                                                                       07560000
         LA    RB,IOBEXTEN              POINT TO FIRST ICB              07580004
         DROP  RB                                                       07580404
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 07582002
         ST    RB,DCBIOBA               SAVE ADDRESS FOR SUBROUTINES    07600000
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 07610002
         LR    RC,RB                    COPY ICB ADDRESS                07620000
*                                                                       07640000
*                                       DURING THE FOLLOWING LOOP, RB   07660000
*                                       MUST REMAIN INTACT FOR IT IS    07680000
*                                       NEEDED TO PUT LINK ADDRESS IN   07700000
*                                       1ST ICB.                        07720000
*                                                                       07740000
*                                                                       07760000
*                                                                       07780000
*   ICB CONSTRUCTION BEGINS AT THIS POINT                               07800000
*                                                                       07820000
*                                                                       07840000
ICBLOOP  EQU   *                                                        07860000
*                                                                       07940000
         USING ICB,RB                                                   07950004
         ST    RC,ICBNICBA              LINK LAST ICB TO CURRENT ICB    07960004
         LR    RB,RC                    UPDATE LAST ICB POINTER         07980004
         LA    RC,ICBNECB               POINT TO ICBS ECB               08000004
         ST    RC,ICBECBPT              SAVE IN ECB SLOT                08020004
         MVI   ICBNECB,ECBNORM          POST ICB COMPLETE               08040004
         LA    RC,ICBEXTEN              POINT TO CP START ADDR          08060004
         USING CCW,RC                                                   08070004
         ST    RC,ICBSTART              SAVE IN ICB CP STARTAD          08080004
*                                                                       08100004
*    NORMAL ICB HAS BEEN GENERATED                                      08120000
*                                                                       08140000
         TM    DCBDEVT,TAPEB            DCB USING TAPE                  08160000
         BO    SOPC043                  YES BRANCH                      08180004
*                                                                       08200000
         TM    PAROPT,PAROUTPT          DCB FOR OUTPUT                  08220004
         BZ    SOPC029                  NO BRANCH                       08240004
*                                                                       08260000
*      SUPPLY AUTOMATIC UNBLOCKING FUNCTION FOR QSAM U.R. OUTPUT        08280000
*                                                                       08320000
         TM    DCBCIND2,DCBCNQSM        QSAM BEING USED FOR OUTPUT      08340004
         BZ    SOPC023                  NO BRANCH                       08360004
         TM    DCBRECFM,DCBRECBR        BLOCKED RECORDS         SA67354 08370002
         BZ    SOPC023                  NO, BYPASS UNBLOCKING   SA67354 08380002
         TM    DCBCIND2,DCBCNBFP        DID OPEN BUILD BUFFERS  SA67354 08390002
         BO    SOPC023                  YES, FUNCTION ALREADY   SA67354 08392002
*                                         PROVIDED              SA67354 08394002
         TM    DCBRECFM,DCBRECU         U RECORDS BEING USED            08400002
         BNM   SOPC023                  YES BRANCH              SA67354 08420002
         SPACE                                                          08430002
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 08432002
         SPACE                                                          08434002
         TM    DCBRECFM,DCBRECF         F RECORDS USED                  08440004
         BZ    SOPC021                  NO BRANCH                       08460004
         MVC   DCBBLKSI,DCBLRECL        FORCE UNBLOCKED RECORDS TO BE   08500004
*                                       OUTPUT TO UNIT RECORD EQUIPMENT 08520002
SOPC021  EQU   *                                                        08560000
         NI    DCBRECFM,X'FF'-DCBRECBR  TURN BLOCKED BIT OFF            08600004
         OI    DCBCIND1,DCBCNBRM        SET BIT FOR CLOSE. MUST  A45221 08610002
*                                         KNOW BIT TURNED OFF.   A45221 08630021
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 08630402
SOPC023  EQU   *                        BUILD WRITE CHANNEL PROGRAM     08640004
         MVI   CCWCOMCD,NOP             STORE NOP CMD BYTE              08780004
         MVI   CCWFLGS,CCWCC            SET CMD CHAIN FLAG              08800004
         MVI   CCWBYTE+1,1              SAVE COUNT OF ONE               08820004
*                                                                       08840000
*   NOP CCW HAS BEEN GENERATED FOR OUTPUT CHANNEL PROGRAM               08860000
*                                                                       08880000
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 08932002
         TM    DCBRECFM,DCBRECCA        ASA CHARACTERS USED             08940004
         BZ    SOPC025                  NO BRANCH                       08960004
*                                                                       08980000
         MVI   DCBRTN4,RTN4             SAVE DDB'S ID INDEX VALUE       09000004
         B     SOPC027                                                  09020000
*                                                                       09040000
SOPC025  EQU   *                                                        09060000
*                                                                       09080000
         MVI   DCBRTN4,RTN3             SAVE DDA'S ID INDEX VALUE       09100004
*                                                                       09120000
SOPC027  EQU   *                                                        09140000
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 09142002
*                                                                       09160000
         L     RD,DCBIOBAD              GET MAIN IOB ADDRESS            09180000
         USING IOBQSAMC,RD                                              09190004
         MVI   IOBCINOP,NOPW            NOP OFFSET IN IOB               09200004
         MVI   IOBCONOP,NOPW            NOP OFFSET IN IOB               09210004
*                                                                       09215004
*        FOR 3800 WITH OPTCD=J AN ADDITIONAL NOP MUST BE BUILT          09220004
*                                                                       09225004
         CLI   DCBDEVT,DCBDVPR5         IS THIS A 3800         @Z40MSMI 09230004
         BNE   SOPC024                  NO - CONTINUE          @Z40MSMI 09235004
         TM    DCBOPTCD,DCBOPTJ         OPTCD=J SPECIFIED      @Z40MSMI 09240004
         BZ    SOPC024                  NO - CONTINUE          @Z40MSMI 09245004
         LA    RC,CCW+L'CCW             INCREMENT TO NEXT CCW  @Z40MSMI 09250004
         MVI   CCWCOMCD,NOP             SET NOP                @Z40MSMI 09255004
         MVI   CCWFLGS,CCWCC            SET CHAIN COMMAND      @Z40MSMI 09260004
         MVI   CCWBYTE+1,1              SET COUNT              @Z40MSMI 09265004
         MODESET EXTKEY=DATAMGT         GET IN DM KEY          @Z40MSMI 09267004
         NI    DCBPRBYT,X'FF'-DCBTRCID  SET ACT TRANS TBL ID   @Z40MSMI 09270004
         MODESET KEYADDR=DXUKEY,WORKREG=11 GET IN CALLER KEY   @Z40MSMI 09272004
         MVI   IOBCINOP,NOPA            SET NOP OFFSET         @Z40MSMI 09275004
         MVI   IOBCONOP,NOPA            SET NOP OFFSET         @Z40MSMI 09280004
         DROP  RD                                                       09280404
SOPC024  EQU   *                                                        09281004
         LA    RC,CCW+L'CCW             UPDATE CCW POINTER              09285004
         MVI   CCWCOMCD,WRITE           STORE WRITE CMD BYTE            09290004
         OI    CCWFLGS,CCWCC+CCWSLI+CCWPCI SET FLAGS                    09300004
         BAL   RRET,SOPC070             GO RESET PCI BIT IF      Y02072 09310002
*                                         NECESSARY              Y02072 09312002
         TM    DCBDEVT,PRINTER          DCB USING PRINTER               09320000
         BO    SOPC037                  YES BRANCH                      09340004
*                                                                       09360000
         CLI   DCBDEVT,DCBDVCRP         1442 BEING USED FOR OUTPUT      09380004
         BNE   SOPC031                  NO BRANCH                       09400004
*                                                                       09420000
         OI    CCWCOMCD,EJCT            TURN ON EJECT MOD.              09440004
         B     SOPC031                                                  09460000
*                                                                       09480000
*                                                                       09500000
SOPC029  EQU   *                        BUILD READ CHANNEL PROGRAM      09520004
*                                                                       09540000
         OI    CCWFLGS,CCWCC+CCWSLI+CCWPCI SET PCI,SILI, CC FLAGS       09560004
         BAL   RRET,SOPC070             GO RESET PCI BIT IF      Y02072 09570002
*                                         NECESSARY              Y02072 09572002
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 09572402
         MVI   DCBRTN4,RTN2             STORE EPG2 INDEX  VALUE         09580004
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 09582002
         OI    CCWCOMCD,READ            TURN ON READ CMD IN CCW         09600004
SOPC031  EQU   *                                                        09620000
*                                                                       09640000
         TM    DCBMODE,DCBMODEC         PROCESSING COLUMN BINARY        09660004
         BZ    SOPC033                  NO BRANCH                       09680004
*                                                                       09700000
         OI    CCWCOMCD,COLBIN          SET COL BIN MOD ON IN CCW       09720004
SOPC033  EQU   *                                                        09740000
*                                                                       09760000
         TM    DCBSTACK,DCBSTCK2        STACKER TWO SPECIFIED           09780004
         BZ    SOPC061                  NO BRANCH                       09800004
*                                                                       09820000
         OI    CCWCOMCD,STCK2           TURN STACKER TWO MOD ON         09840004
         B     SOPC061                                                  09860000
*                                                                       10000000
SOPC037  EQU   *                                                        10020000
*                                                                       10040000
         MVC   CCWCOMCD,DCBPRTSP        STORE PRINTER CMD IF SPECIFIED  10060004
         TM    DCBRECFM,DCBRECCA        ASA CHARACTERS USED             10080004
         BZ    SOPC039                  NO BRANCH                       10100004
*                                                                       10120000
         MVI   CCWCOMCD,WRITE           STORE PRINT SUPPRESS CMD BYTE   10140004
SOPC039  EQU   *                                                        10160000
         CLI   CCWCOMCD,0               WAS PRINTER CMD GENERATED       10180004
         BNE   SOPC041                  YES BRANCH                      10200004
*                                                                       10220000
         MVI   CCWCOMCD,PRTSPC1         SAVE PRINT CMD SPACE ONE LINE   10240004
*                                                                       10260000
SOPC041  EQU   *                                                        10280000
*                                                                       10300000
         B     SOPC061                  BUILD TAPE CHANNEL PROGRAMS     10320004
*                                                                       10340000
SOPC043  EQU   *                                                        10360000
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 10362002
         MVI   DCBRTN4,RTN2             STORE EGP2'S ID VALUE           10380004
         MODESET  KEYADDR=DXUKEY,WORKREG=11 GET INTO USER KEY    Y02072 10382002
         MVI   ICBINCAM+1,1             SAVE INCREMENT VALUE            10400004
         OI    CCWFLGS,CCWCC+CCWSLI+CCWPCI SET FLAGS                    10420004
         BAL   RRET,SOPC070             GO RESET PC I BIT IF     Y02072 10430002
*                                         NECESSARY              Y02072 10432002
         MVI   CCWCOMCD,WRITE           SET FOR WRITE                   10434004
         TM    PAROPT,PAROUTPT          DCB FOR OUTPUT                  10440004
         BO    SOPC061                  YES BRANCH                      10460004
*                                                                       10480000
         MVI   CCWCOMCD,READ            STORE READ CMD BYTE             10500004
         TM    PAROPT,PARRDBCK          READ BACKWARDS BIT ON           10510004
         BZ    SOPC045                  NO - NOT READ BACKWARDS         10512004
         TM    PAROPT,PAROUTPT-PARRDBCK ANY OTHER BITS ON               10520004
         BNZ   SOPC045                  YES - NOT READ BACKWARDS        10540004
*                                                                       10560000
*        READ BACKWARDS CHANGE COMMAND CODE AND INCREMENT AMOUNT        10570004
*                                                                       10572004
         MVI   CCWCOMCD,READBACK        SAVE RD BACK CMD BYTE           10580004
         MVC   ICBINCAM,NEGONE          SAVE INCREMENT VALUE NEGATIVE   10600004
*                                                                       10620000
*                                                                       10640000
SOPC045  EQU   *                                                        10660000
*                                                                       10680000
*    APAR 36955 RESULTED FROM A BAD APAR FIX (17073).  THE       A36955 10689021
*    PROBLEM SYMPTOM WAS THAT THE SILI BIT WAS BEING LEFT ON FOR A36955 10698021
*    FIXED UNBLOCKED RECORDS.                                    A36955 10707021
         TM    DCBRECFM,DCBRECF         TEST FOR FIXED OR        A36955 10716004
*                                       UNDEFINED                A36955 10725021
         BNO   SOPC061                  NO, MUST BE VARIABLE     A36955 10734004
*    AT THIS POINT RECORDS COULD BE EITHER UNDEFINED OR          A36955 10743021
*    FIXED.  MUST TEST FURTHER.                                  A36955 10752021
         TM    DCBRECFM,DCBRECU         RECORDS FORMAT U         A36955 10761004
         BO    SOPC061                                           A36955 10770021
*                                                                       10780000
*                                                                       10800000
*                                                                       10840000
         NI    CCWFLGS,X'FF'-CCWSLI     TURN SILI FLAG OFF              10860004
*                                                                       11100000
SOPC061  EQU   *                        ALL DEVICES                     11120004
*                                                                       11140000
*                                                                       11143018
*             THIS NOP MUST BE INSERTED TO INSURE A SIMULTANEOUS        11146018
*             CHANNEL END DEVICE END INTERUPT IN THE EVENT THIS         11149018
*             ICB'S CHANNEL PROGRAM IS RESTARTED BY THE ERPS            11152018
*                                                                       11155018
         LA    RC,CCW+L'CCW             GET NEXT CCW              19768 11158004
         MVI   CCWCOMCD,NOP             NOP COMMAND CODE          19768 11161004
         MVI   CCWBYTE+1,1              COUNT OF 1 IN CCW         19768 11164004
         MVI   CCWFLGS,CCWCC            SET CMD CHAIN FLAG        19768 11167004
*                                                                       11170018
         LA    RC,CCW+L'CCW             POINT TO NOP/TIC          19768 11173004
*                                                                       11180000
         LA    RD,ICBEXTEN-ICB+L'CCW(RC) POINT TO NEXT POSSIBLE ICB CP. 11200004
         ST    RD,CCWADDRA              SAVE IN NOP/TIC CCW             11220004
         MVI   CCWCOMCD,NOP             SAVE CMD BYTE                   11240004
         OI    CCWFLGS,CCWSLI           SET SILI ON IN CCW              11260004
         MVI   CCWBYTE+1,1              COUNT OF ONE IN CCW             11280004
         LA    RC,CCW+L'CCW             POINT TO NEXT POSSIBLE ICB      11300004
         BCT   RTIOT,ICBLOOP            DECREMENT ICB COUNTER           11320004
*                                                                       11360000
*                                                                       11380000
**********************************************************************  11400000
*                                                                       11420000
*                                                                       11440000
SOPCEND  EQU   *                                                        11460000
*                                                                       11480000
*                                                                       11500000
*                                                                       11560000
         L     RD,DCBIOBA               GET FIRST ICB ADDRESS           11580000
         ST    RD,ICBNICBA              LINK FIRST ICB TO LAST ICB.     11600004
         DROP  RB                                                       11610004
         USING ICB,RD                                                   11612004
         LA    RE,ICBEXTEN              POINT TO ICB'S CP START AD.     11620004
         LA    RF,L'CCW                 CONSTANT OF EIGHT               11640004
         SR    RC,RF                    POINT BACK TO LAST ICB'S NOP    11660000
         ST    RE,CCWADDRA              STORE FIRST ICB'S CP AD IN NOP  11680004
         MVI   CCWCOMCD,NOP             RESTORE NOP CMD BYTE            11700004
         DROP  RC,RD                                                    11710004
*                                                                       11720000
*                                                                       11760000
*                                                                       11780000
*                                                                       11800000
         L     RDEB,DCBIOBAD            PICK UP MAIN IOB ADDRESS        11820000
         USING IOBQSAMC,RDEB                                            11830004
*                                                                       11840000
         IC    RF,IOBCINOP              PICK UP NOP OFFSET              11860004
         AR    RD,RF                    GET NOP ADDRESS AND             11880000
         ST    RD,IOBCNOPA               STORE AS 'LAST NOP' IN MAINIOB 11900004
         MVI   IOBCNOPA,IOBCEXCP         SET EXCP NEEDED FLAG    YM6583 11910004
*                                                                       11920000
*                                                                       11940000
*                                                                       11960000
*    GENERATION OF ICB'S AND CHANNEL PROGRAMS ARE COMPLETE              11980000
*                                                                       12000000
*                                                                       12020000
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 12020102
         TM    DCBRECFM,DCBRECV+DCBRECSB  VARIABLE SPANNED     M6413    12025004
         BO    LOAD1916                YES, XCTL TO 1916         M5071  12030020
         MVC   WTGIDTTR,SOPSLDFT        NO, XCTL TO 1913       @Z30TSCF 12034003
         B     RELOOP                                            M5071  12040020
LOAD1916 EQU   *                                                 M5071  12045020
         MVC   WTGIDTTR,SOPS1916        XCTL TO 1916           @Z30TSCF 12047003
         EJECT                                                          12099002
RELOOP   LA    RWTGC,WTGEND             INCREMENT CURR WTG ENTRY        12160004
         LA    RPARC,L'PARDCBAD(0,RPARC) INCR CURRENT DCB ENTRY PRTR    12180004
         CLC   WTGID,AMIDCNST           THIS RT NEEDED AGAIN            12200004
         BER   RBASE                                                    12220004
*                                                                       12240000
         CLC   WTGID,OPIDCNST           END OF TABLE                    12260004
         BNE   RELOOP                   NO,CHECK NEXT ENTRY             12280004
*                                                                       12300000
         LR    RPARC,RPAR               REINITIALIZE PARM LIST PTR      12320004
         DROP  RWTGC                                                    12330004
         LA    RWTGC,WTGENTRY           REINITIALIZE WTG LIST PTR       12340004
         USING WTGENTRY,RWTGC                                           12350004
ZCHEK    CLI   WTGENTRY,0               IS THIS ENTRY COMPLETE          12360004
         BNE   TCTLRTN                  IF NOT TRANSFER CONTROL         12380004
*                                                                       12400000
         LA    RWTGC,WTGEND             GET NEXT ENTRY                  12420004
         LA    RPARC,L'PARDCBAD(0,RPARC)                                12440004
         B     ZCHEK                                                    12460004
*                                                                       12480000
TCTLRTN  EQU   *                                                        12500000
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSCF*12600003
               MODID=WTGENTRY                                  @Z30TSCF 12610003
*                                                                       13040000
* THE FOLLOWING ROUTINE TESTS TO SEE IF THIS JOB IS RUNNING IN   Y02072 13042002
* A VIRTUAL ENVIRONMENT.  IF YES, PCI BIT SHOULD NOT BE TURNED   Y02072 13044002
* ON.  IF NO, PCI BIT CAN BE LEFT ON.                            Y02072 13046002
* ON INPUT RC MUST POINT TO THE CCW                                     13047004
*                                                                       13048002
SOPC070  L     RDEB,DCBDEBAD            GET DEB ADDRESS          Y02072 13052002
         USING DEBBASIC,RDEB                                     Y02072 13054002
         L     RWK5,DEBTCBAD            TCB ADDR FOR V=R TEST    Y02072 13056002
         DROP  RDEB                                              Y02072 13058002
         USING TCB,RWK5                                          Y02072 13058402
         TM    TCBFLGS6,TCBRV           JOB RUNNING VIRT=REAL    Y02072 13058802
         BOR   RRET                     NO, RETURN               Y02072 13059202
         USING CCW,RC                                            Y02072 13059602
         NI    CCWFLGS,X'FF'-CCWPCI     YES, TURN OFF PCI FLAG   Y02072 13059702
         DROP  RC                                                Y02072 13059802
         BR    RRET                     RETURN MAINLINE          Y02072 13059902
*                                                                       13060000
**                                                                      13060104
*                                                                       13060204
*********************************************************************   13060304
*                                                                       13062904
OPIDCNST DC    C'0S'                                                    13064904
AMIDCNST DC    C'1Q    '                                                13065304
SOPS1916 DC    C'16',VL3(IGG01916)      VAR, SPANNED RECS      @Z30TSCF 13065404
SOPSLDFT DC    C'13',VL3(IGG01913)      OTHER THAN IGG01916    @Z30TSCF 13065504
SOP5     DC    C'1G',VL3(IGG0191G)   CHAINED SCHEDULING UNSUP  @Z30TSCF 13066404
NEGONE   DC    X'FFFF'                                                  13066804
CONONE   DC    H'1'                                                     13067204
*                                                                       13068104
*                                                                       13068504
*********************************************************************** 13068904
*                                                                       13070604
DS       DS    0H                                                       13071004
*                                                                       13071404
PATCH    DC    0H'0',50X'00'            PATCH AREA               Y02072 13072304
END      EQU   *                        END OF MODULE            Y02072 13074004
         EJECT                                                          13075704
         IHACCW  DSECT=YES                                              13077404
         EJECT                                                          13079104
CVT      DSECT                                                          13080804
         CVT                                                            13090804
         EJECT                                                          13110802
         DCBD    DSORG=PS                                               13240004
*                                                                       13242104
*        THE FOLLOWING EQUATES REPRESENT A TABLE IN THE STAGE 3         13242404
*        EXECUTORS AND IS USED TO DECIDE WHICH ROUTINES TO LOAD.        13242704
*                                                                       13243004
         ORG   DCBCNTRL                                                 13243304
DCBRTN1  DS    X                        ROUTINE 1                       13243604
DCBRTN2  DS    X                        ROUTINE 2                       13243904
DCBRTN3  DS    X                        ROUTINE 3                       13244204
DCBRTN4  DS    X                        ROUTINE 4                       13244504
RTN1     EQU   1                        ROUTINE 1 ID                    13244804
RTN2     EQU   2                        ROUTINE 2 ID                    13245104
RTN3     EQU   3                        ROUTINE 3 ID                    13245404
RTN4     EQU   4                        ROUTINE 4 ID                    13245704
RTN5     EQU   5                        ROUTINE 5 ID                    13246004
RTN6     EQU   6                        ROUTINE 6 ID                    13246304
RTN7     EQU   7                        ROUTINE 7 ID                    13246604
RTN8     EQU   8                        ROUTINE 8 ID                    13246904
RTN9     EQU   9                        ROUTINE 9 ID                    13247204
RTN10    EQU   10                       ROUTINE 10 ID                   13247504
         EJECT                                                          13260004
         IEZDEB  LIST=YES                                               13292004
         EJECT                                                          13294004
         IECDSECS  (MAIN,(IOB,NO)),IOB,WTG,PREFX,EXPAND=YES             13350004
         ORG   WTGIDTTR                                                 13352004
WTGID    DS    CL2                      NEXT MODS ID                    13354004
IOBCEXCP EQU   X'80'                    FLAG TO SAY EXCP NEEDED  YM6583 13354404
         EJECT                                                          13356004
         IHAICB                                                         13356404
         EJECT                                                          13356804
FORCORE  DSECT                                                          13358004
         IHAFCAUD  ORG=YES                                              13358404
         EJECT                                                          13358504
         IGGPARML                                                       13358604
         EJECT                                                          13358704
         IKJTCB                                                         13358804
UCB      DSECT                                                          13359204
         IEFUCBOB  LIST=YES                                             13359604
         END                                                            13360004
