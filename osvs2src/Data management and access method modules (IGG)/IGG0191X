         TITLE 'IGG0191X DISK OUTIN, INOUT PCI EXECUTOR'                00100020
IGG0191X CSECT                                                          00200020
*MODULE NAME - IGG0191X                                          Y02072 00250002
*                                                                       00260002
*DESCRIPTIVE NAME - BUILD IOBS                                   Y02072 00270002
*                                                                       00280002
*COPYRIGHT - NONE                                                Y02072 00290002
*                                                                       00292002
*CHANGE ACTIVITY - AS FOLLOWS:                                   Y02072 00294002
*                                                                       00300020
*        VS 2 RELEASE 2 DELETIONS                                Y02072 00350002
*001500,070000,083000-084000,302000-303000,328000-329000,        Y02072 00360002
*339000-340000,563500,564500-564800,650000,699000-702000,        Y02072 00370002
*004000-005000,007000-012000,688000-694000,215000,586000,612000, Y02072 00420002
*616000                                                          Y02072 00430002
*                                                                YM4697 00480002
*                                                                YM6583 00480102
*                                                                       00530103
*        VS2 RELEASE 3 DELETIONS                                        00580103
*                                                              @Z30TSCF 00590103
*        RELEASE 21 DELETIONS                                           00600020
* 407000-411000                                                  A46882 00650021
*                                                                       00700002
*STATUS CHANGE LEVEL 002                                                01300002
*                                                                       01350021
*   THIS MODULE NEW IN REL 20.1 FROM SPLIT OF MODULE IGG0191R           01360021
*                                                                       01370021
*FUNCTION                                                               01400020
*        1  GET CORE FOR IOB'S AND CHAINED CHANNEL PROGRAMS FOR DISK    01500020
*        2  CLEAR THIS CORE                                             01600020
*        3  CONSTRUCT IOBS AND ICBS                                     01700020
*        4  CONSTRUCT CHANNEL PROGRAMS FOR DISK                         01800020
*        5 IT SETS AN AUDIT TRAIL BIT IN THE OPEN WORKAREA       Y02072 01850002
*          INDICATING TO FORCE CLOSE TAHT THE CORE GETMAINED     Y02072 01860002
*          FOR THE IOB'S CAN BE FREEMAINED.                      Y02072 01880002
*                                                                       01900020
*ENTRY POINT                                                            02000020
*        IGG0191W BY XCTL                                               02100020
*                                                                       02200020
*INPUT                                                                  02300020
*        SEE REGISTER DESCRIPTION,DCB                                   02400020
*                                                                       02500020
*OUTPUT                                                                 02600020
*        SEE REGISTER DESCRIPTION                                       02700020
*        USERS DCB                                                      02800020
*                                                                       02900020
* EXTERNAL ROUTINES-NONE                                                03000020
*                                                                       03100020
* EXITS                                                                 03200020
*        NORMAL BY XCTL TO IGG01913                                     03300020
*        NORMAL BY XCTL TO IGG0191J WHEN ONE BUFFER SPECIFIED           03400020
*                                                                       03500020
*        ERROR-NONE                                                     03600020
*                                                                       03650002
*MACROS, ACTION  MODESET, GETMAIN, XCTL                          Y02072 03660002
*                                                                       03670002
*MACROS, MAPPING  DCBD, IECDSECS, IEZDEB, IKJTCB, IEZIOB, IHACCW Y02072 03680002
*                                                                       03700020
*TABLES/WORKAREAS-WHERE TO GO TABLE (WTG)                               03800020
*                                                                       03900020
*        BYTE  0-7     NAME                                             04000020
*        BYTE  8-10    RELATIVE DISK ADDRESS(TTR) O                     04100020
*        BYTE  11      CONCATENATION NUMBER                             04200020
*        BYTE  12      ZERO                                             04300020
*        BYTE  13      ALIAS INDICATOR AND USER DATA                    04400020
*                             ALIAS INDICATOR 1 BIT                     04500020
*                             NUMBER OF TTRS IN USE                     04600020
*        BYTE  14-16   TTR OF FIRST TEXT RECORD                         04700020
*        BYTE  17      ZERO                                             04800020
*        BYTE  18-19   TTR OF NOTE LIST OR SCATTER                      04900020
*        BYTE  20      TRANSLATION TABLE                                05000020
*        BYTE  21      ZERO OR NUMBER OF ENTRIES IN                     05100020
*        BYTE  22-23   ATTRIBUTES                                       05200020
*        BYTE  24-26   TOTAL CONTIGUOUS MAIN STORAG                     05300020
*        BYTE  27-28   LENGTH OF FIRST TEXT RECORD                      05400020
*        BYTE  29      LENGTH OF WTG TABLE (IN DOUB                     05500020
*        BYTE  30231   PATH THROUGH LOADS OF ROUTIN                     05600020
*        BYTE  32-34   IDTTR OF EXECUTOR FOR FIRST                      05700020
*        BYTE  35      WORKAREA ADDRESS FOR FIRST D                     05800020
*        BYTE  36-39   TABLE OF IDTTRS                                  05900020
*        BYTE  32+N(8) IDTTR OF EXECUTOR FOR NTH DCB  (3 BYTES)         06000020
*                      WORKAREA ADDRESS FOR NTH DCB   (1 BYTE )         06100020
*                      IDTTR OF LAST ROUTINE LOAD     (3 BYTES)         06200020
*                      NOT USED                                         06300020
*                                                                       06400020
*                                                                       06500020
*                                                                       06600020
*                                                                       06700020
*                                                                       06800020
* ATTRIBUTES                                                            06900020
*        REENTRANT, REUSABLE, RUNS IN DATA MANAGEMENT KEY UNLESS Y02072 06950002
*        OTHERWISE SPECIFIED, SUPER STATE                        Y02072 07000002
*                                                                       07100020
*NOTES                                                                  07200020
*        ALL REG EQUATES HAVE AN 'R' AT BEGINNING                       07300020
*                                                                       07400020
*                                                                       07500020
RDCB     EQU   2                        DCB ADDR                        07600020
RBASE    EQU   3                        BASE REG                        07700020
RCORE    EQU   4                        WORK AREA ADDR                  07800020
RPAR     EQU   5                        TOP OF PARAMETER LIST           07900020
RWTG     EQU   6                        TOP OF WTG TABLE                08000020
RPARC    EQU   7                        CURRENT PARAMETER               08100020
RWTGC    EQU   8                        CURRENT TRANSFER LOAD           08200020
RWK1     EQU   9                        WORK REGISTER            Y02072 08300002
RUCB     EQU   10                       HERE HOLD CONST 8               08500020
RDEB     EQU   11                       HERE HOLDS DCBCHP               08600020
RB       EQU   12                       CHP POINTER                     08700020
RC       EQU   13                       IOB POINTER                     08800020
RRET     EQU   RC                       RETURN ADDR REGISTER     Y02072 08850002
RD       EQU   14                       WORK REG AND CCW POINTER        08900020
RWK3     EQU   RD                       WORK REGISTER            Y02072 08950002
RJ       EQU   15                       WORK REG AND INDEX REG          09000020
RE       EQU   0                        WORK REG                        09100020
RF       EQU   1                        WORK REG                        09200020
RWK4     EQU   RF                       WORK REGISTER            Y02072 09250002
*                                                                       09300020
*                                                                       09400020
*                                                                       09500020
*                                                                       09600020
*                                                                       09700020
*                                                                       09800020
* DISPLACEMENTS AS EQUATES                                              09900020
*                                                                       10000020
*                                                                       10100020
D0       EQU   0                        DISPLACEMENT OF ZERO            10200020
D1       EQU   1                        DISPLACEMENT OF ONE             10300020
D2       EQU   2                        DISPLACEMENT OF TWO             10400020
D3       EQU   3                        DISPLACEMENT OF THREE           10500020
D4       EQU   4                        DISPLACEMENT OF FOUR            10600020
D5       EQU   5                        DISPLACEMENT OF FIVE            10700020
D6       EQU   6                        DISPLACEMENT OF SIX             10800020
D12      EQU   12                       DISPLACEMENT OF TWELVE          10900020
D14      EQU   14                       DISPLACEMENT OF FOURTEEN        11000020
D16      EQU   16                       DISPLACEMENT OF SIXTEEN         11100020
D32      EQU   32                       DISPLACEMENT OF THIRTYTWO       11200020
*                                                                       11300020
*                                                                       11400020
* BYTE COUNTS AS EQUATES                                                11500020
*                                                                       11600020
ZERO     EQU   0                        BYTE COUNT OF ZERO              11700020
TWNTY    EQU   20                       BYTE COUNT OF 20                11800020
ONE      EQU   1                        BYTE COUNT OF ONE               11900020
TWO      EQU   2                        BYTE COUNT OF TWO               12000020
THREE    EQU   3                        BYTE COUNT OF THREE             12100020
FIVE     EQU   5                        BYTE COUNT OF FIVE              12200020
EIGHT    EQU   8                        BYTE COUNT OF EIGHT             12300020
SXTN     EQU   16                       BYTE COUNT OF SIXTEEN           12400020
TWFOUR   EQU   24                       BYTE COUNT OF 24                12500020
THRYSIX  EQU   36                       BYTE COUNT OF 36                12600020
FRTY     EQU   40                       BYTE COUNT OF 40                12700020
*                                                                       12800020
*                                                                       12900020
* CCW COMMANDS                                                          13000020
*                                                                       13100020
SRCH     EQU   X'31'                    SEARCH COMMAND                  13200020
TIC      EQU   X'08'                    TIC                             13300020
RDCNT    EQU   X'92'                    READ COUNT                      13400020
RDDATA   EQU   X'86'                    READ DATA                       13500020
NOP      EQU   X'03'                    NO OPERATION                    13600020
MTSRCH   EQU   X'B1'                    MULTI TRACK SEARCH              13700020
WRTCKD   EQU   X'1D'                    WRT COUNT, KEY AND DATA         13800020
MTRDD    EQU   X'86'                    READ DATA                       13900020
SETSC    EQU   X'23'                    SET SECTOR                      14000020
RDSC     EQU   X'22'                    READ SECTOR                     14100020
*                                                                       14200020
*                                                                       14300020
* CCW FLAGS                                                             14400020
*                                                                       14500020
PCI      EQU   X'08'                    PROGRAM CONTROLED INTERR        14600020
SKIP     EQU   X'10'                    SKIP FLAG                       14700020
SIL      EQU   X'20'                    SILI FLAG                       14800020
CC       EQU   X'40'                    COMMAND CHAIN                   14900020
DC       EQU   X'80'                    DATA CHAIN                      15000020
*                                                                       15100020
*                                                                       15200020
* MASKS                                                                 15300020
*                                                                       15400020
UFORM    EQU   X'C0'                    FORMAT 'U' RECORDS              15500020
FFORM    EQU   X'80'                    FORMAT 'F' RECORDS              15600020
UORVFORM EQU   X'40'                    FORMAT 'U' OR 'V' RECS   A46882 15650021
VALCHK   EQU   X'80'                    VALIDITY CHECK                  15700020
POINTB   EQU   X'04'                    POINT                           15800020
NORCDRY  EQU   X'20'                    NO RECORD READY                 15900020
PCIIND   EQU   X'04'                    PCI INDICATOR                   16000020
OUTIN    EQU   X'07'                    DCB FOR OUT/IN                  16100020
*                                                                       16200020
*                                                                       16300020
* MISCELLANEOUS EQUATES                                                 16400020
*                                                                       16500020
CMPNOERR EQU   X'7F'                    ECB INITIALIZATION              16600020
*                                       COMPLETE NO ERROR               16700020
CHPOFF   EQU   56                       CHANNEL PROG OFFSET IN MIOB     16800020
CHPADO   EQU   32                       OFF IN MIOB TO CHP ADDR         16900020
CCHHRO   EQU   51                       OFFSET IN MIOB TO SEEK FLD      17000020
RRWOF    EQU   96                       RCD READY WRITE CCW OFFSET DMOR 17100020
NWCPO    EQU   X'40'                    NORMAL CHP WRT OFFSET           17200020
NWCPL    EQU   X'05'                    NORMAL WRT CHP LENGTH IN        17300020
*                                       DWS                             17400020
MIOBSIZE EQU   80                       MAIN IOB SIZE                   17500020
RNOPOFF  EQU   56                       RD CHP NOP OFFSET               17600020
WNOPOFF  EQU   96                       WRT CHP NOP OFFSET              17700020
ICBWO    EQU   60                       WRT OFFSET IN ICB               17800020
ICBSEEK  EQU   35                       SEEK FIELD OFFSET IN ICB        17900020
ICBCHPO  EQU   40                       OFFSET IN ICB TO CHP            18000020
NWRTCHP  EQU   88                       NORM WRITE CHP OFFSET           18100020
BICBSIZE EQU   112                      BASIC ICB SIZE                  18200020
MAX      EQU   256                      MAXIMUM SS LENGTH OPERAND       18300020
OFFSICBS EQU   147                      BASIC OFFSET FROM ONE ICB       18400020
*                                       TO CHP OF NEXT ICB              18500020
IOBCEXCP EQU   X'80'                    IOBCNOPA FLAG            YM6583 18550002
SEEKOFF  EQU   48                       OFFSET TO MIOB SEEK             18600020
CNTOFF   EQU   7                        OFFSET IN CCW TO CNT FLD        18700020
FLAGOFF  EQU   4                        OFFSET IN CCW TO FLAG BYTE      18800020
RRWCPO   EQU   NWCPO+EIGHT              RECORD READY CHP OFFSET         18900020
*                                                                       19000020
*                                                                       19100020
*                                                                       19200020
*                                                                       19300020
*                                                                       19400020
*                                                                       19500020
*                                                                       19600020
*                                                                       19700020
*                                                                       19800020
         BALR  RBASE,RE                 ESTABLISH ADDRESSABILITY        19900020
         USING ENTRY,RBASE                                              20000020
         USING IHADCB,RDCB              DCB DSECT                       20100020
         USING FORCORE,RCORE            COMMON OPEN WORK AREA           20200020
*                                                                       20300020
ENTRY    EQU   *                                                        20400020
*                                                                       20450002
         B     BEGIN                    BR AROUND CONSTANTS      Y02072 20460002
         DC    C'IGG0191X'              MODULE NAME              Y02072 20470002
         DC    C'@Z30TSCF'              LAST SHIP CODE         @Z30TSCF 20480003
         DC    C'10/17/74'              LAST DATE MODIFIED     @Z30TSCF 20490003
BEGIN    DS    0H                                                Y02072 20492002
*                                                                       20500020
         L     RCORE,D4(RWTGC)          LOAD RCORE BASE                 20600020
*                                                                       20700020
         L     RDCB,D0(RPARC)           GET DCB ADDRESS                 20800020
*                                                                       20900020
* TEST FOR ONE BUFFER WHICH IS NOT ALLOWED WITH CHAINED SCHEDULING      21000020
*                                                                       21100020
         CLI   DCBNCP,ONE               IS NUMBER OF CHP EQ ONE         21200020
         BH    LAB007                   IF NO BRANCH                    21300020
*                                       YES SET UP TO XCTL              21400020
         USING WTGENTRY,RWTGC                                    Y02072 21450002
         MVC   WTGIDTTR,SOP8A           ID FOR DISK EXECUTOR   @Z30TSCF 21460003
         B     RELOOP                   GO TO XCTL RTN                  21600020
*                                                                       21700020
*                                                                       21800020
LAB007   EQU   *                                                        21900020
         OI    DCBCIND2,PCIIND          TURN ON PCI INDICATOR           22000020
         LA    RF,MIOBSIZE              GET BASIC IOB SIZE              22100020
         LA    RUCB,EIGHT               CONSTANT OF EIGHT               22200020
*                                                                       22300020
* TEST OF NOTE/POINT BEING USED                                         22400020
*                                                                       22500020
         TM    DCBMACRF,POINTB          NOTE/POINT BEING USED           22600020
         BZ    LAB011                   NO THEN BRANCH                  22700020
         MVI   DCBCNTRL+D1,FIVE         STORE INDEX FOR N/P ID          22800020
LAB011   EQU   *                                                        22900020
*                                                                       23000020
*                                                                       23100020
         SR    RD,RD                    CLEAR REG FOR ACCUMULATION      23200020
*                                       OF ICB LENGTH                   23300020
*                                                                       23400020
* SET UP CONTROL FIELDS AND INITIALIZE COUNT REGS                       23500020
*                                                                       23600020
         MVI   DCBCNTRL+D2,ONE          DISK EOBW IND FOR LOAD MOD      23700020
         MVI   DCBCNTRL+D3,TWO          DA IN EOB IDS                   23800020
         MVI   DCBWCPO,NWCPO            PUT NORMAL WRT CHP OFFSET       23900020
*                                       IN DCB                          24000020
         LA    RC,NWCPL                 GET NORMAL WRT CHP LENGTH       24100020
         MVC   DCBOFFSR(TWO),OFFSETD    PUT OFFSETS IN DCB              24200020
         LA    RDEB,WNOPOFF             GET NORMAL WRITE NOP OFFSET     24300020
*                                                                       24400020
* CHECK FOR RECORD READY FEATURE IF BEING USED INCREMENT COUNTS         24500020
*                                                                       24600020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD READY       24700020
         BO    LAB017                   BRANCH IF YES                   24800020
         MVI   DCBOFFSW,RRWOF           CHANGE WRITE OFFSET             24900020
         MVI   DCBWCPO,RRWCPO           RCD READY OFFSET IN DCB         25000020
         LA    RC,ONE(RC)               INCREMENT CCW COUNT             25100020
         AR    RDEB,RUCB                NOP OFFSET PLUS EIGHT (WRT)     25200020
         LA    RF,SXTN(RF)              INCR MAIN IOB SIZE              25300020
         LA    RD,SXTN(RD)              INCR ICB SIZE                   25400020
LAB017   EQU   *                                                        25500020
*                                                                       25600020
* STORE COUNTS                                                          25700020
*                                                                       25800020
*                                                                       25900020
*                                                                       26000020
* CHECK FOR VALIDITY CHK AND INCREMENT COUNTS                           26100020
*                                                                       26200020
         TM    DCBOPTCD,VALCHK          VAL CHK USED                    26300020
         BNO   LAB029                   BRANCH IF NO                    26400020
         LA    RD,TWFOUR(RD)            INCR ICB SIZE                   26500020
         LA    RDEB,TWFOUR(RDEB)        INCR WRT NOP OFFSET             26600020
         LA    RC,THREE(RC)             INCR CCW COUNT                  26700020
*                                                                       26800020
* NOW CHK AGAIN FOR RCD READY FEATURE AND INCREMENT COUNTS              26900020
LAB021   EQU   *                                                        27000020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD READY       27100020
         BO    LAB029                   BRANCH IF YES                   27200020
         AR    RD,RUCB                  INCR ICB COUNT FOR SET          27300020
*                                       SECTOR CMND IN WRT CHK          27400020
         AR    RDEB,RUCB                INCR NOP OFFSET FOR SAME        27500020
*                                       CMND                            27600020
         AR    RDEB,RUCB                INCREMENT                       27700020
         LA    RC,ONE(RC)               INCR WRT CHP LENGTH             27800020
*                                                                       27900020
* STORE OF REMAINING COUNTS                                             28000020
LAB029   EQU   *                                                        28100020
         STC   RC,DCBWCPL               PUT CHP LENGTH IN DCB           28200020
*                                                                       28300020
* NOW CALCULATE TOTAL CORE NEEDED FOR ICBS                              28400020
*                                                                       28500020
         LA    RD,BICBSIZE(RD)          INCREMENT ICB COUNT FOR         28600020
*                                       BASIC ICB                       28700020
         LR    RB,RD                    COPY AMOUNT                     28800020
         SRL   RB,THREE                 DIVIDE BY DW                    28900020
         STC   RB,DCBIOBL               PUT IN DCB                      29000020
         SR    RJ,RJ                    CLEAR REGISTER                  29100020
         IC    RJ,DCBNCP                GET NO. OF CHPS TO BE BUILT     29200020
         MR    RD,RD                    AMOUNT OF SPACE NEEDED          29300020
*                                       MINUS MAIN IOB                  29400020
*                                                                       29500020
* GET TOTAL AMOUNT OF CORE NEEDED AND ISSUSE GET MAIN                   29600020
*                                                                       29700020
         AR    RJ,RF                    MAIN IOB PLUS TOTAL ICBS        29800020
         LR    RC,RJ                    SAVE AMOUNT FOR CLEARING        29900020
*                                                                       30000020
*  THE FOLLOWING SAVES THE AMOUNT OF CORE GETMAINED FOR THE      YM4697 30050002
*  IOB AND ICBS IN THE FORCE CLOSE AUDIT TRAIL FOR THE FORCE     YM4697 30060002
*  CLOSE EXECUTOR.                                               YM4697 30070002
*                                                                       30100020
         ST    RJ,DXATEXC2              SAVE LENGTH              YM4697 30110002
         MODESET  KEYADDR=DXUKEY,WORKREG=9 GET INTO USER KEY     Y02072 30150002
         GETMAIN R,LV=(RJ),SP=0                                  Y02072 30200002
         LR    RB,RF                    COPY ADDRESS USED TO CLR        30400020
*                                                                       30500020
* CLEAR OF RECEIVED CORE  RB=ADDRESS   RC=AMOUNT                        30600020
*                                                                       30700020
         LR    RJ,RC                    SAVE AMOUNT FOR THETA ADDRS     30800020
         LA    RD,MAX                   CONST OF 256                    30900020
         B     LABCLR                   BRANCH TO CLEAR                 31000020
LABSLO   EQU   *                                                        31100020
         XC    D0(D1,RB),D0(RB)         CLEARS REMAING BYTES            31200020
LABSHI   EQU   *                                                        31300020
         XC    D0(MAX,RB),D0(RB)        CLEAR 256 BYTES                 31400020
         AR    RB,RD                    ADD 256 TO ADDR                 31500020
LABCLR   EQU   *                                                        31600020
         SR    RC,RD                    SUB 256 FROM AMOUNT             31700020
         BH    LABSHI                   BRANCH AMT GT 256               31800020
         AR    RC,RD                    CORRECT AMT                     31900020
         BCTR  RC,RE                    REDUCE AMT BY ONE RE=0          32000020
         EX    RC,LABSLO                                                32100020
*                                                                       32200020
* SET UP THETA ADDRESSES MAY BE USED LATER                              32300020
*                                                                       32400020
         AR    RJ,RF                    GET LAST AREA ADDR + 1          32500020
         SR    RJ,RUCB                  REDUCE BY EIGHT                 32600020
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 32610002
         ST    RWK4,DCBIOBAD            PUT MAIN IOB IN DCB      Y02072 32650002
         OI    FCAOPEN,FCAOIOB          INDIC IOB'S CAN BE FREED Y02072 32660002
         ST    RJ,DXCCW11               TEMP STORE SET THETA ADDR       32700020
*                                                                       33000020
* START CONST OF MAIN IOB HERE                                          33100020
*                                                                       33200020
         MODESET  KEYADDR=DXUKEY,WORKREG=9 GET INTO USER KEY     Y02072 33260002
         STC   RDEB,D3(RF)              PUT WRT NOP OFFSET IN MIOB      33300020
         IC    RDEB,DCBNCP              LOAD NO. OF CHANL PROGRAMS      33400020
         MVI   D2(RF),RNOPOFF                                           33500020
         LA    RE,D4(RF)                ECB ADDR                        33600020
         ST    RE,TWNTY(RF)             PUT ADDR IN ECB POINTER         33700020
         MVI   D4(RF),CMPNOERR          INITIALIZE ECB                  33800020
         L     RWK1,DXUDCBAD            GET USERS DCB ADDRESS    Y02072 33850002
         USING IOBQSAMC,RWK4                                     Y02072 33900002
         ST    RWK1,IOBDCBPT            DCB ADDR TO IOB          Y02072 33950002
         DROP  RWK4                                              Y02072 34000002
*                                                                       34100020
*                                                                       34200020
         LA    RD,CHPOFF(RF)            GET CHP OFFSET IN IOB           34300020
         ST    RD,CHPADO(RF)            PUT IN MAIN IOB                 34400020
         MVC   SEEKOFF(EIGHT,RF),DCBFDAD DISK ADDR TO MIOB              34500020
*                                                                       34600020
* START CONSTRUCTION OF MAIN IOB CHP                                    34700020
*                                                                       34800020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD READY       34900020
         BO    LAB033                   BRANCH IF YES                   35000020
         BAL   RC,LABSTA                IF NO GO BUILD SET SECT         35100020
LAB033   EQU   *                                                        35200020
*                                                                       35300020
* CONSTRUCTION OF SEARCH AND TIC CCWS                                   35400020
*                                                                       35500020
         LA    RE,CCHHRO(RF)            GET CCHHR ADDR                  35600020
         BAL   RC,LABSRCH               GO BUILD IN SUB ROUTINE         35700020
*                                                                       35800020
* POINT TO FIRST ICB AND COMPLETE SECOND TIC CCW                        35900020
*                                                                       36000020
         LA    RB,EIGHT(RD)             PT RB TO FIRST ICB              36100020
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 36160002
         ST    RB,DCBIOBA               PUT IN DCB                      36200020
         MODESET  KEYADDR=DXUKEY,WORKREG=9 GET INTO USER KEY     Y02072 36260002
         LA    RC,FRTY(RB)              GET ICB CHP ADDR                36300020
         ST    RC,D0(RD)                PUT IN CCW                      36400020
         MVI   D0(RD),TIC               PUT IN TIC CMND                 36500020
         ST    RB,EIGHT(RF)             FIRST ICBAD TO MIOB             36600020
         AR    RD,RUCB                  INCR CCW PTR                    36700020
*                                                                       36800020
*                                                                       36900020
*                                                                       37000020
* START OF LOOP TO BUILD ICBS                                           37100020
*                                                                       37200020
LAB051   EQU   *                                                        37300020
         ST    RD,D0(RB)                     LINKAD TO ICB              37400020
*                                            REDUNDANT FOR FIRST        37500020
*                                            TIME                       37600020
         LR    RB,RD                         NEW ICB ADDR               37700020
         LA    RC,D4(RB)                     ECB ADDR                   37800020
         ST    RC,D12(RB)                    PUT IN ICB                 37900020
         MVI   D4(RB),CMPNOERR               INIT ECB COMPLETE NO       38000020
*                                            ERROR                      38100020
         LA    RD,D32(RB)                    PT TO MBBCCHHR FIELD OF    38200020
*                                            ICB                        38300020
         MVC   D0(EIGHT,RD),DCBFDAD          FULL DISK ADDR TO ICB      38400020
*                                                                       38500020
* ICB INITIALIZATION COMPLETE                                           38600020
*                                                                       38700020
         AR    RD,RUCB                       INCR RD TO BECOME CCW      38800020
*                                            PTR                        38900020
* CLEAR INDEX REG AND GET ICB SIZE                                      39000020
*                                                                       39100020
         SR    RJ,RJ                         CLEAR REG                  39200020
         IC    RJ,DCBIOBL               GET ICB SIZE IN DW              39300020
         SLL   RJ,THREE                 TIMES EIGHT                     39400020
         LA    RE,ICBSEEK(RB,RJ)        NEXT ICB SEEK FIELD             39500020
         ST    RE,D0(RD)                PUT IN CCW                      39600020
         MVI   FLAGOFF(RD),CC+PCI+SIL   SET FLAGS                       39700020
         BAL   RRET,LAB666              GO RESET PCI BIT IF      Y02072 39750002
*                                         NECESSARY              Y02072 39760002
         MVI   CNTOFF(RD),FIVE          SET BYTE COUNT                  39800020
         MVI   D0(RD),RDCNT             PUT IN CMND BYTE                39900020
         AR    RD,RUCB                  INCR CCW PTR                    40000020
*                                                                       40100020
* READ COUNT CCW COMPLETED                                              40200020
*                                                                       40300020
*                                                                       40400020
         MVI   FLAGOFF(RD),CC           TURN ON CMND CHAIN              40500020
         TM    DCBRECFM,UORVFORM        TEST FOR UNDEF OR        A46882 40550021
*                                          VARIABLE LENGTH RECS  A46882 40600021
*                                          IF YES, TURN ON SILI  A46882 40650021
         BNO   LAB069                   NO, DON'T TURN ON SILI   A46882 40700021
         OI    FLAGOFF(RD),SIL          TURN ON SILI BIT                41300020
LAB069   EQU   *                                                        41400020
*                                                                       41500020
         MVI   D0(RD),RDDATA            SET CCW CMND BYTE               41600020
         AR    RD,RUCB                  INCR CCW PTR                    41700020
*                                                                       41800020
* READ DATA CCW COMPLETETED                                             41900020
*                                                                       42000020
*                                                                       42100020
         LA    RE,ICBCHPO(RB,RJ)        GET ADDR OF NEXT ICB CHP        42200020
         BAL   RC,LABNOP                GO BUILD NOP                    42300020
*                                                                       42400020
* NOP COMMAND COMPLETED READ PORTION OF CHANNEL PROG COMPLETED          42500020
*                                                                       42600020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD READY       42700020
         BO    LAB075                   BRANCH IF YES                   42800020
         BAL   RC,LABNOPS               GO BUILD NOP/TIC AND RD SEC     42900020
LAB075   EQU   *                                                        43000020
*                                                                       43100020
* IF NEEDED READ SECTOR COMMAND COMPLETED                               43200020
*                                                                       43300020
* START OF WRITE CHANNEL PROGRAM                                        43400020
*                                                                       43500020
         LA    RE,ICBSEEK(RB)           GET ICB SEEK ADDR               43600020
         BAL   RC,LABSRCH               GO BUILD SEARCH AND TIC         43700020
         SH    RD,CON16                 BACK UP POINTER                 43800020
         MVI   D0(RD),MTSRCH            PUT I M-T SRCH CMND             43900020
         AH    RD,CON16                 INCR CCW PTR                    44000020
*                                                                       44100020
* SEARCH AND TIC CMND COMPLETE                                          44200020
*                                                                       44300020
*                                                                       44400020
*                                                                       44500020
         LA    RE,ZERO(RB,RJ)           POINT TO NEXT ICB               44600020
         SR    RE,RUCB                  BACK UP TO CCHHRR FIELD         44700020
         ST    RE,D0(RD)                PUT IN CCW                      44800020
         MVI   FLAGOFF(RD),DC+SIL+PCI   TURN ON DC, SILI, AND PCI       44900020
*                                       FLAGS                           45000020
         BAL   RRET,LAB666              GO RESET PCI BIT IF      Y02072 45050002
*                                         NECESSARY              Y02072 45060002
         MVI   CNTOFF(RD),EIGHT         SET BYTE CNT TO EIGHT           45100020
         MVI   D0(RD),WRTCKD            PUT IN WRT COUNT KEY DATA       45200020
*                                       CCW CMND                        45300020
         AR    RD,RUCB                  INCR CCW PTR                    45400020
*                                                                       45500020
* WRT COUNT KEY DATA CCW COMPLETED                                      45600020
*                                                                       45700020
         MVI   FLAGOFF(RD),SIL+CC       TURN ON SILI FLAG IN CCW        45800020
*                                       NEXT CCW ALL THAT IS NEEDED     45900020
*                                       SINCE REST COMPLETED BY EOB     46000020
         AR    RD,RUCB                  INCR CCW PTR                    46100020
*                                                                       46200020
*                                                                       46300020
* CHECK FOR WRITE CHECK REQUESTED                                       46400020
*                                                                       46500020
         TM    DCBOPTCD,VALCHK          VAL CHK REQUESTED               46600020
         BNO   LAB101                   BRANCH IF NO                    46700020
         SR    RD,RUCB                  BACK UP CCW POINTER             46800020
         OI    FLAGOFF(RD),CC           COMMAND CHAIN PREV CCW          46900020
         AR    RD,RUCB                  RESTORE POINTER                 47000020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD READY       47100020
         BO    LAB095                   BRANCH IF YES                   47200020
         OI    FLAGOFF(RD),CC           COMMAND CHAIN CCW               47300020
         BAL   RC,LABRTA                GO BUILD RD SECTOR              47400020
         BAL   RC,LABSTA                GO BUILD SET SECT CMND          47500020
         SR    RD,RUCB                  BACK UP POINTER                 47600020
         OI    D3(RD),D1                INCREMENT ADDR BY ONE           47700020
*                                       THIS WORKS SINCE ADDR IS        47800020
*                                       ALWAYS ON A DW BOUNDARY         47900020
         AR    RD,RUCB                  RESTORE POINTER                 48000020
LAB095   EQU   *                                                        48100020
*                                                                       48200020
* BUILD SRCH AND TIC CMND                                               48300020
*                                                                       48400020
         LA    RE,D0(RJ,RB)             POINT TO NEXT ICB               48500020
         SR    RE,RUCB                  BACK UP TO CCHHR ADDR           48600020
         BAL   RC,LABSRCH               GO BUILD SEARCH AND TIC         48700020
*                                                                       48800020
* SRCH AND TIC FOR VAL CHK COMPLETED                                    48900020
*                                                                       49000020
         MVI   FLAGOFF(RD),CC+SIL+SKIP  TURN ON SILI, SKIP AND SKIP     49100020
*                                       FLAGS                           49200020
         MVI   D0(RD),MTRDD             PUT IN CCW CMND                 49300020
         AR    RD,RUCB                  INCR CCW PTR                    49400020
*                                                                       49500020
*                                                                       49600020
* LAST CCW IN CHP IS NOP                                                49700020
*                                                                       49800020
LAB101   EQU   *                                                        49900020
         LA    RE,NWRTCHP(RB,RJ)        GET NORM WRT CHP ADDR OF        50000020
*                                       NEXT ICB                        50100020
         BAL   RC,LABNOP                GO BUILD NOP                    50200020
*                                                                       50300020
* CHECK FOR RCD READY FEATURE AND IF BEING USED MUST BUILD READ         50400020
* SECTOR COMMAND                                                        50500020
*                                                                       50600020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD READY       50700020
         BO    LAB091                   BRANCH IF YES                   50800020
         TM    DCBOPTCD,VALCHK          WRT CHECK USED                  50900020
         BO    LAB091                   BRANCH IF YES                   51000020
         BAL   RC,LABNOPS               GO BUILD NOP/TIC AND RD SEC     51100020
LAB091   EQU   *                                                        51200020
*                                                                       51300020
* CHANNEL PROGRAM FINISHED HERE, CHECK FOR MORE TO BE BUILT             51400020
*                                                                       51500020
         AR    RD,RUCB                  INCR PTR TO NEXT ICB            51600020
         BCT   RDEB,LAB051              IF MORE CCWS TO BE BUILT        51700020
*                                       GO BUILD THEM                   51800020
*                                                                       51900020
* IF ALL ICBS BUILT DO FINISH UP LOGIC                                  52000020
*                                                                       52100020
         L     RC,DCBIOBA               GET FIRST ICB POINTER      DMOR 52200020
         ST    RC,ZERO(RB)              PUT IN LAST ICB            DMOR 52300020
         LA    RE,ICBSEEK(RC)           GET FIRST ICB SSEK ADDR    DMOR 52400020
         ST    RE,ICBCHPO(RB)           PUT IN LAST ICB RD CNT     DMOR 52500020
         MVI   ICBCHPO(RB),RDCNT        RESTORE CCW CMND           DMOR 52600020
         LA    RE,ICBCHPO(RC)           PT TO FIRST ICB CHP        DMOR 52700020
*                                                                  DMOR 52800020
* ICBS AND RD CNTS LINKED                                          DMOR 52900020
*                                                                  DMOR 53000020
         LA    RDEB,RNOPOFF(RB)         PT TO LAST ICBS RD NOP          53100020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD READY  DMOR 53200020
         BO    LAB111                   BRANCH IF YES              DMOR 53300020
         ST    RE,D4(RDEB)              PUT ADDR IN RH OF NOP/TIC  DMOR 53400020
         B     LAB115                   BRANCH AROUND NEXT         DMOR 53500020
*                                                                  DMOR 53600020
LAB111   EQU   *                                                   DMOR 53700020
*                                                                  DMOR 53800020
         ST    RE,D0(RDEB)              PUT IN NOP CCW             DMOR 53900020
         MVI   D0(RDEB),NOP             RESTORE NOP CMND           DMOR 54000020
*                                                                  DMOR 54100020
*                                                                  DMOR 54200020
LAB115   EQU   *                                                        54300020
*                                                                  DMOR 54400020
         LA    RC,RNOPOFF(RC)           PT TO WRT CHP ADDR         DMOR 54500020
         SH    RD,CON16                 BACK UP CCW PTR PAST CCHHR DMOR 54600020
         TM    DCBOPTCD,VALCHK          WRT CHK USED               DMOR 54700020
         BO    LAB121                   BRANCH IF YES              DMOR 54800020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD READY  DMOR 54900020
         BO    LAB121                   BRANCH IF YES              DMOR 55000020
         SR    RD,RUCB                  BACK PAST RD SECTOR        DMOR 55100020
         AR    RC,RUCB                  INCR POINTER                    55200020
         ST    RC,D4(RD)                PUT ADDR IN RH OF NOP/TIC  DMOR 55300020
         B     LAB141                   GO AROUND NEXT INSTS       DMOR 55400020
*                                                                  DMOR 55500020
LAB121   EQU   *                                                   DMOR 55600020
*                                                                  DMOR 55700020
         ST    RC,D0(RD)                PUT ADDR IN LAST ICB NOP   DMOR 55800020
         MVI   D0(RD),NOP               RESTORE NOP CMND           DMOR 55900020
*                                                                  DMOR 56000020
LAB141   EQU   *                                                   DMOR 56100020
*                                                                  DMOR 56200020
         L     RC,DCBIOBA               GET FIRST ICB ADDR         DMOR 56300020
         L     RDEB,DCBDEBAD            GET DEB ADDR               DMOR 56400020
*                                                                  DMOR 56500020
* NOPS NOW LINKED TO CHANNEL PROGRAMS                              DMOR 56600020
*                                                                  DMOR 56700020
         TM    SXTN(RDEB),OUTIN         DCB FOR OUT/IN             DMOR 56800020
         BO    LAB151                   BRANCH IF YES              DMOR 56900020
         LA    RE,RNOPOFF(RC)           GET RD NOP ADDR            DMOR 57000020
         B     LAB161                   GO AROUND NEXT             DMOR 57100020
*                                                                  DMOR 57200020
LAB151   EQU   *                                                   DMOR 57300020
*                                                                  DMOR 57400020
         LA    RE,WNOPOFF(RC)           GET NORM WRITE NOP OFFSET  DMOR 57500020
         TM    JFCBMASK+D6,NORCDRY      ANY DEVICES W/O RCD READY  DMOR 57600020
         BO    LAB161                   BRANCH IF YES              DMOR 57700020
         AR    RE,RUCB                  INCR OFFSET REG            DMOR 57800020
*                                                                  DMOR 57900020
LAB161   EQU   *                                                   DMOR 58000020
*                                                                  DMOR 58100020
         ST    RE,D12(RF)               PUT NOP OFFSET IN MIOB          58200020
         MVI   12(RF),IOBCEXCP          SET EXCP NEEDED FLAG     YM6583 58250002
*                                                                       58300020
* SET UP FOR XCTL OUT TO NEXT EXECUTOR                                  58400020
*                                                                       58500020
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 58510002
         USING WTGENTRY,RWTGC                                    Y02072 58560002
         MVC   WTGIDTTR,NXTEXEC         NEXT EXECUTOR          @Z30TSCF 58570003
RELOOP   EQU   *                                                        58900020
         LA    RWTGC,EIGHT(RWTGC)       INCR  CURRENT WTG ENTRY         59000020
         LA    RPARC,D4(RPARC)          INCR DCB ENTRY PTR              59100020
         CLC   D0(TWO,RWTGC),AMIDCNST   IS THIS RTN NEEDED AGAIN        59200020
         BCR   EIGHT,RBASE              IF YES GO BACK                  59300020
*                                                                       59400020
         CLC   D0(TWO,RWTGC),OPIDCNST   IS THIS END OF TABLE            59500020
         BNE   RELOOP                   BRANCH IF NO                    59600020
*                                                                       59700020
         LR    RPARC,RPAR                                               59800020
         LA    RWTGC,D32(RWTG)          REINIT WTG LIST PTR             59900020
ZCHEK    EQU   *                                                        60000020
         CLI   D0(RWTGC),ZERO           THIS ENTRY COMPLETE             60100020
         BNE   TCTLRTN                  BRANCH IF NO                    60200020
*                                                                       60300020
*                                                                       60400020
         LA    RWTGC,EIGHT(RWTGC)       GET NEXT ENTRY                  60500020
         LA    RPARC,D4(RPARC)                                          60600020
         B     ZCHEK                    GO TO NEXT ENTRY                60700020
*                                                                       60800020
*                                                                       60900020
TCTLRTN  EQU   *                                                        61000020
*                                                                       62000020
         USING WTG,RWTG                                                 62050003
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSCF*62060003
               MODID=WTGENTRY                                  @Z30TSCF 62080003
         DROP  RWTGC,RWTG                                      @Z30TSCF 62090003
*                                                                       62100020
*                                                                       62200020
* SET SECTOR BUILD RTN                                                  62300020
*                                                                       62400020
LABSTA   EQU   *                                                        62500020
         L     RE,DXCCW11               GET SET THETA ADDR              62600020
         ST    RE,D0(RD)                PUT IN CCW                      62700020
         MVI   D0(RD),SETSC             PUT IN CCW CMND                 62800020
         OI    FLAGOFF(RD),CC           COMMAND CHAIN CCW               62900020
         B     LAB555                   GO FINISH CCW                   63000020
*                                                                       63100020
*                                                                       63200020
*                                                                       63300020
*                                                                       63400020
* NOP AND READ SECTOR ENTRY                                             63500020
*                                                                       63600020
*                                                                       63700020
LABNOPS  EQU   *                                                        63800020
*                                                                       63900020
         SR    RD,RUCB                  BACK UP POINTER                 64000020
         MVC   D5(THREE,RD),D1(RD)      MOVE ADDR TO RH OF TIC NOP      64100020
         LA    RE,EIGHT(RD)             GET NEXT CCW POINTER            64200020
         ST    RE,D0(RD)                PUT IN CCW                      64300020
         MVI   D0(RD),TIC               CHANGE NO TO TIC                64400020
         AR    RD,RUCB                  INCR POINTER                    64500020
*                                                                       64600020
*                                                                       64700020
* READ SECTOR BUILD RTN                                                 64800020
LABRTA   EQU   *                                                        64900020
         L     RE,DXCCW11               GET READ THETA ADDR      Y02072 65000002
         ST    RE,D0(RD)                PUT IN CCW                      65100020
         MVI   D0(RD),RDSC              PUT IN CCW CMND                 65200020
LAB555   EQU   *                                                        65300020
         MVI   CNTOFF(RD),ONE           SET BYTE CNT TO ONE             65400020
         AR    RD,RUCB                  INCR PTR                        65500020
         BR    RC                       RETURN                          65600020
*                                                                       65700020
* SEARCH AND TIC BUILD ROUTINE                                          65800020
*                                                                       65900020
LABSRCH  EQU   *                                                        66000020
         ST    RE,D0(RD)                PUT ADDR IN CCW                 66100020
         MVI   FLAGOFF(RD),CC           TURN ON CC                      66200020
         MVI   CNTOFF(RD),FIVE          SET BYTE CNT TO FIVE            66300020
         ST    RD,EIGHT(RD)             PUT SRCH CCW ADDR IN NEXT       66400020
*                                       CCW                             66500020
         MVI   D0(RD),SRCH              PUT IN SRCH CMND                66600020
         AR    RD,RUCB                  INCREMENT CCW PTR               66700020
         MVI   D0(RD),TIC               PUT IN TIC CMND                 66800020
         AR    RD,RUCB                  INCR CCW PTR                    66900020
         BR    RC                       RETURN                          67000020
*                                                                       67100020
* NOP BUILD ROUTINE                                                     67200020
*                                                                       67300020
LABNOP   EQU   *                                                        67400020
         ST    RE,D0(RD)                PUT IN CCW                      67500020
         MVI   FLAGOFF(RD),SIL          TURN ON SILI FLAG               67600020
         MVI   D0(RD),NOP               ENTER NOP CCW CMND              67700020
         MVI   CNTOFF(RD),ONE           SET BYTE COUNT TO ONE           67800020
         AR    RD,RUCB                  INCR POINTER                    67900020
         BR    RC                       RETURN                          68000020
*                                                                       68050002
* THE FOLLOWING ROUTINE TESTS TO SEE IF THIS JOB IS RUNNING IN   Y02072 68060002
* A VIRTUAL ENVIRONMENT.  IF YES, PCI BIT SHOULD NOT BE LEFT ON. Y02072 68070002
* IF NO, PCI BIT SHOULD BE LEFT ON.                              Y02072 68080002
*                                                                       68082002
LAB666   EQU   *                                                 Y02072 68084002
         L     RWK1,DCBDEBAD            GET DEB ADDRESS          Y02072 68086002
         USING DEBBASIC,RWK1                                     Y02072 68088002
         L     RWK1,DEBTCBAD            TCB ADDR FOR V=R TEST    Y02072 68088402
         DROP  RWK1                                              Y02072 68088802
         USING TCB,RWK1                                          Y02072 68089202
         TM    TCBFLGS6,TCBRV           JOB RUNNING VIRT         Y02072 68089602
         BOR   RRET                     NO, LEAVE PCI BIT ON     Y02072 68089702
         USING CCW,RWK3                                          Y02072 68089802
         NI    CCWFLGS,X'FF'-CCWPCI     YES, TURN PCI BIT OFF    Y02072 68089902
         DROP  RWK3                                              Y02072 68093202
         BR    RRET                     RETURN MAINLINE          Y02072 68095202
*                                                                       68096702
* CONSTANTS                                                             68100020
*                                                                       68200020
CON16    DC    H'16'                    CONSTANT OF SIXTEEN             68300020
AMIDCNST DC    C'1X'                    THS ID                    DMOR  68400020
OPIDCNST DC    C'0S'                    END ID                          68500020
SOP8A    DC    C'1J',VL3(IGG0191J)      DISK EXECUTOR          @Z30TSCF 68550003
NXTEXEC  DC    C'13',VL3(IGG01913)   TO LOAD ACCESS METH RTNS  @Z30TSCF 68560003
OFFSETD  DC    X'3058'                  OFFSET                          68600020
         SPACE 6                                                        68650002
PATCH    DC    0H'0',50X'00'            PATCH AREA               Y02072 68660002
END      EQU   *                        END OF MODULE            Y02072 68670002
         EJECT                                                          68680002
*                                                                       68700020
*                                                                       69500020
* DSECTS USED IN MODULE                                                 69600002
*                                                                       69700020
         DCBD  DSORG=PS                                                 69800020
*                                                                       70500020
         EJECT                                                          70510003
CVT      DSECT                                                 @Z30TSCF 70520003
         CVT                                                            70530003
         IECDSECS (MAIN,(IOB,NO)),IOB,WTG,PREFX,EXPAND=YES     @Z30TSCF 70550003
         ORG   WTGIDTTR                                          Y02072 70552002
WTGID    DS    CL2                      NEXT MODS ID             Y02072 70554002
         EJECT                                                          70556002
FORCORE  DSECT                                                   Y02072 70558002
         IHAFCAUD  ORG=YES                                       Y02072 70558402
         EJECT                                                          70558802
         IHACCW  DSECT=YES                                       Y02072 70560002
         EJECT                                                          70562002
         IKJTCB                                                  Y02072 70570002
         EJECT                                                          70572002
         IEZDEB                                                  Y02072 70580002
         END                                                            70600020
