         TITLE 'IGG01921 - LOAD OPEN,GETMAIN LOAD MODE WORK AREA'       00010002
IGG01921 CSECT                                                     DM0E 00011002
*                                                                       00012002
*********************************************************************** 00013002
*                                                                     * 00014002
* MODULE-NAME = IGG01921                                              * 00015002
*                                                                     * 00016002
* DESCRIPTIVE-NAME = ISAM OPEN, INITIAL OR RESUME LOAD MODE           * 00017002
*                                                                     * 00018002
* COPYRIGHT = NONE                                                    * 00019002
*                                                                     * 00020002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00021002
*                                                                     * 00022002
* FUNCTION = GET CORE FOR LOAD MODE WORK AREA (WA) FROM SUBPOOL 250.  * 00023002
*            ZERO WORK AREA CORE.  INITIALIZE THE FOLLOWING:  WA ADDR * 00024002
*            IN DCBWKPT1; WA SIZE IN ISLVPTR8; BCT ADDR IN ISLVPTR3;  * 00025002
*            AREA Y ADDR IN ISLVPTR1; KEYSAVE ADDR IN ISLVPTR2; VPTRS * 00026002
*            ADDR IN DCBWKPT6; RECORD OVERHEAD IN ISLLGAP AND ISLIGAP;* 00027002
*            ECB ADDR'S IN IOBS; ECB COMPLETION CODES; FOR INITIAL    * 00028002
*            LOAD ONLY, DCBNREC, DCBST, DCBHIIOV, DCBHIRPD, DCBHIROV, * 00029002
*            AND DCBHIIOV.                                            * 00030002
*                                                                     * 00032002
* NOTES = NONE                                                        * 00033002
*                                                                     * 00034002
*    DEPENDENCIES = NONE                                              * 00035002
*                                                                     * 00036002
*    RESTRICTIONS = NONE                                              * 00037002
*                                                                     * 00038002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00039002
*                                                                     * 00040002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00041002
*                                                                     * 00042002
* MODULE-TYPE = OPEN EXECUTOR                                         * 00043002
*                                                                     * 00044002
*    PROCESSOR = ASSEMXF-370R                                         * 00045002
*                                                                     * 00046002
*    MODULE-SIZE = 944 DECIMAL BYTES                                  * 00047002
*                                                                     * 00048002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00049002
*                                                                     * 00050002
* ENTRY-POINT = IGG01921                                              * 00051002
*                                                                     * 00052002
*    PURPOSE = SEE FUNCTION                                           * 00053002
*                                                                     * 00054002
*    LINKAGE = RECEIVES CONTROL FROM ISAM OPEN EXECUTOR IGG0192C FOR  * 00055002
*              INITIAL OR RESUME LOAD MODE ONLY.  RECEIVES CONTROL IN * 00056002
*              STORAGE PROTECT KEY 5 AND PRIVILEGED STATE.            * 00057002
*                                                                     * 00058002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00059002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00060002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00061002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00062002
*               PARAMETER LIST                                        * 00063002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00064002
*                                                                     * 00065002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00066002
*          UPON ENTRY TO THIS MODULE                                  * 00067002
*                                                                     * 00068002
* EXIT-NORMAL = XCTL TO ISAM OPEN EXECUTOR IGG0192D FOR INITIAL LOAD, * 00069002
*               IGG01920 FOR RESUME LOAD WITH FIXED LENGTH RECORDS    * 00069202
*               (FLR) OR IGG01950 FOR RESUME LOAD WITH VLR.           * 00069302
*                                                                     * 00070002
* EXIT-ERROR = ABEND CODES:                                           * 00071002
*              002 - BLKSIZE LESS THAN LRECL                          * 00072002
*                  - BLKSIZE NOT AN EVEN MULTIPLE OF LRECL            * 00073002
*                  - BLKSIZE TOO BIG FOR TRACK                        * 00074002
*                  - LRECL + OVERFLOW LINK TOO BIG FOR TRACK          * 00075002
*                                                                     * 00075202
*              03B - DCB NOT OPENED FOR OUTPUT                        * 00075402
*                  - LRECL = 0                                        * 00075602
*                  - KEYLENGTH NOT SPECIFIED                          * 00075802
*                  - RKP + KEYLENGTH GREATER THAN LRECL               * 00075902
*                  - FOR VLR ONLY, RKP LESS THAN 4                    * 00076202
*                                                                     * 00076702
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00077002
*                                                                     * 00078002
*    ROUTINES = NONE                                                  * 00079002
*                                                                     * 00081002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00082002
*                 FORCORE - OPEN WORK AREA                            * 00083002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00084002
*                                                                     * 00085002
*    CONTROL-BLOCKS = DCB COPY, DEB AND CVT                           * 00086002
*                                                                     * 00087002
* TABLES = DEVICE TABLE, AND BUFFER CONTROL TABLE                     * 00088002
*                                                                     * 00089002
* MACROS = MODESET, GETMAIN, ABEND AND XCTL.                          * 00090002
*                                                                     * 00091002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00092002
*                                                                     * 00093002
*                                                                     * 00621002
*********************************************************************** 00622002
         EJECT                                                          00623002
FORCORE  DSECT                                                          00624002
         IECDSECT                                                       00640000
         EJECT                                                          00840020
ISLCOMON IGGLOAD                                                        01040020
         EJECT                                                          01240020
IHADEB   IGGDEBD                                                        01440020
         DCBD  DSORG=(IS)                                               03020000
IGG01921 CSECT                                                     DM0E 03040000
R0       EQU   0                        WORK REGISTER                   03060000
R1       EQU   1                        WORK REGISTER                   03080000
R4       EQU   4                        WORK REGISTER            O19113 03124019
R5       EQU   5                        WORK REGISTER            O19113 03126019
R6       EQU   6                        WORK REGISTER            O19113 03128019
R7       EQU   7                        WORK REGISTER            O19113 03130019
R8       EQU   8                        WORK REGISTER            O19113 03132019
R9       EQU   9                        WORK REGISTER            S20201 03136020
R10      EQU   10                       WORK REGISTER                   03140000
RDEB     EQU   12                       BASE REG FOR USERS DEB   O19113 03160019
RE       EQU   0                        WORK REGISTER                   03180000
RF       EQU   1                        WORK REGISTER                   03200000
RDCB     EQU   2                        BASE REG FOR DCB                03220000
RBASE    EQU   3                        BASE REGISTER FOR THIS MODULE   03240000
RCORE    EQU   4                        BASE REG FOR OPEN WORK AREALE   03260000
RPAR     EQU   5    *                   ADDRESS OF PARAMETER TABLE      03280000
RWTG     EQU   6    *                   ADDRESS OF WHERE-TO-GO TABLE    03300000
RPARC    EQU   7    *                   CURRENT PARAMETER ENTRY         03320000
RWTGC    EQU   8    *                   CURRENT WHERE-TO-GO ENTRY       03340000
RTIOT    EQU   9                        ADDRESS OF TIOT                 03360000
R11      EQU   11                       WORK REGISTER                   03400000
RC       EQU   13                       WORK REGISTER                   03460000
RD       EQU   14                       WORK REGISTER                   03480000
RJ       EQU   15                       WORK REGISTER                   03520000
CVTPTR   EQU   16                                                O19113 03525019
CVTZDTAB EQU   64                       OFFSET TO DEV CHAR TABLE S20201 03527020
UCBTYPE  EQU   19                       OFFSET FOR TYPE OF       O19113 03530019
*                                       DEVICE                   O19113 03530720
YLEN     EQU   72                       BASIC LENGTH AREA Y      S20201 03531420
K8       EQU   8                        CONSTANT                 S20201 03532120
K10      EQU   10                       CONSTANT                 S20201 03532820
TRKL     EQU   4                        TRACK LENGTH DEV TBLE    S20201 03533520
K0       EQU   0                        CONSTANT                 S20201 03534220
L5       EQU   5                        LENGTH                   S20201 03535120
ZEUSSW   EQU   9                        DEV TBLE ZEUS SW         S20201 03536020
ZEUS     EQU   X'08'                    ZEUS INDICATOR           S20201 03536920
LIDO     EQU   7                        LAST RECORD OVERHEAD     S20201 03537820
NIDO     EQU   6                        NORMAL RECORD OVERHEAD   S20201 03538720
DEVT     EQU   ISLAREAZ+86              INDEX DEVICE TYPE SA     S20201 03543720
COMPLETE EQU   X'40'                    IOB COMPLET SW           A42181 03546721
RC2C     EQU   X'2C'                    ISAM 002 ABEND RET CODE  Y02072 03547702
FIXED    EQU   X'80'                                             A34959 03550020
VIRTUAL  EQU   X'80'                    VIRTUAL INDICATOR               03554001
K1       EQU   1                        CONSTANT                        03558001
*  COMMON WORK AREA EXCLUDING VARIABLE POINTERS AND  VARIABLE AREAS     03560000
         BALR  RBASE,0                  ESTABLISH ADDRESSABILITY        03580000
         USING *,RBASE                                                  03600000
         USING IHADCB,RDCB                                              03640000
         USING FORCORE,RCORE                                            03660000
         USING IHADEB,RDEB                                       O19113 03670019
         L     RDCB,0(RPARC)            RDCB = ADR OF DCB               03680000
         L     RCORE,4(RWTGC)           RCORE = ADR OF OPEN WK AREA     03700000
         ST    RCORE,DCBRELSE           SAVE OPEN W/A ADDR       Y02072 03750002
*                                                                  DM0E 04700000
* GET CODE FOR LOAD MODE WORK AREA                                 DM0E 05700000
*                                                                  DM0E 06700000
ISL04A5  EQU   *                   GET CORE FOR LOAD MODE WORK AREA     08400000
         L     RDEB,DCBDEBAD            SET UP BASE FOR DEB       17321 08405000
         MVC   DCBWKPT2(3),ISLRETRY     RETRY COUNT FOR 3 IOBS   A42170 08407021
         TM    DEBOPATB,X'0F'           DCB OPENED FOR OUTPUT    O19113 08410019
         BNO   ABEND                    NO--ABEND                A46632 08410121
         LH    RC,DCBLRECL              GET LRECL VALUE          A46632 08410221
         LTR   RC,RC                    LRECL EQUALS ZERO ?      A46632 08410321
         BZ    ABEND                    YES - ABEND 03B          A46632 08410421
         TM    DCBRECFM,X'10'           TEST FOR BLOCKED RECORDS A38145 08410620
         BZ    BLKOK                    BR IF NOT TO CONTINUE    A38145 08410920
         SR    R10,R10                                           A38145 08411220
         LH    R11,DCBBLKSI             GET BLKSIZE VALUE        A38145 08411520
         CR    R11,RC                   BLKSIZE LT LRECL         A38145 08412120
         BL    TOOLONG                  BR IF LOW TO ABEND       Y02072 08412402
         TM    DCBRECFM,X'80'           TEST FOR FIXED           A38145 08412720
         BZ    BLKOK                    BR IF NOT TO CONTINUE    A38145 08413020
         DR    R10,RC                   TEST FOR MULTIPLE        A38145 08413320
         LTR   R10,R10                  IF REMAINDER, NOT        A38145 08413620
*                                       MULTIPLE                 A38145 08413920
         BNZ   TOOLONG                  WILL ABEND               Y02072 08414202
BLKOK    EQU   *                                                 A38145 08414520
         SR    RE,RE                                             A30791 08415319
         IC    RE,DCBKEYLE              WAS KEYLENGTH SPECIFIED  A30791 08415619
         LTR   RE,RE                                             A30791 08415919
         BZ    ABEND                    NO, ABEND                A30791 08416219
         CLC   DCBRKP,ZERO              IS RKP = 0               A34920 08416320
         BNE   TESTRKP                  NO, GO TEST IT           A34920 08416420
         TM    DCBRECFM,X'50'           NEITHER VAR NOR BLOCKED  A34920 08416520
         BZ    RKPOK                    RECFM=F,RKP=0--NO TEST   A34920 08416620
TESTRKP  AH    RE,DCBRKP                ADD RKP TO THE KEYLENGTH A34920 08416720
         CH    RE,DCBLRECL              COMPARE RKP+KEYLE TO     A30791 08416819
         BH    ABEND                    DCBLRECL AND ABEND IF HI A30791 08417119
         TM    DCBRECFM,X'80'           IS IT VLR                A30791 08417419
         BO    RKPOK                    NO, BRANCH               A30791 08417719
         NI    DCBOPTCD,X'FF'-FTIW      FTIW ILLEGAL VLR         S20201 08417820
FTIW     EQU   X'40'                    FTIW INDICATOR           S20201 08417920
         CLC   DCBRKP,FOUR              FOR VLR, RKP CAN'T BE    A30791 08418019
         BL    ABEND                    LESS THAN FOUR           A30791 08418319
RKPOK    EQU   *                                                 A30791 08418619
         LA    RE,250                   FROM SUBPOOL 250                08420000
         SLL   RE,24                                                    08440000
         SR    R11,R11                                           S20201 08460020
         SR    R10,R10                  CLEAR REGISTER                  08480000
         IC    R11,DCBKEYLE             R11 = KEYSAVE AREA       S20201 08500020
         LA    RC,YLEN(R0,R11)          RC = CORE FOR AREA Y     S20201 08520020
         IC    R10,DCBBUFNO                                             08540000
         SLL   R10,2                   R10=BUF CTRL TBL =8 + 4(BUFNO)   08560000
         LA    R10,K8(R0,R10)           CORE REQ'D IS WKAREA +   S20201 08580020
         LA    R9,ISLCSIZE(R0,R11)      KEYLE + AREA Y + BUFFER  S20201 08600020
         AR    R9,R10                   CONTROL TABLE                   08620000
         AR    R9,RC                                                    08640000
         OR    RE,R9                    R9 = TOTAL BYTES OBTAINED       08660000
*                                                                       08680000
         GETMAIN R,LV=(0)                                               08700000
*                                                                       08720000
         ST    RF,DCBWKPT1              DCBWKPT1=ADDR. OF COMON WRKAREA 08740000
         LR    RE,R9                    SAVE SIZE OF ISLCOMON           08760000
         STM   RCORE,R9,DXCCW1          SAVE REGS 4 THRU 9       Y02072 08770002
*                                                                       08780000
* CLEAR ISLCOMON WORK AREA                                              08800000
*  RF = ADDRESS OF AREA,  R9 = SIZE OF AREA                             08820000
         SPACE 1                                                        08822002
         MODESET  KEYADDR=DXUKEY,WORKREG=14  SET USERS KEY       Y02072 08830002
         SPACE 1                                                        08832002
         LA    RD,255                   CLEAR 256 BYTES AT A TIME       08840000
COMPARE  BCTR  R9,0                     COUNT FOR EX MOVE               08860000
         CR    R9,RD                    TEST IF LESS THAN 256 REMAIN    08880000
         BNH   LASTIME                  BRANCH = YES, LESS THAN 256     08900002
         EX    RD,CLEER                 CLEAR 256 BYTES                 08920000
         SR    R9,RD                    DECREMENT COUNTER BY 255        08940000
         LA    RF,256(RF)               ADVANCE 256 BYTES IN WK AREA    08960000
         B     COMPARE                  LOOP TO CLEAR MORE              08980000
         SPACE 2                                                        08980402
*                                                                       08980620
*   ROUTINE TO FIND DEVICE TABLE ENTRY                                  08981220
*        INPUT - RC - LOW ORDER BYTE DEVICE TYPE                        08981820
*        OUTPUT - R6 - ADDRESS OF ENTRY                                 08982420
DEVRTN   SR    R6,R6                    CLEAR WORK REGISTER      S20201 08983020
         L     R5,CVTPTR                R5= A(COMM VECTOR TABLE) S20201 08983620
         L     R5,CVTZDTAB(R0,R5)       R5= A(I/O DEVICE TABLE)  S20201 08984220
         IC    R6,0(RC,R5)              R6= OFFSET IN DEVICE     S20201 08984820
*                                       TABLE                    S20201 08985420
         LA    RC,0(R5,R6)              DEV TABLE POINTER        S20201 08986020
         BR    R9                       RETURN                   S20201 08986620
*                                                                       08987220
*   ROUTINE TO GET RECORD GAPS                                          08987820
*        INPUT - R6 - ADDRESS OF DEVICE TABLE ENTRY                     08988420
*        OUTPUT - R8 - NIDO                                             08989020
*               - R7 - LIDO                                             08989620
*                                                                       08990220
*   CHECK FOR ZEUS DEVICE                                               08990820
GETGAPS  TM    ZEUSSW(RC),ZEUS          ON A ZEUS DEVICE         S20201 08991420
         BO    ZEUSDEV                  BR - IS ZEUS DEVICE      S20201 08992020
         SR    R7,R7                    CLEAR WORK REGISTER      S20201 08992620
         SR    R8,R8                    CLEAR WORK REGISTER      S20201 08993220
         IC    R7,LIDO(RC)              LIDO                     S20201 08993820
         IC    R8,NIDO(RC)              NIDO                     S20201 08994420
         BR    R9                       RETURN                   S20201 08995020
ZEUSDEV  LH    R7,NIDO(RC)              LIDO ALSO NIDO           S20201 08995620
         LR    R8,R7                    NIDO                     S20201 08996220
         BR    R9                       RETURN                   S20201 08996820
*                                                                       09000000
CLEER    XC    0(1,RF),0(RF)            CLEAR AMT IN EXECUTE REGISTER   09020000
         SPACE 2                                                        09030002
*                                                                       09040000
LASTIME  EX    R9,CLEER                 R9 IS LESS THAN 256             09060000
*                                                                       09080000
         L     RF,DCBWKPT1              SET RF = ADR OF WORK AREA       09100000
         USING ISLCOMON,RF                                              09120000
         ST    RE,ISLVPTR8              SET PTR8 = SIZE OF WORK AREA    09140000
         LA    RD,ISLCSIZE(R0,RF)                                S20201 09160020
         SPACE 2                                                        09172002
*  ISLVPTR3  =  ADR. OF BUFFER CONTROL TABLE                            09180000
         ST    RD,ISLVPTR3                                              09200000
         AR    RD,R10                                                   09220000
*  ISLVPTR1  =  ADR. OF AREA Y                                          09240000
         ST    RD,ISLVPTR1                                              09260000
         AR    RD,RC                                                    09280000
*  ISLVPTR2  =  ADR. OF KEYSAVE AREA                                    09300000
         ST    RD,ISLVPTR2                                              09320000
*                                                                       09361020
*   FIND PRIME DEVICE TYPE ENTRY AND SAVE RECORD OVERHEADS IN THE       09362020
*   WORK AREA.                                                          09363020
*                                                                       09364020
         SR    RC,RC                    CLEAR WORK REGISTER      S20201 09365020
         IC    RC,DCBDEVT               DEVICE TYPE OF PROPER    S20201 09366020
*                                       ENTRY                    S20201 09367020
         STC   RC,DEVT                  SAVE DEVICE TYPE         S20201 09368020
         BAL   R9,DEVRTN                GET ENTRY ADDRESS        S20201 09369020
         ST    RC,ISLOCNT               SAVE DEV TBL PTR         S20201 09371020
         SPACE 1                                                        09371102
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 09371702
         SPACE 1                                                        09371902
         ST    RC,DCBLRAN               SAVE DEV TBL PTR         Y02072 09372602
         LA    R9,ISLVPTR1              ADDR OF VARIABLE PTRS    Y02072 09372802
         ST    R9,DCBWKPT6              STORE VAR PTRS ADDR      Y02072 09373002
         SPACE 1                                                        09375002
         MODESET KEYADDR=DXUKEY,WORKREG=9  CHANGE TO USER KEY    Y02072 09375402
         SPACE 1                                                        09377402
         BAL   R9,GETGAPS               GET RECORD OVERHEADS     S20201 09382502
         STH   R7,ISLLGAP               SAVE LAST PRIME OVERHEAD S20201 09386002
         STH   R8,ISLIGAP               SAVE NORMAL PRIME        S20201 09389502
*                                       OVERHEAD                 S20201 09393002
         LA    R10,3                    SET UP CTR FOR 3 ECBS AND IOBS  09396502
         L     R9,DXUDCBAD              GET USERS DCB ADDRESS    Y02072 09398902
         DROP  RCORE                                                    09399302
ISL02G21 ST    RF,8(RF)                 COMPLETE ECB POINTER            09400000
         MVI   4(RF),X'C2'                                              09420000
*  SET FLAGS 1 IN IOB TO DATA AND COMMAND CHAINING                      09440000
         USING DXECB,RF                 ECB/IOB ADDRESSABILITY   Y02072 09460002
         ST    R9,IOBWGHT               STORE DCB ADDRESS        Y02072 09470002
         DROP  RF                       END ECB/IOB ADDR         Y02072 09472002
         USING FORCORE,RCORE            ESTABLISH ADDRESSABILITY Y02072 09476002
         LA    RF,44(RF)                SET POINTER TO NEXT ECB         09480000
         BCT   R10,ISL02G21             DECREMENT COUNTER BY 1          09500000
         L     RF,DCBWKPT1              RESTORE WA PTR           S20201 09510020
         USING ISLCOMON,RF              ESTABLISH ADDR           Y02072 09512002
         MVI   ISLECBA,COMPLETE         MARK IT COMPLETE         A42181 09515021
ISL03K1  EQU   *                                                        09520000
*        IF DISP=OLD AND DATA SET OPENED FOR LOAD THEN USER             09522019
*        INTENDS TO REUSE PRE-ALLOCATED SPACE.                          09523019
*                                                                       09524019
         MODESET EXTKEY=DATAMGT         SET DATA MGT KEY         Y02072 09526002
         SPACE 1                                                        09528002
         TM    JFCBIND2,X'40'           TEST IF DISP=NEW/OLD     A40531 09529021
         BO    ISL0500                  B IF NOT MOD             A40531 09534021
*                                                                       09540000
*********************************************************************** 09560000
         TM    DCBST,X'20'              RESUME LOAD               P4701 09566000
         BZ    ISL0500                  BR-INITIAL LOAD (2D)      P4701 09572000
         L     R9,DSCCORE               FORMAT 2 ADDRESSABILITY  A31998 09572520
         NC    X'43'(4,R9),X'43'(R9)    WERE ANY RECORDS LOADED  A31998 09573020
         BZ    ISL0500                  NO - JUST RELOAD         A31998 09573520
         LM    RCORE,R9,DXCCW1          RESTORE REGISTERS        Y02072 09574502
         MVC   0(L'LOAD20,RWTGC),LOAD20 INITIALIZE WHERE-TO-GO   Y02072 09575502
         TM    DCBRECFM,FIXED           ARE RECS FIXED LENGTH    A34959 09576520
         BO    RELOOP                   YES, BR TO LOAD 1920     A34959 09577520
         MVC   0(L'LOAD50,RWTGC),LOAD50 INITIALIZE WHERE-TO-GO   Y02072 09578102
*                                       A3495                    A40531 09578721
         B     RELOOP                                            A40531 09579321
*                                       P4701                    A40531 09579921
*                                                                       09580521
*       THIS SECTION WILL INITIALIZE HIRPD,HIROV,HIIOV                  09581121
*       BEFORE GOING TO IGG0192D                                        09581721
*                                                                       09582321
ISL0500  EQU   *                                                 Y02072 09582702
         XC    DCBNREC(L'DCBNREC+L'DCBST),DCBNREC  CLEAR DCB    SA54486 09582902
*                                       NREC AND STATUS FIELDS  SA54486 09583302
         XC    DCBHIIOV(1),DCBHIIOV                              A40531 09583521
         L     RC,DCBLRAN               PTR TO DEV TBL ENTRY     S20201 09584620
         MODESET  KEYADDR=DXUKEY,WORKREG=6   SET USERS KEY       Y02072 09585202
*                                                                       09587202
         DROP  RCORE                    END ADDRESSABILITY       Y02072 09589202
         LH    R6,ISLIGAP               NIDO                     S20201 09592002
         LH    R7,ISLLGAP               LIDO                     S20201 09592602
ISLFC011 EQU   *                                                 A32559 09593202
         SR    R9,R9                    CLEAR WORK REGISTER      S20201 09593802
         IC    R9,DCBKEYLE              R9=KEYLENGTH             S20201 09594402
         LA    R8,K10(R9)               R8=KEYLENGTH+10          S20201 09595002
         LH    R4,TRKL(RC)              R4=TRACKLENGTH           S20201 09595602
         SR    R4,R7                    R4=TRACKLENGTH-LIDO      S20201 09596202
         AH    R9,DCBBLKSI              R9=KEYLENGTH+BLKSIZE     S20201 09596802
         LR    R5,R6                    R5=NIDO                  S20201 09597402
*                                                                       09597802
*        DCBHIIOV USED AS A SWITCH TO DETERMINE WHICH PASS THROUGH      09598002
*        ROUTINE.  WILL BE SET TO X'01' WHEN OVERFLOW CALCULATIONS      09598602
*        TO BE MADE.                                                    09599202
*                                                                       09599602
         TM    DCBHIIOV,X'01'           HAS HIRPD PREV BEEN CALC O19113 09599802
         BO    ISLFC013                 YES, CALC HI R FOR OFLOW O19113 09600402
         LR    R7,R4                    CALC HIRPD- HI R FOR     O19113 09601002
*                                       PRIME DATA                      09601602
         SR    R7,R9                    R7=TRKLNG-LIDO-KEYLENGTH O19113 09602202
*                                         -BLKSIZE                      09602802
         BM    TOOLONG                  ABEND IF BLKSI TOO BIG   O19113 09603402
         CH    R7,ISLC110               WILL OFLOW LINK FIT IF   O19113 09604002
*                                       RECFM IS UNBLOCKED              09604602
         BNL   ISLFC012                 YES, CONTINUE PROCESSING O19113 09605202
         TM    DCBRECFM,X'10'           ARE RECORDS UNBLOCKED    O19113 09605802
         BZ    TOOLONG                  YES, OFLOW WON'T FIT     O19113 09606402
ISLFC012 EQU   *                                                 O19113 09607002
         TM    DCBRECFM,X'80'           IS IT VLR                M4502  09607602
         BZ    ISLF01B                  YES, BYPASS PDT LAYOUT   M4502  09608202
         SR    R6,R6                                             O19113 09608802
         MH    R9,10(RC)                R9=TOL(KEYLEN+BLKSIZE)   O19113 09609402
         SRA   R9,9                     R9=TOL(KEYLE+BLKSI)/512  O19113 09610002
         AR    R9,R5                    R9=R9+NIDO               O19113 09610602
         DR    R6,R9                    DIVIDE R7 BY R9          O19113 09611202
         LA    R7,1(R7)                 R7=HI R PRIME DATA TRK   O19113 09611802
         SPACE 1                                                        09611902
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 09612202
         SPACE 1                                                        09612302
         L     R6,DCBRELSE              RESTORE O/C/E WA ADDR    Y02072 09613302
         USING FORCORE,R6               ESTABLISH ADDRESSABILITY Y02072 09613402
         STC   R7,DCBHIRPD              STORE IN HIRPD           O19113 09613502
*                                                                       09613602
         MODESET  KEYADDR=DXUKEY,WORKREG=7   SET USERS KEY       Y02072 09613702
*                                                                       09613802
         DROP  R6                       END ADDRESSABILITY       Y02072 09613902
*                                                                       09615602
*        NOW CALCULATE HIROV                                            09616002
*                                                                       09616402
ISLFC013 LR    R7,R4                    RESET R7 TO TRKLG-LIDO   O19113 09616802
         AH    R8,DCBLRECL              R8=KEYLEN+10+LRECL       O19113 09617202
         SR    R7,R8                    R7=TRKLNG-LIDO-(KEYLE+   O19113 09617602
*                                          10+LRECL)                    09618002
         SR    R6,R6                                             O19113 09618402
         LH    R11,10(RC)               R11=TOL                  O19113 09618802
         MR    R10,R8                   R11=TOL(KEYLE+10+LRECL)  O19113 09619202
         SRA   R11,9                    DIVIDE BY 512 FOR TOL    O19113 09619602
         AR    R11,R5                   R11=TOL(KEYLE+10+LRECL)  O19113 09620002
*                                          +NIDO                        09620202
         DR    R6,R11                   DIVIDE R7 BY R11         O19113 09620802
         LA    R7,1(R7)                 ADD1                     O19113 09621402
         SPACE 1                                                        09621502
         MODESET  EXTKEY=DATAMGT        SET DATA MGT KEY         Y02072 09621802
         SPACE 1                                                        09621902
         TM    DCBHIIOV,X'01'           INDEPENDENT OVERFLOW     O19113 09622002
*                                       PASS                     O19113 09622602
         BZ    ISLFC0A                                           O19113 09623202
         STC   R7,DCBHIIOV              HI R FOR IND OVFLOW      O19113 09623802
         B     ISLF01B                                           O19113 09624402
ISLFC0A  EQU   *                                                 Y02072 09624802
         STC   R7,DCBHIROV              HIROV=HI R FOR CYL OFLW  Y02072 09625002
ISLFC014 TM    DCBOPTCD,X'10'           INDENDENT OVERFLOW REQ   O19113 09625602
         BZ    ISLF01B                  NO                       O19113 09626202
*                                                                       09626802
*        MUST NOW DETERMINE IF INDEPENDENT OVERFLOW ON A                09627402
*        DIFFERENT DEVICE TYPE                                          09628002
*                                                                       09628602
         SR    RC,RC                                             O19113 09629202
         IC    RC,DCBOVDEV              RC= IND OFLOW DEV TYPE   O19113 09629802
         LTR   RC,RC                    OVERFLOW ON SAME DEVICE  O19113 09630402
         BNE   ISLFC015                 YES = BRANCH             O19113 09631002
         IC    RC,DCBDEVT               NO, OVFLOW DEV SAME      O19113 09631602
         STC   RC,DCBOVDEV              SAVE                     O19113 09632202
ISLFC015 OI    DCBHIIOV,X'01'           SET OFLOW PASS BIT       O19113 09632802
         CLC   DCBOVDEV,DCBDEVT         IS OFLOW ON SAME DEV     O19113 09633402
*                                       TYPE                     O19113 09634002
         BE    ISLF01A                  BR - NOT DIFFERENT       S20201 09634602
*                                                                       09634702
         L     R6,DCBRELSE              RESTORE O/C/E WA ADDR    Y02072 09634802
         USING FORCORE,R6               ESTABLISH ADDR           Y02072 09634902
*                                                                       09635402
         MODESET  KEYADDR=DXUKEY,WORKREG=9   SET USERS KEY       Y02072 09637002
*                                                                       09637402
         DROP  R6                       END ADDR                 Y02072 09639902
         BAL   R9,DEVRTN                PT TO DEVICE TABLE       S20201 09642502
         BAL   R9,GETGAPS               OVERFLOW OVERHEADS       S20201 09645002
         LR    R6,R8                    NIDO                     S20201 09647502
         B     ISLFC011                 NO, CALC HI OVFL         S20201 09650002
ISLF01A  STC   R7,DCBHIIOV              HI R ALREADY CALC        S20201 09652502
ISLF01B  EQU   *                                                 Y02072 09655002
         SPACE 1                                                        09657002
         MODESET  EXTKEY=DATAMGT        SET DATA MGT KEY         Y02072 09657502
         SPACE 1                                                        09659502
         L     RCORE,DCBRELSE           RESTORE OPEN W/A ADDR    Y02072 09660002
         USING FORCORE,RCORE            ESTABLISH ADDR           Y02072 09662502
         XC    DCBRELSE,DCBRELSE        CLEAR DCB FIELD          Y02072 09665002
         LM    R4,R9,DXCCW1             RESTORE REGS             Y02072 09667502
         MVC   0(L'LOAD2D,RWTGC),LOAD2D INITIALIZE WTG           Y02072 09670002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       09672502
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       09675002
         CLC   0(2,RWTGC),THISLOAD                                      09677502
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 09680000
         CLC   0(2,RWTGC),OPNLOD7       TEST FOR END OF WTG TABLE       09700000
         BNE   RELOOP                   BR = NOT AT END          A34959 09720020
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                09740000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                09760000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              09780000
         BNE   TCTLRTN                  BR IF NOT ZERO           A34959 09800020
ITSZERO  LA    RWTGC,8(RWTGC)                                           09820000
         LA    RPARC,4(RPARC)                                           09840000
         B     ZCHECK                                                   09860000
TCTLRTN  EQU   *                                                        09880000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         09900000
         LA    RJ,DXCCW12                                               09940000
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 09960002
TOOLONG  EQU   *                                                 O19113 09960519
         LA    RJ,RC2C                  ISAM RETURN CODE         Y02072 09960702
         ABEND X'002',DUMP,,SYSTEM      SYSTEM 002 ABEND         Y02072 09961502
*                                                                       09962002
ABEND    EQU   *                                                        09966002
         ABEND X'03B',DUMP,,SYSTEM      SYSTEM 03B ABEND         Y02072 09972002
* CONSTANTS                                                             09980000
ZERO     DC    H'0'                                              A34920 09985020
FOUR     DC    H'4'                     MINIMUM RKP FOR VLR      A30791 09990019
         DS    0F                                                       10000000
THISLOAD DC    C'21'                                               DM0E 10050000
OPNLOD7  DC    C'0S'                                                    10100000
ISLC110  DC    H'10'                                             O19113 10110019
         ORG   *-1                      USE LOW ORDER BYTE OF DC A42170 10113021
ISLRETRY DC    3X'0A'                   TEN RETRIES FOR EACH IOB A42170 10116021
*                                                                       10120000
LOAD2D   DC    C'2D'                    ID OF MODULE IGG0192D    Y02072 10170002
LOAD20   DC    C'20'                    ID OF MODULE IGG01920    Y02072 10180002
LOAD50   DC    C'50'                    ID OF MODULE IGG01950    Y02072 10190002
*                                                                       10220002
PATCH    DC    XL50'00'                 ZEROED PATCH AREA        Y02072 10270002
         END                                                            10360000
