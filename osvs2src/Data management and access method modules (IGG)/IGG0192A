          TITLE 'IGG0192A - ISAM OPEN, BUILD DEB'                       00020002
IGG0192A CSECT                                                          00022002
*                                                                       00023002
*********************************************************************** 00024002
*                                                                     * 00025002
* MODULE-NAME = IGG0192A                                              * 00026002
*                                                                     * 00027002
* DESCRIPTIVE-NAME = ISAM OPEN, BUILD DEB                             * 00028002
*                                                                     * 00029002
* COPYRIGHT = NONE                                                    * 00030002
*                                                                     * 00030102
*     VS2 RELEASE 3 DELETIONS/CHANGES                                   00036637
* D048900-048960,A049080-049266                                 ZA00123 00037637
* A050300                                                      @ZA10784 00038637
*                                                                       00040602
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00046502
*                                                                     * 00053002
* FUNCTION = DETERMINE THE SIZE OF THE ISAM DEB.  SCAN THE DSCB'S     * 00059502
*            COUNTING SEPARATELY THE NUMBER OF PRIME, INDEX, AND      * 00066002
*            OVERFLOW EXTENTS, AND DETERMINE THE NUMBER OF MODULES TO * 00072502
*            BE LOADED BASED UPON MODE AND DESIRED FUNCTION.  OBTAIN  * 00079002
*            CORE FOR THE DEB FROM SUBPOOL 230, STORAGE PROTECT KEY 5.* 00085502
*            INITIALIZE THE DEB PREFIX, BASIC SECTIONS AND THE M=0    * 00092002
*            EXTENT.  ISSUE DEBCHK TO PLACE THE DEB ADDRESS IN THE    * 00098502
*            DEB TABLE.                                               * 00105002
*                                                                     * 00111502
* NOTES = SEE BELOW                                                   * 00118002
*                                                                     * 00124502
*    DEPENDENCIES = NONE                                              * 00131002
*                                                                     * 00137502
*    RESTRICTIONS = NONE                                              * 00144002
*                                                                     * 00150502
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00157002
*                                                                     * 00163502
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00170002
*                                                                     * 00176502
* MODULE-TYPE = OPEN EXECUTOR                                         * 00183002
*                                                                     * 00189502
*    PROCESSOR = ASSEMXF-370R                                         * 00196002
*                                                                     * 00202502
*    MODULE-SIZE = 1109 DECIMAL BYTES                                 * 00209002
*                                                                     * 00215502
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00222002
*                                                                     * 00228502
* ENTRY-POINT = IGG0192A                                              * 00235002
*                                                                     * 00241502
*    PURPOSE = SEE FUNCTION                                           * 00248002
*                                                                     * 00254502
*    LINKAGE = CALLED BY COMMON OPEN FOR ISAM DATA SET VIA XCTL.      * 00261002
*              RECEIVES CONTROL IN STORAGE PROTECT 5 AND PRIVILEGED   * 00267502
*              STATE.                                                 * 00274002
*                                                                     * 00280502
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00287002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00293502
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00300002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00306502
*               PARAMETER LIST                                        * 00313002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00319502
*                                                                     * 00326002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00332502
*          UPON ENTRY TO THIS MODULE                                  * 00339002
*                                                                     * 00345502
* EXIT-NORMAL = TRANSFERS CONTROL TO ISAM OPEN EXECUTOR IGG0192B IN   * 00352002
*               STORAGE PROTECT KEY 5.                                * 00358502
*                                                                     * 00365002
* EXIT-ERROR = ABEND CODES:                                           * 00371502
*              030 - DCBMACRF INCORRECTLY SPECIFIED                   * 00378002
*              036 - NO PRIME EXTENTS ALLOCATED                       * 00384502
*              03B - DATA SET NOT SUCCESSFULLY CREATED OR LOAD MODE   * 00391002
*                    WITH DISP = SHR SPECIFIED                        * 00397502
*                                                                     * 00404002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00410502
*                                                                     * 00417002
*    ROUTINES = DEBCHK TO PLACE DEB ADDRESS IN DEB TABLE              * 00423502
*                                                                     * 00430002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00436502
*                 FORCORE - OPEN WORK AREA                            * 00443002
*                                                                     * 00449502
*    CONTROL-BLOCKS = DCB COPY, DEB, TCB, AND UCB.                    * 00456002
*                                                                     * 00462502
* TABLES = NONE                                                       * 00469002
*                                                                     * 00475502
* MACROS = ABEND, DEBCHK, GETMAIN, MODESET, AND XCTL                  * 00482002
*                                                                     * 00488502
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00495002
*                                                                     * 00501502
*                                                               YM08221 00508002
*                                                                     * 00514502
*********************************************************************** 00521002
         EJECT                                                          00522002
FORCORE  DSECT                                                          00523002
         IECDSECT                                                       00540000
TCB      IKJTCB                                                         00560001
IHADEB   IGGDEBD                                                        01080020
IHAUCB   DSECT                                                          01160020
         ORG   IHAUCB+16                PARTIAL UCB DEFINITION   S20201 01240020
UCBTYPA  DS    C                        TYPE FIELD               S20201 01320020
UCBTYPB  DS    C                        TYPE FIELD               S20201 01400020
UCBTYPC  DS    C                        TYPE FIELD               S20201 01480020
UCBTYPD  DS    C                        TYPE FIELD               S20201 01560020
RPSFEAT  EQU   X'10'                    USED TO TEST UCBTYP+1    S20201 01640020
         DCBD  DSORG=(IS)                                               01760000
         EJECT                                                          01770002
IGG0192A CSECT                                                          01780000
DCBMOD   EQU   X'80'                                             S20201 01781020
SUBPOOL  EQU   230                      SUBPOOL ID FOR DEB       Y02072 01782002
LASTHALF EQU   4                                                 S20201 01783020
FULLWORD EQU   4                                                 S20201 01784020
WRTCHK   EQU   X'80'                                             S20201 01785020
TWO      EQU   2                                                 S20201 01787020
RPSPRIME EQU   X'80'                                             S20201 01788020
RPSINDEX EQU   X'40'                                             S20201 01789020
RPSOVFLO EQU   X'20'                                             S20201 01790020
* BITS IN DXCCW1+4 ARE                  B0= PRIME ON RPS                01791020
*                                       B1= INDEX ON RPS                01792020
*                                       B2= OVFLO ON RPS                01793020
R0       EQU   0                        WORK REGISTER                   01800000
RE       EQU   0                        WORK REGISTER                   01920000
RF       EQU   1                        WORK REGISTER                   01940000
RDEB     EQU   1                        BASE REG FOR USERS DEB   S20201 01950020
RDCB     EQU   2                        BASE REG FOR DCB                01960000
RBASE    EQU   3                        BASE REG FOR THIS MODULE        01980000
RDSCB    EQU   4                        ADDRESS OF DSCB                 02000000
RPAR     EQU   5    *                   ADDRESS OF PARAMETER TABLE      02040000
RWTG     EQU   6    *                   ADDRESS OF WHERE-TO-GO TABLE    02060000
RPARC    EQU   7    *                   ADDRESS OF CURRENT PARM ENTRY   02080000
RWTGC    EQU   8    *                   ADDRESS OF CURRENT WTG ENTRY    02100000
R9       EQU   9                        WORK REGISTER            S20201 02110020
R10      EQU   10                       WORK REGISTER            S20201 02120020
RUCB     EQU   10                       ADDRESS OF UCB                  02140000
RA       EQU   11                       WORK REGISTER                   02160000
RB       EQU   12                       WORK REGISTER                   02180000
RC       EQU   13                       WORK REGISTER                   02200000
RD       EQU   14                       WORK REGISTER                   02240000
RCORE    EQU   14                       BASE FOR OPEN WORK AREA  S20201 02250020
R15      EQU   15                       WORK REGISTER                   02280000
CVTPTR   EQU   16                       OFFSET FOR COMMUN VECTOR TABLE  02320000
DSCB2ST  EQU   71                       DSCB STATUS BYTE         A27355 02340019
EXTLEN   EQU   16                      LENGTH OF A DA EXTENT     S20201 02341020
ZERO     EQU   X'00'                    TEST HIRPD FOR 0         A34976 02343020
SCAN     EQU   X'40'                    TEST SCAN                A34976 02346020
ONE      EQU   X'01'                    OFFSET OF 1              A34976 02349020
DSCBD8   EQU   54                       DSCB HIRPD               A34976 02352020
SETL     EQU   X'03'                    TEST FOR SETL K/I        Y02072 02355002
JFCBSHR  EQU   X'08'                    JFCB CODE FOR DISP=SHR  OY00679 02355402
READ     EQU   X'20'                    TEST MACRF, BISAM READ   Y02072 02357002
WRITE    EQU   X'20'                    TEST MACRF, BISAM WRITE  Y02072 02359002
         EJECT                                                          02359402
         BALR  RBASE,0                  ESTABLISH ADDRESSABILITY        02360000
         USING *,RBASE                                                  02380000
         USING IHADCB,RDCB              RDCB USED AS BASE OF DCB        02400000
         USING FORCORE,RCORE            RCORE USED AS BASE OF WORK AREA 02440000
CVTTCB   EQU   0                        CVT PTR TO TCB PTRS             02460001
TCBPTR   EQU   4                        PTR TO TCB                      02470001
*********************************************************************** 02500000
*                                                                     * 02520000
* DETERMINE SIZE OF DEB                                               * 02540000
*                                                                     * 02560000
*********************************************************************** 02580000
         L     RDCB,0(RPARC)            RDCB = ADDRESS OF DCB           02600000
         SR    RA,RA                    CLEAR RA = PRIME CTR            02620000
         SR    RB,RB                          RB = INDEX CTR            02640000
         SR    RC,RC                          RC = OVFLO CTR            02660000
         L     RDSCB,4(RWTGC)           RDSCB = ADDRESS OF 1ST DSCB     02680000
         LR    RCORE,RDSCB              WORK AREA ADDRESS        S20201 02681020
*                                                                 13270 02682015
         STH   RC,DCBNBOV               CLEAR NBOV FLD FOR USE IN 13270 02684015
*                                                                 13270 02686015
         XC    DCBWKPT1(8),DCBWKPT1                              A42900 02686621
         XC    DCBWKPT5,DCBWKPT5                                 A42900 02687221
         MVI   DXCCW1+LASTHALF,ZERO     INIT RPS INDICATORS      S20201 02688020
*                                                                     * 02700000
* SCAN DSCB'S, COUNTING SEPARATELY THE NUMBER OF PRIME, INDEX, AND    * 02720000
*  OVERFLOW EXTENT ENTRIES                                            * 02740000
*                                                                     * 02760000
ISL00A3  LA    R0,3                     R0 = COUNT = 3 IF FORMAT 1      02780000
         LA    RF,DSCEXTYP-DXDSCB(RDSCB)    OFFSET FOR F1 DSCB   S20201 02790020
         MVC   DXCCW1(FULLWORD),DSCSCALO-DXDSCB(RDSCB)   PRIME   S20201 02797020
*                                       UCB                      S20201 02804020
*                                       TO DXCCW1                       02812013
         L     RUCB,DXCCW1              GET UCB ADDRESS          S20201 02814020
         USING IHAUCB,RUCB                                       S20201 02816020
*                                                                       02820000
ISL00B2  TM    0(RF),X'01'              TEST IF PRIME                   02840000
         BC    8,ISL00C2                NO                              02860000
         LA    RA,1(RA)                 PRIME + 1                       02880000
         TM    UCBTYPB,RPSFEAT          IS DEV=RPS               S20201 02881020
         BZ    ISL00E3                  BIF NOT RPS              Y02072 02882002
         OI    DXCCW1+LASTHALF,RPSPRIME INDICATE PRIME ON RPS    S20201 02883020
         B     ISL00E3                  BRANCH TO DECREMENT COUNTER     02900000
*                                                                       02910002
ISL00C2  TM    0(RF),X'04'              TEST IF INDEX                   02920000
         BC    8,ISL00D2                NO                              02940000
         LA    RB,1(RB)                 INDEX + 1                       02960000
         TM    UCBTYPB,RPSFEAT          IS DEV=RPS               S20201 02965020
         BZ    ISL00E3                  BIF NOT RPS              S20201 02970020
         OI    DXCCW1+LASTHALF,RPSINDEX INDICATE INDEX ON RPS    S20201 02975020
         B     ISL00E3                  BRANCH TO DECREMENT COUNTER     02980000
ISL00D2  TM    0(RF),X'02'              TEST IF OVFLO                   03000000
         BC    8,ISL00F4                NO                              03020000
         LA    RC,1(RC)                 OVFLO + 1                       03040000
         TM    UCBTYPB,RPSFEAT          IS DEV=RPS               S20201 03044020
         BZ    ISL00E3                  BIF NOT RPS              S20201 03048002
         OI    DXCCW1+LASTHALF,RPSOVFLO INDICATE OVFLO ON RPS    S20201 03052020
ISL00E3  BCT   R0,ISL00F3               DECREMENT COUNT                 03060000
*                                                                       03080000
ISL00F4  CLI   0(RDSCB),X'F1'           TEST IF FORMAT 1                03100000
         BE    ISL00F41                 BRANCH = FORMAT 1               03120000
         LA    RDSCB,44(RDSCB)          EXTRA OFFSET IF NOT FORMAT 1    03140000
ISL00F41 L     RDSCB,96(RDSCB)          RDSCB=POINTER TO NEXT DSCB      03160000
         LTR   RDSCB,RDSCB              TEST IF ADDITIONAL DSCB'S       03180000
         BZ    ISL00E2                  BRANCH = NO                     03200000
         LA    RF,0(RDSCB)              SET RF TO POINT TO NEXT DSCB    03220000
         CLI   0(RDSCB),X'F1'           TEST IF FORMAT 1                03240000
         BE    ISL00A3                  YES                             03260000
         CLI   0(RDSCB),X'03'           TEST IF FORMAT 3 DSCB           03280000
         BNE   ISL00F4                  NO                              03300000
ISL00H5  LA    R0,13                    FORMAT 3 - COUNT = 13           03320000
         LA    RF,4(RF)                            OFFSET = 4           03340000
         B     ISL00B2                                                  03360000
ISL00F3  CH    R0,DECON9                COUNT = 9                       03380000
         BNE   ISL00H3                  NO                              03400000
ISL00J3  LA    RF,1(RF)                 COUNT=9, FORMAT=3               03420000
*                                                                       03440000
ISL00H3  LA    RF,10(RF)                ADVANCE EXTENT POINTER          03460000
         B     ISL00B2                                                  03480000
*                                                                       03520000
*        DETERMINE THE NUMBER OF MODULES TO BE LOADED                   03540000
*        BASED UPON MODE AND DESIRED FUNCTIONS                          03560000
*                                                                       03580000
ISL00E2  EQU   *                                                 S20201 03584020
         LR    RUCB,RCORE               RESET WORKAREA BASE      S20201 03588020
         DROP  RUCB,RCORE                                        S20201 03592020
         USING FORCORE,R10              ESTABLISH NEW BASE       S20201 03596020
         SR    RD,RD                    INITIALIZE RD = MODULE   S20201 03604020
*                                       COUNTER                  S20201 03612020
         TM    DCBMACRF,X'40'           SCAN                     S20201 03622020
         BO    ISL00D11                 YES                             03640000
         TM    DCBMACRF,X'20'           READ                            03660000
         BO    ISL00E2A                 BRANCH YES                      03680000
         TM    DCBMAC,X'04'             WRITE UPDATE                    03700000
         BZ    ISL00E2B                 BRANCH NO                       03720000
ISL00E2A LA    RD,1(RD)                 ADD 1                           03740000
ISL00E2B TM    DCBMAC,X'02'             WRITE ADD                       03760000
         BZ    ISL00E2C                 BRANCH NO                       03780000
         LA    RD,2(0,RD)              ADD 2                            03800000
ISL00E2C LTR   RD,RD                    COUNTER STILL ZERO              03820000
         BZ    ISL00E2D                 BRANCH YES                      03840000
         LA    RDSCB,BISAMEXT           LEN OF BISAM EXTENSION   S21045 03850021
         TM    DCBMACRF,X'04'           DYNAMIC BUFF                    03860000
         BZ    ISL00E2E                                           P4700 03880000
         LA    RD,1(RD)                 ADD 1                           03900000
ISL00E2E TM    DCBMACRF,X'02'           TEST FOR BISAM CHECK      8M800 03908018
         BZ    ISL00D5                  BRANCH   TO ADD 3         23216 03916018
         LA    RD,1(RD)                 ADD 1 FOR CHECK           23216 03924018
         B     ISL00D5                                            23216 03932018
ISL00E2D EQU   *                                                        03940000
         TM    DCBMACRF+1,X'40'         PUT/PUTX                 S20201 03960020
         BO    ISL00D1                  YES                             03980000
ISL00C1  EQU   *                                                        04000000
*  ABEND ERROR CODE OF 30 = MACRF INCORRECTLY SPECIFIED                 04020000
*                                                                       04040002
         ABEND X'030',DUMP,,SYSTEM      SYSTEM 030 ABEND         Y02072 04060002
*                                                                       04070002
ISL00D1  TM    DCBMACRF+1,X'18'         MOVE/LOCATE              S20201 04090020
         BZ    ISL00C1                  NO, ERROR                       04120000
         TM    JFCBIND2,JFCBSHR         LOAD WITH DISP=SHR      OY00679 04130002
         BO    ISL00F21                 YES, GO ABEND           OY00679 04132002
         LA    RD,2(0,RD)               NO, LOAD MODE ADD 2 TO MODULE   04140002
         LA    RDSCB,LOADEXT            LEN OF LOAD EXTENSION    S21045 04150021
         B     ISL00G2                  BR TO PROCESS DEB COUNT   P4701 04160000
* SCAN MODE                                                             04180000
ISL00D11 EQU   *                        *                        A34976 04200020
         LA    RDSCB,SCANEXT            LEN OF SCAN EXTENSION    S21045 04210021
         TM    DCBMACRF+ONE,SETL        TEST FOR SETL - SETL K/I A34976 04220020
         BZ    ISL00D12                 NO                              04260000
         LA    RD,2(RD)                 YES, ADD 2 MODULES              04280000
ISL00D12 TM    DCBMACRF+1,X'44'         PUTX                            04300000
         BZ    ISL00F2                  NO                              04320000
ISL00D5  EQU   *                                                        04340000
         LA    RD,1(RD)                 YES, ADD 1 MODULE               04360000
ISL00F2  LA    RD,2(RD)                 YES, ADD 2 MODULE               04380000
         L     RF,DSCCORE               TEST HIRPD               S20201 04410020
         TM    DSCB2ST(RF),X'20'        WAS LOAD SUCCESSFUL      A27355 04440019
         BZ    ISL00F21                 UNSUCCESSFUL, ISSUE 03B  A34976 04445020
         TM    DCBMACRF,SCAN            SCAN?                    A34976 04450020
         BO    ISL00G2                  YES                      A34976 04455020
         CLI   DSCBD8(RF),ZERO          DSCB HIRPD = 0           A34976 04460020
         BNE   ISL00G2                  NO, LOAD SUCCESSFUL      A34976 04465020
ISL00F21 EQU   *                        *                        A34976 04470020
         ABEND X'03B',DUMP,,SYSTEM      ISSUE ABEND              Y02072 04490002
*                                                                     * 04520000
* CORE REQUIREMENTS FOR DEB = 16(FOR PREFIX) + 32(FOR BASIC SECTION)  * 04540000
*  +2(NO. OF MODS)+16(NO. OF EXTENTS+1)+DEB EXTENSION                   04550021
*    DEB EXTENSION LEN DEPENDS ON LOAD, SCAN, BISAM                     04560021
*                                                                       04580000
ISL00G2  EQU   *                        GET CORE FOR DEB         S20201 04582020
         TM    DXCCW1+LASTHALF,RPSINDEX+RPSPRIME+RPSOVFLO        S20201 04584020
*                                       ARE EITHER INDEX, PRIME OR      04586020
*                                       OVERFLOW ON RPS                 04588020
         BZ    ISL00F5                  BIF NONE ON RPS          S20201 04590020
         LA    RD,ONE(RD)               BUMP MODULE COUNT FOR AN S20201 04592020
*                                       RPS SIO APPENDAGE        S20201 04594002
ISL00F5  EQU   *                                                 S20201 04598020
         LR    RF,R10                   WORK AREA ADDRESSABILITY Y02072 04598402
         DROP  R10                                                      04599601
         USING FORCORE,RF               EST OPEN WA ADDR         Y02072 04600002
         L     R10,CVTPTR                                               04600401
         L     R10,CVTTCB(R10)          *                               04601201
         L     R10,TCBPTR(R10)          TCB ADDRESSABILITY              04602001
         USING TCB,R10                  *                               04602801
         TM    TCBFLGS6,TCBRV           IS IT VIRTUAL                   04603601
         BO    NOTVIRT                  NO - REAL                       04604402
*                                       YES - TEST FOR BISAM     Y02072 04604802
         TM    DCBMACF1,READ            BISAM READ               Y02072 04604902
         BO    INCRID                   YES - BR                 Y02072 04605002
         TM    DCBMACF2,WRITE           BISAM WRITE              Y02072 04605102
         BZ    RPSTEST                  NO - BR                  Y02072 04605502
*                                       YES - IS VIRTUAL AND     Y02072 04605902
INCRID   EQU   *                        BISAM, ALLOW FOR CHANNEL Y02072 04606302
         LA    RD,ONE(RD)               PGM SPLITTING APPENDAGE         04606402
         B     NOTVIRT                  GET CORE FOR DEB         Y02072 04606502
RPSTEST  TM    DXCCW1+LASTHALF,RPSINDEX+RPSPRIME+RPSOVFLO  RPS   Y02072 04606602
         BZ    INCRID                   BR NO TO INCR. NO. RTNS  Y02072 04606702
         DROP  RF                       END OPEN WA ADDR         Y02072 04610002
NOTVIRT  EQU   *                        *                               04613402
         LA    RE,SUBPOOL               DEB FROM SUBPOOL 230     Y02072 04616702
         SLL   RE,24                                                    04620000
         LA    RF,1(RA)                 TOTAL NO. OF EXTENTS            04640000
         AR    RF,RB                    PRIME + INDEX + OVFLO + 1       04660000
         AR    RF,RC                         X 16  + 2(NO.MOD)          04680000
         SLL   RF,3                                                     04700000
         AR    RF,RD                                                    04720000
         SLL   RF,1                                                     04740000
         LA    R9,68(RF,RDSCB)                                   S21045 04750021
*              PREFIX=16,BASIC=32,VECTBL=20,+EXTENSION                  04760021
         OR    RE,R9                                                    04780000
         SLL   RDSCB,16                 PACK EXTENSION LEN AND   S21045 04786021
         OR    RDSCB,RD                 NO. OF SUBS. FOR SAVING  S21045 04792021
*                                                                       04800000
         GETMAIN R,LV=(0)                                               04820000
         USING IHADEB-36,RDEB                                    S21045 04825021
         LR    RD,RDSCB                 RESTORE REG14            S20201 04830020
         SRL   RDSCB,16                 UNPACK DEB EXTENSION LEN S21045 04835021
*                                                                     * 04840000
* CLEAR DEB CORE & COMPLETE PREFIX AND BASIC SECTIONS OF DEB            04860002
*                                                                     * 04880000
*                                                                       04898002
         L     RDSCB,LASTHALF(RWTGC)    RDSCB = ADDR OF WORK    ZA00123 04908002
*                                       AREA                    ZA00123 04918002
         USING FORCORE,RDSCB            SET NEW WKAREA BASE     ZA00123 04918402
         STM   R10,RC,DXCCW5            STORE REGS10-13         ZA00123 04918802
         LR    R10,RF                   C(R10) =DEB AREA PTR    ZA00123 04919202
         LR    RA,R9                    C(R11) = LENGTH OF DEB  ZA00123 04919602
         SR    RB,RB                    CLEAR REG12             ZA00123 04919702
         SR    RC,RC                    CLEAR REG13             ZA00123 04919802
         MVCL  R10,RB                   ZERO COMPLETE DEB       ZA00123 04919902
         LM    R10,RC,DXCCW5            RESTORE REGS10-13       ZA00123 04926602
         LA    RE,7(R9)                 RE=LENGTH OF DEB IN DOUBLE WDS  04933302
         SRL   RE,3                     DIVIDE BY 8                     04940000
         STC   RE,32(RF)                FILL IN DEBLNGTH                04960000
         MVC   23(5,RF),DXCCW7          SAVE   CCHHR OF FORMAT 1 DSCB   05000000
         MVC   22(1,RF),DSCSCALO         MOVE  BB                       05020000
         MVC   28(4,RF),DXDEBXAD        SET UP DEB EXT POINTER @ZA10784 05030037
         ST    RF,64(RF)                SET UP APPAD                    05040000
         LA    RDEB,36(RF)              RDEB POINTS TO BASIC            05060000
         USING IHADEB,RDEB                                       S21045 05070021
         ST    RDEB,DCBDEBAD                                            05080000
         MVI   DEBEXSCL,X'04'           EXTENT LENGTH = 16              05120000
         ST    R10,DEBTCBAD             FILL DEBTCBAD                   05196001
         STC   RD,DEBNMSUB              FILL DEBNMSUB = NO.OF MODULES   05200000
         STM   RPAR,RWTG,DXCCW5         SAVE REGS 5 AND 6        Y02072 05202002
ISL00J1  EQU   *                        ADD DEB TO QUEUE         Y02072 05210002
         L     RPAR,TCBDEB              FIRST DEB ON QUEUE       Y02072 05212002
         MVC   DEBDEBAD+1(3),TCBDEB+1   FILL DEBDEBAD                   05220000
         SPACE 2                                                        05222002
         MODESET  KEYADDR=KEY0,WORKREG=6  SET PROTECT KEY ZERO   Y02072 05230002
         SPACE 1                                                        05240002
         CS    RPAR,RDEB,TCBDEB         ADD NEW DEB IF HEAD OF   Y02072 05250002
*                                       DEB QUEUE NOT CHANGED    Y02072 05252002
         SPACE 1                                                        05252102
         MODESET  EXTKEY=DATAMGT        SET DATA MGT KEY         Y02072 05252402
         SPACE 2                                                        05252802
         BNE   ISL00J1                  BR NOT ADDED TO CHAIN    Y02072 05254002
*                                                                       05256002
         LM    RPAR,RWTG,DXCCW5         RESTORE REGS 5 AND 6     Y02072 05258002
         LA    RE,1(RA)                 ADD 1 EXTENT FOR M=0  + PRIME   05260002
         AR    RE,RB                    ADD INDEX EXTENTS               05280000
         AR    RE,RC                    ADD OVERFLOW EXTENTS            05300000
         STC   RE,DEBNMEXT              FILL DEBNMEXT = NO OF EXTENTS   05320000
         LR    R10,RE                   MOVE FROM REG ZERO       S21045 05322021
         SLL   R10,4                     NO. OF EXT'S X 16       S21045 05324021
         LA    RE,DEBUCBAD(R10)         AM SECTION STARTS AFTER  S21045 05326021
*                                       LAST                     S21045 05328021
*                                       EXTENT.                         05330021
         ST    RE,DEBEXPTR              POINT TO AM SECTION      S21045 05332021
         L     RDCB,DXUDCBAD            USERS DCB ADDR           Y02072 05334002
         ST    RDCB,DEBDCBAD            FILL DEBDCBAD                   05340000
         SPACE 2                                                        05342002
         MODESET  KEYADDR=DXUKEY,WORKREG=10  CHANGE TO USER KEY  Y02072 05350002
         SPACE 2                                                        05360002
*   ISSUING THE DEBCHK MACRO DESTROYS THE CONTENTS OF REGISTER 1,       05370000
*   BUT SINCE DEBCHK LOADS REGISTER 1 WITH THE DEB ADDRESS BEFORE       05372000
*   RETURNING TO THE CALLER, DEB ADDRESSABILITY IS REESTABLISHED.       05374000
*                                                                       05380000
         L     R10,DEBTCBAD             RESTORE TCB ADDRESS             05390000
         ST    RDEB,DCBDEBAD            DEB ADDR TO USER DCB     Y02072 05396002
         SPACE 2                                                        05396402
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 05398002
         SPACE 2                                                        05400002
         DEBCHK (RDCB),TYPE=ADD,AM=ISAM ADD DEB TO DEB TABLE     Y01021 05402000
*                                                                       05404002
         L     RDCB,0(RPARC)            ADDR OF DCB COPY         Y02072 05408002
         MVC   DEBOPATB(1),0(RPARC)     1ST  POS OF PARATBL ENTRY       05414000
         NI    DEBOPATB,X'7F'           CLEAR HI ORDER BIT              05420000
         MVC   DEBPROTG(1),TCBPKF       PROTECTION FLAG           13270 05440015
         OI    DEBDEBID,X'0F'                                           05460000
         MVC   DEBPRIOR(1),TCBDSP       PRIORITY                  13270 05480015
         MVI   DEBOFLGS,X'C0'                                           05500000
         L     RCORE,4(RWTGC)                                           05520000
         NC    DEBOFLGS,JFCBIND2                                        05540000
*                                                                       05560000
*                                                                       05580000
*    COMPLETE FIRST THREE ENTRIES OF APPENDAGE VECTOR TABLE FOR BISAM   05600000
*                                                                       05620000
         DROP  R10                                                      05630001
         L     R10,16(0,0)             GET CVT POINTER                  05640000
         L     R15,20(R10)              R10 = CVT ADDRESS               05660000
         L     R15,0(0,R15)            R15 HAS CONTENTS OF 1ST SLOT     05680000
*                                      OF IOS APPENDAGE VECTOR TABLE    05700000
         L     R10,DEBAPPAD             R10= APPENDAGE VECTOR TABLE ADR 05720000
         ST    R15,0(R10)               STORE IOS ADDRESS FOR END IF    05760000
         ST    R15,8(R10)                 PCI                           05800000
         ST    R15,12(R10)                  CHANNEL END AND             05820000
         ST    R15,16(R10)                     ABNORMAL END APPENDAGES  05840000
         USING DEBAVT,R10               DEB AVT ADDRESSABILITY   Y02072 05850002
         LH    RD,PGFIXCON              ESTABLISH BR 14 FOR SIO  Y02072 05852002
         STH   RD,DXATEXC1              AND PAGE FIX EXITS TAKEN Y02072 05854002
         STH   RD,DXATEXC2              BY IOS                   Y02072 05856002
         LA    RD,DXATEXC1              ADDR OF BR 14S TO        Y02072 05858002
         ST    RD,DEBSIOA               DEBSIOA FIELD OF DEB AVT Y02072 05858402
         DROP  R10                      END DEB AVT USING        Y02072 05858802
*                                                                       05860000
***  THE SECONDARY ALLOCATION FIELD IN DSCB FORMAT 1 WILL   ***         05880000
***   HAVE BEEN SET TO UCB ADDRESS IN A PRE-ISAM OPEN EXECUTOR   ***    05900000
***   ASSUMING FORMAT 2 DSCB FOLLOWS FIRST FORMAT 1 DSCB   ***          05920000
         MVC   DCBWKPT3(5),DSCNEXT      DCBWKPT3=CCHH OF DSCB FORMAT 2  05940000
         MVC   DCBWKPT4+1(3),DSCSCALO+1 DCBWKPT4=R(OF DSCB FORMAT 2)    05960000
*                                         AND UCB ADR OF DSCB FORMAT 2  05980000
*                                                                       06000000
* USING CONTENTS OF REG A, B AND C, BUILDING M=0 EXTENT                 06020000
*                                                                       06040000
         LA    RD,DEBUCBAD+EXTLEN      FIND M=1 EXTENT ADDR      S20201 06060020
         ST    RD,DEBFPEAD              SET UP PTR DEBFPEAD             06080000
         ST    RD,DXCCW8                SAVE PTR TO PRIME ENTRIES 13270 06086015
*                                       FOR USE IN 192B           13270 06092015
         STC   RA,DEBNPEE               SET UP CTR = NO PRIME EXTENTS   06100000
         MVC   DEBRPSID,DXCCW1+LASTHALF SET RPS INDICATORS       S20201 06110020
         SLL   RA,4                     MPY NO PRIME EXTENTS BY LENGTH  06120000
         AR    RD,RA                    INCREMENT PTR TO 1ST PRIME EXT  06140000
         LTR   RB,RB                    TO POINT TO 1ST INDEX EXTENT    06160000
         BZ    ISL00K21                 BRANCH = NO INDEX EXTENTS       06180000
         ST    RD,DEBFIEAD              SET UP ADR OF 1ST INDEX EXTENT  06200000
         ST    RD,DXCCW8+4              SAVE PTR TO INDEX ENTRIES 13270 06206015
*                                       FOR USE IN 192B           13270 06212015
         STC   RB,DEBNIEE               SET UP CTR = NUM INDEX EXTENTS  06220000
ISL00K21 SLL   RB,4                     MPY NUM INDEX EXTENTS BY LENGTH 06240000
         LTR   RC,RC                    TEST IF OVERFLOW ENTRIES        06260000
         BZ    ISL00K3                  BRANCH = NO OVERFLOW EXTENTS    06280000
         AR    RD,RB                    INCREMENT PTR TO 1ST INDEX EXT  06300000
         ST    RD,DEBFOEAD              TO POINT TO OVFLO EXTENT        06320000
         ST    RD,DXCCW9                SAVE PTR TO OVFLO ENTRIES 13270 06326015
*                                       FOR USE IN 192B           13270 06332015
         STC   RC,DEBNOEE               SET UP OVFLO PTR AND CTR        06340000
*                                                                       06360000
* COMPLETE DEB, SET BLOCKSIZE                                           06380000
*                                                                       06400000
ISL00K3  TM    DCBRECFM,X'10'           TEST IF BLOCKED                 06420000
         BC    1,ISL01D5                YES                             06440000
****************************************************************        06443018
*     IF VARIABLE BLKSIZE=LRECL+4                                       06446018
*                                                                       06449018
         LH    RB,DCBLRECL              GET RECORD LENGTH         VLR   06453018
         TM    DCBRECFM,X'80'           ARE RECORDS FIXED LENGTH  VLR   06457018
         BO    ISLFIXUB                 YES, BRANCH               VLR   06461018
         LA    RB,4(RB)                 GET RECORD DESCRIPTOR     VLR   06465018
ISLFIXUB STH   RB,DCBBLKSI                                        VLR   06469018
*                                                                       06473018
****************************************************************        06476018
ISL01D5  CLI   DEBNPEE,X'00'            AT LEAST 1 PRIME EXTENT         06480000
         BC    7,ISL01E4                YES                             06500000
*  ABENDT ERROR CODE OF HEX 36 = NO PRIME EXTENT ENTRIES                06520000
         ABEND X'036',DUMP,,SYSTEM      ISSUE ABEND              Y02072 06560002
ISL01E4  EQU   *                                                 S20201 06570020
*                                                                       07840000
*                                                                       07860000
         MVC   0(L'LOAD2B,RWTGC),LOAD2B INITIALIZE WHERE-TO-GO   Y02072 07880002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       07900000
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       07920000
         CLC   0(2,RWTGC),THISLOAD                                      07940000
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 07960000
         CLC   0(2,RWTGC),OPNLOD7       TEST FOR END OF WTG TABLE       07980000
         BC    7,RELOOP                 BRANCH=NOT AT END               08000000
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                08020000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                08040000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              08060000
         BC    7,TCTLRTN                BRANCH = NOT ZERO               08080000
ITSZERO  LA    RWTGC,8(RWTGC)                                           08100000
         LA    RPARC,4(RPARC)                                           08120000
         B     ZCHECK                                                   08140000
TCTLRTN  EQU   *                                                        08160000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         08180000
         LA    R15,DXCCW12                                       S20201 08220020
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 08240002
* CONSTANTS                                                             08260000
DEBCLEAR XC    0(0,RF),0(RF)            CLEAR CORE FOR DEB      YM08221 08270002
DECON9   DC    X'0009'                                                  08300000
THISLOAD DC    C'2A'                                                    08320000
OPNLOD7  DC    C'0S'                                                    08340000
         DS    0F                       FULLWORD ALIGNMENT       Y02072 08342002
PGFIXCON DC    X'07FE'                  PAGE FIX RET TO IOS      Y02072 08344002
KEY0     DC    X'00'                    STORAGE PROTECT KEY ZERO Y02072 08350002
*                                                                       08360000
LOAD2B   DC    C'2B'                    ID OF MODULE IGG0192B    Y02072 08410002
*                                                                       08460002
PATCH    DC    XL((*-IGG0192A)/20)'00'  ZEROED PATCH AREA        Y02072 08510002
         END                                                            08520000
