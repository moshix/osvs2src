         TITLE 'IGG0192C - ISAM OPEN, THIRD LOAD'                       00200020
IGG0192C CSECT                                                          00201002
*                                                                       00202002
*********************************************************************** 00203002
*                                                                     * 00204002
* MODULE-NAME = IGG0192C                                              * 00205002
*                                                                     * 00206002
* DESCRIPTIVE-NAME = ISAM OPEN, THIRD LOAD                            * 00207002
*                                                                     * 00208002
* COPYRIGHT = NONE                                                    * 00209002
*                                                                     * 00210002
* STATUS = RELEASE OS/VS2-02, LEVEL 01                                * 00211002
*                                                                     * 00212002
* FUNCTION = IF INDEPENDENT OVERFLOW ON A DIFFERENT DEVICE THAN       * 00214002
*            PRIME IS ON, RESET DCBDEVT TO REFLECT THE DEVICE TYPE    * 00215002
*            FOR PRIME DATA.                                          * 00216002
*                                                                     * 00217002
*            IF NOT VIRTUAL = REAL ENVIRONMENT AND BISAM SPECIFIED,   * 00217202
*            LOAD BISAM CHANNEL PROGRAM SPLITTING APPENDAGE IGG019JG. * 00217402
*                                                                     * 00217802
*            IF OPENED FOR LOAD MODE TRANSFER CONTROL TO NEXT         * 00217902
*            EXECUTOR, ELSE TEST FOR DISP = SHR.  IF OPENED WITH      * 00218202
*            SHARED DISP, SEARCH FOR FIELD AREA FOR DATA SET BEING    * 00218402
*            OPENED.  IF A FIELD AREA EXISTS FOR THE DATA SET BEING   * 00218602
*            OPENED, INCREMENT TOTAL USE COUNT BY ONE.  IF FIRST DCB  * 00218702
*            FROM THIS ADDRESS SPACE, ADD NEW ASID AND ASID USE COUNT.* 00218802
*            IF NO FIELD AREA IS FOUND FOR THIS DATA SET, OBTAIN CORE * 00219102
*            FROM SUBPOOL 241 (CSA) IN PROTECT KEY 5 FOR A FIELD AREA * 00219302
*            AND INITIALIZE IT.                                       * 00219402
*                                                                     * 00219602
* NOTES = SEE BELOW                                                   * 00219702
*                                                                     * 00220002
*    DEPENDENCIES = NONE                                              * 00221002
*                                                                     * 00223002
*    RESTRICTIONS = NONE                                              * 00224002
*                                                                     * 00225002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES                      * 00226002
*                                                                     * 00227002
*    PATCH-LABEL = PATCH, A DC STATEMENT                              * 00228002
*                                                                     * 00229002
* MODULE-TYPE = ISAM OPEN EXECUTOR                                    * 00230002
*                                                                     * 00231002
*    PROCESSOR = ASSEMXF-370R                                         * 00232002
*                                                                     * 00233002
*    MODULE-SIZE = 992 DECIMAL BYTES                                  * 00234002
*                                                                     * 00235002
*    ATTRIBUTES = REENTRANT, PRIVILEGED                               * 00236002
*                                                                     * 00237002
* ENTRY-POINT = IGG0192C                                              * 00238002
*                                                                     * 00239002
*    PURPOSE = SEE FUNCTION                                           * 00240002
*                                                                     * 00241002
*    LINKAGE = RECEIVES CONTROL FROM ISAM OPEN EXECUTOR IGG0192B      * 00242002
*              IN STORAGE PROTECT KEY 5 AND PRIVILEGED STATE.         * 00243002
*                                                                     * 00245002
* INPUT = REGISTERS ESTABLISHED ON ENTRY ARE                          * 00246002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00247002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00248002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00249002
*               PARAMETER LIST                                        * 00250002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00251002
*                                                                     * 00252002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00253002
*          UPON ENTRY TO THIS MODULE                                  * 00254002
*                                                                     * 00255002
* EXIT-NORMAL = TRANSFERS CONTROL IN STORAGE PROTECT KEY 5 TO         * 00256002
*               IGG01921 IF LOAD MODE, ELSE TO IGG01920 IF FIXED      * 00257002
*               RECORD FORMAT OR IGG01950 IF VARIABLE FORMAT.         * 00257202
*                                                                     * 00258002
* EXIT-ERROR = NONE                                                   * 00259002
*                                                                     * 00261002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00262002
*                                                                     * 00263002
*    ROUTINES = NONE                                                  * 00264202
*                                                                     * 00265002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00266002
*                 FORCORE - OPEN WORK AREA                            * 00267002
*                 IHAPSA - LOW CORE ADDRESSABILITY                    * 00268402
*                                                                     * 00269002
*    CONTROL-BLOCKS = ASCB, CVT, DCB COPY, DEB, F2 DSCB, JFCB, DCBFA, * 00270002
*                    AND TCB.                                         * 00270202
*                                                                     * 00271002
* TABLES = NONE                                                       * 00272002
*                                                                     * 00273002
* MACROS = GETMAIN, LOAD, MODESET, SETLOCK, AND XCTL                  * 00274002
*                                                                     * 00275002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00276002
*                                                                     * 00277002
*          RELEASE OS/VS2-02 DELETIONS                                * 00277402
*                                                               YM01159 00278002
*                                                               YM06899 00278402
*                                                               YM07856 00278802
*                                                               YM08221 00278902
*                                                                     * 00279002
*********************************************************************** 06201002
         EJECT                                                          06202002
FORCORE  DSECT                                                          06203002
         IECDSECT                                                       06400020
TCB      IKJTCB                                                         06600001
         EJECT                                                          08600001
         IHAPSA                                                         08650002
         EJECT                                                          08700002
         IHAASCB                                                        08750002
         EJECT                                                          08800002
TIOT     DSECT                                                          11000020
TIOELNGH DS    CL1                                                      11200020
TIOESTTA DS    CL1                      STATUS -A-                      11400020
TIOERLOC DS    CL2                      REL LOC OF POOL                 11600020
TIOEDDNM DS    2F                                                       11800020
TIOEJFCB DS    1F                       JFCB DISL ADDRESS               12000020
TIOESTTB DS    0CL1                                                     12200020
TIOEFSRT DS    CL4                                                      12400020
         DS    CL1                                                      12600020
IHADEB   IGGDEBD                                                        12800001
         EJECT                                                          13800001
         CVT   DSECT=YES                                                15800002
         SPACE 4                                                        16800002
         DCBD  DSORG=(IS)                                               19600020
         EJECT                                                          20000020
DCBFA    IGGDCBFA                                                       20200020
         SPACE 2                                                        20400020
         SPACE 3                                                        21002502
IHADSCB  DSECT                                                          21005000
DSCBK1   DS    BL1                      X'02'                           21007500
DSCBK2   DS    CL7                      DCBFTMI2                        21010000
DSCBK3   DS    CL5                      DCBLEMI2                        21012500
DSCBK4   DS    CL7                      DCBFTMI3                        21015000
DSCBK5   DS    CL5                      DCBLETI                         21017500
DSCBK6   DS    CL19                     SPARE                           21020000
DSCBD1   DS    CL1                      EBCDIC '2'                      21022500
DSCBD2   DS    CL1                      DCBNLEV                         21025000
DSCBD3   DS    CL1                      DCBNTM                          21027500
DSCBD4   DS    CL3                      DCBFIRSH                        21030000
DSCBD5   DS    CL2                      DCBLDT                          21032500
DSCBD6   DS    CL1                      DCBCYLOF                        21035000
DSCBD7   DS    CL1                      DCBHIRCM                        21037500
DSCBD8   DS    CL1                      DCBHIRPD                        21040000
DSCBD9   DS    CL1                      DCBHIROV                        21042500
DSCBD10  DS    CL1                      DCBHIRSH                        21045000
DSCBD11  DS    CL2                      RESERVED                        21047500
DSCBD12  DS    CL2                      DCBTDC                          21050000
DSCBD13  DS    CL3                      DCBRORG3                        21052500
DSCBD14  DS    CL2                      DCBNCRHI                        21055000
DSCBD15  DS    CL1                      DCBNTHI                         21057500
DSCBD16  DS    CL4                      DCBNREC                         21060000
DSCBD17  DS    BL1                      DCBST                           21062500
DSCBD18  DS    CL7                      DCBFTCI                         21065000
DSCBD19  DS    CL7                      DCBFTMI3                        21067500
DSCBD20  DS    CL7                      DCBFTHI                         21070000
DSCBD21  DS    CL08                     DCBLPDA                         21072500
DSCBD22  DS    CL5                      LAST TRACK IX ENTRY ADDR        21075000
DSCBD23  DS    CL5                      LAST CYLDR IX ENTRY ADDR        21077500
DSCBD24  DS    CL5                      LAST MASTR IX ENTRY ADDR        21080000
DSCBD25  DS    CL8                      DCBLIOV                         21082500
DSCBD26  DS    CL2                      DCBNBOV                         21085000
DSCBD27  DS    CL2                      DCBRORG2                        21087500
DSCBD28  DS    CL2                      DCBNOREC                        21090000
DSCBD29  DS    CL2                      DCBRORG1                        21092500
DSCBD30  DS    CL3                      SPARE                           21095000
DSCBD31  DS    CL5                      PTR TO FORMAT 3 DSCB            21097500
         SPACE 4                                                        21200002
CHAIN    DSECT                                                          21250021
LSTCHAIN DS    F                                                        21300021
         EJECT                                                          21370021
IGG0192C CSECT                                                          21400020
R0       EQU   0                        WORK REGISTER                   21600020
R1       EQU   1                        WORK REGISTER                   21800020
RDEB     EQU   1                        BASE REGISTER FOR USERS DEB     22000020
R2       EQU   2                        WORK REGISTER                   22200020
RDCB     EQU   2                        BASE REG FOR DCB                22400020
R3       EQU   3                        WORK REGISTER                   22600020
RCORE    EQU   4                        BASE REG FOR OPEN WORK AREALE   22800020
RPAR     EQU   5    *                   ADDRESS OF PARAMETER TABLE      23000020
RWTG     EQU   6    *                   ADDRESS OF WHERE-TO-GO TABLE    23200020
RPARC    EQU   7    *                   CURRENT PARAMETER ENTRY         23400020
RWTGC    EQU   8    *                   CURRENT WHERE-TO-GO ENTRY       23600020
RBASE    EQU   9                        BASE REGISTER                   23800020
RA       EQU   10                       WORK REGISTER                   24000020
RB       EQU   11                       WORK REGISTER                   24200020
RC       EQU   12                       WORK REGISTER                   24400020
RD       EQU   13                       WORK REGISTER                   24600020
RE       EQU   14                       WORK REGISTER                   24800020
RF       EQU   15                       WORK REGISTER                   25000020
*                                                                       25200020
*        EQUATES USED IN MODULE                                         25400020
*                                                                       25600020
DSORG    EQU   26                                                       26200020
MACRF    EQU   42                                                       26400020
WKPTR1   EQU   228                                                      26800020
WKPTR2   EQU   232                                                      27000020
WKPTR3   EQU   236                                                      27200020
WKPTR5   EQU   244                                               A37175 27260020
OFLGS    EQU   48                                                A37175 27320020
JFCBSHR  EQU   X'08'                    JFCB INDICATOR, DISP=SHR A47331 27370021
NULL     EQU   0                        FOR ZERO DISPLACEMENT    A47331 27380021
SHR      EQU   X'80'                    SHR INDICATOR FOR DCB    A47331 27390021
INCR     EQU   X'01'                    CONSTANT FOR INCREMENT   A47331 27392021
CSA241   EQU   241                      CSA SUBPOOL 241          Y02072 27410002
KEYZERO  EQU   0                        CHANGE TO KEY ZERO       Y02072 27412002
LOADMODE EQU   X'18'                    LOAD INDICATOR                  27420001
SCANMODE EQU   X'40'                    SCAN INDICATOR                  27430001
PAGE     EQU   2048                     PAGE LENGTH                     27440001
VIRTUAL  EQU   X'80'                    VIRTUAL INDICATOR               27460001
DWORD    EQU   3                        DOUBLE WORD                     27470001
THREE    EQU   3                        CONSTANT                        27472500
FOUR     EQU   4                        CONSTANT                        27480001
TWENTY4  EQU   24                       CONSTANT                        27482500
ID       EQU   6                        DISP TO ID IN MOD NAME          27490001
K2       EQU   2                        CONSTANT                        27500001
L5       EQU   5                        LENGTH                          27500400
ONE      EQU   1                        CONSTANT                        27520001
ZERO     EQU   0                        CONSTANT                        27530001
RPSID    EQU   X'E0'                    RPS IDENTIFIER                  27540001
         EJECT                                                          27600020
         BALR  RBASE,0                  ESTABLISH ADDRESSABILITY        27800020
         USING *,RBASE                                                  28000020
         USING IHADEB,RDEB                                              28200020
         USING IHADCB,RDCB                                              28400020
         USING FORCORE,RCORE                                            28600020
         L     RDCB,0(RPARC)            RDCB = ADR OF DCB               28800020
         L     RCORE,4(RWTGC)           RCORE = ADR OF OPEN WK AREA     29000020
*                                                                       29200020
*                                                                       29400020
         L     RC,DSCCORE               RC=ADR OF FORMAT 2 DSCB         29600020
         CLI   52(RC),X'00'             WAS CYLOFL ALLOCATED     M0657  29620020
         BE    NOCYL                    NO - CONTINUE            M0657  29640020
         OI    DCBOPTCD,X'08'           USE CYLOFL FIRST         M0657  29660020
NOCYL    CLC   126(2,RC),CONZERO        ANY INDEPENDENT OVERFLOW M0657  29680020
         BE    NOIND                    NO - CONTINUE            M0657  29700020
         OI    DCBOPTCD,X'10'           USE INDEPENDENT OVERFLOW M0657  29720020
NOIND    EQU   *                                                 M0657  29740020
         MVC   DCBST(1),71(RC)          STATUS FROM FMT2 DSCB     P4701 29800020
         L     RCORE,4(RWTGC)           ADR OF OPEN WK AREA             33800020
*                                                                       34000020
*        IF INDEPENDENT OVERFLOW ON DIFFERENT DEVICE THEN DCBDEVT AND   34200002
*        DCBHMASK MUST BE RESET TO REFLECT DEV TYPE FOR PRIME DATA      34400002
*                                                                       34600020
         L     RDEB,DCBDEBAD            GET PTR TO DEB                  35200020
         L     R3,DEBFPEAD              PTR TO PRIME EXTENT             35400020
         L     R3,0(R3)                 PTR TO UCB                      35600020
         MVC   DCBDEVT(1),19(R3)        RESET DEVT                      36000020
         MVI   DCBHMASK,X'FF'           SET MASK FOR LOW ORDER   A53128 36016002
*                                       HEAD BYTE                A53128 36018002
* SET UP OVERFLOW DEVICE TYPE, DEFAULT = PRIME DEVICE TYPE              36020002
         MVC   DCBOVDEV,DCBDEVT         ASSUME NO IND OVFL       M0673  36040020
         L     R3,DEBFOEAD              FIND THE FIRST           M0673  36060020
         LA    R3,0(R3)                 * OVERFLOW EXTENT        M0673  36080020
         LTR   R3,R3                    DOES IT EXIST            M0673  36100020
         BZ    NOINDOV                  NO - TAKE DEFAULT TYPE   M0673  36120020
         L     R3,0(R3)                 PT TO UCB                M0673  36140020
         MVC   DCBOVDEV,19(R3)          GET DEVICE TYPE          M0673  36160020
NOINDOV  EQU   *                                                 O19112 36200020
         SPACE 4                                                        36204002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   36206001
*   IF NOT VIRTUAL = REAL AND BISAM, LOAD BISAM CHANNEL PGM         *   36208002
*   SPLITTING MODULE.  PUT ITS ADDRESS IN THE AVT AND ITS ID IN     *   36208402
*   THE DEB SUBROUTINE LOAD LIST.                                   *   36210002
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   36212001
         SPACE 1                                                        36214001
         L     R3,DEBTCBAD              TCB ADDRESSABILITY              36216001
         USING TCB,R3                   *                               36218001
         SPACE 1                                                        36220001
         L     RA,DEBAPPAD              ADDRESSABILITY ON AVT           36222001
         USING DEBAVT,RA                *                               36224001
         MVI   DEBSIOA,ZERO             MARK AS NOT VIRTUAL             36226002
         TM    TCBFLGS6,TCBRV           IS IT VIRTUAL = REAL            36228001
         BO    INITSIO                  BR YES, NO CP SPLITTING YM08221 36230002
*                                                                       36232002
*   TEST MODE TO DETERMINE IF BISAM MODULE SHOULD BE LOADED             36234002
*                                                                       36234402
         OI    DEBSIOA,VIRTUAL          MARK IT AS VIRTUAL       Y02072 36234802
         TM    DCBMACF2,LOADMODE        IS IT LOAD               Y02072 36238002
         BNZ   NOTVIRT                  BR YES - CLEAR DEB EXT  YM08221 36240002
         SPACE 1                                                        36242001
         TM    DCBMACRF,SCANMODE        IS IT SCAN MODE                 36246002
         BO    NOTVIRT                  BR YES - CLEAR DEB EXT  YM08221 36248002
         SPACE 1                                                        36250001
         LA    R3,IGG019JG              IS BISAM - LOAD CP       Y02072 36252002
*                                       SPLITTING MODULE         Y02072 36252402
         SPACE 1                                                        36254002
         L     RB,CVTPTR                CVT ADDRESS             YM01159 36258002
         USING CVT,RB                   CVT ADDRESSABILITY      YM01159 36260002
         L     RB,CVTLINK               ADDRESS OF LINKLIB DCB  YM01159 36262002
         DROP  RB                       END CVT ADDRESSABILITY  YM01159 36264002
*                                                                       36266002
         MVC   ID(L'IGG019JG,RWTG),0(R3) BUILD MODULE NAME       Y02072 36266402
         SPACE 1                                                        36266802
         LOAD  EPLOC=(RWTG),DCB=(RB)    LOAD IT                         36268000
         SPACE 1                                                        36270002
*   PUT ADDRESS AND LENGTH OF MODULE IN AVT.                            36272001
         ST    R0,DEBSIOA               ADDRESS OF CP SPLIT APPENDAGE   36274002
         OI    DEBSIOA,VIRTUAL          MARK IT AS VIRTUAL              36304002
         L     R1,DCBDEBAD              RESTORE DEB ADDRESS             36306002
         DROP  RA                                                       36308001
         SPACE 1                                                        36310001
*   PUT PGFX ID IN THE N OR N-1 SLOT OF THE DEB LOAD LIST               36312001
         SPACE 1                                                        36314001
         SR    RA,RA                    CLEAR                           36316001
*   ALLOW FOR ISAM DEPENDANT SECTION - SYSTEM INTEGRITY S21045 *        36316400
         L     RB,DEBEXPTR              ISAM DEPENDANT SECTION          36318000
         IC    RA,BISAMLEN              LENGTH ISAM SECTION      Y02072 36319602
         AR    RB,RA                    ALLOW FOR ISAM SECTION          36322800
         IC    RA,DEBNMSUB              NUMBER OF SUB RTNS LOADED       36322900
         AR    RB,RA                    ALLOW TWO BYTES FOR EACH ID.    36323000
         AR    RB,RA                    *                               36323100
*   ALLOW FOR POSSIBLE RPS ID                                           36332001
         SH    RB,HWOF3                 BACK UP TO RPS ID.              36332100
         TM    DEBRPSID,RPSID           IS THIS AN RPS DATA SET         36334001
         BNZ   RPS001                   RPS - USE N-1 SLOT              36336001
         LA    RB,K2(RB)                NOT RPS - USE N SLOT            36338001
RPS001   EQU   *                        *                               36340001
*   MOVE CORRECT ID IN.                                                 36342001
         MVC   0(K2,RB),0(R3)           *                               36344000
         B     NOTVIRT                  INIT FOR NEXT LOAD       Y02072 36344402
         SPACE 1                                                        36344502
INITSIO  EQU   *                        INIT SIO PTR IN AVT     YM08221 36348602
         USING DEBAVT,RA                AVT ADDRESSABILITY      YM07856 36351202
         L     RB,CVTPTR                ADDRESS OF CVT          YM07856 36351602
         USING CVT,RB                   CVT ADDRESSABILITY      YM07856 36352002
         LA    RB,CVTBRET               ADDR OF BR 14 IN CVT    YM07856 36352402
         DROP  RB                       END CVT ADDRESSABILITY  YM07856 36352502
         ST    RB,DEBSIOA               ADDR BR 14 TO DEB SIO   YM07856 36352602
         DROP  RA                       END DEB AVT ADDRESS     YM07856 36352702
         SPACE 1                                                        36353402
NOTVIRT  EQU   *                        *                               36551602
         MVC   0(L'LOAD21,RWTGC),LOAD21 INITIAL WTG TO IGG01921  Y02072 36575802
         TM    DCBMACRF+1,X'18'          IS IT LOAD MODE                36600020
         BM    LOADMRG                  YES, BRANCH              A52029 36800000
         L     RCORE,4(RWTGC)           RCORE = ADR OF OPEN WK AREA     37000020
*********************************************************************** 37200020
*                                                                       37400020
*        TEST FOR DISP = SHR, IF NOT WILL EXIT                          37600020
*                                                                       37800020
         TM    JFCBIND2,JFCBSHR         TEST DISP OF DATA SET    A47331 38000021
         BNO   FININIT                  IF NOT, NO FIELD AREA    A47331 38200021
****                                                                    38400020
*    THIS DATA SET OPENED TO SHR.  WILL SEARCH FOR ALL ISAM             38600020
*        FA'S TO FIND ONE OPENED ON THE SAME DATA SET                   38800021
****                                                                    39000020
         STM   R0,RF,DXCCW1             SAVE REGISTERS           Y02072 39050002
         MODESET KEYADDR=KEY0,WORKREG=13 CHANGE TO KEY ZERO      Y02072 39060002
*                                                                       39062002
*    OBTAIN THE LOCAL LOCK, RELEASED AT FLCL IN THIS MODULE.            39064002
*                                                                       39066002
GLCL     SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,  OBTAIN THE      Y02072*39070002
               RELATED=(DCBFA,IGG0192C) *        LOCAL LOCK      Y02072 39080002
*                                                                       39082002
*    OBTAIN THE CMS LOCK, FREED AT FCMS IN THIS MODULE.                 39084002
*                                                                       39086002
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,    OBTAIN CROSS    Y02072*39090002
               RELATED=(DCBFA,IGG0192C) *        MEMORY LOCK     Y02072 39092002
         MODESET EXTKEY=DATAMGT         CHANGE TO DATA MGT KEY   Y02072 39094002
*                                                                       39096002
         L     R3,CVTPTR                ADDR OF CVT              A47331 39100021
         USING CVT,R3                                            A47331 39150021
         L     R3,CVTEXT1               ADDR OF CVT EXTENSION    A47331 39200021
         USING CVTXTNT1,R3                                              39250021
         L     RA,CVTFACHN              ADDR OF FIRST FA         A47331 39300021
         LA    R3,CVTFACHN              ADDR OF CHAIN PTR TO FA  A47331 39350021
         LTR   RA,RA                    TEST IF ANY FIELD AREAS  A47331 39400021
         BZ    ENDSRCH                  NO, CREATE ONE           A47331 39450021
*********************************************************************** 40800020
*        SEARCH FA CHAIN FOR EXISTING FA FOR THIS DATA SET              40850021
*                                                                       40900021
         USING DCBFA,RA                                                 40950021
CHNSRCH  CLC   DFAID,DCBWKPT3           SAME DATA SET ID AS DCB  A47331 41000021
         BE    FOUNDFA                  YES USE THIS FIELD AREA  A47331 41050021
         LA    R3,DFACHAIN              NO, UPDATE CHAIN AREA PT A47331 41100021
         CLC   DFACHAIN(L'EOC),EOC      ANY MORE FA'S IN CHAIN   Y02072 41150002
         BE    ENDSRCH                  B IF END OF CHAIN TO     A47331 41200021
*                                       CREATE FIELD AREA        A47331 41250021
         L     RA,DFACHAIN              UPDATE FA ADDR           A47331 41300021
         B     CHNSRCH                  B TO CONTINUE SEARCH     A47331 41350021
*********************************************************************** 43400020
*                                                                       43600020
*        IF NO FIELD AREA FOUND FOR THIS DATA SET, WILL                 43800021
*        GET AREA FOR FIELD AREA AND INITIALIZE IT.                     44000021
*                                                                       44200020
*********************************************************************** 44400020
         USING CHAIN,R3                                                 44450021
ENDSRCH  LA    RC,DFASIZE(R0)           SIZE OF FA FOR GETMAIN   A47331 44500021
         BAL   RWTG,GETCORE             GET CORE FOR FIELD AREA  Y02072 44550002
         LTR   RA,RA                    THIS FIRST FA IN CHAIN   Y02072 44560002
         BNZ   ADDFA                    BR NO                    Y02072 44570002
         MODESET KEYADDR=KEY0,WORKREG=13  CHANGE TO KEY ZERO     Y02072 44580002
         ST    R1,LSTCHAIN              ADDR OF DCBFA TO CVT     Y02072 44590002
         MODESET EXTKEY=DATAMGT         CHANGE TO DATA MGT KEY   Y02072 44592002
         B     CLEARFA                  CLEAR FIELD AREA         Y02072 44594002
*                                       DCBFA FIRST IN CHAIN,    Y02072 44596002
ADDFA    EQU   *                        ADD FA TO CHAIN          Y02072 44598002
         ST    R1,LSTCHAIN              SET LAST CHAIN PTR FOR   Y02072 44598402
*                                       THIS FIELD AREA          Y02072 44598802
         DROP  R3                       END FA PTR USING         Y02072 44599202
CLEARFA  LR    RA,R1                    FA ADDRESSABILITY        Y02072 44600002
         XC    DCBFA(DFASIZE),DCBFA     ZERO FA                  A47331 44650021
         MVC   DFAID,DCBWKPT3           MOVE IN DATA SET ID      A47331 44700021
         MVC   DFACHAIN(L'EOC),EOC      SET NEW END OF CH IND    Y02072 44810002
*                                                                       44820021
*********************************************************************** 45800020
*                                                                       46000020
*    COMPLETE  FIELD AREA  INITIALIZATION.                              46200021
*                                                                       46600020
*********************************************************************** 46800020
FOUNDFA  LA    RA,NULL(RA)             CLRAR HIGH ORDER BYTE     A47331 46850021
         ST    RA,DCBWKPT5             SET FA ADDR IN DCB        A47331 46900021
         OI    DCBWKPT5,SHR            SET SHR INDICATOR         A47331 46950021
         LH    RB,DFAUSE               GET USE COUNT             A47331 47000002
         LA    RB,INCR(RB)             INCREMENT USE COUNT       A47331 47050021
         STH   RB,DFAUSE                                         A47331 47150002
         L     RDEB,DCBDEBAD            PROTECTED DEB ADDRESS    Y02072 47160002
         L     RB,DEBEXPTR              PTR TO ISAM DEB EXT.     Y02072 47170002
         USING DEBEXT,RB                DEB EXT. ADDRESSABILITY  Y02072 47180002
         L     RA,DCBWKPT5              PTR TO FIELD AREA        Y02072 47190002
         ST    RA,DEBDCBFA              FIELD AREA ADDR TO DEB   Y02072 47192002
         DROP  RB                       END USING ON DEB EXT.    Y02072 47194002
*                                                                       47200002
**********************************************************************  47250002
*    INCREMENT ADDRESS SPACE USE COUNT.  IF ANOTHER DCB IS OPEN TO      47300002
*    THE DATA SET FROM THIS ASID, INCR THE APPROPRIATE USE COUNT BY     47350002
*    ONE.  IF THIS IS THE FIRST DCB IN THIS ADDRESS SPACE,STORE THE     47400002
*    ASID IN THE FIRST AVAILABLE USER ASID FIELD IN THE FIELD AREA      47450002
*    OR EXTENSION AND SET THE USE COUNT TO ONE.                         47500002
*                                                                       47550002
         USING PSA,R0                   LOW CORE ADDRESSABILITY  Y02072 47600002
         L     RB,PSAAOLD               ASCB ADDRESS             Y02072 47650002
         USING ASCB,RB                  ASCB ADDRESSABILITY      Y02072 47700002
         LH    RB,ASCBASID              ADDRESS SPACE ID         Y02072 47900002
         DROP  RB                       DROP USING ON REGISTER   Y02072 47950002
*                                                                       48000002
         LA    RA,DFAASID1              ADDR OF USER ASID FIELD  Y02072 48050002
         USING DFAASID,RA               USER ASID'S FIELDS       Y02072 48100002
NOASIDS  LA    R3,DFANOIDS              NO. ASIDS IN FIELD AREA  Y02072 48150002
*                                       AND FA EXTENSIONS        Y02072 48200002
         B     ASIDSRCH                 SEARCH FA FOR THIS ASID  Y02072 48210002
*                                                                       48220002
NXTASID  LA    RA,DFANXPTR(RA)          PT TO NEXT ASID ENTRY    Y02072 48230002
ASIDSRCH LH    RC,DFAASIDX              USER ASID                Y02072 48250002
         LTR   RC,RC                    IS THERE AN ASID         Y02072 48300002
         BZ    NOASID                   BR IF ZERO, NO ASID      Y02072 48350002
         CR    RC,RB                    ASID EQ THIS ADDR SPACE  Y02072 48400002
         BE    FNDASID                  BR IF THIS ADDR SPACE    Y02072 48450002
         BCT   R3,NXTASID               BR IF MORE ASID'S        Y02072 48500002
*                                                                       48510002
         LR    R3,RA                    SAVE ADDR ON CURR ENTRY  Y02072 48520002
         DROP  RA                       ESTAB NEW ADDRESSABILITY Y02072 48530002
         USING DFAASID,R3               ON CURRENT ENTRIES       Y02072 48540002
*                                                                       48550002
         L     RA,DFAPTR                PTR TO FIELD EXTENSION   Y02072 48600002
         LTR   RA,RA                    ANOTHER EXTENSION EXIST  Y02072 48650002
         BNZ   NOASIDS                  BR IF EXTENSION EXISTS   Y02072 48700002
*                                                                       48750002
         LA    RC,DFEXSIZE              SIZE OF FA EXTENSION     Y02072 48800002
         BAL   RWTG,GETCORE             GET CORE FOR EXTENSION   Y02072 48850002
*                                                                       48900002
         ST    R1,DFAPTR                ADD EXTENSION TO CHAIN   Y02072 48950002
         DROP  R3                       ESTABLISH ADDRESSABILITY Y02072 48960002
         USING DFAASID,RA               * ON NEW EXTENSION FLDS  Y02072 48970002
         LR    RA,R1                    FA EXTENSION ADDR        Y02072 49000002
         USING DCBFAEX,R1               FA EXTENSION                    49050002
         XC    DCBFAEX(DFEXSIZE),DCBFAEX CLEAR EXTENSION         Y02072 49100002
         DROP  R1                       DROP USING ON REGISTER   Y02072 49150002
*                                                                       49200002
NOASID   STH   RB,DFAASIDX              STORE ASID               Y02072 49250002
FNDASID  LH    R1,DFAUSEX               ASID USE COUNT           Y02072 49300002
         LA    R1,DFAINCR(R1)           INCR USE COUNT BY ONE    Y02072 49350002
         STH   R1,DFAUSEX               STORE USE COUNT          Y02072 49400002
*                                                                       49410002
*    RELEASE CMS AND LOCAL LOCKS                                        49450002
*                                                                       49460002
         MODESET KEYADDR=KEY0,WORKREG=13  CHANGE TO KEY ZERO     Y02072 49500002
*                                                                       49510002
*    RELEASE CMS LOCK, OBTAINED AT GCMS IN THIS MODULE.                 49520002
*                                                                       49530002
         SETLOCK RELEASE,TYPE=CMS,RELATED=(DCBFA,IGG0192C)       Y02072 49550002
*                                                                       49560002
*    RELEASE THE LOCAL LOCK, OBTAINED AT GLCL IN THIS MODULE.           49570002
*                                                                       49580002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=(DCBFA,IGG0192C)     Y02072 49600002
*                                                                       49610002
         MODESET EXTKEY=DATAMGT         CHANGE TO DATA MGT KEY   Y02072 49650002
         LM    R0,RF,DXCCW1             RESTORE REGISTERS        Y02072 49700002
         B     FININIT                  FINISH MERGE TO DCB      Y02072 49750002
*                                                                       49800002
*    SUBROUTINE FOR GETMAIN, LENGTH IS IN REGISTER RC (12)              49850002
*                                                                       49900002
GETCORE  LR    RPAR,RCORE               SAVE WORK AREA ADDRESS   Y02072 49950002
         ST    RPARC,DXCCW9             ADDR CURR PARAM ENTRY    Y02072 50000002
         ST    R3,DXCCW10               SAVE FA CHAIN PTR        Y02072 50010002
         L     RCORE,DCBDEBAD           DEB ADDRESS              Y02072 50050002
         USING IHADEB,RCORE             DEB ADDRESSABILITY       Y02072 50100002
         L     RCORE,DEBTCBAD           TCB ADDRESS              Y02072 50150002
         DROP  RCORE                    DROP USING ON REGISTER   Y02072 50200002
         USING PSA,R0                   LOW CORE ADRESSABILITY   Y02072 50250002
         L     RPARC,PSAAOLD            ASCB ADDRESS             Y02072 50300002
         MODESET KEYADDR=KEY0,WORKREG=13  CHANGE TO KEY ZERO     Y02072 50350002
*                                                                       50400002
         GETMAIN RU,LV=(RC),SP=CSA241,KEY=05,BRANCH=YES          Y02072 50450002
*                                                                       50500002
         MODESET EXTKEY=DATAMGT         CHANGE TO DATA MGT KEY   Y02072 50550002
         LR    RCORE,RPAR               RESTORE WORK AREA ADDR   Y02072 50600002
         USING FORCORE,RCORE            WORK AREA ADDRESSABILITY Y02072 50610002
         L     RPARC,DXCCW9             AND CURR PARAM ENTRY     Y02072 50650002
         L     R3,DXCCW10               RESTORE FA CHAIN PTR     Y02072 50660002
         BR    RWTG                     RETURN                   Y02072 50700002
*                                                                       50750002
**********************************************************************  50800002
*                                                                       50850002
FININIT  EQU   *                                                        60400020
*   MERGE FORMAT2 DSCB FIELDS THAT WON'T BE VALIDATED FOR BISAM         60402500
*   AND QISAM SCAN.                                                     60405000
         USING FORCORE,RCORE            WA ADDRESSABILITY        Y02072 60407002
         L     R3,DSCCORE               ADDRESSABILITY ON FORMAT2       60407500
         USING IHADSCB,R3               *                               60410000
         MVC   DCBNLEV,DSCBD2           MOVE VARIOUS FIELDS FROM S20201 60445000
*                                       DSCB                     S20201 60447500
         MVC   DCBNTM,DSCBD3                                     S20201 60450000
         MVC   DCBFIRSH,DSCBD4           TO DCB                  S20201 60452500
         MVC   DCBLDT,DSCBD5             * CONTINUE MERGING      S20201 60455000
         MVC   DCBCYLOF,DSCBD6           *                       S20201 60457500
*        MOVE FIELDS FROM DSCBD7, DSCBD8, DSCBD9 AND DSCBD10            60460000
*        TO DCBHIRCM, DCBHIRPD, DCBHIROV, AND DCBHIRSH.                 60462500
         MVC   DCBHIRCM(FOUR),DSCBD7    *                               60465000
         MVC   DCBTDC,DSCBD12            *                       S20201 60467500
         MVC   DCBRORG3+L'DCBRORG3-L'DSCBD13(L'DSCBD13),DSCBD13 *       60470000
         MVC   DCBNCRHI,DSCBD14          *                       S20201 60472500
         MVC   DCBNTHI,DSCBD15           *                       S20201 60475000
         MVC   DCBFTCI,DSCBD18          * CONTINUE DCB MERGE     S20201 60477500
         MVC   DCBFTMI1,DSCBD19         * FROM FORMAT 2 DSCB     S20201 60480000
         MVC   DCBFTHI,DSCBD20          *                        S20201 60482500
         MVC   DCBLECI,DSCBD23          *                        S20201 60485000
         MVC   DCBLEMI1,DSCBD24         *                        S20201 60487500
         MVC   DCBLETI,DSCBD22          LAST TRACK INDEX ENTRY          60490000
         MVC   DCBRORG1,DSCBD29         *                        S20201 60492500
*        MOVE FIELDS FROM DSCBK2, DSCBK3, DSCBK4, AND DSCBK5            60495000
*        TO DCBFTMI2, DCBLEMI2, DCBFTMI3 AND DCBLEMI3.                  60497500
         MVC   DCBFTMI2(L'DSCBK2+L'DSCBK3+L'DSCBK4+L'DSCBK5),DSCBK2     60500000
         MVC   0(L'LOAD20,RWTGC),LOAD20 SET UP TO GO TO IGG01920 Y02072 60500402
         TM    DCBRECFM,X'80'           IS IT FIXED LENGTH              61000020
         BO    RELOOP                   YES, GO TO IGG01920             61200020
         MVC   0(L'LOAD50,RWTGC),LOAD50 SET UP TO GO TO IGG01950 Y02072 61400002
         B     RELOOP                   SKIP LOAD MODE MERGE     A52029 61450000
*                                                                       61600020
LOADMRG  EQU   *                                                 A52029 61650000
         L     R3,DSCCORE               ADDRESSABILITY ON F2     A52029 61660000
         USING IHADSCB,R3               TELL ASSEMBLER           A52029 61670000
         TM    JFCBIND2,X'80'           IS DISP OLD              A52029 61700000
         BO    RELOOP                   NOT OLD,SKIP MERGE       A52029 61750000
         NC    DCBNTM,DCBNTM            WAS NTM CODED IN JCL     A52029 61760000
         BNZ   CYLOFCK                  YES SPECIFIED, NO MERGE  A52029 61770000
         MVC   DCBNTM,DSCBD3            MOVE IN FROM FORMAT2     A52029 61780000
CYLOFCK  EQU   *                                                 A52029 61790000
         NC    DCBCYLOF,DCBCYLOF        WAS CYLOF CODED IN JCL   A52029 61792000
         BNZ   RELOOP                   YES SPECIFIED, NO MERGE  A52029 61794000
         MVC   DCBCYLOF,DSCBD6          MOVE IN FROM FORMAT2     A52029 61796000
**********************************************************************  61800020
*                                                                       62000020
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       62200020
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       62400020
         CLC   0(2,RWTGC),THISLOAD                                      62600020
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 62800020
         CLC   0(2,RWTGC),OPNLOD7       TEST FOR END OF WTG TABLE       63000020
         BNE   RELOOP                   BRANCH = NOT AT END             63200020
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                63400020
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                63600020
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              63800020
         BNE   TCTLRTN                  BRANCH = NOT ZERO               64000020
ITSZERO  LA    RWTGC,8(RWTGC)                                           64200020
         LA    RPARC,4(RPARC)                                           64400020
         B     ZCHECK                                                   64600020
TCTLRTN  EQU   *                                                        64800020
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         65000020
         LA    RF,DXCCW12                                               65400020
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 65600002
* CONSTANTS                                                             65800020
*                                       BOX, HI SPEED OR LCS.           66000020
         DS    0F                                                       66200020
HWOF3    DC    H'3'                     CONSTANT                        66220900
*                                                                       66230002
*                                                                       66270001
IGG019JG DC    C'JG'                    BISAM                           66280000
BISAMLEN DC    AL1(BISAMEXT-1)          LEN ACC METH SEC DEB - BISAM    66280802
*                                                                       66290001
CONZERO  DC    F'0'                                                     66400020
KEY0     EQU   CONZERO                  ZERO STORAGE PROTECT KEY Y02072 66450002
EOC      DC    XL4'00FFFFFF'                                            66550002
THISLOAD DC    C'2C'                                                    66600020
OPNLOD7  DC    C'0S'                                                    66800020
*                                                                       67000020
LOAD20    DC    C'20'                     ID OF MODULE IGG01920  Y02072 67050002
LOAD21    DC    C'21'                     ID OF MODULE IGG01921  Y02072 67060002
LOAD50    DC    C'50'                     ID OF MODULE IGG01950  Y02072 67110002
*                                                                       67160002
PATCH    DC    50X'00'                  ZEROED PATCH AREA        Y02072 67210002
         END                                                            69400020
