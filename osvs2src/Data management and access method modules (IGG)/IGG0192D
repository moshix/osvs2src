         TITLE 'IGG0192D - OPEN, QISAM LOAD MODE'                       00020000
IGG0192D CSECT                                                          00021002
*                                                                       00022002
*********************************************************************** 00023002
*                                                                     * 00024002
* MODULE-NAME = IGG0192D                                              * 00025002
*                                                                     * 00026002
* DESCRIPTIVE-NAME = ISAM OPEN, QISAM LOAD MODE--INITIAL LOAD OR      * 00027002
*                    RE-LOAD                                          * 00027402
*                                                                     * 00028002
* COPYRIGHT = NONE                                                    * 00029002
*                                                                     * 00030002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00031002
*                                                                     * 00032002
* FUNCTION = CALCULATE THE VARIOUS DCB FIELDS NEEDED TO ALLOCATE      * 00033002
*            TRACK AND MASTER INDICES.  DETERMINE IF HIGH LEVEL       * 00034002
*            MASTER INDICES ARE TO BE DEVELOPED AND WHERE TO LOCATE   * 00035002
*            THEM.                                                    * 00036002
*                                                                     * 00051002
* NOTES = SEE BELOW                                                   * 00052002
*                                                                     * 00053002
*    DEPENDENCIES = NONE                                              * 00054002
*                                                                     * 00056002
*    RESTRICTIONS = NONE                                              * 00057002
*                                                                     * 00058002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES                      * 00059002
*                                                                     * 00060002
*    PATCH-LABEL = PATCH, A DC STATEMENT                              * 00061002
*                                                                     * 00062002
* MODULE-TYPE = OPEN EXECUTOR                                         * 00063002
*                                                                     * 00064002
*    PROCESSOR = ASSEMXF-370R                                         * 00065002
*                                                                     * 00066002
*    MODULE-SIZE = 992 DECIMAL BYTES                                  * 00067002
*                                                                     * 00068002
*    ATTRIBUTES = REENTRANT, PRIVILEGED                               * 00069002
*                                                                     * 00070002
* ENTRY-POINT = IGG0192D                                              * 00071002
*                                                                     * 00072002
*    PURPOSE = SEE FUNCTION                                           * 00073002
*                                                                     * 00074002
*    LINKAGE = RECEIVES CONTROL FROM ISAM OPEN EXECUTOR IGG01921      * 00075002
*              IN STORAGE PROTECT KEY 5 AND PRIVILEGED STATE.         * 00076002
*                                                                     * 00078002
* INPUT = REGISTERS ESTABLISHED ON ENTRY ARE                          * 00079002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00080002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00081002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00082002
*               PARAMETER LIST                                        * 00083002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00084002
*                                                                     * 00085002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00086002
*          UPON ENTRY TO THIS MODULE                                  * 00087002
*                                                                     * 00088002
* EXIT-NORMAL = TRANSFERS CONTROL IN STORAGE PROTECT KEY 5 TO ISAM    * 00089002
*               OPEN EXECUTOR IGG0192E IF HIGH LEVEL INDICES ARE TO   * 00090002
*               BE DEVELOPED, OTHERWISE TO IGG0192F.                  * 00091002
*                                                                     * 00092002
* EXIT-ERROR = ABEND CODE:                                            * 00093002
*              002 - CYLINDER OVERFLOW INCORRECTLY SPECIFIED OR       * 00093202
*                    NO PRIME DATA TRACKS AVAILABLE (ALL SPACE USED   * 00093402
*                    BY TRACK INDEX AND CYLINDER OVERFLOW)            * 00093602
*                                                                     * 00094002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00095002
*                                                                     * 00096002
*    ROUTINES = NONE                                                  * 00097002
*                                                                     * 00101002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00102002
*                 FORCORE - OPEN WORK AREA                            * 00103002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00105002
*                                                                     * 00107002
*    CONTROL-BLOCK = CVT, DCB COPY, DEB, AND UCB                      * 00108002
*                                                                     * 00110002
* TABLES = INDEX LOCATION TABLE                                       * 00111002
*          I/O DEVICE CHARACTERISTICS TABLE                           * 00111402
*                                                                     * 00112002
* MACROS = ABEND, MODESET, AND XCTL                                   * 00113002
*                                                                     * 00114002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00115002
*                  CHANGES SINCE VS2-3.7                              * 00116000
*C044144,A024780,A044054-044134                              @ZA30666 * 00166000
*                                                                     * 00561002
*********************************************************************** 00562002
         EJECT                                                          00563002
FORCORE  DSECT                                                          00564002
         IECDSECT                                                       00580000
*                                                                       00600000
ISLCOMON DSECT                                                          00620000
         DS    0D                                                       00640000
ISLECBA  DS    A                        FOR CP18 AND CP20               00660000
ISLIOBA  DS    CL40                                                     00680000
ISLECBB  DS    A                        FOR CP21                        00700000
ISLIOBB  DS    CL40                                                     00720000
ISLECBC  DS    A                        FOR CP19                        00740000
ISLIOBC  DS    CL40                                                     00760000
ISLAREAZ DS    CL88                     FOR CP19                        00780000
ISLIXLT  DS    CL104                    INDEX LOCATION TABLE            00800000
ISLNIRT  DS    CL3                      HHR OF DUMMY TRACK INDEX        00820000
ISLHIRT  DS    CL1                      NO INDX ENT ON PRIM DATA TRACK  00840000
ISLCBF   DS    F                        BUR CTRL PTR                    00860000
ISLBMPR  DS    CL1                      USED TO BUMP CBF TO NEXT RCD    00880000
ISLFBW   DS    CL1                      NUM BUFS SCHED TO WRITE         00900000
ISLQC    DS    H                        NUM PRIME CYLINDERS             00920000
ISLM     DS    H                        NUM ENTRIES ON LAST TRK INDEX   00940000
ISLP     DS    H                        NUM TRACKS PER CYLINDER         00960000
ISLQ     DS    H                        NUM FULL TRKS TO BE INDEXED     00980000
ISLQ1    DS    H                        NUM TOTAL TRKS TO BE INDEXED    01000000
ISLQ2    DS    H                        NUM TRACKS IN CURNT INDEX       01020000
ISLQ3    DS    H                        NUM ENTRIES IN CURNT INDEX      01040000
ISLQ4    DS    H                        NUM CYLNDRS OF MASTER INDEX     01060000
ISLR2    DS    F                        ADR OF PRIME DEV TBL ENTRY      01080000
ISLDORE  DS    CL1                      SKIP OPEN 2D INDICATOR          01100000
ISLURSAV DS    16F                      USERS REGISTERS                 01120000
ISLVRSAV DS    16F                                                      01140000
ISLIGAP  EQU   ISLCOMON+704             INTER RECORD OVERHEAD    S20201 01146020
ISLLGAP  EQU   ISLCOMON+706             LAST RECORD OVERHEAD     S20201 01152020
IHADEB   DSECT                                                          01160000
         DS    0D                                                       01180000
DEBNMSUB DS    0CL1                     NUM SUBROUTINES LOADED AT OPEN  01200000
DEBTCBAD DS    A                        TCB POINTER                     01220000
DEBAMLNG DS    0CL1                     LENGTH OF ACCESS METHOD SECTION 01240000
DEBDEBAD DS    A                        POINTER TO NEXT DEB IN TASK     01260000
DEBOFLGS DS    0CL1                     DATA SET STATUS FLAGS           01280000
DEBIRBAD DS    A                        POINTER TO IRB FOR ERROR EXIT   01300000
DEBOPATB DS    0CL1                     FILE TYPE                       01320000
DEBSYSPG DS    A                        SYSTEM PURGE CHAIN              01340000
DEBNMEXT DS    0CL1                     NUMBER OF EXTENTS CONSTRUCTED   01360000
DEBUSRPG DS    A                        USER PURGE CHAIN                01380000
DEBPRIOR DS    0CL1                     DISPATCHING PRIORITY            01400000
DEBECBAD DS    A                        POINTER TO ECB                  01420000
DEBPROTG DS    0BL1                     TASK PROTECTION FLAG            01440000
DEBDEBID DS    0BL1                     F TO IDENTIFY AS A DEB          01460000
DEBDCBAD DS    A                        POINTER TO CORRESPONDING DCB    01480000
DEBEXSCL DS    0CL1                     SCALE FOR SIZE OF DEV SECT      01500000
DEBAPPAD DS    A                        POINTER TO APPENDAGE SECTION    01520000
DEBNIEE  DS    0CL1                     NUMBER OF INDEX EXTENTS         01540000
DEBFIEAD DS    A                        ADR OF FIRST INDEX EXTENT       01560000
DEBNPEE  DS    0CL1                     NUMBER OF PRIME DATA EXTENTS    01580000
DEBFPEAD DS    A                        ADR OF FIRST PRIME DATA EXTENT  01600000
DEBNOEE  DS    0CL1                     NUMBER OF OVERFLOW EXTENTS      01620000
DEBFOEAD DS    A                        ADR OF FIRST OVFLO EXTENT       01640000
         DS    CL4                      DISABLED MODULE                 01660000
DEBDVMOD DS    0CL1                     DEVICE MODIFIER                 01680000
DEBUCBAD DS    A                        POINTER TO UCB                  01700000
DEBBINUM DS    CL2                      BB OF EXTENT                    01720000
DEBSTRCC DS    CL2                      STARTING CC                     01740000
DEBSTRHH DS    CL2                      STARTING HH                     01760000
DEBENDCC DS    CL2                      ENDING CC                       01780000
DEBENDHH DS    CL2                      ENDING HH                       01800000
DEBNMTRK DS    CL2                      NUMBER OF TRACKS IN EXTENT      01820000
         DCBD  DSORG=(IS)                                               01840000
IGG0192D CSECT                                                          01860000
START    BALR  R15,0                    ESTABLISH ADDRESSABILITY        01880000
         USING *,R15                                                    01900000
R0       EQU   0                        WORK REGISTER                   01920000
R1       EQU   1                        BASE REGISTER FOR DCB           01940000
R2       EQU   2                        DEVICE TABLE ENTRY ADDRESS      01960000
R3       EQU   3                        WORK REGISTER                   01980000
R4       EQU   4                        WORK REGISTER                   02000000
R5       EQU   5                        WORK REGISTER                   02020000
R6       EQU   6                        WORK REGISTER                   02040000
R7       EQU   7                        WORK REGISTER                   02060000
R8       EQU   8                        WORK REGISTER                   02080000
R9       EQU   9                        WORK REGISTER                   02100000
R10      EQU   10                       WORK REGISTER                   02120000
R11      EQU   11                       WORK REGISTER                   02140000
R12      EQU   12                       BASE REGISTER FOR USERS DEB     02160000
R13      EQU   13                       BASE REG FOR COMON WORK AREA    02180000
R14      EQU   14                       WORK REGISTER                   02200000
R15      EQU   15                       WORK REGISTER                   02220000
RBASE    EQU   3                        BASE REG FOR THIS MODULE        02280000
RPAR     EQU   5                        ADDRESS OF PARAMETER TABLE      02300000
RWTG     EQU   6                        ADDRESS OF WHERE-TO-GO TABLE    02320000
RPARC    EQU   7                        CURRENT PARAMETER ENTRY         02340000
RWTGC    EQU   8                        CURRENT WHERE-TO-GO ENTRY       02360000
RCORE    EQU   4                        BASE REG FOR OPEN WORK AREA     02400000
RJ       EQU   15                       WORK REGISTER                   02420000
UCBTYPE  EQU   19                       OFFSET FOR TYPE OF DEVICE       02440000
CVTPTR   EQU   16                       OFFSET FOR COMMUN VECTOR TABLE  02460000
LIDO     EQU   7                        LAST RECORD OVERHEAD     S20201 02464020
NIDO     EQU   6                        NORMAL RECORD OVERHEAD   S20201 02468020
SW       EQU   9                        DEV TBLE SW              S20201 02472020
ZEUS     EQU   X'08'                    ZEUS INDICATOR           S20201 02476020
RC2C     EQU   X'2C'                    ISAM 002 ABEND RET CODE  Y02072 02477002
HLINDOF  EQU   X'04'                    HI LEV INDEX GT 65535  @ZA30666 02478000
*********************************************************************** 02480000
*                ENTRY POINT FOR QISAM - LOAD MODE                    * 02500000
*                     ENTERED FROM OPEN MACRO                         * 02520000
*********************************************************************** 02540000
ISLFA01  EQU   *                                                        02560000
BASETAG  L     R1,0(RPARC)              R1 = ADDRESS OF DCB             02580000
         USING IHADEB,R12                                               02600000
         USING IHADCB,R1                                                02620000
         L     R13,DCBWKPT1                                             02640000
         USING ISLCOMON,R13             R13 = ADDRESS OF COMON WORK ARE 02660000
         LR    RBASE,R15                CHANGE BASE OF THIS MODULE      02680000
         L     RCORE,4(RWTGC)           RCORE = ADR OF OPEN WORK AREA   02700000
         USING FORCORE,RCORE                                            02720000
         STM   R0,R15,DXCCW1            SAVE REGISTER CONTENTS   Y02072 02740002
         LR    R0,RCORE                 SAVE OPEN W/A ADDR       Y02072 02750002
         SR    R8,R8                    CLEAR REGISTER 8                02760000
         STH   R8,DCBEXCD1              SET EXCD1 AND 2 TO ZERO         02780000
         L     R12,DCBDEBAD             R12=DEB ADDRESS                 02800000
         L     R2,DCBLRAN                DEVICE TABLE ENTRY      S20201 02890020
         IC    R8,DCBKEYLE              CALCULATE DCBHIRCM              03020000
         LA    R8,10(R8)                R8=DCBKEYLE+10                  03060000
         LH    R3,4(R2)                 R3=TRACKLENGTH                  03080000
*                                                                       03080402
         MODESET  KEYADDR=DXUKEY,WORKREG=4  SET USERS KEY        Y02072 03082002
*                                                                       03084002
         DROP  RCORE                    END OPEN WA USING        Y02072 03086002
         LH    R4,ISLLGAP               LIDO                     S20201 03090020
         LH    R6,ISLIGAP               NIDO                     S20201 03100020
         SR    R3,R4                    R3 = TRLNG - LIDO        S20201 03120020
         LR    R5,R8                    R5 = KEY + 10                   03160000
         MH    R5,10(R2)                R5=(KEYLE+10)TOL                03180000
         SRA   R5,9                     R5 DIVIDED BY 512               03200000
         AR    R5,R6                    R5 = TOL(KEYLE+10)+NIDO  S20201 03220020
         LR    R7,R3                    R7=TRLNG-LIDO                   03260000
         SR    R7,R8                    R7=TRLNG-(KEYLE+10)-LIDO        03280000
         SR    R6,R6                    CLEAR R6                        03300000
         SR    R4,R4                    CLEAR R4                 S20201 03310020
         DR    R6,R5                    DIVIDE R7 BY R5                 03320000
         LA    R9,1(R7)                 R9=NUMB INDEX ENTRIES PER TRACK 03340000
         STC   R9,ISLHIRT               SET HIRT = HIRCM         Y02072 03350002
*                                                                       03350402
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 03352002
*                                                                       03354002
         STC   R9,DCBHIRCM              SET HIRCM = R9                  03360000
         STC   R9,DCBHIRTI              SAVE HIRTI FOR RL        O19113 03390019
         IC    R4,DCBCYLOF              R4=NUMB TRACKS OF TRACK OVERFLO 03400000
         SR    R7,R7                    CLEAR WORK REGISTER      Y02072 03410002
         IC    R7,3(R2)                 NO OF TRKS PER CYL       A34907 03500020
         SR    R7,R4                    1ST TRACK OF CYL OVFL    A43218 03530021
*   CHECK IF FIRST TRACK OF CYLINDER OVERFLOW IS VALID. ABEND IF NOT.   03540021
         BNP   TOOLONG                  INVALID - BR - ABEND     A43218 03550021
         BCTR  R7,0                     R7=HH OF LAST PRIME DATA TRACK  03580000
         STH   R7,DCBLDT                LDT = 0H                        03620013
*                                                                       03660000
*        ALLOCATE TRACK INDEX      CHART FB                             03680000
*                                                                       03700000
ISLFB01  LA    R7,1(R7)                 R7=DCBLDT+1=N                   03720000
         SLA   R7,1                     R7= 2(N)                        03740000
         LA    R7,1(R7)                 R7= 2N+1                        03760000
         LA    R9,2(R9)                 R9= DCBHIRCM+2  =C+2            03780000
         SR    R6,R6                    CLEAR R6                        03800000
         SR    R10,R10                  R10=SKIP                        03820000
         DR    R6,R9                    R7=Q = NO. OF TRACKS            03840000
         IC    R9,DCBKEYLE              SET R9 = KEYLE                  03880000
         AH    R9,DCBBLKSI              R9= KEYLE+BLKSI                 03900000
         LTR   R6,R6                    TEST R                          03920000
         BC    8,ISLFB02                BRANCH IF R = 0                 03940000
         TM    DCBRECFM,X'80'           IS IT VLR?                VLR   03946018
         BZ    ISLFB01A                 YES, BYPASS SHRD TRK.     VLR   03952018
         MR    R4,R6                    R5= R(TOL(KEYLE+10)+NIDO)       03960000
         LR    R11,R3                   R11=TRLNG-LIDO                  03980000
         SR    R11,R5                   R11=REMAINDER OF TRACK          04000000
* COMPARE BLKSI+KEYLE TO TRLNG-LIDO-R(TOL(KEYLE+10)+NIDO)               04020000
         CR    R9,R11                   COMPARE K+BLK TO REMAINDER TRK  04040000
         BNH   ISLFB05                  BRANCH=TRACK IS SHAREABLE       04060000
ISLFB01A EQU   *                                                  VLR   04070018
         SH    R6,ISLC12                R6=R-2 TRACK CONTAINS 2 LESS    04080000
         BC    2,ISLFB03                BRANCH=TRACK USED       ENTRIES 04100000
         LA    R10,1(R10)               SKIP=1                          04120000
ISLFB02  BCTR  R7,0                     R7= Q-1                         04140000
         IC    R4,DCBHIRCM              SET R4 = HIRCM                  04160000
         AR    R6,R4                    R6= R+HIRCM                     04180000
ISLFB03  MVI   DCBHIRSH,X'00'           DCBHIRSH=0                      04200000
ISLFB06  EQU   *                                                        04220000
         LR    R5,R0                    OPEN WORK AREA ADDRESS   Y02072 04222002
         USING FORCORE,R5               OPEN WA ADDRESSABILITY   Y02072 04224002
*                                                                       04226002
         MODESET  KEYADDR=DXUKEY,WORKREG=5  SET USERS KEY        Y02072 04230002
*                                                                       04232002
         DROP  R5                       END OPEN WORK AREA USING Y02072 04234002
         STC   R6,ISLNIRT+2            STORE R IN WORK AREA NIRT        04240000
         STH   R7,ISLNIRT              STORE Q IN WORK AREA NIRT        04260000
*                                                                       04262002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 04270002
*                                                                       04272002
         SR    R5,R5                    CALCULATE DCBNCRHI=CORE FOR INX 04280000
         IC    R5,DCBHIRCM              R5=NO OF INDICES PER TRACK      04300000
         MR    R4,R7                    R5=HIRCM(Q)                     04320000
         AR    R5,R6                    R5=R+Q(HIRCM)                   04340000
         MR    R4,R8                    R5=(KEYLE+10)(R+Q(HIRCM))       04360000
         STH   R5,DCBNCRHI                                              04380000
*********************************************************************** 04400000
* TEST THE CALCULATED VALUE FOR HIGH-LEVEL INDEX IN STORAGE. IF THE   * 04400700
* AMOUNT IS GREATER THAN 65535, INDICATE THIS CONDITION BY TURNING    * 04401400
* ON X'04' IN DSCOPTCD. THIS BIT WILL BE TESTED DURING BISAM OPEN,    * 04402400
* AND IF ON, THE INDEX WILL NOT BE READ INTO STORAGE.                 * 04403400
*********************************************************************** 04404400
         LTR   R4,R4                    PRODUCT GT 32 BITS?    @ZA30666 04405400
         BP    GT65535                  YES-TURN ON INDICATOR  @ZA30666 04406400
         SRL   R5,16                    SHIFT OUT 65535        @ZA30666 04407400
         LTR   R5,R5                    SIZE GT 65535?         @ZA30666 04408400
         BZ    LT65536                  NO-BYPASS              @ZA30666 04409400
GT65535  LR    RCORE,R0                 O/C/EOV WORK AREA      @ZA30666 04410400
         USING FORCORE,RCORE            OPEN WA ADDRESSABILITY @ZA30666 04411400
         OI    DSCOPTCD,HLINDOF         INDICATE TO USER       @ZA30666 04412400
         DROP  RCORE                    END OPEN WA USING      @ZA30666 04413400
LT65536  CLI   DCBHIRSH,X'00'           TEST IF SHARED         @ZA30666 04414400
         BC    8,ISLFB04                BRANCH=NOT SHARED               04420000
         LA    R6,1(R6)                 CALCULATE FIRSH HHR OF 1ST DATA 04440000
         STC   R6,DCBFIRSH+2                             RCD ON CYL     04460000
         STH   R7,DCBFIRSH                                              04480000
         B     ISLFC01                                                  04500000
ISLFB04  MVI   DCBFIRSH+2,X'01'         CALC FIRSH - TRACK NOT SHARED   04520000
         LA    R7,1(R7)                 R=01                            04540000
         AR    R7,R10                   ADD R10 IF SKIPPED TRACK        04560000
         STH   R7,DCBFIRSH              INSERT FIRSH HH                 04580000
         B     ISLFC01                                                  04600000
*                                       CALC HIRSH - SHAREABLE TRACK    04620000
ISLFB05  SR    R11,R9                   R11=TRACK BALANCE               04640000
         LR    R5,R9                    R5= BLKSI+KEYLE                 04660000
         MH    R5,10(R2)                R5= TOL(BLKSI+KEYLE)            04680000
         SRA   R5,9                     DIVIDE BY 512 FOR TOLERANCE     04700000
         LR    R10,R0                   OPEN WORK AREA ADDRESS   Y02072 04702002
         USING FORCORE,R10              OPEN WORK AREA ADDR      Y02072 04704002
*                                                                       04706002
         MODESET  KEYADDR=DXUKEY,WORKREG=10  SET USERS KEY       Y02072 04710002
*                                                                       04720002
         DROP  R10                      END OPEN WORK AREA USING Y02072 04730002
         AH    R5,ISLIGAP               R5=TOL(BLKSI+KEY)+NIDO   S20201 04740020
*                                                                       04742002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 04750002
*                                                                       04760002
         SR    R10,R10                  CLEAR WORK REGISTER             04780000
         DR    R10,R5                   REMAINDER/DATA RCD              04800000
         LA    R11,1(R11)                   + 1                         04820000
         AR    R11,R6                       + REMAINDER                 04840000
         STC   R11,DCBHIRSH                 = HIRSH                     04860000
         SR    R10,R10                  CLEAR WORK REGISTER             04880000
         B     ISLFB06                                                  04900000
*                                                                       04920000
*        CHART FC                                                       04940000
ISLFC01  EQU   *                        *                        A43218 05020021
*   TEST FOR BAD ALLOCATION (NO ROOM FOR PRIME DATA).                   05100021
         CLC   DCBLDT,DCBFIRSH          IS PRIME IN OVERFLOW     A43218 05180021
         BL    TOOLONG                  YES - ALLOCATION INVALID A43218 05260021
         MVI   DCBNLEV,X'00'            SET NLEV TO ZERO         A43218 05340021
         IC    R10,DEBNPEE              NO OF PRIME DATA EXTENT ENTRIES 05440000
         L     R4,DEBFPEAD              ADDR OF 1ST PRIME EXTENT ENTRY  05460000
         SR    R5,R5                    CLEAR WORK REGISTER             05480000
         STH   R5,DCBRORG2              SET RORG2 = ZERO                05500000
         LR    R3,R0                    OPEN WORK AREA ADDRESS   Y02072 05502002
         USING FORCORE,R3               WORK AREA ADDRESSABILITY Y02072 05504002
*                                                                       05506002
         MODESET  KEYADDR=DXUKEY,WORKREG=3  SET USERS KEY        Y02072 05510002
*                                                                       05512002
         DROP  R3                       END OPEN WORK AREA USING Y02072 05514002
         MVC   ISLQC(2),DCBNBOV         ISLQC=NO. OF PRIME CYLS         05520000
*                                                                       05522002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 05530002
*                                                                       05532002
         STH   R5,DCBNBOV               CLEAR NBOV                      05540000
ISLFC02  AH    R5,10(R4)                ADD ENDCC                       05920000
         SH    R5,6(R4)                 SUBTRACT STARTCC                05940000
         LA    R5,1(R5)                      +1                         05960000
         LA    R4,16(R4)                NEXT EXTENT ENTRY               05980000
         BCT   R10,ISLFC02                                              06000000
         LR    R3,R0                    OPEN WORK AREA ADDRESS   Y02072 06002002
         USING FORCORE,R3               WORK AREA ADDRESSABILITY Y02072 06004002
*                                                                       06006002
         MODESET  KEYADDR=DXUKEY,WORKREG=3  SET USERS KEY        Y02072 06010002
*                                                                       06012002
         DROP  R3                       END WORK AREA USING      Y02072 06014002
         STH   R5,ISLQC                 STORE NO OF PRIME CYLS          06020000
*                                                                       06020402
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 06022002
*                                                                       06032002
         CLC   DEBSTRCC(3),DEBENDCC     TEST STRCCH VS ENDCCH     13539 06046015
         BNE   ISLFC03                  BRANCH IF GTR THAN 1 CYL  13539 06066015
         CLI   DEBNPEE,X'01'            TEST GTR 1 EXTENT               06120000
         BC    2,ISLFC03                BRANCH = GTR 1 EXTENT           06140000
         XC    DCBFTHI+1(2),DCBFTHI+1   SET BB TO ZERO           A34907 06160020
         MVC   DCBFTHI+3(4),DEBSTRCC    STORE DCBFTHI CCHH        13539 06190015
         MVI   DCBFTHI,X'01'            DCBFTHI M = 1                   06220000
         LR    R3,R0                    OPEN WORK AREA ADDRESS   Y02072 06222002
         USING FORCORE,R3               WORK AREA ADDRESSABILITY Y02072 06224002
*                                                                       06226002
         MODESET  KEYADDR=DXUKEY,WORKREG=3  SET USERS KEY        Y02072 06230002
*                                                                       06232002
         DROP  R3                       END OPEN WA USING        Y02072 06234002
         MVI   ISLDORE,X'E5'            E5 INDICATES ONLY 1 CYL         06240000
*                                                                       06242002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 06250002
*                                                                       06250402
         LR    RCORE,R0                 GET OPEN W/A ADDR        Y02072 06252002
         USING FORCORE,RCORE            OPEN WA ADDRESSABILITY   Y02072 06254002
         LM    R0,R15,DXCCW1            RESTORE REGISTERS        Y02072 06260002
         DROP  RCORE                    END OPEN WORK AREA USING Y02072 06270002
         MVC   0(L'LOAD2F,RWTGC),LOAD2F INITIALIZE WHERE-TO-GO   Y02072 06280002
         B     ISLFC04F                                                 06300000
ISLFC03  EQU   *                        MORE THAN 1 CYL IN DATA SET     06320000
         MVI   DCBNLEV,X'01'            SET NLEV TO INDICATE A CLY INDX 06340000
         LR    R3,R0                    OPEN WORK AREA ADDRESS   Y02072 06342002
         USING FORCORE,R3               OPEN WA ADDRESSABILITY   Y02072 06344002
*                                                                       06346002
         MODESET  KEYADDR=DXUKEY,WORKREG=3  SET USERS KEY        Y02072 06350002
*                                                                       06352002
         DROP  R3                       END OPEN WORK AREA USING Y02072 06354002
         LA    R5,ISLIXLT               R5 POINTS TO INDEX LOCATION TBL 06360000
         MVC   ISLQ3(2),ISLQC           SET Q3 TO C = NO PRIME DATA CYL 06380000
         SR    R3,R3                    CLEAR WORK REGISTER             06400000
         L     R4,DEBFIEAD              TEST IF SEPARATE INDEX AREA     06420000
         CR    R3,R4                                                    06440000
         BNE   ISLFEH1                  BRANCH = SEPARATE INDEX AREA    06460000
         L    R4,DEBFOEAD                                               06480000
         CR    R3,R4                                                    06500000
         BNE   ISLFEH1                  BRANCH = SEP OVFLO AREA SA69202 06520002
         MVI   ISLDORE,X'E1'            E1=ONLY PRIME EXTENTS IN        06540000
         B     ISLFC04                    DATA SET                      06560000
***                                                                 *** 06580000
* CHART FE-H1-4  THIS SECTION ENTERED WHEN INDICES NOT IN PRIME AREA  * 06600000
***                                                                 *** 06620000
ISLFEH1  L     R8,DEBFPEAD              R8=ADR OF 1ST PRIME EXTENT      06640000
         L     R6,0(R8)                 R6=ADR OF PRIME UCB             06660000
*                                       R4=ADR OF 1ST INDEX EXTENT      06680000
         L     R7,0(R4)                 R7=ADR OF INDEX UCB             06700000
         CLC   19(1,R6),19(R7)                                          06720000
         BNE   ISLFEH1A                 BRANCH-INDEX AND PRIME NOT      06740000
*                                           ON SAME DEVICE              06760000
         CLC   4(2,R8),4(R4)            PRIME BB VS INDEX BB            06780000
         BE    ISLFEH11                 BRANCH-INDEX AND PRIME          06800000
*                                           ON SAME DEVICE              06820000
ISLFEH1A SR    R2,R2                    CLEAR REGISTER           A34907 06840020
         IC    R2,UCBTYPE(R7)           GET DEVICE TYPE FOR      A34907 06860020
         STC   R2,ISLAREAZ+86           SAVE DEVICE TYPE                06880000
         L     R4,CVTPTR                R4 = COMMUNICATION VECTOR TBL   06900000
         L     R6,64(R4)                R6= PTR TO I/O DEVIDE TABLE     06920000
         IC    R3,0(R2,R6)              R2=DEVICE TBL ENTRY FOR INDEX   06940000
         LA    R2,0(R6,R3)                                              06960000
         SR    R3,R3                    CLEAR WORK REGISTER             06980000
         IC    R3,DCBKEYLE              R3 = KEYLE                      07000000
         LA    R3,10(R3)                R3=KEYLE + 10                   07020000
         LH    R7,4(R2)                 R7=TRLNG                        07040000
         SR    R4,R4                    CLEAR REG                S20201 07050020
         SR    R6,R6                    CLEAR REG                S20201 07060020
         IC    R4,LIDO(R2)              LIDO - NON ZEUS          S20201 07070020
         IC    R6,NIDO(R2)              NIDO - NON ZEUS          S20201 07080020
         TM    SW(R2),ZEUS              IF ZEUS CHANGE OVERHEADS S20201 07085020
         BZ    NOTZEUSZ                 NOT ZEUS - BR            S20201 07090020
         LH    R4,NIDO(R2)              LIDO AND NIDO            S20201 07095020
         LR    R6,R4                    *                        S20201 07100020
NOTZEUSZ EQU   *                        *                        S20201 07105020
         SR    R7,R4                    *                        S20201 07110020
         SR    R7,R3                    R7=TRLNG-LIDO-(KEYLE+10)        07120000
         MH    R3,10(R2)                R3=TOL(KEYLE+10)                07140000
         SRA   R3,9                     DIVIDE BY 512 FOR TOLERANCE     07160000
         AR    R3,R6                    R3 = TOL(KEYLE+10)+NIDO  S20201 07180020
         SR    R6,R6                    CLEAR R6                        07220000
         DR    R6,R3                    DIVIDE R7 BY R3                 07240000
         LA    R7,1(R7)                 R7= DCBHIRCM                    07260000
*                                                                       07262002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 07270002
*                                                                       07272002
         STC   R7,DCBHIRCM                                              07280000
         LR    R7,R0                    OPEN WORK AREA ADDRESS   Y02072 07282002
         USING FORCORE,R7               OPEN WA ADDRESSABILITY   Y02072 07284002
*                                                                       07286002
         MODESET  KEYADDR=DXUKEY,WORKREG=7  SET USERS KEY        Y02072 07290002
*                                                                       07300002
         DROP  R7                       END OPEN WORK AREA USING Y02072 07302002
ISLFEH11 SR    R7,R7                    CLEAR WORK REGISTER       13539 07310015
         IC    R7,DEBNIEE               R7=NO OF INDEX EXTENTS          07340000
         SR    R9,R9                    CLEAR WORK REGISTER       13539 07380015
         LTR   R7,R7                    INDEX EXTENT ALLOC      SA69202 07390002
         BNZ   ISLFEH3                  YES                     SA69202 07392002
         IC    R7,DEBNOEE               R7=NO OF OVFLO EXTENTS  SA69202 07394002
ISLFEH3  EQU   *                        SET ILT END M = NO OF EXTENTS   07396002
         IC    R9,DEBNPEE               R9=NUM PRIME EXTENTS            07400000
         AR    R7,R9                    R7=NUM PRIME+NUM INDEX = M OF   07420000
         STC    R7,17(R5)                 FIRST INDEX LOC TBL ENTRY     07440000
         BCTR  R7,0                                                     07460000
         SLL   R7,4                     SETUP MBBCCHH OF END ADR IN ILT 07480000
         LA    R8,DEBUCBAD              R9=ADR OF 1ST ENTENT ENTRY      07500000
         AR    R8,R7                    R8=ADR OF LAST EXTENT ENTRY     07520000
         XC    18(2,R5),18(R5)          SET ILT END BB=0                07540000
         MVC   20(4,R5),10(R8)          SET ILT END CCHH                07560000
ISLFEH4  LH    R7,ISLQC                 C = NUM PRIME DATA CYLINDERS    07580000
         LA    R7,1(R7)                 SET Q3 = C +1                   07600000
         STH   R7,ISLQ3                                            FEJ2 07620000
         SR    R7,R7                    CLEAR WORK REGISTER      Y02072 07630002
ISLFEH5  IC    R7,3(R2)                 R7 = NO OF TRKS PER CYL  A27803 07760019
ISLFEH55 STC   R7,ISLP+1                ISLP = TRACKS PER CYL    A27803 07780019
         MVI   ISLDORE,X'13'            13 = INDICES NOT IN PRIME AREA  07800000
*                                                                       07802002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 07810002
*                                                                       07812002
         ST    R8,DCBWKPT5              SAVE PTR TO EXTENT              07820000
         LR    R3,R0                    OPEN WORK AREA ADDRESS   Y02072 07822002
         USING FORCORE,R3               OPEN WA ADDRESSABILITY   Y02072 07824002
*                                                                       07826002
         MODESET  KEYADDR=DXUKEY,WORKREG=3  SET USERS KEY        Y02072 07830002
*                                                                       07832002
         DROP  R3                       END OPEN WA USING        Y02072 07834002
         B     ISLFC04                                                  07840000
ISLFEH2  LR    R7,R3                    INDICES WILL BE IN OVFLO   FEH4 07860000
         IC    R7,DEBNOEE               R7=NO OF OVFLO EXTENTS          07880000
         B     ISLFEH3                                                  07900000
ISLFC04  EQU   *                                                        07920000
         ST    R2,ISLQ                  SAVE PTR TO IO DEVICE TABLE     07940000
*                                                                       07942002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 07950002
*                                                                       07950402
         LR    RCORE,R0                 RESTORE OPEN W/A ADDR    Y02072 07952002
         USING FORCORE,RCORE            OPEN WA ADDRESSABILITY   Y02072 07954002
         LM    R0,R15,DXCCW1            RESTORE REGISTERS        Y02072 07960002
         USING BASETAG,RBASE                                            07980002
         MVC   0(L'LOAD2E,RWTGC),LOAD2E INITIALIZE WHERE-TO-GO   Y02072 07990002
ISLFC04F EQU   *                                                        08020000
*                                                                       08021202
         MODESET  KEYADDR=DXUKEY,WORKREG=10  SET USERS KEY       Y02072 08022002
*                                                                       08024002
         MVI   ISLAREAZ+87,X'FF'        ASSUME NOT A 2301        A34907 08030020
*                                                                       08040002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 08080002
*                                                                       08090002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       08100000
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       08120000
         CLC   0(2,RWTGC),THISLOAD                                      08140000
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 08160000
         CLC   0(2,RWTGC),OPNLOD7       TEST FOR END OF WTG TABLE       08180000
         BC    7,RELOOP                 BRANCH=NOT AT END               08200000
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                08220000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                08240000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              08260000
         BC    7,TCTLRTN                BRANCH = NOT ZERO               08280000
ITSZERO  LA    RWTGC,8(RWTGC)                                           08300000
         LA    RPARC,4(RPARC)                                           08320000
         B     ZCHECK                                                   08340000
TCTLRTN  EQU   *                                                        08360000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         08380000
         LA    RJ,DXCCW12                                               08420000
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 08440002
TOOLONG  EQU   *                                                  13539 08450015
         LA    R15,RC2C                 ISAM RETURN CODE         Y02072 08451002
         ABEND X'002',DUMP,,SYSTEM      SYSTEM 002 ABEND         Y02072 08470002
         DS    0F                                                       08480000
CONF8    DC    X'FFFFFFF8'                                              08500000
ISLC12   DC    H'2'                                              M4536  08570019
OPNLOD7  DC    C'0S'                                              VLR   08620000
THISLOAD DC    C'2D'                                              VLR   08630000
*                                                                       08660000
LOAD2E   DC    C'2E'                    ID OF MODULE IGG0192E    Y02072 08710002
LOAD2F   DC    C'2F'                    ID OF MODULE IGG0192F    Y02072 08720002
*                                                                       08760002
MODID    DC    C'IGG0192D'              MODULE NAME            @ZA30666 08810000
DATE     DC    CL8'&SYSDATE'            COMPILATION DATE       @ZA30666 08860000
FIX      DC    C'OZ30666'               LATEST FIX             @ZA30666 08910000
PATCH    DC    50X'00'                  ZEROED PATCH AREA        Y02072 08960000
         END                                                            09010000
