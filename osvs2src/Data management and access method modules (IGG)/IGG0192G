         TITLE 'IGG0192G - OPEN, QISAM LOAD MODE'                       00020000
IGG0192G CSECT                                                          00021002
*                                                                       00022002
*        OS/VS2 RELEASE 3 CHANGES                                       00022400
* D0904000                                                      ZA02668 00022800
*********************************************************************** 00023002
*                                                                     * 00024002
* MODULE-NAME = IGG0192G                                              * 00025002
*                                                                     * 00026002
* DESCRIPTIVE-NAME = OPEN, QISAM LOAD MODE--INITIAL LOAD, OR RE-LOAD  * 00027002
*                                                                     * 00028002
* COPYRIGHT = NONE                                                    * 00029002
*                                                                     * 00030002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00031002
*                                                                     * 00032002
* FUNCTION = PERFORM GENERAL INITIALIZATION FOR LOAD MODE.  SET UP    * 00033002
*            THE BUFFER CONTROL TABLE, INITIALIZE THE COUNT FIELDS,   * 00038002
*            SET UP CBF, EOB, BMPR, AND FBW.  SET DCBMSWA TO THE      * 00039002
*            MBBCCHH OF THE NEXT TO LAST TRACK IN THE PRIME DATA AREA * 00040002
*            ALSO INITIALIZE THE RECORD MOVING LOGIC AND AREA Y.      * 00041002
*                                                                     * 00042002
* NOTES = SEE BELOW                                                   * 00043002
*                                                                     * 00044002
*    DEPENDENCIES = NONE                                              * 00045002
*                                                                     * 00046002
*    RESTRICTIONS = NONE                                              * 00047002
*                                                                     * 00048002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00049002
*                                                                     * 00050002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00051002
*                                                                     * 00052002
* MODULE-TYPE = OPEN EXECUTOR                                         * 00053002
*                                                                     * 00054002
*    PROCESSOR = ASSEMXF-370R                                         * 00055002
*                                                                     * 00056002
*    MODULE-SIZE = 1102 DECIMAL BYTES                                 * 00057002
*                                                                     * 00058002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00059002
*                                                                     * 00060002
* ENTRY-POINT = IGG0192G                                              * 00061002
*                                                                     * 00062002
*    PURPOSE = SEE FUNCTION                                           * 00063002
*                                                                     * 00064002
*    LINKAGE = RECEIVES CONTROL FROM ISAM OPEN EXECUTOR IGG0192F      * 00065002
*              IN STORAGE PROTECT KEY 5 AND PRIVILEGED STATE.         * 00066002
*                                                                     * 00068002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00069002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00070002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00071002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00072002
*               PARAMETER LIST                                        * 00073002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00074002
*                                                                     * 00075002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00076002
*          UPON ENTRY TO THIS MODULE                                  * 00077002
*                                                                     * 00078002
* EXIT-NORMAL = TRANSFERS CONTROL IN STORAGE PROTECT KEY 5 VIA XCTL   * 00079002
*               TO IGG0195T IF FULL TRACK INDEX WRITE OPTION,         * 00079202
*               OTHERWISE TO IGG0192U IF WRITE CHECK, OR IGG0192R IF  * 00079402
*               WRITE CHECK NOT SPECIFIED.                            * 00079602
*                                                                     * 00080002
* EXIT-ERROR = ABEND CODE:                                            * 00081002
*              036 - NO PRIME DATA AREA AVAILABLE                     * 00083002
*                                                                     * 00086002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00087002
*                                                                     * 00088002
*    ROUTINES = NONE                                                  * 00089002
*                                                                     * 00091002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00092002
*                 FORCORE - OPEN WORK AREA                            * 00093002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00094002
*                                                                     * 00095002
*    CONTROL-BLOCK = DCB COPY, AND DEB                                * 00096002
*                                                                     * 00097002
* TABLES = NONE                                                       * 00098002
*                                                                     * 00099002
* MACROS = ABEND, MODESET, AND XCTL.                                  * 00100002
*                                                                     * 00101002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00102002
*                                                                     * 00103002
*                                                                     * 01041002
*********************************************************************** 01042002
         EJECT                                                          01043002
********************                                                    01044002
* DCB REFERENCE    *                                                    01060000
********************                                                    01080000
         DCBD  DSORG=(IS)                                               01100000
         USING IHADCB,R1                                                01120000
         EJECT                                                          01140000
****************************                                            01150000
* OPEN WORK AREA REFERENCE *                                            01152000
****************************                                            01154000
FORCORE  DSECT                                                   Y01021 01156000
         IECDSECT                                                Y01021 01158000
         EJECT                                                          01158400
********************                                                    01160000
* DEB REFERENCE    *                                                    01180000
********************                                                    01200000
*                                                                       01220000
IHADEB   IGGDEBD                                                 Y02072 01240002
         USING IHADEB,R8                                                01260000
         EJECT                                                          01940000
*********************************************************************** 01960000
* ISLCOMON REFERENCE     C(DCBWKPT1)=A(ISLCOMMON)                     * 01980000
*********************************************************************** 02000000
*                                                                       02020000
ISLCOMON DSECT                                                          02040000
         USING ISLCOMON,R12                                             02060000
         DS    0D                                                       02080000
ISLECBA  DS    A                        FOR CP18 AND CP20               02100000
ISLIOBA  DS    CL40                                                     02120000
ISLECBB  DS    A                        FOR CP21                        02140000
ISLIOBB  DS    CL40                                                     02160000
ISLECBC  DS    A                        FOR CP19                        02180000
ISLIOBC  DS    CL40                                                     02200000
ISLAREAZ DS    CL88                     FOR CP19                        02220000
ISLIXLT  DS    CL104                    INDEX LOCATION TABLE            02240000
ISLNIRT  DS    CL3                      HHR OF DUMMY TRACK INDEX        02260000
ISLHIRT  DS    CL1                      NO INDX ENT ON PRIM DATA TRACK  02280000
ISLCBF   DS    F                        BUF CTRL PTR (RCD WITHIN BUF)   02300000
ISLBMPR  DS    F                        USED TO BUMP CBF TO NEXT RCD    02320000
ISLFBW   DS    F                        NO OF BUFS SCHED TO WRITE       02340000
ISLEOB   DS    F                        END OF BUFFR ADR                02360000
ISLNCNT  DS    CL8                      NORMAL IX COUNT, CCHHRKDD       02380000
ISLOCNT  DS    CL8                      OVFLOL IX COUNT, CCHHRKDD       02400000
ISLDCNT  DS    CL8                      DUMMY IX COUNT,  CCHHRKDD       02420000
ISLNDAT  DS    CL10                     NORMAL IX DATA, MBBCCHHRFP      02440000
         DS    CL2                                                      02460000
ISLODAT  DS    CL10                     OVFLOW IX DATA, MBBCCHHRFP      02480000
         DS    CL1                                                      02500000
ISLBUFNO DS    CL1                      DCBBUFNO OR 2                   02520000
ISLBUFN  DS    F                        ADDR OF SLOT N IN BCT           02540000
ISLMVC   DS    F                        COUNT OF EXECUTED MOVE (N-1)    02560000
ISLMVCT  DS    F                        NOMBR OF 255 BYTE MOVES (N+1)   02580000
ISLVRSAV DS    18F                      ISL SAVE AREA                   02600000
ISLAPSAV DS    10F                      APPENDAGE SAVE AREA             02620000
ISLWRSAV DS    16F                      ISL SAVE AREA FOR CLOSE         02640000
*                                                                       02660000
TSTWK1C  DS    F                        WORK AREA FOR FORMAT 000N       02680000
TSTWK2C  DS    F                        WORK AREA FOR FORMAT 00NN       02700000
         DS    F                                                        02720000
ISLNOENT DS    F                        NO ENTRIES REMAINING ON TRACK   02740000
ISLOFFST DS    F                        SIZE OF WR CKD INSTR IN BYTES   02760000
ISLD     DS    F                        DISCPLACEMENT FROM CP18 START   02780000
ISLFSTBF DS    F                        ADDR OF 1ST SCHED BUF (REL)     02800000
ISLLSTBF DS    F                        ADDR OF LAST SCHED BUF (REL)    02820000
ISLCCFAD DS    F                        ADDR OF CC FLAG IN CP18         02840000
ISLKEYAD DS    F                        ADDR OF KEY OF LAST RCD ON TRK  02860000
*                                                                       02880000
CL1AD    DS    F                        ADDR CP18 SKLTN                 02900000
CM1AD    DS    F                        ADDR CP19 SKLTN                 02920000
CQ1AD    DS    F                        ADDR CP20 SKLTN                 02940000
CQT1AD   DS    F                        ADDR CP20 WR CHK EXTN           02960000
CQ40AD   DS    F                        ADDR CP21 SKLTN          O19110 02980019
CQ45AD   DS    F                        ADDR CP21 WR CHK EXTN    O19110 03000019
*                                                                       03020000
         SPACE 3                                                        03040002
*                                                                       03060000
* ISLVPTRS REFERENCE       C(DCBWKPT6)=A(ISLVPTRS)                      03080000
*                                                                       03100000
ISLVPTRS EQU   *                                                  25463 03110018
ISLVPTR1 DS    A                        A(AREA Y)                 25463 03120018
ISLVPTR2 DS    A                        A(KEYSAVE)                25463 03130018
ISLVPTR3 DS    A                        A(IOBBCT)                 25463 03140018
ISLVPTR4 DS    A                        A(CP18)                   25463 03150018
ISLVPTR5 DS    A                        A(CP19)                   25463 03160018
ISLVPTR6 DS    A                        A(CP20)                   25463 03170018
ISLVPTR7 DS    A                        A(CP21)                   25463 03180018
ISLVPTR8 DS    A                        SIZE OF ISLCOMON AREA     25463 03190018
ISLVPTR9 DS    A                        SIZE OF CHAN PROG AREA    25463 03200018
ISLVPTRA DS    A                        ADDRESS OF BAD BUFFER     25463 03210018
*                                       A(TRACK INDEX SAVE AREA)        03217019
*                                       BIT 0-FULL TRK INDX WRITE       03224019
*                                       BIT 1-SUCCESSFUL GETMAIN        03231019
ISLVPTRB DS    A                        A(CP20B)-FULL TRK INDX   O19110 03238019
*                                       WR                       O19110 03245019
ISLVPTRC DS    A                        A(CP20C)-FULL TRK INDX   O19110 03252019
*                                       WR                       O19110 03259019
ISLFXWK1 DS    F                        WORK AREA                 13711 03268016
ISLFXWK2 DS    F                        WORK AREA                 13711 03272016
ISLF9WK1 DS    F                        WORK AREA                 13711 03276016
*                                                                       03280000
*                                                                       03300000
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03320000
*                                                                       03340000
IOBBCT   DSECT                                                          03360000
         USING IOBBCT,R11                                               03380000
         DS    0D                                                       03400000
IOBFLAGS DS    0CL1                     FLAGS                           03420000
IOBPTRA  DS    A                        PTR A                           03440000
IOBB     DS    0CL1                     B                               03460000
IOBPTRB  DS    A                        PTR B                           03480000
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03500000
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03520000
         EJECT                                                          03540000
********************                                                    03560000
* IOB REFERENCE    *                                                    03580000
********************                                                    03600000
*                                                                       03620000
IHAIOB   DSECT                                                          03640000
         USING IHAIOB,R2                                                03660000
         DS    0D                                                       03680000
IOBFLG1  DS    CL1                      FLAGS 1                         03700000
IOBFLG2  DS    CL1                      FLAGS 2                         03720000
AIOBSENS DS    CL2                      SENSE BYTES              Y01021 03760000
IOBECBAD DS    A                        ECB POINTER                     03780000
AIOBCSW  DS    CL8                      CHANNEL STATUS WORD      Y01021 03800000
AIOBSIOC DS    0CL1                     SIO CC                   Y01021 03820000
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       03840000
IOBWT    DS    0CL1                     WEIGHT                          03860000
IOBDCBAD DS    A                        DCB POINTER                     03880000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     03900000
IOBBCTI  DS    CL2                      BLK CTR INCR                    03920000
IOBECT   DS    CL2                      ERROR CTR                       03940000
IOBDADAD DS    CL8                      DIR ACESS DEV ADR MBBCCHHR      03960000
*                                                                       03980000
         EJECT                                                          04000000
**********************************************************************  04020000
* ISL PUT OPEN #1                                                     * 04040000
**********************************************************************  04060000
*                                                                       04080000
IGG0192G CSECT                                                          04120000
TSTF800  BALR  R15,0                                                    04140000
         USING *,R15                                                    04160000
BASETAG  L     R1,0(RPARC)                                              04180000
         L     RCORE,4(RWTGC)                                           04200000
         L     R12,DCBWKPT1                                             04220000
         LR    RBASE,R15                                                04240000
         USING FORCORE,RCORE                                     Y02072 04250002
         STM   R0,R15,DXCCW1            SAVE REGISTERS           Y02072 04260002
         LR    R0,RCORE                 SAVE OPEN W/A ADDR       Y02072 04270002
         L     R10,DXUDCBAD             ADDRESS OF USERS DCB     Y02072 04280002
*                                                                       04300000
* EQUATE SYMBOLIC REGISTERS                                             04320000
*                                                                       04340000
R0       EQU   0                                                        04360000
R1       EQU   1                                                        04380000
R2       EQU   2                                                        04400000
R3       EQU   3                                                        04420000
R4       EQU   4                                                        04440000
R5       EQU   5                                                        04460000
R6       EQU   6                                                        04480000
R7       EQU   7                                                        04500000
R8       EQU   8                                                        04520000
R9       EQU   9                                                        04540000
R10      EQU   10                                                       04560000
R11      EQU   11                                                       04580000
R12      EQU   12                                                       04600000
R13      EQU   13                                                       04620000
R14      EQU   14                                                       04640000
R15      EQU   15                                                       04660000
RBASE    EQU   3                                                        04680000
RCORE    EQU   4                                                        04700000
RPAR     EQU   5                                                        04720000
RWTG     EQU   6                                                        04740000
RPARC    EQU   7                                                        04760000
RWTGC    EQU   8                                                        04780000
RJ       EQU   15                                                       04880000
VLR      EQU   X'40'                    VARIABLE LENGTH RECFM    M2674  04910020
ONE      EQU   1                        CONSTANT OF 1            XM0863 04912002
TWO      EQU   2                        CONSTANT OF 2            XM0863 04914002
THREE    EQU   3                        CONSTANT OF 3            XM0863 04916002
FOUR     EQU   4                        CONSTANT OF 4            XM0863 04918002
FIVE     EQU   5                        CONSTANT OF 5            XM0863 04918402
SIX      EQU   6                        CONSTANT OF 6            XM0863 04918802
TEN      EQU   10                       CONSTANT OF 10           XM0863 04919202
MCCH     EQU   X'07'                    MASK TO STORE CCH        Y02072 04920002
         EJECT                                                          04940000
*                                                                       04960000
* OPEN HOUSEKEEPING FOR PUT                                             04980000
*                                                                       05000000
         MODESET  KEYADDR=DXUKEY,WORKREG=2  SET USERS KEY        Y02072 05010002
*                                                                       05010402
         DROP  RCORE                    END OPEN WORK AREA USING Y02072 05012002
TSTHSK   LA    R2,ISLIOBA               C(R2)=A(IOBA)                   05020000
         L     R11,ISLVPTR3             C(R11)=A(BCT)                   05060000
*                                                                       05100000
* SET ISLBUFNO = DCBBUFNO OR 2                                          05120000
*                                                                       05140000
         MVC   ISLBUFNO(1),DCBBUFNO     SET ISLBUFNO = DCBBUFNO         05160000
*                                                                       05162002
*   DONT'T ALLOW LOAD MODE TO SCHEDULE TOO LONG A CHANNEL PROGRAM       05164001
*   BY LIMITING THE NUMBER OF BUFFERS THAT CAN BE USED AT ONE TIME.     05166001
K30      EQU   30                       LARGEST NUMBER BUFFERS          05168001
         CLI   ISLBUFNO,K30             BUFNO TO BIG                    05170001
         BNH   NOTBIG                   NO LEAVE IT                     05172001
         MVI   ISLBUFNO,K30             RESTRICT IT                     05174001
NOTBIG   EQU   *                        *                               05176001
         CLI   ISLBUFNO,X'00'           TEST ISLBUFNO VS ZERO           05180000
         BNE   TSTHK005                 B IF NOT 0                      05200000
         MVI   ISLBUFNO,X'02'           SET ISLBUFNO = 2                05220000
*                                                                       05240000
* INITIALIZE BCT                                                        05260000
*                                                                       05280000
*  1. SET UP KDD IN REG 6                                               05300000
*                                                                       05320000
TSTHK005 SR    R6,R6                                                    05340000
         ST    R6,TSTWK1C               CLEAR TSTWK1C            O19110 05350019
         IC    R6,DCBKEYLE              C(R6)=IL, 000K                  05360000
         LH    R7,DCBBLKSI              C(R7)=00DD                      05380000
         SLL   R7,16                    C(R7)=DD00                      05400000
         SLDL  R6,16                    C(R6)=0KDD                      05420000
*                                                                       05440000
*  2. SET UP BCT, STORRING 0KDD IN BUFF CNT +4 AT SAME TIME             05460000
*                                                                       05480000
         SR    R3,R3                                                    05500000
         IC    R3,ISLBUFNO              C(R3)=NO OF BUFFRS              05520000
         LA    R4,8(R11)                C(R4)=A(SLOT 1)                 05540000
         ST    R4,0(R11)                STORE A(SLOT 1) AT PTRA         05560000
         ST    R4,4(R11)                STORE A(SLOT 1) AT PTRB         05580000
         L     R5,DCBBUFCB              C(R5)=A(BUFF POOL CTRL BLK)     05600000
         L     R5,0(R5)                 C(R5)=A(BUF1)                   05620000
         LA    R5,0(R5)                 DELETE HIGH ORDER BYTE    10284 05630016
         TM    DCBRECFM,VLR             IS VLR SPECIFIED         M2674  05646020
         BO    BOBNOTON                 YES, LEAVE BOB SW OFF    M2674  05652020
         MVI   0(R11),X'08'             SET FLAGS BITS, BOB SW = 1      05660000
BOBNOTON EQU   *                        THROUGH WITH IOBFLAGS    M2674  05670020
         MVI   4(R11),X'00'             SET B = 0                       05680000
*---------------------------------------INIT N SLOTS                    05700000
TSTHK01  EQU   *                        *                               05710000
         LR    R8,R5                    C(R8)=A(BUF1) ALSO              05712000
         ST    R5,0(R4)                 STORE A(BUF N) IN SLOT N        05714000
         L     R5,0(R5)                 C(R5)=A(NEXT BUF)               05716000
         ST    R7,0(R8)                 STORE 0000 IN BUF N CNT         05718000
         ST    R6,4(R8)                 STORE 0KDD IN BUF N CNT +4      05718400
         BCT   R3,TSTHK02               TEST FOR SLOT N                 05720000
         MVI   0(R4),X'80'              STATUS BIT 0 = 1 FOR BUFFR N    05780000
         ST    R4,ISLBUFN               C(BUFN)=A(SLOT N)               05800000
         LR    R4,R5                    A(NEXT BUFFER)                  05820000
         L     R5,DCBBUFCB              C(R5)=A(BUF POOL CTL BLK)       05860000
         ST    R4,0(R5)                 C(BUF POOL CTL BLK)=A(NXT BUF)  05880000
         CLI   DCBHIRSH,X'00'           TEST FOR SHARED TRACKS          05900000
         BE    TSTK012A                 B IF NOT SHARED                 05920000
TSTHK012 CLC   DCBFIRSH+2(1),DCBHIRSH   TEST FOR 1 RCD PER TRK SHARED   05940000
         BNE   TSTHK03                  B IF MORE THAN 1                05960000
TSTHK014 OI    8(R11),X'08'             TURN T-BIT ON FOR BUF 1 (BIT 4) 05980000
         CLC   DCBFIRSH(2),DCBLDT       TEST FOR 1 TRK PER CYL          06000000
         BNE   TSTHK03                  B IF MORE THAN 1                06020000
         OI    8(R11),X'04'             TURN C-BIT ON FOR BUF 1 (BIT 5) 06040000
         B     TSTHK03                  EXIT                            06060000
*                                                                       06080000
*                                       NOT SLOT N-                     06100000
TSTHK02  EQU   *                        NEXT SLOT                       06120000
         MVI   0(R4),X'00'              STATUS BITS = 0                 06140000
         LA    R4,4(R4)                 C(R4)=A(NEXT SLOT)       O19113 06160019
         B     TSTHK01                  LOOP                            06260000
*                                                                       06280002
TSTK012A CLI   DCBHIRPD,X'01'           TEST FOR 1 RCD PER TRK UNSHARED 06300000
         BE    TSTHK014                 BRANCH IF 1                     06320000
         EJECT                                                          06340002
* GENERAL INITIALIZATION                                                06360000
************************                                                06380000
*                                                                       06400000
* INITIALIZE NDAT AND ODAT - R, F, AND P BYTES                          06420000
*                                                                       06440000
TSTHK03  MVC   ISLNDAT+7(3),MVI1        RFP = 00001B                    06460000
         MVC   ISLODAT+7(3),MVI2        RFP = FF1007                    06480000
*                                                                       06500000
* SET ECBA, ECBB, ECBC TO COMPLETE STATE TO AVOID PREMATURE WAIT        06520000
*                                                                       06540000
         OI    ISLECBA,X'40'            SET COMPLETE BIT ON IN ECBA     06560000
         OI    ISLECBB,X'40'            SET COMPLETE BIT ON IN ECBB     06580000
         OI    ISLECBC,X'40'            SET COMPLETE BIT ON IN ECBC     06600000
*                                                                       06620000
*                                                                       06640000
* SET COUNT FIELDS IN NCNT, OCNT, DCNT, BUFFR 1, DCBLPDA, AND IOBA+32   06660000
*                                                                       06680000
         L     R8,DCBDEBAD              C(R8)=A(DEB)                    06700000
         USING IHADEB,R8                                         Y01021 06712400
         L     R5,DEBFPEAD              C(R5)=A(1ST PRIME EXTENT ENTRY) 06720000
         MVC   ISLNCNT(4),6(R5)         NCNT CCHH                       06740000
         MVI   ISLNCNT+4,X'01'               R = 1                      06760000
         MVC   ISLNCNT+5(1),DCBKEYLE         K = KEYLE                  06780000
         MVC   ISLNCNT+6(2),TST10       DD=0A                           06800000
         MVC   ISLOCNT(8),ISLNCNT       OCNT = NCNT WITH -              06820000
         MVI   ISLOCNT+4,X'02'               R = 2                      06840000
         MVC   ISLDCNT(8),ISLNCNT       DCNT = NCNT WITH -              06860000
         MVI   ISLDCNT+4,X'00'               R = 0                      06880000
*                                                                       06900000
         L     R3,8(R11)                C(R3)=A(BUF 1)                  06940000
         LA    R3,0(R3)                                                 06960000
         MVC   0(3,R3),6(R5)            BUF 1 COUNT    CCH FOR          06980000
TSTHK030 MVC   3(2,R3),DCBFIRSH+1                      HR = FIRSH       07140000
*                                                      KDD ALREADY SET  07160000
*                                                                       07180000
         DROP  R1                       DROP ADDR ON COPIED DCB  Y02072 07192002
         USING IHADCB,R10               EST ADDR ON REAL DCB     Y02072 07194002
         MVI   DCBLPDA,X'01'            LPDA           M = 1            07200000
         MVC   DCBLPDA+1(2),4(R5)                      BB               07220000
         MVC   DCBLPDA+3(5),0(R3)                      CCHHR FROM BUF 1 07240000
*                                                                       07260000
         MVC   32(8,R2),DCBLPDA         IOBA+32        MBBCCHHR         07280000
*                                                                       07300000
* SET UP CBF, EOB AND BMPR                                              07320000
*                                                                       07340000
         AH    R3,TST8                  C(R3)=A(BUF1+8)                 07360000
         ST    R3,ISLCBF                CBF = A(BUF 1 +8)               07380000
         DROP  R10                      DROP ADDR ON REAL DCB    Y02072 07390002
         USING IHADCB,R1                EST ADDR ON COPIED DCB   Y02072 07400002
         AH    R3,DCBBUFL               C(R3)=A(BUF1+8+BUFL)     O19110 07410019
         SH    R3,TST9                  C(R3)=A(BUF1+BUFL-1)            07440000
         ST    R3,ISLEOB                EOB = A(BUF1+BUFL-1)            07460000
         LH    R3,DCBLRECL              C(R3)= LRECL                    07480000
         TM    DCBRECFM,X'10'           TEST RECFM BIT 3 FOR BLOCKED    07500000
         BC    1,TSTHK04                B IF 1 = BLOCKED                07520000
         CLC   DCBRKP(2),TSTDDAT        TEST RKD=0                      07540000
         BNE   TSTHK04                  B IF NOT 0                      07560000
*                                                                       07580000
*                                       UNBLOCKED, RKP = 0              07600000
         MVC   TSTWK1C+3(1),DCBKEYLE    C(WK1C)=KEYLE, 000N             07620000
         A     R3,TSTWK1C               C(R3)=LRECL+KEYLE               07640000
*                                                                       07660000
TSTHK04  ST    R3,ISLBMPR               C(BMPR)=LRECL OR LRECL+KEYLE    07680000
*                                                                       07700000
* SET FBW = 1                                                           07720000
*                                                                       07740000
         LA    R3,1                     C(R3)=1                  O19110 07750019
         ST    R3,ISLFBW                SET FBW = 1              O19110 07760019
*                                                                       07780000
         DROP  R1                       END USING ON COPY DCB    Y02072 07790002
         USING IHADCB,R10               ADDR ON REAL DCB         Y02072 07792002
         LM    R3,R4,DCBLPDA            LOAD LPDA FROM USER DCB  Y02072 07794002
*                                                                       07796002
         MODESET  EXTKEY=DATAMGT        SET DATA MGT KEY         Y02072 07798002
*                                                                       07798402
         DROP  R10                      END USING ON REAL DCB    Y02072 07798802
         USING IHADCB,R1                ADDR ON COPY DCB         Y02072 07799202
         STM   R3,R4,DCBLPDA            LPDA TO DCB COPY         Y02072 07799602
         MVC   DCBFTMI3(L'DCBLPDA),DCBLPDA  SAVE LPDA FOR CLOSE  Y02072 07802202
*                                                                       07804802
* SET DCBMSWA = MBBCCHH OF NEXT-TO-LAST TRACK IN LAST PRIME EXTENT      07807402
*     NOTE - DCBMSWA IS THE SAME FIELD AS DCBLPDT.                      07810002
*                                                                       07820000
         SR    R4,R4                    CLEAR REGISTER 4         O19110 07830019
         ST    R4,DCBMSWA               CLEAR MSWA               O19110 07840019
         L     R8,DCBDEBAD              C(R8)=A(DEB)                    07860000
         DROP  R8                                                Y01021 07877600
         USING IHADEB,R8                R8 = DEB ADDRESS         Y01021 07878400
         L     R3,DEBFPEAD              C(R3)=A(1ST PRIME EXTENT ENTRY) 07880000
         IC    R4,DEBNPEE               C(R4)=000M                      07920000
*                                                                       07940000
         CLI   DCBNLEV,0                TEST FOR NO HI LVL INDEX        07960000
         BE    TSTHK042                 BRANCH IF NONE                  07980000
         CLI   DEBNIEE,X'00'            TEST SEPARATE IX AREA           08000000
         BNE   TSTHK042                 B IF PRESENT                    08020000
         CLI   DEBNOEE,X'00'            TEST SEPARATE OVFLOW AREA       08040000
         BNE   TSTHK042                 B IF PRESENT                    08060000
*                                                                       08080000
*  1. HIGH LEVEL INDEX WITH NO SEPERATE IX OR OVFL AREAS                08100002
*                                                                       08120000
         IC    R4,DCBFTHI               C(R4)=000M                      08140000
         BCTR  R4,0                     C(R4)=000M-1 (M-1 FOR EXTENT 0) 08160000
         SLL   R4,4                     C(R4)=000M-1 X 16 (USE AS INDX) 08180000
         LA    R8,6(R4,R3)              C(R8)=STRCC OF LAST EXTENT      08200000
TSTK040  CLC   DCBFTHI+3(3),0(R8)       TEST FTHI VS STRCC OF HI M      08540000
         BNE   TSTHK041                 B IF FTHI NOT STRCC OF HI M     08560000
*                                                                       08580000
         SRL   R4,4                     FTHI = STRCC OF HI M            08600000
         B     TSTHK042                 BACK UP AN EXTENT         21919 08602018
TSTK042  CLI   DCBFTHI+4,X'00'          TEST C2 VRS 0             10284 08605016
         BNE   TSTK043                                            10284 08610016
*                                                                       08615002
         BCTR  R5,0                     C(R5)=00CC-1              10284 08620002
         SLL   R5,8                     C(R5) = CCH             XA02702 08622002
*                                                                       08625002
         B     TSTK044                                            10284 08635016
*                                                                       08640000
TSTHK041 LH    R5,DCBFTHI+3                  C(R5) = CC OF IX           08660000
         SR    R8,R8                                                    08680000
         IC    R8,DCBDEVT               C(R8)= DEVT (INDEX FO2 2 BYTE   08700000
         SLL   R8,1                       DEVICE MASK)                  08720000
         CLI   DCBFTHI+5,X'00'          TEST H1 VS 0                    08740000
         BE    TSTK042                  BRANCH =  H1 IS 0               08760000
         SLL   R5,8                                                     08780000
         IC    R5,DCBFTHI+5             C(R5)= FTHI CCH                 08800000
         BCTR  R5,0                     C(R5)= FTHI CCH-1               08820000
         B     TSTK044                                                  08840000
TSTK043  BCTR  R5,0                     C(R5)= CC-1                     09000000
         SLL   R5,8                     C(R5)= CC0                      09020000
TSTK044  STCM  R5,MCCH,DCBLPDT+3        C(LPDT) = 000CCH0        Y02072 09060002
         B     TSTHK043                                                 09100000
*                                                                       09120000
*  2. SEPERATE IX OR OVFL AREA OR NO HIGH LEVEL INDEX                   09140002
*                                                                       09160000
TSTHK042 BCTR  R4,0                     C(R4)= 000M-1                   09180000
         SLL   R4,4                     C(R4)=000M-1 X 16 (USE AS INDX) 09200000
         LA    R8,10(R4,R3)            C(R8) = A(ENDCCH)                09260000
         MVC   DCBMSWA+3(3),0(R8)      MOVE CCH                         09280000
TSTHK043 LH    R5,DCBLDT               END HH                           09300000
         BCTR  R5,0                    END HH - 1                       09320000
         STC   R5,DCBMSWA+6            STORE HH                         09340000
         LA    R8,4(R4,R3)             C(R8)=A(BB)-1                    09360000
         MVC   DCBMSWA+1(2),0(R8)       MOVE BB TO MSWA                 09380000
         LR    R5,R4                    SAVE CURRENT EXTENT      XM0863 09402002
         SRL   R4,4                                                     09404002
         LA    R4,1(R4)                 C(R4)=000M               O19110 09410019
*                                       M = 1 FOR EXTENT 0              09420019
         STC   R4,DCBMSWA               STORE M                         09440000
         TM    DCBRECFM,VLR             VLR DATA SET            OX01135 09442000
         BO    CONTINUE                 NO SHARED TRKS FOR VLR  OX01135 09444000
         CLI   DCBFIRSH+TWO,ONE         ANY TRACKS SHARED        XM0863 09450002
         BE    CHECKHH                  NO                       XM0863 09452002
         CLC   DCBLDT,DCBFIRSH          SHARED TRACK ONLY TRACK  XM0863 09454002
         BH    CONTINUE                 NO - CONTINUE            XM0863 09456002
         B     CHECKCC                  CHECK FOR MORE THAN 1 CYLXM0863 09458002
CHECKHH  EQU   *                                                        09458402
         CLC   DCBMSWA+FIVE(2),HWONE    MORE THAN 1 PRIME TRACK  XM0863 09458802
         BNL   CONTINUE                 YES                      XM0863 09459202
CHECKCC  EQU   *                                                        09459602
         MVC   DCBMSWA+SIX(1),DCBLDT+ONE SET END0H TO LDT0H      XM0863 09459702
         LR    R4,R5                    RESET LAST EXTENT        XM0863 09459802
         LA    R8,6(R4,R3)              POINT TO START CCHH      XM0863 09459902
         CLC   0(TWO,R8),FOUR(R8)       ENDCC = BEGINCC          XM0863 09466602
         BE    CHECKM                   YES - GO CHECK EXTENTS   XM0863 09468602
         IC    R5,DCBMSWA+THREE         GET CURRENT CC           XM0863 09470602
         SLL   R5,8                     *                        XM0863 09472602
         IC    R5,DCBMSWA+FOUR          *                        XM0863 09473002
         BCTR  R5,0                     SUBTRACT 1               XM0863 09473102
         STC   R5,DCBMSWA+FOUR          RESTORE CC               XM0863 09473202
         SRL   R5,8                     *                        XM0863 09479902
         STC   R5,DCBMSWA+THREE         *                        XM0863 09481902
         B     CONTINUE                 CONTINUE                 XM0863 09483902
CHECKM   EQU   *                                                        09485902
         CLI   DCBMSWA,ONE              MORE THAN ONE EXTENT     XM0863 09486302
         BNH   ABEND                    OUT OF EXTENTS           XM0863 09486402
         SRL   R4,FOUR                  EXTENTS - 1              XM0863 09486502
         STC   R4,DCBMSWA               NEW EXTENT               XM0863 09493202
         BCTR  R4,0                     SUBTRACT ONE TO          XM0863 09495202
         SLL   R4,FOUR                  GET BACK TO              XM0863 09497202
         LA    R8,TEN(R4,R3)            LAST GOOD                XM0863 09499202
         MVC   DCBMSWA+THREE(THREE),0(R8) CYLINDER               XM0863 09499602
CONTINUE EQU   *                                                        09499702
*                                                                       09506602
* CALCULATE MVC AND MVCT FOR RECORD MOVE                                09513302
* BY DIVIDING BMPR BY 255                                               09520000
*                                                                       09540000
TSTHK045 LR    R4,R0                    OPEN WA ADDRESS          Y02072 09560002
         USING FORCORE,R4               OPEN WA ADDRESSABILITY   Y02072 09562002
*                                                                       09570002
         MODESET  KEYADDR=DXUKEY,WORKREG=5  SET USERS KEY        Y02072 09572002
*                                                                       09574002
         DROP  R4                       END OPEN WORK AREA USING Y02072 09576002
         SR    R4,R4                    SET TO ZERO              Y02072 09578002
         L     R5,ISLBMPR               DIVIDEND = 000000NN IN R4-R5    09580000
         D     R4,TST255                DIVISOR  =     0255             09600000
*                                       C(R4) = REMAINDER R             09620000
*                                       C(R5) = QUOTIENT  Q             09640000
         LTR   R4,R4                    TEST R VS 0                     09660000
         BC    8,TSTHK05                B IF R = 0                      09680000
*                                       R NOT 0                         09700000
         LA    R5,1(R5)                 C(R5)=Q+1                O19110 09720019
         B     TSTK055A                                                 09740000
*                                                                       09760000
TSTHK06A MVC   63(1,R9),62(R9)          MOVE 1S IS TO BE EXECUTED       09780000
*                                       R = 0                           09800000
TSTHK05  L     R4,TST255                C(R4)=0255                      09820000
TSTK055A BCTR  R4,0                                                     09840000
         ST    R4,ISLMVC                C(MVC)=0254, COUNT OF EX MOVE   09860000
         ST    R5,ISLMVCT               C(MVCT)=Q, NO OF 255 BYTE MVS   09880000
*                                                                       09900000
* INITIALIZE AREA Y                                                     09920000
*                                                                       09940000
TSTHK055 EQU   *                        *                               09960000
         L     R9,ISLVPTR1              C(R9)=A(AREA Y)                 09980000
*                                                                       10000000
*  1. STORE KDD IN COUNT OF HI-LEVEL INDEX AT Y+5                       10020000
*                                                                       10040000
         MVC   5(3,R9),ISLNCNT+5        C(Y+5)=KDD FROM NCNT            10060000
*                                                                       10080000
*  2. MOVE BINARY 1S TO KEY OF DUMMY INDEX ENTRY AT Y+62                10100000
*                                                                       10120000
         SR    R3,R3                                                    10140000
         IC    R3,DCBKEYLE              C(R3)=KEYLE                     10160000
         MVI   62(R9),X'FF'             SET 1ST BYTE OF KEY = 1S        10180000
         CLI   DCBKEYLE,X'01'           TEST IF KEYLE = 1               10200000
         BE    TSTHK07                  B IF KEYLE = 1                  10220000
         BCTR  R3,0                     R3 EQUALS                       10240000
         BCTR  R3,0                      KEYLE-2                        10260000
         EX    R3,TSTHK06A              MOVE IS TO REST OF KEY          10280000
*                                                                       10300000
*                                                                       10320000
*  3. MOVE HEX 00000000000000002007 TO Y+62+IL FOR DUMMY DATA, TRK IX   10340000
*                                                                       10360000
TSTHK07  EQU   *                                                  10284 10380016
         IC    R3,DCBKEYLE              C(R3)=KEYLE                     10400000
         AR    R9,R3                    C(R9)=A(AREA Y + IL)            10420000
         MVC   62(10,R9),TSTDDAT        MOVE DUMDAT TO AREA Y +62 +IL   10440000
*                                                                       10460000
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 10479702
         EJECT                                                          10493302
*                                                                       10500000
* EXIT ********** EXIT ***************** EXIT *********** EXIT ******** 10520000
*                                                                       10540000
         LR    RCORE,R0                 RESTORE OPEN W/A ADDR    Y02072 10542002
         USING FORCORE,RCORE            OPEN WA ADDRESSABILITY   Y02072 10542402
         LM    R0,R15,DXCCW1            RESTORE REGISTERS        Y02072 10544002
         USING BASETAG,RBASE            ESTABLISH BASE           O19110 10548019
         MVC   0(L'LOAD5T,RWTGC),LOAD5T ASSUME 5T NEXT           Y02072 10549002
         TM    DCBOPTCD,X'40'           FULL TRACK INDEX WRITE   O19110 10552019
         BO    EXIT5T                   YES - GO TO MODULE 5T    O19110 10556019
         MVC   0(L'LOAD2U,RWTGC),LOAD2U ASSUME 2U NEXT           Y02072 10558002
         TM    DCBOPTCD,X'80'           TEST OPTCD BIT 0 (WR CHK)       10560000
         BO    RELOOP                   WRITE CHECK 2U NEXT             10580001
TSTEXIT  MVC   0(L'LOAD2R,RWTGC),LOAD2R MOVE 2R ID               Y02072 10700002
EXIT5T   EQU   *                        *                               10710001
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       10720000
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       10740000
         CLC   0(2,RWTGC),THISLOAD                                      10760000
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 10780000
         CLC   0(2,RWTGC),OPNLOD7       TEST FOR END OF WTG TABLE       10800000
         BC    7,RELOOP                 BRANCH=NOT AT END               10820000
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                10840000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                10860000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              10880000
         BC    7,TCTLRTN                BRANCH = NOT ZERO               10900000
ITSZERO  LA    RWTGC,8(RWTGC)                                           10920000
         LA    RPARC,4(RPARC)                                           10940000
         B     ZCHECK                                                   10960000
TCTLRTN  EQU   *                                                        10980000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         11000000
         LA    RJ,DXCCW12               WA ADDRESS               Y01021 11040000
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 11060002
*                                                                       11080000
ABEND    EQU   *                                                        11090002
         ABEND X'036',DUMP,,SYSTEM      SYSTEM 036 ABEND         XM0863 11100002
MVI1     DC    X'00001B'                                                11120000
MVI2     DC    X'FF1007'                                                11140000
TST8     DC    H'08'                                                    11200000
TST9     DC    H'09'                                                    11220000
TST10    DC    H'10'                                                    11240000
TST255   DC    F'0255'                                                  11260000
MASK     DC    5H'00'                                                   11300000
         DC    X'0904'                  2321 MASK                       11320000
TSTDDAT  DC    X'00000000000000002007'  DUMMY DATA (MBBCCHHRFP)         11340001
THISLOAD DC    C'2G'                                                    11360000
OPNLOD7  DC    C'0S'                                                    11380000
HWONE    DC    H'1'                                              XM0863 11382002
*                                                                       11384000
*        XCTL TABLE                                                     11388000
LOAD2R   DC    C'2R'                    ID OF MODULE IGG0192R    Y02072 11390002
LOAD2U   DC    C'2U'                    ID OF MODULE IGG0192U    Y02072 11390102
LOAD5T   DC    C'5T'                    ID OF MODULE IGG0195T    Y02072 11390202
*                                                                       11390402
PATCH    DC    XL((*-IGG0192G)/20)'00'  ZEROED PATCH AREA        Y02072 11390802
*                                                                       11392000
         END                                                            11580000
