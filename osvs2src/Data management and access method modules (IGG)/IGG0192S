         TITLE 'IGG0192S - OPEN,QISAM LOAD MODE,SET UP CP 19,PRE FMT'   00020000
IGG0192S CSECT                                                          00021002
*                                                                       00022002
*********************************************************************** 00023002
*                                                                     * 00024002
* MODULE-NAME = IGG0192S                                              * 00025002
*                                                                     * 00026002
* DESCRIPTIVE-NAME = ISAM OPEN, LOAD MODE                             * 00027002
*                                                                     * 00028002
* COPYRIGHT = NONE                                                    * 00029002
*                                                                     * 00030002
* STATUS = RELEASE OS/VS2-02, LEVEL 01                                * 00031002
*                                                                     * 00032002
* FUNCTION = LOAD SIO MODULE IF EXECUTING IN VIRTUAL ENVIRONMENT, OR  * 00033002
*            ANY PORTION OF ISAM DATA SET RESIDES ON AN RPS DEVICE.   * 00034002
*            INITIALIZE CP 19 IF SHARED TRACKS, OR CYLINDER OVERFLOW  * 00035002
*            CONTROL RECORD (COCR) IS NEEDED.  EXECUTE CP19 TO PRE-   * 00036002
*            FORMAT FIRST PRIME CYLINDER.  IF NEITHER SHARED TRACKS   * 00037002
*            NOR COCR REQUIRED, EXIT TO NEXT OPEN LOAD WITHOUT        * 00038002
*            INITIALIZING CP19.                                       * 00039002
*                                                                     * 00042002
* NOTES = SEE BELOW                                                   * 00043002
*                                                                     * 00044002
*    DEPENDENCIES = NONE                                              * 00045002
*                                                                     * 00046002
*    RESTRICTIONS = NONE                                              * 00047002
*                                                                     * 00048002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00049002
*                                                                     * 00050002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00051002
*                                                                     * 00052002
* MODULE-TYPE = OPEN EXECUTOR                                         * 00053002
*                                                                     * 00054002
*    PROCESSOR = ASSEMXF-370R                                         * 00055002
*                                                                     * 00056002
*    MODULE-SIZE = 998 DECIMAL BYTES                                  * 00057002
*                                                                     * 00058002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00059002
*                                                                     * 00060002
* ENTRY-POINT = IGG0192S                                              * 00061002
*                                                                     * 00062002
*    PURPOSE = SEE FUNCTION                                           * 00063002
*                                                                     * 00064002
*    LINKAGE = RECEIVES CONTROL FROM ISAM OPEN EXECUTOR IGG0192U IF   * 00065002
*              WRITE-CHECK SPECIFIED, OTHERWISE FROM IGG0192R.        * 00066002
*              RECEIVES CONTROL IN STORAGE PROTECT KEY 5 AND          * 00067002
*              PRIVILEGED STATE.                                      * 00067202
*                                                                     * 00068002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00069002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00070002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00071002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00072002
*               PARAMETER LIST                                        * 00073002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00074002
*                                                                     * 00075002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00076002
*          UPON ENTRY TO THIS MODULE                                  * 00077002
*                                                                     * 00078002
* EXIT-NORMAL = XCTL TO IGG0192V IF WRITE-CHECK SPECIFIED, OTHERWISE  * 00079002
*               TO IGG0192T IN STORAGE PROTECT KEY 5.                 * 00079202
*                                                                     * 00080002
* EXIT-ERROR = NONE                                                   * 00081002
*                                                                     * 00086002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00087002
*                                                                     * 00088002
*    ROUTINES = NONE                                                  * 00089002
*                                                                     * 00091002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00092002
*                 FORCORE - OPEN WORK AREA                            * 00093002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00094002
*                                                                     * 00095002
*    CONTROL-BLOCKS = DCB, DCB COPY, DEB, AND IOB                     * 00096002
*                                                                     * 00097002
* TABLES = NONE                                                       * 00098002
*                                                                     * 00099002
* MACROS = MODESET, LOAD, EXCP, AND XCTL                              * 00100002
*                                                                     * 00101002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00102002
*                                                                     * 00103002
*          RELEASE OS/VS2-02 DELETIONS                                * 00153002
*                                                               YM01159 00203002
*                                                                     * 01061002
*********************************************************************** 01062002
         EJECT                                                          01063002
********************                                                    01064002
* DCB REFERENCE    *                                                    01080000
********************                                                    01100000
         DCBD  DSORG=(IS)                                               01120000
         USING IHADCB,R1                                                01140000
         EJECT                                                          01160000
********************                                                    01180000
* DEB REFERENCE    *                                                    01200000
********************                                                    01220000
*                                                                       01240000
IHADEB   IGGDEBD                                                        01340020
         USING IHADEB,R8                DEB ADDRESSABILITY       S20201 01440020
         EJECT                                                          01960000
ISLCOMON IGGLOAD                                                        02160020
         USING ISLCOMON,R12                                      S20201 02460020
*                                                                       03300000
*                                                                       03320000
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03340000
*                                                                       03360000
IOBBCT   DSECT                                                          03380000
         USING IOBBCT,R11                                               03400000
         DS    0D                                                       03420000
IOBFLAGS DS    0CL1                     FLAGS                           03440000
IOBPTRA  DS    A                        PTR A                           03460000
IOBB     DS    0CL1                     B                               03480000
IOBPTRB  DS    A                        PTR B                           03500000
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03520000
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03540000
         EJECT                                                          03560000
********************                                                    03580000
* IOB REFERENCE    *                                                    03600000
********************                                                    03620000
*                                                                       03640000
IHAIOB   DSECT                                                          03660000
         USING IHAIOB,R2                                                03680000
         DS    0D                                                       03700000
IOBFLG1  DS    CL1                      FLAGS 1                         03720000
IOBFLG2  DS    CL1                      FLAGS 2                         03740000
AIOBSENS DS    CL2                      SENSE BYTES              Y01021 03780000
IOBECBAD DS    A                        ECB POINTER                     03800000
AIOBCSW  DS    CL8                      CHANNEL STATUS WORD      Y01021 03820000
AIOBSIOC DS    0CL1                     SIO CC                   Y01021 03840000
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       03860000
IOBWT    DS    0CL1                     WEIGHT                          03880000
IOBDCBAD DS    A                        DCB POINTER                     03900000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     03920000
IOBBCTI  DS    CL2                      BLK CTR INCR                    03940000
IOBECT   DS    CL2                      ERROR CTR                       03960000
IOBDADAD DS    CL8                      DIR ACESS DEV ADR MBBCCHHR      03980000
*                                                                       04000000
         EJECT                                                          04005020
LOADCPS  DSECT                                                          04010020
         IGGLDCP                                                        04015020
         EJECT                                                          04020000
FORCORE  DSECT                          OPEN/CLOSE/EOV WORK AREA Y01021 04030000
         IECDSECT                                                Y01021 04032000
         SPACE 4                                                        04032402
         CVT   DSECT=YES                                        YM01159 04032802
         EJECT                                                          04034000
**********************************************************************  04040000
* ISL PUT OPEN #3                                                     * 04060000
**********************************************************************  04080000
*                                                                       04100000
*                                                                       04120000
IGG0192S CSECT                                                          04140000
TSTF800  BALR  R15,0                                                    04160000
         USING *,R15                                                    04180000
BASETAG  L     R1,0(RPARC)                                              04200000
         L     RCORE,4(RWTGC)                                           04220000
         L     R12,DCBWKPT1                                             04240000
         LR    RBASE,R15                                                04260000
         USING FORCORE,RCORE            OPEN W/A ADDRESSABILITY  Y02072 04270002
         STM   R0,R15,DXCCW1            SAVE REGISTERS           Y02072 04280002
*                                                                       04282002
         MODESET  KEYADDR=DXUKEY,WORKREG=11  SET USERS KEY       Y02072 04290002
*                                                                       04292002
         L     R11,ISLVPTR3             BUFFER CONTROL TABLE            04300001
         LR    RD,RCORE                 SAVE OPEN W/A ADDR       Y02072 04350002
*                                                                       04360000
* EQUATE SYMBOLIC REGISTERS                                             04380000
*                                                                       04400000
R0       EQU   0                                                        04420000
R1       EQU   1                                                        04440000
R2       EQU   2                                                        04460000
R3       EQU   3                                                        04480000
R4       EQU   4                                                        04500000
R5       EQU   5                                                        04520000
R6       EQU   6                                                        04540000
R7       EQU   7                                                        04560000
R8       EQU   8                                                        04580000
R9       EQU   9                                                        04600000
R10      EQU   10                                                       04620000
R11      EQU   11                                                       04640000
R12      EQU   12                                                       04660000
R13      EQU   13                                                       04680000
R14      EQU   14                                                       04700000
R15      EQU   15                                                       04720000
RBASE    EQU   3                                                        04740000
RCORE    EQU   4                                                        04760000
RPAR     EQU   5                                                        04780000
RWTG     EQU   6                                                        04800000
RPARC    EQU   7                                                        04820000
RWTGC    EQU   8                                                        04840000
RD       EQU   14                                                       04920000
RJ       EQU   15                                                       04940000
*                                                                       04942020
* EQUATE SYMBOLIC LOCATIONS                                             04944020
*                                                                       04946020
L7       EQU   7                        LENGTH                   S20201 04948020
K32      EQU   32                       CONSTANT                 S20201 04950020
DEBSIO   EQU   4                        START I/O APPENDAGE      S20201 04956020
RPSID    EQU   X'E0'                    DATA ON RPS DEVICE       S20201 04960920
K2       EQU   2                        CONSTANT                 S20201 04961820
K5       EQU   5                        CONSTANT                 S20201 04963620
K1       EQU   1                        CONSTANT                 S20201 04964520
K6       EQU   6                        CONSTANT                 S20201 04965420
ALL      EQU   X'FF'                    ALL SW SET               S20201 04966320
K4       EQU   4                        CONSTANT                 S20201 04967220
RESLD    EQU   X'20'                                             A34959 04970020
*                                                                       04980000
TEN      EQU   10                       CONSTANT                        04981001
J38      EQU   38                       CONSTANT                        04982001
J33      EQU   33                       CONSTANT                        04983001
ZERO     EQU   0                        CONSTANT                        04985001
VIRTUAL  EQU   X'80'                    VIRTUAL INDICATOR               04989001
TISASIZE EQU   8                        TISA SIZE DISPLACEMENT          04990001
FTIW     EQU   X'80'                    FTIW INDICATOR                  04991001
IDOFF    EQU   6                        OFFSET INTO WTG TAB             04991400
         EJECT                                                          05000000
*                                                                       05000620
*   LOAD START I/O MODULE INDEX OR PRIME ON RPS DEVICE OR IF            05001202
*        EXECUTING IN VIRTUAL ENVIRONMENT                               05001802
*                                                                       05002420
         L     R8,DCBDEBAD              LOAD DEB ADDRESS         S20201 05002600
         DROP  RCORE                                             Y01021 05003100
         L     R5,DEBAPPAD              ADDRESSABILITY ON AVT           05003300
         USING DEBAVT,R5                *                               05003401
*                                                                       05003502
         TM    DEBSIOA,VIRTUAL          IS IT VIRTUAL ENVIRON.   Y02072 05004102
         BO    LOADSIO                  YES - LOAD SIO APPEND.   Y02072 05006102
*                                       NO - TEST FOR RPS DEV.   Y02072 05006502
         TM    DEBRPSID,RPSID           RPS DEVICE USED          S20201 05008002
         BZ    TSTHSK                   NO - BR. NO SIO MODULE   S20201 05008602
*                                       YES - LOAD SIO MODULE           05009202
LOADSIO  LR    R2,R1                    SAVE DCB ADDRESS         Y02072 05009802
         LR    R4,R15                   SAVE ADDRESSABILITY      S20201 05010402
         L     R3,CVTPTR                ADDRESS OF CVT          YM01159 05011002
         USING CVT,R3                   CVT ADDRESSABILITY      YM01159 05011402
         L     R3,CVTLINK               ADDRESS OF LINKLIB DCB  YM01159 05011502
         DROP  R3                       END CVT ADDRESSABILITY  YM01159 05012502
*                                                                       05014002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 05015002
*                                                                       05016002
         MVC   IDOFF(2,RWTG),SIOID      IGG019GG                        05017002
         LOAD  EPLOC=(RWTG),DCB=(R3)    LOAD SIO MODULE                 05018002
         LR    R15,R4                   RESTOR ADDRESSABILITY           05019002
         SPACE 2                                                        05020002
* SAVE ADDRESS OF RPS SIO MODULE                                        05021002
*   PUT RPS SIO ADDRESS IN THE AVT AND DEB EXTENSION.                   05022002
*                                                                       05023002
         IC    R1,DEBSIOA               SAVE VIRTUAL INDICATOR   Y02072 05024002
         ST    R0,DEBSIOA               SAVE LINKAGE TO RPS SIO         05025002
         STC   R1,DEBSIOA               RESET VIRTUAL INDICATOR  Y02072 05026002
         L     R3,DEBEXPTR              ADDRESSABILITY ISAM SECTION DEB 05027002
         USING DEBEXT,R3                DEB EXTENSION ADDRESS.   Y02072 05028002
         ST    R0,DEBRPSL               SAVE FOR LINKAGE TO RPS SIO     05029002
         DROP  R3                       *                               05030002
         LR    R1,R2                    DCB ADDRESSABILITY              05031002
*                                                                       05032002
*   LOCATE FIRST FREE SPOT ON DEB SUBROUTINE LOAD LIST.                 05033002
*                                                                       05034002
         SR    R3,R3                                             S20201 05035002
         IC    R3,DEBNMEXT              NUMBER OF EXTENTS        S20201 05036002
         SLL   R3,4                     TOTAL LENGTH OF EXTENTS  S20201 05037002
         LA    R4,DEBNIEE+LOADEXT-K2(R3) ADDRESS OF SUBROUTINE   M1819  05038002
*                                       *    NAME SECTION               05039002
         SR    R3,R3                    *                        M6372  05040002
         IC    R3,DEBNMSUB              NUMBER OF SUBROUTINES    S20201 05041002
*                                       *    LOADED                     05042002
         AR    R4,R3                    FIRST FREE SPOT ON       S20201 05043002
         AR    R4,R3                    *    NAME LIST           S20201 05044002
*                                                                       05045002
*   PLACE ID FOR SIO MODULE ON SUBROUTINE NAME LIST                     05046002
*                                                                       05047002
         MVC   0(K2,R4),SIOID           *                        S20201 05048002
*                                                                       05049002
         USING FORCORE,RD               OPEN WA ADDRESSABILITY   Y02072 05050002
*                                                                       05051002
         MODESET  KEYADDR=DXUKEY,WORKREG=3   SET USERS KEY       Y02072 05052002
*                                                                       05053002
         DROP  RD                       END USING ON OPEN WA     Y02072 05054002
*                                                                       05055002
TSTHSK   EQU   *                        *                               05056002
*                                                                       05057002
         DROP  R5                                                       05058002
         LA    R2,ISLIOBA               PT TO IOBA                      05059002
* VARIABLE LENGTH RECORDS                                               05060002
         TM    DCBRECFM,X'80'           IS IT FIXED?              VLR   05061002
         BO    TSTHSK30                 BRANCH IF FIXED           VLR   05062002
BOBOFF   EQU   X'F7'                                             M0651  05063002
         TM    DCBST,RESLD              TEST IF RESUME LOAD      A34959 05064002
         BO    TSTHSK30                 BR IF RESUME LOAD        A34959 05065002
         L     R5,ISLVPTRS+8            A(BCT)=A(PTRA)            VLR   05066002
         NI    0(R5),BOBOFF             BOB SW OFF FOR VLR       M0651  05067002
         L     R5,0(R5)                 PTRA=A(SLOT1)             VLR   05068002
         L     R3,0(R5)                 C(R3)=A(BUFF1)            VLR   05069002
         LA    R3,12(R3)                C(R3)=A(BUFF1)+12         VLR   05070002
         ST    R3,ISLCBF                SAVE ADDR                 VLR   05071002
TSTHSK01 L     R4,0(R5)                 C(SLOT1)=A(BUFF1)         VLR   05072002
         MVC   8(4,R4),TST4             SET UP BLK FIELD          22619 05073002
         TM    0(R5),X'80'              LAST BUFFER?              VLR   05074002
         LA    R5,4(R5)                 PICK UP ADDR NXT BUFF     VLR   05075002
         BZ    TSTHSK01                 NO MORE BUFFS             VLR   05076002
TSTHSK30 EQU   *                                                 A34959 05077002
         SR    R5,R5                    CLEAR REGISTER           A34959 05078002
*                                                                       05079002
* INITIALIZE CP19                                                       05080000
*                                                                       05100000
         CLI   DCBHIRSH,X'00'           TEST HIRSH VS 0 FOR SHARED TRKS 05120000
         BNE   TSTHK41                  B NOT 0 = SHARED TRKS           05140000
*                                                                       05160000
         TM    DCBOPTCD,X'08'           TEST OPTCD BIT-4 FOR CYL OVFL   05180000
         BC    8,TSTHK80                B NOT ON = NO PREFORMAT NEEDED  05200000
         B     TSTHK51                  B IF CYL OVFL-NO SHARED         05220000
*                                                                       05240000
TSTHK41  TM    DCBOPTCD,X'08'           TEST OPTCD BIT-4 FOR CYL OVFL   05260000
         BC    8,TSTHK61                B NOT ON = NO CYL OVFL-SHARED   05280000
         B     TSTHK71                  B IF CYL OVFL-SHARED            05300000
*                                                                       05320000
*                                                                       05340000
*    A.* CP19 COMMON SETUP INITIAL - CYL OVFL AND/OR SHARED TRACKS      05360000
*                                                                       05380000
TSTHK42  LA    R2,ISLIOBC               C(R2)=A(IOBC)                   05400000
         L     R8,ISLFXAD               C(R8)=A(CP19 SKLTN)      S20201 05420020
         L     R10,ISLVPTR5             CP 19 ADDRESS                   05440001
         ST    R10,IOBCPSAD             PT IOB TO CM1            S20201 05450020
         S     R10,TST8                 ALLOW FOR CM0            S20201 05457020
         USING CM0,R10                  ADDRESSABILITY ON CP19   S20201 05464020
         MVC   CM0(CP19LEN),0(R8)       MOVE CHANNEL PROGRAM     S20201 05471020
         LA    R9,ISLAREAZ              C(R9)=A(AREA Z)                 05480000
*                                                                       05482020
         LA    R4,CM0+K5                CM0                      S20201 05484020
         ST    R4,CM0                   ADDR OF SECTOR           S20201 05486020
         MVI   CM0,SETSECT              RESTORE OPCODE           S20201 05488020
*                                                                       05490020
         LA    R4,ISLRPSSS+K1           CM40                     S20201 05492020
         ST    R4,CM40                  ADDRESS OF SECTOR        S20201 05494020
         MVI   CM40,NOP                 OPCODE NOP               S20201 05496020
*                                                                       05500000
         BR    R13                      RETURN                          05520000
*                                                                       05540000
*                                                                       05560000
*    B.* CP19 COMMON SETUP INITIAL - CYL OVFL /AND SHARED TRACKS        05580000
*                                                                       05600000
TSTHK43  EQU   *                                                 S20201 05640020
*                                                                       05680000
*                                       INITIALIZE DATA OF CYL OVFL     05700000
*                                       CTRL RCD AT Z (R9)              05720000
*                                                                       05740000
         LH    R3,DCBLDT                C(R3)=LDT                 22619 05770018
         LA    R3,1(R3)                 C(R3)=LDT+1 = CYL OVFL AREA     05800000
         SLL   R3,16                    C(R3)=HH00                      05820000
         ST    R3,0(R9)                 C(Z)=HH00 = HHRY                05840000
         MVI   4(R9),X'00'              C(Z)=HH000= HHRYY               05860000
         MVC   5(1,R9),DCBCYLOF         C(Z)=HH000N = HHRYYT            05880000
*                                       INITIAL WRITE CYL OVFL CTRL RCD 05920000
*                                       IN CP19                         05940000
*                                                                       05960000
         TM    DCBRECFM,X'80'           IS IT FIXED?              VLR   05963018
         BO    TSTHK43A                 YES, BRANCH               VLR   05966018
         L     R4,DCBLRAN               DEV TBL POINTER           VLR   05969018
         MVC   3(2,R9),4(R4)            MOVE IN YY TK CAP         VLR   05972018
TSTHK43A EQU   *                                                  VLR   05975018
         LA    R4,35(R2)                CM1                             05980000
         A     R4,CM1                                            S20201 05990020
         ST    R4,CM1                   ADDRESS OF IOBC+35       S20201 06000020
*                                                                       06010020
         LA    R4,CM1                   CM2                      S20201 06020020
         A     R4,CM2                                            S20201 06030020
         ST    R4,CM2                   ADDRESS OF CM1           S20201 06040020
*                                                                       06050020
         LR    R4,R9                    CM3                      S20201 06060020
         A     R4,CM3                                            S20201 06070020
         ST    R4,CM3                   ADDRESS OF AREA Z        S20201 06080020
*                                                                       06200000
         BR    R13                      RETURN                          06220000
*                                                                       06240000
*                                                                       06260000
*    C.* CP19 COMMON SETUP INITIAL - SHARED TRACKS /AND CYL OVFL        06280000
*                                                                       06300000
*                                       SET UP R6 WITH CC,IL+10         06320000
TSTHK44  SR    R6,R6                                                    06340000
         IC    R6,DCBKEYLE              C(R6)=IL                        06360000
         LA    R6,10(R6)                C(R6)= IL+10                    06380000
         STH   R6,CM8+K6                CM8 LENGTH = KL+10       S20201 06400020
*                                                                       06480000
*                                       SET UP R7 WITH BUF ADDR         06500000
         L     R7,ISLCBF                C(R7)=A(BUF1+8) FOR GARBAGE ADR 06520000
         ST    R7,CM8                   STORE A(BUF) AT CM8      S20201 06540020
*                                                                       06560000
*                                       SET UP R5 WITH OP,Z+6           06580000
         LA    R5,K6(R9)                C(R4)=Z+6                S20201 06590020
         A     R5,CM7                   CM7                      S20201 06600020
         ST    R5,CM7                                            S20201 06620020
         A     R5,TST8                  C(R5)=OP,Z+14                   06700000
*                                                                       06720000
*                                       INITIAL CM9 THRU CM26           06740000
*                                          C(R5)=OP,Z+6+8 OR Z+14       06760000
*                                          C(R7)=A(BUF)                 06780000
*                                          C(R6)=CC,IL+10               06800000
*                                                                       06820000
         LA    R4,9                     SET UP LOOP COUNTER       22619 06830018
TSTHK445 ST    R5,CM9                   START AT CM9 AND CM10    S20201 06837020
*                                        2261                    S20201 06844020
         ST    R7,CM10                  AND INITLZ ALL           S20201 06851020
         STH   R6,CM10+K6               CP'S                     S20201 06861020
         A     R5,TST8                                                  06900000
         LA    R10,16(0,R10)            GO TO NEXT CCW PAIR       22619 07000018
         BCT   R4,TSTHK445                                        22619 07100018
         L     R10,ISLVPTR5             CP 19 ADDRESS                   07200001
         S     R10,TST8                 ALLOW FOR CM0            S20201 07380020
         NI    CM26+K4,ALL-CC           TURN OFF TENTH CC FLAG   S20201 07460020
*                                                                       07560000
*                                                                       07580000
*                                       SET CM2+4 TO POINT TO ADDR OF   07600000
*                                       CC FLAG THAT WILL BE TURNED OFF 07620000
*                                       AND ON IF MORE THAN TEN ENTRIES 07640000
*                                       MUST BE WRITTEN.                07660000
*                                       IF LESS THAN TEN ENTRIES, TURN  07680000
*                                       CC FLAG OFF NOW.                07700000
*                                                                       07720000
         SR    R4,R4                                                    07740000
         SR    R5,R5                                                    07760000
         IC    R5,DCBFIRSH+2            C(R5)=R OF FIRSH                07780000
         BCTR  R5,0                     SUBTRACT 1 FROM DIVIDEND  22619 07800018
         D     R4,TST10                 DIVISOR  = 000A                 07820000
*                                       C(R4) = REMAINDER R = 000R      07840000
*                                       C(R5) = QUOTIENT  Q             07860000
         LTR   R4,R4                    R VS 0                    VLR   07880018
         BNE   TSTHK45                  B IF R NOT 0                    07900000
*                                                                       07920000
*                                       R=0, TENTH CC FLAG OFF AT CM26  07940000
         L     R4,TST10                 C(R4) = 000A                    07960000
         BCTR  R5,0                     ADJUST QUOTIENT DOWNWARD  22619 07980018
*                                                                       08000000
TSTHK45  SLL   R4,4                     C(R4) = 00R0, MULTIPLY BY 16    08020000
         LA    R6,CM6+K4                C(R6) = A(CM6+4)         S20201 08040020
         AR    R6,R4                    C(R6) = A(CM6+4+00R0) = A(FLAG) 08060000
         ST    R6,CM2+K4                C(CM2+4) = A(CC FLAG)    S20201 08080020
*                                                                       08100000
*                                       TEST IF MORE THAN TEN ENTRIES   08120000
         LTR   R5,R5                                              VLR   08140018
         BNE   TSTHK46                  B IF MORE THAN TEN ENTRIES      08160000
*                                                                       08180000
*                                       TEN OR LESS ENTRIES             08200000
         NI    0(R6),X'BF'              TURN CC FLAG (BIT-4) OFF        08220000
         SR    R4,R4                                                    08240000
         ST    R4,CM2+K4                C(CM2+4) = 0000 = TEN OR S20201 08250020
*                                       LESS                     S20201 08260020
*                                                                       08280000
TSTHK46  LA    R4,CM5                   CM6                      S20201 08300020
         A     R4,CM6                                            S20201 08310020
         ST    R4,CM6                   STORE ADDR OF CM5        S20201 08320020
*                                                                       08380000
*                                       SET UP COUNTS IN AREA Z         08400000
         MVC   6(4,R9),ISLIOBA+35       CCHH FROM IOBA+35 TO Z+6  P4701 08420000
         MVI   10(R9),X'01'                  R=1                        08440000
         MVC   11(3,R9),ISLNCNT+5            KDD FROM NCNT              08460000
*                                                                       08480000
         MVC   14(72,R9),6(R9)               Z+6 TO Z+14 THRU Z+78      08500000
*                                                                       08520000
         LA    R3,10                    C(R3)= 10 = COUNT               08540000
         LR    R4,R9                    PT TO AREA Z                    08560001
         LA    R5,1                     C(R5)= 1 = R1                   08580000
TSTHK47  EQU   *                        *                               08600001
         STC   R5,TEN(R4)               C(R5) = 1 = R                   08610001
         A     R4,TST8                            STEP Z                08620000
         LA    R5,1(R5)                 STEP R                          08640000
         BCT   R3,TSTHK47                         LOOP 9 MORE TIMES     08660000
*                                                                       08680000
         BR    R13                      RETURN                          08700000
*                                                                       08720000
*                                                                       08740000
*    D.* CP19 COMMON SETUP END - CYL OVFL AND/OR SHARED TRACKS          08760000
*                                                                       08780000
*      *                                                                08800000
*      * EXECUTE CP19                                                   08820000
*      *                                                                08840000
TSTHK49  EQU   *                                                        08860000
         TM    DCBST,X'20'              TEST FRO RESUME LOAD      P4701 08865000
         BO    TSTHK80                  BR - IF RL               S20201 08871020
*                                        P470                    S20201 08877020
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 08879002
*                                                                       08881002
         NI    DCBST,X'EF'              RESET NEW CYL SW          P4701 08885000
*                                                                       08885402
         USING FORCORE,RD               OPEN WA ADDRESSABILITY   Y02072 08885802
*                                                                       08886202
         MODESET  KEYADDR=DXUKEY,WORKREG=3   SET USERS KEY       Y02072 08887002
*                                                                       08887402
         L     R3,DXUDCBAD              GET REAL DCB ADDR        Y02072 08889002
         LH    R4,DXUDCBML              GET MOVE LENGTH          Y02072 08889902
         BCTR  R4,0                     DECREMENT LENGTH BY 1    Y02072 08891902
         EX    R4,MOVEDCB               MV FRM COPY TO REAL DCB  Y02072 08893202
         LR    R3,R15                   SAVE R15, BASE            P4701 08896702
         LR    R4,R1                    SAVE R1                         08900000
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         08920000
         LR    R15,R3                   RESTORE R15, BASE               08940000
         LR    R1,R4                    RESTORE R1                      08960000
*      *                                                                08980000
*      * TURN PF-BIT (STATUS BIT-6) ON IN 1ST BCT SLOT                  09000000
*      *                                                                09020000
         L     R3,IOBPTRB               C(R3)=PTR B = A(1ST SLOT) OR-   09040000
         LA    R3,0(R3)                 C(R3)=A(STATUS BITS)            09060000
         OI    0(R3),X'02'              TURN PF-BIT ON (STATUS BIT-6)   09080000
         B     TSTHK80A                 TRANSFER TO NEXT MOD     Y02072 09090002
*                                                                       09100000
* EXIT ********** EXIT ***************** EXIT *********** EXIT ******** 09120000
*                                                                       09140000
TSTHK80  EQU   *                        REFRESH USERS DCB        Y02072 09160002
         L     R3,DXUDCBAD              GET REAL DCB ADDR        Y02072 09162002
         LH    R4,DXUDCBML              GET MOVE LENGTH          Y02072 09164002
         BCTR  R4,0                     DECREMENT LENGTH BY 1    Y02072 09168002
         EX    R4,MOVEDCB               MV FRM COPY TO REAL DCB  Y02072 09168402
*                                                                       09168802
TSTHK80A EQU   *                        XFER CONTROL TO NEXT MOD Y02072 09169202
         LM    R0,R15,DXCCW1            RESTORE REGISTERS        Y02072 09200002
         DROP  RD                       DROP OPEN W/A ADDR       Y02072 09210002
*                                                                       09210402
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 09212002
*                                                                       09212402
         TM    DCBOPTCD,X'80'           TEST OPTCD BIT 0 (WR CHK)       09214002
         MVC   0(L'LOAD2V,RWTGC),LOAD2V ID FOR MODULE IGG0192V   Y02072 09220002
         BO    RELOOP                   WRITE CHECKING                  09240001
         USING BASETAG,RBASE                                            09280000
         MVC   0(L'LOAD2T,RWTGC),LOAD2T ID FOR MODULE IGG0192T   Y02072 09300002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       09320000
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       09340000
         CLC   0(2,RWTGC),THISLOAD                                      09360000
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 09380000
         CLC   0(2,RWTGC),OPNLOD7       TEST FOR END OF WTG TABLE       09400000
         BC    7,RELOOP                 BRANCH=NOT AT END               09420000
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                09440000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                09460000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              09480000
         BC    7,TCTLRTN                BRANCH = NOT ZERO               09500000
ITSZERO  LA    RWTGC,8(RWTGC)                                           09520000
         LA    RPARC,4(RPARC)                                           09540000
         B     ZCHECK                                                   09560000
TCTLRTN  EQU   *                                                        09580000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         09600000
         USING FORCORE,RCORE                                     Y01021 09624000
         LA    RJ,DXCCW12               WA ADDRESS               Y01021 09640000
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 09660002
*                                                                       09680000
MOVEDCB  MVC   DCBKEYLE-IHADCB(0,R3),DCBKEYLE   MOVE FROM COPY   Y02072 09690002
*                                               DCB TO REAL DCB         09694002
         DROP  RBASE                                                    09700000
         EJECT                                                          09720000
*                                                                       09740000
*    1.* CYL OVFL-NO SHARED TRACKS                                      09760000
*                                                                       09780000
TSTHK51  BAL   R13,TSTHK42              B TO COMMON SETUP A.            09800000
         BAL   R13,TSTHK43              B TO COMMON SETUP B.            09820000
*                                                                       09840000
*                                       SET IOBC+32 TO TRACK 00, RCD 0  09860000
*   SET UP IOBC SEEK ADDRESS                                            09880001
         BAL   R13,MULPDA               H=0,R=0                         09900001
*                                                                       09920001
*                                                                       09940000
         NI    CM3+K4,ALL-CC            TURN CC FLAG (BIT-4) OFF S20201 09950020
*                                       AT CM                    S20201 09960020
*                                                                       09980000
         B     TSTHK49                  B TO COMMON SETUP END           10000000
*                                                                       10020000
*                                                                       10040000
*    2.* SHARED TRACKS-NO CYL OVFL                                      10060000
*                                                                       10080000
TSTHK61  BAL   R13,TSTHK42              B TO COMMON SETUP A.            10100000
         BAL   R13,TSTHK44              B TO COMMON SETUP C.            10120000
*                                                                       10140000
         LA    R4,CM5                   C(R4)=A(CM5)             S20201 10160020
         ST    R4,IOBCPSAD              STORE A(CM5) IN IOBC CP START   10200000
*                                                                       10240000
         LA    R4,35(R2)                CM5                             10260000
         A     R4,CM5                                            S20201 10270020
         ST    R4,CM5                   STORE ADDRESS OF IOBC+35 S20201 10280020
*                                                                       10340000
*                                       SET IOBC+32 TO FIRSH WITH R=0   10360000
         LA    R3,32(R2)                POINT TO IOBSEEK          22619 10390018
         BAL   R13,MULPDA               SET UP FIRST SHARED             10400001
         OC    J38(K1,R2),DCBFIRSH+K1   *                               10410001
*                                                                       10420000
         B     TSTHK49                  B TO COMMON SETUP END           10440000
*                                                                       10460000
*                                                                       10480000
*    3.* SHARED TRACKS-CYL OVFL                                         10500000
*                                                                       10520000
TSTHK71  BAL   R13,TSTHK42              B TO COMMON SETUP A.            10540000
         BAL   R13,TSTHK43              B TO COMMON SETUP B.            10560000
         BAL   R13,TSTHK44              B TO COMMON SETUP C.            10580000
*                                                                       10600000
*                                       SET IOBC+32 TO TRACK 00, RCD 0  10620000
         BAL   R13,MULPDA               H=0,R=0                         10640001
*                                                                       10648001
         EJECT                                                          10656001
*                                                                       10664001
*   SET IOBC SEEK FIELD, CHECK FOR MORE THAN ONE TRACK                  10672001
*                                                                       10680001
         LA    R4,J33(R2)               CM4&5 REFERENCE IOBC            10688001
*                                                                       10700000
*                                       TEST IF CYL OVFL RCD ON SHARED  10720000
*                                       TRACK                           10740000
         CLC   DCBFIRSH(2),TST10        TEST FIRSH HH=0           22619 10760018
         BE    TSTHK72                  ON SAME TRACK                   10780001
         MVC   CM27,ISLIOBC+K32         SEEK TO FIRST SHARED            10820001
         OC    CM27+K6(K1),DCBFIRSH+K1  TRACK                           10860001
         LA    R4,CM27+K1               CM4&5 REFERENCE CM27            10900001
TSTHK72  EQU   *                        *                               10940001
*                                                                       10950002
*   CM4 = SEEK TO SHARED TRACK, R=0                                     10980001
*                                                                       10990002
         ST    R4,CM4                   *                               11020001
         MVI   CM4,SEEKHH               *                               11060001
*                                                                       11070002
*   CM5=SEARCH ID TO R0 OF SHARED TRACK                                 11100001
*                                                                       11110002
         LA    R4,K2(R4)                *                               11140001
         ST    R4,CM5                   *                               11180001
         MVI   CM5,SIDEQ                *                               11220001
*                                                                       11320000
         B     TSTHK49                  B TO COMMON END                 11340000
*                                                                       11360000
         SPACE 3                                                        11380002
MULPDA   EQU   *                        *                               11390001
*                                                                       11400001
*   SUBROUTINE TO SET IOBC SEEK TO FIRST RECORD ON CYLINDER             11410001
*   REFERENCED BY IOBA SEEK.(HEAD=0,RECORD=0)                           11420001
*                                                                       11430001
         MVC   K32(L7,R2),ISLIOBA+K32   SET UP MBBCCHH                  11440001
         MVI   39(R2),X'00'             SET R = 0                       11480002
         MVI   J38(R2),ZERO             NO SET H=0                      11495002
         BR    R13                      RETURN                          11500000
         EJECT                                                          11520000
*                                                                       11540000
TST8     DC    F'0008'                  CONSTANT                 S20201 11620020
TST10    DC    F'0010'                                                  11700000
TST4     DC    H'4'                     CONSTANT                 S20201 11710020
SIOID    DC    C'GG'                    NAME OF LOAD MODE SIO           11720000
THISLOAD DC    C'2S'                                                    11740000
OPNLOD7  DC    C'0S'                                                    11760000
*                                                                       11764000
*        XCTL TABLE                                                     11768000
LOAD2T   DC    C'2T'                    ID OF MODULE IGG0192T    Y02072 11768402
LOAD2V   DC    C'2V'                    ID OF MODULE IGG0192V    Y02072 11768802
*                                                                       11769202
PATCH    DC    XL50'00'                 ZEROED PATCH AREA        Y02072 11769602
*                                                                       11772000
         END                                                            11960000
