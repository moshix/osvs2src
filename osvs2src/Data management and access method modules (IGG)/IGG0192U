         TITLE 'IGG0192U - OPEN,QISAM LOAD MODE,SET UP CP18 W/WRT CHK'  00020000
IGG0192U CSECT                                                          00021002
*                                                                       00022002
*********************************************************************** 00023002
*                                                                     * 00024002
* MODULE-NAME = IGG0192U                                              * 00025002
*                                                                     * 00026002
* DESCRIPTIVE-NAME = ISAM OPEN, LOAD MODE WITH WRITE CHECK            * 00027002
*                                                                     * 00028002
* COPYRIGHT = NONE                                                    * 00029002
*                                                                     * 00030002
* STATUS = RELEASE OS/VS2-02, LEVEL 01                                * 00031002
*                                                                     * 00032002
* FUNCTION = LOAD PUT APPENDAGE, AND CHANNEL PROGRAM MODULES WHEN     * 00033002
*            WRITE CHECK IS SPECIFIED.  FOR FIXED LENGTH  RECORDS     * 00034002
*            (FLR), LOAD IGG019GB, IGG019GD, AND IGG019GE.  FOR VLR,  * 00034202
*            LOAD IGG019IB, IGG019GD, AND IGG019IF.  FOR FLR WITH     * 00035002
*            FULL TRACK INDEX WRITE (FTIW), LOAD IGG019I2 INSTEAD OF  * 00036002
*            IGG019GB.  ALSO GETMAIN FOR CHANNEL PROGRAMS AND         * 00037002
*            INITIALIZE CP18.                                         * 00038002
*                                                                     * 00042002
* NOTES = FOR FTIW, THE LENGTH OF CP20 IS LEFT IN THE CALCULATION FOR * 00043002
*         THE CHANNEL PROGRAM GETMAIN TO ALLOW ENOUGH SPACE FOR CP91  * 00043202
*         TO OVERLAY CP19.                                            * 00043402
*                                                                     * 00044002
*    DEPENDENCIES = NONE                                              * 00045002
*                                                                     * 00046002
*    RESTRICTIONS = NONE                                              * 00047002
*                                                                     * 00048002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00049002
*                                                                     * 00050002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00051002
*                                                                     * 00052002
* MODULE-TYPE = OPEN EXECUTOR                                         * 00053002
*                                                                     * 00054002
*    PROCESSOR = ASSEMXF-370R                                         * 00055002
*                                                                     * 00056002
*    MODULE-SIZE = 1016 DECIMAL BYTES                                 * 00057002
*                                                                     * 00058002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00059002
*                                                                     * 00060002
* ENTRY-POINT = IGG0192U                                              * 00061002
*                                                                     * 00062002
*    PURPOSE = SEE FUNCTION                                           * 00063002
*                                                                     * 00064002
*    LINKAGE = RECEIVES CONTROL FROM ISAM OPEN EXECUTOR IGG0195U IF   * 00065002
*              FTIW SPECIFIED, OTHERWISE FROM IGG0192G IF INITIAL     * 00065202
*              LOAD, OR IGG0195D IF RESUME LOAD WITH HIGH-LEVEL       * 00067202
*              INDICES, OR IGG0196G IF RESUME LOAD WITHOUT HIGH-LEVEL * 00067402
*              INDICES.  RECEIVES CONTROL IN STORAGE PROTECT KEY 5    * 00067602
*              AND PRIVILEGED STATE.                                  * 00067802
*                                                                     * 00068002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00069002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00070002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00071002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00072002
*               PARAMETER LIST                                        * 00073002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00074002
*                                                                     * 00075002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00076002
*          UPON ENTRY TO THIS MODULE                                  * 00077002
*                                                                     * 00078002
* EXIT-NORMAL = XCTL TO ISAM OPEN EXECUTOR IGG0192S IN STORAGE        * 00079002
*               PROTECT KEY 5.                                        * 00079202
*                                                                     * 00080002
* EXIT-ERROR = NONE                                                   * 00081002
*                                                                     * 00086002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00087002
*                                                                     * 00088002
*    ROUTINES = NONE                                                  * 00089002
*                                                                     * 00091002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00092002
*                 FORCORE - OPEN WORK AREA                            * 00093002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00094002
*                                                                     * 00095002
*    CONTROL-BLOCKS = DCB COPY, DEB, AND IOB.                         * 00096002
*                                                                     * 00097002
* TABLES = NONE                                                       * 00098002
*                                                                     * 00099002
* MACROS = MODESET, LOAD, GETMAIN, AND XCTL.                          * 00100002
*                                                                     * 00101002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00102002
*                                                                     * 00103002
*          RELEASE OS/VS2-02 DELETIONS                                * 00153002
*                                                               YM01159 00203002
*                                                                     * 01041002
*********************************************************************** 01042002
         EJECT                                                          01043002
********************                                                    01044002
* DCB REFERENCE    *                                                    01060000
********************                                                    01080000
         DCBD  DSORG=(IS)                                               01100000
         USING IHADCB,R1                                                01120000
         EJECT                                                          01140000
********************                                                    01160000
* DEB REFERENCE    *                                                    01180000
********************                                                    01200000
*                                                                       01220000
IHADEB   IGGDEBD                                                        01240001
         USING IHADEB,R8                ADDRESSABILITY                  01540001
         EJECT                                                          01940000
ISLCOMON IGGLOAD                                                        01950020
         USING ISLCOMON,R12                                      S20201 01960020
         EJECT                                                          03040000
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03320000
*                                                                       03340000
IOBBCT   DSECT                                                          03360000
         USING IOBBCT,R11                                               03380000
         DS    0D                                                       03400000
IOBFLAGS DS    0CL1                     FLAGS                           03420000
IOBPTRA  DS    A                        PTR A                           03440000
IOBB     DS    0CL1                     B                               03460000
IOBPTRB  DS    A                        PTR B                           03480000
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03500000
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03520000
         SPACE 4                                                        03540002
********************                                                    03560000
* IOB REFERENCE    *                                                    03580000
********************                                                    03600000
*                                                                       03620000
IHAIOB   DSECT                                                          03640000
         USING IHAIOB,R2                                                03660000
         DS    0D                                                       03680000
IOBFLG1  DS    CL1                      FLAGS 1                         03700000
IOBFLG2  DS    CL1                      FLAGS 2                         03720000
AIOBSENS DS    CL2                      SENSE BYTES              Y01021 03760000
IOBECBAD DS    A                        ECB POINTER                     03780000
AIOBCSW  DS    CL8                      CHANNEL STATUS WORD      Y01021 03800000
AIOBSIOC DS    0CL1                     SIO CC                   Y01021 03820000
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       03840000
IOBWT    DS    0CL1                     WEIGHT                          03860000
IOBDCBAD DS    A                        DCB POINTER                     03880000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     03900000
IOBBCTI  DS    CL2                      BLK CTR INCR                    03920000
IOBECT   DS    CL2                      ERROR CTR                       03940000
IOBDADAD DS    CL8                      DIR ACESS DEV ADR MBBCCHHR      03960000
         EJECT                                                          03970000
****************************                                            03980000
* OPEN WORK AREA REFERENCE *                                            03990000
****************************                                            03992000
FORCORE  DSECT                          OPEN/CLOSE/EOV WORK AREA Y01021 03994000
         IECDSECT                                                Y01021 03996000
         EJECT                                                          04000000
* * * * * * * * * *  LOAD CHANNEL PROGRAM SOURCE SKELETON * * * * * * * 04068020
LOADCPS  DSECT                                                          04072020
         IGGLDCP OPTCD=W                                         S20201 04076020
         SPACE 4                                                        04080002
* * * * * * * * * *  SKELETON FOR RECEIVING CHANNEL PROGRAMS  * * * * * 04082020
CPSTO    DSECT                                                          04084020
CPS1     DS    D                        ADDRESS                  S20201 04086020
CPS2     DS    D                        ADDRESS                  S20201 04088020
CPS3     DS    D                        ADDRESS                  S20201 04090020
CPS4     DS    D                        ADDRESS                  S20201 04092020
CPS5     DS    D                        ADDRESS                  S20201 04094020
         SPACE 4                                                        04096002
         CVT   DSECT=YES                                        YM01159 04098002
         EJECT                                                          04098402
**********************************************************************  04100000
* ISL PUT OPEN #2                                                     * 04120000
**********************************************************************  04140000
*                                                                       04160000
*                                                                       04180000
IGG0192U CSECT                                                          04200000
TSTF800  BALR  R15,0                                                    04220000
         USING *,R15                                                    04240000
BASETAG  L     R1,0(RPARC)                                              04260000
         L     RCORE,4(RWTGC)                                           04280000
         L     R12,DCBWKPT1                                             04300000
         LR    RBASE,R15                                                04320000
         USING FORCORE,RCORE                                     Y02072 04330002
         STM   R0,R15,DXCCW1            SAVE REGISTERS           Y02072 04340002
         LR    R13,RCORE                SAVE OPEN W/A ADDR       Y02072 04350002
         DROP  RCORE                                             Y02072 04360002
         USING IHADEB,R8                                         S21045 04372021
         USING FORCORE,R13              OPEN WA ADDRESSABILITY   Y02072 04372402
         SPACE 2                                                        04372802
         MODESET  KEYADDR=DXUKEY,WORKREG=11  SET USERS KEY       Y02072 04374002
         SPACE 2                                                        04376002
         L     R11,ISLVPTR3             BUFFER CONTROL TABLE            04380000
         L     R8,DCBDEBAD               DEB ADDRESSABILITY      S21045 04381000
*                                                                       04420000
* EQUATE SYMBOLIC REGISTERS                                             04440000
*                                                                       04460000
R0       EQU   0                                                        04480000
R1       EQU   1                                                        04500000
R2       EQU   2                                                        04520000
R3       EQU   3                                                        04540000
R4       EQU   4                                                        04560000
R5       EQU   5                                                        04580000
R6       EQU   6                                                        04600000
R7       EQU   7                                                        04620000
R8       EQU   8                                                        04640000
R9       EQU   9                                                        04660000
R10      EQU   10                                                       04680000
R11      EQU   11                                                       04700000
R12      EQU   12                                                       04720000
R13      EQU   13                                                       04740000
R14      EQU   14                                                       04760000
R15      EQU   15                                                       04780000
RBASE    EQU   3                                                        04800000
RCORE    EQU   4                                                        04820000
RPAR     EQU   5                                                        04840000
RWTG     EQU   6                                                        04860000
RPARC    EQU   7                                                        04880000
RWTGC    EQU   8                                                        04900000
RJ       EQU   15                                                       05000000
K0       EQU   0                        CONSTANT                 S20201 05021020
K4       EQU   4                        CONSTANT                 S20201 05022020
K6       EQU   6                        CONSTANT                 S20201 05023020
K7       EQU   7                        CONSTANT                 S20201 05024020
K8       EQU   8                        CONSTANT                 S20201 05025020
K16      EQU   16                       CONSTANT                 S20201 05026020
K20      EQU   20                       CONSTANT                 S20201 05027020
K24      EQU   24                       CONSTANT                 S20201 05028020
K28      EQU   28                       CONSTANT                 S20201 05029020
K35      EQU   35                       CONSTANT                 S20201 05030020
K64      EQU   64                       CONSTANT                 S20201 05031020
L1       EQU   1                        LENGTH                   S20201 05034020
L2       EQU   2                        LENGTH                   S20201 05037020
L8       EQU   8                        LENGTH                   S20201 05040020
L24      EQU   24                       CONSTANT                 S20201 05043020
L32      EQU   32                       CONSTANT                 S20201 05046020
K12      EQU   12                       CONSTANT                 S20201 05049020
K32      EQU   32                       CONSTANT                 S20201 05052020
*                                                                       05055020
VIRTUAL  EQU   X'80'                    VIRTUAL=VIRTUAL                 05057001
CEDISP   EQU   4                        CE DISPLACEMENT                 05058501
AEDISP   EQU   12                       AE DISPLACEMENT                 05059001
ID       EQU   6                        DISPLACEMENT TO MODULE ID       05059501
         EJECT                                                          05060000
*                                                                       05080000
TSTHSK   LA    R2,ISLIOBA               C(R2)=A(IOBA)                   05100000
*                                                                       05120000
* LOAD PUT, APP, AND CP MODULES (WR CHK)                                05140000
*                                                                       05160000
         L     R9,CVTPTR                ADDRESS OF CVT          YM01159 05180002
         USING CVT,R9                   CVT ADDRESSABILITY      YM01159 05230002
         L     R9,CVTLINK               ADDRESS OF LINKLIB DCB  YM01159 05232002
         DROP  R9                       END CVT ADDRESSABILITY  YM01159 05234002
         LR    R4,R1                    SAVE R1                         05240000
         USING IHADCB,R4                ADDRESSABILITY ON DCB           05241001
         DROP  R1                       *                               05242001
         USING BASETAG,R3               ADDRESSABILITY                  05243001
         DROP  R15                      *                               05244001
*                                                                       05244102
*   R7 WILL BE USED AS AN INDEX FOR FINDING THE CORRECT CHANNEL         05244300
*   PROGRAM AND PROCESSING MODULES TO LOAD.                             05244600
*                                                                       05244702
         LA    R7,CPVLR-CP              ASSUME VLR                      05245000
         TM    DCBRECFM,X'80'           IS IT FIXED               VLR   05255018
         BNO   LOADPUT                  NO - VLR CORRECT                05260000
         SR    R7,R7                    ASSUME FIXED - NOT FTIW         05265000
         TM    ISLVPTRA,FTIW            IS IT FTIW                      05273000
FTIW     EQU   X'C0'                    FTIW INDICATOR                  05273500
         BNO   LOADPUT                  NO - LOAD PUT MODULE     O19110 05274019
         LA    R7,CPFTIW-CP             IT IS FIXED - FTIW              05275000
LOADPUT  EQU   *                                                 O19110 05276019
*                                                                       05276102
*   LOAD PROCESSING TIME MODULE - IGG019GB, IGG019IB OR IGG019I2.       05276200
*                                                                       05276602
         LH    R5,PROC(R7)              LAST TWO BYTES OF NAME          05277000
         STH   R5,ISLVPTR5              SAVE ID FOR DEB                 05278000
         SPACE 2                                                        05278102
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 05278402
         SPACE 2                                                        05278802
         BAL   R10,LOAD                 LOAD PROCESSING MODULE          05279000
         IC    R5,DCBPUT                SAVE O FLAGS                    05280001
         ST    R0,DCBPUT                ADDRESS OF PUT MODULE           05290001
         STC   R5,DCBPUT                RESTORE O FLAGS                 05300001
*                                                                       05300402
*   SAVE PROCESSING MODULE ADDRESS FOR CLOSE - IGG0202I.                05300500
*                                                                       05302502
         L     R5,DEBEXPTR              ADDRESSABILITY ISAM EXTENSION   05310000
         USING DEBEXT,R5                *                               05312000
         ST    R0,DEBPUT                SAVE PUT MODULE ADDRESS         05314000
         DROP  R5                                                       05316000
*                                                                       05318002
*   LOAD CHANNEL END AND ABNORMAL END APPENDAGE MODULE - IGG019GD.      05320000
*                                                                       05322002
         LH    R5,APP                   LAST TWO BYTES OF NAME          05326000
         BAL   R10,LOAD                 LOAD APPENDAGE MODULE           05332000
         ST    R0,DCBWKPT5              ADDRESS OF APPENDAGE            05340001
         MVI   DCBWKPT5,K0              RESET SW                 Y02072 05350002
*                                                                       05360002
*   LOAD CHANNEL PROGRAM MODULE.                                        05364000
*                                                                       05366002
         LH    R5,CP(R7)                LAST TWO BYTES OF NAME.         05368000
LOAD     EQU   *                        LOAD ANY MODULE                 05372000
         STH   R5,ID(RWTG)              FINISH MODULE NAME              05376000
*                                                                       05378002
         LOAD  EPLOC=(RWTG),DCB=(R9)    LOAD CPS                        05380000
*                                                                       05382002
*   SUBROUTINE RETURNS TO LAST BAL OR BALR ISSUED ON R10, THIS          05383000
*   INCLUDES THE BALR INSTRUCTION THAT FOLLOWS.                         05386000
*                                                                       05388002
         BALR  R10,R10                  RETURN TO LOAD NEXT             05389000
*                                                                       05392000
         L     R10,DCBWKPT6             ADDRESSABILITY ISLVPTRS         05395000
         SPACE 2                                                        05395402
         MODESET  KEYADDR=DXUKEY,WORKREG=15  SET USERS KEY       Y02072 05397002
         SPACE 2                                                        05399002
         ST    R0,CL1AD                 PTR TO CP MODULE                05400001
         LR    R15,R3                   RESTORE BASE                    05420000
         LR    R1,R4                    RESTORE R1                      05440000
         USING BASETAG,R15              REVERSE ADDRESSABILITY          05444001
         DROP  R3                       *                               05448001
         USING IHADCB,R1                ADDRESSABILITY ON DCB           05452001
         DROP  R4                       *                               05456001
         L     R6,CL1AD                 C(R6)=ADDR CP18 SKLTN           05680000
         LA    R6,CP18LEN(R6)           ADD SIZE OF CP18         S20201 05690020
*                                        VLR                     S20201 05700020
         ST    R6,CM1AD                 STORE ADDR CP19 SKLTN     VLR   05720018
         LA    R6,CP19LEN(R6)           ADD SIZE OF CP19         S20201 05730020
*                                        VLR                     S20201 05740020
         ST    R6,CQ1AD                 STORE ADDR CP20 SKLTN     VLR   05760018
         LA    R6,CP20LEN(R6)           ADD SIZE OF CP20         S20201 05770020
*                                        VLR                     S20201 05780020
         ST    R6,CQT1AD                STORE ADDR CP20 WR CHK    VLR   05800018
         LA    R6,CP20WRCK(R6)          ADD SIZE OF CP20 WR CHK  S20201 05810020
*                                        VLR                     S20201 05820020
         ST    R6,CQ40AD                ST ADDR CP21 SKLTN        VLR   05840018
         LA    R6,CP21LEN(R6)           ADD SIZE OF CP21         S20201 05850020
*                                        VLR                     S20201 05860020
         ST    R6,CQ45AD                STORE ADDR CP21 WR CHK          05880000
*                                                                       05900000
* SET UP APPENDAGE VECTOR TABLE IN 5 WORDS ON TOP DEB                   05920000
*                                                                       05940000
         L     R8,DCBDEBAD              C(R8)=A(DEB)                    05960000
         USING IHADEB,R8                R8 = DEB ADDRESS         Y01021 05974500
         L     R7,DEBAPPAD              C(R7)=A(VECTOR)                 05980000
         USING DEBAVT,R7                ADDRESSABILITY ON AVT           05990001
         L     R3,DCBWKPT5              APPENDAGE ADDRESS               06000001
         SPACE 2                                                        06000402
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 06002002
         SPACE 2                                                        06004002
         ST    R3,DEBEOEA               END OF EXTENT PTR               06008001
         LA    R3,0(R3)                 *                               06024001
         TM    DEBSIOA,VIRTUAL          VIRTUAL = REAL                  06032001
         BO    TSTHSIO                  NO - DON'T OVERLAY SIO PTR      06040001
         ST    R3,DEBSIOA               YES - OVERLAY SIO               06048001
TSTHSIO  EQU   *                        *                               06056001
         LR    R4,R3                    PCI ADDRESS                     06072001
         LA    R5,CEDISP(R3)            CE ADDRESS                      06080001
         LA    R6,AEDISP(R3)            AE ADDRESS                      06088001
         STM   R4,R6,DEBPCIA            STORE APPENDAGE ADDRESS         06104001
         DROP  R7                                                       06144001
*                                                                       06160000
* STORE PUT AND APPENDAGE MODULE IDS BEYOND LAST EXTENT IN DEB          06180000
*                                                                       06200000
         SR    R4,R4                                                    06220000
         IC    R4,DEBNMEXT              NUMBER OF EXTENTS        S20201 06230020
*                                       *  ISAM DEPENDANT SECTION       06240020
         SLL   R4,4                     C(R4)=NO. OF EXTENTS X 16       06360000
         LA    R5,LOADEXT               GET DEB EXTENSION LENGTH S21045 06368021
         STC   R5,DEBAMLNG              DEB EXTENSION=ACS METH   S21045 06376021
*                                       SECTION                  S21045 06384021
         AR    R4,R5                    ADD EXTENSION LENGTH     S21045 06392021
         LA    R5,DEBNIEE(R4)           PT TO ID LIST                   06400001
*                                                                       06402002
*   MOVE SAVED ID INTO DEB.                                             06410001
*                                                                       06410402
         MODESET  KEYADDR=DXUKEY,WORKREG=3   SET USERS KEY       Y02072 06412002
         SPACE 1                                                        06412402
         LH    R3,ISLVPTR5              LOAD ID                  Y02072 06414002
         SPACE 1                                                        06414402
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 06416002
         SPACE 1                                                        06416402
         STH   R3,0(,R5)                STORE ID IN DEB          Y02072 06418002
*                                                                       06428002
*   MOVE APPENDAGE ID INTO DEB.                                         06430001
*                                                                       06432002
         MVC   L2(L'APP,R5),APP         MOVE IN APP ID                  06440000
*                                                                       06450002
* CALCULATE AMT OF STOREGE NEEDED FOR CHANNEL PROGRAMS (WR CHK)         06480000
*                                                                       06500000
         LA    R3,K24                   BASIC CP LENGTH FOR EACH S20201 06506020
*                                       *  BUFFER                       06512020
         TM    DCBRECFM,X'10'           TEST FOR BLOCKED (BIT-3) * CP18 06520000
         BC    1,TSTHK081               B IF BLOCKED             ****** 06540000
         NC    DCBRKP,DCBRKP            DOES RKP = 0             S20201 06550020
         BZ    TSTHK082                 YES - USE BASIC LENGTH   S20201 06560020
*                                       NO - EXTEND BASIC LENGTH        06570020
TSTHK081 LA    R3,K16(R3)               INCREASE LENGTH          S20201 06580020
TSTHK082 SR    R4,R4                                                    06680000
         SPACE 2                                                        06682002
         MODESET  KEYADDR=DXUKEY,WORKREG=5   SET USERS KEY       Y02072 06690002
         SPACE 2                                                        06692002
         SR    R5,R5                                                    06700000
         IC    R5,ISLBUFNO              C(R4+R5) = BUFNO                06720000
         MR    R4,R3                    C(R5) = ZXBUFNO                 06740000
         LA    R5,K64(R5)               *C(R5)=48+(ZXBUFNO)      S20201 06750020
*                                       13334                     VLR   06760018
         LR    R3,R5                    C(R3) = SIZE OF CP18            06780000
*                                                                * CP19 06800000
         SR    R4,R4                                             ****** 06820000
         CLI   DCBHIRSH,X'00'           TEST HIRSH VS 0          O19110 06840019
         BNE   TSTHK083                 B NOT 0 = SHARED                06860000
         TM    DCBOPTCD,X'08'           TEST OPTCD BIT 4, CYL OVFL      06880000
         BC    8,TSTHK084               B NOT ON = NO CP19 NEEDED       06900000
*                                                                       06902002
*   ADD LENGTH OF CP 18 AND CP19                                        06906020
*                                                                       06908002
TSTHK083 LA    R5,CP19LEN(R5)                                    S20201 06912020
         LA    R4,CP19LEN(R4)           C(R4)=SIZE CP19          S20201 06917020
*                                       O1911                    S20201 06922020
*                                                                       06927020
*   ADD LENGTH OF CP20 W/WRITE CHECK AND CP21 W/WRITE CHECK             06932020
*                                                                       06942020
TSTHK084 EQU   *                                                 O19110 06960019
         LA    R5,CP20LEN+CP20WRCK+CP21LEN+CP21WRCK(R5)          S20201 06970020
*                                                                       07120000
* GET MAIN FOR CHANNEL PROGRAMS                                         07140000
*                                                                       07160000
         ST    R5,32(R10)               STORE SIZE OF CPS FOR DELETE    07180000
         LA    R0,250                   SUBPOOL NO. 250                 07200000
         SLL   R0,24                    C(R0) = P000, P = SUBPOOL NO.   07220000
         OR    R0,R5                    C(R0) = PNNN, NNN = POOL SIZE   07240000
         LR    R6,R1                    SAVE R1                         07260000
         LR    R7,R15                   SAVE R15, BASE                  07280000
*                                                                       07300000
         GETMAIN R,LV=(0)                                               07320000
*                                                                       07340000
         LR    R15,R7                   RESTORE R15                     07360000
         LR    R7,R1                    C(R7)=A(SUBPOOL)                07380000
         LR    R1,R6                    RESTORE R1                      07400000
         LR    R6,R7                    SAVE DESTINATION         S20201 07405020
         LA    R7,K8(R7)                ALLOW FOR RPS            S20201 07410020
*                                       INSTRUCTION              S20201 07415020
*                                                                       07420000
*                                                                       07440000
* SET UP ISLVPTRS FOR CHANNEL PROGRAM ADDRESSES                         07460000
*                                                                       07480000
         ST    R7,12(R10)               A(CP18)                         07500000
         AR    R7,R3                    ADD SIZE OF CP18                07520000
         ST    R7,16(R10)               A(CP19)                         07540000
         AR    R7,R4                    ADD SIZE OF CP19 (MAY BE 0)     07560000
         TM    36(R10),X'C0'            FTIW-SUCCESSFUL GETMAIN  O19110 07565019
         BO    SKPCP20                  YES-DON'T STORE CP20     O19110 07570019
*                                       ADDR                     O19110 07575019
         ST    R7,20(R10)               A(CP20)                         07580000
SKPCP20  EQU   *                                                 O19110 07590019
*   ADD SIZE OF CP20 W/WRITE CHECK                                      07593020
         LA    R7,CP20LEN+CP20WRCK(R7)                           S20201 07596020
         ST    R7,24(R10)               A(CP21)                         07640000
*                                                                       07660000
         SPACE 4                                                        07680002
*                                                                       07700000
* INITIALIZE CP18                                                       07720000
*                                                                       07740000
         LR    R10,R6                   NEXT DESTINATION         S20201 07750020
         USING CPSTO,R10                                         S20201 07760020
         L     R9,CL1AD                 C(R9)=A(CP18 SKLTN, CL1)        07780000
         USING LOADCPS,R9                                        S20201 07790020
         SR    R3,R3                                                    07800000
         IC    R3,ISLBUFNO              C(R3)=NO OF BUFFRS              07820000
         MVC   CPSTO(L32),0(R9)         MOVE CLO,CL1,CL2,CL3     S20201 07830020
* * CL0 INITIALIZATION                                                  07840020
         LA    R4,ISLRPSSS              SET SECTOR               S20201 07850020
         O     R4,CL0                                            S20201 07860020
         ST    R4,CPS1                                           S20201 07870020
* * CL1 INITIALIZATION                                                  07880020
         LA    R4,K35(R2)               SEARCH ID EQUAL          S20201 07890020
         O     R4,CL1                   *  I0B+35                S20201 07900020
         ST    R4,CPS2                  *                        S20201 07910020
* * CL2 INITIALIZATION                                                  07920020
         LA    R4,CPS2                  TIC TO CL1               S20201 07930020
         O     R4,CL2                   *                        S20201 07940020
         ST    R4,CPS3                  *                        S20201 07950020
* * CL3 INITIALIZATION                                                  07960020
         LA    R4,CPS5                  TIC TO CL4               S20201 07970020
         O     R4,CPS4                  TIC TO CL4               S20201 07980020
         ST    R4,CPS4                  *                        S20201 07990020
         ST    R4,CPS4+K4               SAVE ADDRESS             S20201 08000020
         LA    R10,CPS5                 NEXT DESTINATION         S20201 08020020
*                                                                       08030020
*   ASSIGN BUFFERS TO CHANNEL PROGRAMS                                  08040020
*                                                                       08060020
         SR    R8,R8                    CLEAR REGISTER 8         O19110 08190019
         SPACE 1                                                        08192001
         L     R7,0(R11)                1ST AVAILABLE BUFFER            08194001
         MVI   ISLOFFST+3,32            THREE CCWS PER BUFFER    M0170  08195021
         LA    R7,0(R7)                 CLEAR HIGH BYTE                 08196001
         TM    DCBRECFM,X'10'           TEST RECFM BIT 3 FOR BLOCKED    08200000
         BC    1,TSTHK15                B IF 1 = BLOCKED                08220000
*                                                                       08240000
*                                       UNBLOCKED                       08260000
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 08270002
         SPACE 1                                                        08272002
         NC    DCBRKP,DCBRKP            TEST RKP VS 0            S20201 08280020
         SPACE 1                                                        08280402
         MODESET  KEYADDR=DXUKEY,WORKREG=4   SET USERS KEY       Y02072 08282002
         SPACE 1                                                        08284002
         BNZ   TSTHK20                  BR IF RKP NOT 0          S20201 08290020
*                                       O1911                    S20201 08300020
*                                       UNBLOCKED, RKP = 0              08340000
         MVI   ISLOFFST+3,16            IF RECFM=F, RKP=0 ONE    M0170  08350021
         OI    0(R11),X'01'             SET FLAGS BIT 7 = 1 IN BCT      08360000
         IC    R8,DCBKEYLE              C(R8)=KEYLE, 000N = IL          08440000
         AH    R8,DCBLRECL              C(R8)=AL+IL (AL=LRECL)   O19110 08460019
         LA    R8,K8(R8)                C(R8)=AL+IL+8, 00NN      S20201 08480020
*                                                                       08580000
*                                                                       08584020
*   FIXED LENGTH RECORDS, RKP = 0 - SET UP 1 COPY OF CL4 FOR            08588020
*   EACH BUFFER.                                                        08592020
*                                                                       08596020
TSTHK09  MVC   CPS1,CL4                 MOVE CL4                 S20201 08604020
         STH   R8,CPS1+K6               LEN FOR WRITE            S20201 08612020
         L     R4,0(R7)                 C(R4)=C(SLOT S)=A(BUF B)        08620000
         LA    R4,0(R4)                                                 08640000
         O     R4,CL4                   *COMBINE OP CODE         S20201 08650020
*                                        1333                    S20201 08660020
         ST    R4,CPS1                  STORE COUNT ADR IN CL4   S20201 08670020
         LR    R5,R10                   *R5 POINTS TO CURRENT CCW 13334 08688016
         DROP  R10                                               S20201 08689020
         USING CPSTO,R5                                          S20201 08690020
         LA    R10,CPS3                 NEXT DESTINATION         S20201 08691020
         ST    R10,CPS2                 BUILD A NEW TIC WITH     S20201 08692020
         ST    R10,CPS2+K4              *  DUPLICATE ADDRESS FOR S20201 08693020
         OI    CPS2,TIC                 *  RESTORATION           S20201 08694020
         LA    R7,4(R7)                 C(R7)=A(NXT SLOT)         VLR   08738018
         BCT   R3,TSTHK09               LOOP                            08760000
*                                       BLOCKED                  S20201 08772020
         DROP  R5                                                S20201 08781020
         USING CPSTO,R10                                         S20201 08790020
         B     TSTHK30                  B TO MOVE CL5                   08800000
*                                                                       08820000
*                                       UNBLOCKED, RKP NOT 0            08840000
*                                                                       08900000
*                                       BLOCKED                         08920000
TSTHK15  EQU   *                                                 O19110 08940019
         LH    R8,DCBBLKSI              C(R8)=BLKSI              O19110 08960019
         SH    R8,DCBLRECL              C(R8)=BLKSI-LRECL        O19110 08980019
*                                                                       09020000
*                                       COMMON RT FOR CL6, CL7, +CL8    09040000
TSTHK20  EQU   *                                                 O19110 09060019
         AH    R8,DCBRKP                C(R8)=REL KEY ADDR       O19110 09080019
*                                                                       09200000
TSTHK26  MVC   CPS1(L24),CL6            MOVE IN CL6,CL7,CL8      S20201 09205020
         MVC   CPS2+K7(L1),DCBKEYLE     LEN FOR WR KEY           S20201 09210020
         MVC   CPS3+K6(L2),DCBBLKSI     LEN FOR WR DATA          S20201 09215020
         L     R4,0(R7)                 ADDRESS OF BUFFER        S20201 09223020
* * CL6 INITIALIZATION                                                  09231020
         IC    R5,CL6                   WRITE COUNT              S20201 09240020
         ST    R4,CPS1                  *                        S20201 09249020
         STC   R5,CPS1                  *                        S20201 09259020
* * CL7 INITIALIZATION                                                  09269020
         LA    R4,K8(R4)                PT TO DATA               S20201 09279020
         ST    R4,CPS3                                           S20201 09289020
* * CL8 INITIALIZATION                                                  09299020
         AR    R4,R8                    PT TO HIGH KEY IN BLOCK  S20201 09309020
         ST    R4,CPS2                  WRITE KEY                S20201 09319020
         LR    R5,R10                   CURRENT DESTINATION      S20201 09329020
         LA    R10,CPS5                 NEXT DESTINATION         S20201 09339020
         DROP  R10                                               S20201 09349020
         USING CPSTO,R5                                          S20201 09359020
         ST    R10,CPS4                 TIC CCW ADDRESS          S20201 09369020
         ST    R10,CPS4+K4              DUPLICATE FOR            S20201 09376020
*                                       RESTORATION              S20201 09383020
         OI    CPS4,TIC                 RESTORE OP CODE          S20201 09390020
         LA    R7,4(R7)                 C(R7)=A(NXT DEST)         VLR   09434018
*                                       13334                     VLR   09438018
         BCT   R3,TSTHK26               *LOOP                     13334 09442016
         LA    R5,K16(R5)               FAKE UNBLOCKED RKP=0            09445001
*                                                                 13334 09448016
*                                                                 13334 09454016
TSTHK30  EQU   *                        *C(R9)=A(CP18,CL1)       S20201 09460020
         IC    R3,DCBKEYLE              *C(R3)=KEY LENGTH         13334 09466016
         LA    R3,K8(R3)                *C(R3)=KEY LENGTH+8      S20201 09472020
         AH    R3,DCBBLKSI              *C(R3)=KEY LENGTH+8+DATALN13334 09478016
         L     R4,DCBWKPT6              VPTRS                    S20201 09481020
         L     R4,K12(R4)               CP18 ADDRESS             S20201 09482020
         MVC   CPS2,K16(R4)             MOVE IN WRAP AROUND TIC         09483001
         LR    R5,R10                   NEXT DESTINATION         S20201 09484020
         MVC   CPS1(L32),0(R6)          MOVE IN                  S20201 09485020
*                                       CLO*,CL1*,CL2*,CL3*      S20201 09486020
* * CL0* SAME AS CL0 EXCEPT NOP                                         09487020
         MVI   CPS1,NOP                 MAKE CL0* NOP            S20201 09488020
*                                                                       09489020
* * CL1* INITIALIZATION                                                 09490020
         LA    R4,CPS2                  TIC TO CL1*              S20201 09491020
         ST    R4,CPS3                                           S20201 09492020
         OI    CPS3,TIC                 RESTORE OP CODE          S20201 09494020
         ST    R5,K20(R6)               SAVE ADDRESS OF SCH CCW  S20201 09496020
         LA    R5,K32(R5)               NEXT DESTINATION         S20201 09498020
         SR    R4,R4                                             S20201 09500020
         IC    R4,ISLBUFNO              NUMBER OF WRITES TO      S20201 09500820
*                                       CHECK                    S20201 09501620
* * CL9 INITIALIZATION                                                  09502420
AGN      MVC   CPS1,CL9                 READ CKD - SUPPRESS DATA S20201 09503220
         STH   R3,CPS1+K6               *  TRANSFER              S20201 09504020
         TM    DCBRECFM,VLR             IS IT VLR                S20201 09504820
VLR      EQU   X'40'                                             S20201 09505620
         BNO   VLR8                     BIF NOT VLR.             S20201 09506420
         OI    CPS1+K4,SILI             SET SILI FOR VLR.        S20201 09507220
VLR8     EQU   *                        *                        S20201 09510220
         LA    R5,8(R5)                 *NEXT DESTINATION         13334 09550016
         BCT   R4,AGN                   *LOOP                     13334 09556016
         ST    R5,K28(R6)               *SET UP 2ND TIC ADDR.    S20201 09560020
*                                       FLD.                     S20201 09564020
         SH    R5,TST8                  *GET LAST READ CKD CCW   O19110 09568019
         NI    CPS1+K4,X'FF'-CC         TURN CC FLAG OFF         S20201 09571020
         EJECT                                                          09580000
*                                                                       09600000
* EXIT ********** EXIT ***************** EXIT *********** EXIT ******** 09620000
*                                                                       09640000
         LM    R0,R15,DXCCW1            RESTORE REGISTERS        Y02072 09660002
         DROP  R13                                               Y02072 09662002
         SPACE 1                                                        09664002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 09670002
         SPACE 1                                                        09672002
         USING BASETAG,RBASE                                            09680000
         MVC   0(L'LOAD2S,RWTGC),LOAD2S ID OF MODULE IGG0192S    Y02072 09700002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       09720000
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       09740000
         CLC   0(2,RWTGC),THISLOAD                                      09760000
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 09780000
         CLC   0(2,RWTGC),OPNLOD7       TEST FOR END OF WTG TABLE       09800000
         BC    7,RELOOP                 BRANCH=NOT AT END               09820000
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                09840000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                09860000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              09880000
         BC    7,TCTLRTN                BRANCH = NOT ZERO               09900000
ITSZERO  LA    RWTGC,8(RWTGC)                                           09920000
         LA    RPARC,4(RPARC)                                           09940000
         B     ZCHECK                                                   09960000
TCTLRTN  EQU   *                                                        09980000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         10000000
         USING FORCORE,RCORE                                     Y01021 10020500
         LA    RJ,DXCCW12                                        Y01021 10040000
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 10060002
*                                                                       10080000
         DS    0D                                                       10100000
*   LAST TWO BYTES OF MODULE NAMES - USED TO CONSTRUCT NAMES.           10110000
         SPACE 5                                                        10120000
*   CHANNEL END AND ABNORMAL END APPENDAGE MODULE.                      10130000
APP      DC    C'GD'                    IGG019GD - LOAD APPENDAGE       10160000
*   CHANNEL PROGRAM MODULES.                                            10164000
CP       DC    C'GF'                    IGG019GF - FIXED NON FTIW       10168000
CPVLR    DC    C'IF'                    IGG019IF - VLR                  10172000
CPFTIW   DC    C'GF'                    IGG019GF - FIXED FTIW           10176000
*   PROCESSING MODULES( MACRO TIME ).                                   10180000
PROC     DC    C'GB'                    IGG019GB - FIXED NON FTIW       10184000
         DC    C'IB'                    IGG019IB - VLR                  10188000
         DC    C'I2'                    IGG019I2 - FIXED FTIW           10192000
*                                                                       10200000
TST8     DC    H'0008'                                           O19110 10310019
*                                       13334                     VLR   10380018
THISLOAD DC    C'2U'                                                    10500000
OPNLOD7  DC    C'0S'                                                    10520000
LOAD2S   DC    C'2S'                    IS OF MODULE IGG0192S    Y02072 10570002
*                                                                       10620002
PATCH    DC    XL50'00'                 ZEROED PATCH AREA        Y02072 10670002
         END                                                            10680000
