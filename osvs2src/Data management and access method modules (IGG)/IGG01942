         TITLE 'IGG01942-CHECKPOINT DISK INITIALIZATION'                00200020
IGG01942 CSECT                                                          00400020
******************** MICROFICHE FLAGS *********************** SUPT CODE 00400122
*CHANGE ACTIVITY AS FOLLOWS:                                            00400222
*A227150                                                        SA56217 00400322
*C206000,772000,774000,792000,794000                            SA59025 00400422
*A844300                                                        SA59025 00400522
*C015000,046000,050000,194000-206000,217200,217250,217500-217560 Y02027 00400606
*C582600-583200,594000,595000                                    Y02027 00400706
*A227230-227260,626200,839400-839800,896000,906000               Y02027 00400806
*A257000                                                        SA64710 00440552
*C530000,559200                                                 SA64712 00480552
*D558000                                                        SA64712 00520552
*A787400,844200                                                @SA75746 00530509
*C388000,794000                                                @SA75746 00540509
*D792000                                                       @SA75746 00550509
* PACKAGING ERROR                                              @OZ08378 00550691
*        TCAM LEVEL 10.0 MVS CHANGES                           @G36XRNP 00557600
*A029000,098000,120000,134000,566000,715000,787000,844301      @G36XRNP 00564600
*A845200,715000                                                @G36XRNP 00571600
*C011000,014200,028500                                         @G36XRNP 00578600
*D715500-718000,788000-790000                                  @G36XRNP 00585600
*A380000                                                       @OY20541 00585786
*                                                              @G36XRNP 00592600
         SPACE 3                                                        00600020
*********************************************************************** 00800020
*                                                                     * 01000020
*TITLE: 'IGG01942' CHECKPOINT DISK INITIALIZATION MODULE              * 01200020
*                                                                     * 01220022
*MODULE NAME: IGG01942  (TCAM,INITIALIZATION)                  @G36XRNP 01240000
*                                                                     * 01260022
*DESCRIPTIVE NAME: CHECKPOINT DISK INITIALIZATION                     * 01280022
*                                                                     * 01300022
*COPYRIGHT: NONE                                                      * 01320022
*                                                                     * 01340022
*STATUS = CHANGE LEVEL 10.0                                    @G36XRNP 01500000
*                                                                     * 01600020
*FUNCTION:THIS MODULE FORMATS THE CHECKPOINT DATA                     * 01800020
*   SET WITH DUMMY RECORDS. THE CPRCDS OPERAND ON INTRO INDICATES     * 02000020
*   THE NUMBER OF ENVIRONMENT CHECKPOINTS THE USER WANTS ON DISK.     * 02200020
*   THE CKREQS OPERAND INDICATES THE NUMBER OF CKREQ RECORDS TO       * 02400020
*   WRITE ON DISK. THERE IS ONE CONTROL RECORD. THE REMAINDER OF      * 02600020
*   THE SPACE ALLOCATED TO THE CHECKPOINT DATA SET IS USED FOR        * 02800020
*   INCIDENT RECORDS. WHEN IT IS DETERMINED THAT EITHER THE    @G36XRNP 03000000
*   TCAM OR 3705 CHECKPOINT DCB HAS BEEN OPENED SUCCESSFULLY   @G36XRNP 03060000
*   CHECKPOINT ACTIVE INDICATORS ARE SET IN THE TCAM AVT.      @G36XRNP 03120000
*                                                                     * 03200020
*ENTRY POINT:                                                         * 03400020
*                                                                     * 03600020
*        IGG01942                                                     * 03800020
*                                                                     * 04000020
*INPUT: REGISTERS 5,6,7, AND 8 CONTAIN THE FOLLOWING VALUES           * 04200020
*                                                                     * 04400020
*   5 -ADDRESS OF THE BEGINNING OF THE WTG TABLE PREFIX          Y02027 04600006
*   6 -ADDRESS OF BEGINNING OF WHERE-TO-GO TABLE                      * 04800020
*   7 -ADDRESS OF THE COPY OF THE CURRENT DCB                    Y02027 05000006
*   8 -ADDRESS OF CURRENT ENTRY IN WHERE-TO-GO TABLE                  * 05200020
*   THE CHECKPOINT WORKAREA(INCLUDING IOB AND CCWS) IS INITIALIZED.   * 05400020
*                                                                     * 05600020
*OUTPUT: REGISTERS 5 AND 6 ARE SAME AS INPUT. REGISTERS 7 AND 8 ARE   * 05800020
*   UPDATED TO THE NEXT ENTRIES.                                      * 06000020
*   DUMMY RECORDS ARE WRITTEN ON THE CHECKPOINT DATA SET.             * 06200020
*                                                                     * 06400020
*EXTERNAL ROUTINES:                                                   * 06600020
*                                                                     * 06800020
*        IECPCNVT-CONVERTS RELATIVE TRACK ADDRESS TO ACTUAL ADDRESS   * 07000020
*                                                                     * 07200020
*EXITS-NORMAL: THIS MUDULE XCTLS TO THE NEXT ENTRY IN THE WHERE-TO-   * 07400020
*   GO TABLE.                                                         * 07600020
*                                                                     * 07800020
*EXITS-ERROR: THIS MODULE ISSUES AN ERROR MESSAGE VIA WTO AND XCTLS   * 08000020
*   TO THE NEXT ENTRY IN THE WHERE-TO-GO TABLE. IT RECOGNIZES THE     * 08200020
*   FOLLOWING ERRORS:                                                 * 08400020
*   1.DISK ERROR WHILE WRITING                                        * 08600020
*   2.INSUFFICIENT DISK SPACE FOR MINIMUM CHECKPOINT RECORDS:         * 08800020
*      2 ENVIRONMENT RECORDS                                          * 09000020
*      1 CONTROL RECORD                                               * 09200020
*      CKREQ RECORDS-NUMBER SPECIFIED BY CKREQS ON INTRO              * 09400020
*   THE DCB IS MARKED UNOPENED.                                       * 09600020
*                                                                     * 09800020
*MACROS - IEDHJN                                               @G36XRNP 09810000
*         WTO                                                  @G36XRNP 09820000
*         XCTL                                                 @G36XRNP 09830000
*         EXCP                                                 @G36XRNP 09840000
*         WAIT                                                 @G36XRNP 09850000
*         LOAD                                                 @G36XRNP 09860000
*         DELETE                                               @G36XRNP 09870000
*                                                              @G36XRNP 09880000
*MODULE TYPE - PROCEDURE                                       @G36XRNP 09890000
*                                                              @G36XRNP 09900000
*PROCESSOR - ASSEMBLER                                         @G36XRNP 09910000
*                                                              @G36XRNP 09920000
*MODULE SIZE - 1K                                              @G36XRNP 09930000
*                                                              @G36XRNP 09940000
*PURPOSE - SEE FUNCTION                                        @G36XRNP 09950000
*                                                              @G36XRNP 09960000
*LINKAGE - XCTL'ED FROM IGG01943 AND IGG01949                  @G36XRNP 09970000
*                                                              @G36XRNP 09980000
*TABLES/WORK AREAS:                                                   * 10000020
*                                                                     * 10200020
*   CVT                                                               * 10400020
*   AVT (AVTCKGET,AVTOPTPT,AVTRNMPT,AVTCLRHI,AVTBITS,AVTNCKPR,AND     * 10600020
*        AVTCPRCD)                                                    * 10800020
*   CHECKPOINT WORK AREA                                              * 11000020
*   DEB                                                               * 11200020
*   DCB                                                               * 11400020
*                                                                     * 11600020
*ATTRIBUTES: RE-ENTRANT                                               * 11800020
*                                                                     * 12000020
*NOTES - SEE BELOW                                             @G36XRNP 12060000
*                                                                     * 12120000
*      THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL          * 12200000
*   REPRESENTATION OF THE EXTERNAL CHARACTER SET WHICH IS             * 12400020
*   EQUIVALENT TO THE ONE USED AT ASSEMBLE TIME. THE CODING HAS       * 12600020
*   BEEN ARRANGED SO THAT REDEFINITION OF 'CHARACTER' CONSTANTS, BY   * 12800020
*   REASSEMBLY, WILL RESULT IN A CORRECT MODULE FOR THS NEW           * 13000020
*   DEFINITIONS                                                       * 13200020
*                                                                     * 13400020
*RESTRICTIONS - NONE                                           @G36XRNP 13420000
*                                                              @G36XRNP 13440000
*REGISTER CONVENTIONS - SEE REGISTER EQUATES                   @G36XRNP 13460000
*                                                              @G36XRNP 13480000
*PATCH - PATCH                                                 @G36XRNP 13500000
*                                                              @G36XRNP 13520000
*********************************************************************** 13600020
         SPACE 3                                                        13800020
*REGISTER ASSIGNMENTS                                                   14000020
         SPACE                                                          14200020
R0       EQU   0                        WORK REG6LENGTH OF LCB          14400020
R1       EQU   1                        PARM REG OR WORK REG;INVLEN     14600020
R2       EQU   2                        ADDRESS OF CKP WORK AREA        14800020
R3       EQU   3                        LENGTH OF TOTAL CKPT RECORD     15000020
R4       EQU   4                        REG 4                    S22024 15200022
RLCB     EQU   4                        ADDRESS OF LCB OR INV LIST      15400020
R5       EQU   5                        LENGTH OF TERMNAME              15600020
R6       EQU   6                        ADDRESS OF TERMNAME ENTRY       15800020
R7       EQU   7                        REG 7                    S22024 16000022
RQCB     EQU   7                        ADDRESS OF QCB;LNGTH-TOTSEG     16200020
R8       EQU   8                        REG 8                    S22024 16400022
RTERM    EQU   8                        ADDRESS OF TERM ENTRY:UCB       16600020
RAVT     EQU   9                        ADDRESS OF AVT                  16800020
R9       EQU   9                        REG 9                    S22024 17000022
RDCB     EQU   10                       ADDRESS OF DCB;BRANCH ADDR      17200020
R10      EQU   10                       REG 10                   S22024 17400022
RIOB     EQU   11                       ADDRESS OF IOB;INDEX-TNT        17600020
R11      EQU   11                       REG 11                   S22024 17800022
RBASE    EQU   12                       BASE                            18000020
R12      EQU   12                       REG 12                   S22024 18200022
R13      EQU   13                       SAVE AREA;BYTES /RECORD         18400020
R14      EQU   14                       RETURN REG ;ADDRESS OF DEB      18600020
R15      EQU   15                       ENTRY REG;INDEX-NO. EXTENTS     18800020
         SPACE 3                                                        19000020
*STANDARD LINKAGE                                                       19200020
         USING IGG01942,R15             SET TEMPORARY BASE       Y02027 19400006
         BAL   RBASE,QMB00              SET BASE REGISTER        Y02027 19800006
         DROP  R15                      DROP 15 AS BASE          Y02027 20200006
         USING *,RBASE                  ESTABLISH ADDRESSABILITY Y02027 20600006
         USING IEDQAVTD,RAVT            BASE FOR AVT                    21000020
         SPACE                                                          21200020
         USING IHADCB,RDCB              DCB ADDRESSABILITY       S22024 21600022
         USING IEDQCKPD,R8              CHANGE BASE FOR CKPT DSECT 0129 21700020
         SPACE 2                                                        21710006
G01942   IEDHJN ,                       SET THE DATE             Y02027 21720006
QMB00    EQU   *                                                 Y02027 21725006
         SPACE 2                                                        21730006
         USING FORCORE,R4               OPEN WORK AREA DSECT     Y02027 21750006
         L     R4,FOUR(R8)              ADDR OF OPEN WORK AREA   Y02027 21752006
         L     RDCB,DXUDCBAD            GET DCB ADDRESS          Y02027 21754006
         DROP  R4                                                Y02027 21756006
         L     R8,DCBIOBAD              GET WORK AREA ADDRESS    S22024 21758022
         LM    R14,R11,CKPSAVE1+12      RESTORE REGS SAVED BY    S22024 21766022
*                                        PREVIOUS LOAD           S22024 21774022
         LR    R8,R2                    RESET WORKAREA BASE      S22024 21782022
         MVC   AVTDPARM(1),DCBOPTCD     SAVE FOR LATER TESTS     S22024 21790022
         SPACE 3                                                        21800020
*CHECK FOR UNRECOVERABLE ERROR ENCOUNTERED BY IGG01943 AT RESTART  0819 22000020
         SPACE                                                          22200020
         TM    CKPFLAGS,CKPERR          CHECK ERROR FLAG           0819 22400020
         BNZ   QMB9804                  BRANCH IF ERROR FOUND      0819 22600020
         SR    R3,R3                    CLEAR                      1109 22610020
         IC    R3,CKPERRCT              GET ERR COUNT SET BY  1943 1109 22620020
         LTR   R3,R3                    CHECK FOR ERRORS           |109 22630020
         BZ    QMB20                    BRANCH IF NO ERRORS        1109 22640020
         SPACE 3                                                        22650020
*BEGINNING OF LOOP THROUGH COUNT OF ERROR MESSAGES                 1109 22660020
         SPACE                                                          22670020
QMB10    EQU   *                                                   1109 22680020
         MVC   AVTSAVE4(68),QMBMSG      MOVE MSG OUT OF TRANSNT ARA0115 22686020
         LA    R1,AVTSAVE4              ADDR OF MSG                0115 22692020
         WTO   MF=(E,(1))               ISSUE ERROR MSG            0115 22701020
         BCT   R3,QMB10                 SUBTRACT FROM COUNT OF ERRS1109 22710020
         LM    R14,R11,CKPSAVE1+12     RSTR REGS SVD BY 1941    SA56217 22715022
         MVC   0(5,R8),QMBWARM          SET ID FOR IGG01944        1109 22720020
         L     R15,FOUR(R8)             GET ADDRESS OF OPEN      Y02027 22723006
*                                       WORK AREA                Y02027 22726006
         B     QMB875                   XCTL TO NEXT LOAD FOR WARM 1109 22730020
         SPACE 3                                                        22800020
*THE NUMBER OF RECORDS REQUIRED FOR A TOTAL CHECKPOINT HAS BEEN         23000020
*DETERMINED. NOW FORMAT THE DISK WITH DUMMY RECORDS. WRITE ONE          23200020
*CONTROL RECORD, THEN WRITE THE NUMBER OF RECORDS NEEDED FOR TWO        23400020
*TOTAL RECORDS. DETERMINE THE NUMBER OF CKREQ RECORDS NEEDED (THE       23600020
*VALUE GIVEN ON INTRO +3 FOR DISK ERROR RECOVERY) AND WRITE THESE.      23800020
*DETERMINE IF THERE ARE ENOUGH TRACKS LEFT TO WRITE ANOTHER TOTAL       24000020
*PLUS ONE TRACK OF INCIDENTS.IF SO, WRITE THE RECORDS FOR ANOTHER       24200020
*TOTAL. WRITE AS MANY INCIDENT RECORDS AS THE REMAINING SPACE           24400020
*ALLOWS.                                                                24600020
         SPACE 3                                                        24800020
*WRITE CONTROL RECORD                                                   25200020
         SPACE                                                          25400020
QMB20    EQU   *                                                   1109 25500020
         XC    CKPTTRLI,CKPTTRLI                                SA64710 25700052
         MVI   CKPTTRCT,1               INITIALIZE CURNT ENV RCD   0826 26000020
         LA    R13,CKPCYLNO             PUT ADDR OF COUNT AREA INTO     26200020
         ST    R13,CKPRW                CCW TO WRITE COUNT,KEY,DATA     26400020
         MVI   CKPRW,CKPWCKD            PUT IN CODE FOR FORMAT WRIT     26600020
         SR    R0,R0                    RELATIVE TTR FOR R0             26800020
         LM    R1,R2,CKPCPARM           CONVERSION RESULT AND DEBAD     27000020
         XC    CKPKEYLN(2),CKPKEYLN     CLEAR LENGTH FIELD              27200020
         BAL   R13,QMB9905             GET SEEK ADDR FOR IOB            27400020
         MVC   CKPCYLNO(4),CKPIOCC      MOVE CYL AND TRACK TO COUNT     27600020
         MVC   CKPDATLN+1(1),CKPCRLEN   DATA LENGTH-CONTROL RECORD      27800020
         LA    R2,CKPCYLNO-3            ADDRESS FOR CONVERSION RSLT     28000020
         MVI   CKPRCDNO,1               PUT RECORD NO. INTO COUNT       28200020
         LA    R0,1                     RELATIVE TTR                    28400020
         BAL   R13,QMB98                WRITE CONTROL RCD AND WAIT      28600020
         SPACE 3                                                        28800020
*DETERMINE THE NUMBER OF ENVIRONMENT CHECKPOINTS TO WRITE.  THIS        29000020
*DEPENDS UPON THE CPRCK OPERAND ON INTRO AND THE AMOUNT OF SPACE        29200020
*IN THE CHECKPOINT DATA SET.  THE SMALLER VALUE IS USED.                29400020
         SPACE                                                          29600020
         LH    R5,CKPTRKSA              NO. OF TRACKS IN DATA SET       29800020
         SR    R10,R10                                                  30000020
         IC    R10,CKPRPERT             RCD SEGMENTS  PER TRACK         30200020
         MR    R4,R10                   NO. ENVIORNMENT RCD SEGMNTS    X30400020
                                        WHICH CAN BE WRITTEN THERE      30600020
         BCTR  R5,0                     SUBTRACT ONE RCD FOR           X30800020
                                        THE CONTROL RECORD              31000020
         TM    AVTDPARM,CKP3705         3705 CHECKPOINT DCB      S22024 31060022
         BO    QMB708                   YES, BRANCH              S22024 31120022
         SR    R14,R14                                                  31200020
         SR    R15,R15                                                  31400020
         SR    R11,R11                                                  31600020
         IC    R15,CKPCPERT             NO. CKREQ RCDS PER TRACK   0529 31800020
         MH    R15,QMB100H              MULTIPLY BY 100            0909 32000020
         DR    R14,R10                  GET INC PER ENV SEG        0909 32200020
         STH   R15,CKPIPERE             SAVE                            32400020
         LR    R11,R15                  SAVE RESULT                     32600020
         SR    R14,R14                  CLEAR FOR DIVISION              32800020
         SR    R15,R15                  CLEAR                      0910 33000020
         IC    R15,AVTNCKPR             VALUE OF CKREQS                 33200020
         STC   R15,CKPCKRQS             SAVE VALUE OF CKREQS-INTRO      33400020
         LA    R15,CKPCKRNO+1(,R15)     NO. OF INCIDENTS +CKREQS   0910 33600020
         LH    R10,CKPINCLN             LENGTH OF INCIDENT RCDS    0928 33800020
QMB55    EQU   *                                                   0928 34000020
         SH    R10,CKPCKRLN             SUBTRACT LENGTH OF CKREQ RC0928 34200020
         BNP   QMB60                    BRANCH NOT POSITIVE        0928 34400020
         LA    R15,1(R15)               ADD 1 TO NO. CKREQ         0928 34600020
         B     QMB55                    BRANCH IF INCIDENT RCD LARG0928 34800020
QMB60    EQU   *                                                   0928 35000020
         MH    R15,QMB100H              MULTIPLY BY 100            0909 35200020
         DR    R14,R11                  NO. OF ENV RCDS                 35400020
         LTR   R14,R14                  CHECK FOR REMAINDER             35600020
         BZ    QMB706                   C BRANCH IF NO REMAINDER        35800020
         LA    R15,1(0,R15)                                             36000020
QMB706   EQU   *                                                        36200020
         SPACE 3                                                        36400020
         SR    R5,R15                   NO. OF RCDS WHICH CAN BE USED  X36600020
                                        FOR ENV CHECKPOINT RCDS         36800020
         BC    12,QMB90                 BARNCH NOT POSITIVE             37000020
         LH    R10,CKPRCDSR             NO. OF SEGMENTS REQUIRED FOR   X37200020
                                        ONE ENV CHECKPOINT              37400020
         DR    R4,R10                   GET NO OF ENV CHECKPT RCDS     X37600020
                                        WHICH CAN BE WRITTEN            37800020
         SPACE 3                                                        38000020
         SR    R10,R10                  CLEAR REGISTER         @OY20541 38050086
         IC    R10,AVTCPRCD             NO OF ENV RCDS REQUESTED        38200020
         CR    R10,R5                   COMPARE                         38400020
         BNH   QMB707                   USE THE SMALLER VALUE           38600020
         LA    R15,ABENDA               SET 045 ABEND SUBCODE  @SA75746 38800009
         B     ABENDCDE                 BRANCH TO ABEND        @SA75746 38900009
         SPACE 3                                                        39000020
*SET UP FOR LOOP TO BUILD ALL THE ENVIORNMENT RECORD SEGMENTS           39200020
         SPACE                                                          39400020
QMB707   EQU   *                                                        39600020
         LH    R5,CKPRCDSR              NO. RCDS REQUIRED-TOTAL  S22024 39660022
QMB708   EQU   *                                                 S22024 39720022
         STC   R10,CKPCPRCD             SAVE COUNT OF ENV RCDS     0909 39800020
         CH    R10,AVTHA2               CHECK FOR MINIMUM OF 2          40000020
         BL    QMB90                    BRANCH IF LESS THAN MINIMUM     40200020
         MVI   CKPIOR,1                 PUT RECORD NO. INTO IOB         40400020
         LA    R0,2                     RELATIVE TTR                    40600020
         MVC   CKPDATLN,CKPBPERR        PUT DATA LENGTH INTO COUNT      40800020
         MVI   CKPRCDNO,2               PUT RCD NO. INTO COUNT AREA     41000020
         SR    R3,R3                                                    41200020
         IC    R3,CKPRPERT              GET TCDS PER TRACK              41400020
         LA    R4,CKPTTRT1                                              41800020
         LR    R7,R3                    NO. OF RECORDS ON TRACK         42000020
         BCTR  R7,0                     SUBTRACT 1 FOR CONTROL RCD      42200020
         SPACE 3                                                        42400020
*BEGINNING OF LOOP TO WRITE ALL ENVIORNMENT CHECKPOINTS                 42600020
         SPACE                                                          42800020
QMB71    EQU   *                                                        43000020
         ST    R0,CKPTRMAD                                              43200020
         MVC    0(3,R4),CKPTRMAD+1      MOVE TTR TO CONTROL RECORD      43400020
         MVC   3(2,R4),CKPTRKLN         SAVE DATA ON TRACK PRECEDING415X43460000
                                        THIS ENV SEGMENT           G415 43520000
         BAL   R11,QMB91                WRITE RECORD                    43600020
         LA    R4,CKPTTRLN(,R4)         MOVE TO NEXT TTR SLOT      0415 43800000
         BCT   R10,QMB71                SUBTRACT FROM NO OF RCDS        44000020
         SPACE 3                                                        44200020
*SET UP FOR LOOP TO WRITE CKREQ RECORDS                                 44400020
         SPACE                                                          44600020
         CR    R7,R3                    CHECK FOR NEW TRACK        0529 44800020
         IC    R3,CKPCPERT              NO. OF CKREQ RCDS PER TRACK     45000020
         BNE   QMB7105                  BRANCH IF NEW TRACK        0529 45200020
         LR    R7,R3                    INITIALIZE TO NO RCDS/TRCK      45400020
         B     QMB72                     NO WORRY ABOUT PARTIAL TRK0529 45600020
QMB7105  EQU   *                                                   0529 45800020
         LH    R6,CKPIPERE              GET COUNT OF INCIDENT PER E     46000020
         MR    R6,R6                                                    46200020
         D     R6,QMB100F               DIVIDE BY 100              0909 46400020
QMB72    EQU   *                                                        46600020
         ST    R0,CKPTTRCR-1            TTR OF 1ST CKREQ RECORD         46800020
         LTR   R11,R7                   GET COUNT OF CKREQ ON TRK  0114 46860020
         BNZ   QMB73                    BRANCH IF COUNT IS NOT ZERO0114 46920020
         LA    R7,1                     SET COUNT TO 1             0114 46980020
         B     QMB72                    TRY AGAIN                       47040020
QMB73    EQU   *                                                   0115 47100020
         BCTR  R11,0                    SUBTRACT ONE               0824 47200020
         AR    R11,R0                   GET TTR OF LAST RCD ON TRK 0824 47400020
         STC   R11,CKPCRRNO             SAVE TTR OF LAST RCD       0824 47600020
         L     R10,CKPCTTRB             BEGINNING OF CKTTR-TABLE        47800020
         OI    CKPFLAGS,CKPOPNCR        TURN ON OPEN CKREQ FLAG FOR    *48000020
                                        SUBROUTINE                      48200020
         MVC   CKPDATLN(2),CKPCKRLN     LENGTH OF CKREQ RCD             48400020
         SR    R5,R5                    CLEAR                           48600020
         IC    R5,AVTNCKPR              GET NO. OF CKREQ QUEUES         48800020
         LTR   R5,R5                    CHECK FOR NO CKREQS SPECIFIED   49000020
         BZ    QMB75                    BRANCH IF ZERO                  49200020
         LA    R5,CKPCKRNO(0,R5)        ADD EXTRAS(FOR DISK ERRORS)     49400020
         SPACE                                                          49600020
         BAL   R11,QMB91                WRITE RECORDS                   49800020
QMB75    EQU   *                                                        50000020
         NI    CKPFLAGS,X'FF'-CKPOPNCR  TURN OFF OPEN CKREQ FLAG        50200020
         SPACE 3                                                        50400020
*SET UP FOR LOOP TO WRITE INCIDENT RECORDS ON ALL REMAINING DISK        50600020
*SPACE                                                                  50800020
         SPACE                                                          51000020
         SR    R13,R13                  CLEAR                      0626 51200020
         IC    R13,CKPIPERT             GET NO. INC PER TRACK      0626 51400020
         SR    R3,R13                   GET DIFFERENCE FROM CKREQS 0626 51600020
         BNP   QMB80                    BRANCH IF MORE INCIDENT RCD0626X51800020
                                        FIT ON ONE TRACK           0626 52000020
         SR    R7,R3                    GET NO. INC RCDS ON 1ST TRK0626 52200020
         BP    QMB80                    BRANCH IF POSITIVE RESULT  0910 52400020
         LA    R7,1                     TRY WRITING 1 RCD ON TRK   0910 52600020
QMB80    EQU   *                                                   0626 52800020
         LA    R5,X'FF'                 MAXIMUM NO OF INCIDENTS SA64712X53000052
                                        TO WRITE. LET CONVERSION       X53200020
                                        ROUTINE FIGURE END OF DATA      53400020
         LA    R11,QMB82                BRANCH ADDRESS                  53600020
         BAL   R13,QMB9905              CHECK FOR END OF DATA SET       53800020
         ST    R0,CKPTTRIN-1            TTR OF 1ST INCIDENT RCD         54000020
         MVC   CKPSECIN,CKPTRKLN        SAVE TRK LENGTH FOR 1ST INC0504 54100000
         LR    R11,R7                   COPY TTR OF 1ST RCD        0824 54200020
         BCTR  R11,0                    SUBTRACT ONE               0824 54400020
         AR    R11,R0                   GET TTR OF LAST RCD ON TRAK0824 54600020
         STC   R11,CKPINRNO             SAVE TTR OF LAST RCD       0824 54800020
         SR    R3,R3                    CLEAR REG                  0625 55000020
         IC    R3,CKPIPERT              COUNT OF INCIDENTS PER TRACK    55200020
         MVC   CKPDATLN(2),CKPINCLN     LENGTH OF INCIDENT RCD          55400020
         BAL   R11,QMB91                WRITE RECORDS                   55600020
         LTR   R6,R6                    CHECK FOR 255 RCDS WRITTEN 1202 55840020
         BNM   QMB81                    BRNNCH IF LESS THAN 255 RCD1202 55880020
         SR    R6,R6                    ZERO REG FOR SUBTRACTIONSA64712 55920052
QMB81    EQU   *                                                        55960020
         SR    R5,R6                    NUMBER OF RECORDS WRITEN        56000020
QMB82    EQU   *                                                        56200020
         STC   R5,CKPINCNO              SAVE NO. AVAILABLE RECORDS      56400020
         STC   R5,CKPINCNT              SAVE NO. AVAILABLE RECORDS      56600020
         OI    AVTCKFLG,AVTCKTAC        SET TCAM CKPT ACTIVE   @G36XRNP 56650000
         EJECT                                                          56700006
         SPACE 3                                                        56800020
*OPEN PROVIDES SECTION TO SET UP XCTL TO NEXT MODULE                    57000020
         SPACE                                                          57200020
QMB87    EQU   *                                                        57400020
         XC    CKPCYLNO(CKPCTTRB-CKPCYLNO),CKPCYLNO  CLEAR THE PART    X57600020
                                        OF THE WORK AREA USED BY       X57800020
                                        OPEN                            58000020
         LM    R14,R11,CKPSAVE1+12     RSTR REGS SVD BY 1941            58200022
         L     R15,FOUR(R8)             GET ADDRESS OF OPEN      Y02027 58260006
*                                       WORK AREA                Y02027 58320006
QMB873   EQU   *                                                        58400020
         XC    0(2,R8),0(R8)            CLEAR TO INDICATE COMPLETE      58600020
QMB875   EQU   *                                                        58800020
         LA    R8,8(R8)                 INCREMENT CURRENT WTO ENTRY     59000020
         LA    R7,4(R7)                 INCREMENT CURRENT DCB LIST      59200020
         CLC   ZERO(TWO,R8),AMIDCNST    IS THIS EXECUTOR NEEDED  Y02027 59400006
*                                         AGAIN                  Y02027 59500006
         BE    QMB00                    YES, RETURN TO PROCESS ITS22024 59600022
         CLC   0(2,R8),QMB0S            END OF WTG TABLE                59800020
         BNE   QMB875                   NO,GO CHECK NEXT ENTRY          60000020
         LR    R7,R5                    RESET PARM LIST ADDR            60200020
         LA    R8,32(R6)                RESET WTO TABLE POINTER         60400020
         SPACE                                                          60600020
QMB88    EQU   *                                                        60800020
         CLI   0(R8),0                  IS THIS ENTRY ZERO              61000020
         BNE   QMB89                    NO,XCTL                         61200020
         LA    R8,8(0,R8)               ADDRESS OF NEXT ENTRY           61400020
         LA    R7,4(0,R7)               ADDRESS OF NEXT DCB             61600020
         B     QMB88                    BRANCH TO TEST NEXT ENTRYS22024 61800022
         SPACE 3                                                        62000020
*TRANSFER CONTROL TO NEXT EXECUTOR OF FIRST INCOMPLETE DCB              62200020
         SPACE                                                          62400020
QMB89    EQU   *                                                        62600020
         SPACE 1                                                        62610006
         MODESET EXTKEY=DATAMGT         RETURN TO KEY 5          Y02027 62620006
         SPACE 2                                                        62630006
         DROP  R8                       DROP 8 AND USE 2 AS        0216 62660020
         USING IEDQCKPD,R2              BASE FOR CKPT WORK AREA    0216 62720020
         LA    R15,DXCCW12-FORCORE(R15) GET PARM LIST            Y02027 62800006
         DROP  R2                       SWITCH BACK TO             0219 62860020
         USING IEDQCKPD,R8              REGISTER 8                 0219 62920020
         MVC   6(2,R6),0(R8)            EXECUTOR ID TO PARM             63000020
         MVC   14(3,R6),2(R8)           TTR TO WTG TABLE                63200020
         SPACE                                                          63400020
         XCTL  DE=(R6),SF=(E,(15))                                      63600020
         EJECT                                                          63700006
         SPACE                                                          63800020
         SPACE 3                                                        64000020
*SUBROUTINE TO SET UP LOOP AND WRITE THE NEEDED NUMBER OF RECORDS.      64200020
*R11 IS USED AS THE BRANCH REG                                          64400020
         SPACE                                                          64600020
QMB91    EQU   *                                                        64800020
         LR    R6,R5                    INIT. COUNT OR RCDS             65000020
         SPACE 3                                                        65200020
*BEGINNING OF LOOP TO WRITE RECORDS                                     65400020
         SPACE                                                          65600020
QMB92    EQU   *                                                        65800020
         TM    CKPFLAGS,CKPOPNCR        CHECK FOR CKREQ BEING WRITN     66000020
         BZ    QMB93                    BRANCH IF NOT CKREQ             66200020
         ST    R0,CKPTRMAD              PUT TTR IN CKREQ TTR TABLE      66400020
         MVI   CKPCTFLG(R10),0          CLEAR FLAG                      66600020
         MVC   CKPCTTTR(3,R10),CKPTRMAD+1  PUT TTR INCKREQ-TTR TBL      66800020
         XC    CKPCTOFF(2,R10),CKPCTOFF(R10) CLEAR OFFSET               67000020
         MVC   CKPCTSEC(2,R10),CKPTRKLN SAVE DATA ON TRACK        0415X 67100000
         LA    R10,CKPCTTRL(0,R10)      MOVE TO NEXT TABLE ENTRY        67200020
QMB93    EQU   *                                                        67400020
         BAL   R13,QMB98                WRITE RECORDS                   67600020
         BCT   R7,QMB94                 DECREMENT RCDS TO WRITE ON     *67800020
                                        THIS TRACK, BRANCH NOT ZERO     68000020
         SPACE                                                          68200020
*END OF THRACKHAS BEEN REACHED,UPDATE TTR TO NEXT TRACK                 68400020
         SPACE                                                          68600020
         IC    R0,CKPKEYLN              CLEAR OUT RCD NUMBER            68800020
         LR    R15,R0                                                   69000020
         LA    R0,CKP101(0,R15)         BUMP TRACK NUMBER               69200020
         LR    R7,R3                    REINTIALIZE COUNT/TRACK         69400020
         XC    CKPTRKLN,CKPTRKLN        RESET DATA ON TRACK TO 0   0415 69500000
         BAL   R13,QMB9905             GET SEEK ADDR FOR IOB-R0         69600020
QMB94    EQU   *                                                        69800020
         MVC   CKPIOM(8),CKPCYLNO-3     UPDATE MBBCCHHR IN IOB          70000020
         LR    R15,R0                   TTR                             70200020
         LA    R0,1(R15)                BUMP RECORD NUMBER              70400020
         BAL   R13,QMB9905              CONVERT TTR                     70600020
         BCT   R6,QMB92                 DECREMENT RCDS TO WRITE,       *70800020
                                        BRANCH IF NOT ALL WRITTEN       71000020
         SPACE                                                          71200020
*END OF LOOP                                                            71400020
QMB95    EQU   *                                                 S22024 71450022
         TM    AVTDPARM,CKP3705         3705 CHECKPOINT DCB      S22024 71500022
         BZR   R11                      NO, EXIT               @G36XRNP 71510000
         OI    AVTCKFLG,AVTCKNAC        SET 3705 CKPT ACTIVE   @G36XRNP 71520000
         B     QMB87                    PREPARE TO EXIT        @G36XRNP 71530000
         SPACE                                                          72000020
*END OF SUBROUTINE                                                      72200020
         SPACE 3                                                        72400020
*SUBROUTINE TO CONVERT TTR, ISSUE EXCP, AND WAIT (USES R13 AS           72600020
*BRANCH REG.)                                                           72800020
         SPACE                                                          73000020
QMB98    EQU   *                                                        73200020
         STM   R0,R1,CKPSAVE1           SAVE SUPERVISOR REGS            73400020
QMB9802  EQU   *                                                   0415 73510000
         LH    R1,CKPTRKLN              GET DATA ON TRACK SO FAR   0415 73520000
         AH    R1,CKPDATLN              ADD DATA JUST WRITTEN      0415 73530000
         STH   R1,CKPTRKLN              RESTORE DATA LENGTH        0415 73540000
         EXCP  CKPIOB                   START I/O                       73600020
         SPACE                                                          73800020
         WAIT ECB=CKPECB                WAIT FOR COMPLETION             74000020
         SPACE                                                          74200020
         LM    R0,R1,CKPSAVE1           RESTORE SUPERVISOR REGS         74400020
         TM    CKPECB,X'7F'             CHECK FOR DISK ERROR            74600020
         BCR   1,R13                   BRANCH IF NO ERROR               74800020
         SPACE 3                                                        75000020
*PERMANANT DISK ERROR-WTO                                               75200020
         SPACE                                                          75400020
QMB9804  EQU   *                                                   0819 75600020
         LA    R13,DISKERR              SET OFFSET TO MESSAGE    S22024 75800022
         B     QMB99                    BRANCH                   S22024 76200022
         SPACE 3                                                        76400020
*INSUFFICIENT DISK SPACE FOR MINIMUM  CHECKPOINT REQUIREMENTS           76600020
         SPACE                                                          76800020
QMB90    EQU   *                                                        77000020
         LA    R13,DISKALOC             SET OFFSET TO MESSAGE    S22024 77500022
         SPACE                                                          78000020
QMB99    EQU   *                                                        78200020
         MVC   AVTSAVE4(DDL),IEDNMG     MOVE MSG MODULE NAME     S22024 78400022
         LOAD  EPLOC=AVTSAVE4           LOAD MSG MODULE          S22024 78420022
         ALR   R13,R0                   GET ADDR OF PTR TO MSG   S22024 78440022
         L     R1,AVTEZERO(R13)         GET ADDR OF MESSAGE      S22024 78460022
         L     R13,AVTTCB               GET TCB ADDRESS          S22024 78480022
         L     R13,TCBTIO(R13)          GET TIOT ADDRESS         S22024 78500022
         L     RDCB,CKPIODCB-ONE        RELOAD DCB ADDRESS       S22024 78520022
         AH    R13,DCBTIOT              GET TIOE ADDRESS         S22024 78540022
         MVC   DDNAME(DDL,R1),TIOEDDNM(R13) MOVE DDNAME TO MSG   S22024 78560022
         WTO   MF=(E,(1))               WRITE MSG                       78600020
         DELETE EPLOC=AVTSAVE4          DELETE MSG MODULE        S22024 78610022
         TM    AVTDPARM,CKP3705         3705 CHECKPOINT DCB      S22024 78620022
         BZ    QMB9903                  NO, BRANCH               S22024 78640022
         L     RDCB,CKPIODCB-1          RELOAD DCB ADDRESS       S22024 78660022
         XC    DCBIOBAD+ONE(THREE),DCBIOBAD+ONE ZERO TO SHOW NOT S22024 78680022
*                                        OPENED DUE TO I/O ERROR S22024 78700022
         LA    R0,CKPLNGTH+CKPTTRLN     GET LENGTH OF AREA     @G36XRNP 78704000
         LR    R1,R8                    GET ADDRESS OF AREA    @G36XRNP 78708000
         ICM   R0,HI,AVTGETMN+NINE      GET SUBPOOL ADDRESS    @G36XRNP 78712000
         FREEMAIN R,LV=(0),A=(1)        FREE THE WORKAREA      @G36XRNP 78716000
         B     QMB87                    AND EXIT                 S22024 78720022
QMB9903  EQU   *                                                 S22024 78740022
         LA    R15,ABEND9               SET 045 ABEND SUBCODE  @SA75746 78760009
ABENDCDE EQU   *                                               @SA75746 78780009
         LA    R13,AVTSAVE2             GET SAVE AREA FOR ABEND SA59025 79100022
         BAL   R14,AVTABEND             ABEND WITH 045-9 OR -A @SA75746 79400009
         SPACE 3                                                        79600020
*CONVERT TTR                                                            79800020
         SPACE                                                          80000020
QMB9905  EQU   *                                                        80200020
         STM   RAVT,R0,CKPSAVE2         SAVE REGS USED BY CONVERT  0224 80400020
         L     R15,16                   GET CVT                         80600020
         L     R15,28(0,R15)            GET CONVERSION RTN              80800020
         SLL   R0,8                     POSITION TTR                    81000020
         BALR  R14,R15                  BRANCH TO CONVERT               81200020
         SPACE                                                          81400020
         LTR   R15,R15                  CHECK FOR VALID TTR             81600020
         SPACE                                                          81800020
         LM    RAVT,R0,CKPSAVE2         RESTORE REGS               0224 82000020
         BNZ   QMB95                    BR IF END OF DATA SET    S22024 82200022
         BR    R13                      RETURN                          82400020
         SPACE                                                          82600020
*END OF SUBROUTINE                                                      82800020
         SPACE 3                                                        83000020
         DS    0F                                                  0909 83200020
QMB100F  DC    H'0'                     USED TO GET ACCURATE TO    0909 83400020
QMB100H  DC    H'100'                   NEAREST 100TH OF RCD COUNT 0909 83600020
QMB0S    DC    C'0S'                    ID FOR SYSTEM OPEN       S22024 83800022
QMBFLAG  DC    X'8000'                  FLAG FOR CONVRT RTN 0507 S21101 83900000
AMIDCNST DC    C'42'                    ID FOR THIS EXECUTOR     Y02027 83920006
ZERO     EQU   0                        OFFSET                   Y02027 83940006
TWO      EQU   2                        OFFSET                   Y02027 83960006
FOUR     EQU   4                        OFFSET                   Y02027 83980006
DISKERR  EQU   28                       OFFSET TO DISK ERROR MSG S22024 84000022
DISKALOC EQU   24                       OFFSET TO DISK ALLOCATIONS22024 84050022
*                                        ERROR MESSAGE           S22024 84100022
TCBTIO   EQU   12                       TIOT IN TCB              S22024 84150022
TIOEDDNM EQU   4                        DDNAME IN TIOE           S22024 84200022
DDNAME   EQU   12                       OFFSET TO DDNAME IN MSG  S22024 84250022
DDL      EQU   8                        LENGTH OF DDNAME         S22024 84300022
IEDNMG   DC    CL8'IEDNMG'              NAME OF MESSAGE MODULE   S22024 84350022
ONE      EQU   1                        OFFSET OF ONE            S22024 84410022
THREE    EQU   3                        LENGTH OF THREE          S22024 84420022
ABENDA   EQU   X'A'                     045 ABEND SUBCODE      @SA75746 84425009
ABEND9   EQU   9                        045 ABEND SUBCODE       SA59025 84430022
CKP3705  EQU   X'10'                    OPCTD=I                  S22024 84430122
NINE     EQU   9                        DISPLACEMENT           @G36XRNP 84439100
HI       EQU   8                        HI-ORDER MASK          @G36XRNP 84448100
QMBMSG   WTO   'IED083I CHECKPOINT DISK ERROR-RECOVERY FROM PREVIOUS REX84460020
               CORD',ROUTCDE=11,DESC=4,MF=L                        0115 84520020
PATCH    DC    4F'0'                    PATCH AREA             @G36XRNP 84720000
         EJECT                                                          85000006
*CODE TO ROUND OUT MOUDULE TO 1024 BYTES IN LENGTH                      85200020
         SPACE                                                          85400020
NENT     EQU   1                        VALUE 1                  S22024 85600022
LENGTH   EQU   NENT*6+6                 LENGTH                   S22024 85800022
NODBWDS  EQU   (LENGTH+7)/8             LENGTH                   S22024 86000022
ORGIDTTR EQU   1024-NODBWDS*8           ADDRESS                  S22024 86200022
         ORG   IGG01942+ORGIDTTR        EXTEND TO FULL SIZE      S22024 86400022
QMBWARM  DC    C'44'                    ID FOR WARM START          1109 86500020
         DC    XL4'0'                   TTR AND LENGTH             1109 86600020
IDEND    DC    X'0000'                  END OF MODULE NAMELIST   S22024 86800022
         CNOP  4,8                                                      87000020
LOADID   DC    C'019'                   OPEN ID                  S22024 87200022
         DC    YL1(X'80'-NODBWDS)       ADJUST MODULE LENGTH     S22024 87400022
         SPACE 3                                                        87600020
         TAVTD                                                          88000020
         TCKPD 3330                     MERLIN VERSION OF DSECT    0426 88200000
         DCBD  DSORG=TX                                                 88400020
         EJECT                                                          88600006
FORCORE  DSECT                                                   Y02027 89600006
         IECDSECT                                                       90600006
         EJECT                                                          91600006
         END                                                            92800020
