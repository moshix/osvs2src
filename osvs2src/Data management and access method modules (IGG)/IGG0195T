         TITLE 'IGG0195T - OPEN, FULL TRACK INDEX WRITE'                00010019
IGG0195T CSECT                                                          00011002
*                                                                       00012002
*********************************************************************** 00013002
*                                                                     * 00014002
* MODULE-NAME = IGG0195T                                              * 00015002
*                                                                     * 00016002
* DESCRIPTIVE-NAME = ISAM OPEN, FULL TRACK INDEX WRITE                * 00017002
*                                                                     * 00018002
* COPYRIGHT = NONE                                                    * 00019002
*                                                                     * 00020002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00021002
*                                                                     * 00022002
* FUNCTION = CALCULATE SIZE OF CP20 AND TISA (TRACK INDEX SAVE AREA)  * 00023002
*            AND GET CORE FROM SUBPOOL 250 FOR BOTH.  INITIALIZE      * 00024002
*            BOTH TISA AND CP20, USING CP20A FOR A FULL TRACK OF      * 00025002
*            TRACK INDEX ENTRIES, CP20B FOR A SHARED TRACK OF TRACK   * 00026002
*            INDEX ENTRIES, AND CP20C FOR WRITE CHECK OF CP20A/20B.   * 00027002
*            STORE ADDRESSES OF CP'S IN ISLVPTRS.  FOR VIRTUAL USERS, * 00028002
*            SPLIT CP20B FROM CP20C, AND CP20C FROM CP18 TO PREVENT   * 00029002
*            LONG CHANNEL PROGRAMS.                                   * 00030002
*                                                                     * 00032002
* NOTES = SEE BELOW                                                   * 00033002
*                                                                     * 00034002
*    DEPENDENCIES = NONE                                              * 00035002
*                                                                     * 00036002
*    RESTRICTIONS = NONE                                              * 00037002
*                                                                     * 00038002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00039002
*                                                                     * 00040002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00041002
*                                                                     * 00042002
* MODULE-TYPE = OPEN EXECUTOR                                         * 00043002
*                                                                     * 00044002
*    PROCESSOR = ASSEMXF-370R                                         * 00045002
*                                                                     * 00046002
*    MODULE-SIZE = 1043 DECIMAL BYTES                                 * 00047002
*                                                                     * 00048002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00049002
*                                                                     * 00050002
* ENTRY-POINT = IGG0195T                                              * 00051002
*                                                                     * 00052002
*    PURPOSE = SEE FUNCTION                                           * 00053002
*                                                                     * 00054002
*    LINKAGE = RECEIVES CONTROL FROM ISAM OPEN EXECUTOR IGG0195D FOR  * 00055002
*              RESUME LOAD WITH HIGH LEVEL INDICES, OR IGG0196G FOR   * 00056002
*              RESUME LOAD WITHOUT HIGH LEVEL INDICES, OR IGG0192G    * 00057002
*              FOR INITIAL LOAD.  RECEIVES CONTROL IN STORAGE PROTECT * 00057202
*              KEY 5 AND PRIVILEGED STATE.                            * 00057402
*                                                                     * 00058002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00059002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00060002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00061002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00062002
*               PARAMETER LIST                                        * 00063002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00064002
*                                                                     * 00065002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00066002
*          UPON ENTRY TO THIS MODULE                                  * 00067002
*                                                                     * 00068002
* EXIT-NORMAL = XCTL TO ISAM OPEN EXECUTOR IGG0195U IN STORAGE        * 00069002
*               PROTECT KEY 5.                                        * 00069202
*                                                                     * 00070002
* EXIT-ERROR = NONE                                                   * 00071002
*                                                                     * 00076002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00077002
*                                                                     * 00078002
*    ROUTINES = NONE                                                  * 00079002
*                                                                     * 00081002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00082002
*                 FORCORE - OPEN WORK AREA                            * 00083002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00084002
*                                                                     * 00085002
*    CONTROL-BLOCKS = DCB COPY, DEB, AND IOB.                         * 00086002
*                                                                     * 00087002
* TABLES = NONE                                                       * 00088002
*                                                                     * 00089002
* MACROS = MODESET, GETMAIN, AND XCTL.                                * 00090002
*                                                                     * 00091002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00092002
*                                                                     * 00093002
*                                                                     * 01041002
*********************************************************************** 01042002
         EJECT                                                          01043002
********************                                                    01044002
* DCB REFERENCE    *                                                    01060019
********************                                                    01080019
         DCBD  DSORG=(IS)                                               01100019
         USING IHADCB,DCBREG                                            01120019
         EJECT                                                          01140019
DEB      IGGDEBD                        DEB DSECT                       01190000
         EJECT                                                          01940019
ISLCOMON IGGLOAD                                                        01950020
         USING ISLCOMON,ISLREG                                   S20201 01960020
         SPACE 3                                                        01980002
IOBBCT   DSECT                                                          03360019
         USING IOBBCT,BCTREG                                            03380019
         DS    0D                                                       03400019
IOBFLAGS DS    0CL1                     FLAGS                           03420019
IOBPTRA  DS    A                        PTR A                           03440019
IOBB     DS    0CL1                     B                               03460019
IOBPTRB  DS    A                        PTR B                           03480019
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03500019
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03520019
         SPACE 3                                                        03540002
********************                                                    03560019
* IOB REFERENCE    *                                                    03580019
********************                                                    03600019
*                                                                       03620019
IHAIOB   DSECT                                                          03640019
         USING IHAIOB,IOBREG                                            03660019
         DS    0D                                                       03680019
IOBFLG1  DS    CL1                      FLAGS 1                         03700019
IOBFLG2  DS    CL1                      FLAGS 2                         03720019
         DS    CL1                                                      03740019
IOBSNSE  DS    CL1                      SENSE                           03760002
IOBECBAD DS    A                        ECB POINTER                     03780019
IOBCSWD  DS    CL8                      CHANNEL STATUS WORD             03800002
IOBSIOC  DS    0CL1                     SIO CC                          03820002
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       03840019
IOBWT    DS    0CL1                     WEIGHT                          03860019
IOBDCBAD DS    A                        DCB POINTER                     03880019
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     03900019
IOBBCTI  DS    CL2                      BLK CTR INCR                    03920019
IOBECT   DS    CL2                      ERROR CTR                       03940019
IOBDADAD DS    0CL8                                                     03944019
IOBDADA0 DS    CL1                      M                               03948019
IOBDADA1 DS    CL1                       B                              03952019
IOBDADA2 DS    CL1                        B                             03956019
IOBDADA3 DS    CL1                         C                            03960019
IOBDADA4 DS    CL1                          C                           03964019
IOBDADA5 DS    CL1                           H                          03968019
IOBDADA6 DS    CL1                            H                         03972019
IOBDADA7 DS    CL1                             R                        03976019
*                                                                       03980019
         EJECT                                                          04000019
******************************                                          04010002
* OPEN WORK AREA REFERENCE   *                                          04020002
******************************                                          04030002
*                                                                       04040002
FORCORE  DSECT                                                          04050002
         IECDSECT                                                Y02072 04060002
         EJECT                                                          04080002
IGG0195T CSECT                                                          04120019
         BALR  BASEREG,0                LOAD BASE REGISTER              04140019
         USING *,BASEREG                ESTABLISH BASE FOR CSECT        04160019
BASETAG  L     DCBREG,0(RPARC)          C(DCBREG)=A(DCB)                04180019
         L     RCORE,4(RWTGC)           C(RCORE)=A(OPEN WORK AREA)      04200019
         L     ISLREG,DCBWKPT1          C(ISLREG)=A(ISL WORK AREA)      04220019
         USING FORCORE,RCORE            OPEN WA ADDRESSABILITY   Y02072 04230002
         STM   R0,R15,DXCCW1            SAVE REGS FOR EXIT       Y02072 04240002
*                                                                       04300019
* EQUATE SYMBOLIC REGISTERS                                             04320019
*                                                                       04340019
R0       EQU   0                                                        04360019
DCBREG   EQU   1                        DCB                             04380019
IOBREG   EQU   2                        IOB                             04400019
WORKREG  EQU   3                                                        04420019
TISAREG  EQU   4                                                        04440019
GETREG   EQU   5                                                        04460019
GETREGA  EQU   6                                                        04480019
GETREGB  EQU   7                                                        04500019
GETREGC  EQU   8                                                        04520019
BASEREG  EQU   9                        BASE FOR THIS MODULE            04540019
VPTRREG  EQU   10                       ISLVPTRS                        04560019
BCTREG   EQU   11                                                       04580019
ISLREG   EQU   12                       ISLCOMON                        04600019
SAVEREG  EQU   13                                                       04620019
REG14    EQU   14                                                       04640019
R15      EQU   15                                                       04660019
RBASE    EQU   3                                                        04680019
RCORE    EQU   4                                                        04700019
RPAR     EQU   5                                                        04720019
RWTG     EQU   6                                                        04740019
RPARC    EQU   7                                                        04760019
RWTGC    EQU   8                                                        04780019
RJ       EQU   15                                                       04880019
K0       EQU   0                        CONSTANT                 S20201 04901020
K32      EQU   32                       CONSTANT                 S20201 04902020
K48      EQU   48                       CONSTANT                 S20201 04903020
K16      EQU   16                       CONSTANT                 S20201 04904020
K8       EQU   8                        CONSTANT                 S20201 04905020
SSECT    EQU   X'23'                    SET SECTOR               S20201 04906020
K2       EQU   2                        CONSTANT                 S20201 04907020
K4       EQU   4                        CONSTANT                 S20201 04908020
EOC      EQU   X'10'                    END OF CYLINDER                 04908401
FLAG     EQU   10                       TISA FLAG BYTE                  04908801
NOTVIRT  EQU   8                        NOT VIRTUAL CONDITION           04909200
VIRTUAL  EQU   X'80'                    VIRTUAL MARKER                  04909300
L8       EQU   8                        CCW LENGTH                      04909601
         EJECT                                                          04910019
*                                                                       05000019
         LA    IOBREG,ISLIOBA           C(IOBREG)=A(IOBA)               05010019
         L     VPTRREG,DCBWKPT6         C(VPTRREG)=A(VPTRS)             05020019
*********************************************************************** 05030019
*                                                                       05040019
*              INITIALIZE CHANNEL PROGRAM 20 FOR FULL TRACK             05050019
*              INDEX WRITE.                                             05060019
*                                                                       05070019
*              CP20A - FULL TRACK OF TRACK INDEX ENTRIES                05080019
*                                                                       05090019
*                      8(ISLHIRT)+32 IF WRITE CHECK OR                  05100019
*                                +40 IF NO WRITE CHECK                  05110019
*                                                                       05120019
*                      8(ISLNIRT) IF TRACK INDEX IS ON ONE TRACK        05130019
*                                                                       05140019
*              CP20B - SHARED TRACK OF TRACK INDEX ENTRIES              05150019
*                                                                       05160019
*                      8(3(ISLNIRT))+32 IF WRITE CHECK OR               05170019
*                                +40 IF NO WRITE CHECK                  05180019
*                                                                       05190019
*                      3(ISLNIRT) - SRCH, TIC AND WRITE FOR             05200019
*                                   EACH ENTRY                          05210019
*                                                                       05220019
*              CP20C - WRITE CHECK FOR CP20A/B                          05230019
*                                                                       05240019
*                      8(3(ISLHIRT OR ISLNIRT))+40                      05250019
*                                                                       05260019
*                                                                       05270019
*                                                                       05280019
*              CALCULATE THE SIZE OF CHANNEL PROGRAM 20B                05290019
*                                                                       05300019
*********************************************************************** 05310019
*                                                                       05312002
         MODESET KEYADDR=DXUKEY,WORKREG=6  SET USERS KEY         Y02072 05314002
*                                                                       05314402
         LR    R0,RCORE                 OPEN WORK AREA ADDR      Y02072 05316002
         DROP  RCORE                    END WORK AREA USING      Y02072 05318002
*                                                                       05318802
         SR    GETREGA,GETREGA          CLEAR GETREGA                   05320019
         SR    GETREGB,GETREGB          CLEAR GETREGB                   05330019
         SR    GETREGC,GETREGC          CLEAR GETREGC                   05340019
         CLI   DCBHIRSH,X'00'           TEST FOR SHARED TRK             05350019
         BE    FTI01                    NO CALCULATE CP20A              05360019
         IC    GETREGB,ISLNIRT+2        R OF DUMMY ENTRY                05370019
         LR    SAVEREG,GETREGB          SAVE MAX NO OF ENTRIES          05380019
*                                       FOR CP20C                       05390019
         LR    TISAREG,GETREGB          SAVE FOR TISA CALCULATIONS      05400019
         MH    GETREGB,ISL24            3 CCW'S FOR EACH ENTRY   S20201 05410020
         LA    GETREGB,K32(GETREGB)     ADD 8 FOR TIC (3RD CCW)  S20201 05420020
*                                       PLUS 16 FOR TIC TO WR CHK       05440019
*                                       OR SEEK AND TIC TO CP 18        05450019
*                                       PLUS 8 FOR NOP/SET SECTOR       05455020
         CLI   ISLNIRT+1,X'00'          TI ON ONE TRACK                 05460019
         BE    FTI03                    YES-SKIP CALC FOR CP20A         05470019
         EJECT                                                          05480019
*********************************************************************** 05490019
*                                                                       05500019
*              CALCULATE THE SIZE OF CHANNEL PROGRAM 20A IF NO          05510019
*              SHARED TRACK OR MULTIPLE TRACKS OF TRACK INDEX           05520019
*                                                                       05530019
*********************************************************************** 05540019
FTI01    EQU   *                                                        05550019
         IC    GETREGA,ISLHIRT          HIGH R ON TRK INDEX             05560019
         LR    SAVEREG,GETREGA          SAVE MAX NO OF ENTRIES          05570019
*                                       FOR CP20C                       05580019
         LR    TISAREG,GETREGA          NO OF ENTRIES PER TRACK         05590019
         TM    ISLHIRT,X'01'            IS HIRT EVEN OR ODD             05600019
         BZ    FTI015                   BRANCH IF HIRT IS EVEN          05610019
         LA    TISAREG,1(TISAREG)       NO OF ENTRIES/TRK + 1           05620019
*                                       FOR SPLIT ENTRIES               05630019
FTI015   EQU   *                                                        05640019
         CLI   ISLNIRT+1,X'00'          TRACK INDEX ON ONE TRACK        05650019
         BNE   FTI02                    NO - CONTINUE                   05660019
*                                                                       05670019
*              CALCULATE THE SIZE OF CP20A FOR A NON-SHARED             05680019
*              TRACK THAT COULD HAVE LESS RECORDS THAN ISLHIRT          05690019
*                                                                       05700019
         IC    GETREGA,ISLNIRT+2        R OF DUMMY ENTRY                05710019
         LR    SAVEREG,GETREGA          SAVE MAX NO OF ENTRIES          05720019
*                                       FOR CP20C                       05730019
         LR    TISAREG,GETREGA          NO OF ENTRIES PER TRACK         05740019
FTI02    EQU   *                                                        05750019
         SLL   GETREGA,3                MULTPLY BY 8-SIZE OF CCW        05760019
         LA    GETREGA,K48(GETREGA)     ADD 24 FOR SRCH,TIC,TIC  S20201 05770020
*                                       PLUS 16 FOR TIC TO WR CHK       05780019
*                                       OR SEEK AND TIC TO CP18         05790019
*                                       PLUS 8 FOR NOP/SET SECTOR       05795020
         EJECT                                                          05800019
*********************************************************************** 05810019
*                                                                       05820019
*              CALCULATE THE SIZE OF THE TRACK INDEX SAVE AREA.         05830019
*                                                                       05840019
*********************************************************************** 05850019
FTI03    EQU   *                                                        05860019
         ST    SAVEREG,TSTWK1C          SAVE SAVEREG                    05870019
         SR    WORKREG,WORKREG          CLEAR WORKREG                   05880019
         IC    WORKREG,DCBKEYLE         C(GETREG)=KEYLEGTH              05890019
         LA    WORKREG,18(WORKREG)      ADD LENGTH OF COUNT + DATA      05900019
         LR    GETREG,WORKREG           SIZE OF EACH ENTRY              05910019
         MR    TISAREG,TISAREG          NO ENTRIES(SIZE EC ENTRY)       05920019
         LA    TISAREG,20(GETREG)       TISA+20 - CONTROL FIELD         05930019
*                                                                       05940019
*              ROUND THE SIZE OF TISA TO THE NEXT HIGHER MULTIPLE       05950019
*              OF EIGHT FOR CHANNEL PROGRAMS THAT WILL FOLLOW.          05960019
*                                                                       05970019
         LA    TISAREG,7(TISAREG)       ADD 7 TO TISA LENGTH            05980019
         ST    TISAREG,TSTWK2C          STORE TISA LENGTH               05990019
         NI    TSTWK2C+3,X'F8'          AND TISA LENGTH WITH F8         06000019
         L     TISAREG,TSTWK2C          C(TISAREG)=LENGTH OF TISA       06010019
*                                                                       06020019
*              ADD THE SIZE OF CHANNEL PROGRAM 20C IF WRITE CHECK.      06030019
*                                                                       06040019
         TM    DCBOPTCD,X'80'           WRITE CHECK                     06050019
         BZ    FTI04                    NO WRITE CHECK                  06060019
         LTR   GETREGA,GETREGA          TEST FOR CP20A                  06070019
         BZ    FTI035                   NO                              06080019
         SH    GETREGA,EIGHT            SUB CCW THAT TIC TO CP18        06090019
FTI035   LTR   GETREGB,GETREGB          IS THERE A CP20B                06100019
         BZ    FTI036                   NO                              06110019
         SH    GETREGB,EIGHT            SUB CCW THAT TIC TO CP18        06120019
FTI036   LR    GETREGC,SAVEREG          MAX NO ENTRIES/TRACK            06130019
         MH    GETREGC,ISL24            3 CCW'S FOR EACH ENTRY   S20201 06140020
         LA    GETREGC,K32(GETREGC)     ADD 8 FOR TIC (3RD CCW)  S20201 06150020
*                                       PLUS 16 FOR SEEK,TIC TO CP18    06170019
*                                       PLUS 8 FOR NOP/SET SECTOR       06175020
         EJECT                                                          06180019
*********************************************************************** 06190019
*                                                                       06200019
*              GET MAIN STORAGE FOR CHANNEL PROGRAM 20 AND TISA.        06210019
*                                                                       06220019
*********************************************************************** 06230019
FTI04    LR    GETREG,GETREGA           SIZE OF CP20A                   06240019
         AR    GETREG,GETREGB           SIZE OF CP20B                   06250019
         AR    GETREG,GETREGC           SIZE OF CP20C                   06260019
         AR    GETREG,TISAREG           SIZE OF TISA                    06270019
         LA    GETREG,0(GETREG)         ZERO HIGH ORDER BYTE            06280019
*                                                                       06290019
*                                                                       06300019
         LR    BCTREG,DCBREG            SAVE DCB POINTER                06310019
         LR    REG14,R0                 SAVE OPEN WA ADDR        Y02072 06312002
         GETMAIN R,LV=(GETREG),SP=250                            S20201 06320020
         LR    R0,REG14                 RESTORE OPEN WA ADDR     Y02072 06322002
         ST    GETREG,K16(DCBREG)       SAVE TISA LENGTH IN TISA S20201 06330020
         LR    GETREG,DCBREG            GET A(TISA)              S20201 06340020
         LR    DCBREG,BCTREG            RESTORE DCB POINTER      S20201 06350020
         EJECT                                                          06470019
*********************************************************************** 06480019
*                                                                       06490019
*              STORE CHANNEL PROGRAM 20 POINTERS IN ISLVPTRS.           06500019
*                                                                       06510019
*********************************************************************** 06520019
FTI042   EQU   *                                                        06530019
         ST    GETREG,36(0,VPTRREG)     VPTRS+36=A(TISA)                06550019
         OI    36(VPTRREG),X'C0'        BIT 0 ON-FULL TRACK INDEX       06560019
*                                       BIT 1 ON-SUCCESSFUL GETMAIN     06570019
         LA    GETREG,K8(GETREG,TISAREG) A(CCW1) - SKIP NOP      S20201 06590020
         LTR   GETREGA,GETREGA          IS THERE A CP20A                06620019
         BZ    FTI043                   NO                              06630019
         ST    GETREG,20(0,VPTRREG)     VPTRS+20=A(CP20A)               06640019
         AR    GETREG,GETREGA           ADD LENGTH OF CP20A)            06650019
         LTR   GETREGB,GETREGB          IS THERE A CP20B                06660019
         BZ    FTI044                   NO                              06670019
FTI043   EQU   *                                                        06680019
         ST    GETREG,40(0,VPTRREG)     VPTRS+40=A(CP20B)               06690019
         AR    GETREG,GETREGB           ADD LENGTH OF CP20B             06700019
FTI044   EQU   *                                                        06710019
         TM    DCBOPTCD,X'80'           WRITE CHECK                     06720019
         BZ    FTI045                   NO - BRANCH                     06730019
         ST    GETREG,44(0,VPTRREG)     VPTRS+44=A(CP20C)               06740019
FTI045   SR    GETREGC,GETREGC          CLEAR GETREGC                   06750019
         LTR   GETREGA,GETREGA          IS THERE A CP20A                06760019
         BZ    INIT20C                  NO                              06770019
         EJECT                                                          06780019
*********************************************************************** 06790019
*                                                                       06800019
*              INITIALIZE CHANNEL PROGRAM 20A TO WRITE A FULL           06810019
*              TRACK OF TRACK INDEX ENTRIES.                            06820019
*                                                                       06830019
*********************************************************************** 06840019
         L     GETREG,ISLVPTRS+20       A(CP20A)                        06850019
         ST    GETREG,ISLFXWK1          SAVE FOR SEEKTIC RTN            06860019
         IC    GETREGC,ISLHIRT          NO OF REC FOR CP20A             06870019
         CLI   ISLNIRT+1,X'00'          TI ON ONE TRACK                 06880019
         BNE   FTI048                   NO - CONTINUE                   06890019
         IC    GETREGC,ISLNIRT+2        R OF DUMMY ENTRY                06900019
FTI048   EQU   *                                                        06910019
         LR    BCTREG,WORKREG           TI SIZE FOR CCW                 06920019
*                                       INITCP20 ROUTINE)               06930019
*                                                                       06940019
         L     TISAREG,36(VPTRREG)      A(TISA)                         06950019
         LA    TISAREG,20(0,TISAREG)    A(TISA)+20                      06960019
         BAL   REG14,SETSECT            ADD SET SECTOR COMMAND   S20201 06962020
         MVI   0(GETREG),SSECT          RESTORE OPCODE           S20201 06964020
         LA    GETREG,K8(GETREG)        RESTORE ADDRESSABILITY   S20201 06966020
         LA    GETREGA,IOBDADA3         IOBA+35                         06970019
         BAL   REG14,SRCHTIC            SRCH, TIC CCW RTN               06980019
         BAL   REG14,TIC                BR TO TIC CCW RTN               06990019
         LM    GETREGA,GETREGB,CCW3     WRITE CKD CCW                   07000019
         OR    GETREGB,BCTREG           TI ENTRY SIZE                   07010019
FTI05    LA    GETREG,8(GETREG)         BUMP TO NEXT CCW                07020019
         OR    GETREGA,TISAREG          COMBINE COMMAND & ADDR          07030019
         STM   GETREGA,GETREGB,0(GETREG)                                07040019
         AR    TISAREG,WORKREG          ADD TI ENTRY SIZE TO TISA       07050019
         L     GETREGA,CCW3             WRITE CKD CCW                   07060019
         BCT   GETREGC,FTI05            DECREMENT NO OF REC             07070000
CC       EQU   X'40'                    COMMAND CHAINING                07072001
*   SPLIT CP 20A OR B FROM CP 20C OR CP18 TO PREVENT LONG CPS.          07078800
         BAL   R15,UNCHAIN              SPLIT IF NECESSARY              07081600
         BAL   REG14,SEEKTIC            BR TO SEEK, TIC CCW RTN         07087200
         CLI   DCBHIRSH,X'00'           SHARED TRACK                    07090019
         BNE   FTI052                   YES - CONTINUE                  07100019
         L     GETREGA,ISLFXWK1         A(CP20A)                        07110019
         IC    GETREGC,ISLNIRT+2        R OF DUMMY ENTRY                07120019
         SLL   GETREGC,3                MULTIPLY BY 8                   07130019
         SR    GETREG,GETREGC           A(1ST CCW IF HIRT>NIRT)         07140019
         ST    GETREG,20(GETREGA)       SAVE IN SECOND TIC              07150019
FTI052   B     INIT20C                  BR TO INIT CP20C                07160019
*                                                                       07170019
         EJECT                                                          07180019
*********************************************************************** 07190019
*                                                                       07200019
*              ROUTINES TO INITIALIZE CHANNEL PROGRAM 20                07210019
*                                                                       07220019
*                                                                       07230019
*                                                                       07240019
*              INITIALIZE SEARCH AND TIC CCW                            07250019
*                                                                       07260019
*********************************************************************** 07270019
SETSECT  EQU   *                        ATTACH NOP TO FRONT      S20201 07271020
         SH    GETREG,EIGHT             PT TO SLOT FOR NOP       S20201 07272020
         LA    GETREGA,ISLRPSSS+K2      SECTOR LOCATION          S20201 07273020
         O     GETREGA,CCW0             ADD OPCODE               S20201 07274020
         ST    GETREGA,0(GETREG)        SAVE                     S20201 07275020
         MVC   K4(K4,GETREG),CCW0+K4    SAVE                     S20201 07276020
         BR    REG14                    RETURN                   S20201 07277020
*                                                                       07278020
SRCHTIC  O     GETREGA,CCW1             COMBINE SRCH + A(CCHHR)         07280019
         L     GETREGB,CCW1A            SRCH                            07290019
         STM   GETREGA,GETREGB,0(GETREG)                                07300019
         LM    GETREGA,GETREGB,CCW2     TIC                             07310019
         OR    GETREGA,GETREG           COMBINE TIC AND ADDR            07320019
         LA    GETREG,8(GETREG)         BUMP TO NEXT CCW                07330019
         STM   GETREGA,GETREGB,0(GETREG)                                07340019
         BR    REG14                    RETURN                          07350019
*                                                                       07360019
*              INITIALIZE TIC CCW                                       07370019
*                                                                       07380019
TIC      LA    GETREG,8(GETREG)         BUMP TO NEXT CCW                07390019
         LA    GETREGA,8(GETREG)        A(FIRST WRITE OR READ CCW)      07400019
         O     GETREGA,CCW2             TIC                             07410019
         STM   GETREGA,GETREGB,0(GETREG) TIC FOR RESUME LOAD            07420019
         BR    REG14                    RETURN                          07430019
*                                                                       07440019
*              ADD TIC TO CP20C IF WRITE CHECK, OTHERWISE ADD           07450019
*              SEEK AND TIC TO CP18                                     07460019
*                                                                       07470019
SEEKTIC  LA    GETREG,8(GETREG)         BUMP TO NEXT CCW                07480019
         TM    DCBOPTCD,X'80'           WRITE CHECK                     07490019
         BO    FTI055                   YES - SET TIC TO WR CHK         07500019
*                                                                       07510019
*              SET UP SEEK TO PRIME DATA TRACK AND TIC TO CP 18         07520019
*                                                                       07530019
SEEKT    L     GETREGA,36(VPTRREG)      A(TISA)                         07540019
         LA    GETREGA,1(GETREGA)       A(TISA+1)                       07550019
         O     GETREGA,CCW6             COMBINE SEEK AND TISA ADDR      07560019
         L     GETREGB,CCW6A            2ND HALF OF SEEK CCW            07570019
         STM   GETREGA,GETREGB,0(GETREG) STORE SEEK CCW                 07580019
         MVC   8(8,GETREG),CCW2         TIC (TO CP18)                   07590019
         L     GETREGA,ISLFXWK1         A(CP20A OR B OR C)              07600019
         LA    GETREGB,8(GETREG)        ADD 8 FOR A(TIC)                07610019
         ST    GETREGB,12(GETREGA)      SAVE A(TIC TO CP18)             07620019
         B     FTI056                   BR TO INIT NEXT CP              07630019
FTI055   LM    GETREGA,GETREGB,CCW2     TIC                             07640019
         L     TISAREG,ISLVPTRS+44      A(CP20C)-MAY BE ZERO            07650019
         SH    TISAREG,EIGHT            POINT TO NOP             S20201 07655020
         OR    GETREGA,TISAREG          A(CP20C) PLUS TIC               07660019
         STM   GETREGA,GETREGB,0(GETREG)                                07670019
FTI056   EQU   *                                                        07680019
         BR    REG14                    RETURN                          07690019
         EJECT                                                          07700019
*********************************************************************** 07710019
*                                                                       07720019
*              INITIALIZE CHANNEL PROGRAMS 20 B AND C WITH              07730019
*              A SEARCH AND TIC CCW BETWEEN EACH READ OR                07740019
*              WRITE KEY DATA CCW.                                      07750019
*                                                                       07760019
*********************************************************************** 07770019
CP20BC   EQU   *                                                        07780019
         LA    TISAREG,8(SAVEREG)       ADD COUNT FOR A(KEY)            07790019
         LR    BCTREG,WORKREG           TI ENTRY SIZE                   07800019
         SH    BCTREG,EIGHT             TI SIZE-8 FOR CCW CNT           07810019
         BAL   REG14,SRCHTIC            SRCH, TIC CCW RTN               07820019
         BAL   REG14,TIC                BR TO TIC CCW RTN               07830019
         B     WRITECCW                 BR TO INSERT WRITE CCW          07840019
FTI06    LA    GETREG,8(GETREG)         BUMP CP20B FOR NEXT CCW         07850019
         LR    GETREGA,SAVEREG          SRCH ADDRESS                    07860019
         BAL   REG14,SRCHTIC            BR TO SRCH, TIC CCW RTN         07870019
WRITECCW EQU   *                                                        07880019
         LM    GETREGA,GETREGB,ISLFXWK2 W KD CCW                        07890019
         OR    GETREGB,BCTREG           TI ENTRY SIZE                   07900019
         LA    GETREG,8(GETREG)         BUMP CP20B FOR NEXT CCW         07910019
         OR    GETREGA,TISAREG          COMBINE W KD WITH ADDR          07920019
         STM   GETREGA,GETREGB,0(GETREG)                                07930019
         AR    TISAREG,WORKREG          BUMP A(TISA)-NEXT TI            07940019
         AR    SAVEREG,WORKREG          NEXT SRCH ADDRESS               07950019
         BCT   GETREGC,FTI06            DECREMENT NO OF REC             07960019
UNCHAIN  EQU   *                        *                               07962100
*   TEST FOR VIRTUAL = REAL TO SEE IF CHANNEL PROGRAM SHOULD BE SPLIT.  07962402
*                                                                       07962802
         L     REG14,DCBDEBAD           DEB ADDR FROM DCB COPY   Y02072 07963002
         USING DEB,REG14                *                               07963200
         L     REG14,DEBAPPAD           AVT ADDRESSABLITY               07963600
         USING DEBAVT,REG14             *                               07963700
         TM    DEBSIOA,VIRTUAL          IS THIS VIRTUAL                 07963800
         BCR   NOTVIRT,R15              NO - DON'T SPLIT                07963900
*   SPLIT CP 20B OR C FROM CP 20C OR CP18 TO PREVENT LONG CPS.          07964001
         NI    K4(GETREG),X'FF'-CC      DISCONNECT CP'S                 07966001
         BR    R15                      RETURN                          07970019
         EJECT                                                          07980019
*********************************************************************** 07990019
*                                                                       08000019
*              INITIALIZE CHANNEL PROGRAM 20C TO WRITE CHECK.           08010019
*                                                                       08020019
*********************************************************************** 08030019
INIT20C  TM    DCBOPTCD,X'80'           WRITE CHECK                     08040019
         BZ    INIT20B                  DO NOT INIT CP20C               08050019
         L     GETREG,ISLVPTRS+44       A(CP20C)                        08060019
         BAL   REG14,SETSECT            ADD NOP COMMAND          S20201 08063020
         LA    GETREG,K8(GETREG)        RESTORE ADDRESSABILITY   S20201 08066020
         ST    GETREG,ISLFXWK1          SAVE FOR SEEKT ROUTINE          08070019
         LR    GETREGC,SAVEREG          MAX NO OF REC-FOR CP20C         08080019
         L     TISAREG,36(VPTRREG)      A(TISA)                         08090019
         LA    SAVEREG,20(0,TISAREG)    A(TISA)+20                      08100019
         LR    GETREGA,SAVEREG          A(1ST COUNT) FOR SRCH           08110019
         MVC   ISLFXWK2(8),CCW5         SAVE R KD FOR INIT              08120019
         BAL   R15,CP20BC               BR TO INITIALIZE CP20C          08130019
         LA    GETREG,8(GETREG)         BUMP TO NEXT CCW                08140019
         BAL   REG14,SEEKT              BR TO TIC CCW RTN               08150019
         IC    GETREGC,ISLNIRT+2        R OF DUMMY ENTRY                08160019
         MH    GETREGC,ISL24            3 CCW'S FOR EACH ENTRY   S20201 08170020
         SH    GETREGC,ISL16            ADD 16 FOR SRCH, TIC            08190019
         SR    GETREG,GETREGC           A(1ST CCW FOR SHR TRK)          08200019
         ST    GETREG,20(GETREGA)       SAVE IN SECOND TIC              08210019
*                                                                       08220019
         CLI   DCBHIRSH,X'00'           SHARED TRACK                    08230019
         BE    TISAINIT                 NO - DO NOT INIT CP20B          08240019
         L     SAVEREG,0(GETREG)        A(1ST SHR TRK ENTRY IN TISA)    08250019
         SH    SAVEREG,EIGHT            BACK UP TO COUNT                08260019
         LA    SAVEREG,0(SAVEREG)       CLEAR FOR SRCH TIC ROUTINE      08270019
         B     WC20B                    BR TO INIT CP20B FOR WC         08280019
         EJECT                                                          08290019
*********************************************************************** 08300019
*                                                                       08310019
*              INITIALIZE CHANNEL PROGRAM 20B TO WRITE A SHARED         08320019
*              TRACK.                                                   08330019
*                                                                       08340019
*********************************************************************** 08350019
INIT20B  CLI   DCBHIRSH,X'00'           SHARED TRACK                    08360019
         BE    TISAINIT                 NO-DO NOT INIT CP20B            08370019
         L     TISAREG,36(VPTRREG)      A(TISA)                         08380019
         LA    SAVEREG,20(0,TISAREG)   + 20 FOR CONTROL FIELDS          08390019
*                                       A(CCHHR) FOR SRCH               08400019
WC20B    EQU   *                                                        08410019
         SR    GETREGC,GETREGC          CLEAR GETREGC                   08420019
         IC    GETREGC,ISLNIRT+2        R OF DUMMY ENTRY                08430019
         L     GETREG,ISLVPTRS+40       A(CP20B)                        08440019
         ST    GETREG,ISLFXWK1          SAVE FOR SEEKTIC RTN            08450019
         MVC   ISLFXWK2(8),CCW4         SAVE W KD CCW                   08460019
         BAL   REG14,SETSECT            ADD SET SECTOR COMMAND   S20201 08464020
         LA    GETREGA,IOBDADA3         IOBA + 35 FOR 1ST SRCH   S20201 08468020
         MVI   K0(GETREG),SSECT         RESTORE OPCODE           S20201 08472020
         LA    GETREG,K8(GETREG)        RESTORE ADDRESSABILITY   S20201 08476020
         BAL   R15,CP20BC               BR TO INITIALIZE CP20B          08480019
         BAL   REG14,SEEKTIC            BR TO SEEK, TIC CCW RTN         08490019
         EJECT                                                          08500019
*********************************************************************** 08510019
*                                                                       08520019
*              INITIALIZE TRACK INDEX SAVE AREA (TISA)                  08530019
*                                                                       08540019
*********************************************************************** 08550019
TISAINIT L     TISAREG,36(VPTRREG)      A(TISA)                         08560019
         MVC   0(8,TISAREG),IOBDADA0    MOVE IOBA TO TISA               08570019
         SLL   WORKREG,16               SHIFT LEFT 2 BYTES              08580019
         ST    WORKREG,8(0,TISAREG)     TI ENTRY SIZE-TISA+8            08590019
         MVC   11(1,TISAREG),TSTWK1C+3  HIGH R FOR 1ST TRK OF TI        08600019
         MVI   FLAG(TISAREG),EOC        MARK IT END OF CYLINDER         08610001
         LA    GETREGB,20(0,TISAREG)    A(NEXT ENTRY)                   08620019
         ST    GETREGB,12(0,TISAREG)    TISA+13=A(NEXT ENTRY)           08630019
*                                       SET CURR R = 0                  08640019
         EJECT                                                          10480019
*                                                                       10500019
* EXIT ********** EXIT ***************** EXIT *********** EXIT ******** 10520019
*                                                                       10540019
EXIT     EQU   *                                                        10546019
*                                                                       10546102
         MODESET  EXTKEY=DATAMGT        SET DATA MANAGEMENT KEY  Y02072 10546402
*                                                                       10547202
         LR    RCORE,R0                 ADDR OF OPEN WORK AREA   Y02072 10548002
         USING FORCORE,RCORE            OPEN WA ADDRESSABILITY   Y02072 10550002
         LM    R0,R15,DXCCW1            RESTORE REGISTERS        Y02072 10556002
         USING BASETAG,RBASE            ESTABLISH BASE                  10566019
         MVC   0(L'LOAD5U,RWTGC),LOAD5U ID - 5U FOR RESUME LOAD  Y02072 10596002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       10720019
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       10740019
         CLC   0(2,RWTGC),THISLOAD                                      10760019
         BE    BASETAG                  BR-BEGIN THIS MODULE            10780019
         CLC   0(2,RWTGC),OPNLOD7       TEST FOR END OF WTG TABLE       10800019
         BC    7,RELOOP                 BRANCH=NOT AT END               10820019
         LR    RPARC,RPAR               INITIALIZE RPARC                10840019
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                10860019
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              10880019
         BC    7,TCTLRTN                BRANCH = NOT ZERO               10900019
         LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       10920019
         LA    RPARC,4(RPARC)                                           10940019
         B     ZCHECK                                                   10960019
TCTLRTN  EQU   *                                                        10980019
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         11000019
         LA    RJ,DXCCW12                                               11040002
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 11060002
*                                                                       11080019
*                                                                       11084019
         EJECT                                                          11088019
*                                                                       11128019
EIGHT    DC    H'0008'                                                  11148019
ISL16    DC    H'16'                                                    11158019
ISL24    DC    H'24'                    CONSTANT                 S20201 11163020
*                                                                       11168019
THISLOAD DC    C'5T'                    CURRENT MODULE ID               11178019
OPNLOD7  DC    C'0S'                                                    11188019
*                                                                       11198019
*                                                                       11208019
*              CHANNEL PROGRAM 20 - FULL TRACK INDEX WRITE              11218019
*                                                                       11228019
         DS    0D                                                       11238019
CCW0     CCW   X'03',0,X'60',1          NOP  RPS                 S20201 11243020
CCW1     CCW   X'31',0,X'40',5          SRCH                            11248019
CCW2     CCW   X'08',0,X'00',0          TIC                             11258019
CCW3     CCW   X'1D',0,X'40',0          W CKD  CP20A                    11268019
CCW4     CCW   X'0D',0,X'40',0          W KD   CP20B                    11278019
CCW5     CCW   X'0E',0,X'50',0          R KD   CP20C                    11288019
CCW6     CCW   X'1B',0,X'40',6          SEEK                            11298019
*                                                                       11308019
CCW1A    EQU   CCW1+4                                                   11318019
CCW6A    EQU   CCW6+4                                                   11328019
*                                                                       11338019
LOAD5U   DC    C'5U'                    ID OF MODULE IGG0195U    Y02072 11388002
*                                                                       11438002
PATCH    DC    XL((*-IGG0195T)/20)'00'  ZEROED PATCH AREA        Y02072 11488002
         END                                                            11580019
