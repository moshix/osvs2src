     TITLE   'IGG0196D - OPEN, RESUME LOAD'                             00010002
IGG0196D CSECT                                                          00011002
*                                                                       00012002
*********************************************************************** 00013002
*                                                                     * 00014002
* MODULE-NAME = IGG0196D                                              * 00015002
*                                                                     * 00016002
* DESCRIPTIVE-NAME = ISAM OPEN, RESUME LOAD MODE                      * 00017002
*                                                                     * 00018002
* COPYRIGHT = NONE                                                    * 00019002
*                                                                     * 00020002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00021002
*                                                                     * 00022002
* FUNCTION = DETERMINE DEVICE TYPE FOR INDEX & STORE IN INDXTYPE.     * 00023002
*            SET ISLBUFNO & DCBBUFNO IF BETWEEN 1 AND 30 INCLUSIVE;   * 00024002
*            OR LIMIT TO MAXIMUM OF 30; OR DEFAULT TO 2 IF NOT        * 00025002
*            SPECIFIED.  INITIALIZE IOBBCT.  TURN T-BIT ON FOR BUFFER * 00026002
*            1 IF ONE RECORD PER TRACK, & C-BIT ON IF ONE PRIME DATA  * 00027002
*            TRACK PER CYLINDER.  INITIALIZE ISLNDAT & ISLODAT R, F,  * 00028002
*            & P BYTES (X'00001B' AND X'FF1007' RESPECTIVELY).  GET   * 00029002
*            CORE FOR AND EXECUTE CP31A & B TO READ KEY OF LAST TRACK * 00030002
*            INDEX ENTRY INTO KEYSAVE AREA, AND READ COUNT AND DATA   * 00031002
*            OF LAST PRIME DATA BLOCK INTO FIRST BUFFER.              * 00031202
*                                                                     * 00032002
* NOTES = SEE BELOW                                                   * 00033002
*                                                                     * 00034002
*    DEPENDENCIES = NONE                                              * 00035002
*                                                                     * 00036002
*    RESTRICTIONS = NONE                                              * 00037002
*                                                                     * 00038002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00039002
*                                                                     * 00040002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00041002
*                                                                     * 00042002
* MODULE-TYPE = OPEN EXECUTOR                                         * 00043002
*                                                                     * 00044002
*    PROCESSOR = ASSEMXF-370R                                         * 00045002
*                                                                     * 00046002
*    MODULE-SIZE = 906 DECIMAL BYTES                                  * 00047002
*                                                                     * 00048002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00049002
*                                                                     * 00050002
* ENTRY-POINT = IGG0196D                                              * 00051002
*                                                                     * 00052002
*    PURPOSE = SEE FUNCTION                                           * 00053002
*                                                                     * 00054002
*    LINKAGE = RECEIVES CONTROL FROM ISAM OPEN EXECUTOR IGG0196C IN   * 00055002
*              STORAGE PROTECT KEY 5 AND PRIVILEGED STATE FOR RESUME  * 00056002
*              LOAD MODE ONLY.                                        * 00057002
*                                                                     * 00058002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00059002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00060002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00061002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00062002
*               PARAMETER LIST                                        * 00063002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00064002
*                                                                     * 00065002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00066002
*          UPON ENTRY TO THIS MODULE                                  * 00067002
*                                                                     * 00068002
* EXIT-NORMAL = XCTL TO ISAM OPEN EXECUTOR IGG0195G IN STORAGE        * 00069002
*               PROTECT KEY 5.                                        * 00069202
*                                                                     * 00070002
* EXIT-ERROR = ABEND CODES:                                           * 00071002
*              033 - I/O ERROR DURING CP31A OR 31B                    * 00072002
*                                                                     * 00076002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00077002
*                                                                     * 00078002
*    ROUTINES = NONE                                                  * 00079002
*                                                                     * 00081002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00082002
*                 FORCORE - OPEN WORK AREA                            * 00083002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00084002
*                                                                     * 00085002
*    CONTROL-BLOCKS = DCB, DCB COPY, DEB, IOB, AND UCB.               * 00086002
*                                                                     * 00087002
* TABLES = NONE                                                       * 00088002
*                                                                     * 00089002
* MACROS = MODESET, GETMAIN, EXCP, WAIT, FREEMAIN, XCTL, AND ABEND.   * 00090002
*                                                                     * 00091002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00092002
*                                                                     * 00093002
*                                                                     * 01041002
*********************************************************************** 01042002
         EJECT                                                          01043002
********************                                                    01044002
* DCB REFERENCE    *                                                    01060000
********************                                                    01080000
         DCBD  DSORG=(IS)                                               01100000
         USING IHADCB,R1                                                01120000
         EJECT                                                          01140000
********************                                                    01160000
* DEB REFERENCE    *                                                    01180000
********************                                                    01200000
*                                                                       01220000
IHADEB   DSECT                                                          01240000
         USING IHADEB,R8                                                01260000
         DS    0D                                                       01280000
DEBNMSUB DS    0CL1                                                     01300000
DEBTCBAD DS    A                                                        01320000
DEBAMLNG DS    0CL1                                                     01340000
DEBDEBAD DS    A                                                        01360000
DEBOFLGS DS    0CL1                                                     01380000
DEBIRBAD DS    A                                                        01400000
DEBOPATB DS    0CL1                                                     01420000
DEBSYSPG DS    A                                                        01440000
DEBNMEXT DS    0CL1                                                     01460000
DEBUSRPG DS    A                                                        01480000
DEBPRIOR DS    0CL1                                                     01500000
DEBECBAD DS    A                                                        01520000
DEBPROTG DS    0BL1                                                     01540000
DEBDEBID DS    0BL1                                                     01560000
DEBDCBAD DS    A                                                        01580000
DEBEXSCL DS    0CL1                                                     01600000
DEBAPPAD DS    A                                                        01620000
DEBNIEE  DS    0CL1                                                     01640000
DEBFIEAD DS    A                                                        01660000
DEBNPEE  DS    0CL1                                                     01680000
DEBFPEAD DS    A                                                        01700000
DEBNOEE  DS    0CL1                                                     01720000
DEBFOEAD DS    A                                                        01740000
         DS    CL4                                                      01760000
DEBDVMOD DS    0CL1                                                     01780000
DEBUCBAD DS    A                                                        01800000
DEBBINUM DS    CL2                                                      01820000
DEBSTRCC DS    CL2                                                      01840000
DEBSTRHH DS    CL2                                                      01860000
DEBENDCC DS    CL2                                                      01880000
DEBENDHH DS    CL2                                                      01900000
DEBNMTRK DS    CL2                                                      01920000
         EJECT                                                          01940000
*********************************************************************** 01960000
* ISLCOMON REFERENCE     C(DCBWKPT1)=A(ISLCOMMON)                     * 01980000
*********************************************************************** 02000000
*                                                                       02020000
ISLCOMON DSECT                                                          02040000
         USING ISLCOMON,R12                                             02060000
         DS    0D                                                       02080000
ISLECBA  DS    A                        FOR CP18 AND CP20               02100000
ISLIOBA  DS    CL40                                                     02120000
ISLECBB  DS    A                        FOR CP21                        02140000
ISLIOBB  DS    CL40                                                     02160000
ISLECBC  DS    A                        FOR CP19                        02180000
ISLIOBC  DS    CL40                                                     02200000
ISLAREAZ DS    CL88                     FOR CP19                        02220000
INDXTYPE EQU   ISLAREAZ+86              HI LEVEL INDEX DEV TYPE   24503 02230018
ISLIXLT  DS    CL104                    INDEX LOCATION TABLE            02240000
ISLNIRT  DS    CL3                      HHR OF DUMMY TRACK INDEX        02260000
ISLHIRT  DS    CL1                      NO INDX ENT ON PRIM DATA TRACK  02280000
ISLCBF   DS    F                        BUF CTRL PTR (RCD WITHIN BUF)   02300000
ISLBMPR  DS    F                        USED TO BUMP CBF TO NEXT RCD    02320000
ISLFBW   DS    F                        NO OF BUFS SCHED TO WRITE       02340000
ISLEOB   DS    F                        END OF BUFFR ADR                02360000
ISLNCNT  DS    CL8                      NORMAL IX COUNT, CCHHRKDD       02380000
ISLOCNT  DS    CL8                      OVFLOL IX COUNT, CCHHRKDD       02400000
ISLDCNT  DS    CL8                      DUMMY IX COUNT,  CCHHRKDD       02420000
ISLNDAT  DS    CL10                     NORMAL IX DATA, MBBCCHHRFP      02440000
         DS    CL2                                                      02460000
ISLODAT  DS    CL10                     OVFLOW IX DATA, MBBCCHHRFP      02480000
         DS    CL1                                                      02500000
ISLBUFNO DS    CL1                      DCBBUFNO OR 2                   02520000
ISLBUFN  DS    F                        ADDR OF SLOT N IN BCT           02540000
ISLMVC   DS    F                        COUNT OF EXECUTED MOVE (N-1)    02560000
ISLMVCT  DS    F                        NOMBR OF 255 BYTE MOVES (N+1)   02580000
ISLVRSAV DS    18F                      ISL SAVE AREA                   02600000
ISLAPSAV DS    10F                      APPENDAGE SAVE AREA             02620000
ISLWRSAV DS    16F                      ISL SAVE AREA FOR CLOSE         02640000
*                                                                       02660000
TSTWK1C  DS    F                        WORK AREA FOR FORMAT 000N       02680000
TSTWK2C  DS    F                        WORK AREA FOR FORMAT 00NN       02700000
         DS    F                                                        02720000
ISLNOENT DS    F                        NO ENTRIES REMAINING ON TRACK   02740000
ISLOFFST DS    F                        SIZE OF WR CKD INSTR IN BYTES   02760000
ISLD     DS    F                        DISCPLACEMENT FROM CP18 START   02780000
ISLFSTBF DS    F                        ADDR OF 1ST SCHED BUF (REL)     02800000
ISLLSTBF DS    F                        ADDR OF LAST SCHED BUF (REL)    02820000
ISLCCFAD DS    F                        ADDR OF CC FLAG IN CP18         02840000
ISLKEYAD DS    F                        ADDR OF KEY OF LAST RCD ON TRK  02860000
*                                                                       02880000
CL1AD    DS    F                        ADDR CP18 SKLTN                 02900000
CM1AD    DS    F                        ADDR CP19 SKLTN                 02920000
CQ1AD    DS    F                        ADDR CP20 SKLTN                 02940000
CQT1AD   DS    F                        ADDR CP20 WR CHK EXTN           02960000
CQ40AD   DS    F                        ADDR CP20 SKLTN                 02980000
CQ45AD   DS    F                        ADDR CP20 WR CHK EXTN           03000000
*                                                                       03020000
         SPACE 3                                                        03040002
*                                                                       03060000
* ISLVPTRS REFERENCE       C(DCBWKPT6)=A(ISLVPTRS)                      03080000
*                                                                       03100000
ISLVPTRS DS    A                        A(AREA Y)                       03140000
         DS    A                        A(KEYSAVE)                      03160000
         DS    A                        A(IOBBCT)  BUF CTRL TBL ADR     03180000
         DS    A                        A(CP18)                         03200000
         DS    A                        A(CP19)                         03220000
         DS    A                        A(CP20)                         03240000
         DS    A                        A(CP21)                         03260000
         DS    A                        SIZE OF DCB WORK AREA    O19110 03260819
         DS    A                        SIZE OF CHANNEL PGM AREA O19110 03261619
         DS    A                        A(TRACK INDEX SAVE AREA) O19110 03262419
*                                       BIT 0-FULL TRK INDX WRITE       03263219
*                                       BIT 1-SUCCESSFUL GETMAIN        03264019
         DS    A                        A(CP20B)-FULL TRK INDX   O19110 03264819
*                                       WR                       O19110 03265619
         DS    A                        A(CP20C)-FULL TRK INDX   O19110 03266419
*                                       WR                       O19110 03267219
ISLFXWK1 DS    F                        WORK AREA                 13711 03268000
ISLFXWK2 DS    F                        WORK AREA                 13711 03272000
ISLF9WK1 DS    F                        WORK AREA                 13711 03276000
*                                                                       03280000
*                                                                       03300000
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03320000
*                                                                       03340000
IOBBCT   DSECT                                                          03360000
         USING IOBBCT,R11                                               03380000
         DS    0D                                                       03400000
IOBFLAGS DS    0CL1                     FLAGS                           03420000
IOBPTRA  DS    A                        PTR A                           03440000
IOBB     DS    0CL1                     B                               03460000
IOBPTRB  DS    A                        PTR B                           03480000
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03500000
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03520000
         EJECT                                                          03540000
********************                                                    03560000
* IOB REFERENCE    *                                                    03580000
********************                                                    03600000
*                                                                       03620000
IHAIOB   DSECT                                                          03640000
         DS    0D                                                       03680000
IOBFLG1  DS    CL1                      FLAGS 1                         03700000
IOBFLG2  DS    CL1                      FLAGS 2                         03720000
         DS    CL2                                                24503 03750018
IOBECBAD DS    A                        ECB POINTER                     03780000
         DS    CL8                                                24503 03810018
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       03840000
IOBWT    DS    0CL1                     WEIGHT                          03860000
IOBDCBAD DS    A                        DCB POINTER                     03880000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     03900000
IOBBCTI  DS    CL2                      BLK CTR INCR                    03920000
IOBECT   DS    CL2                      ERROR CTR                       03940000
IOBDADAD DS    0CL8                     DIRECT ACCESS DEVICE ADR        03941000
IOBDADA0 DS    CL1                      IOBSEEK   (ISLIOBA+32) M        03942000
IOBDADA1 DS    CL1                      IOBSEEK+1 (ISLIOBA+33) B        03943000
IOBDADA2 DS    CL1                      IOBSEEK+2 (ISLIOBA+34) B        03944000
IOBDADA3 DS    CL1                      IOBSEEK+3 (ISLIOBA+35) C        03945000
IOBDADA4 DS    CL1                      IOBSEEK+4 (ISLIOBA+36) C        03946000
IOBDADA5 DS    CL1                      IOBSEEK+5 (ISLIOBA+37) H        03947000
IOBDADA6 DS    CL1                      IOBSEEK+6 (ISLIOBA+38) H        03948000
IOBDADA7 DS    CL1                      IOBSEEK+7 (ISLIOBA+39) R        03949000
*                                                                       03950000
CP31A    DSECT                                                          03951020
         DS    0D                                                       03952000
CA1      DS    CL8                      1ST CCW                         03953000
CA2      DS    CL8                      2ND CCW                         03954000
CA3      DS    CL8                      3RD CCW                         03955000
CA4      DS    CL1                      4TH CCW                         03956000
CA41     DS    CL6                      COMMAND ADDRESS                 03957000
CA47     DS    CL1                      BYTE COUNT                      03958000
*                                                                       03959020
*   CP31B                                                               03960020
CB1      DS    CL8                      SEEK HEAD                A34959 03961020
CB2      DS    CL8                      SRCH ID EQ               A34959 03962020
CB3      DS    CL8                      TIC TO CB2               A34959 03963020
CB4      DS    CL8                      READ COUNT OF LAST PD-DC A34959 03964020
CB5      DS    CL8                      READ LAST DATA RECORD    A34959 03965020
CB5V1    DS    CL8                      SEARCH FOR R0            A34959 03966020
CB5V2    DS    CL8                      TIC TO CB5V1             A34959 03967020
CB5V3    DS    CL8                      READ DATA OF R0          A34959 03968020
CB6      DS    CL1                      LPDA                     A34959 03969020
CB61     DS    CL6                      SEEK ADDRESS             A34959 03970020
CB67     DS    CL1                      R OF LPDA                A34959 03971020
CB7      DS    CL8                      SEARCH ARG FOR R0        A34959 03972020
CPEND    EQU   *                                                 A34959 03973020
         EJECT                                                  , 24503 03997618
FORCORE  DSECT                                                  , 24503 03998018
         IECDSECT                                               , 24503 03998418
         EJECT                                                          04000000
**********************************************************************  04020000
* ISL PUT OPEN #1                                                     * 04040000
**********************************************************************  04060000
IGG0196D CSECT                                                          04120000
         BALR  R9,0                                                     04140000
         USING *,R9                                                     04160000
BASETAG  L     R1,0(RPARC)                                              04180000
         L     RCORE,4(RWTGC)                                           04200000
         USING FORCORE,RCORE                                      24503 04210018
         L     R12,DCBWKPT1                                             04220000
         LR    RBASE,R9                                                 04240000
         STM   R0,R15,DXCCW1            SAVE REGISTERS           Y02072 04260002
         LR    RD,RCORE                 SAVE S/A ADDR            Y02072 04270002
*                                                                       04300000
* EQUATE SYMBOLIC REGISTERS                                             04320000
*                                                                       04340000
R0       EQU   0                                                        04360000
R1       EQU   1                                                        04380000
R2       EQU   2                                                        04400000
R3       EQU   3                                                        04420000
R4       EQU   4                                                        04440000
R5       EQU   5                                                        04460000
R6       EQU   6                                                        04480000
R7       EQU   7                                                        04500000
R8       EQU   8                                                        04520000
R9       EQU   9                                                        04540000
R10      EQU   10                                                       04560000
R11      EQU   11                                                       04580000
R12      EQU   12                                                       04600000
R13      EQU   13                                                       04620000
R14      EQU   14                                                       04640000
R15      EQU   15                                                       04660000
RBASE    EQU   3                                                        04680000
RCORE    EQU   4                                                        04700000
RPAR     EQU   5                                                        04720000
RWTG     EQU   6                                                        04740000
RPARC    EQU   7                                                        04760000
RWTGC    EQU   8                                                        04780000
RD       EQU   14                                                       04860000
UCBTYPE  EQU   19                       LOCATION OF UCB DEV TYPE  24503 04890018
RZERO    EQU   X'00'                                             A34959 04897020
FIXED    EQU   X'80'                                             A34959 04904020
SILICC   EQU   X'60'                                             A34959 04911020
K4       EQU   4                        LENGTH                          04913001
STAT     EQU   X'80'                    STATUS BIT                      04915000
         EJECT                                                  , 24503 04920218
*****************************************************************       04920418
*                                                                       04920618
*                   ENTRY POINT FOR QISAM - RESUME LOAD                 04920818
*                        ENTERED FROM COMMON OPEN                       04921018
*                                                                       04921218
*****************************************************************       04921418
*   SET UP INDEX DEVICE TYPE.                                           04928321
*                                                                       04928702
         MODESET  KEYADDR=DXUKEY,WORKREG=5  SET USERS KEY        Y02072 04929402
*                                                                       04931402
         DROP RCORE                     END OPEN WA USING        Y02072 04933402
         USING FORCORE,RD               OPEN WA ADDRESSABILITY   Y02072 04933502
*                                                                       04933602
         SR    R5,R5                    CLEAR                    M1766  04933802
         IC    R5,DCBOVDEV              GET OVERFLOW DEV TYPE    M1766  04934902
         LTR   R5,R5                    IS THERE OVERFLOW        M1766  04936002
         BNZ   OVTYPEOK                 YES ASSUME INDEX ON OVFL M1766  04937102
*                                       NO ASSUME INDEX ON PRIME        04938202
         IC    R5,DCBDEVT               GET PRIME DEVICE TYPE    M1766  04939302
OVTYPEOK EQU   *                        *                        M1766  04940402
         L     R8,DCBDEBAD                                       M1766  04942602
         USING IHADEB,R8                                         M1766  04948102
         L     R3,DEBFIEAD              R3=A(INDEX EXTENT)       M1766  04949202
         LTR   R3,R3                                             M1766  04950302
         BZ    SETTYPE                  BRANCH IF NO INDEX-USE   M1766  04951402
*                                       PRIME                           04952502
         L     R3,0(R3)                 R3=A(INDEX UCB)           24503 04953602
         IC    R5,UCBTYPE(R3)           GET INDEX DEVICE TYPE     24503 04954702
SETTYPE  STC   R5,INDXTYPE              SAVE INDEX DEVICE TYPE    24503 04955802
TEST2321 SR    R6,R6                                              24503 04956902
         LA    R7,32(R8)                ADDRESS OF START          24503 04958002
*                                       DEB EXTENTS                     04959102
         EJECT                                                          04977802
*                                                                       04978902
* OPEN HOUSEKEEPING FOR PUT                                             04980000
*                                                                       05000000
         USING IHAIOB,R2                IOB ADDRESSABILITY       Y02072 05010002
TSTHSK   LA    R2,ISLIOBA               C(R2)=A(IOBA)                   05020000
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 05040000
         L     R11,8(R10)               C(R11)=A(BCT)                   05060000
         XC    TSTWK1C(8),TSTWK1C       SET WK1C AND WK2C TO 0          05080000
*                                                                       05100000
* SET ISLBUFNO = DCBBUFNO OR 2                                          05120000
*                                                                       05140000
         MVC   ISLBUFNO(1),DCBBUFNO     SET ISLBUFNO = DCBBUFNO         05160000
*                                                                       05162002
*   LIMIT SIZE OF CHANNEL PROGRAMS                                      05164001
*                                                                       05164402
K30      EQU   30                       LARGEST NUMBER BUFFERS          05166001
         CLI   ISLBUFNO,K30             BUFNO TO BIG                    05168001
         BNH   NOTBIG                   NO LEAVE IT                     05170001
         MVI   ISLBUFNO,K30             RESTRICT IT                     05172001
NOTBIG   EQU   *                        *                               05174001
         CLI   ISLBUFNO,X'00'           TEST ISLBUFNO VS ZERO           05180000
         BNE   TSTHK005                 B IF NOT 0                      05200000
         MVI   ISLBUFNO,X'02'           SET ISLBUFNO = 2                05220000
*                                                                       05240000
* INITIALIZE BCT                                                        05260000
*                                                                       05280000
*  1. SET UP KDD IN REG 6                                               05300000
*                                                                       05320000
TSTHK005 SR    R6,R6                                                    05340000
         IC    R6,DCBKEYLE              C(R6)=IL, 000K                  05360000
         LH    R7,DCBBLKSI              C(R7)=00DD                      05380000
         SLL   R7,16                    C(R7)=DD00                      05400000
         SLDL  R6,16                    C(R6)=0KDD                      05420000
*                                                                       05440000
*  2. SET UP BCT, STORRING 0KDD IN BUFF CNT +4 AT SAME TIME             05460000
*                                                                       05480000
         SR    R3,R3                                                    05500000
         IC    R3,ISLBUFNO              C(R3)=NO OF BUFFRS              05520000
         LA    R4,8(R11)                C(R4)=A(SLOT 1)                 05540000
         ST    R4,0(R11)                STORE A(SLOT 1) AT PTRA         05560000
         ST    R4,4(R11)                STORE A(SLOT 1) AT PTRB         05580000
         L     R5,DCBBUFCB              C(R5)=A(BUFF POOL CTRL BLK)     05600000
         L     R5,0(R5)                 C(R5)=A(BUF1)                   05620000
         LA    R5,0(R5)                 DELETE HIGH ORDER BYTE    10284 05630000
         LR    R8,R5                    C(R8)=A(BUF1) ALSO              05640000
         MVI   0(R11),X'08'             SET FLAGS BITS, BOB SW = 1      05660000
         MVI   4(R11),X'00'             SET B = 0                       05680000
*---------------------------------------INIT N SLOTS                    05700000
TSTHK01  EQU   *                        TEST FOR LAST SLOT              05705001
         ST    R5,0(R4)                 STORE A(BUF N) IN SLOT N        05740000
         L     R5,0(R5)                 C(R5)=A(NEXT BUFFER)            05742000
         ST    R7,0(R8)                 STORE 0000 IN BUF N CNT         05745001
         ST    R6,4(R8)                 STORE 0KDD IN BUF N CNT +4      05760000
         BCT   R3,TSTHK02               TEST FOR SLOT N                 05785001
         MVI   0(R4),STAT               STATUS BIT 0 = 1 FOR BUFFR N    05789000
         ST    R4,ISLBUFN               C(BUFN)=A(SLOT N)               05800000
         LR    R4,R5                    C(R4)=A(NXT BUF)                05804000
         L     R5,DCBBUFCB              C(R5)=A(BUF POOL CTL BLK)       05860000
         ST    R4,0(R5)                 C(BUF POOL CTL BLK)=A(NXT BUF)  05880000
         CLI   DCBHIRPD,X'01'           TEST FRO 1 RCD/TRK-UNSHARED     05910000
         BNE   TSTHK03                  BRANCH G.T. 1 RCD/TRK           05940000
TSTHK014 OI    8(R11),X'08'             TURN T-BIT ON FOR BUF 1 (BIT 4) 05980000
         CLC   DCBFIRSH(2),DCBLDT       TEST FOR 1 TRK PER CYL          06000000
         BNE   TSTHK03                  B IF MORE THAN 1                06020000
         OI    8(R11),X'04'             TURN C-BIT ON FOR BUF 1 (BIT 5) 06040000
         B     TSTHK03                  EXIT                            06060000
*                                                                       06080000
*                                       NOT SLOT N-                     06100000
TSTHK02  EQU   *                        *                               06120001
         LA    R4,K4(R4)                POINT TO NEXT SLOT              06140001
         LR    R8,R5                    C(R8)=A(NEXT BUF) ALSO          06240000
         B     TSTHK01                  LOOP                            06260000
         SPACE 4                                                        06280002
*                                                                       06340000
* GENERAL INITIALIZATION                                                06360000
************************                                                06380000
*                                                                       06400000
* INITIALIZE NDAT AND ODAT - R, F, AND P BYTES                          06420000
*                                                                       06440000
TSTHK03  MVC   ISLNDAT+7(3),MVI1        RFP = 00001B                    06460000
         MVC   ISLODAT+7(3),MVI2        RFP = FF1007                    06480000
*                                                                       06500000
* SET ECBA, ECBB, ECBC TO COMPLETE STATE TO AVOID PREMATURE WAIT        06520000
*                                                                       06540000
         OI    ISLECBA,X'40'            SET COMPLETE BIT ON IN ECBA     06560000
         OI    ISLECBB,X'40'            SET COMPLETE BIT ON IN ECBB     06580000
         OI    ISLECBC,X'40'            SET COMPLETE BIT ON IN ECBC     06600000
         EJECT                                                          06630000
*********************************************************************** 06660000
*                                                                     * 06690000
*                        CHANNEL PROGRAM 31A                          * 06720000
*                                                                     * 06750000
*              READ THE KEY OF THE LAST OVERFLOW TRACK INDEX          * 06780000
*              ENTRY INTO THE KEYSAVE AREA.                           * 06810000
*                                                                     * 06840000
*********************************************************************** 06870000
*                                                                     * 06900000
*                        CHANNEL PROGRAM 31B                          * 06930000
*                                                                     * 06960000
*              THIS CHANNEL PROGRAM WILL BE EXECUTED TO                 07000018
*              READ THE COUNT AND DATA OF THE LAST PRIME DATA         * 07050000
*              BLOCK INTO THE FIRST BUFFER SPECIFIED IN THE           * 07080000
*              BUFFER CONTROL TABLE.                                  * 07110000
*                                                                     * 07140000
*********************************************************************** 07170000
GETCORE  EQU   *                                                 A34959 07250020
         L     R0,CPSIZE                GET SIZE AND SUBPOOL     A34959 07330020
         LR    R3,R1                    SAVE A(DCB)                     07410000
         GETMAIN R,LV=(0)               GET CORE FOR CP31               07440000
         ST    R1,IOBCPSAD              CHANNEL PROG START ADDR         07470000
         LR    R6,R5                    SAVE SIZE OF CP FOR FREEMAIN    07500000
         SLL   R6,24                    SAVE IN HIGH ORDER BYTE         07530000
         AR    R6,R1                    SAVE ADDR OF CP31               07560000
         ST    R6,ISLFXWK1              STORE A(CP31)            O19110 07590019
         BCTR  R5,0                                                     07620000
         MVC   0(96,R1),CP31            CP SKELETON TO AREA      A34959 07650020
         LR    R5,R1                    ADDR GETMAIN AREA               07680000
         LR    R1,R3                    RESTORE A(DCB)                  07710000
*********************************************************************** 07740000
*                                                                     * 07770000
*              SET UP FIRST IOB ADDRESS                               * 07800000
*                                                                     * 07830000
*********************************************************************** 07860000
         MVC   IOBDADA0(3),DCBLPDA      ISLIOBA+32 - MBB                07890000
         MVC   IOBDADA3(5),DCBLETI      LAST NORMAL TI - CCHHR          07920000
         USING CP31A,R5                 CP31A DSECT              A34959 07950020
         EJECT                                                          07980000
*********************************************************************** 08010000
*                                                                     * 08040000
*              INITIALIZE CP31A                                       * 08070000
*                                                                     * 08100000
*********************************************************************** 08130000
         L     R6,CA1                   GET SRCH ARG             A34959 08140020
*                                       DISPLACEMENT             A34959 08150020
         AR    R6,R2                    ADD IOBDADAD             A34959 08160020
         ST    R6,CA1                   INIT CA1                 A34959 08170020
         L     R6,CA2                   GET TIC OP CODE          A34959 08180020
         AR    R6,R5                    ADD ADDR OF CA1          A34959 08190020
         ST    R6,CA2                   TIC TO CA1               A34959 08200020
         L     R6,CA3                   GET DISP TO ISLOCNT      A34959 08210020
         AR    R6,R12                   ADD ADDR OF ISLCOMMON    A34959 08220020
         ST    R6,CA3                   RD CNT OF OVFLOW TI      A34959 08230020
         L     R6,4(0,R10)              C(R6)-A(KEYSAVE)                08310000
         O     R6,CA4                   COMBINE KEYSAVE & COMAND        08370000
         ST    R6,CA4                   READ OVFLO TI KEY CCW           08400000
         IC    R6,DCBKEYLE              KEY LENGTH                      08430000
         STC   R6,CA47                  INSERT KEY LENGTH IN CA4        08460000
         EJECT                                                          08490000
*********************************************************************** 08520000
*                                                                     * 08550000
*              INITIALIZE CP 31B                                        08580018
*                                                                     * 08610000
*********************************************************************** 08640000
         MVC   CB6(8),DCBLPDA           PUT LPDA AT END OF CP31B A34959 08670020
         IC    R6,CB67                  R OF LPDA                A34959 08700020
         BCTR  R6,0                     R-1                      A34959 08730020
         STC   R6,CB67                  LPDA WITH R=R-1          A34959 08760020
         L     R6,CB1                   GET SEEK OP CODE & DISP  A34959 08790020
         AR    R6,R5                    ADD ADDR OF CHAN PROG    A34959 08820020
         ST    R6,CB1                   INIT SEEK CCW            A34959 08850020
         L     R6,CB2                   GET DISP TO SRCH ARG     A34959 08880020
         AR    R6,R5                    ADD ADDR OF CHAN PROG    A34959 08910020
         ST    R6,CB2                   INIT SRCH CCW            A34959 08940020
         L     R6,CB3                   GET DISP TO CB2          A34959 08970020
         AR    R6,R5                    ADD ADDR OF CHAN PROG    A34959 09000020
         ST    R6,CB3                   INIT TIC TO CB2          A34959 09030020
         MVC   CB4+1(3),9(R11)          BCT+9-1ST BUFFER ADDR    A34959 09060020
         MVC   CB5+1(3),9(R11)          BCT+9-1ST BUFFER ADDR    A34959 09090020
         L     R7,CB5                   READ DATA CCW            A34959 09120020
         LA    R6,8(0,0)                R6-8                            09270000
         ALR   R7,R6                    ADD 8 (CNT) TO BUFFER AD        09300000
         SR    R8,R8                    CLEAR REGISTER 8                09330000
         LH    R8,DCBBLKSI              BLOCK SIZE                      09360000
         STM   R7,R8,CB5                CCW TO READ LAST PD BLK  A34959 09363020
         TM    DCBRECFM,FIXED           IS RECORD FORMAT FIXED   A34959 09366020
         BO    FIXINIT                  YES, BRANCH              A34959 09369020
         OI    CB5+4,SILICC             SET SILI, CC BITS ON -   A34959 09372020
*                                       VLR                      A34959 09375020
         MVC   CB7(4),CB6+3             MOVE CCHH FOR R0         A34959 09378020
         MVI   CB7+4,RZERO              SET R OF CCHHR TO 0      A34959 09381020
         L     R6,CB5V1                 GET DISP OF SRCH ARG     A34959 09384020
         AR    R6,R5                    ADD CHAN PROG ADDR       A34959 09387020
         ST    R6,CB5V1                 INIT SRCH ARG            A34959 09390020
         L     R6,CB5V2                 GET DISP TO CB5V1        A34959 09393020
         AR    R6,R5                    ADD CHAN PROG ADDR       A34959 09396020
         ST    R6,CB5V2                 INIT TIC TO CB5V1        A34959 09399020
         L     R6,CB5V3                 GET RD DATA DISP         A34959 09402020
         AR    R6,R5                    ADD CHAN PROG ADDR       A34959 09405020
         ST    R6,CB5V3                 RD R0 DATA               A34959 09408020
FIXINIT  EQU   *                                                 A34959 09411020
         L     R3,DXUDCBAD              GET ADDR OF REAL DCB     Y02072 09413002
         LH    R4,DXUDCBML              GET MOVE LENGTH          Y02072 09415002
         BCTR  R4,0                     DECR BY 1 FOR EX INSTR   Y02072 09417002
         EX    R4,MOVEDCB               REFRESH REAL DCB         Y02072 09419002
         LR    R4,R1                    SAVE R1                  Y02072 09420002
*                                                                       09422002
         DROP  R1                                                       09430000
         USING IHADCB,R4                                                09440002
*                                                                       09442002
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         09450000
         L     R1,IOBECBAD         GET ECB ADDRESS FROM IOB      A49466 09460000
         LA    R1,0(R1)            CLEAR HIGH ORDER BYTE         A49466 09472000
*                                                                       09472402
         WAIT  1,ECB=(1)           WAIT FOR COMPLETION           A49466 09474000
         L     R1,IOBECBAD         GET ECB ADDRESS               A49466 09476000
         TM    0(R1),X'7F'         CHECK FOR NORMAL END          A49466 09478000
         BNO   ABEND               ABEND OF ABNORMAL END         A49466 09478400
         L     R1,IOBCPSAD         GET ADDRESS OF CP31                  09478800
         TM    DCBRECFM,FIXED      TEST IF FIXED LENGTH                 09478900
         BO    CPFREE              BR IF FIXED                          09479000
         USING CP31A,R1                                                 09485200
         MVC   ISLWRSAV(2),CB7+5   SAVE REM CAP FOR 192T/2V             09487200
         DROP  R1                                                       09489202
CPFREE   EQU   *                                                        09491200
         L     R0,CPSIZE           GET SIZE OF GOTTEN AREA       A49466 09491700
         FREEMAIN R,LV=(0),A=(1)   FREE GOTTEN CORE              A49466 09497800
         LR    R1,R4                    RESTORE R1                      09503902
         DROP  R4                                                       09504302
         USING IHADCB,R1        RE-ESTABLISH ADDRESSABILITY TO DCB      09505900
*                                                                       09510000
*                                                                       09540000
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 09550002
*                                                                       09560002
         MVI   DCBFIRSH+3,X'FF'         ALL DEVICES EXCEPT 2301         09570000
*                                                                       09580002
         MODESET  KEYADDR=DXUKEY,WORKREG=10  SET USERS KEY       Y02072 09620002
*                                                                       09670002
MASKA    MVC   ISLAREAZ+87(1),DCBFIRSH+3 MOVE DEVICE MASK               09690000
         EJECT                                                          10480000
*                                                                       10500000
* EXIT ********** EXIT ***************** EXIT *********** EXIT ******** 10520000
EXIT     EQU   *                                                 Y02072 10540002
*                                                                       10550002
         MODESET  EXTKEY=DATAMGT        SET DATA MGMT KEY        Y02072 10590002
*                                                                       10600002
         LM    R0,R15,DXCCW1            RESTORE REGISTERS        Y02072 10660002
         DROP  RD                       DROP WA ADDR             Y02072 10670002
         USING FORCORE,RCORE            EST WA ADDR              Y02072 10672002
         USING BASETAG,RBASE                                            10680000
         MVC   0(L'LOAD5G,RWTGC),LOAD5G ID OF MODULE IGG0195G    Y02072 10700002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       10720000
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       10740000
         CLC   0(2,RWTGC),THISLOAD                                      10760000
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 10780000
         CLC   0(2,RWTGC),OPNLOD7       TEST FOR END OF WTG TABLE       10800000
         BC    7,RELOOP                 BRANCH=NOT AT END               10820000
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                10840000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                10860000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              10880000
         BC    7,TCTLRTN                BRANCH = NOT ZERO               10900000
ITSZERO  LA    RWTGC,8(RWTGC)                                           10920000
         LA    RPARC,4(RPARC)                                           10940000
         B     ZCHECK                                                   10960000
TCTLRTN  EQU   *                                                        10980000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         11000000
         LA    R15,DXCCW12                                        24503 11040018
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 11060002
*                                                                       11062002
ABEND    EQU   *                                                 A49466 11070000
         ABEND X'033',DUMP,,SYSTEM      SYSTEM 033 ABEND         A49466 11074002
*                                                                       11074402
MOVEDCB  MVC   DCBKEYLE-IHADCB(0,R3),DCBKEYLE    REFRESH DCB     Y02072 11076002
*                                                                       11080000
         DS    0D                                                       11082000
*        CP31A                                                          11082620
CP31     CCW   X'31',IOBDADA3-IHAIOB,X'40',5                     A34959 11083220
         CCW   X'08',0,X'00',0          TIC                             11084000
         CCW   X'92',ISLOCNT-ISLCOMON,X'40',8                    A34959 11085020
         CCW   X'0E',0,X'60',0          RD KEY INTO KESAVE       A34959 11086020
*                                                                       11088000
*        CP31B                                                          11088820
         CCW   X'1B',CB61-CA1,X'40',6                            A34959 11089620
         CCW   X'31',CB61+2-CA1,X'40',5                          A34959 11090420
         CCW   X'08',CB2-CA1,X'00',0                             A34959 11091220
         CCW   X'12',0,X'40',8          READ COUNT OF LAST PD-DC        11092000
         CCW   X'06',0,X'00',0          READ DATA OF LAST PD BLK        11093000
         CCW   X'31',CB7-CA1,X'40',5                             A34959 11093220
         CCW   X'08',CB5V1-CA1,X'00',0                           A34959 11093420
         CCW   X'06',CB7+5-CA1,X'20',3                           A34959 11093620
*                                                                       11094000
         DS    0F                                                A34959 11094100
CPSIZE   DC    X'FA'                    SUBPOOL 250              A34959 11096020
         DC    AL3(CPEND-CA1)           CP SIZE                  A34959 11097020
MVI1     DC    X'00001B'                                                11120000
MVI2     DC    X'FF1007'                                                11140000
THISLOAD DC    C'6D'                    CURRENT MODULE ID               11360000
OPNLOD7  DC    C'0S'                                                    11380000
*                                                                       11396001
LOAD5G   DC    C'5G'                    ID OF MODULE IGG0195G    Y02072 11446002
*                                                                       11496002
PATCH    DC    XL50'00'                 ZEROED PATCH AREA        Y02072 11546002
         END                                                            11580000
