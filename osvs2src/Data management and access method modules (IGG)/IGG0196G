 TITLE 'IGG0196G - OPEN, RESUME LOAD'                                   00010000
IGG0196G CSECT                                                          00011002
*                                                                       00012002
*********************************************************************** 00013002
*                                                                     * 00014002
* MODULE-NAME = IGG0196G                                              * 00015002
*                                                                     * 00016002
* DESCRIPTIVE-NAME = ISAM OPEN, RESUME LOAD MODE                      * 00017002
*                                                                     * 00018002
* COPYRIGHT = NONE                                                    * 00019002
*                                                                     * 00020002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00021002
*                                                                     * 00022002
* FUNCTION = INITIALIZE COUNT FIELDS FOR ISLNCNT, OCNT, DCNT, BUFFER  * 00023002
*            1, AND IOBA.  SET ISLCBF, ISLWRSAV, AND, IF APPLICABLE,  * 00024002
*            EOT AND EOC BITS IN DCBST.                               * 00025002
*                                                                     * 00032002
* NOTES = SEE BELOW                                                   * 00033002
*                                                                     * 00034002
*    DEPENDENCIES = NONE                                              * 00035002
*                                                                     * 00036002
*    RESTRICTIONS = NONE                                              * 00037002
*                                                                     * 00038002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00039002
*                                                                     * 00040002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00041002
*                                                                     * 00042002
* MODULE-TYPE = OPEN EXECUTOR                                         * 00043002
*                                                                     * 00044002
*    PROCESSOR = ASSEMXF-370R                                         * 00045002
*                                                                     * 00046002
*    MODULE-SIZE = 950 DECIMAL BYTES                                  * 00047002
*                                                                     * 00048002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00049002
*                                                                     * 00050002
* ENTRY-POINT = IGG0196G                                              * 00051002
*                                                                     * 00052002
*    PURPOSE = SEE FUNCTION                                           * 00053002
*                                                                     * 00054002
*    LINKAGE = RECEIVES CONTROL FROM ISAM OPEN EXECUTOR IGG0195G IN   * 00055002
*              STORAGE PROTECT KEY 5 AND PRIVILEGED STATE.            * 00056002
*                                                                     * 00058002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00059002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00060002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00061002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00062002
*               PARAMETER LIST                                        * 00063002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00064002
*                                                                     * 00065002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00066002
*          UPON ENTRY TO THIS MODULE                                  * 00067002
*                                                                     * 00068002
* EXIT-NORMAL = XCTL IN STORAGE PROTECT KEY 5 TO ISAM OPEN EXECUTOR   * 00069002
*               IGG0195D IF HIGH-LEVEL INDEXES EXIST, OR TO IGG0195T  * 00069202
*               IF FULL TRACK INDEX WRITE IS SPECIFIED, OR TO         * 00069402
*               IGG0192U IF WRITE CHECK IS SPECIFIED, OTHERWISE TO    * 00069602
*               IGG0192R.                                             * 00069802
*                                                                     * 00070002
* EXIT-ERROR = NONE                                                   * 00071002
*                                                                     * 00076002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00077002
*                                                                     * 00078002
*    ROUTINES = NONE                                                  * 00079002
*                                                                     * 00081002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00082002
*                 FORCORE - OPEN WORK AREA                            * 00083002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00084002
*                                                                     * 00085002
*    CONTROL-BLOCKS = DCB COPY, DEB, AND IOB.                         * 00086002
*                                                                     * 00087002
* TABLES = NONE                                                       * 00088002
*                                                                     * 00089002
* MACROS = MODESET AND XCTL.                                          * 00090002
*                                                                     * 00091002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00092002
*                                                                     * 00093002
*                                                                     * 01041002
*********************************************************************** 01042002
         EJECT                                                          01043002
********************                                                    01044002
* DCB REFERENCE    *                                                    01060000
********************                                                    01080000
         DCBD  DSORG=(IS)                                               01100000
         USING IHADCB,R1                                                01120000
         EJECT                                                          01140000
********************                                                    01160000
* DEB REFERENCE    *                                                    01180000
********************                                                    01200000
*                                                                       01220000
IHADEB   DSECT                                                          01240000
         USING IHADEB,R8                                                01260000
         DS    0D                                                       01280000
DEBNMSUB DS    0CL1                                                     01300000
DEBTCBAD DS    A                                                        01320000
DEBAMLNG DS    0CL1                                                     01340000
DEBDEBAD DS    A                                                        01360000
DEBOFLGS DS    0CL1                                                     01380000
DEBIRBAD DS    A                                                        01400000
DEBOPATB DS    0CL1                                                     01420000
DEBSYSPG DS    A                                                        01440000
DEBNMEXT DS    0CL1                                                     01460000
DEBUSRPG DS    A                                                        01480000
DEBPRIOR DS    0CL1                                                     01500000
DEBECBAD DS    A                                                        01520000
DEBPROTG DS    0BL1                                                     01540000
DEBDEBID DS    0BL1                                                     01560000
DEBDCBAD DS    A                                                        01580000
DEBEXSCL DS    0CL1                                                     01600000
DEBAPPAD DS    A                                                        01620000
DEBNIEE  DS    0CL1                                                     01640000
DEBFIEAD DS    A                                                        01660000
DEBNPEE  DS    0CL1                                                     01680000
DEBFPEAD DS    A                                                        01700000
DEBNOEE  DS    0CL1                                                     01720000
DEBFOEAD DS    A                                                        01740000
         DS    CL4                                                      01760000
DEBDVMOD DS    0CL1                                                     01780000
DEBUCBAD DS    A                                                        01800000
DEBBINUM DS    CL2                                                      01820000
DEBSTRCC DS    CL2                                                      01840000
DEBSTRHH DS    CL2                                                      01860000
DEBENDCC DS    CL2                                                      01880000
DEBENDHH DS    CL2                                                      01900000
DEBNMTRK DS    CL2                                                      01920000
         EJECT                                                          01940000
*********************************************************************** 01960000
* ISLCOMON REFERENCE     C(DCBWKPT1)=A(ISLCOMMON)                     * 01980000
*********************************************************************** 02000000
*                                                                       02020000
ISLCOMON DSECT                                                          02040000
         USING ISLCOMON,R12                                             02060000
         DS    0D                                                       02080000
ISLECBA  DS    A                        FOR CP18 AND CP20               02100000
ISLIOBA  DS    CL40                                                     02120000
ISLECBB  DS    A                        FOR CP21                        02140000
ISLIOBB  DS    CL40                                                     02160000
ISLECBC  DS    A                        FOR CP19                        02180000
ISLIOBC  DS    CL40                                                     02200000
ISLAREAZ DS    CL88                     FOR CP19                        02220000
ISLIXLT  DS    CL104                    INDEX LOCATION TABLE            02240000
ISLNIRT  DS    CL3                      HHR OF DUMMY TRACK INDEX        02260000
ISLHIRT  DS    CL1                      NO INDX ENT ON PRIM DATA TRACK  02280000
ISLCBF   DS    F                        BUF CTRL PTR (RCD WITHIN BUF)   02300000
ISLBMPR  DS    F                        USED TO BUMP CBF TO NEXT RCD    02320000
ISLFBW   DS    F                        NO OF BUFS SCHED TO WRITE       02340000
ISLEOB   DS    F                        END OF BUFFR ADR                02360000
ISLNCNT  DS    CL8                      NORMAL IX COUNT, CCHHRKDD       02380000
ISLOCNT  DS    CL8                      OVFLOL IX COUNT, CCHHRKDD       02400000
ISLDCNT  DS    CL8                      DUMMY IX COUNT,  CCHHRKDD       02420000
ISLNDAT  DS    CL10                     NORMAL IX DATA, MBBCCHHRFP      02440000
         DS    CL2                                                      02460000
ISLODAT  DS    CL10                     OVFLOW IX DATA, MBBCCHHRFP      02480000
         DS    CL1                                                      02500000
ISLBUFNO DS    CL1                      DCBBUFNO OR 2                   02520000
ISLBUFN  DS    F                        ADDR OF SLOT N IN BCT           02540000
ISLMVC   DS    F                        COUNT OF EXECUTED MOVE (N-1)    02560000
ISLMVCT  DS    F                        NOMBR OF 255 BYTE MOVES (N+1)   02580000
ISLVRSAV DS    18F                      ISL SAVE AREA                   02600000
ISLAPSAV DS    10F                      APPENDAGE SAVE AREA             02620000
ISLWRSAV DS    16F                      ISL SAVE AREA FOR CLOSE         02640000
*                                                                       02660000
TSTWK1C  DS    F                        WORK AREA FOR FORMAT 000N       02680000
TSTWK2C  DS    F                        WORK AREA FOR FORMAT 00NN       02700000
         DS    F                                                        02720000
ISLNOENT DS    F                        NO ENTRIES REMAINING ON TRACK   02740000
ISLOFFST DS    F                        SIZE OF WR CKD INSTR IN BYTES   02760000
ISLD     DS    F                        DISCPLACEMENT FROM CP18 START   02780000
ISLFSTBF DS    F                        ADDR OF 1ST SCHED BUF (REL)     02800000
ISLLSTBF DS    F                        ADDR OF LAST SCHED BUF (REL)    02820000
ISLCCFAD DS    F                        ADDR OF CC FLAG IN CP18         02840000
ISLKEYAD DS    F                        ADDR OF KEY OF LAST RCD ON TRK  02860000
*                                                                       02880000
CL1AD    DS    F                        ADDR CP18 SKLTN                 02900000
CM1AD    DS    F                        ADDR CP19 SKLTN                 02920000
CQ1AD    DS    F                        ADDR CP20 SKLTN                 02940000
CQT1AD   DS    F                        ADDR CP20 WR CHK EXTN           02960000
CQ40AD   DS    F                        ADDR CP21 SKLTN          O19110 02980019
CQ45AD   DS    F                        ADDR CP21 WR CHK EXTN    O19110 03000019
*                                                                       03020000
         SPACE 3                                                        03040002
*                                                                       03060000
* ISLVPTRS REFERENCE       C(DCBWKPT6)=A(ISLVPTRS)                      03080000
*                                                                       03100000
ISLVPTRS DS    A                        A(AREA Y)                       03140000
         DS    A                        A(KEYSAVE)                      03160000
         DS    A                        A(IOBBCT)  BUF CTRL TBL ADR     03180000
         DS    A                        A(CP18)                         03200000
         DS    A                        A(CP19)                         03220000
         DS    A                        A(CP20)                         03240000
         DS    A                        A(CP21)                         03260000
         DS    A                        SIZE OF DCB WORK AREA    O19110 03260819
         DS    A                        SIZE OF CHANNEL PGM AREA O19110 03261619
         DS    A                        A(TRACK INDEX SAVE AREA) O19110 03262419
*                                       BIT 0-FULL TRK INDX WRITE       03263219
*                                       BIT 1-SUCCESSFUL GETMAIN        03264019
         DS    A                        A(CP20B)-FULL TRK INDX   O19110 03264819
*                                       WR                       O19110 03265619
         DS    A                        A(CP20C)-FULL TRK INDX   O19110 03266419
*                                       WR                       O19110 03267219
ISLFXWK1 DS    F                        WORK AREA                 13711 03268000
ISLFXWK2 DS    F                        WORK AREA                 13711 03272000
ISLF9WK1 DS    F                        WORK AREA                 13711 03276000
*                                                                       03280000
*                                                                       03300000
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03320000
*                                                                       03340000
IOBBCT   DSECT                                                          03360000
         USING IOBBCT,R11                                               03380000
         DS    0D                                                       03400000
IOBFLAGS DS    0CL1                     FLAGS                           03420000
IOBPTRA  DS    A                        PTR A                           03440000
IOBB     DS    0CL1                     B                               03460000
IOBPTRB  DS    A                        PTR B                           03480000
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03500000
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03520000
         EJECT                                                          03540000
********************                                                    03560000
* IOB REFERENCE    *                                                    03580000
********************                                                    03600000
*                                                                       03620000
IHAIOB   DSECT                                                          03640000
         USING IHAIOB,R2                                                03660000
         DS    0D                                                       03680000
IOBFLG1  DS    CL1                      FLAGS 1                         03700000
IOBFLG2  DS    CL1                      FLAGS 2                         03720000
         DS    CL1                                                      03740000
AOBSENSE DS    CL1                      SENSE                           03760002
IOBECBAD DS    A                        ECB POINTER                     03780000
AIOBCSW  DS    CL8                      CHANNEL STATUS WORD             03800002
AOBSIOCC DS    0CL1                     SIO CC                          03820002
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       03840000
IOBWT    DS    0CL1                     WEIGHT                          03860000
IOBDCBAD DS    A                        DCB POINTER                     03880000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     03900000
IOBBCTI  DS    CL2                      BLK CTR INCR                    03920000
IOBECT   DS    CL2                      ERROR CTR                       03940000
IOBDADAD DS    0CL8                                                     03944000
IOBDADA0 DS    CL1                      M                               03948000
IOBDADA1 DS    CL1                       B                              03952000
IOBDADA2 DS    CL1                        B                             03956000
IOBDADA3 DS    CL1                         C                            03960000
IOBDADA4 DS    CL1                          C                           03964000
IOBDADA5 DS    CL1                           H                          03968000
IOBDADA6 DS    CL1                            H                         03972000
IOBDADA7 DS    CL1                             R                        03976000
*                                                                       03980000
         EJECT                                                          04000000
****************************                                            04050002
* OPEN WORK AREA REFERENCE *                                            04080002
****************************                                            04090002
FORCORE  DSECT                                                          04110002
         IECDSECT                                                       04112002
         EJECT                                                          04114002
IGG0196G CSECT                                                          04120000
         BALR  R9,0                                                     04140000
         USING *,R9                                                     04160000
BASETAG  L     R1,0(RPARC)                                              04180000
         L     RCORE,4(RWTGC)                                           04200000
         USING FORCORE,RCORE            OPEN WA ADDRESSABILITY   Y02072 04210002
         L     R12,DCBWKPT1                                             04220000
         STM   R0,R15,DXCCW1            SAVE REGISTERS           Y02072 04260002
         LR    ROPENWA,RCORE            OPEN WORK AREA ADDRESS   Y02072 04270002
         DROP  RCORE                    END USING ON OPEN WA     Y02072 04280002
         USING FORCORE,ROPENWA          OPEN WA ADDRESSABILITY   Y02072 04290002
*                                                                       04300000
* EQUATE SYMBOLIC REGISTERS                                             04320000
*                                                                       04340000
R0       EQU   0                                                        04360000
R1       EQU   1                                                        04380000
R2       EQU   2                                                        04400000
R3       EQU   3                                                        04420000
R4       EQU   4                                                        04440000
R5       EQU   5                                                        04460000
R6       EQU   6                                                        04480000
R7       EQU   7                                                        04500000
R8       EQU   8                                                        04520000
R9       EQU   9                                                        04540000
R10      EQU   10                                                       04560000
R11      EQU   11                                                       04580000
R12      EQU   12                                                       04600000
ROPENWA  EQU   13                       OPEN WORK AREA ADDRESS   Y02072 04620002
R14      EQU   14                                                       04640000
R15      EQU   15                                                       04660000
RBASE    EQU   3                                                        04680000
RCORE    EQU   4                                                        04700000
RPAR     EQU   5                                                        04720000
RWTG     EQU   6                                                        04740000
RPARC    EQU   7                                                        04760000
RWTGC    EQU   8                                                        04780000
K3       EQU   3                        CONSTANT                 S20201 04910320
L1       EQU   1                        LENGTH                   S20201 04910620
LOCATE   EQU   X'08'                    LOCATE MODE - DCBMACRF   S20201 04910920
K4       EQU   4                        CONSTANT                 S20201 04911220
K1       EQU   1                        CONSTANT                 S20201 04911520
BOBSW    EQU   X'08'                                             A34959 04912020
FIXED    EQU   X'80'                                             A34959 04914020
BOBOFF   EQU   X'F7'                                             A34959 04916020
*                                                                       04920000
EOTSW    EQU   X'08'                    END OF TRACK SW          S20201 04923020
ALLBITS  EQU   X'FF'                    EVERYTHING               S20201 04926020
EOCSW    EQU   X'04'                    EOC SW                   S20201 04929020
EOT      EQU   X'01'                    EOT SW                   S20201 04932020
EOC      EQU   X'10'                    EOC SW                   S20201 04935020
         EJECT                                                          04940000
         MVC   DCBFTMI3(L'DCBLPDA),DCBLPDA SAVE LPDA FOR CLOSE   Y02072 04950002
*                                                                       04960000
         MODESET  KEYADDR=DXUKEY,WORKREG=2  SET USERS KEY        Y02072 04970002
*                                                                       05000000
TSTHSK   LA    R2,ISLIOBA               C(R2)=A(IOBA)                   05020000
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 05040000
         MVI   ISLECBA,X'40'            SIMULATE I/O ALREADY     M2676  05045020
*                                       * COMPLETED AS BUFFERS HAVE     05050020
*                                       * ALREADY BEEN WRITTEN          05055020
         L     R11,8(R10)               C(R11)=A(BCT)                   05060000
*********************************************************************** 06170000
*                                                                     * 06200000
*              SET COUNT FIELDS IN NCNT, OCNT, DCNT,                  * 06230000
*              BUFFR1, DCBLPDA, AND IOBA+32.                          * 06260000
*                                                                     * 06290000
*********************************************************************** 06320000
TSTHK09  EQU   *                                                        06350000
         LH    R8,DCBLRECL              C(R8)-LOGICAL RECORD LEN        07300000
         L     R3,8(0,R11)              C(R3)-A(BUF1)                   07310000
         L     R6,4(0,R10)              C(R9)-A(KEYSAVE)                07320000
         SR    R5,R5                    C(R5)=ZERO                      07330000
         IC    R5,DCBKEYLE              C(R5)-KEYLENGTH                 07340000
         STC   R5,ISLNCNT+5             NCNT=XXXXXKXX                   07350000
         MVC   ISLNCNT+6(2),TST10       NCNT=XXXXXKDD                   07360000
         MVC   ISLOCNT+5(3),ISLNCNT+5   OCNT=XXXXXKDD                   07370000
         MVC   ISLDCNT+5(3),ISLNCNT+5   DCNT=XXXXXKDD                   07380000
         L     R7,0(0,R10)              C(R7)=A(AREA Y)                 07390000
         MVC   5(3,R7),ISLNCNT+5        C(Y+5)=KDD FROM NCNT            07400000
         MVC   0(5,R3),DCBLPDA+3        CCHHR OF BUF1 FROM LPDA         07410000
         EJECT                                                          07420000
*********************************************************************** 07430000
*                                                                     * 07440000
*       RESUME LOAD ON LPDA TRACK - CHECK LAST BLOCK FOR PADDING      * 07450000
*                                                                     * 07460000
*********************************************************************** 07470000
*                                                                       07480018
*   IS LAST PRIME DATA BLOCK PADDED - IF SO RESUME LOAD                 07490018
*   TO OVERLAY PADDING                                                  07500018
*                                                                       07510018
TSTHK05  LH    R7,DCBRKP                C(R7)-RELATIVE KEY POSIT        07560000
         LA    R4,8(R7,R3)              C(R9)-A(KEY OF PAD BLK)         07570000
         BCTR  R5,0                     DECREMENT KEYLENGTH FOR         07580000
*                                       SEQUENCE CHECK                  07590000
         LA    R7,8(R3)                 C(R7)-START OF BLOCK READ M3214 07593018
         TM    DCBRECFM,FIXED           IS RECORD FORMAT FIXED   A34959 07593720
         BNO   TSTHK051                 NO - VARIABLE -- BR      A34959 07594420
*   FIXED LENGTH - USE BLKSIZE                                          07595120
         AH    R7,DCBBLKSI              C(R7)-END OF BLOCK READ   M3214 07596018
         B     TSTHK05A                 SKIP VLR PROCESSING      A34959 07596220
*   VARIABLE LENGTH - USE BLOCK DESCRIPTOR WORD FOR BLOCKSIZE           07596420
TSTHK051 EQU   *                        *                        A34959 07596620
         LA    R10,4(R7)                PT TO START OF RECORD    A34959 07596820
         AH    R7,0(R7)                 ADD BDW TO GET END       A34959 07597020
         LA    R4,4(R4)                 ALLOW FOR BDW            A34959 07597220
*   VLR - USE RECORD DESCRIPTOR WORD FOR LRECL                          07597420
TSTHK052 EQU   *                                                 A34959 07597620
         TM    DCBRECFM,FIXED           IS RECORD FORMAT FIXED   A34959 07597820
         BO    TSTHK05A                 YES, BRANCH              A34959 07598020
         MVC   TSTWK1C(2),0(R10)        RDW                      A34959 07598220
         LH    R8,TSTWK1C               LRECL                    A34959 07598420
         AH    R10,TSTWK1C              PT TO NEXT RECORD        A34959 07598620
TSTHK05A EX    R5,COMPKEY               COMPARE REC K TO HIGH K         07600000
         LA    R4,0(R8,R4)              C(R9)-A(KEY OF NXT RCD)         07610000
         BE    TSTHK05C                 BR IF KEY IS IN BLOCK     24503 07611018
         CR    R7,R4                    IS NEXT KEY OUT OF BLOCK  M3214 07612018
         BH    TSTHK052                 BR TO CONTINUE SEARCH    A34959 07613020
*                                  LAST BLOCK IS FULL                   07614018
         TM    DCBRECFM,FIXED           IS RECORD FORMAT FIXED   A34959 07614620
         BNO   TSTHK05F                 BR IF VARIABLE           A34959 07615220
TSTHK05C EQU   *                        *                        A34959 07615820
         TM    DCBRECFM,FIXED           IS RECORD FORMAT FIXED   A34959 07616420
         BO    TSTHK05D                 BR IF FIXED LEN RECS     A34959 07617020
         NI    IOBFLAGS,BOBOFF          SET BOB SW OFF           A34959 07617620
         B     TSTHK05F                 BRANCH, WILL NOT         A34959 07618220
*                                       OVERLAY INDEX IF VLR            07618820
TSTHK05D EQU   *                                                 A34959 07619420
FULLSW   EQU   X'02'                    BUFFER FULL INDICATOR    S20201 07619820
*                                                                       07619902
         MODESET  EXTKEY=DATAMGT        SET DATA MGT KEY         Y02072 07620002
*                                                                       07621002
         NI    DCBST,X'FF'-FULLSW       LAST BLOCK NOT FULL      S20201 07623502
         CR    R7,R4                    END OF BLOCK             S20201 07624502
*                                       A3249                    S20201 07625502
         BH    TSTHK05F                 YES - MOVE MODE / END OF S20201 07626502
*                                       * BUFFER, MUST CHECK FOR        07632520
*                                       * LOCATION AND SET SWITCHES.    07632920
         OI    DCBST,FULLSW             BLOCK FULL               S20201 07633320
*                                                                       07633402
         MODESET  KEYADDR=DXUKEY,WORKREG=7  SET USERS KEY        Y02072 07633502
*                                                                       07633602
         IC    R5,K3(R3)                SAVE LOW HEAD            S20201 07633720
         NC    K3(L1,R3),DCBHMASK       NORMALIZE HEAD           S20201 07634120
         BAL   R7,FULLMOVE              BR TO TEST               S20201 07634520
         STC   R5,K3(R3)                RESTORE LOW HEAD         S20201 07634920
         TM    DCBRECFM,LOCATE          LOCATE MODE              S20201 07635320
         BO    TSTHK05F                 YES - BOB NOT NEEDED     S20201 07635720
         NI    IOBFLAGS,X'FF'-BOBSW     TURN OFF BOB SW TO FORCE S20201 07636120
*                                       * NEW BUFFER                    07636520
*                                       * INDICATOR                     07636920
TSTHK05F EQU   *                        *                        S20201 07637320
*                                                                       07637702
         MODESET KEYADDR=DXUKEY,WORKREG=7  SET USERS KEY         Y02072 07637802
*                                                                       07637902
*                                       NEXT LOGICAL RECORD             07638120
         SH    R4,DCBRKP                C(R4)-CURRENT BUFF PTR   S20201 07638520
*                                        M321                    S20201 07638920
         SR    R4,R8                    PT TO LAST FIKLED ENTRY  S20201 07639320
*                                       A3249                    S20201 07639720
         ST    R4,ISLCBF                STORE CURRENT BUFF PTR   S20201 07640120
         MVC   ISLDCNT(5),DCBLETI       INIT CCHHR               A34959 07642020
         MVC   ISLNCNT(5),DCBLETI       INIT CCHHR               A34959 07644020
         TM    DCBRECFM,FIXED           IS RECORD FORMAT FIXED   A34959 07646020
         BO    TSTHK06                  BR IF FIXED              A34959 07648020
         TM    IOBFLAGS,BOBSW           TEST IF TRACK FULL       A34959 07650020
         BO    TSTHK18                  NO NEED TO RESET BUFF    A34959 07652020
*                                       LEN                      A34959 07654020
*                                       AND TRACK CAPACITY              07656020
         LA    R7,8(R3)                 POINT TO START OF BLOCK  A34959 07658020
         LH    R5,0(R7)                 PICK UP BDW              A34959 07660020
         SR    R5,R8                    SUBTRACT LENGTH OF       A34959 07662020
*                                       BLOCK READ                      07664020
         STH   R5,0(R7)                 RESET LENGTH             A34959 07666020
*                                                                       07668020
*   MUST NOW SET REMAINING CAPACITY OF TRACK TO WHAT IT WAS             07670020
*        BEFORE BLOCK WRITTEN.                                          07672020
*                                                                       07674020
         AR    R5,R8                    R5 = BLKLEN              A34959 07676020
         SR    R6,R6                                             A34959 07678020
         IC    R6,DCBKEYLE              R6 = KEY LENGTH          A34959 07680020
         AR    R5,R6                    R5 = BLKLEN + KEYLEN     A34959 07682020
         L     R8,DCBLRAN               PTR TO ENTRY IN DEV      A34959 07684020
*                                       TABLE                    A34959 07686020
         IC    R6,7(R8)                 R6 = LIDO                A34959 07688020
         AR    R5,R6                    R5 = BLKLEN+KEYLEN+LIDO  A34959 07690020
         AH    R5,ISLWRSAV              ADD REMAINING CAPACITY   A34959 07692020
         STH   R5,ISLWRSAV              RESET REMAINING CAPACITY A34959 07694020
*                                                                       07696020
TSTHK06  EQU   *                                                 A34959 07698020
*********************************************************************** 07700000
*                                                                     * 07710000
*        SET NORMAL TRACK INDEX TO OVERLAY CURRENT ENTRY.             * 07720000
*                                                                     * 07730000
*********************************************************************** 07740000
TSTHK07A MVC   ISLOCNT(5),DCBLETI                                       07750000
         IC    R7,ISLNCNT+3                                             07780000
         BCTR  R7,0                                                     07790000
         SR    R6,R6                    CLEAR                    S20201 07795020
         IC    R6,ISLHIRT                                               07800000
         SR    R5,R5                                                    07810000
*   DETERMINE WHICH INDEX ENTRY TO PASS TO PROCESSING MODULE            07811020
         TM    DCBST,EOT+FULLSW         EOT - NOT SCHE TO WRITE  S20201 07812020
         BO    EOTEXT                   YES - USE NEXT INDEX     S20201 07813020
NOTEOTX  EQU   *                        SAME ENTRY               S20201 07814020
*   BACK UP NCNT SO PROCESSING MODULE WILL INCREMENT TO SAME ENTRY      07815020
         IC    R5,DCBLETI+4                                             07820000
         BCTR  R5,0                                                     07830000
         LTR   R5,R5                                                    07840000
         BZ    TSTHK07B                                                 07850000
         STC   R5,ISLOCNT+4                                             07860000
         BCTR  R5,0                                                     07870000
         LTR   R6,R5                                                    07880000
         BP    TSTHK07D                                                 07890000
         STC   R7,ISLNCNT+3                                             07900000
         B     TSTHK07C                                                 07910000
TSTHK07B EQU   *                        TEST HEAD FOR NEW CYL   SA53743 07912000
         NC    ISLOCNT+K3(L'DCBHMASK),DCBHMASK HEAD ZERO        SA53743 07914000
         BNZ   TSTHK                    BR IF NOT HEAD ZERO     SA53743 07916000
*                                                                       07916402
         MODESET  EXTKEY=DATAMGT        SET DATA MGT KEY         Y02072 07916802
*                                                                       07917202
         OI    DCBST,EOC                SET INDICATOR TO BEGIN  SA53743 07918000
*                                       ON NEW CYLINDER         SA53743 07918400
         MODESET  KEYADDR=DXUKEY,WORKREG=4  SET USERS KEY        Y02072 07918802
*                                                                       07919202
TSTHK    STC   R7,ISLOCNT+3                                     SA53743 07920000
         STC   R7,ISLNCNT+3                                             07930000
         STC   R6,ISLOCNT+4                                             07940000
TSTHK07C BCTR  R6,0                                                     07950000
TSTHK07D STC   R6,ISLNCNT+4                                             07960000
         B     TSTHK18                                                  07970000
*   END OF TRACK OR CYLINDER USE CURRENT ENTRIES                        07970720
EOTEXT   EQU   *                        *                        S20201 07971420
         SR    R7,R7                    CLEAR                    S20201 07972120
         IC    R7,ISLOCNT+K4            RECORD NUMBER            S20201 07972820
         LA    R7,K1(R7)                OF OVERFLOW              S20201 07973520
         IC    R5,ISLOCNT+K3            HEAD OF OVERFLOW         S20201 07974220
         LA    R5,K1(R5)                + ONE                    S20201 07974920
         CR    R6,R7                    IS IT VALID              S20201 07975620
         BNL   EOTEXT1                  YES-SAVE IT              S20201 07976320
         STC   R5,ISLOCNT+K3            INCREMENT HEAD           S20201 07977020
         LA    R7,K1                    RECORD = 1               S20201 07977720
         STC   R5,ISLDCNT+K3            HEAD OF DUMMY            S20201 07978420
EOTEXT1  EQU   *                        *                        S20201 07985420
         STC   R7,ISLOCNT+K4            RECORD                   S20201 07992420
         LA    R7,K1(R7)                INCREMENT TO DUMMY       S20201 07999420
         CR    R6,R7                    RECORD VALID             S20201 08003420
         BNL   EOTEXT2                  YES                      S20201 08007420
         STC   R5,ISLDCNT+K3            HEAD                     S20201 08011420
         LA    R7,K1                     RECORD = 1              S20201 08015420
EOTEXT2  EQU   *                        *                        S20201 08019420
         STC   R7,ISLDCNT+K4            RECORD NUMBER            S20201 08023420
         B     TSTHK18                  DONE                     S20201 08027420
         EJECT                                                          08031420
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   08035420
*              M O V E  M O D E  -  END OF BUFFER                   *   08040020
*                                                                   *   08070020
*   SET IOBFLAGS TO PROPER STATUS                                   *   08100020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *   08130020
FULLMOVE EQU   *                        *                        A32496 08160020
*   MAKE SURE FIRST BUFFER NOT SCHEDULED                                08180020
         NI    IOBS,ALLBITS-EOTSW-EOCSW REMOVE INDICATORS        S20201 08200020
         LA    R6,DCBHIRPD              ASSUME NOT SHARED        A32496 08400020
         CLI   DCBFIRSH+2,1             IS THERE A SHARED TRACK  A32496 08430020
         BE    QNOTSHRD                 NO - NORMAL PRIME TRACK  A32496 08460020
         CLC   DCBFIRSH+1(1),3(R3)      IS THIS A SHARED TRACK   A32496 08490020
         BNE   QNOTSHRD                 NO - NORMAL PRIME TRACK  A32496 08520020
         LA    R6,DCBHIRSH              PT TO HI R OF TRK        A32496 08550020
QNOTSHRD EQU   *                        *                        A32496 08580020
         CLC   4(1,R3),0(R6)            LAST ON TRACK            A32496 08610020
         BCR   7,R7                     NO - FINISHED            A32496 08640020
*                                                                       08650002
         MODESET  EXTKEY=DATAMGT        SET DATA MGT KEY         Y02072 08660002
*                                                                       08662002
         OI    DCBST,EOT                SET EOT SW               S20201 08670020
*                                                                       08680002
         MODESET  KEYADDR=DXUKEY,WORKREG=6  SET USERS KEY        Y02072 08690002
*                                                                       08692002
*   TEST FOR END OF CYLINDER                                            08700020
         CLC   DCBLDT+1(1),3(R3)        LAST TRACK OF CYLINDER   A32496 08730020
         BCR   7,R7                     NO - FINISHED            A32496 08760020
*                                                                       08770002
         MODESET  EXTKEY=DATAMGT        SET DATA MGT KEY         Y02072 08780002
*                                                                       08782002
         OI    DCBST,EOC                D.S. STARTS ON NEW CYL   S20201 08790020
*                                                                       08840002
         MODESET  KEYADDR=DXUKEY,WORKREG=6  SET USERS KEY        Y02072 08890002
*                                                                       08900002
         BR    R7                       RETURN                   A32496 08940020
         EJECT                                                          09000002
TSTHK18  MVC   IOBDADA0(3),DCBLPDA                                      09250000
         MVC   IOBDADA3(5),0(R3)                                        09260000
         IC    R5,IOBDADA7                                              09270000
         BCTR  R5,0                                                     09280000
         STC   R5,IOBDADA7                                              09290000
TSTHK19  MVI   ISLDCNT+4,X'00'                                          09300000
         SR    R3,R3                    C(R3)=ZERO                      09310000
         IC    R3,DCBKEYLE              C(R3)=KEYLENGTH                 09320000
         BCTR  R3,0                     KEYLENGTH-1 FOR EXECUTE         09330000
         L     R3,8(0,R11)              C(R3)-A(BUF1)                   09380000
         MVC   TSTWK1C(4),1(R3)         CHHR OF BUF1 TO WORK AREA       09390000
VLR      EQU   X'40'                    VLR BIT                  A46070 09390421
         TM    DCBRECFM,VLR             VLR?                     A46070 09390821
         BO    TSTHK19B                 YES, SET EOT,EOC MAYBE   A46070 09391221
         TM    DCBST,EOT+FULLSW         IS IT EOT                S20201 09392020
         BO    EXIT                     YES - DONE               S20201 09394020
         B     TSTHK19C                 BR AROUND BOBSW TEST     M0935  09394421
TSTHK19B EQU   *                        FINISH MARKING           S20201 09396020
         TM    IOBFLAGS,BOBSW           END OF TRACK?            A46070 09398021
         BO    TSTHK20                  YES, SET IOBS BITS       A46070 09398421
TSTHK19C EQU   *                                                 M0935  09398821
         CLI   DCBHIRSH,X'00'           TEST FOR SHARED TRACK           09430002
         BE    TSTHK23                  BR-NO SHARED TRACK              09440000
         CLC   DCBFIRSH+1(1),TSTWK1C+2  FIRST REC ON SHARED TRK? A47330 09450000
         BNE   TSTHK23                  BRANCH IF NOT                   09460000
         CLC   DCBHIRSH(1),TSTWK1C+3    HI R ON SHARED TRK              09470000
         BH    EXIT                     BR-NOT EOT                      09480000
TSTHK20  OI    8(R11),X'08'             T-BIT ON IN BUF1                09490000
         CLC   DCBLDT+1(1),TSTWK1C+2    LAST TRACK ON CYL               09500000
         BH    EXIT                     BR-NOT EOC                      09510000
         OI    8(R11),X'04'             C-BIT ON IN BUF1                09520000
         B     EXIT                                                     09530000
TSTHK23  CLC   DCBHIRPD(1),TSTWK1C+3    HI R ON UNSHARED TRK            09540000
         BE    TSTHK20                  BR-EOT                          09550000
         EJECT                                                          10480000
*                                                                       10500000
* EXIT ********** EXIT ***************** EXIT *********** EXIT ******** 10520000
*                                                                       10540000
EXIT     EQU   *                                                        10546000
         LM    R0,R15,DXCCW1            RESTORE REGISTERS        Y02072 10552002
         DROP  ROPENWA                  END USING ON OPEN WA     Y02072 10554002
         USING FORCORE,RCORE            EST ADDR ON OPEN WA      Y02072 10556002
*                                                                       10556402
         MODESET  EXTKEY=DATAMGT        SET DATA MGT KEY         Y02072 10556802
*                                                                       10557202
         USING BASETAG,RBASE            ESTABLISH BASE           O19110 10558019
         CLI   DCBNLEV,X'00'            ANY HIGH LEVEL INDEXES    24503 10566018
         MVC   0(L'LOAD5D,RWTGC),LOAD5D XCTL TO 5D IF YES        Y02072 10576002
         BNE   RELOOP                   BR IF YES                M4874  10584019
         TM    DCBOPTCD,X'40'           FULL TRACK INDEX WRITE   O19110 10592019
         BO    EXIT5T                   YES                      O19110 10598019
         TM    DCBOPTCD,X'80'           TEST FOR WRITE CHECK      24503 10606018
         MVC   0(L'LOAD2R,RWTGC),LOAD2R XCTL TO 2R IF NOT        Y02072 10616002
         BZ    RELOOP                   BR IF NOT                M4874  10626019
         MVC   0(L'LOAD2U,RWTGC),LOAD2U XCTL TO 2U IF WRITE CHCK Y02072 10636002
         B     RELOOP                   BRANCH TO RELOOP         O19110 10656019
EXIT5T   MVC   0(L'LOAD5T,RWTGC),LOAD5T MOVE 5T ID               Y02072 10676002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       10720000
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       10740000
         CLC   0(2,RWTGC),THISLOAD                                      10760000
         BE    BASETAG                  BR-BEGIN THIS MODULE            10780000
         CLC   0(2,RWTGC),OPNLOD7       TEST FOR END OF WTG TABLE       10800000
         BNE   RELOOP                   BR IF NOT AT END         M4874  10820019
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                10840000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                10860000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              10880000
         BNE   TCTLRTN                  BR IF NOT AT END         M4874  10900019
ITSZERO  LA    RWTGC,8(RWTGC)                                           10920000
         LA    RPARC,4(RPARC)                                           10940000
         B     ZCHECK                                                   10960000
TCTLRTN  EQU   *                                                        10980000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         11000000
         LA    R15,DXCCW12                                              11040002
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 11060002
*                                                                       11080000
COMPKEY  CLC   0(1,R6),0(R4)            COMPARE CURRENT KEY TO          11083000
*                                       HIGH KEY                        11089000
TST10    DC    H'10'                                                    11240000
THISLOAD DC    C'6G'                    CURRENT MODULE ID               11310000
OPNLOD7  DC    C'0S'                                                    11380000
LOAD2R   DC    C'2R'                    ID OF MODULE IGG0192R    Y02072 11430002
LOAD2U   DC    C'2U'                    ID OF MODULE IGG0192U    Y02072 11440002
LOAD5D   DC    C'5D'                    ID OF MODULE IGG0195D    Y02072 11450002
LOAD5T   DC    C'5T'                    ID OF MODULE IGG0195T    Y02072 11460002
*                                                                       11480002
PATCH    DC    XL50'00'                 ZEROED PATCH AREA        Y02072 11530002
         END                                                            11580000
