         TITLE 'IGG0196P (D/A UPDATE)'                                  00007020
IGG0196P CSECT                                                          00014020
*MODULE NAME - IGG0196P                                          Y02072 00016002
*                                                                       00018002
*DESCRIPTIVE NAME - BUILD IOBS                                   Y02072 00020002
*                                                                       00022002
*COPYRIGHT - NONE                                                Y02072 00022402
*                                                                       00022802
*CHANGE ACTIVITY - AS FOLLOWS:                                   Y02072 00023202
*                                                                       00023602
*          VS2 RELEASE 2 DELETIONS                               Y02072 00024002
*000090,034000,035300,035500,035700-035740,053060,053080,053100, Y02072 00024402
*058600,108400-110400,111000-112000,112110,112400,128800-129090, Y02072 00024802
*129100,129110-129170,112100,112200,116800-1174000,118000        Y02072 00024902
*14400,34400,35400                                               YM1393 00026902
*                                                                YM4640 00027002
*C24200,70880,81800                                              YM5362 00029002
*D122600-128000                                                  YM5362 00031002
*                                                                YM7595 00031402
*                                                                       00031803
*          VS2 RELEASE 3 DELETIONS                                      00032203
*                                                              @Z30TSCF 00032303
*                                                                       00032402
*          RELEASE 21 DELETIONS                                         00034702
*0340120500-121600                                               A37507 00037002
*0340                                                            A40538 00039302
*0340019460,019520,019900,020000,020100,020700-020900,           A31983 00041602
*0340070100-070400,070500,070800,080400-080600,087600-087800     A31983 00043902
*0340105400                                                       M0950 00046202
*                                                                       00048502
*STATUS CHANGE LEVEL 003                                                00057702
*                                                                       00059702
*FUNCTION/OPERATION- THIS ROUTINE WILL SET UP A CODE IN THE DCBCNTRL    00060020
*      FIELD FOR IGG01912.  IGG01912 (LOAD EXECUTOR) WILL DETERMINE     00080020
*      FROM THIS CODE WHICH ROUTINES WILL BE BROUGHT INTO CORE AT       00100020
*      OPEN TIME.                                                       00120002
*      IT WILL LINK THE IOB'S AND INITIALIZE THEM.                      00160020
*      IT WILL CONSTRUCT THE CHANNEL PROGRAMS NEEDED FOR PROPER EXECUT. 00180020
*      IT WILL SET UP THE NUMBER OF EXTENTS NEEDED AND PLACE THE        00200020
*      ADDRESSES IN THE DCB AND IOB'S.                                  00220020
*                                                                       00240020
*ENTRY POINTS- ENTERED FROM IGG0191P BY USE OF THE XCTL MACRO.          00260002
*                                                                       00280020
*INPUT- SEE DESCRIPTION OF REGISTERS, DCB(USERS).                       00300020
*                                                                       00320020
*OUTPUT & IOB(USER)- SEE DESCRIPTION OF REGISTERS, DCB(USERS).          00340020
*                                                                       00360020
*EXTERNAL ROUTINES- NONE.                                               00380020
*                                                                       00400020
*EXITS-NORMAL-XCTL TO IGG01912, IGG01915 TO LOAD ROUTINES               00420002
*                                                                       00440020
*EXITS-ERROR- NONE.                                                     00460020
*                                                                       00470002
*MACROS : ACTION - MODESET, XCTL, XCTLTABL                       Y02072 00472002
*                                                                       00474002
*MACROS : MAPPING - IHACCW, DCBD, IECDSECS, IGGBCB, IEZDEB, IHAFCAUD    00476002
*                                                                       00480020
*TABLES/WORKAREAS- WHERE TO GO TABLE (WTG)                              00500020
*                                                                       00520020
*      BYTE  0-7  NAME                                                  00540020
*      BYTE  8-10 RELATIVE DISK ADDRESS(TTR) OF FIRST RECORD            00560020
*      BYTE 11    CONCATENATION NUMBER                                  00580020
*      BYTE 12    ZERO                                                  00600020
*      BYTE 13    ALIAS INDICATOR AND USER DATA FIELD DESCRIPTOR.       00620020
*                        ALIAS INDICATOR 1 BIT                          00640020
*                        NUMBER OF TTRS IN USERS DATA FIELD 2 BITS      00660020
*      BYTE 14-16 TTR OF FIRST TEXT RECORD                              00680020
*      BYTE 17    ZERO                                                  00700020
*      BYTE 18-19 TTR OF NOTE LIST OR SCATTER LIST                      00720020
*      BYTE 20    TRANSLATION TABLE                                     00740020
*      BYTE 21    ZERO OR NUMBER OF ENTRIES IN THE NOTE LIST            00760020
*      BYTE 22-23 ATTRIBUTES                                            00780020
*      BYTE 24-26 TOTAL CONTIGUOUS MAIN STORAGE REQUIRED FOR MODULE     00800020
*      BYTE 27-28 LENGTH OF FIRST TEXT RECORD                           00820020
*      BYTE 29    LENGTH OF WTG TABLE (IN DOUBLE WORDS)                 00840020
*      BYTE 30-31 PATH THROUGH LOADS OF ROUTINES                        00860020
*      BYTE 32-36 IDTTR OF EXECUTOR FOR FIRST DCB                       00880020
*      BYTE 37-39 WORKAREA ADDRESS FOR FIRST DCB                        00900020
*      BYTE 40-   TABLE OF IDTTR'S                                      00920020
*      BYTE 32+N(8) IDTTR OF EXECUTOR FOR N TH DCB   (5 BYTES)          00940020
*                   WORKAREA ADDRESS FOR N TH DCB    (3 BYTES)          00960020
*                   IDTTR OF LAST ROUTINE LOAD       (5 BYTES)          00980020
*                   NOT USED                         (3 BYTES)          01000020
*                                                                       01020020
*      SEE DEVICETB DSECT                                               01040020
*                                                                       01060020
*ATTRIBUTES- REENTRANT,REUSABLE,RUNS IN USER KEY UNLESS          Y02072 01080002
*            OTHERWISE SPECIFIED,SUPER STATE                     Y02072 01090002
*                                                                       01100020
*                                                                       01120020
*********************************************************************** 01140020
*                                                                       01160020
*  REGISTER CONVENTIONS USED THROUGH OUT ALL OPEN PASSES                01180020
*                                                                       01200020
*********************************************************************** 01220020
*                                                                       01240020
RDCB     EQU   2         DCB REGISTER                                   01260020
RBASE    EQU   3         BASE REGISTER                                  01280020
RCORE    EQU   4         WORK AREA ADDRESS                              01300020
RPAR     EQU   5         TOP OF PARAMETER LIST                          01320020
RWTG     EQU   6         TOP OF WTG TABLE                               01340020
RPARC    EQU   7         CURRENT PARAMETER                              01360020
RWTGC    EQU   8         CURRENT TRANS LOAD                             01380020
RDEB     EQU   9         DEB REGISTER                            YM5362 01390002
RUCB     EQU   10        COUNTER IN IOB GENERATION                      01420020
RBUFADR  EQU   11        ADDR OF NEXT AVAIL BUFFER               YM7595 01430002
RB       EQU   12        WORK REG1  **                                  01460020
RC       EQU   13        WORK REG2  **  USED IN IOB GENERATION          01480020
RD       EQU   14        WORK REG3  **                                  01500020
RWK3     EQU   15        WORK REGISTER                           YM5362 01530002
RBRNCH   EQU   RWK3      USED TO BRANCH TO SUBROUTINES           YM5362 01532002
RE       EQU   0         WORK REG5                                      01540020
RWK1     EQU   RE        WORK REGISTER                           YM7595 01552002
RF       EQU   1         WORK REG6                                      01560020
RWK2     EQU   RF        WORK REGISTER                           YM5362 01570002
*                                                                       01580020
*********************************************************************** 01600020
*                                                                       01620020
* MASKS FOR ACCESS METHODS IN SAM                                       01640020
*                                                                       01660020
QSAMB    EQU   X'01'                                                    01680020
*                                                                       01700020
*                                                                       01720020
*********************************************************************** 01740020
*                                                                       01760020
* MASKS FOR MACRO'S TO BE USED                                          01780020
*                                                                       01800020
POINTB   EQU   X'04'                                                    01820020
*                                                                       01840020
*********************************************************************** 01860020
*                                                                       01880020
* DCB OFFSET CONSTANTS                                                  01900020
*                                                                       01920020
WCPO     EQU   48                                                       01940020
WCWCPL   EQU   6                        WRITE CHAN PGM LEN WITH  A31983 01950021
*                                          WRT CHK               A31983 01952021
WCTOWCPL EQU   7                        WRITE CHAN PGM LEN WITH  A31983 01954021
*                                          WRT CHK + TRK OVFLOW  A31983 01956021
THREECCW EQU   24                       LEN OF 3 CCW'S           A31983 01958021
WCPL     EQU   3                                                        01960020
OFFSR    EQU   112                                                      01980020
WCOSRQ   EQU   X'88'                    READ CP OFFSET WITH WRT  A31983 01990021
*                                          CHK FOR QSAM          A31983 02000021
TOWCOSRQ EQU   X'90'                    READ CP OFFSET WITH WRT  A31983 02010021
*                                          CHK + TRK OVFLOW FOR  A31983 02012021
*                                          QSAM                  A31983 02014021
WCOSRB   EQU   X'80'                    WRITE CP OFFSET WITH WRT A31983 02016021
*                                          CHK FOR BSAM          A31983 02018021
TOWCOSRB EQU   X'88'                    WRITE CP OFFSET WITH WRT A31983 02018421
*                                          CHK + TRK OVFLOW FOR  A31983 02018821
*                                          BSAM                  A31983 02019221
OFFSW    EQU   64                                                       02020020
OFFSRB   EQU   104                                                      02040020
WRTCKL   EQU   32             LENGTH OF WRITE CHECK SECTION OF    18445 02050020
*                             WRITE CHANNEL PROGRAM               18445 02060020
WRTCKCCW EQU   X'1E'          OFFSET TO WRT CHK CCW               M0950 02070021
*                                                                       02100020
*********************************************************************** 02120020
*                                                                       02140020
* MASKS USED TO TEST OPTION FIELDS IN DCB                               02160020
*                                                                       02180020
DOUBLE   EQU   X'01'                                                    02200020
WRTCK    EQU   X'80'                                                    02220020
UPDATEB  EQU   X'80'                                                    02240020
TRKOVFLB EQU   X'20'                    TRACK OVERFLOW OPTION           02260020
*                                                                       02280020
*********************************************************************** 02300020
*                                                                       02320020
* COMMAND BYTES FOR THE 2841                                            02340020
*                                                                       02360020
*       CONTROL UNIT                                                    02380020
*                                                                       02400020
SEEK     EQU   X'1B'                    SEEK HEAD OP CODE        YM5362 02420002
NOP      EQU   X'03'                    NOP OP CODE              YM5362 02430002
SRCHE      EQU   X'31'                                                  02440020
RDC        EQU   X'92'                                                  02460020
RDD        EQU   X'86'                                                  02480020
RDDX     EQU   X'06'                                                    02500020
TIC        EQU   X'08'                                                  02520020
WRTD       EQU   X'05'                                                  02540020
WRTKD    EQU   X'0D'                                                    02560020
RDKD     EQU   X'8E'                                                    02580020
*                                                                       02600020
*********************************************************************** 02620020
*                                                                       02640020
*   CHANNEL CONTROL WORD FLAGS                                          02660020
*                                                                       02680020
SLI        EQU   X'20'                                                  02700020
CC         EQU   X'40'                                                  02720020
SLICC    EQU   X'60'                                                    02740020
CCSK     EQU   X'50'                                                    02760020
SLICCSK  EQU   X'70'                                                    02780020
*                                                                       02800020
*********************************************************************** 02820020
*                                                                       02840020
* MASKS FOR RECORD FORMATS                                              02860020
*                                                                       02880020
FORMATU    EQU   X'C0'                                                  02900020
*                                                                       02920020
*********************************************************************** 02940020
*                                                                       02960020
* OFFSET FOR PARAMETER TESTS                                            02980020
*                                                                       03000020
ONE      EQU   1                                                        03020020
TWO      EQU   2                        CONSTANT OF 2            M0950  03030021
NOT      EQU   X'FF'                                                    03040020
*                                                                       03060020
*********************************************************************** 03080020
*                                                                       03100020
* MASKS FOR STATUS BITS TO BE TESTED                                    03120020
*                                                                       03140020
FIRSTIOB   EQU   X'01'                                                  03160020
READONLY EQU   X'20'                    IOB READ ONLY INDICATOR         03180020
UNRELFLG EQU   X'02'                   IOB UNRELATED FLAG        A37507 03190021
SEEKCYHD EQU   X'18'                    IF BOTH ON IN FILE MASK, YM5362 03192002
*                                         INHIBIT ALL SEEKS      YM5362 03194002
*                                                                       03200020
*********************************************************************** 03220020
*                                                                       03240020
ZERO     EQU   0                        CONSTANT OF 0                   03240620
FOUR     EQU   4                        CONSTANT OF 4                   03241220
* MASKS USED TO LOAD IGG01915 IN SUPPORT OF QSAM LOCATE MODE OF         03242020
* OPERATION WITH LOGICAL RECORD INTERFACE FOR VARIABLE LENGTH           03244020
* SPANNED RECORD                                                        03246020
*                                                                       03248020
FLGOFFST EQU   4                        OFFSET TO FLAG IN BCB    S19015 03250020
RAFLAG   EQU   X'80'                    RECORD AREA PRESENT      S19015 03252020
NULL     EQU   0                        ZERO DISPLACEMENT        S19015 03254020
IDLEN    EQU   5                        LENGTH OF IDTTR          S19015 03256020
*                                                                       03260020
*                                                                       03282020
*                                                                       03284020
*                                                                       03286020
*                                                                       03288020
*                                                                       03290020
*                                                                       03292020
*                                                                       03294020
*                                                                       03296020
*                                                                       03298020
*                                                                       03300020
*                                                                       03320020
         BALR  RBASE,0                  REG 3 IS BASE                   03340020
         USING SOPB,RBASE                                               03360020
         USING IHADCB,RDCB              REG 2 IS DCB                    03380020
         USING FORCORE,RCORE            REG 4 IS WORK AREA ADDRESS      03420020
         USING DEBBASIC,RDEB                                     YM5362 03430002
*                                                                       03460020
SOPB     EQU   *                                                        03480020
         B     BEGIN                    BRANCH AROUND MODULE ID  YM4640 03485002
         DC    C'IGG0196P'              MODULE NAME              YM4640 03486002
         DC    C'@Z30TSCF'              LAST SHIP CODE         @Z30TSCF 03487003
         DC    C'10/22/74'              LAST SHIP DATE         @Z30TSCF 03488003
BEGIN    DS    0H                       END OF MODULE ID         YM4640 03489002
         MODESET  KEYADDR=DXUKEY,WORKREG=9 GET INTO USER KEY     Y02072 03490002
         L     RDCB,0(RPARC)            GET DCB ADDRESS                 03500020
         LA    RDCB,0(RDCB)             CLEAR HI BYTE                   03520020
         L     RDEB,DCBDEBAD            GET DEB ADDRESS          YM5362 03530002
         L     RCORE,4(RWTGC)           GET WORK AREA ADDRESS           03560020
*                                                                       03580020
         L     RB,DCBIOBA               GET ADDR OF GETMAIN             03780020
         LR    RD,RB                    GET ADDR OF GETMAIN AREA        03980020
         L     RUCB,ZERO(RB)            GET THE IOB COUNT               04180020
         XC    ZERO(FOUR,RB),ZERO(RB)    ZERO OUT FIRST 4 BYTES OF      04380020
*                                       GETMAIN AREA (USED TO           04580020
*                                       PASS INFO FROM IGG0191P)        04780020
         CH    RUCB,ONEIOB             ONE IOB?                  A37507 05302021
         BNE   NTONEIOB                NO - BRANCH               A37507 05304021
         USING IOBQSAMN,RB             ADDRESSABILITY FOR DSECT  Y02072 05306002
         OI    IOBFLAG1,IOBUNREL       YES - SET UNRELATED FLAG  Y02072 05308002
         DROP  RB                                                Y02072 05310002
NTONEIOB EQU   *                                                 A37507 05312021
SOPB30   EQU   *                                                        05320020
         LTR   RUCB,RUCB                HAS IOB COUNT BEEN EXHAUSTED    05340020
         BC    7,SOPB31                 NO, BRANCH                      05360020
*                                                                       05380020
         L     RB,DCBIOBA               GET FIRST IOB GENERATED         05400020
         ST    RB,0(RD)                 LINK FIRST IOB TO LAST          05420020
         OI    0(RD),READONLY           IOB FOR READ ONLY         22484 05430020
         B     SOPBEND                                                  05440020
*                                                                       05460020
*********************************************************************** 05480020
*                                                                       05500020
*    REGISTER USEAGE FOR CHANNEL PROGRAM CONSTRUCTION                   05520020
*       RB - RD/WRT SEQUENCE POINTER                                    05540020
*       RC - FDA POINTER                                                05560020
*       RD - CURRENT IOB POINTER                                        05580020
*       RJ - LINK REG TO INTERNAL SUBROUTINE                            05600020
*       RF - PARAREG FOR INTERNAL SUBROUTINE                            05620020
*       RE - INTERNAL POINTER IN READ SEQUENCE                          05640020
*                                                                       05660020
*********************************************************************** 05680020
*                                                                       05700020
SOPB31   EQU   *                                                        05720020
         ST    RB,0(RD)                 LINK NEW IOB TO LAST ONE BUILT  05740020
         OI    0(RD),READONLY           IOB FOR READ ONLY         22484 05750020
         LR    RD,RB                    UPDATE CURRENT IOB POINTER      05760020
         OI    8(RD),CC                 INDICATE COMMAND CHAINING 21282 05790020
         LA    RB,4(RB)                 POINT TO ECB SLOT               05800020
         OI    0(RB),X'7F'              SET ECB COMPLETE WITHOUT ERROR  05820020
         ST    RB,12(RD)                STORE ECB ADDR IN IOB           05840020
         L     RWK3,DXUDCBAD            GET USERS DCB ADDR       Y02072 05850002
         USING IOBQSAMN,RD                                       Y02072 05860002
         ST    RWK3,IOBDCBPT            DCB ADDR TO IOB          Y02072 05870002
         DROP  RD                                                Y02072 05872002
*                                                                       05880020
*********************************************************************** 05900020
*                                                                       05920020
*     CONSTRUCTION OF CHANNEL PROGRAM FOLLOWS                           05940020
*                                                                       05960020
*********************************************************************** 05980020
*                                                                       06000020
SOPB40   EQU   *                                                        06020020
         LA    RB,48(RD)                UPDATE TO WRITE SEQUENCE        06040020
         LA    RC,43(RD)                POINT TO CCHHR FIELD IN IOB     06060020
         ST    RC,0(RB)                 STORE ADDR IN SRCH CCW          06080020
         MVI   0(RB),SRCHE              STORE CMD BYTE                  06100020
         MVI   7(RB),X'05'              STORE COUNT OF 5 IN CCW         06120020
         OI    4(RB),CC                 SET CMD CHAIN FLAG ON           06140020
         ST    RB,8(RB)                 STORE IN TIC CCW                06160020
         MVI   8(RB),TIC                STORE TIC CMD BYTE              06180020
*                                                                       06200020
*********************************************************************** 06220020
*                                                                       06240020
*     SRCH AND TIC CCWS HAVE BEEN GENERATED AT THIS POINT               06260020
*                                                                       06280020
*********************************************************************** 06300020
*                                                                       06320020
*     CONSTRUCTION OF WRITE CHANNEL PROGRAMS FOLLOW                     06340020
*                                                                       06360020
*********************************************************************** 06380020
*                                                                       06400020
*                                                                       06420020
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 06430002
         MVI   DCBWCPO,WCPO             WRITE CHANNEL PROGRAM OFFSET    06440020
         MVI   DCBWCPL,WCPL             STORE NORMAL WRT CP LEN.        06460020
         MVI   DCBOFFSW,OFFSW           WRITE CCW OFFSET                06480020
         MODESET  KEYADDR=DXUKEY,WORKREG=1 GET INTO USER KEY     Y02072 06482002
*                                                                       06500020
         TM    DCBRECFM,FORMATU         U RECORDS USED                  06520020
         BM    SOPB50                   NO, BRANCH                      06540020
         OI    20(RB),SLI               SET SILI FLAG ON                06560020
*                                                                       06580020
SOPB50   EQU   *                                                        06600020
         OI    20(RB),CC                SET COMMAND CHAIN FLAG ON       06620020
*                                                                       06640020
         MVI   16(RB),WRTD              STORE WRITE DATA CMD OP         06660020
*                                                                       06680020
         TM    DCBCIND2,QSAMB           IS QSAM USED                    06700020
         BO    SOPB51                   YES, BRANCH                     06720020
*                                                                       06740020
         CLI   DCBKEYLE,ONE             IS KEY LENGTH SPECIFIED         06760020
         BC    4,SOPB52                 NO, BRANCH                      06780020
*                                                                       06800020
         MVI   16(RB),WRTKD             STORE WRT KEY & DATA CMD BYTE   06820020
         B     SOPB52                                                   06840020
*                                                                       06860020
SOPB51   EQU   *                                                        06880020
         LA    RF,16(RB)                POINT TO ACTUAL WRT CCW         06900020
         BAL   RBRNCH,SOPB70            GO FILL IN CCW ATTRIBUTES       06920002
*                                                                       06940020
SOPB52   EQU   *                                                        06960020
         TM    DCBOPTCD,WRTCK           IS WRITE VALIDITY CHECK SPEC    06980020
         BC    14,SOPB53               NO. BRANCH                       07000020
         LA    RB,THREECCW(RB)          POSITION AT WRT CHK CP   A31983 07050021
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 07050402
         MVI   DCBWCPL,WCWCPL           CHAN PGM LEN, WRT CHK    A31983 07060021
         TM    DCBRECFM,TRKOVFLB        TRK OVFLOW SPECIFIED?    A31983 07070021
         BNO   NOTRKOV1                 NO, DON'T UPDATE WRT     A31983 07080021
*                                          CHAN PGM LEN          A31983 07080421
         MVI   DCBWCPL,WCTOWCPL         CHAN PGM LEN, WRT CHK    A31983 07080821
*                                          WITH TRK OVFLOW       A31983 07081221
         MODESET  KEYADDR=DXUKEY,WORKREG=1 GET INTO USER KEY     Y02072 07081302
         LA    RF,41(RD)                POINT TO BBCCHHR IN       18445 07082020
*                                       IOBSEEK FIELD             18445 07084020
         ST    RF,0(RB)                 STORE SEEK ADDRESS        18445 07086020
         BAL   RBRNCH,SOPB80            GO GET PROPER OP CODE    YM5362 07088002
         MVI   4(RB),CC                 SET COMMAND CHAIN FLAG ON 18445 07090020
         MVI   7(RB),X'06'              STORE COUNT OF 6 IN CCW   18445 07092020
         LA    RB,8(RB)                 UPDATE RB TO NEXT CCW     18445 07094020
         B     SOPB520                  BR AROUND MODESET        Y02072 07094402
NOTRKOV1 EQU   *                                                 A31983 07096021
         MODESET  KEYADDR=DXUKEY,WORKREG=1 GET INTO USER KEY     Y02072 07096402
SOPB520  TM    DCBRECFM,FORMATU         U RECORDS USED           Y02072 07100002
         BC    14,SOPB52A               NO, BRANCH                      07120020
         OI    20(RB),SLICCSK           SET SILI AND CC FLAGS ON        07140020
         B     SOPB52B                                                  07160020
*                                                                       07180020
SOPB52A  EQU   *                                                        07200020
         OI    20(RB),CCSK              SET CC FLG ON IN READ AND WRT   07220020
SOPB52B  EQU   *                                                        07240020
         ST    RC,0(RB)                 SAVE ADDRESS IN SRCH CCW        07260020
         MVI   0(RB),SRCHE              STORE SRCHE CMD BYTE            07280020
         OI    4(RB),CC                 SET CMD CHAIN FLAG ON           07300020
         MVI   7(RB),X'05'              STORE COUNT OF 5 IN CCW         07320020
         ST    RB,8(RB)                 SRCH ADDR IN TIC CCW            07340020
         MVI   8(RB),TIC                STORE TIC CMD BYTE              07360020
         MVI   16(RB),RDD               STORE READ DATA CMD OP          07380020
         TM    DCBCIND2,QSAMB           QSAM SPECIFIED                  07400020
         BO    SOPB55                   YES, BRANCH                     07420020
*                                                                       07440020
         CLI   DCBKEYLE,ONE             IS KEY LENGTH SPECIFIED         07460020
         BC    4,SOPB53                 NO, BRANCH                      07480020
*                                                                       07500020
         MVI   16(RB),RDKD              STORE RD KEY & DATA CMD BYTE    07520020
*                                                                       07540020
SOPB53   EQU   *                                                        07560020
         TM    DCBCIND2,QSAMB           QSAM USED                       07580020
         BC    1,SOPB55                 YES, BRANCH                     07600020
         NI    20(RB),NOT-CC            CLEAR COMMAND CHAIN FOR BSAM    07620020
*                                                                       07640020
         LA    RB,16(RB)                POINT TO BSAM OFFSET            07660020
         B     SOPB56                                                   07680020
*                                                                       07700020
SOPB55   EQU   *                                                        07720020
         LA    RB,24(RB)                POINT TO READ SEQ.              07740020
*                                                                       07760020
*********************************************************************** 07780020
*                                                                       07800020
*    THIS SECTION GENERATES READ CHANNEL PROGRAMS                       07820020
*                                                                       07840020
*********************************************************************** 07860020
*                                                                       07880020
SOPB56   EQU   *                                                        07900020
*                                                                       07920020
         LA    RC,8(RB)                 POINT TO SRCH CCW OF RD SEQ     07940020
         ST    RC,24(RD)                STORE CP STARTAD IN IOB         07960020
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 07962002
         MVI   DCBOFFSR,OFFSR           STORE NORMAL RD CCW OFFSET      07980020
         TM    DCBOPTCD,WRTCK           IS WRITE VALIDITY CHECK SPEC    08000020
         BC    14,SOPB60                NO, BRANCH                      08020020
         MVI   DCBOFFSR,WCOSRQ          QSAM READ CCW OFFSET     A31983 08070021
*                                          WITH WRT CHK          A31983 08074021
         TM    DCBRECFM,TRKOVFLB        TRK OVFLOW SPECIFIED?    A31983 08076021
         BNO   SOPB60                   NO, DON'T UPDATE READ    A31983 08078021
*                                          OFFSET                A31983 08078421
         MVI   DCBOFFSR,TOWCOSRQ        QSAM READ CCW OFFSET     A31983 08078821
*                                          WITH WRT CK + TRK OV  A31983 08079221
SOPB60   EQU   *                                                        08080020
         MODESET  KEYADDR=DXUKEY,WORKREG=1 GET INTO USER KEY     Y02072 08082002
         LA    RC,49(RB)                POINT TO BBCCHH FIELD           08100020
         TM    DCBCIND2,QSAMB           QSAM SPECIFIED                  08120020
         BZ    SOPB601                  NO. BRANCH                      08140020
         ST    RC,0(RB)                 STORE ADDR IN SEEK CCW          08160020
         BAL   RBRNCH,SOPB80            GO GET PROPER OP CODE    YM5362 08180002
         MVI   7(RB),X'06'              STORE COUNT OF 6 IN CCW         08200020
         OI    4(RB),CC                 SET COMMAND CHAIN FLAG ON       08220020
SOPB601  EQU   *                                                        08240020
         LA    RC,2(RC)                 POINT TO CCHH FIELD             08260020
         ST    RC,8(RB)                 STORE ADDR IN SRCH CCW          08280020
         MVI   8(RB),SRCHE              STORE SEARCH COMMAND BYTE       08300020
         MVI   15(RB),X'05'             STORE COUNT OF 5 IN CCW         08320020
         OI    12(RB),CC                SET COMMAND CHAIN FLAG ON       08340020
         LA    RE,8(RB)                 GET ADDRESS OF SEARCH CCW       08360020
         ST    RE,16(RB)                STORE IN TIC CCW                08380020
         MVI   16(RB),TIC               STORE TIC COMMAND BYTE          08400020
         LA    RE,32(RB)                GET ADDR OF RD COUNT CCW        08420020
         ST    RE,24(RB)                STORE IN TIC CCW                08440020
         MVI   24(RB),TIC               STORE TIC COMMAND BYTE          08460020
         TM    DCBRECFM,TRKOVFLB        TRACK OVERFLOW SPECIFIED        08480020
         BZ    SOPB605                  NO, BRANCH                      08500020
*                                       YES, CHANGE TIC CCW TO RD DATA  08520020
         MVI   24(RB),RDDX              READ DATA CMD OP FOR T/O        08540020
         MVI   28(RB),SLICCSK           SKIP, SILI, CC FLAGS            08560020
         MVI   31(RB),50                NON-ZERO LENGTH                 08580020
*                                                                       08600020
SOPB605  EQU   *                                                        08620020
*                                                                       08640020
         TM    DCBCIND2,QSAMB           QSAM USED                       08660020
         BC    1,SOPB61                 YES, BRANCH                     08680020
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 08682002
         MVI   DCBOFFSR,OFFSRB          STORE BSAM RD CCW OFFSET        08700020
         TM    DCBOPTCD,WRTCK           IS WRITE VALIDITY CHECK SPEC    08720020
         BC    14,SOPB607               NO, BRANCH                      08740020
         MVI   DCBOFFSR,WCOSRB          BSAM READ CCW OFFSET     A31983 08790021
*                                          WITH WRT CHK          A31983 08792021
         TM    DCBRECFM,TRKOVFLB        TRK OVFLOW SPECIFIED     A31983 08794021
         BNO   SOPB607                  NO, DON'T UPDATE READ    A31983 08796021
*                                          CCW OFFSET            A31983 08798021
         MVI   DCBOFFSR,TOWCOSRB        BSAM READ CCW OFFSET     A31983 08798421
*                                          WITH WRT CHK + TRK OV A31983 08798821
SOPB607  EQU   *                                                        08800020
         MODESET  KEYADDR=DXUKEY,WORKREG=1                       Y02072 08810002
         CLI   DCBNCP,ONE               MORE THAN 1 IOB USED            08820020
         B     SOPB62                   BRANCH TO TEST                  08840020
*                                                                       08860020
SOPB61   EQU   *                                                        08880020
         CLI   DCBBUFNO,ONE             MORE THAN 1 IOB USED            08900020
*                                                                       08920020
SOPB62   EQU   *                                                        08940020
         BNH   SOPB64                   NO, BRANCH                      08960020
*                                                                       08980020
*    RC POINTS TO CCHHR OF THIS IOB                                     09000020
*                                                                       09020020
         SR    RF,RF                    CLEAR REG                       09040020
         IC    RF,DCBIOBL               GET IOB LENGTH                  09060020
         SLL   RF,3                     CHANGE TO BYTES                 09080020
         LA    RC,0(RF,RC)              POINT TO NEXT DA ADDR FIELD     09100020
SOPB63   EQU   *                                                        09120020
         ST    RC,32(RB)                STORE IN RD COUNT CCW           09140020
         MVI   32(RB),RDC               STORE RD CNT CMD BYTE           09160020
         OI    36(RB),SLICC             SET SILI AND CC FLAGS ON        09180020
         MVI   39(RB),X'05'             STORE COUNT OF 5 IN CCW         09200020
         MVI   40(RB),RDD               STORE READ DATA CMD BYTE        09220020
         TM    DCBCIND2,QSAMB           QSAM SPECIFIED                  09240020
         BO    SOPB65                   YES, BRANCH                     09260020
*                                                                       09280020
         CLI   DCBKEYLE,ONE             IS KEY LENGTH SPECIFIED         09300020
         BC    4,SOPB65A                NO, BRANCH                      09320020
         MVI   40(RB),RDKD              STORE RD DATA & KEY IN CMD BYTE 09340020
         B     SOPB65A                                                  09360020
*                                                                       09380020
SOPB64   EQU   *                                                        09400020
         L     RDCB,DXUDCBAD            GET USERS DCB ADDR       Y02072 09410002
         LA    RC,DCBFDAD+3             POINT TO CCHHR IN DCB           09420020
         L     RDCB,0(RPARC)            GET PROTECTED COPY BACK  Y02072 09430002
         B     SOPB63                                                   09440020
*                                                                       09460020
SOPB65   EQU   *                                                        09480020
         LA    RF,40(RB)                POINT TO ACTUAL RD DATA CCW     09500020
         BAL   RWK1,SOPB72              GO FILL IN QSAM ATTR     YM7595 09520002
SOPB65A  EQU   *                                                        09600020
         BCTR  RUCB,0                   DECREMENT COUNTER               09620020
         MVC   48(8,RB),DCBFDAD         MOVE FDAD TO SPECIAL FDA        09640020
         MVC   40(8,RD),DCBFDAD         MOVE FDAD TO IOS'S FDA          09660020
*                                                                       09680020
         TM    DCBRECFM,FORMATU         U RECORDS USED                  09700020
         BM    SOPB66                   NO, BRANCH                      09720020
*                                                                       09740020
         OI    44(RB),SLI               SET SLI FLAG IN CCW             09760020
*                                                                       09780020
SOPB66   EQU   *                                                        09800020
         TM    DCBCIND2,QSAMB           QSAM USED                       09820020
         BC    1,SOPB67                 YES BRANCH                      09840020
*                                                                       09860020
         CLI   DCBNCP,ONE               MORE THAN 1 IOB USED            09880020
         B     SOPB68                   BRANCH TO TEST                  09900020
*                                                                       09920020
SOPB67   EQU   *                                                        09940020
         CLI   DCBBUFNO,ONE             MORE THAN 1 IOB USED            09960020
*                                                                       09980020
SOPB68   EQU   *                                                        10000020
         BNH   SOPB69                   NO, BRANCH                      10020020
*                                                                       10040020
         LTR   RUCB,RUCB                HAVE ALL IOBS BEEN GENERATED    10060020
         BC    7,SOPB69                 NO, BRANCH                      10080020
*                                                                       10100020
         L     RC,DCBIOBA               GET FIRST IOB GENERATED         10120020
         SR    RF,RF                    CLEAR REG                       10140020
         IC    RF,DCBOFFSR              OBTAIN READ CCW OFFSET          10160020
         LA    RC,11(RF,RC)             POINT TO NEXT DA ADDR FIELD     10180020
         ST    RC,32(RB)                STORE IN LAST IOBS RD CNT CCW   10200020
         MVI   32(RB),RDC               STORE CMD BYTE                  10220020
*                                                                       10240020
SOPB69   EQU   *                                                        10260020
         LA    RB,56(RB)                POINT TO NEXT POSSIBLE IOB LOC. 10280020
         B     SOPB30                   RETURN FOR NEXT IOB             10300020
*                                                                       10320020
*********************************************************************** 10340020
*                                                                       10360020
*  THE FOLLOWING CODE SETS UP THE CCW WITH LENGTH AND BUF ADDR.         10380020
*                                                                       10400020
*********************************************************************** 10420020
*                                                                       10440020
*                                                                       10460020
SOPB70   EQU   *                                                        10480020
         TM    DCBOPTCD,WRTCK           WRITE CHECK USED                10500020
         BC    14,SOPB71                NO, BRANCH                      10520020
         MVC   WRTCKCCW(TWO,RF),DCBBLKSI                         M0950  10540021
*                                                                       10560020
SOPB71   EQU   *                                                        10580020
         LR    RWK1,RBRNCH              SAVE RETURN ADDR         YM7595 10582002
         L     RWK3,DCBBUFCB            BUFCB ADDR               YM7595 10590002
         USING BCBLK,RWK3                                               10592002
         L     RBUFADR,BCBBUFPT         ADDR NEXT AVAIL BUFFER   YM7595 10594002
         USING BUFFER,RBUFADR                                           10598402
         MVC   BCBBUFAD,BUFNXPTB        UPDATE TO NEXT AVAIL BUF YM7595 10598802
SOPB72   EQU   *                                                 YM1393 10600002
         USING CCW,RF                                            Y02072 10630002
         STCM  RBUFADR,B'0111',CCWADDRB  ADDR OF BUFFER TO CCW   Y02072 10680002
         MVC   CCWBYTE,DCBBLKSI         BYTE COUNT TO CCW        YM1393 10690002
         DROP  RF,RWK3,RBUFADR                                   Y02072 10730002
         LR    RBRNCH,RWK1              RESTORE RETURN ADDR      YM7595 10732002
         BR    RBRNCH                   RETURN                          10740002
         SPACE 3                                                        10750002
*                                                                       10760020
* THE FOLLOWING WILL SET UP THE NEXT CCW AS A SEEK HEAD OR A NOP YM5362 10770002
* DEPENDING ON THE DEB FILE MASK FOR PERFORMANCE REASONS. IF THE YM5362 10780002
* FILE MASK INDICATES ALLOCATION IN CYLINDERS, SET CCW OP CODE   YM5362 10790002
* TO A SEEK HEAD. IF ALLOCATION IS BY TRACKS, SET AS A NOP. THIS YM5362 10792002
* WILL PREVENT FILE MASK VIOLATIONS DURING I/O OPERATIONS AND    YM5362 10794002
* THUS LESS ERROR PROCESSING BY APPENDAGES, EXCP, AND THE ERP.   YM5362 10796002
*                                                                       10800020
SOPB80   EQU   *                                                 YM5362 10810002
         USING DEBDASD,RWK2                                      YM5362 10812002
         LA    RWK2,DEBBASND            ADDR OF DA SECT OF DEB   YM5362 10814002
         USING CCW,RB                                            YM5362 10814402
         MVI   CCWCOMCD,SEEK            ASUME CYL BOUNDRY        YM5462 10814802
         TM    DEBDVMOD,SEEKCYHD        ALLOC IN CYLINDERS       YM5362 10816002
         BNOR  RBRNCH                   YES, OP CODE OK          YM5362 10818002
         MVI   CCWCOMCD,NOP             NO, CHANGE OP CD TO NOP  YM5362 10818402
         BR    RBRNCH                   RETURN MAINLINE          YM5362 10818802
         DROP  RWK2,RB                                           YM5362 10818902
         SPACE 3                                                        10819202
SOPBEND  EQU   *                                                        10820020
         L     RB,DCBIOBA               GET FIRST IOB                   11060020
         OI    0(RB),FIRSTIOB           SET INDICATOR ON FOR CLOSE      11080020
*                                                                       11201020
* PRESENCE OF RECORD AREA TEST TO DETERMINE NEXT LOAD EXECUTOR. IF      11202020
* YES, GET LOAD EXECUTOR IGG01915.                                      11203020
*                                                                       11204020
         TM    DCBBUFCB+3,X'01'         HAVE BUFFERS BEEN        A40538 11204221
*                                       SUPPLIED                 A40538 11204421
         BO    SOPBENDB                 BRANCH IF NO BUFFERS TO  A40538 11204621
*                                       LOAD IGG01912                   11204821
         L     RB,DCBBUFCB              GET BUFCB ADDR           S19015 11205020
         LA    RB,NULL(RB)              CLEAR HIGH ORDER BYTE    S19015 11206020
         TM    FLGOFFST(RB),RAFLAG      RECORD AREA INDICATOR ON S19015 11207020
         BZ    SOPBENDB                 BRANCH IF NOT TO LOAD    S19015 11208020
*                                            IGG01912                   11209020
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 11209102
         USING WTGENTRY,RWTGC                                    Y02072 11209502
         MVC   WTGIDTTR,IGG01915        NEXT MOD               @Z30TSCF 11209903
         B     SOPBENDC                 BRANCH TO PROCESS NEXT   Y02072 11211002
*                                            ENTRY                      11212020
SOPBENDB EQU   *                                                 S19015 11213020
*                                                                       11214020
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 11214402
         MVC   WTGIDTTR,IGG01912        NEXT MOD               @Z30TSCF 11216403
SOPBENDC EQU   *                                                        11228402
         OI    FCAOPEN2,FCAOIOBC        IOBS COMPLETED           YM7595 11238402
         OI    DCBCIND2,UPDATEB         FLAG DCB AS UPDATE       Y02072 11242002
         TM    DCBDSORG,DCBDSGPO       DCB FOR PO                Y02072 11250002
         BZ    RELOOP                  NO, BRANCH                Y02072 11252002
*                                                                Y02072 11254002
         MVI   NTPTINDX+1,5            PROVIDE N/P FOT PO        Y02072 11256002
RELOOP   EQU   *                                                        11260020
         LA    RWTGC,WGOFF(0,RWTGC)     INCREMENT CURR WTG ENTRY        11280020
         LA    RPARC,PLOFF(0,RPARC)     INCR CURRENT DCB ENTRY PRTR     11300020
         CLC   0(2,RWTGC),AMIDCNST      THIS RT NEEDED AGAIN            11320020
         BCR   8,RBASE                                                  11340020
*                                                                       11360020
         CLC   0(2,RWTGC),OPIDCNST      END OF TABLE                    11380020
         BC    7,RELOOP                 NO,CHECK NEXT ENTRY             11400020
*                                                                       11420020
         LR    RPARC,RPAR                                               11440020
         LA    RWTGC,WAOFF(0,RWTG)      REINITIALIZE WTG LIST PTR       11460020
*                                                                       11480020
ZCHEK    EQU   *                                                        11500020
         CLI   0(RWTGC),X'00'          IS THIS ENTRY COMPLETE           11520020
         BC    7,TCTLRTN                IF NOT TRANSFER CONTROL         11540020
         LA    RWTGC,WGOFF(0,RWTGC)     GET NEXT ENTRY                  11560020
         LA    RPARC,PLOFF(0,RPARC)                                     11580020
         BC    15,ZCHEK                                                 11600020
*                                                                       11620020
TCTLRTN  EQU   *                                                        11640020
         USING WTG,RWTG                                                 11690003
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSCF*11740003
               MODID=WTGENTRY                                  @Z30TSCF 11790003
         DROP  RWTGC,RWTG                                      @Z30TSCF 11800003
**                                                                      11820020
WAOFF    EQU   32                                                       11920020
PLOFF    EQU   4                        OFFSET OF DCB ENTRIES           11940020
WGOFF    EQU   8                        OFFSET OF WTG ENTRIES           11960020
*                                                                       11970002
*  MODULE ID'S                                                          11972002
*                                                                       11974002
OPIDCNST DC    C'0S'                                                    11980020
AMIDCNST DC    C'6P'                    ID OF THIS MODULE               12000020
IGG01912 DC    C'12',VL3(IGG01912)      NOT REC AREA           @Z30TSCF 12002003
IGG01915 DC    C'15',VL3(IGG01915)      YES, REC AREA INDIC    @Z30TSCF 12004003
*                                                                       12004402
*  OTHER CONSTANTS                                                      12004802
*                                                                       12005202
ONEIOB   DC    H'1'                    FOR IOB UNRELATED TEST    A37507 12010021
PATCH    DC    25H'0'                   PATCH AREA               YM4640 12122002
END      EQU   *                        END OF MODULE            Y02072 12130002
         EJECT                                                          12140002
         IGGBCB  TYPE=SAM                                               12150002
         EJECT                                                          12160002
           DCBD  DSORG=PS                                               12180020
NTPTINDX EQU   DCBCNTRL                 NOTE/POINT INDEX         Y02072 12190002
         EJECT                                                          12260002
         IEZDEB                                                         12460002
         TITLE 'IGG0196P - FORMAT OF GOTTEN CORE'                       12820002
*                                                                       12840020
*                                                                       12860020
         IECDSECS  (MAIN,(IOB,NO)),IOB,WTG,PREFX,EXPAND=YES    @Z30TSCF 12910003
         ORG   WTGIDTTR                                          Y02072 12912002
WTGID    DS    CL2                      NEXT MODS ID             Y02072 12914002
         EJECT                                                          12914403
CVT      DSECT                                                 @Z30TSCF 12914803
         CVT                                                   @Z30TSCF 12915203
         EJECT                                                          12916002
FORCORE  DSECT                                                          12916402
         IHAFCAUD ORG=YES                                               12918002
         EJECT                                                          12918402
         IHACCW  DSECT=YES                                              12918802
           END                                                          12920020
