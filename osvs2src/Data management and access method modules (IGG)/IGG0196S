         TITLE 'IGG0196S - TS OPEN EXECUTOR'                            00100020
*                                                                       00200020
IGG0196S CSECT                                                          00300020
*                                                                       00400020
* VS/2-3 SERVICE UPDATE                                                 00410003
*  C 129400                                                     ZA16624 00415003
*0000107700,241100-244000                                      @ZA08323 00420003
*  D 422000,422500                                              ZA09612 00425003
*0000107700,129400,129600                                      @OZ09612 00430003
* VS/2-2 DELETIONS/CHANGES                                      YS02019 00450002
*                                       7/23/1973               YM01426 00452002
*                                       8/20/1973               YM03016 00454002
*                                       9/18/1973               YM03842 00456002
*                                      10/01/1973               YM03948 00458002
*                                                                     * 00460002
* RELEASE 21 DELETIONS/CHANGES                                        * 00490020
*                                                                     * 00520020
*0000215016,215044                                               TS2495 00530020
*                                                                M3415  00540020
*                                                                M3504  00545020
*                                                                M4324  00547020
*                                                                M1565  00547520
*                                                                M2307  00548020
*                                                                 M5005 00549020
*                                                                M5457  00549520
*STATUS CHANGE LEVEL 001                                                00550020
*                                                                     * 00580020
* NAME - IGG0196S, TS OPEN EXECUTOR                                   * 00610020
*                                                                     * 00640020
* FUNCTION - THIS ROUTINE OBTAINS CONTROL WHEN THE DCB BEING OPENED   * 00670020
*            IS A TERMINAL DEVICE AND THE TASK IS UNDER TIME SHARING. * 00700020
*            THE EXECUTOR PERFORMS THE FOLLOWING FUNCTIONS.           * 00730020
*                                                                     * 00760020
*          * DEFAULT DCBBLKSI, DCBLRECL, AND DCBRECFM FOR OUTPUT      * 00770002
*            DATA SET                                                 * 00780002
*                                                                     * 00782002
*          * FOR PUT LOCATE MODE, IT SET ON BIT 0 IN BYTE 0 IN BUFFER * 00790020
*            POOL CONTROL BLOCK TO SIGNAL IGG019T4 (TS PUT ROUTINE)   * 00820020
*            THAT THIS IS THE FIRST PUT                               * 00850020
*                                                                     * 00880020
*          * IT LOADS PROPER INTERFACE ROUTINE(S) FOR SAM AND TERMINAL* 00910020
*            I/O SVC                                                  * 00940020
*                                                                     * 00970020
* ENTRY POINTS - IGG0196S, BEGINNG OF ROUTINE. CONTROL IS RECEIVED    * 01000020
*                FROM IGG0196B OR IGG0193I VIA XCTL             YS02019 01030002
*                                                                     * 01060020
* INPUT - SEE DESCRIPTION OF REGISTERS                                * 01090020
*                                                                     * 01120020
* OUTPUT - PROPER INTERFACE ROUTINES LOADED                           * 01150020
*                                                                     * 01180020
* EXTERNAL REFERENCE - NONE                                           * 01210020
*                                                                     * 01240020
* EXIT, NORMAL - TO OPEN MODULE, IGG0190S VIA XCTL                    * 01270020
*                                                                     * 01300020
* EXIT, ERROR - NONE                                                  * 01330020
*                                                                     * 01360020
* TABLE/WORK AREAS - WHERE-TO-GO TABLE (WTG)                          * 01390020
*                                                                     * 01420020
*      BYTE  0-7  NAME                                                * 01450020
*      BYTE  8-10 RELATIVE DISK ADDRESS(TTR) OF FIRST RECORD          * 01480020
*      BYTE 11    CONCATENATION NUMBER                                * 01510020
*      BYTE 12    ZERO                                                * 01540020
*      BYTE 13    ALIAS INDICATOR AND USER DATA FIELD DESCRIPTOR      * 01570020
*                        ALIAS 1 BIT                                  * 01600020
*                        NUMBER OF TTRS IN USERS DATA FIELD 2 BITS    * 01630020
*      BYTE 14-16 TTR OF FIRST TEXT RECORD                            * 01660020
*      BYTE 17    ZERO                                                * 01690020
*      BYTE 18-19 TTR OF NOTE LIST OR SCATTER LIST                    * 01720020
*      BYTE 20    TRANSLATION TABLE                                   * 01750020
*      BYTE 21    ZERO NUMBER OF ENTRIES IN THE NOTE LIST             * 01780020
*      BYTE 22-23 ATTRIBUTES                                          * 01810020
*      BYTE 24-26 TOTAL CONTIGIOUS MAIN STORAGE REQUIRED FOR MODULE   * 01840020
*      BYTE 27-28 LENGTH OF FIRST TEXT RECORD                         * 01870020
*      BYTE 29    LENGTH OF WHERE-TO-GO TABLE (IN DOUBLE WORDS)       * 01900020
*      BYTE 30-31 PATH THROUGH LOADS OF ROUTINES                      * 01930020
*      BYTE 32-34 IDTTR OF EXECUTOR FOR FIRST DCB                     * 01960020
*      BYTE 35    ADDRESS OF STORAGE FOR DCB                          * 01990020
*      BYTE 36-39 TABLE OF IDTTR'S                                    * 02020020
*      BYTE 32+N(8) IDTTR OF EXECUTOR FOR NEXT DCB (3 BYTES)          * 02050020
*                   ADDRESS OF STORAGE FOR DCB     (1 BYTE)           * 02080020
*                   IDTTR OF LAST ROUTINE LOADED   (3 BYTES)          * 02110020
*                   NOT USED                       (1 BYTE)           * 02140020
*                                                                     * 02170020
*      OPEN WORK AREA - SEE IECDSECT IN THIS LISTING                  * 02200020
*                                                                     * 02230020
* ATTRIBUTES - REENTRANT, REUSABLE, SUPERVISOR MODE                   * 02260020
*                                                                     * 02290020
* CHARACTER CODE DEPENDENCY -                                         * 02320020
*                                                                     * 02350020
* NOTES -                                                             * 02380020
*                                                                     * 02410020
*********************************************************************** 03200020
*                                                                       03300020
*                                                                       03400020
*********************************************************************** 03500020
*                                                                       03600020
*   REGISTER CONVENTIONS USED THROUGH OUT OPEN EXECUTORS                03700020
*                                                                       03800020
*********************************************************************** 03900020
*                                                                       04000020
RE       EQU   0                        WORK/PARAMETER REGISTER         04100020
RF       EQU   1                        WORK/PARAMETER REGISTER         04200020
RDCB     EQU   2                        ADDR OF USERS DCB               04300020
RBASE    EQU   3                        BASE REGISTER                   04400020
RCORE    EQU   4                        ADDR OF OPEN WORK AREA          04500020
RPAR     EQU   5                        PARAMTER LIST                   04600020
RWTG     EQU   6                        START OF WTG                    04700020
RPARC    EQU   7                        CURRENT ENTRY IN PARAMETER LIST 04800020
RWTGC    EQU   8                        CURRENT ENTRY IN WTG TABLE      04900020
RTIOT    EQU   9                        TIOT ADDR/WORK REGISTER         05000020
RUCB     EQU   10                       UCB ADDR                        05100020
RDEB     EQU   11                       DEB ADDR                        05200020
RB       EQU   12                       WORK AREA BASE REGISTER         05300020
RC       EQU   13                       WORK REGISTER                   05400020
RD       EQU   14                       WORK/PARAMETER REGISTER         05500020
RJ       EQU   15                       WORK/PARAMETER REGISTER         05600020
*                                                                       05700020
*********************************************************************** 05800020
*                                                                       05900020
*                                                                       06000020
*********************************************************************** 06100020
*                                                                       06200020
*   EQUATES                                                             06300020
*                                                                       06400020
*********************************************************************** 06500020
*                                                                       06600020
NULL     EQU   0                        CONSTANT='0'                    06700020
ONE      EQU   1                        CONSTANT='1'                    06800020
TWO      EQU   2                        CONSTANT='2'                    06900020
THREE    EQU   3                        CONSTANT=3                      07000020
FOUR     EQU   4                        CONSTANT='4'                    07100020
FIVE     EQU   5                        CONSTANT='5'                    07150020
SIX      EQU   6                        CONSTANT=6                      07200020
MSK14    EQU   14                       CONSTANT =14                    07400020
MSK24    EQU   24                       CONSTANT=24                     07500020
MSK25    EQU   25                       CONSTANT=25                     07600020
PARMLNGH EQU   16                       LENGTH OF PARM LIST=16          07700020
MSK48    EQU   X'48'                    MASK FOR V/S RECORD             07800020
QSAMLOCT EQU   X'48'                    MACRF=PL OR GL                  07900020
NOTONES  EQU   14                       'BC 14' FOR TEST UNDER MASK     08000020
BLKSIMRG EQU   X'10'                    BLKSI HAS BEEN MERGED           09110020
LRECLMRG EQU   X'80'                    LRECL HAS BEEN MERGED           09120020
RECFMMRG EQU   X'04'                    RECFM HAS BEEM MERGED           09150020
FIRSTPT  EQU   X'80'                    FIRST PUT IN PUT LOCATE MODE    09200020
MSK7     EQU   7                        CONSTANT = 7                    09300020
MSK22    EQU   22                       CONSTANT = 22                   09400020
WGOFF    EQU   8                        OFFSET TO CURRENT WTG ENTRIES   09500020
PLOFF    EQU   4                        OFFSET TO CURRENT DCB ENTRIES   09600020
WAOFF    EQU   32                       OFFSET TO 1ST ENTRY IN WTG TBL  09700020
DEBPRFX  EQU   16                       SIZE OF DEB PREFIX              09750020
NMXD     EQU   X'09'                    CC NOT MIXED AFTER BRANCH       09800002
MSK0E    EQU   X'0E'                    OPEN FLAG FOR INOUT/OUTIN/UPDAT 10000002
*                                                                       10100020
*********************************************************************** 10200020
*                                                                       10300020
*   REGISTER INITIALIZATION                                             10400020
*                                                                       10500020
*********************************************************************** 10600020
*                                                                       10700020
         LR    RBASE,RJ                 SET UP BASE REGISTER    YM01426 10710002
         USING IGG0196S,RBASE           MODULE ADDRESSABLE      YM01426 10720002
         B     GOGOGOGO                 BRANCH AROUND MODULE ID YM01426 10750002
         DC    C'IGG0196S'              MODULE ID               YM01426 10760002
         DC    X'7109'                  JULIAN DATE - 04/19/77  ZA16624 10770003
         USING IHADCB,RDCB              ESTABLISH DCB REG.              11000020
         USING FORCORE,RCORE            ESTABLISH OPEN WORK AREA        11100020
         USING DEBBASIC,RDEB            ESTABLISH DEB REG.              11200002
         USING CVT,RTIOT                ESTABLISH CVT REG.              11300020
         USING TCB,RD                                                   11350020
*                                                                       11400020
*********************************************************************** 11500020
*                                                                       11600020
*                                                                       11700020
*********************************************************************** 11800020
*                                                                       11900020
GOGOGOGO EQU   *                                                        12000020
*                                                                       12100020
*********************************************************************** 12200020
*                                                                       12300020
         L     RDCB,NULL(RPARC)         GET DCB ADDR                    12400020
         L     RCORE,FOUR(RWTGC)        GET WORK AREA                   12500020
         L     RTIOT,CVTPTR             LOAD CVT ADDR                   12650020
         L     RDEB,DCBDEBAD            GET DEB ADDRESS         YS02019 12651002
*                                                                       12652020
*  CHECK IF DCBBLKSI AND DCBLRECL ARE SPECIFIED. IF BOTH ARE            12654020
*  NOT THERE, DEFAULT WITH TERMINAL LINE SIZE WHEN IT IS SMALLER THAN   12656020
*  BUFFER LENGTH. WHEN DCBBUFL IS SMALLER THAN TERMINAL LINE SIZE,      12658020
*  THE FORMER WILL BE USED AS BLOCK SIZE AND LRECL                      12660020
*                                                                       12662020
         LH    RJ,DCBBLKSI              GET BLOCK SIZE          YS02019 12664002
         LTR   RJ,RJ                    IS IT SPECIFIED         YS02019 12666002
         BNZ   OP6050                   BRANCH IF YES                   12668020
         LH    RJ,DCBLRECL              GET LRECL               YS02019 12670002
         LTR   RJ,RJ                    IS IT SPECIFIED         YS02019 12672002
         BZ    OP6060                   BRANCH IF NO                    12674020
         STH   RJ,DCBBLKSI              USE LRECL AS BLOCK SIZE YS02019 12676002
         OI    JFCBMASK+TWO,BLKSIMRG    INDICATE BLKSI MERGED           12678020
         B     OP5666                   GO TO CHECK RECFM               12680020
         SPACE 1                                                        12680402
OP6050   EQU   *                                                        12682020
         LH    RF,DCBLRECL              GET LRECL                       12684020
         LTR   RF,RF                    IS IT SPECIFIED                 12686020
         BNZ   OP5666                   BRANCH IF YES                   12688020
         STH   RJ,DCBLRECL              USE BLOCK SIZE AS LRECL YS02019 12690002
         OI    JFCBMASK+TWO,LRECLMRG    INDICATE LRECL MERGED           12692020
         B     OP5666                   GO TO CHECK RECFM               12694020
         SPACE 1                                                        12694402
*                                                                       12696020
*  GET TERMINAL LINE SIZE FROM TSB                                      12698020
*                                                                       12700020
OP6060   EQU   *                                                        12702020
         L     RD,DEBTCBAD              GET ADDR OF TCB         YS02019 12704002
         L     RB,PSAAOLD-PSA           GET CURRENT ASCB ADDR   YS02019 12714002
         USING ASCB,RB                  ADDRESSABILITY FOR ASCB YS02019 12728002
         L     RF,ASCBTSB               GET TSB ADDRESS         YS02019 12732002
         USING TSB,RF                                                   12736020
*                                                                       12738002
*  CHANGE TO TCAM'S KEY TO GET TSBLNSZ BECAUSE TSB IS FETCH PROTECTED   12738202
*                                                                       12738402
         MODESET EXTKEY=TCAM            CHANGE TO TCAM'S KEY            12738602
         IC    RJ,TSBLNSZ               GET TERMINAL LINE SIZE  YS02019 12738802
*                                                                       12739002
         MODESET EXTKEY=DATAMGT         CHANGE BACK TO DM'S KEY YS02019 12739202
*                                                                       12739402
         LH    RF,DCBBUFL               GET BUFFER LENGTH               12740020
         LTR   RF,RF                    IS IT SPECIFIED                 12742020
         BZ    OP6070                   BRANCH IF NO                    12744020
         CR    RJ,RF                    IS TERMINAL LINE SIZE   YS02019 12746002
*                                       LARGER THAN BUFFER LENGTH       12748020
*                                                                       12750020
*  IF BUFFER LENGTH IS LARGER THAN TERMINAL LINE SIZE, DEFAULT WITH     12752020
*  THE LATTER, OTHERWISE, DEFAULT WITH THE FORMER.                      12754020
*                                                                       12756020
         BH    OP6080                   BRANCH IF YES                   12758020
         SPACE 1                                                        12758402
OP6070   EQU   *                                                        12760020
         STH   RJ,DCBBLKSI              DEFAULT BLOCK SIZE      YS02019 12762002
         STH   RJ,DCBLRECL              DEFAULT LRECL           YS02019 12764002
         OI    JFCBMASK+TWO,BLKSIMRG+LRECLMRG                           12766020
*                                       SET MERGE MASK                  12768020
         B     OP5666                   GO TO CHECK RECFM               12770020
         SPACE 1                                                        12770402
OP6080   EQU   *                                                        12772020
         LR    RJ,RF                    GET BUFFER LENGTH       YS02019 12774002
         B     OP6070                   DEFAULT BLOCK SIZE              12776020
         SPACE 1                                                        12776402
*                                                                       12788020
*  CHECK WHETHER DCBRECFM IS SPECIFIED, IF NOT, DEFAULT TO FIXED        12800020
*                                                                       12900020
OP5666   EQU   *                                                        12910002
         DROP  RB                      RELEASE USAGE            ZA09612 12940003
         LA    RB,DEBDEVED             GET PTR DEV DEPENDENT    ZA16624 12950003
         USING DEBACSMD,RB             SET BASE                 ZA09612 12960003
         MVC   DEBBLKSI,DCBBLKSI       SAVE BLOCKSIZE IN DEB    ZA09612 12970003
         MVC   DEBLRECL,DCBLRECL       SAVE LRECL IN DEB        ZA09612 12980003
         CLI   DCBRECFM,NULL            CHECK RECFM IS SPECIFIED        13000020
         BNE   TSEX010                  BRANCH IF YES                   13100020
         MVI   DCBRECFM,DCBRECF         DEFAULT TO FIXED                13200002
         OI    JFCBMASK+TWO,RECFMMRG    SET MERGE MASK                  13300020
         SPACE 2                                                        13350002
*                                                                       13900020
*********************************************************************** 14000020
*                                                                       14100020
*   LOAD APPROPRIATE SAM ACCESS METHOD ROUTINE AND INITIALIZE FIELDS    14200020
*   IN THE DCB                                                          14300020
*                                                                       14400020
*********************************************************************** 14500020
*                                                                       14600020
*   DETERMINE ACCESS MODE AND LOAD PROPER ROUTINE                       14700020
*                                                                       14800020
TSEX010  EQU   *                                                        14850020
         SR    RJ,RJ                    RESET RJ TO '0'                 14900020
         IC    RJ,DEBAMLNG              INSERT A.M. LENGTH              15000020
         LA    RUCB,WAOFF(RJ,RDEB)      LOAD DEB OFFSET                 15100002
         IC    RJ,DEBNMEXT              INSERT NO. OF EXTENT            15200020
         SLL   RJ,2                     MULTIPLY EXTENT BY '4'          15300020
         AR    RUCB,RJ                  NOW RUCB POINT TO DEBSUBID      15400020
         TM    DCBCIND2,DCBCNQSM        TEST IF BSAM OR QSAM            16200002
         BO    TSEX050                  QSAM,GOTO CHECK PUT OR GET      16300020
         SPACE 2                                                        16350002
*                                                                       16500020
*                                                                       17300020
*   TEST OPEN FOR INOUT, OUTIN OR UPDAT, AND LOAD COMBINED              17450002
*   READ/WRITE ROUTINE                                                  17460002
*                                                                       17500020
TSEX042  EQU   *                                                        17550020
         TM    DEBOPATB,MSK0E           TEST FOR INOUT,OUTIN,UPDAT      17600020
         BC    NMXD,TSEX041             NO,GOTO CHECK READ OR WRITE     17700020
         LA    RJ,RDWRRTN               LOAD ADDR OF READ/WRITE RTN ID  18100002
         B     TSEX070                  GOTO LOAD SUB RTN               18300002
         SPACE 1                                                        18350002
TSEX041  EQU   *                                                        18500020
         TM    DEBOPATB,MSK0E           TEST IF READ IS SPECIFIED       18700020
         BNZ   TSEX060                  NO,GOTO LOAD WRITE ROUTINE      18800020
         LA    RJ,READRTN               LOAD ADDR OF READ RTN ID        19000020
         B     TSEX070                  GOTO,BRANCH TO LOAD ROUTINE     19100020
         SPACE 1                                                        19150002
TSEX060  EQU   *                                                        19300020
         LA    RJ,WRITERTN              LOAD ADDR OF WRITE RTN ID       19500020
         SPACE 1                                                        19550002
*                                                                       19600002
*   LOAD READ/WRITE ROUTINE                                             19650002
*                                                                       19660002
TSEX070  EQU   *                                                        19700020
         BAL   RD,TSEX900               GOTO LOAD ROUTINE               19900020
         MVC   DCBRTNAD(THREE),MSK25(RWTG)   STORE RTN ADDR IN DCB      20000020
         SPACE 1                                                        20050002
TSEX080  EQU   *                                                        20200020
         TM    DCBMACF1,DCBMRCRL        IS CONTROL SPECIFIED FOR INPUT  20310002
         BO    TSEX020                  BRANCH IF YES                   20320020
         TM    DCBMACF2,DCBMRCRL        IS CONTROL SPECIFIED FOR OUTPUT 20330002
         BNO   TSEX025                  BRANCH IF NO                    20340020
         SPACE 3                                                        20342002
*                                                                       20360020
*   LOAD CONTROL ROUTINE                                                20370020
*                                                                       20380020
TSEX020  EQU   *                                                        20382002
         LA    RJ,CNTRLRTN              LOAD ADDR OF CNTRL ROUTINE ID   20390020
         BAL   RD,TSEX900               GO TO LOAD ROUTINE              20400020
         MVC   DCBCNTRL+ONE(THREE),MSK25(RWTG)                          20410002
*                                       STORE CNTRL ROUTINE ADDR IN DCB 20420020
         B     TSEX030                  GO TO LOAD CHECK ROUTINE        20430020
         SPACE 1                                                        20432002
TSEX025  EQU   *                                                        20440020
         TM    DCBMACF1,DCBMRPT1        IS NOTE/POINT SPECIFIED         20446002
*                                       FOR INPUT                       20452020
         BO    TSEX035                  BRANCH IF YES                   20460020
         TM    DCBMACF2,DCBMRPT1        IS NOTE/POINT SPECIFIED FOR     20466002
*                                       OUTPUT                          20472020
         BNO   TSEX030                  GO TO LOAD CHECK ROUTINE        20480020
         SPACE 1                                                        20482002
*                                                                       20500020
*   LOAD NOTE/POINT ROUTINE                                             20510020
*                                                                       20520020
TSEX035  EQU   *                                                        20522002
         LA    RJ,NTPTRTN               LOAD ADDR OF NOTE-POINT RTN ID  20530020
         BAL   RD,TSEX900               GO TO LOAD ROUTINE              20540020
         MVC   DCBPOINT+ONE(THREE),MSK25(RWTG)                          20550002
*                                       STORE NOTE-POINT RTN ADDR       20560020
         SPACE 1                                                        20562002
*                                                                       20580020
*   LOAD CHECK ROUTINE                                                  20590020
*                                                                       20600020
TSEX030  EQU   *                                                        20602002
         LA    RJ,CHECKRTN              LOAD ADDR OF CHECK RTN ID       20610020
         BAL   RD,TSEX900               GO TO LOAD ROUTINE              20620020
         MVC   DCBCKADR(THREE),MSK25(RWTG)                              20630020
*                                       STORE CHECK RTN ADDRESS         20640020
*                                                                       20700020
         B     TSEX090                  GOTO CHECK WTG TABLE ROUTINE    20800020
         SPACE 3                                                        20850002
*                                                                       20900020
*********************************************************************** 21000020
*                                                                       21100020
*                                                                       21300020
*   QSAM IS SPECIFIED                                                   21400020
*                                                                       21500020
*********************************************************************** 21500420
*                                                                     * 21500820
*  TEST FOR LOCATE MODE, IF SO PUT BUFFER ADRESS IN DCBRECAD, PUT     * 21501020
*  BUFFER ADDRESS PLUS LOGICAL RECORD LENGTH IN DCBEOBAD. IF          * 21501220
*  PUT/LOCATE IS SPECIFIED, TURN ON BIT 0 OF BYTE 0 IN BUFFER POOL    * 21501420
*  CONTROL BLOCK TO INDICATE FIRST PUT.                               * 21501620
*                                                                     * 21502020
*********************************************************************** 21502420
*                                                                       21502820
TSEX050  EQU   *                                                        21504802
         TM    DCBMACRF,QSAMLOCT        TEST FOR GET/LOCATE             21510820
         BO    TSEX001                  BRANCH IF YES                   21518820
         TM    DCBMACRF+ONE,QSAMLOCT    TEST FOR PUT/LOCATE             21526802
         BNO   TSEX040                  BRANCH IF NOT                   21534820
         SPACE 1                                                        21536802
TSEX001  EQU   *                                                        21542820
         L     RD,DCBBUFNO              GET ADDR OF BUFCB               21550820
         MODESET KEYADDR=DXUKEY,WORKREG=13  CHANGE INTO         YM03948 21552802
*                                           USER'S KEY          YM03948 21554802
         L     RD,NULL(RD)              GET ADDR OF FIRST BUFFER        21558820
         MODESET EXTKEY=DATAMGT         CHANGE BACK TO DM KEY   YM03948 21560802
         ST    RD,DCBRECAD              PUT ADDR OF BUFFER IN DCB       21566820
         AH    RD,DCBLRECL              ADD LENGTH OF RECORD            21574820
         ST    RD,DCBEOBAD              PUT EOB ADDRESS IN DCB          21582820
         TM    DCBMACRF+ONE,QSAMLOCT    TEST FOR PUT/LOCATE             21590802
         BNO   TSEX040                  BRANCH IF NOT                   21598820
         L     RD,DCBBUFNO              GET ADDR OF BUFCB               21606820
         MODESET KEYADDR=DXUKEY,WORKREG=13  CHANGE IN USER KEY  YM03948 21608802
         OI    NULL(RD),FIRSTPT         TURN ON FLAG FOR FIRST PUT      21614820
         MODESET EXTKEY=DATAMGT         CHANGE BACK TO DM KEY   YM03948 21624802
         SPACE 3                                                        21624920
*                                                                       21664920
*   TEST IF DCB IS OPEND FOR UPDATE                                     21700020
*                                                                       21800020
TSEX040  EQU   *                                                        21850002
         TM    DEBOPATB,MSK0E           TEST IF DCB IS OPENED FOR UPDAT 21900020
         BC    NMXD,TSEX051             NO,GOTO CHECK PUT OR GET        22000020
         LA    RJ,GTPTRTN                LOAD ADDR OF GET/PUT RTN ID    22200020
         B     TSEX110                  GO TO LOAD ROUTINE              22300020
         SPACE 1                                                        22350002
TSEX051  EQU   *                                                        22500020
         TM    DEBOPATB,MSK0E           TEST IF GET IS SPECIFIED        22700020
         BNZ   TSEX100                  NO, GO TO LOAD PUT RTN          22800020
         LA    RJ,GETRTN                LOAD ADDR OF GET RTN ID         23000020
*                                                                       23020020
*   FOR VARIABLE SPANNED RECORD, SAVE BLOCK SIZE IN DEB IF IT           23040020
*   IS SMALLER THAN LRGCL                                               23060020
*                                                                       23080020
TSEX057  EQU   *                                                        23100020
         TM    DCBRECFM,DCBRECV+DCBRECSB TEST FOR V/S TYPE RECORD       23300002
         BNO   TSEX110                  BRANCH IF NO                    23400020
         TM    DCBMACRF,DCBMRLCG        TEST FOR GET/LOCATE MODE        23500002
         BNO   TSEX110                  BRANCH IF NO                    23600020
         LH    RC,DCBBLKSI              LOAD BLOCK SIZE                 23700020
         DROP  RD                                                       23900020
         USING BUFCB,RD                                                 24100020
         L     RD,DCBBUFCB              GET ADDRESS OF BUFCB   @ZA08323 24300003
         MODESET KEYADDR=DXUKEY,WORKREG=9 CHANGE TO USERS KEY  @ZA08323 24330003
*                                                              @ZA08323 24360003
         CH    RC,BUFL                  IS BLOCK SIZE > BFR    @ZA08323 24390003
         BNH   TSEX055                  BRANCH IF NOT          @ZA08323 24420003
         LH    RC,BUFL                  YES GET BFR LENGTH     @ZA08323 24450003
TSEX055  EQU   *                                               @ZA08323 24480003
         MODESET EXTKEY=DATAMGT         CHANGE BACK TO DM KEY  @ZA08323 24510003
*                                                              @ZA08323 24540003
         L     RTIOT,CVTPTR             RELOAD CVT ADDRESS     @ZA08323 24570003
*                                                              @ZA08323 24600003
         SPACE 1                                                        24650002
TSEX056  EQU   *                                                        24700020
         CH    RC,DEBLRECL              IS BLOCK SIZE BIGGER THAN LRECL 24800020
         BNL   TSEX110                  BRANCH IF YES                   24900020
         STH   RC,DEBLRECL              SAVE BLOCK SIZE IN DEB          25000020
         B     TSEX110                  GOTO,BRANCH TO LOAD ROUTINE     25200020
         SPACE 1                                                        25250002
TSEX100  EQU   *                                                        25400020
         LA    RJ,PUTRTN                LOAD ADDR OF PUT RTN ID         25600020
         SPACE 1                                                        25650002
TSEX110  EQU   *                                                        25800020
         BAL   RD,TSEX900               GOTO LOAD ROUTINE               26000020
         MVC   DCBRTNAD(THREE),MSK25(RWTG)   STORE RTN ADDR IN DCB      26100020
*                                                                       26200020
*                                                                       26240020
*   TEST CNTRL IS SPECIFIED, IF YES, LOAD CONTROL ROUTINE               26280020
*                                                                       26320020
         TM    DCBMACF1,DCBMRCRL        IS CONTROL SPECIFIED FOR INPUT  26360002
         BO    TSEX054                  BRANCH IF YES                   26400020
         TM    DCBMACF2,DCBMRCRL        IS CONTROL SPECIFIED FOR OUTPUT 26450002
         BNO   TSEX090                  BRANCH IF NO                    26480020
         SPACE 1                                                        26530002
TSEX054  EQU   *                                                        26560020
         LA    RJ,CNTRLRTN              LOAD ADDR OF CNTRL RTN ID       26600020
         BAL   RD,TSEX900               GO TO LOAD ROUTINE              26640020
         MVC   DCBCNTRL+ONE(THREE),MSK25(RWTG)                          26680002
*                                       STORE CNTRL RTN ADDR IN DCB     26720020
         B     TSEX090                  GOTO CHECK WTG TABLE ROUTINE    26800020
         SPACE 3                                                        26850002
*                                                                       26900020
*                                                                       27000020
*********************************************************************** 27100020
*                                                                       27200020
TSEX900  EQU   *                                                        27300020
*                                                                       27400020
*********************************************************************** 27500020
*                                                                       27600020
*   LOAD SAM SUBROUTINE ROUTINE                                         27700020
*                                                                       27800020
*********************************************************************** 27900020
*                                                                       28000020
         MVC   NULL(TWO,RUCB),NULL(RJ)  STORE ROUTINE ID IN DEB         28100020
         LA    RUCB,TWO(RUCB)           INCREMENT RUCB BY '2'           28200020
         MVC   SIX(TWO,RWTG),NULL(RJ)   MOVE 2 BYTE ID TO DE            28224020
         L     RC,CVTLINK               GET LINKLIB'S DCB ADDR  YM01426 28274002
         LOAD  EPLOC=(RWTG),DCB=(RC)    LOAD ROUTINE            YM03842 28284002
         ST    RE,MSK24(RWTG)           SAVE ADDR OF ROUTINE TEMPORARLY 29000020
*                                                                       29100020
         SR    RJ,RJ                                                    29200020
         IC    RJ,DEBNMSUB              LOAD NO. OF SUBROUTINE          29300020
         LA    RJ,ONE(RJ)               INCREMENT NO. BY '1'            29400020
         STC   RJ,DEBNMSUB              UPDATE NO. OF SUBROUTINE        29500020
*                                                                       29600020
         BR    RD                       GO BACK TO ENTRY POINT          29700020
*                                                                       29800020
*                                                                       29900020
*********************************************************************** 30000020
*                                                                       30100020
*********************************************************************** 30200020
*                                                                       30300020
*                                                                       30400020
TSEX090  EQU   *                                                        30500020
*                                                                       30510002
*********************************************************************** 30520002
*                                                                       30530002
*   UPDATE USER'S DCB                                                   30540002
*                                                                       30550002
*********************************************************************** 30560002
*                                                                       30570002
         USING WTG,RWTG                 WTG TABLE ADDRESSABLE   YM03016 30620002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(RE,RD,WTGPREFX) COPY   YM03016 30670002
*                                       BACK USER'S DCB         YM03016 30720002
         DROP  RWTG                     WTG NOT ADDRESSABLE     YM03016 30770002
         MVC   DEBDCBB,DXUDCBAD+ONE     UPDATE DCB PTR IN DEB   YM03016 30780002
         MVI   NULL(RWTGC),NULL         SET TO GO OUT FROM SAM EXECUTOR 30800020
         SPACE 2                                                        30850002
*                                                                       31300020
*********************************************************************** 31400020
*                                                                       31500020
*   UPDATES WHERE-TO-GO TABLE AND XCTL TO NEXT MODULE                   31600020
*                                                                       31700020
*********************************************************************** 31800020
*                                                                       31900020
RELOOP   EQU   *                                                        31950002
         LA    RWTGC,WGOFF(NULL,RWTGC)  INCREMENT CURRENT WTG ENTRY     32000020
         LA    RPARC,PLOFF(NULL,RPARC)  INCREMENT CURRENT DCB ENTRY     32100020
         CLC   NULL(TWO,RWTGC),AMIDCNST IS THE RTN NEEDED AGAIN         32200020
         BE    GOGOGOGO                 YES,RETURN TO THE BEGINNING     32300020
         CLC   NULL(TWO,RWTGC),OPIDCNST TEST END OF WTG TABLE           32500020
         BNE   RELOOP                   NO,CHECK NEXT ENTRY             32600020
         LR    RPARC,RPAR               RESET REG. TO '0'               32800020
         LA    RWTGC,WAOFF(NULL,RWTG)   RESET WTG REG TO PT +32(WTG)    32900020
         SPACE 1                                                        32950002
ZCHECK   EQU   *                                                        33100020
         CLI   NULL(RWTGC),NULL         TEST IF THIS ENTRY IS COMPLETE  33300020
         BNE   TCTLRTN                  NO,GOTO XCTL                    33400020
         LA    RWTGC,WGOFF(NULL,RWTGC)  GET NEXT ENTRY OF WTG TABLE     33600020
         LA    RPARC,PLOFF(NULL,RPARC)  GET NEXT ENTRY OF DCB           33700020
         B     ZCHECK                   GOTO TEST COMPLETION            33800020
         SPACE 1                                                        33850002
TCTLRTN  EQU   *                                                        34000020
         MVC   SIX(TWO,RWTG),NULL(RWTGC)     STORE ID IN WTG TABLE      34200020
         LA    RJ,DXCCW12                                               34600020
         XCTL  EPLOC=(RWTG),SF=(E,(15)) XCTL TO NEXT MODULE     YM03842 34800002
         SPACE 3                                                        34850002
*                                                                       35300020
*********************************************************************** 35400020
*                                                                       35500020
*   CONSTANTS                                                           35600020
*                                                                       35700020
*********************************************************************** 35800020
*                                                                       36800020
*   FOR WTG TABLE                                                       36900020
*                                                                       37000020
OPIDCNST DC    C'0S'                    LAST MODULE OF OPEN             37100020
AMIDCNST DC    C'6S'                    THIS MODULE                     37200020
GETRTN   DC    C'T3'                    TS GET ROUTINE ID       YM03016 38260002
PUTRTN   DC    C'T4'                    TS PUT ROUTINE ID       YM03016 38290002
RDWRRTN  DC    C'T5'                    TS READ/WRITE RTN ID    YM03016 38320002
GTPTRTN  DC    C'T6'                    TS GET/PUT ROUTINE ID   YM03016 38350002
READRTN  DC    C'T7'                    TS READ ROUTINE TID     YM03016 38380002
WRITERTN DC    C'T8'                    TS WRITE ROUTINE ID     YM03016 38410002
CHECKRTN DC    C'TX'                    TS CHECK ROUTINE ID     YM03016 38440002
NTPTRTN  DC    C'TY'                    TS NOTE/POINT RTN ID    YM03016 38470002
CNTRLRTN DC    C'TZ'                    TS CONTROL ROUTINE ID   YM03016 38500002
PATCH    DC    20F'0'                   PATCH AREA              YM03016 38550002
         EJECT                                                          38730002
         IHAASCB                                                YS02019 38780002
         SPACE 3                                                        38790002
*                                                                       38800020
*                                                                       38900020
*********************************************************************** 39000020
*                                                                       39100020
*   DCB DSECT                                                           39200020
*                                                                       39300020
*********************************************************************** 39400020
*                                                                       39500020
         DCBD  DSORG=PS                                                 39600020
*                                                                       39700020
DCBEND   EQU   *                                                YS02019 39730002
DCBLEN   EQU   DCBEND-IHADCB            LENGTH OF SAME DCB      YS02019 39760002
DCBRTNAD EQU   DCBREAD+1                SAM RTN ADDR                    39800020
DCBPTADR EQU   DCBPOINT+1               ADDR OF DCB POINT/CNTRL RTN     39900020
DCBCKADR EQU   DCBCHECK+1               ADDR OF DCB CHECK RTN           40000020
DCBBLKSZ EQU   DCBBLKSI+1               DCB BLKSIZE                     40100020
DCBLRCL2 EQU   DCBLRECL+1               DCB LRECL+1                     40200020
*                                                                       40300020
*********************************************************************** 40400020
*                                                                       40500020
*   OPEN WORK AREA DSECT                                                40600020
*                                                                       40700020
*********************************************************************** 40800020
*                                                                       40900020
         IECDSECS (MAIN,(IOB,NO)),WTG,PREFX,EXPAND=YES          YM03016 41200002
*                                                                       41300020
*                                                                       41306020
*                                                                       41390020
*********************************************************************** 41400020
*                                                                       41500020
*   DEB DSECT                                                           41600020
*                                                                       41700020
*********************************************************************** 41800020
*                                                                       41900020
*                                                                       42000020
         IEZDEB                                                         42150002
         SPACE 3                                                        42300002
*                                                                       44300020
*                                                                       44400020
*********************************************************************** 48500020
*                                                                       48600020
*   CVT DUMMY SECTION                                                   48700020
*                                                                       48800020
*********************************************************************** 48900020
*                                                                       49000020
CVT      DSECT                                                          49100020
*                                                                       49200020
         CVT                                                            49300020
**********************************************************************  49400020
*                                                                     * 49500020
*                  BUFFER POOL CONTROL BLOCK DSECT                    * 49600020
*                                                                     * 49700020
**********************************************************************  49800020
         DS    0F                                                       49900020
BUFCB    DSECT                                                          50000020
BUFAD    DS    CL4                      BUFFER ADDRESS                  50100002
BUFNO    DS    CL2                      BUFFER NUMBER                   50200002
BUFL     DS    CL2                      BUFFER LENGTH                   50300002
         SPACE 3                                                        50309020
         IHAPSA                                                 YS02019 50311002
         SPACE 3                                                        50313002
         IKJTCB                                                         50318020
         SPACE 3                                                        50327020
         IKJRB                                                  YS02019 50374002
         SPACE 3                                                        50381020
         IKJTSB                                                         50390020
         END                                                            50400020
