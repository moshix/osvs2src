RWPC     TITLE 'IGG019C8- READ PCI APPENDAGE'                           00100019
IGG019C8 CSECT                                                          00200019
         SPACE 1                                                        00300019
*A 129671,188080-188084,441959-441963,447200-447984,           @YM04451 00300602
*A 462100-462200                                               @YM04451 00301202
*C 451300                                                      @YM06448 00302002
*A 442983                                                      @YM06435 00306002
*A 171500-171800,189267-189334,231200-231420,462800-462820     @YM06434 00308002
*C 171000                                                      @YM06434 00310002
*A 128937,129049,184500-184600,185020,188020-188040,188908     @YM06433 00312002
*A 188941-188942,189010-189263,189945-190196,315500            @YM06433 00314002
*A 419000-419320,419900,431500,439500,441004-441064,441924     @YM06433 00316002
*A 441940-442099,442908,443063-443100,451300,462500-462600     @YM06433 00318002
*A 462900                                                      @YM06433 00320002
*C 149500-150000,155000-157000,159000-161000,187000-188000     @YM06433 00322002
*C 188904,188917,188960,189356-189388,189652-189656            @YM06433 00324002
*C 189885-189887,192000,314000,363000,365800,375000,418300     @YM06433 00326002
*C 420400,424000,441100,441800-441920,442332-442632            @YM06433 00328002
*C 442665-442887,442945-442954,443100,443400,444000-447000     @YM06433 00330002
*C 451400,452000,459000,460000                                 @YM06433 00332002
*D 134600,135900,149000,154000,180000-180400,180800-183988     @YM06433 00334002
*D 185100-185500,188916,188918-188940,188946,188980-188988     @YM06433 00336002
*D 189996-189998,189660-189877,189888,316000-318000,363500     @YM06433 00338002
*D 395600-395980,396100-396200,425000-428000,432000-437900     @YM06433 00340002
*D 440500-440988,441600,442652-442664,442881,442925            @YM06433 00342002
*D 442957-442963,451600,459500,460060-460120,460300-461000     @YM06433 00344002
*A 128929,128989,395600-395980,396100-396200                    YA00099 00346002
*C457000                                                        OY01184 00348002
*D450000                                                         A34092 00350000
*C469400                                                         A41780 00360000
* 132500,190000,192000                                           X010XX 00360100
*C 128995,150000,182600,363000,437900,463440                    YL026VD 00370102
*A 149000,182400,382800,363500,437800                           YL026VD 00380102
*C212100,213570                                                @ZA11964 00380299
*A213670,213700                                                @ZA13707 00380399
*A213670,213700                                                @ZA13751 00380499
*TITLE- IEBCOPY READ/WRITE PCI APPENDAGE- IGG019C8                    * 00400019
*                                                                     * 00500019
*STATUS- CHANGE LEVEL 001                                             * 00600019
*                                                                     * 00700019
*FUNCTION/OPERATION- THIS MODULE DETERMINES DYNAMICALLY WHILE A RECORD* 00800019
*       IS BEING READ OR WRITTEN, IF THERE ARE MORE RECORDS TO BE     * 00900019
*       READ OR WRITTEN, IF THEY ARE IN OR WILL FIT IN THE BUFFER, AND* 01000019
*       IF SO, WHERE THE NEXT RECORD WILL BE READ INTO OR WRITTEN     * 01100019
*       FROM AND UPDATES CCWS TO DO AS IT DETERMINES. A PROGRAM       * 01200019
*       CONTROLLED INTERRUPT IS GENERATED WHEN A CCW IS FETCHED WHICH * 01300019
*       HAS THE PCI FLAG SET. IOS TRAPS THE PCI, DOES SOME SETTING UP * 01400019
*       OF REGISTERS AND GIVES THE PCI APPENDAGE CONTROL AT IGG019C8. * 01500019
*                                                                     * 01600019
*ENTRY POINTS- ENTERED FROM I/O SUPERVISOR AT IGG019C8.               * 01700019
*                                                                     * 01800019
*INPUT- REGISTER 15 SET BY IOS TO THE ADDRESS OF THE ENTRY POINT OF   * 01900019
*      THE APPENDAGE SO IS USED AS BASE ADDRESS REGISTER FOR IGG019C8.* 02000019
*       REGISTER 2 IS SET BY IOS TO POINT TO THE IOB BEING USED. EACH * 02100019
*      IOB CREATED BY THE IEBDSCPY HAS A POINTER TO THE COMMON AREA   * 02200019
*      IEBMCA AT THE END OF IT (OFFSET IEBMCAPT) SO THAT POINTERS,CCWS* 02300019
*      AND OTHER COMMON DATA CAN BE FOUND AND CHANGED BY THE PCI      * 02400019
*      APPENDAGE. POINTER TO THE DCB IS ALSO IN THE IOB AS A SYSTEMS  * 02500019
*      REQUIREMENT.                                                   * 02600019
*      'RDGSW' IS ON IN 'WSFLAG' IF A READ IS BEING DONE.             * 02700019
*       'STATUS' SWITCH IS SET TO DEFINE WHICH DATA SET IS BEING READ.* 02800019
*       'TAG' SWITCH IS SET OT DEFINE WHICH DATA SET IS BEING WRITTEN.* 02900019
*       'RDPTR1' IS SET TO CCW BEING EXECUTED IF READING.             * 03000019
*       'RDPTR2' IS SET TO NEXT CCW TO BE EXECUTED IF READING.        * 03100019
*       'WRPTR1' IS SET TO NEXT CCW TO BE EXECUTED IF WRITING         * 03200019
*       'WRPTR2' IS SET TO NEXT CCW TO BE EXECUTED IF WRITING.        * 03300019
*       'RDCKPTR1' SET TO CCW BEING EXECUTED IF READBACK CHECKING.    * 03400019
*       'RDCKPTR2' SET TO NEXT CCW TO BE EXECUTED IF READBACK CHECKING* 03500019
*       'LASTREC' FLAG SET IN FLAG AHEAD OF COUNT FIELD OF RECORD AND * 03600019
*      IF ON WITHOUT 'ENDPROC' PCI APPENDAGE MUST LOCATE NEXT BUFFER  * 03700019
*      TO DETERMINE WHERE NEXT RECORD TO BE READ OR WRITTEN. 'LASTREC'* 03800019
*      SET BY PCI APPENDAGE WHEN READING, ONLY TESTED WHEN WRITING.   * 03900019
*       'ENDPROC' FLAG SET BY PCI APPENDAGE WHEN NO MORE BUFFER ROOM  * 04000019
*      AVAILABLE TO READ INTO. SET BY IEBDRD (READ ROUTINE) WHEN AN   * 04100019
*      EOF WAS READ- PCI DOESN'T CHECK IF EOF WAS READ AS MAIN READ   * 04200019
*      SHOULD DO IT. WHEN WRITING OR READ BACK CHECKING, 'ENDPROC'    * 04300019
*      FLAG SET MEANS RECORD HAVING IT ON IS THE LAST ONE TO BE DONE. * 04400019
*       'WRTOVR' FLAG SET IN FLAG AHEAD OF COUNT FIELD WHEN WRITING   * 04500019
*      MEANS MAKE NEXT WRITE CCW OP CODE A 'WRITE SPECIAL CNT/KEY/DATA* 04600019
*                                                                     * 04700019
*OUTPUT- IOB CCHHR ADDRESS SET TO LAST RECORD SUCCESSFULLY READ OR    * 04800019
*       WRITTEN.                                                      * 04900019
*                                                                     * 05000019
*                  PCI ACTION IF READING OR WRITING                   * 05100019
*        RESET PCI FLAG IN CCW CURRENTLY EXECUTING SO PCI NOT GIVEN   * 05200019
*       AGAIN IN CASE OF ERROR RETRY OF READ OR WRITE.                * 05300019
*        RESET PCI FLAG IN NEXT READ OR WRITE CCW TO BE EXECUTED.     * 05400019
*        IF MORE RECORDS TO BE READ OR WRITTEN, SET NOP OP CODE AFTER * 05500019
*       NEXT READ OR WRITE CCW TO BE EXECUTED THEN SET A TIC COMMAND  * 05600019
*       AFTER CURRENT CCW EXECUTING SO THAT WILL EXECUTE NEXT READ OR * 05700019
*       WRITE CCW WITH PCI.                                           * 05800019
*        IF NO MORE RECORDS TO BE READ OR WRITTEN, LEAVE NOP CCW OP   * 05900019
*       CODE AFTER CURRENT CCW EXECUTING SO CHAIN OF COMMANDS WILL BE * 06000019
*       BROKEN AND READ/WRITE STOPPED.                                * 06100019
*        SWAP READ OR WRITE CURRENT AND NEXT POINTERS.                * 06200019
*        UP BY 1 THE PCI TAKEN COUNT FOR READING OR WRITING.          * 06300019
*                                                                     * 06400019
*                  PCI ACTION IF READING                              * 06500019
*        IF 'CTOUT' SWITCH ON IN 'TAG' UP BY 1 'DIRCNT' FOR EACH      * 06600019
*       DIRECTORY BLOCK READ.                                         * 06700019
*        IF 'STAT5' SWITCH ON IN 'STATUS' DIRECTORY BLOCKS ARE UNUSED * 06800019
*       SO NEED ONLY COUNT THEM. READ EACH BLOCK INTO SAME AREA AND   * 06900019
*       COUNT EACH ONE READ BY UPPING 'DIRCNT'.                       * 07000019
*        MOVE MBB FROM IOB TO AHEAD OF COUNT OF RECORD JUST READ AND  * 07100019
*       CLEAR FLAG FIELD.                                             * 07200019
*        SET 'LASTREC' IF CURRENT BUFFER FULL AND POSITION TO NEXT.   * 07300019
*        SET 'LASTREC' AND 'ENDPROC' IF HAVE NO MORE BUFFER SPACE.    * 07400019
*                                                                     * 07500019
*TABLES/WORK AREAS-                                                   * 07600019
*       -WKA1-     TEMPORARY BOUNDARY ALIGNMENT FOR DATA LENGTH       * 07700019
*       -BCB-      POINTERS TO BUFFERS                                * 07800019
*       -WRPCICNT- WRITE PCI'S TAKEN COUNT USED BY READ BACK CHECK    * 08000019
*       -IOB-      POINTS TO CURRENT IOB                              * 08300019
*       -RDPTR1-   CURRENT READ CCW COMMAND (READ COUNT/KEY/DATA-8)   * 08400019
*       -RDPTR2-   NEXT READ CCW COMMAND (READ COUNT OF NEXT CHAIN)   * 08500019
*       -WRPTR1-   CURRENT WRITE COMMAND                              * 08600019
*       -WRPTR2-   NEXT WRITE COMMAND                                 * 08700019
*       -RDCKPTR1- CURRENT READ BACK CHECK CCW                        * 08800019
*       -RDCKPTR2- NEXT READ BACK CHECK CCW                           * 08900019
*       -LASTADDR- CONTAINS MBBCCHHR OF LAST SUCCESFULLY WRITTEN REC. * 09000019
*       -SAVEREGS- SAVES REGISTERS UPON ENTRY INTO APPENDAGE AND      * 09100019
*                  RESTORES THEM WHEN RETURNS TO IOS.                 * 09200019
*                                                                     * 09300019
*ATTRIBUTES- SERIAL REUSABLE,SUPERVISOR MODE, DISABLED                * 09400019
         EJECT                                                          09500019
*                                                                     * 09600019
*               SYMBOLIC REGISTERS FOR READ PCI ROUTINE               * 09700019
*                                                                     * 09800019
*   BASE ADDRESS REGISTER GR15- ENTRY POINT PASSED BY IOS             * 09900019
*                                                                     * 10000019
*    WRITE PCI HANDLER IS HERE TOO       IGG019 ENTRY LABEL****-******* 10100019
*                                                                     * 10200019
         SPACE 1                                                        10250019
GR0      EQU   0                                                        10300019
GR1      EQU   1                       APPENDAGE SHOULD NOT CHANGE      10400019
GR2      EQU   2                       POINTS TO IOB ON ENTRY           10500019
GR3      EQU   3                       POINTS TO DEB ON ENTRY           10600019
GR4      EQU   4                       POINTS TO DCB ON ENTRY           10700019
*    DO NOT NEED POINTER TO DCB AS THERE IS ONE IN THE IOB              10800019
*    SAVE REGISTER 4 THRU 8 AND USE REGISTER 4 TO REFERENCE THE COMMON  10900019
*   AREA IEBMCA.                                                        11000019
GR5      EQU   5                       APPENDAGE USES TO POINT TO CCW   11100019
*               REFERENCED BY RDPTR2 IF READING, WRPTR1 IF WRITING.     11200019
GR6      EQU   6                       APPENDAGE USES TO POINT TO CCW   11300019
*                REFERENCED BY RDPTR1 IF READING                        11400019
GR7      EQU   7                       POINTS TO UCB ON ENTRY- DO NOT   11500019
*        NEED UCB SO USE AS WORK REGISTER AFTER SAVING IT.              11600019
GR8      EQU   8                       SAVED AND THEN USED TO POINT TO  11700019
*             FMBB FIELD AHEAD OF RECORD BEING READ                     11800019
GR9      EQU   9                       USED BY APPENDAGE BUT RESET TO   11900019
*                  ZERO BEFORE RETURNING TO IOS.                        12000019
*                     GR10-GR13 WORK REGISTER NO NEED TO SAVE/RESTORE.  12100019
GR10     EQU   10                                                       12200019
GR11     EQU   11                                                       12300019
GR12     EQU   12                                                       12400019
GR13     EQU   13                                                       12500019
GR14     EQU   14                      CONTAINS RETURN ADDRESS OF IOS   12600019
GR15     EQU   15                      ENTRY POINT OF PCI APPENDAGE SET 12700019
*            BEFORE ENTRY SO USED AS BASE REGISTER.                     12800019
*  DECIMAL CONSTANTS                                                    12809019
         SPACE 1                                                        12818019
C0       EQU   0                                                        12827019
C1       EQU   1                                                        12836019
C4       EQU   4                                                        12845019
C6       EQU   6                                                        12854019
C8       EQU   8                                                        12863019
C9       EQU   9                                                        12872019
C12      EQU   12                                                       12881019
C276     EQU   276                                                      12890019
C2       EQU   2                                                        12890519
C3       EQU   3                                                        12891019
C5       EQU   5                                                        12891519
C7       EQU   7                                                        12892019
C10      EQU   10                                                       12892519
C11      EQU   11                                               YA00099 12892902
C16      EQU   16                                                       12893019
C40      EQU   40                                                X010XX 12893400
D2048    EQU   2048                                            @YM06433 12893702
*  HEX CONSTANTS                                                        12895502
X01      EQU   X'01'                                                    12895802
X03      EQU   X'03'                                                    12896102
X08      EQU   X'08'                                                    12896402
X0D      EQU   X'0D'                                                    12896702
X0E      EQU   X'0E'                                                    12897002
X1D      EQU   X'1D'                                                    12897302
X60      EQU   X'60'                                                    12897602
X68      EQU   X'68'                                                    12897902
X70      EQU   X'70'                                                    12898202
X78      EQU   X'78'                                                    12898519
X80      EQU   X'80'                                            YA00099 12898902
X92      EQU   X'92'                                                    12899102
XF7      EQU   X'F7'                                           @YM06433 12904902
         SPACE 1                                                 S20201 12910802
* MISC CONSTANTS                                                 S20201 12916702
         SPACE 1                                                 S20201 12922602
RPS      EQU   X'10'                                             S20201 12928502
CSW      EQU   8                  OFFSET OF CSW IN IOB          YL026VD 12942802
*                                   CHANNEL STATUS WORD          S20201 12957102
VIOBIT   EQU   X'80'              IN UCB IF VIO DATA SET       @YM04451 12964102
         SPACE 1                                                 S20201 12971402
         SPACE 1                                                        12985702
         USING START,GR15                                               13000019
         USING IEBMCA,GR10                                       S20201 13050020
START    EQU   *                                                 S20201 13100020
         L     GR10,IEBMCAPT(GR0,GR2)  PTR TO COMMON AREA IN     S20201 13150020
*                                        IOB                     S20201 13200020
         STM   GR0,GR8,PCISAVE    SAVE REGS                      X010XX 13250000
         DROP  GR10                                              S20201 13300020
         LR    GR4,GR10                SET PTR TO COMMON         S20201 13350020
*                                        AREA IN REG 4           S20201 13400020
         USING IEBMCA,GR4                                        S20201 13450020
         LA    GR3,DEVOFF(GR0,GR2)     LOAD PTR TO DEVTYPE INFO  S20201 13500020
         LA    GR7,C8                  LOAD 8 INTO WORK REG      S20201 13520020
         STH   GR7,WKA1                STORE AS INCREMENT FOR    S20201 13540020
*                                       VALID PCI INTERRUPT      S20201 13560020
*                                       TESTING - READ OR RDBACK S20201 13580020
         TM    WSFLAG,RDGSW            READING                          13600019
         BZ    IGG019                  NO, GO TO WRITE PCI RTN          13700019
         SPACE 1                                                        13800019
*****      PCI HANDLER FOR READING   IGG019C8                 ********* 13900019
         SPACE 1                                                        14000019
*           GR5 HAS POINTER TO RDPTR2 AND GR6 TO RDPTR1                 14100019
*       REGISTER 2 (GR2) HAS IOB ADDRESS PASSED FROM IOS              * 14200019
         L     GR5,RDPTR2              NEXT CCW LIST TO EXECUTE         14300019
         L     GR6,RDPTR1              POINTER TO CCW EXECUTED          14400019
         SPACE 1                                                 S20201 14410020
         LA    GR7,C16(GR0,GR6)        FIND ACCEPTABLE LOWER     S20201 14420020
*                                        LIMIT OF CSW AT PCI     S20201 14430020
*                                        INTERRUPT               S20201 14440020
         BAL   GR9,PCIVALCK            CHECK FOR VALID CSW       S20201 14450020
         SPACE 1                                                 S20201 14460020
         SPACE 1                                                        14500019
*   PREPARE FOR RESTART IN CASE CCW EXECUTING FAILS- WILL BE ABLE TO  * 14600019
*  RETRY THRU IOS IF SET POINTER RIGHT.                               * 14700019
         SPACE 1                                                        14800019
         LRA   GR11,C8(GR6)            REAL ADDR OF READ K/D   @YM06433 14950002
         STCM  GR11,C7,CCW3+C1         TIC TO CCW EXECUTING    @YM06433 15000002
*                                                                       15100019
*    TIC SET UP FOR ERROR RESTART IN CASE THIS READ KEY/DATA NOT DONE   15200019
*                                                                       15300019
         OI    C12(GR5),X68            RESTORE PCI             @YM06433 15500002
         NI    C12(GR6),XF7          RESET PCI FLAG FOR RETRY  @YM06433 15600002
         L     GR8,CURRCCW1            GET READ COUNT ADDRESS  @YM06433 15700002
         LA    GR8,C0(GR0,GR8)         CLEAR OP CODE                    15800019
         LA    GR7,C4                                          @YM06433 15900002
         SR    GR8,GR7                 MOVE BACK 4 BYTES TO    @YM06433 16000002
         MVC   IOBCCHHR(C5,GR2),C4(GR8) FLAG FIELD             @YM06433 16100002
         MVC   C1(C3,GR8),IOBMCCHH(GR2) MOVE MBB FROM IOB TO RECORD     16200019
         TM    SENSE,SENSE4            COMPRESS SCAN FOR 'HOLES'        16300019
         BO    SCANCOMP                 YES                             16400019
         TM    STATUS,STAT4            READING INPUT MEMBER             16500019
         BO    INMEMBR                  YES                             16600019
         TM    STATUS,STAT1+STAT3      INPUT OR OUTPUT SPILL DIRECTORY  16700019
         BC    C5,READDIR              YES, READ DIRECTORY              16800019
         TM    STATUS,STAT5            NEW OUTPUT DIRECTORY             16900019
         BZ    READDIR                 NO, MUST ACTUALLY READ DIRECTORY 17000019
*     MAKE CCWS SAME, READ TILL EOF                            @YM06434 17100002
         L     GR7,CURRCCW1       VIRT ADDR OF READ COUNT      @YM06434 17150002
         STCM  GR7,C7,C1(GR5)     STORE IN RD CT OF NEXT CCW   @YM06434 17160002
         LA    GR7,C8(GR7)        VIRT ADDR OF READ K/D        @YM06434 17170002
         STCM  GR7,C7,C9(GR5)     STORE IN DR K/D OF NEXT CCW  @YM06434 17180002
         SPACE 1                                                        17200019
* WHEN DIRECTORY BLOCKS TO BE COUNTED MAINFLOW CLEARS DIRBCNT BUFFER. * 17300019
         CLC   C8(C1,GR8),NDBTR   IS NDBTR >OR= TO 'R' OF THE    A36049 17320000
*                                 BLOCK JUST READ                A36049 17340000
         BNH   COUNTDR            YES                            A36049 17360000
         MVC   NDBTR(C1),C8(GR8)  NO, UPDATE NDBTR               A36049 17380000
         SPACE 1                                                        17400019
COUNTDR  EQU   *                                                        17500019
         LH    GR7,DIRBCNT                                              17600019
         LA    GR7,C1(GR0,GR7)                                          17700019
         STH   GR7,DIRBCNT             UP DIRECTORY BLOCK COUNT BY 1    17800019
RESETNOP EQU   *                                                        17900019
         MVC   C16(C4,GR5),RSECTOR     REPLACE NOP WITH RS CCW   S20201 18060002
* NOP OR RS WILL STOP CCW EXECUTION IF PCI MISSED                S20201 18280020
SWAP     EQU   *                                                        18350019
         SPACE 1                                                        18400019
         CLI   C0(GR8),LASTREC+ENDPROC FLAG AS LASTREC +BUFFER @YM06433 18450002
*          LOAD AND STORE MULTIPLE DONT CHANGE CONDITION CODE  @YM06433 18460002
         STM   GR5,GR6,RDPTR1          SWAP RDPTR1 AND RDPTR2           18500019
         L     GR7,C0(GR5)        LOAD VIRT DATA ADDR          @YM06433 18502002
         L     GR8,CURRCCW1                                    @YM04848 18600002
         STM   GR7,GR8,CURRCCW1   SWAP READ CCW POINTERS       @YM04848 18650002
         L     GR2,IALPTR2                                     @YM06433 18700002
         L     GR3,IALPTR1                                     @YM06433 18750002
         STM   GR2,GR3,IALPTR1    SWAP IAL LIST POINTERS       @YM06433 18800002
         BE    GENRETRN    IF LAST RECORD IN ANY BUFFER, DONT  @YM06433 18802002
*                  TRANSLATE OR SET UP TIC, JUST RETURN TO IOS @YM06433 18804002
         SPACE 1                                                        18805002
         TM    AOS,PCI      IF PCI BIT OFF, DONT TRANSLATE OR  @YM04451 18806002
         BZ    GENRETRN     SET UP TIC, JUST RETURN TO IOS     @YM04451 18807002
         SPACE 1                                                        18808002
*                                                                       18810002
* AT THIS POINT, RDPTR1 (GR5) POINTS AT THE NEXT CCW STRING TO @YM04848 18850002
* BE TRANSLATED, CURRCCW1 (GR7) CONTAINS THE VIRTUAL DATA      @YM04848 18860002
* ADDRESS, AND EXTEND1 (GR2) CONTAINS THE ADDRESS OF THE       @YM04848 18870002
* ASSOCIATED INDIRECT ADDRESS LIST (IAL)                       @YM04848 18880002
*                                                                       18890002
         LA    GR6,C0(GR7)        LOAD ADDR OF READ COUNT      @YM06433 18890402
         NI    C4(GR5),X'FF'-X'04' SET OFF IAL LIST PRESENT    @YM06433 18890802
         LRA   GR9,C0(GR6)        TRANSLATE ADDRESS TO REAL    @YM06433 18891702
         LR    GR8,GR6          PUT VIRT START ADR IN WORK REG @YM06433 18894102
         AH    GR8,C6(GR5)        BUMP BY LENGTH OF READ       @YM06433 18894202
         BCTR  GR8,C0             DECREASE FOR ACTUAL DATA END @YM06433 18896002
         SRL   GR6,11             SHIFT FOR 2K BOUNDARY        @YM06433 18899202
         SRL   GR8,11             SHIFT FOR 2K BOUNDARY        @YM06433 18901002
         SR    GR8,GR6            ON SAME 2K PAGE              @YM06433 18902802
         BZ    SAMEPAGE           YES, ALL ON ONE PAGE         @YM06433 18904602
         ST    GR9,C0(GR2)        PUT 1ST ENTRY IN IAL         @YM06433 18906402
         SLL   GR6,11             GET 1ST BYTE 1ST 2K PAGE     @YM06433 18908202
         LA    GR6,2048(GR6)      BUMP BY 2K                   @YM06433 18910002
         LRA   GR9,C0(GR6)        TRANSLATE TO REAL            @YM06433 18911802
         ST    GR9,C4(GR2)        PUT 2ND ENTRY IN IAL         @YM06433 18913602
         LRA   GR9,C0(GR2)        TRANSLATE ADDR TO REAL       @YM06433 18917202
         OI    C4(GR5),X'04'      SET IAL LIST PRESENT         @YM06433 18919002
SAMEPAGE DS    0H                                              @YM06433 18920802
         STCM  GR9,C7,C1(GR5)     INSERT REAL ADDR INTO RD CNT @YM06433 18922602
         LA    GR5,C8(GR5)        BUMP TO READ KEY/DATA CCW    @YM06433 18926202
         NI    C4(GR5),X'FF'-X'04' SET IAL LIST NOT PRESENT    @YM06433 18926302
         LA    GR7,C8(GR7)        BUMP DATA ADDRESS BY 8       @YM06434 18926702
         LRA   GR9,C0(GR7)        TRANSLATE ADDRESS TO REAL    @YM06434 18928002
         LR    GR6,GR7            VIRT DATA ADDRESS            @YM06434 18933402
         AH    GR7,C6(GR5)        ADD LENGTH OF READ           @YM04848 18935202
         BCTR  GR7,C0             FIND ACTUAL END ADDR         @YM06433 18935602
         SRL   GR6,11             STARTING PAGE NUMBER         @YM06433 18937002
         SRL   GR7,11             ENDING PAGE NUMBER           @YM06433 18938802
         SR    GR7,GR6            SEE IF ALL ON ONE PAGE       @YM04848 18940602
         BZ    EXTIALRD           MORE THAN 1 PAGE, NEED IAL   @YM04848 18942402
         ST    GR9,C8(GR2)        PUT FIRST ENTRY INTO IAL     @YM04848 18953202
         LA    GR8,C8(GR2)        GET POINTER TO IAL LIST      @YM04848 18963202
         SLL   GR6,11             ADDR OF 1ST BYTE ON 1ST PAGE @YM06433 18965202
EXTLOOPR LA    GR6,D2048(GR6)     BUMP TO LAST BYTE THIS PAGE  @YM06433 18965602
         LA    GR8,C4(GR8)        BUMP TO NEXT IAL ENTRY       @YM04848 18966402
         LRA   GR9,C0(GR6)        REAL ADDR NEXT PAGE          @YM04848 18966502
         ST    GR9,C0(GR8)        STORE REAL ADDR IN NEXT IAL  @YM04848 18966602
         BCT   GR7,EXTLOOPR       LOOP TO TRANSLATE NEXT ENTRY @YM04848 18977702
         LRA   GR9,C8(GR2)        TRANSLATE ADDRESS OF IAL LIST@YM04848 18988102
         OI    C4(GR5),X'04'      SET IAL PRESENT TO READ CCW  @YM06433 18988502
EXTIALRD DS    0H                                              @YM06433 18988602
         STCM  GR9,C7,C1(GR5)     INSERT REAL ADDR OF IAL LIST @YM06433 18988702
         L     GR5,RDPTR1         LOAD RDPTR1                  @YM06433 18994502
         L     GR6,RDPTR2         LOAD ADDR OF READ COUNT      @YM06433 18997202
         LA    GR6,C8(GR6)        BUMP TO READ KEY/DATA        @YM06433 18999202
GENRET1  LRA   GR5,C0(GR5)        REAL ADDR OF NEXT READ COUNT @YM06433 19000702
         ICM   GR5,C8,CCW3        INSERT TIC OP CODE           @YM06433 19003402
         BR    GR0                     MODEL 91 CODE           @YM06433 19006102
*                                      (NOP USED TO INSURE ALL @YM06433 19008802
*                                       PREVIOUS INSTRUCTIONS  @YM06433 19011502
*                                       HAVE ALREADY BEEN      @YM06433 19014202
*                                       EXECUTED)              @YM06433 19016902
         ST    GR5,C8(GR0,GR6)         STORE TIC TO NEXT CCW   @YM06433 19019602
GENRETRN EQU   *                                                        19023202
         LM    GR0,GR8,PCISAVE    RESTORE REGS                   X010XX 19050000
         SR    GR9,GR9                 CLEAR 9 AS IT WAS USED           19100019
         BR    GR14               RETURN TO IOS                @YM06433 19200002
         SPACE 1                                                        19300019
SCANCOMP EQU   *                                                        19400019
         TM    STATUS,STAT2       READING OUTPUT DIR             A36049 19410000
         BZ    SCNCMP             NO                             A36049 19420000
         TM    TAG,CTOUT          COUNT DIRECTORY BLOCKS         A36049 19430000
         BZ    SCNCMP             NO                             A36049 19440000
         CLC   C8(C1,GR8),NDBTR   IS NDBTR >OR= TO 'R' OF THE    A36049 19450000
*                                 BLOCK JUST READ                A36049 19460000
         BNH   SCNCMP             YES                            A36049 19470000
         MVC   NDBTR(C1),C8(GR8)  NO, UPDATE NDBTR               A36049 19480000
SCNCMP   EQU   *                                                 A36049 19490000
         MVC   WKA1(C2),C10(GR8)       MOVE DATA LENGTH TO WORD BOUNDRY 19500019
         SR    GR9,GR9                                                  19600019
         IC    GR9,C9(GR0,GR8)         PICK UP KEY LENGTH               19700019
         LH    GR7,WKA1                DATA LENGTH IF ANY               19800019
         AR    GR7,GR9                 ADD KEY + DATA LENGTH            19900019
         SR    GR13,GR13                                                20000019
         LA    GR10,OUTCHAR            ADDRESS OF DEVTAB CONSTANTS      20100019
         USING DEVTAB,GR10             DEVICE CONSTANTS DSECT           20200019
         CLI   C8(GR8),X01             FIRST RECORD ON A TRACK R=1      20300019
         BNE   SAMETRKS                NO- CONTINUE ON TRACK            20400019
         MVC   OUTDS1+C4(C2),TRKCAP    REINITIALIZE TRACK SIZE          20600019
         SPACE 1                                                        20800019
SAMETRKS EQU   *                                                        20900019
         IC    GR13,OVERI              OVERHEAD NOT LAST RECORD         21000019
         TM    DEVFLAG,HALFOVER        TWO BYTE OVERHEAD FOR     S20201 21070020
*                                        THIS DEVICE             S20201 21140020
         BNO   NOTTWO1       NO,USE ONE BYTE                   @ZA11964 21210099
         SPACE 1                                                 S20201 21280020
         LH    GR13,OVERI              LOAD TWO BYTE OVERHEAD    S20201 21350020
NOTTWO1  OC    WKA1(C2),WKA1 IS DATA LENGTH ZERO (EOF)         @ZA11964 21357099
         BNZ   NOTTWO                  NO, GO ON                 S20201 21364020
         CLI   DEVCODE+3,X'08'    IS IT A 2314?                @ZA13751 21367099
         BE    NOTTWO             YES,DON'T ADD ONE BYTE       @ZA13751 21370099
         SPACE 1                                                 S20201 21371020
*  FOR I/O DEVICES WITH A TWO BYTE OVERHEAD VALUE, THE ONE BYTE  S20201 21378020
* OF DATA WRITTEN BY THE HARDWARE FOR AN EOF RECORD MUST BE      S20201 21385020
* INCLUDED IN TRACK BALANCE COMPUTATIONS                         S20201 21392020
         SPACE 1                                                 S20201 21399020
         LA    GR7,C1(GR0,GR7)         YES, ADD 1 TO KEYLEN PLUS S20201 21406020
*                                       DATA LENGTH FOR EOF      S20201 21413020
NOTTWO   EQU   *                                                 S20201 21420020
         SR    GR11,GR11               WILL HAVE KEY OVERHEAD IF ANY    21500019
         LTR   GR9,GR9                 ANY KEY                          21600019
         BNZ   AKEY                    YES                              21700019
         IC    GR11,OVERK              OVERHEAD IF RECORD WAS KEYED     21800019
AKEY     EQU   *                                                        21900019
         LH    GR12,OUTDS1+C4          GET BYTES UNUSED ON THIS TRK     22000019
         TM    DEVFLAG,TOLFAC          TOLERANCE FACTOR TO BE ADDED     22100019
         BZ    NOTOLER                 NO                               22200019
         MH    GR7,TOLER               MULTIPLY KL + DL BY TOLERANCE    22300019
         SRL   GR7,C9                  (KL + DL)*TOLERANCE/512          22400019
         SPACE 1                                                        22500019
NOTOLER  EQU   *                                                        22600019
         AR    GR7,GR13                ADD OVERHEAD                     22700019
         SR    GR7,GR11                SUBTRACT KEY OVERHEAD IF NO KEY  22800019
         SR    GR12,GR7                COMPUTE THE REMAINING BYTE       23000019
         STH   GR12,OUTDS1+C4          UPDATE TRK BAL FOR WSU           23070019
         L     GR7,CURRCCW1       VIRT ADDR OF READ COUNT      @YM06434 23120002
         STCM  GR7,C7,C1(GR5)     STORE IN RD CT OF NEXT CCW   @YM06434 23130002
         LA    GR7,C8(GR7)        VIRT ADDR OF READ K/D        @YM06434 23140002
         STCM  GR7,C7,C9(GR5)     STORE IN DR K/D OF NEXT CCW  @YM06434 23142002
         B     TESTCNTX                GO TEST FOR COUNT                23150019
         SPACE 1                                                        28200019
READDIR  EQU   *                                                        28300019
         TM    STATUS,STAT2       READING OUTPUT DIR             A36049 28307000
         BZ    RDDIR              NO                             A36049 28314000
         TM    TAG,CTOUT          COUNT DIRECTORY BLOCKS         A36049 28321000
         BZ    RDDIR              NO                             A36049 28328000
         CLC   C8(C1,GR8),NDBTR   IS NDBTR >OR= TO 'R' OF THE    A36049 28335000
*                                 BLOCK JUST READ                A36049 28342000
         BNH   RDDIR              YES                            A36049 28349000
         MVC   NDBTR(C1),C8(GR8)  NO, UPDATE NDBTR               A36049 28356000
RDDIR    EQU   *                                                 A36049 28363000
         LA    GR7,C276(GR0,GR8)       UP POINTERS FOR 1 MORE RECORD    28370019
         LA    GR10,C276(GR0,GR7)      NEXT RECORD CURRENT + 276        28440019
         TM    FLG7,DM                 MERGING DIRECTORY                28510019
         BZ    BUF2ND                  NO-ASSUME BUFFER NOT SPLIT       28520019
BUF1ST   EQU   *                                                        28530019
         C     GR10,ENDFST1            EXCEED END OF FIRST BUFFER       28540019
         BNH   READSMOR                NO-GET SOMEMORE                  28550019
         B     LASTRCB                 YES -MARK BUFFER FLAG            28560019
         SPACE 1                                                        28600019
BUF2ND   EQU   *                                                        28700019
         C     GR10,END2ND2            EXCEED END OF SECOND BUFFER      28800019
         BNH   READSMOR                NO                               28900019
         SPACE 1                                                        29000019
LASTRCB  EQU   *                                                        29100019
         MVI   C0(GR8),LASTREC+ENDPROC FLAG AS LASTREC + LAST BUFFER    29200019
         SPACE 1                                                        29400019
         TM    STATUS,STAT2            READING OUTPUT DIRECTORY         29700019
         BZ    SWAP                    NO, CHANGE POINTERS              29800019
         TM    TAG,CTOUT               COUNT DIRECTORY BLOCKS           29900019
         BZ    SWAP                    NO, CHANGE POINTERS              30000019
         LH    GR7,DIRBCNT                                              30100019
         LA    GR7,C1(GR0,GR7)         UPDATE COUNT                     30200019
         STH   GR7,DIRBCNT                                              30300019
         B     SWAP                    CHANGE POINTERS                  30500019
         SPACE 1                                                        30700019
READSMOR EQU   *                                                        30800019
         MVI   C0(GR8),C0              CLEAR FLAG FIELD                 30900019
         LR    GR8,GR7                 START NEXT RECORD                31000019
NEWBUFR  EQU   *                                                        31100019
*        KEEP  GR8 POINTING TO START OF RECORD IN BUFFER                31200019
         LA    GR11,C4(GR0,GR8)        PASS FLAG + MBB TO COUNT CCHHR   31300019
         STCM  GR11,C7,C1(GR5)    SET RDPTR2 ADDR FOR READ CNT @YM06433 31400002
         LA    GR11,C8(GR0,GR11)                                        31500019
         STCM  GR11,C7,C9(GR5)    SET RDPTR2 ADDR FOR READ K/D @YM06433 31550002
         TM    STATUS,STAT2            READING OUTPUT DIRECTORY         32000019
         BZ    RESETNOP                NO                               32100019
TESTCNTX EQU   *                                                        32200019
         TM    TAG,CTOUT               COUNT DIRECTORY BLOCKS           32300019
         BO    COUNTDR                 YES, GO BUMP COUNTER             32400019
         B     RESETNOP                RESET, SWAP, RETURN              32500019
         SPACE 1                                                        32600019
INMEMBR  EQU   *                                                        32700019
         SR    GR7,GR7                                                  32800019
         IC    GR7,C9(GR0,GR8)         KEY LENGTH OF MEMBER             32870019
         LR    GR10,GR7                SAVE KEY LENGTH                  32950019
         MVC   WKA1(C2),C10(GR8)       SAVE DATA LENGTH                 33020019
         AH    GR7,WKA1                ADD KEY + DATA LENGTH            33100019
         LA    GR7,C12(GR0,GR7)        COUNT + FLAG                     33200019
         AR    GR7,GR8                 LOCATION FOR NEXT RECORD         33300019
         AH    GR10,IBLKSIZE           BLOCKING FACTOR + KEY LN         33400019
         LA    GR10,C12(GR0,GR10)      COUNT + FLAG + MBB               33500019
         AR    GR10,GR7                END OF NEXT RECORD               33600019
         TM    FLG1,STOPEND1           ONLY CAN USE FIRST BUFFER        33700019
         BO    BUF1ST                  YES                              33800019
         TM    FLG1,P2FLG1             TWO BUFFERS                      33900019
         BZ    BUF2ND                  NO, USE END OF FIRST PAIR        34000019
         TM    FLG1,IN2ND              IN SECOND BUFFER                 34100019
         BO    BUF2ND                  YES                              34200019
         C     GR10,ENDFST1            EXCEED END OF FIRST BUFFER       34300019
         BNH   READSMOR                BUFFER NOT EXCEEDED NEXT READ    34400019
         MVI   C0(GR8),LASTREC         FLAG AS LAST RECORD THIS BUFFER  34500019
         L     GR8,BEGFST2             START OF SECOND BUFFER           34600019
         OI    FLG1,IN2ND              IN SECOND BUFFER FLAG SET        34700019
         B     NEWBUFR                 READ INTO NEXT BUFFER            34800019
         TITLE 'IGG019C8- WRITE PORTION OF PCI APPENDAGE'               34900019
*                                                                     * 35500019
*****      PCI HANDLER FOR WRITING   IGG019                   ********* 35600019
*                                                                     * 35800019
IGG019   EQU   *                                                        35900019
         TM    TAG,TAG6                VALIDITY CHECKING                36100019
         BO    VALCHK                  YES                              36200019
         MVI   WKA1+C1,C16             UPDATE INCREMENT FOR      S20201 36202020
*                                       VALID PCI INTERRUPT      S20201 36204020
*                                       TESTING - WRITE          S20201 36206020
         SPACE 1                                                 S20201 36210020
         L     GR5,WRPTR1              LOAD POINTER TO 'CURRENT' S20201 36220020
*                                        CCW CHAIN               S20201 36230020
         LA    GR7,C8(GR0,GR5)         FIND ACCEPTABLE LOWER     S20201 36240020
*                                        LIMIT OF CSW AT PCI     S20201 36250020
*                                        INTERRUPT               S20201 36260020
         BAL   GR9,PCIVALCK            CHECK FOR VALID CSW       S20201 36270020
         SPACE 1                                                 S20201 36280020
         LRA   GR11,C0(GR5)            TRANSLATE TO REAL        YL026VD 36290002
         STCM  GR11,C7,CCW3+C1         SET UP RESTART ADDRESS  @YM06433 36300002
         NI    C4(GR5),XF7             RESET PCI FOR RESTART   @YM06433 36580002
         L     GR6,CURRCCW1         GET ADDRESS OF LAST WRITE  @YM04848 36670002
         LA    GR6,C0(GR0,GR6)         CLEAR OP CODE                    36740019
         TM    TAG,TAG1                DIRECTORY                        36810019
         BZ    NOTDIRTY                NO-XFER                          36820019
         LA    GR7,C12                 GO TO                            36830019
         SR    GR6,GR7                 START OF BUFFER                  36840019
         MVC   LASTGB(C8),LASTGBSV     UPDATE LASTGB FIELD FOR USE      36842019
*                                        BY IEBIOE IF AN I/O ERROR      36844019
*                                        OCCURS                         36846019
         MVC   LASTGBSV(C8),LASTADDR   SAVE VALUE OF LASTADDR AT ENTRY  36848019
*                                        TO IGG019C8                    36850019
         MVC   IOBMCCHH(C8,GR2),LASTADDR MOVE THIS RECORD IN RESTART    36853019
         B     TESTBUF            SEE IF THIS IS THE LAST RECORD        36860019
NOTDIRTY EQU   *                                                        36870019
         LA    GR7,C4                                                   36930019
         SR    GR6,GR7                 BACK UP TO FLAG FIELD            37000019
         MVC   IOBMCCHH(C8,GR2),LASTADDR MOVE LAST REC WRITTEN ADDRESS  37080019
         MVC   LASTADDR(C8),C1(GR6)    THIS RECORD BEING WRITTEN        37160019
TESTBUF  EQU   *                                                        37250019
         TM    C0(GR6),ENDPROC+LASTREC VERY LAST RECORD                 37320019
         BZ    THISBUF                 NOT LAST RECORD IN ANY BUFFER    37400019
         BO    SWAPPTRS                YES                     @YM06433 37500002
         L     GR6,BEGFST2             GET START OF SECOND BUFFER       37600019
         B     RECADDRS                SET UP WRITE                     37700019
         SPACE 1                                                        37800019
THISBUF  EQU   *                                                        37900019
         MVC   WKA1(C2),C10(GR6)       SAVE DATA LENGTH                 38000019
         SR    GR9,GR9                                                  38100019
         IC    GR9,C9(GR0,GR6)         GET KEY LENGTH                   38200019
         AH    GR9,WKA1                ADD KEY + DATA LENGTH            38300019
         LA    GR9,C12(GR0,GR9)        ADD COUNT + FMBB LENGTH          38400019
         AR    GR6,GR9                 START OF NEXT RECORD             38500019
         SPACE 1                                                        38600019
RECADDRS EQU   *                                                        38700019
         MVC   WKA1(C2),C10(GR6)       SAVE DATA LENGTH                 38800019
         SR    GR9,GR9                                                  38900019
         IC    GR9,C9(GR0,GR6)         KEY LENGTH                       39000019
         AH    GR9,WKA1                ADD KEY + DATA LENGTH            39100019
         L     GR5,WRPTR2              NEXT CCW                         39200019
         TM    TAG,TAG1                WRITING DIRECTORY                39300019
         BO    WRTNOCT                 YES, WRITE ONLY KEY/DATA         39370019
         LA    GR9,C8(GR0,GR9)         COUNT LENGTH                     39440019
         LA    GR8,C4(GR0,GR6)         START OF COUNT NEXT RECORD       39510019
         B     STRCNT                  STORE ADDRESS AND COUNT          39600019
WRTNOCT  EQU   *                                                        39650019
         LA    GR8,C12(GR0,GR6)        START OF DIRECTORY KEY NEXT REC  39700019
STRCNT   EQU   *                                                        39750019
         STH   GR9,C6(GR0,GR5)         STORE COUNT FOR NEXT WRITE       39830019
         ST    GR8,C0(GR0,GR5)         WHERE TO WRITE RECORD FROM       39910019
         TM    C0(GR6),WRTOVR          OVERFLOW SEGMENT                 40000019
         BZ    REGWRT                  NO                               40090019
         MVI   C0(GR5),X01             WRITE SPECIAL OP CODE            40180019
         B     SETFLGS            GO SET OTHER INDICATORS               40300019
         SPACE 1                                                        40400019
REGWRT   EQU   *                                                        40500019
         TM    TAG,TAG1                WRITING DIRECTORY                40600019
         BZ    WRCKDOP                 NO, WRITE COUNT KEY DATA         40680019
         MVI   C0(GR5),X0D             WRITE KEY DATA OP CODE           40760019
         MVC   LASTADDR(C8),C1(GR6)    THIS RECORD BEING WRITTEN        40840019
         B     SETFLGS                 RESTORE NEXT CCWS                40920019
         SPACE 1                                                        41000019
WRCKDOP  EQU   *                                                        41100019
         MVI   C0(GR5),X1D             WRITE COUNT KEY DATA OP CODE     41400019
SETFLGS  EQU   *                                                        41700019
         MVI   C4(GR5),X68             RESTORE PCI                      41800019
         LRA   GR8,C16(GR0,GR5)       LOAD POINTER TO STOP CCW @YM06433 41830002
         ST    GR8,C8(GR0,GR5)         STORE IN TIC CCW SLOT     S20201 41860020
         MVI   C8(GR5),X08             RESTORE TIC OP CODE              41890020
* SET UP TIC FROM SIDEQ,MT TO NEXT WRITE WHETHER NEEDED OR NOT @YM06433 41900002
         L     GR8,WRPTR2         GET ADDR OF NEXT WRITE CCW   @YM06433 41910002
         LA    GR8,C0(GR8)        CLEAR HIGH ORDER BYTE        @YM06433 41920002
         LRA   GR8,C0(GR8)        TRANSLATE TO REAL            @YM06433 41930002
         STCM  GR8,C7,WSCH2+C1    STORE IN SIDEQ,MT TIC FORWD  @YM06433 41932002
*        NOP OR RS WILL STOP EXECUTION IF PCI MISSED             S20201 41940020
         LA    GR8,WSCH                PTR TO SID M/T CCW        S20201 41980020
         ST    GR8,WRTICPTR          SAVE TO SET UP PROPER TIC @YM06433 41990002
         TM    TAG,TAG1                WRITING DIRECTORY         S20201 42010020
         BO    SWAPPTRS                YES, LEAVE R ALONE      @YM06433 42040002
         CLI   C8(GR6),X01             NEXT RECORD R1, IF SO     S20201 42070020
*                                        ON NEXT TRACK           S20201 42100020
         BNE   SAMETRK                 NO                        S20201 42130020
         MVC   LASTADDR(C8),C1(GR6)    THIS RECORD TO BE WRITTEN        42210019
         MVI   LASTADDR+C7,C0          MAKE R=0 FOR HEAD SWITCH         42250019
         B     SWAPPTRS                SET UP REST OF CCWS     @YM06433 42400002
         SPACE 1                                                        42900019
SAMETRK  EQU   *                                                        43000019
         L     GR8,WRPTR2              CCW TO START WITH                43100019
         ST    GR8,WRTICPTR          SAVE TO SET UP PROPER TIC @YM06433 43150002
         SPACE 1                                                        43800019
SWAPPTRS EQU   *                                                        43900019
         L     GR9,WRPTR1              CCW JUST USED           @YM06433 43950002
         L     GR8,WRPTR2              CCW TO START WITH                44000019
         STM   GR8,GR9,WRPTR1          SWAP POINTERS                    44100019
         LR    GR9,GR6            SAVE ADDRESS OF FLAG FIELD   @YM06433 44100402
         TM    TAG,TAG1           WRITING DIRECTORY            @YM06433 44102402
         BZ    DOINGMEM           NO, WRITING MEMBER           @YM06433 44104402
         LA    GR6,C8(GR6)        BUMP FOR SKIPPED COUNT FIELD @YM06433 44106402
DOINGMEM LA    GR6,C4(GR6)             BUMP TO COUNT FIELD     @YM06433 44110002
         L     GR7,CURRCCW1                                    @YM04848 44150002
         STM   GR6,GR7,CURRCCW1                                @YM04848 44170002
         L     GR2,IALPTR2                                     @YM06433 44180002
         L     GR3,IALPTR1                                     @YM06433 44190002
         STM   GR2,GR3,IALPTR1         SWAP IAL LIST POINTERS  @YM06433 44192002
         TM    C0(GR9),ENDPROC+LASTREC VERY LAST RECORD                 44193202
         BO    GENRETRN   DONT TRANSLATE OR SET TIC, RETURN    @YM06433 44195502
         SPACE 1                                                        44195702
         TM    AOS,PCI       IF PCI BIT OFF, DONT TRANSLATE OR @YM04451 44195902
         BZ    WASVIO        TIC, BUT UPDATE PCI COUNTS        @YM04451 44196102
         SPACE 1                                                        44196302
*                                                                       44196702
* AT THIS POINT, WRPTR1 (GR8) POINTS AT NEXT CCW STRING TO BE  @YM06433 44197902
* TRANSLATED, CURRCCW1 (GR6) CONTAINS THE NEXT VIRTUAL DATA    @YM06433 44199102
* ADDRESS, AND IOBVRPTR+8 (GR2) CONTAINS THE ADDRESS OF THE    @YM06433 44200302
* ASSOCIATED INDIRECT ADDRESS LIST                             @YM06433 44201502
*                                                                       44202702
         NI    C4(GR8),X'FF'-X'04' SET IAL LIST NOT PRESENT    @YM06433 44203902
         LRA   GR9,C0(GR6)        TRANSLATE DATA ADDR TO REAL  @YM06433 44205102
         LA    GR6,C0(GR6)        CLEAR HIGH ORDER BYTE        @YM06433 44206302
         LR    GR7,GR6            VIRTUAL DATA ADDRESS         @YM06433 44207502
         AH    GR7,C6(GR8)        ADD LENGTH OF READ           @YM06433 44208702
         BCTR  GR7,C0                                                   44209902
         SRL   GR6,11             STARTING PAGE NUMBER         @YM06433 44233202
         SRL   GR7,11             ENDING PAGE NUMBER           @YM06433 44243202
         SR    GR7,GR6            IF MORE THAN 1 PAGE NEED IAL @YM06433 44253202
         BZ    EXTIALWR           BRANCH IF ONLY ONE PAGE      @YM06433 44263202
         ST    GR9,C8(GR2)        PUT FIRST ENTRY INTO IAL     @YM06433 44266502
         LA    GR3,C8(GR2)        GET POINTER TO IAL LIST      @YM06433 44266602
         SLL   GR6,11             ADDR OF 1ST BYTE ON 1ST PAGE @YM06433 44277702
EXTLOOPW LA    GR6,D2048(GR6)     ADDR OF LAST BYTE THIS PAGE  @YM06433 44287702
         LA    GR3,C4(GR3)        BUMP TO NEXT IAL ENTRY       @YM06433 44288502
         LRA   GR9,C0(GR6)        REAL ADDR OF NEXT PAGE       @YM06433 44288602
         ST    GR9,C0(GR3)        STORE REAL ADDR IN NEXT IAL  @YM06433 44288702
         BCT   GR7,EXTLOOPW       LOOP TO TRANSLATE NEXT ENTRY @YM06433 44288802
         OI    C4(GR8),X'04'      SET IAL PRESENT INTO WRT CCW @YM06433 44290802
         LRA   GR9,C8(GR2)        TRANSLATE ADDR OF IAL LIST   @YM06433 44294502
EXTIALWR STCM  GR9,C7,C1(GR8)     INSERT REAL ADDR OF IAL LIST @YM06433 44295302
         SPACE 1                                                        44296302
         MVC   C16(C4,GR8),RSECTOR PUT VIRT ADDR IN NEXT NO-OP @YM06435 44298302
         L     GR5,WRTICPTR       ADDR OF CCW TO WHICH TO TIC  @YM06433 44306302
         L     GR6,WRPTR2         ADDR OF CURRENT WRT C/K/D    @YM06433 44308302
         CLI   C0(GR6),X01             WAS OP CODE OF CCW JUST @YM06433 44310002
*                                       EXECUTED A WRITE SPECIAL A35473 44320021
*                                       C/K/D                    A35473 44330021
         BE    GENRET1                 YES, DON'T INCREMENT    @YM06433 44340002
*                                        COUNTER                 A35473 44350021
         L     GR9,WRPCICNT            PCI COUNT               @YM06433 44400002
         LA    GR9,C1(GR0,GR9)                                 @YM06433 44500002
         ST    GR9,WRPCICNT            UPDATE PCI COUNT        @YM06433 44600002
         B     GENRET1                 RETURN TO IOS           @YM06433 44700002
         SPACE 1                                                        44707002
WASVIO   EQU   *                                               @YM04451 44714002
         MVC   C16(C4,GR8),RSECTOR PUT VIRT ADDR IN NEXT NO-OP @YM04451 44721002
         L     GR6,WRPTR2         ADDR OF CURRENT WRT C/K/D    @YM04451 44728002
         CLI   C0(GR6),X01             WAS OP CODE OF CCW JUST @YM04451 44735002
*                                       EXECUTED A WRITE       @YM04451 44742002
*                                       SPECIAL C/K/D          @YM04451 44749002
         BE    GENRETRN                YES, DON'T INCREMENT    @YM04451 44756002
*                                        COUNTER               @YM04451 44763002
         L     GR9,WRPCICNT            PCI COUNT               @YM04451 44770002
         LA    GR9,C1(GR0,GR9)                                 @YM04451 44777002
         ST    GR9,WRPCICNT            UPDATE PCI COUNT        @YM04451 44784002
         B     GENRETRN                RETURN TO IOS           @YM04451 44791002
         EJECT                                                          44800002
VALCHK   EQU   *                       READ BACK VALIDITY CHECKING      44900019
         SPACE 1                                                 S20201 44910020
         L     GR6,RDCKPTR1            LOAD POINTER TO 'CURRENT' S20201 44920020
*                                        CCW CHAIN               S20201 44930020
         LA    GR7,C16(GR0,GR6)        FIND ACCEPTABLE LOWER     S20201 44940020
*                                        LIMIT OF CSW AT PCI     S20201 44950020
*                                        INTERRUPT               S20201 44960020
         BAL   GR9,PCIVALCK            CHECK FOR VALID CSW       S20201 44970020
         SPACE 1                                                 S20201 44980020
         L     GR7,RDCKPTR1                                             45100019
         LA    GR5,C8(GR0,GR7)    GET PTR TO RKD CCW             A34092 45120002
         LRA   GR9,C0(GR5)        GET REAL ADDR OF RD K/D CCW  @YM06448 45130002
         STCM  GR9,C7,CCW3+C1     STORE IN TIC CCW             @YM06433 45140002
         MVC   IOBCCHHR(C5,GR2),LASTADDR  UPDATE IOB SEEK ADDR   A34092 45180020
         NI    C12(GR7),XF7            RESET PCI               @YM06433 45200002
         L     GR9,WRPCICNT            RECORD COUNT                     45300019
         BCTR  GR9,GR0                 DECREMENT BY 1                   45370019
         ST    GR9,WRPCICNT            STORE DECREMENTED COUNT          45450019
         LTR   GR9,GR9                 DID LAST RECORD (COUNT = ZERO)   45500019
         BNP   GENRETRN           YES,GET OUT                   OY01184 45700002
         L     GR6,RDCKPTR2                                    @YM06433 45900002
         MVI   C12(GR6),X78            RESTORE PCI             @YM06433 46000002
         MVC   C16(C4,GR6),RSECTOR     REPLACE NOP WITH RS CCW   S20201 46018002
NOTRPS4  EQU   *                                                 S20201 46024020
         STM   GR6,GR7,RDCKPTR1                                         46200002
         TM    AOS,PCI            IF PCI BIT OFF, DONT         @YM04451 46210002
         BZ    GENRETRN           TRANSLATE OR TIC, RETURN     @YM04451 46220002
         L     GR5,RDCKPTR1       GET ADDRESS OF NEXT CCW      @YM06433 46250002
         L     GR6,RDCKPTR2       GET ADR READ COUNT, CURR CCW @YM06433 46260002
         MVC   C1(C3,GR5),C1(GR6)     MOVE REAL ADDRESS IN CCW @YM06434 46280002
         MVC   C9(C3,GR5),C9(GR6)     MOVE REAL ADDRESS IN CCW @YM06434 46282002
         LA    GR6,C8(GR6)        BUMP TO READ KEY/DATA ADDR   @YM06433 46290002
         B     GENRET1                PRE-RETURN TO IOS                 46300002
         EJECT                                                   S20201 46304020
**************************************************************** S20201 46308020
*                                                              * S20201 46312020
*    THIS ROUTINE IS USED TO MAKE SURE THAT IF A CCW WITH THE  * S20201 46316020
*  PCI FLAG ON IS EXECUTED VIA COMMAND RETRY, THE INTERRUPT    * S20201 46320020
*  WILL BE IGNORED                                             * S20201 46324020
*                                                              * S20201 46328020
**************************************************************** S20201 46332020
         SPACE 2                                                 S20201 46336020
PCIVALCK EQU   *                                                 S20201 46340020
         L     GR8,CSW(GR0,GR2)        LOAD CSW                 YL026VD 46344002
         LA    GR8,C0(GR0,GR8)         CLEAR HIGH ORDER BYTE     S20201 46348020
         CR    GR8,GR7                 CSW LESS THAN LOWER LIMIT S20201 46352020
         BL    GENRETRN                YES, IGNORE THIS PCI      S20201 46356020
         AH    GR7,WKA1                FIND ACCEPTABLE UPPER     S20201 46360020
*                                        LIMIT OF CSW AT PCI     S20201 46364020
*                                        INTERRUPT               S20201 46368020
         CR    GR8,GR7                 CSW GREATER THAN UPPER    S20201 46372020
*                                        LIMIT                   S20201 46376020
         BH    GENRETRN                YES, IGNORE THIS PCI      S20201 46380020
         BR    GR9                     RETURN, EVERYTHING IS OK  S20201 46384020
         EJECT                                                          46400019
ID       DC    CL8'IGG019C8'      APPENDAGE ID                          46600019
OVERFLOW EQU   X'20'                   SETTING FOR OVERFLOW DEVICE DCB  46700019
         DS    0F                 FULL WORD ALIGNMENT                   46780019
PATCHLEN EQU (*-IGG019C8)/20      5 PER CENT PATCH AREA LENGTH          46860019
PATCH    DC    XL(PATCHLEN)'00'   5 PER CENT PATCH AREA          A41780 46940000
         DS    0D                 DOUBLE WORD ALIGNMENT                 47020019
         DCBD  DSORG=PS                                                 47100019
         EJECT                                                          47200019
IEBMCA   DSECT                                                          47300019
         IEBMCA                                                         47400019
         EJECT                                                          47500019
IECDSECT DSECT                                                          47600019
         IECDSECT                                                       47700019
IOBMCCHH EQU   DXDAADDR-DXIOB          MBBCCHHR FIELD IN IOB            47800019
IOBCCHHR EQU   DXDAADDR-DXIOB+3        CCHHR FIELD IN IOB               47900019
IOBMCCHR EQU   DXDAADDR-DXIOB+7        RECORD FIELD IN IOB              48000019
DCB4IOB  EQU   IOBDCBPT-DXIOB-1        POINTER TO DCB IN IOB            48100019
DEB      EQU   DXDEB                   REFERENCE START OF DEB           48200019
DEBEXSCL EQU   DXDEBAPP                EXTENT SCALE (4 FOR DA)          48300019
DEBSTRCC EQU   DXDEBSCC                CCHH START OF AN EXTENT          48400019
DEBENDHH EQU   DXDEBEHH                END OF AN EXTENT HH              48450019
DISKADR  EQU   DCBFDAD-IHADCB          FDAD IN DCB (MBBCCHHR)           48500019
         SPACE 1                                                        48600019
DEVTAB   DSECT                                                          48700019
*                                                                       48800019
*     DIRECT ACCESS DEVICE TABLE OVERLAY  OUTCHAR IN IEBMCA           * 48900019
*                                                                     * 49000019
DEVCODE  DS    F                       DEVICE CODE FROM UCB           * 49100019
MAXSIZE  DS    F                       MAXIMUM SIZE UNKEYED BLOCK     * 49200019
MAXCC    DS    H                       NUMBER OF CYLINDER             * 49300019
MAXHH    DS    H                       NUMBER OF TRACKS               * 49400019
TRKCAP   DS    H                       MAXIMUM TRACK LENGTH           * 49500019
OVERI    DS    XL1                     OVERHEAD NOT LAST RECORD       * 49600019
OVERL    DS    XL1                     OVERHEAD LAST RECORD           * 49700019
OVERK    DS    XL1                     OVERHEAD REDUCTION FOR NON-KEY * 49800019
DEVFLAG  DS    XL1                     APPLY TOLERANCE FACTOR NOT LAST* 49900019
TOLER    DS    H                       GAP LENGTH CALCULATE TOLERANCE * 50000019
TOLFAC   EQU   X'01'                   TOLERANCE FACTOR TO BE ADDED   * 50100019
HALFOVER EQU   X'08'                                             S20201 50150020
*                                                                     * 50200019
*       END OF DEVTAB OVERLAY                                         * 50300019
*                                                                     * 50400019
         SPACE 1                                                        50500019
         END                                                            50600019
