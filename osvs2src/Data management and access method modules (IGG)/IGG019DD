         TITLE 'IGG019DD-WRITE FORMAT F,TRACK OVERFLOW,LOAD MODE'       00004020
IGG019DD CSECT                                                          00008020
*MODULE NAME = IGG019DD                                               * 00010002
*                                                                     * 00010402
*DESCRIPTIVE NAME = BDAM CREATE WRITE MODULE, FIXED TRACK OVERFLOW    * 00010802
*                                                                     * 00011202
*COPYRIGHT = NONE                                                     * 00011602
*                                                                     * 00011702
*CHANGE ACTIVITY                                                      * 00011802
*                                                                     * 00012002
*        RELEASE 20 CHANGES/DELETIONS                                   00048002
*0000042023-042030,042050-042100                                 M6477  00048520
*0000020200,020400,026100-026200,056100-056200,063400,066260,    M5894  00049020
*0000066330,082200,085200,089800                                 M5894  00050020
*0832026200,056200,082200,089800                                 A33537 00052020
*0832000160-000240,000560-000800,049800,058400,061000-061200     S20201 00054020
*0000042030                                                      M5313  00064020
*0000                                                            M6283  00074020
*        RELEASE 21 CHANGES/DELETIONS                                   00076002
*1390                                                            M0169  00078002
*        VS1-1 CHANGES/DELETIONS                                        00080002
*        VS2-1 CHANGES/DELETIONS                                        00082002
*        VS1-2 CHANGES/DELETIONS                                        00082402
*        VS2-2 CHANGES/DELETIONS                                        00082802
*025060,091400-091800                                            Y02072 00083202
*                                                                YM3919 00083302
*                                                                YM6555 00083402
*                                                                YM7563 00083502
*                                                                       00083602
*        VS2-3 CHANGES/DELETIONS                                        00083702
*A042078-042213                                                 ZA01362 00083802
*        UPDATES TO VS2-3                                               00084000
*A086260,086320                                                 ZA07617 00087000
*STATUS CHANGE LEVEL 003                                                00090000
*                                                                       00094002
*FUNCTIONS- THIS ROUTINE OBTAINS AN IOB, INITIALIZES THE CHANNEL        00100020
*    PROGRAM, AND ISSUES THE 'EXCP' FOR A WRITE TYPE SF OR SD TO A      00120020
*    FORMAT 'F' DATA SET WITH THE TRACK OVERFLOW OPTION SPECIFIED.      00140020
*    IF THE BLOCK WILL NOT FIT ON THE CURRENT TRACK, IT WILL BE         00160020
*    SEGMENTED AS MANY TIMES AS ARE REQUIRED TO COMPLETELY WRITE THE    00180020
*    BLOCK.                                                             00200020
*    CAPACITY RECORDS WILL BE WRITTEN AS EACH TRACK IS FILLED.          00220020
*                                                                       00240020
*    PRIOR TO WRITING THE FIRST BLOCK IN AN ALLOCATED EXTENT, A TEST IS 00260020
*    MADE FOR TRACKS AT THE END OF THE PREVIOUS EXTENT WHICH COULD NOT  00280020
*    BE USED AND MUST BE ERASED. IF THERE ARE UNUSED TRACKS THEY ARE    00300020
*    ERASED BY A COMMON SEQUENCE OF CCWS EXECUTED AS A SEPARATE REQUEST 00320020
*    AND WHEN THAT REQUEST COMPLETES, THE NEW BLOCK WILL BE WRITTEN.    00340020
*                                                                       00360020
*ENTRY POINTS- 'WRTENTRY' IS THE NORMAL ENTRY POINT FROM THE WRITE      00380020
*    MACRO EXPANSION. CALLING SEQUENCE IS     L     15,DCBWRITE         00400020
*                                             BALR  14,15               00420020
*    'EOVENTRY' IS THE ENTRY FROM THE BSAM END-OF-VOLUME EXECUTOR TO    00440020
*    RESTART A WRITE WHICH WAS ISSUED AFTER THE CURRENT SPACE           00460020
*    ALLOCATION WAS FILLED. THE RECORD WILL NOW BE WRITTEN INTO THE     00480020
*    SPACE OBTAINED AS SECONDARY ALLOCATION. CALLING SEQUENCE IS        00500020
*                                              L    15,DCBWRITE         00520020
*                                              BAL  14,4(15)            00540020
*INPUT- TO 'WRTENTRY'- DECB ADDRESS IN REGISTER 1                       00560020
*       TO 'EOVENTRY'- IOB ADDRESS IN REGISTER 3                        00580020
*                      DCB ADDRESS IN REGISTER 2                        00600020
*                      DEB ADDRESS IN REGISTER 5                        00620020
*                                                                       00640020
*OUTPUT- AN IOB FROM THE POOL OF IOBS WILL BE ASSIGNED TO THIS DECB     00660020
*    AND ITS ADDRESS PLACED IN THE DECB, EXCP WILL BE ISSUED TO         00680020
*    SCHEDULE THIS WRITE.                                               00700020
*                                                                       00720020
*EXTERNAL ROUTINES-                                                     00740020
*                                                                       00760020
*EXITS- 'RETURN' IS AN EXIT BACK TO THE USER, REGISTER 15 WILL CONTAIN  00780020
*    A RETURN CODE AS FOLLOWS,                                          00800020
*        0 = RECORD WAS WRITTEN, THERE IS MORE SPACE ON THE TRACK       00820020
*        8 = RECORD WAS WRITTEN, DATA SET IS FILLED                     00840020
*        12= RECORD NOT WRITTEN, NO IOB IS AVAILABLE UNTIL 'CHECK' HAS  00860020
*            BEEN ISSUED.                                               00880020
*    'EOVEXIT' IS A RETURN TO THE END-OF-VOLUME EXECUTOR.               00900020
*                                                                       00905020
*ERROR EXITS-                                                           00910020
*   DMABCOND MACRO IS ISSUED TO TRANSFER CONTROL TO PROBLEM DETER-      00915002
*   MINATION WHEN BLOCK DOES NOT FIT ON SECONDARY EXTENT OR CURRENT     00917002
*   EXTENT.  THE PROBLEM DETERMINATION MODULES WILL ISSUE A WTP MESSAGE 00919002
*   AND GTRACE PERTINENT CONTROL BLOCKS BEFORE ISSUING A 002 ABEND.     00919402
*   THE RETURN CODE ACCOMPANYING THE ABEND WILL IDENTIFY THE EXACT      00919802
*   CAUSE OF THE ERROR.                                                 00919902
*                                                                       00920020
*TABLES- 1. DIRECT ACCESS DEVICE TABLE IS USED TO CALCULATE THE BYTES   00940020
*           OF OVERHEAD FOR THIS RECORD AND TO DETERMINE THE NEXT       00960020
*           VALID TRACK ADDRESS AND THE TRACK LENGTH.                   00980020
*                                                                       01000020
*ATTRIBUTES- THIS ROUTINE IS REENTRANT AND EXECUTED ENABLED.            01020020
*                                                                       01040020
*NOTES- THE REGISTER USAGE IN THIS MODULE AND THE BSAM END-OF-VOLUME    01060020
*    EXECUTOR MUST REMAIN CONSISTENT.                                   01080020
*                                                                       01100020
*                                                                       01120020
*  REGISTER USAGE                                                       01140020
*                                                                       01160020
         USING IGG019DD,EPREG                                           01180020
         USING IHADCB,DCBREG                                            01200020
         USING IOBDEF,IOBREG                                            01220020
         USING DEB,DEBREG                                               01240020
         USING DECBDEF,DECBREG                                          01260020
*                                                                       01280020
WKREG    EQU   0         WORK REGISTER                                  01300020
CCHH     EQU   0                                                        01320020
PARAM1   EQU   1         PARAMETER REGISTER                             01340020
DECBREG  EQU   1         DECB ADDRESS                                   01360020
DCBREG   EQU   2         DCB ADDRESS                                    01380020
IOBREG   EQU   3         IOB ADDRESS                                    01400020
EOVRETRN EQU   4         EOV RETURN ADDRESS                             01420020
DEBREG   EQU   5         DEB ADDRESS                                    01440020
WKREG1   EQU   6         WORK REGISTERS                                 01460020
WKREG2   EQU   7                                                        01480020
WKREG3   EQU   8                                                        01500020
WKREG4   EQU   9                                                        01520020
WKREG5   EQU   10                                                       01540020
WKREG6   EQU   11                                                       01560020
BASE     EQU   12        BASE OF THIS MODULE                            01580020
SAVE     EQU   13        USER'S SAVE AREA                               01600020
RETREG   EQU   14        RETURN ADDRESS WHEN ENTERED                    01620020
EPREG    EQU   15        ENTRY POINT                                    01640020
*                                                                       01660020
*                                                                       01680020
*                                                                       01700020
*                                                                       01720020
*  ENTRY POINTS TO THIS ROUTINE                                         01740020
*                                                                       01760020
WRTENTRY B     BEGIN                   GO TO BEGINNING OF WRITE CODE    01780020
*                                                                       01800020
         DROP  EPREG                                                    01820020
         USING IGG019DD,BASE                                            01840020
*                                                                       01860020
EOVENTRY L     DECBREG,IOBECBPT        LOAD DECB BASE ADDRESS           01880020
         TM    DCBCIND1,VOLFUL          IS THE VOLUME FULL       M5894  01886020
         BCR   1,RETREG                 YES,RETURN TO EOV        M5894  01892020
         L     BASE,DCBWRITE           SET BASE REGISTER                01900020
         LR    EOVRETRN,RETREG         MOVE RETURN TO EOV ADDRESS       01920020
         SR    WKREG2,WKREG2           SET INDEX TO THE CURRENT EXTENT  01940020
         IC    WKREG2,DCBFDAD           IN THE DEB                      01960020
         SLL   WKREG2,4                                                 01980020
         AR    WKREG2,DEBREG                                            02000020
         L     EPREG,DCBDVTBL           LOAD POINTER TO DEVICE   M5894  02005020
*                                       CHAR                     M5894  02010020
         LH    WKREG,DEBNMTRK-DEB(0,WKREG2) GET NO. TRKS IN EXT  M5894  02015020
         MH    WKREG,TRKL(0,EPREG)   MULTIPLY NO. BY TRK LENGTH  M5894  02020020
         CH    WKREG,DCBOFFSR           WILL BLK FIT ON EXTENT?  M5894  02025020
         BL    ABENDSEC                 NO, ABEND WITH 002       Y02072 02030002
*                                       SECONDARY EXT TOO SMALL  Y02072 02032002
         OI    IOBLINK,EOVRET           SET BIT FOR EOV ENTRY    YM6555 02034002
         TM    DCBCIND1,VOLFUL          IS THIS EXTENT FULL YET  YM7563 02034402
         BO    EOVON                    YES,SET EOVFULL BIT &RET YM7563 02034802
         B     BOTHENT                  BRANCH TO COMMON ROUTINE M5894  02035020
*                                                                       02060020
*                                                                       02080020
BEGIN    SAVE  (14,12)                 SAVE THE USER'S REGISTER         02100020
         L     DCBREG,DECDCBAD         LOAD DCB BASE ADDRESS FROM DECB  02120020
         L     DEBREG,DCBDEBAD         LOAD DEB BASE ADDRESS FROM DCB   02140020
         LR    BASE,EPREG              MOVE ENTRY POINT TO BASE REG.    02160020
*                                                                       02180020
         L     IOBREG,DCBIOBA          USE CURRENT IOB TO LOCATE THE    02200020
         TM    DCBCIND2,CLOSEDCB        DID WE ENTER FROM CLOSE  S20201 02205020
         BO    LDBLKSI                  IF SO, GO INIT SOME      S20201 02210020
*                                       THINGS                   S20201 02215020
         L     IOBREG,IOBLINK           NEXT IOB ADDRESS                02220020
         TS    IOBLINK+4               IF NEXT IOB IS AVAILABLE         02240020
         BC    8,OKIOB                  GO INITIALIZE IT                02260020
*                                      ELSE RETURN WITH ERROR CODE 12   02280020
         LA    15,12                                                    02300020
         B     RETURN                                                   02320020
*                                                                       02340020
*                                                                       02360020
OKIOB    ST    IOBREG,DCBIOBA          STORE CURRENT IOB ADDRESS IN DCB 02380020
         LA    WKREG1,8(0,IOBREG)      STORE IOS IOB ADDRESS IN         02400020
         ST    WKREG1,DECIOBPT          THE DECB                        02420020
         ST    DECBREG,IOBECBPT        STORE DECB ADDRESS IN IOB        02440020
         TM    DCBCIND1,VOLFUL         IS VOLUME FULL            M5894  02446020
         BO    EOVON                IF YES GO TO TURN ON BIT     M5894  02452020
BOTHENT  EQU   *                                                        02460020
         L     EPREG,DCBDVTBL          LOAD POINTER TO DEVICE CHAR.     02480020
*                                                                       02500020
         L     WKREG4,IOBSTART          POINT TO FIRST CCW       S20201 02501020
         CLI   0(WKREG4),SETSECT        IS IT AN RPS COMMAND     S20201 02502020
         BNE   NOTRECR                  NO, SKIP MOVING SECTOR   S20201 02503020
*                                       BYTE                     S20201 02504020
         L     WKREG4,D0(WKREG4)        PT TO SECTOR BYTES       S20201 02505020
         TM    DCBCIND2,WZEROBIT        DID LAST WRITE PUT OUT   S20201 02507020
*                                       REC ZERO TOO                    02508020
         BNO   NOTRECR                  NO, LEAVE SECTOR VALUEAS S20201 02509020
*                                       IS                       S20201 02510020
         MVI   D0(WKREG4),D0            INITIALIZE SECTOR VALUE  S20201 02511020
*                                        ZERO                           02512020
NOTRECR  EQU   *                                                 S20201 02513020
         TM    DCBCIND2,WZEROBIT       DID LAST WRITE FILL A TRACK      02520020
         BZ    MVCSRCH                  NO, CONTINUE ON THIS TRACK      02540020
         XI    DCBCIND2,WZEROBIT         YES,TURN OFF R0 FLAG    A30241 02550020
         BAL   RETREG,WZEROFF           YES, GO INCREMENT TRACK NUMBER  02560020
*                                                                       02580020
MVCSRCH  MVC   IOBSEEK,DCBFDAD         MOVE DCB TRACK ADDRESS TO IOB    02600020
         TM    DCBCIND1,ERASEBIT       ARE THERE UNUSED TRACKS   M5894E 02610020
*                                       TO ERAS                  M5894  02620020
         BC    1,ERSRTN                 YES, GO BUILD ERASE REQUEST     02640020
*                                                                       02660020
*                                                                       02680020
         L     WKREG4,DECAREA          LOAD AREA START ADDRESS          02700020
         IC    WKREG2,DCBFDAD+7        INCREMENT BLOCK ID (R) OF        02720020
         LA    WKREG2,1(0,WKREG2)       DCB ADDRESS                     02740020
         STC   WKREG2,DCBFDAD+7                                         02760020
*                                                                       02780020
         SR    WKREG3,WKREG3           ZERO REGISTER                    02800020
         IC    WKREG3,DCBKEYLE          INSERT KEY LENGTH               02820020
         LTR   WKREG3,WKREG3            AND TEST FOR ZERO               02840020
         BZ    LDBLKSI                 IF NO KEYS, SKIP WRITE DUMMY TST 02860020
*                                                                       02880020
*                                                                       02900020
         TM    DECTYPE+1,DUMMY         THIS A WRITE DUMMY               02920020
         BZ    LDBLKSI                  NO                              02940020
         MVI   0(WKREG4),X'FF'          YES, SET FIRST BYTE OF KEY TO 1 02960020
         STC   WKREG2,0(WKREG4,WKREG3)   FIRST BYTE OF DATA TO BLOCK ID 02980020
*                                                                       03000020
LDBLKSI  LH    WKREG5,DCBBLKSI         INITIALIZE DATA FIELD LENGTH     03020020
         LA    WKREG1,IOBDNRCF         SET COUNT FIELD INDEX            03040020
         L     WKREG6,IOBSTART          AND CCW INDEX                   03060020
*                        WKREG1 = COUNT FIELD INDEX                     03080020
*                        WKREG4 = AREA ADDRESS                          03100020
*                        WKREG5 = TOTAL BYTES OF DATA TO BE WRITTEN     03120020
*                        WKREG6 = CCW INDEX                             03140020
MVCAREA  EQU   *                                                        03160020
         L     WKREG2,IOBSTART          POINT TO FIRST CCW       S20201 03162020
         CLI   D0(WKREG2),SETSECT       IS 1ST CCW AN RPS CCW    S20201 03164020
         BNE   NOTCARN                  NO, SKIP UPDATING THE    S20201 03166020
*                                       PTR                      S20201 03168020
         LA    WKREG6,ONECCW(0,WKREG6)  ELSE UPDATE PTR OVER SET S20201 03170020
*                                       SECT                     S20201 03172020
NOTCARN  EQU   *                                                 S20201 03174020
         TM    DCBCIND2,CLOSEDCB        DID WE ENTER FROM CLOSE  S20201 03176020
         BO    WRTR0                    GO WRITE OUT REC 0       S20201 03178020
         ST    WKREG4,CCW4(0,WKREG6)   STORE ADDR INTO WRITE CCW        03180020
         MVI   CCW4(WKREG6),WRTCKD      RESET THE OP-CODE               03200020
*                                                                       03220020
         SR    WKREG,WKREG             CLEAR WORK REGISTERS             03240020
         SR    WKREG2,WKREG2                                            03260020
         SR    WKREG3,WKREG3                                            03280020
         IC    WKREG3,DNRCF+5(0,WKREG1) INSERT KEY LENGTH FOR THIS SEG. 03300020
         IC    WKREG,OVERK(0,EPREG)     AND O'HEAD FOR KEYS             03320020
         LTR   WKREG3,WKREG3           IS A KEY BEING WRITTEN           03340020
         BZ    NOKEYS                   NO, LET O'HEAD SUB. FROM TOTAL  03360020
         SR    WKREG,WKREG              YES, ZERO AMOUNT TO BE SUB.     03380020
NOKEYS   EQU   *                    DEVELOP BYTES REQUIRED FOR LAST RCD 03400020
         IC    WKREG2,OVERL(0,EPREG)                                    03420020
         TM    BYTEDEV(EPREG),TBOVHD    TWO BYTE OVERHEAD USED   S20201 03424020
         BNO   MZ0010                   BRANCH NO                S20201 03428020
         LH    WKREG2,OVERI(EPREG)      IF YES GET TWO BYTE      S20201 03432020
MZ0010   EQU   *                                                 S20201 03436020
         SR    WKREG2,WKREG            IF NO KEY, SUB. O'HEAD FOR KEYS  03440020
         AR    WKREG2,WKREG3            (O'HEAD + KEY LENGTH            03460020
         LH    WKREG3,DCBTRBAL           + DATA LENGTH) THIS SUM WILL   03480020
         SR    WKREG3,WKREG2           BE SUBTRACTED FROM TRACK BALANCE 03500020
         SR    WKREG3,WKREG5           IF RESULT IS NEGATIVE, RECORD    03520020
         BM    SEGMENT                 WILL NOT FIT                     03540020
*                   WKREG2 = KEY LENGTH + O'HEAD FOR A LAST RECORD      03560020
*                                                                       03580020
*                                                                       03600020
         SR    WKREG4,WKREG4           CALCULATE BYTES REQUIRED FOR AN  03620020
         IC    WKREG4,DNRCF+5(0,WKREG1) INTERMEDIATE RECORD.            03640020
         AR    WKREG4,WKREG5          ((KEY LENGTH + DATA LENGTH) TOLER 03660020
         MH    WKREG4,TOLER(0,EPREG)    + O'HEAD)                       03680020
         SRL   WKREG4,9                                                 03700020
         SR    WKREG4,WKREG                                             03720020
         IC    WKREG,OVERI(0,EPREG)                                     03740020
         TM    BYTEDEV(EPREG),TBOVHD    TWO BYTE OVERHEAD USED   S20201 03744020
         BNO   MZ0020                   BRANCH NO                S20201 03748020
         LH    WKREG,OVERI(EPREG)       GET TWO BYTE OVERHEAD    S20201 03752020
MZ0020   EQU   *                                                 S20201 03756020
         AR    WKREG4,WKREG                                             03760020
*                                                                       03780020
         LH    WKREG,DCBTRBAL          DECREMENT TRACK BALANCE BY THE   03800020
         SR    WKREG,WKREG4             CALCULATED VALUE                03820020
         STH   WKREG,DCBTRBAL                                           03840020
         NI    CCW4+4(WKREG6),0        PRE-SET CHAN. PRGM. TO END HERE  03860020
         MVI   CCW3(WKREG6),WRTCKD     TURN OFF WRITE-SPECIAL BIT       03880020
*                                                                       03900020
         CH    WKREG,DCBEOBR+2         WILL A MINIMUM SEGMENT FIT ON    03920020
         LR    WKREG,WKREG5             THIS TRACK. (MOVE DATA LENGTH)  03940020
         BNL   SETCNTS                  YES, GO PREPARE TO WRITE BLOCK  03960020
WRTR0    EQU   *                                                 S20201 03970020
         OI    DCBCIND2,WZEROBIT       SET TRACK-FULL INDICATION        03980020
         XC    DCBTRBAL(2),DCBTRBAL     ZERO TRACK BALANCE       M5894  03990020
         B     SETR0CNT                GO PREPARE TO WRITE R0 AND BLOCK 04000020
*                                                                       04020020
*                                                                       04040020
SEGMENT  EQU   *                                                        04060020
         LH    WKREG,DCBTRBAL          CALC. BYTES OF DATA FIELD WHICH  04080020
         SR    WKREG,WKREG2             WILL FIT ON THIS TRACK          04100020
         MVI   CCW3(WKREG6),WRTSP      MOVE IN WRITE SPECIAL CKD OPCODE 04120020
SETR0CNT EQU   *                                                        04140020
         MVC   R0CNT(4,WKREG1),DCBFDAD+3  MOVE CCHH TO R0 COUNT AND     04160020
         MVC   R0DATA(5,WKREG1),DCBFDAD+3  CCHHR OF LAST BLOCK TO R0    04180020
*                                          DATA FIELD                   04200020
         TM    DCBCIND2,CLOSEDCB        ARE WE HERE FROM CLOSE   S20201 04201020
         BNO   NOTCLOSE                 IF NOT, DKIP THIS RTN    S20201 04202020
         L     WKREG2,IOBSTART         POINT TO 1ST CCW          M6283  04202120
         CLI   D0(WKREG2),SETSECT      IS 1ST CCW AN RPS CCW     M6283  04202220
         LA    WKREG2,CCW5(WKREG2)     LOAD PTR TO R0 CCW        M6477  04202320
         BNE   NOTRPS                  IF NOT RPS R0 CCW OK      M6477  04202420
         LA    WKREG2,TWOCCW(WKREG2)   UP R0 PTR PAST SET SECT   M6477  04202520
*                                       AND TIC                  M6477  04202620
         B     STORECP                 BR TO STORE CHAN PGM      M6477  04202720
NOTRPS   EQU   *                                                 M6477  04202820
         TM    DCBOPTCD,WRTCHK         WAS WRT CHK REQUESTED     M6477  04202920
         BZ    *+8                     NO, DON'T ALLOW FOR CCW   M6477  04203020
         LA    WKREG2,ONECCW(WKREG2)   UP PTR PAST TIC CCW       M6477  04203120
*                                                                       04207802
*   ENTERED FROM CLOSE TO WRITE OUT R0-UPDATE THE IOBSEEK               04209802
*   FIELD, IN CASE THE LAST RECORD WRITTEN OUT CROSSED TRACKS           04211802
*   LEAVING THE IOBSEEK FIELD POINTING TO THE FIRST OF THESE            04212202
*   TRACKS. MUST ALSO TURN OFF THE COMMAND CHAIN BIT IN THE CCW         04212602
*   THAT WRITES THE DATA FIELD OF R0                                    04212702
*                                                                       04212802
STORECP  EQU   *                                                        04212902
         MVC   IOBSEEK,DCBFDAD          UPDATE SEEK FIELD       ZA01362 04214602
         CLI   D0(WKREG2),SETSECT       IS RPS DEVICE USED      ZA01362 04216602
         BNE   CHANOFF                  NO,GO TURN OFF COMCHN   ZA01362 04217002
         NI    D28(WKREG2),X'FF'-CCHN   TURN OFF COMMAND CHAIN  ZA01362 04217402
         B     STORECP2                 CONTINUE                ZA01362 04217802
CHANOFF  EQU   *                        NOT RPS TURN CC OFF     ZA01362 04218202
         NI    D20(WKREG2),X'FF'-CCHN   TURN OFF COMMAND CHAIN  ZA01362 04219302
STORECP2 EQU   *                        CONTINUE                ZA01362 04221302
         ST    WKREG2,IOBSTART          CHAN PGM WILL START HERE S20201 04222902
         B     DOEXCP                   GO WRITE OUT REC ZERO    S20201 04224002
NOTCLOSE EQU   *                                                 S20201 04227102
         OI    CCW4+4(WKREG6),CCHN     SET COMMAND CHAIN TO WRITE R0    04231802
         L     WKREG2,IOBSTART          POINT TO 1ST CCW IN      S20201 04236502
*                                       CHANNEL PR               S20201 04241202
         CLI   D0(WKREG2),SETSECT       IS RPS FEATURED          S20201 04245902
         BE    NEXT01                   BRANCH AROUND            S20201 04250602
         TM    DCBOPTCD,WRTCHK         IS THERE A TIC AT CCW5 LOCATION  04255302
         BZ    CHECK                   NO                               04260020
NEXT01   EQU   *                                                 S20201 04270020
         LA    WKREG2,CCW6(0,WKREG6)                                    04280020
         ST    WKREG2,CCW5(0,WKREG6)                                    04300020
         MVI   CCW5(WKREG6),TICOP                                       04320020
CHECK    EQU   *                                                        04340020
         LTR   WKREG5,WKREG5           HAVE WE FINISHED WRITING THE     04360020
         LH    WKREG2,DCBWCPO          CCWS                             04380020
         BZ    SKIPNOP                 YES GO BACK TO OUTPUT THEM       04400020
         BCTR  WKREG2,0                NO, DECREMENT TRACK COUNT BY ONE 04420020
         STH   WKREG2,DCBWCPO                                           04440020
SETCNTS  EQU   *                                                        04460020
         STH   WKREG,DNRCF+6(0,WKREG1)  STORE DATA LENGTH IN COUNT      04480020
         MVC   DNRCF(5,WKREG1),DCBFDAD+3 MOVE CCHHR TO COUNT            04500020
*                                                                       04520020
         SR    WKREG5,WKREG            DECREMENT DATA BYTES             04540020
         SR    WKREG2,WKREG2                                            04560020
         IC    WKREG2,DNRCF+5(0,WKREG1) CALC. TOTAL BYTES TO BE         04580020
         AR    WKREG,WKREG2              WRITTEN AS A SEGMENT AND       04600020
         STH   WKREG,CCW4+6(0,WKREG6)   USE AS WRITE CCW COUNT          04620020
*                                                                       04640020
         L     WKREG2,IOBSTART          POINT TO FIRST CCW       S20201 04641020
         CLI   D0(WKREG2),SETSECT       ARE WE TOYING WITH RPS   S20201 04642020
         BNE   NONCARN                  NO, THEN SKIP NEXT RTN   S20201 04643020
         LA    WKREG2,CCW9(0,WKREG6)    ELSE,GET CORRECT WRT     S20201 04644020
*                                       ADDR                     S20201 04645020
         OI    D4(WKREG2),CCHN          TURN ON COMMAND CHAIN    M0169  04645521
         TM    DCBOPTCD,WRTCHK          WRT CHK SPECIFIED        S20201 04646020
         BZ    ABAG                     BRANCH                   S20201 04647020
         LA    WKREG2,RRWTCINC(0,WKREG2) ELSE, GET READ R0 ADDR  S20201 04648020
         OI    WTCKCOMO(WKREG2),CCHN    SET CC IN READ SECT      S20201 04649020
*                                       COMMAND                  S20201 04650020
ABAG     EQU   *                                                 S20201 04651020
         NI    LCOMFLGO(WKREG2),DISCONCC TURN OFF COMMAND CHN    S20201 04652020
*                                       AND                      S20201 04653020
         B     CHKBYTES                   BRANCH AROUND NON      S20201 04654020
*                                       CARN. RTN                S20201 04655020
NONCARN  EQU   *                                                 S20201 04656020
         LA    WKREG2,CCW7(0,WKREG6)   TURN OFF COMMAND CHAIN TO END    04660020
         TM    DCBOPTCD,WRTCHK          CHANNEL PROGRAM                 04680020
         BZ    *+8                      (EITHER CCW7 OR CCW9)           04700020
         LA    WKREG2,16(0,WKREG2)                                      04720020
         NI    4(WKREG2),X'BF'                                          04740020
CHKBYTES EQU   *                                                 S20201 04750020
         LTR   WKREG5,WKREG5           IS BYTES REQUIRED = ZERO         04760020
         BZ    CHK1MORE                 YES, SEE IF ANOTHER BLOCK FITS  04780020
*                                                                       04800020
         OI    4(WKREG2),CCHN          SET COMMAND CHAIN TO CONTINUE    04820020
         AR    WKREG4,WKREG            INCREMENT AREA ADDRESS           04840020
         LA    WKREG1,24(0,WKREG1)      AND COUNT FIELD INDEX           04860020
         LA    WKREG6,8(0,WKREG2)       AND CCW INDEX                   04880020
*                                                                       04900020
         BAL   RETREG,WZEROFF           GO INCR. TRK ADDR.       A30241 04920020
         MVC   R0CNT(4,WKREG1),DCBFDAD+3 FILL COUNT FIELD FOR SCH ID EQ 04940020
         MVI   DCBFDAD+7,1              INCREMENT TO FIRST RECORD       04960002
         B     NOTCARN                  RETURN TO CHECK NEXT     S20201 04970020
*                                       SEQUENCE                 S20201 04980020
*                                                                       05000020
*   SEE IF THERE ARE BYTES REMAINING IN THIS EXTENT FOR ANOTHER BLOCK   05020020
*                                                                       05040020
CHK1MORE EQU   *                                                        05060020
         LH    WKREG2,DCBWCPO          LOAD NO. OF TRACKS REMAINING     05080020
         TM    DCBCIND2,WZEROBIT       IF END OF PERIOD DON'T DECREMENT 05100020
         BO    NODECR                  TRACK COUNT                      05120020
         LTR   WKREG2,WKREG2           TEST ANY REMAINING               05140020
         BZ    NODECR                  IF NONE SEE IF A RECORD WILL FIT 05160020
         BCTR  WKREG2,0                DECREMENT NO. TRACKS BY ONE      05180020
NODECR   EQU   *                                                        05200020
         MH    WKREG2,TRKL(0,EPREG)    MULTIPLY BY TRACK LENGTH         05220020
         AH    WKREG2,DCBTRBAL          ADD BALANCE OF CURRENT TRACK    05240020
         LH    WKREG3,DCBEOBR+2                                         05260020
         BCTR  WKREG3,0                                                 05280020
         AH    WKREG3,DCBBLKSI         KEY LENGTH+DATA LENGTH+O'HEAD    05300020
         SR    EPREG,EPREG             PRE-SET RETURN CODE TO 0         05320020
         CR    WKREG2,WKREG3           BYTES  ENOUGH FOR ANOTHER BLOCK  05340020
         BNL   CHKWRTCK                 YES, DON'T WRITE R0             05360020
*                                                                       05380020
OUTPUTR0 EQU   *                                                        05400020
         B     SETR0CNT                OUTPUT R0 CCWS                   05420020
SKIPNOP  EQU   *                                                        05440020
         TM    DCBCIND2,WZEROBIT       IF R0 WRITTEN DON'T DECREMENT    05460020
         BO    R0SET                   TRACK COUNT.SET TRACK FILLED BIT 05480020
         OI    DCBCIND2,WZEROBIT       SET TRACK-FILLED INDICATION      05500020
         BCTR  WKREG2,0                DECREMENT TRACKS REMAINING BY 1  05520020
         STH   WKREG2,DCBWCPO                                           05540020
R0SET    EQU   *                                                        05560020
         LTR   WKREG2,WKREG2           ANY TRACKS LEFT TO BE ERASED     05580020
         BZ    *+8                      NO, LAST BLOCK FILLED LAST TRK. 05600020
         OI    DCBCIND1,ERASEBIT       TURN ON SW TO INDICATE    M5894  05610020
*                                       ERASE                    M5894  05620020
*                                                                       05640020
         IC    WKREG2,DEBNMEXT         SEE IF THIS IS LAST EXTENT       05660020
         BCTR  WKREG2,0                 CURRENTLY ALLOCATED BY          05680020
         EX    WKREG2,CLIEXTNT          COMPARING M TO NO. OF EXTENTS-1 05700020
         BL    CHKWRTCK                NOT LAST EXTENT                  05720020
         LA    EPREG,8                 SET RETURN CODE TO 8             05740020
*                                                                       05760020
CHKWRTCK EQU   *                                                        05780020
         SR    WKREG2,WKREG2            ZERO ONE CCW INDEX       S20201 05782020
*                                       REGISTER                 S20201 05784020
         L     WKREG5,IOBSTART          POINT TO 1ST COMMAND     S20201 05786020
         CLI   D0(WKREG5),SETSECT       IS THIS REC READY        S20201 05788020
         BNE   NORECR                   NO, THEN FORGET UPDATING S20201 05790020
         LA    WKREG2,TWOCCW(0,0)       INDEXES AND USE THE ZERO S20201 05792020
NORECR   EQU   *                                                 S20201 05794020
         AR    WKREG6,WKREG2            UPDATE CCW INDEX         S20201 05796020
         NI    CCW7+4(WKREG6),0        PRE-SET CHAN. PRGM. TO END       05800020
         SR    WKREG6,WKREG2            DOWNDATE CCW INDEX       S20201 05810020
         TM    DCBOPTCD,WRTCHK         IS WRITE CHECK SPECIFIED         05820020
         BZ    TSTRRTIC                 NO,TEST REC READY TICS   S20201 05828020
         OI    CCW9+CARN28(WKREG6),CCHN TURN ON CHAIN COMMAND    S20201 05836020
*                                       BIT IN                   S20201 05844020
*                                       RD SECT IF CARN                 05852020
*                                                                       05860020
         TM    CCW4+4(WKREG6),CCHN     IS R0 BEING WRITTEN TOO          05880020
         MVI   CCW4+4(WKREG6),CCHN      (NEED COMMAND CHAIN EITHER WAY) 05900020
         BZ    SETTICAD                 NO, GO SET A TIC TO VERIFY BLK. 05920020
         TM    CCW2+5(WKREG6),1         IS THIS THE LAST CCW      21476 05930020
*                                       SEQUE                     21476 05940020
         BZ    SHFTR0                   NO, GO MOVE R0 FIELDS           05960020
         AR    WKREG6,WKREG2            UPDATE CCW INDEX         S20201 05970020
         OI    CCW9+4(WKREG6),CCHN     SET COMMAND CHAIN TO VERIFY BLK. 05980020
         B     DOEXCP                   GO EXECUTE                      06000020
*                                                                       06020020
SHFTR0   EQU   *                       USE LAST SEQUENCE OF CCWS TO     06040020
         AR    WKREG6,WKREG2            UPDATE CCW INDEX         S20201 06050020
         MVC   R0CNT+24(16,WKREG1),R0CNT(WKREG1) OUTPUT R0 BY MOVING    06060020
         LA    WKREG,112(0,WKREG6)      FIELDS AND ALTERING TIC AT CCW5 06080020
         AR    WKREG6,WKREG2            UPDATE CCW INDEX         S20201 06085020
         OI    CCW9+D76(WKREG6),CCHN    SET COMM. CHN TO VERIFY  S20201 06090020
         OI    CCW9+CARN84(WKREG6),CCHN  TURN ON CHAIN COMMAND   S20201 06095020
*                                       BIT IN                   S20201 06100020
*                                         RD SECT IF RR OR IN SEEK      06105020
         SR    WKREG6,WKREG2            RESTORE CCW INDEX TO     S20201 06110020
*                                       ORIGINAL                 S20201 06115020
         SR    WKREG6,WKREG2              POINT                  S20201 06120020
         ST    WKREG,CCW5(0,WKREG6)     ALTER TIC AT CCW5 OR     S20201 06125020
*                                       CCW7                     S20201 06130020
*                                                                       06135020
         B     SETTICOP                                                 06140020
TSTRRTIC EQU   *                                                 S20201 06142020
         LTR   WKREG2,WKREG2            IS THERE RPS             S20201 06144020
         BZ    DOEXCP                   IF NOT, GO EXECUTE       S20201 06146020
         OI    CCW4+D4(WKREG6),CCHN     BE SURE WE CHAIN TO TIC  S20201 06148020
         TM    DCBCIND2,WZEROBIT        ARE WE WRITING A ZERO    S20201 06150020
*                                       REC                      S20201 06152020
         BO    DOEXCP                   IF SO, EVERYTHINGS SET   S20201 06154020
*                                       UP                       S20201 06156020
SETTICAD EQU   *                                                        06160020
         MVC   CCW5(4,WKREG6),CCW5+4(WKREG6) RESTORE TIC ADDR. OF CCW5  06180020
SETTICOP MVI   CCW5(WKREG6),TICOP      RESTORE TIC OP-CODE TO CCW5      06200020
*                                                                       06220020
*                                                                       06240020
DOEXCP   EQU   *                                                        06260020
         LR    WKREG2,EPREG            SAVE RETURN CODE                 06280020
         LA    PARAM1,8(0,IOBREG)      SET IOS IOB PARAMETER            06300020
         EXCP  (1)                                                      06320020
EXCPOUT  LR    EPREG,WKREG2             RESTORE RETURN CODE      M5894  06340020
*                                                                       06360020
*                                                                       06380020
         TM    DCBCIND2,CLOSEDCB        WAS ENTRY FROM CLOSE     YM3919 06390002
         BO    RETURN                   YES, RETURN              YM3919 06392002
         TM    IOBLINK,EOVRET           WAS ENTRY FROM EOV       YM6555 06400002
         BZ    RETURN                   NO, ENTERED BY WRITE MACRO      06420020
*                                                                       06440020
         NI    IOBLINK,X'FF'-EOVRET     CLEAR EOV ENTRY BIT      YM6555 06450002
         NI    IOBLINK,NOTEOV           CLEAR EOV UNSCHEDULED INDICATOR 06460002
         BR    EOVRETRN                 GO BACK TO EOV                  06480002
*                                                                       06500020
*                                                                       06520020
*                                                                       06540020
*  BYPASS EXCP FOR REQUESTS AFTER EOV                                   06560020
*                                                                       06580020
SETEOV   OI    DCBCIND1,VOLFUL         MARK DCB SO FUTURE REQ.S BYPASS  06600020
         BCTR  WKREG3,0                 RESTORE DCBFDAD           12987 06606020
         STC   WKREG3,DCBFDAD                                     12987 06612020
POSTEOV  TM    IOBLINK,EOVRET           WAS ENTRY FROM EOV       YM6555 06619002
         BNO   EOVON                    NO, GO SET EOV BIT       YM6555 06621002
RETEOV   EQU   *                        RETURN TO EOV            YM6555 06621402
         NI    IOBLINK,X'FF'-EOVRET     YES, TURN OFF BIT 1ST    YM6555 06623002
         BR    EOVRETRN                 AND RETURN TO EOV        YM6555 06625002
EOVON    OI    IOBLINK,EOVBIT       MARK IOB AS NOT EXCP'D       M5894  06633020
*                                                                       06640020
NORMAL   SR    15,15                   SET RETURN CODE TO ZERO          06660020
*                                                                       06680020
RETURN   EQU   *                        RET TO USER OR EOV       YM6555 06690002
         TM    IOBLINK,EOVRET           WAS ENTRY FROM EOV       YM6555 06692002
         BNO   USERRET                  NO, TO RESTORE USER REGS YM6555 06694002
         B     RETEOV                   BR TO RET TO EOV         YM6555 06694402
USERRET  RETURN (14,12),T,RC=(15)       RETURN TO THE USER              06700002
*                                                                       06720020
*   INCREMENT TRACK ADDRESS BY 1 AND CHECK VALIDITY                     06740020
*                                                                       06760020
WZEROFF  MVC   IOBCSW(4),MAXCC(EPREG)   MOVE NO. OF CYL          A30241 06780020
*                                        AND TRKS TO IOB                06800020
         MVC   IOBCSW+4(4),DCBFDAD+3   MOVE CURRENT CCHH FOR ALIGNMENT  06820020
         MVC   DCBTRBAL,TRKL(EPREG)    RESET TRACK BALANCE              06840020
         MVI   DCBFDAD+7,0              AND ZERO RECORD NO.             06860020
         SR    WKREG2,WKREG2                                            06880020
         IC    WKREG2,DCBFDAD          DEVELOP POINTER TO CURRENT       06900020
         SLL   WKREG2,4                 EXTENT IN THE DEB               06920020
         AR    WKREG2,DEBREG                                            06940020
         LA    IOBREG,0(0,IOBREG)      BE SURE HI-ORDER BYTE IS ZERO    06960020
         LA    WKREG3,3(0,IOBREG)       SET CCHH INDEX TO LAST H        06980020
         L     CCHH,IOBCSW+4           LOAD CURRENT CCHH TO AN ACCUM.   07000020
         TM    BYTEDEV(EPREG),BYTE      ARE ADDRESS BYTES CONTIGUOUS    07020020
         BZ    DOWNONE                  BRANCH IF CONTIG ADDRESS BYTES  07040020
ADDONE   AH    CCHH,ONE                ADD ONE TO THE LO-ORDER BYTE     07060020
         TM    BYTEDEV(EPREG),BYTE     ARE BYTES NON-CONTIGUOUS         07080020
         BC    1,USEBYTE                YES, TREAT EACH SEPARATELY      07100020
         STH   CCHH,IOBCSW+4-IOBDEF(0,WKREG3)  STORE NEW CC OR HH       07120020
         CLC   IOBCSW+4-IOBDEF(2,WKREG3),IOBCSW-IOBDEF(WKREG3)          07140020
*                                            CHECK FOR VALID VALUE      07160020
         BC    4,TSTEXT                ADDRESS VALID, CHECK EXTENT      07180020
         SRL   CCHH,16                 SHIFT TO CC VALUE                07200020
         MVC   IOBCSW-IOBDEF+4(2,WKREG3),ZEROS  ZERO BYTES PROCESSED    07220020
         BCTR  WKREG3,0                  AND DECREMENT THE INDEX        07240020
DOWNONE  BCTR  WKREG3,0                 DECREMENT POINTER               07260020
         CR    WKREG3,IOBREG           HAVE ALL BYTES BEEN PROCESSED    07280020
         BC    10,ADDONE                NO, LOOP TO ADD ONE TO NEXT BYT 07300020
*                                                                       07320020
NEXTEXT  IC    WKREG3,DCBFDAD          INCREMENT M AND SEE IF THIS WAS  07340020
         LA    WKREG3,1(0,WKREG3)       THE LAST EXTENT.                07360020
         STC   WKREG3,DCBFDAD                                           07380020
         CLC   DCBFDAD(1),DEBNMEXT                                      07400020
         BC    8,SETEOV                 YES, GO SET EOV BIT             07420020
         LA    WKREG2,16(0,WKREG2)     INCREMENT TO NEXT EXTENT         07440020
         MVC   DCBFDAD+1(6),DEBBINUM-DEB(WKREG2)  MOVE BBCCHH TO DCB    07460020
         LH    WKREG,DEBNMTRK-DEB(0,WKREG2) GET THE NUMBER OF TRACKS    07480020
*                                      IN THIS EXTENT AND MULTIPLY IT   07500020
         MH    WKREG,TRKL(0,EPREG)     BY TRACK LENGTH                  07520020
         CH    WKREG,DCBOFFSR           COMPARE TO LENGTH OF ONE A30241 07540020
         BNL   RESETTRK                 RECORD. IF IT FITS,GO ON A30241 07560020
ABEND    EQU   *                                                 A27071 07590020
         OI    DCBIFLGS,DCBIFEC         SET ERROR FLAGS ON       YM3919 07592002
*                                       TO PREVENT IOS FROM      YM3919 07594002
*                                       WRITING R0 DURING CLOSE  YM3919 07596002
*                                       IF AN ATTEMPT IS MADE    YM3919 07598002
         DMABCOND  207,SVC=YES,DCB=(DCBREG) BR PROB DET TO ABEND Y02072 07600002
*                                       002 IF BLK DOES NOT FIT  Y02072 07610002
*                                       IN CURRENT EXTENT        Y02072 07620002
*                                                                       07640020
ABENDSEC EQU   *                                                 Y02072 07650002
         OI    DCBIFLGS,DCBIFEC         SET ERROR FLAGS ON       YM3919 07650402
*                                       TO PREVENT IOS FROM      YM3919 07650802
*                                       WRITING R0 DURING CLOSE  YM3919 07651202
*                                       IF AN ATTEMPT IS MADE    YM3919 07651602
         DMABCOND  206,SVC=YES,DCB=(DCBREG) BR PROB DET TO ABEND Y02072 07652002
*                                       002 IF BLK DOES NOT FIT  Y02072 07654002
*                                       IN SECONDARY EXTENT      Y02072 07656002
*                                                                       07658002
RESETTRK EQU   *                                                        07660020
         MVC   DCBWCPO(2),DEBNMTRK-DEB(WKREG2) MOVE TRACKS IN EXTENT TO 07680020
         BR    RETREG                           DCB, RETURN             07700020
*                                                                       07720020
*                                                                       07740020
*                                                                       07760020
*                                                                       07780020
USEBYTE  EQU   *                                                        07800020
         STC   CCHH,IOBCSW-IOBDEF+4(0,WKREG3)  STORE NEW BYTE OF CCHH   07820020
         SRL   CCHH,8                   SHIFT TO THE NEXT ONE           07840020
         CLC   IOBCSW-IOBDEF+4(1,WKREG3),IOBCSW-IOBDEF(WKREG3)          07860020
*                                                 THIS BYTE VALID       07880020
         BC    4,TSTEXT                 BRANCH IF YES                   07900020
         MVI   IOBCSW-IOBDEF+4(WKREG3),0  ZERO THIS BYTE OF CCHH        07920020
         B     DOWNONE                  GO SEE IF ALL BYTES PROCESSED   07940020
*                                                                       07960020
TSTEXT   CLC   IOBCSW+4(4),DEBENDCC-DEB(WKREG2)  ADDRESS WITHIN EXTENT  07980020
         BC    2,NEXTEXT               NO, SEE IF THERE'S ANOTHER EXT   08000020
         MVC   DCBFDAD+3(4),IOBCSW+4   YES, MOVE NEW CCHH TO DCB        08020020
         BR    RETREG                  RETURN TO MAINLINE               08040020
*                                                                       08060020
*                                                                       08080020
*   SET UP THE CCWS TO ERASE A VARIABLE NUMBER OF TRACKS AT THE END OF  08100020
*   THE EXTENT WHICH COULD NOT BE USED.                                 08120020
*                                                                       08140020
*                                                                       08160020
ERSRTN   EQU   *                                                        08180020
*                                                                       08200020
         XI    DCBCIND1,ERASEBIT       CLEAR ERASE FLAG          M5894  08220020
         L     WKREG6,DCBEOBW          LOAD ADDRESS OF ERASE CCW'S      08240020
         MVC   IOBDNRCF(4),IOBSTART    SAVE WRITE CHAN. PROGRAM ADDRESS 08260020
         ST    WKREG6,IOBSTART         STORE NEW START ADDRESS          08280020
         L     WKREG2,IOBSTART          POINT TO FIRST CCW       S20201 08282020
         CLI   D0(WKREG2),SETSECT       ARE WE CLOWNING WITH     S20201 08284020
*                                       ROTATIONAL POSITION SENSING     08286020
         BNE   NORREDY                  IF NOT BRANCH            S20201 08288020
         LA    WKREG6,CARN24(0,WKREG6)  ELSE UPDATE FOR RPS      S20201 08290020
NORREDY  EQU   *                                                 S20201 08292020
         MVC   ERSDATA(4,WKREG6),DCBFDAD+3 MOVE STARTING CCHH ADDRESS   08300020
*                                                                       08320020
EXCPERS  EQU   *                                                        08340020
         LA    PARAM1,8(0,IOBREG)      SET IOS IOB PARAMETER            08360020
         EXCP  (1)                                                      08380020
*                                                                       08400020
         L     DECBREG,IOBECBPT        RELOAD DECB ADDRESS              08420020
         WAIT  ECB=(1)                 WAIT FOR ERASE TO COMPLETE       08440020
*                                                                       08460020
         L     DECBREG,IOBECBPT        RELOAD DECB ADDRESS              08480020
         SR    WKREG2,WKREG2            SET RETURN CODE IN REG   M5894  08490020
         CLI   DECSDECB,X'42'          ANY ERROR OTHER THAN END-OF-EXT. 08500020
         BNE   EXCPOUT                 YES, CK WHERE ENTERED     M5894  08520020
         NI    DECSDECB,0              CLEAR OUT THE ECB                08540020
*                                                                       08560020
         MVC   DCBFDAD+3(4),ERSDATA(WKREG6) MOVE LAST CCHH TO THE DCB   08580020
         MVC   IOBSTART(4),IOBDNRCF    RESTORE CHAN. PROGRAM ADDRESS    08600020
         LA    RETREG,MVCSRCH          SET RETURN ADDRESS               08620020
         L     EPREG,DCBDVTBL           RELOAD DEV CHAR TBL PTR OZ07617 08626000
         NI    DCBIFLGS,X'3F'           TURN OFF PERM ERR IND   OZ07617 08632000
         B     WZEROFF                  AND GO INCR. TRK ADDR    A30241 08640020
*                                                                       08660020
*                                                                       08680020
*                                                                       08700020
CLIEXTNT CLI   DCBFDAD,0   ---EXECUTED-- CHECK FOR M = LAST EXTENT      08720020
*                                                                       08740020
*                                                                       08760020
**********************************************************************  08780020
*                                                                       08800020
ZEROS    DC    H'0'                     CONSTANT OF ZERO                08820020
ONE      DC    H'1'      CONSTANT ONE                                   08840020
NOP      EQU   X'03'     NOP CHANNEL COMMAND OP-CODE                    08860020
TICOP    EQU   X'08'     TIC COMMAND OP-CODE                            08880020
SCHIDEQ  EQU   X'31'     SEARCH ID EQUAL OP-CODE                        08900020
WRTD     EQU   X'05'     WRITE DATA OP-CODE                             08920020
WRTSP    EQU   X'01'     WRITE COUNT-KEY-DATA SPECIAL                   08940020
WRTCKD   EQU   X'1D'     WRITE COUNT-KEY-DATA                           08960020
ERASEBIT EQU   X'04'       THERE ARE TRCKS TO BE ERASED          M5894  08980020
CCHN     EQU   X'40'     COMMAND CHAIN FLAG                             09000020
WRTCHK   EQU   X'80'     WRITE CHECK OPTION                             09020020
DUMMY    EQU   X'10'     WRITE DUMMY TYPE                               09040020
WZEROBIT EQU   X'40'     LAST I/O WAS WRITE R0                          09060020
EOVBIT   EQU   X'80'     THIS WRITE NOT SCHEDULED BECAUSE OF EOV        09080020
NOTEOV   EQU   X'7F'     ALL BITS EXCEPT USCHEDULED BECAUSE OF EOV      09100020
VOLFUL   EQU   X'20'     VOLUME FULL BIT                                09120020
*                                                                       09200020
*      DIRECT ACCESS DEVICE TABLE DEFINITION                            09220020
BYTE     EQU   2         BYTES OF  CCHH ARE NON-CONTIGUOUS              09240020
OVERK    EQU   8         OFFSET TO KEY OVERHEAD                         09260020
OVERI    EQU   6                   INTERMEDIATE RECORD OVERHEAD         09280020
OVERL    EQU   7                   LAST RECORD OVERHEAD                 09300020
TOLER    EQU   10                  TOLERANCE FACTOR                     09320020
TRKL     EQU   4                   BYTES ON TRACK                       09340020
MAXCC    EQU   0                   NO. OF CYLINDERS, TRACKS             09360020
BYTEDEV  EQU   9                   FLAG, BYTES ARE NON-CONTIGUOUS       09380020
*                                                                       09400020
CCW1     EQU   0         OFFSET TO THE CCWS OF A WRITE SEQUENCE         09420020
CCW2     EQU   8                                                        09440020
CCW3     EQU   16                                                       09460020
CCW4     EQU   24                                                       09480020
CCW5     EQU   32                                                       09500020
CCW6     EQU   40                                                       09520020
CCW7     EQU   48                                                       09540020
CCW8     EQU   56                                                       09560020
CCW9     EQU   64                                                       09580020
ERSDATA  EQU   72        8 BYTE DATA FIELD FOLLOWING ERASE CCWS         09600020
*                                                                       09620020
DNRCF    EQU   0         OFFSET TO NEW RECORD COUNT FIELD               09640020
R0CNT    EQU   8         OFFSET TO R0 COUNT FIELD                       09660020
R0DATA   EQU   16        OFFSET TO R0 DATA FIELD                        09680020
CLOSEDCB EQU   X'20'                    CLOSE INDICATOR          S20201 09680620
TBOVHD   EQU   X'08'                    TWO BYTE OVERHEAD INDIC  S20201 09681220
*                                                                       09681820
*                                                                       09682420
*        THE FOLLOWING ARE USED BY ROTATIONAL POSITION SENSING          09683020
*                                                                       09683620
D0       EQU   0         ZERO BYTE DISPLACEMENT                  S20201 09684220
D1       EQU   1         ONE BYTE DISPLACEMENT                   S20201 09684820
Q1       EQU   1         ONE BYTE QUANTITY                       S20201 09685420
D4       EQU   4                        DISPLACEMENT OF 4        S20201 09686020
LCOMFLGO EQU   4         OFFSET TO THE CCW FLAG FLD IN LAST      S20201 09686620
*                                       COMMAND                  S20201 09687220
ONECCW   EQU   8         A ONE CCW DISPLACEMENT - EIGHT BYTES    S20201 09687820
D12      EQU   12        12 BYTE DISPLACEMENT                    S20201 09688420
WTCKCOMO EQU   12        OFFSET TO READ SECTOR FLAG BYTE         S20201 09689020
TWOCCW   EQU   16        A TWO CCW DISPLACEMENT - SIXTEEN BYTES  S20201 09689620
RRWTCINC EQU   16        RECORD READY WRITE CHECK INCREMENT      S20201 09690220
D20      EQU   20                       TWENTY BYTE DISPLACEMENT S20201 09690820
CARN24   EQU   24        UPDATE FOR RPS CCWS IN ERASE C.P.       S20201 09691420
D28      EQU   28                       28 BYTE DISPLACEMENT     S20201 09692020
CARN28   EQU   28        OFFSET TO FLAGS IN RD SECT IF WRT CHECK S20201 09692620
D76      EQU   76        76 BYTE DISPLACEMENT                    S20201 09693220
CARN84   EQU   84        OFFSET TO FLAGS IN RPS RD SECT COMMAND  S20201 09693820
*                                                                       09694420
SETSECT  EQU   X'23'     RPS     TEST BYTE- SET SECTOR COMMAND   S20201 09695020
DISCONCC EQU   X'BF'     FOR DISCONNECTING COMMAND CHAINING      S20201 09695620
EOVRET   EQU   X'10'                    BIT INDICATING CALLER    YM6555 09697602
*                                       OF THIS MODULE WAS EOV   YM6555 09699602
MODID    DC    C'IGG019DD'              MODULE ID                Y02072 09705602
FIX      DC    C'ZA01362 '              LATEST FIX IN MODULE    ZA01362 09706002
DATE     DC    C'09/20/74'              DATE OF LATEST FIX      ZA01362 09706402
PATCH    DC    XL50'0'                  PATCH AREA               Y02072 09706802
         EJECT                                                          09756802
*************************  DCB DEFINITION  **************************** 09780020
         DCBD  DSORG=(PS),DEVD=(DA)                                     09800020
         EJECT                                                          09820020
*************************  IOB DEFINITION  **************************** 09840020
IOBDEF   DSECT      I/O BLOCK DEFINITION                                09860020
IOBLINK  DS    F         IOB LINK ADDRESS                               09880020
IOBIOBA  DS    F         IOB ADDRESS FOR EOV                            09900020
IOBFLAG1 DS    CL1       ERROR FLAG 1                                   09920020
IOBFLAG2 DS    CL1       ERROR FLAG 2                                   09940020
IOBSENSE DS    CL2       I/O SENSE BITS                                 09960020
IOBECBPT DS    F         ECB ADDRESS                                    09980020
IOBCSW   DS    D         CSW STORED BY IOS                              10000020
IOBSIOCC DS    0BL1      SIO CONDITION CODE                             10020020
IOBSTART DS    F         CHANNEL PROGRAM STARTING CCW                   10040020
IOBDCBPT DS    F         DCB ADDRESS                                    10060020
IOBRESTR DS    F         CHANNEL PROGRAM RESTART ADDRESS                10080020
IOBINCAM DS    CL2       BLOCK INCREMENT AMOUNT                         10100020
IOBERRCT DS    CL2       ERROR COUNTS                                   10120020
IOBSEEK  DS    D         SEEK ADDRESS                                   10140020
IOBDNRCF DS    D         NEW RECORD COUNT FIELD                         10160020
IOBR0CNT DS    D         COUNT FIELD OF R0                              10180020
IOBR0DAT DS    D         DATA FIELD OF R0                               10200020
IOBCCW1  DS    D         FIRST CCW OF CHANNEL PROGRAM                   10220020
IOBCCW2  DS    D                                                        10240020
IOBCCW3  DS    D                                                        10260020
IOBCCW4  DS    D                                                        10280020
IOBCCW5  DS    D                                                        10300020
IOBCCW6  DS    D                                                        10320020
IOBCCW7  DS    D                                                        10340020
IOBCCW8  DS    D                                                        10360020
IOBCCW9  DS    D                                                        10380020
IOBCCW10 DS    D                                                        10400020
IOBCCW11 DS    D                                                        10420020
IOBCCW12 DS    D                                                        10440020
IOBCCW13 DS    D                                                        10460020
IOBCCW14 DS    D         LAST CCW OF LONGEST CHANNEL PROGRAM            10480020
*                                                                       10500020
*************************  DECB DEFINITION  *************************** 10520020
*                                                                       10540020
DECBDEF  DSECT     DATA EVENT CONTROL BLOCK                             10560020
DECSDECB DS    F         STANDARD ECB                                   10580020
DECTYPE  DS    CL2       TYPE AND OPTIONS                               10600020
DECLNGTH DS    CL2       DATA LENGTH                                    10620020
DECDCBAD DS    F         DCB ADDRESS                                    10640020
DECAREA  DS    F         AREA ADDRESS                                   10660020
DECIOBPT DS    F         IOB ADDRESS                                    10680020
DECKYADR DS    F                                                        10700020
DECOFSET DS    CL2                                                      10720020
DECRESPN DS    CL1                                                      10740020
         EJECT                                                          10760020
*************************  DEB DEFINITION  **************************** 10780020
*                                                                       10800020
DEB      DSECT                                                          10820020
         DS    0F                                                       10840020
DEBNMSUB DS    0CL1                                                     10860020
DEBTCBAD DS    CL4                                                      10880020
DEBAMLNG DS    0CL1                                                     10900020
DEBDEBAD DS    CL4                                                      10920020
DEBOGLGS DS    0CL1                                                     10940020
DEBIRBAD DS    CL4                                                      10960020
DEBOPATB DS    0CL1                                                     10980020
DEBSYSPG DS    CL4                                                      11000020
DEBNMEXT DS    0CL1                                                     11020020
DEBUSRPG DS    CL4                                                      11040020
DEBPRIOR DS    0CL1                                                     11060020
DEBECBAD DS    CL4                                                      11080020
DEBPROTG DS    0CL1                                                     11100020
DEBDEBID DS    0CL1                                                     11120020
DEBDCBAD DS    CL4                                                      11140020
DEBEXSCL DS    0CL1                                                     11160020
DEBAPPAD DS    CL4                                                      11180020
DEBDVMOD DS    0CL1                                                     11200020
DEBUCBAD DS    CL4                                                      11220020
DEBBINUM DS    CL2                                                      11240020
DEBSTRCC DS    CL2                                                      11260020
DEBSTRHH DS    CL2                                                      11280020
DEBENDCC DS    CL2                                                      11300020
DEBENDHH DS    CL2                                                      11320020
DEBNMTRK DS    CL2                                                      11340020
DEBSUBID EQU   0         SUBROUTINE ID'S                                11360020
         END                                                            11380020
