 TITLE 'IGG019GC  - APPENDAGE ROUTINES, W/O WR CHK'                     00020000
IGG019GC CSECT                                                          00040000
*          RELEASE OS/VS2-02 DELETIONS                                * 00050002
*          RELEASE 19 DELETIONS                                       * 00052000
*2182068600-069000                                               A28706 00052519
*2182034800-034900                                               O19110 00053019
*2182065800                                                      A27321 00053519
*          RELEASE 20 DELETIONS                                       * 00054000
*0492                                                            A30945 00055020
*0492015000,015200-021800,022200,022400,022600-035400,072800,    S20201 00055220
*0492074200,074600,076000,077200,077400,077600,080400,080800,    S20201 00055420
*0492081600,085400,085600,089200,089400,089700,095400,095600,    S20201 00055620
*0492095800,096000,190800,192000                                 S20201 00055820
*          RELEASE 21 DELETIONS                                       * 00056000
*3523046000,052200,052600                                        S21045 00057021
*D069100                                                        SA55487 00057402
*C196700                                                        XA04602 00059402
*          RELEASE 22 DELETIONS                                       * 00064702
*STATUS CHANGE LEVEL 011                                                00068002
*                                                                     * 00080000
*FUNCTION/OPERATION- THIS MODULE CONTAINS THE APPENDAGE ROUTINES FOR  * 00100000
*   PROCESSING ALL LOAD MODE I/O RETURNS. THE CHANNEL END APPENDAGE   * 00120000
*   ROUTINES SIGNAL THE COMPLETION OF INDEX AND/OR BUFFER WRITING.    * 00140000
*   THE ABNORMAL APPENDAGE ROUTINE PREPARES FOR AN ABNORMAL TERMIN-   * 00160000
*   ATION OF THE JOB.  THIS MODULE SUPPORTS BOTH FIXED AND              00170018
*   VARIABLE LENGTH RECORD FORMATS.                                     00180018
*                                                                     * 00200000
*ENTRY POINTS- 'IGG019GC' IS THE ENTRY POINT WHEN NO APPENDAGE        * 00220000
*   PROCESSING IS REQUIRED.                                           * 00240000
*              'IGG019GC+4' IS THE ENTRY POINT FOR CHANNEL END        * 00260000
*   APPENDAGE PROCESSING.                                             * 00280000
*              'IGG019GC+12' IS THE ENTRY POINT FOR ABNORMAL END      * 00300000
*   APPENDAGE PROCESSING.                                             * 00320000
*   ACCESS TO THIS MODULE IS PROVIDED BY A VECTOR OF FIVE ADDRESSES   * 00340000
*   LOCATED AT DEB-36.                                                * 00360000
*                                                                     * 00380000
*INPUT- REGISTER 2  -POINTS TO IOB.                                   * 00400000
*       REGISTER 3  -POINTS TO DEB.                                   * 00420000
*       REGISTER 4  -POINTS TO DCB.                                   * 00440000
*       REGISTER 14 -POINTS TO RETURN FROM APPENDAGE.                 * 00460000
*                                                                     * 00480000
*OUTPUT- SAME REGISTER SETTING AS INPUT.                              * 00500000
*                                                                     * 00520000
*EXTERNAL ROUTINES- THIS MODULE WORKS IN CONJUNCTION WITH LOAD MODE   * 00540000
*   PUT (IGGO19GA), CHANNEL PROGRAMS, AND IOS.                        * 00560000
*                                                                     * 00580000
*EXITS-NORMAL- (ISLF115) FOR NORMAL RETURN TO IOS, CHANNEL END.       * 00600000
*              (ISLF340) FOR EXCP RETURN TO IOS - CP19.               * 00620000
*              (ISLF440) FOR EXCP RETURN TO IOS - CP21.               * 00640000
*              (ISLF505) FOR EXCP RETURN TO IOS - CP21 CYL DUMMY.     * 00660000
*              (ISLF604) FOR EXCP RETURN TO IOS - CP21 MAST DUMMY.    * 00680000
*              (ISLF125) FOR NORMAL RETURN TO IOS, ABNORMAL.          * 00700000
*                                                                     * 00720000
*TABLES/WORK AREAS-                                                   * 00740000
*   DCB      - COMMUNICATION WITH USER.                               * 00760000
*   DEB      - COMMUNICATION WITH IOS.                                * 00780000
*   ISLCOMON - COMMUNICATION WITHIN LOAD MODE.                        * 00800000
*   ISLIOBA  - COMMUNICATION WITH I/O FOR CP18 AND CP20.              * 00820000
*   ISLIOBB  - COMMUNICATION WITH I/O FOR CP21.                       * 00840000
*   ISLIOBC  - COMMUNICATION WITH I/O FOR CP19.                       * 00860000
*   ISLAREAZ - WORK AREA USED FOR PREFORMATTING.                      * 00880000
*   ISLIXLT  - INDEX LOCATION TABLE, LOCATES HI-LEVEL INDICIES.       * 00900000
*   ISLY     - WORK AREA USED WHEN WRITING INDICIES.                  * 00920000
*   ISLVPTRS - VARIABLE POINTERS, REFERENCE VARIABLE LENGTH BLOCKS.   * 00940000
*   IOBBCT   - BUFFER CONTROL TABLE, CONTROLS BUFFER USAGE.           * 00960000
*                                                                     * 00980000
*ATTRIBUTES- READ ONLY, REENTRANT, PRIVILEGED, DISABLED, REUSABLE.    * 01000000
*                                                                     * 01020000
*NOTES- SECTIONS OF THE PROCESSING IN THIS MODULE ARE ENTERED         * 01040000
*   DIRECTLY FROM CLOSE PROCESSING. IN SUCH CASES, PROCESSING IS      * 01060000
*   CARRIED ON AS THOUGH IT WAS PART OF CLOSE.                        * 01080000
*        ENTRY POINT - ISLF110                                        * 01100000
*                                                                     * 01120000
*    ****************************************************************** 01140000
*    THE FOLLOWING NOTATION IS FREQUENTLY USED THROUGHOUT COMMENTS -  * 01160000
*              C(FIELD X) = A(FIELD Y)                                * 01180000
*     CONTENTS OF FIELD X = ADDRESS OF FIELD Y                        * 01200000
*    ****************************************************************** 01220000
*                                                                     * 01240000
         EJECT                                                          01260000
********************                                                    01300000
* DCB REFERENCE    *                                                    01320000
********************                                                    01340000
         DCBD  DSORG=(IS)                                               01360000
         USING IHADCB,R1                                                01380000
         EJECT                                                          01400000
********************                                                    01420000
* DEB REFERENCE    *                                                    01440000
********************                                                    01460000
*                                                                       01480000
IHADEB   IGGDEBD                                                        01490020
         EJECT                                                          02200000
ISLCOMON IGGLOAD                                                        02210020
         USING ISLCOMON,R12                                      S20201 02220020
         SPACE 2                                                        02240002
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03580000
*                                                                       03600000
IOBBCT   DSECT                                                          03620000
         USING IOBBCT,R11                                               03640000
         DS    0D                                                       03660000
IOBFLAGS DS    0CL1                     FLAGS                           03680000
IOBPTRA  DS    A                        PTR A                           03700000
IOBB     DS    0CL1                     B                               03720000
IOBPTRB  DS    A                        PTR B                           03740000
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03760000
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03780000
         EJECT                                                          03785020
LOADCPS  DSECT                                                          03790020
         IGGLDCP                                                        03795020
         EJECT                                                          03800000
********************                                                    03820000
* IOB REFERENCE    *                                                    03840000
********************                                                    03860000
*                                                                       03880000
IHAIOB   DSECT                                                          03900000
         USING IHAIOB,R2                                                03920000
         DS    0D                                                       03940000
IOBFLAG1 DS    CL1                      FLAGS 1                   15924 03960016
IOBFLAG2 DS    CL1                      FLAGS 2                   15924 03980016
         DS    CL1                                                      04000000
IOBSENSE DS    CL1                      SENSE                           04020000
IOBECBAD DS    A                        ECB POINTER                     04040000
IOBCSW   DS    CL8                      CHANNEL STATUS WORD             04060000
IOBSIOCC DS    0CL1                     SIO CC                          04080000
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       04100000
IOBWT    DS    0CL1                     WEIGHT                          04120000
IOBDCBAD DS    A                        DCB POINTER                     04140000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     04160000
IOBBCTI  DS    CL2                      BLK CTR INCR                    04180000
IOBERRCT DS    CL2                      ERROR COUNT               15924 04200016
IOBDADAD DS    CL8                      DIR ACESS DEV ADR MBBCCHHR      04220000
         ORG   IOBDADAD+5                                               04230002
IOBDAHHR DS    XL3                      HHR                      Y02072 04232002
*                                                                       04240000
********************                                                    04260000
* IXLT REFERENCE   *                                                    04280000
********************                                                    04300000
*                                                                       04320000
IXLT     DSECT                                                          04340000
         USING IXLT,R7                                                  04360000
         DS    0D                                                       04380000
IXLTIND  DS    CL1                      INDICATOR                  LEV1 04400000
IXLBEG   DS    CL8                      BEGINING COUNT MBBCCHHR         04420000
IXLSTP   DS    CL8                      STEPPING COUNT MBBCCHHR         04440000
IXLEND   DS    CL8                      ENDING COUNT   MBBCCHHR         04460000
         DS    CL1                                                      04480000
         DS    CL26                                                LEV2 04500000
         DS    CL26                                                LEV3 04520000
         DS    CL26                                                LEV4 04540000
         EJECT                                                          04560000
REGSAVE  DSECT                          REGISTER SA FROM IOS     Y02072 04570002
REGSAV14 DS    F                        REGISTER 14              Y02072 04572002
REGSAV15 DS    F                        REGISTER 15              Y02072 04574002
REGSAV0  DS    F                        REGISTER 0               Y02072 04578802
REGSAV1  DS    F                        REGISTER 1               Y02072 04579202
REGSAV2  DS    F                        REGISTER 2               Y02072 04579602
REGSAV3  DS    F                        REGISTER 3               Y02072 04579702
REGSAV4  DS    F                        REGISTER 4               Y02072 04579802
REGSAV5  DS    F                        REGISTER 5               Y02072 04579902
REGSAV6  DS    F                        REGISTER 6               Y02072 04593202
REGSAV7  DS    F                        REGISTER 7               Y02072 04603202
REGSAV8  DS    F                        REGISTER 8               Y02072 04605202
REGSAV9  DS    F                        REGISTER 9               Y02072 04605602
REGSAV10 DS    F                        REGISTER 10              Y02072 04606002
REGSAV11 DS    F                        REGISTER 11              Y02072 04606402
REGSAV12 DS    F                        REGISTER 12              Y02072 04606502
REGSAV13 DS    F                        REGISTER 13              Y02072 04609802
         EJECT                                                          04613402
IGG019GC CSECT                                                          04616702
*                                                                       04620000
* EQUATE SYMBOLIC REGISTERS                                             04640000
*                                                                       04660000
R0       EQU   0                                                        04680000
R1       EQU   1                                                        04700000
R2       EQU   2                                                        04720000
R3       EQU   3                                                        04740000
R4       EQU   4                                                        04760000
R5       EQU   5                                                        04780000
R6       EQU   6                                                        04800000
R7       EQU   7                                                        04820000
R9       EQU   8                                                        04860000
R10      EQU   10                                                       04880000
R11      EQU   11                                                       04900000
R12      EQU   12                                                       04920000
R13      EQU   13                                                       04940000
R14      EQU   14                                                       04960000
R15      EQU   9                                                        04980000
R16      EQU   15                                                       05000000
EXCP     EQU   8                                                  15924 05010016
HHR      EQU   3                        LENGTH OF HHR IN BYTES   Y02072 05010402
LO3BYTES EQU   7                        STORE LOW 3 ORDER BYTES  Y02072 05010802
ALL      EQU   X'FF'                    ALL SWS ON               S20201 05011020
CM24X    EQU   CM2+4                    COUNT FOR MULTIPLE CP19  S20201 05012020
*                                       * EXECUTIONS.                   05013020
CM64     EQU   CM6+4                    FIRST TIME INDICATOR     S20201 05014020
CM264    EQU   CM26+4                   LAST CC SPOT             S20201 05015020
CM273    EQU   CM27+3                   CCHHR FOR CM5            S20201 05016020
L4       EQU   4                        LENGTH                   S20201 05017020
*                                                                       05020000
FLAGS    EQU   10                       FLAG BYTE IN TISA               05024001
CP20CNXT EQU   X'02'                    SCHEDULE CP20C NEXT             05026001
CP18NEXT EQU   X'01'                    SCHEDULE CP18 NEXT              05028001
CP20LAST EQU   CP18NEXT+CP20CNXT        LAST CP SCHEDULED               05030001
         EJECT                                                          05040000
*********************************************************************** 05060000
* GENERAL APPENDAGE ROUTINE                                           * 05080000
*********************************************************************** 05100000
*                                                                       05120000
*                                                                       05140000
* APPENDAGE ROUTINE ENTRANCES                                           05160000
*                                                                       05180000
         B     0(R14)                   NO APPENDAGE RT, RETURN TO IOS  05200000
         USING *+8,R15                                           S21045 05208021
CE       LA    R15,TWOINSTR(R16)        SET COMMON BASE          S21045 05216021
TWOINSTR EQU   8                        LENGTH OF TWO            S21045 05224021
*                                       INSTRUCTIONS             S21045 05232021
         B     ISLF110                  B TO CE RT                      05240000
ABE      LR    R15,R16                  SET COMMON BASE          S21045 05260021
         B     ISLF120                  B TO AE RT                      05280000
*                                                                       05300000
         EJECT                                                          05320000
*                                                                       05340000
* CE ENTRANCE AND EXIT                                                  05360000
**********************                                                  05380000
*                                                                       05400000
ISLF110  EQU   *                                                 Y02072 05420002
         BAL   R12,ISLF130              LINK TO COMMON HSK       Y02072 05430002
*                                                                       05440000
* LOCATE PROPER CHANNEL END APPENDAGE ROUTINE                           05460000
*                                                                       05480000
         LA    R3,0(R2)                 C(R3)=A(IOBX)                   05500000
         LA    R4,ISLIOBB               C(R4)=A(IOBB)                   05520000
         CR    R3,R4                    COMP IOBX VS IOBB               05540000
         BH    ISLF301                  B IF IOBX = IOBC (CP19)         05560000
         BE    ISLF401                  B IF IOBX = IOBB (CP21)         05580000
         B     ISLF201                  B IF IOBX = IOBA (CP18-CP20)    05600000
*                                                                       05620000
*                                                                       05640000
ISLF115  BAL   R13,ISLF140              LINK TO COMMON END              05660000
         B     0(R14)                   NORMAL RETURN TO IOS            05680000
*                                                                       05700000
*                                                                       05720000
* AE ENTRANCE AND EXIT                                                  05740000
**********************                                                  05760000
*                                                                       05780000
ISLF120  EQU   *                                                 Y02072 05800002
         BAL   R12,ISLF130              LINK TO COMMON HSK       Y02072 05810002
         TM    DCBEXCD1,X'04'           TEST EXCD1 BIT 5 FOR PREV ERR   05820000
         BC    1,ISLF125                B IF ON, ONLY 1 ERR PER JOB     05840000
         B     ISLF701                  B TO ABNORMAL APPENDAGE         05860000
*                                                                       05880000
ISLF125  BAL   R13,ISLF140              LINK TO COMMON END              05900000
         B     0(R14)                   NORMAL RETURN TO IOS            05920000
*                                                                       05940000
*                                                                       05960000
* COMMON APPENDAGE HOUSEKEEPING                                         05980000
*********************************************************************** 06000000
*                                                                       06020000
ISLF130  EQU   *                                                 Y02072 06040002
         STM   R14,R13,0(R13)           SAVE REGS IN IOS SA      Y02072 06050002
         LR    R14,R13                  SAVE ADDR OF SAVE AREA   Y02072 06052002
         USING IHADEB,R3                                         Y02072 06054002
*                                                                       06054402
         MODESET KEYADDR=DEBPROTG,WORKREG=13  SET USERS KEY      Y02072 06056002
*                                                                       06056402
         LR    R13,R12                  SAVE RETURN ADDRESS      Y02072 06058002
         DROP  R3                                                Y02072 06058402
         LR    R1,R4                    C(R1)=A(DCB)                    06060000
         L     R12,DCBWKPT1             C(R12)=A(COMMON)                06080000
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 06120000
         L     R11,8(R10)               C(R11)=A(IOBBCT)                06140000
*                                       C(R2)=A(IOB) - GIVEN            06160000
         LR    R0,R3                    DEB ADDRESSABILITY              06160500
*                                                                       06180000
*                                                                       06200000
         BR    R13                      EXIT                            06220000
*                                                                       06222016
*                                                                       06224016
EXCPRTRN XC    IOBFLAG2(3),IOBFLAG2     CLEAR FLAG2,SENSE BYTES   15924 06226016
         XC    IOBCSW(9),IOBCSW         CLEAR FLAG3,CSW,SIOCC     15924 06228016
         XC    IOBERRCT(2),IOBERRCT     CLEAR ERROR COUNT         15924 06230016
         NI    IOBFLAG1,X'C2'           RESET FLAG1               15924 06232016
*                                                                       06240000
*                                                                       06260000
* COMMON APPENDAGE END                                                  06280000
*********************************************************************** 06300000
*                                                                       06320000
         USING REGSAVE,R14                                       Y02072 06330002
ISLF140  EQU   *                                                 Y02072 06340002
*                                                                       06370002
         MODESET  KEYADDR=KEY0,WORKREG=9  SET PROTECT KEY ZERO   Y02072 06372002
*                                                                       06374002
         LM    R14,R12,REGSAV14         RESTORE REGS FRM IOS SA  Y02072 06376002
         SR    R15,R15                  CLEAR 9                         06380000
*                                                                       06400000
         BR    R13                      EXIT                            06420000
         DROP  R14                                               Y02072 06430002
         EJECT                                                          06440000
*********************************************************************** 06460000
* CHART F2 - APPENDAGE, CP18 AND CP20 CHANNEL END                     * 06480000
*********************************************************************** 06500000
*                                                                       06520000
* SET FLAGS BIT 0 = 0, (IWR)- CP(S) IS NOW AVAILABLE                    06540000
*                                                                       06560000
ISLF201  EQU   *                                                 A27321 06570019
*                                                                       06581019
*              FOR FULL TRACK INDEX WRITE OPTION - IF CP20              06582019
*              WAS EXECUTED WITHOUT CP18 (BIT 4 OF FLAG FIELD           06583019
*              IN THE TRACK INDEX SAVE AREA IS ON) THEN RETURN          06584019
*              TO IOS WITHOUT UPDATING BUFFER POINTER.                  06585019
*                                                                       06586019
         TM    36(R10),X'C0'            SUCCESSFUL GETMAIN FOR   O19110 06587019
*                                       FULL TRACK INDEX WRITE          06588019
         BNO   ISLF2014                 NO - BR TO CONTINUE      O19110 06589019
         L     R4,36(R10)               C(R4)=A(FTIW TI SAVE     O19110 06590019
*                                       AREA)                           06591001
*   IF AOS CP20A OF B ,CP20C AND CP18 ARE SCHEDULED SEPARATELY AND      06591201
*   MUST BE RESTARTED FROM THIS APPENDAGE.                              06591301
         TM    FLAGS(R4),CP20LAST       WAS CP18 LAST SCHEDULED         06591401
         BO    ISLF2014                 YES - DONE                      06591501
AOSNT20C EQU   *                        SCHEDULE CP18 IF NECESSARY      06591601
         TM    10(R4),X'08'             CP20 EXECUTED ALONE      O19110 06592019
         BO    ISLF115                  YES-RETURN TO IOS EXIT   O19110 06593019
*   START CP 18 IF NECESSARY.                                           06594201
         TM    FLAGS(R4),CP18NEXT       SHOULD CP18 BE SCHE             06594801
         BNO   ISLF2014                 NO - FINISHED                   06595401
         MVC   IOBCPSAD,ISLVPTR4        ASSUME CP18 NEXT                06596001
         MVC   IOBDADAD,0(R4)           *                               06596601
         OI    FLAGS(R4),CP20LAST       MARK CP20 SCHEDULED             06597201
         BAL   R13,EXCPRTRN             REFRESH IOB                     06597801
         B     EXCP(R14)                LINK TO IOS TO EXCP             06598401
*                                                                       06600000
* SET OFF STATUS BITS 1 AND 2, 00 = BUFFER AVAILABLE                    06620000
* SET OFF STATUS BIT 4, 0 = T-BIT OFF                                   06640000
* DO THIS FOR EACH BUFFER THAT WAS JUST WRITTEN AND UPDATE PTR A AT THE 06660000
* SAME TIME. AT FINISH, PTR A WILL POINT TO NEXT SLOT TO SCHEDULE FOR   06680000
* WRITING.                                                              06700000
*                                                                       06720000
ISLF2014 EQU   *                                                 O19110 06730019
         L     R3,IOBPTRA               C(R3)=A(1ST SLOT WRITTEN)       06740000
         LA    R3,0(R3)                                                 06760000
ISLF202  TM    0(R3),X'60'              TEST BITS 1 AND 2 VS 11         06780000
         BC    1,ISLF203                B IF BITS 1 AND 2 = 11          06800000
*                                                                       06820000
*                                       BITS 1 AND 2 NOT 11, FINISHED   06840000
         STCM  R3,LO3BYTES,IOBPTRA+L'IOBFLAGS  STORE FIRST SLOT  Y02072 06860002
*                                       ADDR INTO PTRA           A28706 06880002
         B     ISLF115                  NORMAL RETURN TO IOS EXIT       06920000
*---------------------------------------------------------------------- 06940000
*                                                                       06960000
ISLF203  NI    0(R3),X'97'              TURN BITS 1,2 AND 4 (IF ON) OFF 06980000
         A     R3,ISL4                  BUMP R3 TO ADR NEXT SLOT        07000000
         C     R3,ISLBUFN               TEST FOR ADR OF NTH SLOT        07020000
         BH    ISLF204                  B IF OUTSIDE TBL = WRAPAROUND   07040000
         B     ISLF202                  LOOP AGAIN                      07060000
*                                                                       07080000
*                                       WRAPAROUND                      07100000
ISLF204  LA    R3,IOBABUF               C(R3)=A(SLOT 1)                 07120000
         B     ISLF202                  LOOP AGAIN                      07140000
         EJECT                                                          07160000
*********************************************************************** 07180000
* CHART F3 - APPENDAGE, CP19 CHANNEL END                              * 07200000
*********************************************************************** 07220000
*                                                                       07240000
ISLF301  L     R10,16(R10)              C(R10)=A(CP19)                  07260000
         USING CM1,R10                  ADDRESSABILITY ON CP19   S20201 07270020
         CLC   CM24X(L4),ISL0           TEST CM2+4 VS 0000 = 10  S20201 07280020
*                                       OR LESS.                        07290020
         BE    ISLF115                  B IF TEN OR LESS ENTRIES TO BE  07300000
*                                       PREFORMATTED FOR NORMAL IOS     07320000
*                                       RETURN.                         07340000
*                                                                       07360000
* MORE THAN TEN ENTRIES TO PREFORMAT                                    07380000
*                                                                       07400000
         CLC   CM64(L4),ISL0            TEST CM6+4 VS 0000 = 1ST S20201 07410020
*                                       CE                       S20201 07420020
         BE    ISLF302                  B IF 1ST CE FOR THIS CYLINDER   07440000
         CLC   CM64(L4),ISLFF           TEST FOR CM6+4 FOR END   S20201 07460020
         BNE   ISLF303                  B IF PREFORMATTING IN PROCESS   07480000
         B     ISLF320                  B IF END                        07500000
*                                                                       07520000
*                                                                       07540000
* 1ST CE WHILE PREFORMATTING THIS CYLINDER                              07560000
*                                                                       07580000
ISLF302  LA    R4,CM5                   C(R4)=A(CM5)             S20201 07600020
         IC    R5,IOBSIOCC              SAVE SIOCC                      07620000
         ST    R4,IOBCPSAD              STORE A(CM5) IN IOBC CP START   07640000
         STC   R5,IOBSIOCC              RESTORE SIOCC                   07660000
*                                                                       07680000
         LA    R4,35(R2)                CM5                             07700000
         IC    R5,CM5                                            S20201 07720020
         ST    R4,CM5                        STORE ADR IOBC+35   S20201 07740020
         STC   R5,CM5                                            S20201 07760020
*                                                                       07780000
* CALCULATE COUNT OF NO. OF EXECUTES OF CP19 FROM APPENDAGE             07800000
*                                                                       07820000
         SR    R4,R4                                                    07840000
         SR    R5,R5                                                    07860000
         IC    R5,DCBFIRSH+2            C(R5)=R OF FIRSH                07880000
         S     R5,ISL1                  DIVIDEND = 0000000N IN R4-R5    07900000
         D     R4,ISL10                 DIVISOR  = 000A                 07920000
*                                       C(R4) = REMAINDER R = 000R      07940000
*                                       C(R5) = QUOTIENT Q              07960000
         C     R4,ISL0                  TEST R VS 0                     07980000
         BNE   ISLF3025                 B IF R NOT 0                    08000000
         S     R5,ISL1                  R=0, ADJUST Q DOWNWARDS         08020000
ISLF3025 ST    R5,CM64                  C(CM6+4)=Q, Q GR 0       S20201 08040020
*                                                                       08060000
ISLF303  L     R5,CM64                  C(R5) = COUNT Q          S20201 08080020
         C     R5,ISL1                  TEST FOR LAST EXECUTE           08100000
         BE    ISLF305                  B IF LAST EXECUTE               08120000
         S     R5,ISL1                  DECREMENT COUNT Q               08140000
         ST    R5,CM64                  C(CM6+4) = Q, Q GR 0     S20201 08160020
*                                                                       08180000
* PREPARE TO EXECUTE PREFORMAT                                          08200000
*                                                                       08220000
ISLF304  LA    R9,ISLAREAZ              C(R9)=A(AREA Z)                 08240000
         MVC   37(3,R2),80(R9)          C(IOBC+37)=HHR FROM COUNT 10    08260000
         SR    R5,R5                                                    08280000
         IC    R5,82(R9)                C(R5)=R FROM COUNT 10           08300000
         BAL   R13,ISLF310              B TO SET UP AREA Z              08320000
*                                                                       08340000
* EXCP RETURN TO IOS - EXECUTE CP19 AGAIN                               08360000
*                                                                       08380000
         BAL   R13,EXCPRTRN             EXCP HOUSEKEEP            15924 08400016
         B     EXCP(R14)                TAKE EXCP IOS RETURN      15924 08420016
*                                                                       08440000
*                                                                       08460000
* PREPARE TO EXECUTE LAST PREFORMAT FOR THIS CYLINDER                   08480000
*                                                                       08500000
ISLF305  L     R4,ISLFF                 C(R4)=FFFF                      08520000
         ST    R4,CM64                  C(CM6+4) = FFFF = END    S20201 08540020
         L     R4,CM24X                 C(R4)=C(CM2+4)=A(CC      S20201 08550020
*                                       FLAG)                    S20201 08560020
         NI    0(R4),X'BF'              TURN CC FLAG OFF                08580000
         B     ISLF304                  B TO COMMON PREPARE             08600000
*                                                                       08620000
* SUBROUTINE TO SET UP AREA Z                                           08640000
*                                                                       08660000
ISLF310  L     R3,ISL10                 C(R3)=10  = LOOP COUNT          08680000
         LA    R4,10(R9)                C(R4)=A(Z+10) = 1ST R           08700000
ISLF311  A     R5,ISL1                  STEP R                          08720000
         STC   R5,0(R4)                 STORE R IN Z                    08740000
         A     R4,ISL8                  STEP Z                          08760000
         BCT   R3,ISLF311               LOOP                            08780000
         BR    R13                      EXIT                            08800000
*                                                                       08820000
*                                                                       08840000
* END OF APPENDAGE - RESET CONDITIONS                                   08860000
*                                                                       08880000
ISLF320  SR    R5,R5                                                    08900000
         ST    R5,CM64                  C(CM6+4) = 0000          S20201 08920020
         L     R4,CM24X                 C(R4)=C(CM2+4)=A(CC      S20201 08930020
*                                       FLAG)                    S20201 08940020
         OI    0(R4),X'40'              TURN CC FLAG BACK ON            08960000
         NI    CM264,ALL-CC             TURN OFF TENTH CC FLAG   S20201 08966020
*                                        1187                    S20201 08972020
         LA    R9,ISLAREAZ              C(R9)=A(AREA Z)                 08980000
         BAL   R13,ISLF310              B TO SET UP AREA Z, 1ST R = 1   09000000
*                                                                       09020000
         TM    DCBOPTCD,X'08'           TEST OPTCD BIT-4 FOR CYL OVFL   09040000
         BC    8,ISLF325                B IF NO CYL OVFL                09060000
*                                                                       09080000
*                                       CYL OVFL ON                     09100000
         IC    R5,IOBSIOCC              SAVE SIOCC                      09120000
         ST    R10,IOBCPSAD             STORE A(CM1) IN IOBC CP START   09140000
         STC   R5,IOBSIOCC              RESTORE SIOCC                   09160000
*                                                                       09180000
         XC    IOBDAHHR,IOBDAHHR        SET HEAD,RCD TO ZERO     Y02072 09220002
*                                                                       09360000
         CLI   DCBFIRSH+1,X'00'         FIRSH TRACK VS 0                09400000
         BE    ISLF115                  B IF CYL OVFL RCD IS ON SHARED  09420000
*                                       TRACK = CM5 OK - EXIT,NORM RTRN 09440000
*                                                                       09460000
*                                       CYL OVFL RCD NOT ON SHARED TRK  09480000
         TM    IOBFLAGS,X'10'     CP 91 IN CONTROL                      09500000
         BO    ISLF115            YES, CP 91 IN CONTROL RETURN TO IOS   09520000
         LA    R4,CM273                 CM5                      S20201 09540020
         IC    R5,CM5                                            S20201 09560020
         ST    R4,CM5                     STORE ADR CM27+3       S20201 09580020
         STC   R5,CM5                                            S20201 09600020
*                                                                       09620000
         B     ISLF115                  EXIT,NORM RTRN                  09640000
*                                                                       09660000
*                                       NO CYL OVFL - CP START OK       09680000
ISLF325  EQU   *                                                        09700000
         MVI   39(R2),X'00'             SET R=0 IN IOBC+39              09720000
*                                                                       09840000
ISLF326  MVC   38(1,R2),DCBFIRSH+1      SET IOBC+38 TO TRACK FROM FIRSH 09860000
*                                       CM5 OK                          09880000
         B     ISLF115                  EXIT,NORM RTRN                  09900000
         EJECT                                                          09920000
*********************************************************************** 09940000
* CHART F4 - APPENDAGE, CP21 CHANNEL END                              * 09960000
*********************************************************************** 09980000
*                                                                       10000000
ISLF401  LA    R7,ISLIXLT               C(R7)=A(IXLT)                   10020000
         L     R9,0(R10)                C(R9)=A(AREA Y)                 10040000
         LR    R6,R7                    C(R6)=A(IXLT)=A(LEV1)           10060000
         L     R5,ISL1                  C(R5)=0001 FOR CURRENT LEVEL    10080000
         L     R3,24(R10)               C(R3)=A(CP21)                   10100000
         TM    20(R3),X'80'             TEST CQ42 FOR DC                10120000
         BC    8,ISLF115                B IF OFF = EOF, NORMAL RETURN   10140000
*                                                                       10160000
* LOCATE CURRENT LEVEL IN IXLT                                          10180000
*                                                                       10200000
         TM    0(R7),X'20'              TEST LEVEL IND BIT-2            10220000
         BC    1,ISLF403                B IF LEVEL 1, CYL IX            10240000
ISLF402  A     R7,ISL26                 STEP TO NEXT LEVEL IN IXLT      10260000
         A     R5,ISL1                  C(R5)=CURRENT LEVEL             10280000
         TM    0(R7),X'20'              TEST LEVEL IND BIT-2            10300000
         BC    8,ISLF402                B IF NOT THIS LEVEL (LOOP)      10320000
*                                                                       10340000
* MASTER INDEX, TEST FOR DUMMY ENTRY                                    10360000
*                                                                       10380000
         TM    0(R7),X'40'              TEST LEVEL IND BIT-1            10400000
         BC    1,ISLF601                B IF MST DUMMY                  10420000
         B     ISLF410                                                  10440000
*                                                                       10460000
* CYLINDER INDEX, TEST FOR DUMMY ENTRY                                  10480000
*                                                                       10500000
ISLF403  TM    0(R7),X'40'              TEST LEVEL IND BIT-1            10520000
         BC    1,ISLF501                B IF CYL DUMMY                  10540000
*                                                                       10560000
         EJECT                                                          10580000
*                                                                       10600000
* NORMAL ENTRY APPENDAGE ROUTINE, CYLINDER OR MASTER INDEX              10620000
*            * R6 POINTS TO CYLNDER IXLT LEVEL *                        10640000
*            * R7 POINTS TO CURRENT IXLT LEVEL *                        10660000
*                                                                       10680000
* TEST R IN COUNT FIELD IN AREA Y FOR END OF TRACK                      10700000
*                                                                       10720000
ISLF410  CLC   4(1,R9),DCBHIRCM         TEST R VS HI R                  10740000
         BNE   CONTINUE                 BRANCH NOT EQUAL          21347 10746018
         CLI   16(R7),X'00'             IS R OF SX = 0 ?          21347 10752018
         BE    ISLF420                  BRANCH IF EQUAL           21347 10758018
         B     ISLF415                                            21347 10764018
CONTINUE EQU   *                                                  21347 10770018
*                                                                       10780000
*                                       NOT END OF TRACK                10800000
* REPLACE R OF STEPPING COUNT BY R OF Y                                 10820000
*                                                                       10840000
         MVC   16(1,R7),4(R9)           R OF SX = R OF Y                10860000
         TM    IOBFLAGS,X'12'           ARE WE IN CLOSE           VLR   10880018
         BC    1,ISLF420                B IF ON = CLOSE                 10900000
*                                                                       10920000
* TEST HH OF STEPPING COUNT FOR END OF CYLINDER                         10940000
*                                                                       10960000
         MVC   TSTWK1C(1),15(R7)        GET CURRENT TRK FROM IXLT       10980000
         MVC   TSTWK1C+2(1),23(R6)      GET HI TRK FROM IXLT            11000000
         NC    TSTWK1C(1),ISLAREAZ+87   REDUCE CURRENT TO TRACK         11020000
         NC    TSTWK1C+2(1),ISLAREAZ+87  REDUCE HIGH TO TRACK           11040000
         CLC   TSTWK1C(1),TSTWK1C+2     CURRENT TRACK VS HI TRACK       11060000
         BNE   ISLF450                  B IF NOT END OF CYLINDER - EXIT 11080000
*                                                                       11100000
*                                       LAST TRACK ON CYLINDER          11120000
*                                                                       11140000
* TEST R OF STEPPING COUNT FOR NEXT-TO-LAST R ON LAST TRACK             11160000
*                                                                       11180000
         SR    R3,R3                                                    11200000
         IC    R3,DCBHIRCM              C(R3)=HI R                      11220000
         S     R3,ISL1                  C(R3)=HI R -1                   11240000
         SR    R4,R4                                                    11260000
         IC    R4,16(R7)                C(R4)=R OF SX                   11280000
         CR    R3,R4                    TEST HI R -1 VS R OF SX         11300000
         BNE   ISLF450                  B IF NOT NEXT-TO-LAST R  - EXIT 11320000
*                                                                       11340000
* NEXT TO LAST R ON LAST TRACK OF A CYLINDER HAS BEEN WRITTEN FOR THIS  11360000
* LEVEL INDEX. THE LAST SLOT IN A HI-LEVEL INDEX ON A GIVEN CYLINDER    11380000
* MUST CONTAIN A DUMMY ENTRY. SET DUMMY SW ON FOR THIS LEVEL INDEX SO   11400000
* NEXT WRITE WILL PRODUCE DUMMY ENTRY.                                  11420000
*                                                                       11440000
         OI    0(R7),X'40'              SET LEVEL IND BIT-1 ON          11460000
         B     ISLF420                                                  11480000
*                                                                       11500000
*                                                                       11520000
* LAST R WRITTEN WAS END OF TRACK- STEP STEPPING COUNT TO NEXT TRACK    11540000
*                                                                       11560000
ISLF415  MVI   16(R7),X'00'             R OF SX = 0                     11580000
         LH    R3,14(R7)                C(R3)=HH OF SX                  11600000
         A     R3,ISL1                  C(R3)=HH+1                      11620000
         STH   R3,14(R7)                C(SX)=MBBCCHHR, HH=HH+1, R=0    11640000
*                                                                       11660000
* TEST FOR ANY HIGHER LEVEL INDEXES                                     11680000
*                                                                       11700000
ISLF420  TM    0(R7),X'80'              TEST LEVEL IND BIT-0            11720000
         BC    1,ISLF450                                                11740000
*                                                                       11760000
* HIGHER LEVEL INDEX PRESENT, STEP TO NEXT LEVEL IN IXLT                11780000
*                                                                       11800000
         NI    0(R7),X'DF'              TURN BIT-2 IN CURR LEV IND OFF  11820000
         A     R7,ISL26                 STEP R7 TO REF NEXT LEVEL       11840000
         A     R5,ISL1                  C(R5)=CURRENT LEVEL             11860000
         OI    0(R7),X'20'              TURN BIT-2 IN CURR LEV IND ON   11880000
*                                                                       11900000
* CONSTRUCT COUNT FOR MASTER INDEX ENTRY IN AREA Y, Y+0                 11920000
*                                                                       11940000
         MVC   0(4,R9),12(R7)           COUNT = CCHH FROM IXLT SX       11960000
         SR    R3,R3                                                    11980000
         IC    R3,16(R7)                C(R3)=R FROM IXLT SX, 00NN      12000000
         A     R3,ISL1                  C(R3)=R+1                       12020000
         STC   R3,4(R9)                 COUNT = CCHHR WITH R=R+1        12040000
*                                                                       12060000
* CONSTRUCT DATA FOR MASTER INDEX ENTRY IN AREA Y, Y+8                  12080000
*                                                                       12100000
         STC   R5,16(R9)                STORE LEVEL IN F-BYTE 00000III  12120000
*                                                                       12140000
         TM    0(R7),X'40'              TEST IXLTIND BIT 1 (DUMMY SW)   12160000
         BC    1,ISLF430                B IF ON                         12180000
*                                                                       12200000
*                                       DUMMY SW OFF                    12220000
*  A. NORMAL DATA                                                       12240000
*                                                                       12260000
         MVC   8(7,R9),IOBDADAD         DATA=MBBCCHH FROM IOBB+32       12280000
         MVI   15(R9),X'00'             DATA=MBBCCHHR WITH R=0          12300000
*                                       DATA=MBBCCHHRF, F=00000III      12320000
         MVC   TSTWK1C(4),IOBDADAD+3    MOVE CCH FROM IOBB+32           12340000
         MVC   TSTWK2C(4),12(R7)        MOVE CCH FROM IXLT SX           12360000
         MVI   TSTWK1C+3,X'00'          ZERO TRACK NO.                  12420000
         MVI   TSTWK2C+3,X'00'          ZERO TRACK NO.                  12440000
ISLF421  CLC   TSTWK1C(4),TSTWK2C       CC IN IOBB+32 VS CC IN SK       12560002
         BNE   ISLF4215                 BR IF NOT EQUAL                 12580000
*                                                                       12600000
*                                       CCS EQUAL                       12620000
         MVI   17(R9),X'1B'             DATA=MBBCCHHRFP WITH P=1B       12640000
         B     ISLF424                                                  12660000
*                                                                       12680000
*                                       UNEQUAL                         12700000
ISLF4215 EQU   *                                                 Y02072 12720002
*                                                                       12840000
ISLF422  MVI   17(R9),X'0B'             DATA=MBBCCHHRFP WITH P=0B       12860000
*                                                                       12880000
*                                       SET CQ43 (CP21) TO ADDRESS KEY  12900000
*                                       OF LAST RECORD IN LAST BUFFER   12920000
*                                                                       12940000
ISLF424  L     R10,24(R10)              C(R10)=A(CP21-CQ40)             12960000
         L     R4,ISLKEYAD              C(R4)=A(KEY OF LAST WR CKD)     12980000
         IC    R5,24(R10)               SAVE OP                         13000000
         ST    R4,24(R10)               STORE ADDR OF KEY               13020000
         STC   R5,24(R10)               RESTORE OP                      13040000
*                                                                       13060000
         B     ISLF440                                                  13080000
*                                                                       13100000
*                                                                       13120000
*                                       DUMMY SW ON                     13140000
*  B. DUMMY DATA                                                        13160000
*                                                                       13180000
*                                       TEST CC+1 VS DEBENDCC FOR       13200000
*                                       POSSIBLE END OF INDEX EXTENT    13220000
*                                                                       13240000
ISLF430  EQU   *                                                        13260000
         SR    R6,R6                                                    13280000
         IC    R6,9(R7)                 C(R6) = M FROM IXLT SX, 000M    13300000
         S     R6,ISL1                  C(R6) = M-1 (M=1 FOR EXTENT 0)  13320000
         SLL   R6,4                     C(R6) = M-1 X 16 (USE AS INDX)  13340000
*                                                                       13360000
         LR    R9,R0                    RESTORE DEB POINTER             13410000
         USING IHADEB,R9                *                               13412000
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  13420000
         DROP  R9                                                       13430000
         LA    R4,0(R6,R4)              C(R4)=A(CURR INDX EXTENT ENTRY) 13440000
*                                                                       13460000
         MVC   TSTWK1C(4),10(R4)        CCHH - END OF CURRENT EXTENT    13480000
         L     R4,TSTWK1C               C(R4)=CCHH  TRK=0 FOR 2301      13520000
         MVC   TSTWK1C(4),12(R7)        CCHH FROM IXLT                  13540000
         L     R3,TSTWK1C               C(R3)=CCHH   CURRENT CYL ADDR.  13580000
*                                                                       13700000
         IC    R4,ISL0                  SET TRACK=0              Y02072 13720002
*                                                                       14040000
         SRL   R3,16                    C(R3)=00CC               Y02072 14060002
         LA    R3,1(R3)                 CYL+1                           14080000
         SLL   R3,16                    C(R3)=CC00   CC= CYL=1          14100000
*                                                                       14120000
         CR    R3,R4                    COMP NEXT CC VS END CC IN DEB   14160000
         BH    ISLF431                  B IF NEXT CC HIGH               14180000
*                                                                       14200000
*                                       NEXT CC IS IN CURRENT EXTENT    14220000
         L     R9,0(R10)                C(R9)=A(AREA Y)                 14240000
         MVC   8(3,R9),9(R7)            DATA = MBB FROM IXLT SX         14260000
         ST    R3,TSTWK1C                                               14280000
         MVC   11(4,R9),TSTWK1C         DATA=MBBCCHH  CYL+1, TRK=0      14300000
         B     ISLF432                                                  14320000
*                                                                       14340000
*                                       NEXT CC IS IN NEW EXTENT        14360000
ISLF431  SRL   R6,4                     C(R6) = M-1                     14380000
         A     R6,ISL1                  C(R6) = M FOR NEXT EXTENT       14400000
         SLL   R6,4                     C(R6) = M X 16 (USE AS INDX)    14420000
         LR    R9,R0                    RESTORE DEB POINTER             14430000
         USING IHADEB,R9                *                               14432000
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  14440000
         DROP  R9                                                       14450000
         LA    R4,0(R6,R4)              C(R4)=A(NEXT INDX EXTENT ENTRY) 14460000
*                                                                       14480000
         L     R9,0(R10)                C(R9)=A(AREA Y)                 14500000
         MVC   9(6,R9),4(R4)            DATA = BBCCHH FROM NEW EXTENT   14520000
         SRL   R6,4                     C(R6) = M FOR NEXT EXTENT       14540000
         A     R6,ISL1                  C(R6) = M+1 (M=1 FOR EXTENT 0)  14560000
         STC   R6,8(R9)                 DATA = MBBCCHH OF NEW EXTENT    14580000
*                                                                       14600000
ISLF432  MVI   15(R9),X'00'             DATA=MBBCCHHR, R=0              14620000
         OI    16(R9),X'28'             DATA=MBBCCHHRF, F=00101III      14640000
         MVI   17(R9),X'07'             DATA=MBBCCHHRFP WITH P=07       14660000
*                                                                       14680000
*                                       SET CQ43 (CP21) TO ADDRESS KEY  14700000
*                                       OF ALL ONES AT Y+62             14720000
*                                                                       14740000
         L     R10,24(R10)              C(R10)=A(CP21-CQ40)             14760000
         LA    R4,62(R9)                C(R4)=A(AREA Y +62)             14780000
         IC    R5,24(R10)               SAVE OP                         14800000
         ST    R4,24(R10)               STORE ADDR OF KEY OF ONES       14820000
         STC   R5,24(R10)               RESTORE OP                      14840000
*                                                                       14860000
*                                                                       14880000
* PLACE IXLT SX IN IOBB+32                                              14900000
*                                                                       14920000
ISLF440  MVC   IOBDADAD(8),9(R7)        C(IOBB+32)=C(IXLT SX), MBBCCHHR 14940000
ISLF441  EQU   *                                                        14942013
         SR    R13,R13                                                  14948000
         IC    R13,IOBDADAD                                             14950000
         SLL   R13,4                                                    14952000
         LR    R9,R0                    RESTORE DEB POINTER             14952400
         LA    R13,32(R9,R13)           POINT TO EXTENT                 14952500
         MVC   IOBDADAD+2(1),5(R13)     MOVE BB                         14956000
*                                                                       14960000
*                                                                       14980000
* EXCP RETURN TO IOS - EXECUTE CP21 TO WRITE MASTER INDEX               15000000
*                                                                       15020000
         BAL   R13,EXCPRTRN             EXCP HOUSEKEEP            15924 15040016
         B     EXCP(R14)                TAKE EXCP IOS RETURN      15924 15060016
*                                                                       15080000
*                                                                       15100000
* NORMAL RETURN TO IOS - SET C-BIT OFF AND EXIT                         15120000
*      * ADDR OF STATUS BYTE WITH CURRENT                               15140000
*        C-BIT IS IN CP21 AT CQ41 *                                     15160000
*                                                                       15180000
ISLF450  L     R10,24(R10)              C(R10)=A(CP21-CQ41)             15200000
         L     R7,12(R10)               C(R7)=A(LAST SLOT SCHED)        15220000
         NI    0(R7),X'FB'              TURN S BIT 5 OFF (C-BIT)        15240000
         B     ISLF115                 *NORMAL EXIT                     15260000
*                                                                       15280000
         EJECT                                                          15300000
*********************************************************************** 15320000
* CHART F5 - APPENDAGE CYL DUMMY, CP21 CHANNEL END - ENTERED FROM F4  * 15340000
*********************************************************************** 15360000
*                                                                       15380000
* A DUMMY-CYLINDER INDEX ENTRY HAS JUST BEEN WRITTEN AS THE LAST ENTRY  15400000
* ON THE PREVIOUS TRACK. THE DATA PORTION OF THAT ENTRY CONTAINS THE    15420000
* CYLINDER AND TRACK ADDRESS OF THE REAL CYLINDER INDEX ENTRY. THE REAL 15440000
* CYLINDER INDEX ENTRY MUST NOW BE WRITTEN ON THE NEW TRACK.            15460000
*                   * R7 POINTS TO CYLINDER IXLT LEVEL *                15480000
*                                                                       15500000
* TURN DUMMY SW OFF                                                     15520000
*                                                                       15540000
ISLF501  NI    0(R7),X'BF'              SET LEVEL IND BIT-1 OFF         15560000
*                                                                       15580000
*                                                                       15600000
* UPDATE STEPPING COUNT USING DUMMY DATA CONTENTS, PLACE IN IOBB+32     15620000
*                                                                       15640000
         MVC   9(8,R7),8(R9)            C(S0)=MBBCCHHR FROM AREA Y +8   15660000
         MVC   IOBDADAD(8),9(R7)        C(IOBB+32)=C(IXLT S0), MBBCCHHR 15680000
*                                                                       15700000
* CONSTRUCT COUNT FOR CYLINDER INDEX ENTRY IN AREA Y, Y+0               15720000
*                                                                       15740000
         MVC   0(4,R9),12(R7)           COUNT = CCHH FROM IXLT SX       15760000
         MVI   4(R9),X'01'              COUNT = CCHHR WITH R=1          15780000
*                                                                       15800000
* CONSTRUCT DATA FOR CYLINDER INDEX ENTRY IN AREA Y, Y+8                15820000
*                                                                       15840000
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   15860000
         MVC   8(7,R9),IOBDADAD         DATA=MBBCCHH FROM IOBA+32       15880000
         MVI   14(R9),X'00'             SET TO TRACK 0                  15960002
*                                                                       15980000
ISLF5017 EQU   *                                                        16000000
         CLC   DCBFIRSH(2),ISL0         TEST HH OF FIRSH VS 00          16020000
         BNE   ISLF502                  B IF HH NOT 00                  16040000
*                                       HH OF FIRSH = 00                16060000
         MVC   15(1,R9),DCBFIRSH+2      DATA = MBBCCHHR WITH R OF FIRSH 16080000
         B     ISLF503                                                  16100000
*                                       HH OF FIRSH NOT 00              16120000
ISLF502  MVI   15(R9),X'00'             DATA = MBBCCHHR WITH R=00       16140000
ISLF503  MVI   16(R9),X'01'             DATA = MBBCCHHRF WITH F = 01    16160000
*                                                                       16180000
         SR    R6,R6                                                    16200000
         IC    R6,9(R7)                 C(R6) = M FROM IXLT S0          16220000
         S     R6,ISL1                  C(R6) = M-1 (M=1 FOR EXTENT 0)  16240000
         SLL   R6,4                     C(R6) = M-1 X 16 (USE AS INDX)  16260000
*                                                                       16280000
         SR    R5,R5                                                    16300000
         IC    R5,IOBDADAD              C(R5) = M FROM IOBA+32          16320000
         S     R5,ISL1                  C(R5) = M-1 (M=1 FOR EXTENT 0)  16340000
         SLL   R5,4                     C(R5) = M-1 X 16 (USE AS INDX)  16360000
*                                                                       16380000
         LR    R9,R0                    RESTORE DEB POINTER             16430000
         USING IHADEB,R9                *                               16432000
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  16440000
         LA    R4,0(R6,R4)              C(R4)=A(CURR INDX EXTENT ENTRY) 16460000
         L     R3,DEBFPEAD              C(R3)=A(1ST PRIM EXTENT ENTRY)  16480000
         LA    R3,0(R5,R3)              C(R3)=A(CURR PRIM EXTENT ENTRY) 16500000
         DROP  R9                                                       16510000
         L     R9,0(R10)                C(R9)=A(AREA Y)                 16520000
*                                                                       16540000
         LA    R2,ISLIOBB                                               16545013
         MVC   IOBDADAD+1(2),4(R4)      MOVE DEB BB TO IOB              16550013
*                                                                       16555013
         CLC   1(3,R3),1(R4)            COMP UCB ADDRS, PRIM VS INDX    16560000
         BNE   ISLF504                  B IF NOT EQUAL                  16580000
*                                                                       16600000
*                                       UCBS EQUAL                      16620000
*                                                                       16720000
ISLF5039 EQU   *                                                        16740000
         MVI   17(R9),X'0B'             DATA = MBBCCHHRFP WITH P=0B     16760000
         B     ISLF505                                                  16780000
*                                                                       16800000
*                                       UCBS UNEQUAL                    16820000
ISLF504  MVI   17(R9),X'07'             DATA = MBBCCHHRFP WITH P=07     16840000
*                                                                       16860000
*                                       SET CQ43 (CP21) TO ADDRESS KEY  16880000
*                                       OF LAST RECORD IN LAST BUFFER   16900000
*                                                                       16920000
ISLF505  L     R10,24(R10)              C(R10)=A(CP21-CQ40)             16940000
         L     R4,ISLKEYAD              C(R4)=A(KEY OF LAST WR CKD)     16960000
         IC    R5,24(R10)               SAVE OP                         16980000
         ST    R4,24(R10)               STORE ADR OF KEY                17000000
         STC   R5,24(R10)               RESTORE OP                      17020000
*                                                                       17040000
*                                                                       17060000
* EXCP RETURN TO IOS - EXECUTE CP21 TO WRITE CYLINDER INDEX             17080000
*                                                                       17100000
         BAL   R13,EXCPRTRN             EXCP HOUSEKEEP            15924 17120016
         B     EXCP(R14)                TAKE EXCP IOS RETURN      15924 17140016
*                                                                       17160000
         EJECT                                                          17180000
*********************************************************************** 17200000
* CHART F6 - APPENDAGE MST DUMMY, CP21 CHANNEL END - ENTERED FROM F4  * 17220000
*********************************************************************** 17240000
*                                                                       17260000
* A DUMMY MASTER INDEX ENTRY HAS JUST BEEN WRITTEN AS THE LAST ENTRY    17280000
* ON THE PREVIOUS TRACK. THE DATA PORTION OF THAT ENTRY CONTAINS THE    17300000
* CYLINDER AND TRACK ADDRESS OF THE REAL MASTER INDEX ENTRY. THE REAL   17320000
* MASTER INDEX ENTRY MUST NOW BE WRITTEN ON THE NEW TRACK.              17340000
*                   * R7 POINTS TO CURRENT IXLT LEVEL *                 17360000
*                                                                       17380000
* TURN DUMMY SW OFF                                                     17400000
*                                                                       17420000
ISLF601  NI    0(R7),X'BF'              SET LEVEL IND BIT-1 OFF         17440000
*                                                                       17460000
*                                                                       17480000
* UPDATE STEPPING COUNT USING DUMMY DATA CONTENTS, PLACE IN IOBB+32     17500000
*                                                                       17520000
         MVC   9(8,R7),8(R9)            C(SX)=MBBCCHHR FROM AREA Y +8   17540000
         MVC   IOBDADAD(8),9(R7)        C(IOBB+32)=C(IXLT SX), MBBCCHHR 17560000
*                                                                       17580000
* CONSTRUCT COUNT FOR MASTER INDEX ENTRY IN AREA Y, Y+0                 17600000
*                                                                       17620000
         MVC   0(4,R9),12(R7)           COUNT = CCHH FROM IXLT SX       17640000
         MVI   4(R9),X'01'              COUNT = CCHHR WITH R=1          17660000
*                                                                       17680000
* CONSTRUCT DATA FOR MASTER INDEX ENTRY IN AREA Y, Y+8                  17700000
*                                                                       17720000
         STC   R5,16(R9)                STORE LEVEL IN F-BYTE 00000III  17740000
*                                                                       17760000
         MVI   15(R9),X'00'             DATA WITH R=0                   17780000
*                                                                       17800000
         LR    R5,R7                    C(R5)=A(CURRENT LEVEL IXLT)     17820000
         S     R5,ISL26                 C(R5)=A(NEXT LOWER LEVEL IXLT)  17840000
         MVC   8(6,R9),9(R5)            DATA=MBBCCH OF LOWER LEVEL SX   17860000
         IC    R4,15(R5)                C5R4)=H OF LOWER LEVEL SX       17880000
         TM    0(R5),X'40'              IS DUMMY BIT ON NEXT     A30945 17885020
*                                       * LOWER LEVEL                   17890020
         BO    ISLF6011                 YES - INDEX ENTRY OK     A30945 17895020
         BCTR  R4,0                     C(R4)=H-1                       17900000
ISLF6011 EQU   *                        *                        A30945 17910020
         MVC   TSTWK1C(4),12(R7)        MOVE CCHH FROM IXLT SX          17960000
*                                                                       18040000
         MVI   14(R9),X'00'             SET TRACK=0                     18060002
         MVI   TSTWK1C+3,X'00'          SET TRACK=0                     18080000
*                                                                       18100000
ISLF6015 CLC   11(4,R9),TSTWK1C         CCH0 IN IOBB+32 VS CCH0 IN SX   18120000
         STC   R4,14(R9)                SET H BACK TO TRACK ADDRESS     18140000
         BNE   ISLF6017                                                 18160000
*                                                                       18180000
*                                       CCS EQUAL                       18200000
         MVI   17(R9),X'1B'             DATA=MBBCCHHRFP WITH P=1B       18220000
         B     ISLF604                                                  18240000
*                                                                       18260000
*                                       UNEQUAL                         18280000
ISLF6017 EQU   *                                                        18300000
*                                       CCS UNEQUAL                     18460000
ISLF602  MVI   17(R9),X'0B'             DATA=MBBCCHHRFP WITH P=0B       18480000
*                                                                       18500000
*                                       SET CQ43 (CP21) TO ADDRESS KEY  18520000
*                                       OF LAST RECORD IN LAST BUFFER   18540000
*                                                                       18560000
ISLF604  L     R10,24(R10)              C(R10)=A(CP21-CQ40)             18580000
         L     R4,ISLKEYAD              C(R4)=A(KEY OF LAST WR CKD)     18600000
         IC    R5,24(R10)               SAVE OP                         18620000
         ST    R4,24(R10)               STORE ADDR OF KEY               18640000
         STC   R5,24(R10)               RESTORE OP                      18660000
*                                                                       18680000
*                                                                       18700000
* EXCP RETURN TO IOS - EXECUTE CP21 TO WRITE MASTER INDEX               18720000
*                                                                       18740000
         B     ISLF441                  GO GET DEB BB                   18760013
*                                          AND EXCP RETURN              18780013
*                                                                       18800000
         EJECT                                                          18820000
*********************************************************************** 18840000
* CHART F7 - APPENDAGE, ABNORMAL END                                  * 18860000
*********************************************************************** 18880000
*                                                                       18900000
* TEST IOB FOR PERMENANT ERROR                                          18920000
*                                                                       18940000
ISLF701  TM    IOBECBAD,X'20'           TEST BIT 2 OF ECBCC       11643 18960015
         BZ    ISLF702                  B IF PERMANENT ERROR      11643 18980015
         B     ISLF115                  NON-PERM ERR = NORMAL RETURN    19000000
*                                                                       19020000
* TEST IF CP18 HUNG ON A WR CKD                                         19040000
*                                                                       19060000
ISLF702  L     R3,IOBCSW                C(R3)=COMMAND ADDR+8     S20201 19080020
         LA    R3,0(R3)                                                 19100000
         S     R3,ISL8                  C(R3)=COMMAND ADDR OF LAST CCW  19120000
         L     R4,12(R10)               C(R4)=A(CP18)                   19140000
         LA    R4,24(R4)                C(R4)=A(CP18, 1ST WR CKD)       19160000
         L     R5,16(R10)               C(R5)=A(CP19)                   19180000
         S     R5,ISL16                 C(R5)=RA(CP18, LAST WR   S20201 19190020
*                                       CKD)                     S20201 19200020
         CR    R3,R4                    LAST CCW VS CP18 CCW 1          19220000
         BL    ISLF710                  B IF NOT IN CP18                19240000
         CR    R3,R5                    LAST CCW VS CP18 CCW N          19260000
         BH    ISLF710                  B IF NOT IN CP18                19280000
*                                                                       19300000
* CP18 HUNG ON A WR CKD - GET ADDR OF LAST BUFFER WRITTEN               19320000
*                                                                       19340000
         TM    0(R3),X'1D'              TEST FOR CCW WITH OP CODE       19360000
         BC    1,ISLF703                B IF FOUND                      19380000
         S     R3,ISL8                  BACK UP 1 CCW                   19400000
         TM    0(R3),X'1D'              TEST FOR CCW WITH OP CODE       19420000
         BC    1,ISLF703                B IF FOUND                      19440000
         S     R3,ISL8                  BACK UP 1 CCW                   19460000
*                                                                       19480000
ISLF703  L     R6,0(R3)                 C(R6)=DATA ADDR OF LAST WR CKD  19500000
         LA    R6,0(R6)                                                 19520000
         B     ISLF711                                                  19540000
*                                                                       19560000
ISLF710  SR    R6,R6                    ERROR NOT IN CP18, C(R6)=0      19580000
*                                                                       19600000
ISLF711  NI    IOBFLAG1,X'FB'           TURN OFF EXCEPTION FLAG   15924 19620016
         OI    DCBEXCD1,X'04'           SET EXCD1 BIT 5 ON = WR ERROR   19640000
         STCM  R6,LO3BYTES,ISLVPTRA+1   SAVE A(BAD BUFFER),     XA04602 19670002
*                                       KEEP FTIW FLAGS         XA04602 19680002
         LA    R3,IOBS                  C(R3)=A(BUF 1 STATUS)           19700000
*                                                                       19720000
ISLF712  NI    0(R3),X'B0'              TURN BIT 1 OFF                  19740000
         OI    0(R3),X'20'              TURN BIT 2 ON                   19760000
         A     R3,ISL4                  BUMP R3 TO NEXT SLOT            19780000
         C     R3,ISLBUFN               TEST FOR NTH SLOT               19800000
         BNH   ISLF712                  LOOP UNTIL ALL STATUS = 01      19820000
*                                                                       19840000
         B     ISLF125                                                  19860000
*                                                                       19880000
         SPACE 4                                                        19900002
*                                                                       19920000
* CONSTANTS                                                             19940000
*                                                                       19960000
ISL0     DC    F'0000'                                                  19980000
ISL1     DC    F'0001'                                                  20000000
ISL4     DC    F'0004'                                                  20020000
ISL8     DC    F'0008'                                                  20040000
ISL10    DC    F'0010'                                                  20060000
ISL16    DC    H'16'                    CONSTANT                 S20201 20070020
ISL26    DC    F'0026'                                                  20080000
ISLFF    DC    F'8888'                                                  20100000
KEY0     EQU   ISL0                     STORAGE PROTECT KEY ZERO Y02072 20110002
*                                                                       20120000
PATCH    DC    XL((*-IGG019GC)/20)'00'  ZEROED PATCH AREA        Y02072 20130002
*                                                                       20140002
         END                                                            20160000
