 TITLE 'IGG019GD  - APPENDAGE ROUTINES, WR CHK'                         00020000
IGG019GD CSECT                                                          00030000
*          RELEASE OS/VS2-02 DELETIONS                                  00052002
*          RELEASE 19 DELETIONS                                       * 00052402
*2182068800-069200                                               A28706 00052519
*2182035000-035100,223200,234800-235000,236800                   O19110 00053019
*2182066000                                                      A27321 00053519
*          RELEASE 20 DELETIONS                                       * 00054000
*0492                                                            A30945 00054520
*0492223200,234800,236800                                        A32559 00055020
*0492015000,015200-022000,022400,022600,022800-035600,085000,    S20201 00055120
*0492085400,086800,088000,088200,088400,091200,091600,092400,    S20201 00055220
*0492096200,096400,100000,100200,100500,106200,106400,106600,    S20201 00055320
*0492106800,111600,112600,112800,113000,113400,114000,114200,    S20201 00055420
*0492114400,116800,117000,117200,117600,118200,118400,118600,    S20201 00055520
*0492213000,231600,232200,232400,232600,233000,233600,233800,    S20201 00055620
*0492234000,240200                                               S20201 00055720
*          RELEASE 21 DELETIONS                                       * 00056000
*3529046200,052400,052800                                        S21045 00057021
*3529210200-211200,221800-222000,223000-223400,225600-225800,    A42170 00057321
*3529226000-229950,234800-234900,235800,236800                   A42170 00057621
*D069300                                                        SA55487 00057702
*C218500                                                        XA04602 00067702
*STATUS CHANGE LEVEL 012                                                00068002
*                                                                     * 00080000
*FUNCTION/OPERATION- THIS MODULE CONTAINS THE APPENDAGE ROUTINES FOR  * 00100000
*   PROCESSING ALL LOAD MODE I/O RETURNS. THE CHANNEL END APPENDAGE   * 00120000
*   ROUTINES SIGNAL THE COMPLETION OF INDEX AND/OR BUFFER WRITING.    * 00140000
*   THE ABNORMAL APPENDAGE ROUTINE PREPARES FOR AN ABNORMAL TERMIN-   * 00160000
*   ATION OF THE JOB.  THIS MODULE SUPPORTS BOTH FIXED AND              00186018
*   VARIABLE LENGTH RECORD FORMATS.                                     00192018
*                                                                     * 00200000
*ENTRY POINTS- 'IGG019GD' IS THE ENTRY POINT WHEN NO APPENDAGE        * 00220000
*   PROCESSING IS REQUIRED.                                           * 00240000
*              'IGG019GD+4' IS THE ENTRY POINT FOR CHANNEL END        * 00260000
*   APPENDAGE PROCESSING.                                             * 00280000
*              'IGG019GD+12' IS THE ENTRY POINT FOR ABNORMAL END      * 00300000
*   APPENDAGE PROCESSING.                                             * 00320000
*   ACCESS TO THIS MODULE IS PROVIDED BY A VECTOR OF FIVE ADDRESSES   * 00340000
*   LOCATED AT DEB-36.                                                * 00360000
*                                                                     * 00380000
*INPUT- REGISTER 2  -POINTS TO IOB.                                   * 00400000
*       REGISTER 3  -POINTS TO DEB.                                   * 00420000
*       REGISTER 4  -POINTS TO DCB.                                   * 00440000
*       REGISTER 14 -POINTS TO RETURN FROM APPENDAGE.                 * 00460000
*                                                                     * 00480000
*OUTPUT- SAME REGISTER SETTING AS INPUT.                              * 00500000
*                                                                     * 00520000
*EXTERNAL ROUTINES- THIS MODULE WORKS IN CONJUNCTION WITH LOAD MODE   * 00540000
*   PUT (IGG019GB), CHANNEL PROGRAMS, AND IOS.                        * 00560000
*                                                                     * 00580000
*EXITS-NORMAL- (ISLF115) FOR NORMAL RETURN TO IOS, CHANNEL END.       * 00600000
*              (ISLF340) FOR EXCP RETURN TO IOS - CP19.               * 00620000
*              (ISLF440) FOR EXCP RETURN TO IOS - CP21.               * 00640000
*              (ISLF505) FOR EXCP RETURN TO IOS - CP21 CYL DUMMY.     * 00660000
*              (ISLF604) FOR EXCP RETURN TO IOS - CP21 MAST DUMMY.    * 00680000
*              (ISLF761) FOR EXCP RETURN TO IOS - WR ERR RETRY.       * 00700000
*              (ISLF125) FOR NORMAL RETURN TO IOS, ABNORMAL.          * 00720000
*                                                                     * 00740000
*TABLES/WORK AREAS-                                                   * 00760000
*   DCB      - COMMUNICATION WITH USER.                               * 00780000
*   DEB      - COMMUNICATION WITH IOS.                                * 00800000
*   ISLCOMON - COMMUNICATION WITHIN LOAD MODE.                        * 00820000
*   ISLIOBA  - COMMUNICATION WITH I/O FOR CP18 AND CP20.              * 00840000
*   ISLIOBB  - COMMUNICATION WITH I/O FOR CP21.                       * 00860000
*   ISLIOBC  - COMMUNICATION WIT I/O FOR CP19.                        * 00880000
*   ISLAREAZ - WORK AREA USED FOR PREFORMATTING.                      * 00900000
*   ISLIXLT  - INDEX LOCATION TABLE, LOCATES HI-LEVEL INDICIES.       * 00920000
*   ISLY     - WORK AREA USED WHEN WRITING INDICIES.                  * 00940000
*   ISLVPTRS - VARIABLE POINTERS, REFERENCE VARIABLE LENGTH BLOCKS.   * 00960000
*   IOBBCT   - BUFFER CONTROL TABLE, CONTROLS BUFFER USAGE.           * 00980000
*                                                                     * 01000000
*ATTRIBUTES- READ ONLY, REENTRANT, PRIVILEGED, DISABLED, REUSABLE.    * 01020000
*                                                                     * 01040000
*NOTES- SECTIONS OF THE PROCESSING IN THIS MODULE ARE ENTERED         * 01060000
*   DIRECTLY FROM CLOSE PROCESSING. IN SUCH CASES, PROCESSING IS      * 01080000
*   CARRIED ON AS THOUGH IT WAS PART OF CLOSE.                        * 01100000
*        ENTRY POINT - ISLF110                                        * 01120000
*                                                                     * 01140000
*    ****************************************************************** 01160000
*    THE FOLLOWING NOTATION IS FREQUENTLY USED THROUGHOUT COMMENTS -  * 01180000
*              C(FIELD X) = A(FIELD Y)                                * 01200000
*     CONTENTS OF FIELD X = ADDRESS OF FIELD Y                        * 01220000
*    ****************************************************************** 01240000
*                                                                     * 01260000
         EJECT                                                          01280000
********************                                                    01320000
* DCB REFERENCE    *                                                    01340000
********************                                                    01360000
         DCBD  DSORG=(IS)                                               01380000
         USING IHADCB,R1                                                01400000
         EJECT                                                          01420000
********************                                                    01440000
* DEB REFERENCE    *                                                    01460000
********************                                                    01480000
IHADEB   IGGDEBD                                                        01490020
         EJECT                                                          02220000
ISLCOMON IGGLOAD                                                        02230020
         USING ISLCOMON,R12                                      S20201 02240020
         SPACE 1                                                        02260002
*                                                                       03580000
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03600000
*                                                                       03620000
IOBBCT   DSECT                                                          03640000
         USING IOBBCT,R11                                               03660000
         DS    0D                                                       03680000
IOBFLAGS DS    0CL1                     FLAGS                           03700000
IOBPTRA  DS    A                        PTR A                           03720000
IOBB     DS    0CL1                     B                               03740000
IOBPTRB  DS    A                        PTR B                           03760000
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03780000
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03800000
         EJECT                                                          03804020
LDCPS    DSECT                                                          03808020
         IGGLDCP                        OPTCD=W LOAD CHANNEL     S20201 03812020
*                                       PROGRAMS                 S20201 03816020
         EJECT                                                          03820000
********************                                                    03840000
* IOB REFERENCE    *                                                    03860000
********************                                                    03880000
*                                                                       03900000
IHAIOB   DSECT                                                          03920000
         USING IHAIOB,R2                                                03940000
         DS    0D                                                       03960000
IOBFLAG1 DS    CL1                      FLAGS 1                   15924 03980016
IOBFLAG2 DS    CL1                      FLAGS 2                   15924 04000016
         DS    CL1                                                      04020000
IOBSENSE DS    CL1                      SENSE                           04040000
IOBECBAD DS    A                        ECB POINTER                     04060000
IOBCSW   DS    CL8                      CHANNEL STATUS WORD             04080000
IOBSIOCC DS    0CL1                     SIO CC                          04100000
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       04120000
IOBWT    DS    0CL1                     WEIGHT                          04140000
IOBDCBAD DS    A                        DCB POINTER                     04160000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     04180000
IOBBCTI  DS    CL2                      BLK CTR INCR                    04200000
IOBERRCT DS    CL2                      ERROR COUNT               15924 04220016
IOBDADAD DS    CL8                      DIR ACESS DEV ADR MBBCCHHR      04240000
*                                                                       04260000
********************                                                    04280000
* IXLT REFERENCE   *                                                    04300000
********************                                                    04320000
*                                                                       04340000
IXLT     DSECT                                                          04360000
         USING IXLT,R7                                                  04380000
         DS    0D                                                       04400000
IXLTIND  DS    CL1                      INDICATOR                  LEV1 04420000
IXLBEG   DS    CL8                      BEGINING COUNT MBBCCHHR         04440000
IXLSTP   DS    CL8                      STEPPING COUNT MBBCCHHR         04460000
IXLEND   DS    CL8                      ENDING COUNT   MBBCCHHR         04480000
         DS    CL1                                                      04500000
         DS    CL26                                                LEV2 04520000
         DS    CL26                                                LEV3 04540000
         DS    CL26                                                LEV4 04560000
         EJECT                                                          04580000
REGSAVE  DSECT                          REGISTER SA FROM IOS     Y02072 04590002
REGSAV14 DS    F                        REGISTER 14              Y02072 04598002
REGSAV15 DS    F                        REGISTER 15              Y02072 04598402
REGSAV0  DS    F                        REGISTER 0               Y02072 04598802
REGSAV1  DS    F                        REGISTER 1               Y02072 04599202
REGSAV2  DS    F                        REGISTER 2               Y02072 04599602
REGSAV3  DS    F                        REGISTER 3               Y02072 04599702
REGSAV4  DS    F                        REGISTER 4               Y02072 04599802
REGSAV5  DS    F                        REGISTER 5               Y02072 04599902
REGSAV6  DS    F                        REGISTER 6               Y02072 04613202
REGSAV7  DS    F                        REGISTER 7               Y02072 04623202
REGSAV8  DS    F                        REGISTER 8               Y02072 04625202
REGSAV9  DS    F                        REGISTER 9               Y02072 04625602
REGSAV10 DS    F                        REGISTER 10              Y02072 04626002
REGSAV11 DS    F                        REGISTER 11              Y02072 04626402
REGSAV12 DS    F                        REGISTER 12              Y02072 04626502
REGSAV13 DS    F                        REGISTER 13              Y02072 04629802
         EJECT                                                          04633402
IGG019GD CSECT                                                          04636702
*                                                                       04640000
* EQUATE SYMBOLIC REGISTERS                                             04660000
*                                                                       04680000
R0       EQU   0                                                        04700000
R1       EQU   1                                                        04720000
R2       EQU   2                                                        04740000
R3       EQU   3                                                        04760000
R4       EQU   4                                                        04780000
R5       EQU   5                                                        04800000
R6       EQU   6                                                        04820000
R7       EQU   7                                                        04840000
R9       EQU   8                                                        04880000
R10      EQU   10                                                       04900000
R11      EQU   11                                                       04920000
R12      EQU   12                                                       04940000
R13      EQU   13                                                       04960000
R14      EQU   14                                                       04980000
R15      EQU   9                                                        05000000
R16      EQU   15                                                       05020000
EXCP     EQU   8                                                  15924 05030016
LO3BYTES EQU   7                        STORE LOW 3 ORDER BYTES  Y02072 05030402
ALL      EQU   X'FF'                    ALL SWS ON               S20201 05030920
CM24X    EQU   CM2+4                    COUNT FOR MULTIPLE CPQ9  S20201 05031820
*                                       * EXECUTIONS.                   05032720
CM64     EQU   CM6+4                    FIRST TIME INDICATOR     S20201 05033620
CM264    EQU   CM26+4                   LAST CC SPOT             S20201 05034520
CM273    EQU   CM27+3                   CCHHR FOR CM5            S20201 05035420
L4       EQU   4                        LENGTH                   S20201 05036320
CM34     EQU   CM3+4                    CONTROL BYTE OF READ     S20201 05037220
CM74     EQU   CM7+4                    CONTROL BYTE OF READ     S20201 05038120
CM84     EQU   CM8+4                    CONTROL BYTE             S20201 05039020
FLAGS    EQU   10                       FLAG BYTE IN TISA               05039201
CP20CNXT EQU   X'02'                    SCHEDULE CP20C NEXT             05039301
CP18NEXT EQU   X'01'                    SCHEDULE CP18 NEXT              05039401
CP20LAST EQU   CP18NEXT+CP20CNXT        LAST CP SCHEDULED               05039501
*                                                                       05040000
         EJECT                                                          05060000
*********************************************************************** 05080000
* GENERAL APPENDAGE ROUTINE                                           * 05100000
*********************************************************************** 05120000
*                                                                       05140000
*                                                                       05160000
* APPENDAGE ROUTINE ENTRANCES                                           05180000
*                                                                       05200000
         B     0(R14)                   NO APPENDAGE RT, RETURN TO IOS  05220000
         USING *+8,R15                                           S21045 05228021
CE       LA    R15,TWOINSTR(R16)        SET COMMON BASE          S21045 05236021
TWOINSTR EQU   8                        LENGTH OF TWO            S21045 05244021
*                                       INSTRUCTIONS             S21045 05252021
         B     ISLF110                  B TO CE RT                      05260000
ABE      LR    R15,R16                  SET COMMON BASE          S21045 05280021
         B     ISLF120                  B TO AE RT                      05300000
*                                                                       05320000
         EJECT                                                          05340000
*                                                                       05360000
* CE ENTRANCE AND EXIT                                                  05380000
**********************                                                  05400000
*                                                                       05420000
ISLF110  EQU   *                                                 Y02072 05440002
         BAL   R12,ISLF130              LINK TO COMMON HSK       Y02072 05450002
*                                                                       05460000
* LOCATE PROPER CHANNEL END APPENDAGE ROUTINE                           05480000
*                                                                       05500000
         LA    R3,0(R2)                 C(R3)=A(IOBX)                   05520000
         LA    R4,ISLIOBB               C(R4)=A(IOBB)                   05540000
         CR    R3,R4                    COMP IOBX VS IOBB               05560000
         BH    ISLF331                  B IF IOBX = IOBC (CP19)         05580000
         BE    ISLF401                  B IF IOBX = IOBB (CP21)         05600000
         B     ISLF201                  * B IF IOBY=IOBA(CP18-20) 13334 05620016
*                                                                       05640000
*                                                                       05660000
ISLF115  BAL   R13,ISLF140              LINK TO COMMON END              05680000
         B     0(R14)                   NORMAL RETURN TO IOS            05700000
*                                                                       05720000
*                                                                       05740000
* AE ENTRANCE AND EXIT                                                  05760000
**********************                                                  05780000
*                                                                       05800000
ISLF120  EQU   *                                                 Y02072 05820002
         BAL   R12,ISLF130              LINK TO COMMON HSK       Y02072 05830002
         TM    DCBEXCD1,X'04'           TEST EXCD1 BIT 5 FOR PREV ERR   05840000
         BC    1,ISLF125                B IF ON, ONLY 1 ERR PER JOB     05860000
         B     ISLF731                  B TO ABNORMAL APPENDAGE         05880000
*                                                                       05900000
ISLF125  BAL   R13,ISLF140              LINK TO COMMON END              05920000
         B     0(R14)                   NORMAL RETURN TO IOS            05940000
*                                                                       05960000
*                                                                       05980000
* COMMON APPENDAGE HOUSEKEEPING                                         06000000
*********************************************************************** 06020000
*                                                                       06040000
ISLF130  EQU   *                                                 Y02072 06060002
         STM   R14,R13,0(R13)           SAVE REGS IN IOS SA      Y02072 06070002
         LR    R14,R13                  SAVE ADDR OF SAVE AREA   Y02072 06072002
         USING IHADEB,R3                                         Y02072 06074002
*                                                                       06074402
         MODESET  KEYADDR=DEBPROTG,WORKREG=13  SET USERS KEY     Y02072 06076002
*                                                                       06076402
         LR    R13,R12                  SAVE RETURN ADDRESS      Y02072 06078002
         DROP  R3                                                Y02072 06078402
         LR    R1,R4                    C(R1)=A(DCB)                    06080000
         L     R12,DCBWKPT1             C(R12)=A(COMMON)                06100000
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 06140000
         L     R11,8(R10)               C(R11)=A(IOBBCT)                06160000
*                                       C(R2)=A(IOB) - GIVEN            06180000
         LR    R0,R3                    DEB ADDRESSABILITY              06190000
*                                                                       06200000
*                                                                       06220000
         BR    R13                      EXIT                            06240000
*                                                                       06242016
*                                                                       06244016
EXCPRTRN XC    IOBFLAG2(3),IOBFLAG2     CLEAR FLAG2,SENSE BYTES   15924 06246016
         XC    IOBCSW(9),IOBCSW         CLEAR FLAG3,CSW,SIOCC     15924 06248016
         XC    IOBERRCT(2),IOBERRCT     CLEAR ERROR COUNT         15924 06250016
         NI    IOBFLAG1,X'C2'           RESET FLAG1               15924 06252016
*                                                                       06260000
*                                                                       06280000
* COMMON APPENDAGE END                                                  06300000
*********************************************************************** 06320000
*                                                                       06340000
         USING REGSAVE,R14                                       Y02072 06350002
ISLF140  EQU   *                                                 Y02072 06360002
*                                                                       06392002
         MODESET  KEYADDR=KEY0,WORKREG=9  SET PROTECT KEY ZERO   Y02072 06394002
*                                                                       06396002
         LM    R14,R12,REGSAV14         RESTORE REGS FRM IOS SA  Y02072 06398002
         SR    R15,R15                  CLEAR 9                         06400000
*                                                                       06420000
         BR    R13                      EXIT                            06440000
         DROP  R14                                               Y02072 06450002
         EJECT                                                          06460000
*********************************************************************** 06480000
* CHART F2 - APPENDAGE, CP18 AND CP20 CHANNEL END                     * 06500000
*********************************************************************** 06520000
*                                                                       06540000
* SET FLAGS BIT 0 = 0, (IWR)- CP(S) IS NOW AVAILABLE                    06560000
*                                                                       06580000
ISLF201  EQU   *                                                 A27321 06590019
         MVI   DCBWKPT2,X'0A'           RESET RETRY COUNT        A42170 06595021
*                                                                       06601019
*              FOR FULL TRACK INDEX WRITE OPTION - IF CP20              06602019
*              WAS EXECUTED WITHOUT CP18 (BIT 4 OF FLAG FIELD           06603019
*              IN THE TRACK INDEX SAVE AREA IS ON) THEN RETURN          06604019
*              TO IOS WITHOUT UPDATING BUFFER POINTER.                  06605019
*                                                                       06606019
         TM    36(R10),X'C0'            SUCCESSFUL GETMAIN FOR   O19110 06607019
*                                       FULL TRACK INDEX WRITE          06608019
         BNO   ISLF2014                 NO - BR TO CONTINUE      O19110 06609019
         L     R4,36(R10)               C(R4)=A(FTIW TI SAVE     O19110 06610019
*                                       AREA)                           06610101
*   IF AOS CP20A OF B ,CP20C AND CP18 ARE SCHEDULED SEPARATELY AND      06610301
*   MUST BE RESTARTED FROM THIS APPENDAGE.                              06610401
         TM    FLAGS(R4),CP20LAST       FINISHED SCHEDULING             06610501
         BO    ISLF2014                 YES - DONE                      06610601
         TM    FLAGS(R4),CP20CNXT       IS IT NEXT                      06610701
         BZ    AOSNT20C                 NO - DON'T SCHEDULE IT          06610801
         MVC   IOBCPSAD,ISLVPTRC        ASSUME CP20C NEXT               06610901
         NI    FLAGS(R4),X'FF'-CP20CNXT RESET SW                        06611001
         OI    FLAGS(R4),CP18NEXT       SCHEDULE CP18 AFTERWORD         06611101
AOSEXCP  EQU   *                        EXCP CP 18 OR CP20C             06611201
         BAL   R13,EXCPRTRN             REFRESH IOB                     06611301
         B     EXCP(R14)                LINK TO IOS TO EXCP             06611401
AOSNT20C EQU   *                        SCHEDULE CP18 IF NECESSARY      06611501
         TM    10(R4),X'08'             CP20 EXECUTED ALONE      O19110 06612019
         BO    ISLF115                  YES-RETURN TO IOS EXIT   O19110 06613019
*   START CP 18 IF NECESSARY.                                           06614401
         TM    FLAGS(R4),CP18NEXT       SHOULD CP18 BE SCHE             06615101
         BNO   ISLF2014                 NO - FINISHED                   06615801
         MVC   IOBCPSAD,ISLVPTR4        ASSUME CP18 NEXT                06616501
         MVC   IOBDADAD,0(R4)           *                               06617201
         OI    FLAGS(R4),CP20LAST       MARK CP20 SCHEDULED             06617901
         B     AOSEXCP                  EXCP CP18                       06618601
*                                                                       06620000
* SET OFF STATUS BITS 1 AND 2, 00 = BUFFER AVAILABLE                    06640000
* SET OFF STATUS BIT 4, 0 = T-BIT OFF                                   06660000
* DO THIS FOR EACH BUFFER THAT WAS JUST WRITTEN AND UPDATE PTR A AT THE 06680000
* SAME TIME. AT FINISH, PTR A WILL POINT TO NEXT SLOT TO SCHEDULE FOR   06700000
* WRITING.                                                              06720000
*                                                                       06740000
ISLF2014 EQU   *                                                 O19110 06750019
         L     R3,IOBPTRA               C(R3)=A(1ST SLOT WRITTEN)       06760000
         LA    R3,0(R3)                                                 06780000
ISLF202  TM    0(R3),X'60'              TEST BITS 1 AND 2 VS 11         06800000
         BC    1,ISLF203                B IF BITS 1 AND 2 = 11          06820000
*                                                                       06840000
*                                       BITS 1 AND 2 NOT 11, FINISHED   06860000
         STCM  R3,LO3BYTES,IOBPTRA+L'IOBFLAGS  STORE FIRST SLOT  Y02072 06880002
*                                       ADDR INTO PTRA           A28706 06900002
         B     ISLF115                  NORMAL RETURN TO IOS EXIT       06940000
*---------------------------------------------------------------------- 06960000
*                                                                       06980000
ISLF203  NI    0(R3),X'97'              TURN BITS 1,2 AND 4 (IF ON) OFF 07000000
         A     R3,ISL4                  BUMP R3 TO ADR NEXT SLOT        07020000
         C     R3,ISLBUFN               TEST FOR ADR OF NTH SLOT        07040000
         BH    ISLF204                  B IF OUTSIDE TBL = WRAPAROUND   07060000
         B     ISLF202                  LOOP AGAIN                      07080000
*                                                                       07100000
*                                       WRAPAROUND                      07120000
ISLF204  LA    R3,IOBABUF               C(R3)=A(SLOT 1)                 07140000
         B     ISLF202                  LOOP AGAIN                      07160000
         EJECT                                                          07180000
*********************************************************************** 08260000
* CHART F3 - APPENDAGE, CP19 CHANNEL END                              * 08280000
*********************************************************************** 08300000
*                                                                       08320000
ISLF301  L     R10,16(R10)              C(R10)=A(CP19)                  08340000
         USING CM1,R10                  ADDRESSABILITY ON CP19   S20201 08350020
         CLC   12(4,R10),ISL0           TEST CM2+4 VS 0000 = 10 OR LESS 08360000
         BE    ISLF115                  B IF TEN OR LESS ENTRIES TO BE  08380000
*                                       PREFORMATTED FOR NORMAL IOS     08400000
*                                       RETURN.                         08420000
*                                                                       08440000
* MORE THAN TEN ENTRIES TO PREFORMAT                                    08460000
*                                                                       08480000
         CLC   CM64(L4),ISL0            TEST CM6+4 VS 0000 = 1ST S20201 08490020
*                                       CE                       S20201 08500020
         BE    ISLF302                  B IF 1ST CE FOR THIS CYLINDER   08520000
         CLC   CM64(L4),ISLFF           TEST CM6+4 VS FFFF = END S20201 08540020
         BNE   ISLF303                  B IF PREFORMATTING IN PROCESS   08560000
         B     ISLF320                  B IF END                        08580000
*                                                                       08600000
*                                                                       08620000
* 1ST CE WHILE PREFORMATTING THIS CYLINDER                              08640000
*                                                                       08660000
ISLF302  LA    R4,CM5                   C(R4)=A(CM5)             S20201 08680020
         IC    R5,IOBSIOCC              SAVE SIOCC                      08700000
         ST    R4,IOBCPSAD              STORE A(CM5) IN IOBC CP START   08720000
         STC   R5,IOBSIOCC              RESTORE SIOCC                   08740000
*                                                                       08760000
         LA    R4,35(R2)                CM5                             08780000
         IC    R5,CM5                                            S20201 08800020
         ST    R4,CM5                        STORE ADR IOBC+35   S20201 08820020
         STC   R5,CM5                                            S20201 08840020
*                                                                       08860000
* CALCULATE COUNT OF NO. OF EXECUTES OF CP19 FROM APPENDAGE             08880000
*                                                                       08900000
         SR    R4,R4                                                    08920000
         SR    R5,R5                                                    08940000
         IC    R5,DCBFIRSH+2            C(R5)=R OF FIRSH                08960000
         S     R5,ISL1                  DIVIDEND = 0000000N IN R4-R5    08980000
         D     R4,ISL10                 DIVISOR  = 000A                 09000000
*                                       C(R4) = REMAINDER R = 000R      09020000
*                                       C(R5) = QUOTIENT Q              09040000
         C     R4,ISL0                  TEST R VS 0                     09060000
         BNE   ISLF3025                 B IF R NOT 0                    09080000
         S     R5,ISL1                  R=0, ADJUST Q DOWNWARDS         09100000
ISLF3025 ST    R5,CM64                  C(CM6+4)=Q, Q GR 0       S20201 09120020
*                                                                       09140000
ISLF303  L     R5,CM64                  C(R5) = COUNT Q          S20201 09160020
         C     R5,ISL1                  TEST FOR LAST EXECUTE           09180000
         BE    ISLF305                  B IF LAST EXECUTE               09200000
         S     R5,ISL1                  DECREMENT COUNT Q               09220000
         ST    R5,CM64                  C(CM6+4) = Q, Q GR 0     S20201 09240020
*                                                                       09260000
* PREPARE TO EXECUTE PREFORMAT                                          09280000
*                                                                       09300000
ISLF304  LA    R9,ISLAREAZ              C(R9)=A(AREA Z)                 09320000
         MVC   37(3,R2),80(R9)          C(IOBC+37)=HHR FROM COUNT 10    09340000
         SR    R5,R5                                                    09360000
         IC    R5,82(R9)                C(R5)=R FROM COUNT 10           09380000
         BAL   R13,ISLF310              B TO SET UP AREA Z              09400000
*                                                                       09420000
* EXCP RETURN TO IOS - EXECUTE CP19 AGAIN                               09440000
*                                                                       09460000
         BAL   R13,EXCPRTRN             EXCP HOUSEKEEP            15924 09480016
         B     EXCP(R14)                TAKE EXCP IOS RETURN      15924 09500016
*                                                                       09520000
*                                                                       09540000
* PREPARE TO EXECUTE LAST PREFORMAT FOR THIS CYLINDER                   09560000
*                                                                       09580000
ISLF305  L     R4,ISLFF                 C(R4)=FFFF                      09600000
         ST    R4,CM64                  C(CM6+4) = FFFF = END    S20201 09620020
         L     R4,CM24X                 C(R4)=C(CM2+4)=A(CC      S20201 09630020
*                                       FLAG)                    S20201 09640020
         NI    0(R4),X'BF'              TURN CC FLAG OFF                09660000
         B     ISLF304                  B TO COMMON PREPARE             09680000
*                                                                       09700000
* SUBROUTINE TO SET UP AREA Z                                           09720000
*                                                                       09740000
ISLF310  L     R3,ISL10                 C(R3)=10  = LOOP COUNT          09760000
         LA    R4,10(R9)                C(R4)=A(Z+10) = 1ST R           09780000
ISLF311  A     R5,ISL1                  STEP R                          09800000
         STC   R5,0(R4)                 STORE R IN Z                    09820000
         A     R4,ISL8                  STEP Z                          09840000
         BCT   R3,ISLF311               LOOP                            09860000
         BR    R13                      EXIT                            09880000
*                                                                       09900000
*                                                                       09920000
* END OF APPENDAGE - RESET CONDITIONS                                   09940000
*                                                                       09960000
ISLF320  SR    R5,R5                                                    09980000
         ST    R5,CM64                  C(CM6+4) = 0000          S20201 10000020
         L     R4,CM24X                 C(R4)=C(CM2+4)=A(CC      S20201 10010020
*                                       FLAG)                    S20201 10020020
         OI    0(R4),X'40'              TURN CC FLAG BACK ON            10040000
         NI    CM264,ALL-CC             TURN OFF TENTH CC FLAG   S20201 10046020
*                                        1187                    S20201 10052020
         LA    R9,ISLAREAZ              C(R9)=A(AREA Z)                 10060000
         BAL   R13,ISLF310              B TO SET UP AREA Z, 1ST R = 1   10080000
*                                                                       10100000
         TM    DCBOPTCD,X'08'           TEST OPTCD BIT-4 FOR CYL OVFL   10120000
         BC    8,ISLF325                B IF NO CYL OVFL                10140000
*                                                                       10160000
*                                       CYL OVFL ON                     10180000
         IC    R5,IOBSIOCC              SAVE SIOCC                      10200000
         ST    R10,IOBCPSAD             STORE A(CM1) IN IOBC CP START   10220000
         STC   R5,IOBSIOCC              RESTORE SIOCC                   10240000
*                                                                       10260000
         MVI   39(R2),X'00'             SET R=0                         10300000
         MVI   38(R2),X'00'             SET TRACK=0                     10360000
ISLF3205 MVI   37(R2),X'00'             SET 1ST H TO ZERO               10420000
*                                                                       10440000
ISLF3207 EQU   *                                                        10460000
         CLI   DCBFIRSH+1,X'00'         FIRSH VS 0                      10480000
         BE    ISLF115                  B IF CYL OVFL RCD IS ON SHARED  10500000
*                                       TRACK = CM5 OK - EXIT,NORM RTRN 10520000
*                                                                       10540000
*                                       CYL OVFL RCD NOT ON SHARED TRK  10560000
         TM    IOBFLAGS,X'10'     CP 91 IN CONTROL                      10580000
         BO    ISLF115            YES, CP 91 IN CONTROL RETURN TO IOS   10600000
         LA    R4,CM273                 CM5                      S20201 10620020
         IC    R5,CM5                                            S20201 10640020
         ST    R4,CM5                     STORE ADR CM27+3       S20201 10660020
         STC   R5,CM5                                            S20201 10680020
*                                                                       10700000
         B     ISLF115                  EXIT,NORM RTRN                  10720000
*                                                                       10740000
*                                       NO CYL OVFL - CP START OK       10760000
ISLF325  EQU   *                                                        10780000
         MVI   39(R2),X'00'             SET R=0 IN IOBC+39              10800000
*                                                                       10920000
ISLF326  MVC   38(1,R2),DCBFIRSH+1      SET IOBC+38 TO TRACK FROM FIRSH 10940000
*                                       CM5 OK                          10960000
         B     ISLF115                  EXIT,NORM RTRN                  10980000
         EJECT                                                          11000000
*                                                                       11020000
* CHART F3 - EXTENTION FOR WR CHK                                       11040000
*                                                                       11060000
ISLF331  SR    R3,R3                                                    11080000
         MVI   DCBWKPT2+2,X'0A'         RESET RETRY COUNT        A42170 11090021
         IC    R3,ISL10+3               C(R3)=NO OF WR CKD CCWS         11100000
*                                                                       11120000
         L     R10,16(R10)              C(R10)=A(CP19)                  11140000
         CLI   CM3,X'06'                TEST CM3 OP CODE FOR     S20201 11150020
*                                       READ D                   S20201 11160020
         BE    ISLF341                  B IF CM3 = READ                 11180000
*                                                                       11200000
* SET UP CP19 TO READ BACK WHAT WAS JUST WRITTEN                        11220000
*                                                                       11240000
         MVI   CM3,RDATA                SET CM3 OP CODE TO READ  S20201 11250020
*                                       D                        S20201 11260020
         OI    CM34,SKIP                SET CM3 FLAGS TO SKIP    S20201 11280020
         CLI   CM7,X'0D'                TEST CM7 FOR WR KD       S20201 11290020
*                                       (CLOSE)                  S20201 11300020
         BNE   ISLF332                  B IF NOT WR KD                  11320000
         MVI   CM7,RKD                  SET CM7 TO RD KD         S20201 11340020
         B     ISLF333                                                  11360000
*                                                                       11380000
ISLF332  MVI   CM7,RCKD                 SET CCW OP CODE TO READ  S20201 11390020
*                                       CKD                      S20201 11400020
ISLF333  OI    CM74,SKIP                SET CCW FLAGS TO SKIP    S20201 11420020
         OI    CM84,SKIP                SET CCW FLAGS TO SKIP    S20201 11440020
         A     R10,ISL16                STEP R10 TO NEXT CCW            11460000
         BCT   R3,ISLF332               LOOP                            11480000
*                                                                       11500000
* EXCP RETURN TO IOS - EXECUTE CP19 TO READ BACK WHAT WAS WRITTEN       11520000
*                                                                       11540000
         BAL   R13,EXCPRTRN             EXCP HOUSEKEEP            15924 11560016
         B     EXCP(R14)                TAKE EXCP IOS RETURN      15924 11580016
*                                                                       11600000
*                                                                       11620000
* RESET CP19 FOR WRITING                                                11640000
*                                                                       11660000
ISLF341  MVI   CM3,WD                   SET CM3 OP CODE TO WRITE S20201 11670020
*                                       D                        S20201 11680020
         NI    CM34,ALL-SKIP            SET CM3 FLAGS NOT TO     S20201 11690020
*                                       SKIP                     S20201 11700020
         CLI   CM7,X'0E'                TEST CM7 FOR RD KD       S20201 11710020
*                                       (CLOSE)                  S20201 11720020
         BNE   ISLF342                  B IF NOT RD KD                  11740000
         MVI   CM7,WKD                  SET CM7 TO WR KD         S20201 11760020
         B     ISLF343                                                  11780000
*                                                                       11800000
ISLF342  MVI   CM7,WCKD                 SET CCW OP CODE TO WRITE S20201 11810020
*                                       CKD                      S20201 11820020
ISLF343  NI    CM74,ALL-SKIP            SET CCW FLAGSNOT TO SKIP S20201 11840020
         NI    CM84,ALL-SKIP            SET CCW FLAGS NOT TO     S20201 11850020
*                                       SKIP                     S20201 11860020
         A     R10,ISL16                STEP R10 TO NEXT CCW            11880000
         BCT   R3,ISLF342               LOOP                            11900000
*                                                                       11920000
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 11940000
         B     ISLF301                  B TO CE PROCESSING              11960000
*                                                                       11980000
         EJECT                                                          12000000
*********************************************************************** 12020000
* CHART F4 - APPENDAGE, CP21 CHANNEL END                              * 12040000
*********************************************************************** 12060000
*                                                                       12080000
ISLF401  LA    R7,ISLIXLT               C(R7)=A(IXLT)                   12100000
         MVI   DCBWKPT2+1,X'0A'         RESET RETRY COUNT        A42170 12110021
         L     R9,0(R10)                C(R9)=A(AREA Y)                 12120000
         LR    R6,R7                    C(R6)=A(IXLT)=A(LEV1)           12140000
         L     R5,ISL1                  C(R5)=0001 FOR CURRENT LEVEL    12160000
         L     R3,24(R10)               C(R3)=A(CP21)                   12180000
         TM    20(R3),X'80'             TEST CQ42 FOR DC                12200000
         BC    8,ISLF115                B IF OFF = EOF, NORMAL RETURN   12220000
*                                                                       12240000
* LOCATE CURRENT LEVEL IN IXLT                                          12260000
*                                                                       12280000
         TM    0(R7),X'20'              TEST LEVEL IND BIT-2            12300000
         BC    1,ISLF403                B IF LEVEL 1, CYL IX            12320000
ISLF402  A     R7,ISL26                 STEP TO NEXT LEVEL IN IXLT      12340000
         A     R5,ISL1                  C(R5)=CURRENT LEVEL             12360000
         TM    0(R7),X'20'              TEST LEVEL IND BIT-2            12380000
         BC    8,ISLF402                B IF NOT THIS LEVEL (LOOP)      12400000
*                                                                       12420000
* MASTER INDEX, TEST FOR DUMMY ENTRY                                    12440000
*                                                                       12460000
         TM    0(R7),X'40'              TEST LEVEL IND BIT-1            12480000
         BC    1,ISLF601                B IF MST DUMMY                  12500000
         B     ISLF410                                                  12520000
*                                                                       12540000
* CYLINDER INDEX, TEST FOR DUMMY ENTRY                                  12560000
*                                                                       12580000
ISLF403  TM    0(R7),X'40'              TEST LEVEL IND BIT-1            12600000
         BC    1,ISLF501                B IF CYL DUMMY                  12620000
*                                                                       12640000
         EJECT                                                          12660000
*                                                                       12680000
* NORMAL ENTRY APPENDAGE ROUTINE, CYLINDER OR MASTER INDEX              12700000
*            * R6 POINTS TO CYLNDER IXLT LEVEL *                        12720000
*            * R7 POINTS TO CURRENT IXLT LEVEL *                        12740000
*                                                                       12760000
* TEST R IN COUNT FIELD IN AREA Y FOR END OF TRACK                      12780000
*                                                                       12800000
ISLF410  CLC   4(1,R9),DCBHIRCM         TEST R VS HI R                  12820000
         BNE   CONTINUE                 BRANCH NOT EQUAL          21347 12826018
         CLI   16(R7),X'00'             IS R OF SX = 0 ?          21347 12832018
         BE    ISLF420                  BRANCH IF EQUAL           21347 12838018
         B     ISLF415                                            21347 12844018
CONTINUE EQU   *                                                  21347 12850018
*                                                                       12860000
*                                       NOT END OF TRACK                12880000
* REPLACE R OF STEPPING COUNT BY R OF Y                                 12900000
*                                                                       12920000
         MVC   16(1,R7),4(R9)           R OF SX = R OF Y                12940000
         TM    IOBFLAGS,X'12'           ARE WE IN CLOSE           VLR   12960018
         BC    1,ISLF420                B IF ON = CLOSE                 12980000
*                                                                       13000000
* TEST HH OF STEPPING COUNT FOR END OF CYLINDER                         13020000
*                                                                       13040000
         MVC   TSTWK1C(1),15(R7)        GET CURRENT TRK FROM IXLT       13060000
         MVC   TSTWK1C+2(1),23(R6)      GET HI TRACK FROM IXLT          13080000
         NC    TSTWK1C(1),ISLAREAZ+87   REDUCE CURRENT TO TRACK         13100000
         NC    TSTWK1C+2(1),ISLAREAZ+87  REDUCE HIGH TO TRACK           13120000
         CLC   TSTWK1C(1),TSTWK1C+2     CURRENT TRACK VS HI TRACK       13140000
         BNE   ISLF450                  B IF NOT END OF CYLINDER - EXIT 13160000
*                                                                       13180000
*                                       LAST TRACK ON CYLINDER          13200000
*                                                                       13220000
* TEST R OF STEPPING COUNT FOR NEXT-TO-LAST R ON LAST TRACK             13240000
*                                                                       13260000
         SR    R3,R3                                                    13280000
         IC    R3,DCBHIRCM              C(R3)=HI R                      13300000
         S     R3,ISL1                  C(R3)=HI R -1                   13320000
         SR    R4,R4                                                    13340000
         IC    R4,16(R7)                C(R4)=R OF SX                   13360000
         CR    R3,R4                    TEST HI R -1 VS R OF SX         13380000
         BNE   ISLF450                  B IF NOT NEXT-TO-LAST R  - EXIT 13400000
*                                                                       13420000
* NEXT TO LAST R ON LAST TRACK OF A CYLINDER HAS BEEN WRITTEN FOR THIS  13440000
* LEVEL INDEX. THE LAST SLOT IN A HI-LEVEL INDEX ON A GIVEN CYLINDER    13460000
* MUST CONTAIN A DUMMY ENTRY. SET DUMMY SW ON FOR THIS LEVEL INDEX SO   13480000
* NEXT WRITE WILL PRODUCE DUMMY ENTRY.                                  13500000
*                                                                       13520000
         OI    0(R7),X'40'              SET LEVEL IND BIT-1 ON          13540000
         B     ISLF420                                                  13560000
*                                                                       13580000
*                                                                       13600000
* LAST R WRITTEN WAS END OF TRACK- STEP STEPPING COUNT TO NEXT TRACK    13620000
*                                                                       13640000
ISLF415  MVI   16(R7),X'00'             R OF SX = 0                     13660000
         LH    R3,14(R7)                C(R3)=HH OF SX                  13680000
         A     R3,ISL1                  C(R3)=HH+1                      13700000
         STH   R3,14(R7)                C(SX)=MBBCCHHR, HH=HH+1, R=0    13720000
*                                                                       13740000
* TEST FOR ANY HIGHER LEVEL INDEXES                                     13760000
*                                                                       13780000
ISLF420  TM    0(R7),X'80'              TEST LEVEL IND BIT-0            13800000
         BC    1,ISLF450                                                13820000
*                                                                       13840000
* HIGHER LEVEL INDEX PRESENT, STEP TO NEXT LEVEL IN IXLT                13860000
*                                                                       13880000
         NI    0(R7),X'DF'              TURN BIT-2 IN CURR LEV IND OFF  13900000
         A     R7,ISL26                 STEP R7 TO REF NEXT LEVEL       13920000
         A     R5,ISL1                  C(R5)=CURRENT LEVEL             13940000
         OI    0(R7),X'20'              TURN BIT-2 IN CURR LEV IND ON   13960000
*                                                                       13980000
* CONSTRUCT COUNT FOR MASTER INDEX ENTRY IN AREA Y, Y+0                 14000000
*                                                                       14020000
         MVC   0(4,R9),12(R7)           COUNT = CCHH FROM IXLT SX       14040000
         SR    R3,R3                                                    14060000
         IC    R3,16(R7)                C(R3)=R FROM IXLT SX, 00NN      14080000
         A     R3,ISL1                  C(R3)=R+1                       14100000
         STC   R3,4(R9)                 COUNT = CCHHR WITH R=R+1        14120000
*                                                                       14140000
* CONSTRUCT DATA FOR MASTER INDEX ENTRY IN AREA Y, Y+8                  14160000
*                                                                       14180000
         STC   R5,16(R9)                STORE LEVEL IN F-BYTE 00000III  14200000
*                                                                       14220000
         TM    0(R7),X'40'              TEST IXLTIND BIT 1 (DUMMY SW)   14240000
         BC    1,ISLF430                B IF ON                         14260000
*                                                                       14280000
*                                       DUMMY SW OFF                    14300000
*  A. NORMAL DATA                                                       14320000
*                                                                       14340000
         MVC   8(7,R9),IOBDADAD         DATA=MBBCCHH FROM IOBB+32       14360000
         MVI   15(R9),X'00'             DATA=MBBCCHHR WITH R=0          14380000
*                                       DATA=MBBCCHHRF, F=00000III      14400000
         MVC   TSTWK1C(4),IOBDADAD+3    MOVE CCH FROM IOBB+32           14420000
         MVC   TSTWK2C(4),12(R7)        MOVE CCH FROM IXLT SX           14440000
         MVI   TSTWK1C+3,X'00'          ZERO TRACK NO.                  14500000
         MVI   TSTWK2C+3,X'00'          ZERO TRACK NO.                  14520000
*                                                                       14620000
ISLF421  CLC   TSTWK1C(4),TSTWK2C       CC IN IOBB+32 VS CC IN SX       14640000
         BNE   ISLF4215                 BR IF NOT EQ                    14660000
*                                                                       14680000
*                                       CCS EQUAL                       14700000
         MVI   17(R9),X'1B'             DATA=MBBCCHHRFP WITH P=1B       14720000
         B     ISLF424                                                  14740000
*                                                                       14760000
*                                       UNEQUAL                         14780000
ISLF4215 EQU   *                                                 Y02072 14800002
*                                                                       14920000
ISLF422  MVI   17(R9),X'0B'             DATA=MBBCCHHRFP WITH P=0B       14940000
*                                                                       14960000
*                                       SET CQ43 (CP21) TO ADDRESS KEY  14980000
*                                       OF LAST RECORD IN LAST BUFFER   15000000
*                                                                       15020000
ISLF424  L     R10,24(R10)              C(R10)=A(CP21-CQ40)             15040000
         L     R4,ISLKEYAD              C(R4)=A(KEY OF LAST WR CKD)     15060000
         IC    R5,24(R10)               SAVE OP                         15080000
         ST    R4,24(R10)               STORE ADDR OF KEY               15100000
         STC   R5,24(R10)               RESTORE OP                      15120000
*                                                                       15140000
         B     ISLF440                                                  15160000
*                                                                       15180000
*                                                                       15200000
*                                       DUMMY SW ON                     15220000
*  B. DUMMY DATA                                                        15240000
*                                                                       15260000
*                                       TEST CC+1 VS DEBENDCC FOR       15280000
*                                       POSSIBLE END OF INDEX EXTENT    15300000
*                                                                       15320000
ISLF430  EQU   *                                                        15340000
         SR    R6,R6                                                    15360000
         IC    R6,9(R7)                 C(R6) = M FROM IXLT SX, 000M    15380000
         S     R6,ISL1                  C(R6) = M-1 (M=1 FOR EXTENT 0)  15400000
         SLL   R6,4                     C(R6) = M-1 X 16 (USE AS INDX)  15420000
*                                                                       15440000
         LR    R9,R0                    RESTORE DEB POINTER             15490000
         USING IHADEB,R9                *                               15492000
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  15500000
         DROP  R9                                                       15510000
         LA    R4,0(R6,R4)              C(R4)=A(CURR INDX EXTENT ENTRY) 15520000
*                                                                       15540000
         MVC   TSTWK1C(4),10(R4)        CCHH - END OF CURRENT EXTENT    15560000
         L     R4,TSTWK1C               C(R4)=CCHH               Y02072 15600002
         MVC   TSTWK1C(4),12(R7)        CCHH FROM IXLT                  15620000
         L     R3,TSTWK1C               C(R3)=CCHH               Y02072 15660002
*                                                                       15780000
         IC    R4,ISL0                  SET TRACK=0              Y02072 15800002
*                                                                       16140000
         SRL   R3,16                    C(R3)=00CC               Y02072 16160002
         LA    R3,1(R3)                 CYL+1                    Y02072 16180002
         SLL   R3,16                    C(R3)=CC00                      16200000
*                                                                       16220000
         CR    R3,R4                    COMP NEXT CC VS END CC IN DEB   16260000
         BH    ISLF431                  B IF NEXT CC HIGH               16280000
*                                                                       16300000
*                                       NEXT CC IS IN CURRENT EXTENT    16320000
         L     R9,0(R10)                C(R9)=A(AREA Y)                 16340000
         MVC   8(3,R9),9(R7)            DATA = MBB FROM IXLT SX         16360000
         ST    R3,TSTWK1C                                               16380000
         MVC   11(4,R9),TSTWK1C         DATA=MBBCCHH   CYL+1, TRACK=0   16400000
         B     ISLF432                                                  16420000
*                                                                       16440000
*                                       NEXT CC IS IN NEW EXTENT        16460000
ISLF431  SRL   R6,4                     C(R6) = M-1                     16480000
         A     R6,ISL1                  C(R6) = M FOR NEXT EXTENT       16500000
         SLL   R6,4                     C(R6) = M X 16 (USE AS INDX)    16520000
         LR    R9,R0                    RESTORE DEB POINTER             16530000
         USING IHADEB,R9                *                               16532000
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  16540000
         DROP  R9                                                       16550000
         LA    R4,0(R6,R4)              C(R4)=A(NEXT INDX EXTENT ENTRY) 16560000
*                                                                       16580000
         L     R9,0(R10)                C(R9)=A(AREA Y)                 16600000
         MVC   9(6,R9),4(R4)            DATA = BBCCHH FROM NEW EXTENT   16620000
         SRL   R6,4                     C(R6) = M FOR NEXT EXTENT       16640000
         A     R6,ISL1                  C(R6) = M+1 (M=1 FOR EXTENT 0)  16660000
         STC   R6,8(R9)                 DATA = MBBCCHH OF NEW EXTENT    16680000
*                                                                       16700000
ISLF432  MVI   15(R9),X'00'             DATA=MBBCCHHR, R=0              16720000
         OI    16(R9),X'28'             DATA=MBBCCHHRF, F=00101III      16740000
         MVI   17(R9),X'07'             DATA=MBBCCHHRFP WITH P=07       16760000
*                                                                       16780000
*                                       SET CQ43 (CP21) TO ADDRESS KEY  16800000
*                                       OF ALL ONES AT Y+62             16820000
*                                                                       16840000
         L     R10,24(R10)              C(R10)=A(CP21-CQ40)             16860000
         LA    R4,62(R9)                C(R4)=A(AREA Y +62)             16880000
         IC    R5,24(R10)               SAVE OP                         16900000
         ST    R4,24(R10)               STORE ADDR OF KEY OF ONES       16920000
         STC   R5,24(R10)               RESTORE OP                      16940000
*                                                                       16960000
*                                                                       16980000
* PLACE IXLT SX IN IOBB+32                                              17000000
*                                                                       17020000
ISLF440  MVC   IOBDADAD(8),9(R7)        C(IOBB+32)=C(IXLT SX), MBBCCHHR 17040000
ISLF441  EQU   *                                                        17042013
         SR    R13,R13                                                  17048000
         IC    R13,IOBDADAD                                             17050000
         SLL   R13,4                                                    17052000
         LR    R9,R0                    DEB POINTER                     17052400
         LA    R13,32(R9,R13)           POINT TO BB                     17054000
         MVC   IOBDADAD+2(1),5(R13)                                     17056000
*                                                                       17060000
*                                                                       17080000
* EXCP RETURN TO IOS - EXECUTE CP21 TO WRITE MASTER INDEX               17100000
*                                                                       17120000
         BAL   R13,EXCPRTRN             EXCP HOUSEKEEP            15924 17140016
         B     EXCP(R14)                TAKE EXCP IOS RETURN      15924 17160016
*                                                                       17180000
*                                                                       17200000
* NORMAL RETURN TO IOS - SET C-BIT OFF AND EXIT                         17220000
*      * ADDR OF STATUS BYTE WITH CURRENT                               17240000
*        C-BIT IS IN CP21 AT CQ41 *                                     17260000
*                                                                       17280000
ISLF450  L     R10,24(R10)              C(R10)=A(CP21-CQ41)             17300000
         L     R7,12(R10)               C(R7)=A(LAST SLOT SCHED)        17320000
         NI    0(R7),X'FB'              TURN S BIT 5 OFF (C-BIT)        17340000
         B     ISLF115                 *NORMAL EXIT                     17360000
*                                                                       17380000
         EJECT                                                          17400000
*********************************************************************** 17420000
* CHART F5 - APPENDAGE CYL DUMMY, CP21 CHANNEL END - ENTERED FROM F4  * 17440000
*********************************************************************** 17460000
*                                                                       17480000
* A DUMMY-CYLINDER INDEX ENTRY HAS JUST BEEN WRITTEN AS THE LAST ENTRY  17500000
* ON THE PREVIOUS TRACK. THE DATA PORTION OF THAT ENTRY CONTAINS THE    17520000
* CYLINDER AND TRACK ADDRESS OF THE REAL CYLINDER INDEX ENTRY. THE REAL 17540000
* CYLINDER INDEX ENTRY MUST NOW BE WRITTEN ON THE NEW TRACK.            17560000
*                   * R7 POINTS TO CYLINDER IXLT LEVEL *                17580000
*                                                                       17600000
* TURN DUMMY SW OFF                                                     17620000
*                                                                       17640000
ISLF501  NI    0(R7),X'BF'              SET LEVEL IND BIT-1 OFF         17660000
*                                                                       17680000
*                                                                       17700000
* UPDATE STEPPING COUNT USING DUMMY DATA CONTENTS, PLACE IN IOBB+32     17720000
*                                                                       17740000
         MVC   9(8,R7),8(R9)            C(S0)=MBBCCHHR FROM AREA Y +8   17760000
         MVC   IOBDADAD(8),9(R7)        C(IOBB+32)=C(IXLT S0), MBBCCHHR 17780000
*                                                                       17800000
* CONSTRUCT COUNT FOR CYLINDER INDEX ENTRY IN AREA Y, Y+0               17820000
*                                                                       17840000
         MVC   0(4,R9),12(R7)           COUNT = CCHH FROM IXLT SX       17860000
         MVI   4(R9),X'01'              COUNT = CCHHR WITH R=1          17880000
*                                                                       17900000
* CONSTRUCT DATA FOR CYLINDER INDEX ENTRY IN AREA Y, Y+8                17920000
*                                                                       17940000
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   17960000
         MVC   8(7,R9),IOBDADAD         DATA=MBBCCHH FROM IOBA+32       17980000
         MVI   14(R9),X'00'             NOT 2301, SET TO TRACK 0        18060000
*                                                                       18080000
ISLF5017 EQU   *                                                        18100000
         CLC   DCBFIRSH(2),ISL0         TEST HH OF FIRSH VS 00          18120000
         BNE   ISLF502                  B IF HH NOT 00                  18140000
*                                       HH OF FIRSH = 00                18160000
         MVC   15(1,R9),DCBFIRSH+2      DATA = MBBCCHHR WITH R OF FIRSH 18180000
         B     ISLF503                                                  18200000
*                                       HH OF FIRSH NOT 00              18220000
ISLF502  MVI   15(R9),X'00'             DATA = MBBCCHHR WITH R=00       18240000
ISLF503  MVI   16(R9),X'01'             DATA = MBBCCHHRF WITH F = 01    18260000
*                                                                       18280000
         SR    R6,R6                                                    18300000
         IC    R6,9(R7)                 C(R6) = M FROM IXLT S0          18320000
         S     R6,ISL1                  C(R6) = M-1 (M=1 FOR EXTENT 0)  18340000
         SLL   R6,4                     C(R6) = M-1 X 16 (USE AS INDX)  18360000
*                                                                       18380000
         SR    R5,R5                                                    18400000
         IC    R5,IOBDADAD              C(R5) = M FROM IOBA+32          18420000
         S     R5,ISL1                  C(R5) = M-1 (M=1 FOR EXTENT 0)  18440000
         SLL   R5,4                     C(R5) = M-1 X 16 (USE AS INDX)  18460000
         LR    R9,R0                    RESTORE DEB POINTER             18470000
         USING IHADEB,R9                *                               18472000
*                                                                       18480000
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  18540000
         LA    R4,0(R6,R4)              C(R4)=A(CURR INDX EXTENT ENTRY) 18560000
         L     R3,DEBFPEAD              C(R3)=A(1ST PRIM EXTENT ENTRY)  18580000
         DROP  R9                                                       18590000
         LA    R3,0(R5,R3)              C(R3)=A(CURR PRIM EXTENT ENTRY) 18600000
         L     R9,0(R10)                C(R9)=A(AREA Y)                 18620000
*                                                                       18640000
         LA    R2,ISLIOBB                                               18645013
         MVC   IOBDADAD+1(2),4(R4)      MOVE DEB BB TO IOB              18650013
*                                                                       18655013
         CLC   1(3,R3),1(R4)            COMP UCB ADDRS, PRIM VS INDX    18660000
         BNE   ISLF504                  B IF NOT EQUAL                  18680000
*                                                                       18700000
*                                       UCBS EQUAL                      18720000
*                                                                       18820000
ISLF5039 EQU   *                                                        18840000
         MVI   17(R9),X'0B'             DATA = MBBCCHHRFP WITH P=0B     18860000
         B     ISLF505                                                  18880000
*                                                                       18900000
*                                       UCBS UNEQUAL                    18920000
ISLF504  MVI   17(R9),X'07'             DATA = MBBCCHHRFP WITH P=07     18940000
*                                                                       18960000
*                                       SET CQ43 (CP21) TO ADDRESS KEY  18980000
*                                       OF LAST RECORD IN LAST BUFFER   19000000
*                                                                       19020000
ISLF505  L     R10,24(R10)              C(R10)=A(CP21-CQ40)             19040000
         L     R4,ISLKEYAD              C(R4)=A(KEY OF LAST WR CKD)     19060000
         IC    R5,24(R10)               SAVE OP                         19080000
         ST    R4,24(R10)               STORE ADR OF KEY                19100000
         STC   R5,24(R10)               RESTORE OP                      19120000
*                                                                       19140000
*                                                                       19160000
* EXCP RETURN TO IOS - EXECUTE CP21 TO WRITE CYLINDER INDEX             19180000
*                                                                       19200000
         BAL   R13,EXCPRTRN             EXCP HOUSEKEEP            15924 19220016
         B     EXCP(R14)                TAKE EXCP IOS RETURN      15924 19240016
*                                                                       19260000
         EJECT                                                          19280000
*********************************************************************** 19300000
* CHART F6 - APPENDAGE MST DUMMY, CP21 CHANNEL END - ENTERED FROM F4  * 19320000
*********************************************************************** 19340000
*                                                                       19360000
* A DUMMY MASTER INDEX ENTRY HAS JUST BEEN WRITTEN AS THE LAST ENTRY    19380000
* ON THE PREVIOUS TRACK. THE DATA PORTION OF THAT ENTRY CONTAINS THE    19400000
* CYLINDER AND TRACK ADDRESS OF THE REAL MASTER INDEX ENTRY. THE REAL   19420000
* MASTER INDEX ENTRY MUST NOW BE WRITTEN ON THE NEW TRACK.              19440000
*                   * R7 POINTS TO CURRENT IXLT LEVEL *                 19460000
*                                                                       19480000
* TURN DUMMY SW OFF                                                     19500000
*                                                                       19520000
ISLF601  NI    0(R7),X'BF'              SET LEVEL IND BIT-1 OFF         19540000
*                                                                       19560000
*                                                                       19580000
* UPDATE STEPPING COUNT USING DUMMY DATA CONTENTS, PLACE IN IOBB+32     19600000
*                                                                       19620000
         MVC   9(8,R7),8(R9)            C(SX)=MBBCCHHR FROM AREA Y +8   19640000
         MVC   IOBDADAD(8),9(R7)        C(IOBB+32)=C(IXLT SX), MBBCCHHR 19660000
*                                                                       19680000
* CONSTRUCT COUNT FOR MASTER INDEX ENTRY IN AREA Y, Y+0                 19700000
*                                                                       19720000
         MVC   0(4,R9),12(R7)           COUNT = CCHH FROM IXLT SX       19740000
         MVI   4(R9),X'01'              COUNT = CCHHR WITH R=1          19760000
*                                                                       19780000
* CONSTRUCT DATA FOR MASTER INDEX ENTRY IN AREA Y, Y+8                  19800000
*                                                                       19820000
         STC   R5,16(R9)                STORE LEVEL IN F-BYTE 00000III  19840000
*                                                                       19860000
         MVI   15(R9),X'00'             DATA WITH R=0                   19880000
*                                                                       19900000
         LR    R5,R7                    C(R5)=A(CURRENT LEVEL IXLT)     19920000
         S     R5,ISL26                 C(R5)=A(NEXT LOWER LEVEL IXLT)  19940000
         MVC   8(6,R9),9(R5)            DATA=MBBCCH OF LOWER LEVEL SX   19960000
         IC    R4,15(R5)                C5R4)=H OF LOWER LEVEL SX       19980000
         TM    0(R5),X'40'              IS DUMMY BIT ON NEXT     A30945 19985020
*                                       * LOWER LEVEL                   19990020
         BO    ISLF6011                 YES - INDEX ENTRY OK     A30945 19995020
         BCTR  R4,0                     C(R4)=H-1                       20000000
ISLF6011 EQU   *                        *                        A30945 20010020
         MVC   TSTWK1C(4),12(R7)        MOVE CCHH FROM IXLT SX          20060000
*                                                                       20140000
         MVI   14(R9),X'00'             SET TRACK=0                     20160002
         MVI   TSTWK1C+3,X'00'          SET TRACK=0                     20180000
*                                                                       20200000
ISLF6015 CLC   11(4,R9),TSTWK1C         CCH0 IN IOBB+32 VS CCH0 IN SX   20220000
         STC   R4,14(R9)                SET H BACK TO TRACK ADDRESS     20240000
         BNE   ISLF6017                                                 20260000
*                                                                       20280000
*                                       CCS EQUAL                       20300000
         MVI   17(R9),X'1B'             DATA=MBBCCHHRFP WITH P=1B       20320000
         B     ISLF604                                                  20340000
*                                                                       20360000
*                                       UNEQUAL                         20380000
ISLF6017 EQU   *                                                        20400000
*                                       CCS UNEQUAL                     20560000
ISLF602  MVI   17(R9),X'0B'             DATA=MBBCCHHRFP WITH P=0B       20580000
*                                                                       20600000
*                                       SET CQ43 (CP21) TO ADDRESS KEY  20620000
*                                       OF LAST RECORD IN LAST BUFFER   20640000
*                                                                       20660000
ISLF604  L     R10,24(R10)              C(R10)=A(CP21-CQ40)             20680000
         L     R4,ISLKEYAD              C(R4)=A(KEY OF LAST WR CKD)     20700000
         IC    R5,24(R10)               SAVE OP                         20720000
         ST    R4,24(R10)               STORE ADDR OF KEY               20740000
         STC   R5,24(R10)               RESTORE OP                      20760000
*                                                                       20780000
*                                                                       20800000
* EXCP RETURN TO IOS - EXECUTE CP21 TO WRITE MASTER INDEX               20820000
*                                                                       20840000
         B     ISLF441                  GO GET DEB BB                   20860013
*                                          AND EXCP RETURN              20880013
*                                                                       20900000
         EJECT                                                          20920000
*********************************************************************** 20940000
* CHART F7 - APPENDAGE, ABNORMAL END                                  * 20960000
*********************************************************************** 20980000
*                                                                       21000000
* TEST IF CP18 HUNG ON A WR CKD                                         21140000
*                                                                       21160000
ISLF702  L     R3,IOBCSW                C(R3)=COMMAND ADDR+8            21180000
         LA    R3,0(R3)                                                 21200000
         S     R3,ISL8                  C(R3)=COMMAND ADDR OF LAST CCW  21220000
         L     R4,12(R10)               C(R4)=A(CP18)                   21240000
         LA    R4,24(R4)                C(R4)=A(CP18, 1ST WR CKD)       21260000
         L     R5,16(R10)               C(R5)=A(CP19)                   21280000
         S     R5,ISL16                 C(R5)=RA(CP18, LAST WR   S20201 21290020
*                                       CKD)                     S20201 21300020
         CR    R3,R4                    LAST CCW VS CP18 CCW 1          21320000
         BL    ISLF710                  B IF NOT IN CP18                21340000
         CR    R3,R5                    LAST CCW VS CP18 CCW N          21360000
         BH    ISLF710                  B IF NOT IN CP18                21380000
*                                                                       21400000
* CP18 HUNG ON A WR CKD - GET ADDR OF LAST BUFFER WRITTEN               21420000
*                                                                       21440000
         TM    0(R3),X'1E'              *LAST CCW IS READ CKD     13334 21450016
         BC    1,ISLF703                * YES,BRANCH              13334 21460016
         LA    R6,R3                    *C(R6)=3                  13334 21470016
ISLF704  TM    0(R3),X'1D'              *LAST CCW IS WRT. CKD     13334 21480016
         BC    1,ISLF703                *YES, BRANCH              13334 21490016
         S     R3,ISL8                  *NO, BACK UP 1 CCW        13334 21500016
         BCT   R6,ISLF704               *LOOP THREE TIMES ONLY    13334 21510016
         B     ISLF710                  *NEITHER READ NOR WRITE   13334 21520016
*                                                                       21580000
ISLF703  L     R6,0(R3)                 C(R6)=DATA ADDR OF LAST WR CKD  21600000
         LA    R6,0(R6)                                                 21620000
         B     ISLF711                                                  21640000
*                                                                       21660000
ISLF710  SR    R6,R6                    ERROR NOT IN CP18, C(R6)=0      21680000
*                                                                       21700000
ISLF711  NI    IOBFLAG1,X'FB'           TURN OFF EXCEPTION FLAG   15924 21720016
         SR    R3,R3                                                    21740000
         STC   R3,IOBFLAG2              FLAG2=0                   15924 21760016
         STC   R3,IOBCSW                CSW BYTE 1 = 0                  21780000
         ST    R3,IOBBCTI               BLK CT INCR & ERROR CTR = 0     21800000
         OI    DCBEXCD1,X'04'           SET EXCD1 BIT 5 ON = WR ERROR   21820000
         STCM  R6,LO3BYTES,ISLVPTRA+1   SAVE A(BAD BUFFER),     XA04602 21850002
*                                       KEEP FTIW FLAGS         XA04602 21860002
         LA    R3,IOBS                  C(R3)=A(BUF 1 STATUS)           21880000
*                                                                       21900000
ISLF712  NI    0(R3),X'B0'              TURN BIT 1 OFF                  21920000
         OI    0(R3),X'20'              TURN BIT 2 ON                   21940000
         A     R3,ISL4                  BUMP R3 TO NEXT SLOT            21960000
         C     R3,ISLBUFN               TEST FOR NTH SLOT               21980000
         BNH   ISLF712                  LOOP UNTIL ALL STATUS = 01      22000000
*                                                                       22020000
         B     ISLF125                                                  22040000
         EJECT                                                          22060000
*                                                                       22080000
* CHART F7 - EXTENTION FOR WR CHK                                       22100000
*                                                                       22120000
ISLF731  LA    R3,0(R2)                 C(R3)=A(IOBX)                   22140000
         LA    R4,ISLIOBB               C(R4)=A(IOBB)                   22160000
*                                                                       22220000
* TEST IOB FOR PERMENANT ERROR                                          22240000
*                                                                       22260000
         TM    IOBECBAD,X'20'           TEST BYTE 4, BIT 2              22280000
         BO    ISLF115                  NON PERM ERR--NORMAL     A42170 22300021
*                                       EXIT                     A42170 22330021
*                                                                       22360000
* PERMANENT ERROR, SET UP TO RETRY TEN TIMES                            22380000
*                                                                       22400000
ISLF7312 NI    IOBFLAG1,X'FB'           TURN OFF EXCEPTION FLAG   15924 22420016
         SR    R6,R6                                                    22440000
         STC   R6,IOBFLAG2              FLAG2=0                   MC0V  22460000
         STC   R6,IOBCSW                CSW BYTE 1 = 0                  22480000
         ST    R6,IOBBCTI               BLK CT INCR # ERROR CTR=0 MC0V  22500000
         LA    R13,2                    INDICATE IOBC RETRY      A42170 22510021
         CR    R3,R4                    COMP IOBX VS IOBB               22520000
         BH    ISLF741                  B IF IOBX = IOBC (CP19)         22540000
         LA    R13,1                    INDICATE IOBB RETRY      A42170 22560021
         BE    ISLF732                  BR--IOBX = IOBB          A42170 22570021
         SR    R13,R13                  INDICATE IOBA RETRY      A42170 22580021
ISLF732  EQU   *                        IOBX = IOBA OR IOBB      A42170 22590021
* SEE IF CP18 OR CP21 FAILED ON READ BACK                               22600021
*                                                                       22650021
         L     R3,IOBCSW                C(R3) = COMMAND ADDR + 8 A42170 22700021
         S     R3,ISL8                  C(R3) = ADDR LAST CCW    A42170 22750021
         TM    0(R3),RKD                IS LAST CCW A READ CKD   A42170 22800021
         BNO   ISLF754                  NO, BRANCH TO ERROR EXIT A42170 22850021
         SR    R3,R3                    CLEAR REGISTER           A42170 22900021
         B     ISLF753                  B TO AE PROCESSING              23000000
*                                                                       23020000
*                                                                       23040000
* RESET CP19 FOR WRITING (IF IT IS READING)                             23060000
*                                                                       23080000
ISLF741  L     R10,16(R10)              C(R10)=A(CP19)                  23100000
         SR    R3,R3                                                    23120000
         USING CM1,R10                  ADDRESSABILITY ON CP19   S20201 23130020
         IC    R3,ISL10+3               C(R3)=NO OF WR CKD CCWS         23140013
         CLI   CM3,X'05'                TEST CM3 OP CODE FOR WR  S20201 23150020
*                                       D                        S20201 23160020
         BE    ISLF754                  B IF WR TO AE PROCESSING        23180000
*                                                                       23200000
         MVI   CM3,WD                   SET CM3 OP CODE TO WRITE S20201 23210020
*                                       D                        S20201 23220020
         NI    CM34,ALL-SKIP            SET CM3 FLAGS TO SKIP    S20201 23240020
         CLI   CM7,X'0E'                TEST CM7 FOR RD KD       S20201 23250020
*                                       (CLOSE)                  S20201 23260020
         BNE   ISLF742                  B IF NOT RD KD                  23280000
         MVI   CM7,WKD                  SET CM7 TO WR KD         S20201 23300020
         B     ISLF743                                                  23320000
*                                                                       23340000
ISLF742  MVI   CM7,WCKD                 SET CCW OP CODE TO WRITE S20201 23350020
*                                       CKD                      S20201 23360020
ISLF743  NI    CM74,ALL-SKIP            SET CCW FLAGSNOT TO SKIP S20201 23380020
         NI    CM84,ALL-SKIP            SET CCW FLAGS NOT TO     S20201 23390020
*                                       SKIP                     S20201 23400020
         A     R10,ISL16                STEP R10 TO NEXT CCW            23420000
         BCT   R3,ISLF742               LOOP                            23440000
*                                                                       23460000
ISLF753  EQU   *                                                 O19110 23470019
         IC    R3,DCBWKPT2(R13)         GET APPROP RETRY COUNT   A42170 23480021
         BCT   R3,ISLF761               B TO EXCP AGAIN                 23520000
*                                                                       23540000
ISLF754  L     R10,DCBWKPT6             RESET R10, C(R10)=A(VPTRS)      23560000
         B     ISLF702                  BRANCH TO ABNORMAL END   A42170 23580021
*                                                                       23600000
*                                                                       23620000
* EXCP RETURN TO IOS IN ORDER TO RETRY WRITE AND READ                   23640000
*                                                                       23660000
ISLF761  EQU   *                                                 O19110 23670019
         STC   R3,DCBWKPT2(R13)         STORE NEW VALUE          A42170 23680021
         BAL   R13,EXCPRTRN             EXCP HOUSEKEEP            15924 23700016
         B     EXCP(R14)                TAKE EXCP IOS RETURN      15924 23720016
*                                                                       23740000
         EJECT                                                          23760000
*                                                                       23780000
* CONSTANTS                                                             23800000
*                                                                       23820000
ISL0     DC    F'0000'                                                  23840000
ISL1     DC    F'0001'                                                  23860000
ISL4     DC    F'0004'                                                  23880000
ISL8     DC    F'0008'                                                  23900000
ISL10    DC    F'0010'                                                  23920000
ISL16    DC    F'0016'                                                  23940000
ISL26    DC    F'0026'                                                  23960000
ISLFF    DC    F'8888'                                                  23980000
KEY0     EQU   ISL0                     STORAGE PROTECT KEY ZERO Y02072 23990002
*                                                                       24000000
*                                                                       24010002
PATCH    DC    XL((*-IGG019GD)/20)'00'  ZEROED PATCH AREA        Y02072 24020002
*                                                                       24030002
         END                                                            24040000
