         TITLE 'IGG019GG - SIO APPENDAGE FOR RPS CHAN PGM INIT'         00100020
IGG019GG CSECT                                                          00200020
*          RELEASE OS/VS2-02 DELETIONS                                  00250002
*                                                               YM03061 00260002
*                                                               YM03825 00270002
*                                                                       00300020
* FUNCTION/ OPERATION- THIS MODULE IS THE APPENDAGE ROUTINE THAT        00400020
* INITIALIZES THE LOAD MODE CHANNEL PROGRAMS TO UTILIZE THE ROTATIONAL  00500020
* POSITION SENSING (RPS) FEATURE OR NOT. THE PRESENCE OF THE FEATURE    00600020
* IS DETERMINED BY THE UCB.  THE RPS FEATURE IS EXPLOITED BY            00700020
* CHANGING CERTAIN CCW'S IN THE LOAD MODE CHANNEL PROGRAMS FROM         00800020
* NOP TO SET SECTOR, WITH ATTENDANT CALCULATION OF THE PROPER           00900020
* SECTOR VALUE.  ADDITIONALLY SOME TIC ADDRESSES MUST BE CHANGED        01000020
* TO BRING THE SET SECTOR CCW'S INTO USE.                               01100020
* ENTRY POINT- IGG019GG IS THE ONLY ENTRY POINT.  THE MODULE IS         01200020
*              ENTERED AT SIO TIME BY IOS VIA THE DEB APPENDAGE         01300020
*              VECTOR TABLE.                                            01400020
* INPUT-       THE IOS REGISTER INTERFACE IS THE PRINCIPAL INPUT        01500020
*              TO THE MODULE. THEY PROVIDE ADDRESSABILITY FOR THE DCB.  01600020
*              WORK AREA, IOB, DEB, CHANNEL PROGRAMS , ETC.             01700020
* OUTPUT-      THE CHANNEL PROGRAM TO BE EXECUTED ON THIS SIO WILL BE   01800020
*              INITIALIZED ACCORDING TO THE DEVICE FEATURE (RPS OR      01900020
*              NON RPS) IN THE UCB.                                     02000020
*              EXTERNAL ROUTINES- IEA0SCRL VIA CVT0SCRL.  THE ROUTINE   02100020
*              DOES CONVERSION OF THE INPUT PARAMETERS TO A SECTOR      02200020
*              VALUE                                                    02300020
* EXITS-       NORMAL RETURN TO IOS, TO PROCEED WITH SIO.               02400020
* TABLES/WORK AREAS - DECB, DCB, IOB AND EXTENTION, DCB WA (DCW), DEB,  02500020
*        CVT, PART 2 VECTOR TABLE.                                      02600020
*        SEE DSECTS AT FRONT OF MODULE FOR FORMAT AND DESCRIPTIONS.     02700020
*                                                                       02800020
         EJECT                                                          02900020
         DCBD  DSORG=(IS)                                               03000020
         EJECT                                                          03100020
IHADEB   IGGDEBD                                                        03200020
         EJECT                                                          03300020
ISLCOMON IGGLOAD                                                        03400020
         EJECT                                                          03500020
IHAIOB   IGGIOBD                                                        03600020
         EJECT                                                          03700020
LOADCPS  DSECT                                                          03800020
         IGGLDCP OPTCD=W                                                03900020
         EJECT                                                          04000020
CVTAREA  DSECT                                                          04100020
         CVT                                                            04200020
         SPACE 4                                                        04250002
         IECDRQE                                                        04260002
         EJECT                                                          04300020
*   MISCELLANEOUS EQUATES                                               04400020
WRTCHK   EQU   X'80'                                                    04500020
VLR      EQU   X'40'                                                    04600020
FTIW     EQU   X'C0'                   FTIW OPTION + SUCCESSFUL GETMAIN 04700020
ONES     EQU   X'FF'                    MASK OF ALL ONES         Y02072 04750002
CP18NEXT EQU   X'01'                    SCHED CP18 NEXT          Y02072 04760002
CP20CNXT EQU   X'02'                    SCHEDULE CP20C NEXT      Y02072 04770002
CP20LAST EQU   X'03'                    CP20 SCHEDULED LAST      Y02072 04780002
ISL8     EQU   8                                                        04800020
FIRSTIME EQU   X'80'                    FIRST TIME SWITCH FOR CP18V     04900020
ZERO     EQU   0                                                        05000020
ONE      EQU   1                                                        05100020
TWO      EQU   2                                                        05200020
THREE    EQU   3                                                        05300020
FOUR     EQU   4                                                        05400020
TEN      EQU   10                                                       05500020
TWOBYTES EQU   16                                                       05600020
RESET    EQU   255                                                      05700020
ADDR     EQU   1                                                        05800020
AL3      EQU   3                                                        05900020
CPSTART  EQU   IOBSTART-ONE                                             06000020
CAW      EQU   X'48'                    POINTER TO CP START      A44446 06050021
*                                                                       06100020
TISA     DSECT                                                          06800020
         ORG   TISA+10                  DEFINE THE FLAG                 06900020
TISAFLAG DS    C                        B0=RESUME LOAD                  07000020
*                                       B1=CLOSE USES                   07100020
*                                       B2=END OF T.I. TRK              07200020
*                                       B3=END OF CYL                   07300020
*                                       B4=EXCP CP20 ALONE              07400020
CP20ONLY EQU   X'08'                    TEST B4 OF TISAFLAG             07500020
CCW      DSECT                                                          07600020
OPCODE   DS    1C                       COMMAND CODE                    07700020
         DS    AL3                      DATA ADDRESS                    07800020
ADDRESS  EQU   OPCODE                                                   07900020
FLAGS    DS    BL1                      CCW FLAGS                       08000020
NULL     DS    1C                       UNUSED                          08100020
COUNT    DS    H                        BYTE COUNT                      08200020
COUNTFLD DSECT                                                          08300020
CYL      DS    CL2                      CC                              08400020
HEAD     DS    CL2                      HH                              08500020
RECORD   DS    C                        R                               08600020
IHAUCB   DSECT                                                          08700020
         ORG   IHAUCB+16                DEFINE THE TYPE FLD             08800020
UCBTYP   DS    F                        UCB TYPE FIELD                  08900020
TYPOPTN  EQU   UCBTYP+ONE                OPTIONAL FEATURES              09000020
TYPDEV   EQU   UCBTYP+TWO                DEVICE CLASS                   09100020
TYPUNIT  EQU   UCBTYP+THREE              UNIT TYPE                      09200020
*                                                                       09300020
RPSFEAT  EQU   X'10'                                                    09400020
*                                                                       09500020
* DEVICE TABLE ENTRY FORMAT                                             09600020
DEVENTRY DSECT                                                          09700020
         DS    0H                       MERLIN IS TYPICAL               09800020
CCMAX    DC    H'411'                   MAX CYL                         09900020
HHMAX    DC    H'19'                    MAX HEAD                        10000020
TRKCAP   DC    H'13060'                 TRACK CAPACITY                  10100020
OVHDI    DC    AL1(179)                 NOT LAST RCD OVHD               10200020
OVHDL    DC    AL1(179)                 LAST RCD OVHD                   10300020
OVHDK    DC    AL1(54)                  KEY OVHD                        10400020
FLAG     DC    X'00'                    FLAGS                           10500020
TOLRNCE  DC    H'512'                   TOLERANCE FACTOR                10600020
ALTTRK   DC    H'152'                   OCIP 58                         10700020
OVHDR0   DC    H'221'                   ZEUS                            10800020
NOSECT   DC    AL1(128)                 ZEUS                            10900020
         DS    C                        ZEUS (RESERVED)                 11000020
*                                                                       11100020
         EJECT                                                          11200020
* GENERAL REGISTERS ARE USED AS FOLLOWS                                 11300020
*                                                                       11400020
R0       EQU   0                        *    -----                      11500020
R1       EQU   1                        *    12* ADDRESS                11600020
R2       EQU   2                        *    IOB                        11700020
R3       EQU   3                        *    DEB                        11800020
R4       EQU   4                        *    DCB                        11900020
R5       EQU   5                        *    -----                      12000020
RSAVE    EQU   6                        *    REGISTER SAVE AREA  Y02072 12100002
R7       EQU   7                        *    UCB                        12200020
R8       EQU   8                        *    -----                      12300020
R9       EQU   9                        **   WORK REGISTER              12400020
R10      EQU   10                       CHANNEL PROGRAM POINTER         12500020
R11      EQU   11                       DECB                            12600020
R12      EQU   12                       WORK REGISTER                   12700020
R13      EQU   13                       BASE REGISTER                   12800020
R14      EQU   14                       IOS RETURN VECTOR TABLE         12900020
R15      EQU   15                       WORK REGISTER                   13000020
*                                                                       13100020
*        * MEANS THIS REGISTER IS SET UP UPON ENTRY FROM IOS,           13200020
*          AND ITS CONTENTS MUST BE RESTORED UPON RETURN TO IOS         13300020
*       ** MEANS THIS REGISTER MAY BE CHANGED, BUT UPON RETURN TO IOS   13400020
*          MUST CONTAIN ZEROES IN THE THREE HIGH ORDER BYTES            13500020
*                                                                       13600020
IGG019GG CSECT                                                          13700020
         USING IGG019GG,R15             MODULE ADDRESSABILITY           13800002
         USING IHAIOB,R2                IOB ADDRESSABILITY              13900002
         USING IHADEB,R3                DEB ADDRESSABILITY              14000002
         USING IHADCB,R4                DCB ADDRESSABILITY              14100002
         USING RQE,R1                   RQE ADDRESSABILITY              14200002
         USING IHAUCB,R7                UCB ADDRESSABILITY              14300002
*                                                                       14400020
         B     SIOENTRY                 START I/O ENTRY          Y02072 14450002
         B     PGFXNTRY                 PAGE FIX TIME ENTRY     YM03061 14460002
*                                                                       14470002
SIOENTRY STM   R0,R15,0(R13)            SAVE REGISTERS           Y02072 14480002
         LR    RSAVE,R13                SAVE AREA ADDRESS        Y02072 14490002
         MODESET KEYADDR=RQEPRT,WORKREG=10  CHANGE TO USER KEY   Y02072 14492002
*                                                                       14494002
         L     R12,DCBWKPT1             A(COMON)                        14500002
         USING ISLCOMON,R12             LOAD WA ADDRESSABILITY   Y02072 15100002
         LR    R13,R15                  CLEAN UP THE EXT. RTN INTERFACE 15200020
         USING IGG019GG,R13                                             15300020
         DROP  R15                                                      15400020
         LA    R2,0(R2)                 C(R2)=A(IOBX)                   15500020
         LA    R8,ISLIOBB               C(R8)=A(IOBB)                   15600020
         CR    R2,R8                    IOBX VS IOBB                    15700020
         BH    ISLFIOBC                 CP 19                           15800020
         BE    ISLFIOBB                 CP 21                           15900020
         B     ISLFIOBA                 CP 18-20                        16000020
*                                                                       16100020
ISLFRETN EQU   *                        RETURN TO IOS            Y02072 16200002
         SPACE 2                                                        16210002
         MODESET KEYADDR=KEY0,WORKREG=9 CHANGE TO PROTECT KEY 0  Y02072 16250002
         SPACE 2                                                        16260002
         LM    R0,R15,0(RSAVE)          RESTORE REGISTERS        Y02072 16300002
         SR    R9,R9                    RESTORE R9                      16400020
         BR    R14                      NORMAL RETURN TO IOS            16500020
         EJECT                                                          16600020
*                                                                       16700020
ISLTHETA EQU   *                        INTERFACE WITH THE RESIDENT     16800020
*                                       SECTOR CONVERT ROUTINE.         16900020
* THE FOLLOWING FORMULAE ARE USED TO CALCULATE THE SECTOR VALUE FOR     17000020
* MERLIN, ZEUS-ATHENS, AND ZEUS-CORINTH-                                17100020
*                                                                       17200020
* FIXED RECORD LENGTHS===                                               17300020
*  SECTOR = (N/T)(RO + (R-1)(Y-K) + (R-1)(KL+DL))                       17400020
*                                                                       17500020
* VARIABLE LENGTH RECORDS===                                            17600020
* SECTOR = (N/T)(RO + (R-1)(Y-K) + BB)                                  17700020
*                                                                       17800020
* WHERE  N= NUMBER OF SECTORS PER DEVICE                                17900020
*        T= TRACK CAPACITY                                              18000020
*        RO= OVERHEAD FOR R0(RECORD 0)                                  18100020
*        R= TARGET RECORD NUMBER                                        18200020
*        Y= OVERHEAD FOR KEYED RECORDS (EITHER I OR L FROM DEV TAB)     18300020
*        K= OVERHEAD TO SUBTRACT FOR NON-KEYED RECORDS                  18400020
*              (K=0 FOR ISAM)                                           18500020
*        KL= KEY LENGTH                                                 18600020
*        DL= DATA LENGTH                                                18700020
*        BB= TOTAL NUMBER OF KEY AND DATA BYTES UP TO BUT NOT           18800020
*            INCLUDING THE TARGET RECORD.                               18900020
* ISLTHETA CALLING SEQUENCE                                             19000020
*                                                                       19100020
* REGISTERS ARE LOADED AS FOLLOWS-                                      19200020
*              FIXED      VARIABLE                                      19300020
*   C(R0)       +DD        -BB        (2 BYTES, RIGHT JUSTIFIED)        19400020
*   C(R10)     000K       000I                                          19500020
*   C(R11)     000R       000R                                          19600020
*   C(R2)      0AAA       0AAA                                          19700020
*        BAL   R14,ISLTHETA                                             19800020
*                                                                       19900020
         SLL   R0,TWOBYTES              C(R0)= +DD00 OR -BB00           20000020
         OR    R0,R11                   C(R0)= +DD0R OR -BB0R           20100020
         SLL   R10,8                    C(R10)= 00K0 OR 00I0            20200020
         OR    R0,R10                   C(R0)= +DDKR OR -BBIR           20300020
         IC    R9,TYPUNIT               C(R9)= 000T                     20400020
         SLL   R9,24                    C(R9)= T000                     20500020
         OR    R2,R9                    C(R2)= TAAA OR TAAA             20600020
*                                                                       20700020
         L     R9,CVTPTR                C(R9)=A(CVT)                    20800020
         USING CVTAREA,R9                                               20900020
         L     R15,CVT0SCR1             C(R15)=A(IEA0SCR1)              21000020
         LR    R12,R14                  SAVE CALLER                     21100020
         BALR  R14,R15                  TO SECTOR CONVERT RTN           21200020
         LR    R14,R12                  RECOVER RETURN ADDR             21300020
         L     R12,DCBWKPT1             RECOVER WK AREA ADDR            21400020
         L     R2,RQEIOB                RECOVER IOB ADDR         Y02072 21500002
         LA    R2,0(R2)                                                 21600020
         BR    R14                      RETURN TO CALLER                21700020
*                                                                       21800020
ISLSUB8  EQU   *                        ADJUST IOBSTART BY -8           21900020
* ADJUSTMENT BY -8 IS USED TO POINT THE IOBSTART ADDR AT THE SET        22000020
* SECTOR CCW AS PART OF INITIALIZATION FOR AN RPS DEVICE.               22100020
         L     R9,CPSTART               PICK UP ADDR                    22200020
         LA    R9,0(R9)                 CLEAR HI BYTE                   22300020
         S     R9,ISLEIGHT              SUBTRACT 8                      22400020
         IC    R10,IOBSIOCC             SAVE SIO CODE                   22500020
         ST    R9,CPSTART               PUT ADDR BACK                   22600020
         STC   R10,IOBSIOCC             PUT CODE BACK                   22700020
         BR    R14                      RETURN TO CALLER                22800020
ISLEIGHT DC    F'8'                     CONSTANT                        22900020
VARIND   DC    H'0',X'8000'             MAKES BB INTO -BB               23000020
KEY0     EQU   VARIND                   ZERO PROTECT KEY         Y02072 23050002
*                                                                       23100020
        EJECT                                                           23200020
ISLFIOBA EQU   *                        CP 18-20 INITIALIZATION         23300020
         TM    TYPOPTN,RPSFEAT          IS  DEV=RPS                     23466702
         BO    ISL20RPS                 BIF YES                         23500020
*                                                                       23600020
* NON-RPS INITIALIZATION.                                               23700020
* IN ESSENCE, IT REQUIRES THE TIC ADDRESSES THAT WERE BACKED UP         23800020
* (FROM SCH ID CCW'S TO SET SECTORS) FOR RPS TO BE RESET (BUMPED +8),   23900020
* AND OP CODES CHANGED FROM SETSECT TO NOP. SEE THE RPS INITIALIZATION  24000020
* CODE FOR A DESCRIPTION OF THE CHANNEL PGM SETUPS EXPECTED BY THIS MOD 24100020
*                                                                       24200020
         CLC   IOBSTART,ISLVPTR4+ONE    IS IT EXCP FOR CP18 ALONE       24300020
         BE    ISL18NON                 BIF YES                         24400020
*                                                                       24500020
         TM    ISLVPTRA,FTIW            IS IT FTIW                      24600020
         BNO   ISL20FVN                 BIF NOT. GO INIT CP20(F AND V)  24700020
* NON-RPS INITIALIZATION OF FTIW CP'S                                   24800020
         TM    DCBOPTCD,WRTCHK          IS CP20C REQ'D                  24900020
         BO    ISL20CNO                 BIF YES                         25000020
* NON-RPS INITIALIZATION OF CP20A/B                                     25100020
         L     R8,CPSTART               R8=A(CP20A OR CP20B)            25200020
         USING CQ1,R8                                                   25300020
         L     R9,CQ2+FOUR              R9=A(TIC CP18)                  25400020
         USING CCW,R9                                                   25500020
         L     R10,ADDRESS              R10=TIC CP18                    25600020
         USING CL0,R10                                                  25700020
         CLI   CL0,SETSECT              DOES TIC GO TO A SETSECT        25800020
         BNE   ISL20TST                 BIF NOT                         25900020
         LA    R10,CCWLEN(R10)          BUMP TIC ADDR +8                26000020
         ST    R10,ADDRESS              TIC NOW POINTS TO CQ1(CP18)     26100020
         B     ISL20TST                 TEST FOR CP20 ALONE             26200020
         DROP  R9,R10                                                   26300020
ISL20CNO EQU   *                        NON-RPS INITIALIZATION OF CP20C 26400020
         L     R8,ISLVPTRC              C(R8)=A(CP20C(CQ1))             26500020
         S     R8,ISLEIGHT              BACK UP TO CQ0.                 26600020
         USING CQ0,R8                                                   26700020
         CLI   CQ0,SETSECT              IS CP20C SET FOR RPS            26800020
         BNE   ISL20TST                 BIF NOT                         26900020
* INITIALIZE CP20C FOR NON- RPS                                         27000020
         MVI   CQ0,NOP                  SET FOR NON-RPS                 27100020
         L     R9,CQ2+FOUR              C(R9)=A(TIC CP18)               27200020
         USING  CCW,R9                                                  27300020
         L     R10,ADDRESS              C(R10)=TIC CL0 (CP18)           27400020
         A     R10,ISLEIGHT             C(R10)=TIC CL1 (CP18)           27500020
         ST    R10,ADDRESS              TIC NOW GOES TO CL1(CP18)       27600020
ISL20TST EQU   *                        TEST EXCP FOR CP20 ALONE        27700020
         L     R9,ISLVPTRA              C(R9)=A(TISA)                   27800020
         USING TISA,R9                                                  27900020
         TM    TISAFLAG,CP20ONLY        CP20 ALONE                      28000020
         BO    ISLFRETN                 BIF YES                         28100020
         EJECT                                                          28200020
ISL18NON EQU   *                        CP18 NON RPS INIT               28300020
         L     R8,ISLVPTR4              A(CP18)                         28400020
         USING CL1,R8                                                   28500020
         L     R9,CL2+FOUR              GET PTR TO WRT CHK SEG(CL0*)    28600020
         DROP  R8                                                       28700020
         USING CL0,R9                                                   28800020
         TM    DCBOPTCD,WRTCHK          IS CL0* THERE                   28900020
         BNO   ISLFRETN                 BIF NOT                         29000020
         MVI   CL0,NOP                  NON-RPS INIT                    29100020
         B     ISLFRETN                 EXIT                            29200020
         DROP  R9                                                       29300020
ISL20FVN EQU   *                        CP20 NON-RPS INITIALIZATION     29400020
         L     R8,ISLVPTR6              C(R8)=A(CP20)                   29500020
         USING CQ1,R8                                                   29600020
         TM    DCBOPTCD,WRTCHK          ARE CQ24,26, AND CQ9(F) THERE   29700020
         BNO   ISLCQ14N                 BIF NOT                         29800020
ISLCQ24N L     R9,CQ24                  C(R9)=CQ24(L.H.)                29900020
         USING CCW,R9                                                   30000020
         CLI   OPCODE,SETSECT           DOES CQ24 TIC TO CQT0           30100020
         BNE   ISLCQ26N                 BIF NO                          30200020
         A     R9,ISLEIGHT              BUMP TIC ADDR +8                30300020
         ST    R9,CQ24                  CQ24=TIC CQT1                   30400020
ISLCQ26N L     R9,CQ26                  C(R9)=CQ26(L.H.)                30500020
         CLI   OPCODE,SETSECT           DOES CQ26 TIC TO CQT0           30600020
         BNE   ISLCQ9                   BIF NOT                         30700020
         A     R9,ISLEIGHT              BUMP TIC ADDR +8                30800020
         ST    R9,CQ26                  CQ26=TIC CQT1                   30900020
ISLCQ9   TM    DCBRECFM,VLR             IS CQ9 THERE                    31000020
         BO    ISLCQ14N                 BIF NOT                         31100020
ISLCQ9N  L     R9,CQ9                   C(R9)=CQ9(L.H.)                 31200020
         CLI   OPCODE,SETSECT           DOES CQ9 TIC TO CQT0            31300020
         BNE   ISLCQ14N                 BIF NOT                         31400020
         A     R9,ISLEIGHT              BUMP TIC ADDR +8                31500020
         ST    R9,CQ9                   CQ9=TIC CQT1                    31600020
ISLCQ14N L     R9,CQ14                  C(R9)=CQ14(L.H.)                31700020
         CLI   OPCODE,SETSECT           DOES CQ14 TIC TO A SETSECT      31800020
         BNE   ISL18NON                 BIF NOT. CP 20 OK FOR RPS       31900020
         A     R9,ISLEIGHT              BUMP TIC ADDR +8                32000020
         ST    R9,CQ14                  CQ14=TIC CQT1 OR CL1            32100020
ISLCQ4N  TM    DCBRECFM,VLR             DOES CQ4 NEED WORK              32200020
         BNO   ISL18NON                 BIF NOT                         32300020
         L     R9,CQ4                   PICK UP CQ4(L.H.)               32400020
         A     R9,ISLEIGHT              BUMP TIC ADDR +8                32500020
         ST    R9,CQ4                   CQ4 TIC'S TO CL1                32600020
         TM    DCBOPTCD,WRTCHK          IS CQT8* THERE                  32700020
         BNO   ISL18NON                 BIF NOT                         32800020
         L     R9,CQT8                  PICK UP TIC ADDR.               32900020
         CLI   OPCODE,SETSECT           DOES IT TIC TO SET SECTOR       33000020
         BNE   ISL18NON                 BIF NO. LEAVE AS IS.            33100020
         A     R9,ISLEIGHT              BUMP ADDR +8                    33200020
         ST    R9,CQT8                  CQT8 TIC'S TO CQ1.              33300020
         B     ISL18NON                 DO CP18 NON-RPS                 33400020
         DROP  R9                                                       33500020
         EJECT                                                          33600020
ISL20RPS EQU   *                        INITIALIZE CP 20 FOR RPS        33700020
         L     R8,CPSTART               C(R8)=A(CP18 OR CP20)           33800020
         LA    R8,0(R8)                 CLEAR HIGH ORDER BYTE           33900020
         USING CCW,R8                                                   34000020
         CLI   OPCODE,SETSECT           IS FIRST CCW A SET SECTOR       34100020
         BE    ISL18PRC                 YES. IOBSTART IS OK.            34200020
         BAL   R14,ISLSUB8              BACK UP TO THE SET SECT CCW.    34300020
         B     ISL18PRO                 R8 POINTS TO CL1 (OR CQ1)       34400020
ISL18PRC LA    R8,CCWLEN(R8)            BUMP R8 FROM CL0  (OR CQ0) TO   34500020
*                                       CL1 (OR CQ1)                    34600020
ISL18PRO EQU   *                                                        34700020
         C     R8,ISLVPTR4              IS IT EXCP FOR CP18 ALONE       34800020
         BE    ISL18RPS                 BIF YES                         34900020
         DROP  R8                                                       35000020
*                                                                       35100020
         TM    ISLVPTRA,FTIW            IS IT FTIW                      35200020
         BNO   ISL20FVR                 BIF NOT. GO DO CP20 (F + V)     35300020
*                                                                       35400020
* RPS INITIALIZATION FOR FTIW CP'S. CP 18 AND/OR 20 MAY BE EXCP'D       35500020
* SEPARATELY OR TOGETHER. IN ADDITION, CP20 IS DIVIDED INTO A,B, AND C, 35600020
* AS BELOW-                                                             35700020
*                                                                       35800020
*                                                                       35900020
* INITIALIZE CP20(FTIW) FOR RPS                                         36000020
* POSSIBLE SETUPS OF CP20A,B, AND C ARE-                                36100020
*   SETUP 1   SETUP 2   SETUP 3   SETUP 4                               36200020
*  ------------------------------------------                           36300020
*    20A*      20B*      20A       20B                                  36400020
*                        20C*      20C*                                 36500020
*     *= INITIALIZATION REQUIRED                                        36600020
* RPS INITIALIZATION OF 20A AND 20B ARE IDENTICAL. IF CP20C IS USED     36700020
* NO INITIALIZATION OF CP20A/B IS REQUIRED.                             36800020
*                                                                       36900020
         TM    DCBOPTCD,WRTCHK          IS CP20C REQ'D                  37000020
         BO    ISLCP20C                 BIF YES                         37100020
         L     R8,CPSTART               C(R8)=A(CP20A OR CP20B)         37200020
         USING CQ0,R8                                                   37300020
         L     R9,CQ2+FOUR              C(R9)=A(TIC CP18)               37400020
         USING CCW,R9                                                   37500020
         L     R10,ADDRESS              C(R10)=TIC CP18                 37600020
         USING CL0,R10                                                  37700020
         CLI   CL0,SETSECT              DOES IT TIC CL0                 37800020
         BE    ISL20UPD                 BIF YES. GO UPDATE THETA.       37900020
         S     R10,ISLEIGHT             C(R10)=TIC CL0                  38000020
         ST    R10,ADDRESS              TIC NOW GOES TO CL0(CP18)       38100020
         B     ISL20UPD                 UPDATE THETA                    38200020
         DROP  R9,R10                                                   38300020
*                                                                       38400020
ISLCP20C EQU   *                        RPS INITIALIZATION OF CP20C     38500020
         L     R8,ISLVPTRC              C(R8)=A(CP20C(CQ1))             38600020
         S     R8,ISLEIGHT              BACK UP TO CQ0.                 38700020
         USING CQ0,R8                                                   38800020
         CLI   CQ0,SETSECT              IS CP20C SET FOR RPS            38900020
         BE    ISL20UPD                 BIF YES. GO UPDATE THETA.       39000020
         MVI   CQ0,SETSECT              RPS INIT                        39100020
         L     R9,CQ2+FOUR              C(R9)=A(TIC CL1)                39200020
         USING CCW,R9                                                   39300020
         L     R10,ADDRESS              C(R10)=TIC CL1 (CP18)           39400020
         S     R10,ISLEIGHT             C(R10)=TIC CL0 (CP18)           39500020
         ST    R10,ADDRESS              TIC NOW GOES TO CL0(CP18)       39600020
         DROP  R9                                                       39700020
* CALL ISLTHETA(FIXED)                                                  39800020
ISL20UPD EQU   *                        UPDATE THETA FOR CP20(ALL)      39900020
         L     R8,CPSTART               C(R8)=A(CP20)                   40000020
         USING CQ0,R8                                                   40100020
         SR    R11,R11                                                  40200020
         L     R10,CQ1                  C(R10)=A(CCHHR)                 40300020
         USING COUNTFLD,R10                                             40400020
         IC    R11,RECORD               C(R11)=000R                     40500020
         LA    R0,TEN                   C(R0)=+DD                       40600020
         SR    R10,R10                                                  40700020
         DROP  R10                                                      40800020
         IC    R10,DCBKEYLE             C(R10)=000K                     40900020
         LA    R2,ISLRPSSS+TWO          C(R2)=0AAA                      41000020
         BAL   R14,ISLTHETA             CALL SECTOR CONVERT RTN         41100020
* TEST EXCP FOR CP20 ALONE.                                             41200020
         L     R9,ISLVPTRA              C(R9)=A(TISA)                   41300020
         USING TISA,R9                                                  41400020
         TM    TISAFLAG,CP20ONLY+CP18NEXT CP20 EXCPED ALONE             41500001
         BNZ   ISLFRETN                 YES - NO CP18                   41560001
         DROP  R9                                                       41700020
         EJECT                                                          41800020
ISL18RPS EQU   *                        CP 18 RPS INIT RTN              41900020
         L     R8,ISLVPTR4              A(CP18)                         42000020
         USING CL1,R8                                                   42100020
         L     R9,CL2+FOUR              GET PTR TO WRT CHK SEG(CL0*)    42200020
         DROP  R8                                                       42300020
         USING CL0,R9                                                   42400020
         TM    DCBOPTCD,WRTCHK          IS CL0* THERE                   42500020
         BNO   ISL18UPD                 BIF NOT                         42600020
         MVI   CL0,SETSECT              RPS INIT                        42700020
         DROP  R9                                                       42800020
         USING CL1,R8                                                   42900020
ISL18UPD EQU   *                        UPDATE SECTOR VALUE             43000020
         TM    DCBRECFM,VLR             DIFFERENT SECTOR CONVERT        43100020
*                                       PARM FOR VLR.                   43200020
         BO    ISLCP18V                 BIF YES                         43300020
* TEST FOR SHARED TRACK                                                 43400020
*    SHARED TRACK SECTOR CALCULATIONS WILL USE THE VARIABLE FORM.       43500020
         L     R9,CL1                   PICK UP SEARCH ARG ADDR         43600020
         USING COUNTFLD,R9                                              43700020
         CLC   HEAD,DCBFIRSH            TEST FOR SHARED TRK CANDIDATE   43800020
         BNE   ISL18FXD                 BIF NOT ON SHARED TRK           43900020
         CLI   DCBFIRSH+TWO,ONE         R=1 ONLY IF NOT SHARED TRK.     44000020
         BE    ISL18FXD                 BIF NOT SHARED TRK.             44100020
*                                                                       44200020
* CALCULATE BB- SHARED TRACK                                            44300020
*   PARAMETERS   F=RECORD NUMBER FROM DCBFIRSH                          44400020
*                R=TARGET RECORD NUMBER FROM THE SEARCH ARGUMENT        44500020
*                                                                       44600020
*   BB=(F-2)(KL+10)                          WHEN R=F-1                 44700020
*   BB=(F-1)(KL+10)                          WHEN R=F                   44800020
*   BB=(F-1)(KL+10)+(R-F-1)(KL+BS)           WHEN R GT F                44900020
         SR    R10,R10                                                  45000020
         SR    R11,R11                                                  45100020
         IC    R11,DCBFIRSH+TWO         C(R11)=F                        45200020
         LA    R0,ONE                                                   45300020
         SR    R11,R0                   C(R11)=F-1                      45400020
         IC    R10,RECORD               C(R10)=R                        45500020
         CR    R10,R11                  IS R=F-1                        45600020
         BNE   ISL18BB2                 BIF NOT                         45700020
         SR    R11,R0                   C(R11)=F-2                      45800020
ISL18BB2 EQU   *                        C(R11)=Z, (F-1) OR (F-2)        45900020
         IC    R10,DCBKEYLE             C(R10)=KL                       46000020
         LA    R10,TEN(R10)             C(R10)=KL+10                    46100020
         MR    R10,R10                  C(R11)=Z(KL+10)                 46200020
         LR    R0,R11                   C(R0)=Z(KL+10)                  46300020
         SR    R10,R10                                                  46400020
         SR    R11,R11                                                  46500020
         IC    R11,DCBFIRSH+TWO         C(R11)=F                        46600020
         IC    R10,RECORD               C(R10)=R                        46700020
         CR    R10,R11                  IS R GT F                       46800020
         BNH   ISLBBOK                  BIF NOT. BB IS OK.              46900020
         SR    R10,R11                  C(R10)=R-F                      47000020
         LA    R11,ONE                                                  47100020
         SR    R10,R11                  C(R10)=R-F-1                    47200020
         IC    R11,DCBKEYLE             C(R11)=KL                       47300020
         AH    R11,DCBBLKSI             C(R11)=KL+BS                    47400020
         MR    R10,R10                  C(R11)= (R-F-1)(KL+BS)          47500020
         AR    R0,R11                 C(R0)=(F-1)(KL+10)+(R-F-1)(KL+BS) 47600020
ISLBBOK  EQU   *                        C(R0)=BB AS PER 1 OF THE 3      47700020
*                                             ALGORITHMS.               47800020
         SR    R11,R11                                                  47900020
         IC    R11,RECORD               C(R11)=R (TARGET RCD)           48000020
         LA    R10,ONE                  C(R10)=000I                     48100020
         LA    R2,ISLRPSSS              C(R2)=0AAA                      48200020
         O     R0,VARIND                C(R0)=-BB                       48300020
         BAL   R14,ISLTHETA             GO TO CONVERT                   48400020
         B     ISLFRETN                 EXIT                            48500020
         DROP  R9                                                       48600020
* CALL ISLTHETA (FIXED)                                                 48700020
ISL18FXD SR    R11,R11                  C(R11)=0000                     48800020
         L     R10,CL1                  C(R10)=A(CCHHR)                 48900020
         USING COUNTFLD,R10                                             49000020
         IC    R11,RECORD               C(R11)=000R                     49100020
         LH    R0,DCBBLKSI              C(R0)=+DD                       49200020
         SR    R10,R10                                                  49300020
         DROP  R10                                                      49400020
         IC    R10,DCBKEYLE             C(R10)=000K                     49500020
         LA    R2,ISLRPSSS              C(R2)=0AAA                      49600020
         BAL   R14,ISLTHETA             UPDATE SECTOR VALUE             49700020
         B     ISLFRETN                 EXIT                            49800020
         EJECT                                                          49900020
ISLCP18V EQU   *                                                        50000020
* CALL ISLTHETA (VARIABLE)                                              50100020
* BB (PARAMETER FOR SECTOR CONVERT RTN) IS FOUND BY THE FOLLOWING       50200020
*   ALGORITHM- ALL THE WRITE CCW LENGTHS IN CP 18 ARE TOTALED, AND      50300020
*   ADDED TO THE RUNNING TOTAL HELD IN CQ10 (2 BYTES)                   50400020
*                                                                       50500020
* CQ10 (CP20V) HOLDS THE CURRENT BB TOTAL. IT IS UPDATED BEFORE EXIT    50600020
*        FROM THIS MODULE, AND RESET TO ZERO WHEN THE TARGET RECORD     50700020
*              IS RECORD NUMBER ONE.                                    50800020
* CQ10+2 HOLDS THE BB TOTAL THAT IS ONE BLOCK BEHIND THE CURRENT TOTAL. 50900020
*                                                                       51000020
BBTOTAL  EQU   CQ10                     HOLDS TOTAL NUMBER OF KEY AND   51100020
*                                       DATA BYTES USED ON CURRENT TRK  51200020
BBTARGET EQU   CQ10+2                   SAME AS BBTOTAL, BUT ONE BLOCK  51300020
*                                       BEHIND IT. NEEDED FOR SEARCH    51400020
*                                       PREVIOUS CP LOGIC.              51500020
*   TEST FOR FIRST ENTRY TO SIO APPENDAGE.  FIRST TIME SWITCH IS SET BY 51600020
*    VLR PUT MODULES. CL2 OP CODE IS USED FOR THE SWITCH.               51700020
         TM    CL2,FIRSTIME             IS THIS FIRST ENTRY             51800020
         BZ    ISLFRETN                 BIF NOT. NO WORK TO DO.         51900020
         NI    CL2,RESET-FIRSTIME       THIS IS FIRST ENTRY. RESET SW   52000020
         L     R2,CL1                   C(R2)=A(CCHHR)                  52100020
         USING COUNTFLD,R2                                              52200020
         SR    R11,R11                                                  52300020
         IC    R11,RECORD               C(R11)=TARGET RECORD            52400020
         DROP  R2                                                       52500020
         L     R9,ISLVPTR6              C(R9)=A(CP20V)                  52600020
         USING CQ1,R9                                                   52700020
         LTR   R11,R11                  IS TARGET RCD NUMBER=1          52800020
         BNZ   ISL18CAL                 BIF NOT. BB IS OK.              52900020
         STH   R11,BBTOTAL              SET BBTOTAL=ZERO                53000020
         STH   R11,BBTARGET             SET TARGET=ZERO                 53100020
ISL18CAL EQU   *                                                        53200020
         LH    R0,BBTARGET              C(R0)=00BB                      53300020
* SET OTHER REGS                                                        53400020
*                                       C(R11)=000R   (TARGET RECORD)   53500020
ISL18VAR LA    R10,ONE                  C(R10)=000I                     53600020
         LA    R2,ISLRPSSS              C(R2)=0AAA                      53700020
         O     R0,VARIND                C(R0)=-BB                       53800020
         BAL   R14,ISLTHETA             GO TO CONVERT                   53900020
         DROP  R9                       DESTROYED BY CONVERT RTN        54000020
         L     R9,ISLVPTR6              C(R9)=A(CP20)                   54100020
         USING CQ1,R9                                                   54200020
*  BB TOTALLING ROUTINE                                                 54300020
         LA    R2,CL3                   INITIALIZE CCW LOCATOR          54400020
         USING CCW,R2                                                   54500020
ISL18VBB EQU   *                                                        54600020
         CLI   OPCODE,TIC               DOES LOCATOR POINT TO A TIC     54700020
         BNE   ISL18WRT                 BIF NO. TEST THIS CCW           54800020
         L     R2,ADDRESS               LOCATE NEXT CCW.                54900020
ISL18WRT EQU   *                                                        55000020
         CLI   OPCODE,WCKD              IS THIS A WRITE CCW             55100020
         BNE   ISL18VEX                 BIF NOT. TOTAL ONLY WRT CCW'S.  55200020
         MVC   BBTARGET(TWO),BBTOTAL    MAKES TARGET FOLLOW 1 BLOCK     55300020
*                                       BEHIND TOTAL.                   55400020
         TM    FLAGS,DC                 IF DATA CHAINED, THIS IS CL6.   55500020
         BO    ISL18CL6                 BRANCH TO TOTAL CL7 AND 8 LENS  55600020
ISL18CL4 EQU   *                        THIS CCW IS CL4.                55700020
         LH    R10,COUNT                COUNT FROM CL4                  55800020
         S     R10,ISLEIGHT             SUBTRACT COUNT FLD LEN,         55900020
*                                        LEAVES KL+DL                   56000020
         AH    R10,BBTOTAL              ADD LAST TOTAL                  56100020
         STH   R10,BBTOTAL              UPDATE RUNNING TOTAL OF BB      56200020
ISL18VCC EQU   *                                                        56300020
         TM    FLAGS,CC                 TEST FOR MORE CCW'S             56400020
         BNO   ISL18VEX                 EXIT. NO MORE TOTALLING         56500020
         LA    R2,CCWLEN(R2)            BUMP LOCATOR TO NEXT CCW.       56600020
CCWLEN   EQU   8                                                        56700020
         B     ISL18VBB                 GO FOR NEXT WRT SEGMENT         56800020
ISL18CL6 EQU   *                        TOTAL CL7 AND CL8 LENGTHS.      56900020
         LA    R2,CCWLEN(R2)            BUMP LOCATOR                    57000020
         LH    R10,COUNT                PICK UP COUNT                   57100020
         AH    R10,BBTOTAL              ADD LAST TOTAL                  57200020
         STH   R10,BBTOTAL              UPDATE TOTAL                    57300020
         TM    FLAGS,DC                 LOOP IF DATA CHAINED.           57400020
         BO    ISL18CL6                 BACK FOR THE NEXT CCW           57500020
         B     ISL18VCC                 FINISHED WITH CL7 AND 8         57600020
         DROP  R2                                                       57700020
ISL18VEX EQU   *                                                        57800020
         B     ISLFRETN                 EXIT                            57900020
         DROP  R9                                                       58000020
         EJECT                                                          58100020
* RPS INITIALIZATION FOR CP20(FIXED AND VLR)                            58200020
ISL20FVR EQU   *                        CP20(F+V)                       58300020
*                                                                       58400020
         L     R8,ISLVPTR6              C(R8)=A(CP20)                   58500020
         USING CQ1,R8                                                   58600020
*                                                                       58700020
* CQ24, 26, AND 9 ARE ALWAYS INITIALIZED BECAUSE THEY MAY TIC TO        58800020
*OTHER PLACES(THAN THE WRITE CHECK SEGMENT) WHILE ON AN RPS DEVICE.     58900020
*                                                                       59000020
         TM    DCBOPTCD,WRTCHK          ARE CQ24,26, AND CQ9(F) THERE   59100020
         BNO   ISL20DET                 BIF NOT                         59200020
*                                                                       59300020
ISLCQ24R CLC   CQT2+ADDR(AL3),CQ24+ADDR  DOES CQ24 TIC TO CQT1          59400020
         BNE   ISLCQ26R                 BIF NOT                         59500020
         L     R9,CQ24                  C(R9)=CQ24(L.H.)                59600020
         S     R9,ISLEIGHT              C(R9)=C(R9)-8                   59700020
         ST    R9,CQ24                  CQ24 TIC'S TO CQT0              59800020
ISLCQ26R CLC   CQT2+ADDR(AL3),CQ26+ADDR  DOES CQ24 TIC CQT1             59900020
         BNE   ISLCQ9R                  BIF NOT                         60000020
         L     R9,CQ26                  C(R9)=CQ26(L.H.)                60100020
         S     R9,ISLEIGHT              DECREMENT R9                    60200020
         ST    R9,CQ26                  CQ26 TIC'S TO CQT0              60300020
ISLCQ9R  TM    DCBRECFM,VLR             IS CQ9 THERE                    60400020
         BO    ISL20DET                 BIF NOT                         60500020
         CLC   CQT2+ADDR(AL3),CQ9+ADDR  DOES CQ9 TIC TO CQT1            60600020
         BNE   ISL20DET                 BIF NOT                         60700020
         L     R9,CQ9                   C(R9)=CQ9(L.H.)                 60800020
         S     R9,ISLEIGHT              DECREMENT R9                    60900020
         ST    R9,CQ9                   CQ9 TIC'S TO CQT0               61000020
* DETERMINE IF CP20 IS IN RPS OR NON-RPS STATE.                         61100020
ISL20DET EQU   *                                                        61200020
         L     R9,CQ14                  C(R9)=CQ14(L.H.)                61300020
         USING CCW,R9                                                   61400020
         CLI   OPCODE,SETSECT           DOES CQ14 TIC TO A SET SECTOR   61500020
         BE    ISL20UPD                 BIF YES. CP20 IS SET FOR RPS.   61600020
*                                       GO TO UPDATE THETA.             61700020
* CP20(F+V) RPS INITIALIZATION REQUIRED.                                61800020
ISLCQ14R S     R9,ISLEIGHT              POINT CQ14 AT THE SETSECT       61900020
         ST    R9,CQ14                  CQ14 TIC'S TO CQT0 OR CL0       62000020
ISLCQ4R  TM    DCBRECFM,VLR             IS CQ4 THERE                    62100020
         BNO   ISL20UPD                 BIF NOT. CP20 OK FOR RPS.       62200020
         L     R9,CQ4                   C(R9)=CQ4(L.H.)                 62300020
         S     R9,ISLEIGHT              DECREMENT R9                    62400020
         ST    R9,CQ4                   CQ4 TICS TO CL0                 62500020
         TM    DCBOPTCD,WRTCHK          IS CQT8* THERE                  62600020
         BNO   ISL20UPD                 BIF NOT.                        62700020
         L     R9,CQT8                  PICK UP TIC ADDR.               62800020
         CLI   OPCODE,SIDEQ             DOES IT TIC TO SIDEQ            62900020
         BNE   ISL20UPD                 BIF NO. LEAVE AS IS.            63000020
         S     R9,ISLEIGHT              TIC TO PREVIOUS CCW.            63100020
         ST    R9,CQT8                  TIC'S TO CQ0.                   63200020
         B     ISL20UPD                 UPDATE SECTOR VALUE             63300020
         DROP  R9                                                       63400020
         EJECT                                                          63500020
ISLFIOBC EQU   *                        CP 19 INITIALIZATION            63600020
         USING IHAIOB,R2                                                63700020
         L     R8,ISLVPTR5              A(CP19)                         63800020
         USING CM1,R8                                                   63900020
         TM    TYPOPTN,RPSFEAT          IS DEV=RPS                      64000020
         BO    ISL19RPS                 BIF YES                         64100020
*                                                                       64200020
         MVI   CM40,NOP                 SET FOR NON-RPS                 64300020
         B     ISLFRETN                 EXIT                            64400020
*                                                                       64500020
ISL19RPS EQU   *                        RPS INIT                        64600020
         MVI   CM40,SETSECT             RPS INIT                        64700020
         L     R11,CPSTART              PICK UP IOBSTART ADDR           64800020
         USING  CCW,R11                                                 64900020
         CLI   OPCODE,SIDEQ             DOES IOB POINT TO SIDEQ         65000020
         BNE   ISL19UPD                 BIF NOT. DON'T ADJUST IOBSTART. 65100020
         DROP  R11                                                      65200020
         BAL   R14,ISLSUB8              IOBSTART POINTS TO A SIDEQ.     65300020
*                                       PREVIOUS CCW SHOULD BE A SET    65400020
*                                       SECTOR. BACK UP TO IT.          65500020
*                                                                       65600020
*  CALL ISLTHETA (FIXED)                                                65700020
ISL19UPD EQU   *                                                        65800020
         SR    R11,R11                  C(R11)=0000                     65900020
         L     R10,CM5                  C(R10)=A(CCHHR)                 66000020
         USING COUNTFLD,R10                                             66100020
         IC    R11,RECORD               C(R11)=000R                     66200020
         LA    R0,TEN                   C(R0)=+DD                       66300020
         SR    R10,R10                                                  66400020
         DROP  R10                                                      66500020
         IC    R10,DCBKEYLE             C(R10)=000K                     66600020
         DROP  R2                                                       66700020
         LA    R2,ISLRPSSS+ONE          C(R2)=0AAA                      66800020
         BAL   R14,ISLTHETA             UPDATE SECTOR VALUE             66900020
         B     ISLFRETN                 EXIT                            67000020
         EJECT                                                          67100020
ISLFIOBB EQU   *                        CP21                            67200020
         USING IHAIOB,R2                                                67300020
         L     R8,ISLVPTR7              A(CP21)                         67400020
         USING CQ40,R8                                                  67500020
*                                                                       67600020
         TM    TYPOPTN,RPSFEAT          IS  DEV=RPS                     67700020
         BO    ISL21RPS                 BIF YES                         67800020
*                                                                       67900020
         DROP  R8                                                       68000020
         L     R11,CPSTART              C(R11)=A(CHAN PGM)              68100020
         USING CQ39A,R11                                                68200020
         CLI   CQ39A,SETSECT            IS CP SET UP FOR NON-RPS        68300020
         BNE   ISLFRETN                 BIF YES.                        68400020
         DROP  R11                                                      68500020
         USING CQ40,R8                                                  68600020
* CHAN PGM IS SET UP FOR RPS. CHANGE IT TO NON-RPS.                     68700020
         ST    R8,CPSTART               START AT CQ40                   68800020
         TM    DCBOPTCD,WRTCHK          IS CQ44A THERE                  68900020
         BNO   ISLFRETN                 BIF NOT                         69000020
*                                                                       69100020
         MVI   CQ44A,NOP                SET FOR NON-RPS                 69200020
         B     ISLFRETN                                                 69300020
*                                                                       69400020
ISL21RPS EQU   *                        RPS INIT                        69500020
         DROP  R8                                                       69600020
         L     R11,CPSTART              C(R11)=A(CHAN PGM)              69700020
         USING  CQ39A,R11                                               69800020
         CLI   CQ39A,SETSECT            IS CP SET UP FOR RPS            69900020
         BE    ISL21UPD                 BIF YES.                        70000020
         DROP  R11                                                      70100020
         USING CQ40,R8                                                  70200020
         BAL   R14,ISLSUB8              SET C(IOBSTART)=A(CQ39A)        70300020
*                                                                       70400020
         TM    DCBOPTCD,WRTCHK          IS CQ44A THERE                  70500020
         BNO   ISL21UPD                 BIF NOT                         70600020
*                                                                       70700020
         MVI   CQ44A,SETSECT            RPS INIT                        70800020
ISL21UPD EQU   *                        UPDATE SECTOR VALUE             70900020
*  CALL ISLTHETA (FIXED)                                                71000020
         SR    R11,R11                  C(R11)=0000                     71100020
         L     R10,CQ40                 C(R10)=A(CCHHR)                 71200020
         USING COUNTFLD,R10                                             71300020
         IC    R11,RECORD               C(R11)=000R                     71400020
         LA    R0,TEN                   C(R0)=+DD                       71500020
         SR    R10,R10                                                  71600020
         IC    R10,DCBKEYLE             C(R10)=000K                     71700020
         LA    R2,ISLRPSSS+THREE        C(R2)=0AAA                      71800020
         DROP  R2                                                       71900020
         BAL   R14,ISLTHETA             UPDATE SECTOR VALUE             72000020
         B     ISLFRETN                                                 72100020
         EJECT                                                          72102002
         USING IHAIOB,R2                IOB ADDRESSABILITY      YM03061 72102402
PGFXNTRY EQU   *                        PAGE FIX TIME ENTRY     YM03061 72104002
         STM   R0,R15,0(R13)            SAVE REGISTERS          YM03061 72106002
         LR    RSAVE,R13                SAVE SAVE AREA ADDRESS  YM03061 72108002
         LR    R13,R15                  MODULE ADDRESSABILITY   YM03061 72108402
         SPACE 2                                                        72108802
         MODESET KEYADDR=RQEPRT,WORKREG=10  CHANGE TO USER KEY  YM03061 72109202
         SPACE 2                                                        72109602
         L     R12,DCBWKPT1             ADDRESS LOAD MODE WA    YM03061 72109702
         LA    R2,0(,R2)                ADDR OF CURRENT IOB     YM03825 72109802
         LA    R8,ISLIOBA               ADDR OF IOBA (CP18-20)  YM03825 72109902
         CR    R2,R8                    IS IT IOBA (CP18-CP20)  YM03825 72113202
         BNE   ISLFRETN                 BR NO - RETURN TO IOS   YM03825 72115202
*                                                                       72116702
*    TEST FOR FULL TRACK INDEX WRITE AND IF SO SCHEDULE CP20A(B)        72120002
*    CP20C AND CP18 SEPARATELY TO PREVENT LONG CHANNEL PROGRAMS         72130002
*                                                                       72140002
         TM    ISLVPTRA,FTIW            IS IT FTIW               Y02072 72142002
         BZ    ISLFRETN                 BR IF NOT FTIW           Y02072 72144002
         L     R10,ISLVPTRA             ADDR OF TRK INDX SAVAREA Y02072 72146002
         USING TISA,R10                 TRK INDX SAVAREA ADDR    Y02072 72148002
         NI    TISAFLAG,ONES-CP20LAST   RESET CP SWITCHES        Y02072 72148402
         L     R8,ISLVPTR4              ADDR OF CP18             Y02072 72148802
         LA    R8,0(R8)                 CLEAR HIGH ORDER BYTE    Y02072 72149202
         L     R9,CPSTART               CURR CP START ADDRESS    Y02072 72149602
         LA    R9,0(R9)                 CLEAR HIGH ORDER BYTE    Y02072 72149702
         CR    R8,R9                    IS IT CP18 ALONE         Y02072 72149802
         BE    ISLFRETN                 BR IF YES, CP20'S NOT    Y02072 72149902
*                                       INCLUDED                 Y02072 72153202
         TM    DCBOPTCD,WRTCHK          WRITE CHECK SPECIFIED    Y02072 72155202
         BNO   CP18NXT                  BR NO, CP20C NOT NEXT    Y02072 72155602
         OI    TISAFLAG,CP20CNXT        SCHEDULE CP20C NEXT      Y02072 72156002
         B     ISLFRETN                 GO TEST FOR RPS DEVICE   Y02072 72156402
*                                                                       72156502
CP18NXT  EQU   *                        CP18                     Y02072 72156602
         OI    TISAFLAG,CP18NEXT        SCHEDULE CP18 NEXT       Y02072 72159902
*                                                                       72163402
         B     ISLFRETN                 RETURN TO IOS           YM03061 72165402
         SPACE 2                                                        72165802
PATCH    DC    XL((*-IGG019GG)/20)'00'  ZEROED PATCH AREA        Y02072 72166702
*                                                                       72170002
         END                                                            72200020
                                                                        72300020
IEF314I SYSIO                                                           72400020
