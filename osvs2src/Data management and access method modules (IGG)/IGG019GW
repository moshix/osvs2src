         TITLE 'IGG019GW - ASYNC ROUTINES  COMBINED WITH WRT CHK'       00090020
IGG019GW CSECT                                                          00180020
*                                                                       00360020
*          RELEASE OS/VS2-02 DELETIONS                           Y02072 00540002
*                                                               YM01347 00590002
*        OS/VS2 RELEASE 3 CHANGES                                       00600002
*  A437900                                                      ZA01385 00610002
*  A748400-748720,C765900                                       ZA00956 00620002
*          CHANGES SINCE VS2-3.7                                      * 00622037
*A098400-098700,A897100-897110                                 @ZA26522 00624037
*          RELEASE 21 DELETIONS/CHANGES                                 00630020
*1253119700,143100,184500,205200,456300,604800,711000,745200,    A41652 00630121
*1253787500,800100,806400,844200,848700                          A41652 00630221
*1253504000,507600                                               A42240 00630521
*1253275400                                                      A43886 00631021
*1253171900,615600,714600,763200,795600,872100                   S21045 00632021
*1253885600,889200                                               A33533 00635021
*1253                                                            M1792  00637021
*XXXX204600                                                      A48664 00637400
*1253415800                                                      A50698 00637800
*1253198000                                                      A51488 00638200
*1253198000                                                      A51488 00638300
*1253199760                                                      A53751 00638602
*A205000                                                         A57232 00638702
*                                                                       00639021
*          RELEASE 20 DELETIONS/CHANGES                                 00640020
*0713194400-196200,203400-204300                                 M6132  00645020
*                                                                S20201 00650020
*                                                                       00660020
*                                                                       00670020
*                                                                       00680020
*STATUS CHANGE LEVEL 011                                                00740002
*                                                                       00810020
* THIS MODULE WAS REWRITTEN IN RELEASE 20.2 TO                          00900020
* UTILIZE CHANNEL PROGRAM AND WORK AREA                                 00990020
* MACRO EXPANSIONS                                                      01080020
*                                                                       01170020
* FUNCTION/OPERATION  ASYNCHRONOUS ROUTINE FOR BISAM WRITE KN           01260020
*        WITH    READ AND UPDATE WHEN WRITE VALIDITY CHECKING IS        01350020
*        REQUESTED.                                                     01440020
*       WRITE KN                                                        01530020
*        CP14W IS INITIALIZED TO ADD A RECORD TO AN OVERFLOW CHAIN AND  01620020
*        SET THE INDICES AND LINK FIELDS RELATING TO THAT RECORD.       01710020
*        UPON COMPLETION OF THE LAST CP NEEDED TO ADD A RECORD TO THE   01800020
*        DATA SET, COMPLETION IS POSTED AND THE NEXT IOB AWAITING       01890020
*        THIS COMPLETION (IF ANY) IS SCHEDULED.  (R=U IF NO WRITE KN)   01980020
*       READ AND UPDATE                                                 02070020
*        UPON COMPLETION OF CP1 OR CP2, THE NEXT IOB AWAITING THE CP    02160020
*        (IF ANY) IS SCHEDULED AND, IF COMPLETION WAS SUCCESSFUL, CP4-  02250020
*        CP5 IS SCHEDULED FOR THE IOB FOR WHICH CP1 OR CP2 JUST         02340020
*        COMPLETED. IF UNSUCCESSFUL, COMPLETION IS POSTED.              02430020
*        UPON COMPLETION OF CP5, CP6 OR CP7, THE NEXT IOB AWAITING THE  02520020
*        CP (IF ANY) IS SCHEDULED AND COMPLETION IS POSTED FOR THIS IOB 02610020
*        IF NO MORE READ AND UPDATE REQUESTS ARE MADE, THE FIRST        02700020
*        WRITE KN MACRO (IN ANY) IS SCHEDULED.                          02790020
* INPUT - N/A                                                           02880020
* OUTPUT - N/A                                                          02970020
* ENTRY POINT' REL POS 0                                                03060020
* EXTERNAL ROUTINES                                                     03150020
*        CP1 OR CP2, CP4 AND CP5, AND CP7 ARE INITIALIZED AND CP4-CP5-  03240020
*        CP6 REMOVED FROM THE CP QUEUE IN SUB-ROUTINES WITHIN THE       03330020
*        PRIVILEGED MACRO-TIME ROUTINE.                                 03420020
*        THE FIRST CHANNEL PROGRAM NEEDED FOR A WRITE KN MACRO IS       03510020
*        SELECTED AND INITIALIZED BY A SUB-ROUTINE WITHIN THE           03600020
*        PRIVILEGED MACRO-TIME ROUTINE.                                 03690020
*        WHEN ALL WRITE KN MACROS ARE COMPLETE, THE PENDING READ AND    03780020
*        UPDATE MACROS ARE SCHEDULED OR ARE REPLACED ON THE UNSCHEDULED 03870020
*        QUEUE ACCORDING TO THE CHANNEL PROGRAM EACH AWAITS BY A SUB-   03960020
*        ROUTINE WITHIN THE PRIVILEGED MACRO-TIME ROUTINE.              04050020
*        ENTRY POINT NAMES ARE                                          04140020
*        DISCP45 - INITIALIZE CP4 AND CP5                               04230020
*        DISCP7  - INITIALIZE CP7                                       04320020
*        DISCPS  - INITIALIZE CP1 OR CP2                                04410020
*        DISCPWKN- INITIALIZE WKN CP                                    04500020
*        DISPRIV - SCHEDULE OR RE-QUEUE READ AND UPDATE CP'S            04590020
*        SEE THE DSECT LABELED IHADIS FOR THE RELATIVE ADDRESSES OF THE 04680020
*        ENTRY POINTS OF THESE ROUTINES.  THE POINTER TO THE PRIVILEGED 04770020
*        MACRO-TIME ROUTINE IS IN DEBDISAD (SEE DEB DSECT).             04860020
*                    THE DYNAMIC BUFFERING ROUTINE WHICH FREES A BUFFER 04950020
*        UPON COMPLETION OF A WRITE K MACRO IS ENTERED VIA 'BUFASYN'.   05040020
*        SEE THE DSECT LABELED IHABUF FOR THE RELATIVE ADDRESS OF THE   05130020
*        ENTRY POINT OF THIS ROUTINE.  THE POINTER TO THE DYNAMIC       05220020
*        BUFFERING MODULE IS IN DCBFREED (SEE DCB DSECT).               05310020
* EXITS' RETURN TO SUPERVISOR VIA REGISTER 14.                          05400020
* TABLES/WORK AREAS' DECB, DCB, IOB AND EXTENTION, DCB WA (DCW), DEB    05490020
*        SEE DSECTS AT END OF MODULE FOR FORMAT AND DESCRIPTIONS        05580020
* ATTRIBUTES' REENTRANT.  DISABLED UPON ENTRY AND EXIT.  ENABLED AT     05670020
*        VARIOUS POINTS WITHIN THE MODULE.                              05760020
* NOTES - NONE                                                          05850020
* GENERAL REGISTERS ARE USED AS FOLLOWS                                 05940020
R0       EQU   0                        WORK REGISTER                   06030020
R1       EQU   1                        12 STAR ON ENTRY, THEN IOB      06120020
R2       EQU   2                        DECB                            06210020
R3       EQU   3                        WKN USED FOR WORK REG OR DEB    06300020
*                                        R+U USED BASE REGISTER         06390020
R4       EQU   4                        DCB                             06480020
R5       EQU   5                        CHANNEL PROGRAMS                06570020
R6       EQU   6                        WORK REGISTER                   06660020
R7       EQU   7                        WORK REGISTER                   06750020
R8       EQU   8                        WORK REGISTER OR DCB WA         06840020
R9       EQU   9                        WORK REGISTER                   06930020
R10      EQU   10                       WORK REGISTER                   07020020
R11      EQU   11                       WORK REGISTER                   07110020
R12      EQU   12                       WORK REGISTER OR DISABLE RTN    07200020
R13      EQU   13                       WORK REGISTER                   07290020
R14      EQU   14                       RETURN ADDRESS                  07380020
R15      EQU   15                       BASE ON ENTRY                   07470020
*                                        R+U USES AS WORK REGISTER      07560020
SHR      EQU   X'80'                    TEST FOR SHR DATA SET    Y02072 07610002
K0       EQU   0                                                 S20201 07740020
K1       EQU   1                                                 S20201 07830020
K2       EQU   2                                                 S20201 07920020
K3       EQU   3                                                 S20201 08010020
K4       EQU   4                                                 S20201 08100020
K5       EQU   5                                                 S20201 08190020
K6       EQU   6                                                 S20201 08280020
K7       EQU   7                                                 S20201 08370020
K10      EQU   10                                                S20201 08460020
         SPACE 2                                                        08470002
         USING RQE,R1                   RQE ADDRESSABILITY       Y02072 08510002
         USING IHADECB,2                                                08640020
         USING IHADEB,3                                                 08730020
         USING IHADCB,4                                                 08820020
         USING IHAWKNCP,5                                               08910020
         USING IHADCW,8                                                 09000020
         USING ASYNCH,15                                                09090020
         SPACE 2                                                        09140002
ASYNCH   EQU   *                                                        09180020
         L     R3,RQEDEB                PROTECTED DEB ADDR       Y02072 09320002
         IC    R2,RQEPRT                CALLERS PROTECT KEY      Y02072 09370002
         DROP  R1                       END USING ON RQE         Y02072 09420002
         LR    R9,R1                    SAVE RQE ADDR            Y02072 09430002
         L     R0,SP230                 CORE SIZE AND SUBPOOL    Y02072 09440002
         SPACE 2                                                        09440402
         MODESET  EXTKEY=DATAMGT        GET CORE IN DATAMGT KEY  Y02072 09442002
         SPACE 2                                                        09442402
         LR    R5,R15                   SAVE BASE ADDR           Y02072 09444002
         GETMAIN  R,LV=(0)              GET SAVE AREA            Y02072 09446002
         LR    R15,R5                   RESTORE BASE ADDR        Y02072 09448002
         USING IGGSAVE,R1               SAVEAREA ADDRESSABILITY  Y02072 09448402
         XC    IGGSAVE(IGGSIZE),IGGSAVE  CLEAR CORE              Y02072 09448802
         ST    R14,IGGRETRN             SAVE RETURN ADDR         Y02072 09449202
         LR    R14,R1                   SAVE AREA ADDR           Y02072 09449602
         USING IGGSAVE,R14              NEW ADDRESSABILITY       Y02072 09449702
         ST    R3,IGGPDEB               VALIDATED DEB ADDR       Y02072 09449802
         STC   R2,IGGUKEY               REQUESTORS KEY           Y02072 09449902
         USING RQE,R9                   RQE ADDRESSABILITY       Y02072 09479902
         L     R1,RQEIOB                IOB ADDRESS              Y02072 09489902
         USING IHAIOB,R1                IOB ADDRESSABILITY       Y02072 09499902
         DROP  R9                       END USING ON RQE         Y02072 09509902
*                                                                       09519902
         BAL   R11,GETLOCK              OBTAIN LOCAL LOCK, RTRN  Y02072 09529902
*                                       IN USER PROTECT KEY      Y02072 09533202
         L     R2,IOBECBAD              R2   DECB                       09536702
         L     R4,IOBDCBAD-1            R4 DCB POINTER                  09540020
         L     R5,IOBCCWAD              R5   CP                         09630020
         XC    DCBPUTX,DCBPUTX          CLEAR DECB SAVE AREA     A41652 09670021
         SR    R9,R9                    R9   ASYNCH CODE TIMES 4        09720020
         IC    R9,IOBASYN                                               09810020
         CH    R9,FOURTEEN              IS ASYN CODE GT 14?    @ZA26522 09840037
         BH    INVASYCD                 IF YES-GO PROG CHK     @ZA26522 09870037
         SLL   R9,2                                                     09900020
ASYLDC2  B     ASYTAB1(R9)                                              09990020
         EJECT                                                          10240000
CONF8    DC    X'F8F8'                                                  10346700
ASYTAB1  B     ASYASB2                  CODE 0    COMPLETE CP4-5-6 OK   10350020
         B     ASYLDD3                        1   EXCP                  10440020
         B     ASYASB1                  CODE 2    COMPLETE CP7 OK       10530020
         B     ASYAUB2                  CODE 3    COMPLETE CP1 OR 2 OK  10620020
         B     ASYASE5A                 CODE 4    COMPLETE CP4-5-6 ERR  10710020
         B     ASYLDC2                        5   INVALID               10800020
         B     ASYASE5A                 CODE 6    COMPLETE CP7 ERR      10890020
         B     ASYAUB2                  CODE 7    COMPLETE CP1/2 ERR    10980020
         B     ASYLAB1                        8   END WRITE KN MACRO    11070020
         B     ASYL4B2                        9   CP14 PRIME REC BUMPED 11160020
         B     ASYL5B2                       10   CP14 ADD TRK AT END   11250020
         B     ASYL8B2                       11   CP14 ADD END, OVERFLO 11340020
         B     ASYL7B2                       12   CP14 MIDDLE VRFL CHN  11430020
         B     ASYL6B2                       13   CP14 AT BEG OF VRFLCH 11520020
         B     ASYL9B2                       14   CP14 NEW REPLACE DEL  11610020
         EJECT                                                          11700020
*              EXECUTE CHANNEL PROGRAM                                  11790020
ASYLDD3  BAL   R13,SUBROUT1                                             11880020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 11970021
         EJECT                                                          12060020
*********************************************************************** 12150020
*********   WRITE KN                                         ********** 12240020
*********************************************************************** 12330020
         USING IHADCW,R8                                                12420020
         USING IHAWKNCP,R5                                              12510020
*              CHART LA                  COMPLETION OF W KN, CODE 8     12600020
ASYLAB1  LR    R9,R15                   SAVE BASE REG                   12690020
         USING IGG019GW,R9                                       S20201 12780020
         DROP  R15                                               S20201 12870020
         LA    R7,4                                               P4700 12960020
         B     ASYASE5B                 TEST FOR ERROR ROUTINE    P4700 13050020
         DROP  R3                                                S20201 13140020
ASYASE60 LR    R0,R1                    R0= IOB ADDR             S20201 13230020
*                                                                       13320002
         BAL   R1,FREEIOB               FREE IOB CORE            Y02072 13370002
*                                                                       13420002
ASYASE61 EQU   *                                                 A41652 14280021
         ST    R2,DCBPUTX               DECB TO BE POSTED        A41652 14340021
         L     R12,IGGPDEB              VALIDATED DEB ADDR       Y02072 14670002
         LR    3,12       RESTORE  DEBADR.                        P4700 14672000
         USING IHADEB,R3                                         S20201 14690000
         LR    R15,R9                   RESTORE BASE REG                14720000
         USING IGG019GW,R15                                      S20201 14730000
         DROP  R9                                                S20201 14740000
         L    R8,DCBWKPT2                                               14940020
         CLI   DCWNUWKN,X'00'            AND IF   MORE IOBS FOR W KN,   15030020
         BNE   ASYAWF2                   BRANCH TO FIND NEXT            15120020
         BAL   R6,ASYLAE4Q              POST FIELD AREA          A53751 15170002
ASYLAD3  NI    DCWWKNI,X'7F'            OTHERWISE, SET W KN NOT IN PROC 15210020
ASYLAE3  L     R1,DCWFIOBU              R1   NEXT IOB ON QUEUE          15300020
         USING IHAIOB,R1                                         S20201 15390020
ASYLAE1  LTR   R1,R1                                                    15480020
         BE    ASYFINIS                 BRANCH TO RETURN IF NONE A53751 15570002
         TM    IOBUNSQR,X'08'           IF REASON ON Q NOT W KN GOING   15660020
         BO    ASYLAF1                   ON OR WAITING, GET NEXT IOB    15750020
         L     R1,IOBFCHAD               AND BRANCH BACK                15840020
         B     ASYLAE1                                                  15930020
ASYLAF1  L     R6,IOBBCHAD              IF REASON ON Q IS W KN GOING ON 16020020
         LTR   R6,R6                     OR WAITING, REMOVE IOB FROM Q, 16110020
         BZ    ASYLAF11                                                 16200020
         MVC   IOBFCHAD-IHAIOB(4,R6),IOBFCHAD                           16290020
         B     ASYLAF12                                                 16380020
ASYLAF11 MVC   DCWFIOBU,IOBFCHAD                                        16470020
ASYLAF12 L     R6,IOBFCHAD                                              16560020
         LTR   R6,R6                                                    16650020
         BZ    ASYLAF13                                                 16740020
         MVC   IOBBCHAD-IHAIOB(4,R6),IOBBCHAD                           16830020
         B     ASYLAF2                                                  16920020
ASYLAF13 MVC   DCWLIOBU,IOBBCHAD                                        17010020
ASYLAF2  L     R2,IOBECBAD              R2  ADDR OF DECB FOR NEW IOB    17100020
         L     R12,DEBEXPTR              GET ADDR OF DEB EXT PTR S21045 17130021
         USING DEBEXT,R12                                        S21045 17160021
         L     R12,DEBDISAD              GET ADDR OF RTN TO SET  S21045 17190021
         DROP  R12                                               S21045 17220021
         USING IHADIS,R12                 UP CP1,CP2,CP4-5-6, OR CP7    17280020
         BAL   R13,DISPRIV               BRANCH TO THE ROUTINE          17370020
         TM    DECBEXC1,X'80'            IF RECORD FOUND                17460020
         BO    ASYLAE3                                                  17550020
         TM    IOBINDCT,X'40'             AND IOB SCHEDULED             17640020
         BO    ASYLAE3                                                  17730020
         OI    IOBINDCT,X'40'           LEAVE IOB UNSCHED SO THAT 24981 17820020
*        NON-PRIV M-TIME MODULE WON'T ISSUE AN EXCP ALSO.               17910020
         BAL   R13,SUBROUT1                                             18000020
         B     ASYLAE3                   BRANCH BACK FOR NEXT IOB       18090020
ASYLAE4  EQU   *                                                 A35340 18180020
         LA    R6,ASYFINIS              RETURN ADDRESS                  18230000
ASYLAE4Q EQU   *                        *                               18240000
         L     R8,IGGPDEB               VALIDATED DEB ADDR       Y02072 18270002
         USING IHADEB,R8                DEB ADDRESSABILITY       Y02072 18320002
         L     R8,DEBEXPTR              ADDR DEB EXTENSION       Y02072 18370002
         USING DEBEXT,R8                EXT ADDRESSABILITY       Y02072 18420002
         TM    DEBDCBFA,SHR             DISP EQ SHARE            Y02072 18470002
         BZ    MERGDONE                 BR IF NOT SHARED         Y02072 18520002
         L     R8,DEBDCBFA              ADDR OF FIELD AREA       Y02072 18570002
         USING DCBFA,R8                 FA ADDRESSABILITY        Y02072 18620002
         SPACE 2                                                        19976002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 20026002
         SPACE 2                                                        20036002
         STM   R0,R15,IGGREGS           SAVE REGISTERS           Y02072 20076002
         LR    R9,R15                   SAVE BASE ADDRESS        Y02072 20126002
         LR    R3,R14                   SAVE SAVE AREA ADDR      Y02072 20176002
         DROP  R14                      END SAVE AREA USING      Y02072 20226002
         SPACE 2                                                        20236002
         MODESET  KEYADDR=KEY0,WORKREG=11  CHANGE TO KEY ZERO    Y02072 20276002
         SPACE 2                                                        20326002
**********************************************************************  20336002
*        OBTAIN CMS LOCK.  FREED AT FCMS1.                           *  20376002
**********************************************************************  20426002
         SPACE 2                                                        20436002
GCMS1    SETLOCK  OBTAIN,TYPE=CMS,MODE=UNCOND,  OBTAIN CROSS     Y02072*20476002
               RELATED=(DCBFA,IGG019GW(FCMS1)) MEMORY SRVCES LCK Y02072 20496002
*                                                                       20498002
         LR    R15,R9                   RESTORE BASE ADDR        Y02072 20498402
         USING IGGSAVE,R3               SAVEAREA ADDRESSABILITY  Y02072 20498802
         SPACE 2                                                        20498902
         MODESET  KEYADDR=IGGUKEY,WORKREG=11 CHANGE TO USER KEY  Y02072 20499202
         SPACE 1                                                        20499802
         L     R2,DCBRORG3              ACCESSES TO OVRFLOW RCD  Y02072 20505102
         SPACE 1                                                        20505502
         MODESET EXTKEY=DATAMGT         CHANGE TO DATA MGT KEY   Y02072 20505902
         SPACE 1                                                        20506302
         ST    R2,DFARORG3              DCBRORG3 TO FIELD AREA   Y02072 20506402
         SPACE 1                                                        20506502
         MODESET  KEYADDR=IGGUKEY,WORKREG=2  CHANGE TO USER KEY  Y02072 20509802
         SPACE 2                                                        20511802
         L     R2,DCBPUTX               DECB ADDRESSABILITY      Y02072 20512202
         USING IHADECB,R2               DECB                     Y02072 20512602
         SPACE 2                                                        20513002
**********************************************************************  20513102
*    MERGE ALL FIELDS IF WRITE KEY NEW - SELECTIVE MERGE FOR READS.  *  20513202
**********************************************************************  20514602
         SPACE 2                                                        20516602
         TM    DECBTYP2,DECBWKN         IS IT A WRITE KN         Y02072 20517002
         BZ    ENDMERGE                 BR IF NOT WRITE KN       Y02072 20517102
         SPACE 2                                                        20517202
         L     R1,DCBNREC               NO. PRIME DATA RECORDS   Y02072 20517402
         IC    R2,DCBST                 DCB STATUS IND           Y02072 20518802
         LH    R5,DCBNBOV               BYTES ON OVRFLOW TRK     Y02072 20520202
         LH    R9,DCBNOREC              NO RECDS IN OVRFLOW      Y02072 20523202
         LM    R6,R7,DCBLIOV            LAST IND OVRFLOW ADDR    Y02072 20525202
         LH    R10,DCBRORG1             FULL CYL OVRFLOW AREAS   Y02072 20525602
         SLL   R10,16                   SHIFT TO HIGH ORDER POS  Y02072 20526002
         LH    R11,DCBRORG2             FREE TRKS IND OVRFLOW    Y02072 20527202
         OR    R10,R11                  DCBRORG1 AND DCBRORG2    Y02072 20528602
         LM    R11,R12,DCBLPDA          LAST PRIME RCD ADDR      Y02072 20530002
         SPACE 2                                                        20547402
*        STORE DCB FIELDS IN FIELD AREA                          Y02072 20557402
         SPACE 2                                                        20559402
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 20567402
         SPACE 2                                                        20567502
         ST    R1,DFANREC               DCBNREC                  Y02072 20567802
         STC   R2,DFAST                 DCBST                    Y02072 20568202
         STH   R5,DFANBOV               DCBNBOV                  Y02072 20568302
         STH   R9,DFANOREC              DCBNOREC                 Y02072 20575202
         STM   R6,R7,DFALIOV            DCBLIOV                  Y02072 20577202
         ST    R10,DFARORG1             DCBRORG1 AND DCBRORG2    Y02072 20579202
         STM   R11,R12,DFALPDA          DCBLPDA                  Y02072 20581202
ENDMERGE LR    R9,R15                   SAVE BASE ADDR           Y02072 20581602
         SPACE 2                                                        20581702
         MODESET  KEYADDR=KEY0,WORKREG=11  CHANGE TO KEYZERO     Y02072 20582002
         SPACE 2                                                        20582102
**********************************************************************  20584802
*        RELEASE CMS LOCK.  WAS OBTAINED AT GCMS1.                   *  20591102
**********************************************************************  20593102
         SPACE 2                                                        20593802
FCMS1    SETLOCK  RELEASE,TYPE=CMS,     RELEASE CMS LOCK         Y02072*20596502
               RELATED=(DCBFA,IGG019GW(GCMS1))                   Y02072 20599202
         LR    R15,R9                   RESTORE BASE ADDR        Y02072 20601902
         SPACE 2                                                        20603902
         MODESET  KEYADDR=IGGUKEY,WORKREG=11 CHANGE TO USER KEY  Y02072 20610002
         SPACE 2                                                        20620002
         LM    R0,R15,IGGREGS           RESTORE REGISTERS        Y02072 20640802
         DROP  R3                       END USING ON SAVE AREA   Y02072 20640902
         USING IGGSAVE,R14              SAVEAREA ADDRESSABILITY  Y02072 20641202
MERGDONE EQU   *                        MERGE FINISHED           Y02072 20642802
         L     R8,DCBWKPT2              RESTORE WA PTR           A57232 20648102
         BR    R6                       RETURN VIA EXIT          A53751 20665402
         EJECT                                                          20682702
         USING IHADCW,R8                                         A35340 20700020
         USING IHADEB,R3                DEB ADDRESSABILITY       Y02072 20750002
*              SUB-ROUTINE CHARTS L2-L3                                 20790020
*              USE 1 ENTRANCE                                           20880020
ASYL2A2  TM    IOBINDCT,X'20'                                           20970020
         BO    ASYL2B1                                                  21060020
         TM    CH8E+4,X'80'            TEST IF UNBL,PRIME REC     17332 21150020
*                                       BUMPED                    17332 21240020
         BO    ASYL2C3                  BRANCH IF YES             17332 21330020
         XC    DECBLOGR,DECBLOGR        RECORD IS IN DECB AREA          21420020
         L     R6,DECBAREA              R6   ADDRESS OF LINK (NOT ZERO) 21510020
         LA    R6,6(R6)                 R7   ADDRESS OF KEY             21600020
         TM    IOBINDCT,X'10'                                           21690020
         BO    ASYL2A4                                                  21780020
         L     R7,DECBKEY                                               21870020
         B     ASYL2C2                                                  21960020
ASYL2A4  L     R7,DCBMSWA                                               22050020
         LA    R7,8(0,R7)                                               22140020
         B     ASYL2C2                                                  22230020
ASYL2B1  L     R7,DCBMSWA                                               22320020
ASYL2B2  SR    R6,R6                                              17332 22410020
         IC    R6,DCBKEYLE                                              22500020
         AR    R6,R7                                                    22590020
         MVC   DECBLOGR,DCBMSWA                                         22680020
ASYL2C2  MVC   0(10,R6),CB25            LINK PER R6 FROM CB25           22770020
         B     ASYL2D2                                                  22860020
ASYL2C3  L     R7,CH6+4                KEY ADDR OF OVFL REC       17332 22950020
         B     ASYL2B2                                            17332 23040020
*              USE 2 ENTRANCE                                           23130020
ASYL2D1  SR    R6,R6                    R6   ZERO                       23220020
ASYL2D2  TM    DCBOPTCD,X'08'           DETERMINE WHICH OVERFLOW AREA   23310020
         MVI   CB53+4,X'00'             CLEAR EOF SW. IN CP10B    13270 23400020
         BZ    ASYL2E3                   TO USE IF ANY AVAILABLE. TRY   23490020
         CLI   CB22+5,X'00'              CYLINDER AREA BEFORE INDEPEN-  23580020
         BNE   ASYL2H2                   DENT AREA.                     23670020
ASYL2E3  TM    DCBOPTCD,X'10'                                           23760020
         BZ    ASYL2E4                                                  23850020
         LH    R10,DCBRORG2             TEST INDEPENDENT AREA FULL.     23940020
         LTR   R10,R10                                                  24030020
         BNE   ASYL3C1                                                  24120020
ASYL2E4  OI    DECBEXC1,X'20'                                           24210020
         TM    IOBINDCT,X'20'           BRANCH IF THE RECORD FOR WHICH  24300020
         BO    ASYL2E5                   THERE IS NO SPACE IS IN W.     24390020
         TM    IOBINDCT,X'10'           RECORD IS IN DECB AREA.         24480020
         BZ    ASYL2E5                  BRANCH IF THE KEY IS IN DECBKEY 24570020
         SR    R11,R11                  IF NOT, MOVE IT FROM W TO THE   24660020
         IC    R11,DCBKEYLE              DECB KEY AREA.  THIS IS        24750020
         BCTR  R11,0                     NECESSARY SO THAT THE USER     24840020
         L     R6,DECBKEY                WILL KNOW WHERE TO FIND THE    24930020
         EX    R11,ASYL2E6               LOST KEY.                      25020020
ASYL2E5  EQU   *                                                        25110020
         B     ASYLAB1                  BRANCH TO POST COMPLETION       25290020
ASYL2E6  MVC   0(0,R6),0(R7)                                            25380020
ASYL3C1  LA    R11,4(R11)               INDEPENDENT OVERFLOW AREA.      25470020
         CLC   DCBLIOV+7(1),DCBHIIOV    LAST REC ON TRK          O19113 25560020
         BNE   ASYL3B2                  NO -- MBBCCHH ALL SET, BRANCH   25650020
         LA    R12,ASYL3B2              LOAD R12 FOR EXIT         13270 25740020
ASYL3C1A SR    R10,R10                                            13270 25830020
         IC    R10,DCBLIOV                                              25920020
         SLL   R10,4                                                    26010020
         AR    R10,R3                                                   26100020
         SR    R9,R9                    INITIALIZE R9 TO ZERO           26190020
         MVI   DCBLIOV+7,0              SET RECORD NO. TO ZERO          26280020
         CLC   DCBLIOV+6(1),DEBENDHH+1-IHADEB(R10) LAST TRACK OF CYL.   26370020
         BNE   ASYL3C3                  NO, GO INCREMENT TRACK NO.      26460020
         MVI   DCBLIOV+6,0              YES, SET TRACK NO. TO ZERO      26550020
         CLC   DCBLIOV+3(3),DEBENDCC-IHADEB(R10) LAST TRACK OF EXTENT   26640020
         BNE   ASYL3A3                  NO, GO TO INCREMENT CCH         26730020
         IC    R9,DCBLIOV               GO TO NEXT EXTENT               26820020
         LA    R9,1(0,R9)                M+1                            26910020
         STC   R9,DCBLIOV                                               27000020
         CLC   DCBLIOV(1),DEBNMEXT      RUN OUT OF DEB (WILL NOT OCCUR) 27090020
         BE    ASYL2E4                  YES, GO SET NO SPACE INDICATION 27180020
         MVC   DCBLIOV+1(6),DEBBINUM+16-IHADEB(R10) MOVE NEW BBCCHH     27270020
         BR    R12                      EXIT                      13270 27360020
*                                                                       27450020
ASYL3A3  EQU   *                        *                               27540002
         IC    R9,DCBLIOV+K3           PICK UP C1 OF CC          S20201 27810020
         SLL   R9,8                    MAKE ROOM FOR C2          S20201 27900020
         IC    R9,DCBLIOV+K4           PICK UP C2 OF CC          S20201 27990020
         LA    R9,K1(,R9)              BUMP CYL VALUE BY 1       S20201 28080020
         STC   R9,DCBLIOV+K4           RESTORE C2                S20201 28170020
         SRL   R9,8                    MOVE C1 OVER FOR STORE    S20201 28260020
         STC   R9,DCBLIOV+K3           RESTORE C1                S20201 28350020
         BR    R12                     EXIT                      S20201 28440020
ASYL3C3  IC    R9,DCBLIOV+6             INCREMENT TRACK NUMBER          30060020
         LA    R9,1(R9)                                                 30150020
         STC   R9,DCBLIOV+6                                             30240020
         BR    R12                      EXIT                      13270 30330020
ASYL3B2  MVC   CH23(8),DCBLIOV          SET CH23 MBBCCHHR FROM DCBLIOV  30420020
         IC    R8,DCBLIOV+7             ADD 1 TO R IN DCBLIOV           30510020
         LA    R8,1(R8)                                                 30600020
         STC   R8,DCBLIOV+7                                             30690020
         CLC   DCBLIOV+7(1),DCBHIIOV    IF NEW ADDR LAST ON TRK, O19113 30780020
         BNE   ASYL3E2                   THIS REC FILLS AN OVERFLOW     30870020
         LH    R8,DCBRORG2               AREA. THEREFORE, SUBTRACT 1    30960020
         BCTR  R8,0                      FROM NUMBER OF AREAS.          31050020
         STH   R8,DCBRORG2                                              31140020
ASYL3E2  MVC   CH24(5),DCBLIOV+3        SET CCHHR IN CH24 FROM DCBLIOV  31230020
         CLC   DCBLIOV+7(1),DCBHIIOV    NEW ADDRESS LAST IN TRK  O19113 31320020
         BNE   ASYL3E2B                 BRANCH IF NO              13270 31410020
         SR    R8,R8                                              13270 31500020
         CH    R8,DCBRORG2              ANY IND OFL LEFT          13270 31590020
         BE    ASYL2E4                  BRANCH TO NO SPACE FND IF 13270 31680020
         BAL   R12,ASYL3C1A             GO SET EOF ADDRESS        13270 31770020
ASYL3E2B MVC   CB55(5),DCBLIOV+3        MOVE SEARCH ADDR TO CB55  13270 31860020
         MVI   CB53+4,X'20'            SET EOF SWITCH IN CP10B    13270 31950020
         IC    R12,DCBLIOV+7            R=R+1 FOR EOF             13270 32040020
         LA    R12,1(R12)                                         13270 32130020
         STC   R12,CB55+4                                         13270 32220020
         LTR   R6,R6                    TEST USE 2                      32310020
         BZ    ASYL2B5                  EXIT IF YES                     32400020
         CLC   CH23(1),IOBDADAD         M IOB = M IN CH23               32490020
         BE    ASYL3F4                                                  32580020
         MVI   CH14,X'07'               NO - SEEK BBCCHH IN CH14        32670020
         B     ASYL3F3                                                  32760020
ASYL3F4  MVI   CH14,X'0B'               YES - SEEK CCHH IN CH14         32850020
ASYL3F3  TM    CB26,X'08'               BRANCH IF NOT CHAINED, I.E. IF  32940020
         BZ    ASYL2K5                   NO OVERFLOW CHAIN ALREADY      33030020
         CLC   CB25(1),CH23             COMP CH23 TO CB25, SET P IN     33120020
         BNE   ASYL3K2                   LINK PER REG 6 ACCORDINGLY     33210020
         L     R8,DCBWKPT2              GET DCW WORK AREA ADDR     0699 33300020
         CLC   CB25+3(3),CH23+3         MCCH=, GO TO P = SEEK HH        33660020
         BE    ASYL2J3                   M =, SET P = SEEK CCHH         33840020
         MVI   9(R6),X'0B'               M NOT =, SET P = SEEK BBCCHH   33930020
         B     ASYL2J2                                                  34020020
ASYL3K2  MVI   9(R6),X'07'                                              34110020
         B     ASYL2J2                                                  34200020
ASYL2H2  MVC   CH23(6),IOBDADAD         CYL OFLOW AREA                  34290020
         CLC   DCBHIROV,CB22+2          SET CH23 MBBCC    FROM IOB      34380020
         BNE   ASYL2G2                  IF CB22 R INDICATES HI REC IN   34470020
         LH    R8,CB22                   OVERFLOW TRACK,                34560020
         LA    R8,1(R8)                     CB22      HH  OLD HH PLUS 1 34650020
         STH   R8,CB22                                  R ZERO          34740020
         MVI   CB22+2,X'00'                                             34830020
ASYL2G2  MVC   CH23+6(2),CB22+1         SET CH23 HR FROM CB22+1         34920020
         IC    R8,CB22+2                ADD 1 TO R IN CB22              35010020
         LA    R8,1(R8)                 IF RESULT INDICATES HI REC IN   35100020
         STC   R8,CB22+2                 OVERFLOW TRACK, SUBT 1 FROM    35190020
         CLC   DCBHIROV,CB22+2           T IN CB22 TO INDICATE ONE LESS 35280020
         BNE   ASYL2G4                   TRACK.  IF THIS RESULT IS ZERO 35370020
         IC    R8,CB22+5                 ADD ONE TO RORG1 TO INDICATE   35460020
         BCTR  R8,0                      ONE MORE FULL CYLINDER OVER-   35550020
         STC   R8,CB22+5                 FLOW AREA                      35640020
         CLI   CB22+5,X'00'                                             35730020
         BNE   ASYL2G4                                                  35820020
         LH    R8,DCBRORG1                                              35910020
         LA    R8,1(R8)                                                 36000020
         STH   R8,DCBRORG1                                              36090020
ASYL2G4  MVC   CH24(3),IOBDADAD+3       CH24 CCH FROM IOB               36180020
         MVC   CH24+3(2),CB22+1         HR FROM CB22+1                  36270020
         LA    R9,CH1                   SET IOB START PTR. TO CH1       36360020
         ST    R9,IOBSTART-1                                            36450020
         LA    R9,IOBDADAD+3            GET ADDR OF CCHHR          9445 36540020
         ST    R9,CH1                   SET UP SID CCW             9445 36630020
         MVI   CH1,X'31'                SET UP SID OP CODE         9445 36720020
         MVC   CH3A+1(3),CH1+1          SET UP WRT CK CCW          9445 36810020
         LTR   R6,R6                    EXIT IF USE 2.                  36900020
         BZ    ASYL2B5                                                  36990020
         MVI   CH14,X'1B'               CH14 SET TO SEEK HH             37080020
         TM    CB26,X'08'               BRANCH IF CHAINED IN F OF CB26  37170020
         BO    ASYL2J3                                                  37260020
ASYL2K5  LA    R9,CH9                K5      NOT CHAINED - END          37350020
         ST    R9,CH4                                                   37440020
         MVI   CH4,X'08'                MOVE TIC COMMAND                37530020
         OI    CB26,X'08'               RESET F TO INDICATE CHAINED     37620020
         LR    R9,R7                    PLACE REG 7 IN ADDR OF CH12     37710020
         STH   R9,CH12+2                                                37800020
         SRL   R9,16                                                    37890020
         STC   R9,CH12+1                                                37980020
         B     ASYL2J1                  BRANCH                          38070020
ASYL2J3  MVI   9(R6),X'1B'   SET P IN LINK PER R6 TO SEEK HH            38160020
ASYL2J2  LA    R9,CH8D               J2                                 38250020
         ST    R9,CH4                                                   38340020
         MVI   CH4,X'08'                MOVE TIC COMMAND                38430020
ASYL2J1  MVC   CB25(3),CH23                                             38520020
         NI    CH18C+4,X'BF'            CH18C CC OFF                    38610020
         MVC   CB25+3(5),CH24                                           38700020
         LR    R9,R6                    PLACE R6 IN ADDR CH18           38790020
         STH   R9,CH18+2                                                38880020
         SRL   R9,16                                                    38970020
         STC   R9,CH18+1                                                39060020
         LR    R9,R7                    PLACE R7 IN ADDR CH17           39150020
         STH   R9,CH17+2                                                39240020
         SRL   R9,16                                                    39330020
         STC   R9,CH17+1                                                39420020
ASYL2B5  LH    R9,DCBNOREC              ADD 1 TO NORECS                 39510020
         LA    R9,1(R9)                                                 39600020
         STH   R9,DCBNOREC                                              39690020
         BR    R11                      RETURN                          39780020
         EJECT                                                          39870020
*              CHART L4  ASYNCHRONOUS CODE 9                            39960020
ASYL4B2  BAL   R11,MYSUBRTN                                             40050020
         TM    CH8E+4,X'80'            TEST IF UNBL AND UWA       17332 40230020
         BZ    ASYL4D7                 IF NO-BRANCH               17332 40320020
         L     R11,CH6+4                                          17332 40410020
         LA    R6,2                                               17332 40500020
         SR    R11,R6                  SAVE 10 BYTES              17332 40590020
         ST    R11,CH6+4               FOR OVFL REC LINK FLD      17332 40680020
         L     R6,DECBAREA             USE  DECB AREA TO SAVE     17332 40770020
         MVC   0(10,R6),0(R11)         10  PRIOR  BYTES OF RECORD 17332 40860020
         IC    R6,DCBKEYLE                                        17332 40950020
         BCTR  R6,R0                                              17332 41040020
         EX    R6,APPSDAT              SAVE DATA                  17332 41130020
ASYL4D7  BAL   R11,ASYL2A2                                        17332 41220020
         B     ASYL4C4                  CYLINDER AREA RETURN. BRANCH.   41310020
         MVC   IOBDADAD+5(2),CB23       INDEPENDENT AREA.  HH FROM CB23 41400020
         NI    CH55,X'FF'-MT            MT OFF                   S20201 41490020
         LA    R6,CH55                  CHAN PROG START AT CH55  A50698 41580000
         ST    R6,IOBSTART-1                                            41670020
         B     ASYL4D5                  BRANCH                          41760020
ASYL4C4  LA    R6,CH5                   CYLINDER VRFLO AREA. SET CH4 TO 41850020
         ST    R6,CH4                                                   41940020
         MVI   CH4,X'08'                                                42030020
         CLC   IOBDADAD+K6(K1),CB23+K1     H(COCR) = H(TRK IX)   S20201 42120020
*                                       S2020                    S20201 42210020
         BE    ASYL4C5                     YES, BR--NO HEAD SEEK S20201 42300020
*                                       S2020                    S20201 42390020
         LA    R6,CI5                      GET SEEK ADDRESS      S20201 42480020
*                                       S2020                    S20201 42570020
         ST    R6,CH5                      AND PUT IN CH5        S20201 42660020
*                                       S2020                    S20201 42750020
         MVI   CH5,SEEKHH                  SET UP COMMAND CODE   S20201 42840020
*                                       S2020                    S20201 42930020
         MVI   CH5+K7,SIX                  SET COUNT TO SIX      S20201 43020020
*                                       S2020                    S20201 43110020
         MVC   CI5(K2),IOBDADAD+K1         SET BB                S20201 43200020
*                                       S2020                    S20201 43290020
         MVC   CI5+K2(K4),CB22+K6          SET UP CCHH           S20201 43380020
*                                       S2020                    S20201 43470020
         B     ASYL4D5                     CONTINUE CP 14 SET UP S20201 43560020
*                                       S2020                    S20201 43650020
ASYL4C5  MVI   CH5,NOP                     CONVERT TO NO-OP      S20201 43740020
         MVI   CH5+K7,K1                SET COUNT TO ONE        ZA01385 43790002
ASYL4D5  OI    CH8D,X'80'            D5      MT ON                      43920020
ASYL4D5A MVI   IOBAPP,12                GET APPEND CODE OF 12      9445 44010020
         LA    R6,IOBDADAD+3                                            44100020
         STH   R6,CH1+2                                                 44190020
         SRL   R6,16                                                    44280020
         STC   R6,CH1+1                                                 44370020
         MVC   CH3A+1(3),CH1+1               WRITE CHECK SEARCH         44460020
         MVI   IOBCOUNT,X'0A'                SET COUNTER TO 10          44550020
ASYLD5B  TM    CH8E+4,X'40'             TEST IF USER WA           17332 44640020
         BZ    ASYLDD4                  IF NO-BRANCH              17332 44730020
         MVC   CH14,IOBDADAD           SAVE SEEK ADDR PART 2      17332 44820020
         MVC   CH21+4(3),IOBSTART      SAVE IOBSTART              17332 44910020
         LA    R9,CH15                  START CP14 TO             17332 45000020
         ST    R9,IOBSTART-1            WRITE OVERFLOW RECORD     17332 45090020
         MVC   IOBDADAD,CH23            SET IOBSEEK=OVERFLOW REC  17332 45180020
ASYLDD4  EQU   *                                                  17332 45270020
         MVC   CK9+7(1),IOBASYN         SAVE ASYN CODE            17332 45360020
         BAL   R13,SUBROUT1                                             45540020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 45630021
         EJECT                                                          45720020
*              CHART L5  ASYNCHRONOUS ROUTINE, CODE 10                  45810020
ASYL5B2  BAL   R11,MYSUBRTN                                             45900020
ASYL5C3  BAL   R11,ASYL2A2              SUB-ROUTINE CHARTS L2-L3, USE 1 46080020
         B     ASYL5D4                  CYLINDER AREA RETURN. BRANCH    46170020
         MVC   IOBDADAD+5(2),CB24+2     INDEPENDENT AREA.  HH FROM CB24 46260020
         NI    CH8D,X'7F'            F3      MT OFF                     46350020
         NI    CH95,X'FF'-MT            MT OFF                   S20201 46440020
         L     R9,CH4                G3      CP14 STARTS AT CH4 ADDRESS 46530020
         ST    R9,IOBSTART-1                                            46620020
         B     ASYL5F4                  BRANCH                          46710020
ASYL5D4  OI    CH8D,MT                  MT ON                    S20201 46800020
         OI    CH95,MT                  MT ON                    S20201 46890020
ASYL5F4  B     ASYL4D5A                                            9445 46980020
         SPACE 10                                                       47070002
*              CHART L6  ASYNCHRONOUS ROUTINE, CODE 13                  47160020
ASYL6B2  BAL   R11,MYSUBRTN                                             47250020
         MVC   CB24(5),CB22+6                                           47430020
         MVC   CB25(10),CB10+7                                          47520020
         B     ASYL5C3                                                  47610020
         SPACE 2                                                        47660002
MYSUBRTN OC    IOBDADAD+6(1),DCBFIRSH+3 TRACK MASK                      47700020
         XC    IOBDADAD+6(1),DCBFIRSH+3 REDUCE TO CYL BOUNDRY OR ZERO   47790020
         MVI   IOBDADAD+7,0                                             47880020
         BR    R11                                                      47970020
         EJECT                                                          48780020
*              CHART L7  ASYNCHRONOUS ROUTINE, CODE 12                  48870020
ASYL7B2  L     R6,DECBAREA              R6  ADDR OF AREA DECB POINTS TO 48960020
         L     R7,CJ10                  R7  ADDR PER CJ10               49050020
         MVC   6(10,R6),0(R7)           MOVE LINK FIELD FROM CJ10 AREA  49140020
         BAL   R11,MYSUBRTN                                             49230020
         BAL   R11,ASYL2D1              SUB-ROUTINE CHARTS L2-L3, USE 2 49410020
         B     ASYL7E3                  CYLINDER OVERFLOW AREA USED.    49500020
         MVC   IOBDADAD,CH23            INDEPENDENT OVERFLOW AREA.      49590020
         LA    R10,CH15                 SET UP IOB, MBBCCHHR FROM CH23  49680020
         ST    R10,IOBSTART-1                                           49770020
         MVC   0(3,R7),CH23            MOVE LIOV TO LINK OF PREV  13270 49860020
         MVC   3(5,R7),CH24            RECD FROM CP14             13270 49950020
         CLC   CH23(1),CJ11             TEST SAME MCC CJ23 AND CJ11     50040020
         BNE   ASYL7K4A                                                 50130020
         L     R8,DCBWKPT2              GET DCW WORK AREA ADDR     0699 50220020
         CLC   CH23+3(3),CJ11+3                                         50580020
         BNE   ASYL7K4A                 NO MEANS NOT SAME        A42240 50710021
         MVI   9(R7),X'1B'              SEEK HEAD OLD P BYTE     A42240 50750021
         B     ASYL7G3                  NEW P BYTE SET ALREADY   A42240 50790021
ASYL7K4A EQU   *                                                        50850020
         L     R6,DECBAREA                                              50940020
         CLC   CH23(1),6(R6)            SET P IN DECB AREA TO           51030020
         BNE   ASYL7K3                   SEEK BBCCHH IF DIFF DEVICE(M)  51120020
         L     R8,DCBWKPT2              GET DCW WORK AREA ADDR     0699 51210020
         CLC   CH23+3(3),9(R6)          SEEK CCHH IF SAME DEVICE        51570020
         BNE   ASYL7K4                                   DIFF CYL (MCC) 51750020
         MVI   15(R6),X'1B'              SEEK     HH IF SAME DEVICE     51840020
         B     ASYL7F4                                   AND CYL(MCC)   51930020
ASYL7K4  MVI   15(R6),X'0B'                                             52020020
         B     ASYL7F4                                                  52110020
ASYL7K3  MVI   15(R6),X'07'                                             52200020
ASYL7F4  L     R7,CJ10                  TEST SAME M CJ23 AND CJ11       52290020
         CLC   CH23(1),CJ11                                             52380020
         BE    ASYL7G5                                                  52470020
         MVI   CH19,X'07'               NOT SAME, P IN CH19 AND IN AREA 52560020
         MVI   9(R7),X'07'               PER CJ10 MUST BE SEEK BBCCHH   52650020
         B     ASYL7G2                                                  52740020
ASYL7G5  MVI   CH19,X'0B'               SAME, P IN CH19 AND IN AREA PER 52830020
         MVI   9(R7),X'0B'               CJ10 MUST BE SEEK CCHH         52920020
         B     ASYL7G2                                                  53010020
*                                       CYLINDER OVERFLOW AREA.         53100020
ASYL7E3  MVC   0(3,R7),CH23             SET MBB OF LINK FIELD PER CJ10  53190020
         MVC   3(5,R7),CH24             SET CCHHR OF LINK FLD PER CJ10  53280020
         LA    R10,CH14                 CH4  MUST TIC TO CH14           53370020
         ST    R10,CH4                                                  53460020
         MVI   CH4,X'08'                MOVE TIC COMMAND                53550020
ASYL7F3  MVI   CH14,X'1B'               CH14 MUST SEEK HH               53640020
ASYL7G3  MVI   CH19,X'1B'               CH19 MUST SEEK HH               53730020
ASYL7G2  OI    CH18C+4,X'40'            CH18C CC FLAG ON                53820020
         MVC   CH22+1(3),CJ10+1         ADRESS IN CH22, SAME AS CJ10    53910020
         L     R10,DECBAREA             ADDRESS CH18, DECB AREA + 6     54000020
         LA    R10,6(R10)                                               54090020
         STH   R10,CH18+2                                               54180020
         SRL   R10,16                                                   54270020
         STC   R10,CH18+1                                               54360020
         MVC   CH17+1(3),DECBKEY+1      CH18 ADDRESS DECB KEY           54450020
         MVI   IOBAPP,13                APPENDAGE CODE 13               54540020
         MVI   IOBCOUNT,X'0A'                SET COUNTER TO 10          54630020
         B     ASYLD5B                                            17332 54720020
APPSDAT  MVC   0(0,R11),10(R11)                                   17332 54810020
         EJECT                                                          54900020
*              CHART L8  ASYNCHRONOUS ROUTINE,CODE 11                   54990020
ASYL8B2  BAL   R11,MYSUBRTN                                             55080020
         MVC   CH12+1(3),DECBKEY+1      SET ADDR IN CH12 TO DECB KEY    55260020
         L     R6,DECBAREA              R6  ADDR OF DECB AREA           55350020
         L     R7,CJ10                  R7  ADDR AREA PER CJ10          55440020
         MVC   6(10,R6),0(R7)           MBBCCHHR IN AREA+6 FROM CJ10    55530020
         OI    8(R7),X'18'              F NOW = OFLO CHAINED, NOT END   55620020
         BAL   R11,ASYL2D1              SUB-ROUTINE CHARTS L2-L3, USE 2 55710020
         B     ASYL8D2                  CYLINDER OVERFLOW AREA          55800020
         MVC   IOBDADAD(3),DCBLPDA      INDEPENDENT AREA.               55890020
         MVC   IOBDADAD+3(5),CB24       SEEK-SRCH ADDR =LAST OFLO ENTRY 55980020
         MVC   0(3,R7),CH23            SET LINK TO LAST IND OFLO  13270 56070020
         MVC   3(5,R7),CH24            RECD FROM CP14             13270 56160020
         LA    R10,CH9                                                  56250020
         ST    R10,IOBSTART-1                                           56340020
         NI    CH95,X'FF'-MT            CH95 MT OFF              S20201 56430020
         CLC   DCBLPDA(1),CH23          M OF CH23 = LST PRM DATA        56520020
         BE    ASYL8G3                                                  56610020
         MVI   CH14,X'07'               NO - CH14 OP-CODE   SEEK BBCCHH 56700020
         B     ASYL8H4                                                  56790020
ASYL8G3  MVI   CH14,X'0B'               YES- CH14 OP-CODE   SEEK CCHH   56880020
ASYL8H4  CLC   CH23(1),CJ11             MCC CH23 AND CJ11               56970020
         BNE   ASYL7F4                                                  57060020
         L     R8,DCBWKPT2              GET DCW WORK AREA ADDR     0699 57150020
         CLC   CH23+3(3),CJ11+3         CCH  CH23 AND CH11              57510020
         BNE   ASYL7F4                  NO - BRANCH                     57690020
         L     R7,CJ10                                                  57780020
         MVI   9(R7),X'1B'              YES - LINK PER CJ10 P = SEEK HH 57870020
         B     ASYL7G3                         AND BRANCH               57960020
ASYL8D2  L     R7,CJ10                  CYLINDER VRFLO AREA.            58050020
         MVI   9(R7),X'1B'                                              58140020
         MVC   0(3,R7),CH23             LINK PER CJ10 P = SEEK HH       58230020
         MVC   3(5,R7),CH24                           MBB FROM CH23     58320020
         LA    R10,CH9                                CCHHR FROM CH24   58410020
         ST    R10,CH4                                                  58500020
         MVI   CH4,X'08'                MOVE TIC COMMAND                58590020
         OI    CH95,MT                  CH95 MT ON               S20201 58680020
         B     ASYL7F3                                                  58770020
         EJECT                                                          58860020
*              CHART L9  ASYNCHRONOUS CODE 14                           58950020
ASYL9B2  EQU   *                        REPLACE DELETED RCD      Y02072 59000002
         LA    R10,CH20                 IOB START POINTS TO CH20        59130020
         ST    R10,IOBSTART-1                                           59220020
         L     R6,DECBAREA              LINK FIELD PER CJ10 MOVED TO    59310020
         L     R7,CJ10                   DECB AREA + 6                  59400020
         MVC   6(10,R6),0(R7)                                           59490020
         MVC   IOBDADAD,CJ11            RESTORE SEEK ADDRESS FROM CJ11  59580020
         LA    R10,6(0,R6)                   DECB AREA +6               59670020
         STH   R10,CH22+2                                               59760020
         SRL   R10,16                                                   59850020
         STC   R10,CH22+1                    PLACE AT CH22              59940020
         MVI   IOBAPP,13                APPENDAGE CODE 13               60030020
         MVI   IOBCOUNT,X'0A'                SET COUNTER TO 10          60120020
         MVC   CK9+7(1),IOBASYN         SAVE ASYN CODE           A27333 60210020
         BAL   R13,SUBROUT1                                             60390020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 60480021
         DROP  R15                                                      60570020
         USING ASYNCH,R3                                                60660020
         EJECT                                                          60750020
*********************************************************************** 60840020
*********   READ AND UPDATE                                  ********** 60930020
*********************************************************************** 61020020
*        CHART AS   ASYNCHRONOUS ROUTINES, CODES 0, 2, 4, AND 6         61110020
*              CODE 2                                                   61200020
ASYASB1  LR    R3,R15                   SET UP BASE REGISTER            61290020
         TM    DECBTYP1,X'01'           TEST DYNAMIC BUFFERING          61380020
         BZ    ASYASE5                  BRANCH IF NO                    61470020
         L     R15,IGGPDEB              PROTECTED DEB ADDR       Y02072 61490002
         USING IHADEB,R15                                        S21045 61510021
         L     R15,DEBEXPTR              GET ADDR OF DEB         S21045 61530021
*                                       EXTENSION PTR            S21045 61550021
         USING DEBEXT,R15                                        S21045 61570021
         L     R15,DEBFREED              LOAD ADDR DYN BUF       S21045 61590021
*                                       MODULE                   S21045 61610021
         DROP  R15                                               S21045 61630021
         USING IHABUF,R15                                               61650020
         BAL   R12,BUFASYN              BRANCH TO FREE BUFFER           61740020
         B     ASYASF5                  ON RETURN, BRANCH               61830020
*              CODE 0                                                   61920020
ASYASB2  LR    R3,R15                   SET UP BASE REGISTER            62010020
         TM    DECBTYP2,X'E0'           TEST READ                       62100020
         BZ    ASYASB1                  BRANCH IF NO                    62190020
         L     R10,DECBAREA             R10 DEVELOP ADDRESS OF LOG REC  62370020
         LA    R10,16(R10)                                              62460020
         TM    DECBEXC1,X'02'           OVERFLOW OR UNBLOCKED{          62550020
         BO    ASYASC4                  BRANCH IF YES                   62640020
         TM    DCBRECFM,X'10'                                           62730020
         BZ    ASYASC4                                                  62820020
         LR    R7,R10                   SEARCH FOR CORRECT REC IN BLOCK 62910020
         AH    R7,DCBBLKSI              R7   COMPARAND FOR BXLE (EOB)   63000020
         BCTR  R7,0                                                     63090020
         LH    R6,DCBLRECL              R6   INCREMENT FOR BXLE (REC L) 63180020
         AH    R10,DCBRKP               R10 ADDRESS OF KEY IN REC       63270020
         IC    R11,DCBKEYLE             R11 KEY LENGTH FOR EXECUTE      63360020
         BCTR  R11,0                                                    63450020
         L     R8,DECBKEY               R8  ADDRESS OF KEY SOUGHT       63540020
ASYASE3  EX    R11,ASYASE2                                              63630020
         BE    ASYASF3                                                  63720020
         BH    ASYASE1                                                  63810020
         BXLE  R10,R6,ASYASE3                                           63900020
ASYASE1  OI    DECBEXC1,X'80'           NO FIND                         63990020
         B     ASYASE5                                                  64170020
ASYASE2  CLC   0(0,R10),0(R8)                                           64260020
ASYASF3  SH    R10,DCBRKP               FOUND - SUBT RKP TO GET REC AD  64350020
ASYASC4  ST    R10,DECBLOGR             STORE ADDR LOG REC IN DECB      64440020
         L     R8,DCBWKPT2                                              64620020
         USING IHADCW,R8                                                64710020
         TM    DECBTYP2,X'20'           TEST FOR READ KU         A26738 64800020
         BZ    ASYASC5                  IF NOT, SEE IF DYN BUFF  A26738 64890020
         LA    R13,DCWFUPDI             IF SO, PLACE IOB ON UPDATE Q    64980020
         BAL   R15,ASYONQ                                               65070020
         XC    IOBCCWAD(4),IOBCCWAD     CLEAR DYN BUFFER PTR      MC1F  65160020
         TM    DECBTYP1,X'01'           IS THERE ANY DYN BUFFER   MC1F  65250020
         BZ    ASYASF5                BRANCH TO POST COMPLETION   MC1F  65340020
         MVC   IOBCCWAD(4),DECBAREA      YES SAVE PTR             MC1F  65430020
         B     ASYASF5                   AND BRANCH TO POST COMPLETION  65520020
ASYASC5  TM    DECBTYP1,X'01'           DYNAMIC BUFFER           A26738 65610020
         BZ    ASYASE50                 NO, REDUCE NACT AND POST A26738 65700020
         SR    R7,R7                    ZERO INDEX REG           A26738 65790020
         B     ASYASE59                 KEEP IOB ON ERROR QUEUE  A26738 65880020
*                 CODE 4, CODE 6                                        65970020
ASYASE5  EQU   *                                                 A26738 66060020
ASYASE5A SR    R7,R7                    ZERO INDEX REG           A26738 66150020
ASYASE5B LR    R3,R15                   SET UP BASE REGISTER      P4700 66240020
ASYASE55 EQU   *                        TEST FOR ERRORS          S20201 66330020
         L     R8,DCBWKPT2              ADDRESS OF WORK AREA      P4700 66420020
         TM    DECBEXC1,X'FD'           TEST FOR ERRORS           P4700 66510020
         BZ    ASYASE6(R7)              NO ERRORS - ISSUE FREEMAINP4700 66600020
         OI    IOBUNSQR,X'04'           MARK IOB IN ERROR        A26738 66690020
ASYASE59 LA    R13,DCWFIOBE             PUT IOB ON ERROR QUEUE   A26738 66780020
         IC    R0,DCWFIOBE              GET NO OF SLOTS LEFT     A26738 66870020
         BAL   R15,ASYONQ                                        A26738 66960020
         XC    IOBCCWAD(4),IOBCCWAD     CLEAR DYN BUFFER PTR      MC1F  67050020
         TM    DECBTYP1,X'01'           IS THERE ANY DYN BUFFER   MC1F  67140020
         BZ    ASYASE5C                 NO, BRANCH               A26738 67230020
         MVC   IOBCCWAD(4),DECBAREA      YES SAVE PTR             MC1F  67320020
ASYASE5C BCTR  R0,0                     INDICATE ONE LESS SLOT   A26738 67410020
         STC   R0,DCWFIOBE                                       A26738 67500020
         CLI   DCWFIOBE,X'FF'                                    A26738 67590020
         BNE   ASYASE7(R7)              BR IF AMT NOT MINUS      A26738 67680020
*                                       TO RETAIN ALL IOBS              67770020
         MVI   DCWFIOBE,X'00'           STILL NO SPACE IN QUEUE  A26738 67860020
         L     R1,DCWFIOBE              ELSE, REMOVE FIRST IOB   A26738 67950020
         LR    R0,R2                    SAVE CURRENT DECB        A26738 68040020
         LA    R2,DCWFIOBE              POINT TO ERROR QUEUE     A26738 68130020
         LA    R13,4                    SEARCH FOR AN ERROR IOB  A26738 68220020
         BAL   R15,ASYOFFQA             REMOVE IOB               A26738 68310020
         LR    R2,R0                    RESTORE DECB REGISTER    A26738 68400020
         L     R13,IOBCCWAD             DOES THIS DEQUEUED IOB   A26738 68490020
         LTR   R13,R13                  HAVE A DYNAMIC BUFFER    A26738 68580020
         BZ    ASYASE6(R7)              NO, BR TO FREE OLD IOB   A26738 68670020
         L     R15,DCBBUFCB             OTHERWISE, FREE OLD BUFF A26738 68760020
         MVC   0(4,R13),BCBNAVB(R15)                             A26738 68850020
         ST    R13,BCBNAVB(R15)                                  A26738 68940020
         B     ASYASE6(R7)              NOW FREE OLD IOB         A26738 69030020
ASYASE7  B     ASYASF51                 OMIT FREEMAIN            A26738 69120020
         B     ASYASE61                 OMIT ISSUING OF FREEMAIN  P4700 69210020
         B     ASYASE71                 OMIT ISSUING OF FREEMAIN  P4700 69300020
ASYASE6  B     ASYASE50                 ISSUE FREEMAIN            P4700 69390020
         B     ASYASE60                 ISSUE FREEMAIN            P4700 69480020
         B     ASYASE70                 ISSUE FREEMAIN            P4700 69570020
ASYASE50 LR    R0,R1                   R0 = IOBADDR              S20201 69660020
*                                                                       69750002
         BAL   R1,FREEIOB               FREE IOB CORE            Y02072 69800002
*                                                                       69850002
ASYASF51 L     R8,DCBWKPT2        SUBSTRACT 1 FROM  NUMBER OF     7M216 70740020
         IC    R12,DCWNACT               MACRO EVENTS TO BE COMPLETED   70830020
         BCTR  R12,0                     BEFORE NEXT WRITE KN CAN BE    70920020
         STC   R12,DCWNACT               EXECUTED                       71010020
ASYASF5  EQU   *                                                 A41652 71070021
         ST    R2,DCBPUTX               DECB TO BE POSTED        A41652 71130021
         L     R12,IGGPDEB              PROTECTED DEB ADDR       Y02072 71280002
         L     R8,DCBWKPT2                                              71330000
         USING IHADEB,R12                                               71370020
         L     R12,DEBEXPTR              GET ADDR OF DEB EXT PTR S21045 71400021
         USING DEBEXT,R12                                        S21045 71430021
         L     R12,DEBDISAD              GET ADDR OF RTN TO SET  S21045 71460021
         DROP  R12                                               S21045 71490021
         USING IHADIS,R12                                               71550020
         SRL   R9,1                     BRANCH BY ASYNCHRONOUS CODE     71640020
         B     ASYTAB2(R9)               TO RTN TO FREE CP4-5-6 OR CP7  71730020
ASYTAB2  B     ASYASH5                  CODE 0 OR 4, TO ASYASH5         71820020
         B     ASYASG2                  CODE 2 OR 6, TO ASYASG2         71910020
         B     ASYASH5                                                  72000020
ASYASG2  CLI   DCWNUCP7,X'00'           FREE CP7. ANY IOB AWAITING ONE{ 72090020
         BE    ASYASG3                  BRANCH IF NO                    72180020
         LA    R13,32                   FIND IOB AWAITING CP7 AND       72270020
         BAL   R15,ASYOFFQ               REMOVE IT FROM UNSCHED QUEUE   72360020
         USING IHAIOB,R1                                         S20201 72450020
ASYASJ2  IC    R6,DCWNUCP7              SUBTRACT ONE FROM NO. IOBS      72540020
         BCTR  R6,0                      AWAITING CP7                   72630020
         STC   R6,DCWNUCP7                                              72720020
         NI    IOBINDCT,X'7F'           CP7 ALREADY OUT OF Q            72900020
         BAL   R11,DISCP7               GO TO ROUTINE TO SET UP CP7     72990020
         B     ASYAVB2                  BRANCH TO EXCP                  73170020
ASYASG3  MVC   12(4,R5),DCWFCP7         NO IOB AWAITING CP7. ADD IT TO  73260020
         ST    R5,DCWFCP7                CP7 QUEUE                      73350020
         B     ASYAWB2                  BRANCH TO START PENDING WKN     73440020
ASYASH4  EQU   *                        *                       SA61539 73490002
         IC    R6,DCWNACT               DECREASE NUMBER OF      SA61539 73500002
         BCTR  R6,0                     NON-WRITE KEY NEW       SA61539 73510002
         STC   R6,DCWNACT               MACRO EVENTS            SA61539 73520002
ASYASH5  CLI   DCWNUCP4,X'00'           FREE CP4-5-6                    73530020
         BE    ASYASJ5                  IF NO IOB AWAITING IT, BRANCH   73620020
         LA    R13,64                   FIND IOB ASAITING CP4-5-6 AND   73710020
         BAL   R15,ASYOFFQ              REMOVE IT FROM UNSCHEDULED Q    73800020
ASYASJ4  IC    R6,DCWNUCP4              SUBT 1 FROM NO. OF IOBS         73890020
         BCTR  R6,0                      AWAITING CP4-5-6               73980020
         STC   R6,DCWNUCP4                                              74070020
         NI    IOBINDCT,X'7F'           INDICATE CP4-5-6 NOT ON Q       74160020
         BAL   R11,DISCP45              GO TO SET UP CP4-5-6            74250020
         B     ASYASH4                  ERROR RETURN            SA61539 74340002
ASYAVB2  BAL   R13,SUBROUT1                                             74430020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 74520021
ASYASJ5  MVC   12(4,R5),DCWFCP4         NO IOB AWAITING CP4-5-6, ADD IT 74610020
         ST    R5,DCWFCP4                TO AVAILABLE QUEUE             74700020
         B     ASYAWB2                  BRANCH TO START PENDING WKN     74790020
ASYAUB20 EQU   *                        *                       ZA00956 74840002
         IC    R6,DCWNACT               DECREASE NUMBER OF      ZA00956 74850002
         BCTR  R6,0                     NON-WRITE KEY NEW       ZA00956 74860002
         STC   R6,DCWNACT               MACRO EVENTS            ZA00956 74870002
         B     ASYAUB21                 *                       ZA00956 74872002
*        CHART AU   ASYNCHRONOUS ROUTINES, CODES 3 AND 7                74880020
ASYAUB2  LR    R3,R15                   SET UP BASE REGISTER            74970020
         L     R8,DCBWKPT2              R8  ADDRESS OF WORK AREA        75060020
         LR    R9,R1                    SAVE ADDRESS OF IOB             75150020
ASYAUB21 CLI   DCWNUCPS,X'00'           TEST CP1/2 QUEUE EMPTY          75240020
         BNE   ASYAUB3                                                  75330020
         OI    DCWHIAV,X'80'            YES - SET INDICATOR TO AVAILABL 75420020
         B     ASYAUF3                   AND BRANCH TO CONTINUE IOB     75510020
ASYAUB3  EQU   *                                                        75600020
         LA    R13,128                  FIND IOB AWAITING CP1 OR CP2 +  75690020
         BAL   R15,ASYOFFQ               REMOVE IT FROM UNSCHED QUEUE   75780020
         IC    R6,DCWNUCPS              DECREASE NO. OF IOBS AWAITING   75870020
         BCTR  R6,0                      CP1/2                          75960020
         STC   R6,DCWNUCPS                                              76050020
         L     R12,IGGPDEB             PROTECTED DEB ADDR        Y02072 76140002
         USING IHADEB,R12                                               76230020
         L     R12,DEBEXPTR              GET ADDR OF DEB EXT PTR S21045 76260021
         USING DEBEXT,R12                                        S21045 76290021
         L     R12,DEBDISAD              GET ADDR OF RTN TO SET  S21045 76320021
         DROP  R12                                               S21045 76350021
         USING IHADIS,R12                                               76410020
         BAL   R11,DISCPS               BRANCH TO SET UP CP1/2          76500020
         B     ASYAUB20                 ERROR RETURN            ZA00956 76590002
         BAL   R13,SUBROUT1                                             76680020
ASYAUF3  LR    R1,R9                    RESTORE IOB ADDRESS             76770020
         L     R2,IOBECBAD              RESTORE DECB ADDRESS            76860020
         CLI   IOBASYN,X'03'            TEST ASYNCH CODE INDICATE ERROR 76950020
         BE    ASYAUD2                  BRANCH IF NO                    77040020
         LA    R7,8                                               P4700 77130020
         B     ASYASE55                 TEST FOR ERROR ROUTINE   S20201 77220020
ASYASE70 LR    R0,R1                    R0=IOB ADDR              S20201 77310020
*                                                                       77400002
         BAL   R1,FREEIOB               FREE IOB CORE            Y02072 77450002
*                                                                       77500002
ASYASE71 EQU   *                                                  7S029 78390020
         IC    R9,DCWNACT               DECREASE NO. OF NON-WRITE KN    78480020
         BCTR  R9,0                      MACRO EVENTS                   78570020
         STC   R9,DCWNACT                                               78660020
         ST    R2,DCBPUTX               DECB TO BE POSTED        A41652 78750021
         B     ASYAWB2                  BRANCH                          78840020
         USING IHAIOB,R1                                         S20201 78930020
ASYAUD2  L     R5,DCWFCP4               NO - CONTINUE                   79020020
         LTR   R5,R5                                                    79110020
         BZ    ASYAUD1                  CP4-5-6 AVAILABLE {             79200020
         OI    IOBINDCT,X'80'           YES - SET UP CP4-CP5            79290020
         L     R12,IGGPDEB              PROTECTED DEB ADDR       Y02072 79380002
         USING IHADEB,R12                                               79470020
         L     R12,DEBEXPTR              GET ADDR OF DEB EXT PTR S21045 79500021
         USING DEBEXT,R12                                        S21045 79530021
         L     R12,DEBDISAD              GET ADDR OF RTN TO SET  S21045 79560021
         DROP  R12                                               S21045 79590021
         USING IHADIS,R12                                               79650020
         BAL   R11,DISCP45                                              79740020
         B     ASYERROR                 ERROR RETURN, BISAM BUG SA63253 79830002
         BAL   R13,SUBROUT1                                             79920020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 80010021
ASYAUD1  MVI   IOBUNSQR,X'40'           NO - CP4-5-6 NOT AVAILABLE      80100020
         IC    R6,DCWNUCP4              ADD IOB TO UNSCHED Q            80190020
         LA    R6,1(R6)                                                 80280020
         STC   R6,DCWNUCP4                                              80370020
         LA    R13,DCWFIOBU                                             80460020
         BAL   R15,ASYONQ                                               80550020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 80640021
*                                                                       80730020
ASYONQ   LA    R1,0(R1)                 ADD THE IOB WHICH IS            80820020
         L     R6,4(R13)                 POINTED TO BY R1               80910020
         ST    R6,IOBBCHAD               TO THE QUEUE WHOSE FIRST IOB   81000020
         LTR   R6,R6                     POINTER IS IN 0(R13) AND       81090020
         BZ    ASYONQA                   WHOSE LAST IOB POINTER IS IN   81180020
         ST    R1,IOBFCHAD-IHAIOB(R6)    4(R13)                         81270020
         B     ASYONQB                                                  81360020
ASYONQA  ST    R1,0(R13)                                                81450020
ASYONQB  XC    IOBFCHAD,IOBFCHAD                                        81540020
         ST    R1,4(R13)                                                81630020
         BR    R15                      RETURN VIA R15.                 81720020
ASYOFFQ  LA    R2,DCWFIOBU              POINT TO UNSCHED QUEUE   A26738 81810020
         L     R1,DCWFIOBU              FIND THE 1ST IOB ON THE  A26738 81900020
ASYOFFQA EX    R13,ASYOFFQF              UNSCHEDULED QUEUE FOR REASON   81990020
         BO    ASYOFFQB                  IN R13, PUT ITS ADDRESS IN R1, 82080020
         L     R1,IOBFCHAD               REMOVE IT FROM THE UNSCHEDULED 82170020
         B     ASYOFFQA                  QUEUE.                         82260020
ASYOFFQB L     R6,IOBBCHAD                                              82350020
         LTR   R6,R6                                                    82440020
         BZ    ASYOFFQC                                                 82530020
         MVC   IOBFCHAD-IHAIOB(4,R6),IOBFCHAD                           82620020
         B     ASYOFFQD                                                 82710020
ASYOFFQC MVC   1(3,R2),IOBFCHAD+1       UPDATE PTR TO 1ST IOB    A26738 82800020
ASYOFFQD L     R6,IOBFCHAD                                              82890020
         LTR   R6,R6                                                    82980020
         BZ    ASYOFFQE                                                 83070020
         MVC   IOBBCHAD-IHAIOB(4,R6),IOBBCHAD                           83160020
         B     ASYOFFQG                                                 83250020
ASYOFFQE MVC   5(3,R2),IOBBCHAD+1       UPDATE PTR TO LAST IOB   A26738 83340020
ASYOFFQG L     R2,IOBECBAD              SET ITS DECB POINTER IN R2      83430020
         BR    R15                      RETURN VIA R15                  83520020
ASYOFFQF TM    IOBUNSQR,X'00'                                           83610020
*********************************************************************** 83700020
*********   BEGIN A WRITE KN MACRO AFTER COMPLETION OF              *** 83790020
*********     ALL READ AND UPDATE MACROS OR AFTER ANOTHER WRITE KN  *** 83880020
*********************************************************************** 83970020
*        BASE REGISTER IS STILL R3                                      84060020
*              CHART AW   CODES 0, 2, 4 AND 6 CONTINUED                 84150020
         DROP  R1                                                S20201 84240020
ASYAWB2  CLI   DCWNACT,X'00'            IF ANOTHER CP IN PROCESS        84330020
         BNE   ASYFINIS                 IF NOT GO TO EXIT        A41652 84420021
         L     R1,DCWFIOBU               OR IF NO MORE IOBS ON Q        84510020
         USING IHAIOB,R1                                         S20201 84600020
         LTR   R1,R1                                                    84690020
         BNZ   ASYAWD2                   BIF IOB EXISTS          S20201 84780020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 84870021
ASYAWD2  CLI   DCWNUWKN,X'00'           ERROR IN BISAM IF NUWKN ZERO    84960020
         LA    R6,ASYAWD2               POINT OF ERROR          SA63253 85010002
         BE    ASYERROR                 BISAM ERROR ROUTINE     SA63253 85050002
         OI    DCWWKNI,X'80'            SET WKN INDICATOR TO IN PROCESS 85140020
ASYAWE2  TM    IOBUNSQR,X'10'           FIND FIRST IOB WITH AWAITING    85230020
         BO    ASYAWE21                  WRITE KN UNSCHEDULED REASON    85320020
         L     R1,IOBFCHAD                                              85410020
         B     ASYAWE2                                                  85500020
ASYAWE21 L     R6,IOBFCHAD               AND REMOVE IT FROM THE UNSCHED 85590020
         LTR   R6,R6                     QUEUE                          85680020
         BZ    ASYAWE22                                                 85770020
         MVC   IOBBCHAD-IHAIOB(4,R6),IOBBCHAD                           85860020
         B     ASYAWE23                                                 85950020
ASYAWE22 MVC   DCWLIOBU,IOBBCHAD                                        86040020
ASYAWE23 L     R6,IOBBCHAD                                              86130020
         LTR   R6,R6                                                    86220020
         BZ    ASYAWE24                                                 86310020
         MVC   IOBFCHAD-IHAIOB(4,R6),IOBFCHAD                           86400020
         B     ASYAWG2                                                  86490020
ASYAWE24 MVC   DCWFIOBU,IOBFCHAD                                        86580020
ASYAWG2  IC    R6,DCWNUWKN              DECREASE THE NUMBER OF IOBS     86670020
         BCTR  R6,0                      AWAITING W KN  CP              86760020
         STC   R6,DCWNUWKN                                              86850020
         L     R2,IOBECBAD              R2   ADDR OF DECB FOR NEW IOB   86940020
         L     R12,IGGPDEB              PROTECTED DEB ADDR       Y02072 87030002
         USING IHADEB,R12                                               87120020
         L     R12,DEBEXPTR              GET ADDR OF DEB EXT PTR S21045 87150021
         USING DEBEXT,R12                                        S21045 87180021
         L     R12,DEBDISAD              GET ADDR OF RTN TO SET  S21045 87210021
         DROP  R12                                               S21045 87240021
         USING IHADIS,R12                 UP FIRST WKN CHANNEL PROGRAM  87300020
         BAL   R11,DISCPWKN              BRANCH TO THE ROUTINE          87390020
         BAL   R13,SUBROUT1                                             87480020
         LR    R15,R3                   RESTORE FORMER BASE      M0702  87570020
         B     ASYLAE4                  RETURN                   A35340 87660020
ASYAWF2  L     R1,DCWFIOBU              ENTRY FROM CHART LA             87750020
         LR    R3,R15                                                   87840020
         B     ASYAWE2                                                  87930020
SUBROUT1 EQU   *                        *                               88020000
         SR    R7,R7                                              12705 88109600
         IC    R7,IOBDADAD              GET M OF CURRENT EXTENT   12705 88110020
         SLL   R7,4                     M X 16                    12705 88200020
         L     R6,IGGPDEB               PROTECTED DEB ADDR       Y02072 88250002
         LA    R7,32(R7,R6)             PLACE BB FROM THE CURRENT 12705 88380020
         MVC   IOBDADAD+1(2),4(R7)      EXTENT INTO THE DEB       12705 88470020
         MVC   IOBBCHAD+1(3),IOBECBAD+1 SAVE ECB                 A33533 88510021
         LA    R7,IOBCSW                IOS WILL ZERO OUT        A33533 88550021
         ST    R7,IOBECBAD              CSW INSTEAD OF ECB       A33533 88590021
         LR    R7,R15                                             12705 88650020
         LR    R4,R1                    SAVE IOB ADDRESS         M1792  88700021
         BALR  15,0                     ADDRESSABILITY - ENABLE  A48664 88702000
         USING *,15                                              A48664 88704000
*                                                                       88706002
         BAL   R11,FREELOCK             RELEASE LOCAL LOCK       Y02072 88716002
*                                                                       88726002
         EXCP  (1)                                                12705 88740020
         BALR  15,0                     ADDRESSABILITY - DISABLE A48664 88750000
         USING *,15                                              A48664 88760000
*                                                                       88770002
         BAL   R11,GETLOCK              OBTAIN LOCAL LOCK        Y02072 88820002
*                                                                       88822002
         LR    R15,R7                                             12705 88830020
         LR    R1,R4                    RESTORE IOB ADDRESS      M1792  88880021
         USING IHADEB,R6                ADDRESSABILITY ON DEB    M1792  88890021
         L     R4,DEBDCBAD              RESTORE DCB ADDRESS      M1792  88900021
         DROP  R6                                                M1792  88910021
         MVC   IOBECBAD+1(3),IOBBCHAD+1 RESTORE ECB              A33533 88920021
         BR    R13                                                      89010020
         EJECT                                                          89015021
*        THE FOLLOWING ROUTINE IS ENTERED ON A BISAM ERROR              89015402
*        CONDITION. IT SAVES REGISTERS AND RETURNS TO USER              89015802
*        WITH ERRORS SET IN DECB.                                       89016202
         SPACE 1                                                        89016602
ASYERROR EQU   *                        *                               89016702
         L     R8,DCBMSWA               ADDR OF AREA TO SAVE REGSA63253 89016802
         STM   R0,R15,0(R8)             SAVE ALL REGISTERS      SA63253 89016902
         ST    R6,DCBGET                SAVE ERROR ADDRESS      SA63253 89019002
         SPACE 2                                                        89021002
**********************************************************************  89024102
*              THE FOLLOWING IS THE COMMON EXIT TO BE USED FOR       *  89026202
*              RETURNING TO THE SUPERVISOR AFTER POSTING             *  89028302
*              A COMPLETED REQUEST IF NECESSARY                      *  89030402
**********************************************************************  89032502
         SPACE 2                                                        89034602
ASYFINIS EQU   *                                                 A41652 89036702
         BALR  R12,R0                   ESTABLISH               YM01347 89040002
         USING *,R12                    ADDRESSABILITY          YM01347 89045002
*                                                                       89045402
         BAL   R11,FREELOCK             RELEASE LOCAL LOCK       Y02072 89047002
*                                                                       89047402
         IC    R2,IGGUKEY               USER PROTECT KEY         Y02072 89049302
         L     R0,SP230                 SIZE AND SUBPOOL         Y02072 89051402
         LR    R1,R14                   ADDR OF CORE TO FREE     Y02072 89053502
         L     R14,IGGRETRN             RETURN ADDRESS           Y02072 89055602
         SPACE 2                                                        89057702
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 89059802
         SPACE 2                                                        89061902
         FREEMAIN  R,LV=(0),A=(1)       FREE SAVE AREA           Y02072 89064002
         SPACE 2                                                        89066102
         MODESET  KEYADDR=(2)           CHANGE TO USER KEY       Y02072 89068202
         SPACE 2                                                        89070302
         NC    DCBPUTX,DCBPUTX          DECB TO BE POSTED        A41652 89072402
         BZ    NOPOST                   NO - EXIT                A41652 89074502
         L     R2,DCBPUTX               GET SAVED DECB ADDR      A41652 89076602
         POST  DECBECB                  POST COMPLETION          A41652 89078702
**********************************************************************  89080802
*        DO NOT INSERT CODE BETWEEN POST AND RETURN                  *  89082902
**********************************************************************  89085002
NOPOST   EQU   *                                                 A41652 89087102
         RETURN ,                       RETURN TO SUPERVISOR     A41652 89089202
         EJECT                                                          89091302
**********************************************************************  89093402
*        SUBROUTINES TO OBTAIN AND RELEASE THE LOCAL LOCK            *  89095502
**********************************************************************  89097602
         SPACE 2                                                        89137602
GETLOCK  MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 89187602
         SPACE 2                                                        89189602
         STM   R0,R15,IGGREGS           SAVE REGISTERS           Y02072 89197602
         LR    R9,R14                   SAVE SAVE AREA ADDR      Y02072 89207602
         DROP  R14                      END USING ON SAVE AREA   Y02072 89217602
         BALR  R3,R0                    ESTABLISH                Y02072 89227602
         USING *,R3                     ADDRESSABILITY           Y02072 89229602
         SPACE 2                                                        89230002
         MODESET  KEYADDR=KEY0,WORKREG=11 CHANGE TO KEYZERO      Y02072 89231602
         SPACE 2                                                        89232002
**********************************************************************  89232102
*        OBTAIN THE LOCAL LOCK.  FREED AT FLCL1.                     *  89232402
**********************************************************************  89232502
         SPACE 2                                                        89232802
GLCL1    SETLOCK  OBTAIN,TYPE=LOCAL,MODE=UNCOND,  OBTAIN THE     Y02072*89233202
               RELATED=(IOB,IGG019GW(FLCL1))  LOCAL LOCK         Y02072 89233302
         USING IGGSAVE,R9               SAVEAREA ADDRESSABILITY  Y02072 89241102
         SPACE 2                                                        89241502
         MODESET  KEYADDR=IGGUKEY,WORKREG=11 CHANGE TO USER KEY  Y02072 89243102
         SPACE 2                                                        89243502
         LM    R0,R15,IGGREGS           RESTORE REGISTERS        Y02072 89245102
         BR    R11                      RETURN                   Y02072 89247102
         DROP  R3,R9                    END USINGS               Y02072 89247502
         SPACE 4                                                        89247902
FREELOCK MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 89248302
         SPACE 2                                                        89248402
         USING IGGSAVE,R14              SAVEAREA ADDRESSABILITY  Y02072 89248702
         STM   R0,R15,IGGREGS           SAVE REGISTERS           Y02072 89248802
         LR    R9,R14                   SAVE SAVE AREA ADDR      Y02072 89256602
         DROP  R14                      END USING ON SAVE AREA   Y02072 89257002
*                                                                       89258602
         BALR  R3,R0                    ESTABLISH                Y02072 89260602
         USING *,R3                     ADDRESSABILITY           Y02072 89262602
         SPACE 2                                                        89262702
         MODESET  KEYADDR=KEY0,WORKREG=11  CHANGE TO KEYZERO     Y02072 89263002
         SPACE 2                                                        89263102
**********************************************************************  89263502
*        RELEASE THE LOCAL LOCK.  OBTAINED AT GLCL1.                 *  89263802
**********************************************************************  89263902
         SPACE 2                                                        89264202
FLCL1    SETLOCK  RELEASE,TYPE=LOCAL,   RELEASE THE              Y02072*89264302
               RELATED=(IOB,IGG019GW(GLCL1))  LOCAL LOCK         Y02072 89269402
         USING IGGSAVE,R9               SAVEAREA ADDRESSABILITY  Y02072 89271402
         SPACE 2                                                        89271802
         MODESET  KEYADDR=IGGUKEY,WORKREG=11 CHANGE TO USER KEY  Y02072 89273402
         SPACE 2                                                        89273502
         LM    R0,R15,IGGREGS           RESTORE REGISTERS        Y02072 89273802
         BR    R11                      RETURN                   Y02072 89274202
         DROP  R3,R9                    END USINGS               Y02072 89274602
         SPACE 4                                                        89275902
**********************************************************************  89276302
*        SUBROUTINE TO FREE IOB.  ROUTINE USES BRANCH ENTRY TO       *  89277902
*        FREEMAIN                                                    *  89278302
**********************************************************************  89278402
         SPACE 2                                                        89279302
FREEIOB  MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 89279402
         SPACE 2                                                        89279902
         USING IGGSAVE,R14              SAVEAREA ADDRESSABILITY  Y02072 89282502
         STM   R0,R15,IGGREGS           SAVE REGISTERS           Y02072 89283002
         BALR  R9,R0                    ESTABLISH                Y02072 89283502
         USING *,R9                     ADDRESSABILITY           Y02072 89284002
         L     R5,IGGPDEB               PROTECTED DEB ADDR       Y02072 89284502
         USING IHADEB,R5                DEB ADDRESSABILITY       Y02072 89285002
         LR    R1,R0                    IOB ADDRESS              Y02072 89285502
         LA    R0,SP250IOB              IOB SIZE AND SUBPOOL     Y02072 89286002
         TM    DEBRPSID,RPS             RPS DEVICE               Y02072 89286502
         BZ    NORPS                    BR NOT RPS               Y02072 89287002
         AH    R0,RPSCCW                LNGTH OF RPS CCWS        Y02072 89287502
NORPS    L     R4,DEBTCBAD              TCB ADDR                 Y02072 89288002
         DROP  R5                       END USING ON DEB         Y02072 89288502
         USING PSA,R0                   LOW CORE ADDRESSABILITY  Y02072 89289002
         L     R7,PSAAOLD               ASCB ADDRESS             Y02072 89289802
         SPACE 2                                                        89289902
         MODESET  KEYADDR=KEY0,WORKREG=5 CHANGE TO KEYZERO       Y02072 89290002
         SPACE 2                                                        89292002
         LR    R5,R14                   SAVE SAVE AREA ADDR      Y02072 89294202
         IC    R6,IGGUKEY               USER'S PROTECT KEY       Y02072 89294602
         DROP  R14                      END USING ON SAVE AREA   Y02072 89295002
         SPACE 2                                                        89295402
         FREEMAIN  RU,LV=(0),A=(1),SP=SP250,KEY=(R6),BRANCH=YES  Y02072 89296202
         USING IGGSAVE,R5               SAVEAREA ADDRESSABILITY  Y02072 89298302
         SPACE 2                                                        89300702
         MODESET  KEYADDR=IGGUKEY,WORKREG=4 CHANGE TO USER KEY   Y02072 89305602
         SPACE 2                                                        89307602
         LM    R0,R15,IGGREGS           RESTORE REGISTERS        Y02072 89308002
         BR    R1                       RETURN                   Y02072 89310402
         SPACE 4                                                        89312802
RPS       EQU  X'E0'                    RPS MASK-BIT 0=P,1=I,2=O S20201 89315202
SIX      EQU   6                           BYTES FOR SEEK HH     S20201 89317602
RPSCCW   DC    H'16'                    LENGTH OF RPS CCW'S.     S20201 89370020
         DS    0F                                                S20201 89460020
SP250IOB EQU   56                       BASIC IOB=56 BYTES IN    Y02072 89550002
SP250    EQU   250                      SUBPOOL 250              Y02072 89600002
SP230    DC    AL1(230),AL3(IGGSIZE)    SAVEAREA IN SP 230       Y02072 89690002
KEY0     DC    X'00'                    CHANGE TO KEY ZERO       Y02072 89700002
INVASYCD DC    H'0'                PROGCHK FOR BAD ASYN CODE   @ZA26522 89710037
FOURTEEN DC    X'000E'             MAX VALUE FOR ASYN CODE     @ZA26522 89711037
*                                                                       89712037
MODID    DC    C'IGG019GW'              MODULE NAME            @ZA26522 89713037
DATE     DC    CL8'&SYSDATE'            FIX DATE               @ZA26522 89714037
FIX      DC    C' OZ26522'              LATEST FIX             @ZA26522 89715037
PATCH    DC    XL((*-IGG019GW)/20)'00'  ZEROED PATCH AREA        Y02072 89720002
*                                                                       89722002
BCBNAVB  EQU   8                        NEXT AVAIL DYN BUFF PTR  A26738 89730020
IHABUF   DSECT                DYNAMIC BUFFERING VECTOR TABLE            89820020
BUFFREED DS    A                       FREEDBUF ENTRANCE                89910020
BUFSIO   DS    A                       APPENDAGE ENTRANCE               90000020
         DS    A                                                        90090020
BUFASYN  DS    A                       ASYNCHRONOUS ENTRANCE            90180020
IHADIS   DSECT                DISABLED MODULE VECTOR TABLE              90270020
DISQHN   DS    A                       Q-HANDLER                        90360020
DISCP45  DS    A                       SET UP CP4 + CP5                 90450020
DISCP7   DS    A                       SET UP CP7                       90540020
DISCPS   DS    A                       SET UP CP1 OR CP2                90630020
DISCPWKN DS    A                        SET UP WRITE KN CP'S            90720020
DISPRIV  DS    A                        SCHEDULE READ AND UPDATE REQ    90810020
         EJECT                                                          90900002
IHAWKNCP IGGWKNCP OPTCD=W WRITE KN CHANNEL PROGRAM REFERENCES    S20201 90990020
CP9A     EQU   *                                                 S20201 91080020
         IGGCP9A                                                        91170020
         IGGCP9B OPTCD=W                                         S20201 91260020
         IGGCP9C OPTCD=W                                         S20201 91350020
         ORG     CP9A                         CP11               S20201 91440020
         IGGCP11A                                                       91530020
         IGGCP11B OPTCD=W                                        S20201 91620020
         ORG     CP9A                         CP12A              S20201 91710020
         IGGCP12A                                                       91800020
         ORG     CP9A                         CP12B              S20201 91890020
         IGGCP12B                                                       91980020
         ORG     CP9A                       CP13A                S20201 92070020
         IGGCP13A                                                       92160020
         ORG     CP9A                       CP13B                S20201 92250020
         IGGCP13B                                                       92340020
         EJECT                                                          92430020
*              DATA EVENT CONTROL BLOCK                                 92520020
IHADECB  DSECT                                                          92610020
         DS    0F                                                       92700020
DECBECB  DS    CL4                      EVENT CONTROL BLOCK (ECB)       92790020
DECBTYP1 DS    BL1                      TYPE B6 - 1 IF LENGTH IS S      92880020
*                                            B7 - 1 IF AREA IS S        92970020
DECBTYP2 DS    BL1                           B0 - 1 IF READ K           93060020
*                                            B1 - 1 IF READ KX          93150020
*                                            B2 - 1 IF READ KU          93240020
*                                            B4 - 1 IF WRITE K          93330020
DECBWKN  EQU   X'04'                         B5 - 1 IF WRITE KN         93420000
DECBLGTH DS    CL2                      LENGTH OF BLOCK                 93510020
DECBDCBA DS    A                        POINTER TO DCB                  93600020
DECBAREA DS    A                        ADDRESS OF AREA                 93690020
DECBLOGR DS    A                        POINTER TO LOGICAL RECORD       93780020
DECBKEY  DS    A                        POINTER TO KEY                  93870020
DECBEXC1 DS    BL1                      EXCPTN CD B0-RECORD NOT FOUND   93960020
*                                                 B1-RECORD LGTH CHK    94050020
*                                                 B2-NO SPACE           94140020
*                                                 B3-INVALID REQUEST    94230020
*                                                 B4-UNCORRECTABLE IO   94320020
*                                                 B5-UNREACHABLE BLOCK  94410020
*                                                 B6-OVERFLOW RECORD    94500020
*                                                 B7-DUPLICATE          94590020
DECBEXC2 DS    BL1                                B7-READ KU            94680020
         SPACE 2                                                        94730002
IGGSAVE  IGGBISAV                                                       94740002
         EJECT                                                          94770020
         DCBD  DSORG=(IS)                                               94860020
         EJECT                                                          94910002
IHAIOB   IGGIOBD                                                        94950020
         EJECT                                                          95000002
IHADCW   IGGBISAM                                                       95040020
         EJECT                                                          95090002
IHADEB   IGGDEBD                                                        95130020
         EJECT                                                          95220020
DCBFA    IGGDCBFA                                                       95310020
         EJECT                                                          95400020
CVTDEF   DSECT                                                          95490020
         CVT                                                            95580020
         SPACE 4                                                        95630002
         IECDRQE                                                 Y02072 95640002
         SPACE 4                                                        95650002
         IHAPSA                                                  Y02072 95660002
         END                                                            95670020
