         TITLE 'IGG019GZ - ASYNC ROUTINES COMBINED, NO WRT CHK'         00090020
IGG019GZ CSECT                                                          00180020
*                                                                       00360020
*          RELEASE OS/VS2-02 DELETIONS/CHANGES                   Y02072 00540002
*                                                               YM01347 00542002
*        OS/VS2 RELEASE 3 CHANGES                                       00544002
*  A427100                                                      ZA01385 00546002
* A734100-734320,C751500                                        ZA00956 00548002
*          CHANGES SINCE VS2-037                                      * 00550037
*D871200,C871400-871600                                        @ZA19113 00590037
*A096600-096900,A883600-883610                                 @ZA26522 00610037
*          RELEASE 21 DELETIONS/CHANGES                                 00630020
*1244117900,141300,182700,203400,442800,590400,696600,730800,    A41652 00631021
*1244772200,784800,791100,823500,827100                          A41652 00632021
*1244491400,495000-495900                                        A42240 00635021
*1244273600                                                      A43886 00640021
*1244602100                                                      S21045 00650021
*1244868500,872100                                               A33533 00670021
*1244                                                            M1792  00680021
*XXXX202800                                                      A48664 00690000
*1244413100                                                      A50698 00700000
*1244196200                                                      A51488 00710000
*A115800,116600-116900,177800-178000,441500-441700,             YM3399  00714000
*A589100-589300,865120,865300                                   YM3399  00716000
*A149900,150800,153900,180500-180600,182700,197100-197300,       A53751 00718002
*A197600-197800,200720,203500                                    A53751 00718402
*A203200                                                         A57232 00718802
*          RELEASE 20 DELETIONS                                       * 00720020
*0713192600-194400,201600-202500                                 M6132  00760020
*0713032200,150000,191800,192000,192200,192400,192600,192800,    A35340 00810020
*0713193000,193200,193400,193600,193800,194000,194200,194400,    A35340 00900020
*0713194600,194800,195000,195200,195400,195600,195800,196000,    A35340 00990020
*0713196040,196080,196120,196160                                 A35340 01080020
*0713025400-025600                                               A35818 01170020
*0713                                                            M0702  01260020
*                                                                S20201 01290020
*                                                                       01320020
* THIS MODULE WAS REWRITTEN IN RELEASE 20.2 TO                          01350020
* UTILIZE CHANNEL PROGRAM AND WORK AREA                                 01440020
* MACRO EXPANSIONS                                                      01530020
*                                                                       01620020
*STATUS CHANGE LEVEL 011                                                01710002
*                                                                       01800020
* FUNCTION/OPERATION  ASYNCHRONOUS ROUTINE FOR BISAM WRITE KN           01890020
*        WITH    READ AND UPDATE WHEN WRITE VALIDITY CHECKING IS        01980020
*        NOT REQUESTED.                                                 02070020
*       WRITE KN                                                        02160020
*        CP14  IS INITIALIZED TO ADD A RECORD TO AN OVERFLOW CHAIN AND  02250020
*        SET THE INDICES AND LINK FIELDS RELATING TO THAT RECORD.       02340020
*        UPON COMPLETION OF THE LAST CP NEEDED TO ADD A RECORD TO THE   02430020
*        DATA SET, COMPLETION IS POSTED AND THE NEXT IOB AWAITING       02520020
*        THIS COMPLETION (IF ANY) IS SCHEDULED.  (R=U IF NO WRITE KN)   02610020
*       READ AND UPDATE                                                 02700020
*        UPON COMPLETION OF CP1 OR CP2, THE NEXT IOB AWAITING THE CP    02790020
*        (IF ANY) IS SCHEDULED AND, IF COMPLETION WAS SUCCESSFUL, CP4-  02880020
*        CP5 IS SCHEDULED FOR THE IOB FOR WHICH CP1 OR CP2 JUST         02970020
*        COMPLETED. IF UNSUCCESSFUL, COMPLETION IS POSTED.              03060020
*        UPON COMPLETION OF CP5, CP6 OR CP7, THE NEXT IOB AWAITING THE  03150020
*        CP (IF ANY) IS SCHEDULED AND COMPLETION IS POSTED FOR THIS IOB 03240020
*        IF NO MORE READ AND UPDATE REQUESTS ARE MADE, THE FIRST        03330020
*        WRITE KN MACRO (IN ANY) IS SCHEDULED.                          03420020
* ENTRY POINT' REL POS 0                                                03510020
* INPUT - N/A                                                           03600020
* OUTPUT - N/A                                                          03690020
* EXTERNAL ROUTINES                                                     03780020
*        CP1 OR CP2, CP4 AND CP5, AND CP7 ARE INITIALIZED AND CP4-CP5-  03870020
*        CP6 REMOVED FROM THE CP QUEUE IN SUB-ROUTINES WITHIN THE       03960020
*        PRIVILEGED MACRO-TIME ROUTINE.                                 04050020
*        THE FIRST CHANNEL PROGRAM NEEDED FOR A WRITE KN MACRO IS       04140020
*        SELECTED AND INITIALIZED BY A SUB-ROUTINE WITHIN THE           04230020
*        PRIVILEGED MACRO-TIME ROUTINE.                                 04320020
*        WHEN ALL WRITE KN MACROS ARE COMPLETE, THE PENDING READ AND    04410020
*        UPDATE MACROS ARE SCHEDULED OR ARE REPLACED ON THE UNSCHEDULED 04500020
*        QUEUE ACCORDING TO THE CHANNEL PROGRAM EACH AWAITS BY A SUB-   04590020
*        ROUTINE WITHIN THE PRIVILEGED MACRO-TIME ROUTINE.              04680020
*        ENTRY POINT NAMES ARE                                          04770020
*        DISCP45 - INITIALIZE CP4 AND CP5                               04860020
*        DISCP7  - INITIALIZE CP7                                       04950020
*        DISCPS  - INITIALIZE CP1 OR CP2                                05040020
*        DISCPWKN- INITIALIZE WKN CP                                    05130020
*        DISPRIV - SCHEDULE OR RE-QUEUE READ AND UPDATE CP'S            05220020
*        SEE THE DSECT LABELED IHADIS FOR THE RELATIVE ADDRESSES OF THE 05310020
*        ENTRY POINTS OF THESE ROUTINES.  THE POINTER TO THE PRIVILEGED 05400020
*        MACRO-TIME ROUTINE IS IN DEBDISAD (SEE DEB DSECT).             05490020
*                    THE DYNAMIC BUFFERING ROUTINE WHICH FREES A BUFFER 05580020
*        UPON COMPLETION OF A WRITE K MACRO IS ENTERED VIA 'BUFASYN'.   05670020
*        SEE THE DSECT LABELED IHABUF FOR THE RELATIVE ADDRESS OF THE   05760020
*        ENTRY POINT OF THIS ROUTINE.  THE POINTER TO THE DYNAMIC       05850020
*        BUFFERING MODULE IS IN DCBFREED (SEE DCB DSECT).               05940020
* EXITS' RETURN TO SUPERVISOR VIA REGISTER 14.                          06030020
* TABLES/WORK AREAS' DECB, DCB, IOB AND EXTENTION, DCB WA (DCW), DEB    06120020
*        SEE DSECTS AT END OF MODULE FOR FORMAT AND DESCRIPTIONS        06210020
* ATTRIBUTES' REENTRANT.  DISABLED UPON ENTRY AND EXIT.  ENABLED AT     06300020
*        VARIOUS POINTS WITHIN THE MODULE.                              06390020
* NOTES - NONE                                                          06480020
* GENERAL REGISTERS ARE USED AS FOLLOWS                                 06570020
R0       EQU   0                        WORK REGISTER                   06660020
R1       EQU   1                        12 STAR ON ENTRY, THEN IOB      06750020
R2       EQU   2                        DECB                            06840020
R3       EQU   3                        WKN USED FOR WORK REG OR DEB    06930020
*                                        R+U USED BASE REGISTER         07020020
R4       EQU   4                        DCB                             07110020
R5       EQU   5                        CHANNEL PROGRAMS                07200020
R6       EQU   6                        WORK REGISTER                   07290020
R7       EQU   7                        WORK REGISTER                   07380020
R8       EQU   8                        WORK REGISTER OR DCB WA         07470020
R9       EQU   9                        WORK REGISTER                   07560020
R10      EQU   10                       WORK REGISTER                   07650020
R11      EQU   11                       WORK REGISTER                   07740020
R12      EQU   12                       WORK REGISTER OR DISABLE RTN    07830020
R13      EQU   13                       WORK REGISTER                   07920020
R14      EQU   14                       RETURN ADDRESS                  08010020
R15      EQU   15                       BASE ON ENTRY                   08100020
*                                        R+U USES AS WORK REGISTER      08190020
K1       EQU   1                        CONSTANT                        08240002
K7       EQU   7                        CONSTANT                        08250002
         SPACE 2                                                        08280002
         USING RQE,R1                   RQE ADDRESSABILITY       Y02072 08330002
         USING IHADECB,2                                                08460020
         USING IHADEB,3                                                 08550020
         USING IHADCB,4                                                 08640020
         USING IHAWKNCP,5                                               08730020
         USING IHADCW,8                                                 08820020
         USING ASYNCH,R15                                               08910020
         SPACE 2                                                        08960002
ASYNCH   EQU   *                                                        09000020
         L     R3,RQEDEB                VALIDATED DEB ADDR       Y02072 09060002
         IC    R2,RQEPRT                CALLERS PROTECT KEY      Y02072 09070002
         LR    R9,R1                    SAVE RQE ADDRESS         Y02072 09072002
         DROP  R1                       END USING ON RQE         Y02072 09080002
         L     R0,SP230                 SIZE, SP OF SAVE AREA    Y02072 09082002
         SPACE 2                                                        09082402
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 09084002
         SPACE 2                                                        09084402
         LR    R5,R15                   SAVE BASE ADDR           Y02072 09086002
         GETMAIN  R,LV=(0)              GET SAVE AREA            Y02072 09088002
         LR    R15,R5                   RESTORE BASE ADDR        Y02072 09088402
         USING IGGSAVE,R1               SAVEAREA ADDRESSABILITY  Y02072 09088802
         XC    IGGSAVE(IGGSIZE),IGGSAVE  CLEAR CORE              Y02072 09089202
         ST    R14,IGGRETRN             SAVE RETURN ADDRESS      Y02072 09089602
         LR    R14,R1                   SAVE AREA ADDRESS        Y02072 09089702
         USING IGGSAVE,R14              SAVEAREA ADDRESSABILITY  Y02072 09089802
         USING IHAIOB,R1                IOB ADDRESSABILITY       Y02072 09089902
         ST    R3,IGGPDEB               VALIDATED DEB ADDR       Y02072 09119902
         STC   R2,IGGUKEY               USER PROTECT KEY         Y02072 09129902
*                                                                       09131902
         BAL   R11,GETLOCK              OBTAIN LOCAL LOCK, RTRN  Y02072 09139902
*                                       IN USER PROTECT KEY      Y02072 09149902
ASYLDB2A EQU   *                        INITIALIZE REGISTERS     Y02072 09150002
         USING RQE,R9                   RQE ADDRESSABILITY       Y02072 09160002
         L     R1,RQEIOB                R1   IOB ADDRESS         Y02072 09180002
         DROP  R9                       END USING ON RQE         Y02072 09230002
         L     R2,IOBECBAD              R2   DECB                       09270020
         L     R4,IOBDCBAD-1            R4   DCB                        09360020
         L     R5,IOBCCWAD              R5   CP                         09450020
         XC    DCBPUTX,DCBPUTX          CLEAR DECB SAVE AREA     A41652 09490021
         SR    R9,R9                    R9   ASYNCH CODE TIMES 4        09540020
         IC    R9,IOBASYN                                               09630020
         CH    R9,FOURTEEN              IS ASYN CODE GT 14?    @ZA26522 09660037
         BH    INVASYCD                 IF YES-GO PROGCHK      @ZA26522 09690037
         SLL   R9,2                                                     09720020
ASYLDC2  B     ASYTAB1(R9)                                              09810020
CONF8    DC    X'F8F8'                                                  10080020
ASYTAB1  B     ASYASB2                  CODE 0    COMPLETE CP4-5-6 OK   10170020
         B     ASYLDD3                        1   EXCP                  10260020
         B     ASYASB1                  CODE 2    COMPLETE CP7 OK       10350020
         B     ASYAUB2                  CODE 3    COMPLETE CP1 OR 2 OK  10440020
         B     ASYASE5A                 CODE 4    COMPLETE CP4-5-6 ERR  10530020
         B     ASYLDC2                        5   INVALID               10620020
         B     ASYASE5A                 CODE 6    COMPLETE CP7 ERR      10710020
         B     ASYAUB2                  CODE 7    COMPLETE CP1/2 ERR    10800020
         B     ASYLAB1                        8   END WRITE KN MACRO    10890020
         B     ASYL4B2                        9   CP14 PRIME REC BUMPED 10980020
         B     ASYL5B2                       10   CP14 ADD TRK AT END   11070020
         B     ASYL8B2                       11   CP14 ADD END, OVERFLO 11160020
         B     ASYL7B2                       12   CP14 MIDDLE VRFL CHN  11250020
         B     ASYL6B2                       13   CP14 AT BEG OF VRFLCH 11340020
         B     ASYL9B2                       14   CP14 NEW REPLACE DEL  11430020
         EJECT                                                          11520020
**********************************************************************  11534002
*   ROUTINE TO FREE IOB AREA.                                        *  11535002
*        LINKAGE          BAL   R13,FREEIOB           *              *  11537002
**********************************************************************  11537402
         SPACE 2                                                        11538002
FREEIOB  EQU   *                        *                               11538402
         USING ASYNCH,R3                ADDRESSABILITY                  11539000
         DROP  R15                      *                               11540000
         SPACE 2                                                        11540402
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 11541002
         SPACE 2                                                        11541402
         STM   R0,R15,IGGREGS           SAVE REGISTERS           Y02072 11543002
         L     R6,IGGPDEB               PROTECTED DEB ADDR       Y02072 11545002
         USING IHADEB,R6                DEB ADDRESSABILITY       Y02072 11547002
         LA    R0,SP250IOB              IOB LENGTH AND SUBPOOL   Y02072 11549002
         TM    DEBRPSID,RPS             DATA SET ON RPS DEVICE   Y02072 11549402
         BZ    NORPS                    NO - LENGTH CORRECT      Y02072 11549802
         AH    R0,RPSCCW                YES - ADD RPS LENGTH     Y02072 11549902
NORPS    L     R4,DEBTCBAD              TCB ADDR TO REG 4        Y02072 11551202
         DROP R6                        END USING ON DEB         Y02072 11551602
         USING PSA,R0                   LOW CORE ADDRESSABILITY  Y02072 11552002
         L     R7,PSAAOLD               ASCB ADDRESS             Y02072 11552402
         SPACE 2                                                        11552502
         MODESET  KEYADDR=KEY0,WORKREG=5   CHANGE TO KEY ZERO    Y02072 11552602
         SPACE 2                                                        11552702
         IC    R5,IGGUKEY               USER'S PROTECT KEY       Y02072 11553102
         LR    R6,R14                   SAVE SAVE AREA ADDR      Y02072 11553502
         DROP  R3,R14                   END USINGS-SAVEAREA,MOD  Y02072 11553602
         LR    R10,R3                   BASE ADDRESS             Y02072 11553702
         USING ASYNCH,R10               MODULE ADDRESSABILITY    Y02072 11553802
*                                                                       11554002
         FREEMAIN  RU,LV=(0),A=(1),SP=SP250,KEY=(R5),BRANCH=YES  Y02072 11554402
*                                                                       11554502
         USING IGGSAVE,R6               SAVEAREA ADDRESSABILITY  Y02072 11554602
         SPACE 2                                                        11554802
         MODESET  KEYADDR=IGGUKEY,WORKREG=4  CHANGE TO USER KEY  Y02072 11555202
         SPACE 2                                                        11555302
         LM    R0,R15,IGGREGS           RESTORE REGISTERS        Y02072 11555402
         DROP  R6,R10                   END SAVEAREA - MOD USING Y02072 11555502
         USING ASYNCH,R3                MODULE ADDRESSABILITY    Y02072 11558302
         USING IGGSAVE,R14              SAVEAREA ADDRESSABILITY  Y02072 11562402
         BR    R13                      RETURN                          11565202
         SPACE 5                                                        11568002
SETDISAD EQU   *                        *                               11570802
*                                                                       11573602
*   ROUTINE TO GET POINTER TO PRIVELEGED MACRO TIME ROUTINE.            11576402
*        LINKAGE        BAL   R13,SETDISAD                              11579202
*                                                                       11582002
         L     R12,IGGPDEB              PROTECTED DEB ADDR       Y02072 11584802
         USING IHADEB,R12               ADDRESSABILITY ON DEB    Y02072 11587602
         L     R12,DEBEXPTR             ISAM DEPENDANT SECTION DEB      11590402
         USING DEBEXT,R12               ADDRESSABILITY                  11593202
         L     R12,DEBDISAD             A(PRIVELEGED MACRO TIME)        11596002
         BR    R13                      RETURN                          11598802
         USING ASYNCH,R15               ADDRESSABILITY                  11601602
         SPACE 5                                                        11604402
ASYLDD3  EQU   *                                                        11607202
*              EXECUTE CHANNEL PROGRAM                                  11610020
         LR    R3,R15                   SET BASE FOR SUBROUT1   YM3399  11670000
         BAL   R13,SUBROUT1                                             11700000
         B     ASYFINIS                 RETURN VIA EXIT          A41652 11790021
         EJECT                                                          11880020
*********************************************************************** 11970020
*********   WRITE KN                                         ********** 12060020
*********************************************************************** 12150020
         SPACE                                                          12210002
         USING IHADCW,R8                                                12240020
         USING IHAWKNCP,R5                                              12330020
*              CHART LA                  COMPLETION OF W KN, CODE 8     12420020
         SPACE                                                          12470002
ASYLAB1  LR    R9,R15                   SAVE BASE REG                   12510020
         USING ASYNCH,R9                                         S20201 12600020
         DROP  R15                                               S20201 12690020
         LA    R7,4                                               P4700 12780020
         B     ASYASE5B                 TEST FOR ERROR ROUTINE    P4700 12870020
         DROP  R3                                                S20201 12960020
ASYASE60 EQU   *                        *                               12980000
         BAL   R13,FREEIOB              FREE THE IOB                    13000000
ASYASE61 EQU   *                                                 A41652 14100021
         ST    R2,DCBPUTX               DECB TO BE POSTED        A41652 14160021
         LR    R15,R9                   RESTORE BASE REG                14220020
         USING ASYNCH,R15                                        S20201 14310020
         DROP  R9                                                S20201 14400020
         L     R3,IGGPDEB               PROTECTED DEB ADDR       Y02072 14410002
         LR    R12,R3                   DEB POINTER                     14440000
         LR    R15,R9                   BASE ADDRESSABILITY             14450000
         USING IHADEB,R3                                         S20201 14670020
         L    R8,DCBWKPT2                                               14760020
         CLI   DCWNUWKN,X'00'            AND IF   MORE IOBS FOR W KN,   14850020
         BNE   ASYAWF2                   BRANCH TO FIND NEXT            14940020
         BAL   R6,ASYLAE4Q              POST FIELD AREA         SA53751 14990002
*                                                                       15000002
         NI    DCWWKNI,X'7F'            OTHERWISE, SET W KN NOT IN PROC 15090000
ASYLAE3  L     R1,DCWFIOBU              R1   NEXT IOB ON QUEUE          15120020
         USING IHAIOB,R1                                         S20201 15210020
ASYLAE1  LTR   R1,R1                                                    15300020
         BE    ASYFINIS                 RETURN IF NONE          SA53751 15390002
         TM    IOBUNSQR,X'08'           IF REASON ON Q NOT W KN GOING   15480020
         BO    ASYLAF1                   ON OR WAITING, GET NEXT IOB    15570020
         L     R1,IOBFCHAD               AND BRANCH BACK                15660020
         B     ASYLAE1                                                  15750020
ASYLAF1  L     R6,IOBBCHAD              IF REASON ON Q IS W KN GOING ON 15840020
         LTR   R6,R6                     OR WAITING, REMOVE IOB FROM Q, 15930020
         BZ    ASYLAF11                                                 16020020
         MVC   IOBFCHAD-IHAIOB(4,R6),IOBFCHAD                           16110020
         B     ASYLAF12                                                 16200020
ASYLAF11 MVC   DCWFIOBU,IOBFCHAD                                        16290020
ASYLAF12 L     R6,IOBFCHAD                                              16380020
         LTR   R6,R6                                                    16470020
         BZ    ASYLAF13                                                 16560020
         MVC   IOBBCHAD-IHAIOB(4,R6),IOBBCHAD                           16650020
         B     ASYLAF2                                                  16740020
ASYLAF13 MVC   DCWLIOBU,IOBBCHAD                                        16830020
ASYLAF2  L     R2,IOBECBAD              R2  ADDR OF DECB FOR NEW IOB    16920020
         L     R12,DEBEXPTR             EXTENSION ADDRESS        S21045 16950021
         USING DEBEXT,R12                                        S21045 16980021
         L     R12,DEBDISAD             GET ADDRESS OF ROUTINE TO SET   17010020
         USING IHADIS,R12                 UP CP1,CP2,CP4-5-6, OR CP7    17100020
         BAL   R13,DISPRIV               BRANCH TO THE ROUTINE          17190020
         TM    DECBEXC1,X'80'            IF RECORD FOUND                17280020
         BO    ASYLAE3                                                  17370020
         TM    IOBINDCT,X'40'             AND IOB SCHEDULED             17460020
         BO    ASYLAE3                                                  17550020
         OI    IOBINDCT,X'40'           LEAVE IOB UNSCHED SO THAT 24981 17640020
*                                       NON-PRIV M-TIME MODULE          17690002
*                                       WON'T ISSUE AN EXCP ALSO.       17730002
         LR    R3,R15                   SET BASE FOR SUBROUT1   YM3399  17790000
         BAL   R13,SUBROUT1                                             17820020
         LR    R3,R6                    RESET DEB ADDRESS       YM3399  17880000
         B     ASYLAE3                   BRANCH BACK FOR NEXT IOB       17910020
ASYLAE4  EQU   *                                                 A35340 18000020
         LA    R6,ASYFINIS              RETURN VECTOR           SA53751 18050002
ASYLAE4Q EQU   *                        *                       SA53751 18060002
         L     R3,IGGPDEB               VALIDATED DEB ADDR       Y02072 18360002
         L     R8,DEBEXPTR              DEB EXTENSION ADDR       Y02072 18410002
         USING DEBEXT,R8                EXTENSION ADDR           Y02072 18460002
         TM    DEBDCBFA,SHR             TEST IF SHARED DATA SET  Y02072 18470002
         BZ    ENDMERGE                 IF NOT GO TO EXIT        Y02072 18480002
         L     R8,DEBDCBFA              FIELD AREA ADDR          Y02072 18510002
         USING DCBFA,R8                 DCBFA ADDRESSABILITY     Y02072 18560002
         SPACE 2                                                        18570002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 18610002
         SPACE 2                                                        18620002
         STM   R0,R15,IGGREGS           SAVE REGISTERS           Y02072 18660002
         LR    R9,R15                   SAVE BASE ADDR           Y02072 18710002
         DROP  R14                      END USING ON SAVE AREA          18720002
         LR    R3,R14                   SAVE SAVE AREA ADDR      Y02072 18760002
         SPACE 2                                                        18770002
         MODESET  KEYADDR=KEY0,WORKREG=11   CHANGE TO KEY ZERO   Y02072 18810002
         SPACE 2                                                        18820002
**********************************************************************  18830002
*        OBTAIN CMS LOCK.  FREED AT CMS1.                            *  18860002
**********************************************************************  18870002
         SPACE 2                                                        18880002
GCMS1    SETLOCK  OBTAIN,TYPE=CMS,MODE=UNCOND,   CROSS MEMORY    Y02072*18910002
               RELATED=(DCBFA,IGG019GW(FLCL1))   SERVICE LOCK    Y02072 18960002
         SPACE 2                                                        19010002
         LR    R15,R9                   RESTORE BASE ADDR        Y02072 19060002
         USING IGGSAVE,R3               SAVEAREA ADDRESSABILITY  Y02072 19110002
         SPACE 2                                                        19120002
         MODESET  KEYADDR=IGGUKEY,WORKREG=2  CHANGE TO USER KEY  Y02072 19160002
         SPACE 2                                                        19170002
         L     R2,DCBRORG3              NO. OVRFLOW RCD ACCESS   Y02072 19210002
         SPACE 2                                                        19220002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 19260002
         SPACE 2                                                        19270002
         ST    R2,DFARORG3              DCBRORG3 TO DFARORG3     Y02072 19310002
         SPACE 2                                                        19320002
         MODESET  KEYADDR=IGGUKEY,WORKREG=2  CHANGE TO USER KEY  Y02072 19360002
         SPACE 2                                                        19410002
         L     R2,DCBPUTX               DECB ADDRESSABILITY     SA53751 19720002
         USING IHADECB,R2               *                       SA53751 19730002
         SPACE 2                                                        19732002
**********************************************************************  19734002
*   MERGE ALL FIELDS INTO THE FIELD AREA IF IT IS A WRITE KN ONLY.   *  19740002
**********************************************************************  19750002
         SPACE 2                                                        19752002
         TM    DECBTYP2,DECBWKN         IS IT A WRITE KN        SA53751 19760002
         BZ    MERGDONE                 NO - READ MERGE DONE    SA53751 19770002
         IC    R11,DCBST                DCB STATUS IND           Y02072 19780002
         LH    R5,DCBRORG1              NO. FULL CYL OVRFLOW     Y02072 19830002
         SLL   R5,16                    SHIFT TO HIGH ORDER POS  Y02072 19880002
         LH    R7,DCBRORG2              TRKS LEFT IND OVRFLOW    Y02072 19930002
         OR    R5,R7                    RORG1 AND RORG2 TO R5    Y02072 19980002
         LH    R7,DCBNBOV               VLR UNUSED BYTES ON TRK  Y02072 20030002
         SLL   R7,16                    SHIFT TO HIGH ORDER POS  Y02072 20080002
         LH    R9,DCBNOREC              NO. OVRFLOW RCDS         Y02072 20130002
         OR    R7,R9                    NBOV AND NOREC TO R7     Y02072 20180002
         LM    R0,R1,DCBLPDA            LAST PRIME DATA ADDR     Y02072 20230002
         LM    R9,R10,DCBLIOV           LAST IND OVRFLOW ADDR    Y02072 20280002
         L     R13,DCBNREC              NO. PRIME DATA RECORDS   Y02072 20280402
         SPACE 2                                                        20282002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 20290002
         SPACE 2                                                        20292002
*        STORE FIELDS IN FIELD AREA                              Y02072 20300002
         SPACE 1                                                        20302002
         STC   R11,DFAST                DCB STATUS IND           Y02072 20310002
         ST    R5,DFARORG1              DCBRORG1 AND DCBRORG2    Y02072 20312002
         ST    R7,DFANBOV               DCBNBOV AND DCBNOREC     Y02072 20314002
         STM   R0,R1,DFALPDA            DCBLPDA                  Y02072 20316002
         STM   R9,R10,DFALIOV           DCBLIOV                  Y02072 20318002
         ST    R13,DFANREC              DCBNREC                  Y02072 20318102
MERGDONE EQU   *                        MERGE FINISHED           Y02072 20318402
         SPACE 2                                                        20318502
         MODESET  KEYADDR=KEY0,WORKREG=9   CHANGE TO KEY ZERO    Y02072 20318802
         SPACE 2                                                        20318902
         LR    R9,R15                   SAVE BASE                Y02072 20319202
         SPACE 2                                                        20321702
**********************************************************************  20324902
*        FREE CMS LOCK, WAS OBTAINED AT GCMS1.                   Y02072 20327402
**********************************************************************  20329402
         SPACE 2                                                        20329802
FCMS1    SETLOCK  RELEASE,TYPE=CMS,     FREE CROSS MEMORY SRVCS  Y02072*20329902
               RELATED=(DCBFA,IGG019GZ(GCMS1))  LOCK             Y02072 20332402
         SPACE 2                                                        20334402
         LR    R15,R9                   RESTORE BASE ADDR        Y02072 20334902
         SPACE 2                                                        20339902
         MODESET  KEYADDR=IGGUKEY,WORKREG=9  CHANGE TO USER KEY  Y02072 20343202
         SPACE 2                                                        20343602
         LM    R0,R15,IGGREGS           RESTORE REGISTERS        Y02072 20345202
         DROP  R3                       END USING ON SAVE AREA   Y02072 20345602
         USING IGGSAVE,R14              SAVEAREA ADDRESSABILITY  Y02072 20346002
ENDMERGE L     R8,DCBWKPT2              RESTORE WA PTR           A57232 20346702
         BR    R6                       RETURN VIA EXIT         SA53751 20350002
         EJECT                                                          20430020
         USING IHADCW,R8                                         A35340 20520020
         USING IHADEB,R3                DEB ADDRESSABILITY       Y02072 20570002
*              SUB-ROUTINE CHARTS L2-L3                                 20610020
*              USE 1 ENTRANCE                                           20700020
ASYL2A2  TM    IOBINDCT,X'20'                                           20790020
         BO    ASYL2B1                                                  20880020
         XC    DECBLOGR,DECBLOGR        RECORD IS IN DECB AREA          20970020
         TM    CH8E+4,X'80'            TEST IF UNBL,PRIME REC     17332 21060020
*                                       BUMPED                    17332 21150020
         BO    ASYL2C3                  BRANCH IF YES             17332 21240020
         L     R6,DECBAREA              R6   ADDRESS OF LINK (NOT ZERO) 21330020
         LA    R6,6(R6)                 R7   ADDRESS OF KEY             21420020
         TM    IOBINDCT,X'10'                                           21510020
         BO    ASYL2A4                                                  21600020
         L     R7,DECBKEY                                               21690020
         B     ASYL2C2                                                  21780020
ASYL2A4  L     R7,DCBMSWA                                               21870020
         LA    R7,8(0,R7)                                               21960020
         B     ASYL2C2                                                  22050020
ASYL2B1  L     R7,DCBMSWA                                               22140020
ASYL2B2  SR    R6,R6                                              17332 22230020
         IC    R6,DCBKEYLE                                              22320020
         AR    R6,R7                                                    22410020
         MVC   DECBLOGR,DCBMSWA                                         22500020
ASYL2C2  MVC   0(10,R6),CB25            LINK PER R6 FROM CB25           22590020
         B     ASYL2D2                                                  22680020
ASYL2C3  L     R7,CH6+4                KEY ADDR OF OVFL REC       17332 22770020
         B     ASYL2B2                                            17332 22860020
*              USE 2 ENTRANCE                                           22950020
ASYL2D1  SR    R6,R6                    R6   ZERO                       23040020
ASYL2D2  TM    DCBOPTCD,X'08'           DETERMINE WHICH OVERFLOW AREA   23130020
         MVI   CB53+4,X'00'             CLEAR EOF SW. IN CP10B    13270 23220020
         BZ    ASYL2E3                   TO USE IF ANY AVAILABLE. TRY   23310020
         CLI   CB22+5,X'00'              CYLINDER AREA BEFORE INDEPEN-  23400020
         BNE   ASYL2H2                   DENT AREA.                     23490020
ASYL2E3  TM    DCBOPTCD,X'10'                                           23580020
         BZ    ASYL2E4                                                  23670020
         LH    R10,DCBRORG2             TEST INDEPENDENT AREA FULL.     23760020
         LTR   R10,R10                                                  23850020
         BNE   ASYL3C1                                                  23940020
ASYL2E4  OI    DECBEXC1,X'20'                                           24030020
         TM    IOBINDCT,X'20'           BRANCH IF THE RECORD FOR WHICH  24120020
         BO    ASYL2E5                   THERE IS NO SPACE IS IN W.     24210020
         TM    IOBINDCT,X'10'           RECORD IS IN DECB AREA.         24300020
         BZ    ASYL2E5                  BRANCH IF THE KEY IS IN DECBKEY 24390020
         SR    R11,R11                  IF NOT, MOVE IT FROM W TO THE   24480020
         IC    R11,DCBKEYLE              DECB KEY AREA.  THIS IS        24570020
         BCTR  R11,0                     NECESSARY SO THAT THE USER     24660020
         L     R6,DECBKEY                WILL KNOW WHERE TO FIND THE    24750020
         EX    R11,ASYL2E6               LOST KEY.                      24840020
ASYL2E5  EQU   *                                                        24930020
         B     ASYLAB1                  BRANCH TO POST COMPLETION       25110020
ASYL2E6  MVC   0(0,R6),0(R7)                                            25200020
ASYL3C1  LA    R11,4(R11)               INDEPENDENT OVERFLOW AREA.      25290020
         CLC   DCBLIOV+7(1),DCBHIIOV    LAST REC ON TRK          O19113 25380020
         BNE   ASYL3B2                  NO -- MBBCCHH ALL SET, BRANCH   25470020
         LA    R12,ASYL3B2              LOAD R12 FOR EXIT         13270 25560020
ASYL3C1A SR    R10,R10                                            13270 25650020
         IC    R10,DCBLIOV                                              25740020
         SLL   R10,4                                                    25830020
         AR    R10,R3                                                   25920020
         SR    R9,R9                    INITIALIZE R9 TO ZERO           26010020
         MVI   DCBLIOV+7,0              SET RECORD NO. TO ZERO          26100020
         CLC   DCBLIOV+6(1),DEBENDHH+1-IHADEB(R10) LAST TRACK OF CYL.   26190020
         BNE   ASYL3C3                  NO, GO INCREMENT TRACK NO.      26280020
         MVI   DCBLIOV+6,0              YES, SET TRACK NO. TO ZERO      26370020
         CLC   DCBLIOV+3(3),DEBENDCC-IHADEB(R10) LAST TRACK OF EXTENT   26460020
         BNE   ASYL3A3                  NO, GO TO INCREMENT CCH         26550020
         IC    R9,DCBLIOV               GO TO NEXT EXTENT               26640020
         LA    R9,1(0,R9)                M+1                            26730020
         STC   R9,DCBLIOV                                               26820020
         CLC   DCBLIOV(1),DEBNMEXT      RUN OUT OF DEB (WILL NOT OCCUR) 26910020
         BE    ASYL2E4                  YES, GO SET NO SPACE INDICATION 27000020
         MVC   DCBLIOV+1(6),DEBBINUM+16-IHADEB(R10) MOVE NEW BBCCHH     27090020
         BR    R12                      EXIT                      13270 27180020
*                                                                       27270020
ASYL3A3  EQU   *                        *                               27360002
         IC    R9,DCBLIOV+THREE        PICK UP C1 OF CC          S20201 27630020
         SLL   R9,8                    MAKE ROOM FOR C2          S20201 27720020
         IC    R9,DCBLIOV+FOUR         PICK UP C2 OF CC          S20201 27810020
         LA    R9,ONE(,R9)             BUMP CYL VALUE BY 1       S20201 27900020
         STC   R9,DCBLIOV+FOUR         RESTORE C2                S20201 27990020
         SRL   R9,8                    MOVE C1 OVER FOR STORE    S20201 28080020
         STC   R9,DCBLIOV+THREE        RESTORE C1                S20201 28170020
         BR    R12                     EXIT                      S20201 28260020
ASYL3C3  IC    R9,DCBLIOV+6             INCREMENT TRACK NUMBER          29880020
         LA    R9,1(R9)                                                 29970020
         STC   R9,DCBLIOV+6                                             30060020
         BR    R12                      EXIT                      13270 30150020
ASYL3B2  MVC   CH23(8),DCBLIOV          SET CH23 MBBCCHHR FROM DCBLIOV  30240020
         IC    R8,DCBLIOV+7             ADD 1 TO R IN DCBLIOV           30330020
         LA    R8,1(R8)                                                 30420020
         STC   R8,DCBLIOV+7                                             30510020
         CLC   DCBLIOV+7(1),DCBHIIOV    IF NEW ADDR LAST ON TRK, O19113 30600020
         BNE   ASYL3E2                   THIS REC FILLS AN OVERFLOW     30690020
         LH    R8,DCBRORG2               AREA. THEREFORE, SUBTRACT 1    30780020
         BCTR  R8,0                      FROM NUMBER OF AREAS.          30870020
         STH   R8,DCBRORG2                                              30960020
ASYL3E2  MVC   CH24(5),DCBLIOV+3        SET CCHHR IN CH24 FROM DCBLIOV  31050020
         CLC   DCBLIOV+7(1),DCBHIIOV    NEW ADDRESS LAST IN TRK  O19113 31140020
         BNE   ASYL3E2B                 BRANCH IF NO              13270 31230020
         SR    R8,R8                                              13270 31320020
         CH    R8,DCBRORG2              ANY IND OFL LEFT          13270 31410020
         BE    ASYL2E4                  BRANCH TO NO SPACE FND IF 13270 31500020
         BAL   R12,ASYL3C1A             GO SET EOF ADDRESS        13270 31590020
ASYL3E2B MVC   CB55(5),DCBLIOV+3        MOVE SEARCH ADDR TO CB55  13270 31680020
         MVI   CB53+4,X'20'            SET EOF SWITCH IN CP10B    13270 31770020
         IC    R12,DCBLIOV+7            R=R+1 FOR EOF             13270 31860020
         LA    R12,1(R12)                                         13270 31950020
         STC   R12,CB55+4                                         13270 32040020
         LTR   R6,R6                    TEST USE 2                      32130020
         BZ    ASYL2B5                  EXIT IF YES                     32220020
         CLC   CH23(1),IOBDADAD         M IOB = M IN CH23               32310020
         BE    ASYL3F4                                                  32400020
         MVI   CH14,X'07'               NO - SEEK BBCCHH IN CH14        32490020
         B     ASYL3F3                                                  32580020
ASYL3F4  MVI   CH14,X'0B'               YES - SEEK CCHH IN CH14         32670020
ASYL3F3  TM    CB26,X'08'               BRANCH IF NOT CHAINED, I.E. IF  32760020
         BZ    ASYL2K5                   NO OVERFLOW CHAIN ALREADY      32850020
         CLC   CB25(1),CH23             COMP CH23 TO CB25, SET P IN     32940020
         BNE   ASYL3K2                   LINK PER REG 6 ACCORDINGLY     33030020
         L     R8,DCBWKPT2              GET DCW WORK AREA ADDR     0699 33120020
         CLC   CB25+3(3),CH23+3         MCCH=, GO TO P = SEEK HH        33480020
         BE    ASYL2J3                   M =, SET P = SEEK CCHH         33660020
         MVI   9(R6),X'0B'               M NOT =, SET P = SEEK BBCCHH   33750020
         B     ASYL2J2                                                  33840020
ASYL3K2  MVI   9(R6),X'07'                                              33930020
         B     ASYL2J2                                                  34020020
ASYL2H2  MVC   CH23(6),IOBDADAD         CYL OFLOW AREA                  34110020
         CLC   DCBHIROV,CB22+2          SET CH23 MBBCC    FROM IOB      34200020
         BNE   ASYL2G2                  IF CB22 R INDICATES HI REC IN   34290020
         LH    R8,CB22                   OVERFLOW TRACK,                34380020
         LA    R8,1(R8)                     CB22      HH  OLD HH PLUS 1 34470020
         STH   R8,CB22                                  R ZERO          34560020
         MVI   CB22+2,X'00'                                             34650020
ASYL2G2  MVC   CH23+6(2),CB22+1         SET CH23 HR FROM CB22+1         34740020
         IC    R8,CB22+2                ADD 1 TO R IN CB22              34830020
         LA    R8,1(R8)                 IF RESULT INDICATES HI REC IN   34920020
         STC   R8,CB22+2                 OVERFLOW TRACK, SUBT 1 FROM    35010020
         CLC   DCBHIROV,CB22+2           T IN CB22 TO INDICATE ONE LESS 35100020
         BNE   ASYL2G4                   TRACK.  IF THIS RESULT IS ZERO 35190020
         IC    R8,CB22+5                 ADD ONE TO RORG1 TO INDICATE   35280020
         BCTR  R8,0                      ONE MORE FULL CYLINDER OVER-   35370020
         STC   R8,CB22+5                 FLOW AREA                      35460020
         CLI   CB22+5,X'00'                                             35550020
         BNE   ASYL2G4                                                  35640020
         LH    R8,DCBRORG1                                              35730020
         LA    R8,1(R8)                                                 35820020
         STH   R8,DCBRORG1                                              35910020
ASYL2G4  MVC   CH24(3),IOBDADAD+3       CH24 CCH FROM IOB               36000020
         MVC   CH24+3(2),CB22+1         HR FROM CB22+1                  36090020
         LA    R9,CH1                   SET IOB START PTR. TO CH1       36180020
         ST    R9,IOBSTART-1                                            36270020
         LA    R9,IOBDADAD+3            GET ADDR OF CCHHR         10230 36360020
         ST    R9,CH1                   SET UP SEARCH ADDR        10230 36450020
         MVI   CH1,X'31'                SET UP SEARCH OP CODE     10230 36540020
         LTR   R6,R6                    EXIT IF USE 2.                  36630020
         BZ    ASYL2B5                                                  36720020
         MVI   CH14,X'1B'               CH14 SET TO SEEK HH             36810020
         TM    CB26,X'08'               BRANCH IF CHAINED IN F OF CB26  36900020
         BO    ASYL2J3                                                  36990020
ASYL2K5  LA    R9,CH9                K5      NOT CHAINED - END          37080020
         ST    R9,CH4                                                   37170020
         MVI   CH4,X'08'                MOVE TIC COMMAND                37260020
         OI    CB26,X'08'               RESET F TO INDICATE CHAINED     37350020
         LR    R9,R7                    PLACE REG 7 IN ADDR OF CH12     37440020
         STH   R9,CH12+2                                                37530020
         SRL   R9,16                                                    37620020
         STC   R9,CH12+1                                                37710020
         B     ASYL2J1                  BRANCH                          37800020
ASYL2J3  MVI   9(R6),X'1B'              SET P IN LINK PER R6 TO SEEK HH 37890020
ASYL2J2  LA    R9,CH8D               J2                                 37980020
         ST    R9,CH4                                                   38070020
         MVI   CH4,X'08'                MOVE TIC COMMAND                38160020
ASYL2J1  MVC   CB25(3),CH23                                             38250020
         NI    CH18+4,X'BF'             SET CH18 CC OFF                 38340020
         MVC   CB25+3(5),CH24                                           38430020
         LR    R9,R6                    PLACE R6 IN ADDR CH18           38520020
         STH   R9,CH18+2                                                38610020
         SRL   R9,16                                                    38700020
         STC   R9,CH18+1                                                38790020
         LR    R9,R7                    PLACE R7 IN ADDR CH17           38880020
         STH   R9,CH17+2                                                38970020
         SRL   R9,16                                                    39060020
         STC   R9,CH17+1                                                39150020
ASYL2B5  LH    R9,DCBNOREC              ADD 1 TO NORECS                 39240020
         LA    R9,1(R9)                                                 39330020
         STH   R9,DCBNOREC                                              39420020
         BR    R11                      RETURN                          39510020
         EJECT                                                          39600020
*              CHART L4  ASYNCHRONOUS CODE 9                            39690020
ASYL4B2  BAL   R11,MYSUBRTN                                             39780020
         TM    CH8E+4,X'80'            TEST IF UNBL AND UWA       17332 39960020
         BZ    ASYL4D7                 IF NO-BRANCH               17332 40050020
         L     R11,CH6+4                                          17332 40140020
         LA    R6,2                                               17332 40230020
         SR    R11,R6                  SAVE 10 BYTES              17332 40320020
         ST    R11,CH6+4               FOR OVFL REC LINK FLD      17332 40410020
         L     R6,DECBAREA             USE  DECB AREA TO SAVE     17332 40500020
         MVC   0(10,R6),0(R11)         10  PRIOR  BYTES OF RECORD 17332 40590020
         IC    R6,DCBKEYLE                                        17332 40680020
         BCTR  R6,R0                                              17332 40770020
         EX    R6,APPSDAT              SAVE DATA                  17332 40860020
ASYL4D7  BAL   R11,ASYL2A2                                        17332 40950020
         B     ASYL4C4                  CYLINDER AREA RETURN. BRANCH.   41040020
         MVC   IOBDADAD+5(2),CB23       INDEPENDENT AREA.  HH FROM CB23 41130020
         NI    CH55,X'FF'-MT            MT OFF                   S20201 41220020
         LA    R6,CH55                  CHAN PROG START AT CH55  A50698 41310000
         ST    R6,IOBSTART-1                                            41400020
         B     ASYL4D5                  BRANCH                          41490020
ASYL4C4  LA    R6,CH5                   CYLINDER VRFLO AREA. SET CH4 TO 41580020
         ST    R6,CH4                                            S20201 41670020
         MVI   CH4,X'08'                                                41760020
         CLC   IOBDADAD+SIX(ONE),CB23+ONE  H(COCR) = H(TRK IX)   S20201 41850020
         BE    ASYL4C5                  YES, BR--NO HEAD SEEK    S20201 41940020
         LA    R6,CI5                   GET SEEK ADDRESS         S20201 42030020
         ST    R6,CH5                   AND PUT IN CH5           S20201 42120020
         MVI   CH5,SEEKHH               SET UP COMMAND CODE      S20201 42210020
         MVI   CH5+SEVEN,SIX            SET COUNT TO SIX         S20201 42300020
         MVC   CI5(TWO),IOBDADAD+ONE    SET BB                   S20201 42390020
         MVC   CI5+TWO(FOUR),CB22+SIX   SET UP CCHH              S20201 42480020
         B     ASYL4D5                  CONTINUE CP 14 SET UP    S20201 42570020
ASYL4C5  MVI   CH5,NOP                  CONVERT TO NO-OP         S20201 42660020
         MVI   CH5+K7,K1                SET COUNT TO ONE        ZA01385 42710002
ASYL4D5  OI    CH8D,X'80'            D5      MT ON                      42750020
         MVI   IOBAPP,12                APPENDAGE CODE 12               42840020
ASYL4D5A LA    R6,IOBDADAD+3                                            42930020
         STH   R6,CH1+2                                                 43020020
         SRL   R6,16                                                    43110020
         STC   R6,CH1+1                                                 43200020
ASYLD5B  TM    CH8E+4,X'40'             TEST IF USER WA           17332 43290020
         BZ    ASYL4D6                  IF NO-BRANCH              17332 43380020
         MVC   CH14,IOBDADAD           SAVE SEEK ADDR PART 2      17332 43470020
         MVC   CH21+4(3),IOBSTART      SAVE IOBSTART              17332 43560020
         LA    R9,CH15                  START CP14 TO             17332 43650020
         ST    R9,IOBSTART-1            WRITE OVERFLOW RECORD     17332 43740020
         MVC   IOBDADAD,CH23            SET IOBSEEK=OVERFLOW REC  17332 43830020
ASYL4D6  EQU   *                                                  17332 43920020
         MVC   CK9+7(1),IOBASYN         SAVE ASYN CODE            17332 44010020
         LR    R3,R15                   SET BASE FOR SUBROUT1   YM3399  44160000
         BAL   R13,SUBROUT1                                             44190020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 44280021
         EJECT                                                          44370020
*              CHART L5  ASYNCHRONOUS ROUTINE, CODE 10                  44460020
ASYL5B2  BAL   R11,MYSUBRTN                                             44550020
ASYL5C3  BAL   R11,ASYL2A2              SUB-ROUTINE CHARTS L2-L3, USE 1 44730020
         B     ASYL5D4                  CYLINDER AREA RETURN. BRANCH    44820020
         MVC   IOBDADAD+5(2),CB24+2     INDEPENDENT AREA.  HH FROM CB24 44910020
         NI    CH8D,X'7F'            F3      MT OFF                     45000020
         NI    CH95,X'FF'-MT            MT OFF                   S20201 45090020
         L     R9,CH4                G3      CP14 STARTS AT CH4 ADDRESS 45180020
         ST    R9,IOBSTART-1                                            45270020
         B     ASYL5F4                  BRANCH                          45360020
ASYL5D4  OI    CH8D,MT                  MT ON                    S20201 45450020
         OI    CH95,MT                  MT ON                    S20201 45540020
ASYL5F4  MVI   IOBAPP,12                APPENDAGE CODE IS 12            45630020
         B     ASYL4D5A                 GO TO EXCP RTN                  45720020
         EJECT                                                          45810020
*              CHART L6  ASYNCHRONOUS ROUTINE, CODE 13                  45900020
ASYL6B2  BAL   R11,MYSUBRTN                                             45990020
         MVC   CB24(5),CB22+6                                           46170020
         MVC   CB25(10),CB10+7                                          46260020
         B     ASYL5C3                                                  46350020
         SPACE 2                                                        46400002
MYSUBRTN OC    IOBDADAD+6(1),DCBFIRSH+3 TRACK MASK                      46440020
         XC    IOBDADAD+6(1),DCBFIRSH+3 REDUCE TO CYL BOUNDRY OR ZERO   46530020
         MVI   IOBDADAD+7,0                                             46620020
         BR    R11                                                      46710020
         EJECT                                                          47520020
*              CHART L7  ASYNCHRONOUS ROUTINE, CODE 12                  47610020
ASYL7B2  L     R6,DECBAREA              R6  ADDR OF AREA DECB POINTS TO 47700020
         L     R7,CJ10                  R7  ADDR PER CJ10               47790020
         MVC   6(10,R6),0(R7)           MOVE LINK FIELD FROM CJ10 AREA  47880020
         BAL   R11,MYSUBRTN                                             47970020
         BAL   R11,ASYL2D1              SUB-ROUTINE CHARTS L2-L3, USE 2 48150020
         B     ASYL7E3                  CYLINDER OVERFLOW AREA USED.    48240020
         MVC   IOBDADAD,CH23            INDEPENDENT OVERFLOW AREA.      48330020
         LA    R10,CH15                 SET UP IOB, MBBCCHHR FROM CH23  48420020
         ST    R10,IOBSTART-1                                           48510020
         MVC   0(3,R7),CH23            MOVE LIOV TO LINK OF PREV  13270 48600020
         MVC   3(5,R7),CH24            RECD FROM CP14             13270 48690020
         CLC   CH23(1),CJ11             TEST SAME MCC CJ23 AND CJ11     48780020
         BNE   ASYL7K4A                                                 48870020
         L     R8,DCBWKPT2              GET DCW WORK AREA ADDR     0699 48960020
         CLC   CH23+3(3),CJ11+3                                         49320020
         BNE   ASYL7K4A                 NO MEANS NOT SAME        A42240 49460021
         MVI   9(R7),X'1B'              SEEK HEAD OLD P BYTE     A42240 49510021
         B     ASYL7G3                  NEW P BYTE SET ALREADY   A42240 49560021
ASYL7K4A EQU   *                                                 A42240 49610021
         L     R6,DECBAREA                                              49680020
         CLC   CH23(1),6(R6)            SET P IN DECB AREA TO           49770020
         BNE   ASYL7K3                   SEEK BBCCHH IF DIFF DEVICE(M)  49860020
         L     R8,DCBWKPT2              GET DCW WORK AREA ADDR     0699 49950020
         CLC   CH23+3(3),9(R6)          SEEK CCHH IF SAME DEVICE        50310020
         BNE   ASYL7K4                                   DIFF CYL (MCC) 50490020
         MVI   15(R6),X'1B'              SEEK     HH IF SAME DEVICE     50580020
         B     ASYL7F4                                   AND CYL(MCC)   50670020
ASYL7K4  MVI   15(R6),X'0B'                                             50760020
         B     ASYL7F4                                                  50850020
ASYL7K3  MVI   15(R6),X'07'                                             50940020
ASYL7F4  L     R7,CJ10                  TEST SAME M CJ23 AND CJ11       51030020
         CLC   CH23(1),CJ11                                             51120020
         BE    ASYL7G5                                                  51210020
         MVI   CH19,X'07'               NOT SAME, P IN CH19 AND IN AREA 51300020
         MVI   9(R7),X'07'               PER CJ10 MUST BE SEEK BBCCHH   51390020
         B     ASYL7G2                                                  51480020
ASYL7G5  MVI   CH19,X'0B'               SAME, P IN CH19 AND IN AREA PER 51570020
         MVI   9(R7),X'0B'               CJ10 MUST BE SEEK CCHH         51660020
         B     ASYL7G2                                                  51750020
*                                       CYLINDER OVERFLOW AREA.         51840020
ASYL7E3  MVC   0(3,R7),CH23             SET MBB OF LINK FIELD PER CJ10  51930020
         MVC   3(5,R7),CH24             SET CCHHR OF LINK FLD PER CJ10  52020020
         LA    R10,CH14                 CH4  MUST TIC TO CH14           52110020
         ST    R10,CH4                                                  52200020
         MVI   CH4,X'08'                MOVE TIC COMMAND                52290020
ASYL7F3  MVI   CH14,X'1B'               CH14 MUST SEEK HH               52380020
ASYL7G3  MVI   CH19,X'1B'               CH19 MUST SEEK HH               52470020
ASYL7G2  OI    CH18+4,X'40'             CH18 CC FLAG ON                 52560020
         MVC   CH22+1(3),CJ10+1         ADRESS IN CH22, SAME AS CJ10    52650020
         L     R10,DECBAREA             ADDRESS CH18, DECB AREA + 6     52740020
         LA    R10,6(R10)                                               52830020
         STH   R10,CH18+2                                               52920020
         SRL   R10,16                                                   53010020
         STC   R10,CH18+1                                               53100020
         MVC   CH17+1(3),DECBKEY+1      CH18 ADDRESS DECB KEY           53190020
         MVI   IOBAPP,13                APPENDAGE CODE 13               53280020
         B     ASYLD5B                                            17332 53370020
APPSDAT  MVC   0(0,R11),10(R11)                                   17332 53460020
         EJECT                                                          53550020
*              CHART L8  ASYNCHRONOUS ROUTINE,CODE 11                   53640020
ASYL8B2  BAL   R11,MYSUBRTN                                             53730020
         MVC   CH12+1(3),DECBKEY+1      SET ADDR IN CH12 TO DECB KEY    53910020
         L     R6,DECBAREA              R6  ADDR OF DECB AREA           54000020
         L     R7,CJ10                  R7  ADDR AREA PER CJ10          54090020
         MVC   6(10,R6),0(R7)           MBBCCHHR IN AREA+6 FROM CJ10    54180020
         OI    8(R7),X'18'              F NOW = OFLO CHAINED, NOT END   54270020
         BAL   R11,ASYL2D1              SUB-ROUTINE CHARTS L2-L3, USE 2 54360020
         B     ASYL8D2                  CYLINDER OVERFLOW AREA          54450020
         MVC   IOBDADAD(3),DCBLPDA      INDEPENDENT AREA.               54540020
         MVC   IOBDADAD+3(5),CB24       SEEK-SRCH ADDR =LAST OFLO ENTRY 54630020
         MVC   0(3,R7),CH23            SET LINK TO LAST IND OFLO  13270 54720020
         MVC   3(5,R7),CH24            RECD FROM CP14             13270 54810020
         LA    R10,CH9                                                  54900020
         ST    R10,IOBSTART-1                                           54990020
         NI    CH95,X'FF'-MT            CH9 MT OFF               S20201 55080020
         CLC   DCBLPDA(1),CH23          M OF CH23 = LST PRM DATA        55170020
         BE    ASYL8G3                                                  55260020
         MVI   CH14,X'07'               NO - CH14 OP-CODE   SEEK BBCCHH 55350020
         B     ASYL8H4                                                  55440020
ASYL8G3  MVI   CH14,X'0B'               YES- CH14 OP-CODE   SEEK CCHH   55530020
ASYL8H4  CLC   CH23(1),CJ11             MCC CH23 AND CJ11               55620020
         BNE   ASYL7F4                                                  55710020
         L     R8,DCBWKPT2              GET DCW WORK AREA ADDR     0699 55800020
         CLC   CH23+3(3),CJ11+3         CCH  CH23 AND CH11              56160020
         BNE   ASYL7F4                  NO - BRANCH                     56340020
         L     R7,CJ10                                                  56430020
         MVI   9(R7),X'1B'              YES - LINK PER CJ10 P = SEEK HH 56520020
         B     ASYL7G3                         AND BRANCH               56610020
ASYL8D2  L     R7,CJ10                  CYLINDER VRFLO AREA.            56700020
         MVI   9(R7),X'1B'                                              56790020
         MVC   0(3,R7),CH23             LINK PER CJ10 P = SEEK HH       56880020
         MVC   3(5,R7),CH24                           MBB FROM CH23     56970020
         LA    R10,CH9                                CCHHR FROM CH24   57060020
         ST    R10,CH4                                                  57150020
         MVI   CH4,X'08'                MOVE TIC COMMAND                57240020
         OI    CH95,MT                  CH95 MT ON               S20201 57330020
         B     ASYL7F3                                                  57420020
         EJECT                                                          57510020
*              CHART L9  ASYNCHRONOUS CODE 14                           57600020
ASYL9B2  EQU   *                        ASYN CODE 14             Y02072 57650002
         LA    R10,CH20                 IOB START POINTS TO CH20        57780020
         ST    R10,IOBSTART-1                                           57870020
         L     R6,DECBAREA              LINK FIELD PER CJ10 MOVED TO    57960020
         L     R7,CJ10                   DECB AREA + 6                  58050020
         MVC   6(10,R6),0(R7)                                           58140020
         MVC   IOBDADAD,CJ11            RESTORE SEEK ADDRESS FROM CJ11  58230020
         LA    R10,6(0,R6)                   DECB AREA +6               58320020
         STH   R10,CH22+2                                               58410020
         SRL   R10,16                                                   58500020
         STC   R10,CH22+1                    PLACE AT CH22              58590020
         MVI   IOBAPP,13                APPENDAGE CODE 13               58680020
         MVC   CK9+7(1),IOBASYN         SAVE ASYN CODE           A27333 58770020
         LR    R3,R15                   SET BASE FOR SUBROUT1   YM3399  58920000
         BAL   R13,SUBROUT1                                             58950020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 59040021
         DROP  R15                                                      59130020
*                                                                       59220020
         EJECT                                                          59310020
*********************************************************************** 59400020
*********   READ AND UPDATE                                  ********** 59490020
*********************************************************************** 59580020
         USING ASYNCH,R3                                                59670020
*        CHART AS   ASYNCHRONOUS ROUTINES, CODES 0, 2, 4, AND 6         59760020
*              CODE 2                                                   59850020
ASYASB1  LR    R3,R15                   SET UP BASE REGISTER            59940020
         TM    DECBTYP1,X'01'           TEST DYNAMIC BUFFERING          60030020
         BZ    ASYASE5                  BRANCH IF NO                    60120020
         L     R15,IGGPDEB              PROTECTED DEB ADDR       Y02072 60122002
         USING IHADEB,R15               DEB ADDRESSABILITY       Y02072 60134002
         L     R15,DEBEXPTR             GET EXTENSION                   60138300
         USING IHAIOB,R1                                                60142300
*                                       ADDRESSABILITY           S21045 60200021
         USING DEBEXT,R15                                        S21045 60220021
         L     R15,DEBFREED             ADDRESS OF DYN BUF'ING   S21045 60240021
*                                       MODULE                   S21045 60260021
         USING IHABUF,R15                                               60300020
         BAL   R12,BUFASYN              BRANCH TO FREE BUFFER           60390020
         B     ASYASF5                  ON RETURN, BRANCH          8381 60480020
*              CODE 0                                                   60570020
ASYASB2  LR    R3,R15                   SET UP BASE REGISTER            60660020
         TM    DECBTYP2,X'E0'           TEST READ                       60750020
         BZ    ASYASB1                  BRANCH IF NO                    60840020
         L     R10,DECBAREA             R10 DEVELOP ADDRESS OF LOG REC  61020020
         LA    R10,16(R10)                                              61110020
         TM    DECBEXC1,X'02'           OVERFLOW OR UNBLOCKED{          61200020
         BO    ASYASC4                  BRANCH IF YES                   61290020
         TM    DCBRECFM,X'10'                                           61380020
         BZ    ASYASC4                                                  61470020
         LR    R7,R10                   SEARCH FOR CORRECT REC IN BLOCK 61560020
         AH    R7,DCBBLKSI              R7   COMPARAND FOR BXLE (EOB)   61650020
         BCTR  R7,0                                                     61740020
         LH    R6,DCBLRECL              R6   INCREMENT FOR BXLE (REC L) 61830020
         AH    R10,DCBRKP               R10 ADDRESS OF KEY IN REC       61920020
         IC    R11,DCBKEYLE             R11 KEY LENGTH FOR EXECUTE      62010020
         BCTR  R11,0                                                    62100020
         L     R8,DECBKEY               R8  ADDRESS OF KEY SOUGHT       62190020
ASYASE3  EX    R11,ASYASE2                                              62280020
         BE    ASYASF3                                                  62370020
         BH    ASYASE1                                                  62460020
         BXLE  R10,R6,ASYASE3                                           62550020
ASYASE1  OI    DECBEXC1,X'80'           NO FIND                         62640020
         B     ASYASE5                                                  62820020
ASYASE2  CLC   0(0,R10),0(R8)                                           62910020
ASYASF3  SH    R10,DCBRKP               FOUND - SUBT RKP TO GET REC AD  63000020
ASYASC4  ST    R10,DECBLOGR             STORE ADDR LOG REC IN DECB      63090020
         L     R8,DCBWKPT2                                              63270020
         USING IHADCW,R8                                                63360020
         TM    DECBTYP2,X'20'           TEST FOR READ KU         A26738 63450020
         BZ    ASYASC5                  IF NOT, SEE IF DYN BUFF  A26738 63540020
         LA    R13,DCWFUPDI             IF SO, PLACE IOB ON UPDATE Q    63630020
         BAL   R15,ASYONQ                                               63720020
         XC    IOBCCWAD(4),IOBCCWAD     CLEAR DYN BUFFER PTR      MC1F  63810020
         TM    DECBTYP1,X'01'           IS THERE ANY DYN BUFFER   MC1F  63900020
         BZ    ASYASF5                BRANCH TO POST COMPLETION   MC1F  63990020
         MVC   IOBCCWAD(4),DECBAREA      YES SAVE PTR             MC1F  64080020
         B     ASYASF5                   AND BRANCH TO POST COMPLETION  64170020
ASYASC5  TM    DECBTYP1,X'01'           DYNAMIC BUFFER           A26738 64260020
         BZ    ASYASE50                 NO, REDUCE NACT AND POST A26738 64350020
         SR    R7,R7                    ZERO INDEX REG           A26738 64440020
         B     ASYASE59                 KEEP IOB ON ERROR QUEUE  A26738 64530020
*                 CODE 4, CODE 6                                        64620020
ASYASE5  EQU   *                                                 A26738 64710020
ASYASE5A SR    R7,R7                    ZERO INDEX REG           A26738 64800020
ASYASE5B LR    R3,R15                   SET UP BASE REGISTER      P4700 64890020
ASYASE55 EQU   *                        TEST FOR ERRORS          S20201 64980020
         L     R8,DCBWKPT2              ADDRESS OF WORK AREA      P4700 65070020
         TM    DECBEXC1,X'FD'           TEST FOR ERRORS           P4700 65160020
         BZ    ASYASE6(R7)              NO ERRORS - ISSUE FREEMAINP4700 65250020
         OI    IOBUNSQR,X'04'           MARK IOB IN ERROR        A26738 65340020
ASYASE59 LA    R13,DCWFIOBE             PUT IOB ON ERROR QUEUE   A26738 65430020
         IC    R0,DCWFIOBE              GET NO OF SLOTS LEFT     A26738 65520020
         BAL   R15,ASYONQ                                        A26738 65610020
         XC    IOBCCWAD(4),IOBCCWAD     CLEAR DYN BUFFER PTR      MC1F  65700020
         TM    DECBTYP1,X'01'           IS THERE ANY DYN BUFFER   MC1F  65790020
         BZ    ASYASE5C                 NO, BRANCH               A26738 65880020
         MVC   IOBCCWAD(4),DECBAREA      YES SAVE PTR             MC1F  65970020
ASYASE5C BCTR  R0,0                     INDICATE ONE LESS SLOT   A26738 66060020
         STC   R0,DCWFIOBE                                       A26738 66150020
         CLI   DCWFIOBE,X'FF'                                    A26738 66240020
         BNE   ASYASE7(R7)              BR IF AMT NOT MINUS      A26738 66330020
*                                       TO RETAIN ALL IOBS              66420020
         MVI   DCWFIOBE,X'00'           STILL NO SPACE IN QUEUE  A26738 66510020
         L     R1,DCWFIOBE              ELSE, REMOVE FIRST IOB   A26738 66600020
         LR    R0,R2                    SAVE CURRENT DECB        A26738 66690020
         LA    R2,DCWFIOBE              POINT TO ERROR QUEUE     A26738 66780020
         LA    R13,4                    SEARCH FOR AN ERROR IOB  A26738 66870020
         BAL   R15,ASYOFFQA             REMOVE IOB               A26738 66960020
         LR    R2,R0                    RESTORE DECB REGISTER    A26738 67050020
         L     R13,IOBCCWAD             DOES THIS DEQUEUED IOB   A26738 67140020
         LTR   R13,R13                  HAVE A DYNAMIC BUFFER    A26738 67230020
         BZ    ASYASE6(R7)              NO, BR TO FREE OLD IOB   A26738 67320020
         L     R15,DCBBUFCB             OTHERWISE, FREE OLD BUFF A26738 67410020
         MVC   0(4,R13),BCBNAVB(R15)                             A26738 67500020
         ST    R13,BCBNAVB(R15)                                  A26738 67590020
         B     ASYASE6(R7)              NOW FREE OLD IOB         A26738 67680020
ASYASE7  B     ASYASF51                 OMIT FREEMAIN            A26738 67770020
         B     ASYASE61                 OMIT ISSUING OF FREEMAIN  P4700 67860020
         B     ASYASE71                 OMIT ISSUING OF FREEMAIN  P4700 67950020
ASYASE6  B     ASYASE50                 ISSUE FREEMAIN            P4700 68040020
         B     ASYASE60                 ISSUE FREEMAIN            P4700 68130020
         B     ASYASE70                 ISSUE FREEMAIN            P4700 68220020
ASYASE50 EQU   *                        *                               68240000
         BAL   R13,FREEIOB              FREE THE IOB                    68250000
ASYASF51 L     R8,DCBWKPT2        SUBSTRACT 1 FROM  NUMBER OF     7M216 69300020
         IC    R12,DCWNACT               MACRO EVENTS TO BE COMPLETED   69390020
         BCTR  R12,0                     BEFORE NEXT WRITE KN CAN BE    69480020
         STC   R12,DCWNACT               EXECUTED                       69570020
ASYASF5  EQU   *                                                 A41652 69630021
         ST    R2,DCBPUTX               DECB TO BE POSTED        A41652 69690021
         L     R8,DCBWKPT2                                              69750020
         BAL   R13,SETDISAD             R12=A(PRIV MACRO TIME)          69770000
         USING IHADIS,R12                                               70110020
         SRL   R9,1                     BRANCH BY ASYNCHRONOUS CODE     70200020
         B     ASYTAB2(R9)               TO RTN TO FREE CP4-5-6 OR CP7  70290020
ASYTAB2  B     ASYASH5                  CODE 0 OR 4, TO ASYASH5         70380020
         B     ASYASG2                  CODE 2 OR 6, TO ASYASG2         70470020
         B     ASYASH5                                                  70560020
ASYASG2  CLI   DCWNUCP7,X'00'           FREE CP7. ANY IOB AWAITING ONE{ 70650020
         BE    ASYASG3                  BRANCH IF NO                    70740020
         LA    R13,32                   FIND IOB AWAITING CP7 AND       70830020
         BAL   R15,ASYOFFQ               REMOVE IT FROM UNSCHED QUEUE   70920020
         USING IHAIOB,R1                                         S20201 71010020
ASYASJ2  IC    R6,DCWNUCP7              SUBTRACT ONE FROM NO. IOBS      71100020
         BCTR  R6,0                      AWAITING CP7                   71190020
         STC   R6,DCWNUCP7                                              71280020
         NI    IOBINDCT,X'7F'           CP7 ALREADY OUT OF Q            71460020
         BAL   R11,DISCP7               GO TO ROUTINE TO SET UP CP7     71550020
         B     ASYAVB2                  BRANCH TO EXCP                  71730020
ASYASG3  MVC   12(4,R5),DCWFCP7         NO IOB AWAITING CP7. ADD IT TO  71820020
         ST    R5,DCWFCP7                CP7 QUEUE                      71910020
         B     ASYAWB2                  BRANCH TO START PENDING WKN     72000020
ASYASH4  EQU   *                        *                       SA61539 72050002
         IC    R6,DCWNACT               DECREASE NUMBER OF      SA61539 72060002
         BCTR  R6,0                     NON-WRITE KEY NEW       SA61539 72070002
         STC   R6,DCWNACT               MACRO EVENTS            SA61539 72080002
ASYASH5  CLI   DCWNUCP4,X'00'           FREE CP4-5-6                    72090020
         BE    ASYASJ5                  IF NO IOB AWAITING IT, BRANCH   72180020
         LA    R13,64                   FIND IOB ASAITING CP4-5-6 AND   72270020
         BAL   R15,ASYOFFQ              REMOVE IT FROM UNSCHEDULED Q    72360020
ASYASJ4  IC    R6,DCWNUCP4              SUBT 1 FROM NO. OF IOBS         72450020
         BCTR  R6,0                      AWAITING CP4-5-6               72540020
         STC   R6,DCWNUCP4                                              72630020
         NI    IOBINDCT,X'7F'           INDICATE CP4-5-6 NOT ON Q       72720020
         BAL   R11,DISCP45              GO TO SET UP CP4-5-6            72810020
         B     ASYASH4                  ERROR RETURN            SA61539 72900002
ASYAVB2  BAL   R13,SUBROUT1                                             72990020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 73080021
ASYASJ5  MVC   12(4,R5),DCWFCP4         NO IOB AWAITING CP4-5-6, ADD IT 73170020
         ST    R5,DCWFCP4                TO AVAILABLE QUEUE             73260020
         B     ASYAWB2                  BRANCH TO START PENDING WKN     73350020
ASYAUB20 EQU   *                        *                               73400002
         IC    R6,DCWNACT               DECREASE NUMBER OF      ZA00956 73410002
         BCTR  R6,0                     NON-WRITE KEY NEW       ZA00956 73420002
         STC   R6,DCWNACT               MACRO EVENTS            ZA00956 73430002
         B     ASYAUB21                 *                       ZA00956 73432002
*        CHART AU   ASYNCHRONOUS ROUTINES, CODES 3 AND 7                73440020
ASYAUB2  LR    R3,R15                   SET UP BASE REGISTER            73530020
         LR    R9,R1                    SAVE ADDRESS OF IOB             73620020
         L     R8,DCBWKPT2              R8  ADDRESS OF WORK AREA        73710020
ASYAUB21 CLI   DCWNUCPS,X'00'           TEST CP1/2 QUEUE EMPTY          73800020
         BNE   ASYAUB3                                                  73890020
         OI    DCWHIAV,X'80'            YES - SET INDICATOR TO AVAILABL 73980020
         B     ASYAUF3                   AND BRANCH TO CONTINUE IOB     74070020
ASYAUB3  EQU   *                                                        74160020
         LA    R13,128                  FIND IOB AWAITING CP1 OR CP2 +  74250020
         BAL   R15,ASYOFFQ               REMOVE IT FROM UNSCHED QUEUE   74340020
         IC    R6,DCWNUCPS              DECREASE NO. OF IOBS AWAITING   74430020
         BCTR  R6,0                      CP1/2                          74520020
         STC   R6,DCWNUCPS                                              74610020
         BAL   R13,SETDISAD             R12=A(PRIV MACRO TIME)          74630000
         USING IHADIS,R12                                               74970020
         BAL   R11,DISCPS               BRANCH TO SET UP CP1/2          75060020
         B     ASYAUB20                 ERROR RETURN            ZA00956 75150002
         BAL   R13,SUBROUT1                                             75240020
ASYAUF3  LR    R1,R9                    RESTORE IOB ADDRESS             75330020
         L     R2,IOBECBAD              RESTORE DECB ADDRESS            75420020
         CLI   IOBASYN,X'03'            TEST ASYNCH CODE INDICATE ERROR 75510020
         BE    ASYAUD2                  BRANCH IF NO                    75600020
         LA    R7,8                                               P4700 75690020
         B     ASYASE55                 TEST FOR ERROR ROUTINE   S20201 75780020
ASYASE70 EQU   *                        *                               75800000
         BAL   R13,FREEIOB              FREE THE IOB                    75810000
ASYASE71 EQU   *                                                  7S029 76860020
         IC    R9,DCWNACT               DECREASE NO. OF NON-WRITE KN    76950020
         BCTR  R9,0                      MACRO EVENTS                   77040020
         STC   R9,DCWNACT                                               77130020
         ST    R2,DCBPUTX               DECB TO BE POSTED        A41652 77220021
         B     ASYAWB2                  BRANCH                          77310020
         USING IHAIOB,R1                                         S20201 77400020
ASYAUD2  L     R5,DCWFCP4               NO - CONTINUE                   77490020
         LTR   R5,R5                                                    77580020
         BZ    ASYAUD1                  CP4-5-6 AVAILABLE {             77670020
         OI    IOBINDCT,X'80'           YES - SET UP CP4-CP5            77760020
         BAL   R13,SETDISAD             R12=A(PRIV MACRO TIME)          77780000
         USING IHADIS,R12                                               78120020
         BAL   R11,DISCP45                                              78210020
         B     ASYERROR                 ERROR RETURN, BISAM BUG SA63253 78300002
         BAL   R13,SUBROUT1                                             78390020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 78480021
ASYAUD1  MVI   IOBUNSQR,X'40'           NO - CP4-5-6 NOT AVAILABLE      78570020
         IC    R6,DCWNUCP4              ADD IOB TO UNSCHED Q            78660020
         LA    R6,1(R6)                                                 78750020
         STC   R6,DCWNUCP4                                              78840020
         LA    R13,DCWFIOBU                                             78930020
         BAL   R15,ASYONQ                                               79020020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 79110021
*                                                                       79200020
ASYONQ   LA    R1,0(R1)                 ADD THE IOB WHICH IS            79290020
         L     R6,4(R13)                 POINTED TO BY R1               79380020
         ST    R6,IOBBCHAD               TO THE QUEUE WHOSE FIRST IOB   79470020
         LTR   R6,R6                     POINTER IS IN 0(R13) AND       79560020
         BZ    ASYONQA                   WHOSE LAST IOB POINTER IS IN   79650020
         ST    R1,IOBFCHAD-IHAIOB(R6)    4(R13)                         79740020
         B     ASYONQB                                                  79830020
ASYONQA  ST    R1,0(R13)                                                79920020
ASYONQB  XC    IOBFCHAD,IOBFCHAD                                        80010020
         ST    R1,4(R13)                                                80100020
         BR    R15                      RETURN VIA R15.                 80190020
ASYOFFQ  LA    R2,DCWFIOBU              POINT TO UNSCHED QUEUE   A26738 80280020
         L     R1,DCWFIOBU              FIND THE 1ST IOB ON THE  A26738 80370020
ASYOFFQA EX    R13,ASYOFFQF              UNSCHEDULED QUEUE FOR REASON   80460020
         BO    ASYOFFQB                  IN R13, PUT ITS ADDRESS IN R1, 80550020
         L     R1,IOBFCHAD               REMOVE IT FROM THE UNSCHEDULED 80640020
         B     ASYOFFQA                  QUEUE.                         80730020
ASYOFFQB L     R6,IOBBCHAD                                              80820020
         LTR   R6,R6                                                    80910020
         BZ    ASYOFFQC                                                 81000020
         MVC   IOBFCHAD-IHAIOB(4,R6),IOBFCHAD                           81090020
         B     ASYOFFQD                                                 81180020
ASYOFFQC MVC   1(3,R2),IOBFCHAD+1       UPDATE PTR TO 1ST IOB    A26738 81270020
ASYOFFQD L     R6,IOBFCHAD                                              81360020
         LTR   R6,R6                                                    81450020
         BZ    ASYOFFQE                                                 81540020
         MVC   IOBBCHAD-IHAIOB(4,R6),IOBBCHAD                           81630020
         B     ASYOFFQG                                                 81720020
ASYOFFQE MVC   5(3,R2),IOBBCHAD+1       UPDATE PTR TO LAST IOB   A26738 81810020
ASYOFFQG L     R2,IOBECBAD              SET ITS DECB POINTER IN R2      81900020
         BR    R15                      RETURN VIA R15                  81990020
ASYOFFQF TM    IOBUNSQR,X'00'                                           82080020
*              CHART AW   CODES 0, 2, 4 AND 6 CONTINUED                 82170020
ASYAWB2  CLI   DCWNACT,X'00'            IF ANOTHER CP IN PROCESS        82260020
         BNE   ASYFINIS                 RETURN VIA EXIT          A41652 82350021
         L     R1,DCWFIOBU               OR IF NO MORE IOBS ON Q        82440020
         LTR   R1,R1                                                    82530020
         BNE   ASYAWD2                                                  82620020
         B     ASYFINIS                 RETURN VIA EXIT          A41652 82710021
ASYAWD2  CLI   DCWNUWKN,X'00'           ERROR IN BISAM IF NUWKN ZERO    82800020
         LA    R6,ASYAWD2               ERROR ADDRESS           SA63253 82850002
         BE    ASYERROR                 BISAM ERROR ROUTINE     SA63253 82890002
         OI    DCWWKNI,X'80'            SET WKN INDICATOR TO IN PROCESS 82980020
*********************************************************************** 83070020
*********   BEGIN A WRITE KN MACRO AFTER COMPLETION OF              *** 83160020
*********     ALL READ AND UPDATE MACROS OR AFTER ANOTHER WRITE KN  *** 83250020
*********************************************************************** 83340020
*        BASE REGISTER IS STILL R3                                      83430020
ASYAWE2  TM    IOBUNSQR,X'10'           FIND FIRST IOB WITH AWAITING    83520020
         BO    ASYAWE21                  WRITE KN UNSCHEDULED REASON    83610020
         L     R1,IOBFCHAD                                              83700020
         B     ASYAWE2                                                  83790020
ASYAWE21 L     R6,IOBFCHAD               AND REMOVE IT FROM THE UNSCHED 83880020
         LTR   R6,R6                     QUEUE                          83970020
         BZ    ASYAWE22                                                 84060020
         MVC   IOBBCHAD-IHAIOB(4,R6),IOBBCHAD                           84150020
         B     ASYAWE23                                                 84240020
ASYAWE22 MVC   DCWLIOBU,IOBBCHAD                                        84330020
ASYAWE23 L     R6,IOBBCHAD                                              84420020
         LTR   R6,R6                                                    84510020
         BZ    ASYAWE24                                                 84600020
         MVC   IOBFCHAD-IHAIOB(4,R6),IOBFCHAD                           84690020
         B     ASYAWG2                                                  84780020
ASYAWE24 MVC   DCWFIOBU,IOBFCHAD                                        84870020
ASYAWG2  IC    R6,DCWNUWKN              DECREASE THE NUMBER OF IOBS     84960020
         BCTR  R6,0                      AWAITING W KN  CP              85050020
         STC   R6,DCWNUWKN                                              85140020
         L     R2,IOBECBAD              R2   ADDR OF DECB FOR NEW IOB   85230020
         BAL   R13,SETDISAD             R12=A(PRIV MACRO TIME)          85250000
         USING IHADIS,R12                 UP FIRST WKN CHANNEL PROGRAM  85590020
         BAL   R11,DISCPWKN              BRANCH TO THE ROUTINE          85680020
         BAL   R13,SUBROUT1                                             85770020
         LR    R15,R3                   RESTORE FORMER BASE      M0702  85860020
         B     ASYLAE4                  RETURN                   A35340 85950020
ASYAWF2  L     R1,DCWFIOBU              ENTRY FROM CHART LA             86040020
         LR    R3,R15                                                   86130020
         B     ASYAWE2                                                  86220020
         EJECT                                                          86270002
**********************************************************************  86280002
*    EXCP SUBROUTINE.                                                *  86290002
**********************************************************************  86300002
         SPACE 2                                                        86302002
SUBROUT1 SR    R7,R7                                              12705 86310020
         IC    R7,IOBDADAD              GET M OF CURRENT EXTENT   12705 86400020
         SLL   R7,4                     M X 16                    12705 86490020
         L     R6,IGGPDEB               PROTECTED DEB ADDR       Y02072 86500002
         LA    R7,32(R7,R6)             PLACE BB FROM THE CURRENT 12705 86670020
         MVC   IOBDADAD+1(2),4(R7)      EXTENT INTO THE DEB       12705 86760020
         MVC   IOBBCHAD+1(3),IOBECBAD+1 SAVE ECB                 A33533 86800021
         LA    R7,IOBCSW                IOS WILL ZERO OUT        A33533 86840021
         ST    R7,IOBECBAD              CSW INSTEAD OF ECB       A33533 86880021
         LR    R7,R15                                             12705 86940020
         LR    R4,R1                    SAVE IOB ADDRESS         M1792  86990021
         BALR  15,0                     ADDRESSABILITY - ENABLE  A48664 86992000
         USING *,15                                              A48664 86994000
         SPACE                                                          86994402
         BAL   R11,FREELOCK             FREE LOCAL LOCK          Y02072 86996002
         SPACE                                                          87006002
         EXCP  (1)                                                12705 87030020
         SPACE                                                          87032002
         BALR  15,0                     ADDRESSABILITY - DISABLE A48664 87040000
         USING *,15                                              A48664 87050000
         SPACE                                                          87052002
         BAL   R11,GETLOCK              OBTAIN LOCAL LOCK        Y02072 87060002
         SPACE                                                          87110002
         LR    R1,R4                    RESTORE IOB ADDRESS      M1792  87120037
         USING IHADEB,R6                ADDRESSABILITY ON DEB    M1792  87130037
         SLR   R4,R4                                           @ZA19113 87140037
         ICM   R4,7,DEBDCBAD+1          RESTORE DCB ADDRESS    @ZA19113 87150037
         LR    R15,R7                                          @ZA19113 87160037
         DROP  R6                                                M1792  87200021
         MVC   IOBECBAD+1(3),IOBBCHAD+1 RESTORE ECB              A33533 87210021
         BR    R13                                                      87300020
         EJECT                                                          87305021
*        THE FOLLOWING ROUTINE IS ENTERED ON A BISAM ERROR              87305402
*        CONDITION. IT SAVES REGISTERS AND RETURNS TO USER              87305802
*        WITH ERRORS SET IN DECB.                                       87306202
         SPACE 1                                                        87306602
ASYERROR EQU   *                        *                               87306702
         L     R8,DCBMSWA               ADDR OF AREA TO SAVE REGSA63253 87306802
         STM   R0,R15,0(R8)             SAVE REGISTERS          SA63253 87306902
         OI    DECBEXC1,X'FD'           SET ALL ERRORS          SA63253 87309402
         ST    R6,DCBGET                SAVE ERROR ADDRESS      SA63253 87311402
         SPACE 2                                                        87311802
**********************************************************************  87312502
*              THE FOLLOWING IS THE COMMON EXIT TO BE USED FOR       *  87315002
*              RETURNING TO THE SUPERVISOR AFTER POSTING             *  87317502
*              A COMPLETED REQUEST IF NECESSARY                      *  87320002
**********************************************************************  87322502
         SPACE 2                                                        87325002
ASYFINIS EQU   *                                                 A41652 87327502
         BALR  R12,R0                   ESTABLISH               YM01347 87330002
         USING *,R12                    ADDRESSABILITY          YM01347 87335002
         BAL   R11,FREELOCK             RELEASE LOCAL LOCK       Y02072 87337002
         IC    R2,IGGUKEY               USER PROTECT KEY         Y02072 87339002
         L     R0,SP230                 SIZE AND SUBPOOL         Y02072 87340002
         LR    R1,R14                   ADDR OF CORE TO FREE     Y02072 87342502
         L     R14,IGGRETRN             RETURN ADDRESS           Y02072 87345002
         SPACE 2                                                        87347502
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 87350002
         SPACE 2                                                        87352502
         FREEMAIN  R,LV=(0),A=(1)       FREE SAVE AREA CORE      Y02072 87355002
         SPACE 2                                                        87357502
         MODESET  KEYADDR=(2)           CHANGE TO USER KEY       Y02072 87360002
         SPACE 2                                                        87362502
         NC    DCBPUTX,DCBPUTX          DECB TO BE POSTED        A41652 87365002
         BZ    NOPOST                   NO - EXIT                A41652 87367502
         L     R2,DCBPUTX               GET SAVED DECB ADDR      A41652 87370002
         POST  DECBECB                  POST COMPLETION          A41652 87372502
**********************************************************************  87375002
*        DO NOT INSERT CODE BETWEEN POST AND RETURN                  *  87377502
**********************************************************************  87380002
NOPOST   EQU   *                                                 A41652 87382502
         RETURN ,                       RETURN TO SUPERVISOR     A41652 87385002
         EJECT                                                          87387502
**********************************************************************  87390002
*        SUBROUTINES TO OBTAIN OR RELEASE THE LOCAL LOCK.               87392502
**********************************************************************  87395002
         SPACE 2                                                        87435002
GETLOCK  MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 87485002
         SPACE 2                                                        87487002
         STM   R0,R15,IGGREGS           SAVE REGISTERS           Y02072 87495002
         LR    R9,R14                   SAVE SAVE AREA ADDR      Y02072 87505002
         DROP  R14                      END SAVE AREA USING      Y02072 87507002
         BALR  R3,R0                    ESTABLISH                Y02072 87515002
         USING *,R3                     .. ADDRESSABILITY        Y02072 87517002
         SPACE 2                                                        87517402
         MODESET  KEYADDR=KEY0,WORKREG=11  CHANGE TO KEY ZERO    Y02072 87519002
         SPACE 2                                                        87521002
**********************************************************************  87521402
*        OBTAIN THE LOCAL LOCK.  FREED AT FLCL1.                     *  87523002
**********************************************************************  87523102
         SPACE 2                                                        87523202
GLCL1    SETLOCK  OBTAIN,TYPE=LOCAL,MODE=UNCOND,  OBTAIN THE     Y02072*87523302
               RELATED=(IOB,IGG019GZ(FLCL1))      LOCAL LOCK     Y02072 87523402
         USING IGGSAVE,R9               SAVEAREA ADDRESSABILITY  Y02072 87531102
         SPACE 2                                                        87531502
         MODESET  KEYADDR=IGGUKEY,WORKREG=11 CHANGE TO USER KEY  Y02072 87533102
         SPACE 2                                                        87535102
         LM    R0,R15,IGGREGS           RESTORE REGISTERS        Y02072 87537102
         BR    R11                      RETURN                   Y02072 87537502
         DROP  R3,R9                    SAVEAREA, BASU USINGS    Y02072 87537902
         SPACE 3                                                        87538302
**********************************************************************  87538702
*        FREE LOCAL LOCK SUBROUTINE                                  *  87538802
**********************************************************************  87540802
         SPACE 2                                                        87546602
FREELOCK MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 87548602
         SPACE 2                                                        87549002
         USING IGGSAVE,R14              SAVEAREA ADDRESSABILITY  Y02072 87550602
         STM   R0,R15,IGGREGS           SAVE REGISTERS           Y02072 87552602
         LR    R9,R14                   SAVE SAVE AREA ADDR      Y02072 87553002
         DROP  R14                      END SAVE AREA USING      Y02072 87553102
         BALR  R3,R0                    ESTABLISH                Y02072 87553402
         USING *,R3                     .. ADDRESSABILITY        Y02072 87553802
         SPACE 2                                                        87553902
         MODESET  KEYADDR=KEY0,WORKREG=11 CHANGE TO KEY ZERO     Y02072 87554202
         SPACE 2                                                        87556202
**********************************************************************  87564202
*        RELEASE THE LOCAL LOCK.  OBTAINED AT GLCL1.                 *  87575402
**********************************************************************  87577402
         SPACE 2                                                        87585402
FLCL1    SETLOCK  RELEASE,TYPE=LOCAL,   RELEASE THE              Y02072*87595402
               RELATED=(IOB,IGG019GW(GLCL1))  LOCAL LOCK         Y02072 87595802
         USING IGGSAVE,R9               SAVEAREA ADDRESSABILITY  Y02072 87596202
         SPACE 2                                                        87596302
         MODESET  KEYADDR=IGGUKEY,WORKREG=11 CHANGE TO USER KEY  Y02072 87596602
         SPACE 2                                                        87598602
         LM    R0,R15,IGGREGS           RESTORE REGISTERS        Y02072 87603602
         BR    R11                      RETURN                   Y02072 87605602
         EJECT                                                          87607602
RPS      EQU   X'E0'                    RPS MASK-BIT 0=P,1=I,2=O S20201 87610802
ONE      EQU   1                        MISC OFFSET              S20201 87617802
TWO      EQU   2                        *                        S20201 87638902
THREE    EQU   3                        *                        S20201 87660020
FOUR     EQU   4                        *                        S20201 87750020
SIX      EQU   6                        BYTES FOR SEEK HH        S20201 87840020
SEVEN    EQU   7                        *                        S20201 87930020
RPSCCW   DC    H'16'                    LENGTH OF RPS CCW'S.     S20201 88020020
SHR      EQU   X'80'                    TEST FOR SHARED DATA SET Y02072 88070002
         DS    0F                                                S20201 88110020
SP250IOB EQU   56                       BASIC IOB=56 BYTES IN    Y02072 88200002
SP250    EQU   250                      SUBPOOL 250              Y02072 88290002
*                                                                       88292002
SP230    DC    AL1(230),AL3(IGGSIZE)    PROTECTED SAVE AREA      Y02072 88300002
KEY0     DC    X'00'                                             Y02072 88310002
INVASYCD DC    H'0'                PROG CHK FOR BAD ASYN CODE  @ZA26522 88360037
FOURTEEN DC    X'000E'             MAX VALUE FOR ASYN CODE     @ZA26522 88361037
*                                                                       88362037
MODID    DC    C'IGG019GZ'              MODULE NAME            @ZA26522 88363037
DATE     DC    CL8'&SYSDATE'            FIX DATE               @ZA26522 88364037
FIX      DC    C' OZ26522'              LATEST FIX             @ZA26522 88365037
PATCH    DC    XL((*-IGG019GZ)/20)'00'  ZEROED PATCH AREA        Y02072 88370002
*                                                                       88372002
BCBNAVB  EQU   8                        NEXT AVAIL DYN BUFF PTR  S20201 88380020
         SPACE 2                                                        88430002
IHABUF   DSECT                DYNAMIC BUFFERING VECTOR TABLE            88650020
BUFFREED DS    A                       FREEDBUF ENTRANCE                88740020
BUFSIO   DS    A                       APPENDAGE ENTRANCE               88830020
         DS    A                       APPENDAGE ENTRANCE        S20201 88920020
BUFASYN  DS    A                        ASYNCHRONOUS ENTRANCE    S20201 89010020
         SPACE 2                                                        89060002
IHADIS   DSECT                          DISABLED MOD VECTOR TBL  S20201 89100020
DISQHN   DS    A                        Q-HANDLER                S20201 89190020
DISCP45  DS    A                        SET UP  CP4 + CP5        S20201 89280020
DISCP7   DS    A                        SET UP CP7               S20201 89370020
DISCPS   DS    A                        SET UP CP1 OR CP2        S20201 89460020
DISCPWKN DS    A                        SET UP WRITE KN CP'S     S20201 89550020
DISPRIV  DS    A                        SCHEDULE RD AND UPD REQ  S20201 89640020
         SPACE 2                                                        89690002
IGGSAVE  IGGBISAV                                                Y02072 89700002
         EJECT                                                          89728002
IHAWKNCP IGGWKNCP                                                       89730020
         SPACE 2                                                        89780002
*              DATA EVENT CONTROL BLOCK                                 89820020
IHADECB  DSECT                                                          89910020
         DS    0F                                                       90000020
DECBECB  DS    CL4                      EVENT CONTROL BLOCK (ECB)       90090020
DECBTYP1 DS    BL1                      TYPE B6 - 1 IF LENGTH IS S      90180020
*                                            B7 - 1 IF AREA IS S        90270020
DECBTYP2 DS    BL1                           B0 - 1 IF READ K           90360020
*                                            B1 - 1 IF READ KX          90450020
*                                            B2 - 1 IF READ KU          90540020
*                                            B4 - 1 IF WRITE K          90630020
DECBWKN  EQU   X'04'                         B5 - 1 IF WRITE KN         90720000
DECBLGTH DS    CL2                      LENGTH OF BLOCK                 90810020
DECBDCBA DS    A                        POINTER TO DCB                  90900020
DECBAREA DS    A                        ADDRESS OF AREA                 90990020
DECBLOGR DS    A                        POINTER TO LOGICAL RECORD       91080020
DECBKEY  DS    A                        POINTER TO KEY                  91170020
DECBEXC1 DS    BL1                      EXCPTN CD B0-RECORD NOT FOUND   91260020
*                                                 B1-RECORD LGTH CHK    91350020
*                                                 B3-INVALID REQUEST    91440020
*                                                 B4-UNCORRECTABLE IO   91530020
*                                                 B5-UNREACHABLE BLOCK  91620020
*                                                 B6-OVERFLOW RECORD    91710020
*                                                 B7-DUPLICATE REC      91800020
DECBEXC2 DS    BL1                                B7-READ KU            91890020
         EJECT                                                          91940002
         DCBD  DSORG=(IS)                                               91980020
         EJECT                                                          92030002
IHAIOB   IGGIOBD                                                        92070020
         EJECT                                                          92120002
DCBFA    IGGDCBFA                                                       92160020
         EJECT                                                          92210002
IHADCW   IGGBISAM                                                       92250020
         EJECT                                                          92300002
IHADEB   IGGDEBD                                                        92340020
         EJECT                                                          92430020
CVTDEF   DSECT                                                          92520020
         CVT                                                            92610020
         IHAPSA                                                  Y02072 92690002
         SPACE 4                                                        92692002
RQE      IECDRQE                                                 Y02072 92694002
         END                                                            92700020
