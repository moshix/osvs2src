         TITLE 'IGG019HD - SETL K(D) OR SETL KC(D) MODULE'              00020002
IGG019HD CSECT                                                          00040000
*          RELEASE OS/VS2-02 DELETIONS                           Y02072 00042002
*  A050700                                                      ZA01384 00044000
*          RELEASE 21 DELETIONS                                       * 00052000
*                                                                S21045 00053021
*    046200-046600,047400-047600                                SA52459 00053400
*                                                                     * 00066002
*        RELEASE VS2030 PTF CHANGES                                     00071003
*A030500                                                       @ZA07593 00076003
*                                                                       00081003
*STATUS CHANGE LEVEL 009                                                00088002
*                                                                     * 00120000
*FUNCTION/OPERATION - THIS MODULE IS USED TO LOCATE THE RECORD AT     * 00140000
*   WHICH THE USER DESIRES TO BEGIN SEQUENTIAL RETRIEVAL OF HIS DATA  * 00160000
*   SET. THE USER SPECIFIES THE KEY OR KEYCLASS OF THE DESIRED RECORD.* 00180000
*   THE MODULE INITIALIZES WORK AREA FIELDS AND READS THE FIRST       * 00200000
*   RECORDS WHICH WILL BE MADE AVAILABLE TO THE USER BY SUBSEQUENT    * 00220000
*   GETS.  THIS MODULE SUPPORTS BOTH FIXED AND VARIABLE LENGTH          00230018
*   RECORD FORMATS.                                                     00240018
*                                                                     * 00260000
*ENTRY POINTS- 'IGG019HD' (SISCTSK) IS THE ENTRY POINT FOR AN ISAM    * 00280000
*   SETL K(D) OR SETL KC(D) MACRO. THE GENERATED CALLING SEQUENCE IS- * 00300000
*                                                                     * 00320000
*   SETL DCBNAME,K(D),KEY               SETL DCBNAME,KC(D),KEYCLASS   * 00340000
*   LA   1,DCBNAME                      LA   1,DCBNAME                * 00360000
*   LA   0,KEY                          LA   0,KEYCLASS               * 00380000
*   L    15,76(0,1)                     L    15,76(0,1)               * 00400000
*   BALR 14,15                          BALR 14,15                    * 00420000
*                                                                     * 00440000
*INPUT-  REGISTER  0-BYTE 1 = TYPE OF SETL (BIT 0 =1 IF K),           * 00460000
*                             (BIT 1=1 IF C),(BIT 4=1 IF D)           * 00480000
*                    BYTES 2-4 = KEY OR KEYCLASS ADDRESS              * 00500000
*        REGISTER  1-DCB ADDRESS                                      * 00520000
*        REGISTER 13-REGISTER SAVE AREA ADDRESS                       * 00540000
*        REGISTER 14-RETURN ADDRESS                                   * 00560000
*        REGISTER 15-ENTRY POINT                                      * 00580000
*                                                                     * 00600000
*OUTPUT- NORMAL EXIT, SAME AS FOR INPUT                                 00620000
*   ERROR EXIT, DCBEXCD1 BIT 3(ILLEGAL REQUEST) IS SET                * 00640000
*               DCBEXCD1 BIT 2(UNREACHABLE) IS SET                    * 00660000
*               DCBEXCD1 BIT 1(KEY NOT FOUND) IS SET                  * 00680000
*   REGISTER 15- USER'S SYNCHRONOUS ERROR EXIT ROUTINE ADDRESS        * 00700000
*                                                                     * 00720000
*EXTERNAL ROUTINES- 'IGG019HB' SUBROUTINES- 'SISCTSGE'(EINFO), TO       00740000
*   INFORM THE USER OF BAD WRITES ON A RECORD OF A PREVIOUS SCAN.     * 00760000
*   'SISCTSB'(SCHEDULE), TO SET UP AND INITIATE THE READING OF DATA   * 00780000
*   RECORDS BEGINNING AT THE USER SPECIFIED KEY. 'SISCTSD'(QUEUE), TO * 00800000
*   MOVE THE SPECIFIED NUMBER OF BUFFERS FROM ONE DESIGNATED QUEUE TO * 00820000
*   ANOTHER. 'SISCTBS' (SETLB) , TO INITIATE A SCAN AT THE BEGINNING  * 00840000
*   OF THE DATA SET IF A SETL B MACRO WAS SPECIFIED                   * 00860000
*   RATHER THAN A SETL K.                                             * 00880000
*                                                                     * 00900000
*EXITS- NORMAL-'SISSLK4', RETURNS CONTROL TO THE USER TO THE NEXT     * 00920000
*   SEQUENTIAL INSTRUCTION AFTER THE SETL K OR SETL KC MACRO          * 00940000
*   EXPANSION.                                                        * 00960000
*                                                                     * 00980000
*   ERROR-  'SISSKB1C'  IS THE EXIT TO THE USERS SYNCHRONOUS ERROR    * 01000000
*   ROUTINE. 'SISSKF1A' IS THE ABEND EXIT IF NO USER'S SYNCHRONOUS    * 01020000
*   ERROR ROUTINE WAS SPECIFIED.                                      * 01040000
*                                                                     * 01060000
*TABLES/WORKAREAS- DATA EXTENT BLOCK (DEB) DESCRIBED BY SISDEB DSECT, * 01080000
*   WORKAREA DESCRIBED BY SISWORK1 DSECT, DATA CONTROL BLOCK DESCRIBED* 01100000
*   BY IHADCB DSECT.                                                  * 01120000
*                                                                     * 01140000
*ATTRIBUTES - REENTRANT, READ ONLY.                                   * 01160000
*                                                                     * 01180000
*NOTES - REGISTER USAGE IS CONSISTANT IN ALL SCAN MODE MACRO TIME     * 01200000
*   MODULES.                                                            01220000
         EJECT                                                          01240000
         USING IHADCB,R1                                                01260000
         USING SISCP236,R4                                              01280000
         USING SISCP22,R3                                               01300000
         USING SISWORK1,R2                                              01320000
         USING *,R15                                                    01340000
R0       EQU   0                                                        01360000
R1       EQU   1                                                        01380000
R2       EQU   2                                                        01400000
R3       EQU   3                                                        01420000
R4       EQU   4                                                        01440000
R5       EQU   5                                                        01460000
R6       EQU   6                                                        01480000
R7       EQU   7                                                        01500000
R8       EQU   8                                                        01520000
R9       EQU   9                                                        01540000
R10      EQU   10                                                       01560000
R11      EQU   11                                                       01580000
R12      EQU   12                                                       01600000
R13      EQU   13                                                       01620000
R14      EQU   14                                                       01640000
R15      EQU   15                                                       01660000
DELETE   EQU   X'FF'                    DELETE MARK FOR RECS     S20201 01664020
K8       EQU   8                        CONSTANT                 S20201 01668020
K1       EQU   1                        CONSTANT                 S20201 01672020
L3       EQU   3                        LENGTH                   S20201 01676020
         SPACE 3                                                        01680000
SISCTSK  B     SISSKA2                                                  01700000
         SPACE                                                          01720000
*                                  ***** CONSTANTS *****                01740000
EMTYQCON DC    F'0'                                                     01760000
         SPACE 2                                                        01800000
* UPON ENTRY TO THE SETL MACRO, R0 CONTAINS THE TYPE OF SETL AND        01820000
* THE DESIRED KEY ADDRESS                                               01840000
         SPACE 2                                                        01860000
SISSKA2  STM   R14,R12,12(R13)          SAVE REGISTERS           M4902  01880019
         L     R2,DCBWKPT1         LOAD WORK AREA BASE                  01900000
         XC    DCBEXCD1(2),DCBEXCD1    ZERO EXCD1 AND EXCD2             01920000
         OI    W1OSBIT2,X'02'      SET ON RELEASE BIT                   01940000
         ST    R0,W1REGSAV         SAVE SETL TYPE AND KEY ADDRESS       01960000
SISSKA2A TM    W1REGSAV,X'80'      WHAT KIND OF A SETL WAS SPECIFIED    01980000
         BO    SISSKA2B                                          A35340 02000020
         TM    W1REGSAV,X'10'      WAS IT SETL B                        02020000
         BZ    SISSKB1             NO, GO TO SYNAD FOR INVALID TYPE     02040000
         LM    R2,R12,28(R13)      YES, RESTORE REG2-12                 02060000
         L     R15,DCBGET                                               02080000
         A     R15,GSETLB(R15)      GET SETL B MODULE                   02100000
         BR    R15                 GO TO SETL B MODULE                  02120000
         SPACE 2                                                        02140000
*              TEST IF LAST WRITES OF LAST SCAN WERE SUCCESSFULLY       02160000
*              COMPLETED                                                02180000
SISSKA2B EQU   *                                                 A35340 02182020
         TM    W1DCBFA,X'80'            TEST IF DISP=SHR         A35340 02184020
         BZ    CNTINU                   BR IF NOT TO CONTINUE    A35340 02186020
*                                       RTN                      A35340 02188020
         SVC   54                       IF SO, ISSUE SVC 54 TO   A35340 02190020
*                                       REFRESH                  A35340 02192020
*                                       DCB FIELDS                      02194020
CNTINU   EQU   *                                                 A35340 02196020
         SPACE 2                                                        02200000
SISSKA3  TM    W1ECBO,X'40'        ECBO COMP BIT ON                     02220000
         BZ    SISSKA4                  NO, WAIT                        02240000
SISSKB3  CLI   W1WRITEC+1,X'00'        YES, IS WRITE Q EMPTY            02260000
         BE    SISSKB2                  YES                             02280000
         B     SISSKB4                  NO                              02300000
SISSKA4  LR    R5,R1                                                    02320000
         LR    R6,R15                   SAVE R15 AND R1                 02340000
         WAIT  ECB=W1ECBO                                               02360000
         LR    R15,R6                                                   02380000
         LR    R1,R5                    RESTORE R15 AND R1              02400000
SISSKB4  TM    W1OSBIT2,X'80'           ANY WRITE Q ERRORS              02420000
         BZ    SISSKC5                  NO                              02440000
SISSKB5  L     R11,DCBGET               YES                             02460000
         A     R11,GEINFO(R11)          INFORM USER OF WRITE Q ERRORS   02480000
         BALR  R9,R11                                                   02500000
         B     SISSKB2                  BRANCHES WHEN ALL BUFFERS HAVE  02520000
*                                    BEEN MOVED TO FREE Q IN EINFO      02540000
         SPACE                                                          02560000
SISSKC5  LA    R3,W1FR1ST        MOVE WRITE Q BUFS TO FREE Q            02580000
         LA    R4,W1WR1ST                                               02600000
         NI    W1OSBIT1,X'FE'        SET OFF IOBO COMP BIT              02620000
         LH    R5,W1WRITEC                                              02640000
         L     R10,DCBGET               GET ADDRESS OF QUEUE ROUTINE    02660000
         A     R10,GQUEUE(R10)                                          02680000
         BALR  R9,R10                   BRANCH TO QUEUE                 02700000
         SPACE 2                                                        02720000
SISSKB2  L     R4,W1CP23PT                                              02740000
         TM    W1OSBIT1,X'80'      TEST SCAN MODE INDICATOR             02760000
         BZ    SISSKC3             OFF                                  02780000
*                                  IF ON NO ESETL GIVEN BETWEEN THIS    02800000
*                                  AND PREVIOUS SETL                    02820000
SISSKB1  OI    DCBEXCD1,X'10'      SET ON ILLEGAL REQUEST BIT           02840000
SISSKB1A TM    DCBSYNAD+3,X'01'        WAS A SYNAD ADDRESS SPECIFIED    02860000
         BO    SISSKF1             NO                                   02880000
SISSKB1B EQU   *                                                        02900000
         NI    W1OSBIT1,X'80'                                    A26332 02906019
         NI    W1OSBIT2,X'00'                                    A26332 02912019
         LH    R5,W1READC               COUNT ON READ Q.         A37178 02913020
         AH    R5,W1READR               = CNT + RESID            A37178 02914020
         STH   R5,W1READC               *                        A37178 02915020
         XC    W1READR,W1READR          RESID = 0                A37178 02916020
         LA    R3,W1FR1ST              CLEAR READ Q BUFFERS             02920000
         LA    R4,W1RD1ST              TO THE FREE Q                    02940000
         L     R10,DCBGET              GET ADDRESS OF                   02980000
         A     R10,GQUEUE(R10)         QUEUE ROUTINE                    03000000
         BALR  R9,R10                  BRANCH TO THE QUEUE ROUTINE      03020000
         MVI   W1READR+1,X'00'         CLEAR OUT RESIDUE                03040000
         LA    R0,W1IOBI            LOAD REG 0 WITH IOB ADD    @ZA07593 03050003
         L     R15,DCBSYNAD            GET USER'S SYNAD ADDR            03060000
         LM    R2,R12,28(R13)      RESTORE REGS. 2-12                   03080000
         L     R14,12(R13)              RESTORE REG 14           A34626 03090020
SISSKB1C BR    R15                 TAKE SYNAD EXIT                      03100000
*                                  NO SYNAD EXIT SPECIFIED              03120000
SISSKF1  LM    R2,R12,28(R13)                                           03140000
         ABEND X'031',DUMP,,SYSTEM      031 ABEND, NO SYNAD      Y02072 03180002
         SPACE 3                                                        03200000
SISSKC3  TM    W1REGSAV,X'40'      SETL KC                              03220000
         BO    SISSKC4             YES                                  03240000
         MVC   CS22+7(1),DCBKEYLE      RESET TO KEY LENGTH SINCE MACRO  03260000
         MVC   CS29+7(1),DCBKEYLE      WAS SETL K NOT KC                03280000
SISSKD2  TM    DCBRECFM,X'10'           ARE RECORDS BLOCKED             03300000
         BO    SISSKF4                  YES, INITIALIZE CP22B IN CASE   03320000
*                                       A PREVIOUS OPERATION HAS TAKEN  03340000
*                                       PLACE                           03360000
SISSKF3  TM    W1REGSAV,X'08'      WHAT TYPE OF SETL, D OR K-D          03380000
         BO    SISSKF4               DATA ONLY                          03400000
         SPACE 2                                                        03420000
*                        SETL OF KEY AND DATA TYPE HAS BEEN REQUESTED   03440000
*                        IF BUFFER SIZE IS LARGE ENOUGH TO ALLOW FOR    03460000
*                        THIS TYPE, OPEN SETS ON BIT 0 OF OSBIT3        03480000
         SPACE                                                          03500000
         TM    W1OSBIT3,X'80'           IS BUFFER LARGE ENOUGH          03520000
         BZ    SISSKB1                  NO                              03540000
*                                       YES                             03560000
         SPACE                                                          03580000
* IF UNBLOCKED KEY AND DATA RECORDS, ALL CHANNEL PROGRAMS ON THE FREE   03600000
* QUEUE ARE SET TO READ (CP22A MODE)                                    03620000
         SPACE                                                          03640000
         SPACE                                                          03660000
         L     R3,W1FR1ST               SET BASE OF CP22 DSECT          03680000
SISSKF2C L     R7,CN7+4                 BUFFER ADDRESS FOR KEY          03700000
         ST    R7,CN3                                                   03720000
         MVC   CN4+1(3),CN7+1      RE-INITIALIZE CN4              22835 03730018
         MVI   CN3,X'0E'                READ KEY-DATA OP CODE           03740000
         MVI   CN2+4,X'20'              SET ALL FLAGS OFF BUT KD        03760000
         CLC   CN5+1(3),EMTYQCON        ARE WE AT END OF Q              03780000
         BE    SISSKG3                  YES, ALL CP'S CHANGED           03800000
         L     R3,CN5                   GET NEXT CP IN CHAIN            03820000
         B     SISSKF2C                 LOOP                            03840000
         EJECT                                                          03860000
* IF UNBLOCKED RECORDS DATA ONLY SPECIFIED, ALL CHANNEL PROGRAMS ON     03880000
*  THE FREE Q ARE SET UP FOR THIS FORM (CP22B MODE).                    03900000
         SPACE 2                                                        03920000
SISSKF4  L     R3,W1FR1ST               GET CP1 OF FREE Q               03940000
SISSKF4A LA    R7,CN4                                                   03960000
         MVC   CN4+1(3),CN7+1          REINITIALIZE CN4                 03980000
         ST    R7,CN3                   SET CN3 TO CN4 ADDRESS          04000000
         MVI   CN3,X'08'                SET CN3 TO A TIC                04020000
         MVI   CN2+4,X'00'              SET OFF ALL FLAGS               04040000
         CLC   CN5+1(3),EMTYQCON        LAST CP IN CHAIN                04060000
         BE    SISSKG3                  YES                             04080000
         L     R3,CN5                   NO, GET NEXT CP                 04100000
         B     SISSKF4A                 LOOP                            04120000
         SPACE 3                                                        04140000
SISSKG3  L     R4,W1CP23PT         LOAD CP23 ADDRESS TO R4              04160000
         MVC   CS2+1(3),W1REGSAV+1      MOVE KEY ADDRESS TO CCW'S       04180000
         MVC   CS1B+K1(L3),W1REGSAV+K1  *                        S20201 04190020
         MVC   CS11+1(3),W1REGSAV+1                                     04200000
         MVC   CS22+1(3),W1REGSAV+1                                     04220000
         MVC   CS29+1(3),W1REGSAV+1                                     04240000
         TM    W1REGSAV,X'02'           TEST FOR HI/EQ  OPTION   O19111 04242019
         BO    SISSKG3A                 YES                      O19111 04244019
         TM    DCBRECFM,X'10'           ARE RECORDS BLOCKED      O19111 04246019
         BO    SISSKG3A                 YES                      O19111 04248019
         MVI   CS22,X'29'               SRCH UNBLKED REC KEY EQ  O19111 04250019
         B     SISSKG4A                                          O19111 04252019
SISSKG3A MVI   CS22,X'69'               BLKED RECS, SRC HI/EQ    O19111 04254019
SISSKG4A LA    R3,W1RD1ST                                               04260000
         LA    R4,W1FR1ST               MOVE 1 CP FROM FREEQ TO         04280000
         LA    R5,1                    READ Q                           04300000
         L     R10,DCBGET                                               04320000
         A     R10,GQUEUE(R10)                                          04340000
         BALR  R9,R10                   BRANCH TO QUEUE SUB AND RETURN  04360000
SISSKH4  L     R3,W1RD1ST                                               04380000
         MVI   CN6+7,X'00'         SET R OF CP1 READ Q TO ZERO          04400000
SISSKH3  LA    R3,CN6+3                                                 04420000
         L     R4,W1CP23PT                                              04440000
         ST    R3,CS25             PUT CN6+3 ADD TO CS25                04460000
         MVI   CS25,X'12'          RESTORE OP CODE                      04480000
SISSKH2  MVC   W1IDAD(7),DCBFTHI   SET IOBI+32(MBBCCHH) TO DCBFTHI      04500000
*                                       HIGHEST INDEX LEVEL ADDRESS     04520000
         MVI   W1IDAD+7,X'00'          SET R OF IOBI SEEK TO 0    17516 04540000
         MVC   CS6+7(8),W1IDAD          SET CS7 FOR 1 LEVEL      A34003 04545020
*                                       * SEARCH IN CASE CYL INDEX ON   04550020
*                                       * SAME DEVICE AS T.I.           04555020
SISSKJ2  CLI   DCBNLEV,X'00'       NLEV EQUAL ZERO                      04560000
         BE    SISSKK2             YES, THEN TRACK IS HIGHEST LEV INDEX 04580000
SISSKJ3  ST    R4,W1ICPS           SET CPS TO CS1 OF CP23               04600000
SISSKK5  OI    W1OSBIT1,X'08'      INDICATE KEY FOUND                   04680000
         B     SISSLA2                                                  04700000
         SPACE 2                                                        04720000
SISSKK2  LA    R7,CS9                                                   04800000
         ST    R7,W1ICPS                SET CPS TO ADD OF CS9 (CP23)    04820000
         MVC   CS6+7(7),DCBLPDA         SET UP FOR APPENDAGE       054A 04825016
         OC    CS7+5(1),DCBFIRSH+3      REDUCE TO CYL BDRY         054A 04830016
         XC    CS7+5(1),DCBFIRSH+3                                 054A 04835016
         B     SISSKK5                                                  04840000
         SPACE 4                                                        04860000
*  KEY CLASS SPECIFIED, COMPUTE CLASS LENGTH                            04880000
         SPACE 2                                                        04900000
SISSKC4  SR    R5,R5                                                    04920000
         IC    R5,DCBKEYLE              PUT KEY LENTH IN R5             04940000
         L     R6,W1REGSAV              KEY ADDRESS IN R6               04960000
         AR    R6,R5                                                    04980000
SISSKC4A BCTR  R6,0                    R6 NOW CONT. LOW ORDER BYTE KC   05000000
         CLI   0(R6),X'00'              IS THIS BYTE ZERO               05020000
         BNE   SISSKD4                  NO                              05040000
         BCT   R5,SISSKC4A              YES, SUB 1 FROM R5 AND LOOP     05060000
         LA    R5,K1(R5)                PREVENT ZERO CNT CCW    ZA01384 05070000
         SPACE                                                          05080000
*        THE PREVIOUS INSTRUCTIONS COMPUTED CLASS LENGTH. IT IS         05100000
*        NOW IN R5.                                                     05120000
         SPACE                                                          05140000
SISSKD4  L     R4,W1CP23PT                                              05160000
         STC   R5,CS29+7           INSERT KEY CLASS LENGTH IN CS29      05180000
         STC   R5,FIXIND           STORE KEY CL LEN, USED AT SLH3       05200000
         OI    CS29+4,X'20'        SET ON SILI BIT IN CS29              05220000
         STC   R5,CS22+7           PUT KEY CLASS IN CS22                05240000
         OI    CS22+4,X'20'        SET ON SILI BIT IN CS22              05260000
         B     SISSKD2                                                  05280000
         EJECT                                                          05300000
         DS    0F                                                       05320000
         SPACE 2                                                        05340000
*                       *****             *****                         05360000
*                       *****             *****                         05380000
*                       ***** SETL K OR KC*****                         05400000
*                       *****             *****                         05420000
*                       *****             *****                         05440000
         SPACE                                                          05460000
TRKREC1  DC    X'00000001'              HHR OF 001                      05480000
EXECUTE  CLC   0(0,R3),0(R6)            USED TO FIND RECORD WITHIN BLK  05500000
         SPACE 2                                                        05520000
SISSLA2  MVI   W1IEXTEN+1,X'04'         SET APP CODE                    05540000
         NI    W1IF1,X'7F'              SET OFF CD BIT IN IOB           05560000
         BAL   R6,SISEXCP              GO TO EXCP ROUTINE               05580000
SISSLA3  TM    W1ECBI,X'40'             IS COMP BIT SET                 05600000
         BO    SISSLA4                  YES, NO WAIT NEEDED             05620000
         LR    R7,R15                                                   05640000
         WAIT  ECB=W1ECBI                                               05660000
         LR    R15,R7                                                   05680000
SISSLA4  LR    R1,R8                   RESTORE R1                       05700000
         TM    W1OSBIT1,X'04'           CATASTROPHE                     05720000
         BZ    SISSLB4                  NO                              05740000
SISSLA5  OI    DCBEXCD1,X'02'           INDICATE UNREACHABLE            05760000
         B     SISSKB1A                GO TO SYNAD RETURN               05780000
SISSLB4  TM    W1OSBIT1,X'08'           WAS KEY FOUND                   05800000
         BO    SISSLB3                 YES                              05820000
         OI    DCBEXCD1,X'80'          INDICATE LOWER LIMIT NOT FOUND   05840000
         B     SISSKB1A                EXIT TO USER                     05860000
SISSLB3  TM    W1OSBIT1,X'20'           IS KEY ON OVERFLOW TRACK        05880000
         BO    SISSLE3                  YES                             05900000
         SPACE                                                          05920000
*                       NO, KEY IS IN PRIME DATA RECORD                 05940000
*                       COUNT OF RECORD IS READ INTO CN6 BY CP23,       05960000
*                       UNLESS RECORD IS 1ST OF A TRACK.                05980000
         SPACE                                                          06000000
         L     R3,W1RD1ST                                               06020000
         CLI   CN6+7,X'00'             R IN FIRST CN6=0                 06040000
         BNE   SISSLC1                  NO                              06060000
*                                  YES, KEY IS THAT OF 1ST RECORD ON    06080000
*                                  A TRACK                              06100000
SISSLB1  MVC   CN6+1(6),CS18            SET CN6 BBCCHH                  06120000
         MVI   CN6+7,X'01'              R MUST BE 1 TO GO TO THIS PATH  06140000
         TM    CS18+7,X'08'              SHARED TRACK                   06160000
         BZ    SISSLC1                                                  06180000
         MVC   CN6+7(1),CS18+6           YES  R IS PROPER               06200000
SISSLC1  MVC   W1IDAD(7),CS17+7        MOVE MBBCCHH INTO IOB            06220000
SISSLC1A MVI   W1IDAD+6,X'00'          ZERO TRK VALUE                   06320000
SISSLC1B MVI   W1IDAD+7,X'01'          R=1                              06340000
         SPACE 2                                                        06360000
*        INITIALIZING THE FIRST CP22 ON READ Q. AT THIS TIME R4         06380000
*        CONTAINS THE STARTING CCW ADDRESS OF CP23(CS1) AND R3 CONTAINS 06400000
*        THE ADDRESS OF 1ST CCW OF 1ST CP22 ON READQ                    06420000
         SPACE                                                          06440000
SISSLC2  MVC   CN6(1),CS17+7       SET M IN CN6                         06460000
         NI    CN1,X'7F'           SET OFF MT BIT                       06480000
         MVC   CN4+6(2),DCBBLKSI   SET COUNT TO BLKSIZE                 06500000
         NI    CN4+4,X'BF'         SET CC FLAG OFF                      06520000
SISSLC2A MVI   CN4,X'06'           CN4 TO READ D                        06540000
         ST    R3,W1CN15           SET CN1 ADDRESS TO CN15              06560000
         SR    R6,R6                                                    06562013
         IC    R6,CN6                                                   06564013
         SLL   R6,4                                                     06566013
         ST    R6,W1CN14                                                06568013
         L     R6,DCBDEBAD                                              06570013
         LA    R6,32(R6)                                                06572013
         A     R6,W1CN14                                                06574013
         MVC   CN6+1(2),4(R6)                                           06576013
         MVI   W1CN15,X'08'             RESET TIC CODE                  06580000
         LA    R3,CN6+1                                                 06600000
         ST    R3,W1CN14                SET SEEK ADDR IN CN14 TO DATA   06620000
*                                       RECORD ADDRESS                  06640000
         MVI   W1CN14,X'1B'             RESTORE SEEK HH IN CN14         06660000
SISSLE2  LA    R6,W1CN8                                                 06680000
         ST    R6,W1ICPS                SET CP PTR TO READ TRK INDEX CP 06700000
SISSLE1  MVI   W1IEXTEN+1,X'00'         SET IOB APP CODE TO 0           06720000
         OI    W1IF1,X'80'             SET ON DATA CHAIN BIT            06740000
         BAL   R6,SISEXCP                                               06760000
SISSLF1  L     R3,W1RD1ST                                               06780000
         TM    W1ECBI,X'40'             IS IOBI COMPLETE BIT ON         06800000
*                                       NO                              06820000
         BO    SISSLG1                  YES, READ FINISHED              06840000
         LR    R7,R15                                                   06860000
         WAIT  ECB=W1ECBI               WAIT                            06880000
         LR    R15,R7                                                   06900000
SISSLG1  LR    R1,R8                    RESTORE REGS                    06920000
         TM    CN2+4,X'0A'              WAS READ SUCCESSFUL             06940000
         BNE   SISSLK3                 NO, PREPARE TO RETURN TO USER    06960000
SISSLG1A TM    DCBRECFM,X'10'           BLOCKED RECORDS                 06980000
         LA    R14,SISSLH3A             SET UP NO OVERFLOW IND   M4902  06990019
         BO    SISSLG2                  YES, FIND RCD WITHIN BLOCK      07000000
*                                       NO                              07020000
         L     R3,CN7                   GET BUFFER ADDRESS        18746 07026000
         TM    DCBRECFM,X'80'           IS IT FIXED              A43934 07027021
         BO    SISSLK2P                 SEE IF REC DELETED       A43934 07028021
         LA    R3,4(0,R3)               BUMP OVER BDW            A43934 07029021
         B     SISSLK2P                 SEE IF RECORD IS DELETED  18746 07032000
SISSLJ1  L     R3,W1RD1ST                                               07040000
         MVC   W1LPDR,CN6          SET LPDR TO CN6 OF 1ST ON READ Q     07060000
SISSLK3  OI    W1OSBIT1,X'80'      SET ON SCAN MODE INDICATOR           07080000
         MVC   W1CBF,W1EOB        TO FORCE EOB SUBR. ENTRY              07100000
         OI    W1OSBIT2,X'20'        INDIC SAME CYLINDER                07120000
         IC    R7,DCBFIRSH+3           LOAD DEVICE MASK                 07140000
         IC    R8,W1LHH+1              LOAD LPDR H                      07160000
*                                                                       07162019
*        CHECK FOR EOF                                                  07164019
*                                                                       07166019
         NR    R8,R7                   AND MASK WITH LPDR H             07180000
         EX    R8,SISEXEC              CLI    DCBFIRSH+1,H OF LPDR      07200000
         BNE   SISSLK4                                                  07220000
         CLI   DCBFIRSH+2,X'01'      R OF FIRSH EQUAL ONE               07240000
         BE    SISSLK4             YES                                  07260000
         OI    W1OSBIT2,X'10'        INDIC SHARED TRACK                 07280000
SISSLK4  LM    R14,R12,12(R13)          RESTORE REGISTERS        M4902  07300019
         BR    R14                 RETURN TO USER                       07320000
SISEXEC  CLI   DCBFIRSH+1,0            IS H OF LPDR=H OF FIRSH          07340000
SISEXCP  SR    R8,R8                   CLEAR WORK REG                   07360000
         IC    R8,W1IDAD               GET M FROM IOBI                  07380000
         SLL   R8,4                    M X 16                           07400000
         L     R7,DCBDEBAD             GET DCB ADDR                     07420000
         LA    R8,32(R8,R7)            R8 POINTS TO EXTENT OF M.        07440000
         MVC   W1IDAD+1(2),4(R8)       MOVE BB INTO IOB                 07460000
         LR    R8,R1                   SAVE R1                          07480000
         LR    R7,R15                  SAVE R15                         07500000
         EXCP  W1IOBI                  FOR CP24-CP22                    07520000
         LR    R15,R7                  RESTORE R15                      07540000
         BR    R6                                                       07560000
         SPACE 3                                                        07580000
SISSLG2  L     R8,CN7              BUFFER ADDRESS                       07600000
         TM    DCBRECFM,X'80'           IS IT FIXED               VLR   07605018
         BO    FIXEOB                   YES, BRANCH               VLR   07610018
         AH    R8,0(R8)                 VLR BLKSIZE IS VAR        VLR   07615018
         B     VAREOB                                             VLR   07620018
FIXEOB   EQU   *                                                  VLR   07625018
         AH    R8,DCBBLKSI                                        VLR   07630018
VAREOB   EQU   *                                                  VLR   07635018
         BCTR  R8,0                    R8=END OF BUFFER                 07640000
         TM    W1REGSAV,X'40'      SETL KC                              07660000
         BZ    SISSLH2             NO, JUST SETL K                      07680000
SISSLG3  SR    R5,R5               YES                                  07700000
         IC    R5,FIXIND           R5=CLASS LENGTH                      07720000
         SPACE                                                          07740000
SISSLH3  L     R6,W1REGSAV         KEY ADDRESS                          07760000
         L     R3,CN7              LOAD BUFFER ADDRESS TO R3            07780000
         TM    DCBRECFM,X'80'           IS IT FIXED               VLR   07783018
         BO    FIXRKP                   YES, BRANCH               VLR   07786018
         LA    R3,4(R3)                 BUMP OVER BLK LL FLD      VLR   07789018
         MVC   RCDLEN(2),0(R3)          SAVE LENGTH               VLR   07792018
FIXRKP   EQU   *                                                  VLR   07795018
         AH    R3,DCBRKP                                                07800000
         BCTR  R5,0                    FOR WAY CLC WORKS                07820000
         BR    R14                      BR IF OVERFLOW           M4902  07830019
SISSLH3A EX    R5,EXECUTE           CLC   0(0,R3),0(R6)                 07840000
         SPACE 2                                                        07860000
*        IN THE PREVIOUS INSTRUCTIONS,R5 CONTAINED THE KEYLENGTH        07880000
*        (FROM SLH2) OR THE KEY CLASS(FROM SLG3). THE EX INSTRUCTION    07900000
*        CAUSES A BRANCH TO EXECUTE TAG WHICH COMPARES THE RCD KEY      07920000
*        (AT THE LOC. OF R3) TO THE LOWER LIMIT KEY(AT R6)              07940000
*        THE NUMBER OF BYTES TO BE COMPARED IS DESIGNATED BY R5         07960000
         SPACE 2                                                        07980000
         BE    SISSLK2                  IF COMPARE EQUAL,THEN KEY FOUND 08000000
         BH    SISSLJ3                  IF HI, CHECK FOR HI-EQ   O19111 08007019
*                                       OPTION                          08014019
         TM    DCBRECFM,X'80'           IS IT FIXED               VLR   08023018
         BO    FIXLEN                   YES, BRANCH               VLR   08026018
         SH    R3,DCBRKP                GET NXT REC LL            VLR   08029018
         AH    R3,RCDLEN                                          VLR   08032018
         MVC   RCDLEN(2),0(R3)                                    VLR   08035018
         AH    R3,DCBRKP                                          VLR   08038018
         B     VARLEN                                             VLR   08041018
FIXLEN   EQU   *                                                  VLR   08044018
         AH    R3,W1CURLEN              R3=ADDR NEXT RCD IN BUFF  VLR   08047018
VARLEN   EQU   *                                                  VLR   08050018
         CR    R8,R3                    IS THERE A NEXT RCD IN THIS BUF 08060000
         BL    SISSLJ4                  NO,IT'S EOB AND KEY NOT FOUND   08080000
         B     SISSLH3A                 SEARCH NEXT RECORD OF THIS BUF. 08100000
         SPACE                                                          08120000
SISSLH2  SR    R5,R5                                                    08140000
         IC    R5,DCBKEYLE              PUT KEY LENGTH IN R5            08160000
         B     SISSLH3                  BRANCH TO H3                    08180000
SISSLJ3  TM    W1REGSAV,X'02'           SETL KH OR KDH           M4581  08186019
         BZ    SISSLJ4                  NO, BR--NO REC FOUND     M4581  08192019
         SPACE                                                          08200000
*                                       RECORD FOUND                    08220000
SISSLK2  OI    W1OSBIT2,X'01'      SET ON BIT TO BE TESTED IN EOB       08240000
         SH    R3,DCBRKP     BRING R3 BACK TO DATA OF RCD FROM H3A      08260000
         ST    R3,W1KEYBLK              SAVE CORR ADDR FOR EOB RTN      08280000
SISSLK2P TM    DCBOPTCD,X'02'           DELETE OPTION SPECIFIED   18746 08288000
         BZ    SISSLJ1                  NO--TAKE RCD FOUND EXIT   18746 08296000
         TM    DCBRECFM,X'80'           IS IT FIXED               VLR   08298018
         BO    SISSLK2Q                 YES, BRANCH               VLR   08300018
         CLI   4(R3),X'FF'              VLR, CHECK STH BYTE       VLR   08302018
         B     SISSLK2R                                           VLR   08304018
SISSLK2Q EQU   *                                                  VLR   08306018
         CLI   0(R3),X'FF'              TEST FOR DELETED RCD      VLR   08308018
SISSLK2R EQU   *                                                  VLR   08310018
         BNE   SISSLJ1                  IF NOT, BRANCH            18746 08312000
         TM    W1REGSAV,X'40'           SETL KC                   20816 08314000
         BO    SISSLJ1                  YES--OK IF DELETED        20816 08316000
         SPACE                                                          08320000
*              IF HI-EQUAL OPTION NOT SPECIFIED THEN RECORD             08326019
*              NOT FOUND                                                08332019
*                                                                       08338019
         TM    W1REGSAV,X'02'           SETL KH OR KDH           M4581  08345019
         BO    SISSLJ1                  YES, OK IF DELETED       M4581  08352019
SISSLJ4  OI    DCBEXCD1,X'80'           SET ON LOWER LIM NOT FOUND BIT  08360000
         B     SISSKB1A                 GO TO SYNAD                     08380000
         SPACE 2                                                        08400000
*              KEY IS IN OVERFLOW RECORD                                08420000
*              LPDR IS SET IN SETL K APPENDAGE FOR OVERFLOW RCDS        08440000
         SPACE                                                          08460000
SISSLE3  MVC   W1WOVFL(10),CS34+7       MOVE ADDR OF REC TO OVERFLOW    08480000
*                                       ENTRY OF TRACK INDEX AREA       08500000
         MVC   W1READR,W1READC          SET READ R = READ C       18746 08506000
         XC    W1READC(2),W1READC       SET COUNT TO ZERO         18746 08512000
         L     R11,DCBGET                                               08520000
         A     R11,GSCHED(R11)          GO TO SCHEDULE TO READ RECORD   08540000
         BALR  R9,R11                                                   08560000
         TM    W1ECBI,X'40'             IS READING FINISHED       18746 08600000
         BO    SISSLE4                  YES--BRANCH               18746 08640000
         LR    R7,R1                                                    08700000
         LR    R8,R15                                                   08720000
         WAIT  ECB=W1ECBI              WAIT                             08740000
         LR    R1,R7                    RESTORE R1                      08760000
         LR    R15,R8                   RESTORE R15                     08780000
*                                                                       08780719
*              KEY IN OVERFLOW MUST BE COMPARED TO DETERMINE AND        08781419
*              OPTION CHECKED TO DETERMINE IF RECORD GOOD.              08782119
*                                                                       08782819
SISSLE4  TM    W1REGSAV,X'02'           HI/EQ OPTION SPECIFIED   M4581  08782919
         BO    SISSLK3                  YES, BR--KEY WAS FOUND   M4581  08783019
         TM    DCBRECFM,X'10'           ARE RECORDS BLOCKED      M4581  08783119
         BO    SISSLE40                 YES,BR--KEY IS IN DATA   M4581  08783219
         NC    DCBRKP,DCBRKP            IS RKP ZERO              M4581  08783319
         BZ    SISSLE42                 YES, KEY FOUND           M4581  08783419
*                                                                       08783519
*        A SEARCH KEY EQUAL OR HIGH WAS USED IN THE CHANNEL PGM         08783619
*        AND THE SETL WAS NOT EQ/HIGH THEREFORE THE RECORD MUST         08783719
*        BE EXAMINED TO SEE IF THE KEY CONTAINED WITHIN IT IS           08783819
*        EQUAL TO THE DESIRED KEY.                                      08783919
SISSLE40 L     R3,W1RD1ST               SET CP22 BASE            M4581  08784019
         BAL   R14,SISSLG2              BRANCH TO PREPARE FOR    M4902  08784519
*                                       *    COMPARE.                   08785019
SISSLE41 EX    R5,EXECUTE               CLC  0(0,R3),0(R6)       O19111 08785619
         BNE   SISSLJ4                  BR--NO RECORD FOUND      M4581  08786619
SISSLE42 TM    DCBOPTCD,X'02'           DELETE OPTION SPECIFIED  O19111 08788419
         BZ    SISSLK3                  NO--TAKE RCD FOUND EXIT   18746 08790000
         TM    W1REGSAV,X'40'           SETL KC                   20816 08791000
         BO    SISSLK3                  YES--OK IF DELETED        20816 08792000
         L     R3,W1RD1ST               SET CP22 BASE             18746 08795000
         L     R3,CN7                   GET BUFFER ADDRESS        18746 08800000
         TM    DCBRECFM,X'80'           IS IT FIXED               VLR   08800818
         BO    SISSLE4A                 YES, BRANCH               VLR   08801618
         CLI   K8(R3),DELETE            VLR, CHECK 8TH BYTE      S20201 08802420
         B     SISSLE4B                                           VLR   08803218
SISSLE4A EQU   *                                                  VLR   08804018
         CLI   0(R3),X'FF'              WAS THIS RECORD DELETED   18746 08805000
SISSLE4B EQU   *                                                  VLR   08807018
         BNE   SISSLK3                  BRANCH IF RECORD FOUND    18746 08810000
         B     SISSLJ4                  OTHERWISE, RECORD NOT FND 18746 08815000
         SPACE 3                                                        08820000
*                                  OFFSETS OF VECTOR TABLE IN HB        08840000
GEINFO   EQU   12                                                       08860000
GQUEUE   EQU   16                                                       08880000
GSETLB   EQU   36                                                       08900000
GSCHED   EQU   20                                                       08920000
*                                                                       08930002
PATCH    DC    XL((*-IGG019HD)/20)'00'  ZEROED PATCH AREA        Y02072 08932002
*                                                                       08934002
         EJECT                                                          08940000
SISWORK1 IGGSCAN                                                        09740020
RCDLEN   EQU   W1WDCXDM+10              CURRENT RECORD LENGTH    A35340 10540020
*                                  THE NO. OF CP 22'S IS DEPENDENT ON   11440000
*                                  THE NO. OF BUFFERS %DCBBUFNO<        11460000
         EJECT                                                          11480000
         DCBD  DSORG=(IS)                                               11500000
         EJECT                                                          11520000
SISCP22  DSECT                                                          11540000
         IGGCP22                                                        11560020
         SPACE 5                                                        11700000
SISCP236 DSECT                                                          11720000
         IGGCP23                                                        11750020
         IGGCP26                                                        11780020
         END                                                            12540000
