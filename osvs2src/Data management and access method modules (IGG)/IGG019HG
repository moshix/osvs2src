 TITLE  'IGG019HG  - READ APPENDAGE AOS VERSION'                        00020001
IGG019HG CSECT                                                          00040000
*          RELEASE OS/VS2-02 DELETIONS                                  00050002
*                                                               YM01101 00060002
*                                                               YM03876 00062002
*           VS2 RELEASE 037 CHANGES                                     00072037
* D028800-029000,C028200,A028100,A028300,A028700-028798         ZA03150 00073037
* C028797-028798                                                OZ05236 00074037
*           CHANGES SINCE VS2-037                                     * 00075037
*C024700,C024850,A024150-024650                                @ZA26522 00076037
*          RELEASE 21 DELETIONS                                         00082000
*0681032400,038000,058464,058472                                 A48227 00083000
*0681013000,020200,021800                                        S21045 00085021
*                                                                       00087002
*                                                                       00103002
*STATUS CHANGE LEVEL 006                                                00111002
*FUNCTION/OPERATION- A CHANNEL END COMPLETION WILL CAUSE A NORMAL     * 00120000
*   RETURN TO IOS IF PRIME DATA RECORDS ARE BEING READ, AFTER SETTING * 00140000
*   ON THE IOB-I COMPLETE BIT.  IF OVERFLOW RECORDS ARE BEING READ THE* 00160000
*   APPENDAGE SETS UP FOR AND INITIATES THE READ OF THE NEXT OVERFLOW * 00180000
*   RECORD UNTIL EITHER THE OVERFLOW CHAIN OR THE FREE BUFFER SUPPLY  * 00200000
*   IS EXHAUSTED, AT WHICH POINT IT SETS ON THE IOB-I COMPLETE BIT AND* 00220000
*   CAUSES A NORMAL RETURN TO IOS.                                    * 00240000
*                                                                     * 00260000
*   AN ABNORMAL END COMPLETION WILL RESULT IN TAGGING THE BUFFER IN   * 00280000
*   ERROR EITHER UNREADABLE OR UNREACHABLE. IF UNREADABLE, AND ANY    * 00300000
*   BUFFERS REMAIN ON THE QUEUE, THE NEXT READ IS INITIATED.  FOR     * 00320000
*   UNREACHABLE, ALL SUBSEQUENT BUFFERS ON THE QUEUE ARE ALSO MARKED  * 00340000
*   UNREACHABLE AND THE NORMAL RETURN TO IOS IS TAKEN.                * 00360000
*                                                                     * 00380000
*   THIS MODULE CONTAINS THE APPENDAGE CONTROL ROUTINE WHICH          * 00400000
*   INTERROGATES THE APPENDAGE CODES AND SENDS CONTROL TO THE         * 00420000
*   APPROPRIATE APPENDAGE.                                            * 00440000
*                                                                     * 00460000
*   THE ASYNCHRONOUS ROUTINE USED BY THE INPUT APPENDAGES TO          * 00480000
*   CONTINUE READING ON A DEVICE OTHER THAN THE ONE INITIALLY         * 00500000
*   ACCESSED BY THE EXCP IS ALSO IN THIS MODULE.                      * 00520000
*                                                                     * 00540000
*ENTRY POINTS- THE APPENDAGE VECTOR TABLE ADDRESSES THE ENTRY POINTS  * 00560000
*   TO MODULE 'IGG019HG'.                                             * 00580000
*        SISRQA3 - CHANNEL END COMPLETION ON A READ                   * 00600000
*        SISRAB2 - ABNORMAL END COMPLETION ON A READ                  * 00620000
*        SISAPRET - IMMEDIATE RETURN TO IOS IF NOT CH. END OR AB. END * 00640000
*        SISCERTN - ENTRY TO APPENDAGE CONTROL ROUTINE ON CHANNEL END * 00660000
*        SISABRTN - ENTRY TO APPENDAGE CONTROL ROUTINE ON ABNORMAL END* 00680000
*        SISAPASY - ENTRY TO ASYNCHRONOUS ROUTINE                     * 00700000
*                                                                     * 00720000
*INPUT- REGISTER 1- 12* ADDRESS                                       * 00740000
*       REGISTER 2- IOB ADDRESS                                       * 00760000
*       REGISTER 3- DEB ADDRESS                                       * 00780000
*       REGISTER 4- DCB ADDRESS                                       * 00800000
*       REGISTER 7- UCB ADDRESS                                       * 00820000
*       REGISTER 12- WORK AREA ADDRESS                                * 00840000
*       REGISTER 14- RETURN TO IOS VECTOR TABLE ADDRESS               * 00860000
*       REGISTER 15- MODULE BASE                                      * 00880000
*                                                                     * 00900000
*OUTPUT- SAME AS FOR INPUT                                            * 00920000
*                                                                     * 00940000
*EXTERNAL ROUTINES- N/A                                               * 00960000
*                                                                     * 00980000
*EXITS- NORMAL- RETURN TO IOS THROUGH REGISTER 14                     * 01000000
*   ERROR-N/A                                                         * 01020000
*                                                                     * 01040000
*TABLES/WORK AREAS- DATA EXTENT BLOCK(DEB) DESCRIBED BY SISDEB DSECT  * 01060000
*   WORKAREA,DESCRIBED BY SISWORK1 DSECT                              * 01080000
*   DATA CONTROL BLOCK DESCRIBED BY IHADCB DSECT                      * 01100000
*                                                                     * 01120000
*ATTRIBUTES - READ ONLY, REENTRANT                                    * 01140000
*                                                                     * 01160000
*NOTES- REGISTER USAGE IS CONSISTENT IN ALL SCAN MODE                 * 01180000
*   APPENDAGE MODULES.                                                * 01200000
         EJECT                                                          01220000
         USING RQE,R1                   RQE ADDRESSABILITY       Y02072 01230002
         USING SISDEB,R3                                                01240000
         USING IHADCB,R4                                                01260000
         USING SISCP22,R5                                        S20201 01310020
         USING *,R15                                                    01320000
R0       EQU   0                                                        01340000
R1       EQU   1                                                        01360000
R2       EQU   2                                                        01380000
R3       EQU   3                                                        01400000
R4       EQU   4                                                        01420000
R5       EQU   5                                                        01440000
RSAVE    EQU   6                        BASE REG FOR SAVE AREA   Y02072 01460002
R6       EQU   6                                                        01470037
R7       EQU   7                                                        01480000
R8       EQU   8                                                        01500000
R9       EQU   9                                                        01520000
R10      EQU   10                                                       01540000
R11      EQU   11                                                       01560000
R12      EQU   12                                                       01580000
R13      EQU   13                                                       01600000
R14      EQU   14                                                       01620000
R15      EQU   15                                                       01640000
NORMAL   EQU   0                                                  15924 01645016
ASYNCH   EQU   4                        BRANCH OFFSET TO ASYNCH  Y02072 01649402
*                                       SCHEDULING ROUTINE              01649802
EXCP     EQU   8                                                  15924 01650016
BYPASS   EQU   12                                                 15924 01655016
K4       EQU   4                        CONSTANT                 S20201 01655820
L4       EQU   4                        LENGTH                   S20201 01656620
K1       EQU   1                        CONSTANT                 S20201 01657420
L3       EQU   3                        LENGTH                   S20201 01658220
ONZERO   EQU   8                        ZEROES CONDITION         A48227 01668100
RPS      EQU   X'E0'                    DEB RPS INDICATOR        A48227 01669000
VIRTUAL  EQU   X'80'                       VIRTUAL = REAL               01670001
FIXED    EQU   X'80'                    TEST FOR FIXED FORMAT    Y02072 01672002
ONE      EQU   1                        TEST FOR FIRST RECORD    Y02072 01672402
SW22     EQU   X'10'                    CP22 INDICATOR           Y02072 01672802
ZERO     EQU   0                        TEST FOR SHARED TRACK    Y02072 01672902
ONES     EQU   X'FF'                    MASK OF ALL ONES         Y02072 01679602
         SPACE 2                                                 S20201 01686602
*        APPENDAGE CONTROL MODULE, ASSEMBLED WITH RA AND RQ             01693302
         SPACE 2                                                        01700000
SISAPRTN DC    A(SISRQA3-SISAPRTN)      CE READ ENTRY            0      01720000
         DC    A(SISRAB2-SISAPRTN)      AB READ ENTRY            4      01740000
         DC    A(SISAPASY-SISAPRTN)     ASYNCHRONOUS RTN ENTRY   8      01760000
         DC    A(SISAPRET-SISAPRTN)     RETURN ENTRY             12     01780000
         DC    A(SISCERTN-SISAPRTN)     COMMON CE ENTRY          16     01800000
         DC    A(SISABRTN-SISAPRTN)     COMMON AB ENTRY          20     01820000
         SPACE 2                                                        01840000
* IMEDIATE RETURN                                                       01860000
         SPACE 2                                                        01880000
         USING *,R15                                                    01900000
SISAPRET BR    R14                                                      01920000
         SPACE 2                                                        01940000
*  CHANNEL END                                                          01960000
         SPACE 2                                                        01980000
         USING *,R15                                                    02000000
SISCERTN EQU   *                                                 Y02072 02010002
         BAL   R12,SISSKEY              SET KEY AND SAVE REGS    Y02072 02010402
         L     R12,DEBEXPTR             DEB EXTENSION ADDR       Y02072 02012002
         USING DEBEXT,R12                                        S21045 02020021
         LA    R11,W1CEVECT             FOR FINDING ENTRY POINT         02040000
         LA    R10,SISAPCOM             ADDRESS OF COMMON RTN    Y02072 02050002
         BR    R10                      BRANCH TO COMMON RTN     Y02072 02090002
         SPACE 2                                                        02100000
*  ABNORMAL END                                                         02120000
         SPACE 2                                                        02140000
         USING *,R15                                                    02160000
SISABRTN EQU   *                                                 Y02072 02180002
         BAL   R12,SISSKEY              SET KEY AND SAVE REGS    Y02072 02184002
         L     R12,DEBEXPTR             DEB EXTENSION ADDR       Y02072 02190002
         LA    R11,W1ABVECT             FOR FINDING ENTRY POINT         02200000
         LA    R10,SISAPCOM                                             02220000
         BR    R10                      GET TO PROPER APPENDAGE  Y02072 02230002
         SPACE 3                                                        02232002
*  SET KEY AND SAVE REGISTERS ROUTINE                                   02234002
         SPACE 1                                                        02236002
SISSKEY  EQU   *                                                 Y02072 02238002
         USING REGSAVE,R13              SAVE AREA ADDRESSABILITY Y02072 02238402
         STM   R0,R15,REGSAV0           SAVE REGISTERS           Y02072 02238502
         DROP  R13                      END SAVE AREA USING      Y02072 02238602
         LR    RSAVE,R13                SAVE ADDR OF SAVE AREA   Y02072 02238802
         SPACE 2                                                        02239202
         MODESET KEYADDR=RQEPRT,WORKREG=11  SET USERS KEY        Y02072 02239602
         SPACE 2                                                        02249602
         BR    R12                      RETURN TO CALLING RTN    Y02072 02253202
         SPACE 3                                                        02256602
         USING *,R10                                                    02260000
SISAPCOM LA    R13,W1CEVECT             FOR SETTING MODULE BASE         02280000
         LA    R14,SISEXIT              GET EXIT ROUTINE ADDR    Y02072 02282002
         L     R12,DCBWKPT1             WORK AREA ADDR           S21045 02286021
         USING SISWORK1,R12                                      S21045 02292021
*                                       R2 POINTS TO IOB                02340000
         AH    R11,APPCODE(0,R2)        ADD APPROPRIATE APPENDAGE CODE  02360000
*                                        FROM EITHER IOBI OR IOBO       02380000
*************************************************************           02400037
*    TEST VALIDITY OF APPENDAGE CODE FROM IOB               *           02405037
*************************************************************           02410037
         LH    R8,APPCODE(R2)           APPENDAGE CODE         @ZA26522 02415037
         LTR   R5,R8                    TEST CODE VALUE        @ZA26522 02420037
         BNM   NOTMINUS                 GO TEST SOME MORE      @ZA26522 02425037
INVAPPCD DC    H'0'                     PROG CHK FOR BAD CODE  @ZA26522 02430037
FOUR     DC    X'0004'                  DECREMENT VALUE        @ZA26522 02432037
TWENTY   DC    X'0014'                  MAX VALUE FOR CODE     @ZA26522 02435037
NOTMINUS BZ    CODEOK                   SKIP IF CODE IS ZERO   @ZA26522 02440037
         CH    R5,TWENTY                IS APPCODE GT 20?      @ZA26522 02445037
         BH    INVAPPCD                 IF YES PROG CHK        @ZA26522 02450037
DECRIT   SH    R5,FOUR                  SUBT 4                 @ZA26522 02455037
         BP    DECRIT                   STILL PLUS-SUBT MORE   @ZA26522 02460037
         BM    INVAPPCD                 NOT MLTPL OF 4-BAD     @ZA26522 02465037
CODEOK   L     R11,0(R11)               GET ENTRY POINT        @ZA26522 02470037
         CLC   APPCODE(2,R2),SISAPCN8   IS IT THE WRITE CHECK APPENDAGE 02475037
         BH    SISAP01                  YES                             02480037
         AR    R13,R8                   NO, ADD APPCODE TO GET @ZA26522 02485037
         B     SISAP02                  ADDR OF MODULE BASE             02490037
SISAP01  AH    R13,SISAPCN8             TO GET MODULE BASE ADDRESS      02500000
SISAP02  L     R13,0(R13)               PICK UP BASE                    02520000
         LR    R15,R13                                                  02540000
         BR    R11                                                      02560000
SISAPCN8 DC    H'08'                                                    02580000
         DROP  R10                         *                            02590001
         EJECT                                                          02600000
*  ASYNCHRONOUS ROUTINE                                                 02620000
         SPACE 2                                                        02640000
         USING *,R15                                                    02660000
SISAPASY L     R1,4(0,R1)               GET IOB ADDR FROM 12*           02680000
         L     R10,4(R1)                R10 = ECB ADDRESS               02780037
         LA    R10,0(R10)               CLEAR HI ORDER BYTE             02800037
         USING ECB,R10                                                  02810037
         L     R11,ECB                  SAVE ECB IN REG 11      ZA03150 02820037
         LR    R7,R15                   SAVE ADDRESSABILITY     ZA03150 02830037
         EXCP  (1)                                                      02860000
         LR    R15,R7                   RESTORE ADDRESSABILITY  ZA03150 02870037
         L     R6,ECB                   GET ECB IN REG 6        ZA03150 02872037
         LTR   R6,R6                    IS ECB ZEROED?          ZA03150 02874037
         BZ    SWAP                     YES - BR                ZA03150 02876037
POST     ST    R11,ECB                  RESTORE WAITING ECB     ZA03150 02878037
         POST  (R10)                    POST ECB COMPLETE       ZA03150 02878437
EXIT     BR    R14                      RETURN                  ZA03150 02878837
SWAP     CS    R6,R11,ECB               SWAP IF R6 = ECB        ZA03150 02879637
         BE    EXIT                     BR IF NOT EQUAL         OZ05236 02879737
         B     POST                     GO TO EXIT              OZ05236 02879837
SISAPCN4 DC    X'0004'                                                  02920000
         SPACE 3                                                        02930002
         DROP  R15                                               Y02072 02932002
         USING *,R14                                             Y02072 02934002
SISEXIT  EQU   *                                                 Y02072 02936002
         B     SISIOSRT                 BR TO IOS RETURN RTN     Y02072 02938002
         SPACE 1                                                        02938402
*  SCHEDULE ASYNCHRONOUS ROUTINE                                        02938802
         SPACE 1                                                        02939202
         MODESET KEYADDR=KEY0,WORKREG=11  CHANGE TO KEY 0        Y02072 02939302
         SPACE 1                                                        02939402
         USING REGSAVE,RSAVE                                     Y02072 02939602
         L     R14,REGSAV14             RESTORE IOS RETURN ADDR  Y02072 02939702
         LA    R14,BYPASS(,R14)         INCREMENT IOS RET ADDR   Y02072 02939802
         LM    R5,R8,REGSAV5            RESTORE REGS 5-8         Y02072 02939902
         L     R13,CVTPTR               CVT PTR                  Y02072 02946602
         USING CVT,R13                  CVT ADDRESSABILITY       Y02072 02947002
         L     R13,CVT0EF00             EXIT EFFECTOR ADDRESS    Y02072 02948602
         DROP  R13                      END USING ON CVT         Y02072 02949002
         SPACE 1                                                        02949402
         BR    R13                      BR TO EXIT EFFECTOR      Y02072 02953102
         SPACE 2                                                        02953202
*  RETURN TO IOS ROUTINE                                                02959902
         SPACE 1                                                        02961902
SISIOSRT EQU   *                                                 Y02072 02963902
         SPACE 2                                                        02966702
         MODESET KEYADDR=KEY0,WORKREG=11  CHANGE TO KEY 0        Y02072 02968302
         SPACE 2                                                        02970302
         L     R14,REGSAV14             RESTORE IOS RETURN ADDR  Y02072 02972302
         LM    R5,R8,REGSAV5            RESTORE REGS 5-8         Y02072 02974302
         SR    R9,R9                    CLEAR REG FOR IOS        Y02072 02974702
         B     0(R10,R14)               RETURN TO IOS            Y02072 02975202
         DROP  R14                                               Y02072 02977202
         DROP  RSAVE                                             Y02072 02979202
         EJECT                                                          02979902
         USING *,R15                                                    02986602
SISRQA3  B     SISRQA30       USED FOR SETTING BASE REG                 02993302
*                     *****************************                     03000000
*                     *                           *                     03020000
*                     *  ABNORMAL END APP. READ Q *                     03040000
*                     *                           *                     03060000
*                     *****************************                     03080000
         SPACE 2                                                        03100000
*                                  ***** CONSTANTS *****                03140000
CON8     DC    H'8'                        CONSTANT OF 8         S20201 03170020
CON16    DC    AL2(CN3-CN1)                RD KEY DATA OFFSET    S20201 03180020
CON24    DC    AL2(CN4-CN1)                RD DATA OFFSET        S20201 03200020
         SPACE 2                                                        03220000
SISRAB2  EQU   *                        *                        A48227 03240000
         TM    W1IECBAD,X'20'           PERMANENT ERROR         SA65064 03242002
         BO    SISRQH2A                 NO--BRANCH              SA65064 03242402
*   REMOVE RPS PREFIXES AND SUFFIXES IF THEY HAVE BEEN ATTACHED.        03243000
         BAL   R8,RPSPREFX              RPS NORMALIZATION        A48227 03246000
*                                       ROUTINE                  A48227 03249000
*                                                                       03252000
         LA    R8,W1CN8                GET CCW1 ADDR OF CP24     A48227 03255000
         SPACE 2                                                        03260000
*        THE CHECK FOR AN ERROR IN CP24 IS MADE BY COMPARING COM. ADD.  03280000
*        IN THE CSW(IOBI) WITH THE RANGE OF CCW'S OF CP24               03300000
         SPACE 2                                                        03320000
SISRAC2  L     R5,W1COMAD               R5 = ERROR CCW + 8              03340000
         LA    R5,0(R5)                CLEAR HI ORDER BYTE              03360000
         SH    R5,CON8                 SUBTRACT 8 TO GET ERROR CCW      03380000
         CR    R5,R8                   IS ERROR IN CN8 OF CP24          03400000
         BE    SISRAC3B                 YES, CHK FOR SPECIAL SETLK CASE 03420000
*                                       NO                              03440000
         LA    R8,W1CN15               PUT CN15 ADDRESS IN R8           03520000
         CR    R5,R8                   IS ERROR WITHIN RANGE OF CP24    03540000
         BNH   SISRAC3                 YES                              03560000
*                                                                       03570002
*        IF THE BRANCH TO SISRAC3 IS TAKEN THEN THERE                   03580000
*        WAS AN ERROR IN CP24. IF PROGRAM DOESN'T BRANCH THEN THE ERROR 03600000
*        IS IN ONE OF THE CP22'S.                                       03620000
         SPACE 2                                                        03640000
*        AT THIS POINT R5 POINTS TO CCW THAT CAUSED STOP                03660000
         CLI   0(R5),RKD               CP STOP ON A RD KD--CN3   S20201 03680020
         BNE   SISRAC2A                NO                               03700000
*                                      YES                              03720000
         SH    R5,CON16                SET R5 TO CN1 OF CP IN ERROR     03740000
         B     SISRAC2B                                                 03760000
SISRAC2A CLI   0(R5),RDATA             STOP ON RD DATA (CN4)     S20201 03780020
         BNE   SISRAC3                 NO                        A48227 03800000
         SH    R5,CON24               YES, SET R5, TO CN1 FOR CP IN ERR 03820000
SISRAC2B TM    W1ISENSE,X'08'          WAS STOP A DATA CHECK            03840000
         BZ    SISRAC3A                 NO, UNREACHABLE                 03860000
         SPACE 2                                                        03880000
SISRAD2C OI    CN2+K4,UNREAD           MARK BUFFER UNREADABLE    S20201 03900020
         MVC   CN5+K4(L4),W1IF1        MOVE IOB FIELDS INTO      S20201 03920020
         MVC   CN6,W1ICSW              CHAN PROG FOR USER        S20201 03940020
*                                       ERROR EXIT                      03960000
         SPACE 2                                                        03980000
SISRAF2  TM    CN2+K4,OFLOW            OVERFLOW MODE             S20201 04000020
         BO    SISRQC3                  YES, CONTINUE TO READ OFLO RCDS 04020000
SISRAF3  CLC   CN5+K1(L3),CON000       END OF READ Q,  ADDR = 0  S20201 04040020
         BE    SISRQF2                  IF YES, TAKE NORMAL EXIT        04060000
         CLI   CN5,TIC                  IS IT ATIC TO CP22       S20201 04066020
         BE    SISRAG3                  YES                      M5092  04068020
         NI    CN4+4,X'FF'-CC           NO - UNLINK STOP READS   M5092  04070020
         XC    CN5+1(3),CN5+1           *                        M5092  04072020
         B     SISRQF2                  *                        M5092  04074020
*                                                                       04076020
*                                       NO, CONTINUE READING            04080000
SISRAG3  L     R5,CN5                   GET ADDRESS OF NEXT CP   S20201 04100020
         NI    CN1,X'FF'-MT             SET OFF MT IN NEXT CP    S20201 04120020
SISRAH3  MVC   W1IDAD,CN6               SET SEEK ADDR NEXT CN6   S20201 04140020
SISRAJ3  ST    R5,W1ICPS(0)             SET CPS TO CN1 OF NEXT CP       04160000
SISRAJ4  NI    W1IF1,X'FA'                                              04180000
         MVI   W1IF2,X'00'                                              04200000
         MVI   W1KEY,X'00'             INITIALIZE FIELDS FOR            04220000
         MVC   W1IERRCT,CON000         EXCP RETURN                      04240000
SISRAJ5  EQU   *                                                 Y02072 04260002
         XC    W1IF2(3),W1IF2           CLEAR FLAG2,SENSE BYTES   15924 04306016
         XC    W1ICSW(9),W1ICSW         CLEAR FLAG3,CSW,SIOCC     15924 04312016
         XC    W1IERRCT(2),W1IERRCT     CLEAR ERROR COUNT         15924 04318016
         NI    W1IF1,X'C2'              RESET FLAG1               15924 04324016
         LA    R10,EXCP                 LOAD IOS RET ADDR OFST   Y02072 04334002
         BR    R14                      RETURN TO IOS VIA EXIT   Y02072 04336002
*                                       ROUTINE IN IGG019HG             04338002
         SPACE 2                                                        04460000
* TEST FOR SPECIAL CASE OF WHERE SETL K IS LOOKING FOR TRACK INDEX      04480000
*  ENTRY WHICH IS ON OTHER THAN THE 1ST TRACK OF TRACK INDICES          04500000
         SPACE 2                                                        04520000
SISRAC3B TM    W1ISENSE+1,X'08'         CAUSE OF STOP NO RCD FND        04540000
         BZ    SISRAC3E                 NO                              04560000
         IC    R5,W1IDAD+6              SAVE H                          04580000
         NC    W1IDAD+6(1),DCBFIRSH+3  MAKE H A TRK VALUE ONLY          04600000
         CLC   W1IDAD+6(1),DCBFIRSH+1   DOES SEEK H = FIRSH H           04620000
         STC   R5,W1IDAD+6             STORE BACK SAVED H               04640000
         BE    SISRAC3E                YES, NOT SPECIAL CASE            04660000
*                           NO, CONTINUE TESTING FOR SPECIAL CASE       04680000
         SR    R5,R5                    CLEAR WORK REG                  04700000
         IC    R5,W1IDAD+6              GET H OF IOB SEEK               04720000
         LA    R5,1(R5)                 ADD 1 TO H                      04740000
         CLI   DCBFIRSH+2,X'01'     ARE THERE ANY SHARED TRACKS         04760000
         BE    SISRAC3C                NO                               04780000
*                                       YES, SEARCH NEXT INDEX TRACK    04800000
SISRAC3D STC   R5,W1IDAD+6      ADD ONE TO HH OF IDAD                   04820000
         B     SISRAJ4          EXCP RETURN                             04840000
SISRAC3C IC    R8,W1IDAD+6             SAVE H                           04860000
         STC   R5,W1IDAD+6              STORE NEW H TO TEST             04880000
*                                       AGAINST FIRSH H                 04900000
         NC    W1IDAD+6(1),DCBFIRSH+3   AND MASK TO GET TRK VALUE       04920000
         CLC   W1IDAD+6(1),DCBFIRSH+1   DOES NEW H OF IDAD=FIRSH H      04940000
         STC   R8,W1IDAD+6             RESTORE H IN CASE COMP IS EQ     04960000
         BNE   SISRAC3D                 NO, SEARCH NEXT INDEX TRACK     04980000
         SPACE 2                                                        05000000
*        EITHER NOT SPECIAL CASE OR ALL INDEX TRACKS HAVE BEEN          05020000
*        UNSUCCESSFULLY SEARCHED                                        05040000
         SPACE 2                                                        05060000
*        IS IT PERMANENT ERROR                                          05080000
         SPACE                                                          05100000
SISRAC3E TM    W1ISENSE+2,X'3F'                                         05120000
         BO    SISRQH2A                NO                               05140000
*                                      YES                              05160000
         SPACE                                                          05180000
SISRAC3  L     R5,W1RD1ST(0)                                            05200000
SISRAC3A OI    CN2+K4,UNREACH          MARK BUF UNREACH.         S20201 05220020
         SPACE 2                                                        05240000
         TM    CN2+K4,OFLOW            IS THIS AN OVERFLOW REC   S20201 05260020
         BO    SISRAC3F                YES                              05280000
         CLC   CN5+K1(L3),CON000       NO, IS IT END OF READ Q   S20201 05300020
         BE    SISRQF2                 YES, TAKE NORMAL RETURN TO IOS   05320000
         CLI   CN5,TIC                  IS IT ATIC TO CP22       S20201 05326020
         BNE   SISRQF2                  NO - FINISHED            S20201 05332020
         L     R5,CN5                  GET NEXT CP ON Q          S20201 05342020
         B     SISRAC3A                 LOOP, MARKING ALL SUBSEQUENT    05360000
*                                       BUFFERS UNREACHABLE             05380000
         SPACE 2                                                        05400000
*        IF AN OVERFLOW RECORD IS UNREACHABLE IT IS IMPOSSIBLE TO       05420000
*        CONTINUE TO READ THE OVERFLOW CHAIN.  THE READ Q COUNT AND     05440000
*        RESIDUE FIELDS MUST BE RESET.                                  05460000
         SPACE                                                          05480000
SISRAC3F LH    R8,W1READR              LOAD COUNT                       05500000
         BCTR  R8,0                    REDUCE BY ONE                    05520000
         STH   R8,W1READR                                               05540000
         B     SISRQB5                                                  05560000
         EJECT                                                          05580000
SISCTRQ  EQU   *                                                        05600000
*                                     **************************        05620000
*                                     *                        *        05640000
*                                     * CHANNEL END APP READ Q *        05660000
*                                     *                        *        05680000
*                                     **************************        05700000
         SPACE 2                                                        05720000
*                                  ***** CONSTANTS *****                05740000
CON000   DC    X'000000'                3 BYTE CONSTANT OF ZERO         05760000
OFFSET4  EQU   4                        DISPLACEMENT FOR VECT. TABLE    05800000
SUB10    DC    H'10'                    * CONSTANT               S20201 05820020
         SPACE 2                                                        05840000
SISRQA30 EQU   *                        *                        S20201 05846020
*        BAL   R8,RPSPREFX              PSUEDO BRANCH AND LINK          05846100
         LA    R8,SISRQ30               RETURN ADDRESS           A48227 05846200
*   ROUTINE TO REMOVE RPS PREFIX AND SUFFIX FROM CHANNEL PROGRAM.       05846400
*                                                                       05846500
RPSPREFX EQU   *                        *                        A48227 05846600
         TM    DEBRPSID,RPS             SIO MODULE IN            M5092  05846820
         BCR   ONZERO,R8                NO - DON'T LINK TO SIO   A48227 05846900
*                                                                       05856902
*    PLACE TOTALS IN CP22'S AND UNLINK RPS PREFIXES AND SUFFIXES        05866902
*                                                                       05868902
         L     R5,W1ICPS                ADDRESS OF CP22          Y02072 05870902
         TM    CN1,SIDEQ                START AT SET SECTOR      Y02072 05871302
         BO    TTEXIT                   NO, NOT AN RPS REQUEST   Y02072 05871702
         L     R5,W1ICPTIC              ADDR OF FIRST CP22       Y02072 05872102
         ST    R5,W1ICPS                UNLINK PREFIX            Y02072 05872502
*                                                                       05872602
*    CHECK FOR EXISTANCE OF A CP 22                                     05872702
*                                                                       05872802
         CLI   W1ICPTIC,TIC+SW22        WHAT CP WAS SCHEDULED    Y02072 05877902
         BE    TT000                    BR IF CP22 ALONE         Y02072 05879902
         BL    TTEXIT                   BR IF CP23 OR CP25              05881902
         L     R5,W1CN15                CP24 CHAINED TO CP22     Y02072 05882302
*                                                                       05882702
*    CHECK FOR PRIME OR OVERFLOW - PRIME                                05883102
*                                                                       05883502
TT000    TM    CN2FLGS,OFLOW            OVERFLOW                 Y02072 05883602
         BO    TT005                    YES, HANDLE SEPARATELY   Y02072 05883702
*                                                                       05883802
*    CHECK FOR FIRST READ AFTER SETL                                    05884902
*                                                                       05886902
         LH    R3,W1TOTAL               PRIME TOTAL              Y02072 05887002
         LTR   R3,R3                    THIS FIRST GET           Y02072 05888202
         BNZ   TT001                    BR NO - SUM              Y02072 05890202
*                                                                       05890302
*    ESTIMATE THE RUNNING TOTAL                                         05890402
*                                                                       05890502
         IC    R3,CN6R                  RECORD NUMBER            Y02072 05891702
         BCTR  R3,0                     R-1                      Y02072 05893702
         MH    R3,W1RECLEN              (R-1)(MIN RCD LENGTH)    Y02072 05893802
         CLI   DCBHIRSH,ZERO            IS THERE A SHARED TRK    Y02072 05893902
         BE    TT001                    BR NO - GUESS GOOD       Y02072 05894002
         CLC   CN6HR(K1),DCBFIRSH+1     SHARED TRACK             Y02072 05895202
         BNE   TT001                    BR NO - GUESS GOOD       Y02072 05897202
*                                                                       05897302
*    SETL TO SHARED TRACK - MAKE CALCULATION FOR RUNNING TOTAL.         05897402
*                                                                       05897502
         SR    R3,R3                    ZERO                     Y02072 05897902
         IC    R3,CN6R                  RECORD NUMBER - R        Y02072 05898302
         SR    R9,R9                    ZERO                     Y02072 05898702
         IC    R9,DCBFIRSH+2            FIRST R ON CYL - S       Y02072 05899702
         SR    R3,R9                    R-S                      Y02072 05901702
         MH    R3,W1RECLEN              (R-S)*(RECORD LENGTH)    Y02072 05901802
         AH    R3,W1FSTSH               (R-S)*(RECORD LN)+TI     Y02072 05902302
*                                                                       05902702
*    TOTAL RECORDS                                                      05903102
*                                                                       05903202
TT001    CLI   CN6R,ONE                 IS IT RECORD ONE         Y02072 05903302
         BNE   TT002                    BR NO - DON'T RESET      Y02072 05903702
*                                               TOTAL TO ZERO    Y02072 05904502
         SR    R3,R3                    YES, ZERO REG            Y02072 05906502
         B     TT003                    CONTINUE                 Y02072 05906902
TT002    CLI   DCBHIRSH,ZERO            IS THERE A SHARED TRACK  Y02072 05907302
         BE    TT003                    BR NO - DON'T RESET      Y02072 05907702
         CLC   CN6HR(L'DCBFIRSH-1),DCBFIRSH+1 FIRST SHARED TRACK Y02072 05908102
         BNE   TT003                    BR NO - DON'T RESET      Y02072 05908902
         LH    R3,W1FSTSH               RESET                    Y02072 05909302
*                                                                       05909702
*    STORE TOTAL IN CURRENT CHANNEL PROGRAM                             05910102
*                                                                       05910202
TT003    STH   R3,CN2CNT                SAVE FOR PUTX            Y02072 05910302
*                                                                       05910402
*    ADD LENGTH OF CURRENT RECORD                                       05910502
*                                                                       05911402
         AH    R3,CN3KEY                ADD KEY LENGTH           Y02072 05913402
         LH    R9,CN4DL                 DATA LENGTH, FIXED       Y02072 05913502
         TM    DCBRECFM,FIXED           IS IT FIXED FORMAT       Y02072 05913602
         BO    TT004                    BR YES - LENGTH RIGHT    Y02072 05913902
         L     R9,CN4                   NO - VARIABLE LENGTH     Y02072 05914302
         LH    R9,0(R9)                 LENGTH FROM THE BDW      Y02072 05914402
TT004    AR    R3,R9                    ADD DATA LENGTH          Y02072 05914602
         STH   R3,W1TOTAL               SAVE                            05915002
         TM    CN4FLGS,CC               IS CCW CHAINED           Y02072 05915502
         BZ    TTEXIT                   BR NO - FINISHED         Y02072 05915902
         LR    R9,R5                    SAVE ADDR LAST CP        Y02072 05916302
         L     R5,CN5                   ADDRESS OF NEXT CP       Y02072 05916402
         DROP  R5                       END CP USING             Y02072 05916502
         USING SISCP22,R9               ADDR ON PREV CP          Y02072 05916702
         TM    CN5,MT                   IS IT CHAINED TO SUFFIX  Y02072 05916802
         BZ    TT001                    BR NO - CONTINUE         Y02072 05916902
         MVC   CN5(L'W1CN5SAV),W1CN5SAV RESTORE NEXT COPY CP22   Y02072 05917002
         LR    R5,R9                    RESTORE BASE             Y02072 05917202
         B     TTEXITA                  FINISHED                 Y02072 05917302
*                                                                       05917402
*    RESTORE OVERFLOW CHAIN                                             05917502
*                                                                       05917602
         DROP  R9                       ESTABLISH ADDR ON        Y02072 05917702
         USING SISCP22,R5               CP22                     Y02072 05917802
TT005    MVC   CN5(L'W1CN5SAV),W1CN5SAV RESTORE CP CHAIN         Y02072 05920802
         L     R3,W1CN5SAV              CHAIN POINTER           YM01101 05922802
         LA    R3,0(R3)                 CLEAR HIGH BYTE         YM01101 05923202
         LTR   R3,R3                    IS IT CHAINED           YM01101 05923602
         BNZ   TTEXIT                   BR YES - DON'T RESET CC  Y02072 05923702
TTEXITA  NI    CN4FLGS,ONES-CC          UNCHAIN CP22             Y02072 05923802
TTEXIT   EQU   *                        DONE                            05923902
*                                                                       05924102
         L     R3,RQEDEB                RESTORE DEB PTR          Y02072 05924702
         USING SISDEB,R3                ADDRESSABILITY ON DEB    A48227 05927002
         BR    R8                       RETURN                   A48227 05930002
         USING SISRQA3,R15              ADDRESSABILITY                  05933002
         USING SISCP22,R5               ADDRESSABILITY CP22             05936002
SISRQ30  EQU   *                        *                        M5092  05939002
*   IOB MAY POINT TO RPS CP EXTENSION, CORRECT PTR IF IT DOES           05942002
         L     R5,W1ICPS                PT TO FIRST CCW          S20201 05945002
SISRQB3  TM    CN2+K4,OFLOW             OVERFLOW MODE            S20201 05948002
         BO    SISRQC3                  BRANCH IF YES                   05951002
         TM    W1STATUS,X'01'           END OF FILE                     05954002
         BZ    SISRQF2                  BRANCH IF NO                    05957002
*                                       YES                             05960000
         SPACE 1                                                        05970002
*                                       SET END OF DATA BIT ON  YM03876 05972002
SISRQE2  OIL   W1OSBIT1,EODBIT,REF=W1OSBIT1,WREGS=(R8,R10,R11)  YM03876 05980002
         SPACE 2                                                        05990002
*                                       SET IOBI COMPLETE BIT   YM03876 05992002
SISRQF2  OIL   W1OSBIT1,IOBIC,REF=W1OSBIT1,WREGS=(R8,R10,R11)   YM03876 06000002
         SPACE 2                                                        06010002
SISRQG2  NI    W1IF1,X'FB'              SET IOBI EXCEPT BIT TO 0        06020000
SISRQH2A EQU   *                                                 Y02072 06040002
         LA    R10,NORMAL               LOAD IOS RET ADDR OFST   Y02072 06060002
         BR    R14                      RETURN TO IOS VIA EXIT   Y02072 06080002
*                                       ROUTINE IN IGG019HG             06090002
         SPACE 3                                                        06100000
*OVERFLOW CHAIN PROCESSING                                              06120000
         SPACE 2                                                        06140000
SISRQC3  LH    R8,W1READR               LOAD COUNT                      06160000
         BCTR  R8,0                                                     06180000
         STH   R8,W1READR(0)            SET R =R-1                      06200000
SISRQB4  L     R10,CN7                 LOD R10 WITH BUF ADDRESS  S20201 06220020
         SH    R10,SUB10               GET LINK FIELD OF OVERFLOW REC.  06240000
         MVC   W1WOVFL(10),0(R10)      MOVE LINK TO INDEX AREA          06260000
         TM    7(R10),X'FF'   IS IT END OF OVERFLOW CHAIN. DOES R=255   06280000
         BO    SISRQB5                 YES,ALL OVERFLOW RCDS WERE READ  06300000
*                                       NO, STILL SOME IN CHAIN         06320000
SISRQC4  CLC   CN5+K1(L3),CON000       ARE WE AT END OF READ Q   S20201 06340020
         BE    SISRQF2                 YES                              06360000
         CLI   CN5,TIC                  IS IT ATIC TO CP22       S20201 06366020
         BNE   SISRQF2                  NO - FINISHED            S20201 06372020
*                                       NO, SET UP TO READ NEXT RECORD  06380000
SISRQD4  L     R5,CN5                  LOD ADD OF NEXT CP TO R5  S20201 06400020
         NI    CN1,X'FF'-MT            SET MT BIT OFF            S20201 06420020
         NI    CN4+K4,X'FF'-CC         SET CC BIT OFF            S20201 06440020
         NI    CN2+K4,DATA             SET OFF ALL FLAGS BUT     S20201 06450020
*                                       D/KD                     S20201 06460020
         OI    CN2+K4,OFLOW            SET ON OFLOW INDIC. IN CP S20201 06480020
SISRQE4  ST    R5,W1ICPS               SET ICPS TO CN1 OF NEXT CP       06500000
SISRQF4  MVC   W1IDAD,0(R10)           SET TO MBBCCHHR OF LINK   S20201 06520020
         MVC   CN6,W1IDAD              SET CN6 OF NEXT CP        S20201 06540020
         SPACE 2                                                        06560000
*  IS OVERFLOW RECORD ON SAME DEVICE                                    06580000
         SPACE                                                          06600000
         SR    R8,R8                   CLEAR WORK REG                   06620000
         IC    R8,0(R10)               GET M OF OVERFLOW                06640000
         SLL   R8,4                    M X 16                           06660000
         L     R11,DEBUCBAD(R8)        GET UCB ADDR              S20201 06680020
         LA    R11,0(R11)               CLEAR HIGH ORDER BYTE           06700000
         LA    R7,0(R7)                    OF REGS                      06720000
         CR    R7,R11                   SAVE DEVICE                     06740000
         BE    SISRAJ4                  YES BRANCH                      06760000
         SPACE 2                                                        06780000
*  USE ASYNCHRONOUS ROUTINE TO READ NEXT OVERFLOW RECORD                06800000
         SPACE                                                          06820000
         B     ASYNCH(,R14)             BR TO EXIT ROUTINE IN    Y02072 06840002
*                                       IGG019HG                        06890002
         SPACE 2                                                        06960000
*  END OF OVERFLOW CHAIN                                                06980000
         SPACE                                                          07000000
*                                       SET OFF OVRFLW MODE IND YM03876 07010002
SISRQB5  NIL   W1OSBIT1,OFFOVFL,REF=W1OSBIT1,WREGS=(R8,R10,R11) YM03876 07020002
         LH    R8,W1READC                                               07040000
         SH    R8,W1READR                                               07060000
         STH   R8,W1READC                   SET C EQUAL TO C-R          07080000
         CLC   W1LPDR(1),DCBLPDA                                        07090013
         BNE   SISRQF2                  IF EXTENTS NE,NOT DATA END      07100013
         CLC   W1LPDR+3(5),DCBLPDA+3                                    07110013
         BNE   SISRQF2                  NO, NORMAL CASE                 07120000
*                                       YES                             07140000
         OI    CN2+K4,EOD               MARK BUFFER AS EOD       S20201 07150020
*                                       BUFFER                   S20201 07160020
*                                       OVERFLOW CHAIN BEING READ IS AT 07180000
*                                       END OF DATA SET                 07200000
         OI    W1WOVFL+8,X'08'          SET OVERFLOW CHAINED IND ON     07220000
*                                       TESTED IN EOB ROUTINE TO KEEP   07240000
*                                       PROCESSING LAST OVERFLOW CHAIN  07260000
         B     SISRQE2                                                  07280000
APPCODE  EQU   40                                                       07300000
OFLOW    EQU   X'40'                    OVERFLOW RECORD          S20201 07303020
DATA     EQU   X'20'                    DATA/KEY DATA SWITCH     S20201 07306020
EOD      EQU   X'10'                    END OF DATA              S20201 07309020
UNREAD   EQU   X'08'                    UNREADABLE BLOCK         S20201 07312020
UNREACH  EQU   X'02'                    UNREACHABLE BLOCK        S20201 07315020
KEY0     EQU   CON000                   STORAGE PROTECT KEY ZERO Y02072 07315402
EODBIT   EQU   X'40'                    SET EOD BIT ON          YM03876 07315502
IOBIC    EQU   X'02'                    SET IOBI COMP. BIT ON   YM03876 07315602
OFFOVFL  EQU   X'DF'                    TURN OFF OVRFLOW IND.   YM03876 07315702
*                                                                       07315802
PATCH    DC    XL((*-IGG019HG)/20)'00'  ZEROED PATCH AREA       YM03876 07316202
*                                                                       07316602
         EJECT                                                          07317002
         IHAECB                                                         07317137
         EJECT                                                          07317237
         IECDRQE                                                        07317402
         EJECT                                                          07317802
CVT      DSECT                                                          07318202
         CVT                                                            07318602
         SPACE 3                                                        07318702
REGSAVE  DSECT                          REG SAVE AREA FROM IOS   Y02072 07319002
REGSAV0  DS    F                        REGISTER 0               Y02072 07386602
REGSAV1  DS    F                        REGISTER 1               Y02072 07388602
REGSAV2  DS    F                        REGISTER 2               Y02072 07390602
REGSAV3  DS    F                        REGISTER 3               Y02072 07392602
REGSAV4  DS    F                        REGISTER 4               Y02072 07394602
REGSAV5  DS    F                        REGISTER 5               Y02072 07395002
REGSAV6  DS    F                        REGISTER 6               Y02072 07395402
REGSAV7  DS    F                        REGISTER 7               Y02072 07395802
REGSAV8  DS    F                        REGISTER 8               Y02072 07396202
REGSAV9  DS    F                        REGISTER 9               Y02072 07396302
REGSAV10 DS    F                        REGISTER 10              Y02072 07396602
REGSAV11 DS    F                        REGISTER 11              Y02072 07406602
REGSAV12 DS    F                        REGISTER 12              Y02072 07408602
REGSAV13 DS    F                        REGISTER 13              Y02072 07410602
REGSAV14 DS    F                        REGISTER 14              Y02072 07412602
REGSAV15 DS    F                        REGISTER 15              Y02079 07413002
         EJECT                                                          07460000
SISDEB   IGGDEBD                                                        07490020
         EJECT                                                          08220000
SISCP22  DSECT                                                          08240000
         IGGCP22                                                        08250020
SISWORK1 IGGSCAN                                                        08360020
         EJECT                                                          10940000
         DCBD  DSORG=(IS)                                               10960000
         END                                                            10980000
