 TITLE 'IGG019HI -WRITE CHECK APPENDAGE'                                00020000
IGG019HI CSECT                                                          00025000
*          RELEASE OS/VS2-02 DELETIONS                                  00035002
*                                                               YM03876 00037002
*          RELEASE 19 DELETIONS                                         00045000
*          RELEASE 20 DELETIONS                                         00050000
*2774017400,023000,023200,023400,026200,026600,026800,028400,    S20201 00050420
*2774028600,028800,029400,029800,030800,031400,031600,031800,    S20201 00050820
*2774033000,041400,041600,041800,042200,042400,042800,043000,    S20201 00051220
*2774043200,043600,043800,045000,045200,045400,045600,045800,    S20201 00051620
*2774046800,047000,047200,047400,047600,049200,051400-051600,    S20201 00052020
*2774055000,055800,057000,057800,058000,058600,059000,059200,    S20201 00052420
*2774059600,061800,062000,063000,063800,064200,065400,065800,    S20201 00052820
*2774066000,066400,066800,067000,067900,068800,069000,069400,    S20201 00053220
*2774069800,070000,075200,076000,076400,077200,077600,078000,    S20201 00053620
*2774078200,078600,080600,083800-084000,084200-091000,091400-    S20201 00054020
*2774091600,091800-118000                                        S20201 00054420
*          RELEASE 21 DELETIONS                                         00055000
*                                                                S21045 00057021
*                                                                       00060002
*STATUS CHANGE LEVEL 005                                                00080002
*                                                                       00085000
*FUNCTION/OPERATION-                                                    00100000
*   WRITE CHECKING IS DONE A SET AT A TIME. A SET IS DEFINED AS A     * 00120000
*   PORTION OF THE WRITE Q THAT IS COMMAND CHAINED TOGETHER.THE NUMBER* 00140000
*   OF CHANNEL PROGRAMS PER SET VARIES WITH THE TYPE OF RECORD BEING  * 00160000
*   PROCESSED. GENERALLY, THE FIRST SET IS WRITTEN AND THEN CHECKED   * 00180000
*   (READ BACK) BEFORE THE NEXT SET IS WRITTEN. IF A RECORD FAILS THE * 00200000
*   CHECK, IT IS REWRITTEN AND RECHECKED ONCE,                    17516 00220000
*   AFTER WHICH IT IS MARKED UNWRITEABLE. IF A RECORD COULD NOT BE    * 00240000
*   INITIALLY WRITTEN, NO ATTEMPT IS MADE TO REWRITE OR RECHECK IT.   * 00260000
*                                                                     * 00280000
*   WHEN A CHANNEL END COMPLETION RESULTS FROM WRITING A WRITE Q SET, * 00300000
*   THE CCW'S OF THE CHANNEL PROGRAMS ARE SET TO READ(CHECK). IF A    * 00320000
*   CHANNEL END COMPLETION RESULTS FROM THE CHECK, WRITE CHECKING FOR * 00340000
*   THIS SET WAS SUCCESSFUL.THE NEXT SET(IF ANY) IS THEN WRITTEN.     * 00360000
*                                                                     * 00380000
*   IF THE INITIAL WRITE WAS SUCCESSFUL BUT AN ABNORMAL END COMPLETION* 00400000
*   RESULTED ON THE CHECK, THAT RECORD IS REWRITTEN AND RECHECKED     * 00420000
*   ONCE.  IF IT STILL CANNOT BE WRITTEN, THE RECORD IS TAGGED    17516 00440000
*   UNWRITEABLE AND THE USER IS TOLD OF THIS WHEN HE ISSUES A GET. IF,* 00460000
*   DURING THE AFOREMENTIONED REWRITE RECHECK LOOP, ABNORMAL END      * 00480000
*   RESULTS ON THE REWRITE,THE RECORD IS MARKED,AND THE NEXT ELEMENT  * 00500000
*   OF THE SET(IF ANY) IS CHECKED (READ).IF IT WAS THE LAST ITEM OF   * 00520000
*   THE SET, THE NEXT WRITE Q SET(IF ANY) WILL BE WRITTEN.            * 00540000
*                                                                     * 00560000
*   IF ABNORMAL END COMPLETION RESULTS FROM THE ORIGINAL WRITE, THAT  * 00580000
*   PARTICULAR RECORD IS MARKED UNREACHABLE OR UNWRITEABLE(WHICHEVER  * 00600000
*   IT MAY BE). WRITING CONTINUES UNTIL IT IS END OF SET.THE          * 00620000
*   SUBSEQUENT CHECK IS DONE ONLY FOR THOSE UNMARKED RECORDS.         * 00640000
*                                                                     * 00660000
*ENTRY POINTS- THE APPENDAGE VECTOR TABLE ADDRESSES THE VARIOUS ENTRY * 00680000
*   POINTS TO MODULE 'IGG019HI'. THE SPECIFIC POINTS OF ENTRY ARE-    * 00700000
*        SISK1B1 - CHANNEL END ON A WRITE                             * 00720000
*        SISK0A3 - CHANNEL END ON A CHECK                             * 00740000
*        SISK1C2 - CHANNEL END ON A REWRITE                           * 00760000
*        SISK4G3 - CHANNEL END ON A RECHECK                           * 00780000
*                                                                     * 00800000
*        SISK2B2 - ABNORMAL END ON A WRITE                            * 00820000
*        SISK3B2 - ABNORMAL END ON A CHECK                            * 00840000
*        SISK4B2 - ABNORMAL END ON A REWRITE                          * 00860000
*        SISK3G4 - ABNORMAL END ON A RECHECK                          * 00880000
*                                                                     * 00900000
*INPUT- REGISTER 1- 12* ADDRESS                                       * 00920000
*       REGISTER 2- IOB ADDRESS                                       * 00940000
*       REGISTER 3- DEB ADDRESS                                       * 00960000
*       REGISTER 4- DCB ADDRESS                                       * 00980000
*       REGISTER 6 - BASE FOR REGISTER SAVE AREA                      * 00990002
*       REGISTER 7- UCB ADDRESS                                       * 01000000
*       REGISTER 12- WORK AREA ADDRESS                                * 01020000
*       REGISTER 14- RETURN TO IOS VIA IGG019HG                       * 01040002
*       REGISTER 15- MODULE BASE                                      * 01060000
*                                                                     * 01080000
*OUTPUT- SAME AS FOR INPUT                                            * 01100000
*                                                                     * 01120000
*EXTERNAL ROUTINES- N/A                                               * 01140000
*                                                                     * 01160000
*EXITS- NORMAL- RETURN TO IOS THROUGH IGG019HG                        * 01180002
*   ERROR-N/A                                                         * 01200000
*                                                                     * 01220000
*TABLES/WORK AREAS- DATA EXTENT BLOCK(DEB) DESCRIBED BY SISDEB DSECT  * 01240000
*   WORKAREA DESCRIBED BY SISWORK1 DSECT                              * 01260000
*   DATA CONTROL BLOCK DESCRIBED BY IHADCB DSECT                      * 01280000
*                                                                     * 01300000
*ATTRIBUTES- REENTRANT, READ ONLY                                     * 01320000
*                                                                     * 01340000
*NOTES- REGISTER USAGE IS CONSISTENT IN ALL SCAN MODE                 * 01360000
*   APPENDAGE MODULES                                                 * 01380000
         EJECT                                                          01400000
R0       EQU   0                                                        01420000
R1       EQU   1                                                        01440000
R2       EQU   2                                                        01460000
R3       EQU   3                                                        01480000
R4       EQU   4                                                        01500000
R5       EQU   5                                                        01520000
R6       EQU   6                                                        01540000
R7       EQU   7                                                        01560000
R8       EQU   8                                                        01580000
R9       EQU   9                                                        01600000
R10      EQU   10                                                       01620000
R11      EQU   11                                                       01640000
R12      EQU   12                                                       01660000
R13      EQU   13                                                       01680000
R14      EQU   14                                                       01700000
R15      EQU   15                                                       01720000
NORMAL   EQU   0                                                  15924 01725016
ASYNCH   EQU   4                        BRANCH OFFSET TO ASYNCH  Y02072 01727002
*                                       SCHEDULING ROUTINE IN IGG019HG  01729002
EXCP     EQU   8                                                  15924 01730016
BYPASS   EQU   12                                                 15924 01735016
UNWRITE  EQU   X'04'                    UNWRITABLE RECORD        S20201 01735720
UNREACH  EQU   X'02'                    UNREACHABLE BLOCK        S20201 01736420
CCSTORE  EQU   X'01'                    REMEMBER CC BIT          S20201 01737120
K5       EQU   5                        CONSTANT                 S20201 01737820
K4       EQU   4                        CONSTANT                 S20201 01738520
K1       EQU   1                        CONSTANT                 S20201 01739220
L3       EQU   3                        LENGTH                   S20201 01741220
L1       EQU   1                        CONSTANT                 S20201 01743220
L4       EQU   4                        LENGTH                   S20201 01745220
L8       EQU   8                        LENGTH                   S20201 01747220
BADDSET  EQU   X'20'                    BAD DATA SET INDICATOR  YM03876 01747602
IOBOC    EQU   X'01'                    OUTPUT IOB COMPLETE BIT YM03876 01748002
WQERR    EQU   X'80'                    BAD WRITE BIT           YM03876 01748402
WAPBIT   EQU   X'40'                    WRITE APPEND WORK BIT   YM03876 01748802
ONES     EQU   X'FF'                    MASK OF ALL ONES        YM03876 01748902
         SPACE 4                                                        01749202
         USING IHADCB,R4                                         S20201 01751220
         USING SISDEB,R3                                                01760000
         USING SISWORK1,R12                                             01780000
         USING SISCP22,R5                                        S20201 01800020
         USING *,R15                                                    01820000
         EJECT                                                          01840000
         DS    0F                                                     * 01860000
*                                     ************************          01880000
*                                     *                      *          01900000
*                                     *  CHAN END APP CODE C *          01920000
*                                     *                      *          01940000
*                                     ************************          01960000
SISCTK0  DC    A(SISK1B1-SISCTK0)      APP CODE = 8  CE WRITE           01980000
         DC    A(SISK0A3-SISCTK0)      APP CODE =C CE CHECK             02000000
         DC    A(SISK1C2-SISCTK0)      APP CODE = 10  CE REWRITE        02020000
         DC    A(SISK4G3-SISCTK0)      APP CODE = 14  CE RECHECK        02040000
         SPACE 2                                                        02060000
         DC    A(SISK2B2-SISCTK0)      APP CODE = 8  AB END WRITE       02080000
         DC    A(SISK3B2-SISCTK0)      APP CODE = C  AB END CHECK       02100000
         DC    A(SISK4B2-SISCTK0)      APP CODE = 10 AB END REWRITE     02120000
         DC    A(SISK3G4-SISCTK0)      APP CODE = 14 AB END RECHECK     02140000
         SPACE 4                                                        02160002
         USING *,R15                                                    02200000
SISK1B1  B     SISK1B10                 FOR SETTING BASE                02220000
         SPACE 2                                                        02240000
*                                  ***** CONSTANTS *****                02260000
CON3ZERO DC    X'000000'                3 BYTES OF ZERO                 02280000
         DS    0H                                                S20201 02300020
CONO16   DC    AL2(CN3-CN1)             LENGTH RKP=0,UNBLOCKED   S20201 02320020
CON32    DC    AL2(CN5-CN1)             LENGTH OTHERWISE         S20201 02340020
TABOFF4  EQU   4                        OFFSET FOR EXIT EFFECTOR TABLE  02360000
SIXTEEN  EQU   16                       COMMUNICATION VECTOR TABLE      02380000
         SPACE 5                                                        02400000
*  ENTRY POINT CHANNEL END ON CHECK                                     02420000
         SPACE 2                                                        02440000
SISK0A3  TM    W1OSBIT3,X'20'          ANY ERRORS IN THIS SET           02460000
         BZ    SISK0A2                 NO                               02480000
         SPACE                                                          02500000
*                                      WHEN A SET HAS ERRORS THE CHECK  02520000
*                                      IS DONE 1 BUFFER AT A TIME       02540000
         SPACE                                                          02560000
         L     R5,W1COMADO             COMADO MUST POINT TO CN5--C.E.   02580000
         SH    R5,CON32                BRING R5 TO CN1                  02600000
         TM    CN2+K5,CC               SAVE CC BIT ON            S20201 02620020
         BZ    SISK0A2                 NO                               02640000
         OI    CN4+K4,CC               SET CN4 CC BIT BACK ON    S20201 02660020
SISK0A3A L     R5,CN5                  GET NEXT CP ADDR          S20201 02680020
         B     SISK1G4                 GO TO CHECK NEXT CP              02700000
         SPACE 2                                                        02710002
*        THE CC BIT IS SET BACK ON IF THIS CHAN PROG PASSED THE CHECK   02720000
*   AND WAS NOT THE LAST ONE OF THE SET IN ERROR.                       02740000
         SPACE 3                                                        02760000
*  END OF SET, RESET SKIP BITS                                          02780000
         SPACE                                                          02800000
SISK0A2  L     R5,W1FCPS                POINT TO CP1 OF SET             02820000
SISK0B2  NI    CN3+K4,X'FF'-SKIP       SET OFF SKIP BIT IN CN3   S20201 02840020
         NI    CN4+K4,X'FF'-SKIP       SET OFF SKIP BIT IN CN4   S20201 02860020
         TM    CN4+K4,CC               LAST CP OF SET            S20201 02880020
         BZ    SISK0C2                 YES                              02900000
*                                      NO                               02920000
         L     R5,CN5                  GET NEXT CHAN PROG ADDR   S20201 02940020
         B     SISK0B2                 CHANGE NEXT CHANNEL PROGRAM      02960000
SISK0C2  CLC   CON3ZERO,CN5+K1          LAST SET ON WRITE Q      S20201 02980020
SISK0D2  BE    SISK0D1                  YES                             03000000
         SPACE 2                                                        03020000
*        NOT LAST SET, WRITE NEXT SET                                   03040000
         SPACE 2                                                        03060000
SISK0D3  MVC   W1FCPS+K1(L3),CN5+K1    SAVE CHAIN ADD IN FCPS    S20201 03080020
SISK0D4  MVI   W1OEXTEN+1,X'08'        SET APP CODE TO WRITE            03100000
         SPACE 2                                                        03110002
         NIL   W1OSBIT3,ONES-BADDSET,REF=W1OSBIT1, SET OFF BAD  YM03876X03120002
               WREGS=(R9,R10,R13)       DATA SET INDICATOR      YM03876 03130002
         SPACE 2                                                        03132002
SISK0E3  MVC   W1OCPS+1(3),CN5+1       SET OCPS TO NEXT CP       S20201 03140020
         L     R5,CN5                  LOAD CN1 OF NEXT SET      S20201 03160020
SISK0F3  MVC   W1ODAD,CN6              SET IOBO TO NEXT CP CN6   S20201 03180020
         SPACE 2                                                        03200000
*        IS NEXT SET ON SAME DEVICE                                     03220000
         SPACE 2                                                        03240000
SISK0G3  LA    R11,DEBNIEE             LOAD R11 WITH M=0 ADDRESS        03260000
         SR    R8,R8                   CLEAR WORK REG                   03280000
         IC    R8,CN6                  M FROM CN6                S20201 03300020
         SLL   R8,4                    M X 16                           03320000
         ALR   R11,R8                  GET ADDR OF M EXTENT             03340000
         L     R11,0(R11)               GET UCB ADDR                    03360000
         LA    R11,0(R11)              CLEAR HIGH ORDER BYTE            03380000
         LA    R7,0(R7)                    OF REGS                      03400000
         CR    R7,R11                  IS IT SAME DEVICE                03420000
         BE    SISK1G3                 YES, TAKE EXCP RETURN            03440000
SISSK0H3 EQU   *                                                 Y02072 03460002
         B     ASYNCH(,R14)             BRANCH TO EXIT ROUTINE   Y02072 03480002
*                                       IN IGG019HG                     03530002
         SPACE 3                                                        03580000
*        ALL BUFFERS WRITTEN AND CHECKED                                03600000
         SPACE 2                                                        03620000
SISK0D1  OIL   W1OSBIT1,IOBOC,REF=W1OSBIT1, SET ON OUTPUT IOB   YM03876X03640002
               WREGS=(R9,R10,R13)       COMPLETION BIT          YM03876 03650002
         SPACE 2                                                        03652002
         NIL   W1OSBIT3,ONES-BADDSET,REF=W1OSBIT1,  SET OFF BAD YM03876X03660002
               WREGS=(R9,R10,R13)       DATA SET INDICATOR      YM03876 03662002
         SPACE 2                                                        03670002
SISK0E1  TM    W1OSBIT2,X'40'      WRITE Q WORK BIT ON  (BIT9 OF OSB)   03680000
         BO    SISK0E1A            YES                                  03700000
SISK0F1  EQU   *                                                 Y02072 03720002
         LA    R10,NORMAL               LOAD IOS RET ADDR OFST   Y02072 03740002
         BR    R14                      RETURN TO IOS VIA EXIT   Y02072 03750002
*                                       ROUTINE IN IGG019HG             03760002
         SPACE 2                                                        03770002
SISK0E1A OIL   W1OSBIT2,WQERR,REF=W1OSBIT1, SET ON BAD          YM03876X03780002
               WREGS=(R9,R10,R13)       WRITE QUEUE BIT         YM03876 03790002
         SPACE 2                                                        03792002
         NIL   W1OSBIT2,ONES-WAPBIT,REF=W1OSBIT1, SET OFF WRITE YM03876X03800002
               WREGS=(R9,R10,R13)       Q WORK BIT              YM03876 03810002
         SPACE 2                                                        03812002
         B     SISK0F1                  TAKE NORMAL RETURN TO IOS       03820000
         EJECT                                                          03840000
SISCTK1  EQU   *                                                        03860000
*                                     ******************************    03880000
*                                     *                            *    03900000
*                                     *  CHAN END APP CODES 8, 10  *    03920000
*                                     *                            *    03940000
*                                     ******************************    03960000
         SPACE 2                                                        03980000
* ENTRY POINT CHANNEL END ON WRITE                                      04000000
         SPACE 2                                                        04020000
SISK1B10 MVI   W1OEXTEN+1,X'0C'        SET APP. CODE TO C-CHECK         04040000
SISK1B2  MVC   W1OCPS,W1FCPS            SET CHAN PROG POINTER TO FCPS   04060000
SISK1B3  L     R5,W1FCPS               SET R5 TO FCPS                   04080000
         TM    W1OSBIT3,X'20'          ANY BAD WRITES ON THIS SET       04100000
         BO    SISK1G4                 YES                              04120000
SISK1B4  NI    CN1,X'FF'-MT            SET OFF MT BIT IN THIS CP S20201 04140020
SISK1C3  OI    CN4+K4,SKIP             SET ON SKIP BITS IN CN4   S20201 04160020
SISK1D3  CLI   CN3,TIC                 DOES CN3 = TIC            S20201 04180020
         BE    SISK1E3                 YES, USING CP22B                 04200000
SISK1D2  OI    CN3+K4,SKIP             NO, SET SKIP IN CN3(22A)  S20201 04220020
SISK1E2  MVI   CN3,RKD                 SET CN3 TO READ KD        S20201 04240020
         B     SISK1F3                                                  04260000
SISK1E3  MVI   CN4,RDATA               SET CN4 TO RD DATA--22B   S20201 04280020
SISK1F3  TM    CN4+K4,CC               IS CC BIT OF CN4 ON       S20201 04300020
         BZ    SISK1G3                 OFF, END OF THIS SET      S20201 04320020
*                                      ON, NOT END OF SET               04340000
SISK1F4  L     R5,CN5                   GET ADDR OF NEXT CP      S20201 04360020
         B     SISK1C3                  GO BACK FOR NEXT CP      S20201 04380020
         SPACE 3                                                        04400000
*        SINCE AT LEAST 1 BUFFER OF THIS SET HAD AN ERROR, THE CHECKING 04420000
*        IS DONE 1 AT A TIME.  THE BUFFER IN ERROR CANT BE CHECKED      04440000
*        BECAUSE THE CN6 HAS BEEN USED TO STORE IO STATUS INFORMATION   04460000
         SPACE 2                                                        04480000
SISK1G4  TM    CN2+K4,UNWRITE+UNREACH   WAS CP IN ERROR          S20201 04500020
         BM    SISK1G5                  YES                      S20201 04520020
*                                       NO, CHECK IT                    04540020
SISK1G4A MVC   CN2+K5(L1),CN4+K4        SAVE CN4 CC BIT IN CN2   S20201 04560020
         NI    CN4+K4,X'FF'-CC          SET OFF CC BIT IN CN4    S20201 04580020
         B     SISK1B4                  GO TO SET CCWS FOR CHECKING     04600000
         SPACE 2                                                        04620000
* BAD BUFFER                                                            04640000
         SPACE                                                          04660000
SISK1G5  TM    CN4+K4,CC                END OF SET               S20201 04680020
         BZ    SISK0C2                  YES, GO WRITE NEXT SET   S20201 04700020
         L     R5,CN5                   GET NEXT CP ADDR         S20201 04720020
         ST    R5,W1OCPS                SET OCPS TO NEXT CP      S20201 04740020
         MVC   W1ODAD,CN6               SET IOB SEEK TO CN6      S20201 04760020
         B     SISK1G4                  LOOP BACK TO TEST THIS CP       04780000
         SPACE 3                                                        04800000
SISK1G3  EQU   *                                                 Y02072 04820002
         NI    W1OF1,X'FA'                                              04860000
         MVI   W1OF2,X'00'             RE_INITIALIZATION                04880000
         MVI   W1OCSW,X'00'            FOR EXCP RETURN                  04900000
         MVC   W1OERRCT,CON3ZERO                                 S20201 04920020
         SR    R13,R13                 CLEAR WORK REGISTER              04940000
         IC    R13,W1OMBBCC            R13=000M                         04960000
         SLL   R13,4                   M X 16                           04980000
         LA    R13,32(R3,R13)          R13 POINTS TO EXTENT OF M        05000000
         MVC   W1OMBBCC+1(2),4(R13)    MOVE BB FROM DSB INTO IOBO       05020000
         XC    W1IF2(3),W1IF2           CLEAR FLAG2,SENSE BYTES   15924 05026016
         XC    W1ICSW(9),W1ICSW         CLEAR FLAG3,CSW,SIOCC     15924 05032016
         XC    W1IERRCT(2),W1IERRCT     CLEAR ERROR COUNT         15924 05038016
         NI    W1IF1,X'C2'              RESET FLAG1               15924 05044016
SISK1G3A EQU   *                                                 Y02072 05050002
         LA    R10,EXCP                 LOAD IOS RET ADDR OFST   Y02072 05052002
         BR    R14                      RETURN TO IOS VIA EXIT   Y02072 05054002
*                                       ROUTINE IN IGG019HG             05056002
         SPACE 2                                                        05060000
* ENTRY POINT CHANNEL END  ON REWRITE                                   05080000
         SPACE 2                                                        05100000
SISK1C2  MVI   W1OEXTEN+1,X'14'        SET APP CODE TO RECHECK          05120000
         L     R5,W1WR1ST               PT TO FIRST WRITE        S20201 05130020
         B     SISK1B4                  CHANGE CCWS FOR          S20201 05140020
*                                       RECHECKING               S20201 05150020
         EJECT                                                          05180000
SISCTK2  EQU   *                                                        05200000
*                                     ***************************       05220000
*                                     *                         *       05240000
*                                     *  ABNORMAL END APP CODE 8*       05260000
*                                     *                         *       05280000
*                                     ***************************       05300000
         SPACE 2                                                        05320000
* ENTRY POINT ABNORMAL END ON WRITE                                     05340000
         SPACE 2                                                        05360000
SISK2B2  TM    W1OSENSE+2,X'3F'     PERM ERROR                          05380000
         BO    SISK0F1                  NO                              05400000
*                                                                       05410002
*        THE FOLLOWING LOGIC ISOLATES THE CCW OF THE CP IN ERROR        05420000
*        IT TAGS THE BUFFER ACCORDINGLY.                                05440000
*                                                                       05450002
SISK2C2  L     R5,W1COMADO             LOAD ERROR CCW+8 TO R5           05460000
         LA    R5,0(R5)                CLEAR HIGH ORDER BYTE    SA66577 05470002
         SH    R5,EIGHT                BRING R5 TO ERROR CCW            05480000
         L     R10,W1OCPS              ADDR FIRST CCW IN CP     SA66577 05482002
         LA    R10,0(R10)              CLEAR HIGH ORDER BYTE    SA66577 05484002
         CR    R5,R12                  ERROR CCW ADDR BELOW     SA66577 05484402
*                                      SCAN WORK AREA ADDRESS   SA66577 05484802
         BL    SISK2D2                 BR YES-ERROR IN IOS CCW  SA66577 05485202
         CR    R5,R10                  ERROR CCW FIRST IN CP    SA66577 05485602
         BNE   SISK2D2A                BRANCH IF NO             SA66577 05485702
SISK2D2  LR    R5,R10                  CHANNEL PGM START ADDR   SA66577 05485802
         CLI   CN1,SETSECT              RPS FAILURE              S20201 05486020
         BE    RPSFAIL1                 YES MARK THIS BUFFER BAD S20201 05492020
         B     SISK2H2A                ADDR CN1 IN REG5         SA66577 05494002
SISK2D2A EQU   *                       TEST FOR STOP ON CN3/4   SA66577 05496002
         CLI   0(R5),WKD               DID THE CP STOP ON A CN3  S20201 05502020
         BNE   SISK2C2A                NO                               05520000
         SH    R5,CONO16               BRING R5 TO CN1                  05540000
         B     SISK2H2B                                                 05560000
SISK2C2A CLI   0(R5),WD                DID CP STOP ON A CN4      S20201 05580020
         BNE   SISK2H2A                NO                               05600000
*                                                                       05610002
*        IF CP DID NOT STOP ON CN3 OR CN4, MUST BE AT CN1               05620000
*                                                                       05630002
         SH    R5,TWENTY4              SET R5 TO CN1                    05640000
SISK2H2B TM    W1OSENSE,X'08'          DID CP STOP ON DATA CHECK        05660000
         BZ    SISK2H2A                NO                               05680000
SISK2C2B OI    CN2+K4,UNWRITE          MARK THIS BUFFER          S20201 05690020
*                                       UNWRITABLE               S20201 05700020
*  IF CP STOPPED ON A DATA CHECK ON A WRITE COMMAND,                    05720000
*   IT IS MARKED UNWRITABLE                                             05740000
*                                                                       05750002
         SPACE 1                                                        05752002
SISK2E2  OIL   W1OSBIT2,WAPBIT,REF=W1OSBIT1,  SET WRITE Q WORK  YM03876X05760002
               WREGS=(R9,R10,R13)       WORK BIT ON             YM03876 05770002
         SPACE 2                                                        05772002
         MVC   CN5+K4(L4),W1OF1        MOVE IOB FIELDS TO CP     S20201 05780020
         MVC   CN6,W1OCSW              FOR ERROR EXIT TO USER    S20201 05800020
         SPACE 2                                                        05810002
         OIL   W1OSBIT3,BADDSET,REF=W1OSBIT1,  SET ON BAD       YM03876X05820002
               WREGS=(R9,R10,R13)       DATA SET INDICATOR      YM03876 05830002
         SPACE 2                                                        05832002
SISK2F2  NI    W1OF1,X'FB'             SET OFF IOB EXCEPTION BIT        05840000
         TM    CN4+K4,CC               IS THIS LAST BUFF OF SET  S20201 05860020
         BZ    SISK1B1                 YES, GO TO CHECK BUFFERS         05880000
SISK2G3  L     R8,CN5                  GET NEXT CHAN PROG IN SET S20201 05890020
         DROP  R5                                                S20201 05900020
         USING SISCP22,R8                                        S20201 05910020
         NI    CN1,X'FF'-MT            SET OFF ITS MT BIT        S20201 05917020
         DROP  R8                                                S20201 05924020
         USING SISCP22,R5                                        S20201 05931020
         B     SISK0E3                 GO TO WRITE THE REST OF THE SET  05940000
*                                                                       05942002
*   RPS FAILURES DON'T POINT TO CP SO PT AHEAD                          05945020
*                                                                       05947002
RPSFAIL1 EQU   *                        *                        S20201 05950020
         L     R5,CN2                   PT TO A BUFFER           S20201 05955020
SISK2H2A OI    CN2+K4,UNREACH          MARK BUFFER UNREACHABLE   S20201 05965020
         B     SISK2E2                                                  05980000
         EJECT                                                          06000000
SISCTK3  EQU   *                                                        06020000
*                                      ******************************** 06040000
*                                      *                              * 06060000
*                                      * ABNORM END APP CODES C AND 14* 06080000
*                                      *                              * 06100000
*                                      ******************************** 06120000
         SPACE 2                                                        06140000
*                                  ***** CONSTANTS *****                06160000
EIGHT    DC    H'08'                                             S20201 06180020
TWENTY4  DC    AL2(CN4-CN1)                                      S20201 06200020
         SPACE 3                                                        06220000
* ENTRY POINT ABNORMAL END ON CHECK                                     06240000
         SPACE 2                                                        06260000
SISK3B2  L     R5,W1COMADO             LOAD ERROR CCW+8 TO R5           06280000
         LA    R5,0(R5)                CLEAR HIGH ORDER BYTE    SA66577 06290002
         L     R10,W1OCPS              CHANNEL PGM START ADDR   SA66577 06290402
         LA    R10,0(R10)              CLEAR HIGH ORDER BYTE    SA66577 06290802
         CR    R5,R12                  ERROR CCW ADDR BELOW     SA66577 06292002
*                                      SCAN WORK AREA ADDRESS   SA66577 06294002
         BL    SISK3SS                 BR YES-ERROR IN IOS CCW  SA66577 06296002
         LR    R9,R5                   ADDR ERROR CCW+8         SA66577 06298002
         SH    R9,EIGHT                ADDRESS OF ERROR CCW     SA66577 06298402
*                                                                       06298802
         CR    R9,R10                  ERROR CCW FIRST IN CP    SA66577 06299202
         BNE   SISK3A1                 BR NO-TEST IF ON A TIC   SA66577 06299602
SISK3SS  LR    R5,R10                  CHANNEL PGM ADDRESS      SA66577 06299702
         CLI   CN1,SETSECT             FIRST CCW SET SECTOR     SA66577 06299802
         BNE   SISK3B3                 BRANCH IF NOT SET SECTOR SA66577 06299902
         L     R5,CN2                  ADDRESS OF FIRST BUFFER  SA66577 06306602
         B     SISK3B3                 TEST FOR PERM ERROR      SA66577 06308602
SISK3A1  CLI   0(R5),TIC               DID CP STOP ON A TIC     SA66577 06313302
         BNE   SISK3B2B                NO, MUST HAVE STOPPED AT CN4     06320000
*                                      YES                              06340000
SISK3B2A LR    R5,R9                   R5 TO EITHER CN1 OR CN4  SA66577 06360002
         CLI   0(R5),SIDEQ             R5= CN1--MT BIT OFF       S20201 06380020
         BE    SISK3B3                 THEN ERROR AT CN1                06400000
         CLI   0(R5),SIDEQ+MT          R5= CN1--MT BIT ON        S20201 06420020
         BE    SISK3B3                 THEN ERROR AT CN1                06440000
*                                      STOPPED ON CN4                   06460000
SISK3B2B SH    R5,TWENTY4              BRING R5 TO CN1                  06480000
SISK3B3  TM    W1OSENSE+2,X'3F'        PERMANENT ERROR                  06500000
         BO    SISK0F1                  NO, LET IOS RETRY               06520000
SISK3C3  TM    CN4+K4,CC               IS CC BIT OF THIS CP ON   S20201 06540020
         BZ    SISK3C3B                NO                               06560000
SISK3C3C NI    CN4+K4,X'FF'-CC         IF ON , SET OFF CC OF CN4 S20201 06580020
         OI    CN2+K4,CCSTORE          IF CC ON SET ON BIT 7     S20201 06600020
         B     SISK3D3                                                  06620000
SISK3C3B TM    CN2+K5,CC               IS SAVE CC BIT ON         S20201 06640020
         BO    SISK3C3C                YES                              06660000
SISK3C3A NI    CN2+K4,X'FF'-CCSTORE    SET OFF 'REMEMER CC  BIT' S20201 06680020
SISK3D3  NI    CN1,X'FF'-MT            SET MT BIT OF THIS CP OFF S20201 06700020
         SPACE 2                                                        06720000
*        RETRY                                                    17516 06740000
         SPACE                                                          06760000
SISK3D4  MVC   W1ODAD,CN6              SET ODAD TO CN6 OF ERR CP S20201 06790020
         ST    R5,W1OCPS                                                06820000
SISK3E4  MVI   W1OEXTEN+1,X'10'         SET APP CODE TO REWRITE         06840000
         L     R5,W1OCPS               RELOAD FOR REWRITING             06860000
SISK3E3  NI    CN4+K4,X'FF'-CC-SKIP     SET CC AND SKIP BITS OFF S20201 06880020
SISK3F3  CLI   CN3,TIC                  22B                      S20201 06900020
         BNE   SISK3F2                  NO , CP22A'S ARE ON Q           06920000
SISK3G3  MVI   CN4,WD                   SET CN4=WRITE DATA(22B)  S20201 06940020
         B     SISK1G3                  TAKE EXCP RETURN (REWRITE)      06960000
SISK3F2  NI    CN3+K4,X'FF'-SKIP        SKIP IN CN3(CP22A) OFF   S20201 06980020
         MVI   CN3,WKD                  SET CN3 TO WRTE KD       S20201 07000020
         SPACE 2                                                        07020000
SISK3H3  B     SISK1G3                  TAKE EXCP RETURN (REWRITE)      07040000
         SPACE 2                                                        07060000
* ENTRY POINT ABNORMAL END ON RECHECK                                   07080000
         SPACE 2                                                        07100000
SISK3G4  TM    W1OSENSE+2,X'3F'        PERM ERROR                 17516 07120000
         BO    SISK0F1                 NO, LET IOS RETRY          17516 07140000
         BE    SISK4C2                 YES, GO MARK BUFFER        17516 07160000
*                                          UNWRITEABLE            17516 07180000
         EJECT                                                          07240000
SISCTK4  EQU   *                                                        07260000
*                                ********************************       07280000
*                                *                              *       07300000
*                                * AE APP CODE 10,CE APP CODE 14*       07320000
*                                *                              *       07340000
*                                ********************************       07360000
         SPACE 2                                                        07380000
* ENTRY POINT ABNORMAL END ON REWRITE                                   07400000
         SPACE 2                                                        07420000
SISK4B2  TM    W1OSENSE+2,X'3F'       PERM ERROR                        07440000
         BO    SISK0F1                 NO                               07460000
SISK4C2  L     R5,W1COMADO                                              07480000
         LA    R5,0(R5)                CLEAR HIGH ORDER BYTE    SA66577 07490002
         SH    R5,EIGHT                BRING R5 TO ERROR CCW            07500000
*                                                                       07510002
         L     R10,W1OCPS              CHANNEL PGM START ADDR   SA66577 07512002
         LA    R10,0(R10)              CLEAR HIGH ORDER BYTE    SA66577 07514002
         CR    R5,R12                  ERROR CCW ADDR BELOW     SA66577 07516002
*                                      SCAN WORK AREA ADDRESS   SA66577 07518002
         BL    SISK4A1                 BR YES-ERROR IN IOS CCW  SA66577 07518402
         CR    R5,R10                  ERROR CCW FIRST IN CP    SA66577 07518802
         BNE   SISK4A2                 BRANCH IF NO             SA66577 07519202
SISK4A1  LR    R5,R10                  CHANNEL PGM START ADDR   SA66577 07519602
         CLI   CN1,SETSECT             FIRST CCW SET SECTOR     SA66577 07519702
         BNE   SISK4C2D                BR NO-MARK UNWRITABLE    SA66577 07519802
         L     R5,CN2                  ADDRESS OF FIRST BUFFER  SA66577 07519902
         B     SISK4C2D                MARK BUFFER UNWRITABLE   SA66577 07526602
SISK4A2  EQU   *                        FIND WHICH CCW IN ERROR SA66577 07528602
         CLI   0(R5),WKD               CP STOP ON A CN3 (WR KD)  S20201 07533302
         BNE   SISK4C2B                NO                               07540000
SISK4C2C SH    R5,CONO16               BRING R5 TO CN1                  07560000
         B     SISK4C2D                                                 07580000
SISK4C2B CLI   0(R5),RKD               CP STOP ON A RD KD (CN3)  S20201 07600020
         BE    SISK4C2C                YES                              07620000
SISK4C2A CLI   0(R5),WD                CP STOP ON A CN4  (WR D)  S20201 07640020
         BNE   SISK4C2E                DID NOT STOP AT WR DATA          07660000
SISK4C2F SH    R5,TWENTY4              BRING R5 TO CN1                  07680000
         B     SISK4C2D                                                 07700000
SISK4C2E CLI   0(R5),RDATA             CP STOP ON A CN4 (RD      S20201 07710020
*                                       DATA)                    S20201 07720020
         BE    SISK4C2F                YES                              07740000
SISK4C2D OI    CN2+K4,UNWRITE          MARK BUFFER UNWRITABLE    S20201 07760020
         SPACE 2                                                        07770002
         OIL   W1OSBIT2,WAPBIT,REF=W1OSBIT1,  SET ON WRITE Q    YM03876X07780002
               WREGS=(R9,R10,R13)       WORK BIT                YM03876 07790002
         SPACE 2                                                        07792002
         MVC   CN5+4(4),W1OF1          MOVE IOB FIELDS           S20201 07800020
         MVC   CN6,W1OCSW              INTO CHAN. PROG FOR USER  S20201 07820020
SISK4F2  NI    W1OF1,X'FB'             SET OFF IOB EXCEPTION BIT        07840000
SISK4G2  TM    CN2+K4,CCSTORE          'REMEMBER' CC BIT ON{     S20201 07860020
         BO    SISK4G2A                YES                              07880000
         B     SISK0A2         GO TO WRITE NEXT SET                     07900000
*              THE SETC4 SUB ROUTINE HAS PREV. INITIALIZED              07920000
*              ALL CP'S ON WRITE Q TO WRITE CCW'S                       07940000
         EJECT                                                          07960000
* ENTRY POINT CHANNEL END ON RECHECK                                    07980000
         SPACE 2                                                        08000000
SISK4G3  L     R5,W1OCPS               GET ADDR OF RECHECKED CHAN PROG  08020000
         CLI   CN1,SETSECT              RPS PREFIX               S20201 08025020
         BNE   SISK4G2                  NO - PTR OK              S20201 08030020
         L     R5,CN2                   CORRECT PTR              S20201 08035020
         B     SISK4G2                                                  08040000
SISK4G2A OI    CN4+K4,CC               IF FLAG ON, SET ON CN4 CC S20201 08060020
         MVI   W1OEXTEN+1,X'0C'         SET APP. CODE TO C (CHECK)      08080000
         TM    W1OSBIT3,X'20'          ANY WRITE ERRORS ON THIS SET     08100000
         BO    SISK0A3                 YES                              08120000
         B     SISK0E3                  CONTINUE CHECKING               08140000
*                                                                       08150002
*   IF THERE WERE NO ERRORS ON THIS SET, CHECKING IS CONTINUED SINCE    08160000
*   THE CHAN. PROGS. HAVE ALREADY BEEN SET TO READ.IF ERRORS OCCURRED,  08180000
*   THE REMAINING CHAN. PROGS. MUST BE CHANGED TO READ BEFORE CHECKING  08200000
*                                                                       08210002
PATCH    DC    XL50'00'                 ZEROED PATCH AREA        Y02072 08212002
*                                                                       08214002
         EJECT                                                          08220000
SISCP22  DSECT                                                          08260020
         IGGCP22                                                        08300020
         EJECT                                                          08360000
SISDEB   IGGDEBD                                                        08390020
         EJECT                                                          09120000
SISWORK1 IGGSCAN                                                        09150020
         EJECT                                                          11820000
         DCBD  DSORG=(IS)                                               11840000
         END                                                            11860000
