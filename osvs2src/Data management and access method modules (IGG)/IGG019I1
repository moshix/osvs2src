         TITLE 'IGG019I1 - PUT, FULL TRACK INDEX WRITE, W/O WRITE CHK'  00040019
IGG019I1 CSECT                                                          00080019
*          RELEASE OS/VS2-02 DELETIONS                                * 00090002
*                                                               YM03178 00092002
*                                                               YM05395 00094002
*                                                               YM06516 00096002
*                                                                       00100002
*          RELEASE 20 DELETIONS                                       * 00120019
*3392144400-145600                                               A38527 00125020
*3392140800-141200,148800-149600,182800-185600                   A32496 00130020
*3392140400,143600-144000                                        A31998 00140020
*3392                                                            M0620  00150020
*3392156000-156400                                               M1857  00151020
*3392053600,054000-083600,130000,184400,316000-316400,316800-    S20201 00152020
*3392317600,318000-318400,318800-319600,320000-320800,552800,    S20201 00154020
*3392553200,782800,783200-784000                                 S20201 00156020
*          RELEASE 21 DELETIONS                                       * 00160019
*0991316200-318900                                               A46109 00162021
*0991234000-234400                                               A42181 00165021
*0991431200-434000,662400-662800,677200-678000,720800-721200,    A38521 00170021
*0991728000-728400                                               A38521 00180021
*0991711200,711600,712000,754000,764800,765200,765600,766800,    A45263 00183021
*0991800000,800400,802000,806400,838800                          A45263 00186021
*0991601200-603200                                               M0170  00190021
*0991                                                            M0976  00192021
*0991677000,730800                                               M1819  00194021
*0991683600,789200,790000-793600                                 A44853 00194100
*D142000                                                        XM6075  00196000
*D834000-834800,833600                                          SA54556 00198002
*                                                                       00440002
*                                                                     * 00460002
*          VS2 RELEASE 030 PTF CHANGES                         @ZA07607 00465037
*C1612000,455600                                               @ZA07607 00470037
*A164150-166000                                                @ZA07607 00475037
*A167700-167750,C175200                                        @ZA10227 00476037
*A455400                                                       @ZA10226 00477037
* STATUS CHANGE LEVEL 004                                               00480002
*                                                                     * 00520019
*FUNCTION/OPERATION- THIS MODULE CONTAINS THE BASIC LOAD MODE PUT     * 00560019
*   ROUTINES FOR FULL TRACK INDEX WRITE WITHOUT WRITE CHECK.  THESE   * 00600019
*   ROUTINES INVOLVE RECORD PROCESSING FOR MOVE MODE AND FOR LOCATE   * 00640019
*   MODE, BUFFER MANAGEMENT, CHANNEL PROGRAM INITIALIZATION AND       * 00680019
*   EXECUTION.                                                        * 00720019
*                                                                     * 00760019
*ENTRY POINTS- 'IGG019I1' (ISLFX01) IS THE ENTRY FOR A LOAD MODE PUT  * 00800019
*   MACRO INSTRUCTION. THE GENERATED CALLING SEQUENCE IS,             * 00840019
*   LA   1,DCB                                                        * 00880019
*   LA   0,RECORD   FOR MOVE MODE                                     * 00920019
*   L    15,48(0,1)                                                   * 00960019
*   BALR 14,15                                                        * 01000019
*                                                                     * 01040019
*INPUT- REGISTER 0  -POINTS TO USERS RECORD IN WORK AREA (MOVE MODE). * 01080019
*       REGISTER 1  -POINTS TO DCB.                                   * 01120019
*       REGISTER 13 -POINTS TO USER SAVE AREA.                        * 01160019
*       REGISTER 14 -POINTS TO RETURN FROM PUT.                       * 01200019
*                                                                     * 01240019
*OUTPUT- REGISTER 1 -POINTS TO NEXT AVAILABLE SPACE IN OUTPUT BUFFER  * 01280019
*                     (LOCATE MODE).                                  * 01320019
*        REGISTER 1 -POINTS TO BAD BUFFER IF WRITE ERROR OCCURRED.    * 01360019
*        REGISTER 0 -POINTS TO IOB IF WRITE ERROR OCCURRED.           * 01400019
*        REGISTER 14-POINTS TO RETURN TO CLOSE IF WRITE ERROR         * 01440019
*                      OCCURRED DURING CLOSE.                         * 01480019
*                                                                     * 01520019
*EXTERNAL ROUTINES- 'IGG019GC'-CHANNEL PROGRAM APPENDAGE ROUTINES     * 01560019
*   USED TO PROCESS I/O RETURNS. ALSO, CHANNEL PROGRAMS AND IOS.      * 01600019
*                                                                     * 01640019
*EXITS-NORMAL- (ISLFX13), USER RECORD HAS BEEN PROCESSED SUCCESSFULLY.* 01680019
*     -ERROR-  (ISLFX05), AN ERROR OCCURRED DURING THE PROCESSING OF  * 01720019
*   THE USER RECORD. THE ERROR CONDITION IS FLAGGED AS FOLLOWS,       * 01760019
*   DCBEXCD1 BIT 5 ON = WRITE ERROR, REG 1 POINTS TO BAD BUFFER.      * 01800019
*                                    REG 0 POINTS TO IOB.             * 01840019
*   DCBEXCD1 BIT 2 ON = SPACE ERROR, NOT ENOUGH SPACE FOR DATA SET.   * 01880019
*   DCBEXCD2 BIT 1 ON = DUPLICATE KEY.                                * 01920019
*                                    REG 0 POINTS TO HIGH KEY     20852 01960019
*                                                                     * 02000019
*TABLES/WORK AREAS-                                                   * 02040019
*   DCB      - COMMUNICATION WITH USER.                               * 02080019
*   DEB      - COMMUNICATION WITH IOS.                                * 02120019
*   ISLCOMON - COMMUNICATION WITHIN LOAD MODE.                        * 02160019
*   ISLIOBA  - COMMUNICATION WITH I/O FOR CP18 AND CP20.              * 02200019
*   ISLIOBB  - COMMUNICATION WITH I/O FOR CP21.                       * 02240019
*   ISLIOBC  - COMMUNICATION WITH I/O FOR CP19.                       * 02280019
*   ISLAREAZ - WORK AREA USED FOR PREFORMATTING.                      * 02320019
*   ISLIXLT  - INDEX LOCATION TABLE, LOCATES HI-LEVEL INDICIES.       * 02360019
*   ISLY     - WORK AREA USED WHEN WRITING INDICIES.                  * 02400019
*   ISLVPTRS - VARIABLE POINTERS, REFERENCE VARIABLE LENGTH BLOCKS.   * 02440019
*   IOBBCT   - BUFFER CONTROL TABLE, CONTROLS BUFFER USAGE.           * 02480019
*                                                                     * 02520019
*ATTRIBUTES- READ ONLY, REENTRANT, REUSABLE.                          * 02560019
*                                                                     * 02600019
*NOTES- THIS MODULE, TOGETHER WITH THE APPENDAGE MODULE 'IGG019GC',   * 02640019
*   AND THE CHANNEL PROGRAMS, CREATE THE ISAM DATA SET WHEN NO WRITE- * 02680019
*   CHECKING IS SPECIFIED FOR FULL TRACK INDEX WRITE.  ALL OTHER LOAD * 02720019
*   MODE MODULES MERELY PROVIDE THE OPEN AND CLOSE FUNCTIONS.         * 02760019
*       SECTIONS OF THE PROCESSING IN THIS MODULE ARE ENTERED         * 02800019
*   DIRECTLY FROM CLOSE PROCESSING. IN SUCH CASES, PROCESSING IS      * 02840019
*   CARRIED ON AS THOUGH IT WAS PART OF CLOSE.                        * 02880019
*        ENTRY POINTS - ISLFX01                                       * 02920019
*                     - ISLFX20                                       * 02960019
*                     - ISLFY01                                       * 03000019
*                     - ISLFZ01                                       * 03040019
*                     - ISLPA01                                       * 03080019
*                                                                     * 03120019
*    ****************************************************************** 03160019
*    THE FOLLOWING NOTATION IS FREQUENTLY USED THROUGHOUT COMMENTS -  * 03200019
*              C(FIELD X) = A(FIELD Y)                                * 03240019
*     CONTENTS OF FIELD X = ADDRESS OF FIELD Y                        * 03280019
*    ****************************************************************** 03320019
*                                                                     * 03360019
         EJECT                                                          03400019
********************                                                    03440019
* DCB REFERENCE    *                                                    03480019
********************                                                    03520019
*                                                                       03560019
         DCBD  DSORG=(IS)                                               03600019
         USING IHADCB,R1                                                03680019
         EJECT                                                          03720019
********************                                                    03760019
* DEB REFERENCE    *                                                    03800019
********************                                                    03840019
*                                                                       03880019
IHADEB   DSECT                                                          03920019
         USING IHADEB,R8                                                03960019
         DS    0D                                                       04000019
DEBNMSUB DS    0CL1                                                     04040019
DEBTCBAD DS    A                                                        04080019
DEBAMLNG DS    0CL1                                                     04120019
DEBDEBAD DS    A                                                        04160019
DEBOFLGS DS    0CL1                                                     04200019
DEBIRBAD DS    A                                                        04240019
DEBOPATB DS    0CL1                                                     04280019
DEBSYSPG DS    A                                                        04320019
DEBNMEXT DS    0CL1                                                     04360019
DEBUSRPG DS    A                                                        04400019
DEBPRIOR DS    0CL1                                                     04440019
DEBECBAD DS    A                                                        04480019
DEBPROTG DS    0BL1                                                     04520019
DEBDEBID DS    0BL1                                                     04560019
DEBDCBAD DS    A                                                        04600019
DEBEXSCL DS    0CL1                                                     04640019
DEBAPPAD DS    A                                                        04680019
DEBNIEE  DS    0CL1                                                     04720019
DEBFIEAD DS    A                                                        04760019
DEBNPEE  DS    0CL1                                                     04800019
DEBFPEAD DS    A                                                        04840019
DEBNOEE  DS    0CL1                                                     04880019
DEBFOEAD DS    A                                                        04920019
         DS    CL4                                                      04960019
DEBDVMOD DS    0CL1                                                     05000019
DEBUCBAD DS    A                                                        05040019
DEBBINUM DS    CL2                                                      05080019
DEBSTRCC DS    CL2                                                      05120019
DEBSTRHH DS    CL2                                                      05160019
DEBENDCC DS    CL2                                                      05200019
DEBENDHH DS    CL2                                                      05240019
DEBNMTRK DS    CL2                                                      05280019
DEBXTN   DSECT                                                          05290002
DEBXLNGH  DS   H                        LENGTH DEB EXTENSION            05300002
DEBXFLG1  DS   B                        FLAG BYTE                       05310002
DEBXTSKC EQU   X'40'                    TASK CLOSE CLOSING DCB          05312002
         EJECT                                                          05320019
ISLCOMON IGGLOAD                                                        05340020
         USING ISLCOMON,R12             ADDRESSABILITY           S20201 05360020
         EJECT                                                          05380020
*                                                                       08400019
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      08440019
*                                                                       08480019
IOBBCT   DSECT                                                          08520019
         USING IOBBCT,R11                                               08560019
         DS    0D                                                       08600019
IOBFLAGS DS    0CL1                     FLAGS                           08640019
IOBPTRA  DS    A                        PTR A                           08680019
IOBB     DS    0CL1                     B                               08720019
IOBPTRB  DS    A                        PTR B                           08760019
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   08800019
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   08840019
*                                                                       08880019
*------------------ VARIABLE AREA ------------------------------------  08920019
*                                                                       08960019
*        --                                                             09000019
*        --                                                             09040019
*        --                                                             09080019
*        --                                                             09120019
*                                                                       09160019
* ISLY REFERENCE           C(ISLVPTRS)=A(ISLY)                          09200019
*                                                                       09240019
ISLY     DSECT                                                          09280019
         USING ISLY,R9                                                  09320019
         DS    0D                                                       09360019
         DS    CL8                      CYL-MAST IX    COUNT    Y+0     09400019
         DS    CL10                                    DATA     Y+8     09440019
         DS    CL8                      TRK IX NORM    COUNT    Y+18    09480019
         DS    CL10                                    DATA     Y+26    09520019
         DS    CL8                      TRK IX OVFL    COUNT    Y+36    09560019
         DS    CL10                                    DATA     Y+44    09600019
         DS    CL8                      TRK IX DUMM    COUNT    Y+54    09640019
*        DS    CL(IL)                                  KEY 1S   Y+62    09680019
*        DS    CL10                                    DATA     Y+62+IL 09720019
*                                                                       09760019
         EJECT                                                          09800019
IHAIOB   DSECT                                                          09840019
         USING IHAIOB,R2                                                09880019
         DS    0D                                                       09920019
IOBFLG1  DS    CL1                      FLAGS 1                         09960019
IOBFLG2  DS    CL1                      FLAGS 2                         10000019
         DS    CL1                                                      10040019
IOBSENSE DS    CL1                      SENSE                           10080019
IOBECBAD DS    A                        ECB POINTER                     10120019
IOBCSW   DS    CL8                      CHANNEL STATUS WORD             10160019
IOBSIOCC DS    0CL1                     SIO CC                          10200019
IOBCPSAD DS    A                        CHANNEL PROG START ADR          10240019
IOBWT    DS    0CL1                     WEIGHT                          10280019
IOBDCBAD DS    A                        DCB POINTER                     10320019
IOBCPRAD DS    A                        CHANNEL PROG RESTART ADR        10360019
IOBBCTI  DS    CL2                      BLK CTR INCR                    10400019
IOBECT   DS    CL2                      ERROR CTR                       10440019
IOBDADAD DS    CL8                      DIR ACCESS DEV ADR MBBCCHHR     10480019
*                                                                       10520019
IXLT     DSECT                                                          10560019
         USING IXLT,R7                                                  10600019
         DS    0D                                                       10640019
IXLTIND  DS    CL1                      INDICATOR                       10680019
IXLBEG   DS    CL8                      BEGINING COUNT MBBCCHHR         10720019
IXLSTP   DS    CL8                      STEPPING COUNT MBBCCHHR         10760019
IXLEND   DS    CL8                      ENDING COUNT   NBBCCHHR         10800019
         DS    CL1                                                      10840019
         DS    CL26                                                LEV2 10880019
         DS    CL26                                                LEV3 10920019
         DS    CL26                                                LEV4 10960019
         SPACE 3                                                        11000002
*                                                                       11040019
*              FULL TRACK INDEX WRITE OPTION                            11080019
*                                                                       11120019
         DS    0D                                                       11160019
TISA     DSECT                          TRACK INDEX SAVE AREA           11200019
         USING TISA,R6                                                  11240019
FTIWIOB  DS    2F                       IOB FOR FULL TRK INDEX WRITE    11280019
SIZE     DS    AL2                      LENGTH OF TI ENTRY              11320019
FLAGS    DS    AL1                      FLAGS FOR FTIW                  11360019
HIGHR    DS    AL1                      HIGHEST R ON CURRENT TRK        11400019
CURRR    DS    0CL1                     CURRENT RECORD ON THIS TRK      11440019
NEXTTI   DS    A                        ADDR OF NEXT TI ENTRY           11480019
TISASIZE DS    A                        SIZE OF TISA                    11520019
         EJECT                                                          11530020
CPSX     DSECT                                                          11540020
         IGGLDCP                        RECFM=F LOAD CP SKELETON S20201 11550020
         EJECT                                                          11560019
         IKJRB DSECT=YES                                        YM03178 11562002
         SPACE 4                                                        11568002
         IHAPSA                                                 YM05395 11568402
         EJECT                                                          11570002
*********************************************************************** 11600019
* ISL PUT - BEGIN                                                     * 11640019
*********************************************************************** 11680019
*                                                                       11720019
*                                                                       11760019
IGG019I1 CSECT                                                          11800019
ISLF800  SAVE  (14,12)                  SAVE USERS REGS                 11840019
         BALR  R15,0                                                    11880019
         USING *,R15                                                    11920019
         B     ISLFX01                                                  11960019
         B     ISLFX20                                                  12000019
         B     ISLFY01                                                  12040019
         B     ISLFZ01                                                  12080019
         B     ISLPA01                                                  12120019
*                                                                       12160019
* EQUATE SYMBOLIC REGISTERS                                             12200019
*                                                                       12240019
R0       EQU   0                                                        12280019
R1       EQU   1                                                        12320019
R2       EQU   2                                                        12360019
R3       EQU   3                                                        12400019
R4       EQU   4                                                        12440019
R5       EQU   5                                                        12480019
R6       EQU   6                                                        12520019
R7       EQU   7                                                        12560019
R8       EQU   8                                                        12600019
R9       EQU   8                                                        12640019
R10      EQU   10                                                       12680019
R11      EQU   11                                                       12720019
R12      EQU   12                                                       12760019
R13      EQU   13                                                       12800019
R14      EQU   14                                                       12840019
R15      EQU   9                                                        12880019
R16      EQU   15                                                       12920019
CVTPTR   EQU   16                                                       12960019
FOUR     EQU   4                        4                        A38527 12962020
BUF24    EQU   24                       BAD BUFFER OFFSET        A38527 12964020
RSLOAD   EQU   X'20'                    DCBST - RESUME LOAD      S20201 12966020
*                                       *       INDICATOR               12972020
CP20BIT  EQU   X'08'                    EXCP CP20 ONLY BIT       A44853 12974000
CLOSE1   EQU   X'40'                    TISA CLOSE INDICATOR     A44853 12976000
CLOSE2   EQU   X'04'                    NO NEW ENTRIES NEEDED    S20201 12978020
CLOSEFLG EQU   X'20'                    EXCD2 CLOSE FLAG         Y02072 12980002
L4       EQU   4                        LENGTH                   S20201 12984020
K2301    EQU   X'F8'                    2301 MASK                S20201 12990020
K1       EQU   1                        CONSTANT                 S20201 12998020
K2       EQU   2                        CONSTANT                 A38521 13000021
K4       EQU   4                        CONSTANT                 A38521 13002021
L3       EQU   3                        LENGTH                   S20201 13006020
K14      EQU   14                       CONSTANT                 S20201 13014020
K0       EQU   0                        CONSTANT                 S20201 13022020
K3       EQU   3                        CONSTANT                 S20201 13030020
COMPLETE EQU   X'40'                    IOB COMPLETED            A42181 13033021
IOERROR  EQU   X'04'                    DCBEXCD1 - I/O ERROR     A42181 13036021
ISLKEYVL EQU   X'04'                    KEY SEQUENCE VALID(IXLT) XM6075 13038000
INCLOSE  EQU   X'10'                    ENTERED FROM CLOSE      YM05395 13038402
DMCODE   EQU   119                      INTERNAL PROB DET CODE  YM05395 13038802
         EJECT                                                          13040019
*********************************************************************** 13080019
* CHART FX - PUT (MOVE/LOCATE)                                        * 13120019
*********************************************************************** 13160019
*                                                                       13200019
         USING IHADEB,R8                                                13240019
*                                                                       13280019
* FX HOUSEKEEPING                                                       13320019
*                                                                       13360019
ISLFX01  L     R12,DCBWKPT1             C(R12)=A(COMMON)                13400019
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)           14251 13440019
         L     R11,8(R10)               C(R11)=A(BCT)             14251 13480019
         TM    IOBFLAGS,X'10'           DID WE COME FROM CLOSE    14251 13520019
         BO    CONTINUE                 YES TAKE BRANCH           14251 13560019
         ST    R13,ISLVRSAV+4                                     14251 13600019
CONTINUE EQU   *                                                  14251 13640019
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   13680019
         NI    DCBEXCD2,X'3F'           SET EXCD2 BITS 0 AND 1 = 00     13720019
         TM    DCBEXCD1,X'04'           HAS AN OUTPUT ERROR      A31998 13730020
*                                      * OCCURRED$                      13740020
         BO    ISLFX02                  YES TAKE SYNAD           A31998 13750020
*                                                                       13760019
* TEST DCBST BIT 1 FOR LOAD MODE (FIRST TIME SW)                        13800019
*                                                                       13840019
         TM    DCBST,X'40'              TEST ST BIT 1 (1=NOT FRST TIME) 13880019
         BC    14,ISLFX10A              BRANCH NOT ON                   13920019
         LH    R5,DCBRKP                RELATIVE KEY POSITION    A32496 13940020
*                                                                       13960019
         TM    DCBST,X'20'              RESUME LOAD               P4701 14000019
         BZ    ISLFX022                 NOT RESUME LOAD          A31998 14040020
         TM    DCBMACRF+1,X'08'         PUT - LOCATE MODE         P4701 14160019
         BO    ISLFX07A                 BR-YES                   XM6075 14200000
         L     R4,4(R10)                PT TO HIGH KEY           A32496 14210020
         B     ISLFY022                 BRANCH TO CHECK SEQUENCE A32496 14220020
* TEST DCBEXCD1 BIT 5 FOR PREVIOUS UNCORRECTABLE WRITE ERROR            14240019
*                                                                       14280019
ISLFX02  L     R13,ISLVRSAV+4           C(R13)=A(USERS SAVE AREA) 20852 14320019
         MVC   BUF24(FOUR,R13),ISLVPTRA A(BAD BUFFER) IN USER R1 A38527 14420020
         LA    R0,ISLIOBA               C(R0)=A(IOBA)                   14600019
         ST    R0,20(R13)               STORE A(IOBA) IN USERS R0       14640019
         B     ISLFX05                  B TO TAKE SYNAD                 14680019
*                                                                       14720019
* SEQUENCE CHECK                                                        14760019
****************                                                        14800019
*                                                                       14840019
ISLFX022 EQU   *                        *                        A32496 14870020
         L     R4,ISLCBF                                         A32496 14900020
         AR    R4,R5                    PT TO KEY                A32496 14930020
ISLFY022 EQU   *                                                 A32496 14960020
         SR    R3,R3                                                    15000019
         IC    R3,DCBKEYLE              C(R3)=KEYLEN, 000000NN          15040019
         BCTR  R3,0                     C(R3)=KEYLEN-1, FOR EXECUTE     15080019
*                                                                       15120019
* TEST FOR MOVE OR LOCATE PUT                                           15160019
*                                                                       15200019
         TM    DCBMACRF+1,X'10'         TEST MACRF BIT 11               15240019
         BC    1,ISLFX08                B IF ON = MOVE PUT              15280019
*                                                                       15320019
* LOCATE PUT ***                                                        15360019
*                                                                       15400019
         L     R5,4(R10)                C(R5)=A(KEYSAVE)=A(PREV KEY)    15440019
         EX    R3,ISLFX02A              C(CBF+RKP) VS C(KEYSAVE)        15480019
         BH    ISLFX06                  B IF NEW KEY HIGH               15520019
         BE    ISLFX023                 B IF KEY SEQ CORRECT      20852 15560019
         LR    R4,R5                    PTR TO KEY               M1857  15600020
         B    ISLFX041                  BR TO POST ERROR         M1857  15640020
*                                                                       15680019
* LOCATE PUT,KEYS EQUAL- TEST IF 2ND PUT (SEQ CHK ONLY AFTER 2ND PUT)   15720019
*                                                                       15760019
ISLFX023 EQU   *                                                  20852 15800019
         L     R6,DCBNREC               C(R6)=NREC                      15840019
         C     R6,ISLONEF               TEST NREC VS 1                  15880019
         BE    ISLFX06                  B IF NREC = 1, ONLY 2ND PUT     15920019
*                                                                       15960019
* DUPLICATE RECORDS = ERROR                                             16000019
*                                                                       16040019
ISLFX03  OI    DCBEXCD2,X'40'           SET EXCD2 BIT 1 ON = DUPLICATE  16080019
         B     ISLFX04A                                        @ZA07607 16120037
*                                                                       16160019
* MOVE PUT ***                                                          16200019
*                                                                       16240019
ISLFX08  AR    R5,R0                    C(R5)=C(AREA+RKP)=A(NEW KEY)    16280019
         EX    R3,ISLFX08A              C(NEW KEY) VS C(CBF+RKP)        16320019
         BH    ISLFX07                  BRANCH IF NEW KEY HIGH          16360019
         BE    ISLFX03                  BR IF KEYS EQUAL=DUPLIC ATES    16400019
ISLFX041 EQU   *                        *                        M1857  16410020
* SEQUENCE ERROR                                               @ZA07607 16420037
         OI    DCBEXCD2,X'80'           EXCD2 BIT 0,SEQ ERROR  @ZA07607 16450037
         TM    IOBFLAGS,X'10'           IN CLOSE                 M1857  16480037
         BO    ISLFX04A                 YES - DON'T SAVE KEY   @ZA07607 16510037
         ST    R4,20(0,R13)             HI KEY ADDR INTO USER R0  20852 16540037
         OI    20(R13),X'80'            TURN USER REG 0 NEG    @ZA07607 16570037
         B     ISLFX05                                         @ZA07607 16600037
*                                                                       16630037
* TAKE SYNAD EXIT                                                       16660037
ISLFX04A LA    R0,ISLIOBA               LOAD IOB ADDR          @ZA07607 16690037
         TM    IOBFLAGS,X'10'           IN CLOSE?              @ZA10227 16700037
         BO    ISLFX05                  YES BRANCH             @ZA10227 16710037
         ST    R0,20(R13)               ST IN USER SAVE AREA   @ZA07607 16720037
ISLFX05  LR    R4,R14                   SAVE RETURN IN R4               16760019
         L     R16,DCBSYNAD                                             16800019
         C     R16,ISLONEF              TEST SYNAD VS 1                 16840019
         BE    ISLFX052                 BR IF 1 - NO SYNAD              16880019
         TM    IOBFLAGS,X'10'           TEST FLAGS BIT 3 (CLOSE)        16920019
         BC    1,ISLFX051               B IF ON = CLOSE                 16960019
         L     R13,ISLVRSAV+4           RESTORE USER R13                17000019
         L     R14,12(R13)              RESTORE USER R14                17040019
         LM    0,12,20(R13)             RESTORE REGS                    17080019
         BR    R16                      TAKE SYNAD EXIT                 17120019
ISLFX051 TM    DCBEXCD2,X'20'           TEST EXCD2 BIT 2    ***CLOSE*** 17160019
         BC    1,0(R4)                  B IF ON, RETURN TO CLOSE        17200019
         L     R5,DCBDEBAD              DEB ADDRESS             YM06516 17210002
         LA    R5,0(R5)                 CLEAR HIGH ORDER BYTE   YM06516 17212002
         S     R5,ISL8                  PT TO DEB EXTENSION PTR YM06516 17220002
         L     R5,0(R5)                 ADDRESS DEB EXTENSION   YM06516 17230002
         USING DEBXTN,R5                DEB EXT. ADDRESSABILITY YM06516 17240002
         TM    DEBXFLG1,DEBXTSKC        TASK CLOSE CLOSING DCB  YM06516 17242002
         BO    ISLFTERM                 BR YES - ISSUE MESSAGE  YM06516 17244002
         USING PSA,R0                   LOW CORE ADDRESSABILITY YM05395 17250002
         L     R5,PSATOLD               TCB ADDRESS             YM05395 17300002
         DROP  R0,R5                    END LOW CORE DEB ADDR   YM06516 17356002
         L     R5,0(R5)                                                 17360019
         USING RBBASIC,R5               SYNCH RB ADDRESSABILITY YM03178 17370002
         L     R5,RBLINK                OPEN SVRB ADDRESS       YM03178 17380002
         DROP  R5                       END RB ADDRESSABILITY   YM03178 17390002
         LA    R13,ISLVRSAV             SAVE AREA ADDRESS       YM03178 17400002
         OI    DCBEXCD2,CLOSEFLG        EXCD2 BIT 2 ON = CLOSE   Y02072 17410002
         L     1,24(R13)                SET REG 1              @ZA10227 17520037
         LM    2,13,40(R5)              RESTORE USERS REGS 2 - 13       17560019
         BR    R16                      TAKE SYNAD EXIT - WILL   Y02072 17600002
*                                       RETURN TO CLOSE AS REG   Y02072 17640002
*                                       14 HAS ADDR ESTABLISHED  Y02072 17680002
*                                       BY SYNCH ISSUED BY CLOSE Y02072 17720002
*                                                                       17760002
*                                                                       17800002
ISLFX052 EQU   *                        NO SYNAD = ABEND 31             17920002
         TM    IOBFLAGS,INCLOSE         ENTERED FROM CLOSE      YM05395 17930002
         BZ    ISLFX054                 BR NO - ISSUE ABEND     YM05395 17940002
         L     R5,DCBDEBAD              DEB ADDRESS             YM06516 17950002
         LA    R5,0(R5)                 CLEAR HIGH ORDER BYTE   YM06516 17950402
         S     R5,ISL8                  PT TO DEB EXTENSION PTR YM06516 17952002
         L     R5,0(R5)                 ADDRESS DEB EXTENSION   YM06516 17954002
         USING DEBXTN,R5                DEB EXT. ADDRESSABILITY YM06516 17956002
         TM    DEBXFLG1,DEBXTSKC        TASK CLOSE CLOSING DCB  YM06516 17956402
         BO    ISLFTERM                 BR YES - ISSUE MESSAGE  YM05395 17958002
         DROP  R5                       END DEB EXTENSION USING YM05395 17958402
ISLFX054 EQU   *                        ISSUE ABEND             YM05395 17958802
         ABEND X'031',DUMP,,SYSTEM      SYSTEM 031 ABEND         Y02072 17960002
         SPACE 2                                                        17970002
*        ISSUE ERROR MESSAGE AND TERMINATE TASK WITH 031 ABEND -        17980002
*        TASK TERMINATION ISSUED CLOSE FOR USER.                        17990002
         SPACE 2                                                        17992002
ISLFTERM EQU   *                        ISSUE MESSAGE-TERM. TSK YM05395 17994002
         DMABCOND DMCODE,SVC=YES,DCB=(R1)                       YM05395 17996002
         SPACE 2                                                        17998002
*                                                                       18000019
* LOCATE PUT,SEQUENCE OK- MOVE KEY TO KEYAVE AREA                       18040019
*                                                                       18080019
ISLFX06  EX    R3,ISLFX06A              MOVE C(CBF+RKP) TO C(KEYSAVE)   18120019
*                                                                       18160019
* BUMP CBF                                                              18200019
*                                                                       18240019
ISLFX07  EQU   *                        *                        A32496 18340020
         OI    ISLIXLT,ISLKEYVL         VALID RECORD ADDED       XM6075 18390000
ISLFX07A L     R7,ISLCBF                R7=PTR TO CURRENT BUFF   M0620  18470020
         A     R7,ISLBMPR               ADD LENGTH OF RECORD     M0620  18500020
         ST    R7,ISLCBF                RESET CURRENT BUFF PTR   M0620  18530020
         B     ISLFX10                                           M0620  18560020
*                                                                       18600019
* BUMP NREC                                                             18640019
*                                                                       18680019
ISLFX10A OI    DCBST,X'40'              SET ST BIT ON                   18720019
         CLC   DCBLPDA(1),DCBMSWA       TEST FOR SAME M           16305 18760019
         BNE   KEEPGOIN                                           16305 18800019
         CLC   DCBLPDA+3(4),DCBMSWA+3   TEST SAME CCHHR           16305 18840019
         BH    ISLPA205                 BRANCH OUT OF SPACE       16305 18880019
KEEPGOIN EQU   *                                                  16305 18920019
ISLFX10  L     R3,DCBNREC               C(R3)=NREC                      18960019
         A     R3,ISLONEF               C(R3)=NREC+1                    19000019
         ST    R3,DCBNREC               C(NREC)=NREC+1                  19040019
*                                                                       19080019
* TEST BOB SWITCH (APPLIES ONLY TO MOVE PUT, BOBSW = 1 FOR LOCATE PUT)  19120019
*                                                                       19160019
         TM    IOBFLAGS,X'08'           TEST FLAGS BIT 4 VS 1 (BOBSW)   19200019
         BC    1,ISLFX11                B IF ON = NOT 0                 19240019
*                                                                       19280019
*                                       BOBSW = 0                       19320019
         OI    IOBFLAGS,X'08'           SET FLAGS BIT 4 = 1 (BOBSW ON)  19360019
         BAL   R14,ISLPA01             *LINK TO BOB ROUTINE             19400019
*                                                                       19440019
         TM    DCBST,RSLOAD             IS IT RESUME LOAD        S20201 19450020
         BZ    ISLFX11                  NO - O.K.                S20201 19460020
         MVC   IOBPTRA+K1(L3),IOBPTRB+K1 MAKE IT THE FIRST       S20201 19470020
*                                       BOBSW = 1                       19480019
* TEST FOR MOVE OR LOCATE PUT                                           19520019
*                                                                       19560019
ISLFX11  TM    DCBMACRF+1,X'10'         TEST MACRF BIT 11               19600019
         BC    1,ISLFX20                B IF ON = MOVE PUT              19640019
*                                                                       19680019
* LOCATE PUT                                                            19720019
* TEST FOR EOB, HAS USERS LAST RCD FILLED A BUFFER -                    19760019
*                                                                       19800019
         L     R7,ISLCBF                C(R7)=CBF                       19840019
         C     R7,ISLEOB                TEST CBF VS EOB                 19880019
         BNL   ISLFX24                  B IF EOB                        19920019
*                                                                       19960019
*                                       NOT EOB                         20000019
ISLFX12  TM    IOBFLAGS,X'40'           TEST FLAGS BIT 1                20040019
         BC    1,ISLFX14                B IF ON = WRITE SHOULD BE       20080019
*                                                 ATTEMPTED             20120019
*                                                                       20160019
* NOT EOB, FLAGS BIT 1 OFF, RESTORE REGS AND RETURN TO USER             20200019
*                                                                       20240019
* EXIT PUT                                                              20280019
*                                                                       20320019
ISLFX13  TM    IOBFLAGS,X'10'           TEST FLAGS BIT-3 (CLOSE)        20360019
         BC    1,0(R14)                 B IF ON = CLOSE                 20400019
         TM    DCBST,RSLOAD             RESUME LOAD              S20201 20405020
         BZ    ISLFX13R                 NO - PTRS O.K.           S20201 20410020
         MVC   IOBPTRA+K1(L3),IOBPTRB+K1 CORRECT PTRS            S20201 20415020
         NI    DCBST,X'FF'-RSLOAD       TURN OFF RESUME LOAD     S20201 20420020
*                                       * INDICATOR                     20425020
ISLFX13R EQU   *                        *                        S20201 20430020
         TM    DCBMACRF+1,X'10'         TEST MACRF BIT 11 (MOVE PUT)    20440019
         BC    1,ISLFX132               B IF ON = MOVE PUT              20480019
         L     R1,ISLCBF                C(R1)=CBF, FOR LOCATE PUT       20520019
ISLFX132 L     R13,ISLVRSAV+4                                           20560019
         L     R14,12(R13)              RESTORE R14                     20600019
         RETURN (2,12)                  RESTORE USERS REGS AND EXIT     20640019
*                                                                       20680019
*                                                                       20720019
*                                                                       20760019
* NOT EOB, FLAGS BIT 1 ON, SET FLAGS BIT 1 OFF AND ATTEMPT WRITE        20800019
*                                                                       20840019
ISLFX14  NI    IOBFLAGS,X'BF'           SET FLAGS BIT 1 OFF             20880019
         OI    IOBFLAGS,X'20'           SET FLAGS BIT 2 ON (NOT EOB)    20920019
         B     ISLFY02                 *                                20960019
*                                                                       21000019
*                                                                       21040019
*                                                                       21080019
* MOVE PUT                                                              21120019
* MOVE RECORD FROM USER AREA TO CURRENT BUFFER VIA CBF                  21160019
*                                                                       21200019
ISLFX20  L     R3,ISLMVC                C(R3)=COUNT OF EXECUTED MOVE    21240019
         L     R4,ISLCBF                C(R4)=CBF=MOVE DESTINATION      21280019
         LR    R5,R0                    C(R5)=MOVE ORIGIN               21320019
         L     R6,ISLMVCT               C(R6)=NBR OF 255 BYTE MOVES     21360019
ISLFX21  BCT   R6,ISLFX22               TO MOVE 255 BYTES               21400019
         EX    R3,ISLFX21A              MOVE RCD AT R0 TO CBF           21440019
         B     ISLFX23                  MOVE COMPLETED                  21480019
ISLFX22  MVC   0(255,R4),0(R5)          MOVE 255 BYTES OF RECORD        21520019
         LA    R4,255(R4)               BUMP DESTINATION                21560019
         LA    R5,255(R5)               BUMP ORIGIN                     21600019
         B     ISLFX21                  TO MOVE REST OF RECORD          21640019
*                                                                       21680019
* TEST FOR EOB, HAS RCD JUST MOVED FILLED A BUFFER                      21720019
*                                                                       21760019
ISLFX23  L     R7,ISLCBF                C(R7)=CBF                       21800019
         A     R7,ISLBMPR               C(R7)=CBF+BMPR                  21840019
         C     R7,ISLEOB                TEST CBF+BMPR VS EOB            21880019
         BL    ISLFX12                  B IF NOT EOB                    21920019
*                                                                       21960019
*                                                                       22000019
*                                       EOB                             22040019
*                                                                       22080019
* SET BOB SW TO ZERO (RESET)                                            22120019
*                                                                       22160019
         NI    IOBFLAGS,X'F7'           SET FLAGS BIT 4 = 0 (BOBSW OFF) 22200019
         NI    DCBST,X'FF'-RSLOAD       TURN OFF RESUME LOAD     S20201 22220020
*                                                                       22240019
* MARK CURRENT BUFFER AND BUMP B IN BCT.                                22280019
*                                                                       22320019
ISLFX24  L     R3,IOBPTRB               C(R3)=PTR B = A(CURRENT SLOT)   22360019
         TM    DCBST,RSLOAD             RESUME LOAD              S20201 22370020
         BO    ISLFY01                  YES DON'T SCHEDULE       S20201 22380020
         NI    0(R3),X'DF'              SET STATUS BIT 2 = 0            22400019
         OI    0(R3),X'40'              SET STATUS BIT 1 = 1            22440019
*                                       STATUS BITS 1 AND 2 = 10        22480019
*                                       =BUF FULL BUT NOT SCHED         22520019
         IC    R4,IOBB                  C(R4)-000N, FULL BUFRS    P4701 22560019
         LA    R4,1(0,R4)               C(R4)-000000NN+1          P4701 22600019
         STC   R4,IOBB                  C(PTRB)=NNAAAAAA, NN = B        22640019
*                                                                       22680019
         EJECT                                                          22720019
*********************************************************************** 22760019
* CHART FY - PUT (EOB)                                                * 22800019
*********************************************************************** 22840019
*                                                                       22880019
* TEST B VS FBW (ARE WE READY TO ATTEMPT TO WRITE)                      22920019
*                                                                       22960019
ISLFY01  EQU   *                                                        23000019
         SR    R3,R3                    CLEAR REG 3                     23040019
         IC    R3,IOBB                  C(R3)=000N  N=NO. FILLED,       23080019
*                                         UNSCHEDULED BUFFERS           23120019
         C     R3,ISLFBW                TEST B VS FBW                   23160019
         BL    ISLFY41                  B IF NOT ENOUGH BUFFERS FILLED  23200019
*                                                                       23240019
*                                       B G.E. FBW, ATTEMPT WRITE       23280019
* TEST FLAGS BIT 0 VS 1, (IWR)-IS CP AVAILABLE                          23320019
*                                                                       23360019
ISLFY02  EQU   *                        *                        A42181 23370021
         TM    ISLECBA,COMPLETE         IOB AVAILABLE            A42181 23380021
         BZ    ISLFY41A                 NO - SCHEDULE LATER      A42181 23390021
         TM    DCBEXCD1,IOERROR         HAS AN I/O ERROR         A42181 23400021
*                                       OCCURRED                 A42181 23410021
         BO    ISLFX02                  YES - TERMINATE LOAD.    A42181 23420021
*                                                                       23480019
* B GE FBW AND FLAGS BIT 0 = 0 (CP AVAILABLE), SET UP TO WRITE          23520019
*                                                                       23560019
ISLFY03  SR    R3,R3                                                    23600019
         IC    R3,IOBB                  C(R3)=000N                      23640019
         S     R3,ISLFBW                C(R3)=B-FBW, WE WILL SCHED FBW  23680019
*                                                    BUFFRS             23720019
         STC   R3,IOBB                  C(PTRB)=NNAAAAAA, NN = B        23760019
*                                                                       23800019
         NI    IOBFLAGS,X'BF'           SET FLAGS BIT 1 OFF             23840019
*                                                                       23880019
*                                                                       23920019
*                                                                       23960019
* WAIT FOR PREVIOUS I/O TO COMPLETE                                     24000019
*                                                                       24040019
*                                                                       24080019
*                                                                       24120019
* MAKE SURE CP21 HAS COMPLETED                                          24160019
*                                                                       24200019
         LA    R2,ISLIOBB               SET BASE FOR IOB FOR CP21       24240019
         BAL   R4,ISLFY99               BR TO WAIT SUBROUTINE           24280019
*                                                                       24320019
* TEST STATUS BIT-6 (PF BIT) PERTAING TO 1ST BFR.  IF PF BIT ON, THIS   24360019
* IS THE 1ST BUFFER TO BE WRITTEN ON A NEW CYLINDER WITH SHARED TRACKS  24400019
*                                                                       24440019
         TM    0(R3),X'02'              TEST STATUS BIT-6               24480019
         BC    8,ISLFY08                B IF PF NOT ON                  24520019
*                                                                       24560019
* STATUS BIT-6 (PF BIT) IS ON. WE ARE ABOUT TO SCHED THE 1ST WRITE ON   24600019
* A NEW, SHARED-TRACK, CYLINDER. FIRST WE MUST BE SURE CP19 HAS         24640019
* FINISHED PRE-FORMATTING.                                              24680019
*                                                                       24720019
         LA    R2,ISLIOBC               SET BASE FOR IOB FOR CP19       24760019
         BAL   R4,ISLFY99               BR TO WAIT SUBROUTINE           24800019
         NI    0(R3),X'FD'              SET STATUS BIT 6 (PF BIT) OFF   24840019
*                                                                       24880019
*                                                                       24920019
* SCHED FBW BUFFRS FOR WRITING VIA PTR A (STATUS BITS 1,2 ON)           24960019
* AT THE SAME TIME TEST STATUS BYTES FOR BIT-3 ON = NEW EXTENT          25000019
*                                                                       25040019
ISLFY08  L     R4,ISLFBW                C(R4)= NO OF SLOTS TO SCHED     25080019
ISLFY10  OI    0(R3),X'60'              SET STATUS BITS 1,2 = 11        25120019
         TM    0(R3),X'10'              TEST STATUS BIT-3               25160019
         BC    8,ISLFY11                B IF 0, SAME EXTENT             25200019
         IC    R5,IOBDADAD              C(R5)-M                   P4701 25240019
         LA    R5,1(0,R5)               C(R5)-M+1                 P4701 25280019
         STC   R5,IOBDADAD              C(IOBA+32)=MBBCCHHR, M=M+1      25320019
         BAL   R5,ISLFZ21                                               25360019
         NI    0(R3),X'EF'              SET STATUS BIT-3 = 0            25400019
ISLFY11  A     R3,ISL4                  BUMP R3 TO ADR NEXT SLOT        25440019
         C     R3,ISLBUFN               TEST FOR ADR OF NTH SLOT        25480019
         BC    13,ISLFY20A              BR IF NOT HIGH                  25520019
ISLFY12  BCT   R4,ISLFY13               WRAPAROUND POSSIBLE             25560019
         B     ISLFY20                  OUT, SLOT N WAS LAST            25600019
ISLFY13  LA    R3,IOBABUF               WRAPAROUND REAL, C(R3)=A(SLOT1) 25640019
         B     ISLFY10                  LOOP AGAIN                      25680019
*                                                                       25720019
*                                       SAVE ADR OF LAST SLOT IN REG 7  25760019
ISLFY20A BCT   R4,ISLFY10                                               25800019
ISLFY20  LR    R7,R3                    C(R7)=A(LAST SLOT SCHED + 4)    25840019
         S     R7,ISL4                  C(R7)=A(LAST SLOT SCHED)        25880019
*                                                                       25920019
* INITIALIZE CP18 AND CP20 IN SUBROUTINE                                25960019
*                                                                       26000019
*                                                                       26040019
         ST    R14,TSTWK1C              SAVE A(RETURN TO CLOSE)  A44853 26050000
         ST    R7,ISLF9WK1              SAVE REGISTER 7                 26080019
         B     ISLF801                                                  26120019
ISLFY21  EQU   *                                                        26160019
         L     R7,ISLF9WK1              RESTORE REGISTER 7-             26200019
         L     R14,TSTWK1C              RESTORE CLOSE RETRN ADDR A44853 26210000
*                                                                       26240019
* SAVE CONTENTS OF BCT SLOT WITH STATUS AND POINTER OF LAST BUFF SCHED  26280019
*                                                                       26320019
         L     R3,0(R7)                 C(R3)=LAST BCT SLOT CONTENTS    26360019
         ST    R3,ISLF9WK1              SAVE SLOT CONTENTS              26400019
*                                                                       26440019
* TEST LAST BUFFER FOR END OF CYLINDER (C-BIT ON)                       26480019
*                                                                       26520019
         TM    0(R7),X'04'              TEST S BIT 5 VS 1 (C-BIT)       26560019
         BC    1,ISLFZ01                B IF ON                         26600019
*                                                                       26640019
*                                                                       26680019
* EXECUTE CP18 (CP20)                                                   26720019
*                                                                       26760019
*                                                                       26800019
ISLFY30  LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 26840019
         LR    R3,R0                    SAVE R0                         26880019
         LR    R4,R1                    SAVE R1                         26920019
         LR    R5,R14                   SAVE R14                        26960019
*                                                                  8791 27000019
*                                                                  8791 27040019
*                                                                  8791 27080019
* SET FLAGS BIT-0 (IWR BIT)=1, CP IS NOT AVAIL                     8791 27120019
*                                                                  8791 27160019
         OI    IOBFLAGS,X'80'           TURN ON FLAGS BIT 0        8791 27200019
*                                                                  8791 27240019
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         27280019
         LR    R0,R3                    RESTORE R0                      27320019
         LR    R1,R4                    RESTORE R1                      27360019
         LR    R14,R5                   RESTORE R14                     27400019
*                                                                       27440019
* SET FBW IN SUBROUTINE                                                 27480019
*                                                                       27520019
         LA    R7,ISLF9WK1              C(R7)=A(LAST SLOT) FROZEN       27560019
         B     ISLPB01                  GO TO SUBROUTINE                27600019
ISLFY41A OI    IOBFLAGS,X'40'           SET FLAGS BIT 1 ON TO ATTEMPT   27640019
*                                       TO WRITE LATER                  27680019
*                                                                       27720019
*                                                                       27760019
*                                                                       27800019
* TEST FLAGS BIT 2 (NOT EOB INDICATOR)                                  27840019
*                                                                       27880019
ISLFY41  TM    IOBFLAGS,X'20'           TEST FLAGS BIT 2                27920019
         BC    8,ISLFY42                B IF NOT ON (EOB)               27960019
         NI    IOBFLAGS,X'DF'           TURN FLAGS BIT 2 OFF            28000019
         B     ISLFX13                  RTRN TO FX (DONT GET LOC BUFF)  28040019
*                                                                       28080019
* TEST FOR MOVE OR LOCATE PUT                                           28120019
*                                                                       28160019
ISLFY42  TM    DCBMACRF+1,X'10'         TEST MACRF BIT 11               28200019
         BC    1,ISLFX13                B IF ON = MOVE PUT, RTRN TO FX  28240019
*                                                                       28280019
* LOCATE PUT                                                            28320019
*                                                                       28360019
         BAL   R14,ISLPA01             *LINK TO BOB ROUTINE             28400019
         B     ISLFX13                  RETURN TO FX                    28440019
*                                                                       28480019
*                                                                       28520019
***WAIT SUBROUTINE***                                                   28560019
* THIS SUBROUTINE DETERMINES IF A CHANNEL PROGRAM IS AVAILABLE, AND     28600019
* IF IT IS NOT, WAITS UNTIL IT IS.  THE ROUTINE EXPECTS THE  FOLLOWING  28640019
* INPUT - R2 = ADDR OF IOB FOR CHANNEL PROGRAM TO BE TESTED             28680019
*         R4 = RETURN ADDRESS                                           28720019
*                                                                       28760019
ISLFY99  EQU   *                                                        28800019
         ST    R4,ISLVRSAV              SAVE RETURN ADDRESS        0700 28840019
         LR    R3,R1                    SAVE R1                         28880019
         L     R1,IOBECBAD              C(R1)=A(ECB)                    28920019
         TM    0(R1),X'40'              TEST ECB BIT 1 (C-BIT)          28960019
         BC    1,ISLFY995               B IF 1, I/O COMPLETE-DON'T WAIT 29000019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 29040019
         LR    R4,R0                    SAVE R0                         29080019
         LR    R5,R14                   SAVE R14                        29120019
         ST    R16,TSTWK2C              SAVE R16 FOR FTIW WAIT RTN      29160019
         WAIT  ECB=(1)                                                  29200019
         LR    R0,R4                    RESTORE R0                      29240019
         LR    R1,R3                    RESTORE R1                      29280019
         LR    R14,R5                   RESTORE R14                     29320019
         L     R16,TSTWK2C              RESTORE R16 FOR FTIW WAIT       29360019
*                                                                       29400019
ISLFY995 LA    R2,ISLIOBA               C(R2)=A(IOBA)                   29440019
         LR    R1,R3                    RESTORE R1                      29480019
         L     R3,IOBPTRA               C(R3)=A(1ST SLOT TO SCHED)      29520019
         LA    R3,0(R3)                                                 29560019
         L     R4,ISLVRSAV              GET RETURN ADDRESS         0700 29600019
         BCR   15,R4                    RETURN                          29640019
*                                                                       29680019
         EJECT                                                          29720019
*********************************************************************** 29760019
* CHART FZ - CYLINDER INDEX ENTRY SETUP                               * 29800019
*********************************************************************** 29840019
*                                                                       29880019
*                                                                       29920019
* STORE ADDR OF STATUS BYTE WITH C-BIT ON IN CP21 AT CQ41               29960019
* -THIS IS DONE TO PERMIT APPENDAGE TO TURN OFF C-BIT-                  30000019
*            * R7 CONTAINS ADDR OF THE STATUS BYTE *                    30040019
*                                                                       30080019
ISLFZ01  L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 30120019
         L     R3,24(R10)               C(R3)=A(CP21-CQ40)              30160019
         ST    R7,12(R3)                C(CQ41+4)=A(LAST SLOT SCHED)    30200019
         NI    ISLIXLT,X'F7'            SET IXLT LEV1 BIT-4 OFF- TRK IX 30240019
*                                                                       30280019
*                                                                       30320019
* LOCATE LEVEL IN INDEX LOCATION TABLE AT CYLINDER INDEX                30360019
*                                                                       30400019
         LA    R7,ISLIXLT               C(R7)=A(IXLT)                   30440019
         OI    0(R7),X'20'              IXLTIND BIT-2 ON IN LEV1        30480019
         NI    26(R7),X'DF'                     BIT-2 OFF IN LEV2       30520019
         NI    52(R7),X'DF'                                  LEV3       30560019
         NI    78(R7),X'DF'                                  LEV4       30600019
*                                                                       30640019
* CONSTRUCT COUNT FOR CYLINDER INDEX ENTRY IN AREA Y, Y+0               30680019
*                                                                       30720019
         L     R9,0(R10)                C(R9)=A(AREA Y)                 30760019
         MVC   0(4,R9),12(R7)           COUNT = CCHH FROM IXLT S0       30800019
         IC    R3,16(R7)                C(R3)=R FROM IXLT S0, 000N      30840019
         A     R3,ISLONEF               C(R3)=R+1                       30880019
         STC   R3,4(R9)                 COUNT = CCHHR WITH R=R+1        30920019
*                                                                       30960019
* CONSTRUCT DATA FOR CYLINDER INDEX ENTRY IN AREA Y, Y+8                31000019
*                                                                       31040019
         TM    0(R7),X'40'              TEST IXLTIND BIT 1 (DUMMY SW)   31080019
         BC    1,ISLFZ10                B IF ON                         31120019
*                                                                       31160019
*                                       DUMMY SW OFF                    31200019
*  A. NORMAL DATA                                                       31240019
*                                                                       31280019
         MVC   8(7,R9),IOBDADAD         DATA=MBBCCHH FROM IOBA+32       31320019
*                                                                       31520019
         MVC   13(2,R9),ISLZEROF        DATA=MBBCCHH HH=00              31560019
ISLFZ012 EQU   *                                                 A46109 31600021
         CLI   DCBFIRSH+1,K0            H OF FIRSH VS 0          A46109 31640021
         BNE   ISLFZ02                  BIF HH NOT 00            A46109 31680021
*                                       HH OF FIRSH = 00                31720021
         MVC   15(1,R9),DCBFIRSH+2      DATA V MBBCCHHR WITH R   A46109 31760021
*                                       OF FIRSH                        31800021
         B     ISLFZ03                                           A46109 31840021
ISLFZ02  MVI   15(R9),X'00'             DATA = MBBCCHHR WITH R=00       32120019
ISLFZ03  MVI   16(R9),X'01'             DATA = MBBCCHHRF WITH F = 01    32160019
*                                                                       32200019
         SR    R6,R6                                                    32240019
         IC    R6,9(R7)                 C(R6) = M FROM IXLT S0          32280019
         BCTR  R6,0                     C(R6)=M-1                       32320019
         SLL   R6,4                     C(R6) = M-1 X 16 (USE AS INDX)  32360019
*                                                                       32400019
         SR    R5,R5                                                    32440019
         IC    R5,IOBDADAD              C(R5) = M FROM IOBA+32          32480019
         BCTR  R5,0                     C(R5)=M-1                       32520019
         SLL   R5,4                     C(R5) = M-1 X 16 (USE AS INDX)  32560019
*                                                                       32600019
         L     R8,DCBDEBAD              C(R8)=A(DEB)                    32640019
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  32680019
         LA    R4,0(R6,R4)              C(R4)=A(CURR INDX EXTENT ENTRY) 32720019
         L     R3,DEBFPEAD              C(R3)=A(1ST PRIM EXTENT ENTRY)  32760019
         LA    R3,0(R5,R3)              C(R3)=A(CURR PRIM EXTENT ENTRY) 32800019
         L     R9,0(R10)                C(R9)=A(AREA Y)                 32840019
*                                                                       32880019
         CLC   1(3,R3),1(R4)            COMP UCB ADDRS, PRIM VS INDX    32920019
         BNE   ISLFZ04                  B IF NOT EQUAL                  32960019
*                                                                       33000019
*                                       UCBS EQUAL                      33040019
         MVI   17(R9),X'0B'             DATA = MBBCCHHRFP WITH P=0B     33320019
         B     ISLFZ05                                                  33360019
*                                                                       33400019
*                                       UCBS UNEQUAL                    33440019
ISLFZ04  MVI   17(R9),X'07'             DATA = MBBCCHHRFP WITH P=07     33480019
*                                                                       33520019
*                                       SET CQ43 (CP21) TO ADDRESS KEY  33560019
*                                       OF LAST RECORD IN LAST BUFFER   33600019
*                                                                       33640019
ISLFZ05  L     R4,ISLKEYAD              =A(KEY OF LAST WR CKD)    13165 33680019
         B     ISLFZ20                                                  33720019
*                                                                       33760019
*                                       DUMMY SW ON = END OF CYLINDER   33800019
*  B. DUMMY DATA                                                        33840019
*                                                                       33880019
*                                       TEST CC+1 VS DEBENDCC FOR       33920019
*                                       POSSIBLE END OF INDEX EXTENT    33960019
*                                                                       34000019
ISLFZ10  EQU   *                                                        34040019
         SR    R6,R6                                                    34080019
         IC    R6,9(R7)                 C(R6)=M FROM IXLT S0, 000M      34120019
         BCTR  R6,0                                                     34160019
         SLL   R6,4                     C(R6)= 16(M-1) USE FOR INDEX    34200019
*                                       TO DEB ENTRY FOR CURR IX EXTNT  34240019
*                                                                       34280019
         L     R8,DCBDEBAD              C(R8)=A(DEB)                    34320019
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  34360019
         LA    R4,0(R6,R4)              C(R4)=A(CURR INDX EXTNT ENTRY)  34400019
*                                                                       34440019
         L     R9,0(R10)                C(R9)=A(AREA Y)                 34480019
         MVC   ISLFXWK1(4),12(R7)       C(FXWK1)=CCHH OF IXLT SO  13165 34520019
         L     R3,ISLFXWK1              C(R3)=CCHH                      34560019
         MVC   ISLFXWK2(4),10(R4)       C(FXWK2)=CCHH FROM DEBENDCC     34600019
*                                                                       34840019
         SRL   R3,16                    C(R3)=00CC                      34880019
         LA    R3,1(R3)                 ADD 1 FOR NEXT CYL C(R3)=00CC+1 34920019
         SLL   R3,16                    C(R3)=CC+100                    34960019
         ST    R3,ISLFXWK1              C(FXWK1)=CC+100                 35000019
         CLC   ISLFXWK1(2),ISLFXWK2     CC+1 VS ENDCC                   35040019
         BH    ISLFZ11                  BR IF CC+1 HI - IN NEW EXTENT   35080019
*                                                                       35120019
*                                       CC+1    IN CURRENT EXTENT       35160019
ISLFZ11A MVC   8(3,R9),9(R7)            DATA=MBB FROM IXLT S0           35200019
         MVC   11(4,R9),ISLFXWK1        DATA=MBBCCHH  CC=CC+1 HH=00     35240019
         BC    15,ISLFZ12               BR TO PICK UP R, ETC.           35280019
*                                                                       35320019
*                                                                       36720019
*                                                                       36760019
ISLFZ11  EQU   *                                                        36800019
         LA    R6,16(R6)                C(R6)=MX16 INDEX TO NEXT EXTENT 36840019
         MVC   ISLFXWK1(1),3(R4)        C(FXWK1)= H FROM BUFR CNT       36880019
         L     R8,DCBDEBAD              C(R8)=A(DEB)              13165 36920019
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  36960019
         LA    R4,0(R6,R4)              C(R4)=A(NEXT INDX EXTENT ENTRY) 37000019
*                                                                       37040019
         L     R9,0(R10)                C(R9)=A(AREA Y)           13165 37080019
         MVC   9(6,R9),4(R4)            DATA = BBCCHH FROM NEW EXTENT   37120019
         SRL   R6,4                     C(R6) = M FOR NEXT EXTENT       37160019
         A     R6,ISLONEF               C(R6) = M+1 (M=1 FOR EXTENT 0)  37200019
         STC   R6,8(R9)                 DATA = MBBCCHH OF NEW EXTENT    37240019
*                                                                       37280019
ISLFZ12  EQU   *                                                        37320019
         MVC   15(3,R9),ISLRFP          DATA-MBBCCHHR-RFP=002907        37360019
*                                                                       37400019
*                                       SET CQ43(CP21) TO ADDRESS KEY   37440019
*                                       OF ALL ONES AT AREA Y +62       37480019
*                                                                       37520019
         LA    R4,62(R9)                C(R4)=A(AREA Y +62)             37560019
*                                                                       37600019
* PLACE IXLT S0 IN IOBB+32                                              37640019
*                                                                       37680019
ISLFZ20  L     R10,24(R10)              C(R10)=A(CP21-CQ40)       13165 37720019
         IC    R5,24(R10)               SAVE OP                   13165 37760019
         ST    R4,24(R10)               PTR TO REAL OR DUMMY KEY  13165 37800019
         STC   R5,24(R10)               RESTORE OP                13165 37840019
         LA    R2,ISLIOBB               C(R2)=A(IOBB)             13165 37880019
         MVC   IOBDADAD(8),9(R7)        C(IOBB+32)=C(IXLT SO)     13165 37920019
         BAL   R5,ISLFZ21                                               37960019
*                                                                       38000019
*                                                                       38040019
*                                                                       38080019
* EXECUTE CP21                                                          38120019
*                                                                       38160019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 38200019
         LR    R3,R0                    SAVE R0                         38240019
         LR    R4,R1                    SAVE R1                         38280019
         LR    R5,R14                   SAVE R14                        38320019
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         38360019
         LR    R0,R3                    RESTORE R0                      38400019
         LR    R1,R4                    RESTORE R1                      38440019
         LR    R14,R5                   RESTORE R14                     38480019
*                                                                       38520019
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   38560019
         TM    IOBFLAGS,X'12'           TEST FLAGS BITS 3&6 (CLOSE X)   38600019
         BCR   1,R14                    BR IF ON = CLOSE                38640019
         B     ISLFY30                  EXIT                            38680019
ISLFZ21  EQU   *                                                        38720019
         L     R13,DCBDEBAD                                             38760019
         LA    R13,32(R13)   START MOVE OF DEB BB INTO IOB              38800019
         SR    R8,R8                                                    38840019
         IC    R8,IOBDADAD                                              38880019
         SLL   R8,4                                                     38920019
         AR    R8,R13                                                   38960019
         MVC   IOBDADAD+2(1),5(R8)                                      39000019
         BR    R5                       RETURN                          39040019
*                                                                       39080019
         EJECT                                                          39120019
*********************************************************************** 39160019
* CHART PA - BEGINING OF BUFFER                                       * 39200019
*********************************************************************** 39240019
*                                                                       39280019
*                                                                       39320019
* USING PTR B TO REFERENCE COUNT IN LAST BUFFER FILLED -                39360019
*   SET REG 5 = R               - REG A = 000R                          39400019
*   SET REG 6 = CCHH            - REG B = CCHH                          39440019
*   SET REG 7 = HI-RCD ON TRACK - REG C = 000R                          39480019
*                                                                       39520019
ISLPA01  ST    R14,ISLF9WK1             SAVE R14 FOR RETURN TO FX       39560019
         MVC   DCBFTMI3(8),DCBLPDA      SAVE PREVIOUS LPDA FOR CLOSE    39600019
         L     R3,IOBPTRB               C(R3)=C(PTRB)                   39640019
         LA    R3,0(R3)                 C(R3)=A(SLOT S)                 39680019
         L     R4,0(R3)                 C(R4)=C(SLOT S)=A(BUF B)        39720019
         SR    R5,R5                                                    39760019
         IC    R5,4(R4)                 C(R5)=000R                      39800019
         MVC   ISLFXWK2(4),0(R4)        C(FXWK2)=CCHH                   39840019
         L     R6,ISLFXWK2              C(R6)=CCHH                      39880019
*                                                                       39920019
*                                       TEST HH FOR SHARED TRACK        39960019
         SR    R7,R7                                                    40000019
         CLI   DCBHIRSH,X'00'           HIRSH VS 0                      40040019
         BE    ISLPA02                  BR IF 0 - NO SHARED TRACKS      40080019
         STC   R6,ISLFXWK1              C(FXWK1)= H FROM BUF CNT        40120019
ISLPA01A NC    ISLFXWK1(1),DCBFIRSH+3   REDUCE TO TRACK                 40160019
ISLPA01B CLC   DCBFIRSH+1(1),ISLFXWK1   H OF FIRSH VS H OF BUFR CNT     40200019
         IC    R7,DCBHIRSH              C(R7)=HIRSH                     40240019
         BE    ISLPA03                  BR EQ, SHARED TRK - R7=HIRSH    40280019
ISLPA02  IC    R7,DCBHIRPD              NOT A SHARED TRACK, C(R7)=HIRPD 40320019
*                                                                       40360019
* STEP PTR B TO NEXT SLOT IN BCT (MAY WRAPAROUND)                       40400019
*                                                                       40440019
ISLPA03  C     R3,ISLBUFN               TEST FOR ADR OF NTH SLOT        40480019
         LA    R3,4(R3)                 STEP TO NEXT SLOT               40520019
         BNE   ISLPA05                  NOT NTH SLOT, GO UPDATE PTR B   40560019
ISLPA04  LA    R3,IOBABUF               C(R3)=0AAA, AAA= ADR 1ST SLOT   40600019
ISLPA05  IC    R4,IOBB                  SAVE B                          40640019
         ST    R3,IOBPTRB               STORE UPDATED PTR B             40680019
         STC   R4,IOBB                  RESTORE B                       40720019
*                                                                       40760019
* UPDATE CBF AND EOB FOR NEW BUFFER VIA PTR B                           40800019
*                                                                       40840019
         L     R4,0(R3)                 C(R4)=C(SLOT S)=A(BUFF B)       40880019
         LA    R4,0(R4)                                                 40920019
         LR    R3,R4                    C(R3)=A(BUFF B)                 40960019
         A     R3,ISL8                  C(R3)=A(BUFF B)+8               41000019
         ST    R3,ISLCBF                C(CBF)=A(BUFF B)+8              41040019
         LH    R3,DCBBUFL               C(R3)=00NN, NN=BUFL             41080019
         BCTR  R3,0                     C(R3)=00NN-1                    41120019
         AR    R3,R4                    C(R3)=A(BUFF B)+BUFL-1          41160019
         ST    R3,ISLEOB                C(EOB)=A(BUFF B)+BUFL-1         41200019
*                                                                       41240019
*                                                                       41280019
* ROUTINE TO SET UP NEW COUNT FIELD FOR NEW BUFFER                      41320019
* ************************************************                      41360019
*                                                                       41400019
*                                                                       41440019
* TEST IF LAST BUFFR FILLED WAS EOT                                     41480019
*                                                                       41520019
         CR    R7,R5                    TEST REG C VS REG A             41560019
         BE    ISLPA20                  B IF EOT                        41600019
*                                                                       41640019
*                                                                       41680019
* STEP REG A TO NEXT R ON CURRENT TRACK                                 41720019
*                                                                       41760019
         A     R5,ISLONEF               C(R5)=000R+1                    41800019
*                                                                       41840019
* TEST IF NEXT BUFFR TO BE FILLED IS AVAILABLE (STATUS BITS)            41880019
*                                                                       41920019
ISLPA50  L     R3,IOBPTRB               C(R3)=PTR B = A(NEXT SLOT) OR-  41960019
         LA    R3,0(R3)                 C(R3)=A(STATUS BITS)            42000019
         TM    0(R3),X'60'              TEST BITS 1 AND 2               42040019
         BC    8,ISLPA70                B IF 00 = BUFFR AVAILABLE       42080019
*                                                                       42120019
*                                       BITS 1 AND 2 = 11 OR 10         42160019
*                                                                       42200019
* WAIT FOR CP18, AND/OR CP20, AND/OR CP21 BEFORE RE-FILLING BUFFER      42240019
*                                                                       42280019
ISLPA60  L     R4,IOBECBAD              C(R4)=A(ECB)                    42320019
         TM    0(R4),X'40'              TEST ECB BIT 1 (C-BIT)          42360019
         BC    1,ISLPA70                B IF 1, I/O COMPLETE-DONT WAIT  42400019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 42440019
         LR    R3,R1                    SAVE R1                         42480019
         LR    R1,R4                    C(R1)=A(ECB)                    42520019
         LR    R4,R0                    SAVE R0                         42560019
         WAIT  ECB=(1)                  WAIT                            42600019
         LR    R0,R4                    RESTORE R0                      42640019
         LR    R1,R3                    RESTORE R1                      42680019
         L     R3,IOBPTRB               C(R3)=PTR B = A(NEXT SLOT) OR-  42720019
         LA    R3,0(R3)                 C(R3)=A(STATUS BITS)            42760019
*                                                                       42800019
*                                                                       42840019
* TEST DCBEXCD1 BIT 5 FOR PREVIOUS UNCORRECTABLE WRITE ERROR            42880019
*                                                                       42920019
ISLPA70  TM    DCBEXCD1,X'04'           TEST EXCD1 BIT 5                42960019
         BC    8,ISLPA72                B IF NOT ON                     43000019
         TM    IOBFLAGS,X'10'           TEST FLAGS BIT 3 (CLOSE)        43040019
         BC    1,ISLPA72                B IF ON = CLOSE                 43080019
         B     ISLFX02                  BRANCH TO TAKE SYNAD     A38521 43180021
*                                                                       43440019
ISLPA72  EQU   *                                                        43480019
         LA    R2,ISLIOBB               C(R2)=A(IOBB)                   43520019
         TM    0(R3),X'04'              TEST BIT 5 (C-BIT)              43560019
         BC    7,ISLPA60                BR IF 1 - C-BIT ON              43600019
*                                                                       43640019
*                                       C-BIT OFF                       43680019
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   43720019
*                                                                       43760019
* TEST IF NEXT BUFFER TO BE FILLED WILL BE EOT (AND EOC)                43800019
* IF EOT, TURN ON T-BIT  IF EOC, TURN ON C-BIT                          43840019
*                                                                       43880019
ISLPA80  CR    R7,R5                    TEST REG C VS REG A             43920019
         BNE   ISLPA84                  B IF NOT EOT                    43960019
*                                                                       44000019
*                                       NEXT BUFFER EOT                 44040019
         OI    0(R3),X'08'              TURN T-BIT ON (STATUS BIT 4)    44080019
         ST    R6,ISLFXWK1              C(FXWK1)= CCHH FROM REG B       44120019
ISLPA8A  NC    ISLFXWK1+3(1),DCBFIRSH+3 REDUCE TO TRACK FROM REG B      44160019
ISLPA8B  CLC   DCBLDT+1(1),ISLFXWK1+3   H OF LDT VS H FROM REG B        44200019
         BNE   ISLPA84                  B IF NOT LDT                    44240019
         OI    0(R3),X'04'              TURN C-BIT ON (STATUS BIT 5)    44280019
*                                                                       44320019
* ENTER NEW COUNT IN BUFFER USING REG A AND REG B AND UPDATE LPDA       44360019
*                                                                       44400019
ISLPA84  L     R3,0(R3)                 C(R3)=C(SLOT S)=A(NEXT BUFFR)   44440019
         LA    R3,0(R3)                                                 44480019
         ST    R6,ISLFXWK2              STORE CCHH FROM REG B           44520019
         MVC   0(4,R3),ISLFXWK2                                         44560019
         STC   R5,4(R3)                 STORE R FROM REG A              44600019
         MVC   DCBLPDA+3(5),0(R3)       STORE CCHHR FROM BUF IN LPDA    44640019
         L     R14,ISLF9WK1             RESTORE R14 FOR RETURN TO FX    44680019
         BR    R14                     *EXIT                            44720019
*---------------------------------------------------------------------- 44760019
*                                                                       44800019
*                                       LAST BUFFR FILLED EOT           44840019
* SET REG 7 (REG C) = HIRPD, NEXT TRACK CANT BE SHARED                  44880019
*                                                                       44920019
ISLPA20  IC    R7,DCBHIRPD              NOT A SHARED TRACK, C(R7)=HIRPD 44960019
         ST    R6,ISLFXWK1              C(FXWK1)=CCHH FROM REG B        45000019
*                                                                       45040019
* TEST FOR OUT-OF-SPACE                                                 45080019
*                                                                       45120019
         CLC   DCBLPDA(1),DCBMSWA       CURRENT M VS HI M               45160019
         BNE   ISLPA21                  B IF NOT HI PRIME M             45200019
         CLC   ISLFXWK1(4),DCBMSWA+3    CURRENT CCHH VS HI CCHH         45240019
         BNE   ISLPA21                  B IF NOT HI PRIME CCHH          45280019
         TM    IOBFLAGS,X'10'           TEST FOR CLOSE                  45320019
         BO    ISLPA21                  IF IN CLOSE,BRANCH TO GET 17925 45360019
*                                       COUNT,ELSE OUT OF SPACE   17925 45400019
*                                      *---------OUT-OF-SPACE---------* 45440019
ISLPA205 EQU   *                                                        45480019
         OI    DCBEXCD1,X'20'           SET EXCD1 BIT 2 ON = SPACE ERR  45520019
         L     R13,ISLVRSAV+4           RESTORE USER REG 13    @ZA10226 45540037
         B     ISLFX04A                 B TO TAKE SYNAD        @ZA07607 45560037
*                                                                       45600019
* TEST IF LAST BUFFER FILLED WAS EOT AND EOC                            45640019
*                                                                       45680019
ISLPA21  EQU   *                                                        45720019
         EX    R0,ISLPA8A               EXECUTE NC                      45760019
         EX    R0,ISLPA8B               EXECUTE CLC                     45800019
         BE    ISLPA30                  B IF EOT AND EOC                45840019
*                                                                       45880019
*                                       EOT NOT EOC                     45920019
* STEP REG B TO NEXT HH AND SET REG A TO R = 1                          45960019
*                                                                       46000019
         A     R6,ISLONEF               C(R6)=CCHH+1                    46040019
         L     R5,ISLONEF               C(R5)=000R, R = 1               46080019
         B     ISLPA50                                                  46120019
*                                                                       46160019
*                                                                       46200019
*                                       EOT,EOC                         46240019
* NEXT BUFFER TO BE FILLED WILL BE THE 1ST BUFFR ON A NEW CYLINDER      46280019
*                                                                       46320019
* TEST IF SHARED TRACKS                                                 46360019
*                                                                       46400019
ISLPA30  CLI   DCBHIRSH,X'00'           HIRSH VS 0                      46440019
         BE    ISLPA31                  B IF 0, NOT SHARED              46480019
*                                                                       46520019
*                                       SHARED TRACKS                   46560019
* IF SHARED TRACKS, 1ST PRIME DATA ON NEW CYLINDER IS ON A SHARED TRACK 46600019
*                                                                       46640019
         L     R3,IOBPTRB               C(R3)=PTR B = A(NEXT SLOT) OR-  46680019
         OI    0(R3),X'02'              TURN PF-BIT ON (STATUS BIT 6)   46720019
*                                                                       46760019
* SET REG 7 (REG C) = HIRSH                                             46800019
*                                                                       46840019
         IC    R7,DCBHIRSH              SHARED TRACK NEXT, C(R7)=HIRSH  46880019
*                                                                       46920019
* TEST IF LAST BUFFER FILLED WAS EOT, EOC, AND EOE                      46960019
*                                                                       47000019
ISLPA31  L     R8,DCBDEBAD              C(R8)=A(DEB)                    47040019
         L     R3,DEBFPEAD              C(R3)=A(1ST PRIME EXTENT ENTRY) 47080019
         LA    R3,0(R3)                                                 47120019
         L     R4,DCBLPDA               C(R4)=MBBC                      47160019
         SRL   R4,24                    C(R4)=000M                      47200019
         BCTR  R4,0                     C(R4)=M-1                       47240019
         SLL   R4,4                     C(R4)=000M-1 X 16 (USE AS INDX) 47280019
         L     R8,12(R4,R3)             C(R8)=HHXX-END HH OF CURR EXTNT 47320019
         SRL   R8,16                    C(R8)=00HH                      47360019
*                                                                       47560019
         L     R8,8(R4,R3)              C(R8)=END HHCC OF CURR EXTENT   47600019
         SLL   R8,16                    C(R8)=CC00                      47640019
         SRL   R8,16                    C(R8)=00CC=END CC OF EXTENT     47680019
         LR    R5,R6                    C(R5)=CCHH                      47720019
         SRL   R5,16                    C(R5)=00CC=CC JUST FILLED       47760019
         CR    R8,R5                    COMPARE FOR LAST CYLINDER       47800019
         BH    ISLPA33                  B IF END CC IS HIGH             47840019
*                                                                       47880019
*                                       EOT, EOC, AND EOE               47920019
*                                                                       47960019
* SET REG 6 (REG B) TO CC FROM NEXT EXTENT                              48000019
*                                                                       48040019
         LA    R4,16(R4)                C(R4)=MX16  INDEX TO NEXT EXTNT 48080019
         L     R8,4(R4,R3)              C(R8)=STR BBCC OF NEXT EXTENT   48120019
         SLL   R8,16                    C(R8)=CC00                      48160019
         LR    R6,R8                    C(R6)=CC00, HH SET LATER        48200019
*                                                                       48240019
* SET M IN DCBLPDA = M+1                                                48280019
*                                                                       48320019
         SRL   R4,4                     C(R4)=000M                      48360019
         A     R4,ISLONEF               C(R4)=000M+1 (M=1 FOR EXTENT 0) 48400019
         STC   R4,DCBLPDA               C(LPDA)=000M+1                  48440019
*                                                                       48480019
* SET STATUS BIT-3 ON = NEW EXTEN STARTS WITH THIS BUFFR                48520019
*                                                                       48560019
         L     R3,IOBPTRB               C(R3)=PTR B = A(NEXT SLOT) OR-  48600019
         LA    R3,0(R3)                 C(R3)=A(STATUS BITS)            48640019
         OI    0(R3),X'10'              TURN STATUS BIT-3 ON            48680019
*                                                                       48720019
         B     ISLPA34                                                  48760019
*                                                                       48800019
*                                                                       52680019
* SET REG 6 (REG B) TO CC +1            EOT, EOC, NOT EOE               52720019
*                                                                       52760019
ISLPA33  A     R5,ISLONEF               C(R5)=00CC+1, PREVIOUS CC +1    52800019
         SLL   R5,16                    C(R5)=CC00                      52840019
         LR    R6,R5                    C(R6)=CC00, HH SET BELOW        52880019
*                                                                       52920019
* SET REG 6 (REG B) TO HH FROM FIRSH                                    52960019
*                                                                       53000019
ISLPA34  ST    R6,ISLFXWK1              C(FXWK1)=CC00                   53040019
         MVC   ISLFXWK1+2(2),DCBFIRSH   C(FXWK1)=CCHH, HH FROM FIRSH    53080019
         L     R6,ISLFXWK1              C(R6)=CCHH                      53120019
*                                                                       53160019
* SET REG 5 (REG A) TO R FROM FIRSH                                     53200019
*                                                                       53240019
         SR    R5,R5                                                    53320019
         IC    R5,DCBFIRSH+2            C(R5)=000R, R FROM FIRSH        53360019
*                                                                       53400019
* PREFORMAT SHARED TRACK OF NEW CYLINDER IF NECESSARY                   53440019
*                                                                       53480019
         TM    DCBOPTCD,X'08'           TEST OPTCD BIT-4 FOR CYL OVFL   53520019
         BC    1,ISLPA40                B IF ON = CYL OVFL              53560019
         CLI   DCBHIRSH,X'00'           TEST HIRSH VS 0                 53600019
         BE    ISLPA50                  B IF 0, NOT SHARED              53640019
*                                                                       53680019
*                                       SHARED TRACKS - PREFORMAT       53720019
*                                                                       53760019
* INITIALIZE CP19                                                       53800019
*****************                                                       53840019
*                                                                       53880019
ISLPA40  LA    R2,ISLIOBC               C(R2)=A(IOBC)                   53920019
*                                                                       53960019
* BE SURE CP19 NOT IN USE                                               54000019
*                                                                       54040019
         L     R4,IOBECBAD              C(R4)=A(ECB)                    54080019
         TM    0(R4),X'40'              TEST ECB BIT 1 (C-BIT)          54120019
         BC    1,ISLPA41                B IF 1, I/O COMPLETE-DONT WAIT  54160019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 54200019
         LR    R3,R1                    SAVE R1                         54240019
         LR    R1,R4                    C(R1)=A(ECB)                    54280019
         LR    R4,R0                    SAVE R0                         54320019
         WAIT  ECB=(1)                  WAIT                            54360019
         LR    R0,R4                    RESTORE R0                      54400019
         LR    R1,R3                    RESTORE R1                      54440019
ISLPA41  STM   R2,R11,ISLVRSAV+28       SAVE REGS 2-11                  54480019
*                                                                       54520019
*  1. SET IOBC+32 TO NEW CC AND NEW M IF ANY                            54560019
*                                                                       54600019
         ST    R6,ISLFXWK2              C(FXWK2)=CCHH FROM REG B        54640019
         MVC   32(3,R2),DCBLPDA         MOVE MBB FROM LPDA              54680019
         MVC   35(3,R2),ISLFXWK2        MOVE CCH FROM REG B (FXWK2)     54720019
*                                                                       55040019
*  2. SET CM27 TO NEW CC AND NEW M IF ANY                               55080019
*                                                                       55120019
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 55200019
         L     R10,16(R10)              C(R10)=A(CP19)                  55240019
         USING CM1,R10                  ADDRESSABILITY CP19      S20201 55260020
         MVC   CM27(L3),DCBLPDA         MOVE MBB FROM LPDA       S20201 55290020
         MVC   CM27+K3(L4),ISLFXWK2     MOVE CCHH FROM FXWK2     S20201 55310020
         DROP  R10                                               S20201 55330020
*                                                                       55360019
*  3. SET UP AREA Z WITH NEW CC                                         55400019
*                                                                       55440019
         LA    R9,ISLAREAZ              C(R9)=A(AREA Z)                 55480019
         L     R3,ISL10                 C(R3)=10 = COUNT                55520019
         LA    R4,6(R9)                 C(R4)=A(Z+6)                    55560019
ISLPA42  MVC   0(4,R4),ISLFXWK2         STORE CCHH IN Z                 55600019
         A     R4,ISL8                  STEP Z                          55640019
         BCT   R3,ISLPA42               LOOP                            55680019
*                                                                       55720019
*                                                                       55760019
* EXECUTE CP19 - PREFORMAT NEW CYLINDER                                 55800019
***************************************                                 55840019
*                                                                       55880019
         LM    R2,R11,ISLVRSAV+28       RESTORE REGS 2-11               55920019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 55960019
         LR    R3,R0                    SAVE R0                         56000019
         LR    R4,R1                    SAVE R1                         56040019
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         56080019
         LR    R0,R3                    RESTORE R0                      56120019
         LR    R1,R4                    RESTORE R1                      56160019
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   56200019
*                                                                       56240019
         B     ISLPA50                                                  56280019
*                                                                       56320019
*---------------------------------------------------------------------- 56360019
*                                                                       56400019
         EJECT                                                          56440019
*********************************************************************** 56480019
* CHART PB - SET FBW                                                  * 56520019
*********************************************************************** 56560019
*                                                                       56600019
*                                                                       56640019
* C(R7)=A(LAST SLOT SCHED) AS IT WAS FROZEN BEFORE I/O                  56680019
*    SET REG 8 = NO OF BUFFRS NEEDED TO COMPLETE TRACK  - REG C         56720019
*                                                                       56760019
ISLPB01  L     R6,0(R7)                 C(R6)=A(LAST BUFF)              56800019
         LA    R6,0(R6)                                                 56840019
         SR    R3,R3                                                    56880019
         SR    R8,R8                                                    56920019
         IC    R3,4(R6)                 C(R3)=LAST R                    56960019
*                                                                       57000019
* TEST IF SHARED TRACKS ARE USED                                        57040019
*                                                                       57080019
         IC    R8,DCBHIRPD              C(R8)=HIRPD                     57120019
         CLI   DCBHIRSH,X'00'           HIRSH VS 0                      57160019
         BE    ISLPB02                  B IF 0, NO SHARED TRACKS        57200019
*                                                                       57240019
* TEST IF CURRENT TRACK SHARED                                          57280019
*                                                                       57320019
ISLPB01A MVC   ISLFXWK1(1),3(R6)        H (TRK BYTE) FROM BUFFER CNT    57360019
         EX    R0,ISLPA01A              REDUCE TO TRACK ADDR            57400019
         EX    R0,ISLPA01B              H OF FIRSH VS H OF BUFFER CNT   57440019
         BE    ISLPB03                  B IF EQUAL, TRACK SHARED        57480019
*                                                                       57520019
* TEST IF LAST BUFF WAS EOC, IF SO- NEXT TRACK IS SHARED                57560019
*                                                                       57600019
         TM    0(R7),X'04'              TEST S BIT 5 VS 1 (C-BIT)       57640019
         BC    1,ISLPB05                B IF 1, EOC                     57680019
*                                                                       57720019
* 1. SHARED TRACKS-                                                     57760019
*        CURR TRACK NOT SHARED AND NOT EOC                              57800019
* 2. SHARED TRACKS NOT USED-                                            57840019
*                                                                       57880019
ISLPB02  EQU   *                                                        57920019
         TM    0(R7),X'08'              TEST S BIT 4 VS 1 (T-BIT)       57960019
         BC    1,ISLPB06                B IF 1, EOT                     58000019
         B     ISLPB06A                                                 58040019
*                                                                       58080019
* 3. SHARED TRACKS-                                                     58120019
*        CURR TRACK SHARED                                              58160019
*                                                                       58200019
ISLPB03  TM    0(R7),X'08'              TEST S BIT 4 VS 1 (T-BIT)       58240019
         BC    1,ISLPB06                B IF 1, EOT                     58280019
         IC    R8,DCBHIRSH              C(R8)=HIRSH                     58320019
         B     ISLPB06A                                                 58360019
*                                                                       58400019
* 4. SHARED TRACKS-                                                     58440019
*        CURR TRACK NOT SHARED, BUT EOC                                 58480019
*                                                                       58520019
ISLPB05  IC    R8,DCBHIRSH              C(R8)=HIRSH                     58560019
         IC    R3,DCBFIRSH+2            C(R3)=FIRSH R                   58600019
         A     R8,ISLONEF               C(R8)=HIRSH-FIRSH R +1          58640019
*                                                                       58680019
ISLPB06A SR    R8,R3                    C(R8)=HIRSH-FIRSH R OR R+1      58720019
*   REG C = HI R IF FULL TRACK TO BE WRITTEN                            58760019
*   REG C = HI R - R IF PARTIAL TRACK TO BE WRITTEN                     58800019
*                  R = NO. OF BUFFERS WRITTEN SO FAR ON THIS TRACK      58840019
*                                                                       58880019
ISLPB06  ST    R8,ISLFBW                R8 = REG C, C(FBW)=C(REG C)     58920019
*                                                                       58960019
* TEST NEW FBW VS BUFNO AND ADJUST FBW IF NECESSARY                     59000019
*                                                                       59040019
         LA    R4,1                     C(R4)=1                         59080019
         CLC   ISLFBW+3(1),ISLBUFNO     TEST FBW VS BUFNO               59120019
         BL    ISLPB20                  B IF FBW LOW                    59160019
*                                                                       59200019
*                                       FBW HI OR EQ -                  59240019
*                                                                       59280019
         CLC   ISLBUFNO(1),ISLONEF+3    TEST BUFNO VS 1                 59320019
         BE    ISLPB10                  B IF BUFNO = 1                  59360019
*                                                                       59400019
         IC    R4,ISLBUFNO              BUFNO NOT 1, C(R4)=BUFNO        59440019
         BCTR  R4,0                     C(R4)-BUFNO-1             P4701 59480019
*                                                                       59520019
*                                       BUFNO=1                         59560019
ISLPB10  EQU   *                                                        59600019
         ST    R4,ISLFBW                C(FBW)=1                        59640019
*                                                                       59680019
ISLPB20  B     ISLFY41                 *EXIT                            59720019
         EJECT                                                          59760019
*********************************************************************** 59800019
* CHART F8 - INITIALIZE CP18 FOR CURRENT BUFFER SET                   * 59840019
*********************************************************************** 59880019
*                                                                       59920019
*                                                                       59960019
* SET OFFST AND D ACCORDING TO RECFM (IOBA FLAGS BIT 7)                 60000019
*                                                                       60040019
ISLF801  L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 60080019
*                                                                       60360019
* CALC FSTBF = # OF SLOTS SLOT X IS FROM SLOT #1 IN BUF CTRL TABLE      60400019
*                                                                       60440019
ISLF803  L     R3,IOBPTRA               C(R3)=C(PTR A)=A(SLOT X)        60480019
         LA    R3,0(R3)                                                 60520019
         LA    R4,IOBS                  C(R4)=A(SLOT #1)                60560019
         SR    R3,R4                    C(R3)= # OF BYTES X IS FROM #1  60600019
         SRA   R3,2                     DIV BY 4, C(R3)= DIFF IN SLOTS  60640019
         ST    R3,ISLFSTBF              C(FSTBF)= # OF SLOTS FROM #1    60680019
*                                         THAT FIRST BUF SCHED IS       60720019
*                                                                       60760019
* CALC ADDR OF WR CKD X (SCHED TO WR FIRST) FOR TIC IN CP18             60800019
*                                                                       60840019
         L     R5,ISLOFFST              C(R4+R5)=OFFST                  60880019
         MR    R4,R3                    FSTBF X OFFST, C(R5)= THE # OF  60920019
*                                         BYTES WR CKD X IS FROM THE    60960019
*                                         FIRST BYTE OF WR CKD #1       61000019
         L     R10,12(R10)              C(R10)=A(CP18)                  61040019
         LA    R4,24(R10)               C(R4)=A(WR CKD #1)              61080019
         AR    R4,R5                    C(R4)=A(WR CKD X)               61120019
         IC    R6,16(R10)               C(R6)=TIC OP CODE AT CP18+16    61160019
         ST    R4,16(R10)               C(CP18+16)=A(WR CKD X),4 BYTES  61200019
         STC   R6,16(R10)               C(CP18+16)=TIC OP CODE,1 BYTE   61240019
*                                                                       61280019
* LOCATE CC FLAG IN LAST WR CKD THAT WAS EXECUTED (WR CKD X -1) AND     61320019
* TURN CC FLAG ON (CP18)                                                61360019
*                                                                       61400019
         LTR   R3,R3                    FSTBF VS 0                      61440019
         BC    7,ISLF805                B IF NOT ZERO                   61480019
         IC    R3,ISLBUFNO              C(R3)=NO OF BUFFERS             61520019
ISLF805  EQU   *                                                        61560019
         BCTR  R3,0                     C(R3)=BUF N-1                   61600019
         L     R5,ISLOFFST              C(R4+R5)=OFFST                  61640019
         MR    R4,R3                    PREV LAST BUF X OFFST, C(R5)=   61680019
*                                         THE # OF BYTES LAST WR CKD    61720019
*                                         EXECUTED IS FROM THE FIRST    61760019
*                                         BYTE OF WR CKD #1             61800019
         A     R5,ISLD                  C(R5)=# OF BYTES TO CC FLAG     61840019
         AR    R5,R10                   C(R5)=A(CC FLAG OF LAST WR CKD) 61880019
*                                         IN CP18 THAT WAS EXECUTED     61920019
         OI    0(R5),X'40'              TURN ON CC BIT                  61960019
*                                                                       62000019
* CALC LSTBF = FBW SLOTS FROM FSTBF -1, MAY WRAPAROUND                  62040019
*                                                                       62080019
         L     R3,ISLFSTBF              C(R3)=# OF SLOTS FROM SLOT #1   62120019
         A     R3,ISLFBW                C(R3)= FSTBF + FBW              62160019
         BCTR  R3,0                     C(R3)=FSTBF + FBW-1 = LSTBF     62200019
         SR    R4,R4                    C(R4)= 0000                     62240019
         IC    R4,ISLBUFNO              C(R4)=NO OF BUFFRS              62280019
         CR    R3,R4                    LSTBF VS BUFNO, TEST WRAPAROUND 62320019
         BL    ISLF806                  B IF NO WRAPAROUND, LSTBF OK    62360019
         SR    R3,R4                    C(R3)=LSTBF-BUFNO = LSTBF       62400019
*                                         LSTBF SET FOR WRAPAROUND      62440019
ISLF806  ST    R3,ISLLSTBF              C(LSTBF)= # OF SLOTS FROM #1    62480019
*                                         THAT LAST BUF SCHED IS        62520019
*                                                                       62560019
* LOCATE CC FLAG IN LAST WR CKD TO BE EXECUTED(WR CKD X + FBW) AND      62600019
* TURN CC FLAG OFF (CP18)                                               62640019
*                                                                       62680019
         L     R5,ISLOFFST              C(R4+R5)=OFFST                  62720019
         MR    R4,R3                    LSTBF X OFFST, C(R5)= THE # OF  62760019
*                                         BYTES LAST WR CKD TO BE       62800019
*                                         EXECUTED IS FROM THE FIRST    62840019
*                                         BYTE OF WR CKD #1             62880019
         A     R5,ISLD                  C(R5)=# OF BYTES TO CC FLAG     62920019
         AR    R5,R10                   C(R5)=A(CC FLAG OF LAST WR CKD) 62960019
*                                         IN CP18 TO BE EXECUTED        63000019
         NI    0(R5),X'BF'              TURN OFF CC BIT                 63040019
         ST    R5,ISLCCFAD              C(CCFAD)=A(CC FLAG OF LAST WR)  63080019
         EJECT                                                          63120019
*********************************************************************** 63160019
* CHART F9 - INITIALIZE CP20 FOR CURRENT TRACK                        * 63200019
*********************************************************************** 63240019
*                                                                       63280019
         USING ISLY,R9                                                  63320019
*                                                                       63360019
* F9 HOUSEKEEPING                                                       63400019
*                                                                       63440019
ISLF901  L     R6,IOBPTRA               C(R6)=C(PTR A)=A(SLOT X)        63480019
         L     R6,0(R6)                 C(R6)=C(SLOT X)=A(1ST BUF)      63520019
         LA    R6,0(R6)                                                 63560019
         MVC   ISLFXWK1(4),1(R6)        C(FXWK1)=CHHR OF CNT IN 1ST BUF 63600019
         L     R7,ISLFXWK1              C(R7)=CHHR                      63640019
         BCTR  R7,0                     C(R7)=CHHR-1                    63680019
*                                                                       63720019
* TEST LAST BUFFER FOR END OF TRACK (T-BIT ON)                          63760019
*                                                                       63800019
         L     R3,ISLLSTBF              C(R3)=LSTBF                     63840019
         SLA   R3,2                     MULT BY 4, C(R3)=LSTBF IN BYTES 63880019
         LA    R3,IOBS(R3)              C(R3)=A(LSTBF SLOT IN BCT)      63920019
*                                                                       63960019
* SET IOBA+32 (IOBDADAD) = COUNT OF 1ST BUF SCHED, R=R-1 FOR SRCH ID    64000019
*                                                                       64040019
         MVC   IOBDADAD+3(1),0(R6)      C(IOBA+35)=C FROM 1ST BUF       64080019
         ST    R7,IOBDADAD+4            C(IOBA+35)=CHHR WITH R=R-1      64120019
         IC    R4,IOBCPSAD              SAVE SIOCC                      64160019
         ST    R10,IOBCPSAD             C(CPSAD)=CP18 START ADR         64200019
         STC   R4,IOBCPSAD              RESTORE SIOCC                   64240019
         TM    0(R3),X'08'              TEST S BIT 4 VS 1 (T-BIT)       64280019
         BC    1,ISLF902                B IF T-BIT ON                   64320019
*                                                                       64360019
*                                       T-BIT OFF, NO CP20 YET          64400019
*                                                                       64440019
* SET CL1 IN CP18 TO REFERENCE IOBA+35                                  64480019
*                                                                       64520019
INITCP18 LA    R3,IOBDADAD+3            C(R3)=A(IOBA+35)                64560019
         IC    R4,0(R10)                SAVE OP                         64600019
         ST    R3,0(R10)                STORE A(IOBA+35)                64640019
         STC   R4,0(R10)                RESTORE OP                      64680019
*                                                                       64720019
         B     ISLFY21                                                  64760019
         EJECT                                                          64800019
ISLF902  EQU   *                                                        64840019
*                                                                       64880019
         OI    ISLIXLT,X'08'            SET IXLT LEV1 BIT-4 ON-TRK IX   64920019
*                                       TRACK INDEX WRITTEN, BUT        64960019
*                                       NOT CYLINDER INDEX.             65000019
*                                                                       65040019
* GET KEY ADR FROM CP18 ACCORDING TO RECFM (IOBA FLAGS BIT 7)           65080019
*                                                                       65120019
         L     R3,ISLCCFAD              C(R3)=CC FLAG ADR LAST WR CKD   65160019
         TM    IOBFLAGS,X'01'           TEST FLAGS BIT 7 (1=F,RKP 0)    65200019
         BC    1,ISLF903                B IF RECFM IS F,RKP 0           65240019
*                                       RECFM NOT F,RKP 0               65280019
         S     R3,ISL12                 C(R3)=A(CCW WORD 1 OF WR K)     65320019
         L     R3,0(R3)                 C(R3)=C(CCW WORD 1 OF WR K)     65360019
         LA    R3,0(R3)                 C(R3)=A(KEY OF LAST WR CKD)     65400019
         B     ISLF904                                                  65440019
*                                       RECFM IS F,RKP 0                65480019
ISLF903  EQU   *                                                        65520019
         S     R3,ISL4                  C(R3)=A(CCW WORD 1 OF WR CKD)   65560019
         L     R3,0(R3)                 C(R3)=C(CCW WORD 1 OF WR CKD)   65600019
         LA    R3,8(R3)                 C(R3)=A(KEY OF LAST WR CKD)     65640019
*                                                                       65680019
ISLF904  ST    R3,ISLKEYAD              C(KEYAD)=A(KEY OF LAST WR CKD)  65720019
*                                                                       65760019
*                                                                       65800019
         EJECT                                                          65840019
*********************************************************************** 65880019
*                                                                       65920019
*              SET UP MBBCCHHR AT THE BEGINNING OF TISA                 65960019
*                                                                       66000019
*********************************************************************** 66040019
*                                                                       66080019
         LR    R5,R10                   C(R5)=A(CP18,CL1)               66120019
*                                                                       66160019
         L     R10,DCBWKPT6             C(R10)=A(ISLVPTRS)              66200019
         L     R7,ISLVPTRA              GET A(TISA) INTO R7      A38521 66260021
         MVC   0(8,R7),IOBDADAD         A(TISA)=MBB FROM IOBA+32        66320019
*                                                                       66360019
*              SET CL1 IN CP18 TO REFERENCE THE SEEK ADDRESS AT         66400019
*              THE BEGINNING OF TISA.                                   66440019
*                                                                       66480019
         LA    R3,3(R7)                 C(R3)=A(CCHHR AT TISA+3)        66520019
         IC    R4,0(R5)                 SAVE OP                         66560019
         ST    R3,0(R5)                 STORE A(CCHHR AT TISA+3)        66600019
         STC   R4,0(R5)                 RESTORE OP                      66640019
*                                                                       66680019
*         SET UP NORMAL AND OVERFLOW DATA (FROM CP18 SEEK ADDRESS)      66720019
*                                                                       66760019
ISLF908  MVC   ISLNDAT(3),IOBDADAD      C(NDAT)= MBB FROM IOBA+32       66800019
         MVC   ISLNDAT+3(4),0(R6)       C(NDAT)= CCHH FROM 1ST BUF      66840019
         MVC   ISLODAT(7),ISLNDAT       C(ODAT)= MBBCCHH FROM NDAT      66880019
         MVC   ISLNDAT+7(2),ISLZEROF    NORMAL DATA F=00 (UNSHARED)     66920019
*                                       R=00                            66960019
         EJECT                                                          67000019
*********************************************************************** 67040019
*                                                                       67080019
*              SET UP NDAT FP FOR SHARED TRACK                          67120019
*                                                                       67160019
*********************************************************************** 67200019
         CLI   DCBHIRSH,X'00'           SHARED TRACK                    67240019
         BE    INITCNT                  NO - BR TO INIT CNT FIELDS      67280019
         MVC   TSTWK1C(1),ISLNDAT+6     C(TSTWK1C)=H OF NORM DATA       67320019
         NC    TSTWK1C(1),DCBFIRSH+3    REDUCE TO TRACK                 67360019
         CLC   DCBFIRSH+1(1),TSTWK1C    H OF FIRSH VS H OF BUF CNT      67400019
         BNE   INITCNT                  BR IF NOT EQ TO INIT CNT        67440019
         MVI   ISLNDAT+8,X'08'          NORM DATA F = 08 (SHARED)       67480019
         MVC   ISLNDAT+7(1),DCBFIRSH+2  NORM DATA R = FIRSH R           67520019
*                                                                       67560019
*              SET UP CCH IN NORMAL AND OVERFLOW COUNT FIELDS           67600019
*                                                                       67640019
INITCNT  EQU   *                                                        67680019
         MVC   ISLNCNT(K3),K0(R6)       CCHH FROM 1ST BUFFER     M1819  67700021
         MVC   ISLOCNT(K3),ISLNCNT      CCH FROM 1ST BUFFER      M0976  67760021
         MVC   ISLDCNT(K3),ISLNCNT      CCH FROM 1ST BUFFER      M0976  67780021
*                                                                       67840019
*              SET UP COUNT FIELDS IN AREA Y FOR NORMAL AND             67880019
*              OVERFLOW TRACK INDICES.                                  67920019
*                                                                       67960019
         L     R9,0(R10)                C(R9)=A(AREA Y)                 68000019
         MVC   ISLY+26(10),ISLNDAT      C(Y+26)=NORM DATA               68040019
         MVC   ISLY+44(10),ISLODAT      C(Y+44)=OVERFLOW DATA           68080019
         MVC   ISLY+54(8),ISLDCNT       C(Y+54)=DUMMY COUNT             68120019
*                                                                       68160019
*              ESTABLISH ADDRESSIBILITY FOR TISA                        68200019
*                                                                       68240019
         LR    R6,R7                    C(R6)=A(TISA)                   68280019
*                                                                       68320019
         EJECT                                                          68400019
*********************************************************************** 68440019
*                                                                       68480019
*              DETERMINE PATH FOR FULL TRACK INDEX WRITE                68520019
*                                                                       68560019
*********************************************************************** 68600019
ISLFT01  EQU   *                                                        68640019
         CLC   CURRR(1),HIGHR           OVRFLO TI LEFT OVER             68680019
         BNH   ISLFT02                  NO                              68720019
         BAL   R14,OVERFLOW             BR TO OVERFLOW ROUTINE          68760019
*                                                                       68800019
ISLFT02  EQU   *                                                        68840019
         TM    FLAGS,CLOSE1             IS CLOSE FORCING INDEX   A44853 68880000
         BO    CLOSE                    YES-GO TO FTIW CLOSE RTN        68920019
         BAL   R14,MOVETI               BR TO MOVE TI ENTRIES           68960019
*                                                                       69000019
         CLC   DCBLDT+1(1),ISLNDAT+6    LAST PRIME DATA TRACK           69040019
         BE    EOC                      YES-BR TO EOC ROUTINE           69080019
         CLC   CURRR(1),HIGHR           IS TI TRACK FULL                69120019
         BNL   INITTISA                 YES-CONTINUE                    69160019
ISLFT023 EQU   *                                                        69200019
         L     R10,12(R10)              C(R10)=A(CP18)                  69240019
         L     R5,12(R10)               C(R5)=A(CP18 WR CHK SRCH)       69280019
         B     INITCP18                 SET CP18 SRCH TO IOBA+35        69320019
INITTISA EQU   *                                                        69360019
         IC    R4,ISLNCNT+3             HH OF CURRENT TRACK             69400019
         LA    R4,1(R4)                 HH = HH + 1                     69440019
         STC   R4,TSTWK2C               SAVE FOR COMPARE                69480019
LOADR7   EQU   *                                                        69520019
         LA    R7,INIT20                PREPARE FOR BRANCH              69560019
         CLC   CURRR(1),HIGHR           ARE ENTRIES SPLIT               69600019
         BH    RETURN                   YES-WAIT FOR OVERFLOW RTN       69640019
*                                       TO INITIALIZE                   69680019
NEXTTRK  EQU   *                                                        69720019
         LA    R5,TISA+20               C(R5)=A(1ST TI R IN TISA)       69760019
         MVC   HIGHR(1),DCBHIRTI        HIGH R FOR FULL TRACK           69800019
         CLC   ISLNIRT+1(1),TSTWK2C     DUMMY ON NEXT TRACK             69840019
         BNE   ISLFT028                 NO - BRANCH                     69880019
         MVC   HIGHR(1),ISLNIRT+2       SET HIGH R = DUMMY R            69920019
         CLI   DCBHIRSH,X'00'           SHARED TRACK                    69960019
         BNE   ISLFT028                 YES                             70000019
         L     R5,20(R10)               C(R5)=A(CP20A)                  70040019
         L     R5,20(R5)                C(R5)=A(CCW-TRK WITH DUMMY)     70080019
         L     R5,0(R5)                 C(R5)=A(SHR TRK ENTRY-TISA)     70120019
         LA    R5,0(R5)                 CLEAR HIGH ORDER BYTE           70160019
ISLFT028 EQU   *                                                        70200019
         ST    R5,NEXTTI                SET NEXTTI ENTRY & CURR R=0     70240019
RETURN   EQU   *                                                        70280019
         BR    R7                       BR TO INIT20 OR ISLFT03         70320019
         EJECT                                                          70360019
*********************************************************************** 70400019
*                                                                       70440019
*              OVERFLOW ROUTINE  -  NORMAL AND OVERFLOW ENTRIES         70480019
*                                   SPLIT ACROSS TRACKS                 70520019
*                                                                       70560019
*********************************************************************** 70600019
OVERFLOW EQU   *                                                        70640019
         BAL   R16,WAIT                 WAIT ROUTINE FOR FTIW           70680019
         L     R4,NEXTTI                C(R4)=A(NEXT TI ENTRY)          70720019
         SH    R4,SIZE                  NEXT TI-LENGTH OF 1 ENTRY       70760019
         IC    R7,3(R4)                 H FROM OCNT                     70800019
         LA    R7,1(R7)                 H = H + 1                       70840019
         STC   R7,3(R4)                 H + 1 TO OCNT                   70880019
         STC   R7,TSTWK2C               SAVE FOR COMPARE                70920019
         MVI   4(R4),X'01'              SET R = 1                       70960019
         MVC   ISLOCNT+3(2),3(R4)       SET HR FOR NEXT TRACK           71000019
         BAL   R7,NEXTTRK               BR TO INIT NEXT TRK             71040019
ISLFT03  EQU   *                                                        71080019
         BAL   R3,ENTRYMOV              OVERFLOW TI ENTRY IS     A45263 71200021
*                                       MOVED                    A45263 71220021
*                                       IN TISA TO THE BEGINNING        71240019
*                                       OF THE NEXT TRACK               71280019
         AH    R5,SIZE                  C(R5)=1ST ENTRY + TI LENGTH     71320019
         ST    R5,NEXTTI                STORE IN NEXT ENTRY ADDR        71360019
         MVI   CURRR,X'01'              SET CURR R=1                    71400019
         NI    FLAGS,X'CF'              TURN EOC & EOT BITS OFF         71440019
         BR    R14                      RETURN TO ISLFT02,              71480019
*                                       DUMMYTI, OR INACTIVE            71520019
*                                                                       71560019
*                                                                       71600019
*********************************************************************** 71640019
*                                                                       71680019
*              WAIT ROUTINE FOR FULL TRACK INDEX WRITE                  71720019
*                                                                       71760019
*********************************************************************** 71800019
*                                                                       71840019
WAIT     EQU   *                                                        71880019
         LA    R2,ISLIOBA               IOB FOR CP20                    71920019
         BAL   R4,ISLFY99               BR TO WAIT SUBROUTINE           71960019
         TM    DCBEXCD1,X'04'           TEST BIT 5 FOR PREVIOUS         72000019
*                                       UNCORRECTABLE WRITE ERROR       72040019
         BCR   8,R16                    RETURN IF NO ERROR       A38521 72070021
         L     R14,TSTWK1C              RESTORE CLOSE RETURN REG A38521 72100021
         B     ISLFX02                  GO TO SYNAD              A38521 72130021
         EJECT                                                          72160019
*********************************************************************** 72200019
*                                                                       72240019
*              ROUTINE TO MOVE TRACK INDEX ENTRIES TO THE TRACK         72280019
*              INDEX SAVE AREA                                          72320019
*                                                                       72360019
*********************************************************************** 72400019
*                                                                       72440019
MOVETI   EQU   *                                                        72480019
         BAL   R16,WAIT                 BR TO WAIT ROUTINE FOR FTIW     72520019
         SR    R3,R3                    CLEAR REG 3                     72560019
         IC    R7,CURRR                 C(R3)=CURR R                    72600019
         LA    R7,2(R7)                 C(R3)=CURR R+2                  72640019
         TM    FLAGS,X'10'              IS THE EOC FLAG ON              72680019
         BNO   CHECKEOT                 NO-CHECK FOR EOT BIT ON         72720019
         NI    FLAGS,X'CF'              TURN EOC & EOT FLAGS OFF        72760019
         L     R6,IOBPTRA               C(R6)=C(PTR A)=A(SLOT X) M1819  72762021
         L     R6,0(R6)               C(R6)=C(SLOT X)=A(1ST BUF) M1819  72764021
         MVC   ISLNCNT+K3(K1),K3(R6)    GET CYL FOR 2301         M1819  72766021
         OC    ISLNCNT+K3(K1),DCBHMASK  TURN ON ALL TRK BITS     M0976  72770021
         XC    ISLNCNT+K3(K1),DCBHMASK  SET TRACK TO ZERO        M0976  72780021
         MVC   ISLOCNT+K3(K1),ISLNCNT+K3  MOVE TO OCNT           M0976  72790021
         MVI   ISLNCNT+K4,K1            SET R TO 1               A38521 72800021
         MVI   ISLOCNT+K4,K2            SET R TO 2               A38521 72840021
         L     R6,ISLVPTRA              C(R6) = A(TISA)          M1819  72850021
         B     MOVENORM                 MOVE NORMAL TI ENTRY            72880019
CHECKEOT EQU   *                                                        72920019
         TM    FLAGS,X'20'              IS THE EOT FLAG ON              72960019
         BNO   COUNT                    NO - GO MOVE TI ENTRY           73000019
         NI    FLAGS,X'DF'              TURN EOT BIT OFF                73040019
         IC    R4,ISLNCNT+3             C(R4)=LOW ORDER H         M1819 73080021
         LA    R4,1(R4)                 C(R4)=H+1                       73120019
         STC   R4,ISLNCNT+3             SET H = H+1                     73160019
         STC   R4,ISLOCNT+3             H+1 FOR OCNT                    73200019
         MVI   ISLNCNT+4,X'01'          SET R = 1                       73240019
         MVI   ISLOCNT+4,X'02'          SET R = 2                       73280019
         B     MOVENORM                 MOVE NORMAL TI ENTRY            73320019
*                                                                       73360019
*              BUMP NORMAL AND OVERFLOW COUNT FIELDS                    73400019
*                                                                       73440019
COUNT    EQU   *                                                        73480019
         IC    R3,ISLOCNT+4             C(R3)=R FROM OCNT               73520019
         LA    R3,1(R3)                 C(R3)=R+1                       73560019
         STC   R3,ISLNCNT+4             C(NCNT)=R+1                     73600019
         LA    R3,1(R3)                 C(R3)=R+2                       73640019
         STC   R3,ISLOCNT+4             C(OCNT)=R+2                     73680019
         MVC   ISLNCNT+2(2),ISLOCNT+2   C(NCNT)=CCHHR, HH FROM OCNT     73720019
*                                                                       73760019
*                                                                       73800019
         MVC   ISLY+18(8),ISLNCNT       C(Y+18)=NORM COUNT              73840019
         MVC   ISLY+36(8),ISLOCNT       C(Y+36)=OVRFLOW COUNT           73880019
         EJECT                                                          73920019
*********************************************************************** 73960019
*                                                                       74000019
*              MOVE TRACK INDEX ENTRIES TO THE TRACK INDEX SAVE AREA    74040019
*                                                                       74080019
*********************************************************************** 74120019
*                                                                       74160019
*              NORMAL TRACK INDEX ENTRY                                 74200019
*                                                                       74240019
MOVENORM EQU   *                                                        74280019
         L     R5,NEXTTI                C(R5)=A(NEXT NORM TI)           74320019
         MVC   0(8,R5),ISLNCNT          MOVE NCNT TO TISA COUNT         74360019
         L     R4,ISLKEYAD              C(R4)=A(KEY)                    74400019
         IC    R3,DCBKEYLE              C(R3)=KEY LENGTH                74440019
         BAL   R16,MOVENTRY             MOVE NORMAL ENTRY TO TISA       74480019
         MVC   0(10,R5),ISLNDAT         MOVE DATA TO TISA               74520019
*                                                                       74560019
*              OVERFLOW TRACK INDEX ENTRY                               74600019
*                                                                       74640019
         LA    R5,10(R5)                C(R5)=A(OCNT IN TISA)           74680019
         MVC   0(8,R5),ISLOCNT          MOVE OCNT TO TISA               74720019
         LA    R16,MOVEODAT             PREPARE FOR BR R16              74760019
MOVENTRY EQU   *                                                        74800019
         LA    R5,8(R5)                 C(R5)=A(KEY IN TISA)            74840019
         BCTR  R3,0                     C(R3)=KEYLEN-1,FOR EXECUTE      74880019
         EX    R3,MOVE                  MOVE KEY TO TISA                74920019
         LA    R3,1(R3)                 C(R3)=KEYLENGTH                 74960019
         AR    R5,R3                    C(R5)=A(DATA IN TISA)           75000019
         BR    R16                      BR TO MOVEODAT OR N TI MOVE     75040019
MOVEODAT EQU   *                                                        75080019
         MVC   0(10,R5),ISLODAT         MOVE DATA TO TISA               75120019
         L     R3,NEXTTI                C(R3)=A(NEXT TI ENTRY)          75160019
         AH    R3,SIZE                  C(R3)=NEXT + TI LENGTH          75200019
         AH    R3,SIZE                  C(R3)=NEXT + TI LENGTH          75240019
         ST    R3,NEXTTI                A(NXT TI)= NEXT + 2(TI LN)      75280019
         STC   R7,CURRR                 SET CURR R=R+2                  75320019
         BR    R14                      RETURN                          75360019
         EJECT                                                          75440019
*********************************************************************** 75480019
*                                                                       75520019
*        END OF CYLINDER ROUTINE                                        75560019
*                                                                       75600019
*********************************************************************** 75640019
*                                                                       75680019
EOC      EQU   *                                                        75720019
         CLC   CURRR(1),HIGHR           OVRFLO TI LEFT OVER (C>H)       75760019
         BL    DUMMYTI                  NO-BR TO MOVE DUMMY TI          75800019
         BE    WRITETRK                 WRITE FULL TRACK                75880019
         OI    FLAGS,X'08'              EXEC CP20 ONLY           M4881  75900019
         LA    R14,OVFLOW               C(R14)=A(OVFLOW)                75920019
         B     INIT20                   BR FOR CP20 INIT                75960019
WRITETRK EQU   *                                                        76000019
         OI    FLAGS,X'08'              EXEC CP20 ONLY           M4881  76020019
         BAL   R14,INITTISA             INIT TISA FOR NEXT TRACK,       76040019
*                                       THEN WRITE DUMMY ENTRY ONLY     76080019
BUMPCNT  EQU   *                                                        76120019
         IC    R4,ISLOCNT+3             H FROM OCNT                     76160019
         LA    R4,1(R4)                 H=H+1                           76200019
         STC   R4,ISLOCNT+3             SET H FOR NEXT TRACK            76240019
         B     DUMMYTI                  BR TO MOVE DUMMY ENTRY          76280019
OVFLOW   EQU   *                                                        76320019
         BAL   R14,OVERFLOW             BR TO OVERFLOW ROUTINE          76360019
DUMMYTI  EQU   *                                                        76400019
         L     R5,NEXTTI                C(R5)=A(NEXT ENTRY)             76440019
         LA    R4,ISLY+54               C(R4)=A(DCNT IN AREA Y)         76600019
         MVC   ISLY+57(2),ISLNIRT+1     HR OF DUMMY ENTRY               76640019
         BAL   R3,ENTRYMOV              MOVE DUMMY TI TO TISA    A45263 76680021
         MVI   TSTWK2C,X'00'            SET HH=0 FOR COMPARE            76720019
         B     LOADR7                   INIT TISA BEFORE EXCP20         76760019
         EJECT                                                          76800019
*********************************************************************** 76840019
*                                                                       76880019
*              EXECUTE CP20 WITHOUT CP18                                76920019
*                                                                       76960019
*********************************************************************** 77000019
EXCP20   EQU  *                                                         77040019
         L     R7,IOBCPSAD              C(R7)=A(CP20)                   77080019
         LA    R7,0(R7)                 CLEAR HIGH ORDER BYTE           77120019
         L     R7,12(R7)                C(R7)=A(CP18 TIC)               77160019
         S     R7,ISL12                 C(R7)=A(FLAGS-LAST WR CCW)      77200019
         NI    0(R7),X'BF'              TURN OFF COMMAND CHAIN BIT      77240019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 77280019
         LR    R3,R0                    SAVE R0                         77320019
         LR    R4,R1                    SAVE R1                         77360019
         LR    R5,R14                   SAVE R14                        77400019
*                                                                       77440019
*              SET FLAGS BIT 0 = 1, CP IS NOT AVAILABLE                 77480019
*                                                                       77520019
         OI    IOBFLAGS,X'80'           TURN ON FLAGS BIT 0             77560019
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM 20      77600019
         LR    R0,R3                    RESTORE R0                      77640019
         LR    R1,R4                    RESTORE R1                      77680019
         LR    R14,R5                   RESTORE R14                     77720019
         BAL   R16,WAIT                 BR TO WAIT ROUTINE FOR FTIW     77760019
         NI    FLAGS,X'F7'              TURN EXCP20 ONLY BIT OFF        77800019
         OI    0(R7),X'40'              TURN COMND CHAIN BIT ON         77840019
         BR    R14                      RETURN TO OFLOW, OVFLOW,        77880019
*                                       BUMPCNT OR IGG0202I             77920019
         EJECT                                                          77960019
*********************************************************************** 78000019
*                                                                       78040019
*              CLOSE ROUTINE                                            78080019
*                                                                       78120019
*********************************************************************** 78160019
*                                                                       78200019
CLOSE    EQU   *                                                        78240019
         TM    FLAGS,CLOSE2             IS CLOSE FORCING INDEX   S20201 78280020
         BO    SKPMOVE                  YES-DO NOT MOVE TI ENTRY S20201 78360020
         BAL   R14,MOVETI               BR TO MOVE TI ENTRIES           78440019
SKPMOVE  EQU   *                                                        78480019
         LA    R7,INIT20                RETURN FROM NEXTTRK RTN  A44853 78490000
         OI    FLAGS,CP20BIT            INDICATE EXCP CP20 ONLY  A44853 78500000
         CLC   CURRR(1),HIGHR           OVERFLOW LEFT OVER              78520019
         BE    NEXTTRK                  FULL TRK OF TRK INDEX    A44853 78560000
         BH    CP20FLG                  YES - CONTINUE                  78600019
         BAL   R16,WAIT                 BR TO WAIT ROUTINE FOR FTIW     78640019
         B     INACTIVE                 CONTINUE                        78680019
CP20FLG  EQU   *                                                        78720019
         OI    FLAGS,X'08'              TURN BIT ON TO EXCP20 ONLY      78760019
         BAL   R14,INIT20               BR TO EXCP20 ONLY               78800019
OFLOW    EQU   *                                                        78840019
         BAL   R14,OVERFLOW             BR-TI LEFT OVER                 78880019
INACTIVE EQU   *                                                        78960019
INACT    EQU   *                                                        79400019
         OI    FLAGS,X'08'              TURN BIT ON TO EXCP20 ONLY      79440019
INACT2   EQU   *                                                        79480019
         L     R5,NEXTTI                C(R5)=A(NEXT ENTRY)             79520019
         LA    R4,ISLY+54               C(R4)=A(INACTIVE ENTRY)         79560019
         LA    R7,ISLY+70               C(R7)=F BYTE IN DUM DATA        79600019
         SR    R3,R3                    CLEAR REGISTER 3                79640019
         IC    R3,DCBKEYLE              C(R3)=KEY LENGTH                79680019
         AR    R7,R3                    C(R7)=AREA Y+70+KL              79720019
         MVI   0(R7),X'30'              SET F BYTE FOR INACTIVE         79760019
         MVC   ISLY+54(7),ISLOCNT       MOVE OCNT TO DCNT IN AREA Y     79800019
         SR    R13,R13                  CLEAR REGISTER 13               79840019
         IC    R13,CURRR                C(R13)=CURRENT R                79880019
         LA    R13,1(R13)               C(R13)=R+1                      79920019
         STC   R13,ISLY+58              SET DCNT = CURR R+1             79960019
         CLC   ISLY+57(2),ISLNIRT+1     READY FOR DUMMY ENTRY           80080019
         BE    MOVEDUMY                 YES - MOVE DUMMY ENTRY          80120019
MOVEINAC EQU   *                                                        80160019
         BAL   R3,ENTRYMOV              MOVE INACTIVE TI TO TISA A45263 80200021
         AH    R5,SIZE                  C(R5)=A(NEXT ENTRY+TI LEN)      80240019
         LA    R13,1(R13)               C(R13)=R+1 FOR INACTIVE CNT     80280019
         STC   R13,ISLY+58              SET R=R+1                       80320019
         CLC   ISLY+58(1),HIGHR         END OF TRK INDEX YET            80360019
         BL    MOVEINAC                 NO-MOVE ANOTHER INACTIVE TI     80400019
         CLC   ISLY+57(2),ISLNIRT+1     DUMMY ON THIS TRACK             80440019
         BNE   MOVELAST                 NO-MOVE LAST ENTRY              80480019
MOVEDUMY EQU   *                                                        80520019
         MVI   0(R7),X'20'              SET F BYTE IN DDATA-DUMMY       80560019
MOVELAST EQU   *                                                        80600019
         BAL   R3,ENTRYMOV              MOVE DUMMY TI TO TISA    A45263 80640021
         OI    FLAGS,X'08'              TURN BIT ON TO EXCP20 ONLY      80680019
         TM    DCBST,X'02'              LAST BLOCK FULL                 80720019
         BO    LOAD14                   YES - STATUS BITS OK            80760019
         NI    DCBST,X'FE'              NO-TURN END OF TRK BIT OFF      80800019
LOAD14   EQU   *                                                        80840019
         L     R14,TSTWK1C              RESTORE R14 FOR CLOSE           80880019
         EJECT                                                          80920019
*********************************************************************** 80960019
*                                                                       81000019
*              EXCP 20 ROUTINE                                          81040019
*                                                                       81080019
*********************************************************************** 81120019
*                                                                       81160019
*              THE MBBCCHHR FOR THE PRIME DATA TRACK IS AT THE          81200019
*              BEGINNING OF THE TRACK INDEX SAVE AREA (TISA)            81240019
*                                                                       81280019
*              THE MBBCCHHR FOR THE TRACK INDEX TRACK IS IN IOBA        81320019
*                                                                       81360019
INIT20   EQU  *                                                         81400019
         BAL   R16,WAIT                 BR TO WAIT ROUTINE FOR FTIW     81440019
         MVC   IOBDADAD+3(4),ISLOCNT    MOVE CCHH TO IOB SEEK           81480019
         MVI   IOBDADAD+7,X'00'         SET R = 0 FOR SEARCH            81520019
*                                                                       81560019
         OI    FLAGS,X'20'              TURN EOT BIT ON                 81600019
*                                                                       81640019
*              RESUME LOAD WITH FULL TRACK INDEX WRITE                  81680019
*                                                                       81720019
         TM    FLAGS,X'80'              RESUME LOAD                     81760019
         BNO   CHECKEOC                 NO - CONTINUE                   81800019
         NI    FLAGS,X'7F'              TURN RESUME LOAD BIT OFF        81840019
         MVC   IOBDADAD+7(1),TSTWK3C    SET R FOR SRCH                  81880019
         L     R3,TSTWK3C               CP START ADDR                   81920019
         CLC   ISLOCNT+3(1),ISLNIRT+1   END OF CYLINDER                 81960019
         BNE   CPADDR                   NO -- BR TO SET CP ADDR         82000019
         OI    FLAGS,X'10'              TURN EOC BIT ON                 82040019
         B     CPADDR                   BR TO SET CP ADDR               82080019
CHECKEOC EQU   *                                                        82120019
         L     R3,20(R10)               C(R3)=A(CP20A)                  82160019
         CLC   ISLOCNT+3(1),ISLNIRT+1   AT END OF CYLINDER              82200019
         BNE   FULL20A                  NO - EXECUTE CP20A              82240019
         OI    FLAGS,X'10'              TURN EOC BIT ON                 82280019
         CLI   DCBHIRSH,X'00'           SHARED TRACK                    82320019
         BNE   INIT20B                  YES - EXECUTE CP20B             82360019
         EJECT                                                          82400019
*********************************************************************** 82440019
*                                                                       82480019
*              INITIALIZE CP20A FOR END OF CYLINDER                     82520019
*                                                                       82560019
*********************************************************************** 82600019
         L     R5,20(R3)                C(R3)=A(1ST W CKD CCW FOR       82640019
*                                       CP20A WHEN UNSHR TRK W/DUMY     82680019
         BAL   R7,INITTIC               BR TO INITIALIZE TIC            82720019
         B     CPADDR                   BR TO SET CP START ADDR         82760019
*                                                                       82800019
INITTIC  EQU   *                                                        82840019
         ST    R5,16(R3)                RESTORE TIC TO 1ST W CCW        82880019
         MVI   16(R3),X'08'             RESTORE TIC COMMAND CODE        82920019
         BR    R7                       RETURN                          82960019
*********************************************************************** 83000019
*                                                                       83040019
*              INITIALIZE CP20A WHEN NOT END OF CYLINDER                83080019
*                                                                       83120019
*********************************************************************** 83160019
INIT20B  EQU   *                        SET UP 20B              SA54556 83170002
         MVI   IOBDADAD+7,K1            SET R=1 FOR SEARCH      SA54556 83180002
         L     R3,ISLVPTRB              C(R3)=A(CP20B)          SA54556 83190002
FULL20A  EQU   *                                                        83200019
         LA    R5,24(R3)                C(R5)=A(1ST READ CCW)           83240019
         BAL   R7,INITTIC               BR TO INITIALIZE TIC            83280019
*                                                                       83320019
CPADDR   EQU   *                                                        83520019
         IC    R4,IOBCPSAD              SAVE SIOCC                      83560019
         ST    R3,IOBCPSAD              C(CPSAD)=CP20 START ADDR        83600019
         STC   R4,IOBCPSAD              RESTORE SIOCC                   83640019
         TM    FLAGS,X'08'              IS EXCP20 ONLY BIT ON           83680019
         BO    EXCP20                   YES-BR TO EXCP20 W/O CP18       83720019
EXCP1820 EQU   *                                                        83760019
         B     ISLFY21                  BR TO EXCP 18 & 20              83800019
         EJECT                                                          83840019
ENTRYMOV EQU   *                        *                        A45263 83842021
*                                                                       83844021
*   SUBROUTINE TO MOVE A TISA ENTRY.                                    83846021
*        LINKAGE                        BAL   R3,ENTRYMOV               83848021
*        R4 - AREA TO MOVE FROM                                         83850021
*        R5 - AREA TO MOVE TO                                           83852021
*                                                                       83854021
         DROP  R12                      R12 USED AS WORK REG     A45263 83856021
         IC    R12,DCBKEYLE             ENTRY LENGTH = KEYLE +   A45263 83858021
*                                       18                       A45263 83860021
         MVC   0(FIRST17,R5),0(R4)      MOVE FIRST 17 BYTES      A45263 83862021
         EX    R12,MVENTRY1             MOVE LAST KEYLEN +1      A45263 83864021
         L     R12,DCBWKPT1             RESTORE WORK AREA BASE   A45263 83866021
         BR    R3                       RETURN                   A45263 83868021
*                                                                       83870021
MVENTRY1 MVC   FIRST17(0,R5),FIRST17(R4) DUMMY MOVE              A45263 83880021
FIRST17  EQU   17                       TISA LENGTH - (KEYLEN+1) A45263 83890021
*                                                                       83892002
PATCH    DC    XL((*-IGG019I1)/20)'00'  ZEROED PATCH AREA        Y02072 83894002
*                                                                       83896002
         EJECT                                                          83900021
*********************************************************************** 83910021
*                                                                       83920019
*              CONSTANTS                                                83960019
*                                                                       84000019
*********************************************************************** 84040019
ISL8     DC    F'0008'                                                  84080019
ISL10    DC    F'0010'                                                  84120019
CONSF8   DC    F'248'                                                   84160019
ISL28    DC    F'0028'                                                  84200019
ISLZEROF DC    F'0'                                                     84280002
ISL4     DC    F'0004'                                                  84320019
ISL12    DC    F'0012'                                                  84360019
ISLONEF  DC    F'0001'                                                  84400019
ISLTWO   DC    H'0002'                                                  84440019
ISLRFP   DC    X'002907'                                                84480019
*                                                                       84520019
* FX CONSTANTS                                                          84560019
*                                                                       84600019
ISLFX02A CLC   0(1,R4),0(R5)            KEY COMP TO BE EXECUTED (L)     84640019
ISLFX06A MVC   0(1,R5),0(R4)            MOVE KEY TO BE EXECUTED (L)     84680019
ISLFX08A CLC   0(1,R5),0(R4)            KEY COMP TO BE EXECUTED (M)     84720019
ISLFX21A MVC   0(1,R4),0(R5)            MOVE RCD TO BE EXECUTED (M)     84760019
MOVE     EQU   ISLFX06A                 TISA MOVE                A45263 84780021
*                                                                       84800019
*                                                                       84840019
         END                                                            84920019
