         TITLE 'IGG019I2 - PUT, FULL TRACK INDEX WRITE, WRITE CHECK'    00010019
IGG019I2 CSECT                                                          00020019
*          RELEASE OS/VS2-02 DELETIONS                                * 00022002
*                                                               YM03178 00022402
*                                                               YM05395 00022802
*                                                               YM06516 00023202
*                                                                       00024002
*          RELEASE 20 DELETIONS                                       * 00030019
*3393062860-062880,066200-066600,082260-082440                   A32496 00032020
*3393062840,063400-063600                                        A31998 00035020
*3393025000,025200,025400-038200,058600,063000-065200,082400,    S20201 00035420
*3393147400,147600-148000,154200,155600,156200,156800,265200,    S20201 00035820
*3393265400,303840,303880,312200,317700,348600,348700,348800-    S20201 00036220
*3393348900                                                      S20201 00036620
*3393069600-069700                                               M1857  00037020
*          RELEASE 21 DELETIONS                                       * 00040019
*0114116600,118800,147500-150000,341600,346000,411200-411500,    A46109 00040321
*0114412000                                                      A46109 00040621
*0114106400-106600                                               A42181 00041021
*0114204200-205600,316500-316600,320800-321000,332800-332900,    A38521 00043021
*0114334600-334700                                               A38521 00046021
*0114330500,330600,330700,341600,344300,344400,344500,344800,    A45263 00046621
*0114352900,353000,353400,354500                                 A45263 00047221
*0114289500-290300                                               M0170  00048021
*0114                                                            M0976  00048421
*0114320760,335300                                               M1819  00048821
*0114322900,350200,350400-351300                                 A44853 00048900
*D062920                                                         XM6075 00049200
*D362000-362100,362300-362400,363000                            SA54556 00049602
*                                                                       00050002
*        VS2 RELEASE 030 PTF CHANGES                           @ZA07607 00060037
*C071800,216600                                                @ZA07607 00070037
*A073230-073900                                                @ZA07607 00080037
*A071480-074200,C078600                                        @ZA10227 00090037
*A216500                                                       @ZA10226 00100037
* STATUS CHANGE LEVEL 004                                               00120002
*                                                                     * 00130019
*FUNCTION/OPERATION- THIS MODULE CONTAINS THE BASIC LOAD MODE PUT     * 00140019
*   ROUTINES FOR FULL TRACK INDEX WRITE WITH WRITE CHECK.  THESE      * 00150019
*   ROUTINES INVOLVE RECORD PROCESSING FOR MOVE MODE AND FOR LOCATE   * 00160019
*   MODE, BUFFER MANAGEMENT, CHANNEL PROGRAM INITIALIZATION AND       * 00170019
*   EXECUTION.                                                        * 00180019
*                                                                     * 00190019
*ENTRY POINTS- 'IGG019I2' (ISLFX01) IS THE ENTRY FOR A LOAD MODE PUT  * 00200019
*   MACRO INSTRUCTION. THE GENERATED CALLING SEQUENCE IS,             * 00240019
*   LA   1,DCB                                                        * 00260019
*   LA   0,RECORD   FOR MOVE MODE                                     * 00280019
*   L    15,48(0,1)                                                   * 00300019
*   BALR 14,15                                                        * 00320019
*                                                                     * 00340019
*INPUT- REGISTER 0  -POINTS TO USERS RECORD IN WORK AREA (MOVE MODE). * 00360019
*       REGISTER 1  -POINTS TO DCB.                                   * 00380019
*       REGISTER 13 -POINTS TO USER SAVE AREA.                        * 00400019
*       REGISTER 14 -POINTS TO RETURN FROM PUT                        * 00420019
*                                                                     * 00440019
*OUTPUT- REGISTER 1 -POINTS TO NEXT AVAILABLE SPACE IN OUTPUT BUFFER  * 00460019
*                    (LOCATE MODE).                                   * 00480019
*        REGISTER 1 -POINTS TO BAD BUFFER IF WRITE ERROR OCCURRED.    * 00500019
*        REGISTER 0 -POINTS TO IOB IF WRITE ERROR OCCURRED.           * 00520019
*        REGISTER 14-POINTS TO RETURN TO CLOSE IF WRITE ERROR         * 00540019
*                      OCCURRED DURING CLOSE.                         * 00560019
*                                                                     * 00580019
*EXTERNAL ROUTINES- 'IGG019GD'-CHANNEL PROGRAM APPENDAGE ROUTINES     * 00600019
*   USED TO PROCESS I/O RETURNS. ALSO, CHANNEL PROGRAMS AND IOS.      * 00620019
*                                                                     * 00640019
*EXITS-NORMAL- (ISLFX13), USER RECORD HAS BEEN PROCESSED SUCCESSFULLY.* 00660019
*     -ERROR-  (ISLFX05), AN ERROR OCCURRED DURING THE PROCESSING OF  * 00680019
*   THE USER RECORD. THE ERROR CONDITION IS FLAGGED AS FOLLOWS,       * 00700019
*   DCBEXCD1 BIT 5 ON = WRITE ERROR, REG 1 POINTS TO BAD BUFFER       * 00720019
*                                    REG 0 POINTS TO IOB              * 00740019
*   DCBEXCD1 BIT 2 ON = SPACE ERROR, NOT ENOUGH SPACE FOR DATA SET.   * 00760019
*   DCBEXCD2 BIT 1 ON = DUPLICATE KEY.                                * 00780019
*   DCBEXCD2 BIT 0 ON = KEY OUT OF SEQUENCE.                          * 00800019
*                                    REG 0 POINTS TO HIGH KEY     20852 00810019
*                                                                     * 00820019
*TABLES/WORK AREAS-                                                   * 00840019
*   DCB      - COMMUNICATION WITH USER.                               * 00860019
*   DEB      - COMMUNICATION WITH IOS                                 * 00880019
*   ISLCOMON - COMMUNICATION WITHIN LOAD MODE.                        * 00900019
*   ISLIOBA  - COMMUNICATION WITH I/O FOR CP18 AND 20.                * 00920019
*   ISLIOBB  - COMMUNICATION WITH I/O FOR CP21.                       * 00940019
*   ISLIOBC  - COMMUNICATION WITH I/O FOR CP19.                       * 00960019
*   ISLAREAZ - WORK AREA USED FOR PREFORMATTING.                      * 00980019
*   ISLIXLT  - INDEX LOCATION TABLE, LOCATES HI-LEVEL INDICIES.       * 01000019
*   ISLY     - WORK AREA USED WHEN WRITING INDICIES.                  * 01020019
*   ISLVPTRS - VARIABLE POINTERS, REFERENCE VARIABLE LENGTH BLOCKS.   * 01040019
*   IOBBCT   - BUFFER CONTROL TABLE, CONTROLS BUFFER USAGE.           * 01060019
*                                                                     * 01080019
*ATTRIBUTES- READ ONLY, REENTRANT, REUSABLE.                          * 01100019
*                                                                     * 01120019
*NOTES- THIS MODULE, TOGETHER WITH THE APPENDAGE MODULE 'IGG019GD',   * 01140019
*   AND THE CHANNEL PROGRAMS, CREATE THE ISAM DATA SET WHEN WRITE-    * 01160019
*   CHECKING IS SPECIFIED FOR FULL TRACK INDEX WRITE.  ALL OTHER LOAD * 01180019
*   MODE MODULES MERELY PROVIDE THE OPEN AND CLOSE FUNCTIONS.         * 01200019
*       SECTIONS OF THE PROCESSING IN THIS MODULE ARE ENTERED         * 01220019
*   DIRECTLY FROM CLOSE PROCESSING. IN SUCH CASES, PROCESSING IS      * 01240019
*   CARRIED ON AS THOUGH IT WAS PART OF CLOSE.                        * 01260019
*        ENTRY POINTS - ISLFX01                                       * 01280019
*                     - ISLFX20                                       * 01300019
*                     - ISLFY01                                       * 01320019
*                     - ISLFZ01                                       * 01340019
*                     - ISLPA01                                       * 01360019
*                                                                     * 01380019
*    ****************************************************************** 01400019
*    THE FOLLOWING NOTATION IS FREQUENTLY USED THROUGHOUT COMMENTS -  * 01420019
*              C(FIELD X) = A(FIELD Y)                                * 01440019
*     CONTENTS OF FIELD X = ADDRESS OF FIELD Y                        * 01460019
*                                                                       01480019
*                                                                     * 01500019
         EJECT                                                          01520019
IGG019I2 CSECT                                                          01540019
********************                                                    01560019
* DCB REFERENCE    *                                                    01580019
********************                                                    01600019
*                                                                       01620019
         DCBD  DSORG=(IS)                                               01640019
         USING IHADCB,R1                                                01660019
         EJECT                                                          01680019
********************                                                    01700019
* DEB REFERENCE    *                                                    01720019
********************                                                    01740019
*                                                                       01760019
IHADEB   DSECT                                                          01780019
         USING IHADEB,R8                                                01800019
         DS    0D                                                       01820019
DEBNMSUB DS    0CL1                                                     01840019
DEBTCBAD DS    A                                                        01860019
DEBAMLNG DS    0CL1                                                     01880019
DEBDEBAD DS    A                                                        01900019
DEBOFLGS DS    0CL1                                                     01920019
DEBIRBAD DS    A                                                        01940019
DEBOPATB DS    0CL1                                                     01960019
DEBSYSPG DS    A                                                        01980019
DEBNMEXT DS    0CL1                                                     02000019
DEBUSRPG DS    A                                                        02020019
DEBPRIOR DS    0CL1                                                     02040019
DEBECBAD DS    A                                                        02060019
DEBPROTG DS    0BL1                                                     02080019
DEBDEBID DS    0BL1                                                     02100019
DEBDCBAD DS    A                                                        02120019
DEBEXSCL DS    0CL1                                                     02140019
DEBAPPAD DS    A                                                        02160019
DEBNIEE  DS    0CL1                                                     02180019
DEBFIEAD DS    A                                                        02200019
DEBNPEE  DS    0CL1                                                     02220019
DEBFPEAD DS    A                                                        02240019
DEBNOEE  DS    0CL1                                                     02260019
DEBFOEAD DS    A                                                        02280019
         DS    CL4                                                      02300019
DEBDVMOD DS    0CL1                                                     02320019
DEBUCBAD DS    A                                                        02340019
DEBBINUM DS    CL2                                                      02360019
DEBSTRCC DS    CL2                                                      02380019
DEBSTRHH DS    CL2                                                      02400019
DEBENDCC DS    CL2                                                      02420019
DEBENDHH DS    CL2                                                      02440019
DEBNMTRK DS    CL2                                                      02460019
DEBXTN   DSECT                                                          02470002
DEBXLNGH  DS   H                        LENGTH DEB EXTENSION            02472002
DEBXFLG1  DS   B                        FLAG BYTE                       02474002
DEBXTSKC EQU   X'40'                    TASK CLOSE CLOSING DCB          02476002
         EJECT                                                          02480019
ISLCOMON IGGLOAD                                                        02490020
         USING ISLCOMON,R12             ADDRESSABILITY           S20201 02500020
         EJECT                                                          02520020
*                                                                       03840019
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03860019
*                                                                       03880019
IOBBCT   DSECT                                                          03900019
         USING IOBBCT,R11                                               03920019
         DS    0D                                                       03940019
IOBFLAGS DS    0CL1                     FLAGS                           03960019
IOBPTRA  DS    A                        PTR A                           03980019
IOBB     DS    0CL1                     B                               04000019
IOBPTRB  DS    A                        PTR B                           04020019
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   04040019
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   04060019
*                                                                       04080019
*------------------ VARIABLE AREA ------------------------------------  04100019
*                                                                       04120019
*        --                                                             04140019
*        --                                                             04160019
*        --                                                             04180019
*        --                                                             04200019
*                                                                       04220019
* ISLY REFERENCE           C(ISLVPTRS)=A(ISLY)                          04240019
*                                                                       04260019
ISLY     DSECT                                                          04280019
         USING ISLY,R9                                                  04300019
         DS    0D                                                       04320019
         DS    CL8                      CYL-MAST IX    COUNT    Y+0     04340019
         DS    CL10                                    DATA     Y+8     04360019
         DS    CL8                      TRK IX NORM    COUNT    Y+18    04380019
         DS    CL10                                    DATA     Y+26    04400019
         DS    CL8                      TRK IX OVFL    COUNT    Y+36    04420019
         DS    CL10                                    DATA     Y+44    04440019
         DS    CL8                      TRK IX DUMM    COUNT    Y+54    04460019
*        DS    CL(IL)                                  KEY 1S   Y+62    04480019
*        DS    CL10                                    DATA     Y+62+IL 04500019
*                                                                       04520019
         EJECT                                                          04540019
IHAIOB   DSECT                                                          04560019
         USING IHAIOB,R2                                                04580019
         DS    0D                                                       04600019
IOBFLG1  DS    CL1                      FLAGS 1                         04620019
IOBFLG2  DS    CL1                      FLAGS 2                         04640019
         DS    CL1                                                      04660019
IOBSENSE DS    CL1                      SENSE                           04680019
IOBECBAD DS    A                        ECB POINTER                     04700019
IOBCSW   DS    CL8                      CHANNEL STATUS WORD             04720019
IOBSIOCC DS    0CL1                     SIO CC                          04740019
IOBCPSAD DS    A                        CHANNEL PROG START ADR          04760019
IOBWT    DS    0CL1                     WEIGHT                          04780019
IOBDCBAD DS    A                        DCB POINTER                     04800019
IOBCPRAD DS    A                        CHANNEL PROG RESTART ADR        04820019
IOBBCTI  DS    CL2                      BLK CTR INCR                    04840019
IOBECT   DS    CL2                      ERROR CTR                       04860019
IOBDADAD DS    CL8                      DIR ACCESS DEV ADR MBBCCHHR     04880019
*                                                                       04900019
IXLT     DSECT                                                          04920019
         USING IXLT,R7                                                  04940019
         DS    0D                                                       04960019
IXLTIND  DS    CL1                      INDICATOR                       04980019
IXLBEG   DS    CL8                      BEGINING COUNT MBBCCHHR         05000019
IXLSTP   DS    CL8                      STEPPING COUNT MBBCCHHR         05020019
IXLEND   DS    CL8                      ENDING COUNT   NBBCCHHR         05040019
         DS    CL1                                                      05060019
         DS    CL26                                                LEV2 05080019
         DS    CL26                                                LEV3 05100019
         DS    CL26                                                LEV4 05120019
         EJECT                                                          05124020
CPSX     DSECT                                                          05128020
         IGGLDCP  OPTCD=W               LOAD CHANNEL PROGRAM     S20201 05132020
*                                       SKELETON                 S20201 05136020
         SPACE 4                                                        05140002
*********************************************************************** 05141019
*                                                                       05142019
*              FULL TRACK INDEX WRITE OPTION                            05143019
*                                                                       05144019
*********************************************************************** 05145019
         DS    0D                                                       05146019
TISA     DSECT                          TRACK INDEX SAVE AREA           05147019
         USING TISA,R6                                                  05148019
FTIWIOB  DS    2F                       IOB FOR FULL TRK INDEX WRITE    05149019
SIZE     DS    AL2                      LENGTH OF TI ENTRY              05150019
FLAGS    DS    AL1                      FLAGS FOR FTIW                  05151019
HIGHR    DS    AL1                      HIGHEST R ON CURRENT TRK        05152019
CURRR    DS    0CL1                     CURRENT RECORD ON THIS TRK      05153019
NEXTTI   DS    AL3                      ADDR OF NEXT TI ENTRY           05154019
TISASIZE DS    A                        SIZE OF TISA                    05155019
         EJECT                                                          05156019
         IKJRB DSECT=YES                                        YM03178 05156402
         SPACE 4                                                        05157602
         IHAPSA                                                 YM05395 05157702
         EJECT                                                          05158002
*********************************************************************** 05160019
* ISL PUT - BEGIN                                                     * 05180019
*********************************************************************** 05200019
*                                                                       05220019
*                                                                       05240019
IGG019I2 CSECT                                                          05260019
ISLF800  SAVE  (14,12)                  SAVE USERS REGS                 05280019
         BALR  R15,0                                                    05300019
         USING *,R15                                                    05320019
         B     ISLFX01                                                  05340019
         B     ISLFX20                                                  05360019
         B     ISLFY01                                                  05380019
         B     ISLFZ01                                                  05400019
         B     ISLPA01                                                  05420019
*                                                                       05440019
* EQUATE SYMBOLIC REGISTERS                                             05460019
*                                                                       05480019
R0       EQU   0                                                        05500019
R1       EQU   1                                                        05520019
R2       EQU   2                                                        05540019
R3       EQU   3                                                        05560019
R4       EQU   4                                                        05580019
R5       EQU   5                                                        05600019
R6       EQU   6                                                        05620019
R7       EQU   7                                                        05640019
R8       EQU   8                                                        05660019
R9       EQU   8                                                        05680019
R10      EQU   10                                                       05700019
R11      EQU   11                                                       05720019
R12      EQU   12                                                       05740019
R13      EQU   13                                                       05760019
R14      EQU   14                                                       05780019
R15      EQU   9                                                        05800019
R16      EQU   15                                                       05820019
CVTPTR   EQU   16                                                       05840019
RSLOAD   EQU   X'20'                    DCBST - RESUME LOAD      S20201 05842020
*                                       *       INDICATOR               05844020
CP20BIT  EQU   X'08'                    EXCP CP20 ONLY BIT       A44853 05844100
CLOSE1   EQU   X'40'                    TISA CLOSE INDICATOR     A44853 05844400
CLOSE2   EQU   X'04'                    INDICATOR CLOSE FORCING  S20201 05846020
*                                       INDEX                    S20201 05848020
L4       EQU   4                        LENGTH                   S20201 05850020
K1       EQU   1                        CONSTANT                 S20201 05854020
K2       EQU   2                        CONSTANT                 A38521 05855021
L3       EQU   3                        LENGTH                   S20201 05856020
K14      EQU   14                       CONSTANT                 S20201 05858020
K0       EQU   0                        CONSTANT                 S20201 05860020
K3       EQU   3                        CONSTANT                 S20201 05862020
K4       EQU   4                        CONSTANT                 S20201 05864020
K24      EQU   24                       CONSTANT                 S20201 05866020
K20      EQU   20                       CONSTANT                 S20201 05868020
X07      EQU   X'07'                    P BYTE = 07              S20201 05870020
K17      EQU   17                       CONSTANT                 S20201 05872020
COMPLETE EQU   X'40'                    IOB COMPLETED            A42181 05874021
IOERROR  EQU   X'04'                    DCBEXCD1 - I/O ERROR     A42181 05876021
ISLKEYVL EQU   X'04'                    KEY SEQUENCE VALID(IXLT) XM6075 05878000
INCLOSE  EQU   X'10'                    ENTERED FROM CLOSE      YM05395 05878402
DMCODE   EQU   119                      INTERNAL PROB DET CODE  YM05395 05878802
         EJECT                                                          05880019
*********************************************************************** 05900019
* CHART FX - PUT (MOVE/LOCATE)                                        * 05920019
*********************************************************************** 05940019
*                                                                       05960019
         USING IHADEB,R8                                                05980019
*                                                                       06000019
* FX HOUSEKEEPING                                                       06020019
*                                                                       06040019
ISLFX01  L     R12,DCBWKPT1             C(R12)=A(COMMON)                06060019
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)           14251 06065019
         L     R11,8(R10)               C(R11)=A(BCT)             14251 06070019
         TM    IOBFLAGS,X'10'           DID WE COME FROM CLOSE    14251 06075019
         BO    CONTINUE                 YES TAKE BRANCH           14251 06080019
         ST    R13,ISLVRSAV+4                                     14251 06085019
CONTINUE EQU   *                                                  14251 06090019
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   06140019
         NI    DCBEXCD2,X'3F'           SET EXCD2 BITS 0 AND 1 = 00     06160019
*                                                                       06180019
         TM    DCBEXCD1,X'04'           HAS AN OUTPUT ERROR      A31998 06185020
*                                       * OCCURRED$                     06190020
         BO    ISLFX02                  YES TAKE SYNAD           A31998 06195020
* TEST DCBST BIT 1 FOR LOAD MODE (FIRST TIME SW)                        06200019
*                                                                       06220019
         TM    DCBST,X'40'              TEST ST BIT 1 (1=NOT FRST TIME) 06240019
         BC    14,ISLFX10A              BRANCH NOT ON                   06260019
         LH    R5,DCBRKP                RELATIVE KEY POSITION    A32496 06270020
*                                                                       06280019
         TM    DCBST,X'20'              RESUME LOAD               P4701 06282019
         BZ    ISLFX022                 NOT RESUME LOAD          A31998 06284020
         TM    DCBMACRF+1,X'08'         PUT - LOCATE MODE         P4701 06290019
         BO    ISLFX07A                 BR-YES                   XM6075 06292000
         L     R4,4(R10)                PT TO HIGH KEY           A32496 06294020
         B     ISLFY022                 BRANCH TO CHECK SEQUENCE A32496 06296020
*                                                                       06540019
* SEQUENCE CHECK                                                        06560019
****************                                                        06580019
*                                                                       06600019
ISLFX022 EQU   *                        *                        A32496 06610020
         L     R4,ISLCBF                                         A32496 06620020
         AR    R4,R5                    PT TO KEY                A32496 06630020
ISLFY022 EQU   *                                                 A32496 06640020
         SR    R3,R3                                                    06680019
         IC    R3,DCBKEYLE              C(R3)=KEYLEN, 000000NN          06700019
         BCTR  R3,0                     C(R3)=KEYLEN-1, FOR EXECUTE     06720019
*                                                                       06740019
* TEST FOR MOVE OR LOCATE PUT                                           06760019
*                                                                       06780019
         TM    DCBMACRF+1,X'10'         TEST MACRF BIT 11               06800019
         BC    1,ISLFX08                B IF ON = MOVE PUT              06820019
*                                                                       06840019
* LOCATE PUT ***                                                        06860019
*                                                                       06880019
         L     R5,4(R10)                C(R5)=A(KEYSAVE)=A(PREV KEY)    06900019
         EX    R3,ISLFX02A              C(CBF+RKP) VS C(KEYSAVE)        06920019
         BH    ISLFX06                  B IF NEW KEY HIGH               06940019
         BE    ISLFX023                 BR - SEQUENCE CORRECT     20852 06950019
         LR    R4,R5                    PTR TO KEY               M1857  06960020
         B    ISLFX041                  BR TO POST ERROR         M1857  06970020
*                                                                       06980019
* LOCATE PUT,KEYS EQUAL- TEST IF 2ND PUT (SEQ CHK ONLY AFTER 2ND PUT)   07000019
*                                                                       07020019
ISLFX023 EQU   *                                                  20852 07030019
         L     R6,DCBNREC               C(R6)=NREC                      07040019
         C     R6,ISLONEF               TEST NREC VS 1                  07060019
         BE    ISLFX06                  B IF NREC = 1, ONLY 2ND PUT     07080019
*                                                                       07100019
* DUPLICATE RECORDS = ERROR                                             07120019
*                                                                       07140019
ISLFX03  OI    DCBEXCD2,X'40'           SET EXCD2 BIT 1 ON = DUPLICATE  07160019
         B     ISLFX04A                                        @ZA07607 07180037
*                                                                       07200019
* MOVE PUT ***                                                          07220019
*                                                                       07240019
ISLFX08  AR    R5,R0                    C(R5)=C(AREA+RKP)=A(NEW KEY)    07260019
         EX    R3,ISLFX08A              C(NEW KEY) VS C(CBF+RKP)        07280019
         BH    ISLFX07                  BRANCH IF NEW KEY HIGH          07300019
         BE    ISLFX03                  BR IF KEYS EQUAL=DUPLIC ATES    07320019
ISLFX041 EQU   *                        *                        M1857  07322020
* SEQUENCE ERROR                                               @ZA07607 07324037
         OI    DCBEXCD2,X'80'           EXCD2 BIT 0,SEQ ERROR  @ZA07607 07334037
         TM    IOBFLAGS,X'10'           IN CLOSE                 M1857  07344037
         BO    ISLFX04A                 YES - DON'T SAVE KEY   @ZA07607 07354037
         ST    R4,20(R13)               HI KEY ADDR INTO USER R0  20852 07364037
         OI    20(R13),X'80'            TURN USER REG 0 NEG    @ZA07607 07374037
         B     ISLFX05                  BR TO SYNAD            @ZA07607 07384037
*                                                                       07394037
* TAKE SYNAD EXIT                                                       07404037
ISLFX04A LA    R0,ISLIOBA               LOAD IOB ADDR          @ZA07607 07414037
         TM    IOBFLAGS,X'10'           IN CLOSE?              @ZA10227 07417037
         BO    ISLFX05                  YES BRANCH             @ZA10227 07420037
         ST    R0,20(R13)               ST IN USER SAVE AREA   @ZA07607 07424037
ISLFX05  LR    R4,R14                   SAVE RETURN IN R4               07480019
         L     R16,DCBSYNAD                                             07500019
         C     R16,ISLONEF              TEST SYNAD VS 1                 07520019
         BE    ISLFX052                 BR IF 1 - NO SYNAD              07540019
         TM    IOBFLAGS,X'10'           TEST FLAGS BIT 3 (CLOSE)        07560019
         BC    1,ISLFX051               B IF ON = CLOSE                 07580019
         L     R13,ISLVRSAV+4           RESTORE USER R13                07600019
         L     R14,12(R13)              RESTORE USER R14                07620019
         LM    0,12,20(R13)             RESTORE REGS                    07640019
         BR    R16                      TAKE SYNAD EXIT                 07660019
* TEST DCBEXCD1 BIT 5 FOR PREVIOUS UNCORRECTABLE WRITE ERROR            07662020
*                                                                       07664020
ISLFX02  L     R13,ISLVRSAV+K4          C(R13)=A(USERS SAVE      S20201 07666020
*                                       AREA)                    S20201 07668020
         MVC   K24(L4,R13),ISLVPTRA     A(BAD BUFFER) IN USER R1 S20201 07670020
         LA    R0,ISLIOBA               C(R0)=A(IOBA)            S20201 07672020
         ST    R0,K20(R13)              STORE A(IOBA) IN USERS   S20201 07674020
*                                       R0                       S20201 07676020
         B     ISLFX05                  B TO TAKE SYNAD          S20201 07678020
ISLFX051 TM    DCBEXCD2,X'20'           TEST EXCD2 BIT 2    ***CLOSE*** 07680019
         BC    1,0(R4)                  B IF ON, RETURN TO CLOSE        07700019
         L     R5,DCBDEBAD              DEB ADDRESS             YM06516 07710002
         LA    R5,0(R5)                 CLEAR HIGH ORDER BYTE   YM06516 07712002
         S     R5,ISL8                  PT TO DEB EXTENSION PTR YM06516 07720002
         L     R5,0(R5)                 ADDRESS DEB EXTENSION   YM06516 07730002
         USING DEBXTN,R5                DEB EXT. ADDRESSABILITY YM06516 07740002
         TM    DEBXFLG1,DEBXTSKC        TASK CLOSE CLOSING DCB  YM06516 07742002
         BO    ISLFTERM                 BR YES - ISSUE MESSAGE  YM06516 07744002
         USING PSA,R0                   LOW CORE ADDRESSABILITY YM05395 07750002
         L     R5,PSATOLD               TCB ADDRESS             YM05395 07760002
         DROP  R0,R5                    END LOW CORE DEB ADDR   YM06516 07776002
         L     R5,0(R5)                                                 07780019
         USING RBBASIC,R5               SYNCH RB ADDRESSABILITY YM03178 07830002
         L     R5,RBLINK                OPEN SVRB ADDRESS       YM03178 07832002
         DROP  R5                       END RB ADDRESSABILITY   YM03178 07834002
         LA    R13,ISLVRSAV             SAVE AREA ADDRESS       YM03178 07836002
         OI    DCBEXCD2,X'20'           SET EXCD2 BIT 2 ON = CLOSE      07840019
         L     1,24(R13)                SET REG 1              @ZA10227 07860037
         LM    2,13,40(R5)              RESTORE USERS REGS 2 - 13       07880019
         BR    R16                      TAKE SYNAD EXIT - WILL   Y02072 07900002
*                                       RETURN TO CLOSE AS REG   Y02072 07920002
*                                       14 HAS ADDR ESTABLISHED  Y02072 07940002
*                                       BY SYNCH ISSUED BY       Y02072 07960002
*                                       CLOSE EXECUTOR.          Y02072 07980002
*                                                                       08000002
*                                                                       08020002
ISLFX052 EQU   *                        NO SYNAD = ABEND 31             08060002
         TM    IOBFLAGS,INCLOSE         ENTERED FROM CLOSE      YM05395 08070002
         BZ    ISLFX054                 BR NO - ISSUE ABEND     YM05395 08072002
         L     R5,DCBDEBAD              DEB ADDRESS             YM06516 08074002
         LA    R5,0(R5)                 CLEAR HIGH ORDER BYTE   YM06516 08074402
         S     R5,ISL8                  PT TO DEB EXTENSION PTR YM06516 08076002
         L     R5,0(R5)                 ADDRESS DEB EXTENSION   YM06516 08078002
         USING DEBXTN,R5                DEB EXT. ADDRESSABILITY YM06516 08078402
         TM    DEBXFLG1,DEBXTSKC        TASK CLOSE CLOSING DCB  YM06516 08078502
         BO    ISLFTERM                 BR YES - ISSUE MESSAGE  YM05395 08078802
         DROP  R5                       END DEB EXTENSION USING YM06516 08079202
ISLFX054 EQU   *                        ISSUE ABEND             YM05395 08079602
         ABEND X'031',DUMP,,SYSTEM      SYSTEM 031 ABEND         Y02072 08080002
         SPACE 2                                                        08090002
*        ISSUE ERROR MESSAGE AND TERMINATE TASK WITH 031 ABEND -        08092002
*        TASK TERMINATION ISSUED CLOSE FOR USER.                        08094002
         SPACE 2                                                        08096002
ISLFTERM EQU   *                        ISSUE MESSAGE-TERM. TSK YM05395 08098002
         DMABCOND DMCODE,SVC=YES,DCB=(R1)                       YM05395 08098402
         SPACE 2                                                        08098802
*                                                                       08100019
* LOCATE PUT,SEQUENCE OK- MOVE KEY TO KEYAVE AREA                       08120019
*                                                                       08140019
ISLFX06  EX    R3,ISLFX06A              MOVE C(CBF+RKP) TO C(KEYSAVE)   08160019
*                                                                       08180019
* BUMP CBF                                                              08200019
*                                                                       08220019
ISLFX07  EQU   *                        *                        A32496 08230020
         OI    ISLIXLT,ISLKEYVL         VALID RECORD ADDED       XM6075 08240000
ISLFX07A L     R7,ISLCBF                C(R7)=A(CURR BUFR PTR)    P4701 08250019
         A     R7,ISLBMPR               C(R7)=CBF+BMPR                  08260019
         ST    R7,ISLCBF                C(CBF)=CBF+BMPR                 08280019
         B     ISLFX10                                                  08300019
*                                                                       08320019
* BUMP NREC                                                             08340019
*                                                                       08360019
ISLFX10A OI    DCBST,X'40'              SET ST BIT ON                   08380019
         CLC   DCBLPDA(1),DCBMSWA       TEST FOR SAME M           16305 08383019
         BNE   KEEPGOIN                                           16305 08386019
         CLC   DCBLPDA+3(4),DCBMSWA+3   TEST FOR OUT OF SPACE     16305 08389019
         BH    ISLPA205                 BRANCH NO SPACE           16305 08392019
KEEPGOIN EQU   *                                                  16305 08395019
ISLFX10  L     R3,DCBNREC               C(R3)=NREC                      08400019
         A     R3,ISLONEF               C(R3)=NREC+1                    08420019
         ST    R3,DCBNREC               C(NREC)=NREC+1                  08440019
*                                                                       08460019
* TEST BOB SWITCH (APPLIES ONLY TO MOVE PUT, BOBSW = 1 FOR LOCATE PUT)  08480019
*                                                                       08500019
         TM    IOBFLAGS,X'08'           TEST FLAGS BIT 4 VS 1 (BOBSW)   08520019
         BC    1,ISLFX11                B IF ON = NOT 0                 08540019
*                                                                       08560019
*                                       BOBSW = 0                       08580019
         OI    IOBFLAGS,X'08'           SET FLAGS BIT 4 = 1 (BOBSW ON)  08600019
         BAL   R14,ISLPA01             *LINK TO BOB ROUTINE             08620019
*                                                                       08640019
         TM    DCBST,RSLOAD             IS IT RESUME LOAD        S20201 08645020
         BZ    ISLFX11                  NO - O.K.                S20201 08650020
         MVC   IOBPTRA+K1(L3),IOBPTRB+K1 MAKE IT THE FIRST       S20201 08655020
*                                       BOBSW = 1                       08660019
* TEST FOR MOVE OR LOCATE PUT                                           08680019
*                                                                       08700019
ISLFX11  TM    DCBMACRF+1,X'10'         TEST MACRF BIT 11               08720019
         BC    1,ISLFX20                B IF ON = MOVE PUT              08740019
*                                                                       08760019
* LOCATE PUT                                                            08780019
* TEST FOR EOB, HAS USERS LAST RCD FILLED A BUFFER -                    08800019
*                                                                       08820019
         L     R7,ISLCBF                C(R7)=CBF                       08840019
         C     R7,ISLEOB                TEST CBF VS EOB                 08860019
         BNL   ISLFX24                  B IF EOB                        08880019
*                                                                       08900019
*                                       NOT EOB                         08920019
ISLFX12  TM    IOBFLAGS,X'40'           TEST FLAGS BIT 1                08940019
         BC    1,ISLFX14                B IF ON = WRITE SHOULD BE       08960019
*                                                 ATTEMPTED             08980019
*                                                                       09000019
* NOT EOB, FLAGS BIT 1 OFF, RESTORE REGS AND RETURN TO USER             09020019
*                                                                       09040019
* EXIT PUT                                                              09060019
*                                                                       09080019
ISLFX13  TM    IOBFLAGS,X'10'           TEST FLAGS BIT-3 (CLOSE)        09100019
         BC    1,0(R14)                 B IF ON = CLOSE                 09120019
*                                       * INDICATOR                     09122020
         TM    DCBST,RSLOAD             RESUME LOAD              S20201 09124020
         BZ    ISLFX13R                 NO - PTRS CORRECT        S20201 09126020
         NI    DCBST,X'FF'-RSLOAD       RESET RESUME LOAD SW     S20201 09128020
         MVC   IOBPTRA+K1(L3),IOBPTRB+K1 CORRECT PTRS            S20201 09130020
ISLFX13R EQU   *                        *                        S20201 09132020
         TM    DCBMACRF+1,X'10'         TEST MACRF BIT 11 (MOVE PUT)    09140019
         BC    1,ISLFX132               B IF ON = MOVE PUT              09160019
         L     R1,ISLCBF                C(R1)=CBF, FOR LOCATE PUT       09180019
ISLFX132 L     R13,ISLVRSAV+4                                           09200019
         L     R14,12(R13)              RESTORE R14                     09220019
         RETURN (2,12)                  RESTORE USERS REGS AND EXIT     09240019
*                                                                       09260019
*                                                                       09280019
*                                                                       09300019
* NOT EOB, FLAGS BIT 1 ON, SET FLAGS BIT 1 OFF AND ATTEMPT WRITE        09320019
*                                                                       09340019
ISLFX14  NI    IOBFLAGS,X'BF'           SET FLAGS BIT 1 OFF             09360019
         OI    IOBFLAGS,X'20'           SET FLAGS BIT 2 ON (NOT EOB)    09380019
         B     ISLFY02                 *                                09400019
*                                                                       09420019
*                                                                       09440019
*                                                                       09460019
* MOVE PUT                                                              09480019
* MOVE RECORD FROM USER AREA TO CURRENT BUFFER VIA CBF                  09500019
*                                                                       09520019
ISLFX20  L     R3,ISLMVC                C(R3)=COUNT OF EXECUTED MOVE    09540019
         L     R4,ISLCBF                C(R4)=CBF=MOVE DESTINATION      09560019
         LR    R5,R0                    C(R5)=MOVE ORIGIN               09580019
         L     R6,ISLMVCT               C(R6)=NBR OF 255 BYTE MOVES     09600019
ISLFX21  BCT   R6,ISLFX22               TO MOVE 255 BYTES               09620019
         EX    R3,ISLFX21A              MOVE RCD AT R0 TO CBF           09640019
         B     ISLFX23                  MOVE COMPLETED                  09660019
ISLFX22  MVC   0(255,R4),0(R5)          MOVE 255 BYTES OF RECORD        09680019
         LA    R4,255(R4)               BUMP DESTINATION          8M800 09700019
         LA    R5,255(R5)               BUMP ORIGIN               8M800 09720019
         B     ISLFX21                  TO MOVE REST OF RECORD          09740019
*                                                                       09760019
* TEST FOR EOB, HAS RCD JUST MOVED FILLED A BUFFER                      09780019
*                                                                       09800019
ISLFX23  L     R7,ISLCBF                C(R7)=CBF                       09820019
         A     R7,ISLBMPR               C(R7)=CBF+BMPR                  09840019
         C     R7,ISLEOB                TEST CBF+BMPR VS EOB            09860019
         BL    ISLFX12                  B IF NOT EOB                    09880019
*                                                                       09900019
*                                                                       09920019
*                                       EOB                             09940019
*                                                                       09960019
* SET BOB SW TO ZERO (RESET)                                            09980019
*                                                                       10000019
         NI    IOBFLAGS,X'F7'           SET FLAGS BIT 4 = 0 (BOBSW OFF) 10020019
         NI    DCBST,X'FF'-RSLOAD       TURN OFF RESUME LOAD     S20201 10030020
*                                                                       10040019
* MARK CURRENT BUFFER AND BUMP B IN BCT.                                10060019
*                                                                       10080019
ISLFX24  L     R3,IOBPTRB               C(R3)=PTR B = A(CURRENT SLOT)   10100019
         TM    DCBST,RSLOAD             RESUME LOAD              S20201 10106020
         BO    ISLFY01                  YES THEN DON'T SCHEDULE  S20201 10112020
         NI    0(R3),X'DF'              SET STATUS BIT 2 = 0            10120019
         OI    0(R3),X'40'              SET STATUS BIT 1 = 1            10140019
*                                       STATUS BITS 1 AND 2 = 10        10160019
*                                       =BUF FULL BUT NOT SCHED         10180019
         IC    R4,IOBB                  C(R4)-000N, FULL BUFRS    P4701 10200019
         LA    R4,1(0,R4)               C(R4)-000000NN+1          P4701 10220019
         STC   R4,IOBB                  C(PTRB)=NNAAAAAA, NN = B        10260019
*                                                                       10300019
         EJECT                                                          10320019
*********************************************************************** 10340019
* CHART FY - PUT (EOB)                                                * 10360019
*********************************************************************** 10380019
*                                                                       10400019
* TEST B VS FBW (ARE WE READY TO ATTEMPT TO WRITE)                      10420019
*                                                                       10440019
ISLFY01  EQU   *                                                        10450019
         SR    R3,R3                    CLEAR REG 3                     10460019
         IC    R3,IOBB                  C(R3)=000N  N=NO. FILLED,       10480019
*                                         UNSCHEDULED BUFFERS           10500019
         C     R3,ISLFBW                TEST B VS FBW                   10520019
         BL    ISLFY41                  B IF NOT ENOUGH BUFFERS FILLED  10540019
*                                                                       10560019
*                                       B G.E. FBW, ATTEMPT WRITE       10580019
* TEST FLAGS BIT 0 VS 1, (IWR)-IS CP AVAILABLE                          10600019
*                                                                       10620019
ISLFY02  EQU   *                        *                        A42181 10628021
         TM    ISLECBA,COMPLETE         IOB AVAILABLE            A42181 10636021
         BZ    ISLFY41A                 NO - SCHEDULE LATER      A42181 10644021
         TM    DCBEXCD1,IOERROR         HAS AN I/O ERROR         A42181 10652021
*                                       OCCURRED                 A42181 10660021
         BO    ISLFX02                  YES - TERMINATE LOAD.    A42181 10668021
*                                                                       10680019
* B GE FBW AND FLAGS BIT 0 = 0 (CP AVAILABLE), SET UP TO WRITE          10700019
*                                                                       10720019
ISLFY03  SR    R3,R3                                                    10740019
         IC    R3,IOBB                  C(R3)=000N                      10760019
         S     R3,ISLFBW                C(R3)=B-FBW, WE WILL SCHED FBW  10780019
*                                                    BUFFRS             10800019
         STC   R3,IOBB                  C(PTRB)=NNAAAAAA, NN = B        10820019
*                                                                       10840019
         NI    IOBFLAGS,X'BF'           SET FLAGS BIT 1 OFF             10860019
*                                                                       10880019
*                                                                       10900019
*                                                                       10920019
* WAIT FOR PREVIOUS I/O TO COMPLETE                                     10940019
*                                                                       10960019
*                                                                       10980019
*                                                                       11000019
* MAKE SURE CP21 HAS COMPLETED                                          11020019
*                                                                       11040019
         LA    R2,ISLIOBB               SET BASE FOR IOB FOR CP21       11060019
         BAL   R4,ISLFY99               BR TO WAIT SUBROUTINE           11080019
*                                                                       11100019
* TEST STATUS BIT-6 (PF BIT) PERTAING TO 1ST BFR.  IF PF BIT ON, THIS   11120019
* IS THE 1ST BUFFER TO BE WRITTEN ON A NEW CYLINDER WITH SHARED TRACKS  11140019
*                                                                       11160019
         TM    0(R3),X'02'              TEST STATUS BIT-6               11180019
         BC    8,ISLFY08                B IF PF NOT ON                  11200019
*                                                                       11220019
* STATUS BIT-6 (PF BIT) IS ON. WE ARE ABOUT TO SCHED THE 1ST WRITE ON   11240019
* A NEW, SHARED-TRACK, CYLINDER. FIRST WE MUST BE SURE CP19 HAS         11260019
* FINISHED PRE-FORMATTING.                                              11280019
*                                                                       11300019
         LA    R2,ISLIOBC               SET BASE FOR IOB FOR CP19       11320019
         BAL   R4,ISLFY99               BR TO WAIT SUBROUTINE           11340019
         NI    0(R3),X'FD'              SET STATUS BIT 6 (PF BIT) OFF   11360019
*                                                                       11380019
*                                                                       11400019
* SCHED FBW BUFFRS FOR WRITING VIA PTR A (STATUS BITS 1,2 ON)           11420019
* AT THE SAME TIME TEST STATUS BYTES FOR BIT-3 ON = NEW EXTENT          11440019
*                                                                       11460019
ISLFY08  L     R4,ISLFBW                C(R4)= NO OF SLOTS TO SCHED     11480019
ISLFY10  OI    0(R3),X'60'              SET STATUS BITS 1,2 = 11        11500019
         TM    0(R3),X'10'              TEST STATUS BIT-3               11520019
         BC    8,ISLFY11                B IF 0, SAME EXTENT             11540019
         IC    R5,IOBDADAD              C(R5)-M                   P4701 11560019
         LA    R5,1(0,R5)               C(R5)-M+1                 P4701 11580019
         STC   R5,IOBDADAD              C(IOBA+32)=MBBCCHHR, M=M+1      11620019
         BAL   R5,ISLFZ21                                               11630019
         NI    0(R3),X'EF'              SET STATUS BIT-3 = 0            11640019
ISLFY11  AH    R3,ISL4                  BUMP R3 TO ADR NEXT SLOT A46109 11660021
         C     R3,ISLBUFN               TEST FOR ADR OF NTH SLOT        11680019
         BC    13,ISLFY20A              BR IF NOT HIGH                  11700019
ISLFY12  BCT   R4,ISLFY13               WRAPAROUND POSSIBLE             11720019
         B     ISLFY20                  OUT, SLOT N WAS LAST            11740019
ISLFY13  LA    R3,IOBABUF               WRAPAROUND REAL, C(R3)=A(SLOT1) 11760019
         B     ISLFY10                  LOOP AGAIN                      11780019
*                                                                       11800019
*                                       SAVE ADR OF LAST SLOT IN REG 7  11820019
ISLFY20A BCT   R4,ISLFY10                                               11840019
ISLFY20  LR    R7,R3                    C(R7)=A(LAST SLOT SCHED + 4)    11860019
         SH    R7,ISL4                  C(R7)=A(LAST SLOT SCHED) A46109 11880021
*                                                                       11900019
* INITIALIZE CP18 AND CP20 IN SUBROUTINE                                11920019
*                                                                       11940019
*                                                                       11960019
         ST    R14,TSTWK1C              SAVE A(RETURN TO CLOSE)  A44853 11962000
         ST    R7,ISLF9WK1              SAVE REGISTER 7                 11970019
         B     ISLF801                                                  11980019
ISLFY21  EQU   *                                                        11990019
         L     R7,ISLF9WK1              RESTORE REGISTER 7              12000019
         L     R14,TSTWK1C              CLOSE RETURN ADDR        A44853 12010000
*                                                                       12040019
* SAVE CONTENTS OF BCT SLOT WITH STATUS AND POINTER OF LAST BUFF SCHED  12060019
*                                                                       12080019
         MVC   ISLF9WK1(4),0(R7)        SAVE SLOT CONTENTS OF     16305 12100019
*                                       LAST BCT SLOT             16305 12120019
*                                                                       12140019
* TEST LAST BUFFER FOR END OF CYLINDER (C-BIT ON)                       12160019
*                                                                       12180019
         TM    0(R7),X'04'              TEST S BIT 5 VS 1 (C-BIT)       12200019
         BC    1,ISLFZ01                B IF ON                         12220019
*                                                                       12240019
*                                                                       12260019
* EXECUTE CP18 (CP20)                                                   12280019
*                                                                       12300019
*                                                                       12320019
ISLFY30  LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 12340019
         LR    R3,R0                    SAVE R0                         12360019
         LR    R4,R1                    SAVE R1                         12380019
         LR    R5,R14                   SAVE R14                        12400019
*                                                                  8791 12420019
*                                                                  8791 12440019
*                                                                  8791 12460019
* SET FLAGS BIT-0 (IWR BIT)=1, CP IS NOT AVAIL                     8791 12480019
*                                                                  8791 12500019
         OI    IOBFLAGS,X'80'           TURN ON FLAGS BIT 0        8791 12520019
*                                                                  8791 12540019
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         12560019
         LR    R0,R3                    RESTORE R0                      12580019
         LR    R1,R4                    RESTORE R1                      12600019
         LR    R14,R5                   RESTORE R14                     12620019
*                                                                       12640019
* SET FBW IN SUBROUTINE                                                 12660019
*                                                                       12680019
         LA    R7,ISLF9WK1              C(R7)=A(LAST SLOT) FROZEN       12700019
         B     ISLPB01                  GO TO SUBROUTINE                12720019
ISLFY41A OI    IOBFLAGS,X'40'           SET FLAGS BIT 1 ON TO ATTEMPT   12740019
*                                       TO WRITE LATER                  12760019
*                                                                       12780019
*                                                                       12800019
*                                                                       12820019
* TEST FLAGS BIT 2 (NOT EOB INDICATOR)                                  12840019
*                                                                       12860019
ISLFY41  TM    IOBFLAGS,X'20'           TEST FLAGS BIT 2                12880019
         BC    8,ISLFY42                B IF NOT ON (EOB)               12900019
         NI    IOBFLAGS,X'DF'           TURN FLAGS BIT 2 OFF            12920019
         B     ISLFX13                  RTRN TO FX (DONT GET LOC BUFF)  12940019
*                                                                       12960019
* TEST FOR MOVE OR LOCATE PUT                                           12980019
*                                                                       13000019
ISLFY42  TM    DCBMACRF+1,X'10'         TEST MACRF BIT 11               13020019
         BC    1,ISLFX13                B IF ON = MOVE PUT, RTRN TO FX  13040019
*                                                                       13060019
* LOCATE PUT                                                            13080019
*                                                                       13100019
         BAL   R14,ISLPA01             *LINK TO BOB ROUTINE             13120019
         B     ISLFX13                  RETURN TO FX                    13140019
*                                                                       13160019
*                                                                       13180019
***WAIT SUBROUTINE***                                                   13200019
* THIS SUBROUTINE DETERMINES IF A CHANNEL PROGRAM IS AVAILABLE, AND     13220019
* IF IT IS NOT, WAITS UNTIL IT IS.  THE ROUTINE EXPECTS THE  FOLLOWING  13240019
* INPUT - R2 = ADDR OF IOB FOR CHANNEL PROGRAM TO BE TESTED             13260019
*         R4 = RETURN ADDRESS                                           13280019
*                                                                       13300019
ISLFY99  EQU   *                                                        13320019
         ST    R4,ISLVRSAV              SAVE RETURN ADDRESS        0700 13340019
         LR    R3,R1                    SAVE R1                         13360019
         L     R1,IOBECBAD              C(R1)=A(ECB)                    13380019
         TM    0(R1),X'40'              TEST ECB BIT 1 (C-BIT)          13400019
         BC    1,ISLFY995               B IF 1, I/O COMPLETE-DON'T WAIT 13420019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 13440019
         LR    R4,R0                    SAVE R0                         13460019
         LR    R5,R14                   SAVE R14                        13480019
         ST    R16,TSTWK2C              SAVE R16 FOR FTIW WAIT RTN      13490019
         WAIT  ECB=(1)                                                  13500019
         LR    R0,R4                    RESTORE R0                      13520019
         LR    R14,R5                   RESTORE R14                     13560019
         L     R16,TSTWK2C              RESTORE R16 FOR FTIW WAIT       13570019
*                                                                       13580019
ISLFY995 LA    R2,ISLIOBA               C(R2)=A(IOBA)                   13600019
         LR    R1,R3                    RESTORE R1                      13620019
         L     R3,IOBPTRA               C(R3)=A(1ST SLOT TO SCHED)      13640019
         LA    R3,0(R3)                                                 13660019
         L     R4,ISLVRSAV              GET RETURN ADDRESS         0700 13680019
         BCR   15,R4                    RETURN                          13700019
*                                                                       13720019
         EJECT                                                          13740019
*********************************************************************** 13760019
* CHART FZ - CYLINDER INDEX ENTRY SETUP                               * 13780019
*********************************************************************** 13800019
*                                                                       13820019
*                                                                       13840019
* STORE ADDR OF STATUS BYTE WITH C-BIT ON IN CP21 AT CQ41               13860019
* -THIS IS DONE TO PERMIT APPENDAGE TO TURN OFF C-BIT-                  13880019
*            * R7 CONTAINS ADDR OF THE STATUS BYTE *                    13900019
*                                                                       13920019
ISLFZ01  L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 13940019
         L     R10,24(R10)              C(R10)=A(CP21-CQ40)             13960019
         ST    R7,12(R10)               C(CQ41+4)=A(LAST SLOT SCHED)    13980019
         NI    ISLIXLT,X'F7'            SET IXLT LEV1 BIT-4 OFF- TRK IX 14000019
*                                                                       14020019
*                                                                       14040019
* LOCATE LEVEL IN INDEX LOCATION TABLE AT CYLINDER INDEX                14060019
*                                                                       14080019
         LA    R7,ISLIXLT               C(R7)=A(IXLT)                   14100019
         OI    0(R7),X'20'              IXLTIND BIT-2 ON IN LEV1        14120019
         NI    26(R7),X'DF'                     BIT-2 OFF IN LEV2       14140019
         NI    52(R7),X'DF'                                  LEV3       14160019
         NI    78(R7),X'DF'                                  LEV4       14180019
*                                                                       14200019
* CONSTRUCT COUNT FOR CYLINDER INDEX ENTRY IN AREA Y, Y+0               14220019
*                                                                       14240019
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 14260019
         L     R9,0(R10)                C(R9)=A(AREA Y)                 14280019
         MVC   0(4,R9),12(R7)           COUNT = CCHH FROM IXLT S0       14300019
         SR    R3,R3                                                    14320019
         IC    R3,16(R7)                C(R3)=R FROM IXLT S0, 000N      14340019
         A     R3,ISLONEF               C(R3)=R+1                       14360019
         STC   R3,4(R9)                 COUNT = CCHHR WITH R=R+1        14380019
*                                                                       14400019
* CONSTRUCT DATA FOR CYLINDER INDEX ENTRY IN AREA Y, Y+8                14420019
*                                                                       14440019
         TM    0(R7),X'40'              TEST IXLTIND BIT 1 (DUMMY SW)   14460019
         BC    1,ISLFZ10                B IF ON                         14480019
*                                                                       14500019
*                                       DUMMY SW OFF                    14520019
*  A. NORMAL DATA                                                       14540019
*                                                                       14560019
         MVC   8(7,R9),IOBDADAD         DATA=MBBCCHH FROM IOBA+32       14580019
         MVI   14(R9),X'00'             FOR 2321 SET TO TRACK 0         14680019
         CLI   DCBFIRSH+1,X'00'         H OF FIRSH VS 0          A46109 14750021
         MVC   15(2,R9),ISLONEF+2       PRIME R AND F            A46109 14780021
         BNE   ISLFZ03                  BIF HH NOT 0             A46109 14810021
*                                       HH OF FIRSH = 00                14840021
         MVC   15(1,R9),DCBFIRSH+2      DATA = MBBCCHHR WITH R   A46109 14870021
*                                       OF FIRSH                        14900021
ISLFZ03  EQU   *                                                 A46109 14930021
*                                                                       15020019
         SR    R6,R6                                                    15040019
         IC    R6,9(R7)                 C(R6) = M FROM IXLT S0          15060019
         BCTR  R6,0                     C(R6)=M-1                       15080019
         SLL   R6,4                     C(R6) = M-1 X 16 (USE AS INDX)  15100019
*                                                                       15120019
         SR    R5,R5                                                    15140019
         IC    R5,IOBDADAD              C(R5) = M FROM IOBA+32          15160019
         BCTR  R5,0                     C(R5)=M-1                       15180019
         SLL   R5,4                     C(R5) = M-1 X 16 (USE AS INDX)  15200019
*                                                                       15220019
         L     R8,DCBDEBAD              C(R8)=A(DEB)                    15240019
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  15280019
         LA    R4,0(R6,R4)              C(R4)=A(CURR INDX EXTENT ENTRY) 15300019
         L     R3,DEBFPEAD              C(R3)=A(1ST PRIM EXTENT ENTRY)  15320019
         LA    R3,0(R5,R3)              C(R3)=A(CURR PRIM EXTENT ENTRY) 15340019
         L     R9,0(R10)                C(R9)=A(AREA Y)                 15360019
*                                                                       15380019
         CLC   1(3,R3),1(R4)            COMP UCB ADDRS, PRIM VS INDX    15400019
         MVI   K17(R9),X07              DATA = MBBCCHHRFP WITH   S20201 15406020
*                                       P=07                     S20201 15412020
         BNE   ISLFZ05                  B IF NOT EQUAL           S20201 15422020
*                                                                       15440019
*                                       UCBS EQUAL                      15460019
         MVI   17(R9),X'0B'             DATA = MBBCCHHRFP WITH P=0B     15600019
*                                                                       15640019
*                                       UCBS UNEQUAL                    15660019
*                                                                       15700019
*                                       SET CQ43 (CP21) TO ADDRESS KEY  15720019
*                                       OF LAST RECORD IN LAST BUFFER   15740019
*                                                                       15760019
ISLFZ05  L     R4,ISLKEYAD              =A(KEY OF LAST WR CKD)    13165 15830019
         B     ISLFZ20                                                  15900019
*                                                                       15920019
*                                       DUMMY SW ON = END OF CYLINDER   15940019
*  B. DUMMY DATA                                                        15960019
*                                                                       15980019
*                                       TEST CC+1 VS DEBENDCC FOR       16000019
*                                       POSSIBLE END OF INDEX EXTENT    16020019
*                                                                       16040019
ISLFZ10  EQU   *                                                        16060019
         SR    R6,R6                                                    16080019
         IC    R6,9(R7)                 C(R6)=M FROM IXLT S0, 000M      16100019
         BCTR  R6,0                                                     16120019
         SLL   R6,4                     C(R6)=16(M-1) FOR USE AS INDEX  16140019
*                                       TO DEB ENTRY FOR CURR IX EXTNT  16160019
*                                                                       16180019
         L     R8,DCBDEBAD              C(R8)=A(DEB)                    16200019
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  16240019
         LA    R4,0(R6,R4)              C(R4)=A(CURR INDX EXTNT ENTRY)  16260019
*                                                                       16280019
         L     R9,0(R10)                C(R9)=A(AREA Y)                 16320019
         MVC   ISLFXWK1(4),12(R7)       C(FXWK1)=CCHH OF IXLT SO  13165 16340019
         L     R3,ISLFXWK1              C(R3)=CCHH                      16360019
         MVC   ISLFXWK2(4),10(R4)       C(FXWK2)=CCHH FROM DEBENDCC     16380019
*                                                                       16500019
         SRL   R3,16                    C(R3)=00CC                      16520019
         LA    R3,1(R3)                 ADD 1 FOR NEXT CYL C(R3)=00CC+1 16540019
         SLL   R3,16                    C(R3)=CC+100                    16560019
         ST    R3,ISLFXWK1              C(FXWK1)=CC+100                 16580019
         CLC   ISLFXWK1(2),ISLFXWK2     CC+1 VS ENDCC                   16600019
         BH    ISLFZ11                  BR IF CC+1 HI - IN NEW EXTENT   16620019
*                                                                       16640019
*                                       CC+1    IN CURRENT EXTENT       16660019
ISLFZ11A MVC   8(3,R9),9(R7)            DATA=MBB FROM IXLT S0           16680019
         MVC   11(4,R9),ISLFXWK1        DATA=MBBCCHH  CC=CC+1 HH=00     16700019
         BC    15,ISLFZ12               BR TO PICK UP R, ETC.           16720019
*                                                                       16740019
*                                                                       17440019
*                                                                       17460019
ISLFZ11  EQU   *                                                        17480019
         L     R8,DCBDEBAD              C(R8)=A(DEB)              13165 17500019
         LA    R6,16(R6)                INDEX TO NEXT EXTENT      7M402 17510019
         L     R4,DEBFPEAD              C(R4)=A(1ST PRIM EXTENT ENTRY)  17520019
         LA    R4,0(R6,R4)              C(R4)=A(NEXT INDEX EXT)   7M568 17540019
*                                                                       17560019
         L     R9,0(R10)                C(R9)=A(AREA Y)           13165 17570019
         MVC   11(4,R9),6(R4)           DATA=CCHH OF NEW EXTENT   7M568 17580019
         SRL   R6,4                     C(R6) = M FOR NEXT EXTENT       17600019
         A     R6,ISLONEF               C(R6) = M+1 (M=1 FOR EXTENT 0)  17620019
         STC   R6,8(R9)                 DATA = MBBCCHH OF NEW EXTENT    17640019
*                                                                       17660019
ISLFZ12  MVC   15(3,R9),ISLRFP          RFP=002907                8M800 17710019
*                                                                       17760019
*                                       SET CQ43(CP21) TO ADDRESS KEY   17780019
*                                       OF ALL ONES AT AREA Y +62       17800019
*                                                                       17820019
         LA    R4,62(R9)                C(R4)=A(AREA Y +62)             17860019
*                                                                       17940019
* PLACE IXLT S0 IN IOBB+32                                              17960019
*                                                                       17980019
ISLFZ20  L     R10,24(R10)              C(R10)=A(CP21-CQ40)       13165 17984019
         IC    R5,24(R10)               SAVE OP                   13165 17988019
         ST    R4,24(R10)               PTR TO REAL OR DUMMY KEY  13165 17992019
         STC   R5,24(R10)               RESTORE OP                13165 17996019
         LA    R2,ISLIOBB               C(R2)=A(IOBB)             13165 18000019
         MVC   IOBDADAD(8),9(R7)        C(IOBB+32)=C(IXLT SO)     13165 18004019
         BAL   R5,ISLFZ21                                               18010019
*                                                                       18020019
*                                                                       18040019
*                                                                       18060019
* EXECUTE CP21                                                          18080019
*                                                                       18100019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 18120019
         LR    R3,R0                    SAVE R0                         18140019
         LR    R4,R1                    SAVE R1                         18160019
         LR    R5,R14                   SAVE R14                        18180019
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         18200019
         LR    R0,R3                    RESTORE R0                      18220019
         LR    R1,R4                    RESTORE R1                      18240019
         LR    R14,R5                   RESTORE R14                     18260019
*                                                                       18280019
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   18300019
         TM    IOBFLAGS,X'12'           TEST FLAGS BITS 3&6 (CLOSE X)   18320019
         BCR   1,R14                    BR IF ON = CLOSE                18340019
         B     ISLFY30                  EXIT                            18360019
*                                                                       18380019
ISLFZ21  EQU   *                                                        18382019
         L     R13,DCBDEBAD                                             18384019
         LA    R13,32(R13)   START MOVE OF DEB BB INTO IOB              18386019
         SR    R8,R8                                                    18388019
         IC    R8,IOBDADAD                                              18390019
         SLL   R8,4                                                     18392019
         AR    R8,R13                                                   18394019
         MVC   IOBDADAD+2(1),5(R8)                                      18396019
         BR    R5                                                       18398019
         EJECT                                                          18400019
*********************************************************************** 18420019
* CHART PA - BEGINING OF BUFFER                                       * 18440019
*********************************************************************** 18460019
*                                                                       18480019
*                                                                       18500019
* USING PTR B TO REFERENCE COUNT IN LAST BUFFER FILLED -                18520019
*   SET REG 5 = R               - REG A = 000R                          18540019
*   SET REG 6 = CCHH            - REG B = CCHH                          18560019
*   SET REG 7 = HI-RCD ON TRACK - REG C = 000R                          18580019
*                                                                       18600019
ISLPA01  ST    R14,ISLF9WK1             SAVE R14 FOR RETURN TO FX       18620019
         MVC   DCBFTMI3(8),DCBLPDA      SAVE PREVIOUS LPDA FOR CLOSE    18640019
         L     R3,IOBPTRB               C(R3)=C(PTRB)                   18660019
         LA    R3,0(R3)                 C(R3)=A(SLOT S)                 18680019
         L     R4,0(R3)                 C(R4)=C(SLOT S)=A(BUF B)        18700019
         SR    R5,R5                                                    18720019
         IC    R5,4(R4)                 C(R5)=000R                      18740019
         MVC   ISLFXWK2(4),0(R4)        C(FXWK2)=CCHH                   18760019
         L     R6,ISLFXWK2              C(R6)=CCHH                      18780019
*                                                                       18800019
*                                       TEST HH FOR SHARED TRACK        18820019
         SR    R7,R7                                                    18840019
         CLI   DCBHIRSH,X'00'           HIRSH VS 0                      18860019
         BE    ISLPA02                  BR IF 0 - NO SHARED TRACKS      18880019
         STC   R6,ISLFXWK1              C(FXWK1)= H FROM BUF CNT        18900019
ISLPA01A NC    ISLFXWK1(1),DCBFIRSH+3   REDUCE TO TRACK                 18920019
ISLPA01B CLC   DCBFIRSH+1(1),ISLFXWK1   H OF FIRSH VS H OF BUFR CNT     18940019
         IC    R7,DCBHIRSH              C(R7)=HIRSH                     18960019
         BE    ISLPA03                  BR EQ, SHARED TRK - R7=HIRSH    18980019
ISLPA02  IC    R7,DCBHIRPD              NOT A SHARED TRACK, C(R7)=HIRPD 19000019
*                                                                       19020019
* STEP PTR B TO NEXT SLOT IN BCT (MAY WRAPAROUND)                       19040019
*                                                                       19060019
ISLPA03  C     R3,ISLBUFN               TEST FOR ADR OF NTH SLOT        19080019
         LA    R3,4(R3)                 STEP TO NEXT SLOT               19100019
         BNE   ISLPA05                  NOT NTH SLOT, GO UPDATE PTR B   19120019
ISLPA04  LA    R3,IOBABUF               C(R3)=0AAA, AAA= ADR 1ST SLOT   19140019
ISLPA05  IC    R4,IOBB                  SAVE B                          19160019
         ST    R3,IOBPTRB               STORE UPDATED PTR B             19180019
         STC   R4,IOBB                  RESTORE B                       19200019
*                                                                       19220019
* UPDATE CBF AND EOB FOR NEW BUFFER VIA PTR B                           19240019
*                                                                       19260019
         L     R4,0(R3)                 C(R4)=C(SLOT S)=A(BUFF B)       19280019
         LA    R4,0(R4)                                                 19300019
         LR    R3,R4                    C(R3)=A(BUFF B)                 19320019
         A     R3,ISL8                  C(R3)=A(BUFF B)+8               19340019
         ST    R3,ISLCBF                C(CBF)=A(BUFF B)+8              19360019
         LH    R3,DCBBUFL               C(R3)=00NN                8M800 19390019
         BCTR  R3,0                     C(R3)=00NN-1                    19420019
         AR    R3,R4                    C(R3)=A(BUFF B)+BUFL-1          19440019
         ST    R3,ISLEOB                C(EOB)=A(BUFF B)+BUFL-1         19460019
*                                                                       19480019
*                                                                       19500019
* ROUTINE TO SET UP NEW COUNT FIELD FOR NEW BUFFER                      19520019
* ************************************************                      19540019
*                                                                       19560019
*                                                                       19580019
* TEST IF LAST BUFFR FILLED WAS EOT                                     19600019
*                                                                       19620019
         CR    R7,R5                    TEST REG C VS REG A             19640019
         BE    ISLPA20                  B IF EOT                        19660019
*                                                                       19680019
*                                                                       19700019
* STEP REG A TO NEXT R ON CURRENT TRACK                                 19720019
*                                                                       19740019
         A     R5,ISLONEF               C(R5)=000R+1                    19760019
*                                                                       19780019
* TEST IF NEXT BUFFR TO BE FILLED IS AVAILABLE (STATUS BITS)            19800019
*                                                                       19820019
ISLPA50  L     R3,IOBPTRB               C(R3)=PTR B = A(NEXT SLOT) OR-  19840019
         LA    R3,0(R3)                 C(R3)=A(STATUS BITS)            19860019
         TM    0(R3),X'60'              TEST BITS 1 AND 2               19880019
         BC    8,ISLPA70                B IF 00 = BUFFR AVAILABLE       19900019
*                                                                       19920019
*                                       BITS 1 AND 2 = 11 OR 10         19940019
*                                                                       19960019
* WAIT FOR CP18, AND/OR CP20, AND/OR CP21 BEFORE RE-FILLING BUFFER      19980019
*                                                                       20000019
ISLPA60  L     R4,IOBECBAD              C(R4)=A(ECB)                    20020019
         TM    0(R4),X'40'              TEST ECB BIT 1 (C-BIT)          20040019
         BC    1,ISLPA70                B IF 1, I/O COMPLETE-DONT WAIT  20060019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 20080019
         LR    R3,R1                    SAVE R1                         20100019
         LR    R1,R4                    C(R1)=A(ECB)                    20120019
         LR    R4,R0                    SAVE R0                         20140019
         WAIT  ECB=(1)                  WAIT                            20160019
         LR    R0,R4                    RESTORE R0                      20180019
         LR    R1,R3                    RESTORE R1                      20200019
         L     R3,IOBPTRB               C(R3)=PTR B = A(NEXT SLOT) OR-  20220019
         LA    R3,0(R3)                 C(R3)=A(STATUS BITS)            20240019
*                                                                       20260019
*                                                                       20280019
* TEST DCBEXCD1 BIT 5 FOR PREVIOUS UNCORRECTABLE WRITE ERROR            20300019
*                                                                       20320019
ISLPA70  TM    DCBEXCD1,X'04'           TEST EXCD1 BIT 5                20340019
         BC    8,ISLPA72                B IF NOT ON                     20360019
         TM    IOBFLAGS,X'10'           TEST FLAGS BIT 3 (CLOSE)        20380019
         BC    1,ISLPA72                B IF ON = CLOSE                 20400019
         B     ISLFX02                  BRANCH TO TAKE SYNAD     A38521 20490021
*                                                                       20580019
ISLPA72  EQU   *                                                        20600019
         LA    R2,ISLIOBB               C(R2)=A(IOBB)                   20620019
         TM    0(R3),X'04'              TEST BIT 5 (C-BIT)              20640019
         BC    7,ISLPA60                BR IF 1 - C-BIT ON              20660019
*                                                                       20680019
*                                       C-BIT OFF                       20700019
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   20720019
*                                                                       20740019
* TEST IF NEXT BUFFER TO BE FILLED WILL BE EOT (AND EOC)                20760019
* IF EOT, TURN ON T-BIT  IF EOC, TURN ON C-BIT                          20780019
*                                                                       20800019
ISLPA80  CR    R7,R5                    TEST REG C VS REG A             20820019
         BNE   ISLPA84                  B IF NOT EOT                    20840019
*                                                                       20860019
*                                       NEXT BUFFER EOT                 20880019
         OI    0(R3),X'08'              TURN T-BIT ON (STATUS BIT 4)    20900019
         ST    R6,ISLFXWK1              C(FXWK1)= CCHH FROM REG B       20920019
ISLPA8A  NC    ISLFXWK1+3(1),DCBFIRSH+3 REDUCE TO TRACK FROM REG B      20940019
ISLPA8B  CLC   DCBLDT+1(1),ISLFXWK1+3   H OF LDT VS H FROM REG B        20960019
         BNE   ISLPA84                  B IF NOT LDT                    20980019
         OI    0(R3),X'04'              TURN C-BIT ON (STATUS BIT 5)    21000019
*                                                                       21020019
* ENTER NEW COUNT IN BUFFER USING REG A AND REG B AND UPDATE LPDA       21040019
*                                                                       21060019
ISLPA84  L     R3,0(R3)                 C(R3)=C(SLOT S)=A(NEXT BUFFR)   21080019
         LA    R3,0(R3)                                                 21100019
         ST    R6,ISLFXWK2              STORE CCHH FROM REG B           21120019
         MVC   0(4,R3),ISLFXWK2                                         21140019
         STC   R5,4(R3)                 STORE R FROM REG A              21160019
         MVC   DCBLPDA+3(5),0(R3)       STORE CCHHR FROM BUF IN LPDA    21180019
         L     R14,ISLF9WK1             RESTORE R14 FOR RETURN TO FX    21200019
         BR    R14                     *EXIT                            21220019
*---------------------------------------------------------------------- 21240019
*                                                                       21260019
*                                       LAST BUFFR FILLED EOT           21280019
* SET REG 7 (REG C) = HIRPD, NEXT TRACK CANT BE SHARED                  21300019
*                                                                       21320019
ISLPA20  IC    R7,DCBHIRPD              NOT A SHARED TRACK, C(R7)=HIRPD 21340019
         ST    R6,ISLFXWK1              C(FXWK1)=CCHH FROM REG B        21360019
*                                                                       21380019
* TEST FOR OUT-OF-SPACE                                                 21400019
*                                                                       21420019
         CLC   DCBLPDA(1),DCBMSWA       CURRENT M VS HI M               21440019
         BNE   ISLPA21                  B IF NOT HI PRIME M             21460019
         CLC   ISLFXWK1(4),DCBMSWA+3    CURRENT CCHH VS HI CCHH         21480019
         BNE   ISLPA21                  B IF NOT HI PRIME CCHH          21500019
         TM    IOBFLAGS,X'10'           TEST FOR CLOSE                  21520019
         BO    ISLPA21                  IF CLOSE, GET COUNT       17925 21540019
*                                       ELSE OUT OF SPACE         17925 21560019
*                                      *---------OUT-OF-SPACE---------* 21600019
ISLPA205 EQU   *                                                        21620019
         OI    DCBEXCD1,X'20'           SET EXCD1 BIT 2 ON = SPACE ERR  21640019
         L     R13,ISLVRSAV+4           RESTORE USER REG 13    @ZA10226 21650037
         B     ISLFX04A                 B TO TAKE SYNAD        @ZA07607 21660037
*                                                                       21680019
* TEST IF LAST BUFFER FILLED WAS EOT AND EOC                            21700019
*                                                                       21720019
ISLPA21  EQU   *                                                        21740019
         EX    R0,ISLPA8A               EXECUTE NC                      21760019
         EX    R0,ISLPA8B               EXECUTE CLC                     21780019
         BE    ISLPA30                  B IF EOT AND EOC                21800019
*                                                                       21820019
*                                       EOT NOT EOC                     21840019
* STEP REG B TO NEXT HH AND SET REG A TO R = 1                          21860019
*                                                                       21880019
         A     R6,ISLONEF               C(R6)=CCHH+1                    21900019
         L     R5,ISLONEF               C(R5)=000R, R = 1               21920019
         B     ISLPA50                                                  21940019
*                                                                       21960019
*                                                                       21980019
*                                       EOT,EOC                         22000019
* NEXT BUFFER TO BE FILLED WILL BE THE 1ST BUFFR ON A NEW CYLINDER      22020019
*                                                                       22040019
* TEST IF SHARED TRACKS                                                 22060019
*                                                                       22080019
ISLPA30  CLI   DCBHIRSH,X'00'           HIRSH VS 0                      22100019
         BE    ISLPA31                  B IF 0, NOT SHARED              22120019
*                                                                       22140019
*                                       SHARED TRACKS                   22160019
* IF SHARED TRACKS, 1ST PRIME DATA ON NEW CYLINDER IS ON A SHARED TRACK 22180019
*                                                                       22200019
         L     R3,IOBPTRB               C(R3)=PTR B = A(NEXT SLOT) OR-  22220019
         OI    0(R3),X'02'              TURN PF-BIT ON (STATUS BIT 6)   22240019
*                                                                       22260019
* SET REG 7 (REG C) = HIRSH                                             22280019
*                                                                       22300019
         IC    R7,DCBHIRSH              SHARED TRACK NEXT, C(R7)=HIRSH  22320019
*                                                                       22340019
* TEST IF LAST BUFFER FILLED WAS EOT, EOC, AND EOE                      22360019
*                                                                       22380019
ISLPA31  L     R8,DCBDEBAD              C(R8)=A(DEB)                    22400019
         L     R3,DEBFPEAD              C(R3)=A(1ST PRIME EXTENT ENTRY) 22420019
         LA    R3,0(R3)                                                 22440019
         L     R4,DCBLPDA               C(R4)=MBBC                      22460019
         SRL   R4,24                    C(R4)=000M                      22480019
         BCTR  R4,0                     C(R4)=M-1                       22500019
         SLL   R4,4                     C(R4)=000M-1 X 16 (USE AS INDX) 22520019
         L     R8,12(R4,R3)             C(R8)=HHXX-END HH OF CURR EXTNT 22540019
         SRL   R8,16                    C(R8)=00HH                      22560019
*                                                                       22660019
         L     R8,8(R4,R3)              C(R8)=END HHCC OF CURR EXTENT   22680019
         SLL   R8,16                    C(R8)=CC00                      22700019
         SRL   R8,16                    C(R8)=00CC=END CC OF EXTENT     22720019
         LR    R5,R6                    C(R5)=CCHH                      22740019
         SRL   R5,16                    C(R5)=00CC=CC JUST FILLED       22760019
         CR    R8,R5                    COMPARE FOR LAST CYLINDER       22780019
         BH    ISLPA33                  B IF END CC IS HIGH             22800019
*                                                                       22820019
*                                       EOT, EOC, AND EOE               22840019
*                                                                       22860019
* SET REG 6 (REG B) TO CC FROM NEXT EXTENT                              22880019
*                                                                       22900019
         LA    R4,16(R4)                C(R4)=MX16  INDEX TO NEXT EXTNT 22920019
         L     R8,4(R4,R3)              C(R8)=STR BBCC OF NEXT EXTENT   22940019
         SLL   R8,16                    C(R8)=CC00                      22960019
         LR    R6,R8                    C(R6)=CC00, HH SET LATER        22980019
*                                                                       23000019
* SET M IN DCBLPDA = M+1                                                23020019
*                                                                       23040019
         SRL   R4,4                     C(R4)=000M                      23060019
         A     R4,ISLONEF               C(R4)=000M+1 (M=1 FOR EXTENT 0) 23080019
         STC   R4,DCBLPDA               C(LPDA)=000M+1                  23100019
*                                                                       23120019
* SET STATUS BIT-3 ON = NEW EXTEN STARTS WITH THIS BUFFR                23140019
*                                                                       23160019
         L     R3,IOBPTRB               C(R3)=PTR B = A(NEXT SLOT) OR-  23180019
         LA    R3,0(R3)                 C(R3)=A(STATUS BITS)            23200019
         OI    0(R3),X'10'              TURN STATUS BIT-3 ON            23220019
*                                                                       23240019
         B     ISLPA34                                                  23260019
*                                                                       23280019
*                                                                       25220019
* SET REG 6 (REG B) TO CC +1            EOT, EOC, NOT EOE               25240019
*                                                                       25260019
ISLPA33  A     R5,ISLONEF               C(R5)=00CC+1, PREVIOUS CC +1    25280019
         SLL   R5,16                    C(R5)=CC00                      25300019
         LR    R6,R5                    C(R6)=CC00, HH SET BELOW        25320019
*                                                                       25340019
* SET REG 6 (REG B) TO HH FROM FIRSH                                    25360019
*                                                                       25380019
ISLPA34  ST    R6,ISLFXWK1              C(FXWK1)=CC00                   25400019
         MVC   ISLFXWK1+2(2),DCBFIRSH   C(FXWK1)=CCHH, HH FROM FIRSH    25420019
         L     R6,ISLFXWK1              C(R6)=CCHH                      25440019
*                                                                       25460019
* SET REG 5 (REG A) TO R FROM FIRSH                                     25480019
*                                                                       25500019
ISLPA35  EQU   *                                                        25520019
         SR    R5,R5                                                    25540019
         IC    R5,DCBFIRSH+2            C(R5)=000R, R FROM FIRSH        25560019
*                                                                       25580019
* PREFORMAT SHARED TRACK OF NEW CYLINDER IF NECESSARY                   25600019
*                                                                       25620019
         TM    DCBOPTCD,X'08'           TEST OPTCD BIT-4 FOR CYL OVFL   25640019
         BC    1,ISLPA40                B IF ON = CYL OVFL              25660019
         CLI   DCBHIRSH,X'00'           TEST HIRSH VS 0           8M800 25680019
         BE    ISLPA50                  B IF 0, NOT SHARED              25700019
*                                                                       25720019
*                                       SHARED TRACKS - PREFORMAT       25740019
*                                                                       25760019
* INITIALIZE CP19                                                       25780019
*****************                                                       25800019
*                                                                       25820019
ISLPA40  LA    R2,ISLIOBC               C(R2)=A(IOBC)                   25840019
*                                                                       25860019
* BE SURE CP19 NOT IN USE                                               25880019
*                                                                       25900019
         L     R4,IOBECBAD              C(R4)=A(ECB)                    25920019
         TM    0(R4),X'40'              TEST ECB BIT 1 (C-BIT)          25940019
         BC    1,ISLPA41                B IF 1, I/O COMPLETE-DONT WAIT  25960019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 25980019
         LR    R3,R1                    SAVE R1                         26000019
         LR    R1,R4                    C(R1)=A(ECB)                    26020019
         LR    R4,R0                    SAVE R0                         26040019
         WAIT  ECB=(1)                  WAIT                            26060019
         LR    R0,R4                    RESTORE R0                      26080019
         LR    R1,R3                    RESTORE R1                      26100019
ISLPA41  STM   R2,R11,ISLVRSAV+28       SAVE REGS 2-11                  26120019
*                                                                       26140019
*  1. SET IOBC+32 TO NEW CC AND NEW M IF ANY                            26160019
*                                                                       26180019
         ST    R6,ISLFXWK2              C(FXWK2)=CCHH FROM REG B        26200019
         MVC   32(3,R2),DCBLPDA         MOVE MBB FROM LPDA              26220019
         MVC   35(3,R2),ISLFXWK2        MOVE CCH FROM REG B       22619 26240019
*                                                                       26400019
*  2. SET CM27 TO NEW CC AND NEW M IF ANY                               26420019
*                                                                       26440019
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 26480019
         L     R10,16(R10)              C(R10)=A(CP19)                  26500019
         USING CM1,R10                  ADDRESSABILITY ON CP19   S20201 26510020
         MVC   CM27(L3),DCBLPDA         MOVE MBB FROM LPDA       S20201 26520020
         MVC   CM27+K3(L4),ISLFXWK2     MOVE CCHH FROM FXWK2     S20201 26530020
         DROP  R10                                               S20201 26540020
*                                                                       26560019
*  3. SET UP AREA Z WITH NEW CC                                         26580019
*                                                                       26600019
         LA    R9,ISLAREAZ              C(R9)=A(AREA Z)                 26620019
         LA    R3,10                    C(R3) = 10 = COUNT              26640019
         LA    R4,6(R9)                 C(R4)=A(Z+6)                    26660019
ISLPA42  MVC   0(4,R4),ISLFXWK2         STORE CCHH IN Z                 26680019
         A     R4,ISL8                  STEP Z                          26700019
         BCT   R3,ISLPA42               LOOP                            26720019
*                                                                       26740019
*                                                                       26760019
* EXECUTE CP19 - PREFORMAT NEW CYLINDER                                 26780019
***************************************                                 26800019
*                                                                       26820019
         LM    R2,R11,ISLVRSAV+28       RESTORE REGS 2-11               26840019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 26860019
         LR    R3,R0                    SAVE R0                         26880019
         LR    R4,R1                    SAVE R1                         26900019
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         26920019
         LR    R0,R3                    RESTORE R0                      26940019
         LR    R1,R4                    RESTORE R1                      26960019
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   26980019
*                                                                       27000019
         B     ISLPA50                                                  27020019
*                                                                       27040019
*---------------------------------------------------------------------- 27060019
*                                                                       27080019
         EJECT                                                          27100019
*********************************************************************** 27120019
* CHART PB - SET FBW                                                  * 27140019
*********************************************************************** 27160019
*                                                                       27180019
*                                                                       27200019
* C(R7)=A(LAST SLOT SCHED) AS IT WAS FROZEN BEFORE I/O                  27220019
*    SET REG 8 = NO OF BUFFRS NEEDED TO COMPLETE TRACK  - REG C         27240019
*                                                                       27260019
ISLPB01  L     R6,0(R7)                 C(R6)=A(LAST BUFF)              27280019
         LA    R6,0(R6)                                                 27300019
         SR    R3,R3                                                    27320019
         SR    R8,R8                                                    27340019
         IC    R3,4(R6)                 C(R3)=LAST R                    27360019
*                                                                       27380019
* TEST IF SHARED TRACKS ARE USED                                        27400019
*                                                                       27420019
         IC    R8,DCBHIRPD         C(R8)=HIRPD                          27440019
         CLI   DCBHIRSH,X'00'      HIRSH VS 0                           27460019
         BE    ISLPB02                  B IF 0, NO SHARED TRACKS        27480019
*                                                                       27500019
* TEST IF CURRENT TRACK SHARED                                          27520019
*                                                                       27540019
ISLPB01A MVC   ISLFXWK1(1),3(R6)   H (TRK BYTE) FROM BUFFER CNT         27560019
         EX    R0,ISLPA01A         REDUCE TO TRACK ADDR                 27580019
         EX    R0,ISLPA01B         H OF FIRSH VS H OF BUFFER CNT        27600019
         BE    ISLPB03                  B IF EQUAL, TRACK SHARED        27620019
*                                                                       27640019
* TEST IF LAST BUFF WAS EOC, IF SO- NEXT TRACK IS SHARED                27660019
*                                                                       27680019
         TM    0(R7),X'04'              TEST S BIT 5 VS 1 (C-BIT)       27700019
         BC    1,ISLPB05                B IF 1, EOC                     27720019
*                                                                       27740019
* 1. SHARED TRACKS-                                                     27760019
*        CURR TRACK NOT SHARED AND NOT EOC                              27780019
* 2. SHARED TRACKS NOT USED-                                            27800019
*                                                                       27820019
ISLPB02  EQU   *                                                        27840019
         TM    0(R7),X'08'              TEST S BIT 4 VS 1 (T-BIT)       27860019
         BC    1,ISLPB06                B IF 1, EOT                     27880019
         B     ISLPB06A                                                 27900019
*                                                                       27920019
* 3. SHARED TRACKS-                                                     27940019
*        CURR TRACK SHARED                                              27960019
*                                                                       27980019
ISLPB03  TM    0(R7),X'08'              TEST S BIT 4 VS 1 (T-BIT)       28000019
         BC    1,ISLPB06                B IF 1, EOT                     28020019
         IC    R8,DCBHIRSH              C(R8)=HIRSH                     28040019
         B     ISLPB06A                                                 28060019
*                                                                       28080019
* 4. SHARED TRACKS-                                                     28100019
*        CURR TRACK NOT SHARED, BUT EOC                                 28120019
*                                                                       28140019
ISLPB05  IC    R8,DCBHIRSH              C(R8)=HIRSH                     28160019
         IC    R3,DCBFIRSH+2            C(R3)=FIRSH R                   28180019
         A     R8,ISLONEF               C(R8)=HIRSH-FIRSH R +1          28200019
*                                                                       28220019
ISLPB06A SR    R8,R3                    C(R8)=HIRSH-FIRSH R OR R+1      28240019
*   REG C = HI R IF FULL TRACK TO BE WRITTEN                            28260019
*   REG C = HI R - R IF PARTIAL TRACK TO BE WRITTEN                     28280019
*                  R = NO. OF BUFFERS WRITTEN SO FAR ON THIS TRACK      28300019
*                                                                       28320019
ISLPB06  ST    R8,ISLFBW                R8 = REG C, C(FBW)=C(REG C)     28340019
*                                                                       28360019
* TEST NEW FBW VS BUFNO AND ADJUST FBW IF NECESSARY                     28380019
*                                                                       28400019
         LA    R4,1                     C(R4)=1                         28420019
         CLC   ISLFBW+3(1),ISLBUFNO     TEST FBW VS BUFNO               28440019
         BL    ISLPB20                  B IF FBW LOW                    28460019
*                                                                       28480019
*                                       FBW HI OR EQ -                  28500019
*                                                                       28520019
         CLC   ISLBUFNO(1),ISLONEF+3    TEST BUFNO VS 1                 28540019
         BE    ISLPB10                  B IF BUFNO = 1                  28560019
*                                                                       28580019
         IC    R4,ISLBUFNO              BUFNO NOT 1, C(R4)=BUFNO        28600019
         BCTR  R4,0                     C(R4)-BUFNO-1             P4701 28620019
*                                                                       28640019
*                                       BUFNO=1                         28660019
ISLPB10  EQU   *                                                        28680019
         ST    R4,ISLFBW                C(FBW)=1                        28700019
*                                                                       28720019
ISLPB20  B     ISLFY41                 *EXIT                            28740019
         EJECT                                                          28760019
*********************************************************************** 28780019
* CHART F8 - INITIALIZE CP18 FOR CURRENT BUFFER SET                   * 28800019
*********************************************************************** 28820019
*                                                                       28840019
*                                                                       28860019
* SET OFFST AND D ACCORDING TO RECFM (IOBA FLAGS BIT 7)                 28880019
*                                                                       28900019
ISLF801  L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 28920019
*                                                                       29060019
* CALC FSTBF = # OF SLOTS SLOT X IS FROM SLOT #1 IN BUF CTRL TABLE      29080019
*                                                                       29100019
ISLF803  L     R3,IOBPTRA               C(R3)=C(PTR A)=A(SLOT X)        29120019
         LA    R3,0(R3)                                                 29140019
         LA    R4,IOBS                  C(R4)=A(SLOT #1)                29160019
         SR    R3,R4                    C(R3)= # OF BYTES X IS FROM #1  29180019
         SRA   R3,2                     DIV BY 4, C(R3)= DIFF IN SLOTS  29200019
         ST    R3,ISLFSTBF              C(FSTBF)= # OF SLOTS FROM #1    29220019
*                                         THAT FIRST BUF SCHED IS       29240019
*                                                                       29260019
* CALC ADDR OF WR CKD X (SCHED TO WR FIRST) FOR TIC IN CP18             29280019
*                                                                       29300019
         L     R5,ISLOFFST              C(R4+R5)=OFFST                  29320019
         MR    R4,R3                    FSTBF X OFFST, C(R5)= THE # OF  29340019
*                                         BYTES WR CKD X IS FROM THE    29360019
*                                         FIRST BYTE OF WR CKD #1       29380019
         L     R10,12(R10)              C(R10)=A(CP18)                  29400019
         LA    R4,24(R10)               C(R4)=A(WR CKD #1)              29420019
         AR    R4,R5                    C(R4)=A(WR CKD X)               29440019
         IC    R6,16(R10)               C(R6)=TIC OP CODE AT CP18+16    29460019
         ST    R4,16(R10)               C(CP18+16)=A(WR CKD X),4 BYTES  29480019
         STC   R6,16(R10)               C(CP18+16)=TIC OP CODE,1 BYTE   29500019
*                                                                       29880019
* CALC LSTBF = FBW SLOTS FROM FSTBF -1, MAY WRAPAROUND                  29900019
*                                                                       29920019
         L     R3,ISLFSTBF              C(R3)=# OF SLOTS FROM SLOT #1   29940019
         A     R3,ISLFBW                C(R3)= FSTBF + FBW              29960019
         BCTR  R3,0                     C(R3)=FSTBF + FBW-1 = LSTBF     29980019
         SR    R4,R4                    C(R4)= 0000                     30000019
         IC    R4,ISLBUFNO              C(R4)=NO OF BUFFRS              30020019
         CR    R3,R4                    LSTBF VS BUFNO, TEST WRAPAROUND 30040019
         BL    ISLF806                  B IF NO WRAPAROUND, LSTBF OK    30060019
         SR    R3,R4                    C(R3)=LSTBF-BUFNO = LSTBF       30080019
*                                         LSTBF SET FOR WRAPAROUND      30100019
ISLF806  ST    R3,ISLLSTBF              C(LSTBF)= # OF SLOTS FROM #1    30120019
*                                         THAT LAST BUF SCHED IS        30140019
         L     R5,ISLOFFST              C(R4+R5)=OFFST                  30240019
         MR    R4,R3                    LSTBF X OFFST, C(R5)= THE # OF  30260019
*                                         BYTES LAST WR CKD TO BE       30280019
*                                         EXECUTED IS FROM THE FIRST    30300019
*                                         BYTE OF WR CKD #1             30320019
         AR    R5,R10                   *                         13334 30324019
         IC    R4,ISLBUFNO              * C(6)=BUFFER NUMBER      13334 30328019
         LR    R3,R10                   * C(R3)=A(CP18)           13334 30332019
ISLF811  AL    R3,ISLOFFST              *C(R3)=A OF 1ST WRT. COMD 13334 30336019
         MVC   17(3,R3),21(R3)          * RESTORE ORIGN. TIC ADDR.13334 30340019
         BCT   R4,ISLF811               * LOOP , UNTIL ALL DONE   13334 30344019
         TM    IOBFLAGS,X'01'           * RKP=0 ?                 13334 30348019
         BC    1,ISLF808                * BRANCH IF RKP=0         13334 30352019
         MVC   49(3,R5),13(R10)         * SET TIC BRANCH TO WRT.CK13334 30356019
         MVC   ISLKEYAD+1(3),33(R5)     * SET LAST WRITE KEY ADDR.13334 30360019
ISLF809  L     R5,12(R10)               * C(R5)=A(TIC CCW)        13334 30364019
         L     R3,ISLFBW                * C(R3)=NO. OF BUF. TO WRT13334 30368019
         L     R4,20(R10)               * C(R4)=A(READ BACK CCW)  13334 30372019
ISLF807  SL    R4,ISL8                  * C(R4)=A(FIRST READ CCW) 13334 30376019
         BCT   R3,ISLF807               * LOOP,IF MORE THAN 1 BUFR13334 30380019
         USING CL0,R5                   ADDRESSABILITY CP18 WC   S20201 30381020
*                                       EXT                      S20201 30382020
         ST    R4,CL3                   * C(R4)=A(FIRST READ     S20201 30384020
*                                       CCW)                     S20201 30386020
         OI    CL3,TIC                  * RESTORE TIC OP CODE    S20201 30389020
         B     ISLF901                                            13334 30392019
*                                                                 13334 30396019
ISLF808  MVC   33(3,R5),13(R10)         * SET TIC BRANCH TO WRT.CK13334 30400019
         L     R4,24(R5)                * C(R4)=A(CKD OF LAST WRT)13334 30404019
         LA    R4,8(R4)                 * C(R4)=A(KEY OF LAST WRT)13334 30408019
         ST    R4,ISLKEYAD              * SET UP LAST KEY ADDR.   13334 30412019
         B     ISLF809                  * RETURN TO MAIN LINE     13334 30416019
         EJECT                                                          30440019
*********************************************************************** 30460019
* CHART F9 - INITIALIZE CP20 FOR CURRENT TRACK                        * 30480019
*********************************************************************** 30500019
*                                                                       30520019
         USING ISLY,R9                                                  30540019
*                                                                       30560019
* F9 HOUSEKEEPING                                                       30580019
*                                                                       30600019
ISLF901  L     R6,IOBPTRA               C(R6)=C(PTR A)=A(SLOT X)        30620019
         L     R6,0(R6)                 C(R6)=C(SLOT X)=A(1ST BUF)      30640019
         LA    R6,0(R6)                                                 30660019
         MVC   ISLFXWK1(4),1(R6)        C(FXWK1)=CHHR OF CNT IN 1ST BUF 30680019
         L     R7,ISLFXWK1              C(R7)=CHHR                      30700019
         BCTR  R7,0                     C(R7)=CHHR-1                    30720019
*                                                                       30740019
* TEST LAST BUFFER FOR END OF TRACK (T-BIT ON)                          30760019
*                                                                       30780019
         L     R3,ISLLSTBF              C(R3)=LSTBF                     30800019
         SLA   R3,2                     MULT BY 4, C(R3)=LSTBF IN BYTES 30820019
         LA    R3,IOBS(R3)              C(R3)=A(LSTBF SLOT IN BCT)      30840019
*                                                                       30940019
* SET IOBA+32 (IOBDADAD) = COUNT OF 1ST BUF SCHED, R=R-1 FOR SRCH ID    30960019
*                                                                       30980019
         MVC   IOBDADAD+3(1),0(R6)      C(IOBA+35)=C FROM 1ST BUF       31000019
         ST    R7,IOBDADAD+4            C(IOBA+35)=CHHR WITH R=R-1      31020019
         IC    R4,IOBCPSAD              SAVE SIOCC                      31040019
         ST    R10,IOBCPSAD             C(CPSAD)=CP18 START ADR         31060019
         STC   R4,IOBCPSAD              RESTORE SIOCC                   31080019
         TM    0(R3),X'08'              TEST S BIT 4 VS 1 (T-BIT)       31083019
         BO    ISLF902                  BR IF T BIT IS ON               31086019
*                                                                       31089019
*              T BIT IS OFF - NO CP 20 YET                              31092019
*                                                                       31095019
*                                                                       31100019
* SET CL1 IN CP18 TO REFERENCE IOBA+35                                  31120019
*                                                                       31140019
INITCP18 LA    R3,IOBDADAD+3            C(R3)=A(IOBA+35)                31160019
         O     R3,SCHCOM                *COMBINE SCH OP CODER.    13334 31180019
         ST    R3,0(R10)                *UPDATE CP18 SCH COMD.    13334 31200019
         ST    R3,CL1                   *UPDATE CP18 WRT. CK.    S20201 31210020
*                                       SCH                      S20201 31220020
         B     ISLFY21                  * RETURN TO FYRT. CK. SCH 13334 31240019
*                                                                       31280019
         EJECT                                                          31480019
*********************************************************************** 31490019
*                                                                       31500019
*              SET BIT TO INDICATE THAT THE TRACK INDEX HAS BEEN        31510019
*              WRITTEN BUT NOT THE CYLINDER INDEX.                      31520019
*                                                                       31530019
*********************************************************************** 31540019
ISLF902  EQU   *                                                        31550019
         OI    ISLIXLT,X'08'            SET IXLT LEV1 BIT-4 ON          31560019
*********************************************************************** 31570019
*                                                                       31580019
*              SET UP MBBCCHHR AT THE BEGINNING OF TISA                 31590019
*                                                                       31600019
*********************************************************************** 31610019
*                                                                       31620019
         LR    R4,R10                   C(R4)=A(CP18)                   31630019
         L     R10,DCBWKPT6             C(R10)=A(ISLVPTRS)              31640019
         L     R7,ISLVPTRA              GET A(TISA) INTO R7      A38521 31650021
         MVC   0(8,R7),IOBDADAD         A(TISA)=MBBCCHHR FOR CP18       31670019
*********************************************************************** 31680019
*                                                                       31690019
*              SET CL1 IN CP18 TO REFERENCE THE SEEK ADDRESS AT         31700019
*              THE BEGINNING OF TISA.                                   31710019
*                                                                       31720019
*********************************************************************** 31730019
         LA    R3,3(R7)                 C(R3)=A(CCHHR AT TISA+3)        31740019
         O     R3,SCHCOM                COMBINE SRCH COMMAND            31750019
         ST    R3,0(R4)                 STORE A(CCHHR AT TISA+3)        31760019
         ST    R3,CL1                   WR CHK SRCH IN CP18      S20201 31766020
         DROP  R5                                                S20201 31772020
*********************************************************************** 31780019
*                                                                       31790019
*         SET UP NORMAL AND OVERFLOW DATA (FROM CP18 SEEK ADDRESS)      31800019
*                                                                       31810019
*********************************************************************** 31820019
         MVC   ISLNDAT(3),IOBDADAD      C(NDAT)= MBB FROM IOBA+32       31830019
         MVC   ISLNDAT+3(4),0(R6)       C(NDAT)= CCHH FROM 1ST BUF      31840019
         MVC   ISLODAT(7),ISLNDAT       C(ODAT)= MBBCCHH FROM NDAT      31850019
         MVC   ISLNDAT+7(2),ISLZEROF    NORMAL DATA F=00 (UNSHARED)     31860019
*                                       R=00                            31870019
         EJECT                                                          31880019
*********************************************************************** 31890019
*                                                                       31900019
*              SET UP NDAT FP FOR SHARED TRACK                          31910019
*                                                                       31920019
*********************************************************************** 31930019
         CLI   DCBHIRSH,X'00'           SHARED TRACK                    31940019
         BE    INITCNT                  NO - BR TO INIT CNT FIELDS      31950019
         MVC   TSTWK1C(1),ISLNDAT+6     C(TSTWK1C)=H OF NORM DATA       31960019
         NC    TSTWK1C(1),DCBFIRSH+3    REDUCE TO TRACK                 31970019
         CLC   DCBFIRSH+1(1),TSTWK1C    H OF FIRSH VS H OF BUF CNT      31980019
         BNE   INITCNT                  BR TO INIT CNT FIELDS           31990019
         MVI   ISLNDAT+8,X'08'          NORM DATA F = 08 (SHARED)       32000019
         MVC   ISLNDAT+7(1),DCBFIRSH+2  NORM DATA R = FIRSH R           32010019
*********************************************************************** 32020019
*                                                                       32030019
*              SET UP CCH IN NORMAL AND OVERFLOW COUNT FIELDS           32040019
*                                                                       32050019
*********************************************************************** 32060019
INITCNT  EQU   *                                                        32070019
         MVC   ISLNCNT(K3),K0(R6)       CCHH FROM 1ST BUFFER     M1819  32076021
         MVC   ISLOCNT(K3),ISLNCNT      CCH FROM 1ST BUFFER      M0976  32094021
         MVC   ISLDCNT(K3),ISLNCNT      CCH FROM 1ST BUFFER      M0976  32100021
*********************************************************************** 32110019
*                                                                       32120019
*              SET UP COUNT FIELDS IN AREA Y FOR NORMAL AND             32130019
*              OVERFLOW TRACK INDICES.                                  32140019
*                                                                       32150019
*********************************************************************** 32160019
         L     R9,0(R10)                C(R9)=A(AREA Y)                 32170019
         MVC   ISLY+26(10),ISLNDAT      C(Y+26)=NORM DATA               32180019
         MVC   ISLY+44(10),ISLODAT      C(Y+44)=OVERFLOW DATA           32190019
         MVC   ISLY+54(8),ISLDCNT       C(Y+54)=DUMMY COUNT             32200019
*********************************************************************** 32210019
*                                                                       32220019
*              ESTABLISH ADDRESSIBILITY FOR TISA                        32230019
*                                                                       32240019
*********************************************************************** 32250019
*                                                                       32260019
         LR    R6,R7                    C(R6)=A(TISA)                   32270019
*                                                                       32280019
         EJECT                                                          32300019
*********************************************************************** 32310019
*                                                                       32320019
*              DETERMINE PATH FOR FULL TRACK INDEX WRITE                32330019
*                                                                       32340019
*********************************************************************** 32350019
*                                                                       32360019
         CLC   CURRR(1),HIGHR           OVRFLO TI LEFT OVER             32370019
         BNH   ISLFT02                  NO                              32380019
         BAL   R14,OVERFLOW             BR TO OVERFLOW ROUTINE          32390019
ISLFT02  EQU   *                                                        32400019
         TM    FLAGS,CLOSE1             IS CLOSE FORCING INDEX   A44853 32410000
         BO    CLOSE                    YES-GO TO FTIW CLOSE RTN        32420019
         BAL   R14,MOVETI               BR TO MOVE TI ENTRIES           32430019
*                                                                       32440019
*                                                                       32450019
         CLC   DCBLDT+1(1),ISLNDAT+6    LAST PRIME DATA TRACK           32460019
         BE    EOC                      YES-BR TO EOC ROUTINE           32470019
         CLC   CURRR(1),HIGHR           IS TI TRACK FULL                32480019
         BNL   INITTISA                 YES-CONTINUE                    32490019
ISLFT023 EQU   *                                                        32500019
         L     R10,12(R10)              C(R10)=A(CP18)                  32510019
         L     R5,12(R10)               C(R5)=A(CP18 WR CHK SRCH)       32520019
         B     INITCP18                 SET CP18 SRCH TO IOBA+35        32530019
INITTISA EQU   *                                                        32540019
         IC    R4,ISLNCNT+3             HH OF CURRENT TRACK             32550019
         LA    R4,1(R4)                 HH = HH + 1                     32560019
         STC   R4,TSTWK2C               SAVE FOR COMPARE                32570019
LOADR7   EQU   *                                                        32580019
         LA    R7,INIT20                PREPARE FOR BRANCH              32590019
         CLC   CURRR(1),HIGHR           ARE ENTRIES SPLIT               32600019
         BH    RETURN                   YES-WAIT FOR OVERFLOW RTN       32610019
*                                       TO INITIALIZE                   32620019
NEXTTRK  EQU   *                                                        32630019
         LA    R5,TISA+20               C(R5)=A(1ST TI ENTRY)           32640019
         MVC   HIGHR(1),DCBHIRTI        HIGH R FOR FULL TRACK           32650019
         CLC   ISLNIRT+1(1),TSTWK2C     DUMMY ON NEXT TRACK             32660019
         BNE   ISLFT028                 NO - BRANCH                     32670019
         MVC   HIGHR(1),ISLNIRT+2       HIGH R = DUMMY R                32680019
         CLI   DCBHIRSH,X'00'           SHARED TRACK                    32690019
         BNE   SHRTRK                   YES                             32700019
         L     R5,20(R10)               C(R5)=A(CP20A)                  32710019
         L     R5,20(R5)                C(R5)=A(CCW-TRK WITH DUMMY)     32720019
         L     R5,0(R5)                 C(R5)=A(SHR TRK ENTRY-TISA)     32730019
         LA    R5,0(R5)                 CLEAR HIGH ORDER BYTE           32740019
         B     ISLFT028                 BR TO SET NEXTTI & CURR R       32750019
         EJECT                                                          32760019
SHRTRK   EQU   *                                                        32770019
         L     R5,40(R10)               C(R5)=A(CP20B)                  32780019
         L     R5,24(R5)                C(R5)=A(1ST W KD)               32790019
         LA    R5,0(R5)                 CLEAR HIGH ORDER BYTE           32800019
         S     R5,ISL8                  BACK UP TO COUNT                32810019
ISLFT028 EQU   *                                                        32820019
         ST    R5,NEXTTI                SET NEXT TI & CURR R=0          32830019
RETURN   EQU   *                                                        32840019
         BR    R7                       BR TO INIT20 OR ISLFT03         32850019
         EJECT                                                          32860019
*********************************************************************** 32870019
*                                                                       32880019
*              OVERFLOW ROUTINE  -  NORMAL AND OVERFLOW ENTRIES         32890019
*                                   SPLIT ACROSS TRACKS                 32900019
*                                                                       32910019
*********************************************************************** 32920019
OVERFLOW EQU   *                                                        32930019
         BAL   R16,WAIT                 WAIT ROUTINE FOR FTIW           32940019
         L     R4,NEXTTI                C(R4)=A(NEXT TI ENTRY)          32950019
         SH    R4,SIZE                  NEXT TI-LENGTH OF 1 ENTRY       32960019
         IC    R7,3(R4)                 H FROM OCNT                     32970019
         LA    R7,1(R7)                 H = H + 1                       32980019
         STC   R7,3(R4)                 H + 1 TO OCNT                   32990019
         STC   R7,TSTWK2C               SAVE FOR COMPARE                33000019
         MVI   4(R4),X'01'              SET R = 1                       33010019
         MVC   ISLOCNT+3(2),3(R4)       SET HR FOR NEXT TRACK           33020019
         BAL   R7,NEXTTRK               INIT FOR NEXT TRACK             33030019
ISLFT03  EQU   *                                                        33040019
         BAL   R3,ENTRYMOV              OVERFLOW TI ENTRY IS     A45263 33050021
*                                       MOVED                    A45263 33055021
*                                       IN TISA TO THE BEGINNING        33080019
*                                       OF THE NEXT TRACK               33090019
         AH    R5,SIZE                  C(R5)=1ST ENTRY + TI LENGTH     33100019
         ST    R5,NEXTTI                STORE IN NEXT ENTRY ADDR        33110019
         MVI   CURRR,X'01'              SET CURR R=1                    33120019
         NI    FLAGS,X'CF'              TURN EOC & EOT BITS OFF         33130019
         BR    R14                      RETURN TO ISLFT02,              33140019
*                                       DUMMYTI OR INACTIVE             33150019
*                                                                       33160019
*********************************************************************** 33170019
*                                                                       33180019
*              WAIT ROUTINE FOR FULL TRACK INDEX WRITE                  33190019
*                                                                       33200019
*********************************************************************** 33210019
*                                                                       33220019
WAIT     EQU   *                                                        33230019
         LA    R2,ISLIOBA               IOB FOR CP20                    33240019
         BAL   R4,ISLFY99               BR TO WAIT SUBROUTINE           33250019
         TM    DCBEXCD1,X'04'           TEST BIT 5 FOR PREVIOUS         33260019
*                                       UNCORRECTABLE WRITE ERROR       33270019
         BCR   8,R16                    RETURN IF NO ERROR       A38521 33277021
         L     R14,TSTWK1C              RESTORE CLOSE RETURN REG A38521 33284021
         B     ISLFX02                  GO TO SYNAD              A38521 33291021
         EJECT                                                          33300019
*********************************************************************** 33310019
*                                                                       33320019
*              ROUTINE TO MOVE TRACK INDEX ENTRIES TO THE TRACK         33330019
*              INDEX SAVE AREA                                          33340019
*                                                                       33350019
*********************************************************************** 33360019
*                                                                       33370019
MOVETI   EQU   *                                                        33380019
         BAL   R16,WAIT                 WAIT ROUTINE FOR FTIW           33390019
         SR    R3,R3                    CLEAR REGISTER 3                33400019
         IC    R7,CURRR                 C(R3)=CURR R                    33410019
         LA    R7,2(R7)                 C(R3)=CURR R+2                  33420019
         TM    FLAGS,X'10'              EOC FLAG ON                     33430019
         BNO   CHECKEOT                 NO-CHECK FOR EOT BIT ON         33440019
         NI    FLAGS,X'CF'              TURN EOC & EOT FLAGS OFF        33450019
         L     R6,IOBPTRA               C(R6)=C(PTR A)=A(SLOT X) M1819  33450421
         L     R6,0(R6)               C(R6)=C(SLOT X)=A(1ST BUF) M1819  33450821
         MVC   ISLNCNT+K3(K1),K3(R6)    GET CYL FOR 2301         M1819  33451221
         OC    ISLNCNT+K3(K1),DCBHMASK  TURN ON ALL TRK BITS     M0976  33452021
         XC    ISLNCNT+K3(K1),DCBHMASK  SET TRACK TO ZERO        M0976  33454021
         MVC   ISLOCNT+K3(K1),ISLNCNT+K3 MOVE TO OCNT            M0976  33456021
         MVI   ISLNCNT+K4,K1            SET R TO 1               A38521 33460021
         MVI   ISLOCNT+K4,K2            SET R TO 2               A38521 33470021
         L     R6,ISLVPTRA              C(R6) = A(TISA)          M1819  33472021
         B     MOVENORM                 MOVE NORMAL TI ENTRY            33480019
CHECKEOT EQU   *                                                        33490019
         TM    FLAGS,X'20'              EOT FLAG ON                     33500019
         BNO   COUNT                    NO                              33510019
         NI    FLAGS,X'DF'              TURN EOT BIT OFF                33520019
         IC    R4,ISLNCNT+3             C(R4)=LOW ORDER H        M1819  33530021
         LA    R4,1(R4)                 C(R4)=H+1                       33540019
         STC   R4,ISLNCNT+3             SET H = H+1                     33550019
         STC   R4,ISLOCNT+3             H+1 FOR OCNT                    33560019
         MVI   ISLNCNT+4,X'01'          SET R = 1                       33570019
         MVI   ISLOCNT+4,X'02'          SET R = 2                       33580019
         B     MOVENORM                 MOVE NORMAL TI ENTRY            33590019
*********************************************************************** 33600019
*                                                                       33610019
*              BUMP NORMAL AND OVERFLOW COUNT FIELDS                    33620019
*                                                                       33630019
*********************************************************************** 33640019
COUNT    EQU   *                                                        33650019
         IC    R3,ISLOCNT+4             C(R3)=R FROM OCNT               33660019
         LA    R3,1(R3)                 C(R3)=R+1                       33670019
         STC   R3,ISLNCNT+4             C(NCNT)=R+1                     33680019
         LA    R3,1(R3)                 C(R3)=R+2                       33690019
         STC   R3,ISLOCNT+4             C(OCNT)=R+2                     33700019
         MVC   ISLNCNT+2(2),ISLOCNT+2   C(NCNT)=CCHHR, HH FROM OCNT     33710019
         MVC   ISLY+18(8),ISLNCNT       C(Y+18)=NORM COUNT              33740019
         MVC   ISLY+36(8),ISLOCNT       C(Y+36)=OVRFLOW COUNT           33750019
         EJECT                                                          33760019
*********************************************************************** 33770019
*                                                                       33780019
*              MOVE TRACK INDEX ENTRIES TO THE TRACK INDEX SAVE AREA    33790019
*                                                                       33800019
*                                                                       33810019
*                                                                       33820019
*              NORMAL TI                                                33830019
*                                                                       33840019
*********************************************************************** 33850019
MOVENORM EQU   *                                                        33860019
         L     R5,NEXTTI                C(R5)=A(NEXT NORM TI)           33870019
         MVC   0(8,R5),ISLNCNT          MOVE NCNT TO TISA COUNT         33880019
         L     R4,ISLKEYAD              C(R4)=A(KEY)                    33890019
         IC    R3,DCBKEYLE              C(R3)=KEY LENGTH                33900019
         BAL   R16,MOVENTRY             MOVE NORMAL ENTRY TO TISA       33910019
         MVC   0(10,R5),ISLNDAT         MOVE DATA TO TISA               33920019
*********************************************************************** 33930019
*                                                                       33940019
*              OVERFLOW TRACK INDEX ENTRY                               33950019
*                                                                       33960019
*********************************************************************** 33970019
         LA    R5,10(R5)                C(R5)=A(OCNT IN TISA)           33980019
         MVC   0(8,R5),ISLOCNT          MOVE OCNT TO TISA               33990019
         LA    R16,MOVEODAT             PREPARE FOR BR R16              34000019
MOVENTRY EQU   *                                                        34010019
         LA    R5,8(R5)                 C(R5)=A(KEY IN TISA)            34020019
         BCTR  R3,0                     C(R3)=KEYLEN-1,FOR EXECUTE      34030019
         EX    R3,MOVE                  MOVE KEY TO TISA                34040019
         LA    R3,1(R3)                 C(R3)=KEYLENGTH                 34050019
         AR    R5,R3                    C(R5)=A(DATA IN TISA)           34060019
         BR    R16                      BR TO MOVEODAT OR N TI MOVE     34070019
MOVEODAT EQU   *                                                        34080019
         MVC   0(10,R5),ISLODAT         MOVE DATA TO TISA               34090019
         L     R3,NEXTTI                C(R3)=A(NEXT TI ENTRY)          34100019
         AH    R3,SIZE                  C(R3)=NEXT + TI LENGTH          34110019
         AH    R3,SIZE                  C(R3)=NEXT + TI LENGTH          34120019
         ST    R3,NEXTTI                A(NXT TI)= NEXT + 2(TI LN)      34130019
         STC   R7,CURRR                 SET CURR R=R+2                  34140019
         BR    R14                      RETURN                          34150019
         EJECT                                                          34170019
*********************************************************************** 34180019
*                                                                       34190019
*        END OF CYLINDER ROUTINE                                        34200019
*                                                                       34210019
*********************************************************************** 34220019
EOC      EQU   *                                                        34230019
         CLC   CURRR(1),HIGHR           OVRFLO TI LEFT OVER             34240019
         BL    DUMMYTI                  NO-BR TO MOVE DUMMY TI          34250019
         BE    WRITETRK                 WRITE FULL TRACK                34270019
         OI    FLAGS,X'08'              EXEC CP20 ONLY           M4881  34275019
         LA    R14,OVFLOW               C(R14)=A(OVFLOW)                34280019
         B     INIT20                   BR FOR CP20 INIT                34290019
WRITETRK EQU   *                                                        34300019
         OI    FLAGS,X'08'              EXEC CP20 ONLY           M4881  34305019
         BAL   R14,INITTISA             INIT TISA FOR NEXT TRACK,       34310019
*                                       THEN WRITE DUMMY ENTRY ONLY     34320019
BUMPCNT  EQU   *                                                        34330019
         IC    R4,ISLOCNT+3             H FROM OCNT                     34340019
         LA    R4,1(R4)                 H=H+1                           34350019
         STC   R4,ISLOCNT+3             SET H FOR NEXT TRACK            34360019
         B     DUMMYTI                  BR TO MOVE DUMMY TO TISA        34370019
*                                                                       34380019
OVFLOW   EQU   *                                                        34390019
         BAL   R14,OVERFLOW             BR TO OVERFLOW ROUTINE          34400019
DUMMYTI  EQU   *                                                        34410019
         L     R5,NEXTTI                C(R5)=A(NEXT ENTRY)             34420019
         LA    R4,ISLY+54               C(R4)=A(DCNT IN AREA Y)         34460019
         MVC   ISLY+57(2),ISLNIRT+1     HR OF DUMMY COUNT               34470019
         BAL   R3,ENTRYMOV              MOVE DUMMY TI TO TISA    A45263 34480021
         MVI   TSTWK2C,X'00'            SET HH=0 FOR COMPARE            34490019
         B     LOADR7                   INIT TISA BEFORE EXCP20         34500019
         EJECT                                                          34510019
*********************************************************************** 34520019
*                                                                       34530019
*              EXECUTE CP20 WITHOUT CP18                                34540019
*                                                                       34550019
*********************************************************************** 34560019
EXCP20   EQU   *                                                        34570019
         L     R7,44(R10)               C(R7)=A(CP20C)                  34580019
         L     R7,12(R7)                C(R7)=A(CP18 TIC)               34590019
         SH    R7,ISL12                 C(R7)=A(FLAGS OF LAST R  A46109 34596021
*                                       CKD)                     A46109 34602021
         NI    0(R7),X'BF'              TURN OFF COMMAND CHAIN BIT      34610019
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 34620019
         LR    R3,R0                    SAVE R0                         34630019
         LR    R4,R1                    SAVE R1                         34640019
         LR    R5,R14                   SAVE R14                        34650019
*                                                                       34660019
*              SET FLAGS BIT 0 = 1, CP IS NOT AVAILABLE                 34670019
*                                                                       34680019
         OI    IOBFLAGS,X'80'           TURN ON FLAGS BIT 0             34690019
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM 20      34700019
         LR    R0,R3                    RESTORE R0                      34710019
         LR    R1,R4                    RESTORE R1                      34720019
         LR    R14,R5                   RESTORE R14                     34730019
         BAL   R16,WAIT                 WAIT ROUTINE FOR FTIW           34740019
         NI    FLAGS,X'F7'              TURN CP20 BIT OFF               34750019
         OI    0(R7),X'40'              TURN COMND CHAIN BIT ON         34760019
         BR    R14                      RETURN TO OFLOW, OVFLOW,        34770019
*                                       BUMPCNT OR IGG0202I             34780019
         EJECT                                                          34790019
*********************************************************************** 34800019
*                                                                       34810019
*              CLOSE ROUTINE                                            34820019
*                                                                       34830019
*********************************************************************** 34840019
CLOSE    EQU   *                                                        34850019
         TM    FLAGS,CLOSE2             IS CLOSE FORCING INDEX   S20201 34860020
         BO    SKPMOVE                  YES - NO NEW ENTRIES     S20201 34870020
         BAL   R14,MOVETI               BR TO MOVE TI ENTRIES           34900019
SKPMOVE  EQU   *                                                        34910019
         LA    R7,INIT20                RETURN FROM NEXTTRK RTN  A44853 34912000
         OI    FLAGS,CP20BIT            INDICATE EXCP CP20 ONLY  A44853 34914000
         CLC   CURRR(1),HIGHR           OVERFLOW LEFT OVER              34920019
         BE    NEXTTRK                  FULL TRACK OF TRK INDEX  A44853 34930000
         BH    CP20FLG                  YES - CONTINUE                  34940019
         BAL   R16,WAIT                 WAIT ROUTINE FOR FTIW           34950019
         B     INACTIVE                 CONTINUE                        34960019
CP20FLG  EQU   *                                                        34970019
         OI    FLAGS,X'08'              TURN BIT ON TO EXCP20 ONLY      34980019
         BAL   R14,INIT20               BR TO EXCP20 ONLY               34990019
OFLOW    EQU   *                                                        35000019
         BAL   R14,OVERFLOW             BR-TI LEFT OVER                 35010019
INACTIVE EQU   *                                                        35030019
INACT    EQU   *                                                        35140019
         OI    FLAGS,X'08'              TURN BIT ON TO EXCP20 ONLY      35150019
INACT2   EQU   *                                                        35160019
         L     R5,NEXTTI                C(R5)=A(NEXT ENTRY)             35170019
         LA    R4,ISLY+54               C(R4)=A(INACTIVE ENTRY)         35180019
         LA    R7,ISLY+70               C(R7)=F BYTE IN DUM DATA        35190019
         SR    R3,R3                    CLEAR REGISTER 3                35200019
         IC    R3,DCBKEYLE              C(R3)=KEY LENGTH                35210019
         AR    R7,R3                    C(R7)=AREA Y+70+KL              35220019
         MVI   0(R7),X'30'              SET F BYTE FOR INACTIVE         35230019
         MVC   ISLY+54(7),ISLOCNT       MOVE OCNT TO DCNT IN AREA Y     35240019
         SR    R13,R13                  CLEAR REGISTER 13               35250019
         IC    R13,CURRR                C(R13)=CURRENT R                35260019
         LA    R13,1(R13)               C(R13)=R+1                      35270019
         STC   R13,ISLY+58              SET DCNT = CURR R+1             35280019
         CLC   ISLY+57(2),ISLNIRT+1     READY FOR DUMMY ENTRY           35310019
         BE    MOVEDUMY                 YES - MOVE DUMMY ENTRY          35320019
MOVEINAC EQU   *                                                        35330019
         BAL   R3,ENTRYMOV              MOVE INACTIVE TI TO TISA A45263 35340021
         AH    R5,SIZE                  C(R5)=A(NEXT ENTRY+TI LEN)      35350019
         LA    R13,1(R13)               C(R13)=R+1 FOR INACTIVE CNT     35360019
         STC   R13,ISLY+58              SET R=R+1                       35370019
         CLC   ISLY+58(1),HIGHR         END OF TRK INDEX YET            35380019
         BL    MOVEINAC                 NO-MOVE ANOTHER INACTIVE TI     35390019
         CLC   ISLY+57(2),ISLNIRT+1     DUMMY ON THIS TRACK             35400019
         BNE   MOVELAST                 NO - BR TO MOVE LAST ENTRY      35410019
MOVEDUMY EQU   *                                                        35420019
         MVI   0(R7),X'20'              SET F BYTE IN DDATA-DUMMY       35430019
MOVELAST EQU   *                                                        35440019
         BAL   R3,ENTRYMOV              MOVE DUMMY TI TO TISA    A45263 35450021
         TM    DCBST,X'02'              LAST BLOCK FULL                 35460019
         BO    LOAD14                   YES - STATUS BITS OK            35470019
         NI    DCBST,X'FE'              NO-TURN END OF TRK BIT OFF      35480019
LOAD14   EQU   *                                                        35490019
         L     R14,TSTWK1C              RESTORE R14 FOR CLOSE           35500019
*                                                                       35510019
         EJECT                                                          35520019
*********************************************************************** 35530019
*                                                                       35540019
*              EXCP 20 ROUTINE                                          35550019
*                                                                       35560019
*********************************************************************** 35570019
*                                                                       35580019
*                                                                       35590019
*                                                                       35600019
*********************************************************************** 35610019
*                                                                       35620019
*              THE MBBCCHHR FOR THE PRIME DATA TRACK IS AT THE          35630019
*              BEGINNING OF THE TRACK INDEX SAVE AREA (TISA)            35640019
*                                                                       35650019
*              THE MBBCCHHR FOR THE TRACK INDEX TRACK IS IN IOBA        35660019
*                                                                       35670019
*********************************************************************** 35680019
INIT20   EQU   *                                                        35690019
         BAL   R16,WAIT                 WAIT ROUTINE FOR FTIW           35700019
         MVC   IOBDADAD+3(4),ISLOCNT    MOVE CCHH TO IOB SEEK           35710019
         MVI   IOBDADAD+7,X'00'         SET R = 0 FOR SEARCH            35720019
*                                                                       35730019
         OI    FLAGS,X'20'              TURN EOT BIT ON                 35740019
*********************************************************************** 35750019
*                                                                       35760019
*              RESUME LOAD WITH FULL TRACK INDEX WRITE                  35770019
*                                                                       35780019
*********************************************************************** 35790019
         TM    FLAGS,X'80'              RESUME LOAD                     35800019
         BNO   CHKEOC                   NO - CONTINUE                   35810019
         NI    FLAGS,X'7F'              TURN RESUME LOAD BIT OFF        35820019
         MVC   IOBDADAD+7(1),TSTWK3C    SET R FOR SEARCH                35830019
         MVC   IOBCPSAD+1(3),TSTWK3C+1  SET RL CP SAD                   35840019
         CLC   ISLOCNT+3(1),ISLNIRT+1   END OF CYLINDER                 35850019
         BNE   CHECKBIT                 NO - CONTINUE                   35860019
         OI    FLAGS,X'10'              TURN EOC BIT ON                 35870019
         B     CHECKBIT                 BR TO EXCP                      35880019
CHKEOC   EQU   *                                                        35890019
         L     R3,44(R10)               C(R3)=A(CP20C)                  35900019
         CLC   ISLOCNT+3(1),ISLNIRT+1   AT END OF CYLINDER              35910019
         BNE   FULL20A                  NO-INIT 20A WHEN FULL           35920019
         OI    FLAGS,X'10'              TURN EOC BIT ON                 35930019
         CLI   DCBHIRSH,X'00'           IS THERE SHARED TRACK           35940019
         BNE   INIT20B                  YES                             35950019
         EJECT                                                          35960019
*********************************************************************** 35970019
*                                                                       35980019
*              INITIALIZE CP20A FOR END OF CYLINDER                     35990019
*                                                                       36000019
*********************************************************************** 36010019
         BAL   R7,INITTIC               BR TO INITIALIZE TIC            36020019
         L     R3,20(R10)               C(R3)=A(CP20A)                  36030019
         BAL   R7,INITTIC               BR TO INITIALIZE TIC            36040019
         L     R5,0(R5)                 C(R5)=A(1ST ENTRY IN TISA)      36050019
         B     INITSRCH                 BR TO SET CP20C SRCH            36060019
*                                                                       36070019
INITTICX EQU   *                        SET TO START            SA54556 36072002
         LA    R5,K24(R3)               FIRST WRITE             SA54556 36074002
         B     INITTIC2                 CONTINUE                SA54556 36076002
INITTIC  EQU   *                                                        36080019
         L     R5,20(R3)                A(1ST CCW TO BE EXECUTED)       36090019
INITTIC2 EQU   *                                                        36100019
         ST    R5,16(R3)                RESTORE TIC TO 1ST R CCW        36110019
         MVI   16(R3),X'08'             RESTORE TIC COMMAND CODE        36120019
         BR    R7                       RETURN                          36130019
*********************************************************************** 36140019
*                                                                       36150019
*              INITIALIZE CP20A WHEN NOT END OF CYLINDER                36160019
*                                                                       36170019
*********************************************************************** 36180019
FULL20A  EQU   *                                                        36190019
         BAL   R7,INITTICX              BR TO INITIALIZE TIC    SA54556 36210002
         L     R3,20(R10)               C(R3)=A(CP20A)                  36220019
         BAL   R7,INITTICX              BR TO INITIALIZE TIC    SA54556 36230002
         LA    R5,TISA+20               A(1ST CNT IN TISA) FOR SRCH     36250019
INITSRCH EQU   *                                                        36260019
         L     R4,44(R10)               C(R4)=A(CP20C)                  36270019
         ST    R5,0(R4)                 MOVE TO 1ST CP20C SRCH          36280019
         MVI   0(R4),X'31'              RESTORE COMMAND CODE            36290019
         B     CPSAD                    BR TO SET CP START ADDR SA54556 36300002
INIT20B  EQU   *                                                        36310019
         MVI   IOBDADAD+7,X'01'         SET R=1 FOR SEARCH              36320019
         L     R4,40(R10)               C(R4)=A(CP20B)                  36330019
         MVC   1(3,R3),1(R4)            SRCH ADDR FROM 20B TO 20C       36340019
         BAL   R7,INITTIC               BR TO INITIALIZE TIC            36350019
         L     R3,40(R10)               C(R3)=A(CP20B)                  36360019
         BAL   R7,INITTICX              RESET                   SA54556 36364002
CPSAD    EQU   *                                                        36370019
         IC    R4,IOBCPSAD              SAVE SIOCC                      36380019
         ST    R3,IOBCPSAD              C(CPSAD)=CP20 START ADDR        36390019
         STC   R4,IOBCPSAD              RESTORE SIOCC                   36400019
CHECKBIT EQU   *                                                        36410019
         TM    FLAGS,X'08'              IS EXCP20 ONLY BIT ON           36420019
         BO    EXCP20                   BR TO EXCP20 W/O CP18           36430019
EXCP1820 EQU   *                                                        36440019
         B     ISLFY21                  BR TO EXCP 18 & 20              36450019
         SPACE 3                                                        36460002
ENTRYMOV EQU   *                        *                        A45263 36660021
*                                                                       36860021
*   SUBROUTINE TO MOVE A TISA ENTRY.                                    37060021
*        LINKAGE                        BAL   R3,ENTRYMOV               37260021
*        R4 - AREA TO MOVE FROM                                         37460021
*        R5 - AREA TO MOVE TO                                           37660021
*                                                                       37860021
         DROP  R12                      R12 USED AS WORK REG     A45263 38060021
         IC    R12,DCBKEYLE             ENTRY LENGTH = KEYLE +   A45263 38260021
*                                       18                       A45263 38460021
         MVC   0(FIRST17,R5),0(R4)      MOVE FIRST 17 BYTES      A45263 38660021
         EX    R12,MVENTRY1             MOVE LAST KEYLEN +1      A45263 38860021
         L     R12,DCBWKPT1             RESTORE WORK AREA BASE   A45263 39060021
         BR    R3                       RETURN                   A45263 39260021
*                                                                       39460021
MVENTRY1 MVC   FIRST17(0,R5),FIRST17(R4) DUMMY MOVE              A45263 39660021
FIRST17  EQU   17                       TISA LENGTH - (KEYLEN+1) A45263 39860021
         SPACE 2                                                        40860002
*                                                                       40880019
*              CONSTANTS                                                40900019
*                                                                       40920019
ISL8     DC    F'0008'                                                  40940019
CONSF8   DC    F'248'                                             13334 40990019
ISLZEROF DC    F'0'                                                     41080002
ISLONEF  DC    F'0001'                                                  41180019
* THE FOLLWOING 6 BYTES MUST BE CONTIGUOUS                              41190021
SCHCOM   DC    X'31000000'                                        13334 41210019
ISLRFP   EQU   SCHCOM+3                                                 41220019
*                                       002907                    8M800 41230019
ISLFP    DC    X'2907'                  FP OF ISLRFP              8M800 41235019
ISL4     DC    H'04'                                             A46109 41236021
ISL12    DC    H'12'                                             A46109 41237021
ISLTWOF  DC    H'02'                                             A46109 41238021
*                                                                       41240019
* FX CONSTANTS                                                          41260019
*                                                                       41280019
ISLFX02A CLC   0(1,R4),0(R5)            KEY COMP TO BE EXECUTED (L)     41300019
MOVE     EQU   *                                                 A46109 41310021
ISLFX06A MVC   0(1,R5),0(R4)            MOVE KEY TO BE EXECUTED (L)     41320019
ISLFX08A CLC   0(1,R5),0(R4)            KEY COMP TO BE EXECUTED (M)     41340019
ISLFX21A MVC   0(1,R4),0(R5)            MOVE RCD TO BE EXECUTED (M)     41360019
*                                                                       41380019
*                                                                       41430002
PATCH    DC    XL((*-IGG019I2)/20)'00'  ZEROED PATCH AREA        Y02072 41440002
*                                                                       41450002
         END                                                            41460019
