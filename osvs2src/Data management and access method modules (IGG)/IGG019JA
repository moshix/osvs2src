 TITLE 'IGG019JA -- DYNAMIC BUFFERING MODULE, SIO APPENDAGE'            00100002
         IEZBITS                                                        00200001
IGG019JA CSECT                                                          00300001
*MODULE NAME = IGG019JA                                               * 00310002
*                                                                     * 00320002
*DESCRIPTIVE NAME = DYN BUF MODULE & SIO APPENDAGE,                   * 00330037
*                   VIRTUAL ADDRESS SPACE                             * 00340037
*                                                                     * 00342002
*COPYRIGHT = NONE                                                     * 00344002
*                                                                     * 00346002
*CHANGE ACTIVITY                                                      * 00348002
*              VS1-1 CHANGES/DELETIONS                                  00348802
*              VS2-1 CHANGES/DELETIONS                                  00349202
*              VS1-2 CHANGES/DELETIONS                                  00349602
*              VS2-2 CHANGES/DELETIONS                                  00349702
*006000,029000,032000,051000-055000,062000-159000,170000-213000,292000, 00349802
*321000,334000-343000,361000,557000,579000,582000-599000,619000,621000, 00349902
*625000,629000,631000,661000-663000,668000-738000,752000-753000,        00366602
*765000-768000,770000-787000,793000,810000,868000-870000,882000-892000, 00376602
*902000-904000,925000-932000,936000-969000                       Y02072 00378602
*              VS2-4 CHANGES/DELETIONS                                  00379037
*A2871000-288040,370020-377040,414020-415120,575040-575092,    @ZA08000 00379437
*A924020-924120,897740-898020                                  @ZA08000 00379837
*D2885000-298500,378000-394000,467000-537000,665000-897700     @ZA08000 00380237
*D377024,A024500,374152,C374228,374244                         @ZA24815 00380437
*                                                                       00380602
*STATUS CHANGE LEVEL - RELEASE VS2-2 LEVEL 0                            00382602
*                                                                       00383002
*********************************************************************** 00383302
         USING *,RAPDBASE                                               00400001
SIOEP    B     SIORTNE            START I/O APPENDAGE E.P.              00500001
         ORG   IGG019JA+8                                               00700001
FRBUFEP  B     FBUFRTNE           FREE DYNAMIC BUFFER SVC E.P.          00800001
*                                                                       00810002
*                                                                       00820002
*********************************************************************** 00830002
*  THE FOLLOWING TWO ENTRY POINTS ARE USED FOR PROCESSING OF THE      * 00840002
*  FREEDBUF ESTAE ROUTINE, IGCT005G.  THE FIRST ENTRY POINT (+12) IS  * 00842002
*  USED WHEN, IN THE ESTAE CLEANUP ROUTINE, IT IS DETERMINED THAT THE * 00844002
*  AUDIT TRAIL BIT INDICATING THAT THE NEXT IOB HAD BEEN TAKEN FROM   * 00846002
*  THE IOB QUEUE BUT THE CHANNEL PGM HAD NOT BEEN INITIALIZED YET     * 00848002
*  (WKAIOBQ BIT IS ON). IN THIS CASE ENTRY IS MADE TO INITIALIZE      * 00848402
*  THE CHANNEL PROGRAM AND ISSUE THE EXCP FOR THIS REQUEST.           * 00848802
*         THE SECOND ENTRY POINT (+16) IS USED WHEN THE NEXT IOB HAS  * 00849202
*  BEEN REMOVED FROM THE QUEUE, ITS CHANNEL PGM INITIALIZED, BUT THE  * 00849602
*  ABEND OCCURRED BEFORE THE EXCP WAS ISSUED (WKABUFAS BIT ON).IN THIS* 00849702
*  CASE ENTRY IS MADE TO ISSUE THE EXCP FOR THIS REQUEST.             * 00849802
*          INPUT FOR BOTH ENTRIES IS THE SAME:                        * 00849902
*                   REGISTER 2 = NEXT IOB ADDRESS                     * 00866602
*                   REGISTER 3 = BEGINNING ADDRESS OF THIS MODULE     * 00876602
*                   REGISTER 4 = DCB ADDRESS                          * 00878602
*                   REGISTER 5 = SVRB ADDRESS                         * 00880602
*                   REGISTER 6 = BUFFER ADDRESS                       * 00881002
*                   REGISTER 8 = TCB ADDRESS                          * 00882602
*                   REGISTER 15= BEGINNING ADDRESS OF THIS MODULE     * 00883002
*                   WKAREG14 IN SVRB WORKAREA IN INITIALIZED TO       * 00883102
*                                RETURN ADDRESS IN ESTAE              * 00883202
*  A THIRD ENTRY INTO THIS MODULE IS TAKEN BY ESTAE, IGCT005G, IF NO  * 00888802
*  AUDIT TRAIL BITS ARE SET AT ALL.  IN THIS CASE ENTRY IS THE SAME   * 00890802
*  AS FOR FREEDBUF (+8).  INPUT IS LIKEWISE THE SAME.                 * 00892802
*********************************************************************** 00893202
ESTENT1  B     ESTENTA                  INIT CH PGM, ISSUE EXCP  Y02072 00893602
*                                                                       00894002
ESTENT2  B     ESTENTB                  ISSUE EXCP               Y02072 00894102
*********************************************************************** 00894202
*                                                                     * 00894302
*********************************************************************** 00894402
*                  REGISTER EQUATES                                     00900001
*********************************************************************** 00950002
R0       EQU   0        INPUT REGISTER 0    SVC                         01000001
RWORK0   EQU   0        WORK REGISTER                                   01100001
R1       EQU   1        INPUT REGISTER 1                                01200001
RWORK1   EQU   1        WORK REGISTER                                   01300001
RLINK    EQU   1        INTERNAL LINKAGE REGISTER                Y02072 01350002
RRQE     EQU   1        ADDR OF RQE PASSED BY IOS                Y02072 01360002
RIOB     EQU   2        ADDRESS OF IOB                                  01400001
RWORK2   EQU   2        WORK REGISTER                          @ZA08000 01402037
RBASE3   EQU   3        BASE REGISTER       SVC                         01600001
RWORK3   EQU   3        WORK REG                               @ZA08000 01602037
RDCB     EQU   4        ADDRESS OF DCB                                  01700001
RWORK4   EQU   4        WORK REGISTER                                   01800001
RSVRB    EQU   5        ADDRESS OF SVRB ON ENTRY FROM FREEDBUF   Y02072 01950002
RBUFFR   EQU   6        BUFFER ADDRESS                                  02000001
RWORK6   EQU   6        WORK REGISTER                                   02100001
RSWA     EQU   6        PTR TO SEMENT WORK AREA (ASSGNBUF)     @ZA08000 02102037
RDECB    EQU   7        DECB ADDRESS                                    02200001
RWORK7   EQU   7        WORK REGISTER                                   02300001
RCCW     EQU   7        PTR TO CCW TO MODIFY (ASSGNBUF)        @ZA08000 02302037
RTCB     EQU   8        ADDRESS OF TCB IN FREE BUF RTN           Y02072 02350002
RNEWLST  EQU   8        ADDR OF NEW UNSCHEDULED LIST                    02400001
RRQES    EQU   8        REGISTER TO SAVE RQE POINTER           @ZA24815 02450037
RWORK9   EQU   9        WORK REGISTER                                   02500001
RWORK10  EQU   10       WORK REGISTER                                   02800001
RWORK11  EQU   11       WORK REGISTER                                   03000001
RWORK12  EQU   12       WORK REGISTER                                   03100001
RSAVE    EQU   13       IOS REGISTER SAVEAREA ADDR               Y02072 03300002
RWORK13  EQU   13       WORK REGISTER (RECOUP RTN)               Y02072 03350037
RRETURN  EQU   14       RETURN ADDRESS                                  03400001
RRETCODE EQU   15       RETURN CODE REGISTER                            03500001
RAPDBASE EQU   15       BASE REGISTER FOR APPENDAGE ROUTINES            03600001
RWORK15  EQU   15       WORK REGISTER                                   03700001
R15      EQU   15       SAVE/RESTORE REG                         Y02072 03750002
         SPACE 5                                                        03800001
SETSECT  EQU   X'23'         CCW OP-CODE                                03900001
KEYDATOP EQU   X'0E'         CCW OP-CODE  READ KEY & DATE               04000001
RDDATAOP EQU   X'06'         CCW OP-CODE  READ DATA                     04100001
NOP      EQU   X'03'         CCW OP-CODE                                04200001
SILI     EQU   BIT2          CCW FLAGS    SUPPRESS INCORRECT            04300001
*                                         LENGTH INDICATION             04400001
*                                                                       04500001
IC       EQU   B'0001'       MASK FOR ICM, INSERTS 1 BYTE INTO          04600001
*                            LOW ORDER BYTE OF REGISTER                 04700001
ADDR     EQU   B'0111'       MASK FOR ICM/STCM, INSERTS OR              04800001
*                            STORES A 24-BIT ADDRESS TO OR FROM         04900001
*                            THE LOW-ORDER 3 BYTES OF A REGISTER.       05000001
         EJECT                                                          06100001
SIORTNE  EQU   *                                                        21400001
*                                                                     * 21500001
* FUNCTION:                                                           * 21600001
*    THE START-I/O APPENDAGE ATTEMPTS TO ASSIGN A BUFFER TO A         * 21700001
*    READ REQUEST IF THE REQUEST SPECIFIES DYNAMIC BUFFERING AND      * 21800001
*    NO BUFFER WAS ASSIGNED BEFORE EXCP.  IF A BUFFER IS              * 21900001
*    AVAILABLE FOR ASSIGNMENT, IT IS REMOVED FROM THE BUFFER          * 22000001
*    POOL AND THE BUFFER CHAIN IS UPDATED.  THE BUFFER ADDRESS        * 22100001
*    IS PLACED IN THE REQUEST'S DECB AND IN THE READ CCWS OF THE      * 22200001
*    REQUEST'S CHANNEL PROGRAM.  THE ROUTINE THEN RETURNS TO IOS      * 22300001
*    TO INITIATE THE I/O.                                             * 22400001
*    IF NO BUFFER IS AVAILABLE THE REQUEST IS PLACED ON A QUEUE       * 22500001
*    OF REQUESTS WAITING FOR BUFFERS.  THE ROUTINE TAKES THE IOS      * 22600001
*    RETURN WHICH INDICATES THAT THE I/O REQUEST SHOULD NOT BE        * 22700001
*    INITIATED.                                                       * 22800001
*    IF NO BUFFER IS AVAILABLE AND THE ADDRESS OF THE IOB FOR         * 22900001
*    THIS REQUEST CANNOT BE PLACED ON THE CURRENT UNSCHEDULED LIST,   * 23000037
*    THE EXTEND-LIST FUNCTION GETS STORAGE FOR AN UNSCHEDULED LIST      23102037
*    WHICH IS TWICE AS LARGE AS THE PREVIOUS LIST.  IT INITIALIZES    * 23106037
*    THE NEW LIST (AND MOVES ALL ENTRIES FROM THE OLD LIST TO         * 23108037
*    THE NEW LIST) AND PLACES ITS ADDRESS IN DCBDYNB.                 * 23110037
*                                                                     * 23600001
* ENTRY POINT:                                                        * 23700001
*         SIOEP -- ENTERED ASYNCHRONOUSLY FROM IOS AT START-I/O       * 23800001
*         TIME.  THE ADDRESS OF IGG019JA IS PLACED IN THE             * 23900001
*         APPENDAGE VECTOR TABLE (AVT) DURING OPEN PROCESSING.        * 24000001
*         CALLING SEQUENCE -- L     15,4(AVTPTR)                      * 24100001
*                             BALR  14,15                             * 24200001
*                                                                     * 24300001
* INPUT                                                               * 24400001
*    **** REGISTER CONTENTS ****                                      * 24500001
*    REGISTER  1 -- REQUEST QUEUE ELEMENT (RQE) ADDRESS               * 24550002
*    REGISTER  2 -- INPUT/OUTPUT BLOCK (IOB) ADDRESS                  * 24600001
*    REGISTER  3 -- DATA EXTENT BLOCK (DEB) ADDRESS                   * 24700001
*    REGISTER  4 -- DATA CONTROL BLOCK (DCB) ADDRESS                  * 24800001
*    REGISTER  7 -- UNIT CONTROL BLOCK (UCB) ADDRESS                  * 24900001
*    REGISTER 13 -- IOS SAVEAREA ADDRESS                        Y02072* 24950002
*    REGISTER 14 -- RETURN ADDRESS                                    * 25000001
*    REGISTER 15 -- ADDRESS OF IGG019JA                               * 25100001
*                                                                     * 25200001
* OUTPUT                                                              * 25300001
*    **** REGISTER CONTENTS ****                                      * 25400001
*    ALL REGISTER CONTENTS ARE RESTORED BEFORE RETURN TO IOS.         * 25500002
*                                                                     * 26000001
*    **** DATA AREAS SET BY THIS ROUTINE ****                         * 26100001
*    USLBFRQB           UPDATED IF REQUEST IS PLACED ON QUEUE         * 26600001
*                       TO WAIT FOR BUFFER                            * 26700001
*    USLBFRQT           UPDATED IF THIS REQUEST IS THE ONLY ONE ON    * 26800001
*                       THE QUEUE WAITING FOR A BUFFER                * 26900001
*    BCBBFAVL           UPDATED IF A BUFFER IS ASSIGNED               * 27000001
*    DECAREA            DATA ADDR IN THE ASSIGNED BUFFER              * 27100001
*    DECKYADR           KEY ADDR IN THE ASSIGNED BUFFER FOR A READ    * 27200001
*                       BY BLOCK ID, & KEY ADDR SPECIFIED 'S'.        * 27300001
*    CCW3 ADDR          KEY ADDR,FOR NON-RPS CHANNEL PROGRAMS WHEN    * 27800001
*                       KEY IS IN DYNAMIC BUFFER (SEE DECKYADR).      * 27900001
*    CCW4 ADDR          KEY ADDR FOR RPS CHANNEL PROGRAMS, AS ABOVE   * 28000001
*    NEXT-TO-LAST CCW ADDR -- DATA ADDR FOR TRACK-OVERFLOW PROGRAMS   * 28100001
*    LAST CCW ADDR      DATA ADDR FOR NON-TRACK-OVERFLOW PROGRAMS     * 28200001
*                                                                     * 28300001
* EXITS                                                               * 28400001
*         0(R14)        RETURN TO IOS & START I/O                     * 28500001
*         4(R14)        RETURN TO IOS & DISREGARD I/O REQUEST         * 28600001
*                                                                     * 28700001
* ATTRIBUTES -- REENTRANT,PRIVILEGED,KEY=0,ENABLED,WITH THE LOCAL     * 28702037
*    LOCK HELD. MODESET IS ISSUED TO DO ALL PROCESSING IN USER KEY.   * 28704037
*                                                                     * 28706037
         EJECT                                                          28708037
**********************************************************************  28710037
*** DETERMINE IF A BRANCH ENTRY TO SMF IS REQUIRED BECAUSE EXCP HAS     28712037
*** BEEN ISSUED FROM THE ASI ROUTINE IN IGG019KA OR IGC0005C(RELEX)     28714037
*** OR THE ABNORMAL END APPENDAGE HAS RETURNED TO IOS TO RETRY          28715037
*** THE IO REQUEST                                                      28716037
***   INPUT-  REGISTER ONE CONTAINS NUMBER OF EXCP COUNTS.              28717037
***   OUTPUT- SMF EXCP COUNT INCREMENTED BY VALUE IN REG ONE.           28718037
*** SMF BRANCH ENTRY INTERFACE                                          28719037
*** REGISTER  0 - TCB PTR                                               28720037
*** REGISTER  1 - SMF EXCP COUNT                                        28721037
*** REGISTER  3 - DEB PTR                                               28722037
*** REGISTER  7 - UCB PTR                                               28723037
*** REGISTER 10 - WORK REG                                              28724037
*** REGISTER 11 - WORK REG                                              28725037
*** REGISTER 12 - WORK REG                                              28726037
*** REGISTER 13 - WORK REG                                              28727037
*** REGISTER 14 - RETURN ADDR                                           28728037
*** REGISTER 15 - SMF BASE                                              28740037
**********************************************************************  28742037
         STM   R0,R15,0(RSAVE)          SV REGS IN IOS SV AREA @ZA08000 28744037
         LR    RWORK2,RSAVE             SAVE AREA PTR          @ZA08000 28746037
         USING PSA,0                    LOW CORE MAP           @ZA08000 28748037
         L     RWORK13,PSATOLD          PTR TO CURRENT TCB     @ZA08000 28749037
*                                                                       28750037
*** IF THE ABE APPENDAGE RETURNS TO IOS TO RESCHEDULE I/O               28751037
*** THERE WILL BE NO TCB POINTER. THE I/O SUPERVISOR USES THE           28752037
*** SRB TO DISPATCH THE I/O REQUEST.                                    28753037
*                                                                       28754037
         LTR   RWORK13,RWORK13          IS THERE A POINTER     @ZA08000 28755037
         BZ    SMFCALL                  SCHEDULED UNDER SRB    @ZA08000 28756037
         USING TCB,RWORK13              TCB ADDRESSABILITY     @ZA08000 28757037
         L     RWORK13,TCBRBP           PTR TO RB              @ZA08000 28758037
         DROP  RWORK13                                         @ZA08000 28759037
         USING RBBASIC,RWORK13          RB ADDRESSABILITY      @ZA08000 28760037
*                                                                       28761037
***IF EXCP IS ISSUED OUT OF RELEX THE RB WILL BE AN SVRB WITH           28762037
***THE PREVIOUS RB AN IRB.                                              28763037
*                                                                       28764037
         TM    RBSTAB1,RBFTSVRB         IS THIS AN IRB OR SVRB @ZA08000 28765037
         BZ    NOTIRB                   NO,BR AROUND SMF CALL  @ZA08000 28766037
         BNO   SMFCALL                  MAKE SMF CALL FOR IRB  @ZA08000 28767037
         L     RWORK13,RBLINK           PTR TO PREVIOUS RB     @ZA08000 28768037
         TM    RBSTAB1,RBFTIRB          IS PREVIOUS RB AN IRB  @ZA08000 28769037
         DROP  RWORK13                                         @ZA08000 28770037
         BZ    NOTIRB                   NO,DON'T CALL SMF      @ZA08000 28771037
SMFCALL  EQU   *                        CALL SMF               @ZA08000 28772037
         USING RQE,RRQE                                                 28773037
         L     R0,RQETCB                PTR TO TCB             @ZA08000 28774037
         L     R1,MINUS1                NEGATIVE COUNT TO SMF  @ZA08000 28788037
         L     R15,CVTPTR               PTR TO CVT             @ZA08000 28790037
         L     R15,CVTSMFEX-CVTMAP(,R15)   PTR TO SMF RTN      @ZA08000 28792037
         BALR  RRETURN,R15              BR TO SMF              @ZA08000 28794037
         DROP  RRQE                                                     28796037
         DROP  R0                                              @ZA08000 28797037
NOTIRB   EQU   *                        NOT AN IRB             @ZA08000 28798037
         LM    R0,R15,0(RWORK2)         RESTORE REGS           @ZA08000 28800037
         USING IOBSTDRD,RIOB                                            28802037
         USING IHADCB,RDCB                                              28804037
         TM    IOBDTYP2,IOBRQUST  IS THIS A READ REQUEST?               29199702
         BCR   8,RRETURN          IF NOT, RETURN TO IOS                 29199802
         TM    IOBDTYPE,IOBDYNBF  DOES REQUEST SPECIFY DYNAMIC          29199902
*                                 BUFFERING?                            29233202
         BCR   8,RRETURN          IF NO, RETURN TO IOS                  29243202
         TM    IOBSTAT1,IOBBUFF   HAS A BUFFER BEEN ASSIGNED TO         29253202
*                                 THIS REQUEST?                         29263202
         BCR   1,RRETURN          IF SO, RETURN TO IOS                  29265202
*                                                                       29500001
*                       IF A BUFFER IS AVAILABLE, ASSIGN IT TO          29600001
*                       THIS REQUEST AND UPDATE THE BUFFER POOL.        29700001
*                                                                       29800001
         USING RQE,RRQE                 ESTABLISH RQE BASE       Y02072 29860002
*                                                                       29880002
         MODESET  KEYADDR=RQEPRT,WORKREG=10  CHANGE TO USER KEY  Y02072 29890002
*                                                                       29894002
         L     RWORK10,DCBBUFCB   GET BUFFER CONTROL BLOCK ADDR         29900001
         USING BCBDEFV,RWORK10          ESTABLISH BASE FOR BCB   Y02072 30000002
         SR    RWORK11,RWORK11                                          30100001
         ICM   RWORK11,IC,BCBBFAVL  GET BUFFER NUMBER FOR NEXT          30200001
*                                 AVAILABLE BUFFER                      30300001
         BZ    PTONBUFQ           IF NONE AVAILABLE, BRANCH TO          30400001
*                                 PUT REQUEST ON QUEUE                  30500001
         IC    RWORK9,BCBSUFFX-1(RWORK11)   GET NUMBER OF 2ND           30600001
*                                 AVAILABLE BUFFER.                     30700001
         STC   RWORK9,BCBBFAVL    MAKE IT THE NEXT AVAILABLE            30800001
*                                                                       30900001
*                                 COMPUTE ADDR OF THE BUFFER TO         31000001
*                                 BE ASSIGNED.                          31100001
*                                                                       31200001
         BCTR  RWORK11,0          BUFFER NUMBER - 1.                    31300037
         L     RWORK7,BCBBUFL     LENGTH OF EACH BUFFER        @ZA08000 31302037
         MR    RWORK6,RWORK11     BUFFER #-1 * BUFFER LENGTH   @ZA08000 31400037
*                                 = DISPLACEMENT INTO BUFFER POOL       31500037
         LR    RWORK11,RWORK7                                  @ZA08000 31502037
         A     RWORK11,BCBBUF1    + ADDR OF BUFFER #1 = BUFFER          31600001
*                                 ADDR.                                 31700001
         DROP  RWORK10,RRQE                                      Y02072 31800002
         BAL   RLINK,ASSGNBUF     ASSIGN BUFFER TO REQUEST              31900001
*                                                                       32000001
SIORET   EQU   *                        RETURN TO IOS            Y02072 32050002
*                                                                       32060002
         MODESET  KEYADDR=IOSKEY,WORKREG=10  CHANGE TO IOS KEY   Y02072 32070002
*                                                                       32080002
         LM    R0,R15,0(RSAVE)          LOAD IOS REGISTERS       Y02072 32090002
         BR    RRETURN                  RETURN TO IOS TO INITIATE       32092002
*                                       I/O REQUEST                     32300002
         SPACE 5                                                        32400001
PTONBUFQ EQU   *                                                        32500001
*                                                                       32600001
*                       NO BUFFER WAS AVAILABLE. PUT THIS IOB ON        32700001
*                       THE QUEUE WAITING FOR BUFFERS.                  32800001
*                                                                       32900001
*                                                                       33100001
         L     RWORK11,DCBDYNB    ADDR OF CURRENT LIST                  33200001
         USING USL,RWORK11                                              33300001
*                                                                       34400001
*                       PUT IOB ADDR ON THE UNSCHEDULED LIST            34500001
*                                                                       34600001
         L     RWORK10,USLBFRQB   ADDR OF LAST LIST SLOT USED           34700002
         LTR   RWORK10,RWORK10    ANY USED?                             34800001
         BZ    EMPTYQ             BRANCH IF NONE                        34900001
         USING USLSLOT,RWORK10                                          35000001
         TM    USLSLTFL,USLENDL   IS LAST ONE END OF LIST ?             35100001
         BZ    BUMP               BRANCH IF NOT                         35200001
         LA    RWORK10,USLSLOT1-4 LOOP TO POINT TO 1ST SLOT             35300001
BUMP     LA    RWORK10,USLNXT     POINT TO NEXT SLOT                    35400001
         TM    USLSLTFL,USLINUSE  IS THIS SLOT ALREADY IN USE?          35500001
         BO    EXTEND             BRANCH YES, LIST IS FULL              35600037
*                                                                       35700001
STIOBADR ST    RWORK10,USLBFRQB         THIS SLOT IS LAST USED          35800002
         STCM  RIOB,ADDR,USLIOBA+1      PLACE IOB ADDR IN SLOT          35900002
         OI    USLSLTFL,USLINUSE        MARK SLOT NOT AVAILABLE         36000002
         DROP  RWORK10                  DROP USL BASE            Y02072 36010002
*                                                                       36050002
         MODESET  KEYADDR=IOSKEY,WORKREG=10  CHANGE TO IOS KEY   Y02072 36060002
*                                                                       36070002
         LM    R0,R15,0(RSAVE)          LOAD IOS REGISTERS       Y02072 36080002
         B     4(RRETURN)               IOS RETURN - DON'T DO I/O       36200002
*                                                                       36300001
EMPTYQ   LA    RWORK10,USLSLOT1   USE FIRST SLOT ON LIST                36400001
*                                 TOP SLOT IS FIRST ON QUEUE            36500001
         STCM  RWORK10,ADDR,USLBFRQT+1                                  36600001
         B     STIOBADR                                                 36700001
         DROP  RWORK11                                                  36900001
*                                                                       37000001
         EJECT                                                          37000437
EXTEND   EQU   *                                               @ZA08000 37002037
*                       THE IOB ADDRESS CANNOT BE PLACED ON THE         37100001
*                       CURRENT UNSCHEDULED LIST BECAUSE THE            37100437
*                       LIST IS FULL.                                   37102037
*                       GET STORAGE FOR AN UNSCHEDULED LIST TWICE AS    37104037
*                       LARGE AS THE CURRENT ONE.                       37106037
*    DCBDYNB       FOR THE EXTEND FUNCTION, POINTS TO NEW LIST.       * 37202037
*              THE LIST IS INITIALIZED AS FOLLOWS:                    * 37204037
*    USLSIZE       LIST SIZE IN BYTES -- 2* OLD LIST SIZE             * 37206037
*    USLFLAGS      BIT USLCURNT SET IN NEW LIST, TURNED OFF IN        * 37208037
*                  OLD LIST.                                          * 37210037
*    USLBFRQT      THE IOB ADDRESSES ARE ARRANGED SUCH THAT THE       * 37212037
*                  ADDR OF THE 1ST IOB ON THE OLD LIST IS COPIED      * 37214037
*                  INTO THE TOP SLOT ON THE NEW LIST.  IF NO          * 37216037
*                  IOBS ARE ON THE LIST, SET TO ZERO.                 * 37218037
*    USLBFRQB      ADDR OF SLOT USED BY LAST IOB ON QUEUE (OR 0       * 37220037
*                  IF THERE ARE NONE.)                                * 37222037
*    USLCHAIN      ADDRESS OF PRIOR LIST COPY                         * 37224037
*                                                                       37406037
         L     RWORK10,DCBDYNB    GET ADDR OF CURRENT UNSCHED-   Y02072 37410037
         USING USL,RWORK10        ULED LIST.                     Y02072 37412037
         LH    RWORK11,USLSIZE    SIZE OF CURRENT LIST           Y02072 37414037
         SLL   RWORK11,1                *2= SIZE OF NEW LIST   @ZA08000 37414437
         LR    RRQES,RRQE         SAVE RQE POINTER             @ZA24815 37415237
*                                                                       37416037
         GETMAIN R,SP=250,LV=(RWORK11),BRANCH=YES   GET CORE   @ZA08000X37418037
                                                    FOR NEW USL         37420037
         LR    RWORK2,RSAVE             SAVE AREA PTR          @ZA08000 37422137
         LM    RRETURN,R15,56(RSAVE)    RESTORE BASE REG       @ZA08000 37422437
         USING RQE,RRQES                                       @ZA24815 37422837
         MODESET KEYADDR=RQEPRT,WORKREG=9      USER KEY        @ZA08000 37423637
         DROP  RRQES                                           @ZA24815 37424437
         LR    RNEWLST,R1               GET ADDR OF NEW LIST     Y02072 37426037
*                                                                       37428037
         LA    RWORK1,0(RNEWLST,RWORK11)                         Y02072 37430037
*                                                                       37432037
*                  INITIALIZE NEW LIST                                  37502037
*                                                                       37504037
         XC    0(USLSLOT1-USL,RNEWLST),0(RNEWLST)     CLEAR TO 0        37506037
         STH   RWORK11,USLSIZE-USL(RNEWLST)  SIZE OF NEW LIST    Y02072 37508037
         LR    RWORK9,RWORK10           GET ADDRESS OF OLD USL   Y02072 37510037
         AH    RWORK9,USLSIZE           ENDING ADDR OF OLD USL   Y02072 37512037
         LA    RWORK6,USLSLOT1-USL(RNEWLST)                             37514037
*                                 LESS FIRST SLOT ADDR, NEW LIST        37516037
         SR    RWORK1,RWORK6      = LENGTH OF ENTRIES, NEW LIST         37518037
*                                                                       37520037
*                                                                       37522037
*                  IF THE LIST HAS ENTRIES IN 2 NONCONTIGUOUS           37524037
*                  SEGMENTS, FIRST MOVE THE SEGMENT CORRESPONDING       37526037
*                  TO THE TOP OF THE QUEUE. THE SEGMENTS WILL BE        37528037
*                  MOVED WITH MVCL WHICH DEPENDS ON TWO REGISTER        37530037
*                  PAIRS:  R12-R13  AND  R6-R7                          37532037
*                                                                       37534037
         ICM   RWORK12,ADDR,USLBFRQT+1                           Y02072 37536037
*                                 ADDR OF TOP QUEUE ENTRY               37538037
         BZ    CLRLST                                                   37540037
         LR    RWORK13,RWORK9           SAVE FOR LEN CALCULATION Y02072 37542037
*                                       OLD USL ADDR ENDING      Y02072 37544037
         SH    RWORK9,H4                POINT TO LAST ENTRY, OLD LIST   37546037
         USING USLSLOT,RWORK9                                           37602037
         NI    USLSLTFL,X'FF'-USLENDL  TURN OFF END OF LIST FLAG        37604037
*                                      BEFORE MOVE                      37606037
         ST    RWORK6,USLBFRQT-USL(RNEWLST)                             37608037
*                                 TOP OF QUEUE FOR NEW LIST IS          37610037
*                                 FIRST SLOT.                           37612037
         LA    RWORK9,USLSLOT1    FIRST SLOT, OLD LIST.                 37614037
         TM    USLSLTFL,USLINUSE  IS THIS SLOT BEING USED?              37616037
         BZ    SECSEG             BRANCH NO, 1 MOVE WILL SUFFICE        37618037
         DROP  RWORK9                                                   37620037
         CR    RWORK12,RWORK9     IS TOP QUEUE ENTRY IN 1ST SLOT Y02072 37622037
         BE    SECSEG             BRANCH YES, AGAIN 1 MOVE OK           37624037
*                                                                       37626037
         SR    RWORK13,RWORK12    LENGTH OF 1ST SEGMENT          Y02072 37628037
         LR    RWORK7,RWORK13     RECEIVING FIELD IS SAME LENGTH Y02072 37630037
         SR    RWORK1,RWORK7      REDUCE LENGTH OF UNUSED SLOTS         37632037
         MVCL  RWORK6,RWORK12     MOVE 1ST SEGMENT TO NEW LIST   Y02072 37634037
         LA    RWORK12,USLSLOT1   2ND SEGMENT STARTS AT 1ST SLOT Y02072 37636037
*                                 OF OLD LIST.                          37638037
*                                                                       37640037
*                  MOVE SECOND OR ONLY LIST SEGMENT.                    37642037
*                                                                       37644037
SECSEG   L     RWORK13,USLBFRQB   LAST SLOT OF SEGMENT TO MOVE   Y02072 37646037
         USING USLSLOT,RWORK13    ESTABLISH BASE FOR UNSCHED LST Y02072 37648037
         LA    RWORK13,USLNXT     POINT AT END ADDR + 1          Y02072 37650037
         DROP  RWORK13                                           Y02072 37652037
         SR    RWORK13,RWORK12    LENGTH OF SECOND SEGMENT       Y02072 37654037
         LR    RWORK7,RWORK13     RECEIVING FIELD IS SAME LENGTH Y02072 37656037
         SR    RWORK1,RWORK7      REDUCE AMOUNT OF UNUSED SLOTS         37658037
         MVCL  RWORK6,RWORK12     MOVE 2ND SEGMENT TO NEW LIST   Y02072 37660037
         LR    RWORK9,RWORK6      END OF LAST USED SLOT                 37662037
         SH    RWORK9,H4          ADDR OF BOTTOM SLOT IN QUEUE          37664037
         ST    RWORK9,USLBFRQB-USL(RNEWLST)  INITIALIZE PTR TO          37666037
*                                 LAST SLOT OF QUEUE.                   37668037
*                                                                       37670037
*                  CLEAR THE UNUSED SLOTS ON THE NEW LIST               37672037
*                                                                       37674037
CLRLST   LR    RWORK7,RWORK1      LENGTH REMAINING (TO FIELD)           37676037
         SR    RWORK13,RWORK13    SEND NO CHARACTERS, PAD X'00'  Y02072 37678037
         MVCL  RWORK6,RWORK12     CLEAR REST OF LIST             Y02072 37680037
*                                                                       37682037
         SH    RWORK6,H4          ADDR LAST SLOT                        37684037
         USING USLSLOT,RWORK6                                           37686037
         OI    USLSLTFL,USLENDL   TURN ON END-OF-LIST FLAG              37688037
         DROP  RWORK6                                                   37690037
*                                                                       37692037
         NI    USLFLAGS,X'FF'-USLCURNT  TURN OFF 'CURRENT' FLAG         37694037
*                                       IN OLD LIST                     37696037
         OI    USLFLAGS-USL(RNEWLST),USLCURNT                           37698037
*                                 TURN ON 'CURRENT' FLAG IN NEW         37698437
*                                 SET POINTER TO OLD LIST IN NEW        37698837
         ST    RWORK10,USLCHAIN-USL(RNEWLST)                     Y02072 37699237
         ST    RNEWLST,DCBDYNB    SET POINTER TO NEW LIST IN DCB        37699637
         LR    RSAVE,RWORK2             RESTORE SAVE REG       @ZA08000 37702037
         B     PTONBUFQ                 PUT IOB ON USL IST     @ZA08000 37704037
*                                                                       39402037
*                                                                       39414037
         EJECT                                                          39416037
*                                                                       39500001
*                  THIS SUBROUTINE IS USED BY THE START-I/O             39600001
*                  APPENDAGE AND THE FREE DYNAMIC BUFFER SVC            39700001
*                  ROUTINE. IT IS ENTERED IN USER KEY.                  39800002
*                  IT ASSIGNS A BUFFER TO AN I/O REQUEST BY             39900001
*                  PLACING THE BUFFER ADDRESS INTO THE DECB             40000001
*                  AND THE CHANNEL PROGRAM.                             40100001
*                                                                       40200001
*              REGISTER INPUT:  RIOB    - ADDR OF IOB TO WHICH          40300001
*                                         BUFFER WILL BE ASSIGNED       40400002
*                               RDCB    - DCB ADDRESS                   40500001
*                               RWORK11 - BUFFER ADDRESS                40600001
*                               RLINK   - RETURN ADDRESS                40700001
*              REGISTER OUTPUT: RWORK9  - WORK REGISTER                 40800001
*                               RWORK10 - WORK REGISTER                 40900001
*                               RWORK11 - WORK REGISTER                 41000001
*                               RCCW    - WORK REGISTER                 41002037
*                               RSWA    - WORK REGISTER                 41004037
         USING IHADCB,RDCB                                              41100001
         USING IOBSTDRD,RIOB                                            41200001
ASSGNBUF L     RWORK9,IOBECBPT    GET DECB ADDRESS                      41300001
         USING DECB,RWORK9                                              41400001
         USING SWA,RWORK11        ESTABLISH BASE FOR SEG WRKAREA Y02072 41402037
         TM    DCBRECFM,DCBRECV+DCBRECSB IS THIS VS FORMAT     @ZA08000 41404037
         BNO   NORECVS1           NO,BRANCH AROUND VS CODE     @ZA08000 41408037
*                                 PLACE SWA ADDR IN IOB                 41412037
         LR    RWORK10,RIOB       PLACE IOB ADDRESS IN WORK REG         41414037
         LA    RSWA,IOBSTDRD-IOBSWAP   DISP TO IOBSWAP FIELD            41416037
         SR    RWORK10,RSWA       POINT TO IOB PREFIX                   41418037
         USING IOBSWAP,RWORK10                                          41420037
         ST    RWORK11,IOBSWAP    PLACE SWA ADDR IN IOB                 41422037
*                                 DATA & KEY (IF REQUESTED) WILL        41424037
*                                 BE READ INTO THE SEGMENT AREA         41426037
*                                 OF THE DYNAMIC BUFFER.  THE           41428037
*                                 USER WILL BE PASSED THE ADDRESS       41430037
*                                 OF LOCATIONS IN THE RECORD            41432037
*                                 AREA.                                 41434037
*                                                                       41436037
         LA    RSWA,SWASEGMT      GET ADDRESS OF SEGMENT AREA    Y02072 41438037
*                                                                       41440037
         L     RWORK10,DCBBUFCB   ADDRESS BUFFER CONTROL BLOCK          41442037
         USING BCBDEFV,RWORK10    ESTABLISH BASE FOR BCB         Y02072 41444037
         L     RWORK10,BCBRAOFS-1 GET DISPLACEMENT OF RECORD            41446037
         DROP  RWORK10            AREA FROM START OF BUFFER.            41448037
         LA    RWORK11,0(RWORK10,RWORK11)        ADDR OF RECORD AREA    41450037
*                                                                       41452037
         L     RCCW,IOBDCPND      POINT BEYOND LAST CCW                 41454037
         SH    RCCW,H16           POINT TO NEXT-TO-LAST CCW             41456037
*                                 FOR A READ BY BLOCK ID, KEY           41458037
*                                 CODED 'S', THE KEY IS READ            41460037
*                                 INTO THE DYNAMIC BUFFER.              41462037
         TM    IOBDTYP2,IOBTYPE   IS THIS READ BY BLOCK ID?             41464037
         BO    FILLCCWV           BRANCH IF NO                          41466037
         TM    IOBDTYP2,IOBSKEY   WAS KEY ADDRESS CODED 'S'?            41468037
         BZ    FILLCCWV           BRANCH IF NO                          41470037
         ST    RWORK11,DECKYADR   PLACE KEY ADDRESS IN DECB             41472037
         CLI   DCBKEYLE,0         IS KEY LENGTH ZERO             XM1559 41474037
         BE    FILLCCWV           BR IF YES                      XM1559 41476037
         ST    RWORK11,0(RCCW)    PLACE ADDR OF KEY IN RECORD   XA00093 41478037
*                                 AREA INTO NEXT-TO-LAST CCW.           41480037
         MVI   0(RCCW),KEYDATOP   RESTORE OP-CODE                       41482037
*                                 INCREMENT RECORD AREA & SEGMENT       41484037
*                                 AREA POINTERS BEYOND KEY.             41486037
         SR    RWORK10,RWORK10                                          41488037
         IC    RWORK10,DCBKEYLE   GET LENGTH OF KEY                     41490037
         AR    RWORK11,RWORK10    BUMP RECORD AREA POINTER              41492037
*                                                                       41494037
FILLCCWV ST    RWORK11,DECAREA    PLACE DATA ADDRESS IN DECB            41496037
         ST    RSWA,8(RCCW)       PLACE DATA ADDRESS IN LAST CCW        41498037
         MVI   8(RCCW),RDDATAOP   RESTORE OP-CODE.                      41502037
         OI    IOBDSTAT,IOBBUFF   SET BUFFER-ASSIGNED SWITCH            41504037
         BR    RLINK              RETURN TO CALLER                      41506037
         DROP  RWORK11                                                  41508037
         EJECT                                                          41510037
NORECVS1 EQU   *                  NOT VS FORMAT                @ZA08000 41512037
*                                 FOR A READ BY BLOCK ID, KEY           41514037
*                                 CODED 'S', THE KEY IS READ            41600001
*                                 INTO THE DYNAMIC BUFFER.              41700001
         TM    IOBDTYP2,IOBTYPE   IS THIS READ BY BLOCK ID?             41800001
         BO    FILLSCCW           BRANCH IF NO                          41900001
         TM    IOBDTYP2,IOBSKEY   WAS KEY ADDRESS CODED 'S'?            42000001
         BZ    FILLSCCW           BRANCH IF NO                          42100001
*                                 IN AN RPS PROGRAM CCW 3 READS         42200001
*                                 THE KEY; IN A NON-RPS PROGRAM,        42300001
*                                 CCW 4.                                42400001
         LA    RWORK10,IOBCHNPR+16     ADDR OF CCW 3                    42500001
         CLI   IOBCHNPR,SETSECT   TEST FOR RPS PROGRAM                  42600001
         BNE   NORPS              BRANCH IF NOT                         42700001
         LA    RWORK10,8(RWORK10) FOR RPS -- CCW 4                      42800001
*                                 PUT BUFFER ADDR OF KEY IN             42900001
*                                 CORRECT CCW & IN DECB                 43000001
NORPS    ST    RWORK11,0(RWORK10) PLACE ADDRESS IN READ KEY CCW         43100001
         MVI   0(RWORK10),KEYDATOP   RESTORE OP-CODE                    43200001
         ST    RWORK11,DECKYADR   PLACE KEY ADDRESS IN DECB             43300001
*                                 INCREMENT BUFFER POINTER              43400001
*                                 BEYOND KEY                            43500001
         SR    RWORK10,RWORK10                                          43600001
         IC    RWORK10,DCBKEYLE   GET KEY LENGTH                        43700001
         AR    RWORK11,RWORK10    BUMP BUFFER PTR BEYOND KEY            43800001
*                                 IN A NON-TRACK-OVERFLOW PGM           43900001
*                                 THE LAST CCW READS DATA; FOR          44000001
*                                 TRACK OVERFLOW, THE NEXT-TO-          44100001
*                                 LAST CCW                              44200001
FILLSCCW L     RWORK10,IOBDCPND   POINTS BEYOND LAST CCW                44300001
         SH    RWORK10,H8         ADDR OF LAST CCW                      44400001
         TM    DCBOPTCD,DCBOPTTO  TEST FOR TRACK OVERFLOW               44500001
         BZ    STADDR             BRANCH IF NO                          44600001
         SH    RWORK10,H8         ADDR OF NEXT-TO-LAST CCW              44700001
*                                                                       44800001
STADDR   ST    RWORK11,0(RWORK10) PUT DATA ADDR IN CCW                  44900001
         MVI   0(RWORK10),RDDATAOP     RESTORE READ DATA OP-CODE        45000001
         ST    RWORK11,DECAREA    PLACE DATA ADDRESS IN DECB            45100001
         OI    IOBDSTAT,IOBBUFF   SET BUFFER-ASSIGNED SWITCH            45200001
         BR    RLINK              RETURN TO CALLER                      45300001
         DROP  RWORK9                                                   45400001
         DROP  RIOB                                                     45500001
         DROP  RDCB                                                     45600001
         EJECT                                                          45700001
FBUFRTNE EQU   *                                                        45800001
*                                                                     * 45900001
* FUNCTION:                                                           * 46000001
*    THE FREE DYNAMIC BUFFER ROUTINE RELEASES A DYNAMIC BUFFER.       * 46100001
*    IF ANY IOBS ARE ON THE UNSCHEDULED QUEUE (WAITING FOR A          * 46200001
*    BUFFER) THE ROUTINE ASSIGNS THE BUFFER TO THE FIRST IOB ON       * 46300001
*    THE QUEUE, AND ISSUES AN EXCP FOR THAT IOB.  IF NO IOBS ARE      * 46400001
*    ON THE UNSCHEDULED QUEUE THE ROUTINE PLACES THE BUFFER ON        * 46500001
*    THE CHAIN OF AVAILABLE BUFFERS.                                  * 46600001
*                                                                     * 47200001
* ENTRY POINT:                                                        * 47300001
*         FRBUFEP -- ENTERED FROM MODULE IGC0005G WHEN SVC 57 IS      * 47400001
*         ISSUED FOR A DCB WHICH SPECIFIED DIRECT ORGANIZATION.       * 47500001
*         CALLING SEQUENCE -- L    15,DCBDEBAD                        * 47600001
*                             L    15,DEBAPPAD                        * 47700001
*                             L    15,4(15)                           * 47800001
*                             BAL  14,8(15)                           * 47900001
*                                                                     * 48000001
* INPUT                                                               * 48100001
*    **** REGISTER CONTENTS ****                                      * 48200001
*    REGISTER  0 -- DECB ADDRESS                                      * 48300001
*    REGISTER  1 -- DCB ADDRESS                                       * 48500001
*    REGISTER  5 -- SVRB ADDRESS                                      * 48550002
*    REGISTER  8 -- TCB ADDRESS PASSED BY FREEDBUF                    * 48560002
*    REGISTER 14 -- RETURN ADDRESS                                    * 48700001
*    REGISTER 15 -- ADDRESS OF IGG019JA                               * 48800001
*                                                                     * 48900001
* OUTPUT                                                              * 49000001
*    **** REGISTER CONTENTS ****                                      * 49100001
*    ALL REGISTERS EXCEPT REGISTER 14 CAN BE USED WITHOUT SAVING      * 49200001
*    OR RESTORING CONTENTS.                                           * 49300001
*    REGISTER 15 CONTAINS RETURN CODE.                                * 49400001
*                                                                     * 49500001
*    **** DATA FIELDS SET BY THIS ROUTINE ****                        * 49600001
*    USLBFRQT      IF AN IOB IS WAITING FOR A BUFFER, PTR TO 1ST      * 49700001
*                  IOB ON QUEUE IS UPDATED.                           * 49800001
*    USLBFRQB      IF, AFTER 1 IOB IS DEQUEUED, THE LIST IS EMPTY,    * 49900001
*                  USLBFRQB IS SET TO ZERO.                           * 50000001
*    THE BUFFER ADDRESS IS PLACED IN THE CHANNEL PROGRAM AND DECB     * 50100001
*    FIELDS (SEE SIORTNE DESCRIPTION FOR DETAILS).                    * 50200001
*    BCBBFAVL      IF THE BUFFER IS NOT ASSIGNED TO A REQUEST,        * 50300001
*                  ITS NUMBER IS PLACED IN BCBBFAVL.  THE             * 50400001
*                  CORRESPONDING BYTE OF THE BUFFER POOL SUFFIX       * 50500001
*                  WILL POINT TO THE SECOND AVAILABLE BUFFER.         * 50600001
*    SVRB          SEE BELOW                                            51950002
*                                                                     * 52000001
* EXTERNAL REFERENCES                                                 * 52100001
*        EXCP CALL TO IOS                                             * 52200001
*        MODESET   TO CHANGE BETWEEN SUPERVISOR AND USER KEYS         * 52400002
*        SETLOCK   TO RELEASE AND OBTAIN THE LOCAL LOCK                 52450002
*                                                                     * 53000001
* EXITS, NORMAL                                                       * 53100001
*    BRANCH RETURN TO IGC0005G ON REGISTER 14.  RETURN CODE (R15)     * 53200001
*    = 0.                                                             * 53300001
*                                                                     * 53400001
*                                                                     * 54200001
* TABLES / WORK AREAS                                                 * 54300001
*        IOB, DCB, DECB, BUFFER CONTROL BLOCK,                        * 54400037
*         & SVRB EXTENDED SAVEAREA                                    * 54500037
*                                                                     * 54600001
* ATTRIBUTES -- REENTRANT, READONLY, PRIVILEGED. ENTRY IS IN SUPER-   * 54700002
*        VISOR KEY WITHOUT THE LOCAL LOCK HELD. RETURN TO IGC0005G IS * 54710002
*        IN SUPERVISOR KEY. MOST PROCESSING IS IN USER KEY.           * 54720002
*                                                                     * 54800001
* NOTES -- THE ROUTINE MUST HAVE THE LOCAL LOCK TO UPDATE THE SERIALLY* 54900002
*        REUSABLE IOB AND BUFFER QUEUES. SETLOCK WILL BE ISSUED THEN. * 55000002
*                                                                     * 55500001
*****                                                             ***** 55550002
         EJECT                                                          55666702
         LR    RBASE3,RAPDBASE    ESTABLISH BASE REGISTER               55900001
         USING IGG019JA,RBASE3                                          56000001
         DROP  RAPDBASE                                                 56100001
         LR    RDCB,R1            TRANSFER DCB ADDRESS                  56200001
         USING IHADCB,RDCB                                              56300001
         USING RBSECT,RSVRB       ESTABLISH BASE FOR SVRB        Y02072 56350002
         ST    RRETURN,WKAREG14   SAVE RETURN REGISTER                  56352002
         USING TCB,RTCB           ESTABLISH BASE FOR TCB         Y02072 56370002
*                                 PASSED BY FREEDBUF IN R8       Y02072 56380002
*                                                                       56390002
         MODESET  KEYADDR=WKASVKEY,WORKREG=6  CHANGE TO USER KEY Y02072 56392002
*                                                                       56394002
         USING DECB,RDECB                                               56600001
*                                                                       56700001
*                       LOCATE THE BEGINNING ADDRESS OF THE             56800001
*                       BUFFER BEING FREED.                             56900001
*                                                                       57000001
         L     RBUFFR,DECAREA     ASSUME BUFFER ADDR = DATA ADDR        57100001
         TM    DECTYPE2,DECKEYS   WAS KEY IN BUFFER (CODED 'S')?        57200001
         BZ    FBU0500            BRANCH NO                             57300001
         L     RBUFFR,DECKYADR    BUFFER ADDR = KEY ADDR                57400001
FBU0500  EQU   *                                                        57500001
         TM    DCBRECFM,DCBRECV+DCBRECSB IS THIS VS FORMAT     @ZA08000 57500437
         BNO   NORECVS2                 NO,BR AROUND VS CODE   @ZA08000 57500837
         LA    RWORK12,BUFRECAR-BUFBFPTR                                57502037
         SR    RBUFFR,RWORK12     POINT TO ADDR OF BEGINNING OF         57504037
*                                 BUFFER                                57506037
         L     RBUFFR,0(RBUFFR)         GET BUFFER ADDRESS              57508037
         USING SWA,RBUFFR               ESTABLISH BASE FOR SWA   Y02072 57508437
         XC    SWABFINC,SWABFINC        RECORD AREA OFFSET PTR   Y02072 57508837
NORECVS2 EQU   *                        NOT VS RECORD FORMAT   @ZA08000 57509237
         L     RWORK10,DCBDYNB    ADDR OF UNSCHEDULED LIST       Y02072 57510002
         USING USL,RWORK10              USL ADDRESSABILITY       Y02072 57520002
         L     RWORK12,DCBBUFCB         GET BCB ADDRESS          Y02072 57530002
         USING  BCBDEFV,RWORK12         BCB ADDRESSABILITY       Y02072 57540002
*                                                                       57550002
*   PREPARE FOR QUEUE UPDATES. THIS REQUIRES THAT THE LOCAL LOCK BE     57560002
*   OBTAINED WHILE MANIPULATING THE QUEUE. IT IS RELEASED WHEN THE      57570002
*   QUEUE HAS BEEN UPDATED AND THE NEXT WAITING IOB HAS BEEN REMOVED,   57580002
*   OR THE BUFFER HAS BEEN PUT BACK ON THE AVAILABLE BUFFER QUEUE.      57590002
*   MODESET IS ISSUED BECAUSE SETLOCK REQUIRES SUPERVISOR KEY.          57590402
*   CERTAIN FIELDS WILL BE SAVED AT THIS POINT, SHOULD THE ESTAE        57590502
*   NEED THEM. SETLOCK USES REGISTERS 11-14 WITHOUT RESTORING THEM.     57590802
*                                                                       57592002
         IC    RWORK9,BCBBFAVL          GET NEXT AVAIL BUF NO    Y02072 57592402
*                                       FOR ESTAE- 1 BYTE        Y02072 57592802
         DROP  RWORK12                  DROP BCB BASE            Y02072 57592902
         L     RWORK0,USLBFRQT          GET USL CONTENTS FOR     Y02072 57593202
*                                       ESTAE - IN USER KEY      Y02072 57593602
*                                                                       57593702
         MODESET  EXTKEY=ZERO           CHANGE TO SUPER KEY      Y02072 57594002
*                                       TO GET THE LOCAL LOCK    Y02072 57594402
*                                                                       57594802
GETLOCK  SETLOCK  OBTAIN,TYPE=LOCAL,RELATED=('BUFFERQ,IGG019JA(FREELOCKX57594902
               ,FREELCK1)'),MODE=UNCOND  GET THE LOCAL LOCK      Y02072 57595302
*                                                                       57595502
         ST    RBUFFR,WKABUFRG          SAVE BUF PTR FOR ESTAE   Y02072 57595602
         ST    RWORK0,WKASAVE           SAVE USL CONTENT IN SVRB Y02072 57605202
         STC   RWORK9,WKASAVE2          SAVE NEXT AVAIL BUF NO.  Y02072 57615202
*                                       FOR ESTAE IN CASE PATH   Y02072 57625202
*                                       TAKEN CHANGES THIS       Y02072 57627202
*                                                                       57665502
         MODESET  KEYADDR=WKASVKEY,WORKREG=11 RET TO USER KEY    Y02072 57693102
*                                                                       57700002
         ICM   RWORK9,ADDR,USLBFRQT+1   PTR TO 1ST IOB ON QUEUE         60000001
         BZ    FBUNOREQ           BRANCH IF NO IOBS TO MAKE             60100001
*                                 BUFFER AVAILABLE                      60200001
         USING USLSLOT,RWORK9                                           60300001
         L     RIOB,USLSLOT       GET IOB ADDRESS                       60400001
         USING IOBSTDRD,RIOB                                            60500001
*                                                                       60510002
         MODESET  EXTKEY=ZERO           CHANGE TO SUPER KEY      Y02072 60550002
*                                       TO SAVE IOB ADDRESS      Y02072 60560002
         ST    RIOB,WKAIOBRG            SAVE IOB PTR FOR ESTAE   Y02072 60580002
*                                                                       60590002
         MODESET  KEYADDR=WKASVKEY,WORKREG=11  RET TO USER KEY   Y02072 60592002
*                                                                       60594002
         NI    USLSLTFL,X'FF'-USLINUSE  MAKE SLOT AVAILABLE             60600001
         TM    USLSLTFL,USLENDL   IS THIS LAST SLOT IN LIST?            60700001
         BZ    NXTSLT             BRANCH IF NO                          60800001
         LA    RWORK9,USLSLOT1-4 GET BACK TO TOP OF LIST                60900001
NXTSLT   LA    RWORK9,USLNXT      BUMP SLOT POINTER 1 ENTRY             61000001
         TM    USLSLTFL,USLINUSE  IS THERE ANOTHER IOB WAITING?         61100001
         BO    STOREPTR                 BRANCH IF YES                   61200002
         SR    RWORK9,RWORK9                                            61300001
         DROP  RWORK9                                                   61400001
         ST    RWORK9,USLBFRQB          MARK QUEUE EMPTY BY SETTING     61500002
*                                       TOP & BOTTOM PTRS TO ZERO.      61600002
STOREPTR STCM  RWORK9,ADDR,USLBFRQT+1   SLOT OF FIRST IOB (OR 0)        61700002
         DROP  RWORK10                                           Y02072 61750002
*                                                                       61850002
         MODESET  EXTKEY=ZERO           CHANGE TO ZERO KEY       Y02072X61860002
                                        TO SET BIT IN SVRB       Y02072X61870002
                                        AND RELEASE LOCAL LOCK   Y02072 61870402
         MVI   WKATRAIL,WKAIOBQ         SET BIT IN SVRB EXT SAVE Y02072 61870802
*                                       INDICATING IOB DEQUEUED  Y02072 61871202
*                                                                       61872002
FREELOCK SETLOCK  RELEASE,TYPE=LOCAL,RELATED=('BUFFERQ,IGG019JA(GETLOCKX61874002
               )')                      FREE THE LOCAL LOCK      Y02072 61874402
*                                                                       61884402
ESTENTA  EQU   *                        ESTAE ENTRY IF WKAIOBQ=1 Y02072 61886002
*                                                                       61888002
         MODESET  KEYADDR=WKASVKEY,WORKREG=11  RET TO USER KEY   Y02072 61892002
*                                                                       61894002
         LR    RAPDBASE,RBASE3    LOAD BASE FOR COMMON SUBRTNE          61944002
         LR    RWORK11,RBUFFR     PUT BUFFER ADDR IN R11                62400001
         BAL   RLINK,ASSGNBUF     ASSIGN THE BUFFER TO THE              62700001
*                                 DEQUEUED IOB.                         62800001
*                                                                       62870002
         MODESET  EXTKEY=ZERO           CHANGE TO SUPER KEY      Y02072X62880002
                                        TO SET BIT IN SVRB       Y02072 62890002
         MVI   WKATRAIL,WKABUFAS        SET BIT IN SVRB EXTENDED Y02072 62892002
*                                       SAVEAREA INDICATING BUF  Y02072 62894002
*                                       ASSIGNED TO NEXT IOB     Y02072 62896002
ESTENTB  EQU   *                        ESTAE ENTRY IF WKABUFAS  Y02072 62896402
*                                       BIT IS ON                Y02072 62896802
         MODESET  KEYADDR=WKASVKEY,WORKREG=11  RET TO USER KEY   Y02072 62898002
*                                                                       62898402
         L     RWORK11,IOBECBPT         LOAD ADDR TO USER'S DECB Y02072 62898802
         ST    RWORK11,IOBDQPTR         SAVE DECB ADDR IN IOB    Y02072 62899202
         LA    RWORK11,IOBCSW+3         SET UP CSW ADDRESS TO    Y02072 62899602
         ST    RWORK11,IOBECBPT         USE AS DUMMY ECB FOR IOS Y02072 62899702
*                                       CEA OR EOE WILL RESTORE  Y02072 62899802
*                                       USER'S DECB ADDR IN IOB  Y02072 62899902
*                                                                       62933202
         EXCP  (RIOB)                   SCHEDULE I/O FOR NEXT IOB ON Q  62988602
*                                                                       62988702
         MODESET  EXTKEY=ZERO           RETURN TO ZERO KEY       Y02072 62988802
*                                                                       62992502
         MVI   WKATRAIL,WKAEXCP         SET BIT INDICATING EXCP  Y02072 62995302
*                                                                       62995702
         B     NORMEXIT                 NORMAL RET TO IGC0005G   Y02072 63200002
         SPACE 5                                                        63400001
*                                                                       63500001
*   NO IOBS ARE WAITING FOR BUFFERS.  RETURN BUFFER TO THE AVAILABLE    63550002
*   QUEUE.THIS ROUTINE IS ENTERED IN USER KEY WITH THE LOCAL LOCK HELD. 63600002
*   RETURN FROM THIS ROUTINE TO FREEDBUF IS IN SUPERVISOR KEY.          63650002
*                                                                       63800001
FBUNOREQ L     RWORK12,DCBBUFCB   ADDR OF BUFFER CONTROL BLOCK   Y02072 63900002
         USING BCBDEFV,RWORK12          ESTABLISH BCB BASE       Y02072 64000002
*                                                                       64100001
*                      COMPUTE BUFFER NUMBER FROM BUFFER ADDRESS        64200001
*                                                                       64300001
         LR    RWORK1,RBUFFR      BUFFER ADDRESS                        64400001
         S     RWORK1,BCBBUF1     MINUS ADDR OF 1ST BUFFER              64500001
*                                  = DISP INTO BUFFER POOL              64600001
         SR    RWORK0,RWORK0                                            64700001
         D     RWORK0,BCBBUFL     DIVIDED BY BUFFER LENGTH              64800001
*                                  = BUFFER NUMBER -1.                  64900001
         LA    RWORK1,1(RWORK1)   PLUS 1 = BUFFER NUMBER                65000001
*                                                                       65100001
*                      PLACE BUFFER # ON AVAILABLE CHAIN                65200001
*                                                                       65300001
         IC    RWORK9,BCBBFAVL    NEXT AVAIL BUFFER #                   65400001
         STC   RWORK9,BCBSUFFX-1(RWORK1)    POINT CHAIN ENTRY           65500001
*                                 FOR THIS BUFFER TO IT                 65600001
         STC   RWORK1,BCBBFAVL    MAKE THIS BUFFER NEXT AVAIL           65700001
*                                                                       65800001
*            RELEASE LOCAL LOCK AND SET AUDIT TRAIL BIT                 65850002
*                                                                       66000001
*                                                                       66050002
         MODESET  EXTKEY=ZERO           CHANGE TO SUPER KEY      Y02072X66100002
                                        TO SET BIT IN SVRB       Y02072X66150002
                                        AND RELEASE LOCK         Y02072 66152002
         MVI   WKATRAIL,WKABUFQ         SET BIT INDICATING BUF   Y02072 66154002
*                                       FREED AND PUT ON QUEUE   Y02072 66156002
*                                                                       66160002
FREELCK1 SETLOCK  RELEASE,TYPE=LOCAL,RELATED=('BUFFERQ,IGG019JA(GETLOCKX66170002
               )')                      FREE THE LOCAL LOCK      Y02072 66172002
*                                                                       66222002
*                                                                       66600001
         EJECT                                                          73900001
*                                                                       86700001
*                                                                       87100001
*                       NORMAL EXIT                                     87200001
*                                                                       87300001
NORMEXIT L     RRETURN,WKAREG14   RESTORE RETURN REGISTER               87400001
         SR    RRETCODE,RRETCODE  RETURN CODE = 0.                      87500002
         BR    RRETURN            RETURN TO IGC0005G                    87600001
*                                                                       87700001
         SPACE 2                                                        87800002
*********************************************************************** 89750002
*                           CONSTANTS                                 * 89760002
*********************************************************************** 89770002
MINUS1   DC    F'-1'                    NEGATIVE COUNT FOR SMF @ZA08000 89774037
H8       DC    H'8'                                                     89800001
H16      DC    H'16'                                           @ZA08000 89802037
H4       DC    H'4'                                                     89900001
IOSKEY   DC    X'00'                    KEY OF IOS               Y02072 89950002
ZERO     DC    X'00'                    SVRB KEY                 Y02072 89960002
NAME     DC    CL8'IGG019JA'            MODULE NAME            @ZA08000 89962037
FIX      DC    C'OZ24815 '              LATEST APAR            @ZA24815 89963037
DATE     DC    CL8'&SYSDATE'            LAST FIX DATE          @ZA08000 89964037
PATCH    DC    XL50'0'                  PATCH AREA               Y02072 89970002
         EJECT                                                          91000001
*********************************************************************** 91010002
*                         DSECTS                                      * 91020002
*********************************************************************** 91030002
         IHAPSA                                                  Y02072 91050002
         EJECT                                                          91080002
         IECDRQE                                                 Y02072 91090002
         EJECT                                                          91092002
         IKJTCB                                                         91094002
         EJECT                                                          91096002
         IEZIOB                                                         91100001
         ORG   IOBDQPTR                                                 91200001
IOBDQSW  DS    B        FLAGS                                           91300001
IOBDQCP  EQU   BIT0          CHANNEL PROGRAM MODIFIED                   91400001
*                                                                       91500001
         IHADCB DSORG=DA                                                91600001
*                                                                       91700001
         IHADECB                                                        91800001
         SPACE                                                          92200001
         IHAECB                                                         92300001
*                                                                       92400001
         EJECT                                                          92402037
         CVT   DSECT=YES                                       @ZA08000 92404037
         EJECT                                                          92408037
         IGGSWA                                                @ZA08000 92410037
BUFFERB  DSECT          FORMAT OF BUFFER BEYOND SEGMENT AREA            92410437
BUFBFPTR DS    A        ADDRESS OF BEGINNING OF BUFFER                  92410837
BUFRECAR EQU   *        RECORD AREA; BUFBFPTR IS ALIGNED SO THAT        92411237
*                       BUFRECAR FALLS AS SPECIFIED BY DCBBFALN.        92411637
         EJECT                                                          92412037
         IGGBCB  TYPE=DAM                                        Y02072 92450002
         EJECT                                                          92500002
         IKJRB                                                   Y02072 93400002
         IGGFRWKA                                                Y02072 93450002
         EJECT                                                          95350002
         IGGUSL                                                  Y02072 95360002
         END                                                            97100001
