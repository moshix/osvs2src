 TITLE 'IGG019JB -- DYNAMIC BUFFERING MODULE, SIO  APPENDAGE'           00020002
IGG019JB CSECT                                                          00022002
*MODULE NAME = IGG019JB                                               * 00024002
*                                                                     * 00026002
*DESCRIPTIVE NAME = DYN BUF MODULE & SIO APPENDAGE FOR VS RECORD      * 00028002
*                   FORMAT AND VIRTUAL ADDRESS SPACE                  * 00028402
*                                                                     * 00028802
*COPYRIGHT = NONE                                                     * 00029202
*                                                                     * 00029602
*CHANGE ACTIVITY                                                      * 00029702
*                                                                     * 00029802
*        VS1-1 CHANGES/DELETIONS                                        00029902
*        VS2-1 CHANGES/DELETIONS                                        00034902
*        VS1-2 CHANGES/DELETIONS                                        00044902
*D094000                                                        XA00093 00057702
*        VS1-3 CHANGES/DELETIONS                                        00058102
*                                                                XM1559 00058502
*        VS2-2 CHANGES/DELETIONS                                        00059702
*001200,003000,005600,006200,006800,010400-011200,012600-032400,034200- 00061702
*042800,059600,064000,065800-066200,068800-070600,074200,081000,116800, 00063702
*122600-126600,130600-131200,131800,132600,133000,138800-139800,140400- 00065702
*154400,157200-157400,160800,161200-164200,165400,168800,180200-180600, 00065802
*183000-185200,187000-187400,191000-193600,195400-202600         Y02072 00069302
*                                                                     * 00071302
*STATUS CHANGE LEVEL 3                                                * 00071702
*                                                                     * 00072102
         IEZBITS                                                        00073002
*********************************************************************** 00076502
         USING *,RAPDBASE                                               00080001
SIOEP    B     SIORTNE            START I/O APPENDAGE E.P.              00100001
         ORG   IGG019JB+8                                               00140001
FRBUFEP  B     FBUFRTNE           FREE DYNAMIC BUFFER SVC E.P.          00160001
*********************************************************************** 00170002
*                                                                       00172002
*                                                                       00174002
*********************************************************************** 00176002
*  THE FOLLOWING TWO ENTRY POINTS ARE USED FOR PROCESSING OF THE      * 00178002
*  FREEDBUF ESTAE ROUTINE, IGCT005G.  THE FIRST ENTRY POINT (+12) IS  * 00178402
*  USED WHEN, IN THE ESTAE CLEANUP ROUTINE, IT IS DETERMINED THAT THE * 00178802
*  AUDIT TRAIL BIT INDICATING THAT THE NEXT IOB HAD BEEN TAKEN FROM   * 00179202
*  THE IOB QUEUE BUT THE CHANNEL PGM HAD NOT BEEN INITIALIZED YET     * 00179602
*  (WKAIOBQ BIT IS ON). IN THIS CASE ENTRY IS MADE TO INITIALIZE      * 00179702
*  THE CHANNEL PROGRAM AND ISSUE THE EXCP FOR THIS REQUEST.           * 00179802
*         THE SECOND ENTRY POINT (+16) IS USED WHEN THE NEXT IOB HAS  * 00179902
*  BEEN REMOVED FROM THE QUEUE, ITS CHANNEL PGM INITIALIZED, BUT THE  * 00186602
*  ABEND OCCURRED BEFORE THE EXCP WAS ISSUED (WKABUFAS BIT ON).IN THIS* 00188602
*  CASE ENTRY IS MADE TO ISSUE THE EXCP FOR THIS REQUEST.             * 00190602
*          INPUT FOR BOTH ENTRIES IS THE SAME:                        * 00192602
*                   REGISTER 2 = NEXT IOB ADDRESS                     * 00193002
*                   REGISTER 3 = BEGINNING ADDRESS OF THIS MODULE     * 00193102
*                   REGISTER 4 = DCB ADDRESS                          * 00193202
*                   REGISTER 5 = SVRB ADDRESS                         * 00199902
*                   REGISTER 6 = BUFFER ADDRESS                       * 00200302
*                   REGISTER 8 = TCB ADDRESS                          * 00201902
*                   REGISTER 15= BEGINNING ADDRESS OF THIS MODULE     * 00203902
*                   WKAREG14 IN SVRB WORKAREA IN INITIALIZED TO       * 00205902
*                                RETURN ADDRESS IN ESTAE              * 00206302
*  A THIRD ENTRY INTO THIS MODULE IS TAKEN BY ESTAE, IGCT005G, IF NO  * 00206402
*  AUDIT TRAIL BITS ARE SET AT ALL.  IN THIS CASE ENTRY IS THE SAME   * 00206502
*  AS FOR FREEDBUF (+8).  INPUT IS LIKEWISE THE SAME.                 * 00213202
*********************************************************************** 00215202
ESTENT1  B     ESTENTA                  INIT CH PGM, ISSUE EXCP  Y02072 00217202
*                                                                       00219202
ESTENT2  B     ESTENTB                  ISSUE EXCP               Y02072 00219602
*********************************************************************** 00219702
*                                                                     * 00219802
*                  REGISTER EQUATES                                     00219902
R0       EQU   0        INPUT REGISTER 0    SVC                         00226602
RWORK0   EQU   0        WORK REGISTER                                   00233302
R1       EQU   1        INPUT REGISTER 1                                00240001
RRQE     EQU   1        ADDRESS OF RQE                           Y02072 00250002
RLINK    EQU   1        INTERNAL LINKAGE REGISTER                Y02072 00252002
RWORK1   EQU   1        WORK REGISTER                                   00260001
RIOB     EQU   2        ADDRESS OF IOB                                  00280001
RBASE3   EQU   3        BASE REGISTER       SVC                         00320001
RDCB     EQU   4        ADDRESS OF DCB                                  00340001
RWORK4   EQU   4        WORK REGISTER                                   00360001
RSVRB    EQU   5        ADDRESS OF SVRB ON ENTRY FROM FREEDBUF   Y02072 00390002
RBUFFR   EQU   6        BUFFER ADDRESS                                  00400001
RSWA     EQU   6        PTR TO SEGMENT WORK AREA (ASSGNBUF)             00420001
RWORK6   EQU   6        WORK REGISTER                                   00440001
RDECB    EQU   7        DECB ADDRESS                                    00460001
RCCW     EQU   7        PTR TO CCW TO MODIFY (ASSGNBUF)                 00480001
RWORK7   EQU   7        WORK REGISTER                                   00500001
RTCB     EQU   8        TCB BASE REGISTER                        Y02072 00510002
RNEWLST  EQU   8        ADDR OF NEW UNSCHEDULED LIST                    00520001
RWORK9   EQU   9        WORK REGISTER                                   00540001
RWORK10  EQU   10       WORK REGISTER                                   00600001
RWORK11  EQU   11       WORK REGISTER                                   00640001
RWORK12  EQU   12       WORK REGISTER                                   00660001
RSAVE    EQU   13       ADDRESS OF IOS SAVEAREA                  Y02072 00710002
RWORK13  EQU   13       WORK REGISTER (EXTEND RTN)               Y02072 00712002
RRETURN  EQU   14       RETURN ADDRESS                                  00720001
RRETCODE EQU   15       RETURN CODE REGISTER                            00740001
RAPDBASE EQU   15       BASE REGISTER FOR APPENDAGE ROUTINES            00760001
RWORK15  EQU   15       WORK REGISTER                                   00780001
R15      EQU   15       SAVE/RESTORE REG                         Y02072 00790002
         SPACE 5                                                        00800001
KEYDATOP EQU   X'0E'         CCW OP-CODE  READ KEY & DATE               00820001
RDDATAOP EQU   X'06'         CCW OP-CODE  READ DATA                     00840001
NOP      EQU   X'03'         CCW OP-CODE                                00860001
SILI     EQU   BIT2          CCW FLAGS    SUPPRESS INCORRECT            00880001
*                                         LENGTH INDICATION             00900001
*                                                                       00920001
IC       EQU   B'0001'       MASK FOR ICM, INSERTS 1 BYTE INTO          00940001
*                            LOW ORDER BYTE OF REGISTER                 00960001
ADDR     EQU   B'0111'       MASK FOR ICM/STCM, INSERTS OR              00980001
*                            STORES A 24-BIT ADDRESS TO OR FROM         01000001
*                            THE LOW-ORDER 3 BYTES OF A REGISTER.       01020001
FIXERR   EQU   8             RETURN CODE IF GETMAIN FAILS FOR           01140001
*                            EXTEND FUNCTION                            01160002
*                                                                       01220001
         EJECT                                                          01240001
*                                                                       03480001
SIORTNE  EQU   *                                                        04300001
*                                                                     * 04320001
* FUNCTION:                                                           * 04340001
*    THE START-I/O APPENDAGE ATTEMPTS TO ASSIGN A BUFFER TO A         * 04360001
*    READ REQUEST IF THE REQUEST SPECIFIES DYNAMIC BUFFERING AND      * 04380001
*    NO BUFFER WAS ASSIGNED BEFORE EXCP.  IF A BUFFER IS              * 04400001
*    AVAILABLE FOR ASSIGNMENT, IT IS REMOVED FROM THE BUFFER          * 04420001
*    POOL AND THE BUFFER CHAIN IS UPDATED.  THE BUFFER ADDRESS        * 04440001
*    IS PLACED IN THE REQUEST'S DECB AND IN THE READ CCWS OF THE      * 04460001
*    REQUEST'S CHANNEL PROGRAM.  THE ADDRESS OF THE SEGMENT WORK      * 04480001
*    AREA (PART OF THE BUFFER) IS PLACED IN THE IOB.  THE ROUTINE     * 04500001
*    THEN RETURNS TO IOS TO INITIATE THE I/O.                         * 04520001
*    IF NO BUFFER IS AVAILABLE THE REQUEST IS PLACED ON A QUEUE       * 04540001
*    OF REQUESTS WAITING FOR BUFFERS.  THE ROUTINE TAKES THE IOS      * 04560001
*    RETURN WHICH INDICATES THAT THE I/O REQUEST SHOULD NOT BE        * 04580001
*    INITIATED.                                                       * 04600001
*    IF NO BUFFER IS AVAILABLE AND THE ADDRESS OF THE IOB FOR         * 04620001
*    THIS REQUEST CANNOT BE PLACED ON THE CURRENT UNSCHEDULED         * 04640001
*    LIST, THE CHANNEL PROGRAM IS MODIFIED TO PREVENT DATA            * 04660001
*    TRANSFER AND THE NORMAL RETURN TO IOS IS TAKEN.  THE             * 04680001
*    CHANNEL END APPENDAGE WILL SCHEDULE THE ASYNCHRONOUS             * 04700001
*    ROUTINE, WHICH WILL EXTEND THE UNSCHEDULED LIST IF NECES-        * 04720001
*    SARY, AND WILL RE-ISSUE THE EXCP.                                * 04740001
*                                                                     * 04760001
* ENTRY POINT:                                                        * 04780001
*         SIOEP -- ENTERED ASYNCHRONOUSLY FROM IOS AT START-I/O       * 04800001
*         TIME.  THE ADDRESS OF IGG019JB IS PLACED IN THE             * 04820001
*         APPENDAGE VECTOR TABLE (AVT) DURING OPEN PROCESSING.        * 04840001
*         CALLING SEQUENCE -- L     15,4(AVTPTR)                      * 04860001
*                             BALR  14,15                             * 04880001
*                                                                     * 04900001
* INPUT                                                               * 04920001
*    **** REGISTER CONTENTS ****                                      * 04940001
*    REGISTER  1 -- REQUEST QUEUE ELEMENT (RQE) ADDRESS               * 04950002
*    REGISTER  2 -- INPUT/OUTPUT BLOCK (IOB) ADDRESS                  * 04960001
*    REGISTER  3 -- DATA EXTENT BLOCK (DEB) ADDRESS                   * 04980001
*    REGISTER  4 -- DATA CONTROL BLOCK (DCB) ADDRESS                  * 05000001
*    REGISTER  7 -- UNIT CONTROL BLOCK (UCB) ADDRESS                  * 05020001
*    REGISTER 13 -- IOS REGISTER SAVEAREA                       Y02072* 05030002
*    REGISTER 14 -- RETURN ADDRESS                                    * 05040001
*    REGISTER 15 -- ADDRESS OF IGG019JB                               * 05060001
*                                                                     * 05080001
* OUTPUT                                                              * 05100001
*    **** REGISTER CONTENTS ****                                      * 05120001
*    ALL REGISTER CONTENTS ARE UNCHANGED                              * 05140002
*                                                                     * 05240001
*    **** DATA AREAS SET BY THIS ROUTINE ****                         * 05260001
*    IOBSWAP            IF A BUFFER IS ASSIGNED, SEGMENT WORK         * 05280001
*                       AREA ADDRESS                                  * 05300001
*    IOBDSTAT BIT IOBBUFF    SET IF A BUFFER IS ASSIGNED              * 05320001
*    IOBDQSW,IOBDQCP    SET IF NO BUFFER IS AVAILABLE & THERE IS      * 05340001
*                       NO ROOM ON THE CURRENT UNSCHEDULED LIST       * 05360001
*                       FOR THE IOB ADDRESS. -- CHANNEL PGM MODIFIED  * 05380001
*    USLBFRQB           UPDATED IF REQUEST IS PLACED ON QUEUE         * 05400001
*                       TO WAIT FOR BUFFER                            * 05420001
*    USLBFRQT           UPDATED IF THIS REQUEST IS THE ONLY ONE ON    * 05440001
*                       THE QUEUE WAITING FOR A BUFFER.               * 05460001
*    BCBBFAVL           UPDATED IF A BUFFER IS ASSIGNED               * 05480001
*    DECAREA            DATA ADDR IN THE ASSIGNED BUFFER              * 05500001
*    DECKYADR           KEY ADDR IN THE ASSIGNED BUFFER FOR A READ    * 05520001
*                       BY BLOCK ID, & KEY ADDR SPECIFIED 'S'.        * 05540001
*    DECARB1            SAVEAREA FOR OP-CODE OF CCW1 IF CHANNEL       * 05560001
*                       PROGRAM IS MODIFIED.                          * 05580001
*    DECARB2            SAVEAREA FOR FLAGS OF CCW1 IF CHANNEL         * 05600001
*                       PROGRAM IS MODIFIED.                          * 05620001
*    NEXT-TO-LAST CCW ADDR   KEY ADDR WHEN KEY IS IN DYNAMIC BUFFER   * 05640001
*                            (SEE DECKYADR).                          * 05660001
*    LAST CCW ADDR      DATA ADDR                                     * 05680001
*                                                                     * 05700001
* EXITS                                                               * 05720001
*         0(R14)        RETURN TO IOS & START I/O                     * 05740001
*         4(R14)        RETURN TO IOS & DISREGARD I/O REQUEST         * 05760001
*                                                                     * 05780001
* ATTRIBUTES -- REENTRANT,PRIVILEGED,KEY=0,ENABLED, WITH THE LOCAL    * 05800002
*    LOCK HELD. MODESET IS ISSUED TO PROCESS IN USER KEY.             * 05810002
*********************************************************************** 05820002
****                                                               **** 05900002
         USING IOBSTDRD,RIOB                                            05920001
         USING IHADCB,RDCB                                              05940001
         TM    IOBDTYP2,IOBRQUST  IS THIS A READ REQUEST?               05952002
         BCR   8,RRETURN          IF NOT, RETURN TO IOS                 05954002
         TM    IOBDTYPE,IOBDYNBF  DOES REQUEST SPECIFY DYNAMIC          05956002
*                                 BUFFERING?                            05958002
         BCR   8,RRETURN          IF NO, RETURN TO IOS                  05958402
         TM    IOBSTAT1,IOBBUFF   HAS A BUFFER BEEN ASSIGNED TO         05958802
*                                 THIS REQUEST?                         05959202
         BCR   1,RRETURN          IF SO, RETURN TO IOS                  05959602
*                                                                       06020001
*                       IF A BUFFER IS AVAILABLE, ASSIGN IT TO          06040001
*                       THIS REQUEST AND UPDATE THE BUFFER POOL.        06060001
*                                                                       06080001
         STM   R0,R15,0(RSAVE)          SAVE IOS REGISTERS       Y02072 06090002
         USING RQE,RRQE                 ESTABLISH RQE BASE       Y02072 06092002
*                                                                       06094002
         MODESET  KEYADDR=RQEPRT,WORKREG=10  CHANGE TO USER KEY  Y02072 06096002
*                                                                       06098002
         L     RWORK10,DCBBUFCB         GET BUFFER CONTROL BLOCK ADDR   06100002
         USING BCBDEFV,RWORK10          ESTABLISH BASE FOR BCB   Y02072 06120002
         SR    RWORK11,RWORK11                                          06140001
         ICM   RWORK11,IC,BCBBFAVL      GET BUFFER NUMBER FOR NEXT      06160002
*                                       AVAILABLE BUFFER                06180002
         BZ    PTONBUFQ           IF NONE AVAILABLE, BRANCH TO          06200001
*                                 PUT REQUEST ON QUEUE                  06220001
         IC    RWORK9,BCBSUFFX-1(RWORK11)   GET NUMBER OF 2ND           06240001
*                                 AVAILABLE BUFFER.                     06260001
         STC   RWORK9,BCBBFAVL    MAKE IT THE NEXT AVAILABLE            06280001
*                                                                       06300001
*                                 COMPUTE ADDR OF THE BUFFER TO         06320001
*                                 BE ASSIGNED.                          06340001
*                                                                       06360001
         BCTR  RWORK11,0          BUFFER NUMBER - 1.                    06380001
         L     RWORK7,BCBBUFL     LENGTH OF EACH BUFFER                 06420001
         MR    RWORK6,RWORK11     BUFFER # -1 * BUFFER LENGTH           06440001
*                                 = DISPLACEMENT INTO BUFFER POOL       06460001
         LR    RWORK11,RWORK7                                           06480001
         A     RWORK11,BCBBUF1    + ADDR OF BUFFER #1 = BUFFER          06500001
*                                 ADDR.                                 06520001
         DROP  RWORK10,RRQE                                      Y02072 06540002
         BAL   RLINK,ASSGNBUF     ASSIGN BUFFER TO REQUEST              06560001
*                                                                       06600001
SIORET   EQU   *                        RETURN TO IOS            Y02072 06610002
*                                                                       06612002
         MODESET  KEYADDR=IOSKEY,WORKREG=10  CHANGE TO IOS KEY   Y02072 06614002
*                                                                       06616002
         LM    R0,R15,0(RSAVE)          LOAD IOS REGISTERS       Y02072 06618002
         BR    RRETURN                  RETURN TO IOS TO INITIATE       06618402
*                                       I/O REQUEST                     06618802
         SPACE 5                                                        06680001
PTONBUFQ EQU   *                                                        06700001
*                                                                       06720001
*                       NO BUFFER WAS AVAILABLE. PUT THIS IOB ON        06740001
*                       THE QUEUE WAITING FOR BUFFERS.                  06760001
*                                                                       06780001
*                                                                       06820001
         L     RWORK11,DCBDYNB    ADDR OF CURRENT LIST                  06840001
         USING USL,RWORK11                                              06860001
*                                                                       07080001
*                       PUT IOB ADDR ON THE UNSCHEDULED LIST            07100001
*                                                                       07120001
         L     RWORK10,USLBFRQB   ADDR OF LAST LIST SLOT USED           07140002
         LTR   RWORK10,RWORK10    ANY USED?                             07160001
         BZ    EMPTYQ             BRANCH IF NONE                        07180001
         USING USLSLOT,RWORK10                                          07200001
         TM    USLSLTFL,USLENDL   IS LAST ONE END OF LIST ?             07220001
         BZ    BUMP               BRANCH IF NOT                         07240001
         LA    RWORK10,USLSLOT1-4 LOOP TO POINT TO 1ST SLOT             07260001
BUMP     LA    RWORK10,USLNXT     POINT TO NEXT SLOT                    07280001
         TM    USLSLTFL,USLINUSE  IS THIS SLOT ALREADY IN USE?          07300001
         BO    RECOUP             BRANCH YES, LIST IS FULL              07320001
*                                                                       07340001
STIOBADR ST    RWORK10,USLBFRQB   THIS SLOT IS LAST USED                07360001
         STCM  RIOB,ADDR,USLIOBA+1     PLACE IOB ADDR IN SLOT           07380001
         OI    USLSLTFL,USLINUSE  MARK SLOT NOT AVAILABLE               07400001
         DROP  RWORK10                                                  07402002
*                                                                       07410002
         MODESET  KEYADDR=IOSKEY,WORKREG=10  CHANGE TO IOS KEY   Y02072 07430002
*                                                                       07432002
         LM    R0,R15,0(RSAVE)          LOAD IOS REGISTERS       Y02072 07434002
         B     4(RRETURN)               IOS RETURN - DON'T DO I/O       07440002
*                                                                       07460001
EMPTYQ   LA    RWORK10,USLSLOT1   USE FIRST SLOT ON LIST                07480001
*                                 TOP SLOT IS FIRST ON QUEUE            07500001
         STCM  RWORK10,ADDR,USLBFRQT+1                                  07520001
         B     STIOBADR                                                 07540001
         DROP  RWORK11                                                  07580001
*                                                                       07600001
*                       THE IOB ADDRESS CANNOT BE PLACED ON THE         07620001
*                       CURRENT UNSCHEDULED LIST BECAUSE THE            07640002
*                       LIST IS FULL.                                   07680001
*                       MODIFY THE CHANNEL PROGRAM SO THAT NO           07700001
*                       DATA IS TRANSFERRED. THE CHANNEL                07720001
*                       PROGRAM WILL BE REPAIRED AND THE EXCP           07740001
*                       WILL BE REISSUED BY THE ASI ROUTINE.            07760001
*                                                                       07780001
RECOUP   L     RWORK10,IOBECBPT   GET DECB ADDRESS                      07800001
         USING DECB,RWORK10                                             07820001
         IC    RWORK9,IOBCHNPR    SAVE OP-CODE OF CCW1                  07840001
         STC   RWORK9,DECARB1                                           07860001
         MVI   IOBCHNPR,NOP       SET OP-CODE TO NOP                    07880001
         IC    RWORK9,IOBCHNPR+4  SAVE FLAGS OF CCW1                    07900001
         STC   RWORK9,DECARB2                                           07920001
         MVI   IOBCHNPR+4,SILI    SUPPRESS INCORRECT LENGTH FLAG        07940001
         OI    IOBDQSW,IOBDQCP    CHANNEL PGM HAS BEEN ALTERED          07960001
         B     SIORET             TAKE NORMAL IOS RETURN                07980001
*                       (MUST GET TO CEA TO SCHEDULE ASI)               08000001
         DROP  RWORK10                                                  08020001
         DROP  RIOB                                                     08040001
         DROP  RDCB                                                     08060001
*                                                                       08080001
         EJECT                                                          08120001
*                                                                       08140001
*                  THIS SUBROUTINE IS USED BY THE START-I/O             08160001
*                  APPENDAGE AND THE FREE DYNAMIC BUFFER SVC            08180001
*                  ROUTINE. IT IS ENTERED IN USER KEY.                  08200002
*                  IT ASSIGNS A BUFFER TO AN I/O REQUEST BY             08220001
*                  PLACING THE BUFFER ADDRESS INTO THE DECB             08240001
*                  AND THE CHANNEL PROGRAM.  IT ALSO PLACES THE         08260001
*                  SEGMENT WORK AREA ADDRESS IN THE IOB.                08280001
*                                                                       08300001
*              REGISTER INPUT:  RIOB    - ADDR OF IOB TO WHICH          08320001
*                                         BUFFER WILL BE ASSIGNED       08340002
*                               RDCB    - DCB ADDRESS                   08360001
*                               RWORK11 - BUFFER ADDRESS                08380001
*                               RLINK   - RETURN ADDRESS                08400001
*              REGISTER OUTPUT: RSWA    - WORK REGISTER                 08420001
*                               RWORK9  - WORK REGISTER                 08440001
*                               RCCW    - WORK REGISTER                 08460001
*                               RWORK10 - WORK REGISTER                 08480001
*                               RWORK11 - WORK REGISTER                 08500001
         USING SWA,RWORK11        ESTABLISH BASE FOR SEG WRKAREA Y02072 08520002
         USING IHADCB,RDCB                                              08540001
         USING IOBSTDRD,RIOB                                            08560001
ASSGNBUF L     RWORK9,IOBECBPT    GET DECB ADDRESS                      08580001
         USING DECB,RWORK9                                              08600001
*                                 PLACE SWA ADDR IN IOB                 08620001
         LR    RWORK10,RIOB       PLACE IOB ADDRESS IN WORK REG         08640001
         LA    RSWA,IOBSTDRD-IOBSWAP   DISP TO IOBSWAP FIELD            08660001
         SR    RWORK10,RSWA       POINT TO IOB PREFIX                   08680001
         USING IOBSWAP,RWORK10                                          08700001
         ST    RWORK11,IOBSWAP    PLACE SWA ADDR IN IOB                 08720001
*                                 DATA & KEY (IF REQUESTED) WILL        08740001
*                                 BE READ INTO THE SEGMENT AREA         08760001
*                                 OF THE DYNAMIC BUFFER.  THE           08780001
*                                 USER WILL BE PASSED THE ADDRESS       08800001
*                                 OF LOCATIONS IN THE RECORD            08820001
*                                 AREA.                                 08840001
*                                                                       08860001
         LA    RSWA,SWASEGMT      GET ADDRESS OF SEGMENT AREA    Y02072 08880002
*                                                                       08900001
         L     RWORK10,DCBBUFCB   ADDRESS BUFFER CONTROL BLOCK          08920001
         USING BCBDEFV,RWORK10    ESTABLISH BASE FOR BCB         Y02072 08940002
         L     RWORK10,BCBRAOFS-1 GET DISPLACEMENT OF RECORD            08960001
         DROP  RWORK10            AREA FROM START OF BUFFER.            08980001
         LA    RWORK11,0(RWORK10,RWORK11)        ADDR OF RECORD AREA    09000001
*                                                                       09020001
         L     RCCW,IOBDCPND      POINT BEYOND LAST CCW                 09040001
         SH    RCCW,H16           POINT TO NEXT-TO-LAST CCW             09060001
*                                 FOR A READ BY BLOCK ID, KEY           09080001
*                                 CODED 'S', THE KEY IS READ            09100001
*                                 INTO THE DYNAMIC BUFFER.              09120001
         TM    IOBDTYP2,IOBTYPE   IS THIS READ BY BLOCK ID?             09140001
         BO    FILLSCCW           BRANCH IF NO                          09160001
         TM    IOBDTYP2,IOBSKEY   WAS KEY ADDRESS CODED 'S'?            09180001
         BZ    FILLSCCW           BRANCH IF NO                          09200001
         ST    RWORK11,DECKYADR   PLACE KEY ADDRESS IN DECB             09220001
         CLI   DCBKEYLE,0         IS KEY LENGTH ZERO             XM1559 09230002
         BE    FILLSCCW           BR IF YES                      XM1559 09232002
         ST    RWORK11,0(RCCW)    PLACE ADDR OF KEY IN RECORD   XA00093 09240001
*                                 AREA INTO NEXT-TO-LAST CCW.           09260001
         MVI   0(RCCW),KEYDATOP   RESTORE OP-CODE                       09280001
*                                 INCREMENT RECORD AREA & SEGMENT       09300001
*                                 AREA POINTERS BEYOND KEY.             09320001
         SR    RWORK10,RWORK10                                          09340001
         IC    RWORK10,DCBKEYLE   GET LENGTH OF KEY                     09360001
         AR    RWORK11,RWORK10    BUMP RECORD AREA POINTER              09380001
*                                                                       09420001
FILLSCCW ST    RWORK11,DECAREA    PLACE DATA ADDRESS IN DECB            09440001
         ST    RSWA,8(RCCW)       PLACE DATA ADDRESS IN LAST CCW        09460001
         MVI   8(RCCW),RDDATAOP   RESTORE OP-CODE.                      09480001
         OI    IOBDSTAT,IOBBUFF   SET BUFFER-ASSIGNED SWITCH            09500001
         BR    RLINK              RETURN TO CALLER                      09520001
         DROP  RWORK11                                                  09540001
         DROP  RWORK9                                                   09560001
         DROP  RIOB                                                     09580001
         DROP  RDCB                                                     09600001
         EJECT                                                          09620001
FBUFRTNE EQU   *                                                        09640001
*                                                                     * 09660001
* FUNCTION:                                                           * 09680001
*    THE FREE DYNAMIC BUFFER ROUTINE RELEASES A DYNAMIC BUFFER.       * 09700001
*    IF ANY IOBS ARE ON THE UNSCHEDULED QUEUE (WAITING FOR A          * 09720001
*    BUFFER) THE ROUTINE ASSIGNS THE BUFFER TO THE FIRST IOB ON       * 09740001
*    THE QUEUE, AND ISSUES AN EXCP FOR THAT IOB.  IF NO IOBS ARE      * 09760001
*    ON THE UNSCHEDULED QUEUE THE ROUTINE PLACES THE BUFFER ON        * 09780001
*    THE CHAIN OF AVAILABLE BUFFERS.                                  * 09800001
*    THE EXTEND-LIST FUNCTION IS ALSO CALLED VIA THE FREE DYNAM-      * 09820001
*    IC BUFFER SVC.  IT GETS STORAGE FOR AN UNSCHEDULED LIST          * 09840001
*    WHICH IS TWICE AS LARGE AS THE PREVIOUS LIST.  IT INITIALIZES    * 09860001
*    THE NEW LIST (AND MOVES ALL ENTRIES FROM THE OLD LIST TO         * 09880001
*    THE NEW LIST) AND PLACES ITS ADDRESS IN DCBDYNB.                 * 09900001
*                                                                     * 09920001
* ENTRY POINT:                                                        * 09940001
*         FRBUFEP -- ENTERED FROM MODULE IGC0005G WHEN SVC 57 IS      * 09960001
*         ISSUED FOR A DCB WHICH SPECIFIED DIRECT ORGANIZATION.       * 09980001
*         CALLING SEQUENCE -- L    15,DCBDEBAD                        * 10000001
*                             L    15,DEBAPPAD                        * 10020001
*                             L    15,4(15)                           * 10040001
*                             BAL  14,8(15)                           * 10060001
*                                                                     * 10080001
* INPUT                                                               * 10100001
*    **** REGISTER CONTENTS ****                                      * 10120001
*    REGISTER  0 -- DECB ADDRESS                                      * 10140001
*                  R0 IS NEGATIVE FOR THE EXTEND-LIST FUNCTION.       * 10160001
*    REGISTER  1 -- DCB ADDRESS                                       * 10180001
*    REGISTER  5 -- ADDRESS OF SVRB                                   * 10190002
*    REGISTER  8 -- ADDRESS OF TCB PASSED BY FREEDBUF                 * 10192002
*    REGISTER 14 -- RETURN ADDRESS                                    * 10220001
*    REGISTER 15 -- ADDRESS OF IGG019JB                               * 10240001
*                                                                     * 10260001
* OUTPUT                                                              * 10280001
*    **** REGISTER CONTENTS ****                                      * 10300001
*    ALL REGISTERS EXCEPT REGISTER 14 CAN BE USED WITHOUT SAVING      * 10320001
*    OR RESTORING CONTENTS.                                           * 10340001
*    REGISTER 15 CONTAINS RETURN CODE.                                * 10360001
*                                                                     * 10380001
*    **** DATA FIELDS SET BY THIS ROUTINE ****                        * 10400001
*    USLBFRQT      IF AN IOB IS WAITING FOR A BUFFER, PTR TO 1ST      * 10420001
*                  IOB ON QUEUE IS UPDATED.                           * 10440001
*    USLBFRQB      IF, AFTER 1 IOB IS DEQUEUED, THE LIST IS EMPTY,    * 10460001
*                  USLBFRQB IS SET TO ZERO.                           * 10480001
*    IF THE FREED BUFFER IS ASSIGNED TO A WAITING REQUEST, THE        * 10500001
*    BUFFER ADDRESS IS PLACED IN THE CHANNEL PROGRAM AND DECB         * 10520001
*    FIELDS, AND IN THE IOB AS THE SEGMENT WORK AREA ADDRESS (SEE     * 10540001
*    SIORTNE DESCRIPTION FOR DETAILS).                                * 10560001
*    SWABFINC      SET TO ZERO                                        * 10580002
*    BCBBFAVL      IF THE BUFFER IS NOT ASSIGNED TO A REQUEST,        * 10600001
*                  ITS NUMBER IS PLACED IN BCBBFAVL.  THE             * 10620001
*                  CORRESPONDING BYTE OF THE BUFFER POOL SUFFIX       * 10640001
*                  WILL POINT TO THE SECOND AVAILABLE BUFFER.         * 10660001
*    DCBDYNB       FOR THE EXTEND FUNCTION, POINTS TO NEW LIST.       * 10680001
*            THE LIST IS INITIALIZED AS FOLLOWS:                      * 10700002
*    USLSIZE       LIST SIZE IN BYTES -- 2* OLD LIST SIZE             * 10720001
*    USLFLAGS      BIT USLCURNT SET IN NEW LIST, TURNED OFF IN        * 10740001
*                  OLD LIST.                                          * 10760001
*    USLBFRQT      THE IOB ADDRESSES ARE ARRANGED SUCH THAT THE       * 10780001
*                  ADDR OF THE 1ST IOB ON THE OLD LIST IS COPIED      * 10800001
*                  INTO THE TOP SLOT ON THE NEW LIST.  IF NO          * 10820001
*                  IOBS ARE ON THE LIST, SET TO ZERO.                 * 10840001
*    USLBFRQB      ADDR OF SLOT USED BY LAST IOB ON QUEUE (OR 0       * 10860001
*                  IF THERE ARE NONE.)                                * 10880001
*    USLCHAIN      ADDRESS OF PRIOR LIST COPY                         * 10900001
*    IOBDQSW, BIT IOBDQEXT   RESET ON COMPLETION OF EXTEND            * 10920001
*    SVRB          SEE BELOW                                            10930002
*                                                                     * 10940001
* EXTERNAL REFERENCES                                                 * 10960001
*        EXCP CALL TO IOS                                             * 10980001
*        GETMAIN FOR NEW UNSCHEDULED LIST (EXTEND FUNCTION)           * 11000001
*        MODESET   TO CHANGE BETWEEN SUPERVISOR AND USER KEYS         * 11020002
*        SETLOCK   TO RELEASE AND OBTAIN THE LOCAL LOCK               * 11030002
*                                                                     * 11140001
* EXITS, NORMAL                                                       * 11160001
*    BRANCH RETURN TO IGC0005G ON REGISTER 14.  RETURN CODE (R15)     * 11180001
*    = 0.                                                             * 11200001
*                                                                     * 11220001
* EXITS, ERROR                                                        * 11240001
*     BRANCH RETURN TO IGC0005G ON REGISTER 14.  RETURN CODE (R15)    * 11260001
*     = 8.  THE BUFFER HAS NOT BEEN FREED, OR THE UNSCHEDULED         * 11280001
*     LIST HAS NOT BEEN EXTENDED.  THIS CAN OCCUR AS A RESULT OF      * 11300001
*     GETMAIN FOR THE NEW UNSCHEDULED LIST CANNOT BE SATISFIED.       * 11340002
*                                                                     * 11380001
* TABLES / WORK AREAS                                                 * 11400001
*        IOB, DCB, DECB, BUFFER CONTROL BLOCK                         * 11420001
*        UNSCHEDULED LIST, & SVRB EXTENDED SAVEAREA                   * 11440001
*                                                                     * 11460001
* ATTRIBUTES -- REENTRANT, PRIVILEGED. ENTRY IS IN SUPERVISOR KEY     * 11480002
*        WITHOUT THE LOCAL LOCK HELD. RETURN TO IGC0005G IS IN        * 11490002
*        SUPERVISOR KEY. MOST PROCESSING IS IN USER KEY.              * 11500002
*                                                                     * 11512002
* NOTES -- THE ROUTINE MUST HAVE THE LOCAL LOCK TO UPDATE THE SERIALLY* 11520002
*        REUSABLE IOB AND BUFFER QUEUES. SETLOCK WILL BE ISSUED THEN. * 11540002
*                                                                     * 11640001
*****                                                             ***** 11650002
         EJECT                                                          11686602
         LR    RBASE3,RAPDBASE    ESTABLISH BASE REGISTER               11720001
         USING IGG019JB,RBASE3                                          11740001
         DROP  RAPDBASE                                                 11760001
         LR    RDCB,R1            TRANSFER DCB ADDRESS                  11780001
         USING IHADCB,RDCB                                              11800001
         USING RBSECT,RSVRB       ESTABLISH BASE FOR SVRB        Y02072 11810002
         ST    RRETURN,WKAREG14   SAVE RETURN REGISTER                  11810402
         USING TCB,RTCB           ESTABLISH BASE FOR TCB         Y02072 11814002
*                                 PASSED BY FREEDBUF IN R8       Y02072 11816002
*                                                                       11818002
         MODESET  KEYADDR=WKASVKEY,WORKREG=6  CHANGE TO USER KEY Y02072 11818402
*                                                                       11818802
         LTR   RDECB,R0           TEST FOR SPECIAL FUNCTION             11820002
         BNP   EXTEND             BRANCH YES                            11840001
         USING DECB,RDECB                                               11860001
*                                                                       11880001
*                       LOCATE THE BEGINNING ADDRESS OF THE             11900001
*                       BUFFER BEING FREED.                             11920001
*                                                                       11940001
         L     RBUFFR,DECAREA     ASSUME RECORD AREA ADDR = DATA        11960001
*                                 ADDR                                  11980001
         TM    DECTYPE2,DECKEYS   WAS KEY IN BUFFER (CODED 'S')?        12000001
         BZ    FBU0500            BRANCH NO                             12020001
         L     RBUFFR,DECKYADR    RECORD AREA ADDR = KEY ADDR           12040001
FBU0500  EQU   *                                                        12060001
         LA    RWORK12,BUFRECAR-BUFBFPTR                                12080001
         SR    RBUFFR,RWORK12     POINT TO ADDR OF BEGINNING OF         12100001
*                                 BUFFER                                12120001
         L     RBUFFR,0(RBUFFR)         GET BUFFER ADDRESS              12140002
         USING SWA,RBUFFR               ESTABLISH BASE FOR SWA   Y02072 12160002
         XC    SWABFINC,SWABFINC        RECORD AREA OFFSET PTR   Y02072 12180002
         L     RWORK10,DCBDYNB          ADDR OF UNSCHEDULED LIST Y02072 12190002
         USING USL,RWORK10              USL ADDRESSABILITY       Y02072 12192002
         L     RWORK12,DCBBUFCB         GET BCB ADDRESS          Y02072 12194002
         USING  BCBDEFV,RWORK12         BCB ADDRESSABILITY       Y02072 12196002
*                                                                       12200001
*   PREPARE FOR QUEUE UPDATES. THIS REQUIRES THAT THE LOCAL LOCK BE     12220002
*   OBTAINED WHILE MANIPULATING THE QUEUE. IT IS RELEASED WHEN THE      12240002
*   QUEUE HAS BEEN UPDATED AND THE NEXT WAITING IOB HAS BEEN REMOVED,   12250002
*   OR THE BUFFER HAS BEEN PUT BACK ON THE AVAILABLE BUFFER QUEUE.      12260002
*   MODESET IS ISSUED BECAUSE SETLOCK REQUIRES SUPERVISOR KEY.          12270002
*   SETLOCK USES REGISTERS 11-14 WITHOUT RESTORING THEM. CERTAIN        12280002
*   FIELDS WILL BE SAVED AT THIS POINT SHOULD THE ESTAE NEED THEM.      12282002
*                                                                       12290002
         IC    RWORK9,BCBBFAVL          GET NEXT AVAIL BUF NO    Y02072 12300002
*                                       FOR ESTAE- 1 BYTE        Y02072 12310002
         DROP  RWORK12                  DROP BCB BASE            Y02072 12320002
         L     RWORK0,USLBFRQT          GET USL CONTENTS FOR     Y02072 12330002
*                                       ESTAE - IN USER KEY      Y02072 12332002
*                                                                       12334002
         MODESET  EXTKEY=ZERO           CHANGE TO SUPER KEY      Y02072 12336002
*                                       TO GET THE LOCAL LOCK    Y02072 12338002
*                                                                       12338402
GETLOCK  SETLOCK  OBTAIN,TYPE=LOCAL,RELATED=('BUFFERQ,IGG019JB(FREELOCKX12338802
               ,FREELCK1)'),MODE=UNCOND  GET THE LOCAL LOCK      Y02072 12339202
*                                                                       12339602
         ST    RBUFFR,WKABUFRG          SAVE BUF PTR FOR ESTAE   Y02072 12339702
         ST    RWORK0,WKASAVE           SAVE USL CONTENT IN SVRB Y02072 12339802
         STC   RWORK9,WKASAVE2          SAVE NEXT AVAIL BUF NO.  Y02072 12339902
*                                       FOR ESTAE IN CASE PATH   Y02072 12343202
*                                       TAKEN CHANGES THIS       Y02072 12345202
*                                                                       12345602
         MODESET  KEYADDR=WKASVKEY,WORKREG=11 RET TO USER KEY    Y02072 12346002
*                                                                       12346402
         ICM   RWORK9,ADDR,USLBFRQT+1   PTR TO 1ST IOB ON QUEUE         12680001
         BZ    FBUNOREQ                 BRANCH IF NO IOBS TO MAKE       12700002
*                                       BUFFER AVAILABLE                12720002
         USING USLSLOT,RWORK9                                           12740001
         L     RIOB,USLSLOT             GET IOB ADDRESS                 12760002
         USING IOBSTDRD,RIOB                                            12780001
*                                                                       12790002
         MODESET  EXTKEY=ZERO           CHANGE TO ZERO KEY       Y02072X12792002
                                        TO SAVE IOB PTR          Y02072 12794002
         ST    RIOB,WKAIOBRG            SAVE IOB PTR FOR ESTAE   Y02072 12798002
*                                                                       12798402
         MODESET  KEYADDR=WKASVKEY,WORKREG=11  RET TO USER KEY   Y02072 12798802
*                                                                       12799202
         NI    USLSLTFL,X'FF'-USLINUSE  MAKE SLOT AVAILABLE             12800001
         TM    USLSLTFL,USLENDL   IS THIS LAST SLOT IN LIST?            12820001
         BZ    NXTSLT             BRANCH IF NO                          12840001
         LA    RWORK9,USLSLOT1-4 GET BACK TO TOP OF LIST                12860001
NXTSLT   LA    RWORK9,USLNXT      BUMP SLOT POINTER 1 ENTRY             12880001
         TM    USLSLTFL,USLINUSE  IS THERE ANOTHER IOB WAITING?         12900001
         BO    STOREPTR           BRANCH IF YES                         12920001
         DROP  RWORK9                                                   12930002
         SR    RWORK9,RWORK9                                            12940001
         ST    RWORK9,USLBFRQB          MARK QUEUE EMPTY BY SETTING     12980002
*                                       TOP & BOTTOM PTRS TO ZERO.      13000002
STOREPTR STCM  RWORK9,ADDR,USLBFRQT+1   SLOT OF FIRST IOB (OR 0)        13020002
         DROP  RWORK10                                           Y02072 13030002
*                                                                       13040001
         MODESET  EXTKEY=ZERO           CHANGE TO ZERO KEY       Y02072X13050002
                                        TO SET BIT IN SVRB       Y02072X13052002
                                        AND RELEASE LOCAL LOCK   Y02072 13052102
         MVI   WKATRAIL,WKAIOBQ         SET BIT IN SVRB EXT SAVE Y02072 13052602
*                                       AREA INDICATING IOB DEQ  Y02072 13052702
*                                                                       13053402
FREELOCK SETLOCK  RELEASE,TYPE=LOCAL,RELATED=('BUFFERQ,IGG019JB(GETLOCKX13053702
               )')                      FREE THE LOCAL LOCK      Y02072 13053802
*                                                                       13055802
ESTENTA  EQU   *                        ESTAE ENTRY IF WKAIOBQ=1 Y02072 13056002
*                                                                       13056402
         MODESET  KEYADDR=WKASVKEY,WORKREG=11  RET TO USER KEY   Y02072 13058002
*                                                                       13058402
         LR    RAPDBASE,RBASE3          LOAD BASE FOR COMMON SUBRTNE    13140002
         LR    RWORK11,RBUFFR           PUT BUFFER ADDR IN R11          13160002
         BAL   RLINK,ASSGNBUF           ASSIGN THE BUFFER TO THE        13220002
*                                       DEQUEUED IOB.                   13240002
*                                                                       13254002
         MODESET  EXTKEY=ZERO           CHANGE TO ZERO KEY       Y02072X13256002
                                        TO SET BIT IN SVRB       Y02072 13258002
         MVI   WKATRAIL,WKABUFAS        SET BIT IN SVRB EXTENDED Y02072 13258402
*                                       SAVEAREA INDICATING BUF  Y02072 13258802
*                                       ASSIGNED TO NEXT IOB     Y02072 13259202
ESTENTB  EQU   *                        ESTAE ENTRY IF WKABUFAS  Y02072 13259302
*                                       BIT IS ON                Y02072 13259402
         MODESET  KEYADDR=WKASVKEY,WORKREG=11  RET TO USER KEY   Y02072 13259602
*                                                                       13259702
         L     RWORK11,IOBECBPT         LOAD ADDR TO USER'S DECB Y02072 13259802
         ST    RWORK11,IOBDQPTR         SAVE DECB ADDR IN IOB    Y02072 13259902
         LA    RWORK11,IOBCSW+3         SET UP CSW ADDRESS TO    Y02072 13266602
         ST    RWORK11,IOBECBPT         USE AS DUMMY ECB FOR IOS Y02072 13268602
*                                       CEA OR EOE WILL RESTORE  Y02072 13270602
*                                       USER'S DECB ADDR IN IOB  Y02072 13272602
*                                                                       13283902
         EXCP  (RIOB)                   SCHEDULE I/O FOR NEXT IOB ON Q  13299202
*                                                                       13299602
         MODESET  EXTKEY=ZERO           RETURN TO ZERO KEY       Y02072 13299702
*                                                                       13299802
         MVI   WKATRAIL,WKAEXCP         SET BIT INDICATING EXCP  Y02072 13308502
*                                                                       13310502
         B     NORMEXIT                 NORMAL RET TO IGC0005G   Y02072 13333402
         SPACE 5                                                        13360001
*                                                                       13380001
*     NO IOBS ARE WAITING FOR BUFFERS. RETURN BUFFER TO AVAILABLE       13400002
*     BUFFER QUEUE.  THIS ROUTINE IS ENTERED IN USER KEY WITH THE       13420002
*     LOCAL LOCK HELD. RETURN TO FREEDBUF FROM THIS ROUTINE IS IN       13430002
*     SUPERVISOR KEY.                                                   13432002
*                                                                       13440001
FBUNOREQ L     RWORK12,DCBBUFCB   ADDR OF BUFFER CONTROL BLOCK   Y02072 13460002
         USING BCBDEFV,RWORK12    ESTABLISH BASE FOR BCB         Y02072 13480002
*                                                                       13500001
*                 COMPUTE BUFFER NUMBER FROM BUFFER ADDRESS             13520002
*                                                                       13540001
         LR    RWORK1,RBUFFR      BUFFER ADDRESS                        13560001
         S     RWORK1,BCBBUF1     MINUS ADDR OF 1ST BUFFER              13580001
*                                  = DISP INTO BUFFER POOL              13600001
         SR    RWORK0,RWORK0                                            13620001
         L     RWORK11,BCBBUFL                                          13640001
         DR    RWORK0,RWORK11     DIVIDED BY BUFFER LENGTH              13660001
*                                  = BUFFER NUMBER -1.                  13680001
         LA    RWORK1,1(RWORK1)   PLUS 1 = BUFFER NUMBER                13700001
*                                                                       13720001
*                      PLACE BUFFER # ON AVAILABLE CHAIN                13740001
*                                                                       13760001
         IC    RWORK9,BCBBFAVL    NEXT AVAIL BUFFER #                   13780001
         STC   RWORK9,BCBSUFFX-1(RWORK1)    POINT CHAIN ENTRY           13800001
*                                 FOR THIS BUFFER TO IT                 13820001
         STC   RWORK1,BCBBFAVL    MAKE THIS BUFFER NEXT AVAIL           13840001
*                                                                       13860001
*             RELEASE LOCAL LOCK AND SET AUDIT TRAIL BIT                13880002
*                                                                       13950002
         MODESET  EXTKEY=ZERO           CHANGE TO ZERO KEY       Y02072X13960002
                                        TO SET BIT IN SVRB       Y02072X13970002
                                        AND RELEASE LOCK         Y02072 13970402
         MVI   WKATRAIL,WKABUFQ         SET BIT INDICATING BUF   Y02072 13970802
*                                       FREED AND PUT ON QUEUE   Y02072 13971202
*                                                                       13972002
FREELCK1 SETLOCK  RELEASE,TYPE=LOCAL,RELATED=('BUFFERQ,IGG019JB(GETLOCKX13974002
               )')                      FREE THE LOCAL LOCK      Y02072 13974402
*                                                                       13984402
         B     NORMEXIT                 NORMAL RETURN TO IGC0005G       14000002
*                                                                       14020001
         EJECT                                                          15460001
EXTEND   EQU   *                                                        15480001
*                                                                       15500001
*                  THIS FUNCTION IS ONLY CALLED FROM THE                15520001
*                  ASYNCHRONOUS ROUTINE AND THUS IT WOULD BE            15540001
*                  IMPOSSIBLE FOR A SECOND EXTEND REQUEST TO BE         15560001
*                  ISSUED ON A GIVEN DCB BEFORE THE FIRST               15580001
*                  REQUEST COMPLETED. IT IS ENTERED IN USER KEY         15600002
*                  AND EXITS IN SUPERVISOR KEY.                         15610002
*                                                                       15620001
*                  GET STORAGE FOR AN UNSCHEDULED LIST TWICE AS         15640001
*                  LARGE AS THE CURRENT ONE.                            15660001
*                                                                       15680001
         LPR   RDECB,RDECB        GET DECB ADDR (UNCOMPLEMENTED)        15700001
         L     RWORK10,DCBDYNB    GET ADDR OF CURRENT UNSCHED-   Y02072 15760002
         USING USL,RWORK10        ULED LIST.                     Y02072 15780002
         LH    RWORK11,USLSIZE    SIZE OF CURRENT LIST           Y02072 15800002
         SLL   RWORK11,1          *2 = SIZE OF NEW LIST          Y02072 15820002
*                                                                       15822002
         GETMAIN RC,SP=0,LV=(RWORK11)   GET CORE FOR NEW USL     Y02072 15830002
*                                                                       15830402
         LTR   RRETCODE,RRETCODE        DO I HAVE THE CORE?             15832002
         BNZ   ERREXIT5                 BRANCH IF NO.                   15834002
         LR    RNEWLST,R1               GET ADDR OF NEW LIST     Y02072 15836002
*                                                                       15838002
         MODESET  EXTKEY=ZERO           CHANGE TO KEY ZERO TO    Y02072X15838402
                                        GET LOCK AND ST IN SVRB  Y02072 15838802
*                                                                       15839202
*                                                                       15878302
*     IT IS NECESSARY TO GET THE LOCAL LOCK TO MOVE THE OLD             15878402
*     USL LIST CONTENTS INTO THE NEW GOTTEN AREA. SETLOCK               15878502
*     USES REGISTERS 11-14 WITHOUT RESTORING THEM.                      15878602
*                                                                       15878702
         ST    RWORK11,WKAESTAE         SAVE R11 AROUND SETLOCK  Y02072 15878902
*                                                                       15879102
EXTLOCK  SETLOCK  OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=('BUFFERQ,IGG01X15879202
               9JB(EXTFREE)')           GET THE LOCAL LOCK       Y02072 15881202
*                                                                       15889602
         L     RWORK11,WKAESTAE         RESTORE R11              Y02072 15892202
*                                                                       15894802
         MODESET  KEYADDR=WKASVKEY,WORKREG=9   RET TO USER KEY   Y02072 15897402
*                                                                       15900002
*                                                                       16040001
         LA    RWORK1,0(RNEWLST,RWORK11)  END OF LIST            Y02072 16110002
*                                                                       16440001
*                  INITIALIZE NEW LIST                                  16460001
*                                                                       16480001
         XC    0(USLSLOT1-USL,RNEWLST),0(RNEWLST)     CLEAR TO 0        16500001
         STH   RWORK11,USLSIZE-USL(RNEWLST)  SIZE OF NEW LIST    Y02072 16520002
         LR    RWORK9,RWORK10           GET ADDR OF OLD USL LIST Y02072 16570002
         AH    RWORK9,USLSIZE           ADD LEN TO GET END ADDR  Y02072 16572002
         LA    RWORK6,USLSLOT1-USL(RNEWLST)                             16580001
*                                 LESS FIRST SLOT ADDR, NEW LIST        16600001
         SR    RWORK1,RWORK6      = LENGTH OF ENTRIES, NEW LIST         16620001
*                                                                       16640001
*                                                                       16720001
*                  IF THE LIST HAS ENTRIES IN 2 NONCONTIGUOUS           16740001
*                  SEGMENTS, FIRST MOVE THE SEGMENT CORRESPONDING       16760001
*                  TO THE TOP OF THE QUEUE. THE SEGMENTS WILL BE        16780002
*                  MOVED WITH MVCL WHICH DEPENDS ON TWO REGISTER        16790002
*                  PAIRS:  R12-R13  AND  R6-R7                          16792002
*                                                                       16800001
         ICM   RWORK12,ADDR,USLBFRQT+1  ADDR OF TOP QUEUE ENTRY  Y02072 16820002
         BZ    CLRLST                                                   16860001
         LR    RWORK13,RWORK9           SAVE FOR LEN CALCULATION Y02072 16900002
*                                       ENDING ADDR OF OLD USL   Y02072 16910002
         SH    RWORK9,H4                POINT TO LAST ENTRY, OLD LIST   16920002
         USING USLSLOT,RWORK9                                           16940001
         NI    USLSLTFL,X'FF'-USLENDL   TURN OFF END OF LIST FLAG       16960002
*                                       BEFORE MOVE                     16980002
         ST    RWORK6,USLBFRQT-USL(RNEWLST)                             17000001
*                                       TOP OF QUEUE FOR NEW LIST IS    17020002
*                                       FIRST SLOT.                     17040002
         LA    RWORK9,USLSLOT1    FIRST SLOT, OLD LIST.                 17060001
         TM    USLSLTFL,USLINUSE  IS THIS SLOT BEING USED?              17080001
         BZ    SECSEG             BRANCH NO, 1 MOVE WILL SUFFICE        17100001
         DROP  RWORK9                                                   17120001
         CR    RWORK12,RWORK9     IS TOP QUEUE ENTRY IN 1ST SLOT Y02072 17140002
         BE    SECSEG             BRANCH YES, AGAIN 1 MOVE OK           17160001
*                                                                       17180001
         SR    RWORK13,RWORK12    LENGTH OF 1ST SEGMENT          Y02072 17200002
         LR    RWORK7,RWORK13     RECEIVING FIELD IS SAME LGTH   Y02072 17220002
         SR    RWORK1,RWORK7      REDUCE LENGTH OF UNUSED SLOTS         17240001
         MVCL  RWORK6,RWORK12     MOVE 1ST SEGMENT TO NEW LIST   Y02072 17260002
         LA    RWORK12,USLSLOT1   2ND SEGMENT STARTS AT 1ST SLOT Y02072 17280002
*                                 OF OLD LIST.                          17300001
*                                                                       17320001
*                  MOVE SECOND OR ONLY LIST SEGMENT.                    17340001
*                                                                       17360001
SECSEG   L     RWORK13,USLBFRQB   LAST SLOT OF SEGMENT TO MOVE   Y02072 17380002
         USING USLSLOT,RWORK13                                   Y02072 17400002
         LA    RWORK13,USLNXT     POINT AT END ADDR + 1          Y02072 17420002
         DROP  RWORK13                                           Y02072 17440002
         SR    RWORK13,RWORK12    LENGTH OF SECOND SEGMENT       Y02072 17460002
         LR    RWORK7,RWORK13     RECEIVING FIELD IS SAME LGTH   Y02072 17480002
         SR    RWORK1,RWORK7      REDUCE AMOUNT OF UNUSED SLOTS         17500001
         MVCL  RWORK6,RWORK12     MOVE 2ND SEGMENT TO NEW LIST   Y02072 17520002
         LR    RWORK9,RWORK6      END OF LAST USED SLOT                 17540001
         SH    RWORK9,H4          ADDR OF BOTTOM SLOT IN QUEUE          17560001
         ST    RWORK9,USLBFRQB-USL(RNEWLST)  INITIALIZE PTR TO          17580001
*                                 LAST SLOT OF QUEUE.                   17600001
*                                                                       17620001
*                  CLEAR THE UNUSED SLOTS ON THE NEW LIST               17640001
*                                                                       17660001
CLRLST   LR    RWORK7,RWORK1      LENGTH REMAINING (TO FIELD)           17680001
         SR    RWORK13,RWORK13    SEND NO CHARACTERS, PAD X'00'  Y02072 17700002
         MVCL  RWORK6,RWORK12     CLEAR REST OF LIST             Y02072 17720002
*                                                                       17740001
         SH    RWORK6,H4          ADDR LAST SLOT                        17760001
         USING USLSLOT,RWORK6                                           17780001
         OI    USLSLTFL,USLENDL   TURN ON END-OF-LIST FLAG              17800001
         DROP  RWORK6                                                   17820001
*                                                                       17840001
         NI    USLFLAGS,X'FF'-USLCURNT  TURN OFF 'CURRENT' FLAG         17860001
*                                       IN OLD LIST                     17880001
         OI    USLFLAGS-USL(RNEWLST),USLCURNT                           17900001
*                                 TURN ON 'CURRENT' FLAG IN NEW         17920001
*                                 SET POINTER TO OLD LIST IN NEW        17940001
         ST    RWORK10,USLCHAIN-USL(RNEWLST)                     Y02072 17960002
         ST    RNEWLST,DCBDYNB    SET POINTER TO NEW LIST IN DCB        17980001
*                                                                       18050002
*     MODESET MUST BE ISSUED TO RETURN TO SUPERVISOR KEY BEFORE         18060002
*     RELEASING THE LOCAL LOCK. SETLOCK USES REGISTERS 11-14            18070002
*     WITHOUT RESTORING THEM.                                           18072002
*                                                                       18074002
         MODESET  EXTKEY=ZERO           RETURN TO ZERO KEY       Y02072 18078002
*                                                                       18078402
EXTFREE  SETLOCK  RELEASE,TYPE=LOCAL,RELATED=('BUFFERQ,IGG019JB(EXTLOCKX18078802
               )')                      FREE THE LOCAL LOCK      Y02072 18078902
*                                                                       18079602
*                                                                       18080001
*                       NORMAL EXIT                                     18100001
*                                                                       18120001
NORMEXIT L     RRETURN,WKAREG14   RESTORE RETURN REGISTER               18140001
         SR    RRETCODE,RRETCODE  RETURN CODE = 0.                      18160002
         BR    RRETURN            RETURN TO IGC0005G                    18180001
*                                                                       18200001
         SPACE 2                                                        18220002
*                                                                       18240001
*                            ERROR EXITS.                               18260001
*                                                                       18280001
ERREXIT5 LA    RRETCODE,FIXERR    LOAD ERROR CODE                       18540001
         L     RRETURN,WKAREG14   RESTORE RETURN REGISTER               18560001
         BR    RRETURN            RETURN TO CALLER                      18580001
*                                                                       18600001
*********************************************************************** 18610002
*                           CONSTANTS                                 * 18612002
*********************************************************************** 18614002
H16      DC    H'16'                                                    18616002
H4       DC    H'4'                                                     18618002
IOSKEY   DC    X'00'                    KEY OF IOS               Y02072 18618402
ZERO     DC    X'00'                    SVRB KEY                 Y02072 18618502
MODID    DC    C'IGG019JB'              MODULE ID                Y02072 18668502
FIX      DC    C' XM1559 '              LATEST FIX               YM5349 18678502
DATE     DC    C'11/13/73'              DATE OF LATEST FIX       YM5349 18688502
PATCH    DC    XL50'0'                  PATCH AREA               Y02072 18718502
         EJECT                                                          18860001
*********************************************************************** 18862002
*                             DSECTS                                  * 18864002
*********************************************************************** 18866002
         IHAPSA                                                  Y02072 18870002
         EJECT                                                          18872002
         IKJTCB                                                  Y02072 18874002
         EJECT                                                          18876002
         IECDRQE                                                 Y02072 18878002
         IEZIOB                                                         18880001
         ORG   IOBDQPTR                                                 18900001
IOBDQSW  DS    B        FLAGS                                           18920001
IOBDQCP  EQU   BIT0          CHANNEL PROGRAM MODIFIED                   18940001
*                                                                       18960001
         IHADCB DSORG=DA                                                18980001
*                                                                       19000001
         IHADECB                                                        19020001
         ORG   DECAREA                                                  19040001
DECARB1  DS    B                  SAVEAREA FOR CCW1 OP-CODE             19060001
DECARB2  DS    B                  SAVEAREA FOR CCW1 FLAGS               19080001
         EJECT                                                          19130002
         IGGBCB  TYPE=DAM                                        Y02072 19180002
         SPACE 5                                                        19230002
         IGGSWA                                                  Y02072 19280002
BUFFERB  DSECT          FORMAT OF BUFFER BEYOND SEGMENT AREA            19290002
BUFBFPTR DS    A        ADDRESS OF BEGINNING OF BUFFER                  19300002
BUFRECAR EQU   *        RECORD AREA; BUFBFPTR IS ALIGNED SO THAT        19310002
*                       BUFRECAR FALLS AS SPECIFIED BY DCBBFALN.        19320002
         SPACE 5                                                        19330002
         IGGUSL                                                  Y02072 19380002
         EJECT                                                          19490002
         IKJRB                                                   Y02072 19500002
         IGGFRWKA                                                Y02072 19550002
         END                                                            20300001
