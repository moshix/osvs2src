         TITLE 'IGG019KA - BDAM FOUNDATION MODULE-NON VS FORMAT'        00010002
IGG019KA CSECT                                                          00020000
*MODULE NAME - IGG019KA                                               * 00022002
*                                                                     * 00022402
*DESCRIPTIVE NAME - BDAM FOUNDATION MODULE, NON VS FORMAT             * 00022802
*                                                                     * 00023202
*COPYRIGHT - NONE                                                     * 00023602
*                                                                     * 00023702
*CHANGE ACTIVITY                                                      * 00023802
*                                                                     * 00024002
*          OS 20 CHANGES/DELETIONS                                      00046402
*0286074860-074920                                               M5471  00046802
*0286                                                            A33688 00047202
*0286000270-000440,000690-000830,048200,053400,063920,064080,    20201  00047602
*0286083400-083800,084400,084600                                 20201  00047702
*0286134860-134920                                               M5461  00047802
*          OS 21 CHANGES/DELETIONS                                      00049802
*1132111200,117400,120400,120800-121800,122600,132200-132400     A35339 00051802
*1132112600-112800                                               A30797 00053802
*                                                               SA53267 00054202
*057800,059200-060200                                           SA54515 00056202
*          VS 1-1 CHANGES/DELETIONS                                     00064202
*          VS 2-1 CHANGES/DELETIONS                                     00074202
*          VS 1-3 CHANGES/DELETIONS                                     00084202
*                                                               XA02033 00084602
*                                                               XA03071 00085002
*          VS 2-2 CHANGES/DELETIONS                                     00086202
*                                                                Y02072 00088202
*                                                                YM1458 00088602
*                                                                YM3857 00089002
*                                                                YM3850 00089402
*                                                                YM2862 00090602
*                                                                YM5969 00095502
*                                                                YM6585 00097502
*                                                                YM5893 00099502
*                                                                YM8817 00099902
*A052820-052920,053020-053024,053500                            ZA01524 00105902
*D095800-096338                                                @ZA08000 00107937
*          CHANGES SUBSEQUENT TO VS2 - 037                            * 00108937
*C129200                                                       @ZA15675 00109937
*A031900,084650                     OZ28786 CHANGES FLAGGED AS @YA19662 00110937
*                                                                       00112002
*STATUS CHANGE LEVEL 008                                              * 00117602
*                                                                     * 00123202
*FUNCTION/OPERATION- THIS MODULE CONTAINS THREE ROUTINES WHOSE        * 00128802
*   FUNCTIONS ARE:                                                    * 00134402
*   ROUTINE 1. INITIAL ENTRY FOR ANY BDAM READ OR WRITE, CHECK THE    * 00140000
*    VALIDITY OF SPECIFIED TYPE AND OPTIONS, OBTAIN AN IOB, PROVIDE   * 00160000
*    LINKAGE FOR ADDRESS CONVERSION AND CHANNEL PROGRAM CONSTRUCTION, * 00180000
*    ISSUE THE 'EXCP' AND RETURN TO THE USER. IF WRITE ADD FOR A 2305,* 00200002
*    SVC 53 IS ISSUED INSTEAD OF EXCP. WHEN EXCLUSIVE CONTROL OF THE  * 00202002
*    TRACK OR DATA SET IS OBTAINED, IGC0005C WILL ISSUE THE EXCP.     * 00204002
*                                                                     * 00220000
*   ROUTINE 2. ASYNCHRONOUS INTERRUPT ROUTINE(ASI), LINK NEW IOBS     * 00230002
*    TO THE DCB IOB POOL, PROVIDE LINKAGE TO THE FEEDBACK, SELF-      * 00232002
*    FORMAT AND EXCLUSIVE CONTROL MODULES, MAKE THE IOB AVAILABLE     * 00234002
*    AND ISSUE THE 'POST' BEFORE RETURNING TO THE SUPERVISOR.         * 00236002
*                                                                     * 00320000
*   ROUTINE 3. ERROR ROUTINES, RELEASE THE IOB, SET THE PROPER        * 00340000
*    EXCEPTION CODES, ISSUE THE 'POST'.                               * 00360000
*                                                                     * 00380000
*ENTRY POINTS- 'IGG019KA' (ENTRYPT) IS THE ENTRY FOR A BDAM READ OR   * 00400000
*   WRITE MACRO INSTRUCTION. THE GENERATED CALLING SEQUENCE IS,       * 00420000
*   L    15,DCBREAD   (DCB+48)                                        * 00440000
*   BALR 14,15                                                        * 00460000
*                                                                     * 00480000
*   'IECDFDNA' IS THE ENTRY POINT TO THE ASI ROUTINE FROM SUPERVISOR  * 00500000
*   WHEN THE I/O HAS COMPLETED. THE CALLING SEQUENCE USED IS,         * 00520002
*   L    15,IRBRBEP   (IRB+12)                                        * 00540000
*   BALR 14,15                                                        * 00560000
*                                                                     * 00580000
*   'LATERR' IS AN ENTRY TO THE INVALID REQUEST ERROR ROUTINE FROM    * 00600000
*   THE ADDRESS CONVERSION OR PRE-FORMAT MODULES. CALLING SEQUENCE IS,* 00620000
*   L    REG,20(IGG019KA BASE)                                        * 00640000
*   BR   REG                                                          * 00660000
*                                                                     * 00680000
*INPUT- ROUTINE 1.- DECB ADDRESS IN REGISTER 1, SAVE AREA ADDRESS IN  * 00700000
*   REGISTER 13, RETURN ADDRESS IN REGISTER 14, ENTRY POINT IN        * 00720000
*   REGISTER 15.                                                      * 00740000
*                                                                     * 00760000
*   ROUTINE 2.(ASI)- IOS QUEUEING ELEMENT ADDRESS IN REGISTER 1,      * 00780000
*   RETURN ADDRESS IN REGISTER 14, ENTRY POINT IN REGISTER 15.        * 00800000
*                                                                     * 00820000
*   ROUTINE 3.(INVALID REQUEST)- REGISTERS 5,7,11,13 WILL CONTAIN THE * 00840000
*   DECB ADDRESS, IOB ADDRESS, IGG019KA ADDRESS, SAVE AREA ADDRESS,   * 00860000
*   RESPECTIVELY. REGISTER 12 WILL CONTAIN THE REASON CODE WHICH WILL * 00880000
*   APPEAR IN BYTE TWO OF THE DECB AFTER 'POST' IS EXECUTED.          * 00900000
*                                                                     * 00920000
*OUTPUT- ROUTINE 1.- AN IOB WILL BE OBTAINED, CHANNEL PROGRAM         * 00940000
*   CONSTRUCTED AND 'EXCP' EXCECUTED FOR A VALID READ OR WRITE.       * 00960000
*   IF 2305 WRITE ADD AND BLOCK IS NOT AVAILABLE, THE IOB WILL BE     * 00970002
*   PUT ON THE UNPOSTED QUEUE.                                        * 00972002
*                                                                     * 00980000
*   ROUTINE 2.(ASI)- FEEDBACK WILL BE RETURNED IF REQUESTED, AND A    * 01000000
*   COMPLETION CODE PLACED IN THE DECB BY THE 'POST' ROUTINE.         * 01020000
*                                                                     * 01040000
*   ROUTINE 3.(INVALID REQUEST)- A COMPLETION CODE AND REASON CODE    * 01060000
*   ARE PLACED IN THE DECB BY THE 'POST' ROUTINE.                     * 01080000
*                                                                     * 01100000
*EXTERNAL ROUTINES- 'IGG019KC'-CONVERT RELATIVE TRACK ADDRESS (TT OR  * 01120000
*   TTR) TO AN ACTUAL ADDRESS OR CONVERT ACTUAL TO TTR FOR FEEDBACK.  * 01140000
*                                                                     * 01160000
*   'IGG019KE'-CONVERT RELATIVE BLOCK ADDRESS TO AN ACTUAL ADDRESS.   * 01180000
*                                                                     * 01200000
*   'IGG019KF'-CONVERT RELATIVE BLOCK ADDRESS TO AN ACTUAL ADDRESS    * 01220000
*   FOR OVERFLOW RECORDS                                              * 01240000
*                                                                     * 01260000
*   'IGG019KK'-CONSTRUCT A CHANNEL PROGRAM TO SEARCH BY BLOCK ID.     * 01280000
*                                                                     * 01300000
*   'IGG019KI'-CONSTRUCT A CHANNEL PROGRAM TO SEARCH BY BLOCK KEY.    * 01320000
*                                                                     * 01340000
*   'IGG019KO'-CONSTRUCT A CHANNEL PROGRAM TO ADD A NEW BLOCK TO A    * 01360000
*   DATA SET OF FIXED FORMAT RECORDS, (PRE-FORMAT MODULE).            * 01380000
*                                                                     * 01400000
*   'IGG019KM'-CONSTRUCT A CHANNEL PROGRAM TO ADD A NEW BLOCK TO A    * 01420000
*   DATA SET OF VARIABLE OR UNDEFINED LENGTH RECORDS, (SELF-FORMAT    * 01440002
*   MODULE).                                                          * 01460000
*   ALSO ENTERED TO DETERMINE IF THE NEW BLOCK WILL FIT ON THE TRACK  * 01480000
*   AFTER THE CAPACITY RECORD IS READ INTO THE IOB.                   * 01500000
*   ALSO ENTERED AFTER THE WRITE-ADD REQUEST HAS COMPLETED, TO SCAN   * 01520000
*   THE UNSCHEDULED QUEUE FOR OTHER WRITE-ADD REQUESTS AND EXECUTE    * 01540000
*   THE FIRST REQUEST FOUND, IF ANY.                                  * 01560000
*                                                                     * 01580000
*   SVC 53  -PLACE A RECORD ON THE READ EXCLUSIVE LIST FOR A READ     * 01600002
*   OR WRITE ADD REQUEST, OR PUT THE IOB ON THE UNPOSTED QUEUE,       * 01610002
*   OR REMOVE A RECORD FROM THE READ EXCLUSIVE LIST FOR A WRITE       * 01620000
*   WHEN EXCLUSIVE CONTROL IS SPECIFIED, OR IF A WRITE ADD REQUEST.   * 01640002
*                                                                     * 01660000
*   'IGG019KG'-CONVERT AN ACTUAL ADDRESS TO A RELATIVE BLOCK NUMBER   * 01680000
*   IF FEEDBACK IS REQUESTED.                                         * 01700000
*                                                                     * 01720000
*   'IGG019KH'-CONVERT AN ACTUAL ADDRESS TO A RELATIVE BLOCK NUMBER   * 01740000
*   FOR OVERFLOW RECORDS, IF FEEDBACK IS REQUESTED.                   * 01760000
*                                                                     * 01780000
*EXITS-NORMAL- 'RSTOR' IS THE RETURN TO THE PROGRAM WHICH ISSUED THE  * 01800000
*   READ OR WRITE MACRO-INSTRUCTION. THE REQUEST HAS EITHER BEEN      * 01820000
*   EXECUTED VIA 'EXCP' OR HAS BEEN POSTED COMPLETE AS AN INVALID     * 01840000
*   REQUEST.                                                          * 01860000
*   'SUPEXIT' IS THE EXIT FROM THE ASI ROUTINE TO SUPERVISOR. THE DECB* 01880000
*   HAS BEEN POSTED AS COMPLETE WITH A CODE INDICATING SUCCESSFUL OR  * 01900000
*   ERROR COMPLETION.                                                 * 01920000
*                                                                     * 01940000
*TABLES/WORK AREAS- N/A                                               * 01960000
*                                                                     * 01980000
*ATTRIBUTES- THE INITIAL ENTRY ROUTINE AND INVALID REQUEST ERROR      * 02000000
*   ROUTINE ARE REENTRANT AND EXECUTED ENABLED, PROG PGM STATE.       * 02020002
*                                                                     * 02030002
*   THE ASI ROUTINE IS REENTRANT AND EXECUTED ENABLED, IN PROBLEM     * 02040002
*   PROGRAM STATE AND USER KEY.                                       * 02050002
*                                                                     * 02080000
*NOTE- THE BDAM MODUES BRANCH AND LINK TO EACH OTHER WITHOUT USE OF   * 02100000
*   A REGISTER SAVE AREA SO THE REGISTER USAGE MUST REMAIN CONSISTENT * 02120000
*   IN THE BDAM MODULES, IGG019KA, IGG019KC, IGG019KE, IGG019KF,      * 02140000
*   IGG019KG, IGG019KH, IGG019KI, IGG019KK, IGG019KM, IGG019KO,       * 02160000
*   IGG019KQ.                                                         * 02180002
         EJECT                                                          02330002
*********************************************************************** 02380002
*                    REGISTER USAGE                                   * 02420002
*********************************************************************** 02430002
*                                                                       02440000
PARAM2   EQU   0                                                        02460000
PARAM    EQU   1         PARAMETERS                                     02480000
WKREG1   EQU   2         WORK REGISTER                                  02500000
DEBREG   EQU   3         DEB ADDRESS                                    02520000
DCBREG   EQU   4         DCB ADDRESS                                    02540000
DECBREG  EQU   5         DECB ADDRESS                                   02560000
WKREG2   EQU   6         WORK REGISTER                                  02580000
IOBREG   EQU   7         IOB ADDRESS                                    02600000
SECTOR   EQU   8         POINTER TO SECTOR AREA OR LAST DW       20201  02610020
FDNBASE  EQU   11        BASE FOR THE FOUNDATION MODULE                 02620000
INTRET   EQU   12        RETURN FOR INTERNAL LINKAGES                   02640000
SAVE     EQU   13        POINTER TO USER SAVE AREA                      02660000
RETREG   EQU   14        RETURN REGISTER                                02680000
EPREG    EQU   15        ENTRY POINT                                    02700000
WKREG3   EQU   15        WORK REGISTER                           Y02072 02710002
*                                                                       02720000
         IEZBITS                                                        02730001
         EJECT                                                          02740000
         USING IGG019KA,EPREG                                           02750002
*                                                                       02760000
*                                                                       02780000
ENTRYPT  B     BEGIN                    BRANCH AROUND ADDR LOCATIONS    02800002
*                                                                       02820000
RRAD     DC    V(IGG019KE)             RELATIVE BLOCK MOD ADDR   Y02072 02840002
RTAD     DC    V(IGG019KC)             RELATIVE TRACK MOD ADDR   Y02072 02860002
VERAD    DC    V(IGG019KQ)             VERIFY MODULE ADDRESS     Y02072 02880002
ASIAD    DC    A(IECDFDNA)             ASYNCH INTERRUPT RTN      Y02072 02900002
ERRENTRY DC    A(LATERR)               INVALID REQUEST ERROR RTN Y02072 02920002
KEYMODAD DC    V(IGG019KI)             ADDRESS OF THE KEY MODULE Y02072 02940002
IDMODAD  DC    V(IGG019KK)             ADDRESS OF THE ID MODULE  Y02072 02960002
RROVAD   DC    V(IGG019KF)             REL BLOCK/TRK OFLO MOD AD Y02072 02970002
*                                                                       02980000
*                                                                       03000000
*                                                                       03020000
         DROP  EPREG                                                    03040000
BEGIN    SAVE  (14,12)                  SAVE USER REGISTERS IN HIS AREA 03080002
         LR    FDNBASE,EPREG            ESTABLISH BASE FOR THIS MODULE  03100002
         USING IGG019KA,FDNBASE                                         03110002
         LR    DECBREG,PARAM            SET BASE REGISTER FOR DECB      03120002
         USING DECB,DECBREG                                             03130002
         L     DCBREG,DECDCBAD          SET BASE REGISTER FOR DCB       03140002
         USING IHADCB,DCBREG                                            03150002
         L     DEBREG,DCBDEBAD          SET BASE REGISTER FOR DEB       03160002
         USING DEBBASIC,DEBREG                                   Y02072 03170002
*                                                                       03180000
         NI    DECTYPE,OLDOPTS          CLEAR OLD DCB OPTIONS  @YA19662 03190037
         IC    INTRET,DECTYPE           SAVE REQUESTED OPTIONS IN A REG 03200002
         OI    DECTYPE,VERIFY+EXSCH+ACTAD+RELRD+OFLOW                   03220000
         NC    DECTYPE(1),DCBOPTCD      COMBINE DCB OPTIONS WITH THE    03240002
         EX    INTRET,ORBACK            REQUEST OPTIONS.                03260000
         N     INTRET,OPSMSK            VALIDITY CHECK READX,DYN. BFR.  03280002
         BZ    OKOPTS                   OPTIONS (BR IF NONE PRESENT),BY 03300002
         EX    INTRET,VALCHK            EXECUTING A TM INSTRUCTION.     03320000
         BO    OKOPTS                   OK IF ALSO SPECIFIED IN DCB,    03340002
         IC    INTRET,INVOPT            ELSE FLAG THIS REQUEST AS       03360000
         B     ABORT                    INVALID AND GO POST COMPLETION. 03380002
*                                                                       03400000
ORBACK   OI    DECTYPE,0     EXECUTED-RETURN FEEDBACK OPTION BIT.       03420000
VALCHK   TM    DCBOPTCD,0    EXECUTED-CHECK READX,DYN. BFR. REQUEST.    03440000
*                                                                       03460000
OKOPTS   TM    DECTYPE+1,READ           IS THIS A READ REQUEST          03480002
         BO    LGNCHK                   YES, GO TEST LENGTH OPTION      03500002
         TM    DEBOPATB,DEBACCS         DID OPEN SPECIFY OUTPUT/UPDATE  03520002
*                                                                Y02072 03530002
         BC    5,FORMCHK                YES, WRITE REQUEST IS VALID     03540000
         IC    INTRET,INVWRT            FLAG THIS WRITE TO INPUT DATA   03560002
         B     ABORT                    SET, GO POST COMPLETION         03580002
*                                                                       03600000
*                                                                       03620000
FORMCHK  TM    DCBRECFM,DCBRECF         IS RECORD FORMAT VARIABLE       03640002
         BO    LGNCHK                   NO, GO TEST LENGTH OPTION       03660002
         L     WKREG2,DECAREA           USE FIRST TWO BYTES OF DATA AS  03680002
         MVC   DECLNGTH(2),0(WKREG2)    BLOCK LENGTH FOR THE WRITE      03700000
         B     SZRTN                    GO DETERMINE IOB SIZE           03720002
*                                                                       03740000
LGNCHK   TM    DECTYPE+1,LGNOP          DID USER CODE LENGTH AS 'S'     03760002
         BZ    SZRTN                    NO, USE DECB LENGTH             03780002
         MVC   DECLNGTH(2),DCBBLKSI     USE MAX BLOCK SIZE AS LENGTH    03800002
*                                                                       03820000
*********************************************************************** 03830002
*   THE FOLLOWING ROUTINE DETERMINES THE SIZE IOB AND CHANNEL PROGRAM   03840000
*        CORE AREA REQUIRED FOR THIS REQUEST                            03860000
*********************************************************************** 03870002
*                                                                       03880000
SZRTN    LA    WKREG1,BASESZ            SIZE=BASE + OPTIONS             03900002
         LA    PARAM,XSCHSZ             SET TO EXTENDED SEARCH CORE AMT 03920002
         SR    INTRET,INTRET            CLEAR FEEDBACK INCREMENT REG    03940000
         TM    DCBOPTCD,DCBOPTTO        ARE OVERFLOW RECORDS PRESENT    03960002
         BZ    NOTOVFLO                 NO , CONTINUE            Y02072 03980002
         LA    WKREG1,OFLINCR(0,WKREG1) ADD ON FOR NOP CCW AT END OF CP 04000000
NOTOVFLO EQU   *                        CONTINUE IOB SIZE CALC   Y02072 04010002
         TM    DECTYPE+1,READ           TEST TYPE FOR READ              04020002
         BO    TSTRDX                   YES, GO TEST FOR READ EXCLUSIVE 04040000
*                                                                       04060000
         TM    DECTYPE,VERIFY           TEST FOR VERIFY OPTION          04080000
         BZ    TSTWA                    BR IF NO VERIFY SPECIFIED       04100002
         LA    WKREG1,VERSZ(0,WKREG1)   INCREMENT FOR VERIFY CCW'S      04120002
TSTWA    TM    DECTYPE+1,ADD            TEST FOR WRITE ADD TYPE         04140000
         BZ    TSTRDX                   NO, GO TEST FOR WRITE RELEASE   04160002
         LA    WKREG1,ADDSZ+ENQPL(0,WKREG1)  INCREMENT FOR WRITE ADD    04180000
*                                       AND ENQUE PARAMETER LIST        04200002
         LA    PARAM,PFEXTSZ            PRE-SET EXTENDED SEARCH REG     04220002
         TM    DCBRECFM,DCBRECV         ARE RECORDS FIXED FORMAT        04240002
         BZ    TSTX                     BRANCH IF YES                   04260002
         LA    WKREG1,SFSZ(0,WKREG1)    INCREMENT FOR SELF FORMAT WRITE 04280002
         SR    PARAM,PARAM              NO CORE REQ'D FOR EXTENDED SRCH 04300002
         B     TSTX                     GO TEST FOR EXTENDED SEARCH     04320002
*                                                                       04340000
TSTRDX   TM    DECTYPE,READX            IS IT A READ EXCLUSIVE OR A     04360000
*                                       WRITE TO RELEASE                04380000
         BZ    TST4KEY                  BRANCH IF NO                    04400000
         LA    WKREG1,ENQPL(WKREG1)     ADD FOR ENQ PARAMETER LIST      04420000
*                                                                       04440000
TST4KEY  TM    DECTYPE+1,KEY            IS TYPE = KEY                   04460002
         BZ    CHKPOOL                  NO, SIZE IS IN WKREG1           04480002
         TM    DECTYPE,FEEDB+READX+OFLOW  ARE FEEDBACK CCWS NEEDED      04500000
         BZ    TSTX                     NO, LEAVE REGISTER ZERO         04520002
         LA    INTRET,FDBSZ             SET POSSIBLE FEEDBACK INCREMENT 04540002
*                                                                       04560000
TSTX     TM    DECTYPE,EXSCH            TEST FOR EXTENDED SEARCH OPTION 04580000
         BZ    CHKPOOL                  BR IF NOT SPECIFIED             04600002
         CLC   ZEROS(3),DCBLIMCT        IS LENGTH OF SEARCH SPECIFIED   04620002
         BNE   UPSZ88                   YES, REQUEST IS VALID           04640002
         IC    INTRET,INVLIMCT          FLAG INVALID REQUEST (LIMCT=0)  04660002
         B     ABORT                    GO POST COMPLETION              04680002
UPSZ88   AR    WKREG1,PARAM             INCREMENT FOR EXTENDED SEARCH   04700002
         AR    WKREG1,INTRET            INCREMENT FOR FEEDBACK          04720000
*                                                                       04740000
*        THIS CODE IS ADDED TO GET ONE MORE DOUBLE WORD FOR THE         04742020
*        SECTOR BYTES ASSOCIATED WITH RECORD READY.                     04744020
*                                                                       04746020
CHKPOOL  EQU   *                                                 20201  04748020
         LA    WKREG1,RRINCR(WKREG1)    INCR IOB SZ FOR REC REDY 20201  04750002
*                                                                       04752020
*    THE FOLLOWING ROUTINE OBTAINS AN IOB AREA FROM THE POOL OF AREAS   04760000
*     IF ONE OF ENOUGH SIZE IS AVAILABLE                                04780000
*                                                                       04800000
         USING IOBSTDRD,IOBREG          ESTABLISH IOB BASE       Y02072 04810002
         L     IOBREG,DCBIOBAD          LOAD FIRST LINK ADDRESS  20201  04820020
SHFT     LA    IOBREG,0(0,IOBREG)       BE SURE HI-ORDER BYTE IS ZERO   04840002
         LTR   IOBREG,IOBREG            TEST FOR ZERO LINK ADDRESS.     04860000
         BZ    GETCR                    IF ADDR=0, GO GET CORE FOR IOB  04880002
         CH    WKREG1,IOBDIOBS          IS THIS IOB AREA LARGE ENOUGH   04900000
         BH    TRYNEXT                  IF NOT GO SEE IF THERE ARE MORE 04920002
         TS    IOBDAVLI                 IS THIS IOB AVAILABLE           04940000
         BZ    CLRIOB                   YES, GO INITIALIZE AREA         04960002
*                                                                       04980000
TRYNEXT  L     IOBREG,IOBDPLAD          LOAD NEXT POOL LINK             05000002
         B     SHFT                     GO TEST FOR END OF CHAIN        05020002
*                                                                       05040000
*                                                                       05060000
CLRXC    XC    IOBDTYPE(1),IOBDTYPE  EXECUTED-- CLEAR LAST PART OF IOB  05080000
CLRXXC   XC    IOBDTYPE+Q255(Q1),IOBDTYPE+Q255  CLR IF IOB+CCWS  20201  05085020
*                                       GO BEYOND IOBDTYPE+255   20201  05090002
*                                                                       05100000
*                                                                       05120000
*                GETMAIN ROUTINE                                        05140002
*                                                                       05150002
GETCR    LR    PARAM2,WKREG1            MOVE BYTE COUNT TO PARAM REG    05160002
         GETMAIN R,LV=(0)                                               05180000
*                                                                       05200000
         LR    IOBREG,PARAM             LOAD CORE ADDRESS TO IOB BASE   05220002
         STH   WKREG1,IOBDIOBS          STORE THE AREA SIZE IN IOB      05240002
         SR    WKREG2,WKREG2            CLEAR THE POOL                  05260000
         ST    WKREG2,IOBDAVLI          ADDRESS AREA                    05280002
CLRIOB   EQU   *                        CLEAR THE IOB           ZA01524 05282002
         LR    WKREG2,WKREG1            SAVE LENGTH REQUIRED    ZA01524 05290002
         LH    WKREG1,IOBDIOBS          LOAD SIZE OF IOB        ZA01524 05292002
         XC    IOBFLAG2(41),IOBFLAG2    CLEAR IOB SIZE FIELD   @OZ04733 05300037
         LR    SECTOR,IOBREG            LOAD ADDR OF IOB         20201  05301020
         AR    SECTOR,WKREG2            ADD NUMBER OF BYTES     ZA01524 05302002
*                                       REQUIRED FOR THIS REQ   ZA01524 05302402
         S     SECTOR,EIGHT             POINT TO LAST DOUBLE     20201  05303020
*                                       WORD                     20201  05304020
         TM    DECTYPE+Q1,ADD           IS THIS WRITE ADD        20201  05305020
         BO    SUBRDX                   SUBTRACT OFF ENQ AREA    20201  05306020
         TM    DECTYPE,READX            IS THIS READ EXCLUSIVE   20201  05307020
         BZ    NOTREADX                 NO, ALL O.K.             20201  05308020
SUBRDX   EQU   *                                                 20201  05309020
         SH    SECTOR,RDXCORE           SUBTRACT OFF ENQ AREA    20201  05310020
NOTREADX EQU   *                                                 20201  05311020
         SH    WKREG1,K49               REDUCE SIZE TO REMAINING SIZE   05320002
         CH    WKREG1,IOBSZ255          IOB GO BEYOND            20201  05324020
*                                       IOBDTYPE+255?            20201  05328020
         BH    CLROVFF                  YES, GO TO CLEAR BEYOND  20201  05332020
         EX    WKREG1,CLRXC             ELSE CLEAR WHAT IS       20201  05336020
*                                       SPECIFIED                20201  05340020
         B     CORCLRD                  CORE ZEROED SO BRANCH    20201  05344020
CLROVFF  XC    IOBDTYPE(Q255),IOBDTYPE  CLR OUT 1ST 255 BYTES    20201  05348020
         SH    WKREG1,IOBSZ255          SUBT AMT ALREADY CLEAR  ZA01524 05350002
         EX    WKREG1,CLRXXC            CLEAR OUT THE REMAINDER  20201  05352020
*                                                                       05354002
CORCLRD  EQU   *                                                 20201  05356020
         ST    DCBREG,IOBDCBPT          STORE DCB ADDRESS IN IOB        05400002
         ST    DECBREG,IOBECBPT         STORE ECB ADDRESS IN IOB        05420002
         ST    IOBREG,DECIOBPT          STORE IOB ADDR IN DECB          05440002
         LA    WKREG1,IOBCHNPR          DEVELOP CHANNEL PROG STARTING   05460002
         ST    WKREG1,IOBSTART          ADDRESS AND STORE IT IN IOB     05480000
         MVC   IOBDTYPE(L'DECTYPE),DECTYPE  MOVE OPTION & TYPE CODE     05500001
         MVI   IOBFLAG1,CPFLAG          MARK AS UNRELATED,COMMAND CHAIN 05520002
*                                                                       05540000
*    THE FOLLOWING ROUTINE DETERMINES THE ADDRESSING METHOD BEING       05560000
*     USED AND CHECKS THE VALIDITY OF THE ADDRESS.                      05580000
*                                                                       05600000
ADDRDEC  L     PARAM,DECRECPT           LOAD POINTER TO USER'S ADDRESS  05620002
         LA    RETREG,CLRCP             LOAD COMMON RETURN POINT ADDR   05640002
         TM    IOBDTYP2,IOBRQUST+IOBADDTY  BYPASS NEXT RTN IF RD OR WA  05660002
         BC    5,D1NOFDBK               AND GO DETERMINE ADDRESS TYPE   05680000
         TM    IOBDTYP2,IOBTYPE         IF TYPE IS KEY, BYPASS CHECKING 05700002
         BO    TRYX                     FOR A WRITE TO R ZERO           05720002
         TM    IOBDTYPE,IOBACTAD        IS ADDRESS ACTUAL               05740002
         BZ    TRYRT                    NO, GO TEST FURTHER             05760002
TESTR0   EQU   *                        WRT R0 INVALID -TEST IT OX02033 05770002
         CLI   7(PARAM),0               IS THIS A WRITE TO R0           05800002
         BNE   ACTUAL                   NO, ACTUAL ADDRESS IS OK        05820002
SETIRBIT IC    INTRET,INVID             FLAG INVAL REQUEST(WRITE TO R0) 05840002
         B     LATERR                   GO POST COMPLETION, FREE IOB    05860002
*                                                                       05880000
TRYRT    EQU   *                                                        05900000
         TM    DCBOPTCD,DCBOPTF         FEEDBACK IN DCB OPTCD?  XA02033 05950002
         BO    TRYRT2                   YES, NOT ACTUAL ADDRESS XA02033 06000002
         TM    IOBDTYPE,IOBRDEXC+IOBFDBCK WRT REL/FDBK IN DECB  XA03071 06010002
         BM    TESTR0                   YES, ASSUME ACTUAL ADDR  YM8817 06020002
*                                       BECAUSE FEEDBACK ALWAYS XA02033 06030002
*                                       PROVIDED FOR READX REQ  XA02033 06032002
*                                       AND WRT REL MUST ASSUME XA02033 06034002
*                                       PREVIOUS READX REQUEST  XA02033 06036002
TRYRT2   EQU   *                        NOT ACTUAL ADDRESSING   XA02033 06038002
         TM    IOBDTYPE,IOBRELBL        IS ADDR RELATIVE BLOCK NUMBER   06040002
         BO    RELRCDX                  YES, GO TO RELATIVE BLOCK EXIT  06060002
         CLI   2(PARAM),0               IS R OF TTR A 0                 06080002
         BE    SETIRBIT                 YES,WRITE REQUEST IS INVALID    06100002
*                                                                       06120000
RELTRKX  L     EPREG,RTAD               EXIT TO CONVERT TTR TO AN       06140000
         B     RTRKOFFS(0,EPREG)        ACTUAL ADDRESS (19KC+4)  Y02072 06160002
*                                                                       06180000
TRYX     TM    IOBDTYPE,IOBRDEXC        IS THIS A WRITE WITH FEEDBACK   06200002
         BZ    D1NOFDBK                 NO, GO TEST ADDRESS TYPE        06220002
         TM    DCBOPTCD,DCBOPTF         WAS FEEDBACK RELATIVE FOR READ  06240002
         BZ    ACTUAL                   NO, GO MOVE ACTUAL ADDR TO IOB  06260002
D1NOFDBK TM    IOBDTYPE,IOBACTAD        IF ADDRESS IS ALREADY ACTUAL,   06280002
         BO    ACTUAL                   GO MOVE IT TO THE IOB           06300002
         TM    IOBDTYPE,IOBRELBL        IS ADDRESS RELATIVE BLOCK       06320002
         BZ    RELTRKX                  NO, GO TO RELATIVE TRACK EXIT   06340002
*                                                                       06360000
RELRCDX  TM    DCBRECFM,DCBRECTO        IT TRK OVERFLOW PRESENT   13883 06368002
         BO    TRKOV                    YES--GO TO REL BLK/TRK OV 13883 06376016
         L     EPREG,RRAD               NO--CONVERSION MOD EXIT   13883 06384016
         ST    SECTOR,IOBDCPND          ST SECT ADDR WHEN        20201  06385020
*                                       BRANCHING TO             20201  06386020
*                                       THIS MODULE ONLY                06387002
         BALR  RETREG,EPREG             BRANCH TO BLOCK CONVERT  20201  06388020
*                                       RTN                      20201  06389020
         L     SECTOR,IOBDCPND          RESTORE SECTOR ADDR      20201  06390020
         B     CLRCP                    GO CLEAR OUT CHANNEL PGM 20201  06391020
*                                       AREA                     20201  06392020
TRKOV    L     EPREG,RROVAD             TRK OVERFLOW EXIT         13883 06400016
         ST    SECTOR,IOBDCPND                                   20201  06404020
         BALR  RETREG,EPREG             GO TO REL BLK TRK OVFLO  20201  06408020
*                                       MODULE                          06412002
         L     SECTOR,IOBDCPND                                   20201  06416020
*                                                                       06420000
CLRCP    XC    IOBDNRCF(40),IOBDNRCF   CLEAR AREA USED TO STORE REGS    06440002
         B     TYPEDEC                 GO GENERATE CHANNEL PROGRAM      06460002
*                                                                       06480000
*********************************************************************** 06490002
*  THE FOLLOWING ROUTINE DETERMINES THE TYPE OF READ OR WRITE           06500000
*    AND PROVIDES LINKAGE TO THE PROPER MODULE                          06520000
*********************************************************************** 06530002
*                                                                       06540000
ACTUAL   MVC   IOBSEEK,0(PARAM)         MOVE USER ADDRESS TO            06560002
         MVC   IOBUPLIM(7),IOBSEEK      SEEK AND LIMIT FIELDS           06580002
TYPEDEC  LA    RETREG,READY             LOAD COMMON RETURN ADDRESS      06600000
*                                                                       06601020
*    RPS IS TESTED FOR HERE. IF RPS IS TO BE USED, X'FF' AND THE        06602002
*    ADDRESS OF THE LAST DOUBLE WORD ARE PASSED IN IOBDCPND. ELSE X'00' 06603002
*    AND THE ADDRESS OF THE LAST DOUBLE WORD ARE PASSED IN IOBDCPND     06605002
*                                                                       06606020
         ST    SECTOR,IOBDCPND          STORE LAST DOUBLE WORD   20201  06607020
         SR    EPREG,EPREG              ZERO OUT WORK REG        Y02072 06608002
         LA    WKREG3,DEBBASND          GET ADDR OF DEV SECT     Y02072 06608402
         USING DEBDASD,WKREG3           ESTABLISH BASE, DEV SECT Y02072 06608802
         L     WKREG3,DEBUCBAD          GET UCB FROM 1ST EXT     Y02072 06609402
         DROP  WKREG3                   DROP DEB DEV SECT BASE   Y02072 06609802
         USING UCBOB,WKREG3             ESTABLISH UCB BASE       Y02072 06610202
         TM    UCBTBYT2,RECREDY         DOES THIS UCB HAVE RPS   Y02072 06612502
         DROP  WKREG3                                            Y02072 06613002
         BNO   AROUND                   NO, BRANCH AROUND        20201  06614020
         MVI   IOBDCPND,FF              MOVE IN THE RPS ID       20201  06615002
AROUND   EQU   *                                                 20201  06616020
         LA    WKREG2,IOBCHNPR          INITIALIZE CCW INDEX            06620002
*                                                                       06640000
OVERMVC  TM    IOBDTYP2,IOBTYPE+IOBADDTY  IS TYPE KEY OR WRITE ADD      06660002
         BZ    IDEXIT                   NO, GO GENERATE ID CHAN PROGRAM 06680002
         MVI   IOBR,0                   MAKE R BYTE 0 TO SEARCH ON R0   06700002
*                                                                       06720000
         TM    IOBDTYP2,IOBADDTY        IS TYPE WRITE ADD               06740002
         BO    SOMEWA                   YES, GO TEST RECORD FORMAT      06760002
TEST4KEY CLI   DCBKEYLE,0               HAVE KEYS BEEN SPECIFIED        06780002
         BE    SETNOKEY                 NO, GO SET ERROR CODE           06800002
         L     WKREG1,DECKYADR          LOAD AND TEST FOR MISSING KEY   06820002
         LTR   WKREG1,WKREG1            ADDRESS FIELD IN DECB           06840000
         BNZ   PROCEED                  IF NOT MISSING GO TEST EXIT     06860002
SETNOKEY IC    INTRET,INVKEY            SET INVALID REQUEST CODE        06880002
         B     LATERR                   GO POST COMPLETION, FREE IOB    06900002
*                                                                       06920000
PROCEED  TM    IOBDTYP2,IOBTYPE         IS TYPE KEY                     06940002
         BZ    SELFOR                   NO, GO TO WRITE ADD EXIT        06960002
         L     EPREG,KEYMODAD           EXIT TO GENERATE KEY CHANNEL    06980002
         BR    EPREG                    PROGRAM                         07000002
IDEXIT   L     EPREG,IDMODAD            LOAD ID MODULE ADDRESS AND      07020002
         BR    EPREG                    GO TO GENERATE ID CHANNEL PROG. 07040002
*                                                                       07060000
SOMEWA   TM    DCBRECFM,DCBRECV         DATA SET FIXED LENGTH RECORDS   07080002
         BZ    TEST4KEY                 IF YES, GO TEST KEYS PRESENT    07100002
SELFOR   L     EPREG,DCBDFOR            LOAD ENTRY POINT OF THE         07120002
         BR    EPREG                    WRITE ADD MODULE AND BR. TO IT  07140002
*                                                                       07160000
*                                                                       07180000
READY    EQU   *                                                        07200000
         TM    DCBOPTCD,DCBOPTTO        TEST FOR TRACK OVERFLOW         07220002
         BZ    EXPCTEND                 NOT PRESENT, NO NOP CCW         07240002
         OI    4(WKREG2),CCHN           TURN ON COMMAND CHAIN BIT       07260002
         LA    WKREG2,8(0,WKREG2)       UPDATE TO NEXT CCW              07280002
         MVI   0(WKREG2),NOPCODE        PUT IN NOP OP CODE              07300002
         MVI   4(WKREG2),SILI           TURN ON SILI BIT IN NOP CCW     07320002
         MVI   7(WKREG2),ONE            SET A NON-ZERO COUNT IN NOP CCW 07340002
EXPCTEND EQU   *                                                        07360000
         LA    WKREG2,8(0,WKREG2)       UPDATE POINTER TO PROGRAM END   07380002
         ST    WKREG2,IOBDCPND          EXPECTED ENDING ADDRESS         07400002
         MVC   IOBDNRCF+1(1),IOBBB2     MOVE 'B' TO INLINE SEEK AREA    07420002
*                                                                       07440000
*********************************************************************** 07450002
*     THE FOLLOWING TESTS FOR 2305 FIXED WRITE ADD FUNCTION. IF IT IS * 07454002
*     SVC 53 MUST BE ISSUED TO ENQUEUE EITHER ON R0 OF THE TRACK      * 07456002
*     REQUESTED (NO EXTENDED SEARCH) OR ON R0 OF THE 1ST TRACK IN     * 07456402
*     THE DATA SET (EXTENDED SEARCH). IT IS NECESSARY TO HAVE EXCLU-  * 07456802
*     SIVE CONTROL TO PREVENT MULTIPLE WRITE ADD REQUESTS ON THE      * 07457202
*     SAME TRACK FROM FINDING AND UPDATING THE SAME DUMMY RECORD.     * 07457602
*     SVC 53 (IGC0005C) WILL EITHER ENQ ON THE PARTICULAR BLOCK AND   * 07458002
*     ISSUE THE EXCP, OR THE IOB WILL BE PUT ON THE IOB UNPOSTED      * 07458402
*     QUEUE. WHEN THE IOB DOES GAIN CONTROL OF THE BLOCK, IGC0005C    * 07468402
*     WILL ISSUE THE EXCP FOR THIS REQUEST.                           * 07470402
*********************************************************************** 07474402
CHK2305  EQU   *                        IS IT 2305 WRITE ADD     Y02072 07480002
         TM    IOBDTYP2,IOBADDTY        IS TYPE WRITE ADD        Y02072 07481902
         BNO   EXCP                     NO, GO ISSUE EXCP        Y02072 07483902
         TM    DCBRECFM,DCBRECV         IS RECORD FORMAT FIXED   Y02072 07484302
         BO    EXCP                     NO, GO ISSUE EXCP        Y02072 07484702
         LA    WKREG1,DEBBASND          GET DEV DEP SECT         Y02072 07485102
         USING DEBDASD,WKREG1           EST BASE FOR DEV SECT    Y02072 07485502
         L     WKREG1,DEBUCBAD          GET UCB FOR 1ST EXTENT   Y02072 07485902
         DROP  WKREG1                   DROP DEV DEP SECT BASE   Y02072 07487902
         USING UCBOB,WKREG1             UCB ADDRESSABILITY       Y02072 07492002
         CLI   UCBTBYT4,UCB23051        IS DEVICE 2305-1?        Y02072 07494002
         BE    ISSUESVC                 IF 2305,WA,FIXED,GO ENQ  Y02072 07496002
         CLI   UCBTBYT4,UCB23052        IS DEVICE 2305-2?        Y02072 07498002
         BNE   EXCP                     NO, GO ISSUE EXCP        Y02072 07500002
         DROP  DEBREG,WKREG1                                     Y02072 07513802
*                                                                       07513902
*      SVC 53 (EXCLUSIVE CONTROL) WILL BE ISSUED. IGC0005C EXPECTS      07515102
*      REG 1 TO CONTAIN THE IOB ADDRESS, COMPLEMENTED.                  07517102
*                                                                       07518302
ISSUESVC EQU   *                        GO TO XCLUSIVE CNTRL MOD Y02072 07518702
         LCR   PARAM,IOBREG             LOAD COMPLEMENT OF IOB   Y02072 07527202
*                                                                       07527602
         SVC   53                       GO TO ENQ RECORD         Y02072 07528002
*                                                                       07528102
         B     RSTOR                    RETURN TO THE USER       Y02072 07528402
*********************************************************************** 07528502
*                                                                       07533002
EXCP     LR    PARAM,IOBREG             LOAD IOB ADDR AS THE PARAMETER  07537502
         EXCP  (1)                                                      07542002
*                                                                       07546502
RSTOR    RETURN (14,12),T,RC=0                                          07551002
*                                                                       07555502
*                                                                       07560000
*********************************************************************** 07570002
*    THE FOLLOWING ROUTINE COMPLETES THE PROCESSING OF AN INVALID       07580000
*     REQUEST AND RETURNS TO THE USER.                                  07600000
*********************************************************************** 07610002
*                                                                       07620000
LATERR   TM    IOBDAVLI,AVLMSK          IF THE AVAILABILITY BIT IS SET  07640002
         BO    FRMPOOL                  THIS IOB IS LINKED TO THE POOL  07660002
         LH    PARAM2,IOBDIOBS          SET SIZE PARAMETER FOR FREEMAIN 07680002
         LR    PARAM,IOBREG             SET ADDRESS PARAMETER           07700002
         FREEMAIN R,LV=(0),A=(1)                                        07720000
         B     ABORT                                                    07740000
*                                                                       07760000
FRMPOOL  EQU   *                                                        07780000
         MVI   IOBDAVLI,0               AVAILABLE                       07800002
ABORT    AH    INTRET,INVREQ            SET INVALID REQUEST EXCEPT CODE 07820002
         SR    WKREG2,WKREG2            ZERO OUT THE IOB POINTER FIELD  07840002
         ST    WKREG2,DECIOBPT          OF THE DECB                     07860002
         LR    PARAM2,INTRET            POSITION THE POST CODE          07880002
         SLL   PARAM2,8                 (EXCEPTION CODES)               07900002
         LR    PARAM,DECBREG            LOAD ECB ADDRESS PARAMETER      07920002
         MVI   0(PARAM),0               AND CLEAR THE OLD POST CODE AND 07940000
         LA    PARAM,0(0,PARAM)         CLEAR HIGH ORDER BITS    A29259 07950019
         POST  (1),(0)                  POST.                           07960002
         B     RSTOR                    GO RESTORE REGISTERS AND RETURN 07980002
*                                                                       08000000
OPSMSK   DC    F'6'                     OPTIONS-READX,DYNAMIC BFR.      08020002
ZEROS    EQU   OPSMSK                   PLUS ZEROS FOR COMPARING.       08040000
*                                                                       08060000
INVID    DC    X'08'                    INVALID ZERO ID                 08080002
INVOPT   DC    X'02'                    INVALID OPTIONS                 08100002
INVWRT   DC    X'40'                    WRITE TO INPUT DATA SET         08120002
INVLIMCT DC    X'20'                    EXTENDED SEARCH, LIMIT IS ZERO  08140002
INVREQ   DC    H'4096'                  INVALID REQUEST BIT             08160002
*                                                                       08180000
K49      DC    H'49'                    CONSTANT 49                     08200002
INVKEY   DC    X'04'                    KEYS ARE MISSING                08220002
AVLMSK   EQU   X'80'          IOB AVAILABILITY FLAG                     08240000
FIXDMSK  EQU   X'40'          FORMAT 'F' DATA SET                       08260000
VFORM    EQU   X'80'          FORMAT 'V' DATA SET                       08280000
WRTMSK   EQU   15             DCB WAS OPENED FOR OUTPUT OR UPDATE       08300000
*                                                                       08320000
IOBSZ255 DC    H'255'                   COMPARATOR FOR IOB SIZE  20201  08330020
BASESZ   EQU   X'78'                    IOBBASE SIZE =120 BYTES  20201  08340020
ADDSZ    EQU   X'68'                    WRITE ADD =104 BYTES     YM2862 08350002
VERSZ    EQU   X'30'                    VERIFT SIZE INCREMENT =  20201  08360020
*                                       48                       20201  08370020
SFSZ     EQU   X'010'         SELF-FORMAT INCREMENT = 16 BYTES          08400000
XSCHSZ   EQU   X'028'         EXTENDED SEARCH (KEY) INCREMENT=   S19015 08410019
*                                       40 BYTE                  S19015 08420019
PFEXTSZ  EQU   X'60'                    PRE-FORMAT INCREMENT=96  20201  08440020
FDBSZ    EQU   X'038'                   FEEDBACK(K) INCR=56      20201  08443020
Q1       EQU   1                        ONE BYTE QUANTITY        20201  08446020
Q255     EQU   255                      255 BYTE QUANTITY        20201  08449020
RRINCR   EQU   8                                                 20201  08452020
FOUR     EQU   4                                                 20201  08455020
UCBADDR  EQU   32                                                20201  08458020
UCB23051 EQU   X'06'                    UCB TYPE BIT, 2305-1     Y02072 08460002
UCB23052 EQU   X'07'                    UCB TYPE BIT, 2305-2     Y02072 08462002
RECREDY  EQU   X'10'                                             20201  08464020
OLDOPTS  EQU   X'16'          READX + DYN BUFF + FEEDBACK      @YA19662 08465037
FF       EQU   X'FF'                                             20201  08467020
RDXCORE  DC    H'28'                    RD EXCLUSIVE ADDITIVE    20201  08470020
OFLINCR  EQU   8                       BYTES NECESSARY FOR OVERFLOW     08480000
*                                      RECORDS IN IOB(FOR EXTRA CCW)    08500000
*                                                                       08520000
RDADD    EQU   X'0A'          TEST FOR READ OR WRITE ADD                08540000
ADDKY    EQU   X'06'          TEST FOR KEY OR ADD                       08560000
RDXFDB   EQU   X'12'          TEST FOR READ EXCLUSIVE OR FEEDBACK       08580000
CPFLAG   EQU   X'42'          SET UNRELATED, COMMAND CHAIN BITS         08600000
SILI     EQU   X'20'         SUPPRESS INCORRECT LENGTH INDICATION       08620000
NOPCODE  EQU   X'03'     NO OP                                          08640000
ONE      EQU   X'01'                    COUNT OF ONE                    08660002
CCHN     EQU   X'40'                    COMMAND CHAIN BIT IN CCW        08680002
ENQPL    EQU   28                       ENQUE LIST LENGTH               08700000
CNVENTRY EQU   12                       ENTRY IN ADDR CONV RTN   A35339 08710021
*                                                                       08720000
         DROP  DECBREG,IOBREG,DCBREG,FDNBASE                     Y02072 08730002
         EJECT                                                          08740000
        TITLE 'IGG019KA-BDAM FOUNDATION MODULE, NO VS - ASI ROUTINE'    08750002
*                                                                       08760000
*                                                                       08780000
*  ASYNCHRONOUS INTERRUPT ROUTINE:                                      08800002
*        THIS ROUTINE IS ENTERED BY THE SUPERVISOR SO THAT BDAM MAY     08820002
*      COMPLETE THE PROCESSING OF A REQUEST.                            08840002
*      BDAM EXPECTS THE FOLLOWING REGISTER USAGE'                       08860002
*        1 RQE ADDRESS                                                  08880002
*       14 RETURN POINT                                                 08900002
*       15 ENTRY POINT OF THIS ROUTINE                                  08920002
*                                                                       08940000
         USING IECDFDNA,EPREG                                           08960000
*                                                                       09010002
R0       EQU   0                  PARAM REG ON RETURN FROM SVC53 Y02072 09062002
RIOB     EQU   2                  IOB ADDRESS                           09070001
RRQE     EQU   7                  RQE BASE REGISTER              Y02072 09080002
WORKR7   EQU   7                  WORK REGISTER                  Y02072 09090002
RETURN   EQU   9                  RETURN REGISTER FOR READX & ADD       09100001
READADD  EQU   10                 ENTRY POINT REG FOR READX & ADD       09120001
WORKR2   EQU   14                 WORK REGISTER IN ASI ROUTINE          09122002
RRETCODE EQU   15                 RETURN CODE REGISTER                  09126001
FREEDBUF EQU   57                 FREE DYNAMIC BUFFER SVC               09132001
*                                                                       09140000
IECDFDNA B     DASIA       ENTRY FROM SUPERVISOR                        09160002
         B     DASIB       ENTRY FROM SELF-FORMAT                       09180002
         B     DASIC       ENTRY TO CLEAN UP AND POST.                  09200002
         B     DASID       ENTRY TO POST (FROM SELF FORMAT MOD)  YM3850 09202002
*                          IF ERROR. SELF FORMAT ASSUMES THAT THE NEXT  09206002
*                          IOB ADDR IS SAVED IN REG 6 AND MUST BE MAIN- 09208002
*                          TAINED THROUGHOUT ASI PROCESSING ON THIS     09208402
*                          PATH. CONTROL IS RETURNED TO 19KM VIA        09208802
*                          THE ADDR PUT IN IOBDQPTR BY 19KM.            09209202
*                                                                       09210002
*                                                                       09220002
*                                                                       09230002
*                                                                       09240000
DASIA    EQU   *                                                        09260000
         LR    FDNBASE,EPREG            MOVE BASE TO TRANSPARENT REG.   09270002
         DROP  EPREG                                                    09272002
         USING IECDFDNA,FDNBASE         PICK UP NEW BASE                09274002
         LR    RRQE,PARAM               SAVE IOS RQE ADDRESS     Y02072 09280002
         USING RQE,RRQE                 RQE ADDRESSABILITY       Y02072 09290002
         L     PARAM,RQEIOB             GET IOB ADDRESS FROM RQE Y02072 09300002
         USING IOBSTDRD,PARAM           IOB ADDRESSABILITY       Y02072 09302002
         L     SAVE,IOBDCBPT            ESTABLISH DCB BASE       Y02072 09310002
         USING IHADCB,SAVE              DCB ADDRESSABILITY       Y02072 09312002
         LR    INTRET,RETREG            MOVE SUPERVISOR RETURN ADDRESS. 09320002
         L     DECBREG,IOBECBPT         GET DECB ADDRESS                09326002
         USING DECB,DECBREG                                             09332001
*                                                                       09334002
*********************************************************************** 09336002
*  THE FOLLOWING ROUTINE LINKS IOBS TO THE DCB POOL IF THEY WERE      * 09338002
*  OBTAINED BY GETMAIN. THEY ARE ADDED IN ORDER OF INCREASING SIZE.   * 09338402
*********************************************************************** 09338502
POOLIOB  EQU   *                        POOL THE IOB             Y02072 09338902
         L     WKREG3,IOBDPLAD          WAS IOB FROM POOL OR     Y02072 09339202
         LTR   WKREG3,WKREG3            OBTAINED BY GETMAIN      Y02072 09339602
         BNZ   INPOOL                   IF NOT 0,ALREADY IN POOL Y02072 09339702
*                                                                       09339802
POOL     EQU   *                        ADD NEW IOB TO IOB POOL  Y02072 09339902
         MVI   IOBDAVLI,UNAVALSW        MARK CURRENT IOB UNAVAIL Y02072 09341902
*                                       ABLE BEFORE ADD TO POOL  Y02072 09343902
         LA    PARAM,0(0,PARAM)         INSURE 0 HI-ORDER BYTE   A30797 09346602
         L     WKREG3,DCBIOBAD          PUT DCB POOL ADDRESS IN         09348602
         LA    WORKR2,NULL(WKREG3)      BOTH WORK REGS.                 09350602
LOOP     LA    WKREG3,NULL(WKREG3)      CLEAR HI BYTE.                  09352602
         LTR   WKREG3,WKREG3            ANY IOB'S BEYOND THIS.          09353002
         BZ    TSTEQ                    NO, GO TEST FOR FIRST IOB       09353102
*                                                                       09353202
*   PUT IOB ON POOL IN ORDER OF INCREASING SIZE. PUT NEW IOB IN QUEUE   09359902
*   AS THE FIRST IOB IN THAT SIZE GROUP.                                09361902
*                                                                       09363902
         CLC   IOBDIOBS,IOBDIOBS-IOBSTDRD(WKREG3)                       09365902
         BH    SEENEXT1                 NEW IOB IS LARGER               09366302
         IC    PARAM2,IOBDAVLI          SAVE AVAILABILITY BYTE   Y02072 09367402
         SLL   PARAM2,SHFT3BYT          WHILE STORING INTO       Y02072 09369402
         OR    WKREG3,PARAM2            IOB CHAINING FIELD       Y02072 09369802
         ST    WKREG3,IOBDPLAD          STORE NXT IOB ADDR IN    A30797 09370102
         LA    WKREG3,0(WKREG3)         CLR TOP BYTE TO COMPARE  Y02072 09372102
TSTEQ    CR    WKREG3,WORKR2            IF EQUAL, THIS IOB IS THE       09373202
         BE    FIRSTIOB                 FIRST ONE TO BE POOLED          09375202
*                                                                       09377202
*   RELINK THE POOL CHAIN WITHOUT DESTROYING THE AVAILABILITY FLAG.     09379202
*                                                                       09379602
         IC    PARAM2,IOBDAVLI-IOBSTDRD(WORKR2)                   21905 09379702
         SLL   PARAM2,SHFT3BYT                                          09379802
         OR    PARAM,PARAM2                                       21905 09380002
         ST    PARAM,IOBDPLAD-IOBSTDRD(WORKR2)                          09389902
         LA    PARAM,0(PARAM)           CLEAR TOP BYTE-NOT NEG   YM1458 09399902
         B     INPOOL                   CONTINUE IOB PROCESSING  Y02072 09403202
*                                                                       09405202
FIRSTIOB ST    PARAM,DCBIOBAD           INSERT THIS IOB AS TOP OF CHAIN 09405602
         B     INPOOL                   CONTINUE IOB PROCESSING  Y02072 09406402
SEENEXT1 LR    WORKR2,WKREG3            SAVE THE ADDRESS OF PRIOR LINK, 09406502
         L     WKREG3,IOBDPLAD-IOBSTDRD(WKREG3)  LOAD THE ADDRESS OF    09406602
*                                       THE NEXT IOB IN POOL            09409902
         B     LOOP                     GO TEST LINK ADDRESS = ZERO     09411902
*                                                                       09412302
*********************************************************************** 09412402
*                                                                       09413202
INPOOL   EQU   *                        TEST FOR ERRORS          Y02072 09413302
         TM    IOBSTAT1,IOBNEWVL        DID END OF EXTENT CAUSE ASI     09413402
         BZ    TSTERR                   NO, CONTINUE LOOKING FOR CAUSE. 09416702
         XI    IOBSTAT1,IOBNEWVL+IOBABNRM   CLEAR EXCP AND ABNORM BITS  09420002
         L     DECBREG,IOBECBPT         LOAD USER DECB ADDR      Y02072 09424002
         ST    DECBREG,IOBDQPTR         SAVE IT IN IOB TO BE     Y02072 09426002
*                                       RESTORED BY CEA OR EOE   Y02072 09428002
         LA    WKREG2,IOBCSW+3          GET CSW ADDRESS TO USE   Y02072 09432002
         ST    WKREG2,IOBECBPT          AS DUMMY ECB FOR IOS     Y02072 09434002
         EXCP  (1)                      RESTART THE CHANNEL PROGRAM     09440000
         BR    INTRET                   GO BACK TO SUPERVISOR.   Y02072 09480002
*                                                                       09500000
TSTERR   EQU   *                        IS THERE AN ERROR        Y02072 09570002
         DROP  RRQE                                              Y02072 09582802
         ST    INTRET,IOBDQPTR          SAVE SUPVERVISOR RETURN IN IOB. 09636902
         TM    IOBSTAT1,IOBABNRM        WAS THIS ABNORMAL COMPLETION    09640002
         BO    ASIERR                   BRANCH IF YES                   09660000
         TM    IOBDTYPE,IOBRDEXC        IS READX EXCLUSIVE SPECIFIED    09680002
         BO    ENQRCD                   YES CHECK IF RECORD ENQ'D       09700000
         TM    IOBDTYP2,IOBADDTY        IS WRITE ADD SPECIFIED          09720002
         BZ    ASI2NDEN                 NO TEST FOR CHANNEL PROGRAM END 09740000
         TM    DCBRECFM,DCBRECV         IS THIS FIXED LENGTH RECORDS    09760002
         BZ    ASI2NDEN                 YES, TEST FOR CHANNEL PROG. END 09780000
ENQRCD   EQU   *                                                        09800000
         TM    IOBDTYP2,IOBRQUST+IOBADDTY  IS THIS A READ OR WRITE ADD  09820002
         BZ    ASI2NDEN                 NO TEST FOR CHANNEL PROGRAM END 09840000
         TM    IOBSTAT1,IOBENQUE        HAS RECORD BEEN OBTAINED YET    09860002
         BO    ASI2NDEN                 YES-GO TEST FOR PROGRAM END     09880002
         TM    IOBDTYP2,IOBADDTY        IS THIS A WRITE ADD       13513 09883002
         BO    ENQUEUE                  YES--ENQUEUE IT           13513 09886015
         CLC   IOBDCPND+SKPHIBYT(CMP3BYTS),IOBCSW     CHANNEL           09889001
*                                               PROGRAM FINISHED?       09891002
         BNE   ASIERR2                  NO RECORD FOUND           24512 09892018
         B     ENQUEUE                  ELSE GO ENQ RECORD       Y02072 09894002
*                                                                       09894402
*                                                                       09894802
ASI2NDEN CLC   IOBDCPND+SKPHIBYT(CMP3BYTS),IOBCSW     WAS CHANNEL       09960001
*                                                 PROGRAM FINISHED?     09962001
         BE    DASIE                    BRANCH IF COMPLETE              09980000
         TM    IOBDTYP2,IOBADDTY         IS THIS A WRITE ADD            10000002
         BZ    ASIERR2                  BRANCH IF AN ERROR        24512 10020018
         TM    DCBRECFM,DCBRECV         FIXED LENGTH RECORDS            10040002
         BZ    ASIERR2                  IF SO, AN ERROR OCCURRED  24512 10060018
         L     READADD,DCBDFOR          GET BASE OF SELF FORMAT MODULE  10080002
         B     ASIWAENT(READADD)        AND BRANCH TO IT                10100002
*                                                                       10120000
DASIB    TM    IOBDTYPE,IOBRDEXC+IOBFDBCK  IF NOT READ EXCLUSIVE OR     10140002
         BZ    DASIC                    FEEDBACK OPTION, SKIP NEXT RTN. 10160002
*                                                                       10180000
*                                                                       10190002
*  THE FOLLOWING ROUTINE LOCATES OR DEVELOPS ACTUAL ADDRESS FOR USE AS  10200000
*     FEEDBACK AND/OR READ EXCLUSIVE ARGUMENT                           10220000
*                                                                       10230002
*                                                                       10240000
         TM    IOBSTAT1,IOBADDVU        IS THIS A SELF FORMAT ADD       10260002
         BO    TSTEXIT                  YES-SKIP MOVING FEEDBACK        10280000
         MVC   IOBSEEK+2(6),IOBDNRCF+1  ELSE MV ACTUAL TO COMMON FIELD  10300002
*                                                                       10320000
*  IF THIS WAS A WRITE TO RELEASE AN EXCLUSIVE RECORD, GO TO THE READ   10340000
*   EXCLUSIVE MODULE WITHOUT TESTING FOR FEEDBACK TO BE RETURNED.       10360000
*                                                                       10380000
TSTEXIT  TM    IOBDTYP2,IOBRQUST        IS THIS A READ OR WRITE         10400002
         BO    TSTFDB                   READ, GO TEST FOR FEEDBACK      10420002
         TM    IOBDTYPE,IOBRDEXC        WRITE AND EXCLUSIVE BITS SET,   10440002
         BO    RDXEXIT                  GO TO THE READX MODULE          10460002
TSTFDB   TM    DCBOPTCD,DCBOPTF         DCB DOES NOT SPECIFY            10480002
         BZ    ACTFDBK                  FEEDBACK                        10500002
         TM    IOBDTYPE,IOBACTAD        OR ADDRESSING IS ACTUAL         10520002
         BZ    TSTRR                    RETURN                          10540002
ACTFDBK  L     WKREG3,IOBECBPT          ACTUAL ADDRESS                  10560002
         L     WKREG3,DECRECPT-DECB(WKREG3)  AS                         10580002
         MVC   0(8,WKREG3),IOBSEEK      FEEDBACK.                       10600002
         B     DASIC                    GO TEST FOR DYNAMIC BUFFERING   10620000
DASIE    TM    IOBDTYPE,IOBRDEXC        IS THIS A READX                 10640002
         BO    DASIB                    BRANCH IF YES                   10660000
         TM    IOBDTYP2,IOBRQUST        IS THIS A READ                  10680002
         BO    DASIB                    BRANCH IF YES                   10700000
         TM    IOBDTYP2,IOBADDTY        IS THIS WRT ADD REQUEST  Y02072 10760002
         BZ    DASIB                    BRANCH IF NO                    10780000
         TM    DCBRECFM,DCBRECV         IS THIS V OR U FORMAT    Y02072 10782002
         BO    DEQUEUE                  YES,GO DEQ R0 FOR V,U    Y02072 10782402
         L     DEBREG,DCBDEBAD          GET DEB ADDRESS          Y02072 10782802
         USING DEBBASIC,DEBREG          DEB ADDRESSABILITY       Y02072 10783202
         LA    WKREG1,DEBBASND          GET ADDR OF DEV SECT     Y02072 10783302
         USING DEBDASD,WKREG1           EST BASE FOR DEVICE SECT Y02072 10783402
         L     WKREG1,DEBUCBAD          GET UCB ADDRESS,1ST EXT  Y02072 10783602
         DROP  WKREG1                   DROP DEV SECT BASE       Y02072 10784002
         USING UCBOB,WKREG1             UCB ADDRESSABILITY       Y02072 10784502
         CLI   UCBTBYT4,UCB23051        IS DEVICE 2305-1?        Y02072 10786502
         BE    DEQUEUE                  YES, MUST DEQ R0 THEN    Y02072 10786902
         CLI   UCBTBYT4,UCB23052        IS DEVICE 2305-2?        Y02072 10787302
         BE    DEQUEUE                  YES, MUST DEQ R0 THEN    Y02072 10788002
         B     DASIB                    NO, NO EXCLUSIVE CONTROL Y02072 10790002
         DROP  WKREG1,DEBREG            DROP UCB,DEB BASES       Y02072 10792002
*                                                                       10794302
         SPACE 2                                                        10794702
*********************************************************************** 10796002
*  THE FOLLOWING ARE THREE EXITS TO THE READ EXCLUSIVE MODULE, SVC 53 * 10798002
*  (IGC0005C). THE FIRST SVC CALL IS ISSUED TO ENQUEUE ON A RECORD    * 10798402
*  WHEN READ EXCLUSIVE OR WRITE ADD HAS BEEN REQUESTED.  THE SECOND   * 10798802
*  SVC CALL IS ISSUED TO DEQUEUE A BLOCK OBTAINED DURING WRITE ADD    * 10799202
*  PROCESSING.  THE THIRD SVC CALL IS ISSUED TO DEQUEUE A BLOCK READ  * 10799602
*  IN DURING READ EXCLUSIVE (I.E. WRITE RELEASE). IGC0005C EXPECTS    * 10799702
*  THAT REGISTER 1 WILL CONTAIN THE IOB ADDRESS,COMPLEMENTED.         * 10799902
*********************************************************************** 10808602
ENQUEUE  EQU   *                        ENQUEUE ON BLOCK         Y02072 10850002
         LCR   PARAM,PARAM              REG 1,IOB -COMPLEMENTED  Y02072 10851202
*                                                                       10851602
         SVC   53                       GO ENQUEUE CURRENT REC   Y02072 10851702
*                                                                       10851802
         SVC   EXIT                     RETURN TO SUPERVISOR            10851902
*                                                                       10853902
DEQUEUE  EQU   *                        DEQUEUE WRITE ADD REQ    Y02072 10856402
         LR    RIOB,PARAM               SAVE IOB REG IN R2       Y02072 10856602
         LCR   PARAM,PARAM              REG 1,IOB -COMPLEMENTED  Y02072 10856802
         DROP  PARAM                    DROP IOB BASE FOR SVC    Y02072 10857202
*                                                                       10858502
         SVC   53                       GO DEQUEUE CURRENT REC   Y02072 10858802
*                                                                       10859102
         LR    PARAM,RIOB               RESTORE IOB REG          Y02072 10859202
         USING IOBSTDRD,PARAM           REESTABLISH ADDRESSING   Y02072 10859302
         TM    DCBRECFM,DCBRECV         VAR,UNDEF RECORD FORMAT? Y02072 10861302
         BNO   CHKERR                   NO,GO CHECK IF ERR       YM6585 10863302
         LTR   R0,R0                    IS THERE NEXT IOB?       Y02072 10863402
         BZ    DASIB                    NO,GO CHECK DYN BUF      Y02072 10863502
         LR    PARAM,R0                 PUT NEXT IOB IN R1;19KM  Y02072 10863602
*                                       ALSO EXPECTS ITS BASE    Y02072 10865602
*                                       IN R10, THE DCB IN R13   Y02072 10865802
         L     READADD,DCBDFOR          ADDR OF 19KM,SELF FORMAT Y02072 10865902
         B     ASIWAENT(READADD)        BR TO FORMAT MOD         Y02072 10867902
CHKERR   EQU   *                        2305 ERROR CHECK         YM6585 10869902
         TM    IOBSTAT2,ALLMSK          WERE THERE ANY ERRORS    YM6585 10870302
         BNO   DASIB                    NO, GO GET FDBACK THEN   YM6585 10870702
         B     DASIC                    YES,JUST FREE BUF & POST YM6585 10874802
*                                                                       10879102
RDXEXIT  EQU   *                        DEQUEUE WRT REL REQ      Y02072 10883202
         LR    RIOB,PARAM               SAVE IOB REG IN R2       Y02072 10887302
         LCR   PARAM,PARAM              REG 1,IOB -COMPLEMENTED  Y02072 10891402
         DROP  PARAM                    DROP IOB BASE FOR SVC    Y02072 10895502
*                                                                       10899602
         SVC   53                       GO DEQUEUE CURRENT REC   Y02072 10899702
*                                                                       10899802
         LR    PARAM,RIOB               RESTORE IOB REG          Y02072 10899902
         USING IOBSTDRD,PARAM           REESTABLISH ADDRESSING   Y02072 10906602
         B     DASIC                    CHECK FOR DYNAMIC BUFFERING     10913302
*                                                                       10920000
*********************************************************************** 10930002
*                                                                       10932002
TSTRR    LA    INTRET,DASIC             SET UP TO TEST FOR DYN. BUFF.   10940000
*                                       ON RETURN FROM ADDR CONVERSION  10960000
         TM    IOBDTYPE,IOBRELBL        IS RELATIVE RECORD BEING        10980002
         BZ    RTEXIT                   USED,NO-GO TO RELATIVE TRACK    11000002
         L     EPREG,DCBDFBK            LOAD ENTRY POINT OF FEEDBACK    11020002
         BR    EPREG                    MODULE AND GO THERE             11040002
*                                                                       11060000
RTEXIT   L     EPREG,DCBREAD            LOCATE THE                      11080002
         L     EPREG,8(0,EPREG)         ADDR OF RELATIVE TRACK MODULE   11100002
         BR    EPREG                    AND GO THERE             Y02072 11130002
*                                                                       11140000
*                                                                       11160000
DASIC    TM    IOBDTYP2,IOBRQUST        IS THIS A READ REQUEST          11180002
         BO    MAKEAVL                  YES-MAKE IOB AVAILABLE   Y02072 11200002
         TM    IOBDTYPE,IOBDYNBF        NO-TEST FOR DYN. BUFFERING      11220002
         BZ    MAKEAVL                  NO-MAKE IOB AVAILABLE    Y02072 11240002
*                                                                       11260021
*                       FREE DYNAMIC BUFFER                             11264021
*                                                                       11268021
         LR    SAVE,PARAM               SAVE IOB POINTER         XM5413 11270001
         USING IOBSTDRD,SAVE                                            11272001
         L     PARAM2,IOBECBPT          ADDR OF DECB             A30797 11276002
         L     PARAM,IOBDCBPT           ADDR OF DCB              A30797 11280002
         FREEDBUF (0),D,(1)             ISSUE FREEDBUF SVC CALL  A30797 11284002
         LR    PARAM,SAVE               RESTORE IOB POINTER      A30797 11288002
         USING IOBSTDRD,PARAM                                           11290001
         L     SAVE,IOBDCBPT            RESTORE DCB POINTER      A30797 11292002
         USING IHADCB,SAVE                                              11294002
*                                                                       11296002
DASID    EQU   *                        ENTRY FOR POST ROUTINE   YM3850 11298002
*                                                                       11300000
*  THE FOLLOWING ROUTINE POSTS THE ECB COMPLETE AND ZEROS THE IOB       11322002
*  AVAILABILITY BYTE IN THE IOB.                                        11324002
*                                                                       11380000
MAKEAVL  SR    PARAM2,PARAM2            CLEAR FOR EXCEPTION CODES.      11460002
         IC    PARAM2,IOBSTAT2          INSERT EXCEP CODES FROM THE IOB 11480002
         SLL   PARAM2,16                POSITION THEM FOR POST.         11500002
         LR    RIOB,PARAM               SAVE IOB REG IN POST     Y02072 11550002
         DROP  PARAM                                             Y02072 11560002
         USING  IOBSTDRD,RIOB           NEW BASE FOR IOB         Y02072 11570002
         L     FDNBASE,IOBDQPTR         LOAD SAVED SUPER RETURN  YM5969 11580002
         L     PARAM,IOBECBPT           SET DECB PARAMETER              11600002
*                                                                       11620000
         POST  (1),(0)                  AND POST.                       11640000
*                                                                       11680000
         TM    DCBMACRF,DCBMRCK         IS CHECK MACRO SPECIFIED Y02072 11692002
         BOR   FDNBASE                  YES, RETURN DIRECTLY     Y02072 11694002
         MVI   IOBDAVLI,NULL            ELSE, MAKE IOB AVAILABLE Y02072 11696002
         BR    FDNBASE                  RETURN TO SUPERVISOR     Y02072 11698002
         DROP  RIOB                     DROP TEMPORARY IOB BASE  Y02072 11698402
         USING IOBSTDRD,PARAM           REESTABLISH OLD IOB BASE Y02072 11698802
*                                                                       11700000
*                                                                       12360000
*    THE FOLLOWING ROUTINE DETERMINES THE CAUSE OF ABNORMAL COMPLETION  12380000
*     BY ANALYZING THE SENSE BYTES AND CSW STORED IN THE IOB BY IOS.    12400002
*                                                                       12420000
*                                                                       12440000
ASIERR   TM    IOBSTAT2,ALLMSK          HAS ERROR ALREADY BEEN FLAGGED  12460002
         BC    4,ERREXIT                IF YES , EXIT                   12480002
         TM    IOBCSW+3,UCMSK           TEST FOR UNIT CHECK             12500002
         BZ    TSTEXC                   BR. IF NOT                      12520002
         TM    IOBSENS0,DCMSK           TEST FOR DATA CHECK             12540002
         BO    SETUDC                   BRANCH IF YES                   12560002
         TM    IOBSENS1,NRMSK           TEST NO RECORD FOUND            12580002
         BZ    SETUE                    IF NOT SET, MUST BE UNRELATED   12600002
ASIERR2  OI    IOBSTAT2,NOREC           SET NO RECORD FOUND EX. CODE    12620002
         TM    IOBDTYP2,IOBADDTY        IS TYPE WRITE ADD               12640002
         BZ    DASIC                    NO, RETURN TO POOLING ROUTINE   12660002
         XI    IOBSTAT2,FLIPMSK         MV NRF TO NO-SPACE-FND   YM5893 12662002
         TM    DCBRECFM,DCBRECV         IS RECFM V,U             YM6585 12670002
         BO    DASIC                    YES, GO RETURN           YM5893 12672002
         TM    IOBSTAT1,IOBENQUE        NO, IS THE ENQUE BIT ON  YM6585 12674002
*                                       COULD ONLY BE ON FOR     YM6585 12676002
*                                       FIXED FORMAT IF 2305     YM6585 12678002
         BNO   DASIC                    NO, GO FREE BUF & POST   YM6585 12678402
         B     DEQUEUE                  YES, GO DEQUEUE REQUEST  YM6585 12678802
*                                       SINCE ENQ'D ON WHOLE DS  YM6585 12678902
*                                                                       12720000
SETUDC   OI    IOBSTAT2,UNCOR           SET UNCORRECTABLE DATA CHECK    12740002
         B     ERREXIT                  GO TEST FOR EXIT                12760002
*                                                                       12780000
TSTEXC   EQU   *                                                        12800000
         TM    IOBCSW+4,INCLMSK         WAS THE RECORD WRONG LENGTH     12820002
         BO    SETINCL                  IF YES GO SET FLAG              12840002
SETUE    OI    IOBSTAT2,UNREL           SET UNRELATED ERROR FLAG        12860002
*                                                                       12880000
ERREXIT  TM    IOBSTAT1,IOBADDVU        IF THIS WAS A FORMAT WRITE,     12900002
         BO    DASID                    GO POST & RETURN       @ZA15675 12920037
         TM    IOBSTAT2,INCLMSK+ENDOD   IF INCORRECT LENGTH OR END OF   12940002
         BC    7,DASIB                  DATA SET, GO CHECK FEEDBACK     12960000
         B     DASIC                    ELSE BYPASS FEEDBACK TEST       12980002
*                                                                       13000000
SETINCL  OI    IOBSTAT2,LGNCK           SET INCORRECT LENGTH EXCEPTION  13020002
         B     ERREXIT                  CODE, GO DETERMINE EXIT         13040000
*                                                                       13060000
         EJECT                                                          13070002
*********************************************************************** 13072002
*                   CONSTANTS AND EQUATES                             * 13080002
*********************************************************************** 13082002
EIGHT    DC    F'8'                                                MC0J 13086000
ASIWAENT EQU   8                        OFFSET IN FORMAT MOD,ASI Y02072 13088002
EADCCW  EQU   X'06'                                               MC0J  13092002
EXIT     EQU   3                        SVC NUMBER TO RETURN TO SUPERV. 13100000
RTRKOFFS EQU   4                        OFFSET TO REL TRK ENTRY  Y02072 13190002
*                                       IN CONVERT ROUTINE       Y02072 13190402
SKPHIBYT EQU   X'01'                    TO START AT SCND BYTE OF WORD   13190802
*                                       FOR THREE BYTE COMPARES         13191202
CMP3BYTS EQU   X'03'                    USED FOR THREE-BYTE COMPARES    13191602
UNAVALSW EQU   X'FF'                    IOB UNAVAILABLE SWITCH          13192002
SCNDHALF EQU   X'04'                    SECOND HALF OF CCW              13192402
FLIPMSK  EQU   X'A0'                    NO RECORD FOUND TO NO SPACE     13320002
ALLMSK   EQU   X'FF'                    TEST FOR EXCEPTION CODES        13400002
INCLMSK  EQU   X'40'                    INCORRECT LENGTH                13420002
NRMSK    EQU   X'08'                    NO RECORD FOUND                 13440002
UCMSK    EQU   X'02'                    UNIT CHECK                      13460002
DCMSK    EQU   X'08'                    DATA CHECK                      13480002
*              EXCEPTION CODES                                          13560000
NOREC    EQU   X'80'                                                    13580000
LGNCK    EQU   X'40'                                                    13600000
NOSPA    EQU   X'20'                                                    13620000
INVAL    EQU   X'10'                                                    13640000
UNCOR    EQU   X'08'                                                    13660000
ENDOD    EQU   X'04'                                                    13680000
UNREL    EQU   X'02'                                                    13700000
*              OPTIONS AND TYPE                                         13720000
VERIFY   EQU   X'80'                                                    13740000
OFLOW    EQU   X'40'                                                    13760000
EXSCH    EQU   X'20'                                                    13780000
FEEDB    EQU   X'10'                                                    13800000
ACTAD    EQU   X'08'                                                    13820000
DYNBF    EQU   X'04'                                                    13840000
READX    EQU   X'02'                                                    13860000
RELRD    EQU   X'01'                                                    13880000
KEYOP    EQU   X'80'                                                    13900000
LGNOP    EQU   X'40'                                                    13920000
READ     EQU   X'08'                                                    13940000
KEY      EQU   X'04'                                                    13960000
ADD      EQU   X'02'                                                    13980000
SHFT3BYT EQU   24                       SHIFT TO TOP BYTE OF REG Y02072 13990002
NULL     EQU   0                        0 OFFSET                 Y02072 13992002
MODID    DC    C'IGG019KA'              MODULE ID                Y02072 13992102
FIX      DC    C' OZ28786'              LATEST FIX             @ZA08000 13992237
DATE     DC    C'&SYSDATE'              DATE OF LATEST FIX     @ZA08000 14000637
PATCH    DC    XL((*-IGG019KA)/20)'0'   5% PATCH AREA            Y02072 14018002
         EJECT                                                          14026402
*********************************************************************** 14034802
*                            DSECTS                                   * 14043202
*********************************************************************** 14051602
         DCBD  DSORG=DA                                                 14060000
         EJECT                                                          14080000
         IHADECB                                                        14100001
         EJECT                                                          14190002
         IECDRQE                                                 Y02072 14240002
         EJECT                                                          14320000
         IEFUCBOB  LIST=YES                                      Y02072 14330002
         EJECT                                                          14332002
         IEZIOB                                                         14340001
CCW1     DS    D                  CHANNEL COMMAND # 1                   14390001
CCW2     DS    D                  CHANNEL COMMAND # 2                   14392001
CCW3     DS    D                  CHANNEL COMMAND # 3                   14394001
         ORG   IOBDAYLI           ********************                  14400001
IOBDAVLI DS    B                  ******************                    14460001
         ORG   IOBDQPTR+4         *******************                   14520001
IOBUPLIM DS    XL8                ******************                    14580001
IOBDNRCF DS    CL8                ******************                    14640001
         ORG   IOBSTAT2                                                 14760001
OTHERERR EQU   BIT6               ERROR INDICATED IN NXT 2 BYTES        14820001
         IKJTCB                                                         15120001
         EJECT                                                          15260000
         IEZDEB                                                  Y02072 15270002
         END                                                            15900000
