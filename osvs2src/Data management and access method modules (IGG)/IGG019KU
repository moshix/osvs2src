   TITLE 'IGG019KU - BDAM CHANNEL END/ABNORMAL END APPENDAGES'          00022002
IGG019KU CSECT                                                          00024002
*MODULE NAME = IGG019KU                                               * 00030002
*                                                                     * 00032002
*DESCRIPTIVE NAME = BDAM CHANNEL END/ABNORMAL END APPENDAGES          * 00034002
*                                                                     * 00036002
*COPYRIGHT = NONE                                                     * 00036402
*                                                                     * 00036802
*CHANGE ACTIVITY                                                      * 00037202
*                                                                     * 00037602
*          RELEASE 20 CHANGES/DELETIONS                                 00044002
*1775024020,024080-024120                                        A33185 00047020
*          RELEASE 21 CHANGES/DELETIONS                                 00050002
*2683020450-020500                                              SA53130 00050200
*2683020500                                                      M0133  00050521
*2683029000,029800                                               M0055  00051021
*2683024118                                                      A40946 00053021
*                                                               SA53271 00053521
*2683020000                                                      21905  00054021
*                                                               SA53862 00064000
*                                                               SA62422 00066002
*        VS1-1 CHANGES/DELETIONS                                        00074002
*        VS2-1 CHANGES/DELETIONS                                        00084002
*        VS1-2 CHANGES/DELETIONS                                        00086002
*        VS2-2 CHANGES/DELETIONS                                        00088002
*012600,013800,014120,019800,029000-039800                       Y02072 00090002
*                                                                YM3857 00090402
*                                                                YM4606 00090802
*                                                                YM2862 00091202
*                                                                YM5762 00094002
*                                                                YM5947 00094402
*        VS2-3 CHANGES/DELETIONS                                        00094803
*020040-020060,021664-021666,021669,021672,021675,021681,      @OZ04942 00094903
*022383,022419,023075,024683,024690,026412,026930-027784,      @OZ04942 00095003
*027796-027804,027810,027831-027851,028000-028046,             @OZ04942 00095103
*040420-040520                                                 @OZ04942 00095203
*020024,022378,022413,023068,023076-023129,024682,024700        OZ04733 00096003
*023130-023132,026890-026898                                    OZ02226 00097003
*STATUS CHANGE LEVEL 6/12/75                                            00098003
*                                                                       00104018
*FUNCTION/OPERATION- THIS MODULE CONTAINS THE BDAM CHANNEL END AND    * 00120000
*   ABNORMAL (EXCEPTIONAL) END IOS APPENDAGES. THE MODULE IS ALWAYS   * 00140000
*   LOADED WHEN BDAM IS USED AND ALLOWS BDAM TO DETERMINE THE ACTION  * 00160000
*   TO BE TAKEN ON UNIT EXCEPTION, INCORRECT LENGTH, FIRST OCCURRENCE * 00180000
*   OF AN ERROR, PERMANENT ERROR, OR NORMAL CHANNEL END.              * 00200000
*                                                                     * 00220000
*ENTRY POINTS- 'IGG019KU' (BEGIN) IS ENTERED BY IOS WITH A CALLING    * 00240000
*   SEQUENCE,  L    15,12(APPENDAGE LIST)                             * 00260000
*              BALR 14,15                                             * 00280000
*   THE CAUSE OF ENTRY AND ACTION TAKEN IS AS FOLLOWS,                * 00300000
*   1.NORMAL CHANNEL END- SCHEDULE ASYNCHRONOUS INTERRUPT (ASI)       * 00320000
*            IF ADDITIONAL PROCESSING IS REQUIRED                     * 00321003
*            OR POST USERS DECB COMPLETE                              * 00322003
*            OR IN CERTAIN CASES, CHANGE IOBSTART AND RESTART         * 00330002
*   2.UNIT EXCEPTION- SET END-OF-DATA-SET EXCEPTION CODE, SCHEDULE ASI* 00340000
*   3.INCORRECT LENGTH- IF READING FORMAT V, RESET THE ERROR FLAGS IF * 00360000
*     LENGTH IS CORRECT, SCHEDULE ASI. IF LENGTH IS INCORRECT, RETURN * 00380000
*     TO IOS. IF READING FORMAT U, RESET THE ERROR FLAGS, SCHEDULE ASI* 00400000
*     IF READING FORMAT F OR WRITING ANY FORMAT, RETURN TO IOS.       * 00420000
*                                                                     * 00440000
*   'IECDCEB' IS ENTERED BY IOS WITH A CALLING SEQUENCE,              * 00460000
*   L    15,16(APPENDAGE LIST)                                        * 00480000
*   BALR 14,15                                                        * 00500000
*   THE CAUSE OF ENTRY AND ACTION TAKEN IS AS FOLLOWS,                * 00520000
*   1.FIRST OCCURRENCE OF AN ERROR- RETURN TO IOS (ERROR RETRY)       * 00540000
*        UNLESS FIXED WRITE ADD. IN THIS CASE TURN OFF ERROR            00550002
*        FLAGS AND RESTART, ENSURING ENTRY AGAIN IF NEW ERROR           00552002
*        OCCURS OR SAME ERROR REOCCURS. IF SAME ERROR REOCCURS          00554002
*        8 TIMES, SET PERMANENT ERROR FLAGS AND SCHEDULE ASI.           00556002
*   2.PERMANENT ERROR- SET ABNORMAL COMPLETION CODE, SCHEDULE ASI     * 00560000
*                                                                     * 00580000
*INPUT- THE FOLLOWING REGISTERS ARE USED AS POSITIONED BY IOS,        * 00600000
*   1- ADDRESS OF THE RQE                                             * 00610002
*   2- ADDRESS OF THE IOB ASSOCIATED WITH THIS I/O REQUEST            * 00620000
*   4- DCB ADDRESS                                                    * 00640000
*  13- IOS SAVEAREA ADDRESS                                           * 00650002
*  14- RETURN (NORMAL) TO IOS                                         * 00660002
*  15- ENTRY POINT IN THIS MODULE                                     * 00680002
*                                                                     * 00700000
*OUTPUT- THIS ROUTINE MAY SET EXCEPTION CODES IN THE IOB FOR THE      * 00720000
*   ASYNCHRONOUS INTERRUPT ROUTINE.                                   * 00740000
*                                                                     * 00760000
*EXTERNAL ROUTINES- 'IEA0EF00' IS ENTERED TO SCHEDULE ASI.            * 00780000
*                                                                     * 00800000
*EXITS- 'CEEXIT1','CEEXIT2', 'CEEXIT3' ARE ALL NORMAL RETURNS TO IOS  * 00820000
*   FROM THE CHANNEL END APPENDAGE. THE INCORRECT LENGTH INDICATION   * 00840000
*   REMAINS ON.                                                       * 00860000
*        'XCEEXIT1' IS A RETURN TO IOS FROM ABNORMAL END APPENDAGE.   * 00880000
*   AN ERROR HAS OCCURRED BUT THE OPERATION WILL BE RETRIED.          * 00900000
*        'XCEEXIT2' IS THE EXIT TO IEA0EF00 TO SCHEDULE ASI.          * 00920000
*   IEA0EF00 WILL RETURN TO IOS WITH IGNORE OFFSET.                   * 00940000
*                                                                     * 00960000
*TABLES/WORK AREAS- THE COMMUNICATION VECTOR TABLE IS A RESIDENT      * 00980000
*   VECTOR LIST USED TO LOCATE THE ROUTINE, IEA0EF00.                 * 01000000
*                                                                     * 01020000
*ATTRIBUTES- THESE ROUTINES ARE EXECUTED ENABLED AND PRIVILEGED AND   * 01040002
*   ARE REENTRANT. THEY ARE ENTERED IN KEY 0 WITH THE LOCAL LOCK HELD.* 01060002
*   A MODESET WILL BE ISSUED TO DO ALL PROCESSING IN USER KEY.        * 01070002
*                                                                     * 01080000
*NOTE- THIS ROUTINE RELIES ON THE REGISTER USAGE OF IOS.              * 01100000
*      REGISTER 13, ON ENTRY, POINTS TO THE IOS SAVEAREA WHERE          01120002
*      ALL IOS REGISTERS WILL BE SAVED.                                 01140002
*                                                                       01160000
*                                                                       01180000
         USING IGG019KU,BASE                                            01200000
         USING IOBSTDRD,IOBREG                                   Y02072 01220002
         USING RQE,RQEREG                                        Y02072 01230002
         USING IHADCB,DCBREG                                            01240000
         USING UCB,UCBREG                                               01270021
*                                                                       01280000
*  REGISTER USAGE                                                       01300000
*                                                                       01320000
R0       EQU   0                        PARAMETER REGISTER       Y02072 01330002
RQEREG   EQU   1                        BASE REG FOR RQE         Y02072 01332002
IOBREG   EQU   2                        IOB ADDRESS (FROM IOS)          01340002
WORK5    EQU   2                        PASSES IOSKEY TO MODESET Y02072 01350002
DCBREG   EQU   4                        DCB ADDRESS (FROM IOS)          01360002
WORK2    EQU   5                        WORK REGISTER            Y02072 01362002
WRAPREG  EQU   6                        USED FOR DECREMENTING  @OZ04942 01367003
UCBREG   EQU   7                        PTR TO UCB FROM IOS     SA53271 01370002
LINKREG  EQU   9                        INTERNAL LINKAGE REG     Y02072 01372002
SWAREG   EQU   10                                                M0055  01390021
WORK4    EQU   10                       WORK REGISTER           SA53271 01395002
LNGREG   EQU   11                       WORK REGISTER                   01400002
WORK3    EQU   11                       WORK REGISTER           SA53271 01403002
WORK1    EQU   12                       WORK REGISTER             24512 01406018
SAVEREG  EQU   13                       IOS SAVEAREA REGISTER    Y02072 01414002
RETREG   EQU   14                       RETURN TO IOS                   01420002
BASE     EQU   15                       BASE - ENTRY POINT              01440002
R15      EQU   15                       SAVE/RESTORE REG         Y02072 01450002
*                                                                       01460000
*                                                                       01480000
*                                                                       01500000
*                                                                       01520000
BEGIN    B     IECDCEA                  BRANCH AROUND XCE ADCON         01540002
XCEAD    DC    A(IECDCEB-BEGIN)         ADDRESS OF XCE ROUTINE          01560000
*                                                                       01580000
IECDCEA  EQU   *                        CHK IF THIS NORMAL END   Y02072 01590002
         STM   R0,R15,0(SAVEREG)        SAVE REGISTERS FROM IOS  Y02072 01600002
         L     WRAPREG,WRAPBASE         SET UP FOR DECREMENTS  @OZ04942 01601003
         USING WRAPDECR,WRAPREG                                @OZ04942 01601203
         BZ    NORMEND                  BR IF THIS IS NORMAL END Y02072 01602002
         BAL   LINKREG,ECBCHK           BR TO CK FOR ECB PTR     Y02072 01610002
         TM    IOBSTBYT,CSWUNEXP        TEST FOR END OF DATA SET Y02072 01695003
         BO    SETEODS                  BR YES TO SET DECB CODE BIT     01700003
*                                                                       01705002
*    ANALYZE INCORRECT LENGTH ERROR                                     01710002
*                                                                       01715002
         TM    IOBDTYP2,IOBRQUST        WAS THIS A READ REQUEST  Y02072 01720002
CEEXIT1  BZ    CEEXIT3                  NO, LET ERROR CODE STAND Y02072 01740002
*                                                                       01760000
         TM    DCBRECFM,DCBRECL         IS RECORD FORMAT 'U'            01780003
         BM    TSTV                     NO, GO TEST FURTHER.            01800003
*                                                                       01820000
RESET    NI    IOBFLAG1,X'FF'-IOBIOERR  CLEAR ANY LENGTH ERROR FOR A    01840003
         NI    IOBSTBYT+1,X'FF'-CSWINCOR  READ TO FORMAT 'U' DATA SET.  01860003
         B     SCHASI                   SCHEDULE ASYNCHRONOUS INTERRUPT 01880002
*                                                                       01900000
TSTV     TM    DCBRECFM,DCBRECV         IF FORMAT IS 'F'                01920003
CEEXIT2  BZ    CEEXIT3                  LET THE ERROR CODE STAND        01940002
*                                                                       01960000
         L     WORK1,IOBCSW-1           GET ADDRESS OF READ DATA Y02072 02000002
*                                       CCW                      21905  02002021
         LA    WORK1,WRAP-CCWLEN(WORK1)  GET ADDR OF ERROR CCW @OZ04733 02002403
         USING CCW,WORK1                                         21905  02008021
         LH    LNGREG,CCWBYTE           GET LENGTH IN CCW        21905  02010003
         L     WORK1,CCWADDRA           LOAD BUFFER ADDR        SA53862 02011003
         DROP  WORK1                                             21905  02012021
         SH    LNGREG,IOBCSW+5          MINUS REMAINING BYTE CT  Y02072 02020002
         SR    WORK4,WORK4              CLEAR REGISTER          SA62422 02030002
         IC    WORK4,0(WORK1)           GET 1ST BYTE OF BDW     SA62422 02032002
         SLL   WORK4,8                  MOVE IT LEFT ONE BYTE   SA62422 02034002
         IC    WORK4,1(WORK1)           GET 2ND BYTE OF BDW     SA62422 02036002
         CR    LNGREG,WORK4             ARE BYTES READ SAME AS  SA62422 02038002
         BE    RESET                    LENGTH. IF EQUAL, NO ERROR.     02100002
         B     CEEXIT3                  BR TO LET ERROR STAND    Y02072 02110002
*********************************************************************** 02160021
*                  END OF DATA CONDITION                                02160321
**********************************************************************  02160621
SETEODS  EQU   *                                                        02160921
         TM    IOBDTYPE,IOBEXTSC       IS THIS EXTENDED SRCH     Y02072 02161202
         BNO   SETEODS1                NO, GO SET EOD EXCEPT    SA53271 02161521
         TM    IOBDTYP2,IOBADDTY       IS THIS WRITE ADD REQ    SA53271 02161802
         BNO   SETEODS1                NO, GO SET EOD EXCEPT    SA53271 02162121
         MVI   IOBR,X'00'              BEGIN WITH R0 NEXT TRK    Y02072 02163002
         SR    WORK1,WORK1             CLEAR REGISTER           SA53271 02163321
         IC    WORK1,IOBHH1            PICK UP 1ST BYTE OF HH    Y02072 02163602
         SLL   WORK1,8                 MV IT TO 2ND BYTE IN REG SA53271 02163921
         IC    WORK1,IOBHH2            PICK UP 2ND BYTE OF HH    Y02072 02164202
         LA    WORK1,1(0,WORK1)        BUMP TO NEXT TRACK       SA53271 02164521
*     *     *     *     *     *     *     *     *     *     *     *   * 02164821
*                    IS NEXT TRACK VALID ON THAT DEVICE                 02165121
*     *     *     *     *     *     *     *     *     *     *     *   * 02165421
         L     WORK2,CVTPTR(0,0)       PICK UP CVT PTR          SA53271 02165721
         USING CVT,WORK2                                        SA53271 02166021
         L     WORK2,CVTZDTAB          LOAD ADDR TO DEVICE TAB  SA53271 02166221
         USING DVCTI,WORK2                                     @OZ04942 02166403
         LA    WORK3,DVCTYPMK           SET UP TYPE MASK       @OZ04942 02166703
         N     WORK3,UCBTYP             GET UNIT TYPE          @OZ04942 02167003
         IC    WORK3,DVCTIOFF(WORK3)    GET OFFSET FROM INDEX  @OZ04942 02167303
         AR    WORK3,WORK2              POINT TO CORRECT ENTRY @OZ04942 02167603
         USING DVCT,WORK3                                      @OZ04942 02167903
         CH    WORK1,DVCTRK             ARE THERE THIS MANY    @OZ04942 02168203
*                                      TRACKS ON THE CYLINDER           02168721
         BNL   NEWCYL                  IF NOT, GO TO NEXT CYL   SA53271 02169021
         STC   WORK1,IOBHH2            ELSE STORE NEW TRK VALUE  Y02072 02169302
         SRL   WORK1,8                 IN SEARCH ADDR AND RET   SA53271 02169621
         STC   WORK1,IOBHH1            TO IOS TO RESTART THE     Y02072 02169902
         B     RESTARTA                CHANNEL PROGRAM           Y02072 02170202
         DROP  WORK2,WORK3                                     @OZ04942 02170303
*     *     *     *     *     *     *     *     *     *     *     *   * 02170521
*                    BUMP TO NEXT CYLINDER                              02170821
*     *     *     *     *     *     *     *     *     *     *     *   * 02171121
NEWCYL   SR    WORK1,WORK1             CLEAR REG                SA53271 02171402
         IC    WORK1,IOBCC1            PICK UP 1ST BYTE OF CC    Y02072 02171702
         SLL   WORK1,8                 MV IT TO 2ND BYTE OF REG SA53271 02172021
         IC    WORK1,IOBCC2            PICK UP 2ND BYTE OF CC    Y02072 02172302
         LA    WORK1,1(0,WORK1)        BUMP CYLINDER BY ONE     SA53271 02172621
         STC   WORK1,IOBCC2            RETURN CYLINDER VALUE     Y02072 02172902
         SRL   WORK1,8                 TO IOBSEEK BUMPED BY 1.  SA53271 02173221
         STC   WORK1,IOBCC2            IF CYL VALUE NOT VALID    Y02072 02173502
*                                      EOE CONDITION RESULTS, WHICH     02173821
*                                      IS NECESSARY TO WRAP AROUND DS   02174121
         XC    IOBHH1(L'IOBHH),IOBHH1  START WITH TRK0           Y02072 02174202
         B     RESTARTA                 BR TO RESTART CHAN PGM   YM3857 02176202
*********************************************************************** 02187202
SETEODS1 EQU   *                                                SA53271 02190402
         OI    IOBSTAT2,DECCCEOD        SET EOD EXCEPT CODE      Y02072 02193603
         B     SETABN                   MARK IOB AS ABNORMAL COMP.      02196802
*                                                                       02200000
*********************************************************************** 02210002
*                                                                       02210402
*                                                                       02210802
*                                                                       02211202
*  THE FOLLOWING LOGIC APPLIES TO FIXED FORMAT WRITE ADD REQUESTS       02211602
*  WHICH ENCOUNTERED AN ERROR DURING THE SEARCH FOR A DUMMY RECORD      02211702
*  BUT BEFORE THE DATA BYTE(RECORD NO.) FROM A DUMMY RECORD WAS         02211802
*  READ INTO CORE. AN ERROR IN THIS PART OF THE CHANNEL PROGRAM         02211902
*  CAUSED THE ABNORMAL END APPENDAGE TO BE ENTERED. BECAUSE THE         02216602
*  ERP-IN-CONTROL BIT IS THEN TURNED ON, PREVENTING SUBSEQUENT          02220402
*  ENTRY INTO THE ABNORMAL END APPENDAGE (AND HENCE ANY ADJUST-         02220802
*  MENT TO THE CH PGM OR IOBSTART BEFORE RESTART, SHOULD THE ERROR      02221202
*  FOLLOW THE WRT KEY/DATA), THE CHANNEL PGM IS BROKEN UP SO THAT       02221602
*  THE CHAN PGM ENDS ONCE THE DUMMY RECORD IS IDENTIFIED. AT CHAN       02221702
*  END TIME (I.E. AT THIS POINT), THE IOBSTART IS ALTERED TO POINT      02225902
*  TO A SECOND PORTION OF THE CHANNEL PROGRAM WHICH VERIFIES THAT       02227902
*  THE IDENTIFIED DUMMY RECORD IS STILL A DUMMY BEFORE EXECUTING        02229902
*  WRT KEY AND DATA. THIS CHANGE IS REQUIRED AS OF VS2-2 BECAUSE        02230302
*  OF A CHANGE IN IOS WHEREBY DEVICE LOCKOUT NO LONGER EXISTS           02230402
*  WHEN THE ERPS ARE IN CONTROL. AS A RESULT, IT IS POSSIBLE THAT       02230502
*  ANOTHER CHANNEL PROGRAM WAS STARTED, FINDING AND UPDATING            02230702
*  THE SAME DUMMY RECORD WHILE THIS CHANNEL PROGRAM WAS RECOVER-        02231102
*  ING FROM AN ERROR.                                                   02232302
*                                                                       02234302
*                                                                       02234402
NORMEND  EQU   *                        CHK IF WA FIXED- NORMAL  YM3857 02234602
         BAL   LINKREG,ECBCHK           BR TO CK FOR ECB PTR     Y02072 02235102
         TM    IOBDTYP2,IOBADDTY        IS REQ FOR WRITE ADD     YM3857 02235302
         BNO   CONTINUE                 NO, CONTINUE TESTS       YM3857 02235502
         TM    DCBRECFM,DCBRECV         IS RECFM FIXED           YM3857 02235702
         BO    SCHASI                   NO, SCHEDULE ASI       @OZ04942 02235903
         LA    WORK2,WRAP-WRKLEN(IOBREG) IOB - WORKLEN         @OZ04733 02237803
         AH    WORK2,IOBDIOBS           + IOBLENG -> WRKAREA   @OZ04942 02238203
         USING WRKIOB,WORK2             SET UP WORKAREA BASE     YM3857 02240103
         L     WORK1,IOBCSW-1           GET ADDR OF CP STOP      YM3857 02240703
         LA    WORK1,WRAP-CCWLEN(WORK1)  BACK UP TO LAST CCW   @OZ04733 02241303
         USING CCW,WORK1                                       @OZ04942 02242303
         C     WORK1,WRKCCAD            WAS THIS CHAN PGM        YM3857 02242602
*                                       BROKEN UP BY ABN END     YM3857 02242702
*                                       (DID IT STOP ON RD/RS?)  YM3857 02242802
         BNE   CHECKNOP                 NO, CONTINUE CHECKING    YM3857 02242902
         OI    CCWFLGS,CCWCC            RE-COMMAND CHAIN IN CASE YM2862 02243003
*                                       CP WAS DISCONNECTED      YM2862 02245502
         MVC   IOBSTART,WRKSTRT2        SET UP IOBSTART TO PART  YM3857 02250002
*                                       OF CH PGM THAT WILL      YM3857 02252502
*                                       REVERIFY THAT KEY =FF    YM3857 02255002
         MVC   IOBCCHHR,IOBDNCRF+2      UPDATE SEEK TO SRCH      YM4606 02257503
*                                       BEGINNING WITH DUMMY REC YM4606 02260002
         MVI   IOBR,0                   BEGIN WITH R0            YM2862 02262002
         TM    DCBOPTCD,DCBOPTTO        IS THIS TRK OVERFLO      YM5762 02262402
         BNO   RESTARTA                 NO, GO REEXCP            YM5762 02264902
         L     WORK1,IOBSTART           YES, GET 1ST CCW ADDR    YM5762 02266902
         CLI   CCWCOMCD,SETSECT         IS THIS RPS CP           YM5762 02267303
         BNE   RESTARTA                 NO, GO REEXCP            YM5762 02267402
         L     WORK1,CCWADDRA           YES, GET SECTOR ADDR     YM5762 02269303
         MVI   0(WORK1),RPSNOP          CHANGE SECTOR TO NOP,FF  YM5762 02271302
         B     RESTARTA                 BR TO RESTART CHAN PGM   YM3857 02273702
*                                                                       02275602
CHECKNOP EQU   *                        WAS DUMMY STILL THERE    YM3857 02277502
         CLI   CCWCOMCD,NOP             DID C.P. END ON NOP?     YM3857 02279403
         BNE   SCHASI                   NO, THIS IS NOT SPECIAL@OZ04942 02281303
         CLI   CCWCOMCD+L'CCW,RDHA      YES,WAS IT IN 2ND PART   YM5762 02283203
*                                       OF CP THAT VERIFYS KEY   YM3857 02285102
         BNE   SCHASI                   NO, CONTINUE PROCESSING@OZ04942 02287003
         MVC   IOBCCHHR,IOBDNCRF+2      UPDATE SEEK TO SRCH      YM4606 02287503
*                                       BEGINNING WITH DUMMY REC YM4606 02290002
         MVI   IOBR,0                   BEGIN WITH R0            YM2862 02292502
         LA    WORK1,IOBCHNPR           GET BEG OF CP ADDR       YM3857 02295002
         ST    WORK1,IOBSTART           SET UP IOBSTART TO BEG   YM3857 02297502
         B     RESTARTA                 BR TO RESTART CHAN PGM   YM3857 02300002
         DROP  WORK1                                           @OZ04942 02301003
*                                                                       02302502
CONTINUE EQU   *                        CONTINUE TESTING         YM3857 02305002
*********************************************************************** 02305203
*        DETERMINE WHETHER ASYNCHRONOUS ROUTINE IS NEEDED               02305403
*********************************************************************** 02305603
*        NOTE: THIS CODE IS NEVER ENTERED FOR WRITE ADD                 02305703
         TM    DCBRECFM,DCBRECV+DCBRECSB  IF RECFM=VS          @OZ04942 02305803
         BO    SCHASI                     THEN USE ASI         @OZ04942 02306203
         CLI   IOBDAYLI,0               IF IOB NOT YET IN POOL @OZ04942 02306403
         BE    SCHASI                   THEN USE ASI           @OZ04942 02306603
         TM    IOBDTYPE,IOBDYNBF                               @OZ04733 02306803
*                                       IF DYNAMIC BUFFERING OR         02306903
*                                       READ EXCLUSIVE OR FEEDBACK      02307003
         BNZ   SCHASI                   THEN USE ASI           @OZ04942 02307103
         TM    IOBDTYPE,IOBRDEXC        IF NO EXCL CONTROL     @OZ04733 02307603
         BZ    CONT2                    THEN SKIP NEXT TESTS   @OZ04733 02309603
         TM    IOBDTYP2,IOBRQUST        IF WRITE RELEASE       @OZ04733 02311603
         BZ    SCHASI                   THEN USE ASI           @OZ04733 02312003
         TM    IOBSTAT2,IOBENQUE        IF CONTROL NOT GOTTEN  @OZ04733 02312403
         BZ    SCHASI                   THEN USE ASI           @OZ04733 02312803
CONT2    EQU   *                        CONTINUE PROC          @OZ04733 02312903
         CLC   IOBDCPND+SKPHIBYT(CMP3BYTS),IOBCSW     WAS       OZ02226 02313003
*                                       CHAN PROGRAM FINISHED?  OZ02226 02313103
         BNE   SCHASI                   NO - USE ASI            OZ02226 02313203
         L     WORK3,IOBECBPT           GET DECB/ECB           @OZ04942 02313303
         USING DECB,WORK3               ADDRESSIBILITY         @OZ04942 02313503
*********************************************************************** 02314003
*        PROVIDE FEEDBACK AS REQUIRED                                   02314503
*********************************************************************** 02315003
         TM    IOBDTYPE,IOBFDBCK        IF NO FEEDBACK         @OZ04942 02315503
         BZ    POST1                    THEN BYPASS THIS PART  @OZ04942 02316003
         TM    DCBOPTCD,DCBOPTF         IF ACTUAL FEEDBACK     @OZ04942 02316503
         BZ    FDBK1                    THEN GO MOVE IT        @OZ04942 02317003
         TM    IOBDTYPE,IOBACTAD        IF NOT ACTUAL ADDRESS  @OZ04942 02317503
         BNO   SCHASI                   THEN USE ASI TO CONVERT@OZ04942 02318003
FDBK1    L     WORK1,DECRECPT           FIND FDBK AREA         @OZ04942 02318503
         USING FDBKAREA,WORK1                                  @OZ04942 02319003
         MVC   FDBKMBB,IOBSEEK          MOVE IN MBB            @OZ04942 02319503
         MVC   FDBKCHR,IOBDNCRF+2       MOVE IN CCHHR          @OZ04942 02320003
         DROP  WORK1                                           @OZ04942 02320503
         EJECT                                                          02321003
*********************************************************************** 02321503
*        RELEASE IOB AND POST ECB                                       02322003
*        FOLLOWING IS THE REGISTER USAGE ON POST BRANCH ENTRY:          02322503
*        R0-R9         SAVED                                            02323003
*        R10 (WORK4)   POST CODE                                        02323503
*        R11 (WORK3)   ECB POINTER                                      02324003
*        R12-R13       UNUSED                                           02324503
*        R14 (RETREG)  RETURN ADDRESS                                   02325003
*        R15 (BASE)    ENTRY POINT                                      02325503
*********************************************************************** 02326003
*        ECB POINTER IS ALREADY IN WORK3                                02326503
POST1    SR    WORK4,WORK4              SET UP COMPLETION      @OZ04942 02327003
         ICM   WORK4,B'0100',IOBSTAT2   CODE FOR POST          @OZ04942 02327503
         TM    DCBMACRF,DCBMRCK         IF USING CHECK         @OZ04942 02328003
         BO    POST2                    KEEP IOB TILL THEN     @OZ04942 02328503
         MVI   IOBDAYLI,0               ELSE MAKE AVAILABL NOW @OZ04942 02329003
         DROP  IOBREG                   CANNOT USE IOB         @OZ04942 02329503
*                                       ONCE IT IS MADE AVAILABLE       02330003
POST2    EQU   *                                               @OZ04942 02330503
         USING CVT,WORK2                                       @OZ04942 02331003
         L     WORK2,CVTPTR             GO THRU CVT TO         @OZ04942 02331503
         L     BASE,CVT0PT01            GET POST ROUTINE PTR   @OZ04942 02332003
         DROP  BASE                                            @OZ04942 02332503
         MODESET EXTKEY=SUPR            GO INTO SUPERVISOR KEY @OZ04942 02333003
         BALR  RETREG,BASE              POST THE ECB           @OZ04942 02333503
         LM    R0,R15,0(SAVEREG)        RESTORE EXCP REGS      @OZ04942 02334003
         B     NOPOST(RETREG)           RETURN,BYPASSING POST  @OZ04942 02334503
         DROP  WORK2,WORK3                                     @OZ04942 02335003
         EJECT                                                          02335503
         USING IGG019KU,BASE                                   @OZ04942 02336003
         USING IOBSTDRD,IOBREG                                 @OZ04942 02336503
*********************************************************************** 02337003
*                                                                       02337503
*  THE FOLLOWING ROUTINE IS THE ABNORMAL END APPENDAGE, ENTERED BY IOS  02338003
*   ON UNIT CHECK ERROR AND PERMANENT ERROR OF ANY TYPE.                02338503
*                                                                       02339003
*********************************************************************** 02339503
*                                                                       02340000
         USING IECDCEB,BASE                                             02360000
*                                                                       02380000
IECDCEB  STM   R0,R15,0(SAVEREG)        SAVE IOS REGISTERS       Y02072 02390002
         L     WRAPREG,WRAPBASE         SET UP FOR DECREMENTS  @OZ04942 02391003
         BAL   LINKREG,ECBCHK           BR TO CK FOR ECB PTR     Y02072 02392002
*                                                                       02394002
         CLI   IOBECBCC,ECBNORM         IS THERE A PERM ERROR  @OZ04942 02400003
         BNE   SETABN                   YES, GO TO ASYNCH RTN. @OZ04942 02401003
         TM    IOBDTYP2,IOBADDTY        WRITE ADD TYPE FIXED     Y02072 02404002
         BZ    CEEXIT3                  BRANCH IF NOT WRITE ADD  Y02072 02405002
         TM    DCBRECFM,DCBRECV         VARIABLE OR UNDEFINED     24512 02406003
         BO    CEEXIT3                  YES, BRANCH              Y02072 02407002
*                                                                       02417002
*                                                                       02427002
*  THE FOLLOWING LOGIC APPLIES TO FIXED FORMAT WRITE ADD REQUESTS.      02437002
*  BECAUSE THE ERP-IN-CONTROL BIT WOULD NORMALLY BE TURNED ON WHEN      02439002
*  CONTROL RETURNS TO EXCP/ERPS, THUS PREVENTING REENTRY INTO THIS      02441002
*  ABNORMAL END APPENDAGE SHOULD A SECOND ERROR (EG. FILE PROTECT,      02441402
*  ON A SEEK CYL WHICH IS NORMAL, OR DATA OVERRUN ON WRT KEY/DATA,      02441802
*  WHICH IS NOT) OCCUR BEFORE THE CHANNEL PROGRAM CONCLUDES SUC-        02441902
*  CESSFULLY. A PROBLEM EXISTS BECAUSE OF THE INABILITY TO REGAIN       02445202
*  CONTROL: IF THIS APPENDAGE IS ENTERED NORMALLY TO CROSS TRACKS       02447202
*  OR CYLINDERS DURING CHAN PGM EXECUTION AND ENCOUNTERS AN ERROR       02447602
*  LATER WHILE ATTEMPTING TO WRITE DATA, THE ERPS, WHICH WOULD          02448002
*  STILL BE IN CONTROL, WOULD AUTOMATICALLY RESTART THE CHANNEL         02448402
*  PROGRAM FROM THE BEGINNING. BECAUSE THE KEY WAS WRITTEN BEFORE       02448502
*  THE ERROR, THE SAME RECORD IS NO LONGER IDENTIFIED AS THE DUMMY.     02448602
*  A NEW DUMMY RECORD IS FOUND AND THE SAME KEY AND DATA ARE            02451102
*  WRITTEN, RESULTING IN DUPLICATE KEYS. THE SOLUTION TO THIS PROBLEM   02453102
*  IS TO ENSURE THAT THE ABNORMAL END APPENDAGE WILL CONTINUE TO GET    02453502
*  CONTROL ON THE OCCURRENCE OF EACH ERROR. THIS IS DONE AS FOLLOWS:    02453902
*                                                                       02454002
*  A) IF THE ERROR OCCURS BEFORE THE DUMMY RECORD IS IDENTIFIED (IE.    02454302
*  THE DATA BYTE RECORD NO. IS READ IN) TURN OFF THE COMMAND CHAIN      02454702
*  ON THE CCW THAT READS IN THE DATA BYTE (OR ON RD SECTOR FOR RPS),    02454802
*  STOPPING THE CHANNEL PROGRAM BEFORE ANYTHING IS WRITTEN. UPDATE      02454902
*  IOBSEEK FROM THE IOBDNCRF FIELD SO AS NOT TO REPEAT THE SEARCH       02455302
*  ON TRACKS ALREADY SEARCHED AT THIS POINT. AT CHANNEL END TIME        02455702
*  THE CHANNEL END APPENDAGE CAN THEN RESTART THE CHANNEL PGM AT A      02456302
*  POINT THAT VERIFIES THAT THE IDENTIFIED DUMMY RECORD IS STILL        02458302
*  A DUMMY BEFORE WRITING KEY AND DATA, (WHICH ALSO SOLVES AN           02458702
*  INTEGRITY PROBLEM EXISTING AS OF VS2-2 -SEE CEA FOR DETAILS).        02459102
*                                                                       02459402
*  B) IF THE ERROR OCCURS AFTER THE DUMMY RECORD HAS BEEN IDENTIFED     02459802
*  BUT BEFORE THE KEY OR DATA HAVE BEEN WRITTEN THE ERROR FLAGS ARE     02459902
*  TURNED OFF, THE IOBSTART IS CHANGED TO VERIFY THAT THE DUMMY         02460502
*  RECORD IS STILL A DUMMY BEFORE WRITING KEY AND DATA AND THE          02460902
*  CHANNEL PROGRAM IS RESTARTED. A COUNTER IS KEPT IN THE WORKAREA      02461302
*  TO PREVENT AN ENDLESS LOOP. IF THIS PART OF THE CHANNEL PROGRAM      02461702
*  EXPERIENCES GREATER THAN 10 ERRORS, PERMANENT ERROR FLAGS ARE        02462102
*  SET AND THE ASI IS SCHEDULED.                                        02462202
*                                                                       02462302
*  C) IF THE ERROR OCCURS AFTER OR DURING THE WRT KEY/DATA, THE         02462402
*  IOBSTART IS CHANGED TO EXECUTE ONLY THAT PORTION OF THE CHANNEL      02462902
*  PGM WHICH SEARCHES FOR THE RECORD BEING WRITTEN AND REEXECUTES       02463302
*  THE WRT KEY/DATA (AND THE WRITE VERIFY CCWS IF SPECIFIED). IN        02463702
*  THIS CASE THE ERROR FLAGS ARE NOT CHANGED AS IT IS NOT NECESSARY     02463802
*  THAT THE ABNORMAL END APPENDAGE GET CONTROL AGAIN.                   02463902
*                                                                       02464802
*  NOTE: THERE IS A WORKAREA FOLLOWING THE IOB WHICH HAS BEEN INIT-     02465202
*        IALIZED BY THE PRE-FORMAT MODULE, IGG019KO. IT CONTAINS        02465602
*        THE VIRTUAL CHANNEL PGM ADDRESSES OF THE READ DATA, WRT        02466002
*        KEY, VERIFY DUMMY CHAN PGM ENTRY, WRT KEY/DATA CHAN PGM        02466402
*        ENTRY, ETC.                                                    02466502
*                                                                       02467002
*                                                                       02467402
         L     WORK1,IOBCSW-1           GET CCW ADDR WHERE       YM3857 02467803
         LA    WORK1,WRAP-CCWLEN(WORK1)  INTERRUPT OCCURRED    @OZ04733 02468203
         USING CCW,WORK1                                       @OZ04942 02469903
         LA    WORK2,WRAP-WRKLEN(IOBREG)  IOB - WRKLEN         @OZ04733 02470003
         AH    WORK2,IOBDIOBS           + IOBLEN -> WRKAREA      YM3857 02470203
         USING WRKIOB,WORK2             SET UP WORKAREA BASE     YM3857 02470603
         SR    WORK4,WORK4              CLEAR WORK REG           YM3857 02470803
         LA    WORK3,ERPCOUNT           LOAD 10 AS RETRY MAX     YM3857 02471003
         C     WORK1,WRKRDAD            DID ERROR OCCUR ON OR    YM3857 02471203
*                                       BEFORE RD DATE OF DUMMY  YM3857 02471403
*                                       RECORD ID                YM3857 02471603
         BH    CHKMORE                  NO, KEEP LOOKING         YM3857 02471803
         TM    IOBSENS1,IOBS1B7         IS OVERFLO INCOMPLETE    YM5947 02472002
         BO    RETURN2                  YES, READ IN 1 BYTE FROM YM5947 02474002
*                                       OVERFLO REC-GO TO VERIFY YM5947 02476002
*                                                                       02478802
*    INTERRUPT WHILE LOOKING FOR DUMMY RECORD                           02480202
*                                                                       02481602
         L     WORK1,WRKCCAD            LOAD ADDR OF RD/RS       YM3857 02483002
         TM    CCWFLGS,CCWCC            WAS COM CHAIN TURNED OFF YM3857 02484403
         BNO   CEEXIT3                  YES,RETURN FOR ERP RETRY YM3857 02485802
         NI    CCWFLGS,X'FF'-CCWCC      TURN OFF CMD CHAIN       YM3857 02487203
         NI    IOBFLAG1,X'FF'-IOBIOERR  TURN OFF ERROR FLAG      YM3857 02488602
         MVC   IOBCCHHR,IOBDNCRF+2      UPDATE SEEK TO SRCH      YM4606 02490003
*                                       BEGINNING WITH DUMMY REC YM4606 02491402
         MVI   IOBR,0                   BEGIN WITH R0 FIRST      YM2862 02492802
         B     RESTARTA                 BR TO RESTART CH PGM AT  YM3857 02494202
*                                       TOP. ERPS WONT RETRY NOW YM3857 02495602
*                                       CEA WILL ADJUST IOBSTART YM3857 02497002
*                                       TO CONTINUE IF NO ERROR. YM3857 02498402
*                                                                       02499802
CHKMORE  EQU   *                        WHERE DID ERROR OCCUR    YM3857 02501202
         C     WORK1,WRKSTRT2           DID ERROR OCCUR IN PART  YM3857 02502602
*                                       OF CP THAT VERIFY KEY=FF YM3857 02504002
         BL    NOTNEW                   NO,DID NOT STOP IN VERFY YM3857 02505402
*                                                                       02506802
*    INTERRUPT WHILE VERIFYING DUMMY RECORD IS STILL DUMMY              02508202
*                                                                       02509602
         IC    WORK4,WRKCT1             GET ABNE ENTRIES HERE    YM3857 02511002
         LA    WORK4,1(WORK4)           ADD 1 TO COUNTER         YM3857 02512402
         STC   WORK4,WRKCT1             STORE BACK IN WORKAREA   YM3857 02513802
         CR    WORK4,WORK3              IS THIS ENTERED 10 TIMES YM3857 02515202
         BL    RETURN                   NO, CONTINUE RETRYING    YM3857 02516602
*                                                                       02518002
         MVI   IOBECBCC,ECBPERR         COULD NOT RECOVER, SET   YM3857 02519403
*                                       X'41' IN IOB             YM3857 02520802
         B     SETABN                   GO SCHEDULE THE ASI      YM3857 02522202
*                                                                       02523602
RETURN   EQU   *                        LOOPING IN VERIFY SECTN  YM3857 02525002
         NI    IOBFLAG1,X'FF'-IOBIOERR  TURN OFF ERROR FLAG      YM3857 02526402
         B     RESTARTA                 GO RETRY CHAN PGM        YM3857 02527802
*                                                                       02529202
NOTNEW   EQU   *                        WHERE WAS INTERRUPT      YM3857 02530602
         C     WORK1,WRKWKD             DID WRT KEY/DATA         YM3857 02532002
*                                       GET EXECUTED             YM3857 02533402
         BL    RESETIT                  NO, MUST BE SEEK CYL     YM3857 02534802
*                                                                       02536202
*    INTERRUPT WHILE OR AFTER WRITING KEY AND DATA                      02537602
*                                                                       02539002
         MVC   IOBSTART,WRKSTRT3        CHANGE START OF CP ONCE  YM3857 02540402
*                                       PART OF KEY WRITTEN      YM3857 02541802
         MVC   IOBCCHHR,IOBDNCRF+2      UPDATE SEEK TO SRCH      YM4606 02543203
*                                       BEGINNING WITH DUMMY REC YM4606 02544602
*                                       (NECESSARY FOR IOS SEEK) YM4606 02546002
         MVI   IOBR,0                   BEGIN WITH R0            YM2862 02547402
         B     CEEXIT3                  RETURN TO IOS FOR ERP    YM3857 02548802
*                                                                       02550202
*   INTERRUPT AFTER FOUND DUMMY AND BEFORE WRT KEY/DATA(EG. SEEK CYL)   02551602
*                                                                       02553002
RESETIT  EQU   *                        CHANGE START TO VER KEY  YM3857 02554402
         IC    WORK4,WRKCT2             GET LOOP CTR TO DATE     YM3857 02555802
         LA    WORK4,1(WORK4)           ADD THIS ENTRY TO CTR    YM3857 02557202
         STC   WORK4,WRKCT2             ST NEW COUNT             YM3857 02558602
         CR    WORK4,WORK3              IS THIS THE 10TH ENTRY   YM3857 02560002
         BL    RETURN2                  NO, RETURN TO RETRY      YM3857 02561402
*                                                                       02562802
         MVI   IOBECBCC,ECBPERR         SET X'41' IN IOB         YM3857 02564203
*                                       FOR PERMANENT ERROR      YM3857 02565602
         B     SETABN                   GO SCHEDULE THE ASI      YM3857 02567002
*                                                                       02568402
RETURN2  EQU   *                        RESTART CP AGAIN         YM3857 02569802
         MVC   IOBSTART,WRKSTRT2        START CP BY VERIFYING    YM3857 02571202
*                                       THAT DUMMY RECORD IS     YM3857 02572602
*                                       STILL A DUMMY            YM3857 02574002
         MVC   IOBCCHHR,IOBDNCRF+2      UPDATE SEEK TO SRCH      YM4606 02575403
*                                       BEGINNING WITH DUMMY REC YM4606 02576802
         MVI   IOBR,0                   BEGIN WITH R0            YM2862 02578202
         NI    IOBFLAG1,X'FF'-IOBIOERR  TURN OFF ERROR FLAG      YM3857 02579602
         TM    DCBOPTCD,DCBOPTTO        IS THIS TRK OVERFLO      YM5762 02581002
         BNO   RESTARTA                 NO, GO REEXCP            YM5762 02582402
         L     WORK1,IOBSTART           YES, GET 1ST CCW ADDR    YM5762 02583802
         CLI   CCWCOMCD,SETSECT         IS THIS RPS CP           YM5762 02585203
         BNE   RESTARTA                 NO, GO REEXCP            YM5762 02586602
         L     WORK1,CCWADDRA           YES, GET SECTOR ADDR     YM5762 02588003
         DROP  WORK1                                           @OZ04942 02589003
         MVI   0(WORK1),RPSNOP          CHANGE SECTOR TO NOP,FF  YM5762 02589402
         B     RESTARTA                 BR TO RESTART CHAN PGM   YM3857 02590802
*                                       TO VERIFY DUMMY RECORD   YM3857 02592202
*                                                                       02593602
*********************************************************************** 02595002
*    THE FOLLOWING ARE EXITS FROM THIS MODULE, EITHER APPENDAGE,      * 02596402
*    TO RETURN TO IOS IN IOS KEY OR TO SCHEDULE THE ASI.              * 02597802
*  NOTE: BECAUSE THESE EXIT ROUTINES ARE USED BY BOTH THE CHANNEL END * 02599202
*  AND ABNORMAL END APPENDAGES, THE BASE REGISTER MUST BE REESTAB-    * 02600602
*  LISHED SHOULD CODE BE ADDED TO THIS SECTION THAT REQUIRES A BASE.  * 02602002
*********************************************************************** 02603402
SETABN   OI    IOBSTAT1,IOBABNRM        MARK IOB AS ABNORMAL COMPLETION 02604803
*                                                                       02606202
*            SCHEDULE THE ASI ROUTINE                                   02607602
*                                                                       02609002
SCHASI   EQU   *                        SCHEDULE THE ASI ROUTINE Y02072 02610402
         LA    WORK5,IOSKEY             LOAD IOS KEY(=0) IN R2   Y02072 02611802
*                                                                       02613202
         MODESET  KEYADDR=(2)           RETURN TO IOS KEY        Y02072 02614602
*                                                                       02616002
         LM    R0,R15,0(SAVEREG)        RESTORE IOS REGS         Y02072 02617402
         LA    RETREG,NOFREE(RETREG)    SET NOPOST,NOFREE EXIT @OZ04942 02618803
*                                       TO EXCP FROM EXIT EFFECTOR      02619003
         L     BASE,CVTPTR              AND CALL EXIT EFFECTOR,         02620203
         USING CVT,BASE                                        @OZ04942 02621203
         L     BASE,CVT0EF00            LOCATING IT THRU CVT AND        02621603
         BR    BASE                     PASSING IT RQE TO USE    Y02072 02623003
*                                                                       02624402
*            RETURN TO IOS FROM CE OR ABE                               02625802
*                                                                       02627202
         USING IGG019KU,BASE                                   @OZ04942 02628203
CEEXIT3  EQU   *                        RETURN TO IOS            Y02072 02628602
         LA    WORK5,IOSKEY             LOAD IOS KEY(=0) IN R2   Y02072 02630002
*                                                                       02631402
         MODESET  KEYADDR=(2)           RETURN TO IOS KEY        Y02072 02632802
*                                                                       02634202
         LM    R0,R15,0(SAVEREG)        RESTORE IOS REGISTERS    Y02072 02635602
         BR    RETREG                   LET ERROR CODE STAND     Y02072 02637002
*                                                                       02638402
RESTARTA EQU   *                        RETURN TO IOS TO RESTART YM3857 02639802
         MVI   IOBSENS0,0               CLEAR SENSE BYTES      @OZ04942 02641203
         MVI   IOBSENS1,0                                      @OZ04942 02642203
         LA    WORK5,IOSKEY             LOAD IOS KEY(=0) IN R2   Y02072 02642602
         MODESET  KEYADDR=(2)           RETURN TO IOS KEY        Y02072 02644002
*                                                                       02645402
         LM    R0,R15,0(SAVEREG)        RESTORE IOS REGISTERS    Y02072 02646802
         B     RESTART(RETREG)          RET TO IOS TO RESTART   SA53271 02648202
         EJECT                                                          02649602
*********************************************************************** 02651002
*  THE FOLLOWING SUBROUTINE IS ALWAYS EXECUTED UPON ENTRY TO 19KU.    * 02652402
*  FOR CROSSING VOLUMES, DYN BUF OR EXCLUSIVE CONTROL (IF THIS IOB    * 02653802
*  HAD TO WAIT FOR A BLOCK OR BUFFER), MORE THAN ONE EXCP IS ISSUED   * 02655202
*  AGAINST THE SAME IOB.  WHEN MULTIPLE EXCPS ARE REQUIRED THE USERS  * 02656602
*  DECB ADDR IS SAVED IN THE IOBDQPTR FIELD IN THE IOB BEFORE OTHER   * 02658002
*  THAN THE 1ST EXCP WAS ISSUED AGAINST THIS IOB(IN THE DYN BUF RTN,  * 02659402
*  IGC0005C, OR FDN MOD.)  THIS IS NECESSARY TO PREVENT PROCESSING OF * 02660802
*  SUBSEQENT EXCPS FROM OVERLAYING ANY CHANGE IN THE STATUS OF THE ECB* 02662202
*********************************************************************** 02663602
ECBCHK   EQU   *                        CHECK DECB ADDR          Y02072 02665002
*                                                                       02666402
         MODESET  KEYADDR=RQEPRT,WORKREG=5   CHANGE TO USER KEY  Y02072 02667802
*                                                                       02669202
         L     WORK2,IOBECBPT           GET ADDR IN IOB FOR DECB Y02072 02670602
         LA    WORK2,0(WORK2)           CLEAR OUT TOP BYTE       Y02072 02672002
         LA    WORK3,IOBCSW+3           GET ADDR OF IOBCSW WORD  Y02072 02673402
         CR    WORK2,WORK3              DOES IOBECBPT PT TO CSW  Y02072 02674802
         BNER  LINKREG                  IF NOT, DECB PTR OK      Y02072 02676202
         L     WORK2,IOBDQPTR           ELSE,GET REAL DECB PTR   Y02072 02677602
         STCM  WORK2,ADDR,IOBECBPB      STORE IT IN LOW 3 BYTES  Y02072 02679002
         XC    IOBDQPTR,IOBDQPTR        CLEAR IOB FIELD          Y02072 02680402
         BR    LINKREG                  RETURN TO MAIN ROUTINE   Y02072 02681802
         EJECT                                                          02682803
*********************************************************************** 02683202
*                CONSTANTS AND EQUATES                                * 02684602
*********************************************************************** 02686002
*                                                                       02687402
*                                                                       02688802
SKPHIBYT EQU   X'01'                    TO START AT SECOND BYTE OZ02226 02689003
*                                       OF WORD FOR THREE BYTE  OZ02226 02689203
*                                       COMPARES                OZ02226 02689403
CMP3BYTS EQU   X'03'                    USED FOR THREE BYTE     OZ02226 02689603
*                                       COMPARES                OZ02226 02689803
ADDR     EQU   B'0111'                  MASK FOR STCM TO ST LOW  Y02072 02690202
*                                       ORDER 3 BYTES OF REG     Y02072 02691602
*              RETURN OFFSETS TO EXCP                                   02778603
NOPOST   EQU   4                        DO NOT POST ECB        @OZ04942 02778703
RESTART  EQU   8                        REEXCP THE REQUEST      SA53271 02778803
NOFREE   EQU   12                       DON'T FREE RQE OR POST @OZ04942 02779203
*                                                                       02779403
ERPCOUNT EQU   10                       NO OF TIMES ERP RETRIES  YM3857 02781102
IOSKEY   EQU   0                        IOS KEY IS ZERO          Y02072 02790802
*                                                                       02791003
*              CCW OP CODES                                             02791203
NOP      EQU   X'03'                    NOP COMMAND CODE         YM3857 02791803
RDHA     EQU   X'1A'                    READ HOME ADDR           YM5762 02792003
SETSECT  EQU   X'23'                    SET SECTOR OP CODE       YM5762 02792802
*                                                                       02793803
RPSNOP   EQU   X'FF'                    NOPS SET SECTOR COMMAND  YM5762 02794802
*                                                                       02795402
WRAPBASE DC    A(4095*4096)             4K LESS THAN 16MEG     @OZ04942 02796403
*              NOTE: SEE WRAPDECR DSECT FOR USE OF ABOVE CONSTANT       02797403
MODID    DC    CL8'IGG019KU'            MODULE ID                Y02072 02809202
FIX      DC    C'@OZ04942 '             LAST PTM ENTERED         YM5947 02811203
DATE     DC    C'&SYSDATE'              DATE OF LAST PTM         YM5947 02813203
PATCH    DC    XL50'0'                  PATCH AREA               Y02072 02819202
         EJECT                                                          02820000
*********************************************************************** 02830002
*                         DSECTS                                      * 02830203
*********************************************************************** 02830403
WRAPDECR DSECT ,                        USED FOR DECREMENTING  @OZ04942 02831003
*        THE BASE FOR THIS DSECT MUST BE A REG HAVING 4095*4096         02831203
*        USED WITH WRAP (BELOW) THIS WILL GIVE UNCHANGED ADDRESS        02831403
*        EXAMPLE:  LA   RX,WRAP-N(RX)                          @OZ04942 02832003
*              CLEARS HIGH BYTE OF RX AND SUBTRACTS N          @OZ04942 02833003
         DS    XL4096                                          @OZ04942 02834003
WRAP     DS    0X                       EXACTLY 16 MEGS        @OZ04942 02835003
*                                                                       02838003
*                                                                       02839003
FDBKAREA DSECT ,                        USERS FEEDBACK AREA    @OZ04942 02850203
FDBKMBB  DS    CL3                      MBB PART OF SEEK       @OZ04942 02850403
FDBKCHR  DS    CL5                      CCHHR PART OF SEEK     @OZ04942 02850603
*                                                                       02850803
*********************************************************************** 02852002
*  THE FOLLOWING FORMATS THE WORKAREA LOCATED AT THE END OF IOB CORE.   02854002
*  (IN EARLIER RELEASES,FOR V,U,VS FORMAT,THIS AREA WAS AN ENQ LIST.)   02856002
*  THIS WORKAREA CONTAINS ADDRESSES OF PARTICULAR CCWS IN THE CHANNEL   02858002
*  PROGRAM BUILT BY PREFORMAT MODULE, IGG019KO, FIXED WRITE ADD. IT     02858402
*  IS INTERROGATED BY THE CHANNEL OR ABNORMAL END APPENDAGE TO DETER-   02858802
*  MINE IF AN ERROR OCCURRED AND AT WHAT POINT, AND TO TAKE THE         02859202
*  APPROPRIATE ACTION.                                                  02859602
*********************************************************************** 02859702
WRKIOB   DSECT ,                        IOB WORKAREA             YM3857 02859803
WRKRDAD  DS    F                        ADDR OF CCW THAT READS   YM3857 02865503
*                                       IN 1 DATA BYTE - ID      YM3857 02868003
WRKCCAD  DS    F                        ADDR CCW THAT WILL NOT   YM3857 02870503
*                                       BE COMMAND CHAINED TO    YM3857 02873003
*                                       NEXT IF ERROR OCCURS     YM3857 02875503
*                                       BEFORE IT.               YM3857 02878003
WRKSKCYL DS    F                        ADDR OF FIRST SEEK CYL   YM3857 02880503
*                                       WILL BE 0 IF NOT OVFLO   YM3857 02883003
WRKWKD   DS    F                        ADDR OF CCW THAT WRT KD  YM3857 02885502
WRKSTRT2 DS    F                        ADDR OF BEG CP ONCE      YM3857 02895502
*                                       DUMMY RECORD IS FOUND    YM3857 02897502
WRKSTRT3 DS    F                        ADD OF BEG CP IF ANY     YM3857 02899502
*                                       PART OF KEY IS WRITTEN-  YM3857 02901502
*                                       ALSO,ADDR THAT 2ND PART  YM3857 02903502
*                                       OF CP TICS BACK TO IN    YM3857 02903902
*                                       1ST PART OF CHAN PGM     YM3857 02904302
WRKCT1   DS    BL1                      RETRY CTR - VERIFY DUMMY YM3857 02906302
WRKCT2   DS    BL1                      RETRY CTR AFTER DUMMY    YM3857 02910302
*                                       FOUND AND BEFORE KEY IS  YM3857 02910402
*                                       WRITTEN                  YM3857 02912402
         DS    BL2                      RESERVED                 YM3857 02914402
WRKEND   EQU   *                        END OF WRKIOB          @OZ04733 02924403
WRKLEN   EQU   WRKEND-WRKIOB            LENGTH OF WRKIOB       @OZ04733 02924803
         EJECT                                                          02926303
IHACCW   DSECT ,                                               @OZ04942 02927303
         IHACCW DSECT=NO                                       @OZ04942 02931303
CCWEND   EQU   *                        END OF CCW             @OZ04733 02933103
CCWLEN   EQU   CCWEND-IHACCW            LENGTH OF CCW          @OZ04733 02935103
         EJECT                                                          02935903
IHACSW   DSECT ,                                               @OZ04942 02937703
         IHACSW DSECT=NO                                       @OZ04942 02939503
         EJECT                                                          02941303
         CVT  DSECT=YES                                                 02943103
         EJECT                                                          02944903
         DCBD  DSORG=DA                                                 02946703
         EJECT                                                          02948503
         IHADECB ,                                             @OZ04942 02950303
         EJECT                                                          02952103
         IHADVCT ,                                             @OZ04942 02953903
         EJECT                                                          02955703
         IHAECB ,                                              @OZ04942 02957503
         EJECT                                                          02959303
         IEZIOB                                                  Y02072 02961102
         ORG   IOBCC                                           @OZ04942 02962103
IOBCCHHR DS    CL5                      DEF CCHHR WITHIN SEEK  @OZ04942 02963103
         EJECT                                                          02980002
         IECDRQE                                                 Y02072 02985003
         EJECT                                                          02986003
UCB      DSECT                                                          04040503
SRT      EQU   UCB                                                      04041021
         IEFUCBOB                                                       04041521
         END                                                            04060000
