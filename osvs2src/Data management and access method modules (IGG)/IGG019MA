         TITLE 'IGG019MA - BTAM READ/WRITE ROUTINE'                     00100013
*********************************************************************** 00250002
*                                                                     * 00300002
* MODULE NAME: IGG019MA   (OS/VS)                                     * 00350002
*                                                                     * 00400002
* DESCRIPTIVE NAME: BTAM READ/WRITE ROUTINE                           * 00450002
*                                                                     * 00460002
* COPYRIGHT: NONE                                                     * 00480002
*                                                                     * 00490002
* STATUS: RELEASE 3                                                   * 00500003
*                                                                     * 00600002
* FUNCTION:         GENERATE TELECOMMUNICATION CHANNEL PROGRAMS       * 00700002
*                                                                     * 00800002
* ENTRY POINT:      ENTRY IS TO 1ST EXECUTABLE INSTRUCTION FROM USER  * 00900002
*                   PROGRAM READ/WRITE MACRO OR QTAM OR ERP           * 01000002
*                                                                     * 01100002
* INPUT:            REGISTER  1 - ADDRESS OF DECB                     * 01200002
*                   REGISTER 14 - RETURN ADDRESS                      * 01300002
*                                                                     * 01400002
* OUTPUT:           1.  UPDATED IOB AND DECB FIELDS                   * 01500002
*                   2.  GENERATED CHANNEL PROGRAM                     * 01600002
*                   3.  RETURN CODE IN REGISTER 15                    * 01700002
*                       0 - NORMAL RETURN                             * 01800002
*                       4 - CHANNEL BUSY                              * 01900002
*                       8 - INVALID RELATIVE LINE NUMBER              * 02000002
*                       C - INVALID COMMAND                           * 02100002
*                      10 - ALL TERMINALS SKIP BIT ON                 * 02200002
*                      14 - LINE ERROR                                * 02300002
*                      18 - NO BUFFER AVAILABLE                       * 02400002
*                      1C - NO BUFFER POOL                            * 02500002
*                      20 - NO BUFFER ROUTINE                         * 02600002
*                      24 - READ FROM POSITION WITH NO SBA            * 02620002
*                      28 - INVALID CONTROL BLOCK FOUND               * 02640002
*                      2C - OLTEP IS EXECUTING                        * 02660002
*                                                                     * 02700002
* EXTERNAL ROUTINES: 1.  REQUEST/RELEASE BUFFER ROUTINE (IGG019MS)    * 02800002
*                    2.  DEVICE I/O MODULE FOR SPECIFIED DEVICE       * 02900002
*                    3.  IOS SVC 0 ROUTINE (EXECUTE CHANNEL PROGRAM)  * 03000002
*                                                                     * 03100002
* EXIT:             RETURN TO CALLING PROGRAM ADDRESS IN REGISTER 14  * 03200002
*                                                                     * 03300002
* IN LINE ROUTINES: THE READ/WRITE ROUTINE FINDS THE IOB, FINDS THE   * 03400002
*                   DEVICE I/O MODULE, OBTAINS THE AREA ADDRESS AND   * 03500002
*                   LENGTH, LOOPS ON THE CCW COUNT UNTIL ALL CCWS     * 03600002
*                   HAVE BEEN MOVED AND COMPLETED IN THE CHANNEL      * 03700002
*                   PROGRAM AREA OF THE IOB, AND ISSUES EXCP.         * 03800002
*                                                                     * 03900002
*                   THE CCW'S IN THE DEVICE I/O MODULE ARE COMPLETE   * 04000002
*                   EXCEPT FOR AREA ADDRESS AND COUNT.  AN INDEX IN   * 04100002
*                   THE 2ND AND 7TH BYTES OF THE CCW DETERMINES WHICH * 04200002
*                   SUBROUTINE IS BRANCHED TO TO COMPLETE THE AREA    * 04300002
*                   ADDRESS AND COUNT RESPECTIVELY.  WHERE OFFSETS    * 04400002
*                   TO THE NORMAL ADRS OR COUNT OCCUR THEY ALREADY    * 04500002
*                   EXIST IN THE CCW. THE SUB-ROUTINES ARE-           * 04600002
*                                                                     * 04700002
*                        A.  DATAREA - COMPLETES THE AREA ADDRESS FOR * 04800002
*                                      A READ/WRITE DATA OR READ RESP.* 04900002
*                                      INTO AREA COMMAND.             * 05000002
*                                                                     * 05100002
*                        B.  RESPAREA - PROVIDES THE RESPONSE ADDRESS * 05200002
*                                       IN THE DECB.                  * 05300002
*                                                                     * 05400002
*                        C.  SPECCHAR - PROVIDES THE CONTROL CHAR.    * 05500002
*                                       ADDRESS.  THE CONTROL CHARAC- * 05600002
*                                       TERS ARE DEFINED AS CONSTANTS * 05700002
*                                       AT THE END OF THE DEVICE I/O  * 05800002
*                                       MODULE.                       * 05900002
*                                                                     * 06000002
*                        D.  LIST - PROVIDES THE ADDRESS OF THE DIAL  * 06100002
*                                   DIGITS AND THEIR COUNT            * 06200002
*                                                                     * 06300002
*                        E.  PA1050D - SEE PALIST                     * 06400002
*                                                                     * 06500002
*                        F.  PALIST - FINDS THE 1ST NONSKIP POLLING   * 06600002
*                                     OR ADDRESSING ENTRY AND PLACES  * 06700002
*                                     ITS ADDRESS IN THE CCW.         * 06800002
*                                                                     * 06900002
*                        G.  TWXIDENT - PROVIDES THE ADDRESS AND      * 07000002
*                                       COUNT OF THE TWX OR BSC       * 07100002
*                                       IDENTIFICATION CHARACTERS.    * 07200002
*                                                                     * 07300002
*                        H.  DISABLE - DETERMINES TYPE OF DIALING     * 07400002
*                                       LIST AND INSERTS ENABLE       * 07500002
*                                       COMMAND IF IT IS AN ANSWER    * 07600002
*                                       LIST.                         * 07650002
*                                                                     * 07700002
*                        I.  DATALNG -  FOR READ/WRITE DATA IT        * 07800002
*                                       OBTAINS THE AREA LENGTH FROM  * 07900002
*                                       THE DECB.                     * 07950002
*                                                                     * 08000002
*                        J.  AUTOPOLL - SETS UP CHANNEL PROGRAMS      * 08003002
*                                       FOR AUTOPOLL OPERATIONS       * 08006002
*                                                                     * 08009002
*                        K.  BSCCHARS - PROVIDES THE CONTROL          * 08012002
*                                       CHARACTER ADDRESS.  THE       * 08015002
*                                       CONTROL CHARACTERS ARE IN     * 08018002
*                                       THE DCB.                      * 08020002
*                                                                     * 08021002
*                        L.  BSCDIAL - PROVIDES THE ADDRESS AND COUNT * 08024002
*                                      OF DIAL CHARACTERS FOR BSC.    * 08027002
*                                                                     * 08030002
*                        M.  BSCIDENT - PROVIDES THE ADDRESS AND      * 08033002
*                                       COUNT OF THE TERMINAL ID      * 08036002
*                                       CHARACTERS.                   * 08038002
*                                                                     * 08039002
*                        N.  BSCRESP - PROVIDES THE ADDRESS OF THE    * 08042002
*                                      PROPER RESPONSE FOR BSC.       * 08045002
*                                                                     * 08048002
*                        O.  BSCWAREA - COMPLETES THE AREA ADDRESS    * 08051002
*                                       FOR WRITE DATA FROM THE WRITE * 08054002
*                                       AREA.                         * 08056002
*                                                                     * 08057002
*                        P.  BSCGRAPH - PROVIDES THE ADDRESS OF       * 08060002
*                                       LEADING GRAPHICS FOR BSC.     * 08063002
*                                                                     * 08066002
*                        Q.  BSCWLNG - OBTAINS THE WRITE AREA LENGTH  * 08069002
*                                      FROM THE DECB.                 * 08072002
*                                                                     * 08072202
*                        R.  WTTAWRU - PROVIDES THE ADDRESS OF A WRU  * 08072402
*                                      BYTE IF WRU IS CODED YES IN    * 08072602
*                                      THE DCB, OTHERWISE THE ADDRESS * 08072802
*                                      OF A LETTER SHIFT CHARACTER    * 08073002
*                                      FOR WTTA.                      * 08073102
*                                      PROVIDES THE PAD CHARACTERS    * 08073202
*                                      ADDR AND THE COUNT IF IT IS A  * 08073402
*                                      WRITE PAD CHARACTERS.          * 08073602
*                                                                     * 08073802
*                        S.  WTTASNS - PUT X'FF' IN THE RESPONSE      * 08074002
*                                      FIELD OF THE DECB, WHEN A READ * 08074202
*                                      INITIAL OPERATION IS INDICATED * 08074402
*                                      FOR WTTA.                      * 08074802
*                                                                     * 08075002
*                        T.  CNTCHARS- POINTS DATA FIELD OF           * 08077002
*                                      WRITE FRAME CHANGE CCW TO      * 08079002
*                                      AREA POINTED TO BY ENTRY       * 08081002
*                                      FIELD OF DECB.                 * 08083002
*                                                                     * 08085002
*                        U.  FRAMECH - POINTS DATA AREA FIELD OF      * 08087002
*                                      WRITE FRAME CHANGE CCW PAST    * 08089002
*                                      DIAL CHARS IN TERMINAL LIST    * 08091002
*                                      TO POINT TO FRAME CHANGE       * 08093002
*                                      CHARACTERS.                    * 08095002
*                                                                     * 08097002
*                   DBDATA - THIS ROUTINE IS ENTERED FROM 'DATAREA'   * 08100002
*                   WHEN DYNAMIC BUFFERING IS SPECIFIED.  IT PROVIDES * 08200002
*                   THE ADDITIONAL CCW'S NEEDED AND MODIFIES THE      * 08300002
*                   APPROPIATE FIELDS (AREA ADDRESS, FLAGS, TP/OP     * 08400002
*                   CODE, COUNT).                                     * 08500002
*                                                                     * 08505002
*                        V.   SWIDREC - PUTS THE ADDRESS OF THE       * 08510002
*                                       READ-IN-AREA FIELD OF THE     * 08515002
*                                       SWLST TERMINAL LIST IN THE    * 08520002
*                                       AREA FIELD OF THE CCW AND     * 08525002
*                                       THE READ-IN-AREA WIDTH IN     * 08530002
*                                       THE COUNT FIELD OF THE CCW.   * 08535002
*                                                                     * 08540002
*                        W.   SWIDSENT- PUTS THE ADDRESS OF THE       * 08545002
*                                       IDSENT FIELD OF THE SWLST     * 08550002
*                                       TERMINAL LIST IN THE AREA     * 08555002
*                                       FIELD OF THE CCW AND THE      * 08560002
*                                       IDCOUNT IN THE COUNT FIELD    * 08565002
*                                       OF THE CCW.                   * 08570002
*                                                                     * 08575002
*                        X.   SWLSTTIC- PUTS THE ADDRESS OF CCW 1.    * 08580002
*                                       IN THE AREA FIELD OF THE      * 08585002
*                                       CCW.                          * 08590002
*                        Y.  RDFRPOS - USED FOR READ BUFFER FROM      * 08592002
*                                      POSITION AND READ MODIFIED     * 08594002
*                                      FROM POSITION. TESTS FOR       * 08596002
*                                      AN SBA ORDER.                  * 08598002
*                                                                     * 08648002
* ATTRIBUTES:       THIS ROUTINE IS REENTRANT                         * 08700002
*                                                                     * 08750002
* CHANGE ACTIVITY AS FOLLOWS:                                         * 08760002
*********************************************************************** 08765000
*            APARS                          PTMS                      * 08770002
*        YA01260  (10/19/73)            YM4057  (10/3/73) NO CODE     * 08780002
*        YA01016  (10/19/73)            YM4072  (10/15/73) DELETE     * 08790002
*        YA01028  (10/19/73)            YM5663  (12/11/73) PROLOG     * 08792002
*        YA01029  (10/19/73)            YM7701  (2/20/74)             * 08794000
*        YA01018  (10/19/73)                                          * 08796002
*        YA01856  (10/22/73)                                          * 08798002
*        YA02057  (10/22/73)                                          * 08798402
*        YA02153  (10/22/73)                                          * 08798802
*        YA02462  (10/22/73) FIX 1856                                 * 08799202
*        YA02128  (10/22/73)                                          * 08799602
*        YA03267  (2/4/74)                                            * 08809600
*        YA03268  (2/4/74)                                            * 08819600
*        YA03952  (3/19/74)                                           * 08819700
*        YA00542  (10/30/74)                                          * 08819803
*        YA02302  (10/30/74)                                          * 08819903
*        ZA02800  (12/20/74)          AZ04152  (09/24/75)             * 08823203
*        AZ07653  (12/08/75)          AZ07657  (12/08/75)             * 08824003
*        AZ07658  (12/09/75)          AZ09336  (03/11/76)             * 08824903
*        AZ10035  (05/10/76)          AZ11032  (05/11/76)             * 08825800
*        AZ11036  (05/12/76)          AZ11038  (07/23/76)             * 08827800
*********************************************************************** 08830002
         EJECT                                                          08840013
IGG019MA CSECT                                                          08850002
         SPACE 5                                                        08860002
CCWTBLRG EQU   0                        ADDRESS OF TBL OF ALL CCW'S     08900013
PARMREG0 EQU   0                        PARAMETER FOR SVC       YA02128 08910002
REG0     EQU   0                   USED IN BCTR FOR NO BRANCH    Y02947 08950002
DECBREG  EQU   1                        PTR TO DEC                      09000013
PARMREG1 EQU   1                        PARAMETER FOR SVC       YA02128 09050002
IOBREG   EQU   2                        PTR TO IOB                      09100013
AREAREG  EQU   3                        ADDRESS OF READ-WRITE AREA      09200013
TCBREG   EQU   3                        PTR TO TCB               Y02947 09250002
DCBREG   EQU   4                        PTR TO DCB                      09300013
CCWREG   EQU   5                        PTR TO CHANNEL COMMAND WORDS    09400013
CHPRGREG EQU   6                        ADDRESS OF MODEL CHNL PROGRAM   09500013
ZEROREG  EQU   7                        COUNT OF CCW'S COMPLETED.       09600013
DEBREG   EQU   7                        PTR TO DEB               Y02947 09650002
ICSREG   EQU   8                        WORK REGISTER                   09700013
ICREG    EQU   9                        1 CHARACTER WORK REGISTER       09800013
ONEREG   EQU   10                       CONTAINS 1 FOR COUNT            09900013
UCBPTREG EQU   10                                                Y02947 09950002
UCBREG   EQU   11                       PTR TO UCB               Y02947 09960002
TOTREG   EQU   11                       CONTAINS NO OF CCW'S IN CHNL PG 10000013
BASEREG  EQU   12                       BASE REGISTER                   10100013
SAVEREG  EQU   13                       SAVE REGISTER                   10200013
RETREG   EQU   14                       RETURN REGISTER                 10300013
BRREG    EQU   15                                                       10400013
         EJECT                                                   Y02947 10450002
L0       EQU   0                                               @ZA10035 10451000
L1       EQU   1                                               @ZA10035 10452000
L3       EQU   3                                               @ZA10035 10453000
L6       EQU   6                                               @ZA11038 10454000
L7       EQU   7                                               @ZA10035 10455000
L8       EQU   8                                               @ZA11038 10456000
L15      EQU   15                                              @ZA06399 10460003
L16      EQU   16                                              @ZA06399 10470003
L23      EQU   23                                                       10480003
L24      EQU   24                                                       10490003
NMEXT    EQU   16                  OFFSET TO NO. OF RLNS                10500002
BTAMSVC  EQU   116                 SVC FOR IECTSVC              YA02128 10550002
ERROR8   EQU   8                   BAD RETURN CODE              YA02128 10560002
MASKALL  EQU   X'FF'                                                    10600013
ERP      EQU   X'24'                                                    10700013
SADEN    EQU   X'80'                                                    10800013
BUSY     EQU   X'40'                    BUSY BIT                        10900013
CCFLAG   EQU   X'40'                                               000B 10920014
ZERO     EQU   X'00'                                               000B 10940014
ANDOFF   EQU   X'10'                                             A32468 10946020
WRTMASK  EQU   X'0D'                                               000H 10952018
ONLTST   EQU   X'40'                                               000H 10955018
ANSLST   EQU   X'7F'                                               000H 10958018
WTLIST   EQU   X'80'                                               000H 10961018
MASKBITS EQU   X'0F'                                               000H 10964018
EOTWTFLG EQU   X'04'                    WTTA EOT FLAG              000G 10970017
WRUWTFLG EQU   X'40'                    WTTA WRU FLAG              000G 10980017
RLNGTH   EQU   1                   RLN IS 1 BYTE LONG                   10980202
SAVE15   EQU   19                  DISP OF REG 15 IN SAVE AREA          10980402
OLTEPROG EQU   X'2C'               OLTEP IN PROGRESS CODE               10980602
TWOBITS  EQU   2                   USED IN SLA TO MULT BY 4             10980802
PREFIX   EQU   28                  LENGTH OF DEB PREFIX                 10981002
INVALCB  EQU   X'28'               INVALID CTL BLOCK CODE               10981202
NOSBA    EQU   X'24'               NO SBA ORDER CODE                    10981402
GOODRTN  EQU   X'00'               GOOD RETURN CODE                     10981602
NEXTNTRY EQU   4                   DISP OF NEXT ADDR IN UCB LIST        10982002
POLPTLNG EQU   4                   LENGTH OF DECPOLPT FIELD             10982202
ECBPT    EQU   4                   DISP OF ECB ADDR IN IOB              10982402
ECBPTLNG EQU   4                   LENGTH OF ECB ADDR                   10982602
CPAPT    EQU   64                  DISP OF CHAN PGM IN IOB              10982802
CPALNG   EQU   24                  LENGTH OF BSC3 CHAN PGM              10983002
STARTPT  EQU   16                  DISP OF START IN IOB                 10983202
FLAG1LNG EQU   1                   LENGTH OF IOBFLAG1 FIELD             10983402
CC       EQU   X'40'                    COMMAND CHAINING FLAG      000G 10990017
SWLST    EQU   X'FF'                                               000L 10995019
GCB      EQU   27                  OFFSET IN UCB TO ATTN HANDLING FLAGS 10995302
GRAF     EQU   X'1C'               OFFSET TO GRAPHIC STATUS     YA02128 10995402
ATTN     EQU   X'01'               ATTENTION BIT                        10995602
OLTEPSKP EQU   X'82'               OLTEP EXECUTING, SKIP BITS           10995902
READRLN  EQU   36                  OFFSET IN UCB OF RLN OF DVC TO BE RD 10996202
OLTEP    EQU   X'80'               UCB GCB OLTEP FLAG                   10996502
RDINIT   EQU   X'01'               CMD CODE FOR READ INIT               10997402
LCL3270  EQU   X'FE'               FIRST BYTE OF LOCAL 3270 @ IN        10997702
XFE      EQU   X'FE'               MASK FOR HEX FE           LD YA03952 10997800
*                                   DVC I/O MODULE                      10998002
RDTI     EQU   X'08'               READ INITIAL ACTIVE      LD @ZA02800 10998100
*                                                                       11010800
*        THE ABOVE CHANGE WILL AFFECT INSTRUCTION IN SEQ # 457148       11020800
*                                                                       11022800
RDYBIT   EQU   X'20'               DEVICE HAS COME READY        YA02128 11023802
RDYDEVIC EQU   X'F0'               DECFLAGS FOR READY DEVICE    YA02128 11036502
SBA      EQU   X'11'               HEX VALUE OF SBA ORDER               11049202
SBABYTE  EQU   1                   SBA SHOULD BE BYTE1 OF 4 BYTE DATA   11061902
*                                   AREA (RD FROM POSITION INSTR'S)     11074602
         EJECT                                                          11087313
         SR    BRREG,BRREG                                              11100013
         STM   RETREG,BASEREG,12(SAVEREG) SAVE REGISTERS                11200013
         BALR  BASEREG,0                                                11300013
         USING *,BASEREG                                                11400013
         USING IECTDECB,DECBREG                                         11500013
         USING IECTIOB,IOBREG                                           11600013
         USING IHADCB,DCBREG                                            11700013
         B     LOADCBAD                                                 11800013
         SPACE 3                                                        11900013
IOD      DS    0F                                                       12000013
         DC    34F'0'                   ADDRESSES OF DEVICE I/O MODULES 12100002
         DC    X'FF'                    END OF DEVICE I/O ADDRESSES000A 12200013
         DC    C'IGG019MA'                                       Y02947 12250002
         DC    C'** MVS *'                                              12260000
         DC    C'&SYSDATE'         DATE LAST ASSEMBLY                   12264002
         DS    0F                                                Y02947 12270002
PATCH    DC    XL150'00'           PATCH AREA                    Y02947 12280000
         SPACE 3                                                        12300013
*                                       MAIN ROUTINE                    12400013
         SPACE 2                                                        12500013
LOADCBAD EQU   *                                            LD @ZA02302 12650003
         CLI   DISP4(DECBREG),XFF    DUMMY DECB ?           LD @ZA02302 12660003
         BNE   BTAMDECB            NO, CONTINUE             LD @ZA02302 12670003
         L     DECBREG,DISP4(DECBREG)  GET BTAM DECB        LD @ZA02302 12680003
         LA    DECBREG,DISP0(DECBREG)  CLEAR HI BYTE        LD @ZA02302 12690003
BTAMDECB EQU   *                                            LD @ZA02302 12692003
         L     DCBREG,DECDCBAD     LOAD DCB ADDR            LD @ZA02302 12694000
         LA    DCBREG,ZERO(DCBREG)   CLEAR HIGH BYTE           @ZA09336 12697003
         L     AREAREG,DCBDEBAD         LOAD ADDRESS OF DEB             12700013
         CLC   NMEXT(RLNGTH,AREAREG),DECRLN IS RLN GOOD                 12800002
         BL    BADRLN                   IF NOT, BRANCH                  12900013
         CLI   DECRLN,X'00'             IS RLN ZERO                2064 12930014
         BE    BADRLN                   IF SO, BRANCH              2064 12960014
         SR    IOBREG,IOBREG            CALCULATE PTR TO IOB            13000013
         IC    IOBREG,DCBEIOBX          SIZE                            13100013
         SR    ICSREG,ICSREG            CLEAR WORK REGISTER             13160018
         SR    ICREG,ICREG              CLEAR WORK REGISTER             13200018
         IC    ICREG,DECRLN             PICK UP REL LINE NUMBER         13240018
         MR    ICSREG,IOBREG            IOB SIZE TIMES RLN              13280018
         LR    IOBREG,ICREG             RESULT IN IOBREG                13340018
         A     IOBREG,DCBIOBAD          PTR TO 1ST IOB                  13400013
         LA    IOBREG,DISP0(IOBREG)     CLEAR HI ORDER BYTE     YA01856 13450002
         USING IECTDEB+X24,AREAREG      DEB ADDRESSABILITY     @ZA11032 13452000
         L     UCBREG,DEBUCBAD          GET 1ST. UCB ADDR      @ZA11032 13454000
         DROP  AREAREG                                         @ZA11032 13456000
         NI    DECCMCOD,X00  RESET CMD CODE / SWLST FLAG       @ZA11032 13458000
         TM    X13(UCBREG),X90  IS IT BSC                      @ZA11032 13460000
         BNO   NOTSWLST         NO BRANCH                      @ZA11032 13462000
         TM    X10(UCBREG),X07    IS IT BSC3                   @ZA11032 13464000
         BO    NOTSWLST           YES BRANCH                   @ZA11032 13466000
         TM    X10(UCBREG),X06    IS IT BCS2                   @ZA11032 13468000
         BNO   NOTSWLST           BRANCH NOT BCS2              @ZA11032 13470000
         L     AREAREG,DECENTRY   GET LIST ADDRESS             @ZA11032 13472000
         LA    AREAREG,ZERO(AREAREG)  CLEAR HIGH BYTE          @ZA11032 13474000
         LTR   AREAREG,AREAREG       IF NO ADDRESS             @ZA11032 13476000
         BZ    NOTSWLST              NO TERMINAL LIST          @ZA11032 13478000
         CLI   ZERO(AREAREG),SWLST   IS THIS SWLST             @ZA11032 13480000
         BNE   NOTSWLST              NO                        @ZA11032 13482000
         OI    DECCMCOD,XF0       SET SWLST FLAG               @ZA11032 13484000
NOTSWLST EQU   *                                               @ZA11032 13486000
         TM    IOBINCAM,BUSY            IS THE LINE BUSY                13500013
         BZ    SADTEST                  IF NOT, GO TO NEXT TEST         13600013
         TM    IOBFLAG1,ERP             IS ERP IN PROCESS               13700013
         BNO   CHPBUSY             IF NOT, EXIT                         13800002
         TM    IOBINCAM,X'08'           ERP FLAG ON              A23900 13830018
         BNO   CHPBUSY             NO, EXIT WITH BUSY                   13860002
SADTEST  TM    IOBINCAM,SADEN           WAS SAD OR ENABLE COMPLETED     13900013
         BZ    TESTOLT                  NO BRANCH             LD YM7701 13950000
         CLI   DECTYPE+ONE,RDINIT       READ INITIAL?         LD YM7701 14000000
         BNE   SADENER                  NO SET C. C. 14       LD YM7701 14050000
*        THREE LINES OF CODE DELETED BY APAR --------->        @ZA11032 14080000
         CLI   UCBTBYT3(UCBREG),UCB3DISP IS IT 3270?          LD YM7701 14090000
         BNE   SADENER                  NO SET C.C. 14        LD YM7701 14094000
TESTOLT  EQU   *                                              LD YM7701 14096000
         OI    IOBINCAM,BUSY            SET BUSY BIT                    14100013
         TM    IOBINCAM,ONLT            IS ONLT IN CONTROL         000D 14130016
         BO    DEVMOD                                              000D 14160016
         NI    IOBFLAG2,X'FE'           TURN OFF RESET FLAG             14200013
DEVMOD   SR    ICSREG,ICSREG            RESET REG                  000D 14300016
         IC    ICSREG,DCBDEVTP          LOAD DEVICE TYPE                14400013
         SLA   ICSREG,2                 MULTIPLY BY 4                   14500013
         L     CHPRGREG,IOD(ICSREG)     ADD TO DIRECTORY BASE AND LOAD  14600013
         LA    CCWREG,0(CHPRGREG)       SAVE ADRS OF START OF MODULE    14700013
         IC    ICSREG,DECTYPE+1         LOAD TYPE I/O OPERATION         14800013
         N     ICSREG,OFFMSK            AND OFF RST & INIBIT BITS (3F)  14900013
         IC    ICSREG,0(CHPRGREG,ICSREG) LOAD CHNL PROG OFFSET          15000013
         CH    ICSREG,FFCODE            IS IT VALID                     15100013
         BE    INVALID                  NO                              15200013
         SR    ICREG,ICREG             CLEAR WORK REG           YA01260 15210002
         IC    ICREG,DCBEIOBX          IOB SIZE                 YA01260 15220002
         LR    ONEREG,IOBREG           ADR OF IOB               YA01260 15230002
         AR    ONEREG,ICREG            POINT TO END OF IOB      YA01260 15240002
*        13   LINES OF CODE DELETED   BY APAR ---------------> @ZA11036 15253200
         BCTR  ONEREG,0                BACK UP ONE BYTE                 15263200
         MVI   0(ONEREG),X'00'         CLEAR TOTAL CNT OF CHARS         15273200
         AR    CHPRGREG,ICSREG          ADD OFFSET; REG ADRS=CHAL PROG  15300013
*        ONE   LINE OF CODE DELETED BY APAR -------------->    @ZA11032 15400000
         STC   BRREG,DECTPCOD           RESET TP-OP CODE                15500013
         STC   BRREG,DECERRST           RESET ERROR STATUS              15600013
         ST    DECBREG,IOBECBPT         ST DECB PTR IN IOB              15700013
         TM    DECTYPE,X'02'            IS 'S' AREA SPECIFIED           15800013
         BZ    AREAOK                   NO                     @ZA11036 15900000
         NI    DECTYPE,X'FD'            AND OFF 'S' AREA BIT            16000013
         OI    DECTYPE,X'01'            OR ON 'S' LENGTH        YA01018 16010002
         CLI   DECTYPE+1,RCONTONE       IS THIS READ TCW           000L 16030019
         BE    LOAD                                                000L 16060019
         TM    DECTYPE+1,X'01'          IS COMMAND READ                 16100013
         BZ    AREAOK                   NO                              16200013
LOAD     EQU   *                                                   000L 16250019
*        11    LINES OF CODE DELETED BY APAR ------------>     @ZA11036 16299200
         L     CCWTBLRG,REQONE        LOAD REQ COUNT IN REG 0           16359200
         LR    DECBREG,DCBREG         LOAD DCB PTR INTO REG 1           16419200
         REQBUF (1),AREAREG,(0)         REQUEST DESIRED NUMBER   Y02947 16500002
*                                       OF BUFFERS               Y02947 16550002
         LTR   BRREG,BRREG              TEST IF BUFFER GRANTED          16600013
         BZ    BUFOK                    O.K.                            16700013
         LA    BRREG,16(BRREG)          ADD 16 TO RETURN CODE           16800013
         B     NOBUF                    RETURN                          16900013
*        30    LINES OF CODE DELETED BY APAR -------------->   @ZA11036 17087700
         B     AREAOK                                                   17088300
BUFOK    L     DECBREG,24(SAVEREG)      RESTORE DECB ADDRESS            17088902
         ST    AREAREG,DECAREA          STORE BUFFER ADRS IN DECB       17100013
AREAOK   TM    DECTYPE,X'01'            TEST FOR 'S' LENGTH             17200013
         BZ    LNGOK                    NO                              17300013
         NI    DECTYPE,X'FE'            AND OFF 'S' LENGTH BIT          17400013
         MVC   DECLNGTH(2),DCBBUFL      MOVE LENGTH FROM DCB TO DECB    17500013
LNGOK    MVC   DECRESPN(2),FULL4        RESET RESPONSE FIELD TO ZERO    17600013
         SR    CCWTBLRG,CCWTBLRG        RESET REGISTER                  17700013
         IC    CCWTBLRG,24(CCWREG)      INSERT OFFSET TO CCW'S     000B 17800014
         AR    CCWTBLRG,CCWREG          ADD MODULE START ADRS           17900013
         LA    CCWREG,IOBCPA            LOAD ADRS OF CHANNEL PROG AREA  18000013
         ST    CCWREG,IOBSTART                                          18100013
         SR    TOTREG,TOTREG                                            18200013
         SR    ICREG,ICREG                                              18300013
         LA    ONEREG,1                 LOAD CONSTANT 1                 18400013
         BAL   RETREG,RSTENTRY                                          18500013
         B     ENDCCW                                                   18600013
RSTENTRY LR    ZEROREG,ONEREG           RESET REGISTERS                 18700013
         IC    TOTREG,0(CHPRGREG)       LOAD COUNT OF CCW'S IN CHNL PRG 18800013
         N     TOTREG,OFFMSK            AND OF RESET BIT IF PRESENT     18900013
         CLI   DECTYPE+1,WCON           IS THIS A WRITE CONNECT    000L 18910019
         BNE   MOVECCW                                             000L 18920019
         CLI   IOBCPA+5,CONNECT         IS THE LINE CONNECTED      000L 18930019
         BNE   MOVECCW                                             000L 18940019
         MVI   IOBCPA+5,DISCON          RESET TP OP CODE           000L 18950019
         LA    CCWREG,8(CCWREG)         POINT TO SECOND CCW        000L 18960019
         ST    CCWREG,IOBSTART          STORE ADDRESS              000L 18970019
         B     SETLAST2                                            000L 18980019
MOVECCW  SR    ICSREG,ICSREG                                            19000013
         IC    ICSREG,0(ZEROREG,CHPRGREG) LOAD OFFSET TO CCW WANTED     19100013
         SLA   ICSREG,3                 MULTIPLY BY SIZE OF CCW'S       19200013
         AR    ICSREG,CCWTBLRG          ADD TABLE STARTING ADDRESS      19300013
         MVC   0(8,CCWREG),0(ICSREG)    MOVE CCW TO CHNL PROS AREA      19400013
         SR    ICREG,ICREG              CLEAR REG FOR IC INSTR  YA03267 19450000
         IC    ICREG,1(CCWREG)          LOAD AREA INDEX                 19500013
         MVI   1(CCWREG),X'00'          ZERO INDEX IN CCW               19600013
         L     AREAREG,DECENTRY                                         19700013
         B     BTBL1(ICREG)             GO TO AREA ROUTINE              19800013
TESTLNG  IC    ICREG,6(CCWREG)          LOAD LNGTH INDEX                19900013
         CLI   DECTYPE+1,RDCON          IS THIS READ CONNECT       000L 19912019
         BE    SWLSTTST                                          A38568 19916002
         CLI   DECTYPE+1,RCONTONE       IS THIS A READ TCW         000L 19920019
         BE    SWLSTTST                                          A38568 19924002
         CLI   DECTYPE+DISP1,WINIT      WRITE INITIAL          @ZA04152 19925003
         BE    TESTLNGA                 YES CK SWLST           @ZA04152 19926003
         CLI   DECTYPE+1,WCON           IS THIS WRITE CONNECT      000L 19928019
         BNE   NOSWLST                  NO                         000L 19932019
TESTLNGA TM    DECCMCOD,XF0            IS THIS A SWLIST?       @ZA10032 19932300
         BNO   NOSWLST                   NO                    @ZA11032 19932600
         CLI   7(AREAREG),ZERO          IS THIS AN AUTO-DIAL LIST  000L 19936019
         BE    NOAD                                                000L 19940019
         MVI   0(CCWREG),DIAL           PUT DIAL COMMAND IN CCW    000L 19944019
         MVC   7(1,CCWREG),7(AREAREG)   MOVE DIAL COUNT TO CCW     000L 19948019
         SR    ICSREG,ICSREG            CLEAR REGISTER             000L 19952019
         IC    ICSREG,6(AREAREG)        GET READ-IN-AREA LENGTH    000L 19956019
         LA    AREAREG,7(AREAREG)                                  000L 19960019
         AR    AREAREG,ICSREG           POINT TO DIAL CHARACTERS   000L 19964019
         A     AREAREG,0(CCWREG)        ADD COMMAND AND OFFSET     000L 19968019
         ST    AREAREG,0(CCWREG)        STORE IN CCW               000L 19972019
         TM    DECCMCOD,XF0             IS THIS SWLIST         @ZA11032 19972300
         BO    TESTLAST           YES                          @ZA11032 19972600
NOAD     EQU   *                                                   000L 19976019
         LA    ZEROREG,3(ZEROREG)       SKIP UNUSED CCWS           000L 19980019
         B     UPDATE                                              000L 19984019
SWLSTTST EQU   *                                            LD @ZA00542 19985003
         SR    ICSREG,ICSREG       CLEAR REGISTER              @ZA07653 19985103
         IC    ICSREG,DCBDEVTP  LOAD INDEX TO DEVICE I/O TABLE @ZA07653 19985803
         SLA   ICSREG,TWOBITS         MULTIPLY BY 4            @ZA07653 19986503
         LA    ICSREG,IOD(ICSREG)     GET ADDRESS OF TABLE     @ZA07653 19987203
         CLI   ZERO(ICSREG),LCL3270    LOCAL 3270?             @ZA07653 19987903
         BE    NOSWLST                                         @ZA07653 19988603
         TM    DECCMCOD,XF0        IS THIS A SWLIST?           @ZA11032 19988800
         BO    TESTLAST       GO CHECK FOR LAST CCW            @ZA11032 19989000
NOSWLST  EQU   *                                                   000L 19996519
         B     BTBL2(ICREG)             GO TO LENGTH ROUTINE            20000013
SETRC    SR    BRREG,BRREG              SET RETURN CODE = ZERO  YA02153 20050002
         BR    RETREG                   RETURN                  YA02153 20060002
TESTLAST BXH   ZEROREG,ONEREG,SETRC IS CHANNEL PROGRAM COMPLETE YA02153 20100002
         LA    CCWREG,8(CCWREG)         INCREMENT CCW ADDRESS           20200013
         B     MOVECCW                  GO TO MOVE IN NEXT CCW          20300013
TSTOLTEP EQU   *                                                        20320002
         NI    IOBINCAM,MASKALL-BUSY  TURN OFF IOB BUSY FLAG            20340002
         MVI   SAVE15(SAVEREG),OLTEPROG SET OLTEP IN PROGRESS           20360002
         B     RESTREG             RESTORE & RETURN TO USER             20380002
         EJECT                                                          20400013
CHPBUSY  MVI   19(SAVEREG),X'04'        SET CHANNEL BUSY CODE           20500013
         B     RESTREG                                                  20600013
BADRLN   MVI   19(SAVEREG),X'08'        SET CODE FOR TOO HIGH RLN       20700013
         B     RESTREG                                                  20800013
INVALID  MVI   19(SAVEREG),X'0C'        SET INVALID COMMAND CODE        20900013
         B     RST                                                      21000013
FULLUSE  EQU   *                                                 A43797 21050002
         NI    DECTYPE,X'FF'-AP TURN OFF AUTOPOLL IN PROGRESS    A43797 21100002
INVALADR EQU   *                                                 A43797 21150002
ALLSKIP  MVI   19(SAVEREG),X'10'        SET ALL DEVICES SKIP CODE       21200013
         B     RST                                                      21300013
SADENER  MVI   19(SAVEREG),X'14'        SET SAD ENABLE ERROR            21400013
         B     RESTREG                                                  21500017
NOBUF    STC   BRREG,19(SAVEREG)        SET NO BUFFER CODE              21600013
         B     RST                                                      21700013
ENDCCW   TM    DECTYPE+1,X'80'          IS RESET SPECIFIED              21800013
         BZ    SETLAST                  NO                              21900013
         AR    CHPRGREG,ZEROREG         RESET TO START OF RESET PROGRAM 22000013
         TM    0(CHPRGREG),X'80'        TEST TO SEE IF RESET POSSIBLE   22100013
         BZ    SETLAST                  BRANCH IF NOT                   22200013
         CLI   5(CCWREG),X'25'          THIS A READ RESP           000C 22230015
         BE    SETLAST1                 BYPASS SETTING CC FLAG     000C 22260015
         OI    4(CCWREG),X'40'          SET CC FLAG IN CCW              22300013
SETLAST1 EQU   *                                                   000C 22350015
         LA    CCWREG,8(CCWREG)         STEP CCW REGISTER               22400013
         BAL   RETREG,RSTENTRY                                          22500013
SETLAST  OI    5(CCWREG),X'80'          SET LAST CCW BIT IN TP OP CODE  22600013
SETLAST2 EQU   *                                                   000L 22650019
         TM    IOBFLAG1,ERP             TEST FOR ERROR RCVY IN PROCESS  22700013
         BO    RESTREG                                                  22800013
         NI    DECTYPE,X'F7'            RESET WRITE ENQ FLAG     A38557 22820020
         NI    DECFLAGS,X'00'          RESET FLAGS               A26916 22850019
         SR    ICSREG,ICSREG       RESET REG                            22851002
         IC    ICSREG,DCBDEVTP     LOAD INDEX TO DEVICE I/O TABLE       22852002
         SLA   ICSREG,TWOBITS      MULTIPLY BY 4                        22853002
         LA    ICSREG,IOD(ICSREG)  GET @ OF TABLE                       22854002
         CLI   0(ICSREG),LCL3270   IS IT A LOCAL 3270                   22855002
         BNE   EXCP                NO, EXCP                             22856002
         L     DEBREG,DCBDEBAD     GET ADDR OF DEB                      22857002
         L     DEBREG,PREFIX(DEBREG) POINT PAST PREFIX                  22858002
         USING IECTDEB,DEBREG                                           22859002
         SR    ICSREG,ICSREG       CLEAR REGISTER                       22859102
         IC    ICSREG,IOBUCBX      GET UCB INDEX FROM IOB               22859202
         SLA   ICSREG,TWOBITS      & MULTIPLY BY FOUR                   22859302
         L     UCBREG,DEBUCBAD(ICSREG) GET ADDRESS OF UCB BY            22859402
*                                  INDEXING INTO DEB UCB TABLE          22859502
         TM    GCB(UCBREG),OLTEP   OLTEP EXECUTING ON DEVICE            22859602
         BO    TSTOLTEP            YES, EXIT AFTER SETTING RC           22859702
         CLI   DECTYPE+1,RDINIT    WAS COMMAND A READ INITIAL           22860002
         BNE   RESETATN            NO, RESET ATTENTION FLAGS            22861002
         MVI   DECSDECB,ZERO       CLEAR COMP CODE              YA02128 22871002
         CLC   IOBDCBPT+DISP1(LEN3),DEBDCBAD ARE CHAINS GOOD    YA02128 22871402
         BNE   DEBBAD              NO, ERROR                    YA02128 22871802
         LR    PARMREG1,UCBREG     YES, SET FOR SVC             YA02128 22872202
         SR    PARMREG0,PARMREG0   CLEAR REG 0                  YA02128 22872302
         SR    BRREG,BRREG         ROUTE CODE FOR READ TI       YA02128 22872402
         SVC   BTAMSVC             TO IECTSVC                   YA02128 22879402
SVCDONE  B     BTBL3(BRREG)        BRANCH ON RETURN CODE        YA02128 22888002
DEBBAD   LA    BRREG,ERROR8        SET ERROR RETURN CODE        YA02128 22890002
         B     BADCB               READY FOR RETURN             YA02128 22892002
RESETATN SR    UCBREG,UCBREG       CLEAR REG                            22895002
         IC    UCBREG,IOBUCBX      GET UCB INDEX                        22902002
         SLL   UCBREG,2            MULTIPLY BY 4                        22909002
         L     UCBREG,DEBUCBAD(UCBREG) GET UCB ADDRESS                  22916002
         LR    PARMREG1,UCBREG     SET FOR SVC                  YA02128 22923002
         SR    PARMREG0,PARMREG0   CLEAR REG 0                  YA02128 22930002
         LA    BRREG,ONE           SET ROUTING FOR ATNR         YA02128 22937002
         SVC   BTAMSVC             TO IECTSVC                   YA02128 22951002
         B     BTBL4(BRREG)            CK RETURN CODE       L5 @ZA03567 22958003
BTBL4    B     EXCP              IF X'0',EXCP               L5 @ZA03567 22965003
         B     INVALUCB     IF X'04' INVALID ICB            L5 @ZA03567 22967003
         B     FINDRDY      IF X'08' DEV RDY                L5 @ZA03567 22969003
INVALUCB MVI   SAVE15(SAVEREG),INVALCB  SET INVALID UCB CODE            22972002
         B     RESTREG             RESET AND RETURN TO USER             22979002
EXCP     EQU   *                                                        22986002
         LR    DECBREG,IOBREG                                           22993002
         EXCP  (1)                      EXECUTE CHANNEL PROGRAM         23000013
         B     LOADM                                             A26916 23100019
RST      NI    IOBINCAM,MASKALL-BUSY    TURN OFF BUSY BIT               23200013
RESTREG  EQU   *                                                        23240018
         L     DECBREG,24(SAVEREG)     RESTORE DECB ADDRESS             23280018
         NI    DECSDECB,X'80'      CLEAR COMPLETION CODE        YA01028 23290002
         NI    DECTYPE,X'F7'            RESET WRITE ENQ FLAG     A38557 23300020
         NI    DECFLAGS,X'00'          RESET FLAGS                      23320018
LOADM    L     DECBREG,L24(SAVEREG)     RESTORE DECB ADDRESS   @ZA11032 23330000
         NI    DECCMCOD,X00          RESET SWLST FLAG          @ZA11032 23340000
         LM    RETREG,BASEREG,12(SAVEREG)   RESTORE REGISTERS    A26916 23360000
         BR    RETREG                   RETURN TO USER                  23400013
         EJECT                                                          23500013
*                                       BRANCHING TABLE                 23600013
         SPACE 2                                                        23700013
BTBL1    B     TESTLNG               00 NO AREA, PRESET ADDRESS         23800013
         B     DATAREA               04 I/0 TO/FM DATA AREA + INCREMENT 23900013
         B     RESPAREA              08 READ INTO FIRST DATA AREA BYTE  24000013
         B     SPECCHAR              0C WRITE SPECIAL CHARACTER(S)      24100013
         B     LIST                  10 WRITE DIAL LIST                 24200013
         B     PALIST                14 WRITE POLLING CHARACTERS        24300013
         B     TWXIDENT              18 WRITE TWX IDENT                 24400013
         B     PA1050D               1C WRITE 1050 DIAL ADRS CHARACTERS 24500013
         B     DISABLE               20 DISABLE LINE                    24600013
         B     AUTOPOLL              24 AUTOPOLL                   000A 24700013
         B     BSCCHARS              28 WRITE BSC CHARS            000B 24710014
         B     BSCDIAL               2C BSC DIAL                   000B 24720014
         B     BSCIDENT              30 BSC IDENT                  000B 24730014
         B     BSCRESP               34 WRITE BSC RESPONSE         000B 24740014
         B     BSCWAREA              38 I/O TO/FM WAREA            000B 24750014
         B     BSCGRAPH              3C WRITE LEADING GRAPHICS     000B 24760014
         B     BSCADRS               40 RESPONSE TO BSC ADDRS      000B 24770014
         B     WTTAWRU               44 WRITE WRU OR NOT (WTTA)    000G 24780017
         B     WTTASNS               48 PUT X'FF' IN THE RESPN FIELD00G 24790017
         B     WRITTONE              4C WRITE TONE CCW FOR W.T.    000H 24795018
         B     CNTCHARS              50 WRITE FRAME CHANBE         000K 24796018
         B     FRAMECH               54 FRAME CHANGE DFTRMLST      000K 24797018
         B     SWIDREC               58 READ ID SEQUENCE           000L 24797719
         B     SWIDSENT              5C WRITE ID SEQUENCE          000L 24798419
         B     SWLSTTIC              60 TIC TO FIRST CCW           000L 24799119
         B     RDFRPOS               64 READ FROM POSITION              24799502
         SPACE 3                                                        24800013
BTBL2    B     TESTLAST              00 NO ADDITIONAL COUNT NEEDED      24900013
         B     DATALNG               04 GET LENGTH FROM DECB            25000013
         B     BSCWLNG               08 GET WLENGTH FROM DECB      000B 25050014
         B     CONVLENG                                                 25070018
BTBL3    B     FINDATTN              00 CHECK UCB'S FOR ATTN            25090002
         B     NOATTN                04 TURN ON BUSY BITS               25093002
         B     BADCB                 08 INVALID CONTROL BLOCK           25096002
         B     FINDRDY               0C READY INTERCEPTED       YA02128 25098002
         EJECT                                                          25100013
*                                       AREA ROUTINES                   25200013
         SPACE 2                                                        25300013
BSCWAREA L     ICSREG,DECWAREA          LOAD ADDRESS OF I/O AREA   000B 25350014
         B     CNTAREA                  BRANCH                     000B 25400014
DATAREA  L     ICSREG,DECAREA           LOAD ADDRESS OF I/O AREA   000B 25450014
         CLI   DECTYPE+1,X'16'          THIS WRITE ENQ           A38557 25453020
         BNE   CNTAREA                  NO, BRANCH               A38557 25456020
         CLI   0(CCWREG),X'01'                                   A44965 25457002
         BE    CNTAREA                                           A44965 25458002
         TM    DECTYPE,X'08'            DECAREA/LENGTH SPECIFIED A38557 25459020
         BZ    RESPAREA                 NO, BRANCH               A38557 25462020
         LH    AREAREG,DECLNGTH         LOAD DECB LENGTH         A38557 25465020
         CH    AREAREG,K2+2             IS IT GREATER THAN 2     A38557 25468020
         BNH   RESPAREA                 NO, BRANCH               A38557 25471020
CNTAREA  LA    ICSREG,0(ICSREG)         CLEAR HIGH ORDER BYTE      000F 25480017
         CLI   L7(CCWREG),XFF      2740 READ REPEAT AUTO POLL  @ZA10035 25482000
         BNE   CNTAREA2             BRANCH NO                  @ZA10035 25484000
         TM    IOBFLAG1,X20         ERP IN CONTROL             @ZA10035 25486000
         BO    CNTAREA1            BRANCH YES                  @ZA10035 25488000
         MVI   L7(CCWREG),X00      CLEAR FF IN REPEAT CCW      @ZA10035 25490000
         B     CNTAREA2                                        @ZA10035 25492000
CNTAREA1 CLI   IOBWORK+L1,X01      LAST OPERATION RD TI        @ZA10035 25494000
         BNE   CNTAREA2               BRANCH NO                @ZA10035 25496000
         MVI   L3(CCWREG),X01        YES INCREASE ADDR BY ONE  @ZA10035 25498000
CNTAREA2 L     AREAREG,L0(CCWREG)    LOAD CMND CODE AND OFFSET @ZA10035 25500000
         AR    AREAREG,ICSREG           ADD ADDRESS                000B 25550014
         TM    DCBBFTEK,X'08'           TEST FOR DYNAMIC BUFFERING      25600013
         BO    DBDATA                   YES, G0 SET UP ADDITIONAL CCW'S 25700013
         ST    AREAREG,0(CCWREG)        STORE IN CCW                    25706017
         TM    DECCMCOD,XF0             IS THIS A SWLST ?      @ZA11032 25706200
         BNO   TESTLNG               NO                        @ZA11032 25706400
         MVC   SIX(TWO,CCWREG),DECLNGTH  MOVE LENGTH           @ZA04152 25710203
         B     TESTLAST           CHECK FOR LAST CCW           @ZA04152 25711203
RDFRPOS  EQU   *                                                        25712502
         CLI   SBABYTE(AREAREG),SBA  IS THERE  AN SBA ORDER             25713002
         BE    SBAOK               YES, CCW DATA @ = DECENTRY           25713502
         MVI   SAVE15(SAVEREG),NOSBA SET NO SBA CODE                    25714002
         B     RESTREG             RESET AND RETURN TO USER             25714502
SBAOK    LA    AREAREG,0(AREAREG)  CLEAR HIGH ORDER BYTE                25715002
         L     ICSREG,0(CCWREG)    LOAD CMD CODE AND OFFSET             25715502
         AR    ICSREG,AREAREG      ADD ADDRESS (DECENTRY)               25716002
         ST    ICSREG,0(CCWREG)    STORE IN CCW                         25716502
         B     TESTLAST            BYTE COUNT IN CCW CORRECT            25717002
         SPACE 3                                                   000G 25718017
WTTAWRU  EQU   *                                                   000G 25724017
         LR    AREAREG,CCWTBLRG         LOAD BASE ADDR OF CONSTANT 000G 25730017
         A     AREAREG,0(CCWREG)        ADD CMND CODE AND OFFSET   000G 25736017
         CLI   6(CCWREG),X'0C'          IS WRITE PAD CHARACTERS    000G 25742017
         BE    MOTORON                  BRANCH IF YES              000G 25748017
         CLI   3(CCWREG),X'69'          IS A WRITE WRU             000G 25754017
         BNE   WTTAID                   BRANCH IF NOT              000G 25760017
         TM    DCBBQFLG,WRUWTFLG        IS WRU CODED YES IN THE DCB000G 25766017
         BO    CNTWTTA1                 BRANCH IF YES            A25043 25772002
         BCTR  AREAREG,0                DECREMENT BY 1 TO POINT ON A00G 25778017
*                                       PAD CHARACTER.             000G 25784017
         B     CNTWTTA1                                          A25043 25790002
MOTORON  EQU   *                                                   000G 25796017
         NI    6(CCWREG),X'00'          ZERO SUBROUTINE INDEX      000G 25802017
         ST    AREAREG,0(CCWREG)        STORE IN CCW               000G 25808017
         TM    DECFLAGS,EOTWTFLG       IS THE PREVIOUS MSG ENDED        25814018
         BNO   TESTLAST                 BY EOT, BRANCH IF NOT      000G 25820017
         SR    AREAREG,AREAREG          RESET REGISTER             000G 25826017
         IC    AREAREG,DCBWTPAD         INSERT THE MARK-CHARS COUNT000G 25832017
         LA    AREAREG,1(AREAREG)       INCREMENT AREAREG BY 1     000G 25838017
         B     CNTWTTA3                 IF YES, BR TO STORE CNT  A25043 25844002
         SPACE 3                                                   000G 25850017
WTTASNS  EQU   *                                                   000G 25856017
         MVI   DECRESPN,X'FF'           PUT X'FF' IN THE RESPN FIELD00G 25862017
         B     RESPAREA                                            000G 25868017
         SPACE 3                                                   000G 25874017
WTTAID   EQU   *                                                   000G 25880017
         L     AREAREG,DECENTRY         LOAD TERMINAL LIST ADDRESS 000G 25886017
         CLI   5(CCWREG),X'04'          IS A WRITE CPU ID          000G 25892017
         BE    WTTACPU                  BRANCH IF YES              000G 25898017
         TM    DCBBQFLG,WRUWTFLG        IS WRU CODED YES IN THE DCB000G 25904017
         BO    WTTATERM                 BRANCH IF YES              000G 25910017
         SH    CCWREG,EIGHT             DECREMENT CCWREG BY 8      000G 25916017
         B     TESTLAST                 TO IGNORE THE READ TERM ID.000G 25922017
WTTATERM LA    AREAREG,1(AREAREG)       ADDR TO LIST ADDRESS       000G 25928017
         IC    ICREG,0(AREAREG)         INSERT COUNT OF ID CHARS   000G 25934017
         BCTR  ICREG,0                  DECREMENT IT BY 1          000G 25940017
         STH   ICREG,6(CCWREG)          AND STORE INTO CCW COUNT   000G 25946017
         B     CNTWTTA2                                          A25043 25952002
WTTACPU   EQU   *                                                  000G 25958017
         TM    DCBBQFLG,WRUWTFLG        IS WRU CODED YES IN THE DCB000G 25964017
         BO    BSCIDENT                 BRANCH IF YES              000G 25970017
         B     TWXIDENT                 BRANCH IF NOT              000G 25976017
         SPACE 3                                                        26000013
BSCADRS  SR    BRREG,BRREG              CLEAR REGISTER             000B 26050014
RESPAREA LA    AREAREG,DECRESPN         LOAD RESPONSE AREA ADDRESS      26100013
         A     AREAREG,0(CCWREG)        ADD CCW COMMAND                 26200013
STRESP   ST    AREAREG,0(CCWREG)        STORE IN CCW                    26300013
         TM    DECCMCOD,XF0             IS THIS A SWLST ?      @ZA11032 26306000
         BO    TESTLAST                 GO PROCESS LIST        @ZA11032 26312000
         LTR   BRREG,BRREG              IS WREG EMPTY                   26400013
         BZ    TESTLNG                  YES, POLL/ADRS DOES NOT PRECEDE 26500013
         TM    0(BRREG),X'80'           NO, IS POLL/ADRS TERM LAST      26600013
         BZ    RSTBRREG                 NO                              26700013
         CLI   5(CCWREG),X'06'          IS TP OP CODE 06           000H 26730018
         BNE   SETCC                    NO, SET COMMAND CHAINING   000H 26760018
         CLI   7(CCWREG),X'02'          IS CCW COUNT TWO           000H 26790018
         BE    RSTBRREG                 YES, DON'T SET COMMAND CHAIN 0H 26820018
SETCC    OI    4(CCWREG),X'40'          SET COMMAND CHAIN IN CCW   000H 26850018
RSTBRREG SR    BRREG,BRREG              RESET REGISTER                  26900013
         B     TESTLNG                                                  27000013
         SPACE 3                                                        27100013
BSCRESP  SR    AREAREG,AREAREG          RESET REGISTER             000B 27110014
         IC    AREAREG,IOBSNDPT         INSERT ACK POINTER         000B 27120014
         AR    AREAREG,DCBREG           ADD DCB ADDRESS            000B 27130014
         B     CNTCHARS                 BRANCH                     000B 27140014
BSCCHARS LR    AREAREG,DCBREG           LOAD ADDRESS OF DCB        000B 27150014
         CLI   DECTYPE+1,WRRESET        IS THIS WR RESET         A32466 27152020
         BE    RESETACK                 YES, RESET ACK PTRS      S99245 27154002
         CLI   DECTYPE+1,WRRSTMON  IS THIS WR RESET MONITOR?     S99245 27154402
         BNE   CNTCHARS            NO, BRANCH TO CONTROL CHARS   S99245 27154802
RESETACK EQU   *                                                 S99245 27155202
         MVI   IOBRCVPT,X'00'           RESET RCV ACK POINTER    A32466 27156020
         MVI   IOBSNDPT,X'00'           RESET SEND ACK POINTER   A32466 27158020
         B     CNTCHARS                 BRANCH                     000B 27160014
SPECCHAR LR    AREAREG,CCWTBLRG         LOAD BASE ADDRESS OF CONSTANTS  27200013
         A     AREAREG,0(CCWREG)       POINT TO SPECIAL CHARS   YA01260 27202002
         LA    AREAREG,0(AREAREG)      CLEAR HIGH ORDER BYTE    YA01260 27204002
         SR    ICREG,ICREG             CLEAR WORKING REG        YA01260 27206002
         IC    ICREG,DCBEIOBX          GET IOB SIZE             YA01260 27210002
         LR    ICSREG,IOBREG           ADR OF IOB               YA01260 27212002
         AR    ICSREG,ICREG            POINT TO END OF IOB      YA01260 27214002
*        15    LINES OF CODE DELETED BY APAR -------------->   @ZA11036 27225500
         LA    ICREG,L24               POINT TO IOB AREA FOR            27226500
         SR    ONEREG,ONEREG           CLEAR WORK REG                   27227500
         SR    ICSREG,ICREG            START STOP SPEC CHARS    YA01260 27229702
         IC    ONEREG,L23(ICSREG)       PICK UP TOTAL CNT       YA01260 27234003
         SR    ICREG,ICREG             CLEAR WORK REG           YA01260 27238302
         IC    ICREG,7(CCWREG)         # SPEC CHARS THIS CCW    YA01260 27242602
         AR    ICSREG,ONEREG           UPDATE POINTER           YA01260 27246902
         BCTR  ICREG,0                 DECREMENT FOR EXECUTE    YA01260 27251202
         EX    ICREG,MOVER                                      YA01260 27255502
         B     AROUND                                           YA01260 27259802
MOVER    MVC   0(0,ICSREG),0(AREAREG)  MOVE SPEC CHARS FROM     YA01260 27264102
*                                      I/O DEVICE TO IOB        YA01260 27268402
AROUND   AR    ICREG,ONEREG            GET NEW TOTAL OF CHARS   YA01260 27272702
         LA    ICREG,1(ICREG)          ADD ONE FROM EX DECR.    YA01260 27277002
         LR    AREAREG,ICSREG          PT TO IOB AREA OF CHARS  YA01260 27281302
         SR    ICSREG,ONEREG           PT BACK TO BEGIN OF AREA YA01260 27285602
         STC   ICREG,L23(ICSREG)        INSERT NEW TOTAL        YA01260 27289903
         L     ONEREG,0(CCWREG)        PICK UP                  YA01260 27294202
         N     ONEREG,OPCODE           ONLY OP CODE             YA01260 27298502
         AR    AREAREG,ONEREG          OP CODE + DATA ADR       YA01260 27302802
         LA    ONEREG,1                SET BACK TO ONE          YA01260 27307102
         B     CNTWTTA1                CONTINUE                 YA01260 27311402
CNTCHARS LA    AREAREG,0(AREAREG)      CLEAR HIGH ORDER BYTE     A28611 27315702
         A     AREAREG,0(CCWREG)       ADD CMND CODE AND OFFSET  A28611 27320019
CNTWTTA1 ST    AREAREG,0(CCWREG)        STORE IN CCW             A25043 27400002
         B     TESTLAST                                                 27500013
WRITTONE EQU   *                                                   000L 27502019
         CLI   DECTYPE+1,RCONTONE       IS THIS A READ TCW         000L 27504019
         BE    BSCGRAPH                                            000L 27506019
         IC    ICREG,1(AREAREG)         COUNT OF RIDSEQ CHARACTERS      27508019
         SLL   ICREG,1                  MULTIPLY BY TWO            000H 27512018
         LA    AREAREG,2(ICREG,AREAREG) ADD TO LIST ADDRESS        000H 27518018
         IC    ICREG,0(AREAREG)         COUNT OF TIDSEQ CHARACTERS 000H 27524018
         LA    AREAREG,1(ICREG,AREAREG) ADD TO LIST ADDRESS        000H 27530018
         MVC   6(2,CCWREG),0(AREAREG)   MOVE 'TONE' COUNT TO CCW   000H 27536018
         MVC   1(3,CCWREG),2(AREAREG)   MOVE 'TONE' ADDRESS TO CCW 000H 27542018
         B     TESTLAST                                            000H 27548018
         SPACE 3                                                        27554018
BSCDIAL  TM    0(AREAREG),ANSLST                                   000H 27560018
         BNZ   LIST                                                000H 27566018
         TM    DECTYPE,ONLTST                                      000H 27572018
         BO    MOVEIN                                              000H 27578018
         MVC   IOBWORK+1(1),DECTYPE+1  MOVE DECTYPE TO WORK      A26887 27584019
         NI    IOBWORK+1,MASKALL-ANDOFF AND OFF UNUSED BIT       A26887 27590019
         CLI   IOBWORK+1,X'0C'          THIS WRITE TIE           A32468 27592020
         BE    INVALID                  YES, BRANCH              A32468 27594020
         XI    IOBWORK+1,WRTMASK       IS OPERATION WRITE INIT   A26887 27596019
         TM    IOBWORK+1,MASKBITS      IF NOT ANSLST IS VALID    A26887 27602019
         BM    MOVEIN                  SO MOVE IN ENABLE         A26887 27608019
         B     INVALID                                             000H 27614018
MOVEIN   EQU   *                                                   000H 27620018
         MVC   0(8,CCWREG),ENABLCCW     MOVE IN ENABLE CCW         000B 27630014
         OI    4(CCWREG),CCFLAG         SET ON COMMAND CHAIN       000B 27640014
         TM    DECTYPE,ONLTST          IS THIS ON-LINE-TEST        000H 27643018
         BO    TESTLAST                 YES, GO FINIST CHANNEL PGM 000H 27646018
         TM    0(AREAREG),WTLIST        IS ENTRY A WORLD TRADE LIST000H 27649018
         BZ    ANSWER                   NO, REGULAR ANSWER LIST    000H 27652018
         CLI   DECTYPE+1,X'02'         IS THIS A WRITE INITIAL   A29563 27653019
         BE    TESTLAST                IF SO, FINISH CHAN PROG   A29563 27654019
         LA    ZEROREG,11(ZEROREG)      YES, SKIP UNUSED CCWS      000H 27655018
         B     UPDATE                                              000H 27658018
ANSWER   LA    ZEROREG,7(ZEROREG)       SKIP UNUSED CCWS           000H 27661018
UPDATE   IC    TOTREG,0(ZEROREG,CHPRGREG) UPDATE CCW COUNT         000H 27664018
         B     TESTLAST                                            000B 27664803
LIST     EQU   *                   DIAL CCW                     YA01029 27665603
         CLI   DECTYPE+1,WINIT     WRITE TI?                    YA01029 27666403
         BNE   LIST1               NO, DO NORMAL DIAL           YA01029 27667203
         TM    DECCMCOD,XF0        IS THIS A SWLST ?           @ZA11032 27667400
         BO    TESTLNG             GO PROCESS LIST             @ZA11032 27667600
         CLI   1(AREAREG),FE       ANSWER LIST?                 YA01029 27674002
         BNE   LIST1               NO, DO NORMAL DIAL           YA01029 27675002
         SR    ICSREG,ICSREG       CLEAR                        YA01029 27676002
         IC    ICSREG,DCBDEVTP     DISPLACE TO IOD              YA01029 27677002
         SLL   ICSREG,2            MAKE IT WORDS                YA01029 27678002
         LA    ICSREG,IOD(ICSREG)  DISPLACE INTO IOD            YA01029 27679002
         CLI   0(ICSREG),MXTYPE    2740 WITH RC AND DIAL?       YA01029 27680002
         BNE   LIST1               NO, DO NORMAL DIAL           YA01029 27681002
         MVI   0(CCWREG),ENABLE    SET DIAL OP TO ENABLE        YA01029 27682002
         MVI   3(CCWREG),OHH       CLEAR DATA ADR               YA01029 27683002
         MVI   7(CCWREG),ONE       SET LENGTH TO ONE            YA01029 27684002
         B     TESTLNG             GO PROCESS LIST              YA01029 27685002
LIST1    EQU   *                                                YA01029 27686002
         MVC   7(1,CCWREG),0(AREAREG)   MOVE DIAL COUNT TO COUNT FIELD  27700002
         A     AREAREG,0(CCWREG)        ADD COMMAND AND ADRS OFFSET     27800013
         ST    AREAREG,0(CCWREG)                                        27900013
         B     TESTLNG                                                  28000013
         SPACE 2                                                        28010018
FRAMECH  MVC   3(1,CCWREG),0(AREAREG)   MOVE DIAL COUNT FOR ADD    000K 28020018
         LA    AREAREG,1(AREAREG)       BUMP POINTER PAST DIAL CT  000K 28030018
         B     CNTCHARS                 GO BUMP DATA ADDRESS       000K 28040018
*                                        PAST DIAL CHARS TO POINT  000K 28050018
*                                        TO FRAME CHANGE CHARS     000K 28060018
         EJECT                                                          28100013
PA1050D  IC    ICREG,0(AREAREG)         INSERT COUNT OF DIAL CHARACTERS 28200013
         LA    AREAREG,1(ICREG,AREAREG) ADD TO ADRS FOR POLL/ADRS CHAR  28300013
         B     LODCNT                                                   28400013
         SPACE 3                                                        28500013
PALIST   TM    DECTYPE,X'04'            TEST FOR 'S' OPERAND            28600013
         BZ    LODCNT                   IF NOT, BRANCH                  28700013
         IC    ICREG,2(CCWREG)          LOAD POLL OR ADRS OFFSET        28800013
         C     BRREG,DECADRPT(ICREG)    IS PTR ZERO (1ST TIME ONLY)     28900013
         BE    LODCNT                   IF SO, BRANCH                   29000013
         L     AREAREG,DECADRPT(ICREG)  LOAD POLL/ADRS ADDRESS          29100013
LODCNT   CLI   7(CCWREG),X'00'          IS CCW COUNT ZERO          000F 29110017
         BE    CONTINUE                 IF SO, BRANCH              000F 29120017
         IC    ICREG,7(CCWREG)          GET COUNT OF ADDRESS CHARS 000F 29130017
         AR    AREAREG,ICREG            ADD TO TERMINAL ADDRESS    000F 29140017
         B     SETSNS                                              000F 29150017
CONTINUE LA    ICREG,1                  SET COUNT TO ONE           000F 29160017
         LA    ICSREG,8                 SET MAX COUNT TO EIGHT     000F 29170017
LOOP     CLC   0(1,AREAREG),DCBBSENQ    IS THIS CHAR INQUIRY       000F 29180017
         BE    FOUND                   IF SO, BRANCH               000F 29190017
         LA    ICREG,1(ICREG)           STEP COUNT BY ONE          000F 29200017
         LA    AREAREG,1(AREAREG)       STEP ADDRESS BY ONE        000F 29210017
         BCT   ICSREG,LOOP              MAXIMUM CHARACTERS CHECKED 000F 29220017
         B     INVALADR                IF SO, BAD TERM LIST        000F 29230017
FOUND    STC   ICREG,7(CCWREG)          STORE COUNT IN CCW         000F 29240017
         LA    AREAREG,1(AREAREG)       ADD ONE TO ADDRESS         000F 29250017
SETSNS   MVI   IOBSENS0,X'00'                                      000F 29260017
TESTSKIP TM    0(AREAREG),X'40'         TEST SKIP BIT                   29400013
         BZ    PAOK                     NOT SKIP                        29500013
         TM    0(AREAREG),X'80'         TEST END OF LIST BIT            29600013
         BO    ALLSKIP                  END OF LIST                     29700013
         TM    0(AREAREG),X'20'         TEST FORMAT BIT                 29800013
         BZ    PASTEP                   NOT ON                          29900013
         CLI   IOBSENS0,X'00'           IS THIS 2ND TIME THRU LIST 2064 30000014
         BNE   ALLSKIP                  IF SO, BRANCH              2064 30100014
         MVC   IOBSENS0(2),1(AREAREG)   MOVE DECREMENT OF LIST COUNT    30200013
         AH    AREAREG,IOBSENS0         RESET ADDRESS TO START OF LIST  30300013
PASTEP   LA    AREAREG,1(ICREG,AREAREG) STEP TO NEXT CONTROL BYTE       30400013
         B     TESTSKIP                                                 30500013
PAOK     IC    ICREG,2(CCWREG)          LOAD POLL-ADRS OFFSET           30600013
         MVI   2(CCWREG),X'00'          ZERO OFFSET                     30700013
         LR    BRREG,AREAREG            SAVE ADRS OF CONTROL BYTE       30800013
         SH    AREAREG,6(CCWREG)        SUBTRACT TO GET ADRS OF P/A CHR 30900013
         A     AREAREG,0(CCWREG)        ADD AREA INCREMENT & CCW COMMND 31000013
         ST    AREAREG,0(CCWREG)        PLACE RESULT IN CCW             31100013
         LA    AREAREG,0(AREAREG)       ZERO OUT COMMAND CODE           31200013
         ST    AREAREG,DECADRPT(ICREG)  UPDATE CURRENT POLL/ADRS PTR    31300013
         B     TESTLAST                                                 31400013
SWIDREC  EQU   *                                                   000L 31404019
         MVC   7(1,CCWREG),6(AREAREG)   MOVE IN COUNT              000L 31408019
         LA    AREAREG,8(AREAREG)       GET ADDRESS OF READ-IN-AREA000L 31412019
         A     AREAREG,0(CCWREG)        ADD COMMAND AND OFFSET     000L 31416019
         ST    AREAREG,0(CCWREG)        STORE IN CCW               000L 31420019
         B     TESTLAST                                            000L 31424019
SWIDSENT EQU   *                                                   000L 31428019
         SR    ICSREG,ICSREG            CLEAR WORK REGISTER        000L 31432019
         IC    ICSREG,6(AREAREG)        GET READ-IN-AREA LENGTH    000L 31436019
         IC    ICREG,7(AREAREG)         GET DIAL COUNT             000L 31440019
         AR    ICREG,ICSREG                                        000L 31444019
         LA    AREAREG,8(AREAREG)                                  000L 31448019
         AR    AREAREG,ICREG            POINT TO ID COUNT          000L 31452019
MVCOUNT  EQU   *                                                        31456019
         MVC   7(1,CCWREG),0(AREAREG)   MOVE COUNT TO CCW               31460019
         LA    AREAREG,1(AREAREG)       POINT TO IDSENT            000L 31464019
         A     AREAREG,0(CCWREG)        ADD TO COMMAND             000L 31468019
         ST    AREAREG,0(CCWREG)        STORE IN CCW               000L 31472019
         B     TESTLAST                                            000L 31476019
SWLSTTIC EQU   *                                                   000L 31480019
         LA    AREAREG,IOBCPA           POINT TO ENABLE CCW        000L 31484019
         A     AREAREG,0(CCWREG)        ADD TO COMMAND             000L 31488019
         ST    AREAREG,0(CCWREG)        STORE IN CCW               000L 31492019
         B     TESTLAST                                            000L 31496019
         EJECT                                                          31500013
*                                                                  000A 31600013
AUTOPOLL DS    0H                                                  000A 31700013
         OI    DECTYPE,AP                                          000A 31800013
         MVI   IOBSNDPT,X'00'           INITIALIZE SEND ACK PTR    000B 31850014
         MVI   IOBRCVPT,X'02'    INITIALIZE RECEIVE ACK PTR             31860002
*                             TEST FOR 'S' OPERAND.                000A 31900013
STEST    TM    DECTYPE,X'04'                                       000A 32000013
         BZ    AP1COMP                                             000A 32100013
*                             'S' OPERAND - IS PTR=0 -1ST TIME ONLY000A 32200013
         C     BRREG,DECPOLPT                                      000A 32300013
         BE    AP1COMP                                             000A 32400013
*                             USE LAST INDEX/ADDRESS               000A 32500013
         L     AREAREG,DECPOLPT                                    000A 32600013
         SH    AREAREG,HDRLN                                       000A 32700013
         MVC   INDEX(1),DECPOLPT                                   000A 32800013
         B     AP1ONLT                                             000D 32900016
*                                                                  000A 33000013
*                             SCAN FOR SCAN STOP BYTE (FE)         000A 33100013
AP1STEP  AR    AREAREG,ONEREG                                      000A 33200013
AP1COMP  CLI   0(AREAREG),FE                                       000A 33300013
         BNE   AP1STEP                                             000A 33400013
*                                                                  000A 33500013
*                             POINT TO HEAD OF LIST                000A 33600013
         MVC   OFFSET(2),1(AREAREG)                                000A 33700013
         SH    AREAREG,OFFSET                                      000A 33800013
         AR    AREAREG,ONEREG                                      000A 33900013
*                                                                  000A 34000013
*                             GET INDEX BYTE                       000A 34100013
         IC    ICREG,2(AREAREG)                                    000A 34200013
         SRL   ICREG,5                                             000A 34300013
         CR    ICREG,ONEREG        IF POLLING LIST ENTRY IS     YA01016 34320002
         BH    *+8                 0 OR 1, THE TRUE LENGTHS ARE YA01016 34340002
         LA    ICREG,8(ICREG)      8 OR 9 RESPECTIVELY          YA01016 34360002
         L     ICSREG,DECENTRY                                     000A 34400013
         AR    ICSREG,ICREG                                        000A 34500013
         SR    ICSREG,ONEREG                                       000A 34600013
         MVC   INDEX(1),0(ICSREG)                                  000A 34700013
*                                                                  000A 34800013
AP1ONLT  EQU   *                                                   000D 34900016
*                             TEST FOR ON LINE TERM TEST RE-START  000D 35000016
         TM    IOBINCAM,ONLT                                       000D 35100016
         BO    FAEAD                                               000D 35200016
*                             TEST FOR ERP                         000A 35400013
         TM    IOBFLAG1,ERP                                        000A 35500013
         BO    FAEAD                                               000A 35600013
*                             CHECK HEADER                         000D 35610016
AP1HDRC  CLI   1(AREAREG),0                                        000D 35620016
         BE    ALLSKIP                                             000D 35630016
         CLI   7(CCWREG),X'00'         IS THIS START STOP?       A41109 35631002
         BE    AP1USECK                YES, PROCEED              A41109 35632002
         CLI   1(AREAREG),1            ONE ENTRY                 A26909 35633019
         BNE   AP1USECK                NO, CHECK USAGE COUNT     A26909 35636019
         CLC   3(1,AREAREG),DCBBSEOT   IS ENTRY EOT              A26909 35639019
         BE    ALLSKIP                 YES, TURN ON SKIP BIT     A26909 35642019
AP1USECK TM    2(AREAREG),X'0F'        FULL USAGE                A26909 35645019
         BO    FULLUSE                                             000D 35650016
*                             INCREMENT USER COUNT                 000A 35700013
         IC    ICREG,2(AREAREG)                                    000A 35800013
         AR    ICREG,ONEREG                                        000A 35900013
         STC   ICREG,2(AREAREG)                                    000A 36000013
*                                                                  000A 36100013
*                             SAVE 1ST ENTRY ADDRESS               000A 36200013
FAEAD    XC    DECPOLPT+1(3),DECPOLPT+1                            000A 36300013
         LA    ICSREG,HDR(AREAREG)                                 000A 36400013
         O     ICSREG,DECPOLPT                                     000A 36500013
         ST    ICSREG,DECPOLPT                                     000A 36600013
*                                                                  000A 36700013
*                             MOVE IN TIC COMMAND                  000A 36800013
         MVC   8(8,CCWREG),APTIC                                   000A 36900013
         LA    ICSREG,24(CCWREG)                                   000A 37000013
         O     ICSREG,8(CCWREG)                                    000A 37100013
         ST    ICSREG,8(CCWREG)                                    000A 37200013
*                             TEST FOR WRAP BIT                    000A 37300013
         TM    2(AREAREG),X'10'                                    000A 37400013
         BZ    APOPEN                                              000A 37500013
*                             MOVE IN TIC COMMAND                  000A 37600013
         MVC   16(4,CCWREG),APTIC                                  000A 37700013
         ST    BRREG,20(CCWREG)                                    000A 37800013
         LA    ICSREG,40(CCWREG)                                   000A 37900013
         O     ICSREG,16(CCWREG)                                   000A 38000013
         ST    ICSREG,16(CCWREG)                                   000A 38100013
         MVC   24(16,CCWREG),0(CCWREG)                             000A 38200013
         MVC   25(3,CCWREG),DECPOLPT+1                             000A 38300013
*        ONE LINE DELETED BY FOLLOWING PTM                       YM4072 38350002
         B     AP1SCAN                                             000A 38400013
*                             OPEN LIST - CHANGE TIC TO I/O NOP    000A 38500013
APOPEN   MVI   8(CCWREG),NOOP                                      000A 38600013
*                                                                  000A 38700013
*                                                                  000A 38800013
*                             SCAN FOR INDEX BYTE                  000A 38900013
AP1SCAN  SR    ICSREG,ICSREG                                       000A 39000013
         IC    ICSREG,1(AREAREG)                                   000A 39100013
         STC   ICSREG,AE                                           000A 39200013
         IC    ICREG,2(AREAREG)                                    000A 39300013
         SRL   ICREG,5                                             000A 39400013
         CR    ICREG,ONEREG        IF POLLING LIST ENTRY IS     YA01016 39420002
         BH    AP2STEP             0 OR 1, THE TRUE LENGTHS ARE YA01016 39440002
         LA    ICREG,8(ICREG)      8 OR 9 RESPECTIVELY          YA01016 39460002
AP2STEP  AR    AREAREG,ICREG                                       000A 39500013
         TM    DISP2(AREAREG),FORTY                             YA03268 39550000
         BO    AP3CONT                                          YA03268 39560000
         CLC   2(1,AREAREG),INDEX                                  000A 39600013
         BNL   AP3CONT                                             000A 39700013
         BCT   ICSREG,AP2STEP                                      000A 39800013
         L     AREAREG,DECPOLPT                                    000A 39900013
         LA    AREAREG,0(AREAREG)  ZERO HIGH ORDER BYTE          A43772 39920002
         B     AP3ACONT                                          A33975 39950020
*                                                                  000A 40000013
*                             PUT STARTING ADDRESS INTO POLL       000A 40100013
AP3CONT  SR    AREAREG,ICREG                                       000A 40200013
         LA    AREAREG,HDR(AREAREG)                                000A 40300013
AP3ACONT EQU   *                                                 A33975 40350020
         O     AREAREG,0(CCWREG)                                   000A 40400013
         ST    AREAREG,0(CCWREG)                                   000A 40500013
*                             FIND TOTAL LENGTH                    000A 40600013
*                                       TEST FOR SINGLE ENTRY           40610016
*                                            (FOR RJE  REMOVE REL 18)   40620016
         CLI   AE,1                                                     40630016
         BNE   APTLEN                                                   40640016
         XC    6(2,CCWREG),6(CCWREG)                                    40650016
APTLEN   EQU   *                                                        40660016
         CLI   7(CCWREG),X'00'         IS THIS START STOP          000J 40665018
         BE    AP1EOT                   YES  PROCEED               000J 40670018
         SR    ICREG,ONEREG             DECREMENT TO GET LAST      000J 40675018
         STH   ICREG,6(CCWREG)         >AVE IN CCW                 000J 40680018
         AR    ICREG,ONEREG            GET BACK AS WAS             000J 40685018
AP1EOT   EQU   *                                                   000J 40690018
         IC    ICSREG,AE                                           000A 40700013
         MR    ICSREG,ICSREG                                       000A 40800013
         SH    ICREG,6(CCWREG)                                          40850016
         STH   ICREG,30(CCWREG)                                    000A 40900013
*                             FIND LENGTH FOR FIRST POLL           000A 41000013
         SR    ICREG,AREAREG                                       000A 41100013
         L     ICSREG,DECPOLPT      LOAD POLLING POINTER       @ZA07658 41130003
         LA    ICSREG,ZERO(ICSREG)   CLEAR HI BYTE             @ZA07658 41160003
         AR    ICREG,ICSREG                                    @ZA07658 41200003
         STH   ICREG,6(CCWREG)                                     000A 41300013
         SR    ICREG,ICREG                                         000A 41400013
*                                                                  000A 41500013
*                             INCREMENT CCWREG FOR NEXT OPERATION  000A 41600013
         LA    CCWREG,8(CCWREG)                                    000A 41700013
         LR    AREAREG,ICSREG                                  @ZA07658 41800003
         SH    AREAREG,HDRLN                                       000A 41900013
         TM    2(AREAREG),X'10'                                    000A 42000013
         BZ    AP2OPEN                                             000A 42100013
         LA    CCWREG,24(CCWREG)                                   000A 42200013
AP2OPEN  EQU   *                                                   000A 42300013
*                             CLEAR WORKAREA                       000A 42400013
         XC    INDEX(4),INDEX                                      000A 42500013
         B     TESTLAST                                            000A 42600013
*                                                                  000A 42700013
*                             CONSTANTS AND SYMBOLS                000A 42800013
FE       EQU   X'FE'                                               000A 42900013
HDR      EQU   3                                                   000A 43000013
NOOP     EQU   X'03'                                               000A 43100013
ONLT     EQU   X'01'                                               000D 43150016
AP       EQU   X'80'                                               000A 43200013
PCI      EQU   X'08'                                                    43250002
HDRLN    DC    H'3'                                                000A 43300013
APTIC    DC    X'0800000020090001'                                 000A 43400013
         DS    0F                                                       43450003
         EJECT                                                          43500013
BSCIDENT EQU   *                                               @ZA04152 43502003
         TM    DECCMCOD,XF0             IS THIS SWITCHLIST     @ZA11032 43502600
         BO    BIDENT                   YES                    @ZA11032 43503200
         IC    ICREG,ZERO(AREAREG) INSERT COUNT OF DIAL CHARS  @ZA04152 43504000
         N     ICREG,DIALMASK                                      000H 43504200
         LA    AREAREG,1(ICREG,AREAREG) ADD TO LIST ADDRESS        000B 43504400
         CLI   0(AREAREG),FE            IS THIS THE END OF THE LIST000J 43504600
         BNE   IDENT1                                              000J 43504800
         SH    CCWREG,EIGHT             POINT TO THE PREVIOUS CCW  000J 43505000
         CLI   0(CCWREG),DIAL           WAS LAST COMMAND DIAL      000J 43505200
         BNE   ANSER                                               000J 43505400
         AH    CCWREG,EIGHT             POINT TO THE PRESENT CCW   000J 43505600
         MVI   7(CCWREG),ONE            PUT COUNT OF 1 IN CCW      000J 43505800
         LR    AREAREG,DCBREG           LOAD ADDRESS OF DCB        000J 43506000
         MVI   3(CCWREG),FORTY4         SET DCB OFFSET             000J 43506200
         B     CNTCHARS                                            000J 43506400
BIDENT   SR    ICSREG,ICSREG            CLEAR REGISTER         @ZA11038 43506600
         SR    ICREG,ICREG              CLEAR REGISTER         @ZA11038 43506800
         IC    ICSREG,L6(AREAREG)  GET READ IN AREA LENGTH     @ZA11038 43507000
         IC    ICREG,L7(AREAREG)     GET DIAL COUNT            @ZA11038 43507200
         AR    ICSREG,ICREG      READ AREA LNG + DIAL CNT      @ZA11038 43507400
         AR    AREAREG,ICSREG RD AREA LNG + DIAL CNT +LIST ADR @ZA11038 43507600
         LA    AREAREG,L8(AREAREG)   GET ID COUNT-SWLST        @ZA11038 43507800
         MVC   L7(L1,CCWREG),L0(AREAREG)  MOVE ID COUNT TO CCW @ZA11038 43508000
         LA    AREAREG,L1(AREAREG)      POINT TO ID SENT       @ZA11038 43508200
         L     ICSREG,L0(CCWREG)        LOAD CMD CODE          @ZA11038 43508400
         N     ICSREG,OPCODE            ZERO ADDR AREA         @ZA11038 43508600
         AR    AREAREG,ICSREG           ADD ADDRESS            @ZA11038 43508800
         ST    AREAREG,DISP0(CCWREG)                           @ZA04152 43509200
         B     TESTLAST                                        @ZA04152 43509400
ANSER    AH    CCWREG,EIGHT             POINT TO THE PRESENT CCW   000J 43526003
         MVI   5(CCWREG),TP08           MOVE IN TP OP CODE         000J 43526518
         MVI   7(CCWREG),TWO            PUT COUNT OF 2 IN CCW      000J 43527018
         LR    AREAREG,DCBREG           LOAD ADDRESS OF DCB        000J 43527518
         MVI   3(CCWREG),FORTY          SET DCB OFFSET             000J 43528018
         B     CNTCHARS                                            000J 43528518
IDENT1   EQU   *                                                   000J 43529018
         IC    ICREG,0(AREAREG)         INSERT COUNT OF ID CHARS   000B 43530014
         SLL   ICREG,1                  MULTIPLY BY TWO            000B 43540014
         LA    AREAREG,1(ICREG,AREAREG) ADD TO ADDRESS             000B 43550014
         B     CNTINID                                             000B 43560014
TWXIDENT EQU   *                                               @ZA04152 43562000
         TM    DECCMCOD,XF0             IS THIS SWITCHLIST     @ZA11032 43564000
         BO    TIDENT                   YES, UPDATE CCW        @ZA11032 43566000
         IC    ICREG,ZERO(AREAREG)  INSERT CNT OF DIAL CHARS   @ZA04152 43600003
         N     ICREG,DIALMASK                                      000H 43650018
         LA    AREAREG,1(ICREG,AREAREG) ADD TO LIST ADRS                43700013
         CLI   0(AREAREG),FE            IS THIS THE END OF THE LIST000J 43705018
         BNE   CNTINID                                             000J 43710018
         SH    CCWREG,EIGHT             POINT TO PREVIOUS CCW      000J 43715018
         CLI   0(CCWREG),ENABLE         WAS IT AN ENABLE COMMAND   000J 43720018
         BNE   CALL                                                000J 43725018
         AH    CCWREG,EIGHT             POINT TO PRESENT CCW       000J 43730018
         MVI   5(CCWREG),TP0B            MOVE IN TP OP CODE        000J 43735018
         B     LDRESPN                                             000J 43740018
TIDENT   LA    AREAREG,SIX(AREAREG)   ADDR OF READ IN COUNT    @ZA04152 43740703
         MVC   C7(ONE,CCWREG),ZERO(AREAREG) MOVE IN COUNT      @ZA04152 43741403
         LA    AREAREG,ONE(AREAREG)     BUMP TO READ IN AREA   @ZA11038 43742100
         A     AREAREG,ZERO(CCWREG)   ADD CMD CODE AND OFFSET  @ZA04152 43742803
         ST    AREAREG,ZERO(CCWREG)    STORE IN CCW            @ZA04152 43743503
         B     TESTLAST                 GO CHECK NEXT CCW      @ZA04152 43744203
CALL     EQU   *                                                   000J 43745018
         AH   CCWREG,EIGHT              POINT TO PRESENT CCW       000J 43750018
         MVI   5(CCWREG),TP0C           MOVE IN TP OP CODE         000J 43755018
LDRESPN  EQU   *                                                   000J 43760018
         MVI   7(CCWREG),TWO            PUT A COUNT OF 2 IN CCW    000J 43765018
         LA    AREAREG,DECRESPN         LOAD RESPONSE AREA ADDRESS 000J 43770018
         MVI   3(CCWREG),ZERO           ZERO OUT DCB OFFSET        000J 43775018
         A     AREAREG,0(CCWREG)        ADD CCW COMMAND            000J 43780018
         ST    AREAREG,0(CCWREG)        STORE IN CCW               000J 43785018
         B     TESTLAST                                            000J 43790018
CNTINID  MVC   7(1,CCWREG),0(AREAREG)   MOVE COUNT OF ID TO CCW    000B 43800014
CNTWTTA2 A     AREAREG,0(CCWREG)        ADD COMMAND AND OFFSET   A25043 43900002
         ST    AREAREG,0(CCWREG)        STORE IN CCW                    44000013
         B     TESTLAST                                                 44100013
         SPACE 3                                                        44200013
DISABLE  CLI   0(AREAREG),X'00'         IS LIST AN ANSWER LIST          44300013
         BNE   TESTLAST                 NO,O.K. TO SET UP DIAL CCW      44400013
         BXH   ZEROREG,ONEREG,0(RETREG) YES, STEP CNTR OMITTING DIAL    44500013
         LA    CCWREG,8(CCWREG)         STEP CCW REGISTER               44600013
         MVC   0(8,CCWREG),ENABLCCW     USE ENABLE CCWVS. DIAL          44700013
         B     TESTLAST                                                 44800013
         SPACE 3                                                        44900013
BSCGRAPH L     ICSREG,DECWAREA          LOAD ADDRESS I/O AREA      000B 44910014
         L     AREAREG,0(CCWREG)        LOAD CMND CODE AND OFFSET  000B 44920014
         AR    AREAREG,ICSREG           ADD AREA ADDRESS           000B 44930014
         ST    AREAREG,0(CCWREG)        STORE IN CCW               000B 44940014
         CLI   DECTYPE+1,RCONTONE       IS THIS A READ TCW         000L 44943019
         BE    BSCWLNG                                             000L 44946019
         B     TESTLNG                                             000B 44950014
         SPACE 3                                                        44960014
*                                       LENGTH ROUTINES                 45000013
         SPACE 2                                                        45100013
BSCWLNG  NI    6(CCWREG),ZERO           ZERO SUBROUTINE INDEX      000B 45120014
         LH    AREAREG,DECWLNG          LOAD WLENGTH FROM DECB     000B 45140014
         B     CNTNLNG                                             000B 45160014
DATALNG NI     6(CCWREG),X'00'          ZERO SUB-ROUTINE INDEX          45200013
         CLI   L7(CCWREG),XFF     2740 READ REPEAT AUTO POLL   @ZA10035 45210000
         BNE   DATALNG1            BRANCH NO                   @ZA10035 45220000
         MVI   L7(CCWREG),X00    CLEAR FF IN REPEAT CCW        @ZA10035 45230000
         CLI   IOBWORK+L1,X01      LAST OPERATION RD TI        @ZA10035 45240000
         BNE   DATALNG1            BRANCH NO                   @ZA10035 45250000
         MVI   L7(CCWREG),X01  PREPARE TO DECREASE CNT BY ONE  @ZA10035 45260000
DATALNG1 LH    AREAREG,DECLNGTH         LOAD LENGTH FROM DECB  @ZA10035 45270000
CNTNLNG  SH    AREAREG,6(CCWREG)        SUBTRACT OFFSET            000B 45400014
CNTWTTA3 STH   AREAREG,6(CCWREG)        STORE IN CCW             A25043 45500002
         B     TESTLAST                                                 45600013
CONVLENG MVI   6(CCWREG),X'00'          CLEAR OUT OFFSET                45610018
         LH    ICSREG,DECLNGTH          GET USER'S LENGTH AND COUNT     45620018
         CLI   DECTYPE+1,X'16'          THIS WRITE ENQ           A38557 45622020
         BNE   CNVLENG1                 NO, BRANCH               A38557 45624020
         TM    DECTYPE,X'08'            DECAREA/LENGTH SPECIFIED A38557 45626020
         BO    CNVLENG1                 YES, BRANCH              A38557 45628020
         MVI   7(CCWREG),X'02'          SET LENGTH TO TWO        A38557 45630020
         B     CNVLENG2                 BRANCH TO SET LAST CCW   A38557 45632020
CNVLENG1 EQU   *                                                 A38557 45634020
         CH    ICSREG,LENG20            IS USER'S LENGTH MORE THAN 20   45637018
         BH    TESTLAST                 YES, GO BUILD NEXT CCW          45640018
         STH   ICSREG,6(CCWREG)              STORE IN CCW               45650018
CNVLENG2 EQU   *                                                 A32454 45655020
         OI    5(CCWREG),X'80'          TURN ON LAST CCW BIT            45660018
         NI    4(CCWREG),X'3F'          TURN OFF CHAIN BIT              45670018
         B     0(RETREG)                GET OUT                         45680018
*                                       DYNAMIC BUFFERING ROUTINE       45690018
         EJECT                                                          45700013
*                                  ACTIONS BASED ON RETURN FROM         45701002
*                                        IECTRDTI                       45702002
BADCB    EQU   *                   X'08' - INVALID CONTROL BLOCK        45703002
         MVI   SAVE15(SAVEREG),INVALCB  SET INVALID UCB CODE            45704002
         B     RESTREG             RESET AND RETURN TO USER             45705002
NOATTN   EQU   *                   X'04' - NO OUTSTANDING ATTN FOUND    45706002
         L     IOBREG,DCBIOBAD     LOAD INITIAL IOB BASE                45707002
         SR    ICREG,ICREG         CLEAR LOOP REG                       45708002
         IC    ICREG,DEBNMEXT      INSERT # OF RLN'S (LOOP COUNT)       45709002
         SR    ICSREG,ICSREG       CLEAR INCREMENT REG                  45710002
         IC    ICSREG,DCBEIOBX     INSERT SIZE OF IOB                   45711002
ATTNON   LA    IOBREG,0(ICSREG,IOBREG) POINT TO EACH IOB                45712002
         OI    IOBINCAM,BUSY       TURN ON BUSY BIT                     45713002
         NI    IOBFLAG2,XFE       TURN OFF RESETPL BIT      LD YA03952  45713400
         BCT   ICREG,ATTNON        LOOP UNTIL EVERY IOB BUSY BIT SET    45714002
         L     ICREG,DEBUCBAD      GET ADDRESS OF MSTR UCB      YA02057 45714402
         TM    GCB(ICREG),RDTI     IS READ TI ON?               YA02057 45714802
         BZ    BUSYOFF             NO, TURN OFF BUSY BITS       YA02057 45714902
RETURN   MVI   SAVE15(SAVEREG),GOODRTN  SET GOOD CODE           YA02057 45715002
         B     LOADM               EXIT                     LD @ZA02800 45716000
BUSYOFF  EQU   *                                                YA02057 45716402
         L     IOBREG,DCBIOBAD     GET DCB IOB ADDRESS          YA02057 45716802
         SR    ICREG,ICREG         CLEAR LOOP REG               YA02057 45716902
         IC    ICREG,DEBNMEXT      INSERT NUM OF RLNS           YA02057 45717802
BUSYLOOP LA    IOBREG,DISP0(ICSREG,IOBREG) POINT TO EACH IOB    YA02057 45719802
         NI    IOBINCAM,MASKALL-BUSY TURN OFF BUSY              YA02057 45720202
         BCT   ICREG,BUSYLOOP      LOOP                         YA02057 45720602
*                                  UNTIL ALL BITS ARE OFF       YA02057 45720702
         B     RETURN              SET RC=0 AND RETURN          YA02057 45720802
FINDATTN EQU   *                   X'00' - ATTENTION WAS FOUND          45721002
         L     DECBREG,IOBECBPT    GET ADDRESS OF DECB                  45721602
         SR    ICREG,ICREG         CLEAR RLN REG                        45722502
         IC    ICREG,DECRLN        GET RLN                              45723402
         BCTR  ICREG,REG0          DECR RLN BY ONE                      45724302
         SR    ICSREG,ICSREG       CLEAR REG                            45725202
         IC    ICSREG,DEBNMEXT     GET MAX # OF UCB'S TO CHECK          45726102
         SR    ICSREG,ICREG        ADJUST FOR STARTING POINT            45727002
*                                                                       45727902
         SLL   ICREG,2             CONVERT RLN TO DISP INTO UCB LIST    45728802
*                                   BY MULTIPLYING BY 4                 45729702
         LA    UCBPTREG,DEBUCBAD(ICREG) GET PTR TO STARTING LOC IN LIST 45730602
LPONE    L     UCBREG,0(UCBPTREG)  GET ADDRESS OF UCB                   45731502
         TM    GCB(UCBREG),ATTN    WAS ATTENTION RECEIVED               45732402
         BNO   LPONECHK            NO, CHECK OTHERS                     45733302
         TM    GCB(UCBREG),OLTEPSKP OLTEP EXECUTING OR SKIP FLAG SET    45734202
         BZ    ATNFND              NO, ATTENTION FOUND                  45735102
*                                                                       45736002
LPONECHK LA    UCBPTREG,NEXTNTRY(UCBPTREG) INCR TO NEXT ENTRY           45736902
*                                  IN UCB LIST                          45737802
         BCT   ICSREG,LPONE        BR IF MORE TO CHECK                  45738702
         LTR   ICREG,ICREG         IF 0, ENTIRE LIST WAS SEARCHED BY    45739602
         BZ    ALLSKIP              1ST LOOP AND NO ATTN FOUND          45740502
         SRL   ICREG,2             RESTORE TO RLN                       45741402
         LA    UCBPTREG,DEBUCBAD   GET START OF UCB LIST                45742302
LPTWO    L     UCBREG,0(UCBPTREG)  GET ADDRESS OF UCB                   45743202
         TM    GCB(UCBREG),ATTN    WAS ATTENTION RECEIVED               45744102
         BNO   LPTWOCHK            NO, CHECK OTHERS                     45745002
         TM    GCB(UCBREG),OLTEPSKP OLTEP EXECUTING OR SKIP FLAG SET    45745902
         BZ    ATNFND              NO, ATTENTION FOUND                  45746802
LPTWOCHK LA    UCBPTREG,NEXTNTRY(UCBPTREG) INCR TO NEXT UCB ADDR        45747702
         BCT   ICREG,LPTWO         BR IF MORE TO CHECK                  45748602
*                                                                       45749502
         B     ALLSKIP             GO SET ALL DEVICES SKIP CODE         45750402
*                                                                       45751302
ATNFND   XC    DECPOLPT(POLPTLNG),DECPOLPT CLEAR DECPOLPT               45752202
         MVC   DECPOLPT+3(RLNGTH),READRLN(UCBREG)   MOVE RLN OF         45753102
*                                  DVC FROM UCB TO DECB                 45754002
         SPACE 1                                                YA02128 45754102
*                           RESET ATTENTION AND UPDATE COUNT    YA02128 45754202
         LR    PARMREG1,UCBREG     SET FOR SVC                  YA02128 45754502
         SR    PARMREG0,PARMREG0   CLEAR REG 0                  YA02128 45754602
         LA    BRREG,ONE           ROUTE CODE FOR ATNR          YA02128 45756102
         SVC   BTAMSVC             TO IECTSVC                   YA02128 45758702
         B     BTBL5(BRREG)        CHK RET CODE             L5 @ZA03567 45760003
BTBL5    B     PREEXCP                 IF 0 DO EXCP         L5 @ZA03567 45762003
         B     INVALUCB                IF 4 BAD UCB         L5 @ZA03567 45764003
         B     FINDRDY                 IF 8 DEV RDY         L5 @ZA03567 45766003
PREEXCP  EQU   *                                            L5 @ZA03567 45768003
         SR    ICSREG,ICSREG       CLEAR REG                 LD YA03952 45769203
         IC    ICSREG,DCBEIOBX     GET LENGTH OF IOB         LD YA03952 45771203
         L     ICREG,DCBIOBAD      GET ORIGIN OF IOB         LD YA03952 45773203
         LA    ICREG,ZERO(ICREG,ICSREG) IOB FOR RLN 1        LD YA03952 45775203
         NI    IOBFLAG2-IECTIOB(ICREG),XFE TURN OFF RESETPL  LD YA03952 45777203
*                                  BIT IN RLN 1ST IOB        LD YA03952 45779203
         L     DECBREG,IOBECBPT    HET ADDR OF DECB                     45781203
         CLC   DECRLN(RLNGTH),DECPOLPT+3   RLN SPECD = THAT FOR         45783203
         BNE   CPYIOB              DVC TO BE READ, USE EXIST IOB        45785203
         B     EXCP                START I/O                            45787203
*                                                                       45789203
CPYIOB   EQU   *                                                        45791203
*        2 LINES DELETED                                     LD YA03952 45793203
*                                                                       45795203
         MH    ICSREG,DECPOLPT+2   MULTIPLY BY DECPOLPT                 45797203
         L     ICREG,DCBIOBAD      GET BASE FOR IOB POOL                45799203
         LA    ICREG,0(ICREG,ICSREG) ADD DISP TO GET ADDR OF IOB TO BE  45801203
*                                     INITIALIZED                       45803203
         MVC   ECBPT(ECBPTLNG,ICREG),IOBECBPT COPY PTR TO ECB           45805203
         MVC   CPAPT(CPALNG,ICREG),IOBCPA COPY CHANNEL PGM              45807203
         LA    ICSREG,CPAPT(ICREG) COMPUTE ADDR OF CPA                  45809203
         ST    ICSREG,STARTPT(ICREG) AND STORE IN START ADDR            45811203
         MVC   ZERO(TWO,ICREG),IOBFLAG1 COPY IOBFLAG1 AND 2  LD YA03952 45813203
         LR    IOBREG,ICREG        ADDR OF IOB TO BE USED TO IOB BASE   45815203
         OI    IOBINCAM,BUSY       TURN ON IOB BUSY FLAG                45817203
         B     EXCP                START I/O                            45819203
FINDRDY  EQU   *                   X'0C' - READY DEVICE FOUND   YA02128 45821203
         L     DECBREG,IOBECBPT    GET ADDRESS OF DECB          YA02128 45823203
         SR    ICREG,ICREG         CLEAR RLN REG                YA02128 45825203
         IC    ICREG,DECRLN        GET RLN                      YA02128 45827203
         BCTR  ICREG,REG0          REDUCE RLN BY ONE            YA02128 45829203
         SR    ICSREG,ICSREG       CLEAR INDEX REG              YA02128 45831203
         IC    ICSREG,DEBNMEXT     GET MAX NUM UCB'S            YA02128 45833202
         SR    ICSREG,ICREG        ADJUST FOR STARTING POINT    YA02128 45843202
         SLL   ICREG,DISP2         CONVERT RLN TO DISPLACEMENT  YA02128 45853202
*                                  INTO UCB LIST                YA02128 45863202
         LA    UCBPTREG,DEBUCBAD(ICREG) POINT TO TOP OF LIST    YA02128 45865202
RDYLPONE EQU   *                   LOOK FOR READY FLAG          YA02128 45865602
         L     UCBREG,DISP0(UCBPTREG) UCB ADDRESS               YA02128 45866002
         TM    GRAF(UCBREG),RDYBIT THIS DEVICE COME READY?      YA02128 45866402
         BNO   RDYLPCHK            NO, CHECK NEXT               YA02128 45866502
         TM    GCB(UCBREG),OLTEP   OLTEP EXECUTING?             YA02128 45866602
         BZ    RDYFND              NO, READY FOUND              YA02128 45877702
RDYLPCHK EQU   *                   CHECK NEXT UCB               YA02128 45887702
         LA    UCBPTREG,NEXTNTRY(UCBPTREG) INCR TO NEXT ENTRY   YA02128 45888102
*                                  IN UCB LIST                  YA02128 45888502
         BCT   ICSREG,RDYLPONE     BR IF MORE TO CHECK          YA02128 45888602
         LTR   ICREG,ICREG         IF 0, NO READY FOUND OR      YA02128 45888702
         BZ    NOATTN              ONLY READY IS ON DEVICE      YA02128 45888802
*                                  WITH OLTEP EXECUTING         YA02128 45892502
         SRL   ICREG,DISP2         RESTORE RLN                  YA02128 45894502
         LA    UCBPTREG,DEBUCBAD   GET START OF UCB LIST        YA02128 45894902
RDYLPTWO EQU   *                   CHECK REST OF UCB'S          YA02128 45895302
         L     UCBREG,DISP0(UCBPTREG) UCB ADDRESS               YA02128 45895702
         TM    GRAF(UCBREG),RDYBIT THIS DEVICE COME READY?      YA02128 45896102
         BNO   RDY2CHK             NO, CHECK NEXT               YA02128 45896202
         TM    GCB(UCBREG),OLTEP   OLTEP EXECUTING?             YA02128 45922102
         BZ    RDYFND              NO, READY FOUND              YA02128 45932102
RDY2CHK  EQU   *                   CHECK NEXT UCB               YA02128 45942102
         LA    UCBPTREG,NEXTNTRY(UCBPTREG) INCR TO NEXT UCB     YA02128 45944102
         BCT   ICREG,RDYLPTWO      BR OF MORE TO DO             YA02128 45946102
         B     NOATTN              NO READY EXCEPT WHERE        YA02128 45948102
*                                  OLTEP EXECUTING              YA02128 45956702
*                                                               YA02128 45958702
RDYFND   EQU   *                   DEVICE HAS COME READY        YA02128 45960702
         XC    DECPOLPT(POLPTLNG),DECPOLPT CLEAR DECPOLPT       YA02128 45962702
         MVC   DECPOLPT+DISP3(RLNGTH),READRLN(UCBREG) MOVE      YA02128 45964702
*                                  RLN FROM UCB TO DECB         YA02128 45965102
         LR    PARMREG0,DECBREG    PUT DECB ADDRESS IN REG 0    YA02128 45965202
         LR    PARMREG1,UCBREG     PUT UCB ADDRESS IN REG 1     YA02128 45965302
         LA    BRREG,ONE           ROUTE CODE FOR ATNR          YA02128 45965402
         SVC   BTAMSVC             TO IECTSVC                   YA02128 45974002
         LTR   BRREG,BRREG         TEST RETURN CODE             YA02128 45976002
         BNZ   INVALUCB            X'04' - SET INVALID UCB      YA02128 45978002
         L     DECBREG,IOBECBPT    RESTORE DECB ADDRESS         YA02128 45980002
         NI    IOBINCAM,MASKALL-BUSY TURN OFF BUSY              YA02128 45982002
         MVI   SAVE15(SAVEREG),GOODRTN SET GOOD RETURN          YA02128 45982402
         MVC   DECPOLPT(RLNGTH),DECPOLPT+DISP3 PLUG RLN         YA02128 45982502
         MVI   DECFLAGS,RDYDEVIC   SAY CAME READY               YA02128 45982602
         B     LOADM               RETURN TO CALLER             YA02128 45982702
         SPACE 4                                                YA02128 46006102
*                                       DYNAMIC BUFFERING ROUTINE       46029802
         SPACE 2                                                        46053202
DBDATA   TM    6(CCWREG),X'0C'          READ RESPONSE OR READ DATA 000C 46076602
         BM    DATA                     BRANCH IF READ DATA      A29597 46100020
         AH    AREAREG,FULL4+2          INCREMENT AREA ADDRESS          46200013
         B     STRESP                                                   46300013
DATA     OI    4(CCWREG),X'88'          SET ON DATA CHAIN & PCI BIT     46400013
         A     AREAREG,FULL4            INCREMENT AREA ADRS BY SIZE LNK 46500013
         ST    AREAREG,0(CCWREG)        STORE IN CCW AREA               46600013
         MVI   6(CCWREG),X'00'          ZERO COUNT FIELD INDEX          46700013
         LR    AREAREG,ICSREG           PUT AREA ADDRESS IN AREARG 000B 46750014
         LH    ICSREG,DCBBUFL           LOAD BUFFER LENGTH FROM DCB     46800013
         MVI   0(AREAREG),X'00'         SET COMPLETION CODE TO O IN BFR 47000013
         CLI   0(CCWREG),X'02'          IS COMMAND READ                 47100013
         BE    READ                     YES                             47200013
         MVC   8(8,CCWREG),DBWRITE      MOVE TIC COMMAND TO 2ND CCW     47300013
         CLC   1(3,AREAREG),FULL4       IS LINK FIELD ZERO              47400013
         BNE   WRITE                    NO,MSG MORE THAN 1 BFR          47500013
         NI    4(CCWREG),X'77'          TURN OFF DC AND PCI FLAGS       47600013
         TM    DECTYPE+1,X'0D'                                     000B 47630014
         BO    WRWL                                                000B 47660014
         LH    ICSREG,DECLNGTH          USE BUFFER LENGTH IN DECB       47700013
WRL      SH    ICSREG,FULL4+2           SUBTRACT LINK LENGTH       000B 47800014
         SH    ICSREG,6(CCWREG)         SUBTRACT OFFSET                 47900013
         STH   ICSREG,6(CCWREG)         STORE COUNT IN CCW              48000013
         B     TESTLAST                                                 48100013
WRWL     LH    ICSREG,DECWLNG                                      000B 48130014
         B     WRL                                                 000B 48160014
READ     MVC   8(8,CCWREG),DBREAD       MOVE READ-SKIP CMND TO 2ND CCW  48200013
         MVI   4(AREAREG),X'00'         ZERO 1ST BYTE OF DATA AREA      48300013
WRITE    MVC   16(8,CCWREG),0(CCWREG)   MOVE 1ST CCW TO 3RD CCW         48400013
         MVC   24(8,CCWREG),8(CCWREG)   MOVE 2ND CCW TO 4TH CCW         48500013
         MVC   17(3,CCWREG),1(AREAREG)  MOVE ADRS OF NEXT BFR TO CCW    48600013
         L     AREAREG,16(CCWREG)       INCREMENT BY FOUR TO 1ST DATA   48700013
         A     AREAREG,FULL4                 BYTE                       48800013
         ST    AREAREG,16(CCWREG)                                       48900013
         OI    5(CCWREG),X'40'          SETON 1ST PCI BIT IN 1ST R/W    49000013
         SH    ICSREG,FULL4+2           SUBTR ACT 4                     49100013
         STH   ICSREG,22(CCWREG)        STROE IN 2ND READ/WRITE CCW     49200013
         O     CCWREG,24(CCWREG)        PLACE ADRS OF 1ST IN 4TH CCW    49300013
         ST    CCWREG,24(CCWREG)                                        49400013
         LR    AREAREG,CCWREG           SAVE ADRESS OF 1ST CCW          49500013
         AH    CCWREG,SIXTEEN           ADD 16 TO CCW REG               49600013
         ST    CCWREG,8(AREAREG)        PLACE ADDRESS OF 3RD IN 2ND CCW 49700013
         CLI   0(AREAREG),X'02'         IS THIS A READ                  49800013
         BNE   WRITE1                   IF NOT, BRANCH.            000B 49840014
         AH    ICSREG,DECLNGTH          IF THIS IS A READ, ADD     000B 49880014
         SH    ICSREG,DCBBUFL      DECLNGTH AND SUBTRACT DCBBUFL   000B 49920014
         B     READS               TO GET LENGTH OF INPUT AREA     000B 49960014
*                                  MINUS 4.                        000B 50000014
WRITE1   OI    11(AREAREG),X'01'        INVALIDATE ADDR IN 1ST TIC 000B 50040014
READS    SH    ICSREG,6(AREAREG)        SUBTRACT PRESET OFFSET          50100013
         STH   ICSREG,6(AREAREG)        STORE COUNT IN 1ST CCW          50200013
         LA    CCWREG,8(CCWREG)         STEP CCW REG TO 4TH CCW         50300013
*        16    LINES OF CODE DELETED BY APAR ------------>     @ZA11036 50549900
         B     TESTLAST                                                 50559900
         EJECT                                                          50583302
FULL4    DC    F'4'                                                     50600013
K2       DC    F'2'                                              A38557 50650000
OPCODE   DC    X'FF000000'             SAVE THE OP CODE         YA01260 50670002
REQONE   DC    X'01000000'                                              50700013
OFFMSK   DC    X'0000003F'                                              50800013
DIALMASK DC    X'0000007F'                                         000H 50850018
DBREAD   DC    X'02000000381200C0'      READ SKIP MASK           A32459 50920020
DBWRITE  DC    X'0800000028120000'      TIC FOR WRITE COMMAND MASK      51000013
ENABLCCW DC    X'2700000020010001'   14 ENABLE          SLI, L=1        51100013
FFCODE   DC    X'00FF'                                                  51200013
SIXTEEN  DC    H'16'                                                    51300013
EIGHT    DC    H'8'                                                     51330017
CONNECT  EQU   X'DD'                                               000L 51338019
DISCON   EQU   X'01'                                               000L 51342019
RDCON    EQU   X'11'                    READ CONNECT               000L 51346019
WCON     EQU   X'1C'                    WRITE CONNECT              000L 51350019
RCONTONE EQU   X'1E'                                               000L 51354019
WRRESET  EQU   X'0A'                    WRITE RESET              A32466 51358020
WRRSTMON EQU   X'0B'               WRITE RESET MONITOR           S99245 51360002
ENABLE   EQU   X'27'                    ENABLE COMMAND             000J 51363018
DIAL     EQU   X'29'                    DIAL COMMAND               000J 51366018
WINIT    EQU   X'02'               WRITE INITIAL                YA01029 51367002
ONE      EQU   X'01'                    THE CONSTANT 1             000J 51369018
TWO      EQU   X'02'                    THE CONSTANT TWO           000J 51372018
FORTY    EQU   X'40'                    DECIMAL 64                 000J 51375018
FORTY4   EQU   X'44'                    DECIMAL 68                 000J 51378018
TP0B     EQU   X'0B'                    TP OP CODE 0B              000J 51381018
TP0C     EQU   X'0C'                    TP OP CODE 0C              000J 51384018
TP08     EQU   X'08'                    TP OP CODE 08              000J 51384200
X00      EQU   X'00'                                           @ZA10035 51384400
X01      EQU   X'01'                                           @ZA10035 51384600
X06      EQU   X'06'                                           @ZA11032 51384800
X07      EQU   X'07'                                           @ZA11032 51385000
X10      EQU   X'10'                                           @ZA11032 51385200
X13      EQU   X'13'                                           @ZA11032 51385400
X20      EQU   X'20'                                           @ZA10035 51385600
X90      EQU   X'90'                                           @ZA10032 51385800
XF0      EQU   X'F0'                                           @ZA10032 51386000
OHH      EQU   X'00'               NULL BYTE                    YA01029 51388002
MXTYPE   EQU   X'07'               2740 WITH DIAL AND RC        YA01029 51389002
UCB3DISP EQU   X'10'               GRAPHICS DEVICE CLASS      LD YM7701 51390900
UCBTBYT3 EQU   18                  DISPL. OF DEV. CLASS FIELD LD YM7701 51391300
X24      EQU   X'24'                                          LD YM7701 51391700
XFF      EQU   X'FF'                                        LD @ZA02302 51391803
LENG20   DC    H'20'                                                    51391902
DISP0    EQU   0                   DISPLACEMENT OF 0                    51392200
DISP1    EQU   1                   DISPLACEMENT OF 1             Y02947 51392502
DISP2    EQU   2                   DISPLACEMENT OF 2             Y02947 51392902
DISP3    EQU   3                   DISPLACEMENT OF 3            YA02128 51393002
DISP4    EQU   4                   DISPLACEMENT OF 4        LD @ZA02302 51393103
SIX      EQU   6                                               @ZA04152 51393203
C7       EQU   7                                               @ZA04152 51393603
C17      EQU   17                                              @ZA04152 51396203
LEN3     EQU   3                   LENGTH OF 3                   Y02947 51398802
         CNOP  0,8                                                      51400013
         EJECT                                                          51500013
         IECTDECB                                                       51600013
         EJECT                                                          51700013
         IECTIOBX                                                       51800013
         EJECT                                                          51802002
         IECTDEBX                                                       51810002
*                                                                  000A 51900013
*                                                                  000A 52000013
*                             TEMP WORK AREA                       000A 52100013
INDEX    EQU   IOBERINF                                            000D 52200016
AE       EQU   INDEX+1                                             000A 52300013
OFFSET   EQU   INDEX+2                                             000A 52400013
         EJECT                                                          52500013
         DCBD  DSORG=BX,DEVD=(BS,WT)                               000G 52600017
         EJECT                                                          52650002
         IKJTCB DSECT=YES,LIST=YES                                      52660002
         END                                                            52700013
