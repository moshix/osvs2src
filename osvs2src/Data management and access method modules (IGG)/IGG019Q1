19Q1     TITLE 'IGG019Q1 - LOCAL RECEIVE SCHEDULER'                     00200000
IGG019Q1 CSECT                                                          00800020
         SPACE 3                                                        00800122
*********************************************************************** 00804100
*                                                              @Y17XAIL 00808100
* MODULE NAME = IGG019Q1 (TCAM,I/O)                            @Y17XAIL 00812100
*                                                              @Y17XAIL 00816100
* DESCRIPTIVE NAME = LOCAL RECEIVE SCHEDULER                   @Y17XAIL 00820100
*                                                              @Y17XAIL 00824100
* COPYRIGHT = NONE                                             @Y17XAIL 00828100
*                                                              @Y17XAIL 00832100
* STATUS = VERSION 10.0                                        @Y17XAIL 00836100
*                                                              @Y17XAIL 00840100
* FUNCTION = TO SCHEDULE A RECEIVE OPERATION WHEN THE          @Y17XAIL 00844100
* ATTENTION ELEMENT IS POSTED AND TO SET THE LINE 'FREE'       @Y17XAIL 00848100
* AFTER A RECEIVE OPERATION.                                   @Y17XAIL 00852100
*                                                              @Y17XAIL 00856100
*                                                              @Y17XAIL 00860100
* FOR 3705, RECEIVE OPERATIONS ARE SCHEDULED AFTER             @Y17XAIL 00864100
* ATTENTION OR UPON READ REQUEST. THE CHANNEL PROGRAM TO       @Y17XAIL 00868100
* READ IS BUILT HERE AND STARTIO IS ISSUED (VIA AQCTL) HERE    @Y17XAIL 00872100
* UNLESS OUTPUT                                                @G36XRIB 00874100
* IS ON THE OUTPUT CORE QUEUE, WHICH RESULTS IN BYPASS         @Y17XAIL 00876100
* TO THE WRITE SCHEDULER TO BUILD WRITE CHANNEL                @Y17XAIL 00880100
* PROGRAMS ALSO.                                               @Y17XAIL 00884100
*                                                              @Y17XAIL 00888100
* NOTES = SEE BELOW                                            @Y17XAIL 00892100
*                                                              @Y17XAIL 00896100
*    DEPENDENCIES = NONE                                       @Y17XAIL 00900100
*                                                              @Y17XAIL 00904100
*    RESTRICTIONS = NONE                                       @Y17XAIL 00908100
*                                                              @Y17XAIL 00912100
*    REGISTER CONVENTIONS = SEE REGISTER EQUATES               @Y17XAIL 00916100
*                                                              @Y17XAIL 00920100
*    PATCH LABEL = NONE                                        @Y17XAIL 00924100
*                                                              @Y17XAIL 00928100
* MODULE TYPE = PROCEDURE                                      @Y17XAIL 00932100
*                                                              @Y17XAIL 00936100
*    PROCESSOR = XF ASSEMBLER                                  @Y17XAIL 00940100
*                                                              @Y17XAIL 00944100
*    MODULE SIZE =                                             @Y17XAIL 00948100
*                                                              @Y17XAIL 00952100
*    ATTRIBUTES = ENABLED,PROBLEM PROGRAM MODE,                @Y17XAIL 00956100
*    REUSABLE, REFRESHABLE                                     @Y17XAIL 00960100
*                                                              @Y17XAIL 00964100
* ENTRY POINT = FIRST EXECUTABLE INSTRUCTION                   @Y17XAIL 00968100
*                                                              @Y17XAIL 00972100
*    PURPOSE = SEE FUNCTION                                    @Y17XAIL 00976100
*                                                              @Y17XAIL 00980100
*    LINKAGE = L   R15,AVT2260L                                @Y17XAIL 00984100
*              BR  R15                                         @Y17XAIL 00988100
*                                                              @Y17XAIL 00992100
* INPUT = REGISTERS INPUT                                      @Y17XAIL 00996100
*    REGISTER 1  = ADDRESS OF ATTENTION ELEMENT, LCB,          @Y17XAIL 01000100
*                  OR ERB                                      @Y17XAIL 01004100
*    REGISTER 11 = DISPATCHER BASE                             @Y17XAIL 01008100
*    REGISTER 13 = ADDRESS OF AVTSAVE2                         @Y17XAIL 01012100
*    REGISTER 15 = ENTRY POINT ADDRESS                         @Y17XAIL 01016100
*                                                              @Y17XAIL 01020100
* OUTPUT = REGISTER OUPUT                                      @Y17XAIL 01024100
*    REGISTER 1  = ADDRESS OF ELEMENT TO POST                  @Y17XAIL 01028100
*    REGISTER 11 = DISPATCHER BASE                             @Y17XAIL 01032100
*    REGISTER 13 = ADDRESS OF AVTSAVE2                         @Y17XAIL 01036100
*                                                              @Y17XAIL 01040100
* EXIT-NORMAL = TCAM DISPATCHER                                @Y17XAIL 01044100
*                                                              @Y17XAIL 01048100
* EXIT-ERROR = NONE                                            @Y17XAIL 01052100
*                                                              @Y17XAIL 01056100
* EXTERNAL REFERENCES = SEE BELOW                              @Y17XAIL 01060100
*                                                              @Y17XAIL 01064100
*    ROUTINES = IEDAYZ (TSO SCHEDULER)                         @Y17XAIL 01068100
*               IEDQTNT                                        @Y17XAIL 01072100
*                                                              @Y17XAIL 01076100
*    DATA AREAS = LCB CHANNEL PROGRAM AREA                     @Y17XAIL 01080100
*                 INVITATION LIST                              @Y17XAIL 01084100
*                                                              @Y17XAIL 01088100
*    CONTROL BLOCKS = AVT                                      @Y17XAIL 01092100
*                     DCB                                      @Y17XAIL 01096100
*                     LCB                                      @Y17XAIL 01100100
*                     QCB                                      @Y17XAIL 01104100
*                     SCB                                      @Y17XAIL 01108100
*                     STCB                                     @Y17XAIL 01112100
*                     TRM                                      @Y17XAIL 01116100
*                     TSID                                     @Y17XAIL 01120100
*                                                              @Y17XAIL 01124100
* TABLES = NONE                                                @Y17XAIL 01128100
*                                                              @Y17XAIL 01132100
* MACROS = EXCPVR                                              @Y17XAIL 01136100
*          GETMAIN                                             @Y17XAIL 01140100
*          IEDHJN                                              @Y17XAIL 01144100
*                                                              @Y17XAIL 01148100
* CHANGE ACTIVITY = SEE BELOW                                  @Y17XAIL 01152100
*A-000000-999999                                               @Y16X5I0 01156100
*A248000,426000,500000,504000,668000,700000,780000               S22025 01260022
*C128000,130000,220000,224000                                    S22025 01260122
*C328000,348000,384000-388000,432000,452000,468000-476000,500000 S22025 01260222
*C532000                                                         S22025 01260322
*D284000,436000-444000,456000460000,464000-467000,508000-524000  S22025 01260422
*C128000,130000,220000,224000                                    S22025 01260522
*C396000                                                        SA54274 01260622
*D577000                                                        SA54274 01260722
*C404000                                                        SA54274 01260822
*A534600                                                        SA56231 01260922
*D426600-472000,501700-502200,A426600-466600                    SA56606 01261022
*A378400,426000,476000,529000,627530,627830,714000               S22024 01261122
*C032000,684000                                                  S22024 01261222
*D736000,744000,752000,760000,784000,792000,800000,808000        S22024 01261322
*A380000                                                        SA62315 01261422
*C500100-500200                                                 SA69626 01261500
*A504860                                                         Y06327 01361405
*D384000,385000                                                @XA05314 01361556
*A384000                                                       @XA05314 01361656
*C384300                                                       @XA07484 01361757
*A378800                                                       @ZA02641 01361858
*A535000                                                       @SA73490 01361958
*D588000-600000,616000-620000                                  @SA73490 01362058
*C426220                                                       @YA08428 01362158
*D535020-535180,A584000,A612000                                @SA75437 01362258
*A216000,280000,292000,300000,332000,368000,378000,398000      @Y17XAIL 01372200
*A416000,726000,740000,781000,796000,812000                    @Y17XAIL 01382200
*C016000-212000,296000,312000,320000,328000,368000,378400      @Y17XAIL 01392200
*C378850-379550,384200,385400,400000-408000,426050             @Y17XAIL 01402200
*C426150-426500,480000,500900,534600,670950                    @Y17XAIL 01412200
*D220000-228000,250000,264000,304000,477000-478000,            @Y17XAIL 01422200
*D504860-504920,506660-506720,528000-530000,698000,702000      @Y17XAIL 01432200
*D726000,732000                                                @Y17XAIL 01442200
*C506600                                                       @OY14092 01447200
*A272000,422840,680000                                         @G36XRIB 01448200
*C008721                                                       @G36XRIB 01449200
*D422900,776000-778000                                         @G36XRIB 01450200
*A552000,A564000,A568000                                       @OY20448 01450386
*                                                              @Y17XAIL 01452200
*********************************************************************** 01462200
         EJECT                                                          21600020
************************************************************** @Y17XAIL 21680000
*                                                            * @Y17XAIL 21760000
*        USINGS AND REGISTER EQUATES                         * @Y17XAIL 21840000
*                                                            * @Y17XAIL 21920000
************************************************************** @Y17XAIL 22000000
         SPACE 1                                                        23200020
         USING IEDQRECB,RRECB           RECB ADDRESSIBILITY    @YM08074 23300000
         USING IEDQSTCB,RSTCB                                           23600020
         USING IEDQLCB,RLCB                                             23700000
         USING IEDQPRF,RWORK            BUFFER ADDRESSABILITY  @Y17XAIL 23800000
         USING IEDQQCB,RQCB                                             24400020
         USING IEDNTRM,RTRM             TTE ADDRESSABILITY     @Y17XAIL 24600000
         USING IHADCB,RDCB                                              24800020
         USING IEDQDISP,RSUPBASE                                        25200020
         USING AVTSAVE2,R13                                             25600020
         SPACE 2                                                        26000020
R0       EQU   0                        REG 0                    S22024 27200022
R1       EQU   1                                               @G36XRIB 27400000
RRECB    EQU   1                        ELEMENT BASE                    27600020
RA       EQU   2                        WORK REGISTER                   28000020
RSTCB    EQU   3                        STCB BASE              @Y17XAIL 28400000
RLCB     EQU   4                        LCB BASE                        29200020
RWORK    EQU   6                        TEMPORARY WORK REG     @Y17XAIL 29400000
RQCB     EQU   7                        ENTRY QCB ADDRESS (LCB)         30000020
RTRM     EQU   8                        TERM ENTRY BASE        @Y17XAIL 30100000
RCURRENT EQU   8                        CURRENT INVITATION     @Y17XAIL 30200000
*                                       LIST ENTRY             @Y17XAIL 30300000
RILIST   EQU   9                        INVITATION LIST ADDRESS         30800020
RDCB     EQU   10                       DCB ADDR               @Y17XAIL 31000000
RSUPBASE EQU   11                       DISPATCHER BASE REGISTER        31600020
R12      EQU   12                       WORK REGISTER          @Y17XAIL 31800000
R13      EQU   13                       SAVE AREA ADDRESS (AVTSAVE2     32400020
RRET     EQU   14                       RETURN   REGISTER      @Y17XAIL 32800000
R15      EQU   15                       ENTRY BASE REGISTER             33200020
         EJECT                                                          33600020
************************************************************** @Y17XAIL 33630000
*                                                            * @Y17XAIL 33660000
*        ESTABLISH ADDRESSABILITY AND CHECK FOR ATTENTION    * @Y17XAIL 33690000
*        ELEMENT AS INPUT.                                   * @Y17XAIL 33720000
*                                                            * @Y17XAIL 33750000
************************************************************** @Y17XAIL 33780000
         SPACE 1                                               @Y17XAIL 33810000
         DC    AL1(DSPMCPL2)            ACTIVATION KEY OF STCB @Y17XAIL 33840000
         DC    AL1(0)                   ENTRY PT FOLLOWS STCB  @Y17XAIL 33870000
         USING *,R15                    BASE FOR IGG019Q1      @Y17XAIL 33900000
IGG019Q1 IEDHJN START                                            S22025 34000022
         LA    RLCB,AVTEZERO(,RRECB)    GET LCB FOR BASE                35600020
         CLI   RECBPRI,PRIATTN          ATTENTION ELEMENT               36400000
         BE    ATTN                     BR YES, HANDLE ATTN    @YM08074 36410000
         CLI   RECBPRI,PRIATN05         3705 ATTENTION ELEM    @YM08074 36420000
         BNE   NOTATTN                  NO, BRANCH             @Y17XAIL 36440000
         EJECT                                                 @Y17XAIL 36480000
************************************************************** @Y17XAIL 36520000
*                                                            * @Y17XAIL 36560000
*        PROCESSING FOR INPUT = ATTENTION ELEMENT            * @Y17XAIL 36600000
*                                                            * @Y17XAIL 36640000
************************************************************** @Y17XAIL 36680000
         SPACE 1                                               @Y17XAIL 36720000
         SH    RLCB,LCBBKUP5            GET 3705 LCB ADDRESS   @YM08074 36820000
         LA    RRECB,LCBATL05           3705 ATTENTION ELEMENT @YM08074 36920000
         B     GETDCB                   BR TO GET DCB          @YM08074 37020000
ATTN     EQU   *                                               @YM08074 37120000
         SH    RLCB,LCBBKUP             BACK UP TO LCB                  37600020
         LA    RRECB,LCBATTEL           LOCAL ATTENTION ELE    @YM08074 37660000
GETDCB   EQU   *                                               @YM08074 37720000
         L     RDCB,LCBDCBPT            GET DCB ADDRESS             TSO 37800020
         MVI   RECBPRI,AVTEZERO         CLR ATTN ELEMENT PRI   @YM08074 37801000
         TM    DCBDSRG2,DCBDSGTR        IS THE DCB FOR 3705 ?  @Y17XAIL 37802000
         BNO   FREEATN                  BRANCH ON NO             S22024 37803000
         LR    RTRM,R15                 SAVE BASE ADDRESS      @Y17XAIL 37804000
         LH    RRECB,LCBTTCIN           GET TNT OFFSET         @Y17XAIL 37805000
         N     RRECB,AVTCLRHI           CLEAR HI ORDER BYTES   @Y17XAIL 37806000
         L     R15,AVTRNMPT             GET ADDR OF TNT LOOKUP @Y17XAIL 37807000
*                                       CODE                   @Y17XAIL 37808000
         BALR  RRET,R15                 CALL TNT LOOKUP        @Y17XAIL 37809000
         LR    R15,RTRM                 RESTORE BASE ADDRESS   @Y17XAIL 37810000
         LR    RTRM,RRECB               SET TERM ENTRY ADDR    @Y17XAIL 37811000
         SH    RTRM,PRFSZ               BACK UP TO TERM ENTRY  @Y17XAIL 37812000
*                                       PREFIX                 @Y17XAIL 37813000
         TM    TRMBYTE2,TRMRSACT+TRMINPG IS NCP ACTIVE OR IS   @Y17XAIL 37814000
*                                       ACTPU IN PROGRESS      @Y17XAIL 37815000
         BNZ   FREEATN                  YES, BRANCH            @Y17XAIL 37816000
         L     RA,LCBRECOF              GET WORD THAT CONTAINS @Y17XAIL 37817000
*                                       THE ATTENTION FLAG     @Y17XAIL 37818000
TRYAGN1  EQU   *                                               @Y17XAIL 37818500
         LR    RRET,RA                  GET COPY OF WORD       @Y17XAIL 37819000
         N     RRET,RESATTN             RESET ATTENTION FLAG   @Y17XAIL 37821000
         CS    RA,RRET,LCBRECOF         WAS WORD UPDATED       @Y17XAIL 37822000
*                                       ASYNCHRONOUSLY         @Y17XAIL 37823000
         BNE   TRYAGN1                  YES, TRY AGAIN         @Y17XAIL 37824000
         B     DSPDISP                  EXIT                   @ZA02641 37825000
         EJECT                                                 @Y17XAIL 37826000
FREEATN  EQU   *                                                 S22024 37960022
         NI    LCBTSTSW,XF0             FREE UP ATTEN ELEMENT           38000020
         TM    LCBSTAT1,LCBFREEN        LCB FREE ?             @XA05314 38400056
         BO    POSTAWAY                 BRANCH YES             @XA05314 38410056
         TM    DCBDSRG2,DCBDSGTR        3705 DCB?              @Y17XAIL 38415000
         BO    DSPDISP                  BRANCH YES             @XA07484 38430057
         MVI   LCBTSTSW,X'00'           CLR SW FOR DEFERRED    @XA05314 38440056
         B     DSPDISP                  READ                   @XA05314 38450056
POSTAWAY EQU   *                                               @XA05314 38460056
         SPACE                                                          38520022
         TM    DCBDSRG2,DCBDSGTR        IS THE DCB FOR 3705 ?  @Y17XAIL 38530000
         BO    POST1                    YES, GO POST LCB         S22024 38560000
         SPACE 2                                                        38600022
         TM    AVTBIT1,AVTTSON          IS TSO IN SYSTEM            TSO 38850020
         BO    TSO3                     BRANCH ON YES               TSO 38900020
         SPACE                                                          39200020
         NI    LCBTSTSW,X'0F'           RESET FLAG, LEAVING     SA54274 39700022
*                                         POSTED FLAG UNTOUCHED SA54274 39800022
POST1    EQU   *                                               @Y17XAIL 39810000
         L     RA,LCBRECOF              GET WORD THAT CONTAINS @Y17XAIL 39820000
*                                       'RECEIVING' AND 'FREE' @Y17XAIL 39830000
*                                       FLAGS                  @Y17XAIL 39840000
TRYAGN2  EQU   *                                               @Y17XAIL 39845000
         LR    RRET,RA                  GET COPY OF THE WORD   @Y17XAIL 39850000
         O     RRET,SETRECVN            SET RECEIVING ON       @Y17XAIL 39870000
         N     RRET,RESFREE             RESET FREE             @Y17XAIL 39880000
         CS    RA,RRET,LCBRECOF         WAS WORD UPDATED       @Y17XAIL 39890000
*                                       ASYNCHRONOUSLY         @Y17XAIL 39900000
         BNE   TRYAGN2                  YES, TRY AGAIN         @Y17XAIL 39910000
         ST    RLCB,LCBQCBA-1           QCB FOR POST                    40000020
         MVI   LCBPRI,PRILNFRE          SET PRIORITY           @Y17XAIL 40200000
         LR    RRECB,RLCB               DISPATCH PARAMETER              41200020
         BAL   RRET,DSPPOST             POST LCB TO ITSELF     @Y17XAIX 41600000
         EJECT                                                 @Y17XAIL 41606000
************************************************************** @Y17XAIL 41612000
*                                                            * @Y17XAIL 41618000
*        CHECK FOR LCB OR ERB AS INPUT                       * @Y17XAIL 41624000
*                                                            * @Y17XAIL 41630000
************************************************************** @Y17XAIL 41636000
         SPACE 1                                               @Y17XAIL 41642000
NOTATTN  EQU   *                                               @Y17XAIL 41648000
         CLI   RECBPRI-IEDQRECB(RLCB),PRIACTIV ERB INPUT       @Y17XAIL 41654000
         BE    ERB                      YES, BRANCH            @Y17XAIL 41660000
         SPACE 3                                               @Y17XAIL 41666000
************************************************************** @Y17XAIL 41672000
*                                                            * @Y17XAIL 41678000
*        PROCESSING FOR INPUT = LCB                          * @Y17XAIL 41684000
*                                                            * @Y17XAIL 41690000
************************************************************** @Y17XAIL 41696000
         SPACE 1                                               @Y17XAIL 41702000
         L     RDCB,LCBDCBPT            GET DCB ADDRESS                 41708000
         TM    DCBDSRG2,DCBDSGTR        IS THE DCB FOR 3705    @Y17XAIL 41714000
         BNO   NO3705                   BRANCH ON NO             S22024 41720000
         B     CHKCQ                    GO CHECK QUEUE         @Y17XAIL 41726000
         EJECT                                                 @Y17XAIL 41732000
************************************************************** @Y17XAIL 41738000
*                                                            * @Y17XAIL 41744000
*        PROCESSING FOR INPUT = ERB                          * @Y17XAIL 41750000
*                                                            * @Y17XAIL 41756000
************************************************************** @Y17XAIL 41762000
         SPACE 1                                               @Y17XAIL 41768000
ERB      EQU   *                                               @Y17XAIL 41774000
         SH    RLCB,OFFERB              GET ADDR OF LCB        @Y17XAIL 41780000
         L     RWORK,LCBERBCH-1         GET 1ST UNIT ADDR      @Y17XAIL 41786000
         SLR   RILIST,RILIST            CLEAR FOR INSERT       @Y17XAIL 41792000
         IC    RILIST,PRFNBUNT          GET NO. OF UNITS       @Y17XAIL 41798000
         LA    RWORK,LCBERBCH-(PRFTIC+1-IEDQPRF) MAKE LCBERBCH @Y17XAIL 41804000
*                                       APPEAR AS DUMMY FIRST  @Y17XAIL 41810000
*                                       UNIT                   @Y17XAIL 41816000
BUILDUNT EQU   *                                               @Y17XAIL 41822000
         L     RWORK,PRFTIC             GET NEXT UNIT          @Y17XAIL 41828000
         LA    RRET,PRFSUNIT            CCW DATA ADDRESS       @Y17XAIL 41834000
         ST    RRET,PRFIOADR-1          SET DATA ADDRESS       @Y17XAIL 41840000
         MVI   PRFOPCDE,CCWREAD         SET READ COMMAND CODE  @Y17XAIL 41846000
         MVI   PRFFLAGS,CCWCC+CCWSLI    INDICATE CMD CHAINING  @Y17XAIL 41852000
*                                       AND SUPPRESS INCORRECT @Y17XAIL 41858000
*                                       LENGTH                 @Y17XAIL 41864000
         MVI   PRFFLAGS+1,AVTEZERO      CLEAR RESERVED FIELD   @Y17XAIL 41870000
         MVC   PRFCOUNT,AVTKEYLE        SET COUNT              @Y17XAIL 41876000
         MVI   PRFTICC,CCWTIC           SET TIC IN NEXT CCW    @Y17XAIL 41882000
         BCT   RILIST,BUILDUNT          CONTINUE IF MORE UNITS @Y17XAIL 41888000
         MVC   PRFTIC+1(3),LCBRDBFR     LINK LAST UNIT IN NEW  @Y17XAIL 41894000
*                                       CHAIN TO FIRST UNIT ON @Y17XAIL 41900000
*                                       READ CHAIN             @Y17XAIL 41906000
         MVC   LCBRDBFR,LCBERBCH        UPDATE POINTER TO      @YM03700 41908000
*                                       FIRST READ BUFFER      @YM03700 41910000
         XC    LCBERBCH,LCBERBCH        CLEAR ERB CHAIN        @Y17XAIL 41912000
         MVI   LCBRBCT2,AVTEZERO        CLEAR REQUEST COUNT    @YM03745 41915000
         L     RDCB,LCBDCBPT            GET DCB ADDRESS        @Y17XAIL 41918000
         L     RA,LCBRECOF              GET WORD THAT CONTAINS @Y17XAIL 41924000
*                                       THE BUFFER AVAILABLE   @Y17XAIL 41930000
*                                       FLAG                   @Y17XAIL 41936000
TRYAGN3  EQU   *                                               @Y17XAIL 41939000
         LR    RRET,RA                  GET COPY OF THE WORD   @Y17XAIL 41942000
         O     RRET,SETBFRAV            SET BFRS AVAILABLE     @Y17XAIL 41954000
         CS    RA,RRET,LCBRECOF         WAS WORD UPDATED       @Y17XAIL 41960000
*                                       ASYNCHRONOUSLY         @Y17XAIL 41966000
         BNE   TRYAGN3                  YES, TRY AGAIN         @Y17XAIL 41972000
         EJECT                                                 @Y17XAIL 41978000
CHKCQ    EQU   *                                               @Y17XAIL 41984000
         LR    RTRM,R15                 SAVE BASE REGISTER     @Y17XAIL 42008000
         LH    RRECB,LCBTTCIN           GET 3705 TNT OFFSET    @Y17XAIL 42014000
         N     RRECB,AVTCLRHI           CLEAR HI ORDER 2 BYTES @Y17XAIL 42020000
         L     R15,AVTRNMPT             GET ADDR OF TNT LOOKUP @Y17XAIL 42026000
*                                       CODE                   @Y17XAIL 42032000
         BALR  RRET,R15                 CALL TNT LOOKUP        @Y17XAIL 42038000
         LR    R15,RTRM                 RESTORE BASE ADDRESS   @Y17XAIL 42044000
         LR    RTRM,RRECB               GET TERM ENTRY ADDR    @Y17XAIL 42050000
         SH    RTRM,PRFSZ               BACK UP TO TERM ENTRY  @Y17XAIL 42056000
*                                       PREFIX                 @Y17XAIL 42062000
         SPACE 1                                               @YM02908 42062800
         TM    TRMNCP,TRMIPLDM          IPL/DUMP IN PROGRESS   @YM02908 42063600
         BO    DSPDISP                  BR YES, DON'T COMPETE  @YM02908 42064400
         SPACE 1                                               @YM02908 42065200
         CLC   LCBCQELE,AVTDELAD        IS CORE QUEUE EMPTY    @Y17XAIL 42066000
         BE    CHKBFRS                  YES, BRANCH            @Y17XAIL 42066800
         SPACE 1                                               @Y17XAIL 42068000
         TM    TRMNCP,TRMSLOWN          IS 3705 IN SLOWDOWN    @Y17XAIL 42074000
         BNO   NEXTSTCB                 NO, BYPASS TO IGG019TE @YM02908 42080000
         EJECT                                                 @Y17XAIL 42134000
CHKBFRS  EQU   *                                               @Y17XAIL 42140000
         TM    LCBSTAT2,LCBBFRAV        ARE BUFFERS AVAILABLE  @Y17XAIL 42146000
         BZ    DSPDISP                  NO, EXIT TO DISPATCHER @Y17XAIL 42152000
         SPACE 1                                               @Y17XAIL 42158000
         TM    LCBSTAT2,LCBATTN         ATTENTION RECEIVED     @Y17XAIL 42164000
         BO    CHKTSTSW                 YES, GO CHECK LCB      @YM02909 42170000
         SPACE 1                                               @YM02909 42170500
         TS    LCBTSTSW                 LCB AVAILABLE          @YM02909 42171000
         BNZ   DSPDISP                  NO, EXIT               @YM02909 42171500
         SPACE 1                                               @YM02909 42172000
         L     RA,LCBRECOF              GET WORD CONTAINING    @YM02909 42172500
*                                       LCBSTATE               @YM02909 42173000
TRYAGN4  EQU   *                                               @YM02909 42173200
         LR    RRET,RA                  COPY STATE VALUE       @YM02909 42173500
         O     RRET,SETFREE             INDICATE LCB FREE      @YM02909 42174500
         N     RRET,RESRECVN                                   @YM02909 42175000
         CS    RA,RRET,LCBRECOF         WAS LCBSTATE UPDATED   @YM02909 42176000
*                                       ASYNCHRONOUSLY         @YM02909 42176700
         BNE   TRYAGN4                  NO, TRY AGAIN          @YM02909 42177400
         SPACE 1                                               @YM02909 42178100
         MVI   LCBTSTSW,AVTEZERO        MAKE LCB AVAILABLE     @YM02909 42178800
         B     DSPDISP                  AND EXIT               @YM02909 42179500
         SPACE 1                                               @Y17XAIL 42180200
CHKTSTSW EQU   *                                               @YM02909 42180900
         TS    LCBTSTSW                 IS LCB AVAILABLE FOR   @Y17XAIL 42182000
*                                       I/O                    @Y17XAIL 42188000
         BNZ   DSPDISP                  NO, EXIT TO DISPATCHER @Y17XAIL 42194000
         L     RA,LCBRECOF              GET WORD THAT CONTAINS @Y17XAIL 42200000
*                                       BUFFER AVAILABLE       @Y17XAIL 42206000
*                                       FLAG                   @Y17XAIL 42212000
TRYAGN5  EQU   *                                               @Y17XAIL 42215000
         LR    RRET,RA                  GET COPY OF THE WORD   @Y17XAIL 42218000
         O     RRET,SETRECVN            INDICATE RECEIVING     @Y17XAIL 42230000
         N     RRET,RESBFRAV            RESET BUFFER AVAILABLE @Y17XAIL 42236000
*                                       AND LINE FREE          @Y17XAIL 42242000
         CS    RA,RRET,LCBRECOF         WAS WORD UPDATED       @Y17XAIL 42248000
*                                       ASYNCHRONOUSLY         @Y17XAIL 42254000
         BNE   TRYAGN5                  YES, TRY AGAIN         @Y17XAIL 42260000
         SPACE 1                                               @Y17XAIL 42266000
         LA    RA,LCBCCW3                                      @Y17XAIL 42272000
         STCM  RA,AD,LCBSTART                                  @Y17XAIL 42278000
         MVC   LCBCCW4+1(3),LCBRDBFR                           @Y17XAIL 42284000
         MVI   LCBSIO,SIOCODE           CODE FOR STARTIO ENTRY INTO     42284600
*                                       QEB                    @G36XRIB 42285200
         ST    RA,LCBCP                 ADDR OF START OF CHANNEL PROG   42285800
*                                                              @G36XRIB 42286400
         LA    R1,LCBQEBPL              ADDR OF PARM LIST IN R1 FOR     42287000
*                                       QEB                    @G36XRIB 42287600
*        ISSUE SVC TO DO STARTIO                               @G36XRIB 42288200
         AQCTL                                                 @G36XRIB 42288800
         B     DSPDISP                  EXIT TO DISPATCHER     @Y17XAIL 42296000
         EJECT                                                 @Y17XAIL 42302000
NO3705   EQU   *                                                 S22024 42655022
         TM    AVTBIT1,AVTCLOSN         CLOSEDOWN IN PROGRESS   SA56606 42660022
         BO    NEXTSTCB                 YES-EXIT NEXT STCB      SA56606 43160022
         TM    LCBSTAT1,LCBOCNI         STOPLINE IN PROGRESS    SA56606 43660022
         BZ    BYPASS                   NO-CONTINUE             SA56606 44160022
NEXTSTCB EQU   *                                                SA56606 44660022
         L     RSTCB,LCBRSLNK-1         GET NEXT STCB ADDR      SA56606 45160022
         LR    RRECB,RLCB               ELEMENT ADDR            SA56606 45660022
         LR    RQCB,RLCB                QCB ADDR                SA56606 46160022
         B     DSPBYPAS                 EXIT NEXT STCB          SA56606 46660022
BYPASS   EQU   *                                                 S22025 47600022
         BAL   RRET,ILISTRTN            BRANCH TO ILIST RTN    @Y17XAIL 48000000
         SPACE 2                                                        48800022
         CLI   ACTIVE(RILIST),AVTEZERO ANY ACTIVE ENTRIES               49600020
         BE    FREETEST                 NO, BRANCH               S22025 50000022
         LA    RA,0(,RILIST)            GET INVILIST            SA69626 50010005
         LA    R0,TWO                   SET AN OFFSET VALUE      S22025 50030022
         SR    RA,R0                    LOCATE THE TNT INDEX     S22025 50040022
         LH    RRECB,0(RA)              GET THE TNT INDEX        S22025 50050022
         LR    RQCB,R15                 SAVE THE BASE REGISTER   S22025 50060022
         L     R15,AVTRNMPT             GET THE ADDRESS OF THE   S22025 50070022
*                                         IEDQTNT ROUTINE        S22025 50080022
         BALR  RRET,R15                 BRANCH TO IT           @Y17XAIL 50090000
         SPACE 2                                                 S22025 50100022
         LR    R15,RQCB                 RESTORE BASE REGISTER    S22025 50110022
         L     RQCB,TRMDESTQ-1-IEDQTRM(,RRECB)   GET THE         S22025 50120022
*                                         DESTINATION QCB ADDR   S22025 50130022
         LR    RRECB,RLCB               RESTORE THE LCB ADDRESS  S22025 50132022
*                                         FOR A POSSIBLE POST    S22025 50134022
         TM    QCBSTAT,QCBSEND          ARE WE CURRENTLY SENDING S22025 50140022
*                                         TO THIS STATION        S22025 50150022
         BO    NOACTIV                  YES, BRANCH              S22025 50160022
TSOTEST  EQU   *                                                 S22025 50420022
         TM    AVTBIT1,AVTTSON          IS TSO IN THE SYSTEM     S22025 50440022
         BZ    FREETEST                 NO, BRANCH               S22025 50460022
TSO3     EQU   *                                                 S22025 50480022
         L     RWORK,AVTTSOPT           GET THE TSO POINTER      S22025 50500022
         L     RWORK,TSISCHED-IEDQTSI(,RWORK)    GET THE ADDRESS S22025 50520022
*                                         OF THE TIME SHARING    S22025 50540022
*                                         SCHEDULER              S22025 50560022
         BAL   RSTCB,THREETWO(,RWORK)   LINK TO IT               S22025 50580022
         SPACE 2                                                 S22025 50600022
FREETEST EQU   *                                                 S22025 50620022
         LR    RRECB,RLCB               RESTORE THE ELEMENT ADDR S22025 50640022
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN SAVE THE STOPLINE BITS@OY14092 50660000
         OI    LCBSTAT1,LCBFREEN        ASSUME THE LCB IS TO BE  S22025 50680022
*                                         FREED                  S22025 50700022
         CLI   LCBTSTSW,XF0             IS THE LCB TO BE FREED   S22025 50720022
         BE    DSPDISP                  YES, BRANCH              S22025 50740022
         TM    DCBDSRG2,DCBDSGTR        IS THE DCB FOR 3705    @Y17XAIL 51740000
         BO    TSO1                     BRANCH ON YES            S22024 53000022
         XI    LCBSTAT1,LCBRECVN+LCBFREEN    JIGGLE THE FREE AND S22025 53200022
*                                         RECEIVE BITS           S22025 53400022
         BAL   RRET,ILISTRTN            BRANCH TO ILIST RTN    @Y17XAIL 53460000
         CLI   ACTIVE(RILIST),AVTEZERO  ANY ACTIVE ENTRIES      SA56231 53480022
         BE    NOACTIV                  NO, BRANCH              SA56231 53500022
         SPACE 2                                               @SA73490 53501058
         SPACE 2                                                        53520022
         TM    AVTBIT3,AVTRECVN+AVTRFULN IS RECEIVE OPERATION           53600020
*                                        POSSIBLE                       54000020
         BZ    GOTUNIT                  BRANCH IF YES                   54400020
DELAY    EQU   *                                                        55200020
         TM    LCBINSRC+TWO,X'02'       POSTED TO TIME DELAY?  @OY20448 55250086
         BO    DSPDISP                  BRIF YES- NO POST      @OY20448 55300086
         OI    LCBINSRC+TWO,X'02'       INDICATE POSTED        @OY20448 55350086
         LA    RWORK,1                  SET FOR 1 SECOND DELAY          55600020
         STH   RWORK,LCBEOLTD           TIME DELAY PARAMETER            56000020
         MVI   LCBTDL,LCBINSRC-1-IEDQLCB  SET TIME QUEUE PARAMETER      56400020
         L     RWORK,LCBSTCBA-1         STCB ADDRESS           @OY20448 56450086
         CLI   0(RWORK),X'1E'           IS THIS LAST SCHEDULER @OY20448 56500086
         BNE   ITSSCHED                 BRIF NO                @OY20448 56550086
         MVC   LCBSTCBA,LCBRSLNK        GIVE CONTROL TO QEVENT          56800020
ITSSCHED EQU   *                                               @OY20448 56850086
         LA    RWORK,AVTDELYB           TIME DELAY QUEUE                57200020
         ST    RWORK,LCBQCBA-1          FOR POST                        57600020
         MVI   LCBSTAT1,LCBRECVN        SET LCB NOT FREE        SA52509 57800022
         BAL   RRET,DSPPOST             POST LCB TO TIME QUEUE @Y17XAIX 58000000
GOTUNIT  EQU   *                                                        58400020
         IC    RWORK,ILSTSIZE(0,RILIST) GET LIST ENTRY SIZE    @SA75437 58800058
         BCTR  RWORK,R0           SUBTRACT ONE TO REACH INDEX B@SA75437 59200058
         LA    RCURRENT,ILSTPRF(0,RILIST) GET ADDR OF FIRST ENT@SA75437 59600058
         IC    RWORK,0(RCURRENT,RWORK) GET INDEX BYTE          @SA75437 60000058
         IC    R0,LCBINVPT-1                                            60400020
         ST    RCURRENT,LCBINVPT-1 SET AS CURRENT ENTRY                 60800020
         STC   R0,LCBINVPT-1                                            61200020
         AR    RWORK,RWORK        DOUBLE FOR NEGATIVE INDEX    @SA75437 61600058
         SR    RILIST,RWORK             GET ERM TABLE INDEX    @SA75437 62000058
         MVC   LCBTTBIN(2),0(RILIST)    SET IN LCB                      62400020
         TM    AVTBIT1,AVTTSON          IS TSO IN SYSTEM            TSO 62450020
         BZ    TSO1                     BRANCH ON NO                TSO 62500020
         L     RWORK,AVTTSOPT           ADDRESS TS SCHED            TSO 62550020
         L     RWORK,TSISCHED-IEDQTSI(,RWORK)                       TSO 62600020
         BAL   RSTCB,0(,RWORK)          LINK TO TS SCHEDULER        TSO 62650020
         NOP   TSO1                     FIRST RETURN POINT          TSO 62700020
TSO1     EQU   *                                                    TSO 62750020
         LA    RA,AVTBFREB              BUFFER REQUEST QUEUE            62800020
         ST    RA,LCBERB                POST ADDRESS                    63200020
         LA    RA,LCBERB                READY FOR POST                  63600020
         MVI   LCBERBPY,PRIINTRQ        INITIAL REQUEST PRIORITY        64000020
         SR    RWORK,RWORK              CLR WORK REGISTER               64400020
         IC    RWORK,DCBBUFIN           INITIAL COUNT                   64800020
         SRL   RWORK,4                  SHIFT FOR HI ORDER BITS         65200020
         STC   RWORK,LCBERBCT           ESTABLISH INIT REQUEST          65600020
         LA    RRECB,LCBERB             ELEMENT FOR POST                66000020
         BAL   RRET,DSPPOST             POST ERB TO GET BUFFRS @Y17XAIX 66400000
NOACTIV  EQU   *                                                 S22025 66850022
         L     RSTCB,LCBRSLNK-1         GET THE NEXT STCB        S22025 66900022
         CLI   STCBPRI,AVTEZERO         IS THIS THE LAST STCB    S22025 66950022
         BE    DSPBYPAS                 YES, BRANCH              S22025 67000022
         B     DELAY                    FORCE A 1 SECOND DELAY   S22025 67050022
ILISTRTN EQU   *                                                 S22025 67060022
         SR    RWORK,RWORK              CLEAR A WORK REGISTER    S22025 67065022
         IC    RWORK,LCBUCBX            GET THE REL. LINE NO.    S22025 67070022
         SLL   RWORK,TWO                MULTIPLY BY FOUR         S22025 67075022
         L     RILIST,DCBINVLI(RWORK)   GET THE INVITATION LIST  S22025 67080022
*                                         ADDRESS FOR THIS LINE  S22025 67085022
         SR    RWORK,RWORK              CLEAR AGAIN              S22025 67090022
         BR    RRET                     RETURN                 @Y17XAIL 67095000
         EJECT                                                          67100022
*        CONSTANTS AND EQUATES                                          67200020
*                                       OTHER EQUATES                   67600020
         SPACE 1                                                        68000020
SIOCODE  EQU   48                 STARTIO ENTRY CODE INTO QEB  @G36XRIB 68800000
ACTIVE   EQU   1                  OFFSET OF NUM OF ACTIVE ENTRIES       69600020
ILSTSIZE EQU   2                  LENGTH OF AN INVITATION LIST ENTRY    70000020
TWO      EQU   2                        TWO                      S22024 70100022
AD       EQU   7                        STCM MASK FOR ADDRESS  @Y17XAIL 70150000
THREETWO EQU   32                       THIRTY2                  S22024 70300022
ILSTPRF  EQU   8                        SIZE OF ILIST COTNROL AREA      70800020
         SPACE 1                                                        71600020
         DS    0H                                              @Y17XAIL 71700000
OFFERB   DC    AL2(LCBERB-IEDQLCB)      OFFSET OF ERB IN LCB   @Y17XAIL 71800000
LCBBKUP  DC    AL2(LCBATTEL-IEDQLCB)    OFFSET IN LCB TO ATTN ELEMENT   72000020
LCBBKUP5 DC    AL2(LCBATL05-IEDQLCB)    OFFSET IN LCB TO 3705  @YM08074 72100000
*                                       ATTENTION ELEMENT      @YM08074 72200000
XF0      EQU   X'F0'                    MASK TO FREE ATTEN ELE          72400020
         SPACE 1                                               @Y17XAIL 72404000
         DS    0H                                              @Y17XAIL 72408000
PRFSZ    DC    AL2(TRMPRFSZ)            TERM ENTRY PREFIX SIZE @Y17XAIL 72412000
         EJECT                                                 @Y17XAIL 72416000
************************************************************** @Y17XAIL 72420000
*                                                            * @Y17XAIL 72424000
*        COMPARE AND SWAP WORDS                              * @Y17XAIL 72428000
*                                                            * @Y17XAIL 72432000
************************************************************** @Y17XAIL 72436000
         SPACE 1                                               @Y17XAIL 72440000
*        WORD FOR RESETTING LCBATTN IN WORD LCBRECOF           @Y17XAIL 72444000
RESATTN  DS    0F                                              @Y17XAIL 72448000
         DC    AL1(255)                                        @Y17XAIL 72452000
         DC    AL1(255)                                        @Y17XAIL 72456000
         DC    AL1(255)                                        @Y17XAIL 72460000
         DC    AL1(255-LCBATTN)         RESET LCBATTN          @Y17XAIL 72464000
         SPACE 1                                               @Y17XAIL 72468000
*        WORD FOR SETTING LCBRECVN IN WORD LCBRECOF            @Y17XAIL 72472000
SETRECVN DS    0F                                              @Y17XAIL 72476000
         DC    AL2(0)                                          @Y17XAIL 72480000
         DC    AL1(LCBRECVN)            SET LCBRECVN           @Y17XAIL 72484000
         DC    AL1(0)                                          @Y17XAIL 72488000
         SPACE 1                                               @Y17XAIL 72492000
*        WORD FOR RESETTING LCBFREEN IN WORD LCBRECOF          @Y17XAIL 72496000
RESFREE  DS    0F                                              @Y17XAIL 72500000
         DC    AL1(255)                                        @Y17XAIL 72504000
         DC    AL1(255)                                        @Y17XAIL 72508000
         DC    AL1(255-LCBFREEN)        RESET LCBFREEN         @Y17XAIL 72512000
         DC    AL1(255)                                        @Y17XAIL 72516000
*        WORD FOR SETTING LCBBFRAV IN WORD LCBRECOF            @Y17XAIL 72524000
SETBFRAV DS    0F                                              @Y17XAIL 72528000
         DC    AL3(0)                                          @Y17XAIL 72532000
         DC    AL1(LCBBFRAV)            SET LCBBFRAV           @Y17XAIL 72536000
         SPACE 1                                               @Y17XAIL 72540000
*        WORD FOR RESETTING LCBBFRAV IN WORD LCBRECOF          @Y17XAIL 72544000
RESBFRAV DS    0F                                              @Y17XAIL 72548000
         DC    AL1(255)                                        @Y17XAIL 72552000
         DC    AL1(255)                                        @Y17XAIL 72556000
         DC    AL1(255-LCBFREEN)        RESET LCBFREEN         @Y17XAIL 72560000
         DC    AL1(255-LCBBFRAV)        RESET LCBBFRAV         @Y17XAIL 72570000
         SPACE 1                                               @YM02908 72580000
*        WORD FOR SETTING LCBFREEN IN WORD LCBRECOF            @YM02908 72590000
SETFREE  DS    0F                                              @YM02908 72600000
         DC    AL2(0)                                          @YM02908 72610000
         DC    AL1(LCBFREEN)            SET LCBFREEN           @YM02908 72620000
         DC    AL1(0)                                          @YM02908 72630000
         SPACE 1                                               @YM02908 72640000
*        WORD FOR RESETTING LCBRECVN IN WORD LCBRECOF          @YM02908 72650000
RESRECVN DS    0F                                              @YM02908 72660000
         DC    AL1(255)                                        @YM02908 72670000
         DC    AL1(255)                                        @YM02908 72680000
         DC    AL1(255-LCBRECVN)        RESET LCBRECVN         @YM02908 72690000
         DC    AL1(255)                                        @YM02908 72700000
         EJECT                                                          72800020
         TAVTD                                                          74000020
         EJECT                                                 @Y17XAIL 74200000
         TCCWD                                                 @Y17XAIL 74400000
         EJECT                                                 @Y17XAIL 74600000
         DCBD  DSORG=TX                                                 74800020
DCBTRSTA EQU   IHADCB+X'19'             STATUS BYTE              Y06327 75000005
DCBNIDLE EQU   X'02'                    IDLE=NO,SPECIFIED OR     Y06327 75100005
*                                       IMPLIED BY DEFAULT IN    Y06327 75200005
*                                       OPEN MACRO               Y06327 75300005
         EJECT                                                 @Y17XAIL 75400000
         TDISPD                                                         75600020
         EJECT                                                          76800020
         TLCBD                                                          77200020
         EJECT                                                          78100022
         TPRFD                                                 @Y17XAIL 78120000
         EJECT                                                 @Y17XAIL 78140000
         TPRIOR                                                @Y17XAIL 78160000
         EJECT                                                 @Y17XAIL 78180000
         TQCBD                                                          78800020
         EJECT                                                 @Y17XAIL 79200000
         TRECBD                                                         79600020
         EJECT                                                 @Y17XAIL 80000000
         TSTCBD                                                         80400020
         EJECT                                                 @Y17XAIL 80800000
         TTRMD                                                          81200020
         EJECT                                                 @Y17XAIL 81300000
         TTSID                                                 @Y17XAIL 81400000
         SPACE 3                                               @Y17XAIL 81500000
         END                                                            81600020
