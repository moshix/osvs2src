         TITLE 'IGG019QE - START I/O APPENDAGE '                        00100010
IGG019QE CSECT                                                          00300010
         SPACE 3                                                        00310010
*  CHANGE ACTIVITY AS FOLLOWS                                           00320010
******************** MICROFICHE FLAGS *********************** SUPT CODE 00330010
*A696000                                                         Y01004 00370010
*C470000-474000,486000                                           Y01004 00440010
*D478000                                                         Y01004 00510010
*A722000,747640                                                 OY01862 00510110
*A141000,150000,171200-173600,306000-310800,760000-761000        Y02027 00510210
*D306000-309000                                                  Y02027 00510310
         SPACE                                                          00600010
*********************************************************************** 00900010
*  MODULE NAME = IGG019QE                                             * 01000010
*                                                                     * 01100010
*  DESCRIPTIVE NAME = START I/O APPENDAGE                             * 01200010
*                                                                     * 01300010
*  COPYRIGHT = 'NONE'                                                 * 01400010
*                                                                     * 01500010
*  STATUS:  CHANGE LEVEL 5                                            * 01600010
*                                                                     * 02100010
*FUNCTION -- 1 CONVERT VIRTUAL ADDRESS IN CCW STRING TO REAL AND      * 02400010
*              BUILD INDIRECT ADDRESS LIST AS REQUIRED                * 02460010
*            2 CONVERT REAL ADDRESS TO VIRTUAL                        * 02520010
*                                                                     * 02580010
*ENTRY POINTS -- 1 IGG019QE - CONVERT VIRTUAL ADDRESS IN CCW STRING   * 02640010
*              TO REAL AND BUILD INDIRECT ADDRESS LIST AS REQUIRED    * 02700010
*              (FROM IOS BEFORE SIO)                                  * 02760010
*                2 IGG019QE+4 - CONVERT REAL ADDRESS IN CCW STRING TO * 02820010
*              VIRTUAL (FROM LINEEND IGE0004G IGE0004H)               * 02880010
*                3 IGG019QE+34 - CONVERT VIRTUAL ADDRESSES IN    Y02027 02910010
*              CCW STRING TO REAL AND BUILD INDIRECT ADDRESS     Y02027 02940010
*              LIST AS REQUIRED (FROM ALL ERP BEFORE RETRY)      Y02027 02970010
*                                                                     * 03000010
*INPUT  -- R2  IOB ADDRESS                                            * 03300010
*   R14 RETURN ADDRESS                                                * 03600010
*   R15 ENTRY POINT ADDRESS                                      X02004 03900010
*   R12 RETURN ADDRESS FOR ENTRY 2                                    * 04300010
*                                                                     * 04800010
*OUTPUT -- REGISTERS  0-11,14,15 REMAIN TRANSPARENT TO IOS UPON EXIT  * 05100010
*   FROM THIS MODULE                                                  * 05400010
*                                                                     * 05700010
*EXTERNAL ROUTINES - IEAPTRV  CONVERT REAL ADDRESS TO VIRTUAL         * 06000010
*                                                                     * 06300010
*EXITS - NORMAL -- 1 BR 14  RETURN TO IOS                             * 06600010
*                  2 BR 12 - RETURN TO CALLER                         * 06900010
*                  3 BR 14 TO RETURN TO ERP TO ISSUE ERREXCP     Y02027 07000010
*                                                                     * 07200010
*EXIT-ERROR -- NONE                                                   * 07500010
*                                                                     * 07800010
*TABLES/WORK AREAS -- DSECTS OF CONTROL BLOCKS GENERATED BY MACROS:   * 08100010
**  TCCWD                                                             * 08400010
*   TLCBD                                                             * 08700010
*   TPRFD                                                        X02004 08770010
*   TAVTD                                                        X02004 08840010
*   DCBD                                                         X02004 08910010
*   CVT                                                               * 08950010
*                                                                     * 09000010
*ATTRIBUTES -- REFRESHABLE, SUPERVISOR MODE, DISABLED                 * 09300010
*                                                                     * 09600010
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 09900010
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET. * 10200010
*                                                                     * 10500010
*********************************************************************** 10800010
         EJECT                                                          11100010
R0       EQU   0                                                        11400010
X        EQU   1                        CCW ADDRESS                     11700010
Y        EQU   2                        IOB ADDRESS                     12000010
Z        EQU   3                                                        12300010
T        EQU   4                                                        12600010
U        EQU   5                                                        12900010
V        EQU   6                                                        13200010
R7       EQU   7                        LINK FOR SUBROUTINE             13500010
R8       EQU   8                        BASE REGISTER                   13800010
W        EQU   9                                                        14100010
RIOSB    EQU   13                       ADDR OF I/O SUPVR BLOCK  Y02027 14200010
R14      EQU   14                       RETURN ADDRESS                  14400010
R15      EQU   15                                                       14700010
         USING LCBFLAG1,Y                                               15000010
         USING IOSB,RIOSB                                        Y02027 15050010
         DC    A(END19QE-IGG019QE)      LENGTH OF SIO ADDENDAGE  X02004 15100010
         USING *,R15                                                    15120010
         B     SIOENTRY                 ENTRY FROM IOS ON SIO    X02004 15140010
         SPACE 1                                                 X02004 15160010
         B     INTENTRY                 ENTRY FROM ERP OR LINEND X02004 15180010
*                                       AFTER AN I/O INTERRUPT   X02004 15200010
         SPACE 1                                                 X02004 15220010
IGG019QE IEDHJN                                                         15240010
SIOENTRY DS    0H                                                X02004 15260010
         DROP  R15                                               X02004 15280010
         L     R15,CVTLOC               CVT ADDRESS                     15300010
         L     R15,AVTCVTPT(,R15)       ADDRESS OF LOAD LIST            15600010
         L     R15,0(,R15)              AVT BASE                        15900010
         USING IEDQAVTD,R15                                             16200010
         STM   R0,W,AVTSAVEX            SAVE REGISTERS                  16500010
ERPENTRY EQU   *                        ENTRY FROM ERP PRIOR TO  Y02027 16600010
*                                       RETRY.                   Y02027 16700010
         BALR  R8,R0                    ESTABLISH ADDRESSABILITY        16800010
         USING *,R8                                                     17100010
         LTR   R15,R15                  IS ENTRY FROM ERP        Y02027 17120010
         BNZ   IOSENTRY                 NO,CONTINUE              Y02027 17140010
         LR    V,R14                    SAVE RETURN ADDRESS      Y02027 17160010
         LR    W,RIOSB                  SAVE I/O SUPVR BLOCK ADD Y02027 17180010
SETERP   SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=CHANNEL PROGRAM,X17200010
               IGE0004G(SETERP),IGE0004H(SETERP),IEDQGT(SETTRAN),      X17220010
               IEDQGA(SETASSC,SETCONC),'PCI LINEEND,AND START I/O      X17240010
               APPENDAGES ARE LOCKED ON THIS RESOURCE THRU THE EXCP    X17260010
               PROCESSOR ISSUING SETLOCK (ERP,BUFFER ASSOCIATION AND   X17280010
               TRANSPARENT CCW BUILD MUST ISSUE SETLOCK'                17300010
         LR    RIOSB,W            RESTORE IOSB ADDR              Y02027 17320010
         LR    R14,V                    RESTORE RETURN ADDRESS   Y02027 17340010
IOSENTRY EQU   *                                                 Y02027 17360010
         TM    LCBFLAG3,LCBRLAD         REAL ADDRESSES           X02004 17400010
         BO    END                      BRANCH YES                      17700010
*                                                                       18000010
         L     X,LCBDCBPT               DCB ADDRESS                     18300010
         SR    V,V                      CLEAR FOR IC                    18600010
         IC    V,DCBEIOBX-IHADCB(X)     LCB SIZE                        18900010
         LA    X,LCBFLAG1-IEDQLCB+EIGHT ACCOUNT FOR LCB PRE+EXT  X02004 19200010
         SR    V,X                      IOB                             19500010
         LA    V,0(V,Y)                 ADDRESS OF END OF LCB           19800010
         OI    LCBFLAG3,LCBRLAD         SET REAL ADDRESSES       X02004 20100010
         ICM   X,R7,LCBSTART            PICK UP ADDR OF 1ST CCW         20400010
         B     CKBFR                    IS FIRST CCW IN BUFFER          20700010
*                                       IF NOT RETURN                   21000010
         SPACE 1                                                 S22026 21070010
         SPACE 2                                                        21210010
         USING IEDQCCW,X                                                21300010
LOOP     EQU   *                                                        21600010
         TM    CCWFLAGS,CCWSKIP         RD SKP LOOP                     21900010
         BO    CKFLAG                   BRANCH YES                      22200010
*                                                                       22500010
LOOPX    EQU   *                                                        22800010
         BAL   R7,VRTORL                CONVERT DATA ADDRESS            23100010
         SPACE                                                          23400010
         BAL   R7,CKIDA                 CHECK FOR INDIECT ADDR LIST     23700010
         SPACE                                                          24000010
* TEST FOR END OF CCW CHAINING                                          24300010
         SPACE                                                          24600010
         TM    CCWFLAGS,CCWCD+CCWCC     LAST CCW                        24900010
         BZ    END                      BRANCH IF LAST                  25200010
         SPACE                                                          25500010
PLUS8    EQU   *                                                        25800010
         LA    X,CCW+EIGHT              ADDRESS OF NEXT CCW             26100010
*  IF TIC COMMAND THEN GO TO SPECIAL ROUTINE                            26400010
         SPACE                                                          26700010
         CLI   CCWOPCDE,CCWPOLL         AUTOPOLL CCW                    27000010
         BE    AUTOP                    BRANCH YES                      27300010
         CLI   CCWOPCDE,CCWNOP          WAS IT PREVIOUSLY AN AUTO-      27600010
*                                       POLL CCW (ERP ENTRY ONLY)       27900010
         BE    AUTOP                    BRANCH IF YES.                  28200010
*                                                                       28500010
         TM    CCWOPCDE,CCWTIC+CCWREAL  REAL TIC CCW             X02004 28800010
         BNO   CKTIC                    BRANCH IF NO                    29100010
*                                                                       29400010
END      EQU   *                                                        29700010
         NI    LCBLSPCI+TWO,X'FF'-THREE RESET FIRST TIME                30000010
         LTR   R15,R15                  IS ENTRY FROM ERP        Y02027 30300010
         BNZ   IOSLINK                  NO, RETURN TO IOS        Y02027 30600010
         L     W,LCBSTART-1             PICKUP RESTART ADDRESS   Y02027 30640010
         LRA   W,ZERO(,W)               CONVERT VIRTUAL ADDRESS  Y02027 30660010
*                                       OF STARTING CCW TO REAL  Y02027 30680010
         ST    W,IOSRST                 SETUP REAL RETRY ADDRS   Y02027 30720010
*                                       FOR IOS IN IOSB          Y02027 30760010
         XC    IOSSNS,IOSSNS            CLEAR SENSE BYTES        Y02027 30780010
         LR    V,R14                    SAVE RETURN ADDRESS      Y02027 30800010
         LR    W,RIOSB                  SAVE I/O SUPVR BLOCK ADD Y02027 30840010
RESETERP SETLOCK RELEASE,TYPE=LOCAL,RELATED=CHANNEL PROGRAM,           X30880010
               IGG019QE(SETERP)                                         30920010
         LR    R14,V                    RESTORE RETURN ADDRESS   Y02027 30960010
         LR    RIOSB,W            RESTORE IOSB ADDR              Y02027 31000010
         BR    R14                      RETURN TO ERP            Y02027 31040010
IOSLINK  EQU   *                                                 Y02027 31080010
* RETURN TO IOS                                                         31200010
         LM    R0,W,AVTSAVEX            RESTORE REGISTERS               31500010
         BR    R14                      RETURN TO IOS                   31800010
         SPACE                                                          32100010
CKFLAG   EQU   *                                                        32400010
         LA    X,0(,X)                  CLEAR HIGH ORDER                32700010
         LA    R7,LCBCPA                ADDRESS OF SKIP IDLE LOOP       33000010
         CLR   R7,X                                                     33300010
         BNE   LOOPX                    BRANCH NO                       33600010
         TM    CCWFLAGS,CCWCD+CCWCC     RRAL ADDRESS                    33900010
         BO    PLUS8                    BRANCH YES                      34200010
*                                                                       34500010
         OI    CCWFLAGS,CCWCC           SET REAL ADDRESS FLAG           34800010
         BAL   R7,VRTORL                CONVERT TO REAL                 35100010
*                                                                       35400010
         B     PLUS8                    PICK UP NEXT CCW                35700010
*                                                                       36000010
CKTIC    EQU   *                                                        36300010
         TM    CCWOPCDE,R7              IS CCW A VIRTUAL TIC            36600010
         BNZ   LOOP                     BRANCH NO                       36900010
         SPACE                                                          37200010
         L     T,CCWADDR-ONE            TIC TO ADDRESS                  38400010
         LRA   W,0(,T)                  CONVERT TO REAL                 38700010
         STCM  W,R7,CCWADDR             STORE REAL ADDRESS              39000010
         OI    CCWOPCDE,AVTE80          SET REAL TIC OP CODE            39300010
         TM    CCWADDR+TWO,THREE        INVALID TIC                     39400010
         BNZ   END                      BRANCH IF YES                   39500010
         LR    X,T                                                      39600010
         TM    LCBLSPCI+TWO,X           FIRST TIME SET                  39900010
         BO    LOOP                     BRANCH YES                      40200010
*                                                                       40500010
         OC    LCBLSPCI,LCBLSPCI        LSPCI = 0                       40800010
         BZ    LOOP                     BRANCH YES - FOLLOR TIC CHAIN   41100010
*                                                                       41400010
CKBFR    EQU   *                                                        41700010
         LA    R7,0(,X)                 CLEAR HIGH ORDER CCW ADDRESS    42000010
         LA    W,LCBERCCW               START OF CCW'S IN LCB.          42300010
         SR    W,R7                     IS TIC TO BEFORE LCB            42600010
         BP    PKLSPCI                  BRANCH YES                      42900010
*                                                                       43200010
         LR    T,V                      ADDRESS OF IDA AFTER CPA X02004 43500010
         SR    T,R7                     TIC TO AFTER LCB                45300010
         BP    LOOP                     BRANCH NO - CONTINUE            45600010
*                                                                       45900010
PKLSPCI  EQU   *                                                        46200010
         CLM   X,AD,LCBLSPCI            IS SIO ON LSPCI BFR             46400010
         BE    SETSW                    YES, SET FIRST TIME             46600010
          SPACE                                                         46800010
         USING IEDQPRF,R7                                        Y01004 47000010
         L     R7,LCBLSPCI-1            ADDRESS OF FIRST BFR     Y01004 47070010
         BAL   T,SETOPCD                ENTER LOOP               Y01004 47140010
*                                                                Y01004 47210010
         ICM   R7,ALL,PRFTIC            ADDRESS OF NEXT UNIT/BFR Y01004 47280010
         BM    END                      BRANCH IF SIMULATED CHANLY01004 47350010
*                                       PROGRAM CHECK - CCW'S AREY01004 47420010
*                                       ALREADY REAL FROM IEDQGA Y01004 47490010
SETOPCD  EQU   *                                                        47600010
         MVI   PRFOPCDE,ZERO            SET OP CODE TO ZERO             48000010
*                                           FOR LINEEND APPENDAGE       48200010
         CLM   X,AD,PRFTIC+ONE          IS SIO ON NEXT UNIT             48400010
         BCR   CCNEQ,T                  NO, CONTINUE SEARCH      Y01004 48600010
         SPACE                                                          48800010
         LRA   T,0(,X)                  YES, SET TIC TO                 49000010
         STCM  T,AD,PRFTIC+ONE              SIO UNIT TO REAL ADDR       49200010
         OI    PRFTIC,CCWREAL           SET REAL TIC OP CODE     X02004 49400010
SETSW    EQU   *                                                        49600010
         OI    LCBLSPCI+TWO,ONE         SET FIRST TIME SWITCH           49800010
         B     LOOP                     BR TO CONVERT REMAINDER         50000010
*                                        OF CCW CHAIN TO REAL           50200010
         DROP  R7                                                       50400010
         SPACE                                                          50600010
*                                                                       51900010
AUTOP    EQU   *                                                        52200010
         TM    CCWFLAGS,CCWCD+CCWCC     IS THIS END OF CHAIN            52300010
         BZ    END                      YES, EXIT                       52400010
         BAL   R7,VRTORL                CONVERT FIRST POLL              52500010
*                                                                       52800010
         BAL   R7,CKIDA                 BCHECK INDIRECT ADDRESSING      53100010
         BAL   R7,TICCK                 CONVERT TIC                     53400010
*                                                                       53700010
         BAL   R7,TICCK                 CONVERT TIC2                    54000010
*                                                                       54300010
         BAL   R7,VRTORLP               CONVERT POLL2 CCW               54600010
*                                                                       54900010
         BAL   R7,CKIDA                 CHECK INDIRECT ADDRESSING       55200010
*                                                                       55500010
         BAL   R7,TICCK                 CONVERT TIC                     55800010
*                                                                       56100010
         B     PLUS8                    CHECK NEXT CCW                  56400010
*                                                                       56700010
TICCK    EQU   *                                                        57000010
         TM    CCWOPCDE+EIGHT,R7        IS THIS REALLY A TIC            57300010
         BNZ   VRTORLP                  BRANCH NO                       57600010
*                                                                       57900010
         OI    CCWOPCDE+EIGHT,CCWREAL   SET REAL TIC OP CODE     X02004 58200010
VRTORLP  EQU   *                                                        58500010
         LA    X,CCW+EIGHT                                              58800010
VRTORL   EQU   *                                                        59100010
         L     T,CCWADDR-ONE            PICK UP CCW ADDRESS             59400010
         LRA   W,0(,T)                  CONVERT TO REAL ADDRESS         59700010
         STCM  W,R7,CCWADDR             STORE REAL ADDRESS              60000010
         CLI   CCWOPCDE,ZERO            ERP RETRY OF ZEROED CCW         60030010
         BCR   CCNEQ,R7                 BRANCH NO - RETURN              60060010
*                                                                       60090010
         MVI   CCWOPCDE,CCWREAD         ASSUME READ STATE               60120010
         TM    LCBSTAT1,LCBRECVN        ARE WE RECEIVING                60150010
         BCR   CCON,R7                  BRANCH YES - RETURN             60180010
*                                                                       60210010
         MVI   CCWOPCDE,CCWWRITE        SET WRITE OP CODE               60240010
         BR    R7                       RETURN                          60300010
*                                                                       60600010
CKIDA    EQU   *                                                        60900010
* TEST FOR INDIRECT ADDRESS LIST REQUIREMENT                            61200010
* SAVING VIRTUAL 2K BLOCK ADDRESS IN REGISTER T                         61500010
         L     Z,CVTLOC                 CVT ADDRESS                     61600010
         TM    CVTDCB-CVT(Z),CVT2SPS    TEST SYSTEM TYPE                61700010
         SPACE                                                          61800010
         LA    Z,NTWOK                                                  62100010
         BO    VS1                      BRANCH VS1 - 2K PAGE SIZE       62160010
         LA    Z,ONE(Z,Z)               SET Z = 4K MINUS 1              62220010
VS1      EQU   *                                                        62280010
         LR    U,Z                      SAVE PAGE SIZE MINUS 1          62340010
         NR    Z,W                                                      62400010
         XR    T,Z                                                      62700010
         BCTR  Z,0                      DECREMENT RESIDUAL BY 1         62800010
*                                       TO ACCOUNT FOR PAGE SIZE 1      62900010
         AH    Z,CCWCOUNT                                               63000010
         SR    Z,U                      SUBTRACT 2K(4K) -1 FROM         63200010
*                                       DATA ENDING ADDRESS RESIDUAL    63400010
         BCR   13,R7                    RETURN IF NOT CROSS PAGE        63600010
         TM    CCWFLAGS,CCWIDA          IS IDA FLAG SET          X02004 63640010
         BCR   CCON,R7                  BRANCH IF YES - SET BY   X02004 63680010
*                                       IGG019RE IF COMBUF AREA  X02004 63720010
*                                       CROSSES A PAGE BOUNDARY  X02004 63760010
*                                       WHICH IS DETERMINED BY   X02004 63800010
*                                       OPEN WHO BUILT THE IDA   X02004 63840010
         SH    V,H8                     FIRST TIME - BACK UP TO         63900010
*                                       END OF LCB MINUS 8 -            64200010
*                                       SECOND TIME (ONLY AUTOPOLL)     64500010
*                                       BACK UP TO END -16              64800010
         ST    W,0(,V)                                                  65100010
         SPACE                                                          65400010
* STORE INDIRECT ADDRESS LIST POINTER IN CCW                            65700010
         SPACE                                                          66000010
         LRA   W,0(,V)                                                  66300010
         STCM  W,R7,CCWADDR                                             66600010
         SPACE                                                          66900010
* BUILD REST OF INDIRECT ADDRESS LIST                                   67200010
         SPACE                                                          67500010
         LRA   U,ONE(U,T)               REAL ADDRESS OF SECOND PAGE     67900010
         ST    U,FOUR(,V)                                               68400010
         OI    CCWFLAGS,CCWIDA                                          68700010
         BR    R7                       RETURN                          69000010
         EJECT                                                          69300010
R1       EQU   1                        RQE ADDRESS                     69320010
RIOB     EQU   2                        IOB ADDRESS                     69340010
RCCW     EQU   5                        CCW BASE                        69360010
RLNK     EQU   6                        SUBROUTINE LINK REGISTER        69380010
RRET     EQU   12                       RETURN REGISTER                 69400010
R11      EQU   11                       RQE SAVE REGISTER               69420010
RDCB     EQU   4                        DCB ADDRESS                     69440010
INTENTRY DS    0H                                                X02004 69460010
         BALR  R8,0                     SET UP BASE REG          X02004 69480010
         USING *,R8                     SET ADDRESSABILITY       X02004 69500010
         DROP  X                                                        69520010
         USING LCBFLAG1,RIOB                                            69540010
         USING IEDQCCW,RCCW                                             69560010
         LR    R11,R1                  SAVE RQE ADDRESS                 69580010
         ICM   R1,AD,LCBSTART           CHANNEL PROGRAM START           69600010
*                                       FROM LCB.                       69620010
         B     CHECKBUF                 BRANCH TO DETERMINE THE         69640010
*                                       LOCATION OF THE CCW - IN        69660010
*                                       A BUFFER OR IN THE LCB.         69680010
         SPACE 3                                                        69700010
CHKREAL  EQU   *                                                        69720010
         TM    CCWOPCDE,INVALID         IS CCW A VIRTUAL TIC     X01004 69740010
         BZ    CKTICX                   IF YES GO SEE IF THIS ISX01004  69760010
*                                       THE END OF THE CCW CHAIN.       69780010
*                                       (THERE MAY BE MORE REAL         69800010
*                                       CCW'S BEYOND THE VIRTUAL        69820010
*                                       TIC).                           69840010
         SPACE 2                                                        69860010
LOOP1A   EQU   *                                                        69880010
         TM    CCWFLAGS,CCWSKIP         DOES CHANNEL PROGRAM IN-        69900010
*                                       CLUDE WRITE IDLES LOOP   X01004 69920010
         BZ    NOIDLES                  BRANCH IF NO TO CONVERT         69940010
*                                       CCW ADDRESS.                    69960010
         LA    RLNK,LCBCPA              GET ADDR OF WRITE IDLES  X02004 69980010
*                                       LOOP.                           70000010
         LA    RCCW,0(,RCCW)            CLEAR HIGH ORDER BYTE.          70020010
         CLR   RLNK,RCCW                IS CURRENT CCW THE WRITE X02004 70040010
*                                       IDLES/READ SKIP CCW      X01004 70060010
         BNE   NOIDLES                  BRANCH IF NO TO CONVERT         70080010
*                                       CCW ADDRESS.                    70100010
         TM    CCWFLAGS,CCWCC+CCWCD     DO CHAINING FLAGS INDICATE      70120010
*                                       REAL ADDRESSES IN THE WRITE     70140010
*                                       IDLES LOOP               X01004 70160010
         BNO   CHKDONE                  BRANCH IF NO TO SEE IF          70180010
*                                       CONVERSION IS COMPLETE.         70200010
         NI    CCWFLAGS,X'FF'-CCWCC     SET OFF REAL ADDRESS FLAG       70220010
*                                       IN CCW.                         70240010
         SPACE                                                          70260010
NOIDLES  EQU   *                                                        70280010
         TM    LCBFLAG3,LCBRLAD         REAL CCWS IN LCB         X02004 70300010
         BZ    CKCDCC                   BRANCH NO-CHECK CC + CD  X01004 70320010
*                                                                X01004 70340010
         BAL   RLNK,CONVERT             GO TO SUBROUTINE TO CONVERT     70360010
*                                       CCW ADDRESS TO VIRTUAL.         70380010
         BAL   RLNK,CHECKIDA            GO TO SUBROUTINE TO CHECK       70400010
*                                       FOR INDIRECT ADDRESSING. X02004 70420010
         SPACE                                                          70440010
CKCDCC   EQU   *                                                 X01004 70460010
         TM    CCWFLAGS,CCWCC+CCWCD     ARE CHAINING FLAGS ON    X01004 70480010
         BZ    DONE                     BRANCH IF NO - THIS IS          70500010
*                                       THE LAST CCW, SO WE'RE          70520010
*                                       FINISHED.                       70540010
         SPACE                                                          70560010
NEXTCCW  EQU   *                                                        70580010
         LA    RCCW,CCW+EIGHT           ADDRESS NEXT CCW IN CHAIN.      70600010
         CLI   CCWOPCDE,CCWPOLL         IS CCW AN AUTOPOLL COMND X01004 70620010
         BE    AUTOPOLL                 BRANCH IF YES TO CONVERT        70640010
*                                       AUTOPOLL CCW ADDRESSES.         70660010
         CLI   CCWOPCDE,CCWNOP          WAS IT AN AUTOPOLL COMMAND      70680010
*                                       PREVIOUSLY               X01004 70700010
         BNE   CHKREAL                  BRANCH IF NO                    70720010
AUTOPOLL EQU   *                                                        70740010
         TM    CCWFLAGS,CCWCD+CCWCC     IS THIS END OF CHAIN            70760010
         BZ    DONE                     YES, EXIT                       70780010
         TM    LCBFLAG3,LCBRLAD         REAL CCWS IN LCB         X02004 70800010
         BO    AUTOOK                   BRANCH YES - CONVERT            70820010
         LA    RCCW,CCW+THIRTY2         BUMP PAST POLL SEQUENCE         70840010
         B     NEXTCCW                  CONVERT LAST TIC                70860010
*                                                                       70880010
AUTOOK   EQU   *                                                        70900010
         BAL   RLNK,CONVERT             GO TO SUBROUTINE TO CONVERT     70920010
*                                       FIRST POLL CCW ADDRESS TO       70940010
*                                       VIRTUAL.                        70960010
         BAL   RLNK,CHECKIDA            GO TO SUBROUTINE TO CHECKX02004 70980010
*                                       FOR INDIRECT ADDRESSING.        71000010
         BAL   RLNK,TICTEST             TO SUBROUTINE TO CONVERT X02004 71020010
*                                       THE NEXT CCW - A TIC.           71040010
         BAL   RLNK,TICTEST             TO SUBROUTINE TO CONVERT X02004 71060010
*                                       THE NEXT CCW - A TIC.           71080010
         BAL   RLNK,PRECONV             TO SUBROUTINE TO CONVERT X02004 71100010
*                                       THE SECOND POLL CCW.            71120010
         BAL   RLNK,CHECKIDA            TO SUBROUTINE TO CHECK   X02004 71140010
*                                       FOR INDIRECT ADDRESSING.        71160010
         BAL   RLNK,TICTEST             TO SUBROUTINE TO CONVERT X02004 71180010
*                                       THE NEXT CCW - A TIC.           71200010
         B     NEXTCCW                  BRANCH TO GET THE NEXT CCW.     71220010
         SPACE 3                                                        71240010
         EJECT                                                          71260010
* THE FOLLOWING SUBROUTINE CHECKS FOR INDIRECT ADDRESSING.              71280010
         SPACE                                                          71300010
CHECKIDA EQU   *                                                        71320010
         TM    CCWFLAGS,CCWIDA          IS INDIRECT ADDR USED    X01004 71340010
         BCR   8,RLNK                   RETURN TO CALLER IF NOT. X02004 71360010
         L     R1,0(,R1)                GET REAL INDIRECT ADDRESS       71380010
         LA    R1,0(,R1)                CLEAR HIGH ORDER FOR VS2        71400010
         NI    CCWFLAGS,X'FF'-CCWIDA    SET OFF INDIRECT ADDRESSING     71420010
*                                       FLAG.                           71440010
         L     R15,CVTLOC               CVT ADDRESS                     71460010
         L     R15,CVTPTRV-CVT(,R15)    REAL TO VIRTUAL SURTN           71480010
         BALR  R14,R15                  LINK TO SUBROUTINE TO CONX02004 71500010
*                                       VERT INDIRECT ADDRESS TO        71520010
*                                       VIRTUAL.                        71540010
         STCM  R1,AD,CCWADDR            STORE VIRT. ADDR IN CCW  X01004 71560010
         BR    RLNK                     RETURN TO CALLER.        X02004 71580010
         SPACE                                                          71600010
* END OF SUBROUTINE.                                                    71620010
CKTICX   EQU   *                                                        71640010
         ICM   R1,ALL,CCWADDR-1         TIC TO ADDRESS                  71660010
         BNM   LOOP2A                   BRANCH IF VIRTUAL TO CHECK      71680010
*                                       NEXT CCW IN CHAIN.              71700010
         BAL   R14,PTRV               GO TO SUBROUTINE TO CONVERT       71720010
*                                       TIC-TO ADDRESS TO VIRTUAL.      71740010
         OI    LCBFLAG3,LCBRLAD         SET REAL ADDRESS FLAG    X02004 71760010
         STCM  R1,SEVEN,CCWADDR      STORE VIRTUAL TIC-TO     X0100     71780010
*                                       ADDRESS IN CCW.          X01004 71800010
         NI    CCWOPCDE,X'FF'-CCWREAL     T VIRTUAL TIC OP CODE. X01004 71820010
LOOP2A   EQU   *                                                 Y01004 71840010
         TM    CCWADDR+2,INVALID        IS TIC INVALID          X01004  71860010
         BNZ   DONE                     BRANCH IF YES           X01004  71880010
CHECKBUF EQU   *                                                        71900010
         LA    RCCW,0(,R1)              GET NEXT CCW ADDRESS.           71920010
         TM    LCBLSPCI+2,ONE           HAS LCBLSPCI BEEN USED   X02004 71940010
*                                       ALREADY                  X01004 71960010
         BO    TEST2                    BRANCH IF YES - WE'VE AL-       71980010
*                                       READY TIC'D OUT OF THE LCB.     72000010
         LA    R14,LCBERCCW             RWKC - ADDR OF ERP CCWS  X02004 72020010
*                                       IN LCB.                         72040010
         SR    R14,RCCW                 DOES THE CURRENT CCW     X02004 72060010
*                                       PRECEDE CCW'S IN LCB     X01004 72080010
         BP    NOTINLCB                 BRANCH IF YES TO GET BUF-       72100010
*                                       FER ADDRESS FROM LCBLSPCI.      72120010
         SR    R14,R14                  CLEAR FOR IC.                   72140010
         IC    R14,DCBEIOBX-IHADCB(RDCB)  T LCB SIZE FROM DCB    X0200  72160010
         LA    R14,0(RIOB,R14)          CALCULATE ENDING ADDRESS X02004 72180010
*                                       OF LCB.                         72200010
         SH    R14,OFFLCB               ACCOUNT FOR LCB PRE+EXT OY01862 72210010
         SR    R14,RCCW                 DOES THE CURRENT CCW            72220010
*                                       FOLLOW  CCW'S IN LCB     X01004 72240010
         BP    LOOP1A                   BRANCH IF THE CCW IS IN         72260010
*                                       THE LCB.                        72280010
         SPACE                                                          72300010
NOTINLCB EQU   *                                                        72320010
         ICM   RCCW,SEVEN,LCBLSPCI      GET BUFFER ADDR FROM LCB X01004 72340010
         BZ    DONE                     BRANCH IF BUFFER IS NOT         72360010
*                                       ASSIGNED - WE'RE DONE.          72380010
         OI    LCBLSPCI+2,ONE           SET SWITCH TO INDICATE   X      72400010
*                                       FIRST USE OF LCBLSPCI           72420010
*                                       (FIRST TIC OUT OF LCB).         72440010
         SPACE                                                          72460010
TEST2    EQU   *                                                        72480010
         CLI   CCWOPCDE,ZERO            IS THIS THE RESULT OF A         72500010
*                                       RESTART ON OTHER THAN THE       72520010
*                                       FIRST UNIT OF A BUFFER   X01004 72540010
         BNE   LOOP1A                   BRANCH IF NO.                   72560010
         B     NEXTCCW                  FOLLOW TIC CHAIN         Y01004 72580010
         EJECT                                                          72600010
* THE FOLLOWING SUBROUTINE CONVERTS REAL ADDRESSES TO VIRTUAL.          72620010
         SPACE                                                          72640010
TICTEST  EQU   *                        SPECIAL SUBROUTINE ENTRY        72660010
*                                       FOR TIC CCW'S AFTER AUTO-       72680010
*                                       POLL CCW'S.                     72700010
         TM    CCWOPCDE+EIGHT,CCWTIC+CCWREAL   S CCW A REAL TIC  X01004 72720010
         BNO   PRECONV                  BRANCH IF NO - IT'S BEEN        72740010
*                                       SET TO A NO-OP.                 72760010
         NI    CCWOPCDE+EIGHT,X'FF'-CCWREAL T VIRTUAL TIC OP CODE.      72780010
         SPACE                                                          72800010
PRECONV  EQU   *                        SPECIAL SUBROUTINE ENTRY        72820010
*                                       POINT FOR AUTOPOLL CCW'S.       72840010
         LA    RCCW,CCW+EIGHT           BUMP PAST FIRST POLL CCW.       72860010
         SPACE                                                          72880010
CONVERT  EQU   *                                                        72900010
         BAL   R14,PTRV                 CONVERT ADDRESS                 72920010
         SPACE 1                                                        72940010
         STCM  R1,AD,CCWADDR            SET VIRTUAL ADDRESS             72960010
         BR    RLNK                     RETURN TO CALLER                72980010
         SPACE 1                                                        73000010
PTRV     EQU   *                                                        73020010
         SR    R1,R1                                                    73040010
         ICM   R1,AD,CCWADDR            ADDRESS TO BE CONVERTED         73060010
         L     R15,CVTLOC               CVT ADDRESS                     73080010
         L     R15,CVTPTRV-CVT(,R15)    REAL TO VIRTUAL SURTN           73100010
         BR    R15                      LINK TO SUBROUTINE.      X02004 73120010
         SPACE                                                          73140010
* NOTE:  RETURN FROM 'IEAPTRV' IS VIA BR 14.  IF THIS SUBROUTINE WAS    73160010
*        ENTERED AT ENTRY POINT 'TICTEST', ENTRY POINT 'PRECONV', OR    73180010
*        ENTRY POINT 'CONVERT', RETURN WILL BE TO STATEMENT 'NSI'.      73200010
*        IF THIS SUBROUTINE WAS ENTERED AT ENTRY POINT 'PTRV',          73220010
*        RETURN WILL BE DIRECTLY TO THE CALLER AT THE NEXT SEQUENTIAL   73240010
*        INSTRUCTION AFTER THE BAL TO 'PTRV'.                           73260010
         SPACE                                                          73280010
         EJECT                                                          73300010
CHKDONE  EQU   *                        ENTER HERE WITH VIRTUAL         73320010
*                                       ADDRS. IN WRITE IDLES LOOP.     73340010
         CLM   RCCW,SEVEN,LCBCPA+NINE   IS CURRENT CCW IN WRITE  X01004 73360010
*                                       IDLES LOOP               X01004 73380010
         BNE   NEXTCCW                  BRANCH IF NO TO GET THE         73400010
*                                       NEXT CCW.                       73420010
         SPACE 2                                                        73440010
* AT THIS POINT, ALL APPLICABLE CCW ADDRESSES HAVE BEEN CONVERTED TO    73460010
* VIRTUAL.                                                              73480010
         SPACE                                                          73500010
DONE     EQU   *                                                        73520010
         NI    LCBLSPCI+2,X'FF'-ONE     TURN OFF LSPCI FLAG             73540010
         NI    LCBFLAG3,X'FF'-LCBRLAD    RESET REAL ADDR FLAG    X02004 73560010
         LR    R1,R11                   RESTORE RQE ADDRESS             73580010
         BR    RRET                     RETURN                          73600010
         SPACE 1                                                        73620010
THIRTY2  EQU   32                                                       73640010
INVALID  EQU   X'07'                    INVALID TIC FLAG.               73660010
AD       EQU   X'07'                    MASK FOR ADDRESS                74760010
*                                                                       74762010
H8       DC    H'8'                     ONE HALF WORD OF 8              74764010
OFFLCB   DC    AL2(LCBFLAG1-IEDQLCB+EIGHT) LENGTH OF LCB PREFIX OY01862 74764610
*                                       AND EXTENSION           OY01862 74765210
ALL      EQU   15                       MASK FOR ICM OF 4 BYTES  Y01004 74766010
CCNEQ    EQU   7                        NOT EQUAL CONDITION             74768010
CCON     EQU   7                        BIT ON CONDITION CODE           74770010
ONE      EQU    1                                                       74772010
TWO      EQU    2                                                       74774010
THREE    EQU    3                                                       74776010
FOUR     EQU    4                                                       74778010
FIVE     EQU    5                                                       74780010
SIX      EQU    6                                                       74782010
SEVEN    EQU    7                                                       74784010
EIGHT    EQU    8                                                       74786010
NINE     EQU    9                                                       74788010
TEN      EQU   10                                                       74790010
ELEVEN   EQU   11                                                       74792010
NTWOK    EQU   2047                                                     74794010
CVTLOC   EQU   16                                                       74800010
ZERO     EQU   X'00'                                                    74820010
         CNOP  0,8                      ALIGN TO DOUBLEWORD      X02004 74840010
END19QE  EQU   *                        END OF LOAD MODULE       X02004 74860010
         EJECT                                                          74880010
         TPRFD                                                          74940010
         TCCWD                                                          75000010
         TLCBD                                                          75300010
         DCBD  DSORG=TX                                                 75600010
         TAVTD                                                          75900010
         EJECT                                                          76000010
         IHAPSA                                                         76000110
         CVT   DSECT=YES                                                76100010
         IECDIOSB                                                       76100110
         END                                                            76200010
