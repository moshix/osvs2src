R2 TITLE '''IGG019R2'' - DISK END APPENDAGE'                            00300020
IGG019R2 CSECT                                                          00600020
*A184000-185000,553000,585000-639000                             Y02027 00600606
*D294100-295702,576000-648000,651400-654200                             00601206
         SPACE 3                                                SA63974 00602052
*  CHANGE ACTIVITY AS FOLLOWS                                           00604052
********************MICROFICHE FLAGS ************************ SUPT CODE 00606052
*A256980,651000                                                  A42413 00610052
*C261500                                                         A42413 00610152
*D720200-722920,780000                                           A42413 00610252
*A228000                                                         S21101 00610352
*C261500                                                         S21101 00610452
*A294000,438000                                                  S21101 00610552
*D653000                                                         S21101 00610652
*C724000                                                         S21101 00610752
*A735000                                                         S21101 00610852
*C792000                                                         S21101 00610952
*C261000                                                         S21903 00611052
*D 657000-663000                                                SA63974 00611152
*A 669000                                                       SA63974 00611252
*C261000                                                         S21903 00880022
*A207000,256800,260000,295700,732000,781000                      X01004 00882005
*C294000-294020,723000-724000                                    X01004 00884005
*D256982                                                         X01004 00886005
*A736000                                                         X02004 00888005
*C257000,295706,483000,492000,732450,732630                      X02004 00890005
*D255000                                                         X02004 00892005
*C249000,253000,256988-294080,294090-295716,354000-357000      2Z40X9QG 00892109
*C444698-444778,444938,444178-446718,449028-449078             2Z40X9QG 00892209
*C449258,453000-456000,459000,462000-465000,471000             2Z40X9QG 00892309
*C477000-492000,723000-726000,732090-723360,732450-732720      2Z40X9QG 00892409
*C732990-733080,734340-734430,736600-777000                    2Z40X9QG 00892509
*D468000                                                       2Z40X9QG 00892609
*C444938-445018                                                @OY12418 00892791
*A256820                                                       @OS78337 00894700
*C266588-267188,270788-271388                                  @OS78337 00896700
*C450000,487000,754800-771600                                  @OZ26164 00897711
         EJECT                                                 @Z40X9QG 00900009
*********************************************************************** 01000052
*                                                                     * 01100052
*TITLE -- 'IGG019R2' - DISK END APPENDAGE                             * 01200020
*                                                                     * 01500020
*  MODULE NAME = IGG019R2                                             * 01800052
*                                                                     * 01840052
*  DESCRIPTIVE NAME = DISK END APPENDAGE                              * 01880052
*                                                                     * 01920052
*  COPYRIGHT = 'NONE'                                                 * 01960052
*                                                                     * 02000052
*  STATUS CHANGE LEVEL 9                                       @Z40X9QG 02040009
*                                                                     * 02100020
*FUNCTION -- THIS APPENDAGE IS TO RECEIVE CONTROL FROM IOS AT THE     * 02400020
*   END OF A DISK I/O OPERATION.  IT REMOVES THE CPBS FROM THE IOB    * 02700020
*   AND MAKES THEM AVAILABLE FOR CPB CLEANUP ROUTINE.  IF ANY CPBS    * 03000020
*   ARE AVAILABLE ON THE RETQ, THESE ARE PASSED BACK TO IOS WITH A    * 03300020
*   REQUEST TO 'RETRY' THE DISK CHANNEL PROGRAM. TCAM DISPATCHER'S    * 03600009
*   ECB IS POSTED COMPLETE TO ACTIVATE THE TCAM TASK.          @Z40X9QG 03900009
*                                                                     * 04200020
*   A TEST ALSO IS MADE FOR AN ERROR IN THE I/O OPERATION.  IF IN99226  04260022
*   ERROR, THE BAD CPB IS FOUND AND FLAGGED.  THE FOLLOWING CPB  99226  04320022
*   IS EXPANDED AND RETURNED WITH A REQUEST TO RETRY.            99226  04380022
*                                                                99226  04440022
*   THIS MODULE IS ALSO THE START I/O APPENDAGE ROUTINE. SEE   @Z40X9QG 04450009
*   PROLOGUE AT LABEL DISKSIO FOR INFORMATION FOR THAT ENTRY   @Z40X9QG 04460009
*   POINT.                                                     @Z40X9QG 04470009
*ENTRY POINTS - DISK APPENDAGE HAS TWO ENTRY POINTS:           @Z40X9QG 04500009
*   CHANNEL END APPENDAGE (CHE)                                @Z40X9QG 04600009
*        LINKAGE                                               @Z40X9QG 04700009
*              L    15,IOSNRM                                  @Z40X9QG 04800009
*              BALR 14,15                                      @Z40X9QG 04900009
*   ABNORMAL END APPENDAGE (ABE)                               @Z40X9QG 05000009
*        LINKAGE                                               @Z40X9QG 05100009
*              L    15,IOSABN                                  @Z40X9QG 05200009
*              BALR 14,15                                      @Z40X9QG 05300009
*                                                                     * 06000020
*INPUT                                                         @Z40X9QG 06300009
*   REGISTER 1  - ADDRESS OF IOSB                              @Z40X9QG 06400009
*   REGISTER 13 - ADDRESS OF 16 WORD SAVE AREA                 @Z40X9QG 06500009
*   REGISTER 14 - RETURN ADDRESS                               @Z40X9QG 06600009
*   REGISTER 15 - ENTRY POINT ADDRESS                          @Z40X9QG 06700009
*                                                                     * 06900020
*OUTPUT                                                        @Z40X9QG 07200009
*   CHANNEL END APPENDAGE                                      @Z40X9QG 07300009
*        COMPLETED CPB'S ARE CHAINED TO CPB CLEANUP QUEUE,     @Z40X9QG 07400009
*        CPB CLEANUP QCB IS POSTED, AND TCAM'S DISPATCHER      @Z40X9QG 07500009
*        IS POSTED. I/O IS 'RETRIED' ON CPB'S ON IOSBERET.     @Z40X9QG 07600009
*   ABNORMAL END APPENDAGE                                     @Z40X9QG 07700009
*        IF ENTERED WITH ERROR BITS IN IOSTATUS AND NOT        @Z40X9QG 07800009
*        PERMANENT ERROR, RETURN FOR RETRY. IF PERMANENT ERROR @Z40X9QG 07900009
*        COMPLETED CPB'S ARE CHAINED TO CPB CLEANUP QUEUE,     @Z40X9QG 08000009
*        CPB CLEANUP QCB IS POSTED, AND TCAM'S DISPATCHER      @Z40X9QG 08100009
*        IS POSTED. THE CPB IN ERROR IS FLAGGED AND THE        @Z40X9QG 08200009
*        FOLLOWING CPB'S ARE EXPANDED AND RETURNED TO IOS      @Z40X9QG 08300009
*        FOR RETRY.                                            @Z40X9QG 08400009
*                                                                99226  08910022
*EXTERNAL ROUTINES.                                                   * 09000020
*        'OS POST' - POSTS TCAM'S ECB TO ACTIVATE DISPATCHER.         * 09300020
*                                                                     * 09600020
*EXITS-NORMAL -- RETURN TO IOS VIA REGISTER 14 IF NO RETRY.           * 09900020
*   RETURN TO IOS VIA REGISTER 14+8 IF RETRY IS TO BE ATTEMPTED.      * 10200020
*                                                                     * 10500020
*EXITS-ERROR -- N/A                                                   * 10800020
*                                                                     * 11100020
*TABLES/WORKAREAS -- QCB, FOR CPB CLEANUP.  IT IS ENQUEUED ON         * 11400020
*   ASYNCHRONOUS READY Q FOR TCAM DISPATCHER TO ACTIVATE. PRIORITY    * 11700009
*   IS PUT INTO QCBPRI.                                               * 12000020
*                                                                     * 12300020
*   CPB - CPBS ARE PICKED UP FROM IOBSTART USING CPBNEXT AS CHAINING  * 14100020
*   POINTER.  CPBNEXT OF LAST CPB IS ZERO.  CPBS ARE PASSED TO CPB    * 14400020
*   CLEANUP VIA ONE OF TWO FIFO QUEUES, AVTDKAPQ AND AVTDKENQ.        * 14700020
*   AVT - THE CPB CLEANUP QCB IS TAGGED 'AVTCPBCB'.                   * 15000020
*   IN AVTBIT1, BIT X'80' IF SET CAUSES AVTDKENQ TO BE USED           * 15300020
*   INSTEAD OF AVTDKAPQ TO HOLD CPBS BEING RETURNED TO CPB CLEANUP.   * 15600020
*                                                                     * 15900020
*ATTRIBUTES - REUSABLE, REFRESHABLE, ENTERED WITH LOCAL LOCK   @Z40X9QG 16200009
*                                                                     * 16500020
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 16800020
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET. * 17100020
*                                                                     * 17400020
*   THIS ROUTINE IS LOADED FROM SVCLIB WHEN THE FIRST DISK MESSAGE    * 17700020
*   QUEUE DATA SET IS OPENED.                                         * 18000020
*********************************************************************** 18100052
         EJECT                                                  SA63974 18200052
R15      EQU   15                       ENTRY ADDRESS                   18300020
R14      EQU   14                       RETURN ADDRESS                  18600020
R13      EQU   13                       SAVEAREA POINTER                18900020
RBASE    EQU   12                       PROGRAM BASE                    19200020
R12      EQU   12                       TCB ADDR FOR OS POST            19500020
R11      EQU   11                       ECB ADDR                        19900020
RCPB     EQU   11                       CPB DSECT BASE                  20400020
RQCB     EQU   11                       CPB CLEANUP'S QCB ADDRESS       20700020
R10      EQU   10                       REGISTER TEN             X01004 20800005
R9       EQU   9                        ERRORED CPB WORKAREA     99226  21300022
*                                         THEN, CLEARED FOR IOS  99226  21400022
RAVT     EQU   8                        AVT BASE               @Z40X9QG 21600009
RIOSBE   EQU   7                        POINTER TO IOSBE       @Z40X9QG 21900009
CURR     EQU   6                        ADDR OF CURRENT ELEMENT  Y02027 22030006
*                                       ON ASYNCH READY QUEUE    Y02027 22110006
R6       EQU   6                        WORK REGISTER          @Z40X9QG 22200009
R5       EQU   5                        WORK REGISTER          @Z40X9QG 22400009
R4       EQU   4                        WORK REGISTER          @Z40X9QG 22600009
R3       EQU   3                        REGS 3 THRU 6 USED IN    S21101 22850021
*                                         MOVING CCWS IN CPB     S21101 22900021
RIOSB    EQU   2                        POINTER TO IOSB        @Z40X9QG 23100009
R1       EQU   1                        REGISTER 1             @Z40X9QG 23400009
R0       EQU   0                                                        24000020
*                                                                       24300020
         USING IEDQCPB,RCPB                                             24600020
         USING IOSB,RIOSB               IOSB ADDRESSABILITY    @Z40X9QG 24900009
         USING REGSAVE,R13              SAVE AREA              @Z40X9QG 25000009
*                                       ADDRESSABILITY         @Z40X9QG 25100009
         USING IEDQAVTD,RAVT                                            25200020
         USING IOSBE,RIOSBE             IOSBE ADDRESSABILITY   @Z40X9QG 25300009
*                                                                       25600020
         EJECT                                                 @Z40X9QG 25620009
************************************************************** @Z40X9QG 25650009
*                                                            * @Z40X9QG 25653009
* EQUATES                                                    * @Z40X9QG 25656009
*                                                            * @Z40X9QG 25659009
************************************************************** @Z40X9QG 25662009
ZERO     EQU   0                        NUMERIC VALUE          @Z40X9QG 25665009
ONE      EQU   1                        NUMERIC VALUE          @Z40X9QG 25668009
TWO      EQU   2                        NUMERIC VALUE          @Z40X9QG 25671009
THREE    EQU   3                        NUMERIC VALUE          @Z40X9QG 25674009
AD       EQU   7                        3- BYTE ICM/STCM MASK    X01004 25680105
SM       EQU   X'31'                    SEARCH ID EQUAL CCW OP   X01004 25680205
NOTIC    EQU   7                        TIC CCW MASK             X01004 25680305
EIGHT    EQU   8                        CONSTANT                 X01004 25680405
NO       EQU   8                        BRANCH CONDITION CODE    X01004 25680505
ALL      EQU   15                       4- BYTE ICM/STCM MASK    X01004 25680605
SXTN     EQU   16                       OFFSET INTO SAVE AREA    X01004 25680705
GOODCODE EQU   X'7F'                    SUCCESSFUL COMPLETION    99226  25682022
INTCODE  EQU   X'7E'                    INTERCEPT CONDITION    @OS78337 25682500
CPBER    EQU   X'01'                    FLAG TO INDICATE BAD CPB 99226  25683022
SETBACK  EQU   16                       ALLOW FOR OFFSET IN CPB  99226  25685022
RWFLAG   EQU   4                        RD/WR FLAG DISPLACEMENT  99226  25686022
FOUR     EQU   4                        DISPLACEMENT OF FOUR     99226  25686522
SEVEN    EQU   7                                                 Y02027 25686706
SECRW    EQU   8                        SECOND RD/WR DISPL       99226  25687022
TIC2     EQU   8                        TIC2 DISPL               99226  25688022
NEXT     EQU   9                        NEXT DISPL               99226  25689022
INC      EQU   1                        INCREMENTOR TO NEXT BYTE        25690020
W2       EQU   4                        OFFSET TO SECOND WORD OF AREA   25692020
WAITBIT  EQU   X'80'                    WAIT BIT               @Z40X9QG 25694009
RETRY    EQU   8                        VALUE ADDED TO R14 TO           25696020
*                                         CAUSE RETRY                   25698020
*                                                                       25698420
         EJECT                                                 @Z40X9QG 25698809
************************************************************** @Z40X9QG 25758809
*                                                            * @Z40X9QG 25818809
* CONSTANTS THAT MUST NOT BE MOVED                           * @Z40X9QG 25878809
*                                                            * @Z40X9QG 25938809
************************************************************** @Z40X9QG 25998809
         SPACE 1                                               @Z40X9QG 26058809
         DC    AL2(END19R2-IGG019R2)    LENGTH OF MODULE       @Z40X9QG 26118809
         DC    AL2(DISKSIO-IGG019R2)    OFFSET OF SIO CCW      @Z40X9QG 26178809
*                                       TRANSLATION CODE CALLED@Z40X9QG 26238809
*                                       BY IEDQEB              @Z40X9QG 26298809
IGG019R2 IEDHJN ,                                              @Z40X9QG 26358809
         EJECT                                                 @Z40X9QG 26418809
************************************************************** @Z40X9QG 26478809
*                                                            * @Z40X9QG 26538809
* ENTRY POINT FOR CHANNEL END AND ABNORMAL APPENDAGES.       * @Z40X9QG 26598809
* IF I/O COMPLETION CODE IS NOT '7F' OR '7E', THEN THIS      * @OS78337 26658800
* ENTRY IS FOR ABE - DO ABE PROCESSING                       * @OS78337 26718800
*                                                            * @Z40X9QG 26778809
************************************************************** @Z40X9QG 26838809
         USING *,R15                    ADDRESSABILITY         @Z40X9QG 26898809
CHE      EQU   *                                               @Z40X9QG 26958809
ABE      EQU   *                                               @Z40X9QG 27018809
         CLI   IOSCOD-IOSB(R1),INTCODE  PERMANENT ERROR        @OS78337 27078800
         BL    SETUP                    YES,DO ERROR PROCESSING@OS78337 27138800
         SPACE 2                                               @Z40X9QG 27198809
************************************************************** @Z40X9QG 27258809
*                                                            * @Z40X9QG 27318809
* IF COMPLETION CODE IS '7F', AND IF ERROR BITS ARE SET      * @Z40X9QG 27378809
* IN IOSTATUS (IN CSW), THEN THIS IS ENTRY FOR ABE -         * @Z40X9QG 27438809
* RETURN TO IOS FOR RETRY. IF NO ERROR BITS, THIS IS         * @Z40X9QG 27498809
* CHE ENTRY - CONTINUE.                                      * @Z40X9QG 27558809
*                                                            * @Z40X9QG 27618809
************************************************************** @Z40X9QG 27678809
         SPACE 1                                               @Z40X9QG 27738809
         NC    IOSTATUS-IOSB(L'IOSTATUS,R1),ERRBITS ANY ERRORS @Z40X9QG 27798809
         BNZR  R14                      YES, RETURN TO IOS     @Z40X9QG 27858809
         SPACE 2                                               @Z40X9QG 27918809
************************************************************** @Z40X9QG 27978809
*                                                            * @Z40X9QG 28038809
* DO SETUP INITIALIZATION                                    * @Z40X9QG 28098809
*                                                            * @Z40X9QG 28158809
************************************************************** @Z40X9QG 28218809
         SPACE 1                                               @Z40X9QG 28278809
SETUP    EQU   *                                               @Z40X9QG 28338809
         STM   R0,R15,REGSAVE           SAVE REGS IN SAVE AREA @Z40X9QG 28398809
*                                       PROVIDED BY IOS        @Z40X9QG 28458809
         BALR  RBASE,0                  SET BASE REG           @Z40X9QG 28518809
         DROP  R15                                             @Z40X9QG 28578809
         USING *,RBASE                  SET ADDRESSABILITY     @Z40X9QG 28638809
         LR    RIOSB,R1                 SET IOSB ADDRESS       @Z40X9QG 28698809
         L     RIOSBE,IOSUSE            SET IOSBE ADDRESS      @Z40X9QG 28758809
         USING CVT,R3                   CVT ADDRESSABILITY     @Z40X9QG 28818809
         L     R3,CVTPTR                GET CVT ADDRESS        @Z40X9QG 28878809
         L     R10,CVTAQAVT             GET TCX ADDRESS        @Z40X9QG 28938809
         L     RAVT,TCXAVT-IEDQTCX(,R10) GET AVT ADDRESS       @Z40X9QG 28998809
         EJECT                                                 @Z40X9QG 29409009
************************************************************** @Z40X9QG 29417009
*                                                            * @Z40X9QG 29425009
* TRANSLATE CCW'S FROM REAL TO VIRTUAL                       * @Z40X9QG 29433009
*                                                            * @Z40X9QG 29441009
************************************************************** @Z40X9QG 29449009
         SPACE 1                                               @Z40X9QG 29457009
         USING IEDQCCW,R11              CCW ADDRESSABILITY     @Z40X9QG 29465009
         NI    IOSBEFLG,IOSBECPV        RESET TRANSLATION FLAG @Z40X9QG 29473009
         L     R11,IOSVST               GET START OF CHANNEL   @Z40X9QG 29481009
*                                       PROGRAM                @Z40X9QG 29489009
         L     R10,CVTPTRV              ADDR OF REAL TO        @Z40X9QG 29497009
*                                       VIRTUAL CONVERTER      @Z40X9QG 29505009
         DROP  R3                                              @Z40X9QG 29513009
         SPACE 1                                               @Z40X9QG 29521009
CONVRLOP EQU   *                                               @Z40X9QG 29529009
         LR    R15,R10                  SET CONVERTER ADDR     @Z40X9QG 29537009
         SLR   R1,R1                    CLEAR FOR INSERT       @Z40X9QG 29545009
         ICM   R1,AD,CCWADDR            I/O ADDRESS            @Z40X9QG 29553009
         BALR  R14,R15                  CONVERT ADDRESS        @Z40X9QG 29561009
         STCM  R1,AD,CCWADDR            SET VIRTUAL ADDRESS      X01004 29571805
         CLI   CCWOPCDE,SM              STATUS MODIFIER EXPECTED X01004 29572005
         BE    SMNOTIC                  BRANCH YES               X01004 29572205
         TM    CCWOPCDE,NOTIC           IS THIS CCW A TIC        X01004 29572405
         BZ    ITSTIC                   BRANCH YES               X01004 29572605
         TM    CCWFLAGS,CCWCC+CCWCD     CHAINING SPECIFIED       X01004 29572805
         BZ    TESTQ                    NO, BRANCH             @Z40X9QG 29573009
PLUS8V   EQU   *                                                 X01004 29573205
         LA    R11,CCW+EIGHT            BUMP TO NEXT CCW         X01004 29573405
         B     CONVRLOP                 CONTINUE LOOP            X01004 29573605
SMNOTIC  EQU   *                                                 X01004 29573805
         LA    R11,CCW+EIGHT            BUMP TO TIC              X01004 29574005
         LR    R15,R10                  SET CONVERTER ADDR     @Z40X9QG 29574109
         SR    R1,R1                    CLEAR HIGH-ORDER BYTE    X01004 29574205
         ICM   R1,AD,CCWADDR            TIC TO ADDRESS           X01004 29574405
         BALR  R14,R15                  CONVERT                @Z40X9QG 29574609
         SPACE 1                                                 X01004 29574805
         STCM  R1,AD,CCWADDR            SET VIRTUAL ADDRESS      X01004 29575005
         B     PLUS8V                   GET NEXT CCW             X01004 29575205
ITSTIC   EQU   *                                                 X01004 29575405
         LR    R11,R1                   NEXT CCW IS TIC TO ADDR. X01004 29575605
         B     CONVRLOP                 CONTINUE LOOP            X01004 29575805
         DROP  R11                                               X01004 29577005
         EJECT                                                 @Z40X9QG 29577209
************************************************************** @Z40X9QG 29587209
*                                                            * @Z40X9QG 29597209
* CHECK FOR AVAILABILITY OF DISABLE FIFO QUEUE               * @Z40X9QG 29607209
* FOR CPB CLEANUP                                            * @Z40X9QG 29617209
*                                                            * @Z40X9QG 29627209
************************************************************** @Z40X9QG 29637209
         USING IEDQCPB,RCPB             CPB ADDRESSABILITY     @Z40X9QG 29647209
TESTQ    EQU   *                                                 99226  29682022
         LA    R14,AVTDKAPQ             GET ADDR OF DISABLED FIFO Q     30600020
*                                         OF CPBS TO BE PASSED          30900020
         TS    AVTEZERO(R14)            QUEUE LOCKED             Y02027 31000006
         BZ    LOOP                     NO,  BRANCH (AND USE   @Z40X9QG 31100009
*                                       DISABLED QUEUE)        @Z40X9QG 31300009
         SPACE 2                                               @Z40X9QG 31500009
************************************************************** @Z40X9QG 31600009
*                                                            * @Z40X9QG 31700009
* IF STARTUP IS IN PROGRESS, THESE CPBS ARE NOT FOR CPB CLEANUP,        31800020
* BUT FOR THE CHECKPOINT OPEN ROUTINE WHO REQUESTED THE DISK I/O.       32100020
* OPEN IS IN A WAIT STATE, WAITING FOR APPENDAGE TO HANG THE CPB        32400020
* ON AVTDKAPQ FOR REPROCESSING BY OPEN.                                 32700020
*                                                                       33000020
************************************************************** @Z40X9QG 33100009
LOCKED   EQU   *                                                        33300020
         LA    R14,AVTDKENQ             GET ADDR OF ENABLED FIFO Q      33600020
*                                         OF CPBS TO BE PASSED          33900020
*                                         TO CPB CLEANUP                34200020
         TS    AVTEZERO(R14)            QUEUE LOCKED             Y02027 34300006
         BNE   TESTQ                    YES, RETRY DISABLE QUEUE Y02027 34400006
         EJECT                                                 @Z40X9QG 34420009
************************************************************** @Z40X9QG 34440009
*                                                            * @Z40X9QG 34460009
* R14 HAS ADDR OF FIFO Q TO RECEIVE CPB                                 34500020
*                                                                       34800020
************************************************************** @Z40X9QG 34900009
LOOP     EQU   *                                                        35100020
         L     RCPB,IOSVST              GET ADDR OF 1ST CPB    @Z40X9QG 35400009
         MVC   IOSVST+INC(THREE),CPBNEXT BUMP TO NEXT CPB      @Z40X9QG 35500009
         SPACE 2                                               @Z40X9QG 35600009
************************************************************** @Z40X9QG 35700009
*                                                                       36000020
* ENQUEUE CPB ONTO FIFO Q FOR CPB CLEANUP                               36300020
*                                                                       36600020
************************************************************** @Z40X9QG 36700009
         XC    CPBNEXT,CPBNEXT          ZERO FORWARD POINTER IN CPB     36900020
*                                         WHICH MAY BECOME LAST ON Q    37200020
         L     R15,W2(,R14)             GET ADDR OF LAST CPB ALREADY    37500020
*                                         ON Q FROM 2ND WORD OF Q       37800020
         ST    RCPB,W2(,R14)            SET Q TO POINT TO NEW CPB       38100020
*                                         AS NEW LAST CPB ON Q          38400020
         NC    INC(L'CPBNEXT,R14),INC(R14) IF 1ST WORD OF Q IS 0,       38700020
*                                         THE Q WAS EMPTY               39000020
         BNZ   NOTEMPTY                 BRANCH IF SOMETHING ALREADY     39300020
*                                         ON THE Q                      39600020
*                                       CONTINUE IF NEW CPB IS NOW      39900020
*                                         THE ONLY CPB TO BE ON Q       40200020
         MVC   INC(L'CPBNEXT,R14),W2+INC(R14) BEING ONLY CPB, BOTH      40500020
*                                         FIRST & LAST WORD OF Q        40800020
*                                         POINTS TO SAME CPB            41100020
         B     ENQUEUED                 CPB HAS BEEN ADDED TO AN        41400020
*                                         EMPTY Q                       41700020
         EJECT                                                 @Z40X9QG 41730009
************************************************************** @Z40X9QG 41760009
*                                                            * @Z40X9QG 41790009
* ADJUST CCW'S IN THE CPB (IF NECESSARY). SUBROUTINE         * @Z40X9QG 41820009
* USES REGS 3,4,5,6, AND 15 AS WORK REGISTERS.               * @Z40X9QG 41850009
*                                                            * @Z40X9QG 41880009
************************************************************** @Z40X9QG 41910009
ENQSUBR  EQU   *                        CPB HAS BEEN PASSED TO   99226  42000022
*                                         CPB CLEANUP SUBTASK    99226  42900022
         LA    R15,0(,RCPB)             SET PSEUDO BASE OF CPB   S21101 43850021
*                                       AND CLEAR HIGH BYTE      S21101 43900021
         CLI   CPBSEEK,CPBSEEKC         IS FIRST CCW SEEK        S21101 43950021
         BNE   NOTSEEK                    NO, NOT LARGE CPB      S21101 44000021
*                                         YES, LARGE CPB         S21101 44050021
         CLI   CPBSET,CPBSETC           IS SECOND CCW SET CCW    S21101 44060021
         BE    OUT                        YES, LARGE CPB WITH SETS21101 44070021
*                                         NO, LARGE WITHOUT SET  S21101 44080021
LESS8    EQU   *                                                 S21101 44090021
         SH    R15,H8                   ADJUST FOR MISSING CCW   S21101 44092021
         B     OUT                      PSEUDO CPB BASE SET      S21101 44094021
*                                                                S21101 44096021
NOTSEEK  EQU   *                        NOT LARGE CPB            S21101 44098021
         CLI   CPBSEEK,CPBSETC          IS FIRST CCW SET         S21101 44098421
         BE    LESS8                      YES, MEDIUM CPB WITH SES21101 44098821
*                                           GO ADJUST FOR MISSINGS21101 44099221
*                                         SEEK                   S21101 44099621
*                                         NO, NOT SET CCW        S21101 44099721
         CLI   CPBSEEK,CPBSRCHC         IS FIRST CCW SEARCH      S21101 44099821
         BE    LESS16                     YES, MEDIUM CPB        S21101 44099921
*                                         WITHOUT SET            S21101 44149921
*                                         NO, SMALL CPB          S21101 44159921
         SH    R15,H16                  ADJUST FOR MISSING       S21101 44169921
*                                         SEARCH-TIC             S21101 44179921
LESS16   EQU   *                        MEDIUM CPB WITHOUT SET   S21101 44191921
         SH    R15,H16                  ADJUST FOR MISSING       S21101 44193921
*                                         SEEK, SET              S21101 44195921
OUT      EQU   *                        R15 IS ADJUSTED PSEUDO   S21101 44197921
*                                         CPB BASE               S21101 44198321
         LM    R3,R6,CPBRDWR-IEDQCPB(R15) GET RD, RD CCWS FROM   S21101 44198721
*                                         PSEUDO CPB             S21101 44199121
         TM    CPBXDWR-IEDQCPB(R15),CPBTICC IS THIS TIC OR FF    S21101 44199521
         BZ    NOTTIC                   NO, BRANCH             @Z40X9QG 44199609
         SH    R15,H8                   ADDR OF DISK UNIT AT     S21121 44199821
*                                         CPBAREA, NOT CPBXREA   S21101 44249821
NOTTIC   EQU   *                                               @Z40X9QG 44254809
         L     R15,CPBXREAF-IEDQCPB(,R15) GET UNIT ADDRESS       S21101 44259821
         STM   R3,R6,CPBRDWR            RESTORE RD, RD CCWS TO   S21101 44269821
*                                         PROPER POSITION        S21101 44279821
         ST    R15,CPBXREAF             SET BUFFER ADDRESS TO    S21101 44289821
*                                         PROPER POSITION        S21101 44291821
         BR    R9                       RETURN TO CALLER         99226  44293822
         EJECT                                                 @Z40X9QG 44294809
************************************************************** @Z40X9QG 44295809
*                                                            * @Z40X9QG 44296809
* ADD CPB TO CLEANUP QUEUE AND CALL TO ADJUST CCW'S IN CPB   * @Z40X9QG 44297809
*                                                            * @Z40X9QG 44298809
************************************************************** @Z40X9QG 44299809
*                                                                99226  44301822
NOTEMPTY EQU   *                        NEW CPB IS TO BE ADDED TO99226  44309822
*                                         OTHERS ON Q            99226  44317822
         MVC   CPBNEXT-IEDQCPB(,R15),W2+INC(R14) PUT ADDR OF NEW 99226  44325822
*                                         CPB IN FORWARD POINTER 99226  44333822
*                                         OF OLD LAST CPB        99226  44341822
ENQUEUED EQU   *                                                 99226  44349822
         BAL   R9,ENQSUBR               LINK TO ENQUEUE SUBR     99226  44365822
*                                                                99226  44373822
         MVI   CPBSEEK,AVTEZERO         FLAG ADJUSTED CPB AS     99226  44389822
*                                       SERVICED BY APPENDAGE    99226  44397822
         SPACE 2                                               @Z40X9QG 44399809
************************************************************** @Z40X9QG 44401809
*                                                            * @Z40X9QG 44403809
* IF THERE WERE ANY ERRORS IN THE I/O OPERATION,                 99226  44405822
*   FIND THE BAD CPB AND FLAG IT,                                99226  44413822
*   TEST IF THE BAD CPB IS THE LAST ONE,                         99226  44429822
*    IF LAST, TEST RETRY INDICATORS,                             99226  44437822
*    IF NOT, RUN THROUGH THE CPB CLEANUP SUBTASK AND THE BUILD   99226  44445822
*      SEARCH TIC ROUTINE WITH THE NEXT CPB AND GO TO SET RETRY  99226  44453822
*                                                                99226  44461822
************************************************************** @Z40X9QG 44465809
         CLI   IOSCOD,GOODCODE          ANY ERRORS             @Z40X9QG 44469809
         BE    TESTIOB                  NO, BRANCH             @Z40X9QG 44477809
*                                         YES, CPB BAD SOMEWHERE 99226  44485822
         CLC   IOSCSWCA,AVTCPBPT+1      TEST IF CSW IN LOW CORE@OY12418 44493891
         BL    FLAGIT                   YES, FLAG FIRST CPB    @OY12418 44501891
*                                         NO, LOOK FOR BAD CPB   99226  44509822
         SLR   R9,R9                    CLEAR FOR INSERT       @Z40X9QG 44517809
         ICM   R9,AD,IOSCSWCA           GET CMD ADDR FROM CSW  @Z40X9QG 44521809
         LA    RCPB,0(,RCPB)            CLEAR HIGH ORDER BYTE    99226  44525822
         SR    R9,RCPB                                           99226  44533822
         BM    TESTIOB                  THIS NOT BAD CPB         99226  44541822
*                                                                99226  44549822
         C     R9,BADCCW                                         99226  44557822
         BH    TESTIOB                  THIS NOT BAD CPB         99226  44565822
*                                                                99226  44573822
         EJECT                                                 @Z40X9QG 44574809
************************************************************** @Z40X9QG 44575809
*                                                            * @Z40X9QG 44576809
* FLAG CPB THAT IS IN ERROR                                  * @Z40X9QG 44577809
*                                                            * @Z40X9QG 44578809
************************************************************** @Z40X9QG 44579809
         SPACE 1                                               @Z40X9QG 44580809
FLAGIT   EQU   *                                                 99226  44581822
         MVI   AVTEZERO(R14),AVTEZERO   CLEAR Q LOCK FLAG        Y02027 44585806
         OI    CPBFLAG,CPBER            FLAG THIS CPB AS BAD     99226  44589822
         MVC   CPBFLAG3(EIGHT),IOSCC    SAVE CONDITION CODE    @Z40X9QG 44597809
*                                       AND CSW                @Z40X9QG 44605809
         MVC   CPBFLAG1(TWO),IOSFLA     SAVE FLAGS ...         @Z40X9QG 44613809
         MVC   CPBSENS0(TWO),IOSSNS     ... AND SENSE BYTES .. @Z40X9QG 44621809
         MVC   CPBECBCC,IOSCOD          ... AND COMPLETION     @Z40X9QG 44629809
*                                       CODE                   @Z40X9QG 44637809
         L     R9,IOSUCB                GET UCB ADDRESS        @Z40X9QG 44645809
         MVC   CPBUCBID,UCBNAME-UCB(R9) PASS UCB ID            @Z40X9QG 44653809
         SPACE 1                                               @Z40X9QG 44661809
         ICM   RCPB,ALL,IOSVST          IS THERE ANOTHER CPB   @Z40X9QG 44669809
         BZ    LASTCPB                    NO, LAST WAS BAD       99226  44685822
*                                         YES, MORE TO DO        99226  44693822
         BAL   R9,ENQSUBR               LINK TO ENQUEUE SUBR     99226  44701822
         EJECT                                                 @Z40X9QG 44703809
************************************************************** @Z40X9QG 44705809
*                                                                99226  44709822
*   BUILD SEARCH TIC ROUTINE                                     99226  44717822
*                                                                99226  44725822
*                                                            * @Z40X9QG 44727809
************************************************************** @Z40X9QG 44729809
         STM   R3,R6,CPBRDWR-SETBACK    SET UP RDWR CODES        99226  44733822
         LA    R15,CPBABSAD+3           ADDRESS OF CCHHR STORED  99226  44741822
         ST    R15,CPBSRECF-SETBACK       IN PTR TO RECORD ID    99226  44749822
         MVI   CPBSRCH-SETBACK,CPBSRCHC SET SEARCH ID EQ OP CODE 99226  44757822
         MVI   CPBSRHFL-SETBACK,CPBCCC  SET SEARCH CCW FLAG AS CC99226  44765822
         LA    R15,CPBSRH5              SET SEARCH COUNT AS 5    99226  44773822
         STH   R15,CPBSRHCT-SETBACK                              99226  44781822
         LA    R15,CPBSRCH-SETBACK      PTR TO RECORD ID STORED  99226  44789822
         ST    R15,CPBTICSF-SETBACK       AS ADDR OF SEARCH CCW  99226  44797822
         MVI   CPBTIC1-SETBACK,CPBTICC  SET ON TIC TO SEARCH CCW 99226  44805822
         LA    R9,CPBRDWR-SETBACK       GET RD/WR CCW PTR        99226  44813822
         CLI   0(R9),CPBRDKC            TEST IF RD K & D         99226  44821822
         BNE   CCTEST                     NO, LOOK FOR CC HERE   99226  44829822
*                                         YES, RESET PTR         99226  44837822
         LA    R9,SECRW(R9)             GET 2ND RD WR CCW        99226  44845822
CCTEST   EQU   *                                                 99226  44853822
         CLI   RWFLAG(R9),CPBCCC        TEST COMMAND CHAINING    99226  44861822
         BNE   SETRETRY                   NO, CONTINUE           99226  44869822
*                                         YES, SET NEXT CPB PTR  99226  44877822
         MVI   TIC2(R9),CPBTICC         SET ON TIC TO NEXT CPB   99226  44885822
         MVC   NEXT(3,R9),CPBNEXT       PTR TO NEXT CPB          99226  44893822
SETRETRY EQU   *                                                 Y02027 44901806
         BAL   R3,REDRIVE               SET UP TO 'REDRIVE'    @VS41086 44902809
         B     RETURN                   PREPARE TO RETURN      @Z40X9QG 44905809
         SPACE 2                                               @VS41086 44909809
************************************************************** @VS41086 44910109
*                                                            * @VS41086 44910409
* REDRIVE I/O BY RETURNING TO IOS AT R14 + 8. BEFORE         * @VS41086 44910709
* RETURNING, CALL DISKSIO SUBROUTINE TO INITIALIZE THE       * @VS41086 44911009
* IOSB AND TRANSLATE CCW'S.                                  * @VS41086 44911309
*                                                            * @VS41086 44911609
************************************************************** @VS41086 44911909
REDRIVE  EQU   *                                               @VS41086 44912209
         L     R1,SAVE14                GET RETURN ADDR TO IOS @VS41086 44912509
         LA    R1,RETRY(,R1)            BUMP TO 'RETRY' ADDR   @VS41086 44912809
         ST    R1,SAVE14                SAVE ADDRESS           @VS41086 44913109
         LA    R15,DISKSIO              ADDR OF DISKSIO CODE   @VS41086 44913409
         BALR  R14,R15                  DO SIO PROCESSING      @VS41086 44913709
         BR    R3                       RETURN TO CALLER       @VS41086 44914009
         EJECT                                                 @Z40X9QG 44914309
************************************************************** @Z40X9QG 44914609
*                                                            * @Z40X9QG 44914909
* TEST FOR ANOTHER CPB. IF AT LASTCPB, THEN SET UP FOR RETRY * @Z40X9QG 44915209
*                                                            * @Z40X9QG 44915509
************************************************************** @Z40X9QG 44915809
         SPACE 1                                               @Z40X9QG 44916109
TESTIOB  EQU   *                                                 99226  44917822
         ICM   RCPB,ALL,IOSVST          IS THERE ANOTHER CPB   @Z40X9QG 44925809
         BNZ   LOOP                       YES, GO GET IT         99226  44933822
*                                         NO, LAST CPB           99226  44941822
         MVI   AVTEZERO(R14),AVTEZERO   CLEAR Q LOCK FLAG        Y02027 44945806
*                                                                99226  44949822
LASTCPB  EQU   *                                                 99226  44957822
         TS    IOSBELCK                 IS RETRY DOOR LOCKED   @OZ26164 45000011
         BZ    DORETRY                  NO, RETRY              @Z40X9QG 45300009
         OI    IOSBEFLG,IOSBERDY        INDICATE THAT IOSBE    @Z40X9QG 45400009
*                                       READY FOR NEW I/O      @Z40X9QG 45500009
         B     RETURN                   PREPARE TO RETURN      @Z40X9QG 45600009
         SPACE 1                                               @Z40X9QG 45700009
DORETRY  EQU   *                                               @Z40X9QG 45800009
         ICM   RCPB,AD,IOSBERET         IS RETRY QUEUE ZERO    @Z40X9QG 45900009
         BNZ   CLRRET                   NO, BRANCH             @Z40X9QG 46200009
         OI    IOSBEFLG,IOSBERDY        INDICATE THAT IOSBE    @Z40X9QG 46300009
*                                       IS READY FOR NEW I/O   @Z40X9QG 46400009
         B     UNLOCK                   PREPARE TO RETURN      @Z40X9QG 46500009
         SPACE 1                                               @Z40X9QG 46600009
CLRRET   EQU   *                                               @Z40X9QG 46700009
         XC    IOSBERET,IOSBERET        ZERO RETRY QUEUE       @Z40X9QG 47100009
*                                                                99226  47500022
         BAL   R3,REDRIVE               SET UP TO 'REDRIVE'    @VS41086 47700009
         SPACE 1                                               @Z40X9QG 47900009
         DROP  RCPB                                            @Z40X9QG 48100009
         SPACE 2                                               @Z40X9QG 48300009
UNLOCK   EQU   *                                               @Z40X9QG 48500009
         MVI   IOSBELCK,AVTEZERO        UNLOCK RETRY DOOR      @OZ26164 48700011
         EJECT                                                 @Z40X9QG 48900009
************************************************************** @Z40X9QG 49100009
*                                                                       49500020
* IF STARTUP IS IN PROGRESS, CHECKPOINT OPEN IS USING CPBS TO LOOK      49800020
* AT THE DISK MESSAGE QUEUES.  THESE CPBS ARE HANDLED BY EXCP           50100020
* DRIVER (IGG019RC), AND ALSO DISK END APPENDAGE.  IF THE TCAM          50400020
* SYSTEM IS NOT YET ACTIVATED, AND STARTUP IS IN PROGRESS, THESE        50700020
* CPBS COMING THRU APPENDAGE ARE TO BE RETURNED TO CHECKPOINT OPEN,     51000020
* NOT CPB CLEANUP (IEDQFA).  TO PREVENT CPB CLEANUP'S QCB FROM          51300020
* BEING POSTED TO THE DISABLED READY QUEUE, CHECKPOINT OPEN PUTS        51600020
* A NON-ZERO DUMMY 'PRIORITY' IN THE CPB CLEANUP QCB.  APPENDAGE        51900020
* CHECKS THIS PRIORITY FIELD, FINDS IT TO BE NON-ZERO, THINKS THE       52200020
* QCB IS ALREADY POSTED, SO SKIPS POSTING THE QCB.  WHEN CHECKPOINT     52500020
* OPEN IS FINISHED, IT ZEROS THE PRIORITY FIELD SO APPENDAGE WILL       52800020
* ACTIVATE CPB CLEANUP WHEN THE NEXT CPB COMES IN.                      53100020
*                                                                       53400020
************************************************************** @Z40X9QG 53500009
         SPACE 2                                               @Z40X9QG 53600009
RETURN   EQU   *                                               @Z40X9QG 53700009
         LA    RQCB,AVTCPBCB            USING CPB CLEANUP QCB AS        54300020
*                                         ELEMENT, HANG ELE ON          54600020
*                                         DISABLED APENDAGE Q           54900020
         USING IEDQQCB,RQCB                                             55200020
         USING CVT,R3                   CVT ADDRESSABILITY     @Z40X9QG 55300009
         L     R3,CVTPTR                GET CVT ADDRESS        @Z40X9QG 55400009
         CLI   QCBPRI,AVTEZERO          IS QCB ALREADY POSTED           55500020
         BNZ   STARTING                   YES, ALREADY POSTED           55800020
*                                         NO, POST IT                   56100020
         MVI   QCBPRI,PRICPBCL          PUT PRIORITY TO QCB             56400020
         EJECT                                                 @Z40X9QG 56500009
************************************************************** @Z40X9QG 56600009
*                                                                       56700020
* PUT CPB CLEANUP QCB ON ASYNCHRONOUS READY QUEUE            * @Z40X9QG 57000009
*                                                                       57300020
************************************************************** @Z40X9QG 57900009
         L     R10,CVTAQAVT             GET ADDR OF TCAM'S     @Z40X9QG 58500009
*                                       CVT EXTENSION            Y02027 58800006
         USING IEDQTCX,R10              TCX ADDRESSABILITY     @Z40X9QG 59100009
         L     CURR,TCXREADY            PICKUP ADDR OF CURRENT   Y02027 59700006
*                                       ELEMENT ON AYNCHRONOUS   Y02027 60000006
*                                       READY QUEUE              Y02027 60300006
NEWCURR  STCM  CURR,SEVEN,QCBLINK       LINK NEW ELEMENT TO THE  Y02027 60600006
*                                       CURRENT ELEMENT          Y02027 60900006
         CS    CURR,RQCB,TCXREADY       WAS CURRENT ELEMENT      Y02027 61200006
*                                       UPDATED ASYNCHRONOUSLY   Y02027 61500006
         BNE   NEWCURR                  YES, LINK NEW ELEMENT    Y02027 61800006
*                                       TO NEW CURRENT ELEMENT   Y02027 62100006
*                                       NO, ASYNCHRONOUS RDY Q   Y02027 62400006
*                                       IS UPDATED WITH NEW ELEM Y02027 62700006
*                                       BY COMPARE-AND-SWAP INST Y02027 63000006
         DROP  R10                                             @Z40X9QG 63300009
         DROP  RQCB                                            @Z40X9QG 64200009
         SPACE 2                                               @Z40X9QG 65100009
************************************************************** @Z40X9QG 65160009
*                                                            * @Z40X9QG 65220009
* DETERMINE WHICH ECB IS TO BE POSTED                        * @Z40X9QG 65280009
*                                                            * @Z40X9QG 65340009
************************************************************** @Z40X9QG 65400009
STARTING EQU   *                                               @Z40X9QG 65460009
         LA    R11,AVTOSECB             ASSUME TCAM'S ECB      @Z40X9QG 65520009
         TM    AVTBIT1,AVTREADN         WAS READ ISSUED BY     @Z40X9QG 65580009
*                                       CHECKPOINT QUEUE SCAN  @Z40X9QG 65640009
         BO    QPOST                    NO, BRANCH             @Z40X9QG 65700009
         LA    R11,AVTCKECA             GET CKPT ECB           @Z40X9QG 65760009
         EJECT                                                 @Z40X9QG 65820009
************************************************************** @Z40X9QG 65880009
*                                                            * @Z40X9QG 65940009
* USE 'QUICK POST' TECHNIQUE TO POST ECB                     * @Z40X9QG 66000009
*                                                            * @Z40X9QG 66060009
************************************************************** @Z40X9QG 66120009
QPOST    EQU   *                                               @Z40X9QG 66180009
         L     R14,ZERO(,R11)           GET CONTENTS OF ECB    @Z40X9QG 66240009
         L     R15,POSTBIT              GET COMPLETION BIT AND @Z40X9QG 66300009
*                                       CODE TO BE COMPARED AND@Z40X9QG 66360009
*                                       SWAPPED                @Z40X9QG 66420009
         TM    ZERO(R11),WAITBIT        ECB WAITING            @Z40X9QG 66480009
         BO    POST                     YES, BRANCH            @Z40X9QG 66540009
         CS    R14,R15,ZERO(R11)        DO COMPARE AND SWAP TO @Z40X9QG 66600009
*                                       SET ECB POSTED         @Z40X9QG 66660009
         BZ    EXIT                     BR IF CS SUCCESSFUL    @Z40X9QG 66720009
         SPACE 2                                               @Z40X9QG 66780009
************************************************************** @Z40X9QG 67024009
*                                                            * @Z40X9QG 67026009
* USE BRANCH ENTRY TO POST ECB                               * @Z40X9QG 67028009
*        REGISTER 10 - COMPLETION CODE                       * @Z40X9QG 67030009
*        REGISTER 11 - ADDRESS OF ECB                        * @Z40X9QG 67032009
*        REGISTER 14 - RETURN ADDRESS                        * @Z40X9QG 67034009
*        REGISTER 15 - POST ENTRY POINT                      * @Z40X9QG 67036009
*                                                            * @Z40X9QG 67038009
************************************************************** @Z40X9QG 67040009
POST     EQU   *                                               @Z40X9QG 67050009
         L     R15,CVT0PT01             OS POST ENTRY ADDR              67500020
         SLR   R10,R10                  CLEAR REG 10           @Z40X9QG 67900009
         BALR  R14,R15                  POST TCAM'S ECB TO              68100020
*                                         ACTIVATE TCAM DISPATCHER      68400020
         SPACE 2                                               @Z40X9QG 68500009
************************************************************** @Z40X9QG 68600009
* IF STARTUP IS IN PROGRESS, CHECKPOINT OPEN IS THE ONLY ONE USING      68700020
* CPBS.  IT HAS ISSUED A 'WAIT' ON AVTOSECB AFTER PASSING CPBS TO       69000020
* EXCP DRIVER TO GET I/O STARTED.  WHEN APPENDAGE POSTS AVTOSECB,       69300020
* THIS SATISFIES THE CHECKPOINT OPEN, GIVING IT CONTROL.  IF TCAM       69600020
* IS ACTUALLY RUNNING (NOT A STARTUP SITUATION), THIS POST SATISFIES    69900020
* THE 'WAIT' ISSUED BY THE TCAM DISPATCHER.                             70200020
*                                                                       70500020
************************************************************** @Z40X9QG 70800009
EXIT     EQU   *                                                        72000020
         LM    R0,R15,REGSAVE           RESTORE REGISTERS      @Z40X9QG 72300009
         BR    R14                      EXIT TO IOS                     72900020
*                                                                       73200020
   TITLE '''IGG019R2'' - START I/O APPENDAGE'                           73200309
************************************************************** @Z40X9QG 73200609
*                                                            * @Z40X9QG 73200909
* DESCRIPTIVE NAME - START I/O APPENDAGE                     * @Z40X9QG 73201209
*                                                            * @Z40X9QG 73201509
* FUNCTION - INITIALIZE THE IOSB AND TRANSLATE CCW'S FROM    * @Z40X9QG 73201809
*            VIRTUAL TO REAL                                 * @Z40X9QG 73202109
*                                                            * @Z40X9QG 73202409
* ENTRY POINT  - DISKSIO                                     * @Z40X9QG 73202709
*                                                            * @Z40X9QG 73203009
* INPUT -                                                    * @Z40X9QG 73203309
*        REGISTER 2  - ADDRESS OF IOSB                       * @Z40X9QG 73203609
*        REGISTER 7  - ADDRESS OF IOSBE                      * @Z40X9QG 73203909
*        REGISTER 11 - ADDRESS OF CPB                        * @Z40X9QG 73204209
*        REGISTER 14 - RETURN ADDRESS                        * @Z40X9QG 73204509
*        REGISTER 15 - ENTRY POINT ADDRESS                   * @Z40X9QG 73204809
*                                                            * @Z40X9QG 73205109
* OUTPUT - INITIALIZED IOSB AND TRANSLATED CCW'S. THE        * @Z40X9QG 73205409
*          FOLLOWING ARE USED AS WORK REGISTERS: 1,10,11     * @Z40X9QG 73205709
*                                                            * @Z40X9QG 73206009
* CALLED BY -                                                * @Z40X9QG 73206309
*        IEDQEB   - BEFORE STARTIO MACRO ISSUED              * @Z40X9QG 73206609
*        IGG019R2 - AS SUBROUTINE BEFORE RETURN TO IOS       * @Z40X9QG 73206909
*                   FOR RETRY                                * @Z40X9QG 73207209
*                                                            * @Z40X9QG 73207509
************************************************************** @Z40X9QG 73207809
         SPACE 1                                               @Z40X9QG 73208109
         USING IEDQCPB,RCPB             CPB ADDRESSABILITY     @Z40X9QG 73209009
         USING IOSB,RIOSB               IOSB ADDRESSABILITY    @Z40X9QG 73209809
         USING IOSBE,RIOSBE             IOSBE ADDRESSABILITY   @Z40X9QG 73210609
         EJECT                                                 @Z40X9QG 73211409
************************************************************** @Z40X9QG 73212209
*                                                            * @Z40X9QG 73213009
* INITIALIZE THE IOSB                                        * @Z40X9QG 73213809
*                                                            * @Z40X9QG 73214609
************************************************************** @Z40X9QG 73215409
         SPACE 1                                               @Z40X9QG 73216209
         USING DISKSIO,R15              USE R15 AS BASE        @Z40X9QG 73217009
DISKSIO  EQU   *                                               @Z40X9QG 73217809
         SLR   R1,R1                    CLEAR REGISTER         @Z40X9QG 73218609
         ST    R1,IOSFLA                CLEAR FLAGS            @Z40X9QG 73219409
         MVI   IOSFLA,IOSACHN           SET CHAINING FLAGS     @Z40X9QG 73220209
         MVI   IOSPRLVL,ZERO            CLEAR PRLVL            @VS41093 73221009
         MVI   IOSOPT,IOSTSLL           SET NO LOCK FOR        @Z40X9QG 73221809
*                                       TERMINATION ROUTINE    @Z40X9QG 73222609
         MVI   IOSOPT2,ZERO             CLEAR OPT2             @Z40X9QG 73223409
         ST    R1,IOSAPMSK              CLEAR MASK AND SENSE   @Z40X9QG 73224209
         ST    R1,IOSIPIB               CLEAR IPIB             @Z40X9QG 73225009
         ST    R1,IOSERP                CLEAR ERP WORK AREA    @Z40X9QG 73225809
         STCM  R1,THREE,IOSAFF          CLEAR AFFINITY AND ... @Z40X9QG 73226609
*                                       ... 1ST BYTE OF PATH   @Z40X9QG 73227409
         STH   R1,IOSMDB                CLEAR ERP BYTES        @Z40X9QG 73228209
         MVC   IOSEEK,CPBABSAD          SET MBBCCHHR           @Z40X9QG 73229009
         MVC   IOSEEKA,CPBABSAD         SET MBBCCHHR           @Z40X9QG 73229809
         DROP  RCPB                                            @Z40X9QG 73230609
         EJECT                                                 @Z40X9QG 73231409
************************************************************** @Z40X9QG 73232209
*                                                            * @Z40X9QG 73233009
* TRANSLATE CCW'S FROM VIRTUAL TO REAL ADDRESSES             * @Z40X9QG 73233809
*                                                            * @Z40X9QG 73234609
************************************************************** @Z40X9QG 73235409
         SPACE 1                                               @Z40X9QG 73236209
         USING IEDQCCW,R10              CCW ADDRESSABILITY     @Z40X9QG 73237009
         LA    R10,ZERO(,RCPB)          GET ADDRESS OF         @Z40X9QG 73237809
*                                       CHANNEL PROGRAM        @Z40X9QG 73238609
         ST    R10,IOSVST               SET VIRTUAL ADDRESS OF @Z40X9QG 73239409
*                                       CHANNEL PROGRAM        @Z40X9QG 73240209
         LRA   R1,ZERO(,R10)            CONVERT TO REAL        @Z40X9QG 73241009
         ST    R1,IOSRST                SET REAL CHANNEL       @Z40X9QG 73241809
*                                       PROGRAM ADDRESS        @Z40X9QG 73242609
         SPACE 1                                               @Z40X9QG 73243409
         TM    IOSBEFLG,IOSBECPR        CCW'S REAL             @Z40X9QG 73245009
         BOR   R14                      YES, RETURN TO CALLER  @Z40X9QG 73255009
         OI    IOSBEFLG,IOSBECPR        SET TRANSLATE FLAG     @Z40X9QG 73265009
CONVLOOP EQU   *                                                 X01004 73281005
         ICM   R11,AD,CCWADDR           I/O ADDRESS              X01004 73290005
         LRA   R1,ZERO(,R11)            CONVERT TO REAL        @Z40X9QG 73299009
         STCM  R1,AD,CCWADDR            SET REAL ADDRESS       @Z40X9QG 73308009
         CLI   CCWOPCDE,SM              STATUS MODIFIER EXPECTED X01004 73317005
         BE    STATUSM                  BRAVCH YES               X01004 73326005
         TM    CCWOPCDE,NOTIC            THIS CCW A TIC          X01004 73335005
         BZ    ISATIC                   BRANCH YES               X01004 73344005
         TM    CCWFLAGS,CCWCC+CCWCD     CHAINING FLAGS SET       X01004 73353005
         BCR   NO,R14                   BRANCH NO - END OF CHAIN X01004 73362005
*                                       RETURN TO IOS            X01004 73371005
PLUS8    EQU   *                                                 X01004 73380005
         LA    R10,CCW+EIGHT            BUMP TO NEXT CCW         X01004 73389005
         B     CONVLOOP                 CONTINUE LOOP            X01004 73398005
STATUSM  EQU   *                                                 X01004 73407005
         LA    R10,CCW+EIGHT            BUMP TO TIC              X01004 73416005
         ICM   R11,AD,CCWADDR           TIC TO ADDRESS           X01004 73425005
         LRA   R1,ZERO(,R11)            CONVERT TO REAL        @Z40X9QG 73434009
         STCM  R1,AD,CCWADDR            SET REAL ADDRESS       @Z40X9QG 73443009
         B     PLUS8                    GET NEXT CCW             X01004 73452005
ISATIC   EQU   *                                                 X01004 73461005
         LR    R10,R11                  NEXT CCW IS TIC TO ADDR. X01004 73470005
         B     CONVLOOP                 CONTINUE LOOP            X01004 73479005
*                                                                       73500020
         EJECT                                                 @Z40X9QG 73501009
************************************************************** @Z40X9QG 73502009
*                                                            * @Z40X9QG 73503009
* DATA DEFINITIONS                                           * @Z40X9QG 73504009
*                                                            * @Z40X9QG 73505009
************************************************************** @Z40X9QG 73506009
         SPACE 2                                               @Z40X9QG 73507009
         DS    0F                                              @Z40X9QG 73508009
POSTBIT  DC    X'40000000'              COMPLETION BIT AND CODE@Z40X9QG 73509009
BADCCW   DC    A(CPBABSAD-IEDQCPB)      CPB ADDR OUT OF RANGE    99226  73510022
         SPACE 2                                               @Z40X9QG 73520009
*        ERROR BITS TO CHECK IN CSW                            @Z40X9QG 73521009
ERRBITS  DS    0XL2                     UNIT AND CHANNEL ...   @Z40X9QG 73522009
*                                       ... STATUS BITS        @Z40X9QG 73523009
UNITSTAT DC    XL1'03'                  UNIT STATUS            @Z40X9QG 73524009
*                                        02 - UNIT CHECK       @Z40X9QG 73525009
*                                        01 - UNIT EXCEPTION   @Z40X9QG 73526009
CHANSTAT DC    XL1'7F'                  CHANNEL STATUS         @Z40X9QG 73527009
*                                        40 - INCORRECT LENGTH @Z40X9QG 73528009
*                                        20 - PROGRAM CHECK    @Z40X9QG 73529009
*                                        10 - PROTECTION CHECK @Z40X9QG 73530009
*                                        08 - CHANNEL DATA     @Z40X9QG 73531009
*                                             CHECK            @Z40X9QG 73532009
*                                        04 - CHANNEL CONTROL  @Z40X9QG 73533009
*                                             CHECK            @Z40X9QG 73534009
*                                        02 - INTERFACE        @Z40X9QG 73535009
*                                             CONTROL CHECK    @Z40X9QG 73536009
*                                        01 - CHAINING CHECK   @Z40X9QG 73537009
         SPACE 2                                               @Z40X9QG 73538009
H8       DC    H'8'                     ADJUST PSEUDO CPB REG    S21101 73550021
H16      DC    H'16'                    ADJUST PSEUDO CPB REG    S21101 73600021
         SPACE 1                                               @Z40X9QG 73606009
PATCH    DC    20H'0'                   PATCH AREA             @Z40X9QG 73612009
         SPACE 2                                               @Z40X9QG 73618009
************************************************************** @Z40X9QG 73624009
*                                                            * @Z40X9QG 73630009
*        END OF LOAD MODULE - DO NOT ADD CODE AFTER          * @Z40X9QG 73636009
*        THIS EQUATE                                         * @Z40X9QG 73642009
*                                                            * @Z40X9QG 73648009
************************************************************** @Z40X9QG 73654009
         CNOP  0,8                      ALIGN TO DOUBLEWORD      X02004 73660005
END19R2  EQU   *                        END OF LOAD MODULE       X02004 73720005
         EJECT                                                 @Z40X9QG 73800009
*        DSECT FOR IOS SAVE AREA                               @Z40X9QG 73880009
         SPACE 1                                               @Z40X9QG 73960009
REGSAVE  DSECT                                                          74040009
SAVE0    DS    A                        SAVE AREA FOR REG0     @Z40X9QG 74120009
SAVE1    DS    A                        SAVE AREA FOR REG1     @Z40X9QG 74200009
SAVE2    DS    A                        SAVE AREA FOR REG2     @Z40X9QG 74280009
SAVE3    DS    A                        SAVE AREA FOR REG3     @Z40X9QG 74360009
SAVE4    DS    A                        SAVE AREA FOR REG4     @Z40X9QG 74440009
SAVE5    DS    A                        SAVE AREA FOR REG5     @Z40X9QG 74520009
SAVE6    DS    A                        SAVE AREA FOR REG6     @Z40X9QG 74600009
SAVE7    DS    A                        SAVE AREA FOR REG7     @Z40X9QG 74680009
SAVE8    DS    A                        SAVE AREA FOR REG8     @Z40X9QG 74760009
SAVE9    DS    A                        SAVE AREA FOR REG9     @Z40X9QG 74840009
SAVE10   DS    A                        SAVE AREA FOR REG10    @Z40X9QG 74920009
SAVE11   DS    A                        SAVE AREA FOR REG11    @Z40X9QG 75000009
SAVE12   DS    A                        SAVE AREA FOR REG12    @Z40X9QG 75080009
SAVE13   DS    A                        SAVE AREA FOR REG13    @Z40X9QG 75160009
SAVE14   DS    A                        SAVE AREA FOR REG14    @Z40X9QG 75240009
SAVE15   DS    A                        SAVE AREA FOR REG15    @Z40X9QG 75320009
         SPACE 5                                               @Z40X9QG 75400009
         TIOSBED                                               @OZ26164 75480011
         EJECT                                                 @Z40X9QG 77240009
         IECDIOSB                                              @Z40X9QG 77320009
         EJECT                                                 @Z40X9QG 77400009
         TCPBD 3330                                              99226  77720022
*                                                                99226  77740022
* IN DISK ERROR CONDITIONS, DISK APPENDAGE PASSES ERROR STATUS   99226  77760022
* INFORMATION IN THE CPB AS FOLLOWS                              99226  77780022
*                                                                99226  77800022
         ORG   CPBSEEK                  REDEFINE FROM CPB START  99226  77820022
         DS    A                        RESERVED FOR IEDQRQ      99226  77840022
CPBFLAG3 DS    C                        FROM IOBFLAG3            99226  77860022
CPBCSW   DS    CL7                      FROM IOBCSW              99226  77880022
CPBFLAG1 DS    C                        FROM IOBFLAG1            99226  77900022
CPBFLAG2 DS    C                        FROM IOBFLAG2            99226  77920022
CPBSENS0 DS    C                        FROM IOBSENS0            99226  77940022
CPBSENS1 DS    C                        FROM IOBSENS1            99226  77960022
CPBECBCC DS    C                        FROM IOBECBCC            99226  77980022
CPBUCBID DS    CL3                      FROM UCBNAME             99226  78000022
         EJECT                                                 @Z40X9QG 78050009
         TCCWD                                                          78200005
         EJECT                                                 @Z40X9QG 78250009
         TPRIOR                                                         78300020
         EJECT                                                 @Z40X9QG 78400009
         TQCBD                                                          78600020
         EJECT                                                 @Z40X9QG 78700009
         TAVTD                                                   99226  79200022
         EJECT                                                 @Z40X9QG 79300009
UCB      DSECT                                                   99226  79400022
         IEFUCBOB                                                99226  79600022
         EJECT                                                 @Z40X9QG 79800009
CVT      DSECT                                                          80100020
         CVT                                                            80400020
         EJECT                                                 @Z40X9QG 80450009
         TTCXD                                                          80500006
         SPACE 2                                               @Z40X9QG 80600009
         END                                                            80700020
