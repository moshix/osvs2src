19R6     TITLE '''IGG019R6'' - START-UP MESSAGE ROUTINE'                00050010
IGG019R6 CSECT                                                          00100010
*A-000000-999999                                               @X31X8N0 00107010
         SPACE 3                                                        00114010
*CHANGE ACTIVITY = AS FOLLOWS:                                          00121010
*A277200-277800,373070                                          SA51078 00128010
*A373140-373420                                                 SA50192 00135010
*A137500,176000                                                  S99228 00142010
*A137000,377000,412000,467000,492000,493000                      S21101 00149010
*A245000,462000,4925000                                          S21101 00156010
*C152000,229000,364000,385000,440000,516000                      S21101 00163010
*D329000-331000,335000,345000-349000,413000-439000,524000-525000 S21101 00170010
*D410600,467070-467840                                           S21101 00177010
*C060000-061000,087000                                           S22025 00184010
*A179300                                                         S22026 00191010
*A137500,234000,274000,324000,446000,455000                     SA52971 00198010
*C055000-056000,144000,184000-194000,229000-229900,278000-281000SA52971 00205010
*D146000,156000-159000,160500,218000,238000,245500-246000       SA52971 00212010
*D249000-249600,251000-259000,267000-268000,270000-272000,276000SA52971 00219010
*D283000,332000,334000-338000,342000-344000,351000-361000       SA52971 00226010
*C308000-317000,322000-323200,325000,372500-375000,377500-406000SA52971 00233010
*D367000-371000,410300,454000,457800-458000,478000,480000-483000SA52971 00240010
*C448000-448900,457200,462500-462700,526000-527200              SA52971 00247010
*D486000-491000,493690,494000-514000,533000,535000              SA52971 00254010
*A005000,117000                                                  S21903 00261010
*D006000                                                         S21903 00268010
*A448300                                                        SA58995 00275010
*C446090-446120                                                 SA58995 00282010
*D448500-448600                                                 SA58995 00289010
*A448370                                                        SA59195 00296010
*C002100-002950                                                 SA59195 00303010
*A462000,538000                                                 SA67771 00310010
*A479000                                                        SA68003 00317010
*A493510                                                       @SA70647 00324010
*A164000                                                       @Z30X8NJ 00331010
*C001000-002000,008000                                         @Z30X8NJ 00338010
*C446630                                                       @SA64388 00345010
*A241000,457500                                                @YA07705 00352010
*A240000                                                       @OZ11205 00359010
         SPACE 3                                                        00366010
*********************************************************************** 00400020
*                                                                     * 00500020
*MODULE-NAME = IGG019R6                                          S21903 00600010
*                                                                S21903 00620022
*DESCRIPTIVE-TITLE = START-UP MESSAGE ROUTINE                    S21903 00640010
*                                                                S21903 00660022
*COPYRIGHT = 'NONE'                                              S21903 00680010
*                                                                     * 00700020
*STATUS: CHANGE LEVEL 8                                        @Z30X8NJ 00800010
*                                                                     * 00900020
*FUNCTION:THIS MODULE LOCATES ALL TERMINAL ENTRIES ASSOCIATED WITH A  * 01000010
*   PARTICULAR LCB. THE ADDRESS OF EACH ENTRY AND THE ADDRESS OF ITS  * 01100010
*   OPTION FIELDS(IF PRESENT) ARE PASSED TO A USER EXIT IN A TWO WORD * 01200010
*   PARAMETER LIST. THE ADDRESSES OF THE USER EXITS ARE OPTIONALLY    * 01300010
*   SPECIFIED ON THE READY MACRO. ONE EXIT IS GIVEN CONTROL IF A COLD * 01400010
*   START IS IN EFFECT FOR THE SYSTEM;THE OTHER EXIT IS GIVEN CONTROL * 01500010
*   IF A WARM OR CONTINUATION START IS IN EFFECT. IF THE USER EXIT HAS* 01600010
*   A MESSAGE TO SEND TO THE TERMINAL,IT RETURNS TO THIS MODULE  WITH * 01700010
*   THE ADDRESS OF THE MESSAGE IN REGISTER 1 AND THE LENGTH OF THE    * 01800010
*   MESSAGE IN THE FIRST BYTE OF THE MESSAGE;IF THE USER EXIT DOES NOT* 01900010
*   HAVE A MESSAGE,IT RETURNS WITH ZERO IN REGISTER 1.                * 02000010
*                                                                     * 02100020
*   IF CORE ONLY QUEUES ARE SPECIFIED FOR A PARTICULAR QUEUE,THIS     * 02200010
*   MODULE REMOVES BUFFERS FROM THE AVAILABLE BUFFER QUEUE, BUILDS    * 02300010
*   THE MESSAGE, AND PASSES IT, ONE UNIT AT A TIME, TO THE DESTINA-   * 02400010
*   TION SCHEDULER(IEDQHM02) SO THAT IT CAN BE PUT ON THE DESTINA-    * 02500010
*   TION QCB.  IN THE CORE ONLY SITUATION, THERE WILL NOT BE ANY      * 02600010
*   MESSAGES ALREADY ON THE QUEUE AS A RESULT OF RESTART,SO NO        * 02700010
*   SPECIAL MEASURES HAVE TO BE TAKEN TO ENSURE THAT START-UP         * 02800010
*   MESSAGES ARE ENQUEUED FIRST ON THE DESTINATION QCB.               * 02900010
*                                                                     * 03000020
*   IF DISK QUEUES ARE SPECIFIED FOR A PARTICULAR QUEUE, THIS         * 03100010
*   MODULE REMOVES ONE CPB FROM THE CPB FREEPOOL AND BUILDS THE       * 03200010
*   PROPER NUMBER                                                     * 03300010
*   OF BUFFERS IN A CPB WORK AREA,ONE UNIT AT A TIME. AFTER EACH UNIT * 03400010
*   IS BUILT,IT SETS UP THE CPB AND BRANCHES TO EXCP DRIVER (IEDQFL)  * 03500010
*   TO WRITE THE UNIT ON DISK. THE INTERFACE IS MADE TO LOOK LIKE EXCP* 03600010
*   DRIVER IS GETTING CONTROL FROM THE TCAM DISPATCHER: THE CPB IS PUT* 03700010
*   ON THE INPUT QUEUE(AVTINCPQ),A PRIORITY IS PUT INTO THE CPB CLEAN-* 03800010
*   QCB TO PREVENT THE QCB FROM BEING POSTED TO THE READY QUEUE BY    * 03900010
*   EXCP DRIVER,THE ENTRY POINT FOR IEDQFL IS PUT INTO REGISTER 15,   * 04000010
*   AND THE RETURN ADDRESS FOR THIS MODULE IS PUT IN PLACE OF THE     * 04100010
*   ADDRESS OF THE DISPATCHER (AVTEA). IN THIS MANNER,IEDQFL IS USED  * 04200010
*   AS A SUBROUTINE FOR THIS MODULE. WHEN IEDQFL RETURNS,THIS MODULE  * 04300010
*   WAITS ON THE ECB CALLED AVTOSECB,SO THAT THE I/O WILL BE COMPLETE * 04400010
*   BEFORE ANOTHER BUFFER UNIT IS BUILT.  AFTER ALL UNITS ARE BUILT,  * 04500010
*   THE CPB IS RETURNED TO THE CPB FREEPOOL.                            04600010
*                                                                     * 04700020
*   THIS MODULE ASSIGNS DISK RECORD NUMBERS TO THE BUFFER UNITS BY    * 04800010
*   USING QCBDNHDR AND AVTRADDR OR AVTNADDR IN THE CONVENTIAL MANNER, * 04900010
*   BUT IT PUTS THE MESSAGE AT THE HEAD OF THE FEFO QUEUE (HIGHEST    * 05000010
*   PRIORITY LEVEL) BY MOVING QCBFFEFO INTO THE MESSAGE FEFO CHAIN    * 05100010
*   FIELD AND PUTTING THE NUMBER OF THE MESSAGE INTO QCBFFEFO.        * 05200010
*                                                                     * 05300020
*   AFTER THIS MODULE HAS GONE THROUGH THE TERMNAME TABLE AND         * 05400010
*   PROCESSED ALL TERMINALS, IT                                 SA52971 05500010
*   INCREMENTS THE NUMBER OF LINES PROCESSED (AVTSMCNT) AND COMPARES  * 05600010
*   IT WITH THE NUMBER OF LINES OPENED(AVTLNCNT). IF THEY EQUAL IT    * 05800010
*   RETURNS TO THE DISPATCHER AT DSPDLETE;IF NOT EQUAL, IT RETURNS TO * 05900010
*   THE DISPATCHER AT DSPCHAIN.  IN BOTH CASES THE LCB IS POSTED S22025 06000010
*   TO ITSELF UNLESS THE LINE IS OPENED IDLE.  IN THIS CASE, NO  S22025 06050010
*   ELEMENT IS POSTED.                                           S22025 06100010
*                                                                     * 06200020
*   ONLY SINGLE-TYPE TERMINAL ENTRIES WHOSE LINES ARE OPENED BEFORE   * 06300010
*   READY IS EXECUTED ARE PROCESSED BY THIS MODULE.                   * 06400010
*                                                                     * 06500020
*ENTRY POINT:                                                         * 06505010
*                                                                     * 06700020
*        IGG019R6                                                     * 06800010
*                                                                     * 06900010
*INPUT:REGISTERS 1,13,AND15 CONTAIN THE FOLLOWING:                    * 07000010
*                                                                     * 07100020
*      1-ADDRESS OF AN LCB                                            * 07200010
*      13-ADDRESS OF AVTSAVE2                                         * 07300010
*      15-ADDRESS OF FIRST EXECUTABLE INSTRUCTION FOR THIS MODULE     * 07400010
*         (THE QCB AND STCB ARE LOCATED AT THE BEGINNING OF THE CSECT)* 07500010
*                                                                     * 07600020
*OUTPUT:IF SPECIFIED BY USER EXIT,A MESSAGE IS WRITTEN TO DISK AT THE * 07700010
*   HEAD OF THE FEFO CHAIN.                                           * 07800010
*                                                                     * 07900020
*EXTERNAL ROUTINES:                                                   * 07910010
*                                                                     * 08100020
*        IEDQHM02                                                     * 08200020
*        IGG019RC                                                     * 08300020
*        USER EXIT SPECIFIED ON READY MACRO                           * 08400020
*        IGG019RC-WTORTN-DISK ERROR HANDLING                     99226  08450022
*                                                                     * 08453010
*EXITS-NORMAL:THIS MODULE EXITS TO THE TCAM DISPATCHER AT EITHER      * 08553010
*   DSPCHAIN OR DSPDELETE.  SEE 'FUNCTIONS'                      S22025 08653010
*                                                                     * 08753010
*EXITS-ERROR-BRANCH TO THE WTORTN OF IGG019RC ON DISK ERRORS     99226  08853010
*                                                                     * 08953010
*TABLES/WORK AREAS:                                                   * 09100010
*                                                                     * 09200020
*   AVT(AVTRNMPT,AVTCLRHI,AVTDOUBL,AVTOPTPT,AVTRDYA,AVTBIT2,AVTSAVE4, * 09250010
*      AVTKEYLE,AVTHDRSZ,AVTFCPB,AVTTXTSZ,AVTRADDR,AVTNADDR,AVTLODPT, * 09350010
*      AVTEA,AVTINCPQ,AVTSAVE2,AVTFL,AVTOSECB,AVTDKAPQ,AVTCPBCB,      * 09450010
*      AVTSMCNT,AVTLNCNT)                                             * 09550010
*   LCB                                                               * 09650010
*   TERMNAME TABLE                                                    * 09750010
*   TERMINAL TABLE                                                    * 09850010
*   QCB                                                               * 09950010
*   DCB                                                               * 10050010
*   OPTION TABLE                                                      * 10150010
*   PREFIX                                                            * 10250010
*   DATA AREA OF MESSAGE                                              * 10350010
*   CPB                                                               * 10450010
*   SCB                                                               * 10550010
*                                                                     * 10650010
*ATTRIBUTES:RE-ENTERABLE                                              * 10750010
*                                                                     * 10850010
*NOTES:THE USER EXIT MUST SAVE AND RESTORE REGISTERS FOR THIS MODULE. * 10950010
*                                                                     * 11050010
*NOTES:THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL REPRE-   * 11150010
*   SENTATION OF THE EXTERNAL CHARACTER SET WHICH IS EQUIVALENT TO    * 11250010
*   THE ONE USED AT ASSEMBLY TIME. THE CODING HAS BEEN ARRANGED SO    * 11350010
*   THAT REDEFINITION OF 'CHARACTER' CONSTANTS,BY REASSEMBLY, WILL    * 11450010
*   RESULT IN A CORRECT MODULE FOR THE NEW DEFINITIONS.               * 11550010
*                                                                     * 11700020
*********************************************************************** 11800020
         SPACE 3                                                        11900020
*REGISTER ASSIGNMENTS                                                   12000020
         SPACE                                                          12100020
R0       EQU   0                        REMAINING LENGTH OF USER MSG    12200020
R1       EQU   1                        ADDRESS OF PARM,USER MSG        12300020
R2       EQU   2                        ADDRESS OF IOB-FROM DCB         12400020
R3       EQU   3                        ADDRESS OF SCB                  12500020
R4       EQU   4                        ADDRESS OF LCB                  12600020
R5       EQU   5                        COUNT OF TERM ENTRIES           12700020
R6       EQU   6                        ADDRESS OF PREFIX               12800020
R7       EQU   7                        ADDRESS OF QCB                  12900020
R8       EQU   8                        ADDRESS OF TERM ENTRY           13000020
R9       EQU   9                        DESTINATION TERM OFFSET         13100020
R10      EQU   10                       ADDRESS OF DCB,MOVE INST        13200020
R11      EQU   11                       ADDRESS OF IEDQEA               13300020
R12      EQU   12                       BASE REG                        13400020
R13      EQU   13                       ADDRESS OF AVTSAVE2             13500020
R14      EQU   14                       ADDRESS OF CPB                  13600020
R15      EQU   15                       BRANCH REG                      13700020
         SPACE                                                          13710020
*LOCAL EQUATES                                                   S21101 13720020
         SPACE                                                          13730020
MULT4    EQU   2                        VALUE FOR MULTIPLICATION S21101 13740020
INCR     EQU   4                        INCREMENTAL VALUE        S21101 13750020
OPEN     EQU   X'10'                    DCB OPEN LFAG           SA52971 13751022
SIZESCB  EQU   X'54'                    DUMMY SCB SIZE          SA52971 13752022
CUMASK   EQU   X'01'                    GENERAL POLL CONTROL UNITS99228 13760022
CBRDCST  EQU   X'40'                    BROADCAST DCT BIT        S22027 13763010
TWO      EQU   2                        TWO                             13766010
ONE      EQU   1                        VALUE 1                  S22024 13770022
         SPACE 3                                                        13800020
*COMBINED QCB AND STCB                                                  13900020
         SPACE                                                          14000020
QNCQCB   DC    X'02'                    QCB                             14100022
         DC    XL3'0'                   QCB CONTINUED                   14200022
         DC    F'0'                     QCB CONTINUED                   14300022
QNCSTCB  DC    AL1(DSPMCPL4)            SUBTASK ENTRY CODE       CLUP21 14400022
         DC    AL3(QNCSTCB)             POINTER TO SELF                 14500022
         SPACE 2                                                        14700022
         USING *,R12                    DECLARE                         14800022
         LR    R12,R15                  BASE REG                        14900022
IGG019R6 IEDHJN QNC00                   IDENTIFIER AND DATE      S22026 15000022
         USING AVTSAVE2,R13             USE DISP SAVE AREA AS AVT      X15400020
                                        BASE REG                        15500020
         SPACE                                                          16000020
         L     R9,AVTRNMPT              ADDRESS OF TERMNAME TABLE       16100020
         USING IEDQTNTD,R9                                              16200020
         LH    R5,TNTLEN                NUMBER OF ENTRIES               16300020
         N     R5,AVTCLRHI              CLEAR HIGH ORDER HALF WORD      16400020
         DROP  R9                       DROP BASE FOR TNT      @Z30X8NJ 16450010
         LA    R9,1                     INITIALIZE TERM OFFSET          16500020
         SPACE 3                                                        16600020
*BEGINNING OF LOOP THROUGH TERMNAME TABLE                               16700020
         SPACE                                                          16800020
QNC20    EQU   *                                                        16900020
         LR    R1,R9                    MOVE TERM OFFSET                17000020
         L     R15,AVTRNMPT             ADDRESS OF TERMNAME TABLE       17100020
         BALR  R14,R15                  GET TERM ENTRY ADDRESS          17200020
         LR    R8,R1                    MOVE ADDRESS                    17300020
         USING IEDQTRM,R8               BASE FOR TERMINAL ENTRY         17400020
         TM    TRMDSORG,TRMLGB          IS THIS A 3705 LGB       S22024 17430022
         BO    QNC90                    YES, SKIP THIS ENTRY     S22024 17460022
         TM    TRMSTATE,TRMSNGLE        CHECK TYPE OF TERM ENTRY        17500010
         BNZ   QNC90                    BRANCH IF NOT SINGLE TYPE       17600020
         SPACE                                                          17700020
*CHECK FOR GENERAL POLL CONTROL UNIT ENTRY                       S99228 17709022
*                  NO GOOD MORNING MESSAGE TO CONTROL UNITS      S99228 17718022
         SPACE 1                                                        17727022
         SR    R7,R7                    CLEAR INDEX REGISTER     S99228 17736022
         IC    R7,TRMCHCIN              INSERT DCT ENTRY INDEX   S99228 17745022
         BCTR  R7,R0                    REDUCE FOR ENTRY         S99228 17754022
         MH    R7,AVTDCTLN              MULTIPLY FOR OFFSET    @YM07404 17763010
         A     R7,AVTCSTCS              ADD DCT START ADDR       S99228 17772022
         TM    ONE(R7),CUMASK           CONTROL UNIT ENTRY?      S99228 17781022
         BO    QNC90                    BRANCH YES               S99228 17790022
         L     R7,TRMDESTQ-1            ADDRESS OF QCB                  17800020
         USING IEDQQCB,R7                                               17900020
         TM    QCBDSFLG,QCBDISK+QCBCORE ANY QUEUEING             S22029 17930022
         BZ    QNC90                    BRANCH IF NO             S22029 17960022
         SPACE                                                          18000020
         L     R10,QCBDCBAD-1           ADDRESS OF DCB                  18100020
         USING IHADCB,R10                                               18200020
         TM    TRMSTATE,TRMPREF         3705 RESOURCE          @YM07404 18200710
         BZ    CKOPEN                   NO, CHECK FOR DCB OPEN   S22024 18201410
         LA    R1,IEDQTRM-IEDNTRM       LENGTH OF NEG PREFIX   @YM07404 18202110
         SR    R8,R1                    BACKUP TO NEG PREFIX   @YM07404 18202810
         DROP  R8                                              @YM07404 18203510
         USING IEDNTRM,R8               ADDRESSIBILITY ON PRF  @YM07404 18204210
         CLI   TRMTYPE,TRMLUNT          SNA LU                 @YM07404 18204910
         BE    QNC30                    BR YES, GEN MESSAGE    @YM07404 18205610
         CLI   TRMTYPE,TRMCTERM         DIAL LINE ENTRY        @YM07404 18206310
         BE    QNC30                    BR YES, GEN MESSAGE    @YM07404 18207010
         CLI   TRMTYPE,TRMPSNA          PRE-SNA TERMINAL       @YM07404 18207710
         BE    QNC30                    BR YES, GEN MESSAGE    @YM07404 18208410
         B     QNC90                    BR, DO NOT GEN MESSAGE @YM07404 18209110
QNC30    EQU   *                                               @YM07404 18209810
         AR    R8,R1                    POINT TO TRM PROPER    @YM07404 18210510
         DROP  R8                                              @YM07404 18211210
         USING IEDQTRM,R8               ADDRESSIBILITY ON TRM  @YM07404 18211910
         B     QNC35                    BR TO GEN MESSAGE      @YM07404 18212610
CKOPEN   EQU   *                                                 S22024 18213310
         SPACE                                                          18214010
         TM    DCBOFLGS,OPEN            IS DCB OPEN             SA52971 18214710
         BZ    QNC90                    NO, DON'T GEN MSG       SA52971 18215410
         SPACE 3                                                        18216110
*PASS PARAMETERS TO USER ROUTINE                                        18216810
         SPACE                                                          18217510
QNC35    EQU   *                                               @YM07404 18218210
         ST    R8,AVTDOUBL              ADDR OF TERM ENTRY              19800020
         LH    R1,TRMOPTBL              OPTION TABLE OFFSET             19900020
         N     R1,AVTCLRHI              CLEAR HIGH ORDER HALF WORD      20000020
         A     R1,AVTOPTPT              ADD BEGINNG ADDR OF OPT TBL     20100020
         ST    R1,AVTDOUBL+4            PUT INTO PARM LIST              20200020
         L     R1,AVTRDYA               ADDR OF USER EXITS              20300020
         TM    AVTBIT2,AVTSTRTN         CHECK FOR RESTART               20400020
         L     R15,4(0,R1)              ADDR OF RESTART EXIT            20500020
         BO    QNC40                    BRANCH IF RESTART               20600020
         L     R15,0(0,R1)              ADDR OF GOOD-MORNING EXIT       20700020
QNC40    EQU   *                                                        20800020
         LTR   R15,R15                  CHECK FOR USER EXIT             20900020
         BZ    QNC95                    BRANCH IF NONE                  21000020
         LA    R1,AVTDOUBL              ADDRESS OF PARAMETERS           21100020
         LA    R13,AVTSAVE4             SAVE AREA                       21200020
         BALR  R14,R15                  BRANCH TO USER EXIT             21300020
         LA    R0,AVTSAVE4-AVTSAVE2                                     21400020
         SR    R13,R0                   RESTORE DISPATCHERS SAVE AR     21500020
         LTR   R1,R15                   CHECK FOR MSG TO SEND           21600020
         BZ    QNC90                    BRANCH IF NO MSG                21700020
         SPACE 3                                                        21900020
*BUILD THE FIRST UNIT OF A HEADER BUFFER                                22000020
         SPACE                                                          22100020
         LH    R11,AVTKEYLE             GET KEY (UNIT) LENGTH           22200020
         LA    R10,AVTHDRSZ             GET LENGTH OF HEADER PREFIX     22300020
         SR    R11,R10                  GET DATA LENGTH                 22400020
         IC    R0,0(R1)                 GET LENGTH OF USER MSG          22500020
         LA    R14,1                    CONSTANT                        22600020
         SR    R0,R14                   SUBTRACT FOR LENG FIELD         22700020
         AR    R1,R14                   GET BEGINNING OF TEXT OF MS0601 22800020
         SR    R8,R8                                                    22900022
         LR    R2,R11                   GET LENGTH IF 1ST UNIT          22910022
QNC98    EQU   *                                                        22920022
         LA    R8,1(,R8)                ADD ONE TO COUNT OF UNITS       22930022
         CR    R2,R0                    CHECK FOR END OF MESSAGE        22940022
         BNL   QNC99                    BRANCH IF END OF MESSAGE        22950022
         AH    R2,AVTKEYLE              ADD LENGTH OF BFR -NO PRFIX     22960022
         B     QNC98                    GET NEXT UNIT              1029 22970022
QNC99    EQU   *                                                        22980022
         LR    R2,R0                    GET LENGTH OF PARTIAL BUFFR     22990022
         SPACE 3                                                        23000020
*IF CORE QUEUEING ONLY, GET BUFFER UNIT FOR MESSAGE FROM AVAILABLE      23100020
*BUFFER QUEUE.  FOR DISK QUEUEING, GET CPB AND BUFFER UNIT FROM CPB     23200020
*FREEPOOL.                                                              23300020
         SPACE                                                          23400020
         LA    R10,QNCMOVE1             MOVE 1ST SEGMENT OF MSG         23450022
QNC45    EQU   *                                                        23500020
         USING IEDQPRF,R6                                               23600020
         USING IEDQCPB,R14              BASE FOR CPB                    23700020
         TM    QCBDSFLG,QCBDISK         CHECK FOR DISK QUEUES           23900020
         BNZ   QNC46                    BRANCH IF DISK QUEUES           24000020
         CLC   AVTCADDR,AVTTOTNC        CORE QUEUE FULL        @OZ11205 24030010
         BE    QNC90                    YES,DONT QUEUE         @OZ11205 24060010
         LH    R14,AVTAVFCT             AVAILABLE BUFFER COUNT          24100020
         N     R14,AVTCLRHI             CLEAR HIGH BYTES       @YA07705 24120010
         LTR   R14,R14                  CHECK COUNT                     24200020
         BZ    QNC90                    BRANCH IF NONE AVAILABLE        24300020
         BCTR  R14,0                    SUBTRACT ONE                    24400020
         STH   R14,AVTAVFCT             RESTORE COUNT                   24500020
         L     R6,AVTBFREB              GET BUFFER FROM POOL            24700020
         MVC   AVTBFREB+1(3),5(R6)      MOVE LINK FIELD                 24800020
         ST    R6,AVTDOUBL+4            ADDR OF 1ST UNIT                25000020
         B     QNC51                    BRANCH IF 1ST BUFFER FOR M      26000020
         SPACE 3                                                        26100020
*GET UNIT FOR DISK QUEUEING                                             26200020
         SPACE                                                          26300020
QNC46    EQU   *                                                        26400020
         L     R14,AVTFCPB              GET CPB FROM FREEPOOL           26500020
         L     R6,CPBXREAF              GET I/O AREA(PREFIX)            26900020
QNC51    EQU   *                                                        27300020
         XC    0(AVTHDRSZ+AVTUMALN,R6),0(R6) CLEAR PREFIX IN NEW UN1029 27400020
         CLC   0(6,R10),QNCMOVE2        CHECK FOR 1ST UNIT IN BUFFR     27410022
         BNE   SETPRF                   IF 1ST, SET PREFIX      SA52971 27420022
         MVI   DATFLAGS-IEDQDATA(R6),DATNPRFX SET NO PREFIX     SA52971 27430022
         B     QNC53                    GO MOVE MESSAGE TEXT    SA52971 27440022
         SPACE 1                                                SA52971 27450022
SETPRF   EQU   *                                                SA52971 27460022
         STH   R9,PRFDEST               PUT TERM OFFSET IN PREFIX       27500020
         MVI   PRFSCAN,AVTHDRSZ         SET UP SCAN POINTER-ERRORMG0106 27550020
         STC   R8,PRFNBUNT              PUT UNIT COUNT IN BUFFER        27700020
         TM    QCBDSFLG,QCBDISK         DISK QUEUEING           SA51078 27720022
         BZ    NOPLQCB                  BRANCH IF NO            SA51078 27740022
         MVI   PRFNBUNT,0               SET PRIORITY LEVEL IND  SA51078 27760022
NOPLQCB  EQU   *                                                SA51078 27780022
         LA    R15,AVTHDRSZ(,R2)        SET BUFFER LENGTH       SA52971 27800022
         STH   R15,PRFSIZE              STORE IN PREFIX                 28200020
         SPACE 3                                                        29600020
*MOVE MESSAGE FROM USER AREA TO BUFFER UNIT                             29700020
         SPACE                                                          29800020
QNC53    EQU   *                                                        29900020
         BCTR  R11,0                    SUBTRACT FOR EXECUTE            30400020
         EX    R11,0(R10)               MOVE MSG SEG TO BUFFER UNIT     30500020
         LA    R11,1(,R11)              MAKE UP FOR SUBTRACTION         30600020
         LA    R1,0(R1,R11)             UPDATE MSG ADDRESS         0601 30700020
         SR    R0,R11                   SUB FROM LENGTH TO BE MOVED     30800022
         BP    QNC78                    BRANCH IF REMAINING LENGTH     X30900022
                                        TO BE MOVED IS POSITIVE         31000022
         AR    R11,R0                   RESTORE PARTIAL LENGTH          31100022
QNC78    EQU   *                                                        31300022
         TM    DATFLAGS-IEDQDATA(R6),DATNPRFX FIRST UNIT        SA52971 31350022
         BZ    QNC54                    YES, GO SET IN QCB      SA52971 31400022
         STC   R11,DATCOUNT-IEDQDATA(R6) SET PARTIAL UNIT COUNT SA52971 31450022
         MVC   DATFEFO-IEDQDATA(3,R6),AVTDOUBL+5 ASSUME MO QUEUESA52971 31500022
         TM    QCBDSFLG,QCBDISK         MO QUEUES               SA52971 31550022
         BZ    QNC85                    YES, GO TO ENQUEUE      SA52971 31600022
         MVC   DATFEFO-IEDQDATA(3,R6),CPBADDR+1 SET RECORD NUM  SA52971 31650022
         B     QNC80                    GO ENQUEUE ON DISK      SA52971 31700022
         SPACE 3                                                        31800020
*THIS IS THE FIRST UNIT IN THE BUFFER FOR DISK QUEUES                   31900020
         SPACE                                                          32000020
QNC54    EQU   *                                                        32100020
         LH    R15,QCBMSGCT             INCREMENT COUNT OF MESSAGES     32200022
         LA    R15,1(,R15)              FOR THIS QCB                    32260022
         STH   R15,QCBMSGCT             RESTORE COUNT                   32320022
         TM    QCBDSFLG,QCBDISK         CHECK FOR DISK QUEUES           32400020
         BZ    QNC85                    BR IF MO QUEUES         SA52971 32450022
         LA    R10,AVTNADDR             VALUE OF ADDRESS                32500022
         TM    QCBDSFLG,QCBREUS         CHECK DISK TYPE                 32600020
         BZ    QNC60                    BRANCH IF NON-REUS              32700020
         LA    R10,AVTRADDR             VALUE OF ADDRESS FOR REUS       32800020
QNC60    EQU   *                                                        33300020
         SPACE 3                                                        33900020
*THIS IS THE FIRST UNIT IN THE HEADER BUFFER-DISK QUEUES                34000020
         SPACE                                                          34100020
         MVC   PRFCRCD(3),QCBDNHDR      ASSIGN DISK NO. TO RCD          35000020
         MVC   QCBDNHDR(3),1(R10)       ASSIGN AHEAD FOR NEXT HDR       36200020
         MVC   PRFNHDR(3),QCBDNHDR      CHAIN NEXT HDR                  36300020
         LA    R15,INCR                 ADD 4 TO VALUE OF ADDR   S21101 36400020
         A     R15,0(,R10)              (NADDR OR RADDR)          0601  36500020
         ST    R15,0(,R10)                                         0601 36600020
         MVC   CPBADDR+1(3),PRFCRCD     MOVE NO. OF THIS RECORD         37200020
         MVC   PRFHQBCK(3),QCBQBACK     CHAIN INTO QBACK CHAIN  SA52971 37250022
         MVC   QCBQBACK(3),PRFCRCD                              SA52971 37300022
         MVC   QCBPQBCK,PRFCRCD         UPDATE PRI Q BACK PTR   SA51078 37307022
         NC    QCBPFEFO,QCBPFEFO        START POINT SET         SA50192 37314022
         BNZ   NOTFIRST                 BR YES                  SA50192 37321022
*                                       SET INITIAL FEFO        SA50192 37328022
         OI    DATFLAGS-IEDQDATA(R6),DATIFEFO                   SA50192 37335022
NOTFIRST EQU   *                                                SA50192 37342022
         MVC   DATFEFO-IEDQDATA(3,R6),QCBFFEFO CHAIN ONTO TOP   SA52971 37350022
*                                         OF FEFO CHAIN         SA52971 37400022
         BCT   R8,QNC7105               GET NUM. OF EXTRA UNITS SA52971 37450022
         B     QNC80                    BR IF NO EXTRA UNITS    SA52971 37500022
QNC7105  EQU   *                                                        37600020
         MVC   PRFXTRA(3),1(R10)        ASSIGN DISK NO.S TO EXTRAS      37700020
         SLL   R8,MULT4                 MULTIPLY BY 4           SA52971 37750022
         A     R8,AVTEZERO(,R10)        ADD TO ADDRESS          SA52971 38650022
         ST    R8,AVTEZERO(,R10)        UPDATE ADDRESS          SA52971 39550022
         SPACE 3                                                        40700020
*SET UP CPB FOR DISK EXCP DRIVER TO WRITE MSG OUT TO DISK               40800020
         SPACE                                                          40900020
QNC80    EQU   *                                                        41000020
         MVI   CPBRDWR,CPBWRKC          WRITE KEY,DATA CODE IN 1ST      41100020
         MVI   CPBXDWR,CPBWRC           WRITE DATA CODE IN 2ND CCW      41200020
         BAL   R10,QNC965               BRANCH TO EXCP DRIVER505 S21101 41250020
         LA    R10,INCR                 ADD 4 TO VALUE OF ADDR   S21101 42250020
         A     R10,CPBADDR              GET NEXT SEQUENTIAL RECORD      44100020
         ST    R10,CPBADDR              RESTORE ADDRESS                 44200020
         USING IEDQDATA,R6                                              44300020
         TM    DATFLAGS,DATNPRFX        CHECK FOR PREFIX                44400020
         BO    QNC87                    BRANCH IF NO PREFIX             44500020
         USING IEDQPRF,R6                                               44600020
         NC    QCBFFEFO(3),QCBFFEFO     WILL THIS BE LAST ON CHNSA52971 44603022
         BNZ   NOFLAGS                  NO, SAVED FLAGS ARE OK  SA52971 44606022
         MVC   PRFTIC(1),DATFLAGS-IEDQDATA(R6) PRESERVE FLAGS   SA58995 44609022
NOFLAGS  EQU   *                                                SA52971 44615022
         CLC   QCBPFEFO(3),QCBFFEFO     IS START-SCAN SAME AS   SA52971 44618022
*                                         FIRST TO SEND MSG     SA52971 44621022
         BE    QNC81                    YES, RESET START SCAN   SA52971 44624022
         MVC   DATFLAGS-IEDQDATA(6,R6),QCBDATFL SET TO CHAIN    SA52971 44627022
         MVC   CPBADDR+1(3),QCBPFEFO    SET RECORD TO WRITE     SA52971 44630022
         CLC   QCBPFEFO(3),QCBLFEFO     IS THIS ALSO LAST ON CHNSA52971 44636022
         BE    NOREAD                   YES, WE HAVE SAVED INFO SA52971 44639022
         MVI   CPBRDWR,CPBRDC           SET TO READ DATA FIELDS SA52971 44642022
         MVI   CPBXDWR,CPBNOPC            ONLY                  SA52971 44643022
         BAL   R10,QNC965               GO EXECUTE DISK I/O     SA52971 44645022
NOREAD   EQU   *                                                SA52971 44648022
         MVC   DATFEFO-IEDQDATA(3,R6),PRFCRCD RS/GM MSG FROM    SA52971 44651022
*                                         PFEFO                 SA52971 44654022
         MVI   CPBRDWR,CPBWRC           SET TO WRITE DATA FIELD SA52971 44657022
         MVI   CPBXDWR,CPBNOPC            ONLY                  SA52971 44658022
         BAL   R10,QNC965               GO CHECK 1ST FEFO       SA52971 44660022
*        B     QNC83   FOR CASE WHERE SEQUENCE NUMBER IS       @SA64388 44663010
*        RESEQUENCED AT WARM START THIS PROVIDES CORRECT NO.   @SA64388 44664010
         SPACE  1                                               SA52971 44666022
QNC81    EQU   *                                                SA52971 44669022
         MVC   QCBPFEFO(3),PRFCRCD      RESET START SCAN AND    SA52971 44672022
         MVC   QCBPREVF(3),PRFCRCD      SHUFFLE SPOTS           SA52971 44675022
QNC83    EQU   *                                                SA52971 44685010
         MVC   CPBADDR+1(3),PRFXTRA     RECORD NO. FOR 1ST XTRA UNT     44700020
         NC    QCBFFEFO(3),QCBFFEFO     IS THERE A FIRST TO     SA52971 44800022
*              SND MSG                                          SA52971 44810022
         BNZ   QNC84                    YES, DON'T BOTHER LFEFO SA52971 44820022
         MVC   QCBLFEFO(3),PRFCRCD      SET AS 'LAST-TO-SEND'   SA52971 44830022
         MVC   QCBDATFL(1),PRFTIC       PRESERVE FLAGS          SA58995 44835022
         XC    QCBDATSQ,QCBDATSQ        CLEAR OUT SEQ NUMBER    SA59195 44837022
QNC84    EQU   *                                                SA52971 44840022
         MVC   QCBFFEFO(3),PRFCRCD      SET AS FIRST TO SEND    SA52971 44870022
         B     QNC87                    GO GET NEXT UNIT        SA52971 44880022
         SPACE 3                                                        44900020
*BRANCH TO DESTINATION SCHEDULER (IEDQHM02) TO TAKE CARE OF CORE        45000020
*QUEUES                                                                 45100020
         SPACE                                                          45200020
QNC85    EQU   *                                                        45300020
         TM    DATFLAGS-IEDQDATA(R6),DATNPRFX IS THIS 1ST UNIT  SA52971 45304022
         BO    NOGTMN                   NO, SCB IS INITIALIZED  SA52971 45324022
         XC    AVTSAVE3+4(SIZESCB),AVTSAVE3+4 CLEAR SCB         SA52971 45344022
         LA    R3,AVTSAVE3+4            SET SCB REG             SA52971 45364022
         MVC   AVTDOUBL+1(3),QCBLFEFO   LAST MSG ON CORE QUEUE     0601 45400022
         L     R15,AVTDOUBL             LAST MSG ON CORE QUEUE     0601 45410022
         LA    R15,0(,R15)              CLEAR HIGH ORDER BYTE      0601 45420022
         LTR   R15,R15                  CHECK FOR EMPTY QUEUE      0601 45430022
         BNZ   QNC4505                  BRANCH IF NOT EMPTY        0601 45440022
         LA    R15,QCBFFEFO-(DATFEFO-IEDQDATA) POSITION FOR RCD ADD0601 45450022
QNC4505  EQU   *                                                   0601 45460022
         MVC   DATFEFO-IEDQDATA(3,R15),AVTDOUBL+5  PUT BFR ON QUEUE0601 45470022
         MVC   QCBLFEFO,AVTDOUBL+5      INDICATE BFR AS LAST ON QUE0601 45480022
NOGTMN   EQU   *                                                SA52971 45490022
         LA    R8,IEDQPQCB              ADDR OF PRIORITY QCB FOR HM0601 45500020
         L     R15,AVTHM02              GET ADDRESS OF IEDQHM02         45600020
         BALR  R14,R15                  BRANCH                          45700020
         LTR   R15,R15                  CHECK FOR RETURNED UNIT    1029 45710020
         BZ    QNC87                    IF NONE, DON'T RE-POOL  SA52971 45720022
NOCORE   EQU   *                                                SA52971 45725010
         MVC   5(3,R15),AVTBFREB+1      LINK FIELD -BFR UNIT       1029 45730020
         ST    R15,AVTBFREB             RETURN BFR TO FREE POOL    1029 45740020
         LH    R15,AVTAVFCT             GET BUFFER COUNT           1029 45750020
         N     R15,AVTCLRHI             CLEAR HIGH BYTES       @YA07705 45752010
         LA    R15,1(,R15)              ADD 1 TO COUNT OF AVAILABLE1029 45760020
         STH   R15,AVTAVFCT             RESTORE COUNT              1029 45770020
         SPACE 3                                                        45900020
*CHECK FOR END OF MESSAGE                                               46000020
         SPACE                                                          46100020
QNC87    EQU   *                                                        46200020
         TM    QCBDSFLG,QCBDISK         DISK QUEUING USED       SA67771 46206005
         BNZ   QNC88                    YES, BRANCH             SA67771 46212005
         USING IEDQSCB,R3               BASE FOR SCB            SA67771 46218005
         NC    SCBCCHDR,SCBCCHDR        WAS MSMAX EXCEEDED      SA67771 46224005
         BZ    QNC90                    YES, DO NOT QUEUE OTHER SA67771 46230005
*                                         UNITS                 SA67771 46236005
QNC88    EQU   *                                                SA67771 46242005
         LA    R10,QNCMOVE2             MOVE INSTR                      46250022
         LH    R11,AVTKEYLE             GET UNIT SIZE FOR NEXT  SA52971 46260022
*                                         MOVE                  SA52971 46270022
         LTR   R0,R0                    CHECK FOR END OF MESSAGE        46300020
         BP    QNC45                    BRANCH IF NOT END OF MESSAGE    46400020
         SPACE                                                          46500020
*END OF LOOP FOR THIS MESSAGE                                           46600020
         SPACE 3                                                        46700020
         USING IEDQPRF,R6               BASE FOR PREFIX     0510 S21101 46791020
QNC90    EQU   *                                                        46800020
         LA    R9,1(,R9)                GET NEXT OFFSET                 46900020
         CR    R9,R5                    CHECK FOR END OF TERM TABLE     47000020
         BNH   QNC20                    BRANCH IF NOT END OF TABLE      47100020
         SPACE                                                          47200020
*END OF LOOP THROUGH TERMNAME TABLE                                     47300020
         SPACE 3                                                        47400020
* MOVE CODE TO THE AVT TO DELETE THIS MODULE AND RETURN TO THE          47450010
* DISPATCHER.                                                           47500010
         SPACE 1                                                 X03039 47700010
QNC95    EQU   *                                                 X03039 47900010
         L     R11,AVTEA                DISPATCHER ENTRY POINT   X03039 48100010
         MVC   AVTSAVE3+4(MOVELEN),DELSTART MOVE CODE TO DELETE  X03039 48400010
         LA    R14,AVTSAVE3+4           BASE FOR DELETE CODE     X03039 48500010
         BR    R14                      BRANCH TO DELETE         X03039 48800010
         SPACE 3                                                        49210020
*SUBROUTINE TO BRANCH TO EXCP DRIVER TO ACCESS MESSAGE QUEUE0510 S21101 49220020
*DATA SET ON DISK                                           0510 S21101 49230020
         SPACE                                                          49240020
QNC965   EQU   *                                            0510 S21101 49250020
         MVC   AVTFCPB+1(3),CPBNEXT     DELINK CPB FROM FREE POOLS21101 49260020
         SPACE 3                                                        49300020
         L     R8,AVTEA                 SAVE ADDRESS OF DISPATCHER      49303020
         XC    CPBNEXT,CPBNEXT          CLEAR LINK FIELD                49306020
         ST    R14,AVTINCPQ+4           PUT CPB IN INPUT QUEUE          49309020
         MVC   AVTINCPQ+1(3),AVTINCPQ+5                                 49312020
         STM   R14,R12,AVTSAVE3+12      SAVE REGS                       49315020
         MVI   AVTOSECB,0               CLEAR POST BIT                  49318020
         L     R15,AVTFL                ADDR OF EXCP DRIVER             49321020
         LA    R14,QNC82-(DSPDISP-IEDQDISP)                             49324020
         ST    R14,AVTEA                SET UP RETURN ADDRESS           49327020
         MVI   AVTCPBCB+4,X'FF'         PUT DUMMY PRIORITY INTO        X49330020
                                        CPB CLEANUP QCB TO PREVENT     X49333020
                                        CPB FROM BEING POSTED           49336020
         BR    R15                      BRANCH TO EXCP DRIVER           49339020
QNC82    EQU   *                                                        49342020
         WAIT  ECB=AVTOSECB             WAIT FOR COMPLETION OF I/O      49345020
         LM    R14,R12,AVTSAVE3+12      RESTORE REGS                    49348020
         MVI   AVTOSECB,0               CLEAR ECB                       49351020
         B     SKIPPOST                 SKIP CODE TO POST      @SA70647 49351210
*                                        THRESH CLOSE ELEMENT  @SA70647 49351410
OFFPOST  EQU   X'18'                    OFFSET FROM DSPDISP    @SA70647 49351610
*                                       TO DSPPOST             @SA70647 49351810
         ORG   QNC82+OFFPOST            ENTRY POINT IF BRANCH  @SA70647 49352010
*                                        FROM EXCP DRIVER IS   @SA70647 49352210
*                                        TO DSPPOST            @SA70647 49352410
         LM    R14,R12,AVTSAVE3+12      RESTORE REGISTERS      @SA70647 49352610
         LR    R11,R8                   SET DISPATCHER BASE    @SA70647 49352810
         LA    R1,AVTHRESE              GET ADDR OF THRESHOLD  @SA70647 49353010
*                                        CLOSEDOWN ELEMENT     @SA70647 49353210
         BAL   R14,DSPPOSTR-IEDQDISP(R11) POST TO OP CONTROL   @SA70647 49353310
         B     QNC82                    WAIT FOR I/O           @SA70647 49353410
SKIPPOST EQU   *                                               @SA70647 49353810
         NC    AVTDKAPQ+1(3),AVTDKAPQ+1 CHECK Q FROM DISK APPENDAGE     49354020
         BZ    QNC82                    BRANCH IF INTERRUPT WAS        X49357020
                                        LINE END APPENDAGE NOT DISK     49360020
         XC    AVTDKAPQ+1(3),AVTDKAPQ+1 CLEAR CPB FROM QUEUE WHERE     X49363020
                                        IT WAS PUT BY DISK END APND     49366020
         ST    R8,AVTEA                 RESTORE ADDR OF DISPATCHER      49372020
         EJECT ,                                                 99226  49372122
*                                                                99226  49372222
* WHEN THE CPB COMES BACK FROM APPENDAGE, A TEST IS MADE TO      99226  49372322
* DETERMINE IF THERE WAS A DISK ERROR . IF SO IT PICKS UP A      99226  49372422
* WTO ROUTINE IN IGG019RC TO HANDLE IT.                          99226  49372522
*                                                                99226  49372622
CPBER    EQU   X'01'                    CPB FLAG FROM DISK ERROR 99226  49372722
         TM    CPBFLAG,CPBER            DID CPB HAVE I/O ERROR   99226  49372822
         BZ    GOODCPB                    NO, GOOD CPB           99226  49372922
*                                         YES, I/O ERROR         99226  49373022
         LR    R7,R14                   GET CPB FOR WTO          99226  49373122
         L     R15,AVTFL                GET ADDRESS OF IGG019RC  99226  49373222
         L     R15,4(,R15)              GET 2ND WORD OF RC       99226  49373322
         BALR  R14,R15                  CALL DISK ERROR WTO RTN  99226  49373422
*                                                                99226  49373522
         LM    R14,R12,AVTSAVE3+12      RESTORE SYS REGS         99226  49373622
GOODCPB  EQU   *                                                 99226  49373722
         MVI   AVTCPBCB+4,0             CLEAR DUMMY PRIORITY            49375020
         MVC   CPBNEXT,AVTFCPB+1        RESTORE LINK FIELD              49378020
         MVC   AVTFCPB+1(3),AVTSAVE3+13 PUT CPB BACK ON QUEUE           49381020
         BR    R10                      RETURN FROM SUBROUTINE          51500022
         SPACE                                                          51700020
*END OF SUBROUTINE                                                      51800020
         SPACE 3                                                        51900020
QNCMOVE1 MVC   PRFSHDR(0),0(R1)         MOVE MSG SEGMENT TO HEADER 0601X52000020
                                        PREFIX                          52100020
QNCMOVE2 MVC   PRFSUNIT(0),0(R1)        MOVE MSG SEGMENT TO UNIT   0601X52200020
                                        WHICH DOES NOT CONTAIN PRFX     52300020
* THIS CODE IS EXECUTED FROM THE AVT AND REQUIRES THAT THE BASE         52500010
* REGISTER BE CHANGED, THEREFORE IT SHOULD ALWAYS BE LOCATED AFTER      52750010
* DATA AREAS AND CONSTANTS.                                             52756010
DELSTART EQU   *                                                 X03039 52762010
         USING IEDQDISP,R11             BASE FOR DISPATCHER      X03039 52770010
         USING *,R14                    BASE FOR DELETE CODE     X03039 52800010
         DELETE EP=IGG019R6             DELETE STARTUP MSG RTN   X03039 52830010
         B     DSPDISP                  DISPATCH NEXT SUBTASK    X03039 52860010
MOVELEN  EQU   *-DELSTART               LENGTH OF CODE           X03039 52890010
         EJECT                                                          52920010
         SPACE 3                                                        52950010
         TAVTD                                                          53000020
         EJECT                                                          53050010
         TTRMD                                                          53100020
         EJECT                                                          53150010
         TTNTD                                                          53200020
         EJECT                                                          53250010
         TLCBD                                                          53300010
         EJECT                                                          53350010
         DCBD  DSORG=TX                                                 53400020
         EJECT                                                          53460022
         TLGBD                                                          53500010
         EJECT                                                          53540010
         TPRFD                                                          53600020
         EJECT                                                          53650010
         TDISPD                                                         53700020
         EJECT                                                          53750010
         TQCBD                                                          53800020
         EJECT                                                          53820010
         TSCBD                                                  SA67771 53850005
         EJECT                                                          53870010
         TPRIOR                                                         53910010
         EJECT                                                          53950010
         TCPBD 3330                     MERLIN VERSION             0421 54000000
         EJECT                                                          54050010
         TDATAD                                                         54100020
         END                                                            54200020
