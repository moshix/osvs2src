RC TITLE '''IGG019RC'' - EXCP DRIVER'                                   00100020
IGG019RC CSECT                                                          00200020
*A155150,155930,175000,636000,644000,939000                      S21101 00220020
*C115000-130000,155120,168000,371000,604000,613000-615000,625000 S21101 00240020
*C646000,778000,798000,926000                                    S21101 00260020
*D171000-173000,587000-592000                                    S21101 00280020
*C167000,216000,217000,225000,226000,322000,376000,433000,475000 S22025 00285022
*C484000,519000,645000,647000,872000,891000                      S22025 00290022
*D551000,552000,910000                                           S22025 00295022
*C654000                                                         S21903 00297022
*A155950,624270,625080,649000                                    X01004 00297104
*C055000,079000,109000-114000,155110,174000-175400,188000-190000,X01004 00297204
*C210000-212000,219000-221000,339000,397000-399000,603100,636300 X01004 00297304
*D625050,644600                                                  X01004 00297404
*D650840                                                       @XA06323 00297561
*A650920                                                       @XA06323 00297661
*A469000,456000                                                @SA71677 00297761
*A048000,155100,155960,201000,209000,235000,266000,323000      @Z40X9QG 00297809
*A342000,355000,433000,438000,464000,484000,496000,519000      @Z40X9QG 00297909
*A551400,552500,584000,608000,616000,624360,625590,652080      @Z40X9QG 00298009
*A655000,739000,768000,815000,847000,897000,903200,925000      @Z40X9QG 00298109
*A926000,926240,930000,935000,935600,936200,937000,939000      @Z40X9QG 00298209
*A939200,939400                                                @Z40X9QG 00298309
*C004000,006000,010000,011000,031000.032000,055000,079000      @Z40X9QG 00298409
*C225000,265000,267000,273000,281000,286000,298000,299000      @Z40X9QG 00298509
*C305000,306000,307800,312000,314200-315000,317000,318000      @Z40X9QG 00298609
*C321000,322000,325000,346000,351000,366000,370000             @Z40X9QG 00298709
*C372000,380000,386000,387000,389000,391000,398000,410000      @Z40X9QG 00298809
*C480000,481000,482000,624090-624180,650600,893000,931000      @Z40X9QG 00298909
*D003000,046000-047000,155120-155130,155330,155510,214000      @Z40X9QG 00299009
*D223000,295000,319000,328000,329000-339000                    @Z40X9QG 00299109
*C277000,320000,344000,931000-933100                           @OZ26164 00349111
         EJECT                                                 @Z40X9QG 00400009
************************************************************** @Z40X9QG 00410009
*                                                            * @Z40X9QG 00420009
*MODULE NAME - IGG019RC                                        @Z40X9QG 00430009
*                                                              @Z40X9QG 00440009
*DESCRIPTIVE NAME - EXCP DRIVER                                @Z40X9QG 00450009
*                                                                     * 00500020
*STATUS - CHANGE LEVEL 9                                       @Z40X9QG 00600009
*                                                                     * 00700020
*FUNCTION--THIS MODULE TAKES THE CPBS BEGUN BY IEDQFA,                * 00800020
*   CHAINS THEM IN PROPER SEQUENCE, ADDS SEEK AND SEARCH-TIC CCWS     * 00900020
*   WHERE NECESSARY, CALLS IEDQEB VIA SVC 102 TO REQUEST THAT  @Z40X9QG 01000009
*   IOS BE CALLED VIA MACRO TO START DISK I/O,PASSES ADDITIONAL@Z40X9QG 01100009
*   CPBS TO THE IOB FOR DISK END APPENDAGE TO RETRY, AND RETURNS TO   * 01200020
*   THE DISPATCHER, ENDING DISK I/O SUBTASK.                          * 01300020
*                                                                99226  01310022
*   A ROUTINE ALSO RESIDES HERE WHICH WRITES A MESSAGE TO THE    99226  01320022
*   OPERATOR IN THE EVENT OF DISK ERROR                          99226  01330022
*   A DISK WRITE ERROR REQUESTS A QUICK CLOSEDOWN                99226  01340022
*   A DISK READ ERROR ISSUES AN ABEND                            99226  01350022
*                                                                99226  01360022
*                                                                     * 01400020
*ENTRY POINTS--ONLY ONE ENTRY, CALL BY IEDQFA                         * 01500020
*        'IGG019RC' - START DISK I/O                                  * 01600020
*        CALLING SEQUENCE --                                          * 01700020
*        L     15,IEDFL IEDFL IS TAG OF WORD CONTAINING ADDR OF       * 01800020
*                       IGG019RC                                      * 01900020
*        BR    15                                                     * 02000020
*                                                                     * 02100020
*INPUT--THERE ARE THREE TYPES OF INPUT--REGISTERS, AVT CONSTANTS, AND * 02200020
*   THE CPBS PREPARED BY IEDQFA                                       * 02300020
*   REGISTER INPUT -                                                  * 02400020
*   R15 HAD ADDRESS OF ENTRY POINT                                    * 02500020
*   R13 HAS ADDRESS OF AVTSAVE2                                       * 02600020
*                                                                     * 02700020
*   AVT CONSTANTS -                                                   * 02800020
*   AVTINCPQ HAS CHAIN OF CPBS PREPARED BY IEDQFA TO BE PROCESSED     * 02900020
*   BY EXCP DRIVER.                                                   * 03000020
*   AVTIOBR HAS ADDRESS OF REUSABLE DISK QUEUES IOSBE'S        @Z40X9QG 03100009
*   AVTIOBN HAS ADDRESS OF NON-REUSABLE DISK QUEUES IOSBE'S    @Z40X9QG 03200009
*   AVTFO HAS ADDRESS OF FIFO Q MANAGER                               * 03300020
*   AVTDSKCT HAS NUMBER OF WRITING CPBS, BUMPED BY IEDQFL             * 03400020
*                                                                     * 03500020
*   CPB FIELDS EXPECTED TO BE ALREADY DONE.                           * 03600020
*   CPBRDWR HAS READ OR WRITE CCW COMMAND CODE.                       * 03700020
*   CPBXDWR MAY BE NO-OP, READ, OR WRITE CCW COMMAND CODE.            * 03800020
*   CPBXREA HAS ADDR OF UNIT OF BUFFER (DATA PORTION).                * 03900020
*   CPNEXT POINTS TO THE NEXT CPB ON THE AVTINCPQ (OR ZERO).          * 04000020
*   CPBFLAG INDICATES REUSABLE OR NON-REUSABLE DISK MSG QUEUE.        * 04100020
*   CPBADDR HAS ABSOLUTE NUMBER OF DISK RECORD TO BE CONVERTED TO     * 04200020
*   MBBCCHHR.  THIS VALUE CAME FROM AVTNADDR OR AVTRADDR.             * 04300020
*   OTHER FIELDS IN CPB ARE IGNORED.                                  * 04400020
*                                                                     * 04500020
*OUTPUT--                                                             * 04800020
*   AVTINCPQ IS EMPTIED                                        @Z40X9QG 04850009
*   ALL CPBS ARE BUILT AND CHAINED.                                   * 04900020
*   EXCP HAS BEEN DONE ON ALL EXTENTS FOR WHICH THERE ARE CPBS.       * 05000020
*   AVTDSKCT HAS BEEN BUMPED 1 FOR EACH WRITING CPB THAT HAS AT       * 05100020
*   LEAST REACHED THE RETQ.                                           * 05200020
*                                                                     * 05300020
*EXTERNAL ROUTINES--                                                  * 05400020
*   AQCTL (SVC 102) TO REQUEST STARTIO MACRO                   @Z40X9QG 05500009
*                                                                     * 05600020
*EXITS-NORMAL -- AN EXIT IS MADE TO THE DISPATCHER WITH R11 HAVING    * 05700020
*   CONTENTS OF AVTEA AND R13 POINTING TO AVTSAVE2.                   * 05800020
*                                                                     * 05900020
*   IF STARTUP IS IN PROGRESS, CHECKPOINT OPEN HAS MODIFIED AVTEA     * 06000020
*   SO EXCP DRIVER ACTUALLY RETURNS TO OPEN.                          * 06100020
*                                                                     * 06200020
*EXITS-ERROR--N/A.                                                    * 06300020
*                                                                     * 06400020
*TABLES/WORK AREAS-                                                   * 06500020
*   FOLLOWING MACROS ARE USED TO GENERATE DSECTS-TIOBD,TDEBD,TCPBD,   * 06600020
*   TAVTD,TDISPD.  CPB AND AVT FIELDS USED DESCRIBED UNDER 'INPUT'.   * 06700020
*                                                                     * 06800020
*ATTRIBUTES -- RESIDENT, REUSABLE, REFRESHABLE                        * 06900020
*   PROBLEM PROGRAM MODE                                              * 07000020
*                                                                     * 07100020
*NOTES -- THE OPERATION OF THIS SUBROUTINE DEPENDS UPON AN INTERNAL   * 07200020
*   REPRESENTATION OF THE EXTERNAL CHARACTER SET WHICH IS EQUIVALENT  * 07300020
*   TO THE ONE USED AT ASSEMBLY TIME.  THE CODING HAS BEEN ARRANGED   * 07400020
*   SO THAT REDIFINITION OF 'CHARACTER' CONSTANTS, BY REASSEMBLY,     * 07500020
*   WILL RESULT IN A CORRECT MODULE FOR THE NEW DEFINITIONS.          * 07600020
*                                                                     * 07700020
*   THERE ARE THREE MAJOR STEPS IN THIS ROUTINE--INSERTION BY CC      * 07800020
*   PRIORITY, OPTIMIZE DISK CHANNEL PROGRAM, AND AQCTL.        @Z40X9QG 07900009
*                                                                     * 08000020
*   INSERT--TAKE EACH CPB FROM INPUT Q (AVTINCPQ),CONVERT CPBADDR     * 08100020
*   TO MBBCCHHR ABSOLUTE ADDRESS.   USE 'M' AS SEARCH INDEX, FIND     * 08200020
*   APPROPRIATE IOB FOR THIS EXTENT.  SEARCH NEWQ OF THIS IOB, USING  * 08300020
*   'CC' AS ARGUMENT TO FIND PROPER PLACE FOR NEW CPB.  ORDERING IS   * 08400020
*   FIFO PER CYLINDER, BUT CYLINDERS ARE ORDER WITH CURRENT ARM       * 08500020
*   POSITION AS HIGHEST PRIORITY.                                     * 08600020
*                                                                     * 08700020
*   OPTIMIZE--THE NEW CPB IS COMPARED WITH THE PREVIOUS CPB ON THE    * 08800020
*   NEWQ CHAIN.  5 CONDITIONS ARE RECOGNIZED, AND ACCORDINGLY ONE     * 08900020
*   OF THREE TYPES OF CPBS IS BUILT INTO NEW CPB.                     * 09000020
*   CONDITION--                                      CPB TYPE--       * 09100020
*   1.  THERE IS NO PREVIOUS CPB                        MEDIUM        * 09200020
*   2.  PREVIOUS CPB IS FOR A DIFFERENT CC.             MEDIUM        * 09300020
*   3.  PREVIOUS CPB IS FOR SAME CC, BUT DIFFERENT HH.  LARGE         * 09400020
*   4.  PREVIOUS CPB IS FOR TRACK, BUT ITS RECORD                     * 09500020
*   IS NOT THE ONE IMMEDIATELY PRECEEDING THE RECORD                  * 09600020
*   OF THE NEW CPB.                                     MEDIUM        * 09700020
*   5.  PREVIOUS CPB IS FOR THE RECORD IMMEDIATELY                    * 09800020
*   PRECEEDING THE RECORD OF THE NEW CPB. (READ ONLY)   SMALL         * 09900020
*                                                                     * 10000020
*   LARGE CPB STARTS WITH SEEK, SEARCH, AND TIC CCWS.  IT IS          * 10100020
*   USED TO CHANGE HEADS ON SAME CYLINDER ONLY.                       * 10200020
*   MEDIUM CPB STARTS WITH SEARCH AND TIC CCWS.  IT IS USED TO        * 10300020
*   ACCESS NON-SEQUENTIAL RECORDS ON THE SAME TRACK AS THE PREVIOUS   * 10400020
*   CPB.  ALSO USED TO START NEW CHANNEL PROGRAM ON A NEW CYLINDER.   * 10500020
*   SMALL CPB HAS ONLY READ/WRITE CCWS.  IT IS USED FOR ACCESSING     * 10600020
*   SEQUENTIAL RECORDS ON ONE TRACK ONLY.                             * 10700020
*                                                                     * 10800020
*   AQCTL - AFTER ALL CPBS HAVE BEEN BUILT ONTO NEW Q, EACH    @Z40X9QG 10900009
*   IOSBE IS CHECKED FOR CPB'S AVAILABLE. IF THE               @Z40X9QG 10950009
*   RETRY QUEUE HAS SOME AND THE IOSBE IS READY FOR I/O,       @Z40X9QG 11000009
*   SHIFT RETRY QUEUE CPB'S TO IOSVST AND SHIFT ONE CYLINDER   @Z40X9QG 11050009
*   OF CPB'S FROM NEW QUEUE TO RETRY QUEUE. ISSUE SVC 102      @Z40X9QG 11100009
*   TO HAVE I/O STARTED. WHEN ALL EXTENTS WITH CPB'S ARE       @Z40X9QG 11150009
*   RUNNING, RETURN TO TCAM DISPATCHER.                        @Z40X9QG 11200009
*                                                            * @Z40X9QG 11250009
************************************************************** @Z40X9QG 11300009
         EJECT                                                 @Z40X9QG 11350009
R15      EQU   15                       ENTRY ADDRESS, WORK REG  S21101 11460021
R14      EQU   14                       RETURN ADDR FROM INTERNALS21101 11520021
*                                         SUBROUTINE, WORK REG   S21101 11580021
R13      EQU   13                       SAVEAREA ADDRESS         S21101 11640021
R12      EQU   12                       UNUSED BY THIS NAME      S21101 11700021
R11      EQU   11                       DISPATCHER ADDRESS       S21101 11760021
R10      EQU   10                       UNUSED BY THIS NAME      S21101 11820021
R9       EQU   9                        UNUSED BY THIS NAME      S21101 11880021
R8       EQU   8                        NUMBER OF EXTENTS        S21101 11940021
R7       EQU   7                        UNUSED BY THIS NAME      S21101 12000021
R6       EQU   6                        RETURN ADDR FROM INTERNALS21101 12060021
*                                         ROUTINES               S21101 12120021
R5       EQU   5                        UNUSED BY THIS NAME      S21101 12180021
R4       EQU   4                        UNUSED BY THIS NAME      S21101 12240021
R3       EQU   3                        WORK REG                 S21101 12300021
R2       EQU   2                        WORK REG, DCB,DEB,       S21101 12360021
*                                         UCB ADDRS              S21101 12420021
*                                         PARM PASSER TO SECTOR  S21101 12480021
*                                         CONVERT ROUTINE        S21101 12540021
R1       EQU   1                        WORK REG, PARAMETER PASS S21101 12600021
R0       EQU   0                        WORK REG, PARAMETER PASS S21101 12660021
*                                         TO SECTOR CONVERT      S21101 12720021
*                                         ROUTINE                S21101 12780021
*                                                                S21101 12840021
RM       EQU   15                       M OF MBBCCHHR (EXTENT)          13100020
RCC      EQU   15                       CYLINDER ID FROM CPB BEING      13200020
*                                         ADDED TO NEWQ                 13300020
RIOBINDX EQU   14                       HAS SIZE OF AN IOB              13400020
RAVT     EQU   13                       AVT DSECT BASE                  13500020
RBASE    EQU   12                       PROGRAM BASE                    13600020
RIOSBE   EQU   11                       BASE OF IOSBE DSECT    @Z40X9QG 13700009
RDUMCPB  EQU   10                       MODIFIED POINTER TO NEW CPB     13800020
RNEXTCPB EQU   10                       PT TO NEXT CPB ON NEWQ          13900020
RSKIP    EQU   9                        ADDR OF EITHER 'DOTEST'         14000020
*                                         OR 'SKIPTEST'                 14100020
RLASTCPB EQU   4                        PT TO PREVIOUS CPB ON NEWQ      14200020
RCPB     EQU   7                        BASE OF CPB DSECT. THE CPB      14300020
*                                         TO BE ADDED TO NEWQ           14400020
RPREFIX  EQU   6                        PREFIX DSECT BASE        99226  14450022
RDEB     EQU   5                        DEB DSECT BASE                  14500020
RNEXTCC  EQU   2                        CYLINDER ID OF NEXT CPB ON      14600020
*                                         NEWQ                          14700020
RARM     EQU   0                        CYLINDER ID OF CURRENT ARM      14800020
*                                         POSITION FROM IOBXCC          14900020
         USING *,R15                    TEMPORARY PROGRAM BASE          15000020
         USING IEDQCPB,RCPB             CPB DSECT BASE                  15100020
         USING IEDQAVTD,RAVT            AVT DSECT BASE                  15200020
         USING IOSBE,RIOSBE             IOSBE ADDRESSABILITY            15300009
         USING IEDQDEB,RDEB             DEB DSECT                       15400020
         USING IEDQPRF,RPREFIX          PREFIX DSECT             99226  15450022
         EJECT                                                 @Z40X9QG 15470009
*                                                                       15500020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 15503020
*                                                                       15506020
*                       LOCAL EQUATES                                   15509020
*                                                                S21101 15510021
ZERO     EQU   0                        ZERO                   @Z40X9QG 15510509
HI       EQU   8                        MASK TO ICM HI-BYTE      X01004 15511004
FF       EQU   X'FF'                    DUMMY TIC OP CODE               15515020
RPS      EQU   X'10'                    RPS DEVICE IN UCBTBYT2   S21101 15516021
CCWLEN   EQU   8                        LENGTH OF CCW                   15518020
CCWFLAG  EQU   4                        OFFSET INTO CCW OF FLAG BYTE    15521020
SAVECCW  EQU   12                       OFFSET INTO SAVE2 WHERE 3       15524020
*                                         CCWS ARE SAVED                15527020
THREECCW EQU   20                       LENGTH OF CCWS SAVED IN SAVE2   15530020
HISREG15 EQU   16                       OFFSET INTO SAVEAREA OF R15     15536020
HISREG14 EQU   12                       OFFSET INTO SAVEAREA OF R14     15539020
LBB      EQU   2                        LENGTH OF BB IN MBBCCHHR        15542020
LHHR     EQU   2                        LENGTH OF HH IN MBBCCHHR        15545020
LCC      EQU   2                        LENGTH OF CC IN MBBCCHHR        15548020
INC      EQU   1                        INCREMENTOR TO NEXT BYTE        15554020
FULLSHIF EQU   32                       DOUBLE REG SHIFT ENTIRE REG     15557020
BYTESHIF EQU   8                        SHIFT COUNT FOR ONE BYTE        15560020
THRESHFF EQU   X'FF'                    VALUE IN AVTHRESS - MEANS       15563020
*                                         ELE NO YET ACTIVATED          15566020
THRESHF7 EQU   X'F7'                    VALUE IN AVTHRESS - MEANS       15569020
*                                         ELE IS REQUESTED TO BE        15572020
*                                         POSTED UPON EXIT FROM '-RC'   15575020
THRESHF0 EQU   X'F0'                    VALUE IN AVTHRESS - MEANS       15578020
*                                         ELE HAS BEEN POSTED TO READY  15581020
ABEND1   EQU   1                        ABEND SUBCODE, OUT OF           15584020
*                                         SPACE, NON-REUS DISK          15587020
ABEND5   EQU   5                        ABEND SUBCODE, DISK DCB         15590020
*                                         NOT OPEN                      15593020
ROUNDER  EQU   3                        VALUE FOR RRN ADJUSTMENT S21101 15594020
LORDER   EQU   3                        OFFSET VALUE             S21101 15595020
TWO      EQU   2                        MASK TO ICM BYTE 3       X01004 15595204
AD       EQU   7                        MASK TO ICM ADDRESS      X01004 15595404
ALL      EQU   15                       EFFECTIVE LOAD ICM MASK  X01004 15595604
DIV4     EQU   2                        VALUE FOR RRN ADJUSTMENT S21101 15596020
         EJECT                                                 @Z40X9QG 15598009
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 15600020
*                                                                       15700020
*                       ENTRY - EXCP DRIVER                             15800020
*                                                                       15900020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 16000020
*                                                                       16100020
         BAL   RBASE,LOOP               SKIP CONSTANTS AND              16200020
*                                         SET PROGRAM BASE              16300020
         DROP  R15                      FORGET TEMPORARY                16400020
         USING *,RBASE                  ESTABLISH ADDRESSABILITY        16500020
*                                                                       16600020
*                                                                99226  16620022
* THIS CONSTANT ALLOWS ANOTHER ROUTINE ACCESS TO THE DISK ERP WTO99226  16640022
*                                                                99226  16660022
         DC    A(WTORTN)                WTO ROUTINE FOR DISK ERP 99226  16680022
IGG019RC IEDHJN ,                                                S22025 16700022
*                                                                       16900020
LOOP     EQU   *                                                        17000020
         LA    RBASE,AVTEZERO(,RBASE)   CLEAR SWITCH IN BASE REG.X01004 17400004
         SR    RCPB,RCPB                CLEAR FOR ICM            X01004 17430004
         ICM   RCPB,AD,AVTINCPQ+INC     FIRST CPB ON INPUT QUEUE X01004 17460004
*                                       IS QUEUE EMPTY           X01004 17520004
         BZ    CRANKIT                    YES, NO MORE CPBS      S21101 17560021
*                                         NO, GOT A CPB          S21101 17580021
         MVC   AVTINCPQ+INC(L'AVTINCPQ-INC),CPBNEXT LEAVE REST ON CPBS  17600020
         XC    CPBNEXT,CPBNEXT          ZERO FORWARD POINTER            17700020
         MVI   CPBXWFL,AVTEZERO         CLEAR FLAG BYTE 2ND CCW         17800020
         CLI   CPBXDWR,CPBNOPC          IS SECOND CCW A NO-OP           17900020
         BE    NOPCODE                    YES, IT IS A NOP              18000020
*                                         NO, IT IS READ/WRITE          18100020
         MVI   CPBRWFL,CPBCDC+CPBSLIC   SET 'DATA CHAIN' AND 'SLI'      18200020
         MVC   CPBCOUNT,AVTKEYLE        SET KEYLENGTH                   18300020
         L     R15,CPBXREAF             GET UNIT ADDRESS                18400020
         LA    R15,AVTUMALN(,R15)       BUMP BY SIZE OF UNIT            18500020
*                                         MANAGEMENT AREA TO ADDR       18600020
*                                         OF KEY PORTION OF UNIT        18700020
         STCM  R15,AD,CPBAREA           SET KEY BUFFER ADDRESS   X01004 18800004
         B     DISKCPB                  GO PROCESS CPB ONTO NEWQ        19100020
*                                                                       19200020
NOPCODE  EQU   *                                                        19300020
         MVI   CPBRWFL,AVTEZERO         CLEAR CCWFLAG BITS 1ST CCW      19400020
         MVI   CPBXDWR,FF               SET NO-OP TO DUMMY 'TIC'        19500020
         LA    R15,AVTDATLN             GET SIZE OF DATA RECORD         19600020
         STH   R15,CPBCOUNT               TO FIRST CCW LENGTH FIELD     19700020
         MVC   CPBAREA,CPBXREA          DATA WRITTEN FROM FIRST         19800020
*                                         OF UNIT                       19900020
         B     DISKCPB                  GO PROCESS CPB ONTO NEWQ        20000020
*                                                                       20100020
         EJECT                                                 @Z40X9QG 20150009
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 20200020
*                                                                       20300020
CRANKIT  EQU   *                                                        20400020
*                                                                       20500020
* BEFORE RETURNING TO THE DISPATCHER, EXCP DRIVER MUST CHECK THE        20600020
* CHAINS OF IOSBE'S (REUS AND NON-REUS) TO MAKE                @Z40X9QG 20700009
* SURE NO CPB IS UNNECESSARILY WAITING FOR EXCP.                        20800020
*                                                                       20900020
************************************************************** @Z40X9QG 20930009
         SPACE 1                                               @Z40X9QG 20960009
         ICM   RIOSBE,ALL,AVTIOBR       FIRST IOSBE FOR REUS   @Z40X9QG 21000009
*                                       IS REUSEABLE DISK USED   X01004 21100004
         BZ    TRYNONRU                   NO, GO DO NON-REUS            21300020
         L     RDEB,AVTADEBR            GET DEB FOR REUSABLE DISK       21500020
         BAL   R6,CHECKIOB              CHK FOR IOSBE READY    @Z40X9QG 21600009
*                                       FOR EXCP                 S22025 21700022
TRYNONRU EQU   *                                                        21800020
         ICM   RIOSBE,ALL,AVTIOBN       1ST IOSBE FOR NON-REUS @Z40X9QG 21900009
*                                       IS NON REUSEABLE DISK    X01004 22000004
         BZ    EXIT                       NO, QUIT                      22200020
         L     RDEB,AVTADEBN            GET DEB FOR NON-REUS            22400020
         BAL   R6,CHECKIOB              CHK FOR IOSBE READY    @Z40X9QG 22500009
*                                       FOR EXCP                 S22025 22600022
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 22700020
*                                                                       22800020
EXIT     EQU   *                                                        22900020
         L     R11,AVTEA                                                23000020
         CLI   AVTHRESS,THRESHF7        DOES ELE NEED POSTING           23100020
         BE    PASSELE                    YES, GO POST IT               23200020
*                                         NO, DO NOT POST IT            23300020
         USING IEDQDISP,R11                                             23400020
         B     DSPDISP                  RETURN TO DISPATCHER            23500020
         EJECT                                                 @Z40X9QG 23530009
************************************************************** @Z40X9QG 23560009
*                                                                       23600020
* IF STARTUP IS IN PROGRESS, CHECKPOINT OPEN IS USING CPBS TO LOOK      23700020
* AT THE DISK MESSAGE QUEUE DATA SETS.  OPEN IS CALLING EXCP DRIVER     23800020
* AS A SUBROUTINE TO FINISH BUILDING THE CPBS AND GET I/O STARTED       23900020
* ON THE DISK.  NORMALLY EXCP DRIVER IS NOT A SUBROUTINE, SINCE         24000020
* IEDQFA EXITS TO IT AND IT IN TURN EXITS TO THE DISPATCHER.            24100020
* HOWEVER, CHECKPOINT OPEN CAUSES IT TO BE A SUBROUTINE WHICH           24200020
* RETURNS TO OPEN (NOT EXITS TO DISPATCHER) BY PUTTING INTO AVTEA       24300020
* THE ADDRESS OF THE LOCATION TO WHICH EXCP DRIVER IS TO RETURN,        24400020
* MODIFIED BY THE OFFSET OF 'DSPDISP'.  OPEN ATTENDS TO SAVING AND      24500020
* RESTORING OF REGISTERS, USING R13 POINTING TO AVTSAVE2.  OPEN ALSO    24600020
* RESETS AVTEA BACK TO THE ADDRESS OF THE DISPATCHER, AND RESETS        24700020
* CERTAIN VALUES BACK INTO AVTSAVE2 WHICH ARE EXPECTED TO HAVE BEEN     24800020
* ASSEMBLED THERE.  AVTSAVE2 IS DISTROYED BY EXCP DRIVER, THUS THE      24900020
* NEED FOR REPAIR BY OPEN UPON COMPLETION OF ALL DISK I/O REQUESTS      25000020
* TO EXCP DRIVER.  THIS USE AS A SUBROUTINE PREVENTS PREMATURE          25100020
* ACTIVATION OF THE DISPATCHER.  WHEN OPEN GETS CONTROL BACK FROM       25200020
* EXCP DRIVER, IT ISSUES 'WAIT' ON AVTOSECB, WHICH WILL BE POSTED       25300020
* BY DISK APPENDAGE UPON COMPLETION OF I/O.                             25400020
*                                                                       25500020
PASSELE  EQU   *                                                        25600020
         LA    R1,AVTHRESE              PASS ADDRESS OF NON-REUS        25700020
*                                         THRESHOLD CLOSEDOWN ELE       25800020
*                                         TO DISPATCHER TO BE POSTED    25900020
*                                         TO 'FLUSH' CLOSE MCP          26000020
         MVI   AVTHRESS,THRESHF0        MARK ELEMENT 'POSTED'           26100020
         B     DSPPOST                  EXIT TO DISPATCHER              26200020
*                                                                       26300020
         DROP  R11                                                      26400020
         USING IOSBE,RIOSBE             IOSBE ADDRESSABILITY   @Z40X9QG 26500009
*                                                                       26600020
         EJECT                                                 @Z40X9QG 26630009
         SPACE 1                                               @Z40X9QG 26660009
************************************************************** @Z40X9QG 26700009
*                                                            * @Z40X9QG 26770009
* CHECK FOR IOSBE READY FOR NEW I/O                          * @Z40X9QG 26840009
*              INPUT: RIOSBE - PTR TO 1ST IOSBE              * @Z40X9QG 26910009
*                     RDEB   - PTR TO DEB                    * @Z40X9QG 26980009
*                     R6     - RETURN ADDRESS                * @Z40X9QG 27050009
*                                                            * @Z40X9QG 27120009
************************************************************** @Z40X9QG 27190009
         SPACE 1                                               @Z40X9QG 27260009
CHECKIOB EQU   *                                               @Z40X9QG 27330009
         SR    R8,R8                    CLEAR COUNTER REGISTER          27400020
         IC    R8,DEBNMEXT              GET NUMBER OF EXTENTS           27500020
LOCK     EQU   *                                                        27600020
         TS    IOSBELCK                 LOCK DOOR; FORBID DISK @OZ26164 27700011
*                                       END TO RETRY             Y02027 27800006
         BNE   LOCK                     IF LOCKED, DISK END      Y02027 27900006
*                                       RETRY IS IN PROGRESS     Y02027 28000006
         ICM   RCPB,AD,IOSBERET         IS RETRY QUEUE ZERO    @Z40X9QG 28100009
         BNZ   GOODRETQ                   NO, SOMETHING ON RETQ         28300020
*                                         YES, RETQ IS EMPTY            28400020
TESTNEWQ EQU   *                                                        28500020
         ICM   RCPB,AD,IOSBENEW         IS NEW QUEUE ZERO      @Z40X9QG 28600009
         BZ    UNLOCK                     YES, GO UNLOCK DOOR           28700020
*                                         NO, SOMETHING ON NEWQ         28800020
SAMECYL  EQU   *                                                        29000020
         LR    RLASTCPB,RCPB            REMEMBER THIS CPB BEFORE        29100020
*                                         GOING TO NEXT CPB             29200020
         ICM   RCPB,AD,CPBNEXT          IS THIS THE LAST CPB     Y02027 29300006
         BZ    LASTCPB                    YES, LAST CPB                 29600020
*                                         NO, THERE IS ANOTHER CPB      29700020
         CLC   IOSBEXCC,CPBCCHHR        IS NEW CPB FOR SAME CYL@Z40X9QG 29800009
*                                         AS FIRST CPB         @Z40X9QG 29900009
         BE    SAMECYL                    YES, KEEP LOOKING             30000020
*                                         NO, DIFFERENT CYLINDER        30100020
         XC    CPBNEXT-IEDQCPB(,RLASTCPB),CPBNEXT-IEDQCPB(RLASTCPB)     30200020
*                                       CLEAR POINTER OF LAST CPB       30300020
*                                         TO BE MOVED TO RETQ           30400020
         MVC   IOSBEXCC,CPBCCHHR        SAVE CYL ID OF NEXT CPB@Z40X9QG 30500009
*                                         AS TOP PRIORITY CYL  @Z40X9QG 30600009
         EJECT                                                 @Z40X9QG 30650009
LASTCPB  EQU   *                                                        30700020
         MVC   IOSBERET,IOSBENEW        ENQUEUE FIRST CPBS ONTO@Z40X9QG 30780009
*                                         RETQ FROM NEWQ                31100020
         STCM  RCPB,AD,IOSBENEW         PUT FIRST CPB WITH     @Z40X9QG 31200009
*                                         DIFFERENT CYL ONTO   @Z40X9QG 31420009
*                                         NEWQ IN FIRST PLACE  @Z40X9QG 31510009
GOODRETQ EQU   *                        RETRY Q HAS SOMETHING           31600020
         TM    IOSBEFLG,IOSBERDY        CAN IOSBE ACCEPT NEW IO@Z40X9QG 31700009
         BO    STARTIO                  YES, BRANCH            @Z40X9QG 31800009
         MVI   IOSBELCK,AVTEZERO        UNLOCK RETRY DOOR      @OZ26164 32000011
         TM    IOSBEFLG,IOSBERDY        CAN IOSBE ACCEPT NEW IO@Z40X9QG 32100009
         BO    LOCK                     YES, BRANCH            @Z40X9QG 32200009
         B     NEXTIOB                  GO CHECK NEXT EXTENT            32600020
*                                                                       32700020
         EJECT                                                 @Z40X9QG 32750009
************************************************************** @Z40X9QG 32800009
*                                                            * @Z40X9QG 32810009
* ISSUE AQCTL TO REQUEST THAT STARTIO BE ISSUED              * @Z40X9QG 32820009
*                                                            * @Z40X9QG 32830009
************************************************************** @Z40X9QG 32840009
STARTIO  EQU   *                                               @Z40X9QG 32850009
         MVC   IOSBECPB,IOSBERET        PASS RET QUEUE TO      @Z40X9QG 32900009
*                                       SVC 102 AS PARAMETER   @Z40X9QG 33000009
         XC    IOSBERET,IOSBERET        CLEAR RETRY QUEUE      @Z40X9QG 33100009
         NI    IOSBEFLG,IOSBEBUS        SET IOSBE BUSY         @Z40X9QG 33200009
         LR    R1,RIOSBE                SET IOSBE AS PARM LIST @Z40X9QG 33300009
         AQCTL                          ISSUE SVC 102          @Z40X9QG 33400009
         B     TESTNEWQ                 IF ANYTHING IS ON NEWQ, GO      34000020
*                                         PUT IT TO RETQ FOR DISK       34100020
*                                         END APPENDAGE                 34200020
         SPACE 2                                               @Z40X9QG 34250009
UNLOCK   EQU   *                                                        34300020
         MVI   IOSBELCK,AVTEZERO        UNLOCK RETRY DOOR      @OZ26164 34400011
NEXTIOB  EQU   *                                                        34500020
         LA    RIOSBE,IOSBELEN(,RIOSBE) BUMP TO NEXT IOSBE     @Z40X9QG 34600009
         BCT   R8,LOCK                  GO CHECK NEXT EXTENT,           34700020
*                                         IF ANY                        34800020
         BR    R6                       FINISHED WITH THIS DISK         34900020
*                                         RETURN TO MAIN CODE           35000020
         EJECT                                                 @Z40X9QG 35100009
************************************************************** @Z40X9QG 35150009
*                                                                       35200020
* SEND CPB TO THE DISK ADDRESS CONVERT ROUTINE FOR IT TO GENERATE       35300020
* THE ABSOLUTE DISK ADDRESS IN THE FORM OF MBBCCHHR.                    35400020
*                                                                       35500020
************************************************************** @Z40X9QG 35550009
DISKCPB EQU *                                                           35600020
         LA    R15,IEDQFP               GET ADDR OF CONVERT ROUTINE     35700020
         BALR  R14,R15                  CALL CONVERT ROUTINE            35800020
*                                                                       35900020
         TM    CPBRDWR,CPBWRITB         IS THIS CPB FOR 'WRITE'         36000020
         BO    SKIPBUMP                   YES, SKIP BUMPING COUNTER     36100020
*                                         NO, COUNT READING CPBS        36200020
         LH    R1,AVTDSKCT              GET PREVIOUS COUNT              36300020
         LA    R1,INC(,R1)              BUMP COUNTER                    36400020
         STH   R1,AVTDSKCT              RESTORE NEW COUNT               36500020
         SPACE 1                                               @Z40X9QG 36600009
************************************************************** @Z40X9QG 36650009
*                                                            * @Z40X9QG 36700009
* SET RIOSBE TO FIRST IOSBE FOR THIS QUEUE                   * @Z40X9QG 36750009
*                                                            * @Z40X9QG 36800009
************************************************************** @Z40X9QG 36850009
SKIPBUMP EQU   *                                               @Z40X9QG 36900009
         L     RIOSBE,AVTIOBR           GET ADDR OF 1ST IOSBE  @Z40X9QG 36950009
*                                         FOR REUS QUEUES      @Z40X9QG 37000009
         TM    CPBADDR+LORDER,CPBQTYPE  IS CPB FOR REUSABLE DISK S21101 37100020
         BO    SKIP                     YES, BRANCH            @Z40X9QG 37200009
         L     RIOSBE,AVTIOBN           GET ADDR OF 1ST IOSBE  @Z40X9QG 37300009
*                                         FOR NON-REUS QUEUES  @Z40X9QG 37400009
         SPACE 2                                               @Z40X9QG 37500009
************************************************************** @Z40X9QG 37600009
*                                                            * @Z40X9QG 37700009
* STEP THROUGH THE CHAIN OF IOSBE'S TO FIND ONE              * @Z40X9QG 37800009
* CORRESPONDING TO THE EXTENT SPECIFIED BY                   * @Z40X9QG 37900009
* M OF MBBCCHHR IN CPB                                       * @Z40X9QG 38100009
*                                                            * @Z40X9QG 38160009
************************************************************** @Z40X9QG 38220009
SKIP     EQU   *                                                        38300020
         SR    RM,RM                    CLEAR WORK REG                  38400020
         IC    RM,CPBABSAD              GET M OF MBBCCHHR               38500020
         LA    RIOBINDX,IOSBELEN        GET SIZE OF ONE IOSBE  @Z40X9QG 38600009
         MR    RM-1,RIOBINDX            GET TOTAL SIZE OF IOSBE@Z40X9QG 38700009
*                                         TO BE SKIPPED                 38800020
         LA    RIOSBE,ZERO(RM,RIOSBE)   BUMP TO NEXT IOSBE     @Z40X9QG 38900009
         EJECT                                                 @Z40X9QG 38950009
*                                                                       39000020
* THE NEW CPB (RCPB) IS TO BE PLACED ON THE NEW Q OF THE IOSBE @Z40X9QG 39100009
* ORDER IS IN ASCENDING CYLINDER ID, WITH CURRENT ARM POSITION BEING    39200020
* THE TOP PRIORITY CYLINDER.  WITHIN A GROUP OF CPBS ALL FOR THE        39300020
* SAME CYLINDER, A NEW CPB FOR THE SAME CYLINDER IS ADDED AT THE        39400020
* END OF THAT GROUP OF CPBS, KEEPING FIFO ORDER WITHIN THE CYLINDER     39500020
*                                                                       39600020
         SR    RLASTCPB,RLASTCPB        CLEAR FOR ICM            X01004 39700004
         ICM   RLASTCPB,AD,IOSBENEW     FIRST CPB ON NEW QUEUE @Z40X9QG 39800009
         BZ    ZERONEWQ                   YES, NEWQ IS EMPTY            40000020
*                                         NO, NEWQ HAS CPB(S)           40100020
         L     RNEXTCPB,CPBNEXTF-IEDQCPB(0,RLASTCPB) GET ADDRESS OF     40200020
*                                         2ND CPB ON NEWQ               40300020
         LA    RNEXTCPB,0(0,RNEXTCPB)   CLEAR HIGH BYTE                 40400020
*                                                                       40500020
* RCPB HAS ADDRESS OF NEW CPB TO BE ADDED.                              40600020
* RLASTCPB HAS ADDRESS OF 1ST CPB ON NEWQ.                              40700020
* RNEXTCPB HAS ADDRESS OF 2ND CPB (IF ANY) ON NEWQ.                     40800020
*                                                                       40900020
         LH    RARM,IOSBEXCC            GET CURRENT ARM POS.   @Z40X9QG 41000009
         MVC   AVTDOUBL(LCC),CPBCCHHR   GET CYL ID FROM MBBCCHHR        41100020
         LH    RCC,AVTDOUBL               OF NEW CPB TO BE ADDED        41200020
         CR    RCC,RARM                 IS NEW CYL (RCC) GE CYL OF      41300020
*                                         CURRENT ARM POSITION (RARM)   41400020
         BL    SETEX                      NO, NEW CYL IS LESS THAN OLD  41500020
*                                         YES, NEW CYL IS GE OLD        41600020
         LA    RSKIP,DOTEST             SET SWITCH                      41700020
*                                                                       41800020
* STEP THROUGH CPBS ON NEWQ LOOKING FOR PLACE FOR NEW CPB.              41900020
*                                                                       42000020
CPBLOOP  EQU   *                                                        42100020
         LTR   RNEXTCPB,RNEXTCPB        IS THERE ANOTHER CPB ON NEWQ    42200020
         BNZ   ANOTHCPB                   YES,THERE IS ANOTHER CPB      42300020
*                                         NO, THIS IS THE LAST ONE      42400020
*                                                                       42500020
* RLASTCPB POINTS TO THE LAST CPB ON THE END OF THE NEWQ.               42600020
* RCPB HAS THE ADDRESS OF THE CPB TO BE ADDED AT THE END OF THE NEWQ.   42700020
*                                                                       42800020
CHAINEW  EQU   *                                                        42900020
         STCM  RCPB,AD,CPBNEXT-IEDQCPB(RLASTCPB) CHAIN NEW CPB   Y02027 43000006
*                                       AT END OF NEWQ           Y02027 43100006
         B     BUILDCCW                 BRANCH TO BUILD DISK CCW S22025 43300022
         EJECT                                                 @Z40X9QG 43330009
************************************************************** @Z40X9QG 43360009
*                                                                       43400020
* RLASTCPB POINTS TO A CPB ON THE NEWQ, RNEXTCPB POINTS TO THE CPB      43500020
* WHICH FOLLOWS IT, RCPB IS THE NEW CPB WHICH MIGHT BE INSERTED         43600020
* BETWEEN THESE TWO, OR 2 OTHERS FURTHER ON.                            43700020
*                                                                       43800020
************************************************************** @Z40X9QG 43830009
         SPACE 1                                               @Z40X9QG 43860009
ANOTHCPB EQU   *                                                        43900020
         MVC   AVTDOUBL(LCC),CPBCCHHR-IEDQCPB(RNEXTCPB) GET CYL OF      44000020
         LH    RNEXTCC,AVTDOUBL           NEXT CPB                      44100020
         BR    RSKIP                    GO TO EITHER 'DOTEST' OR        44200020
*                                         GO TO 'SKIPTEST'              44300020
DOTEST   EQU   *                                                        44400020
         CR    RNEXTCC,RARM             IS CYL OF NEXT CPB(RNEXTCC)     44500020
*                                         LT CYL OF RET Q(RARM)         44600020
         BL    INSNEW                     YES,INSERT NEW CPB BEFORE     44700020
*                                           LAST CPB                    44800020
SKIPTEST EQU   *                          NO, CONTINUE                  44900020
ANOTHCP  EQU   *                                                        45000020
         CR    RNEXTCC,RCC              IS CYL OF NEXT CPB (RNEXTCC)    45100020
*                                       GT CYL OF NEW CPB (RCC)         45200020
         BH    INSNEW                     YES, NEXT ONE IS HIGHER       45300020
*                                           THAN NEW CPB                45400020
*                                         NO, NEXT ONE IS LESS THAN     45500020
*                                           OR EQUAL TO NEW CPB         45600020
GETNEXT  EQU   *                                               @SA71677 45650061
         LR    RLASTCPB,RNEXTCPB        WHAT WAS 'NEXT' CPB BECOMES     45700020
*                                         THE 'PREVIOUS' OR 'LAST' CPB  45800020
         ICM   RNEXTCPB,AD,CPBNEXT-IEDQCPB(RLASTCPB) GET ADDRESS Y02027 45900006
*                                       OF NEXT CPB ON NEWQ      Y02027 46000006
         B     CPBLOOP                  GO SEE IF THE NEW CPB CAN       46200020
*                                         BE INSERTED BETWEEN THESE     46300020
*                                         NEXT TWO CPBS.                46400020
         EJECT                                                 @Z40X9QG 46450009
*                                                                       46500020
* RCPB IS TO BE INSERTED BETWEEN THE CPBS POINTED TO BY RNEXTCPB        46600020
* AND RLASTCPB (AFTER RLASTCPB AND BEFORE RNEXTCPB)                     46700020
*                                                                       46800020
INSNEW   EQU   *                                                        46900020
         CLC   CPBCCHHR-IEDQCPB(LCC,RLASTCPB),CPBCCHHR-IEDQCPB(RNEXTCPB)46920061
               ) ARE NEXT AND LAST CPBS ON SAME CYLINDER       @SA71677 46940061
         BE    GETNEXT                  YES, DON'T INSERT HERE @SA71677 46960061
         STCM  RNEXTCPB,AD,CPBNEXT      HANG NEXT CPB FROM       Y02027 47000006
*                                       NEW CPB                  Y02027 47100006
         STCM  RCPB,AD,CPBNEXT-IEDQCPB(RLASTCPB) CHAIN NEW CPB   Y02027 47200006
*                                       FROM PREVIOUS CPB        Y02027 47300006
         B     BUILDCCW                 BRANCH TO BUILD DISK CCW S22025 47500022
*                                                                       47600020
* THE NEWQ IS EMPTY.  PUT THE NEW CPB ON THE NEWQ.                      47700020
*                                                                       47800020
ZERONEWQ EQU   *                                                        47900020
         MVC   IOSBEXCC,CPBCCHHR        SAVE CYL ID OF NEW CPB @Z40X9QG 48000009
*                                         AS TOP PRIORITY CYL  @Z40X9QG 48100009
         STCM  RCPB,AD,IOSBENEW         HANG NEW CPB ONTO NEWQ @Z40X9QG 48200009
         B     BUILDCCW                 BRANCH TO BUILD DISK CCW S22025 48400022
         EJECT                                                 @Z40X9QG 48430009
************************************************************** @Z40X9QG 48460009
*                                                                       48500020
* THE CYLINDER (IN RCC) OF THE NEW CPB (RCPB) IS LESS THAN THE          48600020
* CURRENT ARM POSITION (RARM).                                          48700020
*                                                                       48800020
* RCC HAS CYLINDER ID OF NEW CPB.                                       48900020
* RLASTCPB POINTS TO FIRST CPB ON NEWQ.                                 49000020
* RNEXTCPB POINTS TO 2ND CPB ON NEWQ.                                   49100020
*                                                                       49200020
* SEARCH FOR THE CPB ON THE NEWQ THAT IS NOT SAME OR GREATER THAN       49300020
* THE PREVIOUS CPB'S CYL ID, BUT THE CPB WHOSE CYL ID IS LESS THAN      49400020
* THE CURRENT ARM POSITION (OR FIND END OF NEWQ).                       49500020
*                                                                       49600020
************************************************************** @Z40X9QG 49630009
         SPACE 2                                               @Z40X9QG 49660009
NEWLOW   EQU   *                                                        49700020
         MVC   AVTDOUBL(LCC),CPBCCHHR-IEDQCPB(RNEXTCPB) GET CYL OF      49800020
         LH    RNEXTCC,AVTDOUBL           NEXT CPB                      49900020
         CR    RNEXTCC,RARM             IS CYL OF NEXT CPB(RNEXTCC)     50000020
*                                         LESS THAN CYL OF CURRENT      50100020
*                                         ARM POSITION (RARM)           50200020
         BL    ANOTHCP                    YES,RNEXTCPB IS BELOW         50300020
*                                           CURRENT ARM POSITION        50400020
*                                         NO, KEEP LOOKING              50500020
         LR    RLASTCPB,RNEXTCPB        WHAT WAS 'NEXT' CPB BECOMES     50600020
*                                         'PREVIOUS' OR 'LAST' CPB      50700020
         L     RNEXTCPB,CPBNEXTF-IEDQCPB(0,RNEXTCPB) LOOK AT A NEW      50800020
*                                         'NEXT' CPB                    50900020
         LA    RNEXTCPB,0(0,RNEXTCPB)   CLEAR HIGH BYTE                 51000020
NEWLOWOK EQU   *                                                        51100020
         LTR   RNEXTCPB,RNEXTCPB        IS THERE ANOTHER CPB            51200020
         BZ    CHAINEW                    NO, PUT NEW CPB AT END        51300020
*                                           OF NEWQ                     51400020
         B     NEWLOW                     YES, KEEP LOOKING             51500020
*                                                                       51600020
SETEX    EQU   *                                                        51700020
         LA    RSKIP,SKIPTEST           SET SWITCH                      51800020
         B     NEWLOWOK                 CHECK FOR ANOTHER CPB    S22025 51900022
         EJECT                                                 @Z40X9QG 51950009
*                                                                       52000020
* RCPB HAS THE ADDRESS OF THE CPB JUST ADDED TO THE NEWQ.               52100020
* RLASTCPB HAS THE ADDRESS OF THE CPB ON THE NEWQ JUST BEFORE THE       52200020
* CPB JUST ADDED (RCPB).  RLASTCPB IS ZERO IF RCPB IS THE ONLY          52300020
* CPB ON NEWQ.                                                          52400020
*                                                                       52500020
* BUILD CHANNEL PROGRAM FOR DISK IN CPB.                                52600020
*                                                                       52700020
BUILDCCW EQU   *                                                        52800020
         MVC   SAVECCW(THREECCW,R13),CPBRDWR SAVE 2 READ/WRITE          52900020
*                                         CCWS AND TIC                  53000020
         LR    RDUMCPB,RCPB             SET SECONDARY CPB BASE REG      53100020
         LTR   RLASTCPB,RLASTCPB        IS THERE ANOTHER CPB ON NEW     53200020
*                                         Q JUST BEFORE THIS ONE        53300020
         BZ    NOPREV                     NO, THIS IS THE ONLY ONE      53400020
*                                         YES, THERE IS A PREVIOUS      53500020
*                                           CPB                         53600020
         CLC   CPBCCHHR-IEDQCPB(LCC,RLASTCPB),CPBCCHHR IS CYL OF        53700020
*                                         PREVIOUS CPB SAME AS CYL      53800020
*                                         OF NEW CPB                    53900020
         BE    EQUALCC                    YES, CYLINDERS ARE ALIKE      54000020
*                                         NO, DIFFERENT CYLINDERS       54100020
*                                                                       54200020
NOPREV   EQU   *                                                        54300020
         SH    RDUMCPB,HALF8            MODIFY SECONDARY CPB BASE       54400020
*                                         FOR MEDIUM CPB                54500020
         BAL   R6,MEDIUMCP              GO BUILD MEDIUM CPB             54600020
*                                                                       54700020
ZEROADDR EQU   *                                                        54800020
         NC    CPBADDR+INC(L'CPBADDR-INC),CPBADDR+INC IS ADDRESS 0 **** 54900020
         BNZ   LOOP                       NO, FINISHED WITH NEW CPB     55000020
* THIS SHOULD NEVER OCCUR.   BUT, JUST IN CASE, BETTER KILL IT NOW      55110020
* BEFORE ALL TRACE OF WHY THE FALSE REQUEST WAS MADE IS LOST.           55120020
*                                                                       55130020
         DC    H'0'                     CPB REQUESTS DISK REC ZERO      55140020
************************************************************** @Z40X9QG 55145009
*                                                                       55150020
* THIS IS AN INTENTIONAL PROGRAM CHECK TO TRAP A TYPE OF INTERNAL       55160020
* TCAM LOGICAL BUG THAT CAUSES RECORD ZERO TO INCORRECTLY BE REFERENCED 55170020
* IN THE CPB.  THERE IS NO SUCH RECORD.                                 55180020
* THE FIX LIES NOT IN IGG019RC BUT IN WHOEVER BUILT THE CPB AND GAVE    55190020
* IT TO IGG019RC FOR ITS INPUT QUEUE.   RCPB POINTS TO THE CPB.         55200020
* CPBFLAG X'80' BIT ON SAYS CPB BUILT BY REUS/COPY, IGG019RP.           55210020
* IF THAT NOT ON, CHECK 'READY HAD BEEN EXECUTED ' BIT IN AVT.          55220020
* IF ON, PROBABLY CPB BUILT BY IEDQFA. IF NOT ON, WARMSTART BUILT CPB.  55230020
*                                                                       55250020
************************************************************** @Z40X9QG 55260009
         EJECT                                                 @Z40X9QG 55270009
EQUALCC  EQU   *                                                        55300020
         CLC   CPBHHR-IEDQCPB(LHHR,RLASTCPB),CPBHHR IS HEAD ID OF       55400020
*                                         PREVIOUS CPB SAME AS HEAD     55500020
*                                         OF NEW CPB                    55600020
         BE    SAMEHEAD                   YES, HEADS ARE ALIKE          55700020
*                                         NO, DIFFERENT HEADS           55800020
*                                       LEAVE SECONDARY CPB BASE        55900020
*                                         FOR LARGE CPB                 56000020
         BAL   R6,LARGECPB              GO BUILD LARGE CPB              56100020
*                                                                       56200020
         B     HUNTFF                   GO CHAIN CPBS TOGETHER          56300020
MEDIUM   EQU   *                                                        56400020
         SH    RDUMCPB,HALF8            MODIFY SECONDARY CPB BASE       56500020
*                                         FOR MEDIUM CPB                56600020
         BAL   R6,MEDIUMCP              GO BUILD MEDIUM CPB             56700020
*                                                                       56800020
* TIC OF PREVIOUS CPB IS X'FF'. FIND IT, CHANGE IT TO REAL TIC OP.      56900020
*                                                                       57000020
HUNTFF   EQU   *                                                        57100020
         CLI   CCWLEN(RLASTCPB),FF      IS THIS THE TIC                 57200020
         BE    GOTFF                      YES, THIS IS THE TIC          57300020
*                                         NO, KEEP LOOKING              57400020
         LA    RLASTCPB,CCWLEN(0,RLASTCPB) LOOK AT NEXT CCW             57500020
         B     HUNTFF                   GO HUNT FOR TIC                 57600020
*                                                                       57700020
GOTFF    EQU   *                        FOUND TIC                       57800020
         OI    CCWFLAG(RLASTCPB),CPBCCC TURN ON COMMAND CHAIN BIT       57900020
*                                         IN RD/WR CCW                  58000020
         ST    RCPB,CCWLEN(0,RLASTCPB)  SET TIC ADDR TO NEXT CPB        58100020
         MVI   CCWLEN(RLASTCPB),CPBTICC CHANGE X'FF' TO TIC OP CODE     58200020
         B     ZEROADDR                 FINISHED WITH THIS CPB          58300020
*                                       START ALL OVER                  58400020
         EJECT                                                 @Z40X9QG 58450009
SAMEHEAD EQU   *                        NEW AND PREVIOUS CPBS HAVE      58500020
*                                         SAME HEAD                     58600020
         SR    R15,R15                  CLEAR WORK REGISTER             59300020
         IC    R15,CPBR-IEDQCPB(RLASTCPB) GET R OF MBBCCHHR             59400020
*                                         FROM PREVIOUS CPB             59500020
         SR    R14,R14                                                  59600020
         IC    R14,CPBR                 GET R OF MBBCCHHR OF NEW CPB    59700020
         SR    R14,R15                  SUBTRACT R OF PREVIOUS CPB      59800020
*                                         FROM R OF NEW CPB             59900020
         BCT   R14,MEDIUM               IS THE DIFFERENCE EXACTLY       60000020
*                                         ONE                           60100020
*                                         NO, DIFFERENCE IS NOT ONE     60200020
*                                         YES, DIFFERENCE IS ONE        60300020
         ICM   RBASE,HI,XFF             SET A SWITCH TO          X01004 60310004
*                                         SKIP RPS SO SEQUENTIAL S21101 60320021
*                                         'WRITES' HAVE NO SET   S21101 60330021
*                                         SECTOR CCW             S21101 60340021
         TM    CPBRDWR,CPBWRITB         IS THIS CPB FOR 'WRITE'  S21101 60350021
         BO    MEDIUM                     YES, WRITE MUST BE     S21101 60360021
*                                         AFTER SEARCH - TIC     S21101 60370021
*                                         NO, READS MAY BE       S21101 60380021
*                                         CHAINED TOGETHER       S21101 60390021
         SH    RDUMCPB,HALF32           MODIFY SECONDARY CPB BASES21101 60400021
*                                         FOR SMALL CPB                 60500020
         BAL   R6,SMALLCPB              GO BUILD SMALL CPB              60600020
*                                                                       60700020
         B     HUNTFF                   GO CHAIN CPBS TOGETHER          60800020
         EJECT                                                 @Z40X9QG 60830009
************************************************************** @Z40X9QG 60860009
*                                                                       60900020
* THERE ARE 2 CPB REGISTERS, RCPB POINTS TO THE NEW CPB TO RECEIVE      61000020
* THE DISK CHANNEL PROGRAM,RDUMCPB HAS A MODIFIED VALUE OF RCPB TO      61100020
* CAUSE CCWS TO BE BUILT AT LOWER LOCATIONS.                            61200020
* RDUMCPB IS RCPB    LARGE CPB (HAS ALL CCWS)                    S21101 61260021
* RDUMCPB IS RCPB-8  LARGE CPB (HAS ALL BUT SET SECTOR)          S21101 61320021
* RDUMCPB IS RCPB-8  MEDIUM CPB (NO SEEK)                        S21101 61380021
* RDUMCPB IS RCPB-16 MEDIUM CPB (NO SEEK NOR SET SECTOR)         S21101 61440021
* RDUMCPB IS RCPB-32 SMALL CPB (NO SEEK, SET SECTOR, SEARCH-TIC) S21101 61500021
*                                                                       61600020
************************************************************** @Z40X9QG 61630009
         SPACE 2                                               @Z40X9QG 61660009
LARGECPB EQU   *                        GENERATE SEEK HEAD CCW          61700020
         LA    R15,CPBBBCC              ADDR OF BBCCHH                  61800020
         ST    R15,CPBHEADF-IEDQCPB(0,RDUMCPB) PT TO BBCCHH             61900020
         MVI   CPBSEEK-IEDQCPB(RDUMCPB),CPBSEEKC SEEK OP CODE           62000020
         MVI   CPBSEKFL-IEDQCPB(RDUMCPB),CPBCCC COMMAND CHAIN           62100020
         LA    R15,CPBSEK6                                              62200020
         STH   R15,CPBSEKCT-IEDQCPB(0,RDUMCPB) SET SEEK COUNT TO 6      62300020
*                                                                       62400020
MEDIUMCP EQU   *                        AFTER OPTIONAL SET SECTORS21101 62403021
*                                         GENERATE SEARCH-TIC    S21101 62406021
         L     R2,AVTADEBR              GET DEB ADDR FOR       @Z40X9QG 62409009
*                                       REUS QUEUES            @Z40X9QG 62410009
         TM    IOSBEFLG,IOSBENRQ        NON-REUS QUEUES        @Z40X9QG 62411009
         BZ    REUS                     NO, BRANCH             @Z40X9QG 62412009
         L     R2,AVTADEBN              GET DEB ADDR FOR       @Z40X9QG 62413009
*                                       NON-REUS QUEUES        @Z40X9QG 62414009
REUS     EQU   *                                               @Z40X9QG 62415009
         L     R2,DEBUCBAD-IEDQDEB(,R2) GET UCB ADDRESS        @Z40X9QG 62416009
         LTR   RBASE,RBASE              CAN WE SKIP SET SECTOR   X01004 62419004
         BM    RPSSW1                   YES, BRANCH              X01004 62420004
         TM    UCBTBYT2-UCB(R2),RPS     IS RPS SUPPORTED         S21101 62421021
RPSSW    BO    BUILDRPS                   YES, GO BUILD SET SECTOS21101 62424021
*                                         NO, SKIP SET SECTOR    S21101 62427021
RPSSW1   EQU   *                                                 X01004 62428004
         SH    RDUMCPB,HALF8            ADJUST PSEUDO CPB BASE   S21101 62430021
*                                         FOR MISSING SET SECTOR S21101 62433021
         B     SKIPRPS                  SKIP SET SECTOR CCW      S21101 62436021
         EJECT                                                 @Z40X9QG 62437009
************************************************************** @Z40X9QG 62438009
*                                                                S21101 62439021
BUILDRPS EQU   *                        BUILD SET SECTOR CCW     S21101 62442021
* SET UP PARAMETERS TO CALL SECTOR CONVERT ROUTINE               S21101 62445021
* R0 HAS DDKR                                                    S21101 62448021
*        DD -  PHYSICAL BLOCK SIZE                               S21101 62451021
*        K  -  KEYLENGTH                                         S21101 62454021
*        R  -  RECORD NUMBER                                     S21101 62457021
* R2 HAS DAAA                                                    S21101 62460021
*        D  -  UCB DEVICE TYPE CODE FROM UCB+19                  S21101 62463021
*        AAA-  POINTER TO ONE BYTE AREA TO RECEIVE SECTOR VALUE  S21101 62466021
* R14 HAS RETURN ADDRESS                                         S21101 62469021
* R15 HAS ENTRY ADDRESS (FROM CVT+232)                           S21101 62472021
*                                                                S21101 62475021
* R2 HOW HAS ADDRESS OF UCB                                      S21101 62478021
*                                                                S21101 62481021
         IC    R2,UCBTBYT4-UCB(R2)      DEVICE TYPE CODE         S21101 62484021
         LA    R3,CPBSECTR-IEDQCPB(,RDUMCPB) SECTOR VALUE ADDRESSS21101 62487021
         ST    R3,CPBSETAF-IEDQCPB(,RDUMCPB) POINT CCW TO        S21101 62490021
*                                         SECTOR VALUE           S21101 62493021
         SLL   R3,BYTESHIF              ADDRESS TO TOP 3 BYTES   S21101 62496021
         SLDL  R2,FULLSHIF-BYTESHIF     R2 NOW HAS DAAA          S21101 62499021
*                                                                S21101 62502021
         L     R0,ZEROPARM              R0 NOW HAS DDKX          S21101 62508021
         ICM   R0,TWO,AVTKEYLE+INC      GET K OF DDKR            X01004 62509004
         IC    R0,CPBR                  R0 NOW HAS DDKR          S21101 62511021
*                                                                S21101 62514021
         L     R15,CVTPTR               GET CVT                  S21101 62517021
         USING CVT,R15                                           S21101 62520021
         L     R15,CVT0SCR1             GET ENTRY TO SECTOR      S21101 62523021
*                                         CONVERSION ROUTINE     S21101 62526021
         STM   R0,R12,AVTSAVE4          SAVE REGS CLOBBERED      S21101 62529021
*                                         BY CONVERT ROUTINE     S21101 62532021
         BALR  R14,R15                  CALCULATE SECTOR VALUE   S21101 62535021
*                                       BUILD SET SECTOR CCW     S21101 62538021
         DROP  R15                                               S21101 62541021
         LM    R0,R12,AVTSAVE4          RESTORE REGS             S21101 62544021
         MVI   CPBSET-IEDQCPB(RDUMCPB),CPBSETC SET SECTOR OP CODES21101 62547021
         LA    R15,CPBSET1              GET COUNT OF 1           S21101 62550021
         ST    R15,CPBSETCT-2-IEDQCPB(RDUMCPB) CCW AND CLEAR     S21101 62553021
*                                         UNUSED BYTE            S21101 62556021
         MVI   CPBSETFL-IEDQCPB(RDUMCPB),CPBCCC COMMAND CHAIN    S21101 62559021
         EJECT                                                 @Z40X9QG 62560009
SKIPRPS  EQU   *                                                 S21101 62562021
         LA    R15,CPBCCHHR                                             62600020
         ST    R15,CPBSRECF-IEDQCPB(0,RDUMCPB) ADDR OF CCHHR            62700020
         MVI   CPBSRCH-IEDQCPB(RDUMCPB),CPBSRCHC SEARCH ID EQ OP        62800020
         MVI   CPBSRHFL-IEDQCPB(RDUMCPB),CPBCCC COMMAND CHAIN           62900020
         LA    R15,CPBSRH5                                              63000020
         STH   R15,CPBSRHCT-IEDQCPB(0,RDUMCPB) COUNT FIELD TO 5         63100020
         LA    R15,CPBSRCH-IEDQCPB(0,RDUMCPB)                           63200020
         ST    R15,CPBTICSF-IEDQCPB(0,RDUMCPB) ADDR OF SEARCH CCW       63300020
         MVI   CPBTIC1-IEDQCPB(RDUMCPB),CPBTICC TIC OP CODE             63400020
*                                                                       63500020
SMALLCPB EQU   *                                                        63600020
         LA    RBASE,AVTEZERO(,RBASE)   RESET SWITCH IN BASE REG.X01004 63630004
*                                         TO TEST FOR RPS DEVICE S21101 63660021
         MVC   CPBRDWR-IEDQCPB(THREECCW,RDUMCPB),SAVECCW(R13) GET       63700020
*                                         BOTH RD/WR CCWS AND TIC       63800020
         MVI   CPBTIC2-IEDQCPB(RDUMCPB),FF SET OP CODE OF FINAL         63900020
*                                         TIC TO X'FF' TEMPORARILY      64000020
         BR    R6                       RETURN TO MAIN CODE             64100020
*                                                                       64200020
*                                                                       64300020
*                       LOCAL CONSTANTS                                 64400020
         DS    0F                       R0 PARAM TO SET SECTOR   S21101 64420021
ZEROPARM DC    H'6'                     DATALENGTH OF DISK RECORDS21101 64440021
*                                                                S21101 64480021
HALF8    DC    H'8'                     ADJUSTS FOR MEDIUM CPB   S22025 64500022
*                                       SIZE OF CCW              S22025 64700022
HALF32   DC    H'32'                    ADJUSTS FOR SMALL CPB    S21101 64900021
XFF      DC    X'FF'                    SWITCH FOR RPS SET SECTORX01004 64902004
         EJECT ,                                                 99226  64904022
*                                                                99226  64908022
* THE WTORTN IS A WTO MESSAGE WRITTEN AT DISK ERP TIME.          99226  64912022
*   IT IS CALLED UPON TO SEND A MESSAGE TO THE OPERATOR BY       99226  64916022
*   IEDQFQ, IGG019Q8,IGG019R6                                    99226  64920022
*                                                                99226  64924022
* A CHECK IS ALSO MADE FOR THE TYPE OF DISK ERROR.               99226  64928022
*   IF IT IS A DISK WRITE ERROR, A QUICK CLOSEDOWN IS REQUESTED. 99226  64932022
*   IF IT IS A DISK READ ERROR, AN ABEND IS ISSUED.              99226  64936022
*                                                                99226  64940022
*   ENTRY HERE IS THROUGH A BRANCH TO THE ADDRESS IN THE         99226  64944022
*          SECOND WORD OF IGG019RC                               99226  64948022
*                                                                99226  64952022
*   INPUT--R13 HAS AVTSAVE2                                      99226  64956022
*          R7 HAS CPB BASE                                       99226  64960022
*          R14 HAS RETURN ADDRESS                                99226  64964022
*          R15 HAS ENTRY POINT                                   99226  64968022
*                                                                99226  64972022
*   OUTPUT-ALL REGISTERS ARE UNCHANGED                           99226  64976022
*                                                                99226  64980022
*   EXTERNAL ROUTINES--DSPPOSTR--PUTS CLOSEDOWN ELEMENT ON       99226  64984022
*          READY QUEUE IN CASE OF DISK WRITE ERRORS              99226  64988022
*                                                                99226  64992022
*   EXITS-NORMAL - N/A                                           99226  64996022
*                                                                99226  65000022
*   EXITS-ERROR                                                  99226  65004022
*          AVTABEND--TO ABEND S045 U008 DISK READ ERROR          99226  65008022
*                                                                99226  65012022
*          RETURN TO CALLING PROGRAM TO AWAIT CLOSEDOWN ON       99226  65016022
*          DISK WRITE ERRORS                                     99226  65020022
*                                                                99226  65024022
*                                                                99226  65028022
WTORTN   DS    0H                                                99226  65032022
         STM   R14,R12,12(R13)                                   99226  65036022
         BALR  RBASE,0                  ESTABLISH ADDRESSABILITY 99226  65040022
         USING *,RBASE                                           99226  65044022
         USING IEDQCPB,RCPB                                      99226  65048022
*        USING IEDQAVTD,RAVT                                     99226  65052022
*        USING IEDQPRF,RPREFIX                                   99226  65056022
         DROP  RIOSBE                                          @Z40X9QG 65060009
         USING IEDQDISP,R11                                      99226  65064022
         UNPK  MSGECBCC(3),CPBECBCC(2)  GET COMPLETION CODE      99226  65068022
         UNPK  MSGFLAG1(9),CPBFLAG1(5)  GET FLAG1-2,SENS0-1      99226  65072022
         UNPK  MSGCSW(9),CPBFLAG3(5)    GET FLAG3 AND HALF CSW   99226  65076022
         UNPK  MSGCSW+8(9),CPBCSW+3(5)  GET LAST HALF CSW        99226  65080022
         UNPK  MSGADDR(7),CPBADDR+1(4)  GET DISK ADDRESS         99226  65088022
         TR    MSGECBCC(46),TRTABLE     MAKE IT PRINTABLE        99226  65092022
         MVC   MSGUCBID(3),CPBUCBID     GET UCB IDENTIFICATION @XA06323 65094061
         MVC   MSGECBCC+2(2),COMBLNK    SEPARATE WITH FIELD      99226  65096022
         MVC   MSGFLAG1+8(2),COMBLNK      SEPARATORS, A COMMA    99226  65100022
         MVC   MSGCSW+16(2),COMBLNK       AND A BLANK            99226  65104022
         MVC   MSGUCBID+3(2),COMBLNK                             99226  65108022
         MVI   MSGADDR+6,AVTEPER        PUT PERIOD AT END        99226  65112022
         NI    CPBADDR,AVTEFF-EXCLVAL   RESET ERROR FLAG         99226  65114022
         TM    CPBRDWR,CPBWRITB         IS CPB FOR WRITE         99226  65116022
         BZ    BADREAD                    NO, READ               99226  65120022
*                                                                99226  65124022
*                                         YES, WRITE             99226  65128022
         MVC   MSGRDWR(3),WR            SET TO WRITE             99226  65132022
*                                                                99226  65136022
* REQUEST A CLOSEDOWN IF NOT ALREADY REQUESTED                   99226  65140022
*                                                                99226  65144022
         CLI   AVTHRESS,THRESHFF        REQUEST FOR CLOSEDOWN YET99226  65148022
         BNE   DISKERR                    YES, CONTINUE          99226  65152022
*                                         NO,REQUEST IT          99226  65156022
         LA    R1,AVTHRESE              PASS ADDRESS OF CLOSEDOWN99226  65160022
*                                         ELEMENT TO DISPATCHER  99226  65164022
*                                         TO BE POSTED TO QUICK  99226  65168022
*                                         CLOSEDOWN              99226  65172022
         MVI   AVTHRESE+CLOSETYP,QUICK  SET CLOSE AS QUICK       99226  65176022
         MVI   AVTHRESS,THRESHF0        MARK ELEMENT POSTED      99226  65180022
         L     R11,AVTEA                GET DISPATCHER           99226  65184022
         LR    R5,R7                    SAVE CPB BASE            99226  65188022
         BAL   R14,DSPPOSTR             GO TO DISPATCHER         99226  65192022
*                                                                99226  65196022
         LR    R7,R5                    RESTORE CPB BASE         99226  65200022
         B     DISKERR                  GO TO WTO                99226  65204022
*                                                                99226  65208022
         EJECT                                                 @Z40X9QG 65210009
BADREAD  EQU   *                                                 99226  65212022
         MVC   MSGRDWR(3),RD            SET TO READ              99226  65216022
*                                                                99226  65220022
DISKERR  EQU   *                                                 99226  65224022
         CLI   CNT,MSGCNT               TEST COUNT EXCEEDED      99226  65228022
         BNL   RETURNX                    IF YES,SKIP WTO        99226  65232022
*                                         IF NO, WRITE MSG       99226  65236022
         SR    R3,R3                    INCREMENT WTO COUNT      99226  65240022
         IC    R3,CNT                                            99226  65244022
         LA    R3,1(,R3)                                         99226  65248022
         STC   R3,CNT                                            99226  65252022
         WTO   MF=(E,MSGNAME)           DISPLAY ERROR MESSAGE    99226  65256022
*                                                                99226  65260022
         CLI   CNT,MSGCNT               TEST LAST OF COUNT       99226  65264022
         BL    RETURNX                    IF NO, SKIP LAST MSG   99226  65268022
*                                         IF LAST, WRITE SUCH MSG99226  65272022
         WTO   MF=(E,MSGNAME2)          PRINT STOPPED MSG        99226  65276022
RETURNX  DS    0H                                                99226  65280022
         TM    CPBRDWR,CPBWRITB         IS CPB FOR WRITE         99226  65284022
         BNZ   RETURN                     YES, RETURN            99226  65288022
*                                         NO, ABEND              99226  65292022
         LA    R15,ABCODE               SET ABEND CODE           99226  65296022
         BAL   R14,AVTABEND             ABEND                    99226  65300022
*                                                                99226  65304022
RETURN   RETURN (14,12)                                          99226  65308022
*                                                                99226  65312022
CLOSETYP EQU   8                        CLOSEDOWN TYPE           99226  65316022
QUICK    EQU   X'30'                    QUICK CLOSE IN CLOSEDOWN 99226  65320022
CNT      DC    X'00'                    COUNTER FOR DISK WTOS    99226  65324022
MSGCNT   EQU   X'05'                    DISK WTO MAX             99226  65328022
ABCODE   EQU   X'08'                    DISK READ ERROR CODE     99226  65332022
RD       DC    CL3'RD '                 READ IDENTIFIER          99226  65336022
WR       DC    CL3'WR '                 WRITE IDENTIFIER         99226  65340022
EXCLVAL  EQU   X'01'                    REVERSE BIT              99226  65344022
COMBLNK  DC    CL2', '                  FIELD SEPARATOR          99226  65348022
*                                                                99226  65352022
   TITLE 'IGG019RC-IEDQFP-ABSOLUTE RECORD NUMBER TO MBBCCHHR CONVERTER' 65400022
IEDQFP   DS    0H                                                       65500020
         SPACE 1                                               @Z40X9QG 65530009
************************************************************** @Z40X9QG 65560009
*                                                                     * 65600020
*TITLE   'IEDQFP' - ABSOLUTE RECORD NUMBER TO MBBCCHHR CONVERTER      * 65700020
*                                                                     * 65800020
*STATUS - CHANGE LEVEL 0                                              * 65900020
*                                                                     * 66000020
*FUNCTION/OPERATION - THE PURPOSE OF THIS ROUTINE IS TO CONVERT       * 66100020
*   THE ABSOLUTE RECORD NUMBER INTO AN MBBCCHHR DISK ADDRESS FOR      * 66200020
*   A MULTIVOLUME QTAM DISK MESSAGE QUEUE.                            * 66300020
*                                                                     * 66400020
*   THE DISK MESSAGE QUEUE CONSISTS OF ONE OR MORE SIMILAR EXTENTS    * 66500020
*   OF ONE FIXED, UNBLOCKED DATA SET, ONE ON EACH OF ONE OR MORE      * 66600020
*   DISK DRIVES OF THE SAME TYPE.  EACH EXTENT MUST CONTAIN THE       * 66700020
*   SAME NUMBER OF CONTINUOUS CYLINDERS ON A CYLINDER BOUNDARY.       * 66800020
*                                                                     * 66900020
*   THE RECORDS ARE ASSIGNED TO THE DISKS IN THE FOLLOWING ORDER -    * 67000020
*   SEQUENTIALLY ON THE FIRST TRACK ON THE FIRST CYLINDER OF THE      * 67100020
*   FIRST EXTENT.  THEN SEQUENTIALY ON THE FIRST TRACK OF THE         * 67200020
*   FIRST CYLINDER ON THE SECOND EXTENT, AND SO ON UNTIL THE FIRST    * 67300020
*   TRACK OF ALL EXTENTS ARE ASSIGNED.  THEN CONTINUE BACK ON THE     * 67400020
*   FIRST EXTENT WITH THE SECOND TRACK OF THE FIRST CYLINDER. THEN    * 67500020
*   THE SAME FOR THE SECOND EXTENT, AND SO ON.  THIS PROCESS IS       * 67600020
*   REPEATED FOR THE REST OF THE FIRST CYLINDER OF ALL EXTENTS.       * 67700020
*   PROCEED TO THE SECOND CYLINDER, AND CONTINUE THRU THE DATA SET.   * 67800020
*   THIS ALGORITHM IS DESIGNED FOR USE WITH MULTIPLE ARM SUPPORT.     * 67900020
*                                                                     * 68000020
*ENTRY POINTS -                                                       * 68100020
*        'IEDQFP - CONVERT ABSOLUTE RECORD NUMBER TO MBBCCHHR         * 68200020
*   CALLING SEQUENCE IS                                               * 68300020
*        LA    R15,IEDQFP                                             * 68400020
*        BALR  R14,R15                                                * 68500020
*                                                                     * 68600020
*INPUT - RCPB HAS THE ADDR OF THE CPB WHICH CONTAINS IN THE CPBADDR   * 68700020
*   FIELD THE ABSOLUTE RECORD NUMBER TO BE CONVERTED.  REGISTER 13    * 68800020
*   POINTS TO AVTSAVE2. R15 HAS ENTRY ADDRESS.R14 HAS EXIT ADDRESS    * 68900020
*                                                                     * 69000020
*   THE AVT HAS TWO 6 WORD AREAS INITIALIZED TO HAVE THE FOLLOWING    * 69100020
*   FULLWORD VALUES.  A BIT IN CPBFLAG DETERMINES WHICH 6 WORD AREA   * 69200020
*   IS TO BE USED.  (ONE GROUP IS FOR REUSABLE DISK, THE OTHER FOR    * 69300020
*   NON-REUSABLE DISK QUEUES.)                                        * 69400020
*                                                                     * 69500020
*        AVTDQDEB DC F'0' ADDRESS OF DEB OF DISK QUEUE DCB            * 69600020
*        AVTNOVOL DC F'0' NUMBER OF EXTENTS                           * 69700020
*        AVTRCTRK DC F'0' NUMBER OF RECORDS PER TRACK                 * 69800020
*        AVTTRCYL DC F'0' NUMBER OF TRACKS PER CYLINDER               * 69900020
*        AVTTOTNO DC F'0' NUMBER OF RECORDS IN ENTIRE DATA SET        * 70000020
*        AVTVOLRT DC F'0' PRODUCT OF NO. OF VOLUMES * NO. RECORDS     * 70100020
*                          PER TRACK                                  * 70200020
*                                                                     * 70300020
*OUTPUT - ALL REGISTERS ARE UNCHANGED.  IN THE CPB, THE               * 70400020
*   CPBABSAD FIELD OF THE CPB NOW CONTAINS THE MBBCCHHR.  ALL OTHER   * 70500020
*   FIELDS, INCLUDING THE INPUT FIELD, CPBADDR, ARE UNCHANGED,        * 70600020
*   EXCEPT THE COMMAND CHAIN BIT IN SECOND READ/WRITE CCW IS          * 70700020
*   TURNED OFF.                                                       * 70800020
*                                                                     * 70900020
*EXTERNAL REFERENCES - THE ABSOLUTE CYLINDER ID COMES FROM DEB EXTENT * 71000020
*                                                                     * 71100020
*   THE DSECT OF THE AVT IS TO BE PROVIDED BY THE MACRO, 'AVT'.       * 71200020
*                                                                     * 71300020
*   THE ROUTINE MAKES NO CALL TO ANY EXTERNAL SUBROUTINE.  THUS IT    * 71400020
*   DOES NOT CHANGE THE VALUE IN R13, HAVING NO SAVEAREA OF ITS OWN.  * 71500020
*                                                                     * 71600020
*EXITS-NORMAL - ALL REGISTERS REMAIN UNCHANGED.  NO RETURN CODE.      * 71700020
*   CPBABSAD FIELD OF THE CPB NOW CONTAINS THE REQUIRED MBBCCHHR.     * 71800020
*   RETURN IS MADE TO THE ADDRESS IN R14                              * 71900020
*                                                                     * 72000020
*EXITS-ERROR  --  ABEND CODE S045 U001 - NON-REUS DISK WRAP           * 72100020
*   ABEND CODE S045 U005 - CPB REQUESTING I/O ON UNOPENED DATA SET    * 72200020
*                                                                     * 72300020
*TABLES/WORKAREAS - ALL LOCAL STORAGE IS IN REGISTERS. REFERENCE      * 72400020
*   IS MADE TO THE AREAS OF THE AVT DESCRIBED UNDER 'INPUT' ABOVE.    * 72500020
*   IN THE CPB, THE FIELD CPBTTR IS REFERENCED, AND THE FIELD         * 72600020
*   CPBABSAD MODIFIED.                                                * 72700020
*                                                                     * 72800020
*ATTRIBUTES - REUSABLE, REFRESHABLE                                   * 72900020
*                                                                     * 73000020
*NOTES - THE OPERATION OF THIS SUBROUTINE DOES NOT DEPEND UPON A      * 73100020
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER      * 73200020
*   SET.                                                              * 73300020
*                                                                     * 73400020
*   A MESSAGE IS DISPLAYED WITH 'WTO',ROUTCDE=(2,11),DESC=6           * 73500020
*   'IED076I TCAM NON-REUSABLE DISK THRESHOLD CLOSEDOWN' - THE SYSTEM * 73600020
*   IS CLOSING DOWN DUE TO AN IMPENDING FULLNESS OF THE DISK.         * 73700020
*                                                                     * 73800020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 73900020
         EJECT                                                 @Z40X9QG 73950009
*                                                                       74000020
*                        REGISTER USAGE DEFINITIONS                     74100020
*                                                                       74200020
*15      EQU   15                       PROGRAM BASE                    74300020
*14      EQU   14                       RETURN ADDRESS                  74400020
*13      EQU   13                       CALLER'S SAVEAREA               74500020
*12      EQU   12                                                       74600020
RVOLRT   EQU   12                       PRODUCT OF NO. OF VOLUMES       74700020
*                                         TIMES NO. RECORDS PER TRK     74800020
RTOTNO   EQU   11                       TOTAL NO. OF RECORDS IN         74900020
*                                         ENTIRE DATA SET               75000020
RTRCYL   EQU   10                       NO. TRACKS PER CYLINDER         75100020
RRCTRK   EQU   9                        NO. RECORDS PER TRACK           75200020
RNOVOL   EQU   8                        NO. OF EXTENTS                  75300020
RDEBX    EQU   7                        ADDR OF DEB OF DISK Q           75400020
*7       EQU   7                        7-12 LOADED FROM AVT            75500020
RCPBX    EQU   6                        BASE OF CPB DSECT               75600020
*5       EQU   5                        UNUSED IN CONVERT ROUTINE       75700020
*4       EQU   4                        UNUSED IN CONVERT ROUTINE       75800020
*3       EQU   3                        2-3 EVEN ODD PAIR FOR DIVISION  75900020
*2       EQU   2                        2-3 EVEN ODD PAIR FOR DIVISION  76000020
*1       EQU   1                        1-0 EVEN ODD PAIR FOR DIVISION  76100020
*0       EQU   0                        1-0 EVEN ODD PAIR FOR DIVISION  76200020
*                                                                       76300020
         DROP  RCPB                                                     76400020
         DROP  RDEB                                                     76500020
         USING *,R15                    PROGRAM BASE                    76600020
         USING IEDQCPB,RCPBX            BASE OF CPB DSECT               76700020
         USING IEDQDEBX,RDEBX           BASE OF DEB EXTENT DSECT        76800020
         EJECT                                                 @Z40X9QG 76850009
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 76900020
*                                                                       77000020
*                        ENTRY POINT                                    77100020
*                                                                       77200020
         STM   R14,R12,HISREG14(R13)    SAVE REGISTERS                  77300020
         LA    RCPBX,0(,RCPB)           CLEAR HIGH BYTE AND             77400020
*                                         SET CPB DSECT BASE            77500020
         L     R1,CPBADDR               GET ABS. REC. NO. FROM CPB      77600020
         LA    R1,0(,R1)                CLEAR HIGH BYTE                 77700020
         LA    R1,ROUNDER(R1)           ADJUST THE               S21101 77750020
         SRL   R1,DIV4                    RELATIVE RECORD NO.    S21101 77800020
         TM    CPBADDR+LORDER,CPBQTYPE  IS CPB FOR REUSABLE DISK S21101 77850020
         BO    PEUSDISK                   YES, REUSABLE DISK            77900020
*                                         NO, NON-REUSABLE              78000020
         LM    R7,R12,AVTADEBN          GET VALUES FROM AVT             78100020
         L     R0,AVTHRESN              GET THRESHOLD VALUE             78200020
         CR    R1,R0                    DOES THIS RECORD EXCEED THE     78300020
*                                         THRESHOLD                     78400020
         BH    EXCEED                     YES, THRESHOLD EXCEEDED       78500020
*                                         NO, WITHIN LIMITS OK          78600020
*                                                                       78700020
* ABSOLUTE RECORD NUMBER / TOTAL NO OF RECORDS GIVES                    78800020
* QUOTIENT - IGNORED                                                    78900020
* REMAINDER- RELATIVE RECORD NUMBER                                     79000020
CONTINUE EQU   *                                                        79100020
         LTR   RTOTNO,RTOTNO            HAS OPEN DONE THIS TYPE OF      79200020
*                                         DISK MSG Q                    79300020
         BZ    NOTOPEN                    NO, DATA SET NOT OPEN         79400020
*                                         YES, IT IS OPEN OK            79500020
         SR    R0,R0                    CLEAR EVEN REG FOR DIVISION     79600020
         DR    R1-1,RTOTNO                                              79700020
         TM    CPBADDR+LORDER,CPBQTYPE  IS CPB FOR REUSABLE DISK S21101 79800020
         BO    NOTWRAP                    YES, REUSABLE DISK            79900020
*                                         NO, NON-REUSABLE DISK         80000020
         LTR   R1,R1                    HAS ENTIRE DATA BEEN USED       80100020
         BZ    NOTWRAP                    NO, NOT WRAPPED               80200020
*                                         YES, NON-REUSABLE DISK        80300020
*                                           IS TRYING TO WRAP           80400020
         LA    R15,ABEND1               PASS SUBCODE IN R15             80500020
         BAL   R14,AVTABEND             ABEND, OUT OF SPACE NON REUS    80600020
*                                                                       80700020
NOTOPEN  EQU   *                                                        80800020
         LA    R15,ABEND5               PASS SUBCODE IN R15             80900020
         BAL   R14,AVTABEND             ABEND, DISK DCB NOT OPEN        81000020
*                                                                       81300020
NOTWRAP  EQU   *                                                        81400020
         SRDA  R0,FULLSHIF              MOVE REMAINDER TO ODD REG       81500020
         EJECT                                                 @Z40X9QG 81550009
*                                                                       81600020
* RELATIVE RECORD NUMBER / PRODUCT OF NO. VOLS AND NO. REC PER TRK      81700020
* QUOTIENT - RELATIVE TRACK                                             81800020
* REMAINDER - RELATIVE RECORD NO. ON THIS ROW OF TRACKS                 81900020
*                                                                       82000020
         DR    R1-1,RVOLRT                                              82100020
*                                                                       82200020
* R1 HAS RELATIVE TRACK, R0 HAS RELATIVE RECORD NO. ON THIS ROW         82300020
*                                                                       82400020
         LR    R3,R1                    GET RELATIVE TRACK              82500020
         SR    R2,R2                    CLEAR EVEN REG FOR DIVISION     82600020
*                                                                       82700020
* RELATIVE TRACK / NO. TRACKS PER CYL GIVES                             82800020
* QUOTIENT - RELATIVE CYLINDER NO.                                      82900020
* REMAINDER- RELATIVE TRACK NO.                                         83000020
*                                                                       83100020
         DR    R3-1,RTRCYL                                              83200020
*                                                                       83300020
* R3 HAS RELATIVE CYLINDER NO, R2 HAS RELATIVE TRACK NO.                83400020
*                                                                       83500020
* RELATIVE RECORD NO. ON THIS ROW OF TRACKS / NO RECORDS PER TRACK      83600020
* QUOTIENT - RELATIVE DRIVE NUMBER                                      83700020
* REMAINDER- RELATIVE RECORD NUMBER                                     83800020
*                                                                       83900020
         SRDA  R0,FULLSHIF              CLEAR EVEN REG.                 84000020
         DR    R1-1,RRCTRK                                              84100020
*                                                                       84200020
* R1 HAS RELATIVE DRIVE NUMBER, R0 HAS RELATIVE RECORD NUMBER           84300020
*                                                                       84400020
         XR    R1,R0                    SWAP REGISTERS R0, R1           84500020
         XR    R0,R1                                                    84600020
         XR    R1,R0                                                    84700020
         EJECT                                                 @Z40X9QG 84750009
*                                                                       84800020
* R0 HAS RELATIVE DRIVE NUMBER, R1 HAS RELATIVE RECORD NUMBER           84900020
*                                                                       85000020
         STC   R0,CPBABSAD              SET M OF MBBCCHHR               85100020
         XC    CPBBBCC(LBB),CPBBBCC     SET BB OF MBBCCHHR TO 0         85200020
         LA    R1,INC(,R1)              MAKE REC. NO. REL. TO 1         85300020
         STC   R1,CPBR                  SET R OF MBBCCHHR               85400020
         STC   R2,CPBHHR+INC            GET REL TRACK NO.               85500020
         SRL   R2,BYTESHIF                                              85600020
         STC   R2,CPBHHR                                                85700020
*                                                                       85800020
         LA    R1,DEBEXTLM              GET SIZE OF EACH DEB EXTENT     85900020
         MR    R1-1,R0                  MULT BY RELATIVE DRIVE NO.      86000020
         LA    RDEBX,DEBEXTPT(RDEBX,R1) BUMP DEB PT TO PROPER EXT       86100020
         AH    R3,DEBSTRCC              GET ABSOLUTE CYLINDER ADDR      86200020
         STC   R3,CPBCCHHR+INC            INTO MBBCCHHR                 86300020
         SRL   R3,BYTESHIF                                              86400020
         STC   R3,CPBCCHHR                                              86500020
         LM    R14,R12,HISREG14(R13)    RESTORE REGISTERS               86600020
         BR    R14                      RETURN TO MAIN ROUTINE          86700020
*                                                                       86800020
*                                                                       86900020
PEUSDISK EQU   *                                                        87000020
         LM    R7,R12,AVTADEBR          GET VALUES FROM AVT             87100020
         B     CONTINUE                 BRANCH TO GET REL REC NO.S22025 87200022
*                                                                       87300020
EXCEED   EQU   *                                                        87400020
         TM    AVTBIT1,AVTREADN         IS CHECKPOINT OPEN DOING        87500020
*                                         THIS CPB (OR, HAS READY NOT   87600020
*                                         BEEN EXECUTED YET)            87700020
         BZ    CONTINUE                   YES, CKPOINT,IGNORE THRESHOLD 87800020
*                                         NO, USUAL DISK TRAFFIC        87900020
         CLI   AVTHRESS,THRESHFF        HAS CLOSEDOWN BEEN REQUESTED    88000020
         BNE   CONTINUE                   YES, IGNORE THRESHOLD         88100020
*                                         NO, REQUEST THRESHOLD         88200020
         MVI   AVTHRESS,THRESHF7        MARK IT AS REQUESTED            88300020
         LR    R3,R1                    SAVE VALUE OF ADDR              88400020
*                                                                       88500020
         WTO   MF=(E,IED076I)           THRESHOLD CLOSEDOWN MSG         88600020
*                                                                       88800020
         L     R15,HISREG15(R13)        RELOAD PGM BASE                 88900020
         LR    R1,R3                    RESTORE VALUE OF ADDR           89000020
         B     CONTINUE                 RETURN                   S22025 89100022
*                                                                       89200020
         EJECT                                                 @Z40X9QG 89300009
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 89400020
*                                                                       89500020
*                       WRITE - TO - OPERATOR                           89600020
*                                                                       89700020
************************************************************** @Z40X9QG 89730009
         SPACE 2                                               @Z40X9QG 89760009
IED076I  WTO   'IED076I TCAM NON-REUSABLE DISK THRESHOLD CLOSEDOWN',   *89800020
               ROUTCDE=(2,11),DESC=4,MF=L                               89900020
         ENTRY IED076I                                                  90000020
IED140I  WTO   'IED140I TCAM DISK ERROR 41, F1F2S0S1, F3CSWCSWCSWCSWCS,*90020022
                UCB, RD ADDRESS',ROUTCDE=(2,10,11),DESC=4,MF=L   99226  90040022
MSGNAME  EQU   IED140I                                           99226  90060022
MSGECBCC EQU   MSGNAME+28               2 BYTE ECB CODE          99226  90080022
MSGFLAG1 EQU   MSGNAME+32               8 BYTE FLAG1-2,SENS0-1   99226  90100022
MSGCSW   EQU   MSGNAME+42               16 BYTE FLAG3 AND CSW    99226  90120022
MSGUCBID EQU   MSGNAME+60               3 BYTE UCBID             99226  90140022
MSGRDWR  EQU   MSGNAME+65               2 BYTE TYPE OPERATION    99226  90160022
MSGADDR  EQU   MSGNAME+68               6 BYTE DISK ADDR         99226  90180022
         ENTRY IED140I                                           99226  90200022
IED139I  WTO   'IED139I PRINTING STOPPED',                       99226 *90220022
               ROUTCDE=(2,10,11),DESC=4,MF=L                     99226  90240022
         ENTRY IED139I                                           99226  90260022
MSGNAME2 EQU   IED139I                                           99226  90280022
TRTABLE  EQU   *-239                    TRANSLATE TABLE          99226  90300022
         DC    C' 0123456789ABCDEF'     TRANSLATE TABLE          99226  90320022
         EJECT                                                 @Z40X9QG 90410009
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 90500020
*                                                                       90600020
*                        DSECTS                                         90700020
*                                                                       90800020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 90900020
IEDQDEBX DSECT                                                          91100020
DEBEXTPT EQU   68                       POINTER TO FIRST DEB EXTENT     91200020
DEBEXTLM EQU   16                       LENGTH OF EACH EXTENT           91300020
DEBDVMO  DS    0C                       DEVICE MODIFIER                 91400020
DEBUCBA  DS    A                        ADDRESS OF UCB                  91500020
         DS    2C                       RESERVED                        91600020
DEBSTRCC DS    CL2                      CYLINDER START ADDRESS          91700020
DEBSTRHH DS    CL2                      READ OR WRITE TRACK START ADDR  91800020
DEBENDCC DS    CL2                      CYLINDER END ADDRESS            91900020
DEBENDHH DS    CL2                      READ OR WRITE TRACK END ADDR    92000020
DEBNMTRK DS    H                        NUMBER OF TRACKS ALLOCATED      92100020
*                                         IN THIS EXTENT                92200020
*                                                                       92300020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 92400020
*                                                                       92500020
         EJECT                                                 @Z40X9QG 92550009
         TCPBD 3330                                              S21101 92600021
************************************************************** @Z40X9QG 92603009
*                                                                99226  92606022
* IN DISK ERROR CONDITIONS, DISK APPENDAGE PASSES                99226  92612022
* ERROR STATUS INFORMATION IN THE CPB AS FOLLOWS                 99226  92618022
*                                                                99226  92624022
************************************************************** @Z40X9QG 92626009
         SPACE 1                                               @Z40X9QG 92628009
         ORG   CPBSEEK                  REDEFINE FROM CPB START  99226  92630022
         DS    A                        RESERVED FOR IEDQFQ      99226  92636022
CPBFLAG3 DS    C                        FROM IOBFLAG3            99226  92642022
CPBCSW   DS    CL7                      FORM IOBCSW              99226  92648022
CPBFLAG1 DS    C                        FORM IOBFLAG1            99226  92654022
CPBFLAG2 DS    C                        FORM IOBFLAG2            99226  92660022
CPBSENS0 DS    C                        FORM IOBSENS0            99226  92666022
CPBSENS1 DS    C                        FROM IOBSENS1            99226  92672022
CPBECBCC DS    C                        FORM IOBECBCC            99226  92678022
CPBUCBID DS    CL3                      FROM UCBNAME             99226  92684022
*                                                                99226  92690022
CPBBBCC  EQU   CPBABSAD+1               BB OF MBBCCHHR                  92700020
CPBCCHHR EQU   CPBABSAD+3               CC OF MBBCCHHR                  92800020
CPBHHR   EQU   CPBABSAD+5               HH OF MBBCCHHR                  92900020
CPBR     EQU   CPBABSAD+7               R  OF MBBCCHHR                  93000020
         EJECT                                                 @Z40X9QG 93050009
         TIOSBED                                               @OZ26164 93100011
         EJECT                                                 @Z40X9QG 93320009
         TDEBD                                                          93500020
         EJECT                                                 @Z40X9QG 93530009
         TDATAD                                                  99226  93560022
         EJECT                                                 @Z40X9QG 93590009
         TPRFD                                                   99226  93620022
         EJECT                                                 @Z40X9QG 93660009
         TDISPD                                                         93700020
         EJECT                                                 @Z40X9QG 93800009
         TAVTD 2                                                        93900020
         EJECT                                                 @Z40X9QG 93905009
CVT      DSECT                                                   S21101 93910021
         CVT   RPS=YES                                           S21101 93920021
         EJECT                                                 @Z40X9QG 93925009
UCB      DSECT                                                   S21101 93930021
         IEFUCBOB                                                S21101 93940021
         EJECT                                                 @Z40X9QG 93945009
         DCBD  DSORG=TQ                                          S21101 93950021
         END                                                            94000020
