         TITLE '''IGG019RD'' - BUFFERED TERMINAL SCHEDULER'             00100020
IGG019RD CSECT                                                          00200020
*A-000000-999999                                               @X31X8I0 00200108
         SPACE 3                                                        00200322
*CHANGE ACTIVITY=AS FOLLOWS:                                            00200422
******************** MICROFICHE FLAGS *********************** SUPT CODE 00200522
*A231000,337100,337600,339150,339350,339415,354000,369000,375000 S21101 00200652
*A380000,409000,422000,445000,470000,584000,635000,639000,642000 S21101 00200752
*A660000,697000,821000,845000,850000,851000,852000               S21101 00200852
*C151300,197000-227000,280000-309000,333000-334000,402000,409000 S21101 00200952
*C505000,532300,566000                                           S21101 00201052
*D329000,337200-337300,355000-366000,376000-377000,382000,410000 S21101 00201152
*D419000,446000,448000-452600,454000-456000,478000-482000,485000 S21101 00201252
*D510000,636000-638000,661000-668000,698000-703000,780000,844000 S21101 00201352
*D846000-849000                                                  S21101 00201452
*C458000,586000-587000                                           A48267 00201552
*A608000                                                         A48267 00201652
*A127000,169000,279180,279390,339350,368000,372300,611000,617000 S22025 00201752
*A639200,841500                                                  S22025 00201852
*C151300,177500,196160,279350,279390,422044,468000-469000,634000 S22025 00201952
*C673000,681000,821400,821600-821650,826000,826600               S22025 00202052
*D196280,279200-279280,279360,369000-369900,483000-487000        S22025 00202152
*D639210-639230                                                  S22025 00202252
*C532400                                                        SA52985 00202352
*A371400                                                        SA56605 00202452
*A279240,639223                                                 SA56606 00202552
*D735000,815000                                                 SA61794 00202652
*A732025-732525,A805025-805025                                   Y05331 00202705
*A584200                                                        SA52515 00205754
*A660600                                                        SA68697 00207705
*D532100-532500                                                @SA70320 00208061
*A657000,669000                                                 OX03968 00208505
*C673000                                                        OX03968 00209305
*A002000,842700                                                @Z30X8IM 00209408
*C008000,169400,265000,391200,422082,422086,498200,573000      @Z30X8IM 00209508
*D169600-169800,266000-267000,391400-391600,422084,422088      @Z30X8IM 00209608
*D498400-498600,571000,574000,639064-639066                    @Z30X8IM 00209708
*C639063                                                       @Z30X8IM 00209808
*A165000,676200,842700                                         @XA08074 00209909
*D732150,732200-732275,733000                                  @OY12394 00210091
*A584400,704000,706000,717000                                  @OX12490 00210191
*C322600,338000,339650,413600,470200,505600,726600,777600      @OY14092 00220191
*C504800                                                       @OX17153 00230100
*D805225,806000                                                @OZ33657 00235100
*C279410,279480                                                @OY21468 00236100
*A269200,372300,841650                                         @OY21468 00237100
*A528000                                                       @OZ34395 00238100
* $01=OZ42506    JTC2202  79.11.07  098061:                        @01A 00238625
* $02=OZ42847    JTC2202  79.12.19  098061:                        @02A 00239125
* $03=OZ43405    JTC2202  79.12.19  098061:                        @03A 00239625
* $11=OZ45902    ETC2302  80.07.15  723465:                        @11A 00239826
*                                                                       00240191
         SPACE 4                                                        00270191
*                                                                       00276191
         DC    AL2(TAG-IGG019RD)        DESTINATION SCHEDULER           00300020
*                                       LOGIC OFFSET                    00400020
         SPACE 4                                                        00500020
*********************************************************************** 00600020
*                                                                     * 00650052
*TITLE: 'IGG019RD' BUFFERED TERMINAL SCHEDULER                        * 00700020
*                                                                     * 00710022
* $MOD(IGG019RD) COMP(I@) PROD(TCAM):                              @01C 00720025
*                                                                     * 00730022
* DESCRIPTIVE NAME=BUFFERED TERMINAL SCHEDULER                        * 00740022
*                                                                     * 00750022
* COPYRIGHT='NONE'                                                    * 00760022
*                                                                     * 00770022
*  STATUS=CHANGE LEVEL 8                                       @Z30X8IM 00800008
*                                                                     * 00850052
*FUNCTION:                                                            * 00900020
*   THE PURPOSE OF THIS MODULE IS TO SCHEDULE SEND AND RECIEVE        * 01000020
*   OPERATIONS FOR BUFFERED TERMINALS,E.G., 2740 MODEL 2 AND 2770.    * 01100020
*   IN GENERAL, IT PERFORMS IN A MANNER ANALOGOUS TO THE SEND AND     * 01200020
*   RECIEVE SCHEDULERS FOR NON-BUFFERED TERMINALS.  THE SEND FUNCTION * 01300020
*   IS DIFFERENT DUE TO THE TERMINAL'S HAVING A HARDWARE BUFFER.      * 01400020
*   WHEN A BLOCK OF TEXT IS SENT TO A BUFFERED TERMINAL, THE          * 01500020
*   TRANSMISSION IS COMPLETE.  HOWEVER, TCAM MUST OBSERVE A TIME      * 01600020
*   DELAY EQUIVALENT TO THE TIME REQUIRED FOR THE TERMINAL TO EMPTY   * 01700020
*   ITS BUFFER ONTO ITS OUTPUT DEVICE.  THIS SCHEDULER MUST TRY TO    * 01800020
*   UTILIZE THE LINE FOR SENDING TO OR RECIEVING FROM OTHER TERMINALS * 01900020
*   ON THE LINE DURING THE TIME DELAY FOR THE TERMINAL TO WHICH THE   * 02000020
*   LAST BLOCK OF TEXT WAS SENT.  FLAGS IN THE DESTINATION QCBSTAT    * 02100020
*   INDICATE WHETHER THE TERMINAL IS IN SEND OR RECIEVE MODE.  THESE  * 02200020
*   STATES ARE MUTUALLY EXCLUSIVE.                                    * 02300020
*                                                                     * 02400020
*   THIS ROUTINE WAITS IN THE DESTINATION QCB AND THE LCB.  THERE IS  * 02500020
*   A PHYSICAL STCB FOR EACH DESTINATION QCB AND LCB.  WHEN A BUFFER  * 02600020
*   IS POSTED TO THE DESTINATION QCB, THE BTS PASSES IT TO THE DESTI- * 02700020
*   NATION SCHEDULER(IEDQHM).  WHEN IEDQHM RECOGNIZES END-OF-MSG,     * 02800020
*   IT BRANCHES TO AN ENTRY POINT IN BTS(TAG).  IF THE LINE IS FREE,  * 02900020
*   THE LCB IS POSTED TO ITSELF UNING DSPPOSTR.  IF NOT AND AFTER     * 03000020
*   RETURN FROM THE DISPATCHER, THE QCB'S STCB FOR BTS IS LINKED INTO * 03100020
*   THE LCB'S STCB CHAIN.  THIS ACTION INDICATES THAT THERE IS A      * 03200020
*   MESSAGE FOR THE ASSOCIATED TERMINAL.  IF AUTOPOLL IS IN PROGRESS, * 03300020
*   IT IS STOPPED AND EXIT IS MADE TO IEDQHM.  IF NOT, AN EXIT IS MADE* 03400020
*   TO IEDQHM.                                                        * 03500020
*                                                                     * 03600020
*   WHEN THE LCB IS POSTED TO BTS, A TEST IS MADE FOR TYPE OF LAST    * 03700020
*   OPERATION.  IF THE LAST OPERATION WAS A RECIEVE, A TEST IS MADE   * 03800020
*   FOR SCHEDULING PRIORITY.  IF EQUAL PRIORITY IS SPECIFIED, A TEST  * 03900020
*   IS MADE FOR END OF INVITATION LIST.  IF NOT THE END, THE ERB IS   * 04000020
*   SET UP TO RECIEVE FROM THE NEXT ENTRY IN THE LIST, AND THE ERB IS * 04100020
*   POSTED TO THE BUFFER REQUEST QCB.                                 * 04200020
*                                                                     * 04300020
*   IF END OF INVITATION LIST, THE CURRENT INVLIST POINTER IS RESET   * 04400020
*   TO THE BEGINNING AND A TEST IS MADE FOR SOMETHING TO SEND TO A    * 04500020
*   TERMINAL ON THE LINE.  IF THE PRIORITY TEST INDICATED SEND PRTY,  * 04600020
*   A SEND TEST IS ALSO MADE.  IF NOTHING TO SEND, BTS INITIATES A    * 04700020
*   RECIEVE OPERATION ON THE FIRST ENTRY IN THE INVITATION LIST.      * 04800020
*                                                                     * 04900020
*   IF THERE IS SOMETHING TO SEND, THE NEXT BTS STCB IN THE LCB'S     * 05000020
*   STCB CHAIN IS DISPATCHED.  IF THE QCB REFLECTS AN EMPTY STATUS,   * 05100020
*   THE STCB IS REMOVED FROM THE LCB'S STCB CHAIN, QCBSEND IS TURNED  * 05200020
*   OFF, AND BTS EXITS TO THE DISPATCHER BY POSTING THE LCB TO ITSELF.* 05300020
*                                                                     * 05400020
*   IF THE QCB IS NOT EMPTY, A TEST IS MADE FOR SEND STATUS(QCBRECEV= * 05500020
*   0).  IF NON-ZERO, THE LOOP FOR TESTING FOR SOMETHING TO SEND IS   * 05600020
*   REENTERED.  IF NOT RECIEVE, QCBSEND IS TURNED ON.  THE ERB TO     * 05700020
*   INITIATE THE SENDING OPERATION IS MADE, AND BTS EXITS TO THE      * 05800020
*   DISPATCHER BY POSTING THE ERB TO DISK I/O QCB.                    * 05900020
*                                                                     * 06000020
*   IF THE LAST OPERATION ON THE LINE WAS A SEND, BTS MUST OBSREVE A  * 06100020
*   TIME DELAY FOR THE DESTINATION OF THE LAST BLOCK.  THE TIME DELAY * 06200020
*   IS STORED IN THE QCB, AND ITS STCB IS DELINKED FROM THE LCB'S STCB* 06300020
*   CHAIN.  THE QCB IS PASSED VIA BALR TO THE TIME DELAY ROUTINE      * 06400020
*   BRANCH ENTRY POINT(IEDQHG01).  THE 'SOMETHING-ELSE-TO-SEND' LOOP  * 06500020
*   IS ENTERED NOW.                                                   * 06600020
*                                                                     * 06700020
*   WHEN THE TIME DELAY EXPIRES, IEDQHG POSTS THE QCB TO A QCB IN THE * 06800020
*   BTS CSECT(BTSTDQCB).  BTS RETURNS THE QCB'S BTS STCB TO THE LCB'S * 06900020
*   STCB CHAIN.  IF THE LINE IS FREE, IT POSTS THE LCB TO ITSELF AND  * 07000020
*   EXITS TO THE DISPATCHER.  IF NOT, IT MERELY EXITS TO DISPATCHER.  * 07100020
*ENTRY POINT:                                                         * 07200020
*        IGG019RD                                                     * 07300020
*INPUT:                                                               * 07400020
*   1  - LINE CONTROL BLOCK OR BUFFER ADDRESS                         * 07500020
*   3  - SUBTASK CONTROL BLOCK ADDRESS                                * 07600020
*   7  - QUEUE CONTROL BLOCK ADDRESS                                  * 07700020
*   11 - DISPATCHER'S ADDRESS                                         * 07800020
*   13 - AVTSAVE2 ADDRESS                                             * 07900020
*   15 - ENTRY POINT ADDRESS                                          * 08000020
*OUTPUT:                                                              * 08100020
*        NONE                                                         * 08200020
*EXTERNAL ROUTINES:                                                   * 08300020
*        DSPPOSTR                                                     * 08400020
*        IEDQHG01 - TIME DELAY SUBTASK                                * 08500020
*EXITS-NORMAL:                                                        * 08600020
*        DSPBYPAS                                                     * 08700020
*        DSPPOST                                                      * 08800020
*        DSPDISP                                                      * 08900020
*EXIT-ERROR:                                                          * 09000020
*           NONE                                                      * 09100020
*TABLES/WORKAREAS:                                                    * 09200020
*        AVT                                                          * 09300020
*        LCB                                                          * 09400020
*        QCB                                                          * 09500020
*        SCB                                                          * 09600020
*        DCB                                                          * 09700020
*        DEB                                                          * 09800020
*        ILIST                                                        * 09900020
*        TERMINAL ENTRY                                               * 10000020
*ATTRIBUTES: RE-ENTRANT, REFRESHABLE, PROBLEM PROGRAM MODE            * 10100020
*NOTES:  THE OPERATION OF THIS MODULE DEPENDS UPON AN INTERNAL        * 10200020
*   REPRESENTATION OF THE EXTERNAL CHARACTER SET WHICH IS EQUIVALENT  * 10300020
*   TO THE ONE USED AT ASSEMBLY TIME.  THE CODING HAS BEEN ARRANGED   * 10400020
*   SO THAT REDEFINITION OF 'CHARACTER' CONSTANTS, BY REASSEMBLY,     * 10500020
*   WILL RESULT IN A CORRECT MODULE FOR THE NEW DEFINITIONS.          * 10600020
*********************************************************************** 10700020
         EJECT                                                          10800020
*                                                                     * 10900020
*           S Y M B O L I C     R E G I S T E R S                     * 11000020
*                                                                     * 11100020
RZERO    EQU   0                        WORK REGISTER                   11200020
RPARM    EQU   1                        PARAMETER REGISTER              11300020
RTEMP    EQU   2                        WORK REGISTER                   11400020
RSTCB    EQU   3                        SUBTASK CONTROL BLOCK           11500020
RILIST   EQU   4                        INVITATION LIST                 11600020
RPQCB    EQU   5                        PRIORITY LEVEL QCB              11700020
RSCB     EQU   9                        STATION CONTROL BLOCK           11800020
RQCB     EQU   7                        QUEUE CONTROL BLOCK             11900020
RDCB     EQU   8                        DATA CONTROL BLOCK              12000020
RTERM    EQU   6                        TERMINAL ENTRY                  12100020
RLCB     EQU   10                       LINE CONTROL BLOCK              12200020
RDISP    EQU   11                       DISPATCHER BASE REGISTER        12300020
RBASE    EQU   12                       CSECT BASE REGISTER             12400020
RAVT     EQU   13                       AVT BASE REGISTER               12500020
RETURN   EQU   14                       RETURN ADDRESS                  12600020
RENTRY   EQU   15                       ENTRY POINT ADDRESS             12700020
         SPACE 3                                                        12730022
CLEAR0F  EQU   X'0F'                    TO CLEAR HBFNO           S22025 12760022
         SPACE 2                                                        12800020
*                                                                     * 12900020
*        ESTABLISH CSECT AND CONTROL BLOCK ADDRESSABILITY             * 13000020
*                                                                     * 13100020
         BALR  RBASE,RZERO              ESTABLISH CSECT                 13200020
         USING *,RBASE                            ADDRESSABILITY        13300020
         USING IEDQDISP,RDISP           TCAM DISPATCHER                 13400020
         USING IEDQAVTD,RAVT            ADDRESS VECTOR TABLE            13500020
         USING IEDQQCB,RQCB             QUEUE CONTROL BLOCK             13600020
         USING IEDQSCB,RSCB             STATION CONTROL BLOCK           13700020
         USING IEDQLCB,RLCB             LINE CONTROL BLOCK              13800020
         USING IEDQTRM,RTERM            TERMINAL TABLE ENTRY            13900020
         USING IHADCB,RDCB              DATA CONTROL BLOCK              14000020
         USING IEDQSTCB,RSTCB           SUBTASK CONTROL BLOCK           14100020
         EJECT                                                          14200020
         CLI   RECBPRI-IEDQRECB(RPARM),PRILNFRE IS ELEMENT AN LCB       14300020
         BE    LASTOPN                  BRANCH IF YES                   14400020
*                                                                     * 14500020
*   PASSED ELEMENT IS A BUFFER POSTED TO A DESTINATION QCB.  IT       * 14600020
*   MUST NOW BE PASSED TO THE DESTINATION SCHEDULER FOR PROCESSING.   * 14700020
*                                                                     * 14800020
         L     RSTCB,QCBSLINK-1         ADDR OF DEST SCHED STCB         14900020
         B     DSPBYPAS                 ACTIVATE DEST SCHED             15000020
IGG019RD IEDHJN SELF,HJN                                                15060022
         SPACE 2                                                        15200020
LASTOPN  DS    0H                                                       15300020
         LA    RPARM,0(0,RPARM)         CLEAR HIGH-ORDER BYTE           15400020
         LA    RQCB,0(0,RQCB)           CLEAR HIGH-ORDER BYTE           15500020
         CR    RPARM,RQCB               IS POSTED ELEMENT AN LCB        15600020
         BE    LCBGO                    BRANCH IF YES                   15700020
*                                                                     * 15800020
*        INPUT ELEMENT IS AN ERB WITH RECALLED BUFFER                 * 15900020
*                                                                     * 16000020
         LA    RTEMP,LCBERB-IEDQLCB     ERB OFFSET INTO LCB             16100020
         SR    RPARM,RTEMP              COMPUTE LCB ADDRESS             16200020
         LR    RLCB,RPARM               LCB ADDRESSABILITY              16300020
         L     RSCB,LCBSCBA-1           SCB ADDRESSABILITY              16400020
         L     RDCB,LCBDCBPT            LINE GROUP DCB ADDRESS          16500020
         TM    LCBERBST,LCBRDERR        LOGICAL READ ERROR     @XA08074 16530009
         BO    ABEND045                 BRANCH IF YES          @XA08074 16560009
         L     RTEMP,LCBERBCH-1         RECALLED BUFFER ADDRESS         16600020
         OI    PRFSTAT1-IEDQPRF(RTEMP),PRFCNCLN SET CANCEL MSG FLAG     16700020
         MVC   LCBISZE(1),PRFSCAN+1-IEDQPRF(RTEMP) SET IDLE COUNT       16800020
         MVC   LCBTTBIN,SCBDCHDR        SET UP TNT OFFSET               16900020
         NI    SCBHBFNO,CLEAR0F         RESET HBFNO              S22025 16910022
         LA    RPARM,AVTINOUT           INMSG/OUTMSG DELIMITER          16920020
         STCM  RPARM,ADR,SCBMACR        RESET MACRO ADDRESS    @Z30X8IM 16940008
         MVC   SCBUNTCT(1),SCBDEOB                                      17020020
         MVC   SCBDEOB(4),LCBCPA        RESTORE AFTER RECALL            17050020
         TM    LCBERBST,LCBEOMSG        EOM IN RECALLED BUFFER          17200020
         BNO   BUILDERB                 BRANCH IF NO                    17300020
         LA    RTEMP,AVTACTIB           ACTIVATE ROUTINE QCB ADDR       17400020
         B     ACTIVATE                 GO SEND EOM BUFFER              17500020
         EJECT                                                          17550020
LCBGO    EQU   *                                                        17600020
         LR    RLCB,RPARM               GET LCB ADDRESS                 17700020
         NI    LCBSTAT2,AVTEFF-LCBSNDPR TURN OFF SEND PRIORITY   S22025 17750022
         L     RSCB,LCBSCBA-1           SCB ADDRESS                     17800020
*                                                                     * 17900020
*        FIND TERMNAME TABLE OFFSET FOR CURRENT INVLIST ENTRY         * 18000020
*                                                                     * 18100020
         L     RDCB,LCBDCBPT            LINE GROUP DCB ADDRESS          18200020
         L     RTEMP,LCBINVPT-1         CURRENT ILIST ENTRY ADDR        18300020
         SR    RPARM,RPARM              CLEAR REGISTER TO ZERO          18400020
         IC    RPARM,LCBUCBX            RLN-1                           18500020
         SLL   RPARM,2                  MULTIPLY BY FOUR                18600020
         L     RILIST,DCBINVLI(RPARM)   INVITATION LIST ADDRESS         18700020
         TM    LCBSTAT1,LCBSENDN        LAST OPERATION A SEND           18800020
         BO    DELAY                    BRANCH IF YES                   18900020
         L     RPARM,DCBDEBAD           DEB ADDRESS                     19000020
         TM    DEBOPATB-DEBNMSUB(RPARM),OUTONLY OUTPUT ONLY LINE        19100020
         BO    FREE                     BRANCH IF YES                   19200020
         CLI   0(RTEMP),FE              END OF ILIST                    19300020
         BE    PRITST                   BRANCH IF YES                   19400020
         CLI   1(RTEMP),FE              END OF LIST                     19500020
         BE    PRITST                   BRANCH IF YES                   19600020
         SPACE                                                          19602020
         TM    LCBSTAT2,LCBNEGRP        DID THE STATION HAVE     S21101 19604020
*                                         ANYTHING TO ENTER      S21101 19606020
         BO    PRITST                   NO, BRANCH               S21101 19608020
         L     RTEMP,LCBINVPT-1         GET CURRENT ENTRY        S21101 19610020
         LA    RTEMP,AVTEZERO(,RTEMP)   CLEAR HI BYTE            S21101 19612020
         BAL   RPQCB,GETQCBAD           GET QCB ADD FOR ENTRY    S21101 19614020
         SPACE 2                                                        19616022
         BAL   RPQCB,QCBRTNE            COMPUTE THE SCB ADDRESS  S21101 19618020
         SPACE                                                          19620020
         TM    SCBQTYPE,SCBBFMM         IS THIS MIDDLE OF MESSAGES21101 19622020
*                                         TO A BUFFERED TERMINAL S21101 19624020
         BZ    PRITST                   BRANCH NO                S21101 19626020
         L     RTEMP,LCBINVPT-1         CURRENT ENTRY RESET      S21101 19630020
         BAL   RPQCB,NEXTENT            BUMP ILIST PINTER,WEDONT S21101 19632020
*                                         WANT TO RE-POLL SAME   S21101 19634020
         EJECT                                                          22900020
PRITST   EQU   *                                                        23000020
*                                                                     * 23100020
         NI    LCBSTAT2,AVTEFF-LCBNEGRP RESET RESPONSE SWITCH    S21101 23150020
*        DECIDE WHETHER TO TRY TO SEND OR RECEIVE NOW                 * 23200020
*                                                                     * 23300020
         TM    DCBCPRI,EQPRI            EQUAL PRIORITY SPECIFIED        23400020
         BO    INVLTST                  BRANCH IF YES                   23500020
*                                                                     * 23600020
*    SINCE SEND PRIORITY IS SPECIFIED, MUST TEST FOR A QCB            * 23700020
*    FROM WHICH WE CAN SEND.                                          * 23800020
*                                                                     * 23900020
QCBCHECK EQU   *                                                        24000020
         CLC   LCBRSLNK,AVTDELAD+1      IS THERE A DEST QCB LINKED      24100020
*                                       TO THIS LCB, I.E., IS THERE     24200020
*                                       A BLOCK OF DATA TO BE SENT      24300020
         BNE   SENDTST                  BRANCH IF YES                   24400020
         EJECT                                                          24500020
INVLTST  EQU   *                                                        24600020
*                                                                     * 24700020
*     CHECK FOR END OF INVITATION LIST.  IF YES, RESET LCBINVPT       * 24800020
*     TO BEGINNING TO RESTART THE POLLING PASS AND SEE IF THERE       * 24900020
*     IS A BLOCK OF DATA TO BE SENT.                                  * 25000020
*                                                                     * 25100020
         SPACE 2                                                        25200020
         L     RTEMP,LCBINVPT-1         GET CURRENT ILIST ENTRY         25300020
         SR    RPARM,RPARM              CLEAR REGISTER TO ZERO          25400020
         IC    RPARM,LCBUCBX            RLN-1                           25500020
         SLL   RPARM,2                  MULTIPLY BY FOUR                25600020
         L     RILIST,DCBINVLI(RPARM)   INVITATION LIST ADDRESS         25700020
         CLI   EOL(RTEMP),FE            END OF ILIST                    25800020
         BE    RESET                    BRANCH IF YES                   25900020
         CLI   1(RTEMP),FE              END OF LIST FOR BISYNC          26000020
         BNE   RCV                      BRANCH IF NO                    26100020
RESET    EQU   *                                                        26200020
         LA    RTEMP,ILISTPRF(0,RILIST) BUMP PAST ILIST PREFIX TO       26300020
*                                       FIRST ENTRY IN ILIST            26400020
         STCM  RTEMP,ADR,LCBINVPT       RESET NEW CURRNT ENTRY @Z30X8IM 26500008
         CLI   1(RILIST),0              ANY ACTIVE ENTRIES              26800020
         BE    FREE                     BRANCH IF NO                    26900020
         CLC   LCBRSLNK,AVTDELAD+1      MSG TO SEND                     26910020
         BNE   SENDTST                  BRANCH IF YES                   26920020
         SR    RPARM,RPARM              CLEAR REGISTER TO ZERO          26930020
         IC    RPARM,DCBINTVL           POLLING DELAY FROM DCB          26940020
         LTR   RPARM,RPARM              DELAY SPECIFIED                 26950020
         BNZ   SETDELAY                 BRANCH IF YES                   26960020
         B     QCBCHECK                 CHECK FOR BLOCK TO SEND         27000020
         EJECT                                                          27100020
RCV      EQU   *                                                        27200020
*                                                                     * 27300020
*      BUILD ERB TO INITIATE A RECEIVE OPERATION ON THE LINE          * 27400020
*                                                                     * 27500020
         TM    LCBINSRC+2,LCBDLY        LCB IN TIME DELAY               27530020
         BO    FREE                     BRANCH IF YES                   27560020
         SPACE 2                                                        27900020
         L     RPARM,DCBDEBAD           GET DEB ADDRESS          S21101 27901020
         TM    DEBOPATB-DEBNMSUB(RPARM),OUTONLY       IS THIS AN S21101 27902020
*                                         OUTPUT ONLY LINE       S21101 27903020
         BO    FREE                     BRANCH IF YES            S21101 27904020
         SPACE                                                          27905020
         TM    AVTBIT1,AVTDLAYN+AVTCLOSN    IS THIS CLOSEDOWN OR S22025 27905122
*                                         SYSTEM DELAY           S22025 27905222
         BNZ   SETINDEX                 YES, BRANCH              S22025 27905322
         TM    LCBSTAT1,LCBOCNI         REQUEST FOR STOPLINE     S22025 27905422
         BZ    SETLOOP                  NO, BRANCH               S22025 27905522
SETINDEX EQU   *                                                 S22025 27905622
         OI    LCBSTAT2,LCBSNDPR        SET THE PRIORITY BIT     S22025 27905722
SETLOOP  EQU   *                                                 S22025 27905822
         L     RTEMP,LCBINVPT-1         CURRENT ENTRY            S21101 27906020
         LA    RTEMP,AVTEZERO(,RTEMP)   CLEAR THE HIGH ORDER BYTES21101 27907020
         ST    RTEMP,AVTDOUBL           SAVE FOR LOOP CONTROL    S21101 27908020
         B     STLOOP                   ENTER LOOP               S21101 27909020
         SPACE                                                          27910020
LOOPEXIT EQU   *                                                 S21101 27911020
         C     RTEMP,AVTDOUBL           WRAPPED ILIST ENTRIES    S21101 27912020
         BE    FREE                     BRANCH IF YES            S21101 27913020
         SPACE                                                          27914020
STLOOP   EQU   *                                                 S21101 27915020
         BAL   RPQCB,GETQCBAD           QCB ADDRESS FOR ENTRY    S21101 27916020
         TM    QCBSTAT,QCBSEND          SENDING TO THIS          S21101 27917020
         BO    GETNEXT                  YES, GO TO NEXT ENTRY    S21101 27918020
         SPACE                                                          27919020
         BAL   RPQCB,QCBRTNE            COMPUTE THE SCB ADDRESS  S22025 27924022
         TM    LCBSTAT1,LCBOCNI         REQUEST FOR STOPLINE?   SA56606 27924122
         BO    GETNEXT                  BRANCH YES              SA56606 27924222
         SPACE 2                                                        27924522
         TM    SCBQTYPE,SCBBFMM         IS THIS MIDDLE OF MSG TO S22025 27925022
*                                         THIS STATION           S22025 27925522
         BO    GORCV                    YES, BRANCH              S22025 27926022
         TM    LCBSTAT2,LCBSNDPR        IS THIS AN UNUSUAL       S22025 27926522
*                                         CONDITION              S22025 27927022
         BZ    GORCV                    NO, BRANCH               S22025 27927522
         EJECT                                                          27928022
GETNEXT  EQU   *                                                 S21101 27929020
         SR    RZERO,RZERO              CLEAR WORK REGISTER      S21101 27930020
         LR    RPARM,RTEMP              COPY ILIST POINTER       S21101 27931020
         IC    RZERO,ILSTSIZE(,RILIST)  SIZE OF EACH ENTRY       S21101 27932020
         AR    RPARM,RZERO              NEXT ENTRY               S21101 27933020
         CLI   AVTEZERO(RPARM),FE       END OF LIST              S21101 27934020
         BE    SETIT                    YES, BRANCH              S22025 27935022
         CLI   1(RPARM),FE              END OF LIST              S21101 27937020
         BNE   CONT                     NO, CONTINUE SCAN        S21101 27938020
         EJECT                                                          27939022
SETIT    EQU   *                                                 S21101 27940020
         CLC   LCBRSLNK,AVTDELAD+1      ANYTHING TO SEND?          @02C 27941025
         BE    CONT                     BRANCH IF NO               @02C 27941325
         BAL   RPQCB,NEXTENT            UPDATE TO NEXT ENTRY IN         27942000
*                                       THE INVITATION LIST    @OY21468 27943000
         B     SENDTST                  ATTEMPT TO SEND            @02C 27943325
         SPACE 1                                                 S21101 27953020
CONT     EQU   *                                                 S21101 27953525
         BAL   RPQCB,NEXTENT            GET THE NEXT ILIST ENTRY S21101 27953625
         B     LOOPEXIT                 SCAN THE NEXT ENTRY      S21101 27953725
         SPACE 1                                                 S21101 27953800
GORCV    EQU   *                                                 S21101 27954020
         MVC   LCBTTBIN,AVTDOUBL+4      SET TNT OFFSET           S21101 27955020
         BAL   RPQCB,QCBRTNE            COMPUTE THE SCB ADDRESS  S21101 27956020
         SPACE                                                          27957020
         ST    RSCB,LCBSCBA-1           STORE IT IN THE LCB      S21101 27958020
         TM    5(RILIST),AUTO           AUTOPOLL REQUESTED              31000020
         BNO   NOAUTO                   BRANCH IF NO                    31100020
         NI    3(RILIST),AVTEFF-STRTAUTO                                31200020
         NC    4(1,RILIST),4(RILIST)    SENDING TO A STATION            31300020
         BNZ   NOAUTO                   BRANCH IF YES                   31400020
         OI    3(RILIST),STRTAUTO       SET AUTOPOLL FLAG               31500020
         EJECT                                                          31600020
NOAUTO   EQU   *                                                        31700020
*                                                                     * 31800020
*           COMPLETE ERB INITIALIZATION                               * 31900020
*                                                                     * 32000020
         LA    RTEMP,AVTBFREB           BUFFER REQUEST QUEUE ADDR       32100020
         ST    RTEMP,LCBERB             STORE IN QCB FIELD OF ERB       32200020
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN PRESERVE STOPLINE BITS@OY14092 32260091
         OI    LCBSTAT1,LCBRECVN        SET RECEIVE STATUS IN LCB       32320020
         MVI   LCBERBPY,PRIINTRQ        INITIAL REQUEST PRIORITY        32400020
         SR    RTEMP,RTEMP              CLEAR REGISTER TO ZERO          32500020
         IC    RTEMP,DCBBUFIN           INITIAL BUFFER COUNT            32600020
         SRL   RTEMP,4                  ISOLATE FOUR HI ORDER BITS      32700020
         STC   RTEMP,LCBERBCT           ESTABLISH INIT REQUEST          32800020
         XC    LCBRECAD,LCBRECAD                                        33000020
         XC    LCBRECOF,LCBRECOF                                        33100020
         LA    RPARM,LCBERB             PREPARE TO POST ERB             33200020
         B     FULLQ                    PROCEED WITH RECEIVE     S21101 33300020
FREE     EQU   *                                                        33500020
         CLC   LCBRSLNK,AVTDELAD+1      SOMETHING TO SEND NOW           33600020
         BNE   SENDTST                  BRANCH IF YES TO SEND LOGIC     33700020
FREETST  EQU   *                                                        33710020
         TM    AVTBIT1,AVTCLOSN+AVTDLAYN     IS THIS CLOSE OR    S21101 33712020
*                                            SYSTEM DELAY        S21101 33714020
         BNZ   NOSEND                   BRANCH IF EITHER OR BOTH S21101 33716020
         TM    LCBSTAT1,LCBOCNI         STOPLINE REQUESTED              33740020
         BO    NOSEND                   BRANCH IF YES                   33750020
SETFREE  EQU   *                                                        33760020
         OI    LCBSTAT2,LCBNEGRP        SET SWITCH               S21101 33780020
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN PRESERVE STOPLINE BITS@OY14092 33800091
         OI    LCBSTAT1,LCBFREEN        SET LINE FREE                   33840020
         B     DSPDISP                  EXIT TO DISPATCHER              33900020
FULLQ    EQU   *                                                        33905020
         TM    AVTBIT3,AVTRECVN+AVTRFULN QUEUE THRESHOLD CONDITION      33910020
         BZ    DSPPOST                  BRANCH IF NO                    33915020
         TM    SCBQTYPE,SCBBFMM         IS THIS ALSO MIDDLE      S21101 33915521
*                                         OF MESSAGE             S21101 33916021
         BO    SETTIME                  YES, SET DELAY TIME      S21101 33916521
         CLC   LCBRSLNK,AVTDELAD+1      SOMETHING TO SEND               33920020
         BNE   SENDTST                  BRANCH IF YES                   33925020
         CLI   4(RILIST),0              SENDING TO A STATION            33930020
         BNE   SETFREE                  BRANCH IF YES                   33935020
         EJECT                                                          33935222
SETTIME  EQU   *                                                 S21101 33935521
         LA    RPARM,1                  ONE-SECOND DELAY                33940020
SETDELAY EQU   *                                                        33940520
         TM    LCBINSRC+2,LCBDLY        LCB IN TIME DELAY               33941020
         BO    FREE                     BRANCH IF YES                   33941520
         OI    LCBSTAT2,LCBNEGRP        SET SWITCH               S21101 33941720
         OI    LCBINSRC+2,LCBDLY        SET LCB IN TIME DELAY           33942020
         STH   RPARM,LCBEOLTD           TIME DELAY PARAMETER            33945020
         MVI   LCBTDL,LCBINSRC-1-IEDQLCB TIME DELAY INDEX               33950020
         ST    RLCB,LCBQCBA-1           SET UP QCB ADDRESS              33957020
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN PRESERVE STOPLINE BITS@OY14092 33965091
         OI    LCBSTAT1,LCBFREEN        SET LINE FREE                   33970020
         LR    RPARM,RLCB               TIME DELAY PARAMETER            33975020
         L     RENTRY,AVTHG01           TIME DELAY SUBTASK              33981020
         BALR  RETURN,RENTRY            PUT LCB IN TIME DELAY           33987020
         B     DSPDISP                  EXIT TO DISPATCHER              33993020
         EJECT                                                          34000020
SENDTST  EQU   *                                                        34100020
*                                                                     * 34200020
*         THERE IS A DEST QCB IN THE CHAIN OF WAITING QCB'S FOR       * 34300020
*      THIS LCB. PREPARE THE ERB FOR A SEND OPERATION IF THERE        * 34400020
*      IS UNSENT DATA ON THE QCB.  IF THERE IS NO DATA ON THE         * 34500020
*      QCB, REMOVE QCB FROM CHAIN AND POST LCB TO ITSELF.             * 34600020
*                                                                     * 34700020
         SPACE 2                                                        34800020
         L     RSTCB,STCBLINK-1         ADDR OF A BUFFERED TERMINAL     34900020
*                                       SCHEDULER'S STCB THAT IS        35000020
*                                       ASSOCIATED WITH A DEST QCB      35100020
         LA    RPARM,QCBSTVTO-IEDQQCB   STCB OFFSET INTO QCB            35200020
         LR    RQCB,RSTCB               COMPUTE STARTING ADDRESS        35300020
         SR    RQCB,RPARM                 OF DEST QCB                   35400020
         BAL   RPQCB,QCBRTNE            COMPUTE THE SCB ADDRESS  S21101 35430020
         SPACE                                                          35460020
         ST    RSCB,LCBSCBA-1           STORE ADDRESS OF CURRENT        36800020
         TM    SCBQTYPE,SCBBFMM         IS THIS STATION IN       S22025 36900022
*                                         MIDDLE OF MESSAGE      S22025 36920022
         BZ    TRYSEND                  NO, BRANCH               S22025 36940022
         TM    QCBSTAT,QCBSEND          IS A SEND OPERATION IN   S22025 36960022
*                                         PROGRESS               S22025 36980022
         BO    TRYSEND                  YES, BRANCH              S22025 37000022
         L     RTEMP,STCBLINK-1         GET THE ADDRESS OF THE   S21101 37020020
*                                         NEXT STCB ON THE CHAIN S21101 37050020
         CLI   STCBPRIT(RTEMP),AVTEZERO IS THIS THE LAST ELEMENT S21101 37080020
*                                         ON THE STCB CHAIN      S21101 37110020
         BNE   SENDTST                  BRANCH NO                S21101 37140020
         TM    LCBSTAT1,LCBOCNI        IS IT STOPLINE           SA56606 37143022
         BO    TSTSTOPL                BR YES                   SA56606 37146022
         TM    LCBINSRC+2,LCBDLY       LCB IN END POLL DELAY    SA56605 37150022
         BO    SETFREE                  YES-DONT TRY TO POLL    SA56605 37160022
         L     RTEMP,LCBINVPT-1         GET CURRENT ILIST ENTRY SA56606 37160922
         SR    RPARM,RPARM             CLEAR REG TO ZERO        SA56606 37161822
         IC    RPARM,LCBUCBX            RLN-1                   SA56606 37162722
         SLL   RPARM,TWO                MULTIPLY BY 4           SA56606 37163622
         L     RILIST,DCBINVLI(RPARM)   INVLIST ADDRESS         SA56606 37164522
         CLI   ONE(RILIST),ZERO         ANY ACTIVE ENTRIES      SA56606 37165422
         BNE   RSETSTCB                 YES, TRY TO RECEIVE     SA56606 37166322
         TM    AVTBIT1,AVTCLOSN         FLUSH OR QUICK CLOSE    SA56606 37167222
         BO    POSTOPC                  YES-NOTIFY OP CNTRL     SA56606 37168122
         B     SETTIME                 PUT LCB IN TIME DELAY    SA56606 37169022
RSETSTCB EQU   *                                                SA56606 37169522
         SPACE                                                          37170020
         LA    RSTCB,LCBRSKEY          RESET STCB BASE           S21101 37200020
         B     INVLTST                  FINISH RCV OPERATION       @02C 37230025
         EJECT                                                          37240022
TRYSEND  EQU   *                                                 S21101 37260020
         TM    AVTBIT1,AVTCLOSN+AVTQUCKN  FLUSH CLOSE                   37400020
         BM    BYPASS                   BRANCH IF YES                   37500020
         BO    NOSEND                   BRANCH IF QUICK CLOSE    S21101 37520020
         TM    AVTBIT1,AVTDLAYN         IS IT SYSTEM DELAY       S21101 37540020
         BO    NOSEND                   YES, BRANCH              S21101 37560020
         TM    LCBSTAT1,LCBOCNI         STOPLINE                        37800020
         BO    NOSEND                   BRANCH IF YES                   37900020
BYPASS   EQU   *                                                        38000020
         EJECT                                                          38002020
         SPACE 2                                                        38100020
         TM    SCBQTYPE,SCBBFMM         ARE WE READY TO SEND A          38300020
*                                       SUBSEQUENT(NON-HEADER)          38400020
*                                       BLOCK TO THIS DESTINATION       38500020
         BNO   INITIAL                  BRANCH IF NO TO PERFORM         38600020
*                                       SCAN AND SCB INITIALIZATION     38700020
         EJECT                                                          38800020
SENDSEG  EQU   *                                                        38850020
*        DO SPECIAL PROCESSING FOR THE MULTI-BLOCK MESSAGE SITUATION  * 38900020
*                                                                     * 39000020
         SPACE 2                                                        39100020
         STCM  RQCB,ADR,SCBDESTQ        SET UP QCB ADDRESS     @Z30X8IM 39120008
         MVC   LCBTTCIN(2),SCBDCHDR     RESTORE TTCIN              @11A 39160026
         NC    SCBDEOB,SCBDEOB          NEED TO DO A RECALL             39200020
*                                       FOR EMBEDDED EOB BUFFER         39300020
         BZ    BUILDERB                 BRANCH IF NO TO SET UP          39400020
*                                       REQUEST FOR NEXT BUFFER         39500020
         SPACE                                                          39600020
*                                                                     * 39700020
*        PREPARE ERB TO RECALL BUFFER WITH EMBEDDED EOB               * 39800020
*                                                                     * 39900020
*              SEE IF LAST BUFFER OF MESSAGE HAS BEEN READ FROM DISK  * 40000020
         TM    SCBQTYPE,SCBCOREQ        CORE QUEUEING                   40100020
         BO    COREONLY                 BRANCH IF YES                   40200020
         TM    SCBSTAT1,PRFNLSTN        EOM BUFFER                      40300020
         BO    NOTLAST                  BRANCH IF NO                    40400020
         CLC   SCBDEOB+1(3),SCBCRCD     SENDING LAST SEGMENT            40500020
         BNL   COREONLY                                         SA60792 40600022
         NC    SCBXTRA(THREE),SCBXTRA                           SA60792 40610022
         BZ    RSET                                             SA60792 40620022
         CLC   SCBDEOB+ONE(THREE),SCBXTRA                       SA60792 40630022
         BNL   COREONLY                                         SA60792 40640022
RSET     EQU   *                                                SA60792 40650022
         OI    SCBSTAT1,PRFNLSTN        FLAG AS NOT LAST YET            40700020
NOTLAST  EQU   *                                                        40800020
         XC    SCBXTRA(3),SCBXTRA       CLEAR FOR RECALL         S21101 40840021
         XC    SCBNTXT(3),SCBNTXT       CLEAR FOR RECALL         S21101 40880021
COREONLY EQU   *                                                 S21101 40920021
         MVZ   SCBHBFNO,SCBQTYPE        SET QTYPE FLGS FOR FA   SA52971 40930022
         MVC   LCBCPA(4),SCBDEOB        SAVE OVER RECALL                40950020
         NI    QCBSTAT,AVTEFF-QCBBUFRD  TURN OFF HEADER FLAG            41100020
         LA    RTEMP,AVTDSIOB           DISK I/O QCB ADDRESS            41200020
         ST    RTEMP,LCBERB             SET QCB ADDR IN ERB             41300020
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN PRESERVE STOPLINE BITS@OY14092 41360091
         OI    LCBSTAT1,LCBSENDN        SET LCB IN SEND STATE           41420020
         MVI   LCBERBPY,PRIDKEOB        RECALL PRIORITY                 41500020
         MVI   LCBERBCT,1               RECALL BUFFER COUNT             41600020
         MVI   LCBERBCT+1,AVTEZERO      CLEAR DISABLED COUNT            41650020
         OI    LCBSTAT1,LCBRCLLN        SET RECALL BIT IN LCB           41700020
         ST    RLCB,LCBRCQCB            SET UP ERB RETURN ADDRESS       41800020
         LA    RPARM,LCBERB             ERB ADDR FOR DISPATCHER         42000020
         B     DSPPOST                  POST ERB FOR RECALL             42100020
         EJECT                                                          42200020
GETQCBAD EQU   *                                                 S21101 42200220
*        SUBROUTINT WILL COMPUTE ADDRESS OF QCB BASED ON ILIST   S21101 42200420
* POINSTER IN RTEMP                                              S21101 42200620
*        RILIST POINTS TO ILIST CONTROL WORDS                    S21101 42200820
*        QCB IS SET IN RQCB                                      S21101 42201020
*        TNT OFFSET IS SET AT AVTDOUBL+4                         S21101 42201220
         SR    RPARM,RPARM              CLEAR WORK REGISTER      S21101 42201420
         IC    RPARM,ILSTSIZE(,RILIST)  GET THE SIZE OF EACH     S21101 42201620
*                                         INVITATION LIST ENTRY  S21101 42201820
         BCTR  RPARM,RZERO              DECREMENT TO INDEX BYTE  S21101 42202020
         IC    RPARM,0(RTEMP,RPARM)     GET INDEX BYTE           S21101 42202220
         AR    RPARM,RPARM              DOUBLE FOR NEG INDEX     S21101 42202420
         LR    RTERM,RILIST             COPY ILIST ADDRESS       S21101 42202620
         SR    RTERM,RPARM              ADDRESS OF TNTOFFSET     S21101 42202820
         LH    RPARM,AVTEZERO(,RTERM)   DET TNT OFFSET           S21101 42203020
         STH   RPARM,AVTDOUBL+4         SAVE TNT OFFSET          S21101 42203220
         L     RENTRY,AVTRNMPT          TNT CONVERSION           S21101 42203420
         BALR  RETURN,RENTRY            LINK TO IT               S21101 42203620
         L     RQCB,TRMDESTQ-1-IEDQTRM(RPARM)     LOAD THE       S21101 42203820
*                                         DESTINATION QCB ADDR   S21101 42204020
         BR    RPQCB                    RETURN                   S21101 42204220
         EJECT                                                          42204422
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  S21101 42204620
*                                                             *  S21101 42204820
*        THIS SUBROUTINE WILL GET THE ADDRESS OF THE NEXT     *  S21101 42205020
*        INVITATION LIST ENTRY.  RTEMP POINTS TO THE          *  S21101 42205220
*                            CURRENT ENTRY                    *  S21101 42205420
*                                                             *  S21101 42205620
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  S21101 42205820
NEXTENT  EQU   *                                                 S21101 42206020
         SR    RPARM,RPARM              CLEAR WORK REGISTER      S21101 42206220
         IC    RPARM,ILSTSIZE(,RILIST)  SIZE OF EACH             S21101 42206420
         AR    RTEMP,RPARM              BUMP TO NEXT             S21101 42206620
         CLI   AVTEZERO(RTEMP),FE       END OF LIST              S21101 42206820
         BE    RESETIT                  BRANCH YES TO RESET      S21101 42207020
         CLI   1(RTEMP),FE              END OF BSC LIST          S21101 42207220
         BNE   SETINVPT                 NO, BRANCH               S21101 42207420
RESETIT  EQU   *                                                 S21101 42207620
         LA    RTEMP,ILISTPRF(,RILIST)  TO FIRST ENTRY           S21101 42207820
SETINVPT EQU   *                                                 S21101 42208020
         STCM  RTEMP,ADR,LCBINVPT       STORE THE ADDRESS OF   @Z30X8IM 42208208
*                                         THE NEXT ILIST ENTRY @Z30X8IM 42208608
         BR    RPQCB                    RETURN                   S21101 42209020
         EJECT                                                          42209220
INITIAL  EQU   *                                                        42300020
*                                                                     * 42400020
*        FIND PRIORITY LEVEL QCB WITH A MESSAGE TO BE SENT            * 42500020
*                                                                     * 42600020
         USING IEDQPQCB,RPQCB           PRIORITY LEVEL QCB              42700020
         L     RPARM,DCBDEBAD           DEB ADDRESS                     42800020
         TM    DEBOPATB-DEBNMSUB(RPARM),OUTPUT OPEN FOR OUTPUT          42900020
         BNO   DEQ                      BRANCH IF NO                    43000020
        TM    QCBSTAT,QCBTRMHO         IS TERMINAL HELD                 43100020
         BO    DEQ                      BRANCH IF YES                   43200020
         TM    QCBDSFLG,QCBHELD         REUSABILITY RUNNING             43230020
         BO    DEQ                      BRANCH IF YES                   43260020
         SR    RTEMP,RTEMP              INITIALIZE PQCB COUNTER         43300020
         LA    RPQCB,IEDQPQCB-IEDQQCB(0,RQCB) ADDR OF FIRST PRTY QCB    43400020
LOOP     EQU   *                                                        43500020
         NC    QCBFFEFO,QCBFFEFO        IS THERE AN UNSENT MESSAGE      43600020
*                                       FOR THIS PRTY LEVEL QCB         43700020
         BNZ   BUILDSCB                 BRANCH IF YES TO COMPLETE       43800020
*                                       SCB INITIALIZATION              43900020
         CLI   QCBPRIPQ,0               LAST PRTY LEVEL QCB             44000020
         BE    DEQ                      BRANCH IF YES TO REMOVE         44100020
*                                       THIS QCB FROM LCB CHAIN         44200020
         LA    RPQCB,QCBPEND            ADDR OF NEXT PRTY LEVEL QCB     44300020
         LA    RTEMP,1(0,RTEMP)         INCREMENT PQCB COUNTER          44400020
         B     LOOP                     TEST THIS PRTY LEVEL QCB        44500020
         EJECT                                                          44510020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  S21101 44520020
*                                                             *  S21101 44530020
*        REMOVE THE QCB FROM THE STCB CHAIN OF THE LCB        *  S21101 44540020
*                                                             *  S21101 44550020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  S21101 44560020
DEQ      EQU   *                                                        44700020
         SPACE 4                                                        45300020
         NI    QCBSTAT,X'FF'-QCBSEND    TURN OFF SEND MODE FLAG         45700020
         BAL   RETURN,SEARCH            FIND AND REMOVE STCB     A48267 45800022
         MVC   13(3,RQCB),9(RQCB)       PUT DEST SCHED ON BOTTOM        45900020
         LA    RPARM,8(0,RQCB)          ADDRESS OF BTS STCB             46000020
         ST    RPARM,8(0,RQCB)          PUT BTS STCB ON TOP OF QCB      46100020
         MVI   8(RQCB),X'1A'            RESTORE BTS VTO                 46200020
         SR    RTEMP,RTEMP              CLEAR REG TO ZERO               46300020
         IC    RTEMP,LCBUCBX            RLN-1                           46400020
         SLL   RTEMP,2                  MULTIPLE BY FOUR                46500020
         L     RILIST,DCBINVLI(RTEMP)   INVITATION LIST ADDRESS         46600020
         SR    RTEMP,RTEMP              CLEAR REG TO ZERO               46700020
         IC    RTEMP,4(RILIST)          SUBTRACT ONE FROM COUNT  S22025 46800022
         BCTR  RTEMP,0                  OF TERMINALS CURRENTLY   S22025 46870022
         STC   RTEMP,4(RILIST)          SENDING                  S22025 46940022
         ST    RLCB,LCBQCBA-1           POST ADDRESS             S21101 47010020
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN PRESERVE STOPLINE BITS@OY14092 47020091
         OI    LCBSTAT2,LCBNEGRP        TURN ON THE NEGATIVE     S21101 47030020
*                                         RESPONSE BIT           S21101 47040020
         OI    LCBSTAT1,LCBRECVN        SET LCB STATE            S21101 47050020
         LR    RPARM,RLCB               SET UP DISPATCHER PARM REG      47100020
         B     DSPPOST                  POST LCB TO ITSELF              47200020
         EJECT                                                          47300020
*                                                                     * 47400020
*              COMPLETE SCB AND ERB INITIALIZATION                    * 47500020
*                                                                     * 47600020
BUILDSCB EQU   *                                                        47700020
         MVI   LCBTTCIN+ONE,ONE                                 SA60792 48200022
         OI    QCBSTAT,QCBSEND          SET SEND MODE FLAG              48800020
         MVC   SCBSCHDR,QCBFFEFO        MOVE REL REC NO OF CURRENT      48900020
*                                       HEADER INTO SCB                 49000020
         MVC   SCBSCSEG,QCBFFEFO        MOVE REL REC NO OF CURRENT      49100020
*                                       SEGMENT INTO SCB                49200020
         OI    SCBQTYPE,SCBBFMM         SET MID-MESSAGE FLAG            49300020
         STC   RTEMP,SCBPRI             PUT PRTY LEVEL QCB INDEX        49400020
*                                       INTO SCB                        49500020
         OI    QCBSTAT,QCBBUFRD         TURN ON HEADER FLAG             49600020
         OI    QCBFLAG,QCBSDFFO                                         49700020
         XC    SCBFEFO(3),SCBFEFO                                       49800020
         STCM  RQCB,ADR,SCBDESTQ        PUT QCB ADDR IN SCB    @Z30X8IM 49820008
         MVI   SCBUNTCT,AVTEZERO        CLEAR UNIT COUNT           @03A 49820525
         SPACE 2                                                        49900020
BUILDERB EQU   *                                                        50000020
         LA    RTEMP,AVTDSIOB           GET ADDRESS OF DISK I/O         50100020
*                                       QCB FROM AVT                    50200020
ACTIVATE EQU   *                                                        50300020
         ST    RTEMP,LCBERB             SET QCB ADDR IN ERB             50400020
         NI    QCBELCHN+2,AVTEFF-QCBCNTEN TURN OFF BUFFER BUSY @OX17153 50480000
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN PRESERVE STOPLINE BITS@OY14092 50560091
         OI    LCBSTAT1,LCBSENDN        SET LCB IN SEND STATE           50620020
         MVI   LCBERBPY,PRIINTRQ        INITIAL REQUEST PRIORITY        50700020
         MVC   LCBERBCT(1),DCBBUFOU     INITIAL BUFFER COUNT            50800020
         NI    LCBERBCT,X0F             CLEAR LOW-ORDER FOUR BITS       50900020
         XC    LCBRECAD,LCBRECAD                                        51100020
         XC    LCBRECOF,LCBRECOF                                        51200020
         LA    RPARM,LCBERB             PUT ERB ADDR IN PARM REG        51300020
*                                       FOR DISPATCHER                  51400020
         B     DSPPOST                  POST ERB TO DISK I/O            51500020
         EJECT                                                          51600020
DELAY    EQU   *                                                        51700020
*                                                                     * 51800020
*        SINCE THE LAST OPERATION WAS A 'SEND', THE DESTINATION       * 51900020
*        QCB MUST BE PLACED IN THE TIME DELAY QUEUE FOR THE TIME      * 52000020
*        INTERVAL SPECIFIED IN THE TERMINAL ENTRY FOR THE LAST        * 52100020
*        SENT BLOCK.                                                  * 52200020
*                                                                     * 52300020
         MVC   SCBDCHDR(2),LCBTTCIN     SAVE TNT OFFSET                 52400020
         SR    RPARM,RPARM              CLEAR REGISTER TO ZERO          52500020
         LH    RPARM,LCBTTCIN           TNT OFFSET OF TERMINAL          52600020
*                                       TO WHICH WE JUST SENT           52700020
         N     RPARM,AVTCLRHI           CLEAR HI-ORDER HALF             52800020
         LTR   RPARM,RPARM              IS TTCIN=0 ?           @OZ34395 52830000
         BZ    NEXTTEST                 YES                    @OZ34395 52860000
         L     RENTRY,AVTRNMPT          ADDR OF CONVERSION LOGIC        52900020
         BALR  RETURN,RENTRY            COMPUTE TERMINAL ENTRY ADDR     53000020
         LR    RTERM,RPARM              DSECT ADDRESSABILITY            53100020
         L     RQCB,TRMDESTQ-1          DESTINATION QCB ADDRESS         53200020
*                                                                       53300020
*              FIND BUFFERED TERMINAL TIME DELAY VALUE                  53400020
*                                                                       53500020
         LA    RPARM,TRMOPNO            GET THE ADDRESS OF THE   S22025 53530022
*                                         FIRST DEVICE DEP FIELD S22025 53560022
         TM    TRMSTATE,TRMOPTFN        OPTION FIELDS SPECIFIED         53600020
         BZ    SCAN                     NO, BRANCH               S22025 53700022
         SPACE 2                                                        54100020
COMPOPTF EQU   *                                                        54200020
         SR    RETURN,RETURN            CLEAR REGISTER TO ZERO          54300020
         IC    RETURN,TRMOPNO           NUMBER OF OPTION FIELDS         54400020
         LA    RPARM,THREE(RETURN,RPARM) BUMP THE DEVICE DEP.    S22025 54500022
*                                         FIELD POINTER PAST THE S22025 54600022
*                                         OPTION OFFSETS         S22025 54700022
SCAN     EQU   *                                                        54800020
         LH    RETURN,TRMDEVFL          GET THE DEVICE DEPENDENT S22025 54900022
*                                         FIELD FLAGS            S22025 55000022
         SLL   RETURN,FIFTEEN           SHIFT FLAGS TO THE LEFT  S22025 55100022
         LA    RENTRY,SIX               TEST 6 DEV DEP FLAGS     S22025 55200022
         SR    RTERM,RTERM              CLEAR A LENGTH REGISTER  S22025 55300022
SHIFT    EQU   *                                                        55400020
         SLL   RETURN,ONE               TEST THE NEXT FLAG       S22025 55500022
         LTR   RETURN,RETURN            IS THIS FIELD PRESENT    S22025 55570022
         BNM   BUMP                     NO, BRANCH               S22025 55640022
         IC    RTERM,ZERO(RPARM)        GET THE LENGTH OF THE    S22025 55710022
*                                         CURRENT FIELD          S22025 55780022
         LA    RPARM,ONE(RTERM,RPARM)   BUMP TO THE NEXT OPTION  S22025 55850022
*                                         FIELD                  S22025 55920022
BUMP     EQU   *                                                        56000020
         BCT   RENTRY,SHIFT            IS THIS THE BFDLY FIELD   S22025 56100022
*                                         IF NOT, CONTINUE SCAN  S22025 56300022
         SPACE 3                                                        56600020
MOVETIME EQU   *                                                        56700020
         MVC   QCBEOLDT(2),1(RPARM)     MOVE TIME DELAY INTO QCB        56800020
         MVI   QCBEOLDT+2,0             TIME DELAY INTERFACE INDEX      56900020
         MVI   QCBPRI,X'EC'             SET QCB PRIORITY                57000020
         LA    RTEMP,BTSTDQCB           BTS TIME DELAY INTERRUPT        57200020
         STCM  RTEMP,ADR,QCBELCHN       HANDLER QCB ADDRESS    @Z30X8IM 57300008
*                                                                    *  57408020
*        CHECK FOR SPECIAL CASE OF TIME DELAY OF 12 OR MORE HOURS    *  57416020
*                                                                    *  57424020
         CLC   QCBEOLDT(2),TWELVE       DELAY GREATER THAN 12 HOURS     57432020
         BL    LOWER                    BRANCH IF NO                    57440020
         LH    RTEMP,QCBEOLDT           GET LARGE TIME DELAY            57448020
         N    RTEMP,AVTCLRHI            CLEAR HIGH-ORDER HALFWORD       57456020
         SH    RTEMP,TWELVE             DECREMENT BY 12 HOURS           57464020
         OI    QCBSTAT,QCBTIME          SET FLAG FOR TIME DELAY         57472020
         STH   RTEMP,QCBEOLDT           SET NEW DELAY VALUE             57480020
LOWER    EQU   *                                                        57488020
         EJECT                                                          57500020
*                                                                     * 57600020
*              REMOVE QCB FROM STCB CHAIN OF LCB                      * 57700020
*                                                                     * 57800020
NODECR   EQU   *                                                        58400020
         TM    SCBQTYPE,SCBBFMM         IS THIS MIDDLE OF MSG    S21101 58410021
         BO    NODECR01                 YES, BRANCH              S21101 58420021
         TM    QCBSTAT,QCBTRMHO         IS TERMINAL HELD        SA52515 58423054
         BO    NEXTTEST                 BRANCH IF YES           SA52515 58426054
         NI    QCBSTAT,AVTEFF-QCBSEND   TURN OFF THE SEND BIT IN S21101 58430021
*                                         THE DESTINATION QCB    S21101 58440021
         SR    RTEMP,RTEMP              CLEAR REG TO ZERO      @OX12490 58441091
         IC    RTEMP,LCBUCBX            RLN-1                  @OX12490 58442091
         SLL   RTEMP,2                  MULTIPLE BY FOUR       @OX12490 58443091
         L     RILIST,DCBINVLI(RTEMP)   INVITATION LIST ADDRESS@OX12490 58444091
         SR    RTEMP,RTEMP              CLEAR REG TO ZERO      @OX12490 58445091
         IC    RTEMP,4(RILIST)          SUBTRACT ONE FROM COUNT@OX12490 58446091
         BCTR  RTEMP,0                  OF TERMINALS CURRENTLY @OX12490 58447091
         STC   RTEMP,4(RILIST)          SENDING                @OX12490 58448091
NODECR01 EQU   *                                                 S21101 58450021
         LR    RPARM,RQCB               PARM FOR TIME DELAY             58500020
         BAL   RETURN,SEARCH            FIND AND REMOVE STCB     A48267 58600022
         XC    13(3,RQCB),13(RQCB)                                      58750020
         L     RENTRY,AVTHG01           TIME DELAY LOGIC ADDRESS        58800020
         BALR  RETURN,RENTRY            POST QCB TO TIME DELAY          58900020
         LA    RSTCB,LCBSTCBA-1         RESTORE STCB ADDRESS            58950020
         SPACE 2                                                        59000020
NEXTTEST EQU   *                                                        59100020
*                                                                     * 59200020
*        IF THERE IS SOMETHING TO SEND, SEND IT.  IF NOT, AND         * 59300020
*        THERE IS AN ACTIVE ENTRY IN THE ILIST, TRY TO RECEIVE.       * 59400020
*        OTHERWISE, SET THE LINE FREE AND EXIT TO DISPATCHER.         * 59500020
*                                                                     * 59600020
         L     RDCB,LCBDCBPT            LINE GROUP DCB ADDRESS          59700020
         NI    LCBSTAT1,X'FF'-LCBSENDN  SET LCB NOT SENDING             59800020
         CLC   LCBRSLNK,AVTDELAD+1      ANOTHER QCB IN LCB CHAIN        59900020
         BNE   SENDTST                  BRANCH IF YES TO TRY TO         60000020
*                                       SEND ANOTHER BLOCK              60100020
         SR    RPARM,RPARM              CLEAR REGISTER TO ZERO          60200020
         IC    RPARM,LCBUCBX            RLN-1                           60300020
         SLL   RPARM,2                  MULTIPLY BY FOUR                60400020
         L     RILIST,DCBINVLI(RPARM)   INVITATION LIST ADDRESS         60500020
         CLI   0(RILIST),0              ANY ACTIVE ENTRIES              60600020
         BNE   INVLTST                  BRANCH IF YES                   60700020
         B     FREETST                                                  60800020
         SPACE  2                                                       60810022
SEARCH   EQU   *                                                 A48267 60820022
         LA    RSTCB,QCBSTVTO           ADDRESS OF SEND SCHEDULARA48267 60830022
*                                         TO BE REMOVED          A48267 60840022
         ST    RSTCB,AVTDOUBL                                    A48267 60850022
         LA    RSTCB,LCBRSKEY           ADDRESS OF RECEIVE SCH   A48267 60860022
SCHLOOP  EQU   *                                                 A48267 60870022
         CLC   AVTDOUBL+1(3),5(RSTCB)   IS THE NEXT SCHEDULAR    A48267 60880022
*        THE ONE TO BE REMOVED                                   A48267 60890022
         BE    DELINK                   BRANCH IF YES            A48267 60900022
         L     RSTCB,4(RSTCB)           NEXT SCHEDULAR           A48267 60910022
         B     SCHLOOP                  CONTINUE                 A48267 60920022
DELINK   EQU   *                                                 A48267 60930022
         L     RTEMP,4(RSTCB)           ADDRESS OF SCH TO REMOVE A48267 60940022
         MVC   5(3,RSTCB),5(RTEMP)      DELINK STCB FROM CHAIN   A48267 60950022
         BR    RETURN                   RETURN                   A48267 60960022
         EJECT                                                          61000020
NOSEND   EQU   *                                                        61100020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  S22025 61150022
*                                                                     * 61200020
*        RECIEVE OPERATIONS ARE HALTED.  IF FLUSH CLOSE AND THERE     * 61300020
*        ARE MESSAGES TO SEND, SEND THEM UNTIL THE QUEUES ARE EMPTY.  * 61400020
*        IF QUICK CLOSE OR STOP LINE, CHECK FOR QCBSFOR WHICH THERE   * 61500020
*        IS A PARTIAL MESSAGE TO SEND.  IF NONE, POST LCB TO OPCTL.   * 61600020
*                                                                     * 61700020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  S22025 61730022
         OI    LCBSTAT2,LCBSNDPR        SET A FLAG FOR LINE END  S22025 61760022
         CLC   LCBRSLNK,AVTDELAD+1      MESSAGE TO SEND                 61800020
         BNE   TESTOPN                  BRANCH IF YES                   61900020
PRESTOP  EQU   *                                                        61950020
*                                                                     * 62000020
*        CHECK FOR QCB ON TIME DELAY QUEUE                            * 62100020
*                                                                     * 62200020
         L     RTEMP,AVTDELYB           DUMMY TIME QUEUE ELEMENT        62300020
         L     RPARM,AVTTIMQ            FIRST TIME QUEUE ELEMENT        62400020
         LA    RTEMP,0(0,RTEMP)         CLEAR HIGH-ORDER BYTE           62500020
TQLOOP   EQU   *                                                        62600020
         LA    RPARM,0(0,RPARM)         CLEAR HIGH-ORDER BYTE           62700020
         CR    RTEMP,RPARM              END OF TIME QUEUE               62800020
         BE    STOPSEND                 BRANCH IF YES                   62900020
         CLI   QCBEOLDT+2-IEDQQCB(RPARM),AVTEZERO ELEM A QCB            63000020
         BE    QCBTESTX                 BRANCH IF YES                   63100020
TQNEXT   EQU   *                                                        63200020
         L     RPARM,28(0,RPARM)        ADDR OF NEXT ELEM ON QUEUE      63300020
         B     TQLOOP                   CHECK NEXT ELEMENT       S22025 63400022
QCBTESTX EQU   *                                                        63500020
         CLC   LCBDCBPT+1(3),QCBDCBAD-IEDQQCB(RPARM)             S21101 63510020
*                                       IS THIS QCB ASSOCIATED   S21101 63520020
*                                         WITH THIS LCB          S21101 63530020
         BNE   TQNEXT                   NO, CHECK NEXT ELEMENT   S21101 63540020
*                                         ON THE TIME QUEUE      S21101 63550020
RLNTEST  EQU   *                                                        63810020
         IC    RENTRY,QCBRELLN-IEDQQCB(RPARM)  RLN                      63820020
         BCTR  RENTRY,RZERO             RLN-1                           63830020
         EX    RENTRY,TESTRLN           SAME RELATIVE LINE NUMBER       63840020
         BNE   TQNEXT                   BRANCH IF NO                    63850020
         B     SETFREE                  EXIT IF QCB ON TIME DELAY Q     63870020
STOPSEND EQU   *                                                        63900020
         OI    LCBSTAT2,LCBNEGRP        SET SWITCH               S21101 63901020
         L     RPARM,DCBDEBAD           GET DEB POINTER          S21101 63902020
         TM    DEBOPATB-DEBNMSUB(RPARM),OUTONLY       IS THIS AN S21101 63903020
*                                         OUTPUT ONLY LINE       S21101 63904020
         BO    POSTHK                   BRANCH IF YES            S21101 63905020
         SPACE                                                          63906020
         LA    RTEMP,ILISTPRF(,RILIST)  POINT TO FIRST ENTRY IN  S21101 63906121
*                                         THE INVITATION LIST    S21101 63906221
         STCM  RTEMP,ADR,LCBINVPT       STORE ADDRESS OF FIRST @Z30X8IM 63906308
*                                         ILIST ENTRY          @Z30X8IM 63908308
         SPACE                                                          63912020
LOOPEX   EQU   *                                                 S21101 63913020
         CLI   AVTEZERO(RTEMP),FE       IS THIS THE LAST ENTRY   S21101 63913221
         BE    POSTHK                   YES, BRANCH              S21101 63913421
         CLI   1(RTEMP),FE              END OF THE BSC LIST      S21101 63913621
         BE    POSTHK                   YES, BRANCH              S21101 63913821
         SPACE                                                          63917020
ENTLOOP  EQU   *                                                 S21101 63918020
         BAL   RPQCB,GETQCBAD           GET THE QCB ADDRESS FOR  S21101 63919020
*                                         THIS ENTRY             S21101 63920020
         TM    QCBSTAT,QCBSEND          ARE WE CURRENTLY SENDING S22025 63921022
         BO    NEXTSEND                 YES, BRANCH              S22025 63922022
*                                                                S22025 63922122
         BAL   RPQCB,QCBRTNE            COMPUTE THE SCB ADDRESS  S22025 63922222
         TM    LCBSTAT1,LCBOCNI         REQUEST FOR STOPLINE?   SA56606 63922322
         BO    NEXTSEND                 BRANCH YES              SA56606 63922422
         TM    SCBQTYPE,SCBBFMM         MID MESSAGE ON RECEIVE?  S22025 63922522
         BO    GORCV                    YES, BRANCH              S22025 63922622
NEXTSEND EQU   *                                                 S22025 63922722
         SR    RPARM,RPARM              CLEAR A WORK REGISTER    S21101 63923221
         IC    RPARM,ILSTSIZE(,RILIST)  SIZE OF AN ENTRY         S21101 63923421
         AR    RTEMP,RPARM              ADDRESS OF NEXT ENTRY    S21101 63923621
*                                         IN INVITATION LIST     S21101 63923821
         B     LOOPEX                   SCAN NEXT ENTRY          S21101 63925020
         SPACE                                                          63926020
POSTHK   EQU   *                                                 S21101 63927020
         TM    AVTBIT1,AVTDLAYN         IS THIS SYSTEM DELAY     S21101 63928020
         BNO   TSTSTOPL                 NO, BRANCH               S21101 63929020
         MVC   LCBQCBA(3),AVTHI+1       SET THE SYSTEM DELAY QCB S21101 63930020
*                                         ADDRESS                S21101 63931020
         B     SETPARM                  BRANCH TO POST LCB       S21101 63932020
TSTSTOPL EQU   *                                                 S21101 63933020
         TM    LCBSTAT1,LCBOCNI         STOPLINE REQUESTED              64000020
         BNO   POSTOPC                  BRANCH IF NO                    64100020
         MVC   LCBQCBA(3),AVTHK+1       OPERATOR CONTROL QCB            64200020
SETPARM  EQU   *                                                 S21101 64250020
         LR    RPARM,RLCB               DISPATCHER PARAMETER            64300020
         B     DSPPOST                  POST LCB TO OPCTL               64400020
POSTOPC  EQU   *                                                        64500020
         MVI   LCBSTAT1,LCBFREEN        SET LINE FREE                   64600020
         SR    RPARM,RPARM              CLEAR REGISTER TO ZERO          64610020
         IC    RPARM,LCBUCBX            RLN-1                           64620020
         SLL    RPARM,2                 MULTIPLY BY FOUR                64630020
         L     RILIST,DCBINVLI(RPARM)   INVITATION LIST ADDRESS         64640020
         MVI   4(RILIST),AVTEZERO       SET LINE NOT SENDING            64650020
         LA    RPARM,AVTOPCOB+4         OPERATOR CONTROL ECB ADDR       64700020
         POST  (1)                                                      64800020
         B     DSPDISP                  EXIT TO DISPATCHER              64900020
         EJECT                                                          65000020
TESTOPN  EQU   *                                                        65100020
         TM    AVTBIT1,AVTCLOSN+AVTQUCKN FLUSH CLOSE                    65200020
         BM    SENDTST                  BRANCH IF YES                   65300020
*                                                                     * 65400020
*        SEE IF THERE IS A PARTIAL MESSAGE TO BE SENT.                * 65500020
*                                                                     * 65600020
         L     RSTCB,LCBRSLNK-1         BTS STCB ADDRESS                65700020
OPNLOOP  EQU   *                                                OX03968 65750005
         LA    RPARM,QCBSTVTO-IEDQQCB   STCB OFFSET INTO QCB            65800020
         LR    RQCB,RSTCB                                               65900020
         SR    RQCB,RPARM               COMPUTE QCB ADDRESS             66000020
         SR    RZERO,RZERO              CLEAR A WORK REGISTER    S21101 66020020
         IC    RZERO,QCBSCBOF           GET THE SCB INDEX        S21101 66040020
         BAL   RPQCB,QCBRTNE            COMPUTE THE SCB ADDRESS  S21101 66060020
         ST    RSCB,LCBSCBA-1           SET SCB ADDR IN LCB     SA68697 66070005
         SPACE                                                          66080020
         TM    SCBQTYPE,SCBBFMM         MIDDLE OF MESSAGE               66900020
         BZ    NEXTQCB                  BRANCH IF NO            OX03968 66930005
         TM    QCBSTAT,QCBSEND          MID MSG ON OUTPUT       OX03968 66960005
         BO    SENDSEG                  BRANCH IF YES                   67000020
NEXTQCB  EQU   *                                                OX03968 67300005
         L     RTEMP,STCBLINK-1         GET NEXT STCB ADDRESS   OX03968 67340005
         CLI   STCBPRIT(RTEMP),AVTEZERO IS THIS LAST STCB       OX03968 67380005
         BE    PRESTOP                  BRANCH IF YES TO CHECK  OX03968 67420005
*                                       TIME DELAY QUEUE FOR    OX03968 67460005
*                                       TERMINALS IN MIDDLE OF  OX03968 67500005
*                                       MESSAGE ON OUTPUT       OX03968 67540005
         LR    RSTCB,RTEMP              SAVE STCB ADDRESS       OX03968 67580005
         B     OPNLOOP                  AND LOOK AT NEXT STCB   OX03968 67620005
         SPACE 2                                               @XA08074 67630009
ABEND045 EQU   *                                               @XA08074 67640009
         LA    RENTRY,ABEND2            PASS SUBCODE FOR LOGCAL@XA08074 67650009
*                                        READ ERROR FOR REUS   @XA08074 67660009
         BAL   RETURN,AVTABEND          ABEND TCAM 045-2       @XA08074 67670009
         EJECT                                                          67700020
BTSTDQCB DS    0F                       QCB TO WHICH TIME DELAY         67800020
         DC    C'BFTS'                  POSTS DEST QCB AT END OF        67900020
         DC    XL1'0A'                  TIME DELAY INTERVAL             68000020
         DC    C'TDQ'                   IDENTIFIER               S22025 68100022
         DC    A(*-4)                   STCB ADDRESS                    68200020
*                                                                     * 68300020
*        THIS SUBTASK IS ACTIVATED BY THE TIME DELAY ROUTINE          * 68400020
*        WHEN THE TIME DELAY FOR A DESTINATION QCB HAS ELAPSED.       * 68500020
*        IT RETURNS THE QCB TO THE LCB CHAIN.  IF THE LINE IS         * 68600020
*        FREE, IT POSTS THE LCB TO ITSELF.  IF NOT, IT EXITS          * 68700020
*        TO THE DISPATCHER                                            * 68800020
*                                                                     * 68900020
         USING *,RENTRY                 SUBTASK ADDRESSABILITY          69000020
         LR    RQCB,RPARM               DEST QCB ADDRESS                69100020
*                                                                     * 69200020
*                   FIND THE LCB FOR THIS QCB                         * 69300020
*                                                                     * 69400020
         L     RDCB,QCBDCBAD-1          DCB ADDRESS                     69500020
         L     RPARM,DCBDEBAD           DEB ADDRESS                     69600020
         BAL   RPQCB,LCBFIND            FIND QCB'S LCB                  69700020
         BAL   RPQCB,QCBRTNE            COMPUTE THE SCB ADDRESS  S21101 69730020
         SPACE                                                          69760020
         LA    RPARM,QCBSTVTO           ADDR OF BTS SEND STCB           70400020
         LR    RDCB,RQCB                SAVE REG               @OX12490 70450091
         LA    RQCB,LCBRSLNK-1          ADDRESS OF STCB CHAIN           70500020
         BAL   RETURN,DSPPRIOR          INSERT STCB INTO LCB CHAIN      70600020
         LR    RQCB,RDCB                RESTORE REG            @OX12490 70650091
         L     RDCB,LCBDCBPT            DCB ADDRESS                     70700020
         TM    DCBCPRI,EQPRI            EQUAL PRIORITY                  70800020
         BO    NOSETX                   BRANCH IF YES                   70900020
         OI    LCBSTAT2,LCBSNDPR        TELL LINE END THAT IT IS        71000020
*                                       SEND PRIORITY AND THAT THERE    71100020
*                                       IS SOMETHING TO SEND            71200020
NOSETX   EQU   *                                                        71300020
         SR    RPARM,RPARM              CLEAR REG TO ZERO               71400020
         IC    RPARM,LCBUCBX                                            71500020
         SLL   RPARM,2                                                  71600020
         L     RILIST,DCBINVLI(RPARM)   INVITATION LIST ADDRESS         71700020
         TM    QCBSTAT,QCBSEND          ARE WE SENDING         @OX12490 71800091
         BO    NOBUMP                   BRANCH IF YES          @OX12490 71900091
         IC    RTEMP,4(RILIST)                                 @OX12490 72000091
         LA    RTEMP,1(0,RTEMP)                                @OX12490 72100091
         STC   RTEMP,4(RILIST)                                 @OX12490 72200091
NOBUMP   EQU   *                                                        72300020
         CLI   LCBSTAT1,AVTEZERO        LINE STOPPED                    72330020
         BE    DSPDISP                  BRANCH IF YES                   72360020
         TM    LCBSTAT1,LCBFREEN        IS THE LINE FREE                72400020
         BNO   AUTOTST                  BRANCH IF NO                    72500020
         CLI   LCBPRI,PRILCBDL          SYSTEM INTERVAL IN EFFECT       72530020
         BE    DSPDISP                  BRANCH IF YES                   72560020
         ST    RLCB,LCBQCBA-1           PREPARE TO POST LCB TO LCB      72600020
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN PRESERVE STOPLINE BITS@OY14092 72660091
         OI    LCBSTAT1,LCBRECVN        SET RECEIVE STATUS IN LCB       72720020
         LR    RPARM,RLCB               DISPATCHER PARAMETER            72800020
         B     DSPPOST                  POST LCB TO ITSELF              72900020
AUTOTST  EQU   *                                                        73000020
         CLI   LCBCPA+24,POLL           LINE IN AUTOPOLL                73100020
         BNE   DSPDISP                  BRANCH IF NO                    73200020
         ST    RLCB,AVTSAVE2            SAVE LCB POINTER         Y05331 73202505
         L     RPARM,AVTSAVTP           POINTER TO SECONDARY AVT Y05331 73205005
         USING IEDNSVTD,RPARM                                    Y05331 73207505
         TM    SAVTDIAF,SAVTVIRT        IN VM ENVIRONMENT ?      Y05331 73210005
         BNO   NOVIRT                    NO,BRANCH               Y05331 73212505
         ST    RENTRY,AVTSAVE2+28       SAVE R15                 Y05331 73217505
         LA    RZERO,LCBCPA+56          TIC ADDRESS              Y05331 73230005
         L     RENTRY,SAVTDIAG          VIRTUAL DIAGNOSE ROUTINE Y05331 73232505
         DROP  RPARM                                             Y05331 73235005
         MVI   LCBCPA+56,CCWNOP         NOP VIRTUAL TIC          Y05331 73237505
         BAL   RETURN,4(,RENTRY)        NOP REAL TIC,STOP AUTOPOLY05331 73240005
         L     RENTRY,AVTSAVE2+28       SARESTORE R15            Y05331 73242505
         NI    3(RILIST),AUTOPOLF       STOP AUTOPOLL            Y05331 73245005
         B     DSPDISP                  EXIT TO DISPATCHER       Y05331 73247505
         SPACE                                                          73250005
NOVIRT   EQU   *                        NON VIRTUAL ENVIRONMENT  Y05331 73252505
         MVI   LCBCPA+56,CCWNOP         STOP AUTOPOLL                   73400020
         SPACE 1                                                SA61794 73500052
         B     DSPDISP                  EXIT TO DISPATCHER              73600020
         EJECT                                                          73700020
TAG      EQU   *                                                        73800020
*                                                                     * 73900020
*        THIS LOGIC IS ACTIVATED BY DESTINATION SCHEDULER WHEN        * 74000020
*        EOM IS POSTED TO DESTINATION QCB. (RQCB IS SET UP)           * 74100020
*                                                                     * 74200020
         USING *,RENTRY                 ESTABLISH ADDRESSABILITY        74300020
         L     RDCB,QCBDCBAD-1          LINE GROUP DCB                  74400020
         TM    DCBOFLGS,OPEN            IS THIS DCB OPEN                74500020
         BCR   8,RETURN                 RETURN TO DEST SCHED IF NO      74600020
         L     RPARM,DCBDEBAD           DEB ADDRESS                     74700020
         TM    DEBOPATB-DEBNMSUB(RPARM),OUTPUT   OPEN FOR OUTPUT        74800020
         BCR   8,RETURN                 RETURN TO DEST SCHED IF NO      74900020
*                                                                     * 75000020
*                   FIND THE LCB FOR THIS QCB                         * 75100020
*                                                                     * 75200020
         LA    RPQCB,ENDFIND                                            75300020
LCBFIND  EQU   *                                                        75400020
         SR    RTEMP,RTEMP              CLEAR REGISTER TO ZERO          75500020
         IC    RTEMP,DEBNMEXT-DEBNMSUB(0,RPARM) NUMBER OF LCBS          75600020
         SR    RPARM,RPARM              CLEAR REGISTER TO ZERO          75700020
         IC    RPARM,QCBRELLN           QCB'S STARTING RLN              75800020
         LR    RLCB,RPARM               SAVE THIS RLN FOR LATER         75900020
         BCTR  RLCB,RZERO               RLN MINUS 1                     76000020
         SR    RTEMP,RLCB               COUNT OF LCB'S TO SCAN          76100020
         BCR   13,RETURN                RETURN TO DEST SCHED IF RLN     76200020
*                                       LESS THAN DEBNMEXT              76300020
         SR    RTEMP,RTEMP              CLEAR REGISTER TO ZERO          76400020
         IC    RTEMP,DCBEIOBX           LCB SIZE                        76500020
         MR    RPARM-1,RTEMP            STARTING LCB OFFSET             76600020
         AL    RPARM,DCBIOBAD           POINT TO IOB OF LCB             76700020
         LA    RTEMP,LCBFLAG1-IEDQLCB                                   76800020
         SR    RPARM,RTEMP              ADJUST TO START OF LCB          76900020
         LR    RLCB,RPARM               LCB ADDRESS                     77000020
         LR    RTEMP,RETURN             SAVE RETURN ADDRESS OF          77100020
*                                       DESTINATION SCHEDULER           77200020
         BR    RPQCB                    RETURN TO CALLER                77300020
ENDFIND  EQU   *                                                        77400020
         SPACE 2                                                        77500020
         TM    LCBSTAT1,LCBFREEN        IS THE LINE FREE NOW            77600020
         BNO   LINKQCB                  BRANCH IF NO                    77700020
         CLI   LCBPRI,PRILCBDL          SYSTEM INTERVAL IN EFFECT       77720020
         BE    LINKQCB                  BRANCH IF YES                   77740020
         NI    LCBSTAT1,LCBOCNI+LCBOCWTN PRESERVE STOPLINE BITS@OY14092 77760091
         OI    LCBSTAT1,LCBRECVN        SET RECEIVE STATUS IN LCB       77820020
         ST    RLCB,LCBQCBA-1           PREPARE TO POST LCB TO LCB      77900020
         LR    RZERO,RQCB               SAVE QCB ADDRESS                78100020
         BAL   RETURN,DSPPOSTR          POST LCB TO ITSELF              78200020
         LR    RQCB,RZERO               RESTORE QCB ADDRESS             78300020
         EJECT                                                          78400020
LINKQCB  EQU   *                                                        78500020
*                                                                     * 78600020
*              PUT QCB INTO LCB'S CHAIN OF WAITING QCB'S              * 78700020
*                                                                     * 78800020
         LR    RSTCB,RLCB               ADDRESS OF QCB TO WHICH         78900020
*                                       STCB IS TO BE LINKED            79000020
         L     RDCB,LCBDCBPT            DCB ADDRESS                     79100020
         TM    DCBCPRI,EQPRI            EQUAL PRIORITY                  79200020
         BO    NOSET                    BRANCH IF YES                   79300020
         OI    LCBSTAT2,LCBSNDPR        TELL LINE END THAT IT IS        79400020
*                                       SEND PRIORITY AND THAT THERE    79500020
*                                       IS SOMETHING TO SEND            79600020
NOSET    EQU   *                                                        79700020
         BAL   RETURN,DSPUNAVR          LINK QCB TO LCB                 79800020
         SPACE 2                                                        79900020
*                                                                     * 80000020
*        IF LINE IS BEING AUTOPOLLED, STOP AUTOPOLL AND EXIT          * 80100020
*        TO DESTINATION SCHEDULER.  IF NO, JUST EXIT TO DEST SCHED    * 80200020
*                                                                     * 80300020
         CLI   LCBCPA+24,POLL           LINE IN AUTOPOLL                80400020
         BNE   OUT                      BRANCH IF NO                    80500020
         ST    RLCB,AVTSAVE2            SAVE LCB POINTER         Y05331 80502505
         L     RPARM,AVTSAVTP           POINTER TO SECONDARY AVT Y05331 80505005
         USING IEDNSVTD,RPARM                                    Y05331 80507505
         TM    SAVTDIAF,SAVTVIRT        IN VM ENVIRONMENT ?      Y05331 80510005
         BNO   NOVIRT2                   NO,  BRANCH             Y05331 80512505
         LA    RZERO,LCBCPA+32          TIC ADDRESS              Y05331 80515005
         ST    RENTRY,AVTSAVE2+28       SAVE R15                 Y05331 80517505
         L     RENTRY,SAVTDIAG          VIRTUAL DIAGNOSE ROUTINE Y05331 80520005
         BAL   RETURN,4(,RENTRY)        NOP REAL TIC-STOP AUTOPOLY05331 80525005
         LA    RZERO,LCBCPA+56          TIC ADDRESS           Y05331    80527505
         L     RPARM,AVTSAVTP           POINTER TO SECONDARY AVT Y05331 80530005
         L     RENTRY,SAVTDIAG          VIRTUAL DIAGNOSE ROUTINE Y05331 80532505
         DROP  RPARM                                             Y05331 80535005
         MVI   LCBCPA+56,CCWNOP         NOP VIRTUAL TIC          Y05331 80537505
         BAL   RETURN,4(,RENTRY)        NOP REAL TIC,STOP AUTOPOLY05331 80540005
         L     RENTRY,AVTSAVE2+28       SARESTORE R15            Y05331 80542505
         B     OUT                                               Y05331 80545005
         SPACE                                                          80547505
NOVIRT2  EQU   *                        NON VIRTUAL ENVIRONMENT  Y05331 80550005
         MVI   LCBCPA+56,CCWNOP           THE POLLS                     80700020
         SPACE 2                                                        80800020
OUT      EQU   *                                                        80900020
         LR    RETURN,RTEMP             RESTORE RETURN ADDRESS          81000020
         SR    RTEMP,RTEMP              CLEAR REG TO ZERO               81100020
         IC    RTEMP,LCBUCBX            RLN-1                           81200020
         SLL   RTEMP,2                  MULTIPLE BY FOUR                81300020
         L     RILIST,DCBINVLI(RTEMP)   INVITATION LIST ADDRESS         81400020
         SR    RTEMP,RTEMP              CLEAR REG TO ZERO               81600020
         IC    RTEMP,4(RILIST)                                          81700020
         LA    RTEMP,1(0,RTEMP)                                         81800020
         STC   RTEMP,4(RILIST)                                          81900020
         BR    RETURN                   RETURN TO DEST SCHEDULER        82000020
         EJECT                                                          82100020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  S21101 82105020
*                                                             *  S21101 82110020
*        THIS SUBROUTINE WILL COMPUTE THE SCB ADDRESS         *  S21101 82115020
*                  FOR ANY DESTINATION QCB                    *  S21101 82120020
*                                                             *  S21101 82125020
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *  S21101 82130020
QCBRTNE  EQU   *                                                 S21101 82135020
         SR    RZERO,RZERO              CLEAR A WORK REGISTER    S22025 82140022
         SR    RSCB,RSCB                CLEAR ANOTHER            S21101 82145020
         IC    RSCB,QCBSCBOF            GET THE INDEX TO THE     S21101 82150020
*                                         RIGHT SCB              S21101 82155020
         IC    RZERO,AVTSCBSZ           SIZE OF AN SCB           S22025 82160022
         MR    RDCB,RZERO               COMPUTE THE OFFSET TO    S22025 82165022
*                                         THE SCB                S21101 82170020
         L     RDCB,LCBDCBPT            RESTORE THE DCB ADDRESS  S21101 82175020
         AL    RSCB,LCBSCBDA-1          ADD THE OFFSET TO THE    S21101 82180020
*                                         ABSOLUTE SCB ADDRESS   S21101 82185020
         BR    RPQCB                    RETURN TO THE CALLER     S21101 82190020
         EJECT                                                          82195020
*                                                                     * 82200020
*      S Y M B O L I C    C O N S T A N T S    A N D    E Q U A T E S * 82300020
*                                                                     * 82400020
         SPACE 2                                                        82500020
HONE     DC    H'1'                     HALFWORD OF ONE          S22025 82600022
TWELVE   DC    AL2(43200)               TWELVE-HOUR TIME DELAY          82650020
TESTRLN  DS    0H                       INSURE HALF WORD BOUNDRY S22025 82660022
         CLI   LCBUCBX,AVTEZERO         COMPARE RLN'S                   82670020
AUTOPOLF EQU   X'FE'                                                    82700020
AUTO     EQU   X'01'                                                    82800020
STRTAUTO EQU   X'01'                                                    82900020
EQPRI    EQU   X'02'                    DCB PRIORITY BYTE MASK          83000020
FE       EQU   X'FE'                    END-OF-ILIST INDICATOR          83100020
EOL      EQU   0                        OFFSET OF END-OF-ILIST          83200020
*                                       INDICATOR IN ILIST ENTRY        83300020
X0F      EQU   X'0F'                    LCBERBCT BIT FLIPPER            83400020
OPEN     EQU   X'10'                    OPENED DCB FLAG                 83500020
OUTPUT   EQU   X'01'                    LINE OPEN FOR OUTPUT            83600020
*                                       LINE GROUP OPEN FOR OUTPUT      83700020
POLL     EQU   X'09'                    POLL COMMAND                    83800020
CCWNOP   EQU   X'03'                    NO-OP COMMAND                   83900020
ILISTPRF EQU   8                        SIZE OF ILIST CONTROL AREA      84000020
ZERO     EQU   0                                                 S22025 84030022
ONE      EQU   1                                                        84060022
TWO      EQU   2                        CONSTANT                SA56606 84080022
ILSTSIZE EQU   2                        LENGTH OF AN ILIST ENTRY        84100020
THREE    EQU   3                                                        84120022
STCBPRIT EQU   4                                                 S21101 84150020
FOUR     EQU   4                                                 S22025 84160022
SIX      EQU   6                                                        84165022
EIGHT    EQU   8                                                 S22025 84170022
FIFTEEN  EQU   15                                                       84180022
OUTONLY  EQU   X'03'                    LINE OPEN FOR OUTPUT ONLY       84200020
LCBDLY   EQU   X'02'                                                    84270020
ABEND2   EQU   2                        045 ABEND SUBCODE      @XA08074 84275009
ADR      EQU   7                        MASK FOR ADDRESS STORE @Z30X8IM 84280008
         EJECT                                                          84300020
         TPRIOR                                                         84500020
         EJECT                                                          84550020
         TAVTD 2                                                        85000020
         EJECT                                                          85050020
         TQCBD                                                          85100020
         EJECT                                                          85150020
         TLCBD                                                          85200020
         EJECT                                                          85250020
         TSCBD                                                          85300020
         TDEBD                                                          85400020
         DCBD  DSORG=TX                                                 85500020
         TDISPD                                                         85600020
         TTRMD                                                          85700020
         TRECBD                                                         85800020
         TSTCBD                                                         85900020
         TPRFD                                                          86000020
         END                                                            86100020
