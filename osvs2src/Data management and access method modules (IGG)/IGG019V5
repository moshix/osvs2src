         TITLE 'IGG019V5 - 1419 APPENDAGES'                             00060002
IGG019V5 CSECT                                                          00060402
         SPACE                                                          00060802
*********************************************************************** 00100021
*                                                                     * 00180002
* MODULE NAME - IGG019V5                                              * 00180402
*                                                              @ZA06120 00180537
* ALIAS - IGG019V7                                             @ZA06120 00180637
*                                                                     * 00180802
* DESCRIPTIVE NAME - 1419 APPENDAGES                                  * 00181202
*                                                                     * 00181602
* COPYRIGHT - NONE                                                    * 00182002
*                                                                     * 00182402
* CHANGE ACTIVITY - AS FOLLOWS:                                       * 00182802
*                                                                     * 00183202
*          RELEASE 21 DELETIONS                                       * 00183602
*1022                                                            A46398 00184002
*1022                                                            A46625 00184402
*1022                                                            A41426 00184802
*1022                                                            A43711 00185202
*1022253200                                                      A43224 00185602
*1022001200                                                      A42476 00186002
*A525700                                                         A33935 00186402
*A829800                                                         A39662 00186802
*C717000                                                         A39662 00187202
*A270100-270400,525200-526000,528040-529120,845500-845800        A33924 00187602
*C913200                                                         A33924 00188002
*D525600,528600                                                  A33924 00188402
*                                                               SA60294 00188502
*                                                                     * 00188702
*          VS1 RELEASE 03 DELETIONS                                   * 00188802
*                                                       SA58043/OX01515 00188902
*                                                                     * 00189002
*          VS2 RELEASE 02 DELETIONS                                   * 00189202
*D065400-067200,072600-074400,076800-077400,079200,092400-093000,Y02072 00189302
*D126600-127800,177600-183600,186000-186600,201600-243000,249000-Y02072 00189402
*D249600,251400,254400-255000,256200,259800-261400,280200-283200,Y02072 00189502
*D284400-285900,288000,289800,291600,304800,313200,316800,318000-Y02072 00189602
*D320400,321600-324000,373800,375000-376200,377400,383400-384000,Y02072 00189702
*D386400,423600-426000,427200,431400-432000,433200,454200,457800,Y02072 00189802
*D473400,474600,475410,492580-492588,492596,498000-499200,500400,Y02072 00189902
*D502800-503400,520800,522600,533400-534600,535800,540600,546600,Y02072 00190002
*D550800,573600,574800-576000,580200,592800,601800,606600-609000,Y02072 00190102
*D622800,624600,672600-673800,675000,676200,679800,681400,697200-Y02072 00190202
*D699600,700800,734400-736800,756600-757800,758400,765110-889200,Y02072 00190302
*D901200,904200-912000,915600,916800-931200                      Y02072 00190402
*                                                                     * 00191202
*                                                                     * 00191602
* STATUS - VS2 RELEASE 2 LEVEL 0                                      * 00192002
*        VS2 REL 3.0 CHANGES                                            00192202
* A491300,856100                                               @ZA02230 00192302
*A765232-765312                                                @ZA07205 00202337
*                                                                     * 00216202
*        VS2 REL 3.7 CHANGES                                   @ZA07621 00218237
*C912840                                                       @ZA07621 00220237
*C770486-770492,771900-772100,773300-773600,773900-774900      @ZA07621 00222237
*C775200                                                       @ZA07621 00223237
*A913841-913870                                                @ZA07621 00224237
*A289257-289260                                                @ZA09994 00225237
*C636940                                                       @ZA09994 00226237
*A289257-289260                                                @ZA09992 00227137
*C901830                                                        ZA11089 00227637
*C773400                                                       @ZA14595 00228137
*C729000,C913110                                               @ZA14706 00233137
*C726450,A076275,A726000-726420                                @ZA26121 00236137
*C523676,A523340-523656                                        @ZA33065 00237137
*C342500,A342000-342300                                        @ZA33842 00238137
* FUNCTION/OPERATION -                                                * 00240002
*              THE APPENDAGES CONTAINED HEREIN MONITOR THE I/O        * 00300002
*              OPERATIONS OF THE 1419 MAGNETIC INK CHARACTER READER.  * 00360002
*              THE MAIN FUNCTION OF EACH APPENDAGE IS AS FOLLOWS:     * 00420002
*                                                                     * 00480002
***************************************************************@ZA06120 00488037
*                                                              @ZA06120 00496037
* NOTE  ***   THE PCI APPENDAGE IS NOW LOADED BY THE ALIAS OF  @ZA06120 00504037
*             IGG019V7 TO SEIALIAZE WHEN IN AN MP ENVIRONMENT  @ZA06120 00512037
*                                                              @ZA06120 00520037
*                                                              @ZA06120 00528037
*              1. PCI APPENDAGE-                                      * 00540002
*                                                                     * 00600002
*                   THIS ROUTINE HANDLES NORMAL POSTING OF BUFFERS    * 00660002
*                   AND THE UPDATING OF DATA ADDRESSES IN BOTH THE    * 00720002
*                   PCU AND SCU CCW STRINGS.  IT LINKS TO (OR SCHED-  * 00780002
*                   ULES THE USERS STACKER SELECT ROUTINE AND PLUGS   * 00840002
*                   THE RETURNED COMMAND INTO THE SCU CCW STRING.     * 00900002
*                                                                     * 00960002
*              2. ABNORMAL END APPENDAGE-                             * 01020002
*                                                                     * 01080002
*                   THIS ROUTINE HANDLES UNIT CHECK CONDITIONS        * 01140002
*                   OCCURING ON EITHER THE PCU OR SCU.  IT SETS       * 01200002
*                   ERROR INDICATIONS IN THE BUFFERS AND POSTS        * 01260002
*                   I/O  OPERATIONS IN THE MICB ECB.                  * 01320002
*                                                                     * 01380002
*              3. CHANNEL END APPENDAGE-                              * 01440002
*                                                                     * 01500002
*                   THIS ROUTINE HANDLES CHANNEL END CONDITIONS       * 01560002
*                   ON THE SCU  AND CHANNEL END OR UNIT EXCEPTION     * 01620002
*                   ON THE PCU.  BUFFER STATUS INDICATORS ARE SET     * 01680002
*                   AND POSTING IS DONE IN THE MICB ECBS.             * 01740002
*                                                                     * 01800002
*                                                                     * 01860002
* ENTRY POINTS - THE FOLLOWING FOUR ENTRY POINTS ARE USED:            * 01980002
*                                                                     * 02040002
*              1. PCIAPEN-                                            * 02220002
*                                                                     * 02280002
*                   THIS IS THE ENTRY POINT FOR THE PCI APPENDAGE.    * 02340002
*                   IT IS LINKED TO FROM IOS WHEN A PROGRAM CONTROLED * 02400002
*                   INTERRUPT OCCURS ON THE SCU CHANNEL PROGRAM.      * 02460002
*                                                                     * 02520002
*              2. ABNEND-                                             * 02580002
*                                                                     * 02640002
*                   THIS IS THE ENTRY POINT FOR THE ABNORMAL END      * 02700002
*                   APPENDAGE.  IT IS LINKED TO FROM IOS WHEN UNIT    * 02760002
*                   CHECK OR CHANNEL ERRORS OCCUR ON THE PCU OR SCU   * 02820002
*                                                                     * 02880002
*              3. CHANEND-                                            * 02940002
*                                                                     * 03000002
*                   THIS IS THE ENTRY POINT FOR THE CHANNEL END       * 03060002
*                   APPENDAGE.  IT IS LINKED TO FROM IOS WHEN         * 03120002
*                   CHANNEL END OR UNIT EXCEPTION OCCUR.              * 03180002
*                                                                     * 03600002
*                                                                     * 03660002
* INPUT -                                                             * 03780002
*                                                                     * 03840002
*              FOLLOWING IS THE INPUT TO THE APPENDAGES:              * 03900002
*                                                                     * 03960002
*                   GR1 CONTAINS THE ADDR OF THE REQUEST ELEMENT      * 04020002
*                   GR2 CONTAINS THE ADDR OF THE IOB                  * 04080002
*                   GR3 CONTAINS THE ADDR OF THE DEB                  * 04140002
*                   GR4 CONTAINS THE ADDR OF THE DCB                  * 04200002
*                   GR7 CONTAINS THE ADDR OF THE UCB                  * 04260002
*                   GR14 CONTAINS THE RETURN ADDR OF IOS              * 04320002
*                   GR15 CONTAINS THE ENTRY POINT ADDR                * 04380002
*                                                                     * 04800002
*                                                                     * 04860002
* OUTPUT -                                                            * 04980002
*              BUFFER STATUS INDICATORS ARE SET AND I/O OPERATIONS    * 05040002
*              ARE POSTED IN THE MICB ECBS.                           * 05100002
*                                                                     * 05160002
*                                                                     * 05220002
* EXTERNAL ROUTINES - THE USERS SS ROUTINE.                           * 05340002
*                                                                     * 05400002
*                                                                     * 05460002
* EXITS-NORMAL - RETURNS TO EXCP VIA A BR 14                          * 05640002
*                                                                     * 05700002
* EXITS-ERROR - NONE                                                  * 05760002
*                                                                     * 05820002
*                                                                     * 05820402
* TABLES/WORK AREAS - NONE                                            * 05820802
*                                                                     * 05821202
*                                                                     * 05821602
* MACROS-ACTION - MODESET, SETLOCK, PCIPOST, IOSGEN                   * 05822002
*                                                                     * 05822402
* MACROS-MAPPING - IHAASVT, CVT, DCBD, IEZIOB, IECDIOCM, IECDIOSB,    * 05822802
*                  IECDRQE, IHASRB, IEFUCBOB                          * 05823037
*                                                                     * 05823402
*                                                                     * 05823602
* ATTRIBUTES - SERIALLY REUSABLE, SUPERVISOR STATE, NORMALLY RUNS IN  * 05824002
*              THE USER'S KEY.                                        * 05824102
*                                                                     * 05824402
*********************************************************************** 05880000
         EJECT                                                          05940000
*********************************************************************** 06060002
*   REGISTER EQUATES                                                    06120002
*********************************************************************** 06180002
*                                                                       06180402
R0       EQU   0                       REGISTER 0                Y02072 06182002
ZERO     EQU   R0                      PARM REG                         06184002
PARM1    EQU   1                       PARM REG                         06186002
RQEREG   EQU   PARM1                   ADDR OF RQE                      06300002
PARM2    EQU   2                       PARM REG                         06302002
IOBREG   EQU   PARM2                   ADDR OF IOB                      06360002
DEBREG   EQU   3                       ADDR OF DEB                      06420002
DCBREG   EQU   4                       ADDR OF DCB                      06480002
GR5      EQU   5                       WORK REGISTER                    06780002
RWRK1    EQU   GR5                     WORK REGISTER             Y02072 06782002
RMICB    EQU   RWRK1                   PTR TO MICB CONTAINING    Y02072 06784002
*                                      ECB TO BE POSTED          Y02072 06786002
GR6      EQU   6                       WORK REGISTER                    06840002
GR7      EQU   7                       WORK REGISTER                    06900002
RUCB     EQU   GR7                     UCB ADDRESS               Y02072 06900402
CMICB    EQU   RUCB                    ADDR CURRENT MICB                06902002
GR8      EQU   8                       WORK REGISTER                    06960002
RTCB     EQU   GR8                     TCB ADDRESS               Y02072 06962002
CCWREG   EQU   RTCB                    ADDR CCW STRING                  06964002
GR9      EQU   9                       WORK REG                         07020002
GR10     EQU   10                      WORK REG                         07080002
CCREG    EQU   GR10                    COMPLETION CODE REGISTER         07140002
ECBADR   EQU   11                      ADDR ECB TO BE POSTED            07200002
BAS3     EQU   ECBADR                  BASE FOR SCHEDULED ROUTINE       07500002
GR12     EQU   12                      TCB ADDR FOR POST                07502002
BA12     EQU   GR12                    BASE REG                         07504002
R13      EQU   13                      WORK REGISTER             Y02072 07504402
SAVREG   EQU   R13                     ADDR SAVE AREA                   07506002
RTRNREG  EQU   14                      RETURN REGISTER                  07508002
R15      EQU   15                      REGISTER 15               Y02072 07510002
BASE     EQU   R15                     BASE REGISTER                    07512002
BRANREG  EQU   BASE                    BRANCH REGISTER                  07560002
         EJECT                                                          07561002
*********************************************************************** 07562002
*   MASKS, DISPLACEMENTS, AND OTHER EQUATES                             07563002
*********************************************************************** 07564002
*                                                                       07565002
*   FOLLOWING ARE EQUATES FOR MASKS AND IMMEDIATE DATA                  07567002
*                                                                       07568002
LITEL    EQU   X'10'                   TO SEE IF ITS LAST LITE          07569002
OFFLITE  EQU   X'EF'                   TO TURN OFF LIGHT SW             07570002
UCHKCHND EQU   X'0A'                   MASK FOR TESTING UNIT CHECK AND  07571002
*                                      CHANNEL  END                     07572002
ALL      EQU   X'FF'                                                    07572537
XFF      EQU   X'FF'                                                    07573002
REJOFF   EQU   X'7F'                   TO TURN OFF COMMAND REJECT       07575002
BADCOMI  EQU   X'08'                   TO INDICATE USER HAS ISSUED      07576002
*                                      REJECT COMMAND                   07577002
BADOFF   EQU   X'F7'                   TO TURN OFF BADCOMI              07578002
CHANER   EQU   X'0F'                   MASK FOR TESTING CHANNEL ERRORS  07579002
SIT0     EQU   X'0F'                   MASK FOR TESTING WHATS           07580002
*                                      HAPPENING IN THE APPENDAGES      07581002
NOP      EQU   X'03'                   NO-OP COMMAND                    07582002
ST2OR3   EQU   X'08'                   TEST FOR STRING 2 OR 3 ON PCU    07583002
ST1      EQU   X'04'                   FOR TESTING STRING 1 BIT         07584002
MSENS    EQU   X'24'                   MOD SENSE COMMAND CODE           07585002
OVERRUN  EQU   X'40'                   FOR TESTING IF BUFFER OVERRUN    07586002
*                                      IS IMMINENT                      07587002
DISENG   EQU   X'DF'                   DISENGAGE COMMAND                07588002
CHAINOFF EQU   X'BF'                   TO TURN OFF COMMAND CHAINING     07589002
CHAINON  EQU   X'40'                   TO TURN ON COMMAND CHAINING      07590002
INITIAL  EQU   X'10'                   TO SEE IF ENGAGE JUST ISSUED     07591002
LATESS   EQU   X'04'                   FOR CHECKING LATE  SS            07592002
COMRLTSS EQU   X'84'                   COMMAND REJECT - LATE SS  A39662 07593002
SETLTSS  EQU   X'20'                   FOR SETTING LATE SS IN BUFFER    07594002
X02      EQU   X'02'                   TO INDICATE ERP IS EXECUTING     07595002
X01      EQU   X'01'                   TO INDICATE SCU ERP EXECUTING    07596002
PCURR    EQU   X'80'                   TO INDICATE POST CURRENT         07598002
PCURRP1  EQU   X'40'                   TO INDICATE POST CURR+1          07599002
XFD      EQU   X'FD'                   TO TURN OFF X02                  07600002
X7F      EQU   X'7F'                   TO TURN OFF PCURR                07601002
XBF      EQU   X'BF'                   TO TURN OFF PCURRP1              07602002
XFE      EQU   X'FE'                   TO TURN OFF X01                  07603002
AUTSEL   EQU   X'02'                   FOR CHECKING AUTO SELECT BIT     07604002
SETAUTS  EQU   X'80'                   FOR SETTING AUTO SEL IN BUFFER   07605002
WAIT     EQU   X'80'                   TO CHECK WAIT BIT IN ECB         07606002
ZBIT2    EQU   X'DF'                   FOR ZEROING DOC UNDER READ       07607002
OFFERR   EQU   X'DF'                   TO TURN OFF UNRECOV              07607202
*                                      HEAD BIT                         07608002
ONBIT4   EQU   X'08'                   FOR TURNING ON BIT4 OF DCBMRFLG  07609002
OFFBIT5  EQU   X'FB'                   FOR TURNING OFF BIT5             07610002
ONBIT5   EQU   X'04'                   TO TURN ON BIT5                  07611002
OFFBIT4  EQU   X'F7'                   TO TURN OFF BIT4                 07612002
BATCH    EQU   X'80'                   TO TEST FOR BATCH NO. UPDATE     07613002
PCUABEND EQU   X'AB'                   TO TEST 'WHICH'  SWITCH          07615002
SSC0     EQU   X'0B'                   SS IND FOR POCKET 0 2ND   A33924 07616002
*                                      GROUP                     A33924 07617002
CSS0     EQU   X'DB'                   SS CMD FOR POCKET 0 2ND   A33924 07618002
*                                      GROUP                     A33924 07619002
UC       EQU   X'02'                   MASK FOR UNIT CHECK       A33924 07620002
PCIINCTL EQU   X'01'                   TO SET  'WHICH'  SWITCH          07622002
SETO5    EQU   X'A0'                   TO SET BUFFER COUNTER            07623002
INVALC   EQU   X'FF'                   TO FORCE COMMAND REJECT          07624002
MREAD    EQU   X'4C'                   MREAD BACKWARDS COMMAND          07625002
CMRJBOC  EQU   X'A1'                   TO TEST COM REJ,BOC,AND OP ATT   07626002
UNRECOV  EQU   X'20'                   TO SET UNRECOV I/O ERROR         07627002
INTREQ   EQU   X'40'                   INTERVENTION REQUIRED   @ZA26121 07627537
INTVR    EQU   X'41'                   MASK TO TEST INTVR REQ/OPR ATTN  07628002
OPATTN   EQU   X'01'                   MASK TO TEST SENS FOR OPR ATTN   07629002
SCUAB    EQU   X'BB'                   TO SAY SCU ABEND GOING           07630002
IR       EQU   X'08'                   TO SET INTV REQ BIT IN BUFFER    07631002
XF0      EQU   X'F0'                   FOR TESTING IF SCU HAS BROKEN    07632002
SITF     EQU   X'0F'                   FOR SETTING SITUATION F          07633002
SIT2     EQU   X'02'                   FOR SETTING SITUATION 2          07634002
CC3      EQU   X'70'                   FOR CHECKING CC=3                07635002
UEX      EQU   X'10'                   FOR SETTING UNIT EXCEPTION BIT   07636002
UNITEX   EQU   X'04'                    UNIT EX IN MICB        @ZA02230 07636102
UNITE    EQU   X'01'                   UNIT EXCEPTION IN CSW            07636402
SIT3     EQU   X'03'                   FOR SETTING SITUATION 3          07637002
PCUCE    EQU   X'F0'                   TO SAY PCU C.E. APPEN IS EXCTNG  07638002
SCUCE    EQU   X'F1'                   TO SAY SCU C.E. APPEN IS EXCTNG  07638437
NVAL     EQU   X'F7'                   FOR REMOVING BIT4 IN SS COMM     07639002
PCIMISD  EQU   X'04'                   TO INDICATE PCI MISSED           07640002
BDTCE    EQU   X'40'                   TO SAY BROKEN DUE TO CHAN END    07642002
COMREJ   EQU   X'80'                   FOR TESTING COMMAND REJ ON SCU   07643002
LLS      EQU   X'04'                   MASK TO SET ON LATE SS SENSE     07644002
CPCHECK  EQU   X'20'                   TO TEST CSW FOR PROGRAM CHECK    07645002
TURNOFF  EQU   X'EF'                   TO TURN OFF INITIAL BIT          07646002
XREJCOM  EQU   X'CF'                   REJECT POCKET                    07647002
BDTUC    EQU   X'20'                   USED TO INDICATE IN DCBAPPIN     07648002
*                                      THAT THE SCU HAS BROKEN DUE      07649002
*                                      TO UNIT CHECK.                   07650002
BDTLTPCI EQU   X'80'                   USED TO SET DCBAPPIN TO          07651002
*                                      INDICATE THE SCU HAS             07652002
*                                      BROKEN DUE TO LATE PCI.          07653002
PCIENTRY EQU   X'01'                                              41426 07654002
SIOENTRY EQU   X'02'                   SIGNAL FOR START I/O ENTRY 41426 07655002
IPPCCIC  EQU   X'7F'                   TO TEST ERRORS IN CSW            07657102
ASC      EQU   X'E0'                   TO TEST ATTENTION,S MOD,CU END   07657302
SIT5     EQU   X'05'                   SITUATION 5 INDICATOR            07657402
TIC      EQU   X'08'                   TIC COMMAND CODE                 07657602
WRDELAY  EQU   X'E1'                   WRITE DELAY COMMAND CODE SA60294 07657702
OFF      EQU   X'FF'                   USED TO TURN OFF BITS     Y02072 07657802
EXIT     EQU   3                       SVC NO. FOR LEAVING SS ROUTINE   07657902
*                                                                       07663837
*                                                                       07666037
*   DISPLACEMENT EQUATES                                                07668237
*                                                                       07670437
*     FOR MICB -                                                        07672637
*                                                                       07674837
MICBNEXT EQU   0                       ADDR  OF NEXT MICB               07677037
MICBECB  EQU   4                       EMBEDDED EVENT CONTROL BLOCK     07679237
MICBFLAG EQU   8                       FLAG  BITS                       07681437
MICBSENS EQU   9                       SENSE INFORMATION                07683637
MICBECBA EQU   12                      ADDR OF ECB                      07685837
MICBNM1  EQU   20                      ADDR OF CURRENT - 1              07688037
MICBDATA EQU   24                      ADDR OF BUFFER                   07690237
*                                                                       07692437
*                                                                       07694637
*      FOR DEB -                                                        07696837
*                                                                       07699037
DEBTCBAD EQU   0                       ADDR OF TCB                      07701237
DEBUCBAD EQU   32                      DISP TO UCB ADDR                 07703437
DEBSSAD  EQU   44                      ADDR OF THE USER'S SS RTN Y02072 07705637
*                                                                       07707837
*                                                                       07710037
*   FOLLOWING ARE EQUATES FOR VARIOUS DISPLACEMENTS AND LENGTHS         07712237
*                                                                       07714437
ONE      EQU   1                       DISP OF 1                        07716637
FOUR     EQU   4                       BRANCH DISPLACEMENT              07718837
INDLEN   EQU   10                      LENGTH OF BUFFER STATUS          07721037
SEVEN    EQU   15                      FOR LENGTH IN MOVE               07723237
EIGHT    EQU   8                       DISP OF 8                        07725437
TWEN4    EQU   24                      DISP OF 24                       07727637
FORTY    EQU   40                      DISP OF 40                       07729837
SIX4     EQU   64                      DISP OF 64                       07732037
FIVE     EQU   5                       DISP OF 5                        07734237
TWEN8    EQU   28                      DISP OF 28                       07736437
THREE    EQU   3                       DISP OF 3                        07738637
FOUR8    EQU   48                      DISP OF 48                A46625 07740837
TWO      EQU   2                       DISP OF 2                        07743037
SIXTEEN  EQU   16                      DISP OF  16                      07745237
THIR2    EQU   32                      DISP OF 32                       07747437
SS1DIS   EQU   16                      DISP TO FIRST SS COMMAND IN THE  07749637
*                                      SCU CHAIN                        07751837
SS2DIS   EQU   40                      DISP TO  2ND  SS COMMAND         07754037
CCWD     EQU   24                      DISP OF CCW ADDR IN IOB          07756237
IOBLN    EQU   48                      LENGTH OF PCU OR SCU IOB         07758437
XPCLEN   EQU   80                      LEN OF PCU CHAIN                 07760637
ZER0     EQU   0                                                        07762837
SCUSTRNG EQU   24                      DISP OF CCW ADDR IN IOB          07765037
STRNGLEN EQU   24                      LENGTH OF EACH PCU STRING        07767237
MSDIS    EQU   16                      DISP TO MSENS IN EACH STRING     07769437
MRDIS    EQU   8                       DISP TO MREAD IN EACH STRING     07771637
NOPDIS   EQU   0                       DISP TO NOP IN   EACH STRING     07773837
OFFREG1  EQU   4                       OFFSET TO REG 1 IN SA     Y02072 07776037
OFFREG12 EQU   48                      OFFSET TO REG 12 IN SA    Y02072 07778237
OFFREG13 EQU   52                      OFFSET TO REG 13 IN SA    Y02072 07780437
OFFREG14 EQU   56                      OFFSET TO REG 14 IN SA    Y02072 07782637
TABLE    EQU   8                       TABLE OFFSET FROM INDEX    41426 07784837
WORKA    EQU   7                                                  41426 07787037
TRCEDSP  EQU   168                     OFFSET OF TRACE TBL FR IOB 41426 07789237
TTPTR    EQU   6                                                  41426 07791437
WORKB    EQU   10                                                 41426 07793637
TRACRET  EQU   11                                                 41426 07795837
         EJECT                                                          07798002
CHANEND  B     CHANDIS(BASE)           GO TO CHANNEL END HANDLER        07800002
ABNEND   B     ABNDIS(BASE)            GO TO ABNORMAL END HANDLER       07860002
SIOENTER B     SIODIS(BASE)            START I/O APPENDAGE        41426 07950002
*                                                                       07952002
PCIAPEN  EQU   *                       START OF PCI INTERRUPT HANDLER   07980002
         USING *,BA12                  ESTABLISH ADDRESSABILITY         08042037
         USING RQE,RQEREG              ESTABLISH RQE BASE REG    Y02072 08052037
         USING IHADCB,DCBREG           ESTABLISH DCB BASE REG    Y02072 08062037
         USING IOBSTDRD,IOBREG         ESTABLISH IOB BASE REG    Y02072 08072037
*                                                                       08100000
*********************************************************************** 08160000
*   THE PCI APPENDAGE IS ENTERED WHENEVER A PROGRAM CONTROLLED          08220002
*   INTERRUPT OCCURS ON THE SCU COMMAND CHAIN.  THE PCI BIT IS ON IN    08280002
*   BOTH WRITE DELAY COMMANDS IN THE SCU CHAIN.  WHEN FUNCTIONING       08340002
*   NORMALLY, A PCI INTERRUPT SHOULD OCCUR SHORTLY AFTER THE CHANNEL    08400002
*   STARTS EXECUTING A WRITE DELAY COMMAND.  THE APPENDAGE GETS CONTROL 08460002
*   AND PERFORMS NECESSARY HOUSEKEEPING THEN LINKS TO THE USER'S        08520002
*   STACKER SELECT ROUTINE SO THAT A POCKET MAY BE DETERMINED FOR THE   08580002
*   DOCUMENT JUST READ.  THE USER LINKS BACK TO THE APPENDAGE WHICH     08640002
*   THEN PLUGS THE CHOSEN SS COMMAND CODE INTO THE NOP COMMAND          08700002
*   IMMEDIATELY FOLLOWING THE WRITE DELAY WHICH CAUSED THE INTERRUPT.   08760002
*   THE DOCUMENT WILL THEN BE SELECTED INTO THE POCKET CHOSEN BY THE    08820002
*   USER.                                                               08880002
*********************************************************************** 09060000
*                                                                       09062002
         LR    BA12,BASE                                                09120037
         STM   ZERO,BASE,KRESAV        SAVE REGISTERS                   09170037
         MVI   WHAT,PCIENTRY           SET SWITCH FOR TRACE      Y02072 09220037
         MVI   WHICH,PCIINCTL          IND PCI APPEN EXECUTING @ZA07621 09240037
         BAL   TRACRET,TRACE           ENTER TRACE               Y02072 09270037
*                                                                       09320037
         L     GR8,IOBCMDA-1           GET COMMAND ADDRESS       Y02072 09370037
         L     CMICB,DCBWTOID          GET CURRENT MICB ADDRESS@ZA06142 09420037
         CLI   ZERO(GR8),MREAD         READ COMMAND, QQ                 09480002
         BNE   WRNGCOM                 NO, PCI ON WRONG COMMAND         09540002
         MVI   ZERO(GR8),NOP           NOP INVALID COMMAND              09600002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 09602002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 09902002
         L     CCWREG,IOBSTART         GET ADDR SCU CCW CHAIN    Y02072 09960002
         L     GR6,DCBIOBAD            GET PCU IOB ADDR                 10080002
         L     GR5,CCWD(GR6)           GET ADDR PCU CCW CHAIN           10140002
         LR    GR10,GR5                SAVE ADDR PCU CHAIN              10200002
         TM    DCBMRFLG,ST2OR3         ARE WE IN STRING 2 OR 3,QQ       10260002
         BZ    ST1005                  NO, DONT BUMP POINTER            10320002
         TM    DCBMRFLG,ST1            IS IT STRING 3                   10380002
         BZ    ST2001                  NO, GO BUMP TO STRING2           10440002
         LA    GR5,STRNGLEN(0,GR5)     BUMP TO NEXT STRING              10500002
*                                                                       10502002
ST2001   LA    GR5,STRNGLEN(0,GR5)     DITTO                            10560002
*                                                                       10562002
ST1005   L     CMICB,DCBWTOID          PICK UP ADDR CURRENT MICB        10620002
         TM    MICBFLAG(CMICB),INITIAL FIRST AFTER AN ENGAGE, QQ        10680002
         BZ    NFIRST                  NOT FIRST BUF                    10740002
         MVI   ZERO(GR10),NOP          SET ENGAGE TO NOP                10800002
         B     DONST006                CONTINUE PROCESSING              10860002
*                                                                       10862002
NFIRST   EQU   *                                                        10920000
         L     GR9,MICBNM1(0,CMICB)    GET ADDR OF ZEROS                10980000
         L     GR9,MICBECBA(GR9)       SET BUFFER                       11040000
         MVI   ZERO(GR9),XFF           TO                               11100000
         MVC   ONE(SEVEN,GR9),ZERO(GR9)  ONES                           11160000
*                                                                       11162002
DONST006 LA    GR9,EIGHT(CCWREG)       POINT AT FIRST WD COMMAND        11220000
         TM    DCBMRFLG,DCBMRSCC       IS THIS 2ND SCU STRING    Y02072 11280002
         BZ    DBMPT007                NO, DON'T BUMP POINTER           11340002
         LA    GR9,TWEN4(0,GR9)        POINT AT SECOND WD COMMAND       11400000
*                                                                       11402002
DBMPT007 L     GR9,ZERO(0,GR9)         GET ADDR WD BUFFER               11460000
         LA    GR8,FOUR8(ZERO,GR9)     LIMITING BUF ADDR         A46625 11510002
         LA    GR9,SIX4(0,GR9)         POINT AT BUFFER END              11520000
         SH    GR9,IOBCSW+5            SUBTRACT RESIDUAL COUNT   Y02072 11580002
         CR    GR9,GR8                 IS CALC BUF ADDR PAST     A46625 11630002
*                                      LIMIT                     A46625 11632002
         BNH   USEGR9                  WITHIN 16 BYTES OF BUF    A46625 11634002
         LR    GR9,GR8                 USE LIMITING ADDR         A46625 11638002
*                                                                       11638102
USEGR9   EQU   *                                                 A46625 11638421
         MVI   ZERO(GR9),ZERO          SET UP WD BUFFER                 11640000
         MVC   ONE(SEVEN,GR9),ZERO(GR9)  TO ZEROS                       11700000
         ST    GR9,MICBECBA(0,CMICB)   SAVE ADDR OF ZEROS               11760000
*                                                                       11762002
WRNGCOM  EQU   *                                                        11820000
         TM    IOBCSW+3,UCHKCHND       UNIT CHECK/CHANNEL END,QQ Y02072 11880002
         BNZ   EXCPEXT2                YES, RETURN TO EXCP AND   Y02072 11940002
*                                      LET CHANNEL END OR ABNORMAL END  12000002
*                                      APPENDAGE HANDLE THE SITUATION   12060002
*                                                                       12120000
         TM    IOBCSW+4,CHANER         ANY OTHER ERRORS,QQ       Y02072 12180002
         BNZ   EXCPEXT2                YES, GO TO RETURN TO EXCP Y02072 12240002
*                                                                       12300000
         CLC   MICBSENS+1(TWO,CMICB),ZEROS   ANY SENSE FOR PCU @ZA07206 12350037
         BE    EXCPEXT2                NO RETRUN TO EXCP       @ZA04944 12355037
         L     GR8,IOBCMDA-1           GET COMMAND ADDR          Y02072 12360002
         CLI   ZERO(GR8),NOP           HAS WRITE BEEN NOPPED            12420000
         BNE   EXCPEXT2                NO, GO TO RETURN TO EXCP  Y02072 12480002
         TM    DCBAPPIN,SIT0           HAS THE PCU CHAIN STOPPED,QQ     12540002
         BNZ   EXCPEXT2                YES, GO TO RETURN TO EXCP Y02072 12600002
*                                                                       12840002
         L     GR8,MICBNEXT(0,CMICB)   GET ADDR CURRENT+1               12900002
         L     GR8,MICBNEXT(0,GR8)     GET ADDR CURRENT+2               12960002
         L     GR8,MICBNEXT(0,GR8)     GET ADDR CURRENT+3               13020002
         LA    GR6,MICBSENS+ONE(0,GR8) POINT AT PCU SENSE AREA          13080000
         ST    GR6,MSDIS(0,GR5)        PUT ADDR IN MSENSE COMMAND       13140002
         MVI   MSDIS(GR5),MSENS        PUT COMMAND BACK                 13200002
         L     GR6,MICBDATA(0,GR8)     LOAD DATA ADDR                   13260002
         AH    GR6,DCBBUFL             POINT AT BUFFER END              13320002
         BCTR  GR6,0                   DECREMENT BY ONE                 13380000
         ST    GR6,MRDIS(0,GR5)        PUT ADDR IN MODIFIED READ        13440002
         MVI   MRDIS(GR5),MREAD        RESTORE COMMAND                  13500000
         TM    DCBMRFLG,DCBMRDR        HAS DISENGAGE BEEN ISSUED Y02072 13560002
         BZ    SEIFSHUD                NO, SEE IF IT SHOULD BE          13620000
         SR    GR6,GR6                 CLEAR 6                          13680000
         IC    GR6,DCBMRIND            PICK UP BUFFER COU TER           13740000
         SH    GR6,H32CON              DECREMENT IT BY ONE              13800000
         STC   GR6,DCBMRIND            REPLACE IT.                      13860000
         SRA   GR6,FIVE                SHIFT OUT NOISE                  13920000
         BNZ   NODIS010                NOT ZERO, ALL IS WELL            13980000
         MVI   NOPDIS(GR5),INVALC      SET NOP TO AN INVALID            14040000
*                                      COMMAND, THUS FORCING A          14100000
*                                      COMMAND REJECT IF THE            14160000
*                                      DISENGAGE WAS LOST.              14220000
         B     NODIS010                DONT TEST FOR DISENGAGE          14280000
*                                                                       14282002
SEIFSHUD EQU   *                                                        14340000
         TM    MICBFLAG(GR8),OVERRUN   IS BUFFER OVERRUN IMMINENT       14520002
         BO    DISEN008                YES, GO SET FOR DISENGAGE        14580002
*                                                                       14640000
         TM    DCBMRFLG,DCBMRDRU       DID USER REQUEST DISNGAGE Y02072 14700002
         BZ    NODIS010                NO, DONT SET FOR STOP.           14760002
*                                                                       14820000
DISEN008 MVI   NOPDIS(GR10),DISENG     DITTO                            14880000
         MVI   STRNGLEN(GR10),DISENG   DITTO                            14940002
         MVI   STRNGLEN+STRNGLEN(GR10),DISENG  DITTO                    15000002
         OI    DCBMRFLG,DCBMRDR        INDICATE DISENGAGE SET    Y02072 15060002
         OI    DCBMRIND,SETO5          SET BUFFER COUNTER SO WE CAN     15120000
*                                      FORCE COMMAND REJECT IF          15180000
*                                      DISENGAGE COMMAND IS LOST.       15240000
*                                                                       15300000
*                                                                       15360000
NODIS010 L     GR5,MICBNEXT(0,CMICB)   GET ADDR CURRENT+1 MICB          15420002
         ST    GR5,DCBWTOID            BUMP CURRENT POINTER             15480002
         LA    GR5,MICBSENS(0,GR5)     POINT AT SENSE LOCATION          15540002
         L     CCWREG,IOBSTART         GET ADDR SCU CCW CHAIN    Y02072 15600002
         TM    DCBMRFLG,DCBMRSCC       ARE WE IN 2ND SCU STRING  Y02072 15660002
         BO    SCSTR015                YES, GO UPDATE FIRST STRING      15720002
         ST    GR5,ZERO(0,CCWREG)      PUT SENSE ADDR IN COMMAND        15780000
         MVI   ZERO(CCWREG),MSENS      PUT COMMAND CODE BACK            15840000
         MVI   FORTY(CCWREG),MREAD     SET UP REJECT COMMAND IN CASE    15900000
*                                      OF MISSED PCI                    15960000
         NI    FOUR(CCWREG),CHAINOFF   TURN CHAIN BIT OFF               16020000
         OI    TWEN8(CCWREG),CHAINON   TURN CHAIN BIT ON IN THIS STRNG  16080000
         B     SETSS020                GO SET SS INFO IN BUFFER         16140002
*                                                                       16200000
*                                                                       16260000
SCSTR015 ST    GR5,TWEN4(0,CCWREG)     PUT SENS ADDR IN COMMAND         16320000
         MVI   TWEN4(CCWREG),MSENS     PUT COMMAND CODE BACK            16380000
         MVI   SIXTEEN(CCWREG),MREAD   SET UP REJECT COMMAND IN CASE    16440000
*                                      OF MISSED PCI                    16500000
         NI    TWEN8(CCWREG),CHAINOFF  TURN CHAIN BIT OFF               16560000
         OI    FOUR(CCWREG),CHAINON    TURN CHAIN BIT ON IN THIS STRNG  16620000
*                                                                       16740000
*                                                                       16800000
SETSS020 TM    MICBFLAG(CMICB),INITIAL  FIRST BUFFER AFTER ENGAGE       16860002
         BO    SETRD040                YES, DONT SET SS INFO            16920002
         L     GR5,MICBNM1(0,CMICB)    GET ADDR CURRENT-1 MICB          17040002
         L     GR8,MICBDATA(0,GR5)     GET ADDR BUFFER                  17100002
         TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT,QQ           17160002
         BZ    TSTAT025                NO, TEST AUTO SELECT             17220002
         OI    THREE(GR8),SETLTSS      INDICATE LATE SS IN BUFFER       17280000
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5              17340000
*                                                                       17342002
TSTAT025 TM    MICBSENS(GR5),AUTSEL    WAS DOCUMENT AUTO SELECTED       17400002
         BZ    SETRD040                NO, GO SET READ STATUS    Y02072 17460002
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5              17520000
         OI    TWO(GR8),SETAUTS        INDICATE AUTO SELECT             17580000
*                                                                       17640000
*                                                                       17700000
SETRD040 L     GR5,MICBDATA(0,CMICB)   GET BUFFER ADDR                  18840002
         MVC   TWO(TWO,GR5),MICBSENS+ONE(CMICB)  SET READ STATUS        18900000
         NI    THREE(GR5),ZBIT2        ZERO BIT 2                       18960000
         XI    DCBMRFLG,DCBMRSCC       UPDATE STRING IND FOR SCU Y02072 19020002
         TM    DCBMRFLG,ST2OR3         STRING 2 OR 3, QQ                19080002
         BO    WHICH045                GO SEE WHICH ONE                 19140002
         NI    DCBMRFLG,OFFBIT5        TURN OFF BIT5                    19200002
         OI    DCBMRFLG,ONBIT4         TURN ON BIT 4                    19260000
         B     TSTAT055                GO TEST FOR AUTO SELECT          19320002
*                                                                       19380000
*                                                                       19440000
WHICH045 TM    DCBMRFLG,ONBIT5         STRING 3, QQ                     19500002
         BZ    SETB5050                NO, GO TURN ON BIT5              19560002
         NI    DCBMRFLG,OFFBIT4        TURN OFF BIT4                    19620002
*                                                                       19622002
SETB5050 OI    DCBMRFLG,ONBIT5         TURN ON BIT5                     19680002
*                                                                       19740000
*                                                                       19800000
TSTAT055 TM    TWO(GR5),AUTSEL         WAS DOCUMENT AUTO SELECTED       19860000
         MVI   FIVE(GR5),XREJCOM       PUT X'CF' IN BYTE FIVE           19920000
         LA    BAS3,STPRM085+TWO       SET UP NEW BASE                  19980002
         BO    EXIT0120                YES, DONT DO STACKER SELECT      20040002
         EJECT                                                          24420002
*********************************************************************** 24480000
*  FOLLOWING IS THE ENTRY POINT TO THE STACKER SELECT ROUTINE.          24540002
*********************************************************************** 24720000
*                                                                       24780000
STPRM085 BALR  BAS3,0                  BASE                             25020000
         USING *,BAS3                  REGISTERS                        25080002
         L     PARM2,DCBIMAGE          GET IMAGE ADDR ADDR IN REG2      25200002
         L     PARM1,DCBWTOID          GET ADDR CURRENT MICB            25260002
         CLI   DCBAPPIN,SIT3           IS IT SIT. 3-BAD READ     A43224 25270002
         BNE   BACK                    NO, BACK UP CURR. PTR.    A43224 25280002
         XI    DCBMRFLG,DCBMRSCC       UPDATE SCU STRING INDR    Y02072 25290002
         B     NOBACK                  DONT BACK UP PTR.         A43224 25300002
*                                                                       25302002
BACK     L     PARM1,MICBNM1(0,PARM1)  GET ADDR PREV. MICB       A43224 25310002
*                                                                       25312002
NOBACK   EQU   *                                                 A43224 25320021
         L     PARM1,MICBDATA(0,PARM1) POINT AT BUFFER                  25380002
         L     SAVREG,DCBIOBAD         GET ADDR PCU IOB          Y02072 26400002
         LA    SAVREG,IOBLN+IOBLN(0,SAVREG)  POINT AT SAVE AREA         26460002
*                                                                       26520000
         L     BRANREG,DEBSSAD(,DEBREG)  GET ADDR OF SS ROUTINE  Y02072 26580002
         LR    DEBREG,DCBREG           PUT DCB ADDR IN 3                26640000
         BALR  RTRNREG,BRANREG         GO TO  USER                      26700002
*                                                                       26760000
         L     PARM2,DCBIOBAD          GET ADDR PCU IOB                 26820002
         L     PARM2,IOBLN+SCUSTRNG(0,PARM2)  GET ADDR SCU CCW STRING   26880002
         IC    GR7,FOUR(0,PARM1)       PICK UP USERS SS CODE            26940000
         STC   GR7,FIVE(0,PARM1)       PUT COMMAND IN BYTE 5            27000000
         CLI   FOUR(PARM1),SSC0        IS SS INDICATOR A X'0B'   A33924 27010020
         BNE   TESTBNU                 NO/GO TEST FOR BNU        A33924 27020020
         LA    GR7,CSS0                LOAD COMMAND CODE FOR 0   A33924 27030020
*                                                                       27032002
TESTBNU  EQU   *                                                 A33924 27040020
         TM    ONE(PARM1),BATCH        BATCH NO. UPDATE SPECIFIED       27060000
         BO    DNTOR100                YES,LEAVE BIT 4 IN COMMAND       27120000
         LA    GR8,NVAL                GET X'F7'                        27180000
         NR    GR7,GR8                 REMOVE BIT4                      27240000
*                                                                       27300000
DNTOR100 LA    GR8,MREAD               GET READ OP CODE                 27360000
         CR    GR7,GR8                 IS USER PLUGGING A READ          27420000
         BNE   SWCHAN                  NO,  CHECK WHICH CHAIN           27480000
         L     GR8,DCBWTOID            GET CURRENT MICB ADDR            27540000
         OI    MICBFLAG(GR8),BADCOMI   INDICATE USER HAS ISSUED READ    27600000
*                                                                       27602002
SWCHAN   TM    DCBMRFLG,DCBMRSCC       IS CHAIN2 INDICATED, QQ   Y02072 27660002
         BO    SET10105                YES, PUT COMMAND IN CHAIN1       27720002
         STC   GR7,SS2DIS(0,PARM2)     PUT COMMAND IN CHAIN2            27780002
         B     EXIT0120                GET READY TO GET OUT             27840002
*                                                                       27900000
SET10105 STC   GR7,SS1DIS(0,PARM2)     PUT COMMAND IN CHAIN 1           27960002
*                                                                       28680002
EXIT0120 EQU   *                                                 Y02072 28682002
         L     RTRNREG,KRESAV+OFFREG14  RESTORE RETURN ADDRESS   Y02072 28684002
         CLI   WHICH,PCUABEND          ARE WE IN ABNORMAL END APPENDAGE 28740002
         BE    TSTXERR                 YES, SEE WHY                     28860000
*                                                                       28920000
         CLI   WHICH,PCIINCTL          IS PCI APPEND IN CONTROL  Y02072 28922002
         BNE   SSRETRN1                GO RETURN TO EXCP IF NOT  Y02072 28924002
         L     RWRK1,DCBWTOID          GET ADDR CURRENT+1 MICB @ZA06708 28924437
         L     RWRK1,MICBNM1(,RWRK1)   GET ADDR CURRENT MICB   @ZA06708 28925437
         TM    MICBFLAG(RWRK1),INITIAL FIRST BUFF AFTER ENGAGE @ZA09992 28925737
         BO    SSRETRN1                YES DONT POST           @ZA09992 28926037
         L     RWRK1,MICBNM1(,RWRK1)   GET ADDR CURRENT-1 MICB @ZA06708 28926437
         LA    RWRK1,MICBECB(,RWRK1)   GET ADDR CURRENT-1 ECB    Y02072 28928002
         OI    0(RWRK1),ZERO           PROG CHK IF NOT USER CORE Y02072 28930002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 28932002
         L     RQEREG,KRESAV+OFFREG1   RESTORE RQE ADDRESS       Y02072 28932402
         L     SAVREG,KRESAV+OFFREG13     RESTORE EXCP'S SA PTR  Y02072 28934002
         L     GR10,KCODCON            GET COMPLETION CODE       Y02072 28934402
         PCIPOST ECB=(RWRK1),SVAREA=(SAVREG),RQE=(1),CODE=(10)   Y02072X28936002
                                       POST ECB COMPLETE         Y02072 28938002
         B     SSRETRN2                GO TO RETURN TO EXCP      Y02072 29040002
*                                                                       29042002
TSTXERR  TM    ZERSAV,UNRECOV          CALL ERP, QQ                     29100002
         BNZ   CALLERP                 YES, GO IND ERP TO EXEC   Y02072 29220002
         LA    RTRNREG,4(,RTRNREG)     INCR TO 2ND EXCP RTRN PT  Y02072 29222002
         B     SSRETRN1                GO TO RETURN TO EXCP      Y02072 29224002
*                                                                       29226002
CALLERP  EQU   *                                                 Y02072 29228002
         OI    DCBMRIND,X02            INDICATE ERP IS EXECUTING        29280002
*                                                                       29282002
SSRETRN1 EQU   *                       NOT IN KEY 0              Y02072 29284002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 29286002
*                                                                       29288002
SSRETRN2 EQU   *                       ALREADY IN KEY 0          Y02072 29290002
         ST    RTRNREG,KRESAV+OFFREG14  UPDATE EXCP RETURN ADDR  Y02072 29290402
         MVI   WHICH,ZERO              ZERO SWITCH                      29292037
         LM    R0,R15,KRESAV           RESTORE EXCP'S REGISTERS  Y02072 29312037
         BR    RTRNREG                 RETURN TO EXCP                   29352037
         DROP  BAS3                    DROP BASE REGISTER               29392037
         EJECT                                                          29460002
*********************************************************************** 29520000
*   FOLLOWING IS THE ABNORMAL END APPENDAGE.  IT IS LINKED TO FROM      29580002
*   IOS WHENEVER UNIT CHECK OR CHANNEL ERRORS OCCUR ON THE CCW CHAINS.  29640002
*   THE APPENDAGE THEN SETS ERROR INFORMATION IN THE BUFFERS AND POSTS  29700002
*   THEM COMPLETE.  IF THE ERROR WAS ANYTHING OTHER THAN INTERVENTION   29760002
*   REQUIRED, THIS APPENDAGE SPECIFIES THAT THE ERP SHOULD BE SCHEDULED 29820002
*   WHEN IT RETURNS TO IOS.                                             29880002
*********************************************************************** 29940000
*                                                                       29942002
AEAPEN   EQU   *                                                        30000000
         USING PCIAPEN,BA12                                             30060000
         USING RQE,RQEREG              ESTABLISH RQE BASE REG   Y02072  30062002
         LA    BA12,PCIAPEN-ABNEND(0,BASE)  SET UP BASE                 30120002
         L     GR10,DCBIOBAD           GET ADDR PCU IOB                 30180002
         LA    GR10,EIGHT(0,GR10)      BUMP OVER PREFIX                 30240002
         LA    IOBREG,ZERO(0,IOBREG)   CLEAR OUT GARBAGE                30300002
         STM   ZERO,BASE,KRESAV        SAVE IOS REGS             Y02072 30302002
         CR    GR10,IOBREG             PCU ABNORMAL END, QQ             30360002
         BNE   SCUAB800                NO GO HANDLE SCU ABNEND          30420002
         MVI   WHICH,PCUABEND          IND PCU ABEND GOING     @ZA07621 30460037
         BAL   TRACRET,TRACE           ENTER TRACE FOR BREAK IN   41426 30500002
*                                      CHAIN                      41426 30520002
         TM    DCBMRIND,X02            ERP JUST FINISHED, QQ            30540000
         BZ    GTCOM005                NO, GO GET COMMAND ADDR          30600000
         NI    DCBMRIND,XFD            TURN OFF ERP GOING BIT           30660000
         TM    DCBMRIND,X01            IS SCU ERP EXECUTING             30720000
         BO    EXCPEXT1                YES, LET IT POST BUFFER   Y02072 30780002
*                                                                       30840000
         TM    DCBMRFG,PCURR           CURRENT NEED POSTING             30900000
         BO    NPCURR                  YES, GO POST IT                  30960000
         TM    DCBMRFG,PCURRP1         CURR+1 NEEDS POSTING, QQ         31020000
         BO    NPCURRP1                YES, GO POST IT                  31080000
*                                                                       31140000
*   NOTHING NEEDS POSTING, GET OUT                                      31200000
*                                                                       31260000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 31380002
*                                                                       31440000
NPCURR   NI    DCBMRFG,X7F             TURN OFF POST CURRENT FLAG       31500000
         L     GR5,DCBWTOID            GET ADDR CURRENT                 31560000
*                                                                       31562002
DIDEW    EQU   *                                                 Y02072 31620002
         L     CCREG,KPCUER            INIT CC TO ERROR ON PCU   Y02072 31740002
         CLI   IOBSIOCC,CC3            IS CONDITION CODE 3       Y02072 31742002
         BNE   CHKWAIT                 POST ECB IN ERROR IF NOT  Y01072 31744002
         L     CCREG,KCODCON           CHANGE CC TO IND SUCCESS  Y02072 31746002
*                                                                       31748002
CHKWAIT  EQU   *                                                 Y02072 31748402
         TM    MICBECB(GR5),WAIT       DID USER WAIT             Y02072 31748802
         BNZ   POSTECB                 YES, GO TO POST ROUTINE   Y02072 31749202
         ST    CCREG,MICBECB(,GR5)     POST ECB                  Y02072 31749602
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 31749702
*                                                                       31749802
POSTECB  EQU   *                                                 Y02072 31750002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 32100002
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 32460002
*                                                                       32520000
NPCURRP1 NI    DCBMRFG,XBF             TURN OFF POST FLAG               32580000
         L     GR5,DCBWTOID            GET ADDR OF CURRENT MICB         32640000
         L     GR5,MICBNEXT(GR5)       GET ADDR CURRENT+1               32700000
         B     DIDEW                   GO POST CURR+1                   32760000
*                                                                       32820000
GTCOM005 EQU   *                                                 Y02072 32822002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 32824002
*                                      APPENDAGE IS EXECUTING           32940002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 32942002
         CLI   IOBSIOCC,CC3            DEVICE NOT OPERATIONAL, @ZA06142 33240037
         L     CMICB,DCBWTOID          GET ADDR OF CURR MICB   @ZA06142 33300037
         BNE   XCHKCOM                 NO, SEE WHERE WE BLEW            33360037
         B     CURR020                 GO HANDLE BLOW UP ON CURRENT     33420002
*                                                                       33422002
XCHKCOM  EQU   *                                                        33480000
         L     GR5,IOBCMDA-1           PICK UP COMMAND ADDR      Y02072 33540002
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE               33600002
         LTR   GR5,GR5                 CSW ZERO                @ZA01359 33650002
         BZ    CURR020                 YES USE CURRENT BUFFER  @ZA01359 33652002
         SH    GR5,KEIGHT              POINT AT COMMAND THAT BLEW       33660002
         CLI   ZERO(GR5),MREAD         IS IT A MOD READ                 33720000
         BNE   SEEIF010                NO, CHECK  MSENSE                33780002
*                                                                       33840000
         LA    GR5,EIGHT(0,GR5)        POINT AT MSENSE                  33900000
         B     GSENS015                GO PICK OUT SENSE ADDR           33960002
*                                                                       34020000
SEEIF010 CLI   ZERO(GR5),MSENS         IS IT A MOD SENSE                34080000
         BE    GSENS015                YES, GO GET SENSE ADDR           34140002
         CLI   ZERO(GR5),TIC           IS IT A TIC?            @ZA33842 34200037
         BNE   ENGDIS                  NO - BRANCH AROUND      @ZA33842 34210037
         SH    GR5,KEIGHT              YES-BACK UP TO MSENSE   @ZA33842 34220037
         B     GSENS015                GO GET SENSE ADDR       @ZA33842 34230037
*                                                                       34240037
ENGDIS   LA    GR5,SIXTEEN(0,GR5)      MUST BE ENG OR DISENG   @ZA33842 34250037
*                                      BUMP BY 16 TO POINT AT MSENS     34320002
GSENS015 L     GR5,ZERO(0,GR5)         GET SENSE ADDR FROM COMMAND      34380000
         LA    GR5,ZERO(0,GR5)         GET RID OF GARBAGE               34440000
         SH    GR5,KTEN                GR5 NOW POINTS AT THE MICB       34500002
*                                      WHICH CORRESPONDS TO THE         34560002
*                                      COMMAND CHAIN THAT BLEW UP       34620002
         L     CMICB,DCBWTOID          GET ADDR OF CURRENT MICB         34680002
         LA    CMICB,0(0,CMICB)        GET RID OF GARBAGE               34740002
         CR    GR5,CMICB               DID WE BLOW UP ON CURRENT STRNG  34800002
         BE    CURR020                 YES,GO PROCESS ERROR             34860002
         L     GR5,MICBNM1(0,GR5)      POINT AT CURRENT-1               34920002
         CR    GR5,CMICB               DID WE BLOW UP ON CURRENT+1      34980002
         BE    CURP1065                YES, GO  PROCESS ERROR           35040002
*                                                                       35100000
         B     CURP2                   MUST HAVE BLOWN UP ON CURRENT+2  35160002
*                                                                       35220000
CURR020  TM    MICBFLAG(CMICB),INITIAL FIRST BUFF ATER AN ENGAGE        35280002
         BZ    SCUBR035                NO, GO SEE IF SCU STILL GOING    35340002
*                                                                       35400000
         L     GR5,MICBDATA(0,CMICB)   GET ADDR BUFFER                  35460002
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             35520000
*                                                                       35580000
         TM    DCBAPPIN,XF0            HAS SCU CHAIN BROKEN             35640002
         BNZ   CHKWT050                YES,GO SEE IF USER WAITED        35700002
         MVI   DCBAPPIN,SITF           INDICATE  SITUATION F.           35760002
*                                      THIS INDICATES  TO THE SCU       35820002
*                                      APPENDAGES THAT ONLY THE         35880002
*                                      CURRENT BUFFER NEEDS TO BE       35940002
*                                      POSTED                           36000002
*                                                                       36060000
         B     TSTIR060                GO CHECK FOR INTV REQUIRED       36120002
*                                                                       36180000
SCUBR035 TM    DCBAPPIN,XF0            HAS SCU CHAIN BEEN BROKEN        36240002
         BNZ   SETER040                YES, SET ERROR INFO IN BUFFER    36300002
         MVI   DCBAPPIN,SIT2           INDICATE SITUATION 2 SO THAT     36360002
*                                      SCU APPENDAGES KNOW THAT         36420002
*                                      CURRENT-1  BUFFER MUST STILL     36480002
*                                      BE SET FOR SS AND POSTED.        36540002
*                                                                       36542002
SETER040 L     GR5,MICBDATA(0,CMICB)   GET ADDR BUFFER                  36600002
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             36660000
*                                                                       36720000
CHKWT050 TM    ZERSAV,UNRECOV          GOING TO ERP                     36780002
         BNZ   REDPOST                 YES GO INDICATE WE ARE READY TO  36840002
*                                      POST UPON COMPLETION OF ERP      36900002
         TM    DCBMRIND,X01            IS SCU ERP EXECUTING             36960002
         BO    REDPOST                 YES,INDICATE WE ARE READY        37020002
*                                      ANYTIME YOU ARE.                 37080002
         TM    MICBECB(CMICB),WAIT     DID USER WAIT FOR BUFFER         37140002
         BZ    IPOST055                NO I WILL POST IT                37200002
*                                                                       37260000
         L     CCREG,KCODCON           LOAD NORMAL COMPLETION CODE      37320002
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 37440002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 37680002
*                                                                       37800000
*                                                                       37860000
IPOST055 MVC   MICBECB(FOUR,CMICB),KCODCON  POST COMPLETE               37920000
         B     TSTIR060                GO LEAVE                         37980002
*                                                                       37982002
REDPOST  OI    DCBMRFG,PCURR           SAY CURRENT MUST BE POSTED       38040002
*                                                                       38042002
TSTIR060 TM    ZERSAV,UNRECOV          ERRORS BESIDES I.R.              38100002
         BNZ   GO2ERP                  SET FOR ERP                      38160002
         CLI   IOBSIOCC,CC3            DEVICE NOT READY, QQ             38220002
         BNE   EXCPEXT1                RETURN TO EXCP IF NOT     Y02072 38280002
*                                                                       38460000
GO2ERP   OI    DCBMRIND,X02            INDICATE ERP IS EXECUTING FOR    38520002
*                                      PCU                              38580002
         B     EXCPEXT2                LET EXCP SCHEDULE ERP     Y02072 38700002
*                                                                       38702002
*                                                                       38760000
*********************************************************************** 38820000
*   THE FOLLOWING CODE HANDLES THE SITUATION WHEN THE PCU CHAIN         38880002
*   BLOWS UP ON THE CURRENT+1 BUFFER.                                   38940002
*********************************************************************** 39000000
*                                                                       39002002
CURP2    L     GR5,MICBNEXT(0,GR5)     POINT AT C+2 MICB                39060000
         L     GR5,MICBDATA(0,GR5)     POINT AT C+2 BUFFER              39120000
         LH    GR6,DCBBUFL             GET BUFFER LEN                   39180000
         BCTR  GR6,ZERO                DECREMENT FOR EXECUTE            39240000
         EX    GR6,CLR                 CLEAR C+2 BUFFER                 39300000
*                                                                       39360000
         B     CURP1065                GO HANDLE BLOW UP AS IF IT       39420000
*                                      OCCURRED ON C+1.                 39480000
*                                                                       39540000
CURP1065 TM    DCBAPPIN,XF0            HAS SCU CHAIN BROKEN             39600002
         BZ    SETSS090                GO SET STACKER INFO IN C-1       39660002
*                                                                       39720000
         CLI   WHICH,PCUABEND          ARE WE IN CHAN END APPENDAGE     39780002
         BNE   CLRBUF75                YES, GO CLEAR C+1  BUFFER        39840002
*                                                                       39900000
         L     GR5,MICBDATA(0,CMICB)   GET ADDR CURRENT BUFFER          39960000
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             40020000
*                                                                       40080000
CLRBUF75 L     GR5,MICBNEXT(0,CMICB)   GET ADDR C+1 MICB                40140002
         L     GR5,MICBDATA(0,GR5)     GET ADDR C+1 BUFFER              40200002
         LH    GR6,DCBBUFL             GET BUFFER LENGTH                40260002
         BCTR  GR6,ZERO                DECREMENT FOR EXECUTE            40320002
         EX    GR6,CLR                 CLEAR C+1 BUFFER                 40380002
*                                                                       40440000
*                                                                       40500000
         B     CHKWT050                GO POST AND EXIT                 40560002
*                                                                       40800000
*                                                                       40860000
*********************************************************************** 40920000
*   IF THE PCU CHAIN BLEW UP ON THE CURRENT+1 BUFFER AND THE SCU CHAIN  41040002
*   HAS NOT YET BROKEN, THE FOLLOWING CODE IS EXECUTED.                 41100002
*********************************************************************** 41160000
*                                                                       41280000
SETSS090 TM    MICBFLAG(CMICB),INITIAL  FIRST AFTER AN ENGAGE           41340000
         BO    SWHCH105                GO SEE TO C+1                    41400000
         L     GR5,MICBNM1(0,CMICB)    GET ADDR C-1 MICB                41460000
         L     GR6,MICBDATA(0,GR5)     GET C-1 BUFFER ADDR              41520002
         TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT,QQ           41580002
         BZ    TSTAT095                NO, TEST AUTO SELECT             41640002
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              41700000
         OI    THREE(GR6),SETLTSS      SET LATE STACKER BIT             41820000
*                                                                       41822002
TSTAT095 TM    MICBSENS(GR5),AUTSEL    WAS DOCUMENT AUTO SELECTED       41880002
         BZ    DPOST095                                                 41940000
         OI    TWO(GR6),SETAUTS        INDICATE AUTO SELECT             42000000
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              42060000
*                                                                       42120000
DPOST095 TM    MICBECB(GR5),WAIT       DID USER WAIT                    42180002
         BZ    MPST100                 NO, POST MYSELF                  42240002
         L     CCREG,KCODCON           LOAD COMPLETION CODE             42300000
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 42660002
         B     SWHCH105                GO SEE WHICH APPENDAGE WERE IN   42780002
*                                                                       42840000
*                                                                       42900000
MPST100  MVC   MICBECB(FOUR,GR5),KCODCON  POST C-1 COMPLETE             42960000
*                                                                       42962002
SWHCH105 L     GR6,MICBNEXT(,CMICB)    GET ADDR OF C+1 MICB      Y02072 43020002
         L     GR5,MICBDATA(,GR6)      GET ADDR OF C+1 BUFF      Y02072 43080002
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             43260000
         TM    ZERSAV,UNRECOV          GOING TO ERP,QQ                  43380002
         BNZ   RPOST                   YES, INDICATE READY FOR POST     43440002
         TM    DCBMRIND,X01            IS SCU EXECUTING                 43500002
         BO    RPOST                   YES, INDICATE READY FOR POST     43560002
         MVC   MICBECB(FOUR,GR6),KCODCON  POST NORMAL COMPLETION Y02072 43620002
         B     LEVALON                 GET READY FOR SS                 43680002
*                                                                       43682002
RPOST    OI    DCBMRFG,PCURRP1         CURRENT+1 MUST BE POSTED         43740002
*                                                                       43742002
LEVALON  EQU   *                                                        43800000
         L     GR5,MICBDATA(0,CMICB)   PICK UP BUFFER ADDRESS           43920002
         MVC   TWO(TWO,GR5),MICBSENS+ONE(CMICB)  SET READ STATUS        43980000
         NI    THREE(GR5),ZBIT2        ZERO BIT 2                       44040000
         MVI   DCBAPPIN,SIT3           SET SITUATION INDICATOR FOR      44160002
*                                      SCU APPENDAGES.                  44220002
         B     TSTAT055                GO AND PREPARE  FOR EXIT TO      44280002
*                                      USERS  SS  ROUTINE.              44340002
*                                                                       44400000
*********************************************************************** 44460002
*   THE FOLLOWING SUBROUTINE SETS BUFFER STATUS INDICATORS              44520002
*********************************************************************** 44522002
*                                                                       44580000
SESTAT   EQU   *                                                 Y02072 44640002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 44642002
         ST    CMICB,CSAV              SAVE CURRENT MICB                44700002
         ST    RTRNREG,RTRNSAVE        SAVE SUBROUTINE RETRN REG Y02072 44700402
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 44702002
         TM    IOBCSW+3,ASC            ATTN, S MOD, OR CU END    Y02072 44704002
         BZ    OTHERR                  NO, SEE IF OTHER ERRORS          44760002
         OI    ZERO(GR5),UNRECOV       SET IO ERROR BIT                 44820002
*                                                                       44822002
OTHERR   TM    IOBCSW+4,IPPCCIC        OTHER ERRORS IN STATUS    Y02072 44880002
         BZ    TSNS                    NO, TEST SENSE                   44940002
         OI    ZERO(GR5),UNRECOV       SET IO ERROR BIT                 45000002
*                                                                       45002002
TSNS     TM    IOBSENS0,CMRJBOC        CMD REJECT OR BUS OUT CHK Y02072 45060002
         BZ    CHKIRQ                  NO, CHECK I.R.                   45120002
         OI    ZERO(GR5),UNRECOV       SET IO ERROR BIT                 45180002
*                                                                       45182002
CHKIRQ   TM    IOBSENS0,INTVR          IS I.R. BIT ON            Y02072 45240002
         BNZ   SETIR                   YES GO SET I.R.         @ZA02234 45300002
         TM    IOBSENS0,XFF-INTVR-AUTSEL    ANY VALID SENSE    @ZA02234 45350002
         BZ    SETIR                   NO SET I.R. BIT ON      @ZA04946 45352037
         CLC   IOBSENS0(TWO),DUMSENS   DUMMY SENSE FROM IOS    @ZA04946 45352537
         BNE    SAVE0                  NO USE NORMAL SENSE     @ZA04946 45353037
         OI    ZERO(GR5),UNRECOV       SET I/O ERROR           @ZA04946 45353537
SETIR    EQU   *                                               @ZA02234 45354002
         OI    ZERO(GR5),IR            SET ON I.R. BIT                  45360002
         NI    0(GR5),OFF-UEX          TURN OFF UNIT EXCEPTION  OX01515 45362002
         L     RUCB,DEBUCBAD(,DEBREG)  GET ADDR OF PCU UCB       Y02072 45480002
         BAL   RTRNREG,DEVNREDY        GO TO SET PCU NOT READY   Y02072 45540002
         CLI   WHICH,PCUABEND          PCU ABEND, QQ                    45600002
         BE    SAVE0                   YES, DON'T SET SCU NOT    Y02072 45660002
*                                      READY                     Y02072 45720002
         L     RUCB,DEBUCBAD+4(,DEBREG)  GET ADDR OF SCU UCB     Y02072 45840002
         BAL   RTRNREG,DEVNREDY        GO TO SET SCU NOT READY   Y02072 45900002
*                                                                       45900402
SAVE0    EQU   *                                                 Y02072 45902002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 45904002
         MVC   ZERSAV(ONE),ZERO(GR5)   SAVE BYTE ZERO                   45960002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 45962002
         L     CMICB,CSAV              RESTORE MICB POINTER             46020002
         L     RTRNREG,RTRNSAVE        RESTORE RETURN ADDRESS    Y02072 46022002
         BR    RTRNREG                 RETURN                           46080002
         DROP  RQEREG                  DROP RQE BASE REGISTER    Y02072 46082002
         EJECT                                                          46500000
*********************************************************************** 46560000
*   THE FOLLOWING IS THE CHANNEL END APPENDAGE.  IT IS ENTERED WHEN     46680002
*   CHANNEL END OCCURS ON THE PCU OR SCU CCW CHAINS.                    46740002
*********************************************************************** 46800000
*                                                                       46920000
CEAPEN   EQU   *                                                        46980000
         USING RQE,RQEREG              ESTABLISH RQE BASE REG    Y02072 46982002
         LA    BA12,PCIAPEN-CHANEND(0,BASE)  SET BASE  REGISTER         47040002
         L     GR10,DCBIOBAD           GET ADDR PCU IOB                 47100002
         LA    GR10,EIGHT(GR10)        BUMP OVER PREFIX                 47160002
         LA    IOBREG,0(IOBREG)        CLEAR OUT GARBAGE                47220002
         STM   R0,R15,KRESAV           SAVE EXCP'S REGISTERS     Y02072 47250037
         CR    GR10,IOBREG             PCU CHANNEL END. QQ              47280002
         BNE   SCUCE005                NO, GO HANDLE SCU CHAN END       47400002
         MVI   WHICH,PCUCE             INDICATE PCU CHAN END     Y02072 47402002
*                                      APPEN IS BEING EXECUTED   Y02072 47404002
         BAL   TRACRET,TRACE           ENTER TRACE FOR BREAK IN   41426 47420002
*                                      CHAIN                      41426 47440002
         LA    GR5,IOBLN(GR10)         POINT TO SCU IOB                 47524002
         TM    TWO(GR5),OPATTN         TEST IF OP ATTN LAST TIME        47528002
         BZ    CECONT                  NO, CONT CHANNEL END PROCESSING  47534002
         L     RUCB,DEBUCBAD(,DEBREG)  GET ADDR OF PCU UCB       Y02072 47548002
         BAL   RTRNREG,DEVNREDY        SET PCU UCB TO NOT READY  Y02072 47555002
*                                      TO SYNC PCU WITH SCU      Y02072 47562002
CECONT   EQU   *                                                        47569000
         L     CMICB,DCBWTOID          PICK UP ADDR CURRENT MICB        47580002
*                                                                       47640000
         TM    DCBAPPIN,XF0-UEX        HAS SCU STOPPED           Y02072 47700002
         BNZ   GETGONX                 YES, POST AND LEAVE              47760000
*                                                                       47820000
         L     GR5,IOBCMDA-1           PICKUP COMMAND ADDR       Y02072 47880002
         L     GR5,ZERO(0,GR5)         GET SENSE ADDR                   47940000
         LA    GR5,ZERO(0,GR5)         GET RID OF GARBAGE               48000000
         SH    GR5,KTEN                GR5 NOW POINTS AT THE MICB WHICH 48060000
*                                      CORRESPONDS TO THE COMAND STRING 48120002
*                                      THAT TERMINATED DUE TO UNIT EX.  48180000
         LA    CMICB,0(0,CMICB)        GET RID OF GARBAGE               48240000
         CR    GR5,CMICB               TERMINATE ON CURRENT             48300000
         BE    UEONC                   YES, GO HANDLE AS NORMAL         48360000
*                                                                       48362002
*                                                                       48420000
*********************************************************************** 48422002
*   UNIT EXCEPTION ON THE PCU HAS OCCURRED ON THE CURRENT+1 BUFFER.     48480002
*   THIS MEANS THAT I/O ON THE SCU WAS NOT STARTED IN TIME TO PREVENT   48540002
*   THE PCU FROM TERMINATING. THIS SITUATION WILL BE TREATED AS A       48600002
*   LATE PCI.                                                           48660002
*********************************************************************** 48662002
*                                                                       48720000
         NI    DCBAPPIN,UEX            TURN OFF ALL BUT SCU CE @ZA05562 48770037
         OI    DCBAPPIN,SIT5           INDICATE SITUATION 5    @ZA05562 48800037
         B     EXCPEXT3                GO TO RETURN TO EXCP      Y02072 48840002
*                                                                       48900000
UEONC    EQU   *                                                        48960000
         L     GR5,MICBDATA(0,CMICB)   GET ADDR C BUFFER                49020000
         OI    ZERO(GR5),UEX           TURN ON UNIT EXCEPTION           49080000
         OI    MICBFLAG(CMICB),UNITEX  SET UNIT EX IN MICB     @ZA02230 49130002
         TM    MICBECB(CMICB),WAIT     HAS USER WAITED ON THIS   A46398 49250002
         BZ    LVTME009                                          A46398 49254021
         L     CCREG,KCODCON           PUT COMP. CODE INTO R10   A46398 49256002
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 49259202
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 49259702
*                                                                       49259802
LVTME009 MVC   MICBECB(FOUR,CMICB),KCODCON  POST MICB COMPLETE   A46398 49259902
         NI    DCBAPPIN,UEX            TURN OFF ALL BUT SCU    @ZA05562 49300037
*                                      CHAN END DELAYED BIT    @ZA05562 49305037
         OI    DCBAPPIN,SIT2           INDICATE C-1 MUST STILL @ZA05562 49310037
*                                      SET FOR SS AND POSTED            49320000
         B     EXCPEXT3                GO TO RETURN TO EXCP      Y02072 49380002
*                                                                       49382002
GETGONX  EQU   *                                                        49440000
         TM    DCBMRIND,X01            IS SCU EXECUTING                 49500002
         BNZ   RPOST2                  YES INDICATED POST NEEDED        49560002
         TM    MICBECB(CMICB),WAIT     HAS USER WAITED ON THIS BUFFER   49620002
         BZ    LVTME010                NO, DONT LINK TO POST ROUTINE    49680002
         L     CCREG,KSCUER            SET UP COMP CODE FOR POST Y02072 49740002
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 49980002
         BAL   RTRNREG,POSTRTN         LINK TO  POST ROUTINE     Y02072 50100002
*                                                                       50160002
LVTME010 MVC   MICBECB(FOUR,CMICB),KSCUER  POST COMPLETE WITH ERROR     50220000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 50400002
*                                                                       50402002
RPOST2   OI    DCBMRFG,PCURR           CURRENT NEEDS POSTING            50460002
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 50520002
         EJECT                                                          50760000
*********************************************************************** 50820000
*   THE FOLLOWING CODE HANDLES CHANNEL END CONDITIONS ON THE            50880002
*   SCU CCW CHAIN.                                                      50940002
*********************************************************************** 51000000
*                                                                       51060000
SCUCE005 EQU   *                                                 Y02072 51300002
         MVI   WHICH,SCUCE             IND SCU CHAN END        @ZA06136 51310037
         BAL   TRACRET,TRACE           ENTER TRACE FOR BREAK IN   41426 51320002
*                                      CHAIN                      41426 51340002
         L     GR5,IOBSTART            GET COMMAND CHAIN ADDR    Y02072 51342002
         L     GR6,DCBIOBAD            GET ADDR PCU IOB                 51360002
         L     GR6,CCWD(0,GR6)         GET ADDR OF PCU CCW STRING       51420002
         LA    GR6,XPCLEN(0,GR6)       POINT AT SCU STRING              51480002
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE               51540002
         CR    GR5,GR6                 DID THE CE  OCCUR ON THE         51600002
*                                      POCKET LIGHT CHAIN               51660002
         BE    WHPCU005                NO, GO HANDLE THE INTRPT  Y02072 51720002
         TM    DCBMRFG,LITEL           LAST LIT COMMAND, QQ             51780002
         BZ    EXCPEXT2                NO, GO TO RETURN TO EXCP  Y02072 51840002
         NI    DCBMRFG,OFFLITE         TURN OFF LIGHT SWITCH            51900002
*                                                                       51960000
         BAL   RTRNREG,DEVNREDY        GO TO SET SCU NOT READY   Y02072 52020002
         L     RUCB,DEBUCBAD(,DEBREG)  GET ADDR OF PCU UCB       Y02072 52140002
         BAL   RTRNREG,DEVNREDY        GO TO SET PCU NOT READY   Y02072 52200002
         B     EXCPEXT2                GO TO RETURN TO EXCP      Y02072 52320002
WHPCU005 EQU   *                                                 Y02072 52322002
         TM    DCBAPPIN,SITF           ANY PCU STATUS?           Y02072 52324002
         BNZ   WHPCU010                YES PCU CE OCCURRED FIRST Y02072 52326002
         TM    IOBCSW+3,UNITE          UNIT EXCEPTION ON?        Y02072 52326402
         BO    SETUE                   GO SET FLAG               Y02072 52326802
         L     GR5,IOBCMDA-1           LOAD ADDR OF NEXT CMND    Y02072 52328002
         CLI   0(GR5),WRDELAY          SPECIAL MS CONDITION?     Y02072 52330002
         BE    MSBREAK                 YES - GO HANDLE           Y02072 52332002
SETUE    EQU   *                                                 Y02072 52332402
         OI    DCBAPPIN,UEX            SET FLAG FOR PCU CE       Y02072 52332802
         L     CMICB,DCBWTOID          GET CURRENT MICB ADDR   @ZA33065 52334037
         TM    MICBFLAG(CMICB),INITIAL FIRST BUFFER AFTER ENG? @ZA33065 52334137
         BO    EXCPEXT1                YES-DONT SET SS INFO    @ZA33065 52334237
         L     GR5,MICBNM1(0,CMICB)    GET CURRENT-1 BUFFER    @ZA33065 52334937
         L     GR8,MICBDATA(0,GR5)     GET ADDR BUFFER         @ZA33065 52335037
         TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT?    @ZA33065 52335137
         BZ    TSTSC025                NO-TEST AUTO SELECT     @ZA33065 52335237
         OI    THREE(GR8),SETLTSS      INDICATE LATE SS IN BFR @ZA33065 52335337
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5     @ZA33065 52335437
TSTSC025 TM    MICBSENS(GR5),AUTSEL    WAS DOC AUTO SELECTED?  @ZA33065 52335537
         BZ    TSTMORE                 NO-GO DO MORE TESTS     @ZA33065 52335637
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5     @ZA33065 52337637
         OI    TWO(GR8),SETAUTS        INDICATE AUTO SELECT    @ZA33065 52339637
TSTMORE  TM    MICBSENS(GR5),ALL       ANY ERRORS?             @ZA33065 52341637
         BNZ   HAVERR                  YES-GO GET POST CODE    @ZA33065 52343637
         L     CCREG,KCODCON           COMPLETION CODE 7F      @ZA33065 52345637
         B     TSTWAIT                 GO SEE IF WAITING       @ZA33065 52347637
HAVERR   L     CCREG,KSCUER            COMPLETION CODE 41      @ZA33065 52349637
TSTWAIT  TM    MICBECB(GR5),WAIT       DID USER WAIT?          @ZA33065 52351637
         BZ    POSTIT                  NO-GO POST MYSELF       @ZA33065 52353637
         BAL   RTRNREG,POSTRTN         YES-GO TO POST ROUTINE  @ZA33065 52354637
POSTIT   TM    MICBSENS(GR5),ALL       ANY ERRORS?             @ZA33065 52355637
         BNZ   POSTERR                 YES-POST SCU IN ERROR   @ZA33065 52359637
         MVC   MICBECB(4,GR5),KCODCON  POST ECB WITH 7F        @ZA33065 52361637
         B     EXCPEXT1                RETURN TO EXCP          @ZA33065 52363637
POSTERR  MVC   MICBECB(4,GR5),KSCUER   POST ECB WITH 41        @ZA33065 52365637
         B     EXCPEXT1                RETURN TO EXCP - SCU CE   Y02072 52367637
*                                      WILL BE HANDLED AFTER PCU Y02072 52369637
WHPCU010 OI    DCBAPPIN,BDTCE          INDICATE BROKEN DUE TO CHAN END  52380002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 52382002
         MVN   CHECKARE(1),DCBAPPIN    MOVE SITUATION INDICATOR         52440002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 52442002
         CLI   CHECKARE,SIT5           LATE PCI, QQ                     52500002
         BNE   NEXTSIT                 NO/GO TEST NEXT SIT       A33924 52510002
         L     GR5,IOBCMDA-1           LOAD ADDR OF FAILING CMND Y02072 52520002
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE        A33924 52530020
         CLI   0(GR5),WRDELAY          IS THIS CCW WRITE DELAY  SA60294 52532002
         BE    MSBREAK                 IF SO, PREV CCW IS MS    SA60294 52534002
         OI    DCBAPPIN,BDTUC          INDICATE BROKEN DUE TO UC A33935 52550020
         B     HNDLLPCI                GO HANDLE LATE PCI        A33924 52570020
*                                                                       52572002
NEXTSIT  EQU   *                                                 A33924 52590020
         CLI   CHECKARE,SITF           HAS SITUATION F BEEN INDICATED   52620002
         BE    GETIT2                  YES, CURRENT MUST BE POSTED      52680000
         CLI   CHECKARE,SIT2           SITUATION 2                      52740002
         BE    CHKFZ020                GO POST C-1                      52800002
         CLI   CHECKARE,ZERO           IS IT SITUATION ZERO      A33924 52804020
         BNE   SIT3035                 NO/ASSUME SITUATION 3     A33924 52808020
*                                                                A33924 52812020
*                                                                       52814002
*********************************************************************** 52814402
*   SITUATION 0 CAN OCCUR AT THIS POINT IN TIME ONLY IF THE PRECEEDING  52816002
*   PCI CAME IN SO LATE THAT THE APPENDAGE DID NOT HAVE ADEQUATE TIME   52820002
*   TO UPDATE THE FOLLOWING MS COMMAND BEFORE THE CHANNEL FETCHES IT.   52824002
*   CONSEQUENTLY, THE SCU CHAIN BROKE AT THE MS COMMAND WITH CHANNEL    52828002
*   END AND DEVICE END ONLY.  THIS SITUATION WILL BE HANDLED AS A       52832002
*   MISSED PCI.                                                         52836002
*********************************************************************** 52838002
*                                                                       52838402
MSBREAK  EQU   *                                                SA60294 52838802
         L     GR5,IOBCMDA-1           LOAD ADDR OF LAST COMMAND Y02072 52840002
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE        A33924 52844002
         L     GR6,IOBSTART            LOAD ADDR SCU CHAN PGM    Y02072 52848002
         LA    GR6,EIGHT(0,GR6)        POINT TO SECOND COMMAND   A33924 52852002
         CR    GR5,GR6                 ARE WE ON 1ST OR 2ND MS   A33924 52856002
         BNE   SECMS                   SECOND MS                 A33924 52860037
         LA    GR6,THIR2(0,GR6)        POINT TO ASSOC NOP/SS CCW A33924 52864002
         B     UPDTCSW                 GO MODIFY IOBCSW          A33924 52868002
*                                                                       52870002
SECMS    EQU   *                                                 A33924 52872020
         LA    GR6,EIGHT(0,GR6)        POINT TO ASSOC NOP/SS CCW A33924 52876002
*                                                                       52878002
UPDTCSW  EQU   *                                                 A33924 52880020
         MVI   0(GR6),MREAD            SET NOP/SS TO MREAD COM   A33924 52884002
         LA    GR6,EIGHT(0,GR6)        POINT PAST COMMAND        A33924 52888002
         ST    GR6,IOBCMDA-1           MODIFY LAST COMMAND ADDR  Y02072 52892002
         OI    IOBCSW+3,UC             SET UNIT CHECK IN IOB     Y02072 52896002
         OI    IOBFLAG1,IOBIOERR       SET IOB EXCEPTION FLAG ON Y02072 52900002
         MVI   DCBAPPIN,SIT5           SET SITUATION 5 IN DCB    A33924 52904002
         MVI   IOBSENS0,COMREJ         SET IOBSENS0 TO COMREJ    A33924 52908002
         B     REGCH810                GO HANDLE MISSED PCI      A33924 52912002
*                                                                       52914002
GETIT    L     GR5,DCBWTOID            GET ADDR CURRENT MICB            52920002
*                                                                       52922002
POSTT011 TM    MICBECB(GR5),WAIT       HAS USER WAITED FOR BUFFER       52980002
         BZ    IPSTT015                NO, POST MYSELF                  53040002
         L     CCREG,KCODCON           LOAD COMPLETION CODE             53160002
*                                                                       53220002
HDFRPST  EQU   *                                                 Y02072 53280002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 53520002
*                                                                       53640000
BEGON012 EQU   *                                                        53700000
         TM    DCBAPPIN,BDTLTPCI       DID UNIT CHECK OCCUR             53760000
*                                      ON SCU DUE TO MISSED PCI.        53820000
*                                      IF SO (TAKE NOTE) WE ARE         53880002
*                                      IN THE ABNORMAL END APPENDAGE    53940000
         BO    STPCI030                YES, GO INDICATE SAME            54000000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 54120002
*                                                                       54180000
GETIT2   L     GR5,DCBWTOID            GET ADDR CURRENT MICB            54240000
         L     GR6,MICBDATA(0,GR5)     GET BUFFER ADDR                  54300000
         TM    ZERO(GR6),UNRECOV       ERRORS BESIDESI.R.               54360000
         BO    NOTNORM                 YES, SEE IF POST IS NEEDED       54420000
         TM    DCBMRIND,X02            IS PCU ERP EXECUTING             54480000
         BZ    GETIT                   NO, GO POST NORMAL COMPLETION    54540000
*                                                                       54542002
GTPERR   OI    DCBMRFG,PCURR           INDICATE CURRENT NEEDS POSTING   54600000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 54720002
*                                                                       54722002
NOTNORM  TM    DCBMRIND,X02            IS PCU ERP EXECUTING, QQ         54780000
         BO    GTPERR                  YES, INDICATE CURRENT NEEDS PST  54840000
         TM    MICBECB(GR5),WAIT       HAS USER WAITED                  54900000
         BZ    HFTPERR                 NO, POST MYSELF                  54960000
         L     CCREG,KPCUER            GET COMPLETION CODE              55020000
         B     HDFRPST                 GO POST ABNORMAL COMPLETION      55140000
*                                                                       55142002
HFTPERR  MVC   MICBECB(ONE,GR5),KPCUER  POST COMPLETION                 55200000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 55260002
*                                                                       55262002
IPSTT015 MVC   MICBECB(0,GR5),KCODCON  POST COMPLETE                    55320002
         B     BEGON012                SEE  WHAT SIT WE RE  IN          55380002
*                                                                       55382002
CHKFZ020 L     CMICB,DCBWTOID          GET ADDR CURRENT MICB            55440002
         L     GR5,MICBNM1(0,CMICB)    GET ADDR C-1 MICB                55500002
         L     GR6,MICBDATA(0,GR5)     GET ADDR C-1 BUFFER              55560002
         TM    MICBFLAG(CMICB),INITIAL  FIRST BUFFER AFTER AN ENGAGE    55620000
         BO    BEGON012                YES, LEAVE.                      55680002
*                                                                       55740000
CHKSS024 TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT, QQ          55800002
         BZ    ISTAT025                NO, CHECK FOR AUTO SELECT        55860002
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              55920000
         OI    THREE(GR6),SETLTSS      INDICATE LATE SS IN BUFFER       55980000
*                                                                       55982002
ISTAT025 TM    MICBSENS(GR5),AUTSEL    WAS DOCUMENT AUTO SELECTED       56040002
         BZ    POSTT011                NO, GO POST COMPLETION,          56100002
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              56160000
         OI    TWO(GR6),SETAUTS        INDICATE AUTO SELECT             56220000
         B     POSTT011                GO  POST AS COMPLETE             56280002
*                                                                       56340000
*                                                                       56400000
STPCI030 L     GR5,MICBDATA(0,CMICB)   GET CURRENT BUFFER ADDR          56460002
         OI    ZERO(GR5),PCIMISD       INDICATE PCI WAS MISSED          56520000
         LA    GR5,INDLEN(0,GR5)       BUMP OVER BUFFER STATUS          56580002
         LH    GR6,DCBBUFL             GET BUFFER LENGTH                56640002
         SH    GR6,KELEVN              DECREMENT FOR EXECUTE            56700002
         EX    GR6,CLR                 CLEAR  C+1 BUFFER                56760002
*                                                                       56820000
         CLI   CHECKARE,SIT5           HAS PCU QUIT                     56880000
         BNE   RESGO                   NO, GO EXIT                      56940000
         TM    DCBAPPIN,BDTUC          ARE WE GOING TO ERP              57000002
         BO    RPOST3                  YES, SET POST READY              57060002
*                                                                       57120000
         TM    MICBECB(CMICB),WAIT     HAS USER WAITED                  57180000
         BZ    DNGPST                  NO, POST MYSELF                  57240000
         L     CCREG,KSCUER            GET COMPLETION CODE              57300000
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 57420002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 57660002
*                                                                       57720002
DNGPST   MVC   MICBECB(FOUR,CMICB),KSCUER  POST COMPLETION              57780000
*                                                                       57782002
RESGO    TM    DCBAPPIN,BDTUC          ARE WE GOING TO ERP              57840002
         BZ    EXCPEXT2                NO, GO TO RETURN TO EXCP  Y02072 57900002
         CLI   WHICH,PCUCE             ENTERED FROM PCU CH END @ZA06136 57960037
         BE    SETPRERP                YES GO IND PRI ERP      @ZA06136 57990037
         OI    DCBMRIND,X01            INDICATE SCU ERP EXEC   @ZA06136 58010037
         B     EXCPEXT2                RETRUN TO EXCP          @ZA06136 58030037
*                                                              @ZA06136 58050037
SETPRERP OI    DCBMRIND,X02            INDICATE PCU ERP EXEC   @ZA06136 58070037
         B     EXCPEXT2                GO TO RETURN TO EXCP      Y02072 58090037
*                                                                       58140000
RPOST3   OI    DCBMRFG,PCURR           CURRENT NEEDS POSTING            58200002
         B    RESGO                    GO GET OUT                       58260000
*                                                                       58320000
*                                                                       58380000
SIT3035  L     GR5,DCBWTOID            GET ADDR CURRENT                 58440002
         L     GR6,MICBDATA(0,GR5)     GET ADDR BUFFER                  58500002
         B     CHKSS024                GO SET SS INFO                   58560002
         DROP  RQEREG                  DROP RQE BASE REGISTER    Y02072 58562002
         EJECT                                                          58800000
*********************************************************************** 58920000
*   THE  FOLLOWING CODE IS  EXECUTED IF  ABNORMAL END  OCCURS  ON       58980000
*   THE SCU CCW  CHAIN.                                                 59040000
*********************************************************************** 59100000
*                                                                       59160000
SCUAB800 EQU   *                                                 Y02072 59220002
         USING RQE,RQEREG              ESTABLISH RQE BASE REG    Y02072 59220402
         MVI   WHICH,SCUAB             INDICATE SCU ABEND GOING  Y02072 59222002
         BAL   TRACRET,TRACE           ENTER TRACE FOR BREAK IN   41426 59240002
*                                      CHAIN                      41426 59260002
         TM    DCBMRIND,X01            ERP JUST FINISH, QQ              59340000
         BZ    CHKCN805                NO, CONTINUE                     59400000
*                                                                       59460000
         NI    DCBMRIND,XFE            TURN OFF ERP GOING               59520000
         TM    DCBMRIND,X02            IS PCU ERP GOING                 59580000
         BO    EXCPEXT1                YES, LET IT POST BUFFER   Y02072 59640002
*                                                                       59700000
         TM    DCBMRFG,PCURR           CURRENT NEED POSTING, QQ         59760000
         BO    XPCURR                  YES, GO DO IT                    59820000
         TM    DCBMRFG,PCURRP1         CURR+1 NEED POSTING, QQ          59880000
         BO    XPCURRP1                YES, GO DO IT                    59940000
*                                                                       60000000
*  NOTHING NEEDS POSTING.  GET OUT                                      60060000
*                                                                       60120000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 60240002
*                                                                       60300000
XPCURR   NI    DCBMRFG,X7F             TURN OFF POST CURRENT FLAG       60360000
         L     GR5,DCBWTOID            GET ADDR CURRENT MICB            60420000
*                                                                       60422002
XDIDEW   TM    MICBECB(GR5),WAIT       DID USER WAIT, QQ                60480000
         BZ    XEYPOST                 NO, POST HERE                    60540000
         L     CCREG,KSCUER            LOAD COMPLETION CODE             60600000
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 60960002
*                                                                       61020002
XEYPOST  MVC   MICBECB(FOUR,GR5),KSCUER  POST COMPLETE                  61080000
         B     EXCPEXT1                GO TO RETURN TO EXCP      Y02072 61140002
*                                                                       61200000
XPCURRP1 NI    DCBMRFG,XBF             TURN OFF POST FLAG               61260000
         L     GR5,DCBWTOID            GET ADDR CURRENT MICB            61320000
         L     GR5,MICBNEXT(0,GR5)     GET ADDR CURR+1                  61380000
         B     XDIDEW                  GO POST                          61440000
*                                                                       61500000
CHKCN805 L     GR5,IOBSTART            GET COMMAND CHAIN ADDRESS Y02072 61560002
         L     GR6,DCBIOBAD            GET ADDR PCU IOB                 61620002
         L     GR6,CCWD(0,GR6)         GET ADDR OF PCU CCW STRING       61680000
         LA    GR6,XPCLEN(0,GR6)       POINT AT SCU STRING              61740000
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE               61800002
         CR    GR5,GR6                 ARE WE ON POCKET LIGHT CHAIN     61860002
         BE    REGCH810                NO, GO HANDLE INTERRUPT          61920002
         TM    DCBMRFG,LITEL           LAST LITE COMMAND, QQ            61980000
         BZ    EXCPEXT2                NO, GO TO RETURN TO EXCP  Y02072 62040002
         NI    DCBMRFG,OFFLITE         TURN OFF LITE SW                 62100000
*                                                                       62160000
         BAL   RTRNREG,DEVNREDY        GO TO SET SCU NOT READY   Y02072 62220002
         L     RUCB,DEBUCBAD(,DEBREG)  GET ADDR OF PCU UCB       Y02072 62340002
         BAL   RTRNREG,DEVNREDY        GO TO SET PCU NOT READY   Y02072 62400002
         B     EXCPEXT2                GO TO RETURN TO EXCP      Y02072 62520002
*                                                                       62580000
*                                                                       62640000
REGCH810 OI    DCBAPPIN,BDTUC          INDICATE SCU CHAIN BROKEN DUE    62700002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 62762002
         MVN   CHECKARE(1),DCBAPPIN    ISOLATE SITUATION                62820002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 62822002
         CLI   CHECKARE,SIT5           LATE PCI, QQ                     62880000
         BE    HNDZR815                YES,GO HANDLE IT                 62940000
         CLI   CHECKARE,SITF           IS IT SITUATION  F               63000002
         BE    HNDF3820                YES, GO HANDLE IT                63060002
         CLI   CHECKARE,SIT3           IS IT SITUATION 3                63120002
         BE    HNDSIT3                 YES, HANDLE IT                   63180002
         CLI   CHECKARE,ZER0           IS IT SITUTATION 0               63240000
         BE    HNDZR815                YES HANDLE                       63300002
         CLI   CHECKARE,SIT2           SITUATION 2                      63360002
         BE    HNDST855                YES, HANDLE IT                   63420002
*                                                                       63422002
HNDZR815 L     GR5,IOBCMDA-1           PICK UP COMMAND ADDR      Y02072 63480002
         LA    GR5,0(0,GR5)            GET RID OF GARBAGE               63540002
         SH    GR5,KEIGHT              POINT AT FAILING COMMAND         63600002
         BM    STPSS890                ZERO CSW USE CURR MICB  @ZA06142 63630037
*                                                                       63638037
         CLI   ZERO(GR5),WRDELAY       IS IT A WR DLY CMD      @ZA01358 63646037
         BNE   CHKREAD                 NO CHECK FOR MOD READ   @ZA03940 63654037
         TM    IOBSENS0,COMREJ         COMMAND REJECT          @ZA03940 63662037
         BNO   CHKREAD                 NO CONTINUE             @ZA04949 63670037
         LA    GR6,EIGHT(GR5)          POINT TO NOP SS         @ZA04949 63678037
         CLI   EIGHT(GR6),TIC         END OF STRING            @ZA04949 63686037
         BNE   UPDTCSW                YES HANDLE AS MISSED PCI @ZA09995 63694037
         SH    GR6,K24                BACK UP TO FIRST NOP SS  @ZA04949 63702037
         B     UPDTCSW                GO HANDLE AS MISSED PCI  @ZA04949 63710037
CHKREAD  EQU   *                                               @ZA04949 63718037
         CLI   ZERO(GR5),MREAD         IS IT A READ COMMAND             63720000
         BNE   RGUCK875                NO, GO HANDLE REGULAR UNIT CHECK 63780000
         TM    IOBSENS0,COMREJ         COMMAND REJECT, QQ        Y02072 63840002
         BZ    RGUCK875                NO, HANDLE AS REGULAR ERROR      63900000
         L     CMICB,DCBWTOID          GET CURRENT MICB ADDR            63960000
         TM    MICBFLAG(CMICB),BADCOMI  DID USER ISSUE THIS COMMAND     64020002
         BZ    MSPCI                   NO, ITS A MISSED PCI             64080002
         NI    MICBFLAG(CMICB),BADOFF  TURN OFF BAD COMMAND BIT         64140000
         B     RGUCK875                HANDLE AS COMMAND REJECT         64200000
*                                                                       64202002
MSPCI    EQU   *                                                        64260000
         NI    IOBSENS0,REJOFF         TURN OFF COMMAND REJECT   Y02072 64320002
         OI    IOBSENS0,LLS            SET ON LATE SS SENSE      Y02072 64380002
*                                                                       64440000
*                                                                       64442002
*********************************************************************** 64444002
*   COMMAND REJECT HAS OCCURRED ON A READ COMMAND TO THE SCU.           64500002
*   THIS MEANS THAT THE PCI INTERRUPT WAS NOT ACCEPTED IN TIME TO       64560002
*   RESET THE COMMAND TO A NOP                                          64620002
*********************************************************************** 64622002
*                                                                       64680000
HNDLLPCI EQU   *                                                        64740000
         OI    DCBAPPIN,BDTLTPCI       INDICATE SCU CHAIN BROKEN DUE    64800000
*                                      TO LATE PCI.                     64860000
         CLI   EIGHT(GR5),TIC          IS IT A TIC COMMAND              64920002
         BNE   GSENS                   NO, GO PICK UP SENSE AREA ADDR   64980002
         S     GR5,FORTY8              YES, POINT TO FIRST SENSE COMND  65040002
*                                                                       65042002
GSENS    L     GR5,EIGHT(GR5)          POINT TO SENSE COMMAND           65100002
         LA    GR5,ZERO(0,GR5)         GET RID OF GARBAGE               65160000
         SH    GR5,KNINE               POINT AT ASSOCIATED MICB         65220000
         L     CMICB,DCBWTOID          GET CURRENT POINTER              65280000
         CR    GR5,CMICB               DID THE PCI INTERRUPT OCCUR      65340000
*                                      SO LATE THAT WE STILL GOT        65400000
*                                      COMMAND REJECT ON THE WRITE.     65460000
         BE    CHKFZ020                NO, GO SET PCI MISSED IN         65520000
*                                      CURRENT AND POST C-1.            65580000
         ST    GR5,DCBWTOID            YES, BACK UP CURRENT POINTER     65640000
         LR    CMICB,GR5               DITTO                            65700000
         B     STPCI030                GO SET PCI MISSED IN CURRENT     65760000
*                                                                       65820000
*                                                                       65880000
HNDF3820 L     CMICB,DCBWTOID          GET ADDR C MICB                  65940002
         L     GR5,MICBDATA(0,CMICB)   GET BUFFER ADDR                  66000002
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             66060000
         TM    ZERSAV,UNRECOV          UNRECOVERABLE ERROR, QQ          66120000
         BZ    NONTALL                 NO, CONTINUE                     66180000
         NI    ZERO(GR5),OFFERR        TURN OFF BIT 2                   66240000
         OI    ZERO(GR5),BIT1          TURN ON UNRECOV SS ERROR         66300000
*                                                                       66302002
NONTALL  EQU   *                                                        66360000
         TM    ZERSAV,UNRECOV          GOING TO ERP, QQ                 66780002
         BO    RPOST4                  YES, INDICATE POST NEEDED        66840000
         TM    DCBMRIND,X02            IS PCU ERP EXECUTING             66900000
         BO    RPOST4                  YES, INDICATE POST NEEDED        66960000
         TM    MICBECB(CMICB),WAIT     HAS USER WAITED, QQ              67020002
         BZ    IPOST840                NO, POST IT MYSELF               67080002
*                                                                       67140000
         L     CCREG,KCODCON           GET NORMAL COMPLETION CODE       67200000
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 67440002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 67560002
*                                                                       67680000
*                                                                       67740000
IPOST840 MVC   MICBECB(FOUR,CMICB),KCODCON  POST COMPLETE               67800000
*                                                                       67860000
XIT0850  TM    ZERSAV,UNRECOV          ERRORS BESIDES   I.R.            67920000
         BZ    EXCPEXT1                DONT HAVE ERP SCHEDULED   Y02072 68040002
         OI    DCBMRIND,X01            INDICATE SCU ERP EXECUTING       68100000
         CLI   CHECKARE,SIT5           PCU DOWN, MISSED PCI      A43711 68110002
         BNE   EXCPEXT2                NO, GO TO RETURN TO EXCP  Y02072 68120002
         OI    DCBMRFG,PCURR           CURR MICB NEEDS POSTING   A43711 68130002
         B     EXCPEXT2                HAVE ERP SCHEDULED        Y02072 68160002
*                                                                       68220000
RPOST4   OI    DCBMRFG,PCURR           CURRENT NEEDS POSTING            68280000
         B     XIT0850                 GO GET OUT                       68340000
*                                                                       68400000
HNDST855 L     CMICB,DCBWTOID          GET ADDR CURRENT MICB            68460002
         TM    MICBFLAG(CMICB),INITIAL  FIRST BUFFER AFTER AN ENGAGE    68520000
         BZ    SXTSS860                NO, SET SS INFO IN C-1           68580002
         NI    MICBFLAG(CMICB),TURNOFF  SET OFF INITIAL SWITCH          68640000
         B     HNDF3820                GO SET ERR INFO IN CURRENT       68700002
*                                                                       68760000
SXTSS860 L     GR5,MICBNM1(0,CMICB)    GET ADDR C-1 MICB                68820002
         L     GR8,MICBDATA(0,GR5)     GET ADDR BUFFER                  68880002
         TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT, QQ          68940002
         BZ    NTSTA865                NO, TEST AUTO SELECT             69000002
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5              69060000
         OI    THREE(GR8),SETLTSS      SET LATE SS BIT                  69120000
*                                                                       69122002
NTSTA865 TM    MICBSENS(GR5),AUTSEL    AUTO SELECT, QQ                  69180002
         BZ    NPSTT870                NO, GO POST COMPLETE             69240002
         MVI   FIVE(GR8),XREJCOM       PUT X'CF' IN BYTE 5              69300000
         OI    TWO(GR8),SETAUTS        SET AUTO SELECT BIT              69360000
*                                                                       69420000
NPSTT870 TM    MICBECB(GR5),WAIT       DID USER WAIT                    69480002
         BZ    NLPST872                NO, POST MYSELF                  69540002
*                                                                       69600000
         L     CCREG,KCODCON           LOAD NORMAL COMPLETION CODE      69660002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 70020002
         B     HNDF3820                GO SET ERR INFO IN CURRENT       70140002
*                                                                       70200000
NLPST872 MVC   MICBECB(0,GR5),KCODCON  POST BUFFER                      70260002
         B     HNDF3820                GO SET ERR INFO                  70320002
*                                                                       70322002
RGUCK875 L     GR6,IOBSTART            GET ADDR SCU CHAIN        Y02072 70380002
         LA    GR6,0(0,GR6)            GET RID OF GARBAGE               70440002
         CR    GR5,GR6                 BLOW IN STRING2                  70500002
         BE    BINTW880                YES, SEE IF THATS CURRENT        70560002
*                                                                       70620000
         LA    GR6,THIR2(0,GR6)        POINT AT STRING 2                70680000
         CR    GR5,GR6                 BLOW IN STRING2                  70740002
         BNL   BINTW880                YES SEE IF THATS CURRENT         70800002
*                                                                       70860000
         TM    DCBMRFLG,DCBMRSCC       IS CHAIN2 CURRENT         Y02072 70920002
         BO    BKUPT885                YES, WE BLEW IN C-1              70980002
         B     STPSS890                BLEW UP IN CURRENT               71040002
*                                                                       71042002
BINTW880 TM    DCBMRFLG,DCBMRSCC       IS CHAIN2 CURRENT         Y02072 71100002
         BO    STPSS890                YES, WE BLEW IN CURRENT          71160002
*                                                                       71220000
*                                                                       71222002
*********************************************************************** 71224002
*  BLEW UP IN C-1 CHAIN. SET SS INFORMATION AND POST C-1 THEN SET       71280002
*  ERROR INFORMATION IN CURRENT.                                        71340002
*********************************************************************** 71342002
*                                                                       71344002
BKUPT885 L     CMICB,DCBWTOID          GET ADDR C MICB                  71400000
         L     GR5,MICBNM1(0,CMICB)    GET ADDR C-1 MICB                71460000
         L     GR5,MICBDATA(0,GR5)     GET BUFFER ADDR                  71520002
         TM    IOBCSW+4,CPCHECK        PROGRAM CHECK, QQ         Y02072 71580002
         BO    MCF                     YES, SET BUFFER INFO             71640000
         TM    IOBSENS0,COMRLTSS       COMMAND REJ - LATE SS     Y02072 71700002
         BZ    NOTESA                  NO, TEST AUTO SELECT             71760000
*                                                                       71762002
MCF      EQU   *                                                        71820000
         MVI   FIVE(GR5),XREJCOM       PUT X'CF' IN BYTE 5              71880000
         OI    THREE(GR5),SETLTSS      SET LATE STACKER BIT             71940000
*                                                                       71942002
NOTESA   TM    IOBSENS0,AUTSEL         WAS IT AUTO SELECTED, QQ  Y02072 72000002
         BZ    NXGO                    NO DONT SET BIT                  72060000
         OI    TWO(GR5),SETAUTS        INDICATE AUTO SELECT             72120000
         MVI   FIVE(GR5),XREJCOM       PUT X'CF' IN BYTE 5              72180000
*                                                                       72240000
NXGO     L     GR5,MICBNM1(0,CMICB)    GO AND POST C-1                  72300000
         B     PSTIT900                AND SET C.                       72360000
*                                                                       72420000
*                                                                       72480000
STPSS890 L     CMICB,DCBWTOID          GET ADDR CMICB                   72540002
         TM    MICBFLAG(CMICB),INITIAL FIRST BFR AFTER ENG?    @ZA26121 72600037
         BZ    SKIPIT                  IF NO-GO AROUND         @ZA26121 72603037
         CLI   CHECKARE,SIT5           SITUATION 5?            @ZA26121 72606037
         BNE   SKIPIT                  IF NO-GO AROUND         @ZA26121 72609037
         TM    MICBSENS(CMICB),INTREQ  INTERVENTION REQUIRED?  @ZA26121 72612037
         BZ    SKIPIT                  IF NO-GO AROUND         @ZA26121 72615037
         L     GR5,MICBDATA(0,CMICB)   CURRENT BFR ADDR        @ZA26121 72618037
         OI    0(GR5),UNRECOV          SET UNRECOV ERROR       @ZA26121 72621037
         OI    DCBMRIND,DCBMRERS       SET ERP FOR SCU         @ZA26121 72624037
         TM    MICBECB(CMICB),WAIT     DID USER WAIT?          @ZA26121 72627037
         BZ    IPOST                   IF NO-GO POST IT        @ZA26121 72630037
         L     CCREG,KSCUER            LOAD POST CODE          @ZA26121 72633037
         BAL   RTRNREG,POSTRTN         TO POST ROUTINE         @ZA26121 72636037
IPOST    MVC   MICBECB(4,CMICB),KSCUER MOVE POST CODE TO MICB  @ZA26121 72639037
         B     EXCPEXT2                TO EXCP TO GO TO ERP    @ZA26121 72642037
SKIPIT   L     GR5,MICBNM1(0,CMICB)    GET ADDR C-1            @ZA26121 72645037
         L     GR6,MICBDATA(0,CMICB)   GET BUFFER ADDR                  72660002
         TM    MICBSENS(GR5),LATESS    LATE STACKER SELECT,QQ           72720002
         BZ    TSTAT895                NO, TEST FOR AUTO SELECT         72780002
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              72840000
         OI    THREE(GR6),SETLTSS      SET LATE SS BIT         @ZA14706 72900037
*                                                                       72902002
TSTAT895 TM    MICBSENS(GR5),AUTSEL    AUTO  SELECT,QQ                  72960002
         BZ    PSTIT900                NO , GO  POST                    73020002
         OI    TWO(GR6),SETAUTS        SET AUTO SELECT BIT              73080000
         MVI   FIVE(GR6),XREJCOM       PUT X'CF' IN BYTE 5              73140002
*                                                                       73200000
PSTIT900 TM    MICBECB(GR5),WAIT       DID USER WAIT                    73260002
         BZ    PMYSF                   NO, POST IT MYSELF               73320002
         L     CCREG,KCODCON           LOAD  NORMAL COMPLETION CODE     73380002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 73740002
*                                                                       73800002
PMYSF    MVC   MICBECB(FOUR,GR5),KCODCON  POST COMPLETE                 73860002
         L     CMICB,DCBWTOID          GET CURRENT MICB ADDR            73980002
         L     GR5,MICBDATA(0,CMICB)   GET BUFFER ADDR.                 74040002
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             74100000
         TM    ZERSAV,UNRECOV          ERRORS BESIDES I.R.              74160000
         BZ    NONTALL1                NO, CONTINUE                     74220000
         NI    ZERO(GR5),OFFERR        TURN OFF BIT 2                   74280000
         OI    ZERO(GR5),BIT1          TURN ON BIT 1                    74340000
*                                                                       74342002
NONTALL1 EQU   *                                                        74400000
         B     XIT0850                                                  74460000
*                                                                       74640000
*                                                                       74700000
HNDSIT3  L     CMICB,DCBWTOID          GET ADDR C MICB                  74760000
         L     GR5,MICBDATA(0,CMICB)   GET BUFFER ADDR                  74820000
         TM    IOBSENS0,LATESS         LATE STACKER SELRCT, ,QQ  Y02072 74880002
         BZ    TESATX                  NO, TEST AUTO SELECT             74940000
         OI    THREE(GR5),SETLTSS      SET LATE STACKER BIT             75000002
         MVI   FIVE(GR5),XREJCOM       PUT X'CF' IN BYTE 5              75060000
*                                                                       75120000
TESATX   TM    IOBSENS0,AUTSEL         WAS DOCUMENT AUTO SELECTD Y02072 75180002
         BZ    NOWPS                   NO, POST AS COMPLETE             75240000
         MVI   FIVE(GR5),XREJCOM       PUT X'CF' IN BYTE 5              75300000
         OI    TWO(GR5),SETAUTS        INDICATE AUTO SELECT             75360000
*                                                                       75362002
NOWPS    EQU   *                                                 Y02072 75420002
         TM    MICBECB(CMICB),WAIT     HAS USER WAITED                  75480000
         BZ    XYPOST                  NO, POST MYSELF                  75540000
         L     CCREG,KCODCON           LOAD NORMAL COMPLETION CODE      75600000
         LR    RMICB,CMICB             SET UP MICB PTR FOR POST  Y02072 75810002
         BAL   RTRNREG,POSTRTN         LINK TO POST ROUTINE      Y02072 75900002
*                                                                       75930002
XYPOST   MVC   MICBECB(FOUR,CMICB),KCODCON  POST COMPLETION             75960002
         L     GR5,MICBNEXT(0,CMICB)   GET ADDR C+1 MICB                76020002
         L     GR5,MICBDATA(0,GR5)     GET ADDR C+1 BUFFER              76080000
         BAL   RTRNREG,SESTAT          GO SET BUFFER STATUS             76140000
         TM    ZERSAV,UNRECOV          ERRORS BESIDES I.R.              76200000
         BZ    NONTALL2                NO, CONTINUE                     76260000
         NI    ZERO(GR5),OFFERR        TURN OFF BIT 2                   76320000
         OI    ZERO(GR5),BIT1          TURN ON BIT1                     76380000
*                                                                       76382002
NONTALL2 EQU   *                                                        76440000
         B     XIT0850                 GET OUT                          76500000
         DROP  RQEREG                  DROP RQE BASE REGISTER    Y02072 76500402
         EJECT                                                          76500802
*********************************************************************** 76501002
*   THE FOLLOWING SUBROUTINE PLACES ENTRIES INTO THE 1419 TRACE TABLE.  76501102
*********************************************************************** 76501202
*                                                                       76501402
SIOTRAC  EQU   *                                                  41426 76501602
         USING RQE,RQEREG              ESTABLISH RQE BASE REG    Y02072 76501837
         DROP  BA12                    FORCE USE OF BASE REG 15   41426 76502537
         USING SIOENTER,BASE           SAVE REGS BEFORE USING 12  41426 76503237
         STM   0,15,KRESAV             STORE IOS REGISTERS        41426 76504002
         DROP  BASE                    RETURN TO BASE REG 12      41426 76505002
         USING PCIAPEN,BA12            RETURN TO BASE REG 12      41426 76506002
         LA    BA12,PCIAPEN-SIOENTER(0,BASE)  EST.                41426 76507002
*                                      ADDRESSIBILITY             41426 76508002
         MVI   WHAT,SIOENTRY           SET SWITCH                 41426 76509002
         MVI   WHICH,SIOENTRY          INDICATE SIO FOR TRACE  @ZA07621 76509237
         LR    RWRK1,RUCB              SAVE UCB ADDR           @ZA01360 76509402
         L     RUCB,DEBUCBAD(,DEBREG)  GET PRI UCB ADDR        @ZA07205 76523237
         BAL   RTRNREG,NRDYTST         SEE IF PRI IS READY     @ZA07205 76524237
         L     RUCB,DEBUCBAD+4(,DEBREG) GET SEC UCB ADDR       @ZA07205 76525237
         LA    RTRNREG,TRACIT          SET RETURN ADDR         @ZA07205 76526237
         BNZ   DEVNREDY                GO SET SEC NOT READY    @ZA07205 76527237
         L     RUCB,DEBUCBAD+4(,DEBREG) GET SEC UCB ADDR       @ZA07205 76529237
         BAL   RTRNREG,DEVREDY         GO SET SCU READY        @ZA07205 76531237
TRACIT   EQU   *                                               @ZA01360 76536402
         LR    RUCB,RWRK1              RESTORE UCB ADDRESS     @ZA01360 76536502
         BAL   TRACRET,TRACE           GO TRACE START I/O        Y02072 76536602
*                                                                       76543302
*                                                                       76550002
*********************************************************************** 76570002
*   THE FOLLOWING CODE RESTORES REGISTERS AND RETURNS TO EXCP.          76590002
*********************************************************************** 76610002
*                                                                       76630002
EXCPEXT2 EQU   *                                                 Y02072 76650002
         L     RTRNREG,KRESAV+OFFREG14  RESTORE RETURN ADDRESS   Y02072 76670002
*                                                                       76690002
EXCPEXIT EQU   *                                                 Y02072 76710002
         MODESET EXTKEY=SUPR           RETURN TO KEY 0           Y02072 76730002
         ST    RTRNREG,KRESAV+OFFREG14  UPDATE EXCP RETURN ADDR  Y02072 76750002
         LM    R0,R15,KRESAV           RESTORE EXCP'S REGISTERS  Y02072 76753037
         BR    RTRNREG                 RETURN TO EXCP            Y02072 76773037
*                                                                       76810002
EXCPEXT3 EQU   *                                                 Y02072 76812002
         TM    DCBAPPIN,UEX            WAS SCU CE DELAYED?       Y02072 76814002
         BZ    EXCPEXT1                YES RETURN TO EXCP        Y02072 76816002
         NI    DCBAPPIN,X'FF'-UEX      TURN OFF FLAG             Y02072 76818002
         L     IOBREG,DCBIOBAD         POINT TO PCU IOB        @ZA05562 76818437
         LA    IOBREG,IOBLN+EIGHT(,IOBREG) POINT TO SCU IOB    @ZA05562 76819237
         B     WHPCU010                NO - GO HANDLE            Y02072 76820002
EXCPEXT1 EQU   *                                                 Y02072 76830002
         L     RTRNREG,KRESAV+OFFREG14  RESTORE RETURN ADDRESS   Y02072 76850002
         LA    RTRNREG,4(,RTRNREG)     INCR TO SECND EXCP RTN PT Y02072 76870002
         B     EXCPEXIT                GO RETURN TO EXCP         Y02072 76890002
         EJECT                                                          76910002
*                                                                       76930002
TRACE    EQU   *                                                  41426 76950002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 76970002
         L     TTPTR,DCBIOBAD      POINTER TO PCU IOB            41426  77020002
         LA    TTPTR,TRCEDSP-IOBLN(TTPTR) INCREMENT POINTER TO @ZA00738 77030002
*                                       TRACETABLE               41426  77040002
         TM    DCBMRIND,DCBMRSCU   DOES DCB POINTTO SCU IOB    @ZA00738 77042002
         BNZ   SCUPTR              YES DONT INCREASE POINTER   @ZA00738 77044002
         LA    TTPTR,IOBLN(,TTPTR) INCR PAST SCU IOB           @ZA00738 77046002
SCUPTR   EQU   *                                               @ZA00738 77048002
         USING TRACETBL,TTPTR                                  @ZA07621 77048637
         LR    GR8,TTPTR           SAVE POINTER TO START OF TT @ZA07621 77049337
         SR    WORKA,WORKA             ZERO REGISTER              41426 77050002
         IC    WORKA,0(TTPTR)          LOAD INDEX VALUE           41426 77070002
         SRA   WORKA,ONE               ALIGN AS MULIIPLE OF 8     41426 77090002
         LA    TTPTR,TABLE(WORKA,TTPTR)  POSITION POINTER,NEXT    41426 77110002
*                                      ENTRY                      41426 77130002
         CLI   WHAT,PCIENTRY           TEST ENTRY SWITCH          41426 77150037
         BNE   NOTPCI                                             41426 77170037
         MVC   TRCMD,RQEPRT              STORE PROT KEY IN TABL@ZA07621 77190037
         MVC   TRCSW,IOBCSW                STORE CSW IN THE TBL@ZA07621 77210037
         B     ADD                                                41426 77230002
*                                                                       77250002
NOTPCI   CLI   WHAT,SIOENTRY           TEST ENTRY SWITCH          41426 77270002
         BNE   NOTSIO                                             41426 77290002
         L     WORKB,IOBSTART          GET POINTER TO FIRST CCW  Y02072 77310002
         MVC   TRCMD,0(WORKB)          STORE COMMAND CODE      @ZA07621 77330037
         MVC   TRUCB,KRESAV+29         STORE UCB ADDRESS       @ZA14595 77340037
         MVC   INITMICB-TRACETBL(3,GR8),DCBWTOIA  APPEND CMICB @ZA07621 77350037
         MVC   INITBUFF-TRACETBL(3,GR8),DCBIOBA+1 USERS CMICB  @ZA07621 77360037
         B     ADD                                                41426 77370037
*                                                                       77380037
NOTSIO   MVC   TRCSW,IOBCSW            STORE CSW FROM IOB TO TB@ZA07621 77390037
         MVC   TRSNS,IOBSENS0          STORE SENSE BYTE 0 IN TB@ZA07621 77400037
*                                                                       77410037
ADD      EQU   *                                               @ZA07621 77420037
         MVC   TRMRIND,DCBMRIND  TRACE MICR INDICATORS         @ZA07621 77430037
         MVC   TRDCB0,DCBWTOID+1 TRACE CURRENT MICB ADDRESS    @ZA07621 77440037
         MVC   TRAPPIN,DCBAPPIN  TRACE APPENDAGE INDICATOR     @ZA07621 77450037
         MVC   TRMRFG,DCBMRFG    TRACE MICR FLAG               @ZA07621 77460037
         MVC   TRWHICH,WHICH     TRACE WHICH APPENDAGE IS IN   @ZA07621 77470037
         MVC   TRCKAREA,CHECKARE TRACE CHECK AREA              @ZA07621 77480037
         LA    WORKA,SIXTEEN(WORKA)    INCREMENT INDEX BY ONE  @ZA07621 77490037
         SLA   WORKA,ONE               SHIFT OUT HIGH ORDER       41426 77500037
*                                      UNWANTED BIT               41426 77510037
         STC   WORKA,0(GR8)         STORE NEW INDEX VALUE      @ZA07621 77520037
         L     WORKA,KRESAV+28         REPLACE UCB POINTER IN     41426 77590002
*                                      REGISTER                   41426 77610002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 77630002
         MVI   WHAT,ZERO               RESET SWITCH              Y02072 77650002
         MODESET KEYADDR=RQEPRT,WORKREG=9  CHANGE TO USER'S KEY  Y02072 77670002
TRACEND  BR    TRACRET                 GO TO IN LINE CODE         41426 77690002
         EJECT                                                          77710002
*********************************************************************** 78600002
*   THE FOLLOWING SUBROUTINE IS USED TO POST THE ECB.  INPUT TO THIS    78700002
*   ROUTINE IS AS FOLLOWS:                                              78800002
*                                                                       78900002
*        REGISTER 1  - RQE ADDRESS                                      79000002
*        REGISTER 3  - DEB ADDRESS                                      79100002
*        REGISTER 5  - ADDRESS OF MICB CONTAINING ECB TO BE POSTED      79200002
*        REGISTER 10 - COMPLETION CODE TO BE POSTED IN THE ECB          79300002
*        REGISTER 14 - RETURN ADDRESS TO MAIN LINE CODE                 79400002
*                                                                       79500002
*   FOLLOWING ARE THE REGISTERS PASED TO THE POST ROUTINE:              79600002
*                                                                       79700002
*        REGISTER 10 - COMPLETION CODE TO BE POSTED IN THE ECB          79800002
*        REGISTER 11 - ECB TO BE POSTED                                 79900002
*        REGISTER 12 - TCB ADDRESS                                      80000002
*        REGISTER 14 - RETURN ADDRESS TO THIS SUBROUTINE                80100002
*        REGISTER 15 - ENTRY ADDRESS TO POST                            80200002
*                                                                       80300002
*   REGISTERS 12 AND 14 ARE RESTORED PRIOR TO RETURNING TO MAIN LINE    80400002
*   CODE.                                                               80500002
*********************************************************************** 80600002
*                                                                       80700002
POSTRTN  EQU   *                                                 Y02072 80800002
         LA    ECBADR,MICBECB(,RMICB)  GET ADDR OF ECB TO POST   Y02072 80900002
         OI    0(ECBADR),ZERO          PROG CHK IF NOT USER CORE Y02072 81000002
         L     R15,CVTPTR              GET ADDRESS OF THE CVT    Y02072 81100002
         L     R15,CVT0PT01-CVT(,R15)  GET ADDR OF POST ROUTINE  Y02072 81200002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 81300002
         ST    RTRNREG,RTRNSAVE        SAVE RETURN ADDRESS       Y02072 81400002
         DROP  BA12                    DROP MODULE BASE REGISTER Y02072 81500002
         L     BA12,DEBTCBAD(,DEBREG)  GET TCB ADDRESS           Y02072 81600002
         BALR  RTRNREG,R15             GO TO POST ECB            Y02072 81700002
         MODESET KEYADDR=RQEPRT,WORKREG=15  CHANGE TO USER'S KEY Y02072 81800002
         BALR  BA12,0                  TEMP BASE REG LOCATION    Y02072 81900002
         USING *,BA12                  EST SUBROUTINE BASE REG   Y02072 82000002
         L     BA12,KRESAV+OFFREG12    RESTORE MODULE BASE REG   Y02072 82100002
         DROP  BA12                    DROP SUBROUTINE BASE REG  Y02072 82200002
         USING PCIAPEN,BA12            RE-ESTABLISH MODULE BASE  Y02072 82300002
         L     RTRNREG,RTRNSAVE        RESTORE RETURN ADDRESS    Y02072 82400002
         BR    RTRNREG                 RETURN TO MAINLINE CODE   Y02072 82500002
         EJECT                                                          82600002
*********************************************************************** 82700002
*   THE FOLLOWING SUBROUTINE IS USED TO SET A DEVICE TO NOT READY.      82800002
*   INPUT TO THIS ROUTINE IS AS FOLLOWS:                                82900002
*                                                                       83000002
*        REGISTER 7  - UCB ADDRESS OF DEVICE TO BE MADE NOT READY       83100002
*        REGISTER 13 - EXCP SAVE AREA ADDRESS                           83200002
*********************************************************************** 83300002
*                                                                       83400002
DEVNREDY EQU   *                       SET DEVICE TO NOT READY   Y02072 83500002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0           Y02072 83600002
         IOSGEN UCBFLG,UCB=(RUCB),VAR=ON,TABLE=UCBNRY,REG=COND   Y02072 83800037
         MODESET KEYADDR=RQEPRT,WORKREG=9  RETURN TO USER'S KEY  Y02072 83900002
         BR    RTRNREG                 RETURN TO CALLER          Y02072 84000002
NRDYTST  EQU   *                                               @ZA01360 84050002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0         @ZA01360 84060002
         IOSGEN UCBFLG,UCB=(RUCB),VAR=TEST,TABLE=UCBNRY        @ZA01360 84070002
         MODESET KEYADDR=RQEPRT,WORKREG=9  RETURN TO USER KEY  @ZA01360 84080002
         BR    RTRNREG                 RETURN TO CALLER        @ZA01360 84090002
DEVREDY  EQU   *                                               @ZA01360 84092002
         MODESET EXTKEY=SUPR           CHANGE TO KEY 0         @ZA01360 84094002
         IOSGEN UCBFLG,UCB=(RUCB),VAR=OFF,TABLE=UCBNRY         @ZA04948 84096037
         MODESET KEYADDR=RQEPRT,WORKREG=9  RETURN TO USER KEY  @ZA01360 84098002
         BR    RTRNREG                 RETURN TO CALLER        @ZA01360 84098402
         EJECT                                                          84100002
*********************************************************************** 84200002
*   EQUATES FOR BRANCH TABLE AT BEGINNING OF THIS MODULE                84300002
*********************************************************************** 84400002
*                                                                       84500002
CHANDIS  EQU   CEAPEN-CHANEND                                           84600002
ABNDIS   EQU   AEAPEN-ABNEND                                            84700002
SIODIS   EQU   SIOTRAC-SIOENTER                                   41426 84900002
*                                                                       88924002
*                                                                       88926002
*********************************************************************** 88928002
*   THE FOLLOWING ARE CONSTANTS AND WORKAREAS USED BY THE APPENDAGES    88980002
*********************************************************************** 88982002
*                                                                       89040000
         DS    0D                      FOR ALIGNMENT                    89160002
*                                                                       89820000
CSAV     DC    F'0'                    SAVE AREA FOR CMICB              89880000
RTRNSAVE DC    F'0'                    POST RETRN ADDR SAVE AREA Y02072 89884002
KRESAV   DS    16F                     FOR SAVING SUPVS REGISTERS       89940002
*                                                                       90000000
KCODCON  DC    0F'0',X'7F000000'       SUCCESSFUL COMPLETION CDE Y02072 90060002
KPCUER   DC    0F'0',X'41000000'       ERROR COMPLETION CODE     Y02072 90062002
KSCUER   DC    0F'0',X'41000001'       SCU ERROR COMPLETION CODE Y02072 90064002
*                                                                       90180000
FORTY8   DC    F'48'                   CONSTANT OF 48                   90182002
ZEROS    DC    H'0'                    CONSTANT OF ZERO        @ZA04944 90182537
K24      DC    H'24'                   CONSTANT OF 24          @ZA03940 90183037
DUMSENS  DC    X'10FE'                 DUMMY SENSE FROM IOS    @ZA11089 90183537
KEIGHT   DC    H'8'                    CONSTANT OF 8                    90184002
KNINE    DC    H'9'                    CONSTANT NINE                    90186002
KTEN     DC    H'10'                   CONSTANT OF 10                   90188002
KELEVN   DC    H'11'                   CONSTANT 11                      90190002
H32CON   DC    H'32'                   TO DECREMENT BUFF COUNTER        90192002
*                                                                       90194002
CLR      XC    0(0,GR5),0(GR5)         EXECUTED FOR ZEROING BUFFERS     90196002
*                                                                       90198002
WHAT     DC    X'00'                   CODE, TYPE ENTRY FROM IOS  41426 90210002
WHICH    DC    X'00'                   INDICATES WHICH APPENDAGE        90240002
CHECKARE DC    X'00'                   FOR ISOLATING SITUATION          90300000
*                                      IS EXECUTING AT ANY GIVEN TIME   90360002
ZERSAV   DC    X'00'                   FOR SAVING BUFFER STATUS         91260000
SVC13    DC    X'0A0D'                 USED TO CHECK FOR SVC 13  Y02072 91262002
*                                                                       91264002
MODID    DC    C'IGG019V5'             MODULE NAME             @ZA07621 91284037
DATE     DC    CL8'&SYSDATE'           COMPILATION DATE        @ZA07621 91293037
FIX      DC    C'OZ33842'              LATEST FIX              @ZA11089 91302037
PATCH    DC    XL((*-IGG019V5)/20)'0'  5% PATCH AREA           @ZA14706 91311037
         EJECT                                                          91323302
*********************************************************************** 91324002
*   CONTROL BLOCK DEFINITIONS                                           91380002
*********************************************************************** 91382002
*                                                                       91384002
**       TRACE TABLE DSECT                                     @ZA07621 91384137
*                                                              @ZA07621 91384237
TRACETBL DSECT                                                 @ZA07621 91384337
*TRACE TABLE HEADER CONTAINS INDEX TO CURRENT ENTRY AND THE    @ZA07621 91384437
* CONTENTS OF DCB PLUS 0 AND PLUS 44 AT SIO TIME               @ZA07621 91384537
TRINDEX  DS    0BL4              FOUR BITS FOR INDEX TO CURR   @ZA07621 91384637
         DS    CL1                                             @ZA07621 91384737
INITMICB DS    CL3               CONTENTS OF DCB +0 FOR SIO    @ZA07621 91384837
         DS    CL1                                             @ZA07621 91384937
INITBUFF DS    CL3               CONTENTS OF DCB +44 FOR SIO   @ZA07621 91385037
*                                                              @ZA07621 91385137
         ORG   TRACETBL                                        @ZA07621 91385237
* THE FOLLOWING ARE THE SIXTEEN BYTE ENTRIES FOR EACH OF THE   @ZA07621 91385337
*  APPENDAGES                                                  @ZA07621 91385437
*                                                              @ZA07621 91385537
TRCMD    DS    0CL1              COMMAND CODE FOR SIO TRACE    @ZA07621 91385637
TRSNS    DS    CL1           SENSE BYTE ZERO FOR ABNORMAL END  @ZA07621 91385737
TRCSW    DS    0CL7          CSW FOR PCI ABEND AND CHAN END    @ZA07621 91385837
         DS    CL4                                             @ZA07621 91385937
TRUCB    DS    CL3               UCB ADDR OF DEV BEING STARTED @ZA07621 91386037
TRMRIND  DS    CL1               DCBMRIND                      @ZA07621 91386137
TRDCB0   DS    0CL3              CURR CONTENTS OF DCB PLUS 0   @ZA07621 91386237
TRCMICB  DS    CL3               CURENT MICB                   @ZA07621 91386337
TRAPPIN  DS    CL1               DCB APPENDAGE INDICATOR       @ZA07621 91386437
TRDCB44  DS    0CL3              CURR CONTENTS OF DCBPLUS 44   @ZA07621 91386537
TRMRFG   DS    CL1               DCB MICR FLAG                 @ZA07621 91386637
TRWHICH  DS    CL1               WHICH APPENDAGE IS IN CONTROL @ZA07621 91386737
TRCKAREA DS    CL1               BUFFER STATUS INDICATOR       @ZA07621 91386837
*                                                              @ZA07621 91386937
*                                                              @ZA07621 91387037
*                                                              @ZA07621 91387137
         IEZBITS                                                 Y02072 91387237
         IHAASVT                                                 Y02072 91387437
         EJECT                                                          91387637
         CVT   DSECT=YES                                         Y02072 91388802
         SPACE 3                                                        91390002
         DCBD  DSORG=BS,DEVD=MR                                         91440000
         EJECT                                                          91500002
         IEZIOB                                                  Y02072 91620002
         EJECT                                                          91622002
         IECDIOCM                                                Y02072 91624002
         EJECT                                                          91626002
         IECDIOSB                                                Y02072 91628002
         EJECT                                                          93182002
         IECDRQE                                                 Y02072 93192002
         EJECT                                                          93192402
         IHASRB                                                  Y02072 93192802
         EJECT                                                          93194002
UCB      DSECT                                                   Y02072 93200002
         IEFUCBOB                                                Y02072 93202002
         END                                                            93240037
