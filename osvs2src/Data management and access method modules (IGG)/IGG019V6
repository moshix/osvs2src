 TITLE 'IGG019V6-REAL ADDRESS SPACE PCI,CH.END,AB.END APPENDAGE'        00050002
IGG019V6 CSECT                                                          00100002
*********************************************************************** 00102002
*                                                                       00110002
* MODULE NAME-IGG019V6                                                  00150002
*                                                                       00160002
* DESCRIPTIVE NAME-REAL ADDRESS SPACE PCI, CHANNEL END, ABNORMAL        00200002
*   END APPENDAGE                                                       00250002
*                                                                       00260002
* COPYRIGHT-NONE                                                        00270002
*                                                                       00300002
* CHANGE ACTIVITY-AS FOLLOWS                                            00350002
*                                                                       00400002
*          RELEASE 21 DELETIONS                                       * 02100002
*                                                                M0477  02150002
*                                                                A42907 02200002
*          VS2 RELEASE 02 DELETIONS                                     02250002
*                                                                Y02072 02300002
* 210500,273500,319500,352500,419000,429000,437000               YM4635 02400002
*                                                                YM5355 02400102
*                                                                YM5998 02400202
*                                                                YM6583 02400302
*                                                                YM1002 02400402
*          VS1 RELEASE 03 DELETIONS                                     02400637
*                                                               XA02374 02400837
*          VS2 POST RELEASE 3 CHANGES                                   02401037
*A092600-092900,161100-161200,163100-163400                    @ZA00971 02401237
*A19751002-19758002                                            @ZA02259 02450037
*A210100-210200,273100,273200,319100-319200,418600-418700      @ZA11106 02490037
*428600-428700.437000-437200,437800                            @ZA11106 02510037
*A205510,205520,C275200                                        @ZA11126 02530037
*C245500                                                       @ZA11654 02550037
*A245510-245520                                                @ZA11654 02570037
*C292500                                                       @ZA08874 02580037
*A343500-343860                                                @ZA08874 02590037
*C390000                                                       @ZA17184 02600037
*A208600-208800                                                @ZA18996 02603037
*D263500-265000,266000                                         @ZA18996 02606037
*D44250002                                                     @ZA27785 02610037
*C284500,285000                                                @ZA26933 02620037
*A284600-284800,287600-287700                                  @ZA26933 02630037
*C287700                                                       @ZA33346 02640037
* MODULE TYPE- APPENDAGE USED BY BSAM/QSAM FOR PCI REQUIREMENTS.        02650002
*                                                                       02700002
* FUNCTION-TO HANDLE THE MANIPULATION OF ICB'S UNDER THREE TYPES OF     02750002
*          INTERRUPTS  1)PCI-TYPE INTERRUPT   2)CHANNEL-END INTERRUPT   02800002
*          AND  3)ABNORMAL-END INTERRUPT                                02850002
*                                                                       02900002
*          PCI ENTRY-ALL  FINISHED ICBS ARE POSTED COMPLETE. THE        02950002
*                    BLOCK COUNT UPDATED IF USING TAPE. THE MAINIOB     03000002
*                    POINTERS ARE UPDATED TO SHOW NEW ICB CHAIN'S       03050002
*                    STATUS. IF AN ICB IS BEING WAITED ON, A BRANCH     03100002
*                    ENTRY TO IOS'S 'POST' ROUTINE IS MADE TO SATISFY   03150002
*                    'WAIT'.                                            03200002
*                                                                       03250002
*          CHANNEL END ENTRY- IN ADDITION TO POSTING AND UPDATING       03300002
*                    FUNCTIONS EXACTLY AS IN PCI ENTRY, A CHECK IS      03350002
*                    MADE TO SEE IF AN ERROR HAS BEEN PREVIOUSLY        03400002
*                    PROCESSED. A CHAIN OF ICB'S MAY THEN BE RESTARTED  03450002
*                    IF THE 'START CHAIN' INDICATOR IS ON.              03500002
*                                                                       03550002
*          ABNORMAL END ENTRY- THE POSTING AND UPDATING FUNCTIONS       03600002
*                    ARE ALSO PERFORMED AS IN PCI UNTIL THE ICB IN      03650002
*                    ERROR IS FOUND. IF THIS IS FIRST ENTRY FOR THE     03700002
*                    ERROR, THE ICB IS ISOLATED FROM ANY CHAINED        03750002
*                    ICBS AND GIVEN BACK TO IOS TO RECOVER.(IF ANY      03800002
*                    ICBS ARE CHAINED ON, THE 'START CHAIN' INDICATOR   03850002
*                    IS SET ON SO THAT CHAIN MAY BE RESTARTED IF        03900002
*                    ERROR IS CORRECTED OR PROCESSING IS TO CONTINUE.)  03950002
*                    IF ERROR  HAS BEEN PROCESSED BEFORE THE ICB,       04000002
*                    AND MAINIOB ARE POSTED IN ERROR.                   04050002
*                                                                       04100002
*                                                                       04150002
* ENTRY POINT-IGG019V6 IN APPENDAGE VECTOR TABLE FOR PCI .              04200002
*             IGG019V6+4 IN APPENDAGE VECTOR TABLE FOR BOTH THE         04250002
*               ABNORMAL END APPENDAGE AND CHANNEL APPENDAGE.           04300002
*                                                                       04350002
* INPUT-REGISTERS SET UP BY IOS                                         04400002
*        1) RQE = 1      RQE ADDRESS                                    04410002
*        2) RIOB = 2     IOB(IOS) POINTER                               04450002
*        3) DCBR = 4     DCB  POINTER.                                  04500002
*        4) RSAVE = 13   PTR TO 16 FULL WORDS REGISTERS SAVEAREA Y02072 04550002
*        5) RETR = 14    RETURN ADDRESS                                 04650002
*        6) BASR = 15    BASE REG FOR THIS MODULE.                      04700002
*                                                                       04850002
*                                                                       04900002
*          FIELDS REFERENCED IN DCB                                     04950002
*        1) DCBBLKCT     TAPE BLOCK COUNT UPDATED                       05000002
*        2) DCBDEVT      CHECK FOR TAPE OR DIRECT ACCESS                05050002
*        3) DCBIFLG      CHANGE TO PERMIT OR PREVENT IOS ERROR RECOVERY 05100002
*        4) DCBIOBAD     FIRST BYTE CONTAINS NOP OFFSET FOR ICB         05150002
*                                                                       05200002
*          BITS, FIELDS AND FLAGS                                       05250002
*        1) BLOCK COUNT INCREMENT IS IN 1ST 2 BYTES OF 'DCBAD' IN ICB.  05300002
*        2) ECB IN MAINIOB AND ICB                                      05350002
*          A)WAIT BIT(10000000=X'80')                                   05400002
*          B)COMPLETE BIT(01000000=X'40')                               05450002
*        3) BYTE 1 OF '1ST ICB' IN MAINIOB                              05500002
*          A)ERRPPROC(ERROR PREVIOUSLY PROCESSED)=X'04'                 05550002
*          B)STRTCHAN(RESTART CHAIN OF ICBS) =X'02'                     05600002
*          C) PCIENTRY=X'01'  APPENDAGE WAS ENTERED DUE TO A PCI.       05650002
*        4) DCBDEVT                                                     05700002
*          A)TAPE = X'80'                                               05750002
*        5) CSW IN MAINIOB                                              05800002
*          A)CHEND(00001000) CHANNEL END.........BYTE 1                 05850002
*          B)UNITEXC(00000001) UNIT EXCEPTION....BYTE 1                 05900002
*          C)UNITCHEK(00000010) UNIT CHECK.......BYTE 1                 05950002
*          D)RONGSIZE(01000000) INCORRECT LENGTH.BYTE 2                 06000002
*          E)ERRORS(00110001) FOR CHAINING CHECK,                       06050002
*                                  PROGRAMCHECK,                        06100002
*                          OR PROTECTION CHECK...BYTE 2                 06150002
*        6)  BYTE 30, BIT 0 IN THE ICB IS A 'SPECIAL VOLUME FULL' BIT.  06200037
*            IT IS SET WHEN THE REFLECTIVE SPOT IS ENCOUNTERED ON       06240037
*            ON A WRITE WITH A WRITE ERROR.  WHEN ERROR PROCESSING      06280037
*            IS FINISHED, AN END OF TAPE CONDITION IS TO BE HANDLED.    06320037
*                                                                       06400002
* ATTRIBUTES-REENTRANT,RESUABLE,ENABLED,HOLD LOCAL LOCK,         Y02072 06450002
*            GENERALLY RUNS IN KEY IN WHICH EXCP WAS ISSUED.            06500002
*                                                                       06550002
* NOTES-SEE BELOW                                                Y02072 06560002
*   PATCH LABEL-PATCH A DC STATEMENT                                    06610002
*   THIS MODULE IS THE SAME COPY AS IGGR19CU                            06620002
*   THE REASONS FOR CREATING A NEW MODULE FOR THE V=R USERS ARE:        06622002
*    1.) THE MODULE WILL RESIDE IN SVCLIB (WHEREAS THE MODULE FOR       06624002
*        V=V USERS RESIDES IN LPALIB)                                   06626002
*    2.) THE V=R MODULE OPERATES IN A DIFFERENT ENVIRONMENT. WHEN       06628002
*        A PCI INTERRUPT IS RECEIVED WITHOUT CHANNEL END, THE PCI       06630002
*        APPENDAGE IS ENTERED FROM THE DIE. THIS ENVIRONMENT DIFFERS    06632002
*        FROM THE CHANNEL END APPENDAGE ENVIRONMENT IN 2 SIGNIFICANT    06634002
*        WAYS:                                                          06636002
*         A.) IT IS DISABLED (CE IS ENABLED)                            06638002
*         B.) IT DOES NOT HOLD THE LOCAL LOCK (CE HAS LOCAL LOCK)       06638402
*                                                                       06640002
*        3)    THE CHANNEL PROGRAMS IN THE ICBS ARE CHAINED TOGETHER BY 06642002
*              THE EOB ROUTINES AND UNCHAINED BY IGG019V6.              06644002
*                                                                       06648002
*        4)    FOR DIRECT ACCESS THE MAIN IOB HAS A CHANNEL PROGRAM     06650002
*              IN IT TO ALLOW FOR A COMMON SEARCH.  IOBSTART POINTS     06652002
*              TO THE FIRST CCW IN THE CHANNEL PROGRAM AND THE LAST     06654002
*              CCW IS A TIC TO THE CHANNEL PROGRAM OF THE FIRST ICB     06656002
*              ON THE CHAIN.  FOR NON DIRECT ACCESS THERE IS NO         06658002
*              CHANNEL PROGRAM IN THE MAIN IOB AND IOBSTART POINTS      06660002
*              TO THE CHANNEL PROGRAM IN THE FIRST ICB ON THE CHAIN.    06662002
*                                                                       06664002
*        5)    EACH ICB'S CHANNEL PROGRAM ENDS IN ONE OF THE FOLLOWING  06666002
*              WAYS:                                                    06668002
*                                                                       06670002
*              NON-RPS WHEN NOT CHAINED.                                06672002
*              |  NOP   | NXT CCW STR | ******************|             06674002
*              |__________________________________________|             06676002
*                                                                       06678002
*              NON-RPS WHEN CHAINED.                                    06680002
*              |  TIC   | NXT CCW STR | ******************|             06682002
*              |__________________________________________|             06684002
*                                                                       06686002
*              RPS WHEN NOT CHAINED.                                    06688002
*              | NOPTIC | ADR RDSCT   | NXT CCW STR       |             06690002
*              |__________________________________________|             06692002
*              | RDSCT  | SECTOR ADDR | 00   00   00   01 |             06694002
*              |__________________________________________|             06696002
*                                                                       06698002
*              RPS WHEN CHAINED.                                        06700002
*              |  TIC   | NXT CCW STR | NXT CCW STR       |             06702002
*              |__________________________________________|             06704002
*              | RDSCT  | SECTOR ADDR | 00   00   00   01 |             06706002
*              |__________________________________________|             06708002
*                                                                       06710002
*              A NOPTIC COMMAND IS A X'88'.  THE HARDWARE DECODES IT    06712002
*              THE SAME AS AN ORDINARY TIC.  BITS 0 - 3 ARE IGNORED     06714002
*              BY THE HARDWARE BUT ARE USED BY THE SOFTWARE TO IND-     06716002
*              ICATE THAT THIS IS THE LAST CHANNEL PROGRAM IN THE       06718002
*              CHAIN (AS A NOP IS FOR NON-RPS). THE NOPTIC IS WHAT      06720002
*              IOBCNOPA POINTS TO FOR AN RPS CHANNEL PROGRAM.           06722002
*                                                                       06724002
*              TO ADD OR REMOVE A NON-RPS SEGMENT ALL THAT IS           06726002
*              NEEDED IS TO CHANGE THE OPCODE FROM A NOP TO A TIC OR    06728002
*              FROM A TIC TO A NOP.                                     06730002
*              TO REMOVE AN RPS SEGMENT THE TIC IS CHANGED TO A         06732002
*              NOPTIC AND THE ADDRESS IS CHANGED TO THAT OF THE         06734002
*              READ SECTOR COMMAND FOLLOWING.  TO ADD A SEGMENT         06736002
*              THE NOPTIC IS CHANGED TO A NORMAL TIC AND THE ADDRESS    06738002
*              IN THE SECOND WORD IS MOVED TO THE FIRST WORD.           06740002
         EJECT                                                          06742002
*                                                                       06744002
*        6)    IOBCNOPA IS USED FOR SERIALIZATION BETWEEN THE EOB       06746002
*              ROUTINES AND IGG019V6. PRIOR TO VS2 RELEASE 2 THE        06748002
*              ECB WAS USED FOR THIS SERIALIZATION, HOWEVER SINCE       06750002
*              MP SUPPORT WAS ADDED AND THE APPENDAGES RUN ENABLED,     06752002
*              IT WAS NO LONGER SUFFICIENT.  THE HIGH ORDER BIT OF      06754002
*              IOBCNOPA MEANS THAT IF THE EOB ROUTINES ADD ANOTHER      06756002
*              SEGMENT THEY MUST ISSUE AN EXCP SINCE IGG019V6 HAS       06758002
*              TERMINATED THE LAST SEGMENT.  IF THE BIT IS A 0 THEN     06760002
*              EITHER 19V6 WILL RE-EXCP OR THE SEGMENT IS STILL         06762002
*              ACTIVE.  19V6 ONLY TURNS ON THE BIT IT NEVER CHANGES     06764002
*              THE ADDRESS.  THE EOB ROUTINES CHANGE THE ADDRESS        06766002
*              AND WHEN THEY ISSUE AN EXCP TURN OFF THE BIT.            06768002
*              A CS INSTRUCTION IS USED BY BOTH CU AND THE EOB          06770002
*              ROUTINES TO PREVENT INTERACTION IN AN MP ENVIRONMENT.    06772002
*              THIS SUPPORT WAS ADDED WITH PTM YM6583.                  06774002
*                                                                       06776002
*   PATCH LABEL-PATCH A DC STATEMENT                                    06778002
*                                                                       06780002
*********************************************************************** 06782002
         EJECT                                                          06784002
         USING RQE,RRQE                 RQE REGISTER             Y02072 06786002
         USING IHADCB,DCBR                                              06800002
         USING *,BASR                                                   06850002
         SPACE 2                                                        06900002
R0       EQU   0                                                        06950002
RRQE     EQU   1                        RQE REGISTER             Y02072 06960002
RIOB     EQU   2                        IOB POINTER                     07000002
RWRK4    EQU   3                        WORK REG                 Y02072 07012002
DCBR     EQU   4                        POINTER TO DCB                  07020002
R5       EQU   5                                                        07030002
RWRK6    EQU   5                        WORK REG                 Y02072 07040002
R6       EQU   6                                                        07050002
R7       EQU   7                                                        07100002
R8       EQU   8                                                        07150002
RINSERT  EQU   9                        INSERT CHARACTER REG            07160002
RWRK7    EQU   9                        WORK REG                 Y02072 07170002
R10      EQU   10                                                       07200002
RWRK1    EQU   10                                                       07210002
RWRK2    EQU   11                                                       07220002
RWRK3    EQU   12                                                       07230002
R12      EQU   12                       REG 12,FOR LM INST       Y02072 07232002
RSAVE    EQU   13                       PTR TO REG SAVEAREA      Y02072 07242002
RETR     EQU   14                       RETURN REGISTER                 07244002
BASR     EQU   15                       BASE REGISTER FOR THIS CSECT    07246002
R15      EQU   15                       REG 15,FOR STM/LM INST   Y02072 07248002
         SPACE 2                                                        07248402
FIRSTICB EQU   8                                                        07250002
CPSTART  EQU   24                                                       07300002
ZERO     EQU   X'00'                                                    07350002
INCREMNT EQU   28                                                       07400002
ECBPTR   EQU   12                                                       07450002
DABIT    EQU   X'20'                                                    07700002
NOP      EQU   X'03'                                                    08450002
EIGHT    EQU   8                        DECREMENT OF 8            M6373 08900002
UCSLOAD  EQU   X'FB'                    UCS LOAD COMMAND          M6373 08950002
SKIP0    EQU   X'83'                    SKIP TO CHANNEL 0 COMMAND M6373 09000002
FOLD     EQU   X'43'                    FOLD COMMAND              M6373 09050002
ERR1     EQU   X'02'                    ERR MASK FOR STAT1        M6373 09100002
ERR2     EQU   X'7F'                    ERROR MASK FOR STAT 2     M6373 09150002
RETRY    EQU   X'80'                    TEST FOR ERROR RETRY      M6373 09200002
CMNDRTRY EQU   X'80'                    TEST IF ERROR RETRYABLE   M6373 09250002
*  IF IOS WAS UNABLE TO GET SENSE BYTES AFTER TEN TRIES FOLLOWING       09260037
*  A UNIT CHECK ON ANY DEVICE, IOS SIMULATES SENSE BYTES BY SETTING     09270037
*  X'10FE'.                                                             09280037
SENSFAIL EQU   X'FE'                SIMULATED SENSE IN IONSENS1@ZA00971 09290037
RTRYOFF  EQU   X'7F'                    TURN OFF RETRY            M6373 09300002
SKIPFLAG EQU   X'40'                    INDICATE SKIP TO 0        M6373 09350002
SKIPOFF  EQU   X'3F'                    TURNS OFF RETRY AND SKIP  M6373 09400002
*                                        FLGS                     M6373 09450002
TAPE     EQU   X'80'                    TAPE INDICATOR IN DCBDEVT=X'80' 09500002
NULL     EQU   X'00'                                             S20202 09600002
SETSC    EQU   X'23'                    SET SECTOR CCW CMND      20201  09750002
READSC   EQU   X'22'                    READ SECTOR CCW CMND     YM5355 09800002
TICNOP   EQU   X'88'                    RCD READY NOP TIC CMND   20201  09850002
SKIP     EQU   4                        SKIP OFFSET        IOS RETURN   10000002
EXCP     EQU   8                        EXCP OFFSET        IOS RETURN   10050002
MIOBCHP  EQU   56                       MIOB OFFSET TO CHP       20201  10300002
*                                                                       10350002
* DISPLACEMENTS AS EQUATES                                              10400002
*                                                                       10450002
D0       EQU   0                        DISPLACEMENT OF 0        20201  10500002
D5       EQU   5                        DISPLACEMENT OF 5        20201  10600002
D4       EQU   4                        DISPLACEMENT OF 4        20201  10650002
D8       EQU   8                        DISPLACEMENT OF 8        20201  10700002
* BYTE COUNTS AS EQUATES                                                10750002
B3       EQU   3                        BYTE COUNT OF 3          20201  10850002
D25      EQU   25                       DISPLACEMENT OF 25       20201  10900002
D81      EQU   81                       RR LAST TIC MIOB OFFSET  20201  10950002
*                                                                       11050002
PCIBYTE  EQU   28                                                       11100002
RONGSIZE EQU   X'40'                    CHECKS CSW...INCORRECT LENGTH   11350002
CHEND    EQU   X'08'                     *    *     CHANNEL END         11400002
UNITEXC  EQU   X'01'                     *    *     UNIT EXCEPTION      11450002
UNITCHEK EQU   X'02'                     *    *     UNIT CHECK          11500002
ERRORS   EQU   X'3F'                     * PROGRAM, PROTECTION, XA02374 11550002
* CHANNEL DATA, CHANNEL CONTROL, INTERFACE CONTROL AND CHAINING CHECKS  11600002
*                                                                       11650002
* NOTE:    USE ERRORS  MASK  WITH BYTE 2 OF 2ND                         11700002
*          HALF OF CSW--- UNITCHEK, CHEND, AND                          11750002
*          UNITEXC ARE MASKS FOR BYTE 1 OF STATUS FIELD.                11800002
*                                                                       11850002
CC       EQU   X'40'                    CHAIN COMMAND FLAG              12000002
OUTNOP   EQU   X'03'                                                    12200002
INNOP    EQU   X'02'                                                    12250002
SAVE13   EQU   52                       OFFSET TO REG 13 IN SA   Y02072 12350002
SAVE14   EQU   56                       OFFSET TO REG 14 IN SA   Y02072 12400002
SAVE15   EQU   60                       OFFSET TO REG 15 IN SA   Y02072 12450002
VCKECB   EQU   X'00'                    VALIDITY CHECK ECB MASK  Y02072 12650002
ENTRAGAN EQU   X'20'                    SECOND TIME ENTERED IND SA61524 12660002
         EJECT                                                          12700002
         USING IOBSTDRD,RIOB                                            12800002
*                                                                       12850002
*  PCI ENTRY                                                            12900002
*                                                                       12950002
         OI    PCIBYTE(RIOB),IOBPCI                                     13000002
*                                                                       13100002
* CHANNEL END OR ABNORMAL END ENTRY POINT.                              13150002
*                                                                       13200002
         DROP  BASR                                                     13250002
         BALR  BASR,R0                  FORCE BASE REG TO * +2          13300002
         USING *,BASR                   BASE REGISTER            Y02072 13350002
         SPACE                                                          13400002
         B     BEGIN                    BR AROUND CONSTANTS      Y02072 13402002
         DC    C'IGG019V6'              MODULE NAME              Y02072 13410002
         DC    C' ZA33346'              LAST SHIP CODE         @ZA18996 13420037
         DC    C'&SYSDATE'              LAST DATE MODIFIED     @ZA18996 13430037
BEGIN    DC    0H'0'                                             Y02072 13440037
         SPACE                                                          13442002
         TM    IOBFLAG1,IOBSPSVC        SVC MODULE ISSUED EXCP   Y02072 13450002
         BOR   RETR                     YES, NORMAL RETURN TO    Y02072 13550002
*                                        EXCP                    Y02072 13600002
         STM   R0,R15,0(RSAVE)          SAVE ALL REGISTERS       Y02072 13700002
         SPACE                                                          13750002
*    CHANGE THE KEY TO THAT SPECIFIED IN RQE                     Y02072 13800002
         MODESET KEYADDR=RQEPRT,WORKREG=10  ISSUE MODESET        Y02072 13850002
         SPACE                                                          13900002
         LA    RWRK1,IOBSTDRD-IOBPREFX  LENGTH OF PREFIX                13950002
         SR    RIOB,RWRK1               GET ADDRESS OF IOB PREFIX       14000002
         USING IOBPREFX,RIOB                                            14050002
         L     RWRK1,IOBCSW-1           GET COMMAND ADDRESS -  @ZA11126 14060037
         LA    RWRK1,NULL(RWRK1)        CLEAR THE HI BYTE   -  @ZA11126 14066037
         LTR   RWRK1,RWRK1              IS THE CSW ZERO ??     @ZA11126 14072037
         BNZ   TEST3211                 NO  BRANCH             @ZA11126 14078037
* IF A CSW OF ZERO IS PRESENT-THE FIRST ICB WILL BE POSTED WITH@ZA11126 14084037
* A PERMENANT ERROR SINCE IT IS IMPOSSIBLE TO DETERMINE THE    @ZA11126 14090037
* SOURCE OF THE INTERRUPT                                      @ZA11126 14096037
         SR    R5,R5                    CLEAR REGISTER         @ZA11126 14102037
         L     RWRK2,IOBCICB            GET ADDR OF 1ST ICB    @ZA11126 14108037
         LA    RWRK2,NULL(RWRK2)        CLEAR HIGH ORDER BYTE  @ZA11126 14114037
         B     PCIN5                                           @ZA11126 14120037
TEST3211 EQU   *                                               @ZA11126 14126037
         CLI   DCBDEVT,DCBDVPR3         TEST FOR 3211          @ZA11126 14132037
         BNE   NPATH                    NO DON'T NEED RETRY       M6373 14150002
*                                                                       14200002
*  IF THE DEVICE IS A 3211 THE FOLLOWING CODE SCHEDULES THE             14250002
*  ASYNCHRONOUS ROUTINE IGG019FS WHEN ERROR RECOVERY IS POSSIBLE        14300002
*                                                                       14350002
         LA    RWRK2,EIGHT              GET DECREMENT             M6373 14500002
         SR    RWRK1,RWRK2              POINT AT COMMAND          M6373 14550002
         CLI   NULL(RWRK1),UCSLOAD      UCS LOAD COMMAND          M6373 14600002
         BE    NRETIOS                  YES RETURN TO IOS         M6373 14650002
         CLI   NULL(RWRK1),SKIP0        SKIP TO CHANNEL 0 COMMAND M6373 14700002
         BE    NRET                     YES RETURN TO IOS         M6373 14750002
         CLI   NULL(RWRK1),FOLD         FOLD COMMAND              M6373 14800002
         BE    NRETIOS                  YES RETURN TO IOS         M6373 14850002
         TM    IOBCSW+3,ERR1            TEST FOR UNIT CHECK       M6373 14950002
         BNZ   SEEIF2                   YES SEE IF 2ND ENTRY      M6373 15000002
         TM    IOBCSW+4,ERR2            TEST FOR ANY OTHER ERRORS M6373 15050002
         BNZ   SEEIF2                   YES SEE IF 2ND ENTRY      M6373 15100002
         TM    IOBRFLAG,RETRY           DID WE JUST RETRY               15150002
         BZ    NPATH                    NO TAKE NORNAL PATH       M6373 15200002
*                                                                       15250002
* A RETRY HAS BEEN SUCCESSFULLY ISSUED. THE NORMAL PATH IS TAKEN.       15300002
*                                                                       15350002
         NI    IOBRFLAG,RTRYOFF         TURN OFF RETRY FLAG             15400002
         B     NPATH                    TAKE NORMAL PATH          M6373 15450002
*                                                                       15500002
NRET     NI    IOBRFLAG,SKIPOFF         TURN SKIP FLAG OFF              15550002
NRETIOS  EQU   *                                                        15600002
         MODESET EXTKEY=ZERO            RESTORE THE IOS KEY      Y02072 15650002
         LM    R0,R15,0(RSAVE)          RESTORE THE REGISTERS    Y02072 15700002
         BR    RETR                     RETURN TO IOS             M6373 15750002
*                                                                       15800002
SEEIF2   TM    IOBECBCC,ENTRAGAN        SECOND TIME ENTERED     SA61524 15850002
         BZ    YES2                     YES BRANCH                M6373 15900002
*                                                                       15950002
         TM    IOBRFLAG,RETRY           DID WE JUST DO RETRY?           16000002
         BNZ   NPATH                    YES, TAKE NORMAL PATH     M6373 16100002
         CLI   IOBSENS1,SENSFAIL        SEE IF BAD SENSE BYTES @ZA00971 16110037
         BNE   NPATH                    BR IF SIMULATED SENSE  @ZA00971 16120037
         TM    IOBSENS1,CMNDRTRY        IS COMMAND RETRYABLE      M6373 16150037
         BZ    NPATH                    NO,  GET OUT              M6373 16200002
         B     NRETIOS                  GO GET OUT                M6373 16250002
*                                                                       16300002
YES2     EQU   *                       ERPS HAVE JUST GIVEN UP @ZA00971 16310037
         CLI   IOBSENS1,SENSFAIL       SEE IF SENSE BYTES VALID@ZA00971 16320037
         BE    NPATH                   BR IF BAD SENSE BYTES   @ZA00971 16340037
         TM    IOBSENS1,CMNDRTRY        IS COMMAND RETRYABLE    SA61524 16350037
         BO    CANBE                    YES                       M6373 16400002
         NI    IOBRFLAG,RTRYOFF         TURN OFF RETRY FLAG             16450002
         B     NPATH                    TAKE NORMAL PATH          M6373 16500002
*                                                                       16550002
CANBE    TM    IOBRFLAG,RETRY           JUST DO RETRY                   16600002
         BZ    GORETRY                  NO SET UP TO DO IT        M6373 16650002
*                                                                       16700002
         NI    IOBRFLAG,RTRYOFF         TURN OFF RETRY FLAG             16750002
         OI    IOBRFLAG,SKIPFLAG        INDICATE SKIP TO 0              16800002
         BAL   RWRK6,SCHEDIT            SCHEDULE ASYNCH RTN       M6373 16850002
         B     NPATH                                              M6373 16900002
*                                                                       16950002
GORETRY  OI    IOBRFLAG,RETRY           TURN ON RETRY FLAG              17000002
         BAL   RWRK6,SCHEDIT            SCHEDULE IGG019FS         M6373 17050002
         MODESET EXTKEY=ZERO            RESTORE THE IOS KEY      Y02072 17100002
         LM    R0,R15,0(RSAVE)          RESTORE REGS             Y02072 17150002
         B     12(RETR)                 RETURN TO IOS; KEEP RQE; DON'T  17200002
*                                       POST                      M6373 17250002
SCHEDIT  EQU   *                                                        17300002
         LR    RWRK7,RSAVE              SAVE THE SAVE AREA PTR   Y02072 17350002
         L     BASR,CVTPTR                                        M6373 17400002
         L     BASR,4(BASR)             GET ADDR EXIT EFFECTOR    M6373 17450002
         SPACE 2                                                        17500002
*********************************************************************** 17550002
*    CHANGE THE KEY BACK TO IOS KEY BEFORE BRANCH TO EXIT EFFECTOR      17600002
*********************************************************************** 17650002
         SPACE                                                          17700002
         MODESET EXTKEY=ZERO            RESTORE THE IOS KEY      Y02072 17750002
         SPACE                                                          17800002
         BALR  RETR,BASR                PUT IQE OF LIST           M6373 17850002
         SPACE                                                          17900002
         LM    RSAVE,BASR,SAVE13(RWRK7) RESTORE THE REGS         Y02072 17950002
*********************************************************************** 18000002
*    CHANGE THE KEY TO THAT SPECIFIED IN RQE                            18050002
*********************************************************************** 18100002
         SPACE                                                          18150002
         MODESET KEYADDR=RQEPRT,WORKREG=10   ISSUE MODESET       Y02072 18200002
         SPACE                                                          18250002
         BR    RWRK6                    RETURN TO CALLER          M6373 18300002
         EJECT                                                          18302002
*********************************************************************** 18304002
*        FIRST THE ICB IN WHICH THE INTERUPT OCCURRED MUST BE FOUND.  * 18306002
*        THIS IS ACCOMPLISHED BY COMPARING THE ADDRESS IN THE IOBCSW  * 18308002
*        TO THE BEGINNING AND ENDING ADDRESSES OF THE ICBS.  THE MAIN * 18310002
*        IOB AND THE ICBS ARE ARRANGED IN CORE AS FOLLOWS.            * 18312002
*                                                                     * 18314002
*        ________________________________________________________     * 18316002
*        |                                                      |     * 18318002
*        |           MAIN IOB                                   |     * 18320002
*        | - - - - - - - - - - - - - - - - - - - - - - - - - - -|     * 18322002
*        |       MAIN IOB CCWS  (DIRECT ACCESS ONLY)            |     * 18324002
*        |______________________________________________________|     * 18326002
*        |                                                      |     * 18328002
*        |           FIRST ICB                                  |     * 18330002
*        | - - - - - - - - - - - - - - - - - - - - - - - - - - -|     * 18332002
*        |       FIRST ICB CCWS                                 |     * 18334002
*        |______________________________________________________|     * 18336002
*        |                                                      |     * 18338002
*        |           SECOND ICB                                 |     * 18340002
*        | - - - - - - - - - - - - - - - - - - - - - - - - - - -|     * 18342002
*        |       SECOND ICB CCWS                                |     * 18344002
*        |______________________________________________________|     * 18346002
*        ////////////////////////////////////////////////////////     * 18348002
*        ________________________________________________________     * 18348402
*        |                                                      |     * 18348802
*        |           LAST ICB                                   |     * 18349202
*        | - - - - - - - - - - - - - - - - - - - - - - - - - - -|     * 18349602
*        |       LAST ICB CCWS                                  |     * 18349702
*        |______________________________________________________|     * 18349802
*                                                                     * 18349902
*        IF THE CSW ADDRESS IS LESS THAN THE ICB BEGINNING ADDRESS    * 18351902
*        THEN THIS CANNOT BE THE ICB THAT THE INTERUPT OCCURED ON.    * 18352302
*        IF THE CSW ADDRESS IS GREATER THEN THE ICB BEGINNING         * 18352702
*        ADDRESS IT IS THEN COMPARED TO THE ENDING ADDRESS. IF IT     * 18353102
*        IS ALSO LESS THEN THE ENDING ADDRESS THEN THIS IS THE ICB    * 18353502
*        THAT HAD THE INTERUPT.  EACH ICB BEFORE THE INTERUPT IS      * 18353602
*        HANDLED AS SUCCESSFUL.  THE IOBCICB POINTER IS UPDATED AND   * 18353702
*        THE ICB CCWS ARE REMOVED FROM THE CHAIN. THE ICBECB IS ALSO  * 18353802
*        POSTED AS COMPLETE WITH NO ERRORS.  WHEN THE ICB IN WHICH    * 18355802
*        THE INTERUPT OCCURRED IS FOUND IT IS HANDLED AT PCIN5.       * 18356202
*                                                                     * 18356602
*********************************************************************** 18357002
NPATH    EQU   *                                                  M6373 18357802
         TM    0(RIOB),IOBBKSPC         WAS LAST I/O OPER A      A32514 18400002
*                                        POINT?                  A32514 18450002
         BO    NRETIOS                  YES, RETURN TO IOS       Y02072 18500002
NOTPOINT EQU   *                        POINT NOT LAST IO        A32514 18900002
         L     RWRK1,24(RIOB)           PICK UP CCW AD.FROM CSW         18950002
         LA    RWRK1,0(RWRK1)                                           19000002
         SR    R5,R5                    CLEAR FOR THE NOP OFFSET. 12356 19050002
         L     RWRK2,FIRSTICB(RIOB)     GET ICB ADDR.             12295 19100002
         LA    RWRK2,0(RWRK2)           CLEAR HI BYTE.            12295 19150002
         LA    RINSERT,X'30'(0,RIOB)    GET END OF BASIC MAIN IOB       19200002
         TM    DCBDEVT,DABIT            IS THIS DIRECT ACCESS           19250002
         BZ    AROUND                   NO  GO AROUND                   19300002
         LA    RINSERT,X'30'(RINSERT)   ADD TO COMPENSATE FOR D.A.      19350002
AROUND   EQU   *                                                        19400002
         CR    RWRK1,RINSERT            COMPARE CSW ADDR TO END ADDR    19450002
         BH    OK                       IF GREATER ,OK, GO ON           19500002
         TM    PCIBYTE+16(RIOB),IOBPCI  PCI ENTRY                M4587  19550002
         MVI   PCIBYTE+16(RIOB),X'00'   RESTORE INC FLD TO ZERO         19600002
         BO    EXITNORM                 BRANCH IF PCI ENTRY      M4587  19650002
         LA    RINSERT,X'38'(0,RIOB)                                    19700002
         B     PCIN16             CSW IS IN MAIN IOB OR IOS/ERPS  23228 19750002
* FOR MVS WE MUST DETERMINE IF THE INTERRUPT IS GREATER        @ZA02259 19800037
* THAN THE END OF THE ICB STRING AS THE ERPS CAN INTERRUPT     @ZA02259 19802037
* WITH AN ADDRESS FROM THE HIGH RANGE.                         @ZA02259 19804037
OK       EQU   *                                               @ZA02259 19806037
         SR    R6,R6              ZERO REG 6                   @ZA02259 19808037
         SR    R7,R7              ZERO REG 7                   @ZA02259 19810037
         SR    R8,R8              ZERO REG 8                   @ZA02259 19812037
         IC    R8,DCBBUFNO        PUT BUFFER NUMBER IN REG 8   @ZA02259 19814037
         TM    DCBCIND2,DCBCNQSM  ARE WE RUNNING QSAM ???      @ZA02259 19816037
         BO    *+8                BRANCH FORWARD IF YES        @ZA02259 19818037
         IC    R8,DCBNCP          PUT BSAM NCP IN REG 8        @ZA02259 19820037
         IC    R7,DCBIOBL         PUT IOB LENGTH IN REG 7      @ZA02259 19822037
         SLA   R7,3(0)            MULTIPLY BY 8                @ZA02259 19824037
         MR    R6,R8              GET TOTAL LENGTH             @ZA02259 19826037
         AR    R7,RINSERT         ADD IOB END TO TOTAL         @ZA02259 19828037
         CR    RWRK1,R7           COMPARE TOTAL TO CSW         @ZA02259 19830037
         BH    PCIN16             IT IS HIGH SO THE CSW        @ZA02259 19832037
* SHOWS THE INTERRUPT DID NOT COME FROM THE ICB STRING         @ZA02259 19834037
         OC    0(1,RIOB),PCIBYTE+16(RIOB) MOVE THE FLAG FROM            19850002
*                                       TEMP STORAGE                    19900002
         MVI   PCIBYTE+16(RIOB),X'00'   CLEAR FLAG                      19950002
*                                        LEAVE THIS EXIT.               20000002
         SR    RINSERT,RINSERT                                          20050002
         TM    0(RWRK2),IOBWRITE        IS THIS OUTPUT                  20100002
         BO    OUT001                   YES,BRANCH AROUND               20150002
         TM    DCBCIND1,DCBCNEVA        IS VOLUME FULL BIT ON           20200002
         BNO   OUT001                   NO, BRANCH                23771 20250002
         TM    0(RIOB),IOBPCI           TEST FOR PCI             A32541 20300002
         BO    EXITNORM                 BRANCH IF PCI            A32541 20350002
         OI    28(RIOB),UNITEXC         TURN ON UNIT EXCEPTION    23771 20400002
         B     PCIN8AA                                            23771 20450002
OUT001   EQU   *                                                        20500002
PCIN0    EQU   *                                                        20550002
         CR    RWRK1,RWRK2              COMPARE CSW ADDRESS TO ICB PTR. 20600002
         BH    PCIN1A                   BRANCH IF CSW HIGH        19395 20650002
PCIN1B   EQU   *                                                        20700002
         LR    RWRK1,RWRK2                                              20750002
         BAL   R8,OUTIN                 GO GET NOP                      20800002
         AR    RWRK1,R5                 COMPUTE NOP ADDRESS             20850002
         ST    RWRK1,16(RWRK2)          STORE IN ICB CSW       @ZA18996 20860037
         XC    22(2,RWRK2),22(RWRK2)    ZERO CSW COUNT         @ZA18996 20870037
         MVI   20(RWRK2),CHEND          CHANNEL END TO ICB CSW @ZA18996 20880037
         L     RWRK3,0(RWRK2)           GET NEXT ICB PTR                20900002
         L     RWRK3,CPSTART(RWRK3)     GET CHANNEL PROGRAM START       20950002
*                                        ADDRESS OF NEXT ICB.           21000002
         CLI   IOBCCW,SETSC            IS THIS AN RPS DEVICE?  @ZA11106 21010037
         BNE   NOTRRA                   BRANCH NO              @ZA11106 21020037
         CLI   D8(RWRK1),READSC         NEXT COMND READ SECTOR   YM5355 21050002
         BNE   NOTRRA                   BRANCH NO                20201  21100002
         ST    RWRK3,D4(RWRK1)          PUT ADDR IN RH NOP/TIC   20201  21150002
         LA    RINSERT,D8(RWRK1)        RD SECTOR ADDR           20201  21200002
         ST    RINSERT,D0(RWRK1)        PUT IN CCW               20201  21250002
         MVI   D0(RWRK1),TICNOP         PUT IN TICNOP CMND       20201  21300002
         B     FEATA                    GO AROUND NEXT           20201  21350002
NOTRRA   EQU   *                                                 20201  21400002
         ST    RWRK3,0(RWRK1)           STORE NEXT ICBS C.P.STARTAD     21450002
*                                        IN THIS ICBS  NOP CCW          21500002
         MVI   0(RWRK1),NOP             CHANGE TIC TO NOP               21550002
FEATA    EQU   *                                                 20201  21600002
         LA    RINSERT,8                                                21650002
         SR    RWRK1,RINSERT            GET CCW BEFORE NOP              21700002
         OI    4(RWRK1),CC              TURN ON CC FLAG IN IT           21750002
         LA    RWRK1,8(RWRK1)                                           21800002
         TM    DCBDEVT,TAPE             IS IT TAPE                      21850002
         BZ    PCIN2                    NO, BRANCH AROUND               21900002
         LH    RWRK3,INCREMNT(RWRK2)    PICK UP BLOCK COUNT INCREMENT   21950002
         A     RWRK3,DCBBLKCT           UPDATE BLOCK COUNT              22000002
         ST    RWRK3,DCBBLKCT           AND RETURN IT.                  22050002
PCIN2    EQU   *                                                        22100002
         SR    RETR,RETR                CLEAR 14 SO POST ROUTINE        22150002
*                                        WILL POST  7F                  22200002
         EJECT                                                          22500002
*********************************************************************** 22550002
*                                                                       22600002
*   SET UP TO POST ECB                                                  22650002
*                                                                       22700002
*       REG 10   COMPLETION CODE WITH WHICH TO POST                     22710002
*       REG 11   ADDRESS OF ECB TO BE POST'ED                           22800002
*       REG 13   ADDR OF A 16 FW REGISTERS SAVEAREA TO BE USED BY POST  22900002
*                                                                       23150002
*       TO USE THE POST SUBROUTINE AS A CLOSED SUBROUTINE,              23350002
*       BAL   6,PCIN3+4        AND SET THE CONDITION TO EITHER          23400002
*       X'7F'  OR X'41'  BY USING REG 14 AS AN INDICATOR.               23450002
*       IF REG 14 = 0, POST ECB AS 7F                                   23500002
*       IF REG 14 = NOT ZERO, POST ECB AS 41                            23550002
*                                                                       23600002
*********************************************************************** 23610002
         SPACE                                                          23700002
         LA    R6,PCIN3B                GET ADDRESS TO LEAVE SUBRT      23900002
PCIN3AA  EQU   *                                                        23950002
         LR    RWRK7,RWRK2              SAVE ICB POINTER         Y02072 23960002
         L     RWRK2,ECBPTR(RWRK2)      GET ECB PTR OF ICB              24200002
         LA    RWRK2,0(RWRK2)           CLEAR HI-ORDER BYTE       M0477 24250002
         SPACE                                                          24300002
         USING ECB,RWRK2                ECB REGISTER             Y02072 24350002
         SPACE                                                          24400002
*    VALIDITY CHECK ECB BEFORE BRANCH TO POST SO THAT WHEN THE          24450002
*    KEYS ARE NOT THE SAME IT WILL CAUSE PROGRAM CHECK                  24500002
         L     R10,ECBCC                VALIDITY CHECK ECB     @ZA11654 24550037
CSWP     CS    R10,R10,ECBCC            LOCK ON ECB            @ZA11654 24560037
         BNE   CSWP                     ECB CHANGED BY WAIT    @ZA11654 24570037
         SPACE                                                          24600002
         DROP  RWRK2                                                    24650002
         SPACE                                                          24700002
         L     R10,ECBNORMW             ASSUME ECB OK, LOAD POST YM1002 24750002
*                                        CODE OK WORD            Y02072 24760002
         LTR   RETR,RETR                IS ECB TO BE X'41'              24800002
         BZ    SEVENF                   NO,BRANCH                       24850002
         L     R10,ECBPERRW             LOAD IN ERROR CONDITION  YM1002 24900002
*                                        CODE WORD               Y02072 24950002
         SPACE                                                          24960002
*********************************************************************** 25600002
*    CHANGE THE KEY BACK TO IOS KEY BEFORE BRANCH TO POST               25650002
*********************************************************************** 25700002
         SPACE                                                          25750002
SEVENF   MODESET EXTKEY=ZERO            RESTORE THE IOS KEY      Y02072 25800002
         EJECT                                                          25810002
         PUSH  USING                                                    25820002
         LR    RWRK3,R6                 SAVE SUBROUTINE RET PT   Y02072 25830002
         LM    R0,R8,0(RSAVE)           RESTORE INPUT REGS       Y02072 25840002
         L     RETR,SAVE14(RSAVE)       RESTORE RETURN TO IOS    Y02072 25850002
*                                        ADDRESS                 Y02072 25860002
         PCIPOST ECB=(11),SVAREA=(13),RQE=(1),CODE=(10) POST     Y02072 25870002
         STM   R0,R15,0(RSAVE)          RESTORE REGS IN SAVEAREA Y02072 25880002
*                                        TO INPUT ORDER          Y02072 25890002
         LR    RWRK2,RWRK7              RESTORE ICB PTR          Y02072 25892002
         LR    R6,RWRK3                 RESTORE SUBRTN RETURN PT Y02072 25900002
         LA    RWRK3,IOBSTDRD-IOBPREFX  PREFIX LENGTH            Y02072 25910002
         SR    RIOB,RWRK3               IOB PREFIX               Y02072 25920002
         SR    R5,R5                    CLEAR REGISTER           Y02072 25930002
         POP   USING                                             Y02072 25940002
*    CHANGE THE KEY TO THAT SPECIFIED IN RQE                     Y02072 25950002
         MODESET KEYADDR=RQEPRT,WORKREG=14  ISSUE MODESET        Y02072 26000002
         SPACE                                                          26050002
         BR    R6                       GET OUT OF POST SUBROUTINE      26250002
PCIN3B   EQU   *                                                        26300002
         MVC   9(3,RIOB),1(RWRK2)       MOVE NEXT ICB ADDR.TO M.IOB     26350037
         L     RWRK1,24(RIOB)           PICK UP CCW ADDRESS FROM CSW    26650002
         LA    RWRK1,0(RWRK1)           CLEAR HIGH BYTE                 26700002
         L     RWRK2,0(RWRK2)           PICK UP NEXT ICB ADDR.FOR NEXT  26750002
*                                        TIME THROUGH LOOP              26800002
         LA    RWRK2,0(RWRK2)           CLEAR HIGH BYTE                 26850002
*                                        RWRK1 HAS CSW'S CCW ADDRESS    26900002
         B     PCIN0                                                    26950002
         SPACE 2                                                        27000002
PCIN1A   EQU   *                                                        27050002
*                                       COME HERE IF CSW  ADDRESS       27100002
*                                       IS GREATER THAN OR EQUAL        27150002
*                                       TO ICB POINTER.                 27200002
         BAL   R8,OUTIN                 GO GET NOP OFFSET               27250002
         LA    RWRK3,8(R5,RWRK2)        GET NOP ADDRESS + 8             27300002
         CLI   IOBCCW,SETSC            IS THIS RPS DEVICE?     @ZA11106 27310037
         BNE   NOTRRD                   BRANCH NO              @ZA11106 27320037
         CLI   0(RWRK3),READSC          NEXT CMND READ SECTOR    YM5355 27350002
         BNE   NOTRRD                   BRANCH NO                20201  27400002
         LA    RWRK3,D8(RWRK3)          INCR FOR RD SECTOR       20201  27450002
NOTRRD   EQU   *                                                 20201  27500002
         CR    RWRK1,RWRK3              COMPARE CSW ADDRESS TO ICB+OFFS 27550002
         BH    PCIN1B                   CSW GREATER--BRANCH             27600002
*                                       CSW ADDRESS IS LESS THAN        27700002
*                                       OR EQUAL TO ICB + 8 + NOP OFFS  27750002
         TM    0(RIOB),IOBPCI           WAS THIS PCI ENTRY              27800002
         BO    EXITNORM                 BRANCH IF PCI                   27850002
*                                        FALL THROUGH IF NOT PCI        27900002
         EJECT                                                          27950002
*********************************************************************** 28140037
*        COME HERE IF CHANNEL END FOUND                                 28160037
*********************************************************************** 28180037
PCIN5    MVC   16(6,RWRK2),24(RIOB)     MOVE CSW INTO ICB BECAUSE C.E.  28200037
*                                       WAS FOUND.  RWRK2 HAS ICB ADDR. 28250002
         XC    22(2,RWRK2),22(RWRK2)    ZERO CSW COUNT                  28300002
         MVC   10(2,RWRK2),18(RIOB)     MOVE IN 2 SENSE BYTES           28350002
         TM    30(RWRK2),X'80'          IS SPECIAL VOL FULL BIT ON      28400002
         BZ    PCIN5A                   NO, BRANCH             @ZA26933 28450037
         OI    20(RWRK2),UNITEXC        SET UNIT EXCEPTION IN  @ZA26933 28460037
         OI    28(RIOB),UNITEXC         IOB AND ICB            @ZA26933 28470037
         B     PCIN6A                   PROCESS UNIT EXCEPTION @ZA26933 28480037
PCIN5A   TM    28(RIOB),UNITEXC         TEST FOR UNIT EXCEPTION@ZA26933 28490037
         BNO   PCIN7                    BRANCH IF NOT UNIT EXCEP.       28550002
         TM    DCBDEVT,TAPE             IS THIS TAPE                    28600002
         BNO   NOTAPE3                  NO  GO AROUND                   28650002
         TM    28(RIOB),UNITCHEK        IS THERE A UNIT CHECK           28700002
         BNO   NOTAPE3                  NO  GO AROUND                   28750002
         TM    0(RWRK2),IOBWRITE        IS THIS OUTPUT?        @ZA26933 28760037
         BZ    PCIN7                    NO, BRANCH             @ZA33346 28770037
         OI    30(RWRK2),X'80'          TURN ON SPECIAL VOL FULL BIT    28800002
         B     PCIN7                    GO TO UNIT CHECK HANDLER        28850002
NOTAPE3  EQU   *                                                        28900002
         TM    DCBDEVT,X'40'            IS UNIT RECORD  USED            28950002
         BZ    PCIN6A                   NO BRANCH                       29000002
         TM    0(RWRK2),IOBWRITE        IS THIS OUTPUT                  29050002
         BNO   PCIN6A                   NO, BRANCH                26016 29100002
         SH    RWRK1,CON8               POINT TO COMMAND CODE     26016 29150002
         TM    0(RWRK1),X'03'           SPACE ONLY COMMAND        26016 29200002
         BO    RESTWRT                  YES, BRANCH            @ZA08874 29250037
         B     PCIN7                                              26016 29300002
PCIN6A   EQU   *                                                        29350002
*                                       UNIT EXCEPTION FOUND OR         29400002
*                                       ERROR WAS PROCESSED ALREADY     29450002
         NI    30(RWRK2),X'7F'          TURN OFF ''SPECIAL VOL FULL''   29500002
         NI    0(RIOB),255-IOBABAPP     TURN OFF ERROR INDICATOR        29550002
         MVC   FIRSTICB+1(3,RIOB),1(RWRK2) MOVE LINK FLD TO MAINIOB     29600002
         MVI   4(RIOB),ECBPERR          SET IOB COMPLETE IN ERROR       29650002
         LA    RETR,ECBPERR             SET FLAG TO REFLECT CC=41       30000002
         BAL   R6,PCIN3AA               GO TO POSTING SUBROUTINE        30050002
         TM    DCBDEVT,DABIT            TEST FOR DIRECT ACCESS          30150002
         BO    PCIN6C                   YES IT IS- BRANCH               30200002
         L     RWRK3,0(RWRK2)           GET NEXT ICB                    30300002
         MVC   33(3,RIOB),25(RWRK3)     MOVE CHANNEL PROG START ADDRESS 30350002
*                                       FROM ICB TO MAINIOB             30400002
         TM    DCBDEVT,TAPE             IS TAPE BEING USED              30450002
         BZ    NOTAPE1                  NO BRANCH                       30500002
         TM    0(RWRK2),IOBWRITE        IS THIS OUTPUT            17438 30550002
         BO    UPDATE                   YES, UPDATE BLK CNT       17438 30600002
         TM    28(RIOB),UNITEXC         IS THIS UNIT EXCEPTION          30650002
         BO    NOTAPE1                  YES,DON'T UPDATE BLOCK COUNT    30700002
UPDATE   LH    RWRK3,28(RWRK2)          UPDATE THE BLOCK          17438 30750002
         A     RWRK3,DCBBLKCT           COUNT IN THE DCB USING          30800002
         ST    RWRK3,DCBBLKCT           INCREMENT IN DCB PTR IN ICB     30850002
NOTAPE1  EQU   *                                                        30900002
         B     PCIN6D                                                   30950002
PCIN6C   EQU   *                                                        31000002
         L     RWRK3,0(RWRK2)           GET NEXT ICB                    31050002
         MVC   48(8,RIOB),32(RWRK3)     MOVE NEXT ICB'S FDAD TO MAINIOB 31100002
         CLI   MIOBCHP(RIOB),SETSC      RCD READY CHP            20201  31150002
         BNE   PCIN6CX                  BRANCH IF NO             20201  31200002
         MVC   D81(B3,RIOB),D25(RWRK3)  MOVE CHP START TO TIC    20201  31250002
*                                       MIOB                     20201  31300002
         B     PCIN6CY                  BRANCH AROUND            20201  31350002
PCIN6CX  EQU   *                                                 20201  31400002
         MVC   73(3,RIOB),25(RWRK3)     MOVE CHANNEL PROGRAM START      31450002
*                                        ADDRESS FROM ICB TO FINAL TIC  31500002
*                                        OF MAINIOB                     31550002
PCIN6CY  EQU   *                                                 20201  31600002
PCIN6D   EQU   *                                                        31650002
         BAL   R8,OUTIN                 GO GET NOP OFFSET               31700002
         LA    RWRK3,0(R5,RWRK2)        GET NOP ADDRESS OF ERR ICB      31750002
         L     RWRK4,0(RWRK2)           GET NEXT ICB PTR                31800002
         L     RWRK4,24(RWRK4)          GET CHANNEL PRG.START ADDRESS   31850002
*                                        OF NEXT ICB.                   31900002
         CLI   IOBCCW,SETSC            IS THIS AN RPS DEVICE?  @ZA11106 31910037
         BNE   NOTRRH                   BRANCH NO              @ZA11106 31920037
         CLI   D8(RWRK3),READSC         READ SECTOR CMND NEXT    YM5355 31950002
         BNE   NOTRRH                   BRANCH NO                20201  32000002
         ST    RWRK4,D4(RWRK3)          PUT ADDR IN RH OF        20201  32050002
*                                        TIC/NOP                 20201  32100002
         BAL   R7,NOPTIC                GO BUILD NOP/TIC         20201  32150002
         B     FEATH                    GO AROUND NEXT INSTS     20201  32200002
NOTRRH   EQU   *                                                 20201  32250002
         ST    RWRK4,0(RWRK3)           STORE IN THIS ICBS NOP CCW      32300002
         MVI   0(RWRK3),NOP             MOVE IN A NOP                   32350002
FEATH    EQU   *                                                 20201  32400002
         LA    RINSERT,8                                                32450002
         SR    RWRK3,RINSERT            GET CCW BEFORE NOP              32500002
         OI    4(RWRK3),CC              TURN ON CC FLAG IN IT           32550002
         LA    RWRK3,8(RWRK3)                                           32600002
         TM    0(RIOB),IOBPCI           PCI ENTRY                 19524 32650002
         BO    EXITNORM                 YES, BRANCH               19524 32700002
         B     EXITSKIP                                                 32750002
PCIN7    EQU   *                                                        32800002
*                                       TEST FOR ERRORS.                32850002
*                                       PCI AND UNIT EXCEP. NOT FOUND   32900002
         TM    28(RIOB),UNITCHEK        TEST FOR UNITCHECK              32950002
         BO    PCIN8A                   BRANCH ON YES                   33000002
CHAN9    EQU   *                                                        33050002
         TM    29(RIOB),ERRORS          TEST FOR OTHER ERRORS   XA02374 33100002
         BNZ   NOTPRINT                                           19768 33250002
*                                       ERRORS.                         33300002
         TM    29(RIOB),RONGSIZE        TEST FOR INCORRECT LENTH        33350002
         BNO   PCIN10                   NO BRANCH                       33450002
         TM    0(RWRK2),IOBWRITE        IS THIS OUTPUT                  33550002
         BO    PCIN8AA                  YES....IF OUTPUT WRONG LENGTH   33600002
*                                        GO TO PERM ERROR HANDLER       33650002
         B     PCIN9                    BRANCH TO INPUT LENGTH CHECK    33700002
         SPACE 2                                                        33750002
PCIN8A   EQU   *                                                        33800002
*                                       BEGINNING OF ERROR HANDLING     33850002
*                                       SECTION                         33900002
         TM    DCBDEVT,DCBDVPR1         IS THIS A PRINTER ?             33950002
         BNO   NOTPRINT                 NO, GO ARROUND            15065 34000002
         TM    18(RIOB),X'01'           TEST FOR CHANNEL 9        16550 34050002
         BZ    NOTPRINT                 NO, BRANCH                19768 34100002
         TM    18(RIOB),X'F2'           ERRORS WITH CHANNEL 9     19768 34150002
         BNZ   NOTPRINT                 YES, BRANCH               22216 34200002
         SH    RWRK1,CON8               POINT TO COMMAND CODE     22216 34250002
         TM    0(RWRK1),X'03'           SPACE ONLY COMMAND        22216 34300002
         BNO   CHAN9                    NO, BRANCH                22216 34350002
RESTWRT  EQU   *              WHEN THERE IS A CHAN 12 OR A     @ZA08874 34353037
*                             CHAN 9 ON A PRINTER. THE CHAN    @ZA08874 34356037
*                             PROGRAM WILL BE RESTARTED FROM   @ZA08874 34359037
*                             THE WRITE.                       @ZA08874 34362037
         LA    RWRK1,8(RWRK1)           RESET TO THE WRITE CCW @ZA08874 34365037
         ST    RWRK1,IOBSTART           SET IOBSTART TO WRITE  @ZA08874 34368037
         TM    28(RIOB),X'01'           WAS THIS A CHAN 12     @ZA08874 34371037
         BO    RESTWRT6                 YES-GO SET FLAG        @ZA08874 34374037
         OI    DCBIFLGS,DCBIFC9         NO-SET CHAN 9          @ZA08874 34377037
         B     MOREXIT                  RE-EXCP                @ZA08874 34380037
RESTWRT6 OI    DCBIFLGS,DCBIFC12        SET CHANNEL 12         @ZA08874 34383037
         B     MOREXIT                  RE-EXCP                @ZA08874 34386037
NOTPRINT EQU   *                                                        34400002
         TM    0(RIOB),IOBABAPP         TEST  ERROR PREVIOUSLY PROCESST 34450002
*                                        BIT TO SEE IF THIS IS 2ND PASS 34500002
         BZ    PCIN8B                   NO-FIRST TIME, BRANCH           34550002
PCIN8AA  EQU   *                                                        34600002
         MVC   22(2,RWRK2),30(RIOB)     MOVE IN COUNT RESIDUE           34650002
         NI    0(RIOB),255-IOBABAPP     YES,TURN IT OFF                 34700002
         B     PCIN6A                   AND GO TO PERM ERROR SECTION    34750002
PCIN8B   EQU        *                                                   34800002
*                                       ERROR HAS NOT BEEN              34850002
*                                       PROCESSED BEFORE                34900002
         BAL   R8,OUTIN                 GO GET NOP OFFSET               34950002
         LA    RWRK3,0(R5,RWRK2)        GET NOP ADDRESS                 35000002
         L     RWRK4,0(RWRK2)           GET NEXT ICB POINTER            35050002
         L     RWRK4,24(RWRK4)          GET C P STARTAD OF NEXT ICB     35100002
         TM    0(RWRK3),NOP             IS IT A NOP NOW                 35150002
         BO    PCIN8C                   YES BRANCH                      35200002
         CLI   D8(RWRK3),READSC         READ SECTOR CMND NEXT    YM5355 35250002
         BNE   PCIN8B1                  BRANCH NO                20201  35300002
         ST    RWRK4,D4(RWRK3)          PUT IN RH OF NOP/TIC     20201  35350002
         TM    D0(RWRK3),TICNOP         NOP TIC                  20201  35400002
         BO    PCIN8C2                  BRANCH YES               20201  35450002
         BAL   R7,NOPTIC                GO BUILD NOP/TIC         20201  35500002
         OI    0(RIOB),IOBRSTCH         TURN ON RESTART CHAIN    20201  35550002
*                                        BIT                     20201  35600002
         B     PCIN8C2                  GO AROUND NEXT           20201  35650002
PCIN8B1  EQU   *                                                 20201  35700002
         OI    0(RIOB),IOBRSTCH         TURN ON RESTART CHAIN    20201  35750002
*                                        BIT                     20201  35800002
PCIN8C   EQU   *                                                        35850002
         ST    RWRK4,D0(RWRK3)          PUT ADDR IN NOP          20201  35900002
         MVI   D0(RWRK3),NOP            RESTORE NOP CMND         20201  35950002
PCIN8C2  EQU   *                                                 20201  36000002
*                                       TO PREVENT TIC-ING ON TO AN ICB 36050002
*                                       DURING ERROR RECOVERY, TURN OFF 36100002
*                                       THE CHAIN COMMAND FLAG IN THE   36150002
*                                       CCW JUST BEFORE THE NOP/TIC.    36200002
         LA    RINSERT,8                                                36250002
         SR    RWRK3,RINSERT            GET CCW BEFORE NOP/TIC          36300002
         NI    4(RWRK3),255-CC          TURN OFF CC FLAG IN CCW         36350002
         TM    DCBDEVT,DABIT            TEST FOR DIRECT ACCESS          36400002
         BO    PCIN8D                   YES, BRANCH                     36450002
         MVC   33(3,RIOB),25(RWRK2)     MOVE CHANNEL PROGRAM START ADDR 36500002
*                                        FROM ICB TO MAINIOB            36550002
         B     PCIN8E                                                   36600002
PCIN8D   EQU   *                                                        36650002
         CLI   MIOBCHP(RIOB),SETSC      RCD READ CHP             20201  36700002
         BNE   PCIN8DX                  BRANCH IF NO             20201  36750002
         MVC   D81(B3,RIOB),D25(RWRK2)  MOVE CHP ADDR TO TIC     20201  36800002
*                                       MIOB                     20201  36850002
         B     PCIN8DZ                  BRANCH AROUND NORM MOVE  20201  36900002
PCIN8DX  EQU   *                                                 20201  36950002
         MVC   73(3,RIOB),25(RWRK2)     MOVE CHANNEL PROG START ADDRESS 37000002
*                                        TO FINAL TIC OF MAINIOB        37050002
PCIN8DZ  EQU   *                                                 20201  37100002
         MVC   48(8,RIOB),32(RWRK2)     MOVE MBB--R TO MAINIOB          37150002
PCIN8E   EQU   *                                                        37200002
*                                        ALLOW IOS ERROR RECOVERY       37250002
         OI    0(RIOB),IOBABAPP         TURN ON THE 'ERROR PREVIOUSLY   37300002
*                                        PROCESSED' INDICATOR           37350002
         B     EXITNORM                                                 37400002
PCIN9    EQU   *                                                        37450002
*                                       COME HERE IF WRONG LENGTH       37500002
*                                       INDICATOR IS ON                 37550002
*                                                                       37600002
*                                       A VALID TRUNCATED RECORD HAS A  37650002
*                                       LENGTH WHICH IS A MULTIPLE OF   37700002
*                                       LOGICAL RECORD LENGTH.          37750002
         SR    R6,R6                    CLEAR EVEN REG                  37800002
         LH    R7,30(RIOB)              PUT CSW COUNT RESIDUE IN ODD    37850002
*                                        REG OF EVEN/ODD PAIR           37900002
         LH    RINSERT,DCBLRECL         GET LOGICAL RECORD LENGTH AS    37950002
*                                        DIVISOR                        38000002
         DR    R6,RINSERT               DIVIDE COUNT RESIDUE BY LRECL   38050002
*                                       AFTER THE DIVISION, THE 32 BIT  38100002
*                                       SIGNED REMAINDER IS IN EVEN     38150002
*                                       REG.  (R0) AND THE 32 BIT       38200002
*                                       QUOTIENT IS IN ODD REG(1)       38250002
*                                                                       38300002
*                                       IF A TOO LARGE RECORD IS READ,  38350002
*                                       THE CSW COUNT RESIDUE WILL BE   38400002
*                                       ZERO AND THE INCORRECT LENGTH   38450002
*                                       BIT WILL BE ON.                 38500002
*                                                                       38550002
*                                       IF THE REMAINDER IS GREATER     38600002
*                                       THAN ZERO, IT IS AN INVALID     38650002
*                                       RECORD.                         38700002
*                                       IF THE QUOTIENT IS ZERO,        38750002
*                                       THE DIVIDEND WAS ZERO AND       38800002
*                                       THE RECORD IS WRONG LENGTH.     38850002
*                                                                       38900002
         LTR   R6,R6                    TEST REMAINDER                  38950002
         BP    PCIN8AA                  BRANCH IF REMAINDER    @ZA17184 39000037
*                                        GREATER THAN ZERO.             39050002
         LTR   R7,R7                    TEST QUOTIENT                   39100002
         BZ    PCIN6A                   BRANCH IF QUOTIENT IS ZERO      39150002
         TM    DCBRECFM,DCBRECSB        IS THIS DATASET STANDARD F      39200002
         BZ    PCIN15                   NO BRANCH                       39250002
*                                        STANDARD F INPUT FOUND         39300002
         L     RWRK3,0(RWRK2)           GET NEXT ICB                    39350002
         OI    20(RWRK3),UNITEXC        TURN ON UNIT EXCEPTION          39400002
         OI    20(RWRK3),CHEND          TURN ON CE                      39450002
         OI    DCBCIND1,DCBCNEVA        TURN ON VOL FULL BIT            39500002
         B     PCIN15                                                   39550002
PCIN10   EQU   *                                                        39600002
         L     RWRK3,0(RWRK2)           GET PTR TO NEXT ICB             39650002
         TM    DCBDEVT,X'20'            IS IT DIRECT ACCESS ?           39700002
         BO    PCIN11                   YES, BRANCH                     39750002
         MVC   32(4,RIOB),24(RWRK3)     MOVE CH.P.START ADDR FROM       39800002
*                                        ICB TO THE MAINIOB             39850002
         TM    DCBDEVT,TAPE             IS TAPE BEING USED              39950002
         BZ    NOTAPE2                  NO BRANCH                       40000002
         LH    RWRK3,28(RWRK2)          UPDATE THE BLOCK                40050002
         A     RWRK3,DCBBLKCT           COUNT IN THE DCB USING          40100002
         ST    RWRK3,DCBBLKCT           INCREMENT IN DCB PTR IN ICB     40150002
NOTAPE2  EQU   *                                                        40200002
         B     PCIN12                                                   40250002
PCIN11   EQU   *                                                        40300002
         MVC   48(8,RIOB),32(RWRK3)     MOVE COUNT TO MAINIOB           40350002
         CLI   MIOBCHP(RIOB),SETSC      IS THIS RCD READY CHP    20201  40400002
         BNE   PCIN11X                  NO BRANCH                20201  40450002
         MVC   D81(B3,RIOB),D25(RWRK3)  MOVE CHP ADDR TO MIOB    20201  40500002
*                                        TIC                     20201  40550002
         B     PCIN11Z                  BRANCH AROUND NORM MOVE  20201  40600002
PCIN11X  EQU   *                                                 20201  40650002
         MVC   73(3,RIOB),25(RWRK3)     MOVE CHANNEL PROG START ADDRESS 40700002
*                                        FROM ICB TO FINAL TIC MAINIOB  40750002
PCIN11Z  EQU   *                                                 20201  40800002
PCIN12   EQU   *                                                        40850002
*                                       THIS SECTION SETS IOB AND       40900002
*                                       ICB COMPLETE WITHOUT ERROR      40950002
         SR    RETR,RETR                SET FLAG TO REFLECT CC=7F       41300002
         BAL   R6,PCIN3AA               GO TO POST SUBROUTINE           41350002
         MVC   9(3,RIOB),1(RWRK2)       GET PTR TO NEXT ICB AND         41500002
         LR    RWRK1,RWRK2              SAVE ICB POINTER                41550002
         L     RWRK2,0(RWRK2)           STORE IN '1ST ICB' OF MAINIOB   41600002
         LR    R6,RWRK2                 SAVE CONTENTS                   41650002
         LR    RWRK2,RWRK1              WORK 2 NEEDED IN SUBRT          41700002
         BAL   R8,OUTIN                                                 41750002
         LR    RWRK2,R6                                                 41800002
         LA    RWRK3,0(R5,RWRK1)        GET NOP ADDRESS                 41850002
         CLI   IOBCCW,SETSC            IS THIS AN RPS DEVICE?  @ZA11106 41860037
         BNE   NOTRRP                   BRANCH NO              @ZA11106 41870037
         CLI   D8(RWRK3),READSC         READ SECTOR CMND NEXT    YM5355 41900002
         BNE   NOTRRP                   BRANCH NO                20201  41950002
         MVC   D5(B3,RWRK3),D25(RWRK2)  IN RH OF NOP             20201  42000002
         B     FEATP                    GO AROUND NEXT           20201  42050002
NOTRRP   EQU   *                                                 20201  42100002
         MVC   1(3,RWRK3),25(RWRK2)     MOVE IN NEXT CP STARTAD  A28707 42150002
FEATP    EQU   *                                                 20201  42200002
         LA    RINSERT,8                                                42250002
         SR    RWRK3,RINSERT            GET CCW BEFORE NOP              42300002
         OI    4(RWRK3),CC              TURN ON CC  FLAG IN IT          42350002
         AR    RWRK3,RINSERT            RESTORE PTR              20201  42400002
         TM    0(RIOB),IOBABAPP         HAS ERROR BEEN PREVIOUSLY PRO-  42450002
*                                       CESSED                          42500002
         BNO   PCIN13                   NO, BRANCH                      42550002
         NI    0(RIOB),255-IOBABAPP     TURN ERROR INDICATOR OFF        42600002
         TM    0(RIOB),IOBRSTCH         IS IT NECESSARY TO RESTART A    42650002
*                                        CHAIN OF ICBS                  42700002
         BO    PCIN14                   YES, BRANCH                     42750002
PCIN13   EQU   *                                                        42800002
         NI    16(RIOB),X'FB'           TURN OFF EXCEPTIONAL COND.13298 42850002
         CLI   IOBCCW,SETSC            IS THIS AN RPS DEVICE?  @ZA11106 42860037
         BNE   NOTRRS                   BRANCH NO              @ZA11106 42870037
         CLI   D8(RWRK3),READSC         READ SECTOR COMND NEXT   YM5355 42900002
         BNE   NOTRRS                   BRANCH NO                20201  42950002
         L     RWRK2,MIOBCHP(RIOB)      GET SECTOR ADDRESS       20201  43000002
         TM    D0(RWRK3),TICNOP         TIC NOP CMND             20201  43100002
         BO    CHCKEXIT                 YES, BRANCH AROUND NEXT  20201  43200002
FEATSX   EQU   *                                                 20201  43250002
         BAL   R7,NOPTIC                GO BUILD NOP/TIC         20201  43300002
         B     FEATW                    BRANCH AROUND NEXT       20201  43350002
NOTRRS   EQU   *                                                 20201  43400002
         TM    0(RWRK3),NOP             IS THE CCW NOW A NOP            43450002
         BO    CHCKEXIT                 YES - BRANCH             M6365  43500002
*                                       IF NOT A NOP, FALL THROUGH      43550002
*                                       AND USE THE EXCP EXIT BELOW     43600002
PCIN14   EQU   *                                                        43650002
         CLI   IOBCCW,SETSC            IS THIS AN RPS DEVICE?  @ZA11106 43700037
         BNE   PCIN14A                  BRANCH NO              @ZA11106 43720037
         CLI   D8(RWRK3),READSC         READ SECTOR CMND NEXT    YM5355 43740037
         BE    FEATSX                   BRANCH IF YES            20201  43760037
PCIN14A  EQU   *                        NOT RECORD READY       @ZA11106 43780037
         MVI   0(RWRK3),NOP             MAKE CCW A NOP                  43800002
FEATW    EQU   *                                                 20201  43850002
         NI    0(RIOB),255-IOBRSTCH     TURN OFF CHAIN INDICATOR        43900002
         NI    16(RIOB),X'FB'           TURN OFF EXP COND         19798 43950002
         B     EXCPEXIT                                                 44000002
PCIN15   EQU   *                                                        44050002
         BAL   R8,OUTIN                 GO GET NOP OFFSET               44100002
         LA    RWRK4,0(R5,RWRK2)        GET NOP                         44150002
         ST    RWRK4,16(RWRK2)          STORE IN CSW                    44200002
         MVC   20(4,RWRK2),28(RIOB)     MOVE 2 STATUS BYTES,COUNT AND   44300002
         MVC   10(2,RWRK2),18(RIOB)     TWO SENSE BYTES  TO ICB         44350002
         MVI   24(RIOB),ZERO            ZERO   FLAG3,                   44400002
         XC    46(2,RIOB),46(RIOB)      ERROR COUNT,                    44500002
         NI    16(RIOB),X'C3'          RESET FLAG1 ERRORS        YM5998 44510002
         NI    17(RIOB),X'30'          RESET FLAG2 ERRORS        YM5998 44520002
         NI    DCBIFLGS,X'3F'           ERROR FLAGS ,                   44550002
         MVI   28(RIOB),X'0C'           AND THE STATUS                  44600002
         MVI   29(RIOB),ZERO            ERROR BITS IN CSW               44650002
         B     PCIN10                                             17891 44700002
PCIN16   EQU   *                                                        44750002
         SR    RINSERT,RINSERT                                          44800002
         TM    0(RIOB),IOBABAPP         IS THIS 2ND ENTRY               44850002
         BC    1,PCIN6A                 YES,GO POST PERMANENT ERROR     44900002
*                                        AND GET OUT.                   44950002
*    IF NOT 2ND ENTRY   SET  UP TO DO ERROR RECOVERY                    45000002
         BAL   R8,OUTIN                 GO GET NOP OFFSET               45050002
         L     RWRK2,8(RIOB)            GET 1ST ICB                     45100002
         LA    RWRK3,0(R5,RWRK2)        GET NOP ADDRESS                 45150002
         LA    RINSERT,8                                                45200002
         SR    RWRK3,RINSERT            GET CCW BEFORE NOP/TIC          45250002
         NI    4(RWRK3),255-CC          AND TURN OFF THE CC FLAG        45300002
         B     PCIN8E                   GO SET SOME FLAGS AND RETURN    45350002
*                                        TO IOS TO ERROR RETRY.         45400002
*                                       *** EXITS  ***                  45450002
CHCKEXIT EQU   *                       SEE IF EOB HAVE ADDED     YM6583 45460002
*                                      ANOTHER ICB               YM6583 45470002
         LR    RWRK2,RWRK3             GET NOP ADDRESS           YM6583 45480002
         O     RWRK3,IOBCEXCP          TURN ON EXCP NEEDED FLAG  YM6583 45490002
         CS    RWRK2,RWRK3,12(RIOB)    TURN ON FLAG              YM6583 45492002
         BE    NORMPOST                SUCCESSFUL - EOB WILL     YM6583 45494002
*                                      EXCP IF ANOTHER ICB IS ADDED     45496002
EXCPEXIT EQU   *                                                        45500002
         L     RWRK1,8(RIOB)            GET FIRST ICB            A28707 45550002
         TM    DCBDEVT,DABIT            DIRECT ACCESS            M3932  45600002
         BO    DAEXIT                   BRANCH IF YES            M3932  45650002
         MVC   33(3,RIOB),25(RWRK1)     MOVE CP STARTAD FROM     M3932  45700002
*                                        ICB TO MAIN IOB                45750002
         B     MOREXIT                                           M3932  45800002
DAEXIT   EQU   *                                                 M3932  45850002
         MVC   48(8,RIOB),32(RWRK1)     MOVE COUNT TO MAIN IOB   A28707 45900002
         CLI   MIOBCHP(RIOB),SETSC      RPS USED                 20201  45950002
         BNE   NOTRPS                   BRANCH NO                20201  46000002
         MVC   D81(B3,RIOB),D25(RWRK1)  UPDATE ADDR FOR RPS CHP  20201  46050002
         B     RPSMOVED                 AROUND NORMAL MOVE       20201  46200002
NOTRPS   EQU   *                                                 20201  46250002
         MVC   73(3,RIOB),25(RWRK1)     MOVE CP STARTAD FROM ICB A28707 46300002
*                                        TO FINAL TIC IN MAINIOB        46350002
RPSMOVED EQU   *                                                 20201  46450002
MOREXIT  EQU   *                                                 M3932  46500002
         MVI   4(RIOB),ZERO             SET MAIN IOB NOT COMPLETE       46550002
         L     RETR,SAVE14(RSAVE)       RESTORE RETURN REG       Y02072 46600002
         LA    RETR,EXCP(RETR)                                          46650002
         B     EXIT                                                     46700002
NORMPOST MVI   4(RIOB),ECBNORM          POST MAIN IOB 7F         A27322 46750002
EXITNORM EQU   *                                                        46800002
         L     RETR,SAVE14(RSAVE)       RESTORE RETURN REG       Y02072 46850002
         B     EXIT                                                     46900002
EXITSKIP EQU   *                                                        46950002
         L     RETR,SAVE14(RSAVE)       RESTORE RETURN REGISTER  Y02072 47000002
         CLI   DCBDEVT,DCBDVPR3         TEST FOR 3211                   47050002
         BNE   EXTSKIP2                 BRANCH IF NOT                   47100002
         TM    IOBRFLAG,SKIPFLAG+RETRY  WAS THE ASYN RTN SCHEDULED ?    47200002
         BZ    EXTSKIP2                 BRANCH IF NO                    47250002
         LA    RETR,12(RETR)            KEEP THE REQUEST ELEMENT        47300002
         B     EXIT                                                     47350002
EXTSKIP2 EQU   *                        DEVICES OTHER THE 3211          47400002
         LA    RETR,SKIP(RETR)          PICK UP SKIP OFFSET             47450002
EXIT     EQU   *                                                        47500002
         NI    0(RIOB),255-IOBPCI       TURN OFF FLAG                   47550002
         MODESET EXTKEY=ZERO            RESTORE THE IOS KEY      Y02072 47600002
         LM    R0,R12,0(RSAVE)          RESTORE THE REG 0-12     Y02072 47650002
         L     R15,SAVE15(RSAVE)        RESTORE REG 15           Y02072 47700002
         BR    RETR                                                     47750002
NOPTIC   EQU   *                                                 20201  47800002
         LA    RINSERT,D8(RWRK3)        GET ADDR OF RD SECTOR    20201  47850002
         ST    RINSERT,D0(RWRK3)        PUT IN CCW               20201  47900002
         MVI   D0(RWRK3),TICNOP         INSERT TIC CMND          20201  47950002
         BR    R7                       RETURN                   20201  48000002
OUTIN    EQU   *                                                        48050002
         IC    R5,OUTNOP(RIOB)          GET OUTPUT NOP                  48100002
         TM    0(RWRK2),IOBWRITE        IS THIS ICB OUTPUT              48150002
         BCR   1,R8                     IF OUTPUT,  RETURN              48200002
         IC    R5,INNOP(RIOB)           GET INPUT NOP                   48250002
         BR    R8                       RETURN                          48300002
         EJECT                                                          48350002
CON8     DC    H'8'                                                     48400002
         DS    0F                                                       48450002
ECBPERRW DC    X'41000000'              CP HAS TERMINATED WITH   Y02072 48500002
*                                        PERMANENT ERROR         Y02072 48550002
ECBNORMW DC    X'7F000000'              CP HAS TERMINATED W/O    Y02072 48600002
*                                        ERROR                   Y02072 48650002
IOBCEXCP DC    X'80000000'             EXCP NEEDED FLAG          YM6583 48660002
         SPACE                                                          48760002
* MODULE PATCH AREA                                                     48770002
         DS    0H                                                       48780002
PATCH    DC    XL((*-IGG019V6)/20)'0'   PATCH AREA               Y02072 48790002
MODLEN   EQU   *-IGG019V6               LENGTH OF MODULE         Y02072 48792002
         EJECT                                                          48800002
         DCBD  DSORG=PS                                                 48850002
         EJECT                                                          48900002
CVT      DSECT                                                          48950002
         CVT                                                            49000002
         EJECT                                                          49050002
         IHAECB                                                  Y02072 49100002
         EJECT                                                          49150002
         IEZIOB                                                         49200002
         ORG   IOBPREFX+1                                               49250002
IOBRFLAG DS    BL1                FLAGS FOR 3211 ERROR RETRY            49300002
         EJECT                                                          49350002
         IECDRQE                                                 Y02072 49400002
         EJECT                                                          49450002
         IHASRB                                                  Y02072 49460002
         EJECT                                                          49470002
         IHAASVT                                                 Y02072 49480002
         EJECT                                                          49490002
         IECDIOSB                                                Y02072 49492002
         END                                                            49500002
