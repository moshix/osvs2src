         TITLE 'IGG0201P-CLOSE EXECUTOR FOR 3505 OMR AND RCE, AND 3525' 00050037
         START                                                          00100037
IGG0201P CSECT                                                          00150037
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 00200037
*                                                       @ZA08168        00250037
* C 152000,159000                                              @ZA03830 00300037
* C 155000                                                     @ZA00861 00350037
* D 321200,344400,368300                                       @YM06152 00400037
* D 210500-220000,443400,204450,189500,413000,415000-416000    @YM06152 00450037
* D 507000-510000                                              @YM05576 00500037
* C 204450                                                     @YM05576 00550037
* C 1682000,1747000,1817000,1867000,1927000,19920000,20520000, @ZA29896 00560037
* C 2112000,2192000                                            @ZA29896 00570037
* A 235500-235850,252000-252350                                @ZA33956 00580037
*                                                                       00600037
*                                                                       00650037
* MODULE NAME= IGG0201P                                                 00700037
*                                                                       00750037
* DESCRIPTIVE NAME= CLOSE EXECUTOR FOR 3525 ASSOCIATED DATA SETS OR     00800037
*                   3505 WITH OMR OR RCE USING BSAM AND QSAM            00850037
*                                                                       00900037
* COPYRIGHT= NONE                                                       00950037
*                                                                       01000037
* STATUS = OS/VS2 REL. 3                                                01050037
*                                                                       01100037
* FUNCTION= THIS IS THE FIRST HALF OF THE CLOSE ROUTINE USED WHEN       01150037
*              OMR OR RCE IS SPECIFIED FOR THE 3505 AND WHEN            01200037
*              CLOSING 3525 ASSOCIATED DATA SETS.                       01250037
*                                                                       01300037
*      OPERATION=    THE FOLLOWING OPERATIONS WILL BE PREFORMED BY      01350037
*                   THIS CLOSE EXECUTOR FOR BSAM/QSAM DATA SETS         01400037
*                   IF INPUT-1 DELETE ALL REQUEST FOR DATA (PURGE)      01450037
*                            2 RESET OMR OR RCE MODE VIA AN UNFLAGED    01500037
*                              FEED COMMAND IF THE DEVICE DID NOT       01550037
*                              PRESENT UNIT EXCEPTION WHICH IN ITSELF   01600037
*                              WOULD RESET THE OMR OR RCE MODE.         01650037
*                            3 ISSUE A FEED COMMAND CAUSING LAST CD TO  01700037
*                              BE FED AND STACKER SELECTED IF CNTRL WAS 01750037
*                              SPECIFIED.                               01800037
*                            NOTE-THIS CARD FEED WILL BE IN ADDITION    01850037
*                                 TO THE FEED REFERENCED ABOVE IN       01900037
*                                 ITEM TWO IF OMR OR RCE WAS            01950037
*                                 SPECIFIED.                            02000037
*                                                                       02050037
*                   IF OUTPUT- BSAM ASSUMES QUIESENCE                   02100037
*                              QSAM WILL TRUNCATE AND FLUSH BUFFERS     02150037
*              FOR FORCE CLOSE, THIS ROUTINE WILL BE ENTERED   @YM06153 02200037
*              FOR QSAM OUTPUT DATA SETS ONLY.  IT WILL        @YM06153 02250037
*              PURGE ANY I/O INITIATED FOR PRIMING             @YM06153 02300037
*              INPUT BUFFERS.                                  @YM06153 02350037
*                                                                       02400037
*              THE 3525 HAS A PRINT STATION BETWEEN THE PUNCH-STATION   02450037
*              AND THE STACKER. THUS, CARD MOVEMENT AT CLOSE PRESENTS   02500037
*              AND UNUSUAL SITUATION. THE FOLLOWING RULES APPLY TO      02550037
*              CARD MOVEMENT WHEN THE 3525 FILE(S) ARE CLOSED.          02600037
*                                                                       02650037
*               FILE TYPE              FEED CAUSED BY CLOSE OF          02700037
*                                                                       02750037
*               READ                   READ                             02800037
*               PUNCH                  PUNCH                            02850037
*               PRINT                  PRINT                            02900037
*               READ/PRINT             READ                             02950037
*               READ/PUNCH/PRINT       READ                             03000037
*               READ/PUNCH             READ                             03050037
*               PUNCH/PRINT            PUNCH                            03100037
*               PUNCH/INTERPRET        PUNCH                            03150037
*                                                                       03200037
*                 NOTE- IF A DELIMITER CARD IS USED IT WILL STAY IN THE 03250037
*                       TRANSPORT UNTIL THE NEXT JOB CAUSES A CARD      03300037
*                       FEED OR AN NPRO IS PREFORMED.                   03350037
*                                                                       03400037
* NOTES=                                                                03450037
*   PATCH-LABEL= ZAPSZAPS                                               03500037
*                                                                       03550037
* MODULE TYPE=                                                          03600037
*   PROCESSOR= ASSEM                                                    03650037
*   ATTRIBUTES= REENTRANT                                               03700037
*                                                                       03750037
* ENTRY POINT= XCTL FROM IGG0201A                                       03800037
*   PURPOSE= TO CLOSE 3525 OR 3505 DATA SETS                            03850037
*   INPUT= SEE DESCRIPTION OF REGISTERS                                 03900037
*                                                                       03950037
* EXIT NORMAL= XCTL TO IGG0201R                                         04000037
*                                                                       04050037
* EXIT ERROR=  XCTL TO IGG0201R                                         04100037
*                                                                       04150037
* EXTERNAL REFERENCES=                                                  04200037
*   ROUTINES= DCBPUT(TO OUTPUT LAST BUFFER)                             04250037
*   DATA AREAS= PSA                                                     04300037
*               0/C/E WORK AREA (IECDSECT)                              04350037
*   CONTROL BLOCKS=                                                     04400037
*                  DCB-U,DEB-M,IOB-M,TCB-U,RB-U                         04450037
*                                                                       04500037
* TABLES= WHERE TO GO TABLE (WTG)                                       04550037
*                                                                       04600037
* MACROS=                                                               04650037
*       DEBCHK,MODESET,GETMAIN,FREEMAIN,XCTL,SYNCH                      04700037
*       WAIT,PURGE,EXCP                                                 04750037
*                                                                       04800037
* CHANGE ACTIVITY= VS/2 REL. 2 - Y02898,YM06152,YM05576                 04850037
*                                                                       04900037
* * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * 04950037
*                                                                       05000037
*        REGISTER USAGE                                                 05050037
*                                                                       05100037
RE       EQU   0                       WORK/PARAMETER REGISTER          05150037
RF       EQU   1                       WORK/PARAMETER REGISTER          05200037
RDCB     EQU   2                       ADDRESS OF USER'S DCB            05250037
RBASE    EQU   3                       BASE REGISTER                    05300037
RCORE    EQU   4                       ADDRESS OF CLOSE WORK AREA       05350037
RPAR     EQU   5                       PARAMETER LIST                   05400037
RWTG     EQU   6                       START OF WTG                     05450037
RPARC    EQU   7                       CURRENT ENTRY IN PARAMETER LIST  05500037
RWTGC    EQU   8                       CURRENT ENTRY IN WTG TABLE       05550037
RTCB     EQU   9                       ADDRESS OF CURRENT TCB    Y02898 05600037
RUCB     EQU   10                      UCB ADDRESS                      05650037
RDEB     EQU   11                      DEB ADDRESS                      05700037
RB       EQU   12                      WORK REGISTER                    05750037
RC       EQU   13                      WORK REGISTER                    05800037
RD       EQU   14                      WORK/PARAMETER REGISTER          05850037
RJ       EQU   15                      WORK/PARAMETER REGISTER          05900037
R2       EQU   2                                               @YM06152 05950037
R12      EQU   12                                              @YM06152 06000037
*                                                                       06050037
CLOSEB   EQU   X'20'                                                    06100037
COMPLETE EQU   X'7F'                                                    06150037
QSAMB    EQU   X'01'                                                    06200037
BYTO     EQU   0                       DISPLACEMENT=0                   06250037
ECBOS    EQU   4                       OFFSET TO ECB                    06300037
ECBADOS  EQU   12                      OFFSET TO ECB ADDRESS            06350037
OUTPUT   EQU   X'07'                    MASK FOR OUTIN OR OUTPUT        06400037
SILIBIT  EQU   X'20'                   SUPPRESS INCORRECT LENGTH IND    06450037
TMFLAG   EQU   X'04'                   TM FLAG FOR CLOSE ROUTINE        06500037
UNUSED   EQU   X'80'                   DCB OPENED-NOT YET USED          06550037
ZERO     EQU   0                       DISPLACEMENT                     06600037
ONE      EQU   1                                                        06650037
TWO      EQU   2                                                        06700037
THREE    EQU   3                                                        06750037
FOUR     EQU   4                                                        06800037
SIX      EQU   6                                                        06850037
EIGHT    EQU   8                                                        06900037
R3505    EQU   X'46'                   3505 DCB DEVICE TYPE MASK        06950037
P3525    EQU   X'4C'                   3525 DCB DEVICE TYPE MASK        07000037
RPMASK   EQU   X'60'                                                    07050037
RWMASK   EQU   X'50'                                                    07100037
PWMASK   EQU   X'30'                                                    07150037
ERMASK   EQU   X'3F'                                                    07200037
SLIFLAG  EQU   X'20'                                                    07250037
WMASK    EQU   X'10'                                                    07300037
WXMASK   EQU   X'14'                                                    07350037
INMASK   EQU   X'0C'                    MASK FOR INOUT OR INPUT         07400037
CNTRL    EQU   X'02'                                                    07450037
SEQMASK  EQU   X'08'                                           @ZA03830 07500037
SEQFDISP EQU   80                      ASSOCIATED DATA SET SQE. DISP.   07550037
DEBOFFST EQU   44                                                       07600037
SEQOFF   EQU   X'C7'                MASK TO TURN OFF SEQ. FLAG @ZA00861 07650037
DEBRPTR  EQU   36                                                       07700037
DEBPPTR  EQU   40                                                       07750037
DEBWPTR  EQU   44                                                       07800037
XMASK    EQU   X'04'                                           @ZA03830 07850037
LOCMASK  EQU   X'14'                                                    07900037
WAOFF    EQU   32                                                       07950037
WGOFF    EQU   8                                                        08000037
PLOFF    EQU   4                                                        08050037
UE       EQU   X'01'                   UNIT EXCEPTION MASK              08100037
STATUSN  EQU   20                      NORM  CH SCH DCB IOB OFFSET      08150037
ECBPNTR  EQU   12                                                       08200037
CCW1     EQU   40                                                       08250037
CPADDR   EQU   24                                                       08300037
CCWFLAGS EQU   44                                                       08350037
FDSS     EQU   X'23'                   FEED SS COMMAND                  08400037
RW       EQU   X'50'                                                    08450037
P        EQU   X'20'                                                    08500037
W        EQU   X'10'                                                    08550037
IRPD     EQU   X'E8'                   INT.,RD,PCH,DPI FLAGS   @ZA11813 08600037
WRTOP    EQU   X'40'                                                    08650037
D14      EQU   14                                                       08700037
PIODSID  EQU   X'B0'                   PURGE OPT               @YM06152 08750037
PALL     EQU   X'D0'                   PURGE OPT               @YM06152 08800037
SAVELG   EQU   76                      SAVE AREA LENGTH        @YM06152 08850037
KEYMASK  EQU   X'80'                   MASK TO DISTINGUISH     @YM06152 08900037
PPLLENTH EQU   12             LENGTH OF PURGE PARM LST         @YM06152 08950037
DCBTRUNC EQU   8              OFFSET INTO PUTRTF OF            @YM06152 09000037
*                             TRUNCATE ROUTINE                 @YM06152 09050037
*                                      SYSTEM AND USER KEY     @YM06152 09100037
*                                                                       09150037
         USING IHADCB,RDCB                                              09200037
         USING CSTART,RBASE                                             09250037
         USING DEBBASIC,RDEB                                            09300037
         USING FORCORE,RCORE                                            09350037
         USING PSA,0                                           @YM06152 09400037
         BALR  RBASE,RE                PUT BASE ADDR IN BASE REG        09450037
CSTART   EQU   *                                                        09500037
         B     GETDCB                                          @ZA33956 09550037
         DC    CL8'IGG0201P'           MODULE NAME             @ZA33956 09560037
         DC    CL8'@ZA33956'           APAR ID                 @ZA33956 09570037
         DC    CL8'&SYSDATE'           DATE                    @ZA33956 09580037
*  SET CLOSE FLAG IN DCB AND INITALIZE REGISTERS AND WORKAREA , SAVE    09600037
*  ADDRESS OF DEB AND ISSUE PURGE MACRO                                 09650037
*                                                                       09700037
*                                                                       09750037
GETDCB   EQU   *                                               @ZA33956 09770037
         L     RCORE,FOUR(RWTGC)       GET DCB'S WORK AREA ADDR.        09800037
         MVI   DXCCW1,ZERO         CLEAR SWITCH                  Y02898 09850037
         MODESET KEYADDR=DXUKEY,WORKREG=15  USER KEY           @YM05576 09900037
         GETMAIN R,LV=SAVELG,SP=230     SAVE AREA              @YM06152 09950037
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY    @YM06152 10000037
         ST    RF,SCWGETMA              SAVE AREA ADDR         @YM06152 10050037
         LR    RC,RF                    SAVE PTR TO SAVE AREA  @YM06152 10100037
         L     RDCB,DXPDCBAD            GET DATA MAN DCB ADDR  @YM06152 10150037
         L     RDEB,DCBDEBAD            GET DEB ADDRESS          Y02898 10200037
         L     RDCB,DXUDCBAD            USER DCB               @YM06152 10250037
*                                                                       10300037
         MODESET KEYADDR=DXUKEY,WORKREG=15  USER KEY           @YM06152 10350037
         L     RB,DCBIOBA              GET CURR IOB ADDR.      @YM05576 10400037
         LA    RB,0(RB)                CLEAR HI ORDER BYTE     @YM05576 10450037
         L     RUCB,DEBSUCBA            GET UCB ADDRESS          Y02898 10500037
         OI    DCBCIND2,CLOSEB          TURN ON CLOSE FLAG       Y02898 10550037
         TM    DEBOPATB,OUTPUT         IS DCB OPENED FOR OUTPUT         10600037
         BNO   AMCL1010                BRANCH IF NOT OUTPUT             10650037
*                                                                       10700037
         TM    DCBCIND2,QSAMB          DCB USING QSAM TO PROCESS        10750037
         BO    TRUNCATE                YES BRANCH                       10800037
AMCL1010 EQU   *                                                        10850037
         USING PPLDSID,RC              PURGE PARM LIST         @YM06152 10900037
         XC    PPLDSID(PPLLENTH),PPLDSID   CLEAR LIST          @YM06152 10950037
         ST    RDEB,PPLDSID            PUT DECB IN LIST        @YM06152 11000037
         MVI   PPLDSID,PALL            PURGE OPT TO QUISE      @YM06152 11050037
         TM    ZERO(RB),WRTOP          LAST OF A WRITE         @YM06152 11100037
         BZ    AMCL1015                NO                      @YM06152 11150037
         MVI   PPLDSID,PIODSID         OPT,HALT I/O DELETE,ETC @YM06152 11200037
AMCL1015 EQU   *                                                        11250037
*                                                                       11300037
         PURGE (1)                                                      11350037
*                                                                       11400037
*                                                                       11450037
         LA    RF,PPLCC       GET PARA LIST ECB ADDRESS        @YM06153 11500037
*                                                                       11550037
         WAIT  ECB=(RF)                                                 11600037
         DROP  RC                                              @YM06153 11650037
*                                                                       11700037
         MODESET EXTKEY=DATAMGT     DATA MANAGEMENT KEY        @YM06152 11750037
         OI    FCACLOS2,FCACPURG    SET PURGE                  @YM06153 11800037
         TM    FCACLOS1,FCACFORC    IS THIS FORCE CLOSE        @YM06153 11850037
         BO    AMCL1040             YES, EXIT                  @YM06153 11900037
RP350090 EQU   *                                                        11950037
*                                                                       12000037
*  DETERMINE DEVICE TYPE. IF 3505 AND UNIT EXCEPTION IS ON IN STATUS OF 12050037
*  IOB EXIT TO IGG0201R. IF NOT TURN OFF ERROR INDICATORS IN DCB AND    12100037
*  RESET DEVICE BY ISSUING A FEED STACKER-SELECT (23) COMMAND.          12150037
*                                                                       12200037
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY            @YM05576 12250037
         CLI   DCBDEVT,R3505           IS THIS A 3505 CARD READER       12300037
         BNE   RP350400                IF NO GO CK FOR ASSOCIATED DATA  12350037
*                                      ON 3525                          12400037
*                                                                       12450037
*                                                                       12500037
*             CHECK TO SEE IF UNIT EXCEPTION HAS OCCURED                12550037
RP350300 EQU   *                                                        12600037
         L     RB,DCBIOBA              LOAD ADDR OF NORMAL SHC IOB      12650037
         TM    STATUSN(RB),UE          TEST FOR UNIT EXCEPTION          12700037
         BO    AMCL1040                BRANCH IF YES           @YM06152 12750037
RP350310 EQU   *                                                        12800037
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY            @YM05576 12850037
*                                      KEY                       Y02898 12900037
         NI    DCBIFLGS,ERMASK         TURN OFF ANY ERROR INDICATORS    12950037
*                                                                       13000037
*              DO A FEED STACKER SELECT WITHOUT OMR/RCE FLAG TO         13050037
*              RESET THE 3505 OR 3525                                   13100037
*                                                                       13150037
         L     RB,DCBIOBA              GET IOB ADDRESS                  13200037
         LA    RF,CCW1(RB)             POINT TO FIRST CCW               13250037
         ST    RF,CPADDR(RB)           STORE CP. ADDR IN IOB            13300037
         MVI   CCWFLAGS(RB),SLIFLAG    SET SLI ON CCOFF IN CCW          13350037
         MVI   ZERO(RF),FDSS           STORE AFD SS CMD                 13400037
         LA    RF,FOUR(RB)             GET SPECIAL ECB ADDR.            13450037
         ST    RF,ECBPNTR(RB)          STORE IN IOB ECB PNTR.           13500037
         LA    RF,EIGHT(RB)            POINT TO IOS'S IOB               13550037
*                                                                       13600037
*                                                                       13650037
         EXCP  (1)                                                      13700037
*                                                                       13750037
         WAIT  ECB=4(RB)                                                13800037
         MODESET EXTKEY=DATAMGT        DATA MGT KEY              Y02898 13850037
*                              KEY                                      13900037
         CLI   DXCCW1,ONE              CK IF CONTROL FLAG SWITCH Y02898 13950037
         BNE   AMCL1040                LOAD ID OF NEXT EXEC    @YM06152 14000037
         MVI   DXCCW1,ZERO             CLEAR SWITCH              Y02898 14050037
         B     RP350310                BRANCH TO FEED ANOTHER CARD      14100037
*                                                                       14150037
*                   CHECKING FOR 3525 ASSOCIATED DATA SET               14200037
*                CHANGE THE NAME "DCBMODE+3" WHEN OUR DSECT IS AVAIL    14250037
*                                                                       14300037
*  CHECK TO SEE WHAT TYPE OF DATA SET IS BEIN CLOSED ON 3525. IF INPUT  14350037
*  DATA SET WITH CNTRL ISSUE TWO FEED STACKER-SELECT CCW'S,OTHEWISE     14400037
*  ISSUE ONE FEED STACKER-SELECT CCW.                                   14450037
*                                                                       14500037
RP350400 EQU   *                                                        14550037
         TM    DCBMODE+THREE,RPMASK    IS THIS A READ/PUNCH DATA SET    14600037
*                                                                       14650037
         BO    RP350500                BRANCH IF YES                    14700037
         TM    DCBMODE+THREE,RWMASK    IS THIS A READ/PRINT DATA SET    14750037
         BO    RP350500                BRANCH IF YES                    14800037
         TM    DCBMODE+THREE,PWMASK    IS THIS A PUNCH/PRINT DATA SET   14850037
         BO    RP350500                BRANCH IF YES                    14900037
RP350600 EQU   *                                                        14950037
         CLI   DCBFUNC,WMASK           PRINT ONLY SPECIFIED BY FUNC=W   15000037
         BE    RP350310                BRANCH IF YES                    15050037
         CLI   DCBFUNC,WXMASK          PRINT ONLY SPECIFIED BY FUNC=WX  15100037
         BE    RP350310                BRANCH IF YES                    15150037
         TM    DEBOPATB,INMASK          IS THIS AN INPUT OR INOUT DCB   15200037
         BNZ   RP350310                 NO, BRANCH                      15250037
*                                                                       15300037
*                                                                       15350037
*                                                                       15400037
RP350610 EQU   *                                                        15450037
         TM    DCBMACRF,CNTRL          IS CNTRL SPECIFIED               15500037
         BNO   RP350310                IF NO GO FEED A CARD             15550037
RP350660 EQU   *                                                        15600037
*                                      SET SYSTEM TO OPEN PROTECTY02898 15650037
         MODESET EXTKEY=DATAMGT        KEY                       Y02898 15700037
         MVI   DXCCW1,ONE              SET SWITCH TO ONE         Y02898 15750037
         B     RP350310                BRANCH TO FEED A CARD            15800037
*              TURN ON SEQUENCE FLAGS IN ASSOCIATED DCB'S AND           15850037
*              TURN OFF SEQUENCE FLAGS IN DCB BEING CLOSE               15900037
RP350500 EQU   *                                                        15950037
         NI    DCBQSWS,SEQOFF          TURN OFF SEQUENCE FLAG           16000037
         SR    RB,RB                   SET FLAG TO ZERO                 16050037
         L     RC,DEBRDCB              LOAD ASSOCIATED READ DCB ADDR.   16100037
         LA    RC,0(RC)                ZERO HI ORDER BYTE               16150037
         LR    RD,RC                    SAVE DCB ADDR          @YM06152 16200037
*                                  SET SYSTEM TO OPEN PROTECT  @ZA08168 16250037
         MODESET EXTKEY=DATAMGT    KEY                         @ZA08168 16300037
         CLR   RC,RB                   IS THE READ DCB ADDR ZERO        16350037
         BE    RP350520                IF SO GO CK ON PUNCH DCB         16400037
*                                                                       16450037
*  THIS ROUTINE CHECKS FOR READ ASSOCIATED DATA SET. IF READ IS PART    16500037
*  OF ASSOCIATED DATA SET,ZERO OUT READ DCB ADDRESS IN DEBRDCB FIELD OF 16550037
*  DEB FOR EACH DATA SET OPENED (READ/PUNCH/PRINT)                      16600037
*                                                                       16650037
         CLR   RDCB,RC                 IS CUR DCB FOR READ              16700037
         BNE   RP350520                NO, BRANCH                       16750037
         DEBCHK (RDCB)                 GO TO DEB VALIDITY CHK  @YM06152 16800037
         LR    RDEB,RF                 RESET DEB BASE          @ZA29896 16820037
         ST    RB,DEBRDCB              CLEAR DEB READ DCB POINTER       16850037
         L     RC,DEBPDCB              GET ADDRESS OF PUNCH DCB         16900037
         LA    RC,0(RC)                ZERO HI ORDER BYTE               16950037
         LR    RD,RC                   SAVE DCB ADDR           @YM06152 17000037
         CLR   RB,RC                   PUNCH DATA SET ALSO USED         17050037
         BE    RP350512                IF NO GO CK WRITE DCB            17100037
*                                      SET SYSTEM TO USER PROTECTY02898 17150037
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY            @YM05576 17200037
         OI    SEQFDISP(RC),SEQMASK    TURN ON SEQ FLAGS                17250037
         L     RC,DEBOFFST(RC)   GET PUNCH DATA SET DEB ADDR     Y02898 17300037
         MODESET EXTKEY=DATAMGT        SET SYSTEM TO CLOSE PROTECY02898 17350037
*                                      KEY                       Y02898 17400037
         DEBCHK (RD)                   GO TO DEB VALIDITY      @YM06152 17450037
         LR    RC,RF                   RESET DEB BASE          @ZA29896 17470037
         ST    RB,DEBRPTR(RC)          ZERO READ DCB @ IN PUNCH DEB     17500037
RP350512 EQU   *                                                        17550037
         L     RC,DEBWDCB              GET PRINT DCB ADDRESS            17600037
         LA    RC,0(RC)                ZERO HI ORDER BYTE               17650037
         LR    RD,RC                   SAVE DCB ADDR           @YM06152 17700037
         CLR   RB,RC                   PRINT DATA SET USED              17750037
         BE    RP350520                NO GO CK PUNCH DCB               17800037
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY            @YM05576 17850037
*                                      KEY                       Y02898 17900037
         OI    SEQFDISP(RC),SEQMASK    TURN ON SEQUENCE MASK            17950037
         L     RC,DEBOFFST(RC)         GET PRINT DCB'S DEB              18000037
         MODESET EXTKEY=DATAMGT        SET SYSTEM TO CLOSE PROTECY02898 18050037
*                                      KEY                       Y02898 18100037
         DEBCHK (RD)                   GO TO DEB VALIDITY      @YM06152 18150037
         LR    RC,RF                   RESET DEB BASE          @ZA29896 18170037
         ST    RB,DEBRPTR(RC)          ZERO READ DCD @ IN PRINT DEB     18200037
RP350520 EQU   *                                                        18250037
         L     RC,DEBPDCB              GET PUNCH DCB ADDRESS            18300037
         LA    RC,0(RC)                ZERO HI ORDER BYTE               18350037
         CLR   RC,RB                   PUNCH DCB USED IN ASSOCIATIVE DS 18400037
         BE    RP350530                NO GO CK PRINT DCB               18450037
         CLR   RDCB,RC                 PUNCH DCB BEING CLOSED           18500037
         BNE   RP350530                NO GO CK PRINT DCB               18550037
*                                      SET SYSTEM TO OPEN PROTECTY02898 18600037
         DEBCHK (RDCB)                 GO TO DEB VALIDITY      @YM06152 18650037
         LR    RDEB,RF                 RESET DEB BASE          @ZA29896 18670037
         ST    RB,DEBPDCB              ZERO PUNCH DCB @ IN DEBPDCB      18700037
         L     RC,DEBRDCB              GET @ OF READ DCB IN PUNCH DEB   18750037
         LA    RC,0(RC)                ZERO HI ORDER BYTE               18800037
         LR    RD,RC                   SAVE DCB ADDR           @YM06152 18850037
         CLR   RB,RC                   READ DCB @ IN PUNCH DEB          18900037
         BE    RP350522                IF NO GO CK IF PRINT DATA SET    18950037
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY            @YM05576 19000037
         OI    SEQFDISP(RC),SEQMASK    TURN ON SEQUENCE FLAG FOR PUNCH  19050037
         L     RC,DEBOFFST(RC)         GET PUNCH DCB DEB ADDRESS        19100037
         MODESET EXTKEY=DATAMGT        SET SYSTEM TO CLOSE PROTECY02898 19150037
*                                      KEY                       Y02898 19200037
         DEBCHK (RD)                   GO TO DEB VALIDITY      @YM06152 19250037
         LR    RC,RF                   RESET DEB BASE          @ZA29896 19270037
         ST    RB,DEBPPTR(RC)          ZERO PUNCH DCB @ PTR IN PUNC     19300037
RP350522 EQU   *                                                        19350037
         L     RC,DEBWDCB              CHECK IF PRINT DATA SET EXIST    19400037
         LA    RC,0(RC)                ZERO HI ORDER BYTE               19450037
         LR    RD,RC                   SAVE DCB ADDR           @YM06152 19500037
         CLR   RB,RC                   PRINT DCB @ IN PRINT DEB         19550037
         BE    RP350530                IF NO BRANCH                     19600037
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY            @YM05576 19650037
         OI    SEQFDISP(RC),SEQMASK    SET PRINT SEQUENCE FLAG          19700037
         L     RC,DEBOFFST(RC)         GET PRINT DCB DEB ADDRESS        19750037
         MODESET EXTKEY=DATAMGT        SET SYSTEM TO CLOSE PROTECY02898 19800037
*                                      KEY                       Y02898 19850037
         DEBCHK (RD)                   GO TO DEB VALIDITY      @YM06152 19900037
         LR    RC,RF                   RESET DEB BASE          @ZA29896 19920037
         ST    RB,DEBPPTR(RC)          ZERO PUNCH DCB @ PTR IN PUNC     19950037
*                                                                       20000037
RP350530 EQU   *                                                        20050037
         L     RC,DEBWDCB                                               20100037
         LA    RC,0(RC)                ZERO HI ORDER BYTE               20150037
         CLR   RC,RB                   WRITE DCB OPENED                 20200037
         BE    RP350650                IF NO GO TEST DATA SET TYPE      20250037
         CLR   RDCB,RC                 PRINT DCB NOW BEING CLOSED       20300037
         BNE   RP350650                IF NOT GO TEST DATA SET TYPE     20350037
*                                      SET SYSTEM TO USER PROTECTY02898 20400037
         MODESET EXTKEY=DATAMGT        KEY                       Y02898 20450037
         DEBCHK (RDCB)                 GO TO DEB VALIDITY      @YM06152 20500037
         LR    RDEB,RF                 RESET DEB BASE          @ZA29896 20520037
         ST    RB,DEBWDCB              ZERO PRINT DCB @ IN DEB          20550037
         L     RC,DEBRDCB              GET @ OF READ DCB                20600037
         LA    RC,0(RC)                ZERO HIGHER ORDER BYTE           20650037
         LR    RD,RC                   SAVE DCB ADDR           @YM06152 20700037
         CLR   RB,RC                   READ DCB OPENED                  20750037
         BE    RP350532                IF NOT GO CHECK IF PUNCH OPENED  20800037
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY            @YM05576 20850037
         OI    SEQFDISP(RC),SEQMASK    SET SEQUENCE FLAG IN READ DCB    20900037
         L     RC,DEBOFFST(RC)         GET READ'S DCB DEB               20950037
         MODESET EXTKEY=DATAMGT        SET SYSTEM TO CLOSE PROTECY02898 21000037
*                                      KEY                       Y02898 21050037
         DEBCHK (RD)                   GO TO DEB VALIDITY      @YM06152 21100037
         LR    RC,RF                   RESET DEB BASE          @ZA29896 21120037
         ST    RB,DEBRPTR(RC)          ZERO OUT READ PTR @ IN DEB       21150037
*                                                                       21200037
RP350532 EQU   *                                                        21250037
*                                                                       21300037
         L     RC,DEBPDCB              GET PUNCH DCB ADDRESS            21350037
         LA    RC,0(RC)                ZERO HIGHER ORDER BYTE           21400037
         LR    RD,RC                   SAVE DCB ADDR           @YM06152 21450037
         CLR   RB,RC                   PUNCH DCB OPENED                 21500037
         BE    RP350650                IF NOT GO CK TYPE OF ASSOC.D.SET 21550037
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY            @YM05576 21600037
*                                      KEY                       Y02898 21650037
         OI    SEQFDISP(RC),SEQMASK    SET SEQUENCE FLAG IN PUNCH DCB   21700037
         L     RC,DEBOFFST(RC)         GET PUNCH DCB'S DEB ADDRESS      21750037
         MODESET EXTKEY=DATAMGT        SET SYSTEM TO CLOSE PROTECY02898 21800037
*                                      KEY                       Y02898 21850037
         DEBCHK (RD)                   GO TO DEB VALIDITY      @YM06152 21900037
         LR    RC,RF                   RESET DEB BASE          @ZA29896 21920037
         ST    RB,DEBPPTR(RC)          ZERO OUT PUNCH PTR @ IN DEB      21950037
RP350650 EQU   *                                                        22000037
*                                      SET SYSTEM TO USER PROTECTY02898 22050037
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY            @YM05576 22100037
         TM    DCBFUNC,RWMASK          IS THIS A READ/PRINT DATA SET    22150037
         BO    RP350653                BRANCH IF YES                    22200037
RP350651 EQU   *                                                        22250037
         TM    DCBFUNC,RPMASK          IS THIS A READ/PUNCH DATA SET    22300037
         BO    RP350654                BRANCH IF YES                    22350037
RP350652 EQU   *                                                        22400037
         TM    DCBFUNC,PWMASK          IS THIS A PUNCH/PRINT DATA SET   22450037
         BO    RP350655                BRANCH IF YES                    22500037
         B     RP350300                BRANCH                           22550037
RP350653 EQU   *                                                        22600037
         TM    DEBOPATB,INMASK         IS THIS AN INPUT FILE            22650037
         BZ    RP350610                BRANCH IF YES                    22700037
         B     AMCL1040                BRANCH                  @YM06152 22750037
RP350654 EQU   *                                                        22800037
         TM    DEBOPATB,INMASK                                          22850037
         BZ    RP350310                BRANCH, IF NO                    22900037
         B     AMCL1040                BRANCH                  @YM06152 22950037
RP350655 EQU   *                                                        23000037
         TM    DCBFUNC,XMASK           IS THIS A PRINT DATA SET         23050037
         BO    AMCL1040                BRANCH IF YES           @YM06152 23100037
         B     RP350310                BRANCH                           23150037
TRUNCATE EQU   *                                                        23200037
         TM    DCBCIND2,DCBCNIOE       HAS EOV BEEN ENTERED    @YM06152 23250037
         BO    RP350090                YES, BRANCH                      23300037
         L     RF,DXUDCBAD             GET USER DCB ADDRESS      Y02898 23350037
         LA    RJ,LOADPUT              ADDR OF INST TO GO TO   @YM06152 23400037
*                                      TRUNCATE ROUTINE        @YM06152 23450037
         BAL   RB,SYNCHRTN             GO TO SYNCH RTN         @YM06152 23500037
***                                                            @ZA33956 23550037
         MODESET EXTKEY=DATAMGT                                @ZA33956 23557037
         DEBCHK (RDCB)                                         @ZA33956 23564037
         LR    RDEB,RF                 RELOAD DEB BASE         @ZA33956 23571037
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER KEY            @ZA33956 23578037
***                                                            @ZA33956 23585037
         TM    DCBMACRF+ONE,LOCMASK    DCB USING LOCATE MODE            23600037
         BM    AMCLAD02                NO BRANCH                        23650037
***                                                                     23700037
**                                                                      23750037
*        THIS ROUTINE WILL PREVENT ISSUING A PUT WHEN THE 3525 @ZA11813 23800037
*        PUNCH OR PRINT IS A PART OF AN ASSOCIATED DATA SET    @ZA11813 23850037
*        USING QSAM IN LOCATE MODE.                            @ZA11813 23900037
* NOTE:  THE USER MUST ISSUE A PUT FOR HIS LAST PUNCH OR PRINT @ZA11813 23950037
*        BUFFER WHEN USING QSAM IN LOCATE MODE FOR AN          @ZA11813 24000037
*        ASSOCIATED DATA SET.                                  @ZA11813 24050037
**                                                             @ZA11813 24100037
***                                                            @ZA11813 24150037
         TM    DCBFUNC,IRPD            FUNC OTHER THAN PRT ONLY@ZA11813 24200037
         BM    RP350656                YES, BRANCH             @ZA11813 24250037
         TM    DCBFUNC,W               FUNC EQUALS PRT ONLY    @ZA11813 24300037
         BO    AMCLAD01                YES, BR. TO ISSUE PUT   @ZA11813 24350037
RP350656 EQU   *                                               @ZA11813 24400037
         TM    DCBFUNC,RW              CK FOR READ OR PRINT DATA SET    24450037
         BZ    AMCLAD01                NO, BRANCH TO PUT ROUTINE        24500037
         TM    DCBFUNC,P               CK FOR PUNCH FLAG ONLY           24550037
         BO    AMCLAD02                YES, BYPASS PUT ROUTINE          24600037
         TM    DCBFUNC,W               PRINT FLAG ON                    24650037
         BO    AMCLAD02                YES, BYPASS PUT ROUTINE          24700037
*                                                                       24750037
*                                                                       24800037
AMCLAD01 EQU   *                                                        24850037
*                                                                       24900037
*  MUST ISSUE A PUT ROUTINE IF IN LOCATE MODE TO FLUSH BUFF AFTER TRUNC 24950037
*                                                                       25000037
         LR    RF,RDCB                 SET UP PARAMETER REGISTER Y02898 25050037
         L     RJ,DCBPUT               FOR PUT LOCATE ROUTINE  @YM06152 25100037
         BAL   RB,SYNCHRTN             TO PUT LOCATE ROUTINE   @YM06152 25150037
***                                                            @ZA33956 25200037
         MODESET EXTKEY=DATAMGT                                @ZA33956 25207037
         DEBCHK (RDCB)                                         @ZA33956 25214037
         LR    RDEB,RF                 RELOAD DEB BASE         @ZA33956 25221037
         MODESET KEYADDR=DXUKEY,WORKREG=15  USER KEY           @ZA33956 25228037
***                                                            @ZA33956 25235037
AMCLAD02 EQU   *                                                        25250037
         L     RB,DCBIOBA              LOAD ADDR OF IOB                 25300037
         LA    RB,0(RB)                CLEAR HI ORDER BYTE              25350037
         LR    RUCB,RB                 SAVE IOB ADDR TO LOOP ON         25400037
AMCLAD03 EQU   *                                                        25450037
         LR    RD,RB                   SAVE IOB IN CASE OF ERROR        25500037
         L     RB,BYTO(RB)             GET NEXT IOB                     25550037
         LA    RB,BYTO(RB)             CLEAR HI ORDER BYTE              25600037
         B     AMCLAD05                GO TEST COMPLETION               25650037
*                                                                       25700037
AMCLAD04 EQU   *                       ISSUE WAIT                       25750037
         L     RF,ECBADOS(RB)          GET ECB ADDRESS                  25800037
         WAIT  ECB=(1)                 WAIT ON IOB COMPLETION           25850037
AMCLAD05 TM    ECBOS(RB),COMPLETE      TEST IOB COMPLETE/OUT ERROR      25900037
         BM    AMCL1035                BRANCH COMPLETE BUT IN ERROR     25950037
         BZ    AMCLAD04                GO WAIT NOT YET COMPLETE         26000037
         CR    RUCB,RB                 IS THE NEXT IOB = IOBA           26050037
         BE    RP350090                YES                              26100037
         B     AMCLAD03                GET NEXT IOB                     26150037
AMCL1035 EQU   *                                                        26200037
         ST    RD,DCBIOBA              STORE LAST IOB SCHEDULED         26250037
*                                                                       26300037
AMCL1040 EQU     *                                             @YM06153 26350037
         MODESET KEYADDR=DXUKEY,WORKREG=15                     @YM06153 26400037
         L       RF,SCWGETMA        GET SAVE AREA ADDR         @YM06153 26450037
         FREEMAIN R,LV=SAVELG,A=(1),SP=230  REG SAVE AREA      @YM06153 26500037
         MODESET EXTKEY=DATAMGT                                @YM06153 26550037
         MVC   ZERO(TWO,RWTGC),GOOD   LOAD ID  NEXT EXECUTOR   @YM05576 26600037
         TM      FCACLOS1,FCACFORC  IS THIS FORCE CLOSE        @YM06153 26650037
         BO      AMCL5019           YES                        @YM06153 26700037
*                                                                       26750037
*                                                                       26800037
RELOOP   EQU   *                                                        26850037
         LA    RWTGC,WGOFF(ZERO,RWTGC) STEP TO NEXT ENTRY               26900037
         LA    RPARC,PLOFF(ZERO,RPARC) STEP TO NEXT ENTRY               26950037
         CLC   0(TWO,RWTGC),AMIDCNST                                    27000037
         BCR   EIGHT,RBASE             RECRUSE THRU MODULE              27050037
         CLC   0(TWO,RWTGC),CLLDB       END OF TABLE?          @YM05576 27100037
         BL    RELOOP                  NO BRANCH               @YM05576 27150037
         CLC   0(TWO,RWTGC),CLLDG      END OF TABLE?           @YM05576 27200037
         BH    RELOOP                  NO BRANCH               @YM05576 27250037
*                                                                       27300037
         LR    RPARC,RPAR              INITILIZATION                    27350037
         LA    RWTGC,WAOFF(ZERO,RWTG)  REINITIALIZE WTG LIST POINTER    27400037
*                                                                       27450037
AMCL5011 EQU   *                                                        27500037
         CLI   0(RWTGC),ZERO           IS THIS ENTRY ZERO               27550037
         BNE   AMCL5019                NO BRANCH                        27600037
         LA    RWTGC,WGOFF(ZERO,RWTGC) STEP TO NEXT ENTRY               27650037
         LA    RPARC,PLOFF(ZERO,RPARC) STEP TO NEXT ENTRY               27700037
         B     AMCL5011                BRANCH                           27750037
*                                                                       27800037
AMCL5019 EQU   *                                                        27850037
         MVC   SIX(TWO,RWTG),ZERO(RWTGC) SET UP ROUTINE ID FOR XCTL     27900037
         MVC   D14(THREE,RWTG),TWO(RWTGC) MOVE TTR INTO TABLE           27950037
***                                                                     28000037
         XCTL  DE=(RWTG),SF=(E,DXCCW12)                                 28050037
*                                                                       28100037
*THIS ROUTINE TESTS THE CALLERS KEY TO DETERMINE WHETHER TO    @YM06152 28150037
*BALR (IF KEY IS LT 8) OR SYNCH (IF KEY IS GT 7) TO THE ACCESS @YM06152 28200037
*METHOD ROUTINES. CLOSES REGS ARE SAVED IN THE SVRB SAVEAREA   @YM06152 28250037
*AND THE USERS REGISTERS ARE LOADED AND PASSED TO THE ACCESS   @YM06152 28300037
*METHOD ROUTINES (FOR THE CASE AN EOV CONDITION ARISES AND A   @YM06152 28350037
*USER EOV EXIT IS TAKEN).                                      @YM06152 28400037
*                                                                       28450037
SYNCHRTN EQU     *                                             @YM06152 28500037
         L       RTCB,PSATOLD       GET CURRENT TCB@           @YM06152 28550037
         USING   TCB,RTCB                                      @YM06152 28600037
         L       RD,TCBRBP          GET RB ADDR                @YM06152 28650037
         USING   RBSECT,RD          BASE FOR RB                @YM06152 28700037
         MODESET EXTKEY=SUPR                                   @YM06152 28750037
         STM     RF,RB,RBEXSAVE     SAVE CLOSE REG IN SVRB     @YM06152 28800037
         L       RC,SCWGETMA        GET REG SAVE AREA ADDR     @YM06152 28850037
         MODESET KEYADDR=DXUKEY,WORKREG=12                     @YM06152 28900037
         TM      DXUKEY,KEYMASK     CALLER KEY 8 OR HIGHER?    @YM06152 28950037
         BO      PRB                SYNCH IF GT 0R EQ 8        @YM06152 29000037
         LM      R2,R12,RBGRS2      GET USER REGS              @YM06152 29050037
         DROP    RD                                            @YM06152 29100037
         BALR    RD,RJ              PUT ROUTINE                @YM06152 29150037
         USING   *,RD                                          @YM06152 29200037
         B       RELOAD                                        @YM06152 29250037
         DROP    RD                                            @YM06152 29300037
*                                                                       29350037
PRB      EQU     *                                             @YM06152 29400037
         USING   RBSECT,RD                                     @YM06152 29450037
         LM      R2,R12,RBGRS2      GET USERS REGS             @YM06152 29500037
         DROP    RD                                            @YM06152 29550037
         SYNCH   (15)               GO TO USER                 @YM06152 29600037
*                                                                       29650037
RELOAD   EQU     *                                             @YM06152 29700037
         L       RTCB,PSATOLD       CURRENT TCB ADDR           @YM06152 29750037
         USING   TCB,RTCB                                      @YM06152 29800037
         L       RD,TCBRBP          LOAD PTR TO SVRB           @YM06152 29850037
         DROP    RTCB                                          @YM06152 29900037
         USING   RBSECT,RD                                     @YM06152 29950037
         LM      RF,RB,RBEXSAVE     RESTORE CLOSES REG         @YM06152 30000037
         DROP    RD                                            @YM06152 30050037
         BR      RB                 RETURN TO MAIN ROUTINE     @YM06152 30100037
*                                                                       30150037
*INSTRUCTIONS USED TO GO TO THE ACCESS METHOD ROUTINE          @YM06152 30200037
         DROP    RDCB                                          @YM06152 30250037
         USING   IHADCB,RF                                     @YM06152 30300037
LOADPUT  L       RJ,DCBPUT          LOAD PUT RTN ADDR          @YM06152 30350037
         B       DCBTRUNC(RJ)       BR TO TRUNCATE ROUTINE     @YM06152 30400037
AMIDCNST DC    C'1P'                   ID OF THIS MODULE                30450037
*                   MUST BE INSERTED                                    30500037
*                                                                       30550037
ZAPSZAPS DC    8C'ZAPSZAPS'            WORK AREA USED BY CLOSE   Y02898 30600037
GOOD     DC    C'1R'             ID OF SECOND HALF OF 3505/25  @YM05576 30650037
CLLDB    DC   C'0B'                         ID OF IGG0200B     @YM05576 30700037
CLLDG    DC   C'0G'                     ID OF IGG0200G         @YM05576 30750037
*                                                                       30800037
         DCBD  DSORG=PS                                                 30850037
         IEZDEB                                                         30900037
         IECDSECS MAIN,EXPAND=YES                                Y02898 30950037
         IKJTCB                                                  Y02898 31000037
         IHARB                                                   Y02898 31050037
         IHAPSA                                                @YM06152 31100037
         IECDPPL DSECT=YES                                     @YM06152 31150037
FORCORE  DSECT                                                 @YM06152 31200037
         IHAFCAUD ORG=YES                                      @YM06152 31250037
FORCORE  DSECT                                                 @YM06152 31300037
         IGGSCW                                                @YM06152 31350037
         END                                                            31400037
