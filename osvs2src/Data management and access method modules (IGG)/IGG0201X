 TITLE 'IGG0201X - SAM CLOSE EXECUTOR, NON-DIRECT ACCESS - LOAD 2'      00006002
IGG0201X CSECT                                                          00012020
*                                                                       00014002
*MODULE NAME - IGG0201X                                                 00016002
*                                                                       00016402
*DESCRIPTIVE NAME - RESTORE RESOURCES AND CLEAN UP FOR NON-DA           00016802
*                                                                       00017202
*COPYRIGHT - NONE                                                       00017602
*                                                                       00017702
*STATUS CHANGE LEVEL 003                                                00048002
*                                                                       00054020
*FUNCTION - THE FOLLOWING WILL BE PERFORMED BY THIS CLOSE EXECUTOR FOR  00068002
*           BSAM/QSAM DATA SETS NON-DIRECT ACCESS:                      00078002
*         - IT WILL FREEMAIN THE RECORD AREA IF GOTTEN BY OPEN.         00128002
*         - IT WILL FREEMAIN ANY BUFFERS GOTTEN BY OPEN IF              00180002
*           CONCATENATION WITH UNLIKE ATTRIBUTES.                       00200002
*           FOR ALL OTHER CONDITIONS BUFFERS WILL BE RETURNED TO        00240002
*           THE POOL.                                                   00250002
*         - IT FREEMAINS THE IOBS/ICBS GOTTEN BY OPEN.                  00260002
*         - IT FREEMAINS THE FCR TABLE FOR 3886 OCR DEVICES.            00270002
*         - CLEAR FIELDS IN THE DCB SO THAT IT CAN'T BE USED UNLESS     00280002
*           IT IS OPENED AGAIN.                                         00300002
*         - SETS APPROPRIATE AUDIT TRAIL BITS IN THE O/C/E       Y02072 00342002
*           WORKAREA IN CASE THE USERS STAE ROUTINE SHOULD GET   Y02072 00344002
*           CONTROL DURING A FORCE CLOSE SITUATION. (THESE       Y02072 00346002
*           BITS, ALTHOUGH SET DURING NORMAL CLOSE, HAVE NO      Y02072 00348002
*           MEANING).                                            Y02072 00348402
*                                                                       00360020
*ENTRY POINT - IGG0201X FROM IGG0201A OR IGG0201B                       00380003
*                                                                       00400020
*INPUT - SEE DESCRIPTION OF REGISTERS, DCB(USERS), IOB(USERS).          00420002
*                                                                       00440020
*OUTPUT - NONE                                                          00460002
*                                                                       00480020
*MACROS - ACTION : FREEMAIN, IECRES, MODESET                            00490003
*                                                                       00492002
*MACROS - MAPPING : IECDSECT, IECDSECS, DCBD, IGGBCB, IHACCW, IEZDEB,   00494002
*                   IEZIOB, IGGPARML, IGGSCW, IHAFCAUD                  00496002
*                                                                       00498002
*EXTERNAL ROUTINES - NONE                                               00500002
*                                                                       00520020
*EXITS - NORMAL : TO IGG0200B, IGG0200G                                 00540003
*                                                                       00560020
*EXITS - ABNORMAL : BR 14 TO FORCE CLOSE EXEC IF FORCE CLOSE IN  Y02072 00570002
*                   CONTROL                                      Y02072 00580002
*                                                                       00582002
*ATTRIBUTES - REENTRANT, REUSABLE, RUNS IN USER KEY UNLESS       Y02072 00584002
*             OTHERWISE SPECIFIED, SUPERVISOR STATE              Y02072 00586002
*                                                                       00590002
*TABLES/WORKAREAS - WHERE TO GO TABLE (WTG)                             00620002
*                                                                       00640020
*      BYTE  0-7  NAME                                                  00660020
*      BYTE  8-10 RELATIVE DISK ADDRESS(TTR) OF FIRST RECORD            00680020
*      BYTE 11    CONCATENATION NUMBER                                  00700020
*      BYTE 12    ZERO                                                  00720020
*      BYTE 13    ALIAS INDICATOR AND USER DATA FIELD DESCRIPTOR.       00740020
*                        ALIAS INDICATOR 1 BIT                          00760020
*                        NUMBER OF TTRS IN USERS DATA FIELD 2 BITS      00780020
*      BYTE 14-16 TTR OF FIRST TEXT RECORD                              00800020
*      BYTE 17    ZERO                                                  00820020
*      BYTE 18-19 TTR OF NOTE LIST OR SCATTER LIST                      00840020
*      BYTE 20    TRANSLATION TABLE                                     00860020
*      BYTE 21    ZERO OR NUMBER OF ENTRIES IN THE NOTE LIST            00880020
*      BYTE 22-23 ATTRIBUTES                                            00900020
*      BYTE 24-26 TOTAL CONTIGUOUS MAIN STORAGE REQUIRED FOR MODULE     00920020
*      BYTE 27-28 LENGTH OF FIRST TEXT RECORD                           00940020
*      BYTE 29    LENGTH OF WTG TABLE (IN DOUBLE WORDS)                 00960020
*      BYTE 30-31 PATH THROUGH LOADS OF ROUTINES                        00980020
*      BYTE 32-36 IDTTR OF EXECUTOR FOR FIRST DCB                       01000020
*      BYTE 37-39 WORKAREA ADDRESS FOR FIRST DCB                        01020020
*      BYTE 40-   TABLE OF IDTTR'S                                      01040020
*      BYTE 32+N(8) IDTTR OF EXECUTOR FOR N TH DCB   (5 BYTES)          01060020
*                   WORKAREA ADDRESS FOR N TH DCB    (3 BYTES)          01080020
*                   IDTTR OF LAST ROUTINE LOAD       (5 BYTES)          01100020
*                   NOT USED                         (3 BYTES)          01120020
*                                                                       01140020
*      CLOSE WORK AREA                                                  01150002
*                                                                       01220020
*NOTES - ALL REGISTER EQUATES BEGIN WITH THE CHARACTER R.               01240002
*        THE DEB ADDRESS IS GOTTEN FROM THE PROTECTED DCB FOR    Y02072 01240102
*        INTEGRITY REASONS.                                      Y02072 01240202
*                                                                       01240402
*CHANGE ACTIVITY - AS FOLLOWS:                                          01242002
*                                                                       01244002
*          VS2 RELEASE 01 DELETIONS/CHANGES                             01246002
*D097000-097200                                                  YM0928 01248002
*                                                                       01248402
*          VS2 RELEASE 02 DELETIONS/CHANGES                             01248802
*000080,000200,000340,000480,004900,024900,025200,025204,        Y02072 01249202
*025300-025324,025500-025720,097762,100600,103700-103960,115800, Y02072 01249602
*115900,116200-116300,117720,117880,124480,133400,133600,        Y02072 01249702
*124700-124968,129800,132700,100200,100340,115400,117600,117720, Y02072 01249802
*120000-120400,121000                                            Y02072 01249902
*24620-24640                                                     YM3079 01253402
*                                                                YM4640 01253502
*                                                                YM7595 01255502
*                                                                YM6889 01257502
*C125000                                                       @AZ09146 01262537
*          VS2 RELEASE 03 DELETIONS/CHANGES                             01267503
*                                                              @Z30TSMI 01267903
*          RELEASE 21 DELETIONS/CHANGES                                 01268502
*                                                                A48163 01272002
*                                                                A45221 01275502
*                                                                M0008  01279002
* 123400                                                         A40495 01282502
*                                                                A45280 01286002
*                                                               SA67354 01288002
*                                                                       01289502
         EJECT                                                          01293002
*                                                                       01296502
* REGISTER USAGE                                                        01300002
*                                                                       01320020
RWK1     EQU   0                        WORK REGISTER                   01340002
R1       EQU   1                        PARAMETER REGISTER              01360002
RWK2     EQU   R1                       WORK REGISTER                   01370002
RDCB     EQU   2                        ADDR OF USERS DCB               01380002
RBASE    EQU   3                        BASE REGISTER                   01400002
RCORE    EQU   4                        ADDR OF CLOSE WORK AREA         01420002
RPAR     EQU   5                        PARAMETER LIST                  01440002
RWTG     EQU   6                        START OF WTG                    01460002
RPARC    EQU   7                        CURRENT ENTRY IN PARAMETER LIST 01480002
RWTGC    EQU   8                        CURRENT ENTRY IN WTG TABLE      01500002
RWK7     EQU   9                        WORK REGISTER                   01520002
RWK4     EQU   10                       WORK REGISTER                   01530002
RDEB     EQU   11                       DEB ADDRESS                     01560002
RIOB     EQU   12                       IOB REGISTER                    01590002
RWK3     EQU   RIOB                     WORK REGISTER                   01600002
RWK5     EQU   14                       WORK REGISTER                   01620002
RBRNCH   EQU   RWK5                     RETURN REGISTER          Y02072 01630002
R15      EQU   15                       PARAMETER REGISTER       Y02072 01632002
RWK6     EQU   R15                      WORK REGISTER                   01640002
         EJECT                                                          01650002
*                                                                       01660020
* EQUATES FOR CONSTANTS                                                 01662002
*                                                                       01664002
RDBACKB  EQU   X'03'                    TEST FOR READ BACKWARD    OC022 02100002
OUTINOUT EQU   X'07'                    TEST FOR OUTPUT OR OUTIN  OC022 02232002
OCR3886  EQU   X'57'                    DCBDEVT FOR 3886 OCR    XL03127 02273002
FCRTBLSZ EQU   2048                     3886 FCR TABLE SIZE     XL03127 02275002
DEFLTCP  EQU   1                        DEFAULT NO OF CHAN PGMS         02332402
CLOSEFIN EQU   0                        CLOSE FINISHED THIS DCB         02332802
MIOBSIZE EQU   48                       SIZE OF MAIN IOB IN CHAIN SCHED 02333202
INVALADD EQU   X'01'                    USED TO INVALIDATE       Y02072 02333602
*                                         ADDRESS VECTORS        Y02072 02333802
CLEARIND EQU   0                        FOR CLEARING ONE BYTE INDIC'S   02334002
DCBLNFMT EQU   X'FF'                    FOR CLEARING LINE FORMAT        02343702
*                                         NUMBER ON 3886 OCR DEVICES    02353702
         EJECT                                                          02359602
*                                                                       02372202
* ADDRESSABILITY FOR DSECTS                                             02384802
*                                                                       02397402
         USING WTG,RWTG                                                 02410002
         USING WTGENTRY,RWTGC                                           02420002
         BALR  RBASE,0                                                  02440020
         USING AMCL1,RBASE                                              02450002
AMCL1    EQU   *                                                        02460020
         B     BEGIN                    BRANCH AROUND MODULE ID  YM4640 02462002
         DC    C'IGG0201X'              MODULE NAME              YM4640 02464002
         DC    C'@AZ09146'              LAST SHIP CODE         @AZ09146 02466037
         DC    C'03/10/76'              LAST SHIP DATE         @AZ09146 02467037
BEGIN    DS    0H                       END OF MODULE ID         YM4640 02468402
         L     RCORE,WTGDCBWA           GET DCB'S WORK AREA      Y02072 02470002
         USING FORCORE,RCORE                                     Y02072 02472002
         L     RDCB,DXPDCBAD            GET PROTECTED DCB ADDR   Y02072 02472402
         USING IHADCB,RDCB                                       Y02072 02472802
         L     RDEB,DCBDEBAD            GET VALID DEB ADDR       Y02072 02473202
         USING DEBBASIC,RDEB                                            02473602
         MODESET  KEYADDR=DXUKEY,WORKREG=13                      Y02072 02474002
         SR    RWK7,RWK7                PREPARE FOR IC INST             02480002
         L     RDCB,DXUDCBAD            GET DCB BEING CLOSED     Y02072 02520002
         L     RIOB,DCBIOBA             GET CURR IOB ADDRESS            02580002
         LA    RIOB,0(RIOB)             CLEAR HIGH ORDER BYTE           02600002
         USING IOBQSAMN,RIOB                                            02650002
         CLI   DCBDEVT,DCBDVTRM         TSO TERMINAL                    05660002
         BE    AMCL5000                 YES, BRANCH                     06660020
         TM    DCBCIND2,DCBCNQSM        DCB USING QSAM                  09580002
         BZ    AMCL3000                 NO BRANCH                       09600002
         TM    DCBCIND1,DCBCNEXB        EXCHANGE BUFFERING USED         09640002
         BO    AMCL3000                 YES BRANCH                      09660002
         L     RWK5,DCBBUFCB            GET BUFFER POOL CNTRL BLK       09740002
*                                                                       09750021
* IF A RECORD AREA WAS ACQUIRED BY OPEN, IT SHOULD BE RETURNED TO       09752021
* THE SUPERVISOR.                                                       09754021
*                                                                       09756021
         LA    RWK5,0(RWK5)             CLEAR HIGH ORDER BYTE    A48163 09758002
         USING BCBLK,RWK5                                               09758102
         TM    BCBFLGS,BCBLRI           RECORD AREA INDICATOR ON A48163 09758402
         BZ    AMCL2010                 BRANCH NO TO CHECK OFLGS A48163 09758821
         TM    DCBCIND2,DCBCNBFP        DID OPEN ACQUIRE POOL    A48163 09759002
         BZ    AMCL2010                 BRANCH NO TO CHECK OFLGS A48163 09759121
         L     R1,BCBLRIAR              GET RECORD AREA ADDR     A48163 09766002
         USING LRIAREA,R1                                               09768002
         L     RWK4,LRILGTH             GET LENGTH OF RECORD AREA       09769402
         LA    RWK4,0(RWK4)             CLR HI BYT FOR OR INST   YM6889 09771402
         FREEMAIN R,LV=(RWK4),A=(1),SP=0  FREE RECORD AREA       Y02072 09776202
         SPACE 2                                                        09778202
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 09778602
         SPACE 2                                                        09779002
         OI    FCACLOS1,FCACRECA        REC AREA FREED           Y02072 09779402
         SPACE 2                                                        09779502
         MODESET  KEYADDR=DXUKEY,WORKREG=13  BACK TO USER KEY    Y02072 09785502
         SPACE 2                                                        09787502
         NI    BCBFLGS,X'FF'-BCBLRI     TURN OFF RECORD AREA FLAG       09792002
         XC    BCBLRIAR,BCBLRIAR        CLEAR RECORD AREA ADDR          09798002
AMCL2010 EQU   *                                                        09804002
         SR    RWK6,RWK6                CLEAR REGISTER           YM0928 09810002
         IC    RWK6,DCBBUFNO            GET NUMBER OF BUFFERS    YM0928 09816002
*                                        TO FREE                        09822002
         TM    DCBOFLGS,DCBOFEOV        CONCATENATION UNLIKE ATTRIBUTES 09828002
         BZ    AMCL2030                 NO BRANCH TO FREE BUFFERS       09834002
         TM    DCBCIND2,DCBCNBFP        DID OPEN ACQUIRE POOL           09840002
         BZ    AMCL2030                 NO BRANCH TO RETURN BUFFERS     09860002
*                                         TO THE POOL                   09870002
*                                                                       09900020
* FREE BUFFER POOL  OPEN WILL ACQUIRE A NEW ONE LATER                   09920002
*                                                                       09940020
AMCL2020 EQU   *                                                        09950002
         LR    R1,RWK5                  SAV CNTRL BLK ADDR FOR FREEMAIN 09960002
         DROP  RWK5                                                     09970002
         USING BCBLK,RWK2                                               09972002
         LH    RWK5,BCBBUFSZ            GET BUFFER SIZE                 09980002
         MR    RWK5,RWK5                TOTAL AMT REQUIRED FOR BUFFERS  10000002
         LA    RWK4,BCBNLN(RWK6)        ADD EIGHT FOR CNTRL BLK  Y02072 10020002
         TM    BCBFLGS,BCBEXTND         IS BUFCB LENGTH 16 BYTES A48163 10030002
         BNO   FREE                     NO, GO FREE POOL                10032021
         LA    RWK4,BCBEXLN(RWK4)       YES, ADD 8 BYTES MORE    Y02072 10034002
FREE     EQU   *                                                 A48163 10036021
*                                                                       10040020
         FREEMAIN R,LV=(RWK4),A=(1),SP=0  FREE BUFFER POOL       Y02072 10060002
         SPACE 2                                                        10110002
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 10112002
         SPACE 2                                                        10114002
         OI    FCACLOS1,FCACBUFC        BUFFERS FREED            Y02072 10116002
         SPACE 2                                                        10118002
         MODESET  KEYADDR=DXUKEY,WORKREG=13  BACK TO USER KEY    Y02072 10118402
         SPACE 2                                                        10118802
         XC    DCBBUFCA,DCBBUFCA        CLEAR ADDRESS IN DCB            10120002
         OI    DCBBUFCB+3,INVALADD      SET INVALID ADDRESS             10140002
         B     AMCL3000                                                 10160020
*                                                                       10210002
* BEFORE RELINKING BUFFERS IT MUST BE KNOWN IF IT CAN BE DONE    YM7595 10260002
* SAFELY. IF THIS IS A FORCE CLOSE SITUATION, OPEN COULD HAVE    YM7595 10270002
* BEEN IN THE PROCESS OF UNCHAINING BUFFERS FOR CCW BUFFER       YM7595 10272002
* ADDRESSES WHEN THE ERROR OCURRED. IF THIS IS THE CASE, THE     YM7595 10274002
* STATE OF THE BUFFER POOL IS NOT KNOWN AND THEREFORE IT WOULD   YM7595 10276002
* BE RISKY TO TRY TO RECHAIN. IF THIS IS THE CASE THE BUFFER     YM7595 10278002
* POOL SHOULD BE FREEMAINED BECAUSE IT IS UNUSABLE.              YM7595 10278402
*                                                                       10278802
AMCL2030 EQU   *                                                        10280020
         TM    FCACLOS1,FCACFORC        FORCE CLOSE IN CONTROL   YM7595 10282002
         BZ    AMCL2035                 NO, GO RELINK BUFFERS    YM7595 10284002
         TM    FCAOPEN2,FCAOIOBC        WAS IOB CONSTRUCTION     YM7595 10286002
*                                         COMPLETED              YM7595 10288002
         BO    AMCL2035                 YES, OK TO RELINK BUFS   YM7595 10288402
         TM    DCBCIND2,DCBCNBFP        DID OPEN BUILD BUFFERS   YM7595 10288802
         BO    AMCL2020                 YES, GO FREEMAIN BUF     YM7595 10289202
*                                         POOL                   YM7595 10289602
         BZ    AMCL3000                 NO, CANNOT FREE USER     YM7595 10289702
*                                         GOTTEN BUFFERS         YM7595 10289802
*                                                                       10289902
* SIMULATE THE FREE BUFFER MACRO TO RETURN BUFFERS TO POOL              10293902
*                                                                       10295902
AMCL2035 EQU   *                                                        10297902
         USING BCBLK,RWK5                                               10298002
         IC    RWK7,DCBOFFSW            GET WRITE CCW OFFSET      OC022 10302002
         TM    DEBOPATB,OUTINOUT        TEST TYPE OF I/O          OC022 10304002
         BO    AMCL2040                 BRANCH IF OUTPUT          OC022 10306020
         IC    RWK7,DCBOFFSR            GET READ CCW OFFSET       OC022 10310002
AMCL2040 EQU   *                        BUFFER CLEARING LOOP      OC022 10314020
         LA    RWK4,0(RWK7,RIOB)        GET TO RD/WRT CCW ADDR          10320002
         USING CCW,RWK4                                                 10330002
         L     RWK4,CCWADDRA            GET BUFFER ADDRESS              10340002
         DROP  RWK4                                                     10350002
         LA    RWK4,0(RWK4)             HIGH BYTE CLEARED               10360002
         TM    DEBOPATB,RDBACKB         IS DCB OPENED FOR READ BACKWARD 10400002
         BNM   AMCL2070                 IF NOT, BRANCH.                 10420002
         LH    RWK1,DCBBLKSI            GET SIZE OF ONE BUFFER AND      10440002
         BCTR  RWK1,0                   DECREMENT BY ONE.               10460002
         SR    RWK4,RWK1                POINT TO BEGINNING OF BUFFER.   10480002
         B     AMCL2080                 CONT PROC READ BACKWARD  S19017 10490002
AMCL2070 EQU   *                                                        10520020
         CLI   DCBDEVT,DCBDVOR5         CHECK FOR A              S19017 10521002
         BL    AMCL2080                 1285, 1287, OR 1288      S19017 10522020
         CLI   DCBDEVT,DCBDVOR8         DCBDEVT IS 5A,5B,OR 5C   S19017 10523002
         BH    AMCL2080                 IF NOT, CONT PROCESSING  S19017 10524002
         DROP  RIOB                                                     10524402
         USING CCW+(IOBQSAMN-IOBEXTEN-L'CCW),RWK3  ADDRESSABILITY TO    10524802
*                                                    SECOND CCW IN C.P. 10524902
         LH    RWK1,CCWBYTE             OTHERWISE, LOAD COUNT    S19017 10525002
         DROP  RWK3                                                     10525402
         USING IOBQSAMN,RIOB                                            10525802
         TM    DCBRECFM,DCBRECF         F OR U FORMAT RECORDS           10526002
         BO    AMCL2075                 YES, BRANCH                     10527020
         AH    RWK1,RDWLEN              ADD 4 TO COUNT FOR       S19017 10530002
AMCL2075 EQU   *                           VAR RECS              S19017 10531002
         BCTR  RWK1,0                   DECREMENT BY 1 TO        S19017 10532002
*                                         ACCT FOR RD                   10532402
         SR    RWK4,RWK1                POINT TO BEGIN OF BUFFER S19017 10533002
AMCL2080 EQU   *                                                 S19017 10535020
         USING BUFFER,RWK4                                              10545002
         MVC   BUFNXPTB,BCBBUFAD        UPDATE LAST BUF WITH NEW ONE    10560002
         ST    RWK4,BCBBUFPT            UPDATE BUFFER POOL CNRL BLK     10580002
         L     RIOB,IOBNIOBA            GET NEXT IOB IN CHAIN           10600002
         BCT   RWK6,AMCL2040            IF MORE IOB'S FREE BUF'S  OC022 10620002
         SPACE 2                                                        10670002
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 10672002
         SPACE 2                                                        10674002
         OI    FCACLOS1,FCACBUFP        BUFFERS RET TO POOL      Y02072 10676002
         SPACE 2                                                        10678002
         MODESET  KEYADDR=DXUKEY,WORKREG=13  BACK TO USER KEY    Y02072 10678402
         SPACE 2                                                        10678802
*                                                                       10680020
* PREPARE TO FREE SPACE REQUIRED FOR IOB/ICB S                          10700002
*                                                                       10720020
AMCL3000 EQU   *                                                        10740020
         SR    RWK5,RWK5                INITIALIZE REGISTERS            10760002
         SR    RWK1,RWK1                                                10780002
         SR    RWK2,RWK2                                                10800002
         IC    RWK1,DCBIOBL             GET LEN OF IOB/ICB (DBL WRDS)   10820002
         SLL   RWK1,3                   GET LEN IN BYTES                10840002
         IC    RWK2,DCBNCP              GET NUMBER OF BSAM CP.S         10860002
         TM    DCBCIND2,DCBCNQSM        IS QSAM BEING USED              10880002
         BZ    AMCL3010                 NO BRANCH                       10900002
         IC    RWK2,DCBBUFNO            GET NUMBER OF QSAM CP.S         10940002
AMCL3010 EQU   *                                                        10980020
         TM    DCBCIND2,DCBCNCHS        WAS DCB USING PCI SCHEDULING    11020002
         BO    AMCL3050                 YES BRANCH                      11040002
AMCL3020 EQU   *                                                        11080020
         TM    IOBNFLG1,IOBFIRST        THIS THE FIRST IOB IN CHAIN     11120002
         BO    AMCL3060                 YES BRANCH                      11140002
         L     RIOB,IOBNIOBA            GET NEXT IOB                    11160002
         B     AMCL3020                 CONTINUE TO LOOP                11180020
AMCL3050 EQU   *                                                        11240020
         L     RIOB,DCBIOBAD            GET MAIN IOB ADDRESS            11260002
         LA    RIOB,0(RIOB)             CLEAR HIGH BYTE                 11280002
         LA    RWK5,MIOBSIZE            CNST OF 48 FOR MIOB             11300002
AMCL3060 EQU   *                                                        11400020
         LTR   RWK2,RWK2                WERE NO. OF CP SPECIFIED        11420002
         BP    AMCL3065                 YES, BRANCH                     11440002
         LA    RWK2,DEFLTCP             NO, PROVIDE ONE                 11460002
AMCL3065 EQU   *                                                        11480020
         MR    RWK1,RWK1                NUMBER OF CP'S X IOB/ICB SIZE   11500002
         LA    RWK4,0(RWK2,RWK5)        ADD ANY PCI CNSTS REQ    Y02072 11540002
*                                                                       11560020
         FREEMAIN R,LV=(RWK4),A=(RIOB),SP=0  FREE IOB/ICB SPACE  Y02072 11580002
         SPACE 2                                                        11590002
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 11600002
         SPACE 2                                                        11602002
         OI    FCACLOS1,FCACIOB         IOBS FREED               Y02072 11604002
         SPACE 2                                                        11606002
         MODESET  KEYADDR=DXUKEY,WORKREG=13  BACK TO USER KEY    Y02072 11608002
         SPACE 2                                                        11608402
*                                                                       11610002
* THE FOLLOWING CODE FREES UP THE 2K SPACE FOR THE FCR TABLE    XL03127 11620002
* USED BY THE 3886 OCR DEVICE                                   XL03127 11630002
*                                                                       11640002
         CLI   DCBDEVT,OCR3886          IS DEVICE A 3886 OCR    XL03127 11650002
         BNE   AMCL5000                 NO,BRANCH AROUND        XL03127 11700002
         L     RIOB,DCBFRTBA            GET FCR TABLE PTR       XL03127 11750002
         LA    RWK4,FCRTBLSZ            TABLE SIZE 2048 BYTES    Y02072 11760002
         XC    DCBFRTBA,DCBFRTBA        CLEAR OUT PTR FIELD     XL03127 11770002
         FREEMAIN R,LV=(RWK4),A=(RIOB),SP=0   FREE FCR TABLE     Y02072 11772002
         SPACE 2                                                        11774002
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 11774402
         SPACE 2                                                        11774802
         OI    FCACLOS1,FCACFCR         FCR FREED                Y02072 11775202
         SPACE 2                                                        11775602
         MODESET  KEYADDR=DXUKEY,WORKREG=13  BACK TO USER KEY    Y02072 11775702
         SPACE 2                                                        11775802
         MVI   DCBLNNUM,0               CLEAR FIELD             XL03127 11788002
         MVI   DCBLFMAT,DCBLNFMT        RESET FIELD             XL03127 11798002
         EJECT                                                          11798402
*                                                                       11800020
* THIS SECTION OF CODE CLEARS BSAM/QSAM VECTORS IN DCB                  11820002
*                                                                       11880020
AMCL5000 EQU   *                                                        11900020
         SR    RWK2,RWK2                CLEAR REGISTER           A45280 11930002
         SR    RWK6,RWK6                                                11940002
         IC    RWK6,DEBNMEXT            NUMBER OF EXTENTS        A45280 11950002
         IC    RWK2,DEBEXSCL            OBTAIN SCALING FACTOR    A45280 11952002
         SLL   RWK6,0(RWK2)             LNGTH OF DEB EXTENT AREA A45280 11954002
         LA    RWK6,DEBBASND-DEBBASIC(RWK6,RDEB)  POINT TO       A45280 11956002
*                                         ACCESS METHOD SECTION         11956402
         USING DEBACSMD,RWK6                                            11956802
         MVC   DCBLRECL,DEBLRECL        RESTORE LRECL            A45280 11958002
         DROP  RWK6                                                     11958102
         SR    RWK6,RWK6                CLEAR REGISTER           A45280 11958402
         ST    RWK6,DCBWCPO             CLEAR OFFSET FIELDS             11960002
         LA    RWK6,INVALADD            TO SET AN INVALID ADDR   Y02072 11970002
         ST    RWK6,DCBIOBA             IOB VECTOR CLEARED              11980002
         ST    RWK6,DCBIOBAD            IOB FOR PCI CLEARED    @Z30TSMI 11982003
         ST    RWK6,DCBEOBW             WRITE EOB VECTOR CLEARED Y02072 11990002
         STCM  RWK6,B'0111',DCBCNTRL+1  CNTRL MOD VECTOR CLEARED Y02072 11992002
         STCM  RWK6,B'0111',DCBEOBRA    READ EOB VECTOR CLEARED  Y02072 11994002
         STCM  RWK6,B'0111',DCBREAD+1   READ MOD VECTOR CLEARED  Y02072 11996002
         TM    DCBOFLGS,DCBOFEOV        CONCATENATION UNLIKE ATTRIBUTES 12060002
         BO    AMCL5005                 YES BRANCH                      12080002
         STCM  RWK6,B'0111',DCBPERRA    ERR RTN VECTOR CLEARED   Y02072 12090002
AMCL5005 EQU   *                                                        12180020
         TM    DCBCIND2,DCBCNQSM        WAS QSAM USED                   12200002
         BZ    AMCL5006                 NO BRANCH                       12220002
         ST    RWK6,DCBEOB              CLEAR VECTOR                    12260002
AMCL5006 EQU   *                                                        12300021
         TM    DCBCIND1,DCBCNBRM        WAS BLK REC BIT TURNED   A45221 12322021
*                                         OFF DURING OPEN?       A45221 12324021
         BZ    AMCL5008                 NO, BR AROUND            A45221 12326021
         OI    DCBRECFM,DCBRECBR        YES, RESTORE BIT         A45221 12328002
         NI    DCBCIND1,X'FF'-DCBCNBRM  RESET BIT               SA67354 12328102
AMCL5008 EQU   *                                                 A45221 12328421
         NI    DCBCIND1,CLEARIND        CLEAR SAM INDICATOR      A40495 12330002
         NI    DCBCIND2,DCBCNFEO        RESET ALL BUT FEOV INDIC A40495 12340002
         CLI   DCBDEVT,DCBDVOR5         CHECK FOR A              S19017 12384002
         BL    AMCL5010                  1285, 1287, OR 1288     S19017 12386020
         CLI   DCBDEVT,DCBDVOR8         DCBDEVT IS 5A,5B,OR 5C   S19017 12388002
         BH    AMCL5010                 IF NOT, CONTINUE         S19017 12390002
         XC    DCBDSPLA,DCBDSPLA        CLEAR DCBDSPLY (+13)     S19017 12392002
         XC    DCBRESCA,DCBRESCA        CLEAR DCBRESCN (+17)     S19017 12394002
         EJECT                                                          12396002
AMCL5010 EQU   *                                                 S19017 12398020
         SPACE 2                                                        12408002
         MODESET  EXTKEY=DATAMGT        BACK TO DATA MANAG KEY   Y02072 12448002
         SPACE 2                                                        12498002
         TM    FCACLOS1,FCACFORC        FORCE CLOSE IN CONTROL   Y02072 12498102
         BNO   XCTL                     NO, CONTINUE NORMAL PATH Y02072 12498202
         SR    R15,R15                  RET CD FOR FC EXEC TO    Y02072 12498302
*                                         PASS TO CLOSES TRR     Y02072 12498802
         L     RBRNCH,24(RPAR)          GET RETURN ADDR        @AZ09146 12500037
         BR    RBRNCH                   RETURN TO FORCE CLO EXEC Y02072 12503702
XCTL     EQU   *                        NON-FORCE CLOSE PATH     Y02072 12505702
         MVI   WTGENTRY,0               CLEAR WTG ENTRY          Y02072 12507702
RELOOP   EQU   *                                                        12514602
         LA    RWTGC,L'WTGENTRY(,RWTGC)  STEP TO NEXT ENTRY             12520002
         LA    RPARC,L'PARDCBAD(,RPARC)  STEP TO NEXT ENTRY             12540002
         CLC   WTGIDNX,AMIDCNST         THIS ROUTINE NEEDED AGAIN       12560002
         BCR   8,RBASE                  RECURSE THRU MODULE             12580020
         CLC   WTGIDNX,CLLDB            IS THIS THE END OF THE TABLE    12600002
         BL    RELOOP                   NO BRANCH                       12620002
         CLC   WTGIDNX,CLLDG            IS THIS THE END OF THE TABLE    12640002
         BH    RELOOP                   NO BRANCH                       12660002
         LR    RPARC,RPAR               INITIALIZATION                  12680020
         DROP  RWTGC                                                    12690002
         LA    RWTGC,WTGENTRY                                           12700002
         USING WTGENTRY,RWTGC                                           12710002
AMCL5011 EQU   *                                                        12720020
         CLI   WTGIDTTR,CLOSEFIN        IS THIS ENTRY = ZERO?           12740002
         BNE   AMCL5019                 NO BRANCH                       12760002
         LA    RWTGC,L'WTGENTRY(,RWTGC) NEXT ENTRY IN WTG TAB           12780002
         LA    RPARC,L'PARDCBAD(,RPARC) NEXT DCB ADDRESS                12800002
         B     AMCL5011                                                 12820020
AMCL5019 EQU   *                                                        12860020
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSMI*12920003
               MODID=WTGENTRY           GO TO NEXT ROUTINE     @Z30TSMI 12970003
         EJECT                                                          12990002
*                                                                       12992002
*CONSTANTS                                                              12994002
*                                                                       12996002
AMIDCNST DC    C'1X'                                                    13000002
RDWLEN   DC    H'4'                     USED AS A CONST OF 4     S19017 13070002
*                                         IN A AH INST                  13120002
CLLDB    DC    C'0B'                    MOD ID                   Y02072 13200002
CLLDG    DC    C'0G'                    MOD ID                   Y02072 13220002
         SPACE                                                          13260002
PATCH    DC    25H'0'                   PATCH AREA               YM4640 13270002
END      EQU   *                        END OF MODULE            Y02072 13280002
         TITLE 'IGG0201X - FORECORE DSECT'                              13330002
         IECDSECS  (MAIN,(IOB,NO)),EXPAND=YES                    Y02072 13340002
         EJECT                                                          13410002
         IGGSCW                                                         13420002
         TITLE 'IGG0201X - DSECT FOR AUDIT TRAIL'                       13430002
         IHAFCAUD  ORG=YES                                       Y02072 13440002
         TITLE 'IGG0201X - DCB DSECT'                                   14060002
         DCBD  DSORG=PS                                                 14080020
         TITLE 'IGG0201X - BUFFER CONTROL BLOCK DSECT'                  14100002
         IGGBCB                                                         14110002
         TITLE 'IGG0201X - CCW DSECT'                                   14114002
         IHACCW DSECT=YES                                               14116002
         TITLE 'IGG0201X - CVT DSECT'                                   14118003
CVT      DSECT                                                          14118103
         CVT                                                            14118203
         TITLE 'IGG0201X - IOB DSECT'                                   14118402
         IEZIOB                                                         14118802
         TITLE 'IGG0201X - WHERE TO GO TABLE DSECT'                     14119902
         IECDSECS WTG,PREFX,EXPAND=YES                                  14169903
         ORG   WTG+8                                             Y02072 14171902
WRKRETRN DS    F                        FORCE CLOSE RET ADDR     Y02072 14173902
         ORG   WTGIDTTR                                                 14179902
WTGIDNX  DS    CL2                      ID NEXT MODULE                  14181902
WTGTTRNX DS    CL3                      TTR NEXT MODULE                 14183902
         ORG   WTGIDTTR+4                                               14185902
WTGDCBWA DS    A                        WORK AREA ADDRESS CURRENT DCB   14187902
         TITLE 'IGG0201X - CLOSE PARAMETER LIST DSECT'                  14188302
         IGGPARML                                                       14188702
         TITLE 'IGG0201X - DEB DSECT'                                   14189902
         IEZDEB                                                         14199902
         END                                                            14209937
