     TITLE 'IGG0201Y - SAM/PAM CLOSE EXECUTOR, DIRECT ACCESS - LOAD 2'  00060002
IGG0201Y CSECT                                                          00120019
*                                                                       00122002
*MODULE NAME - IGG0201Y                                                 00124002
*                                                                       00126002
*DESCRIPTIVE NAME - RESTORE RESOURCES AND CLEAN UP FOR DA               00128002
*                                                                       00128402
*STATUS CHANGE LEVEL 006                                                01160002
*                                                                     * 01210019
*FUNCTION - THE FOLLOWING FUNCTIONS WILL BE PERFORMED BY THIS  CLOSE    01400002
*           EXECUTOR FOR BSAM, QSAM AND BPAM DATA SETS-DIR. ACC. DEV.   01500002
*           * FREES SEGMENT WORK AREA FOR DCB'S WHICH SPECIFY BFTEK=R,  01600002
*             RECFM=VS,MACRF=WL                                         01700002
*           * IT WILL RETURN ALL BUFFERS TO THE BUFFER POOL IF GOTTEN   01750002
*             BY OPEN AND SIMPLE BUFFERING                              01800002
*           * IF WILL FREEMAIN ALL BUFFERS FOR DATA SETS WITH CONCAT-   01850002
*             ENATION OF UNLIKE ATTRIBUTES                              01900002
*           * IT WILL FREE THE RECORD AREA IF OPEN HAD ACQUIRED IT      02300002
*           * CLEAR FIELDS IN THE DCB SO THAT IT CAN'T BE USED UNLESS   02400002
*             IT IS OPENED AGAIN                                        02500002
*           * FREEMAIN THE AREA GOTTEN FOR THE CONSTRUCTION OF IOB'S    02600002
*           * SETS APPROPRIATE AUDIT TRAIL BITS IN THE O/C/E     Y02072 02650002
*             WORKAREA IN CASE THE USERS STAE ROUTINE SHOULD GET Y02072 02700002
*             CONTROL DURING A FORCE CLOSE SITUATION. (THESE     Y02072 02750002
*             BITS, ALTHOUGH SET DURING NORMAL CLOSE, HAVE NO    Y02072 02850002
*             MEANING).                                          Y02072 02860002
*                                                                       02900019
*ENTRY POINT - FROM IGG0201Z OR IGG0201B                                03000003
*                                                                       03100019
*INPUT - SEE DESCRIPTION OF REGISTERS, DCB(USERS), IOB(USERS).          03200002
*                                                                       03300019
*OUTPUT - NONE                                                          03400002
*                                                                       03500019
*EXTERNAL ROUTINES - NONE                                               03600002
*                                                                       03700019
*MACROS : MAPPING - IECDSECT, IECDSECS, DCBD, IGGBCB, IHACCW, IHAFCAUD, 03750002
*                   IEZIOB, IGGPARML, IGGSWA, IEZDEB, IGGSCW            03760002
*                                                                       03770002
*MACROS : ACTION - FREEMAIN, IECRES, MODESET                            03780003
*                                                                       03790002
*EXITS-NORMAL - TO IGG0200B, IGG0200G                                   03800003
*                                                                       03900019
*EXITS-ABNORMAL - BR 14 TO RETURN TO THE FORCE CLOSE EXECUTOR    Y02072 03910002
*                                                                       04100019
*TABLES/WORKAREAS- WHERE TO GO TABLE (WTG)                              04200019
*                                                                       04300019
*      BYTE  0-7  NAME                                                  04400019
*      BYTE  8-10 RELATIVE DISK ADDRESS(TTR) OF FIRST RECORD            04500019
*      BYTE 11    CONCATENATION NUMBER                                  04600019
*      BYTE 12    ZERO                                                  04700019
*      BYTE 13    ALIAS INDICATOR AND USER DATA FIELD DESCRIPTOR.       04800019
*                        ALIAS INDICATOR 1 BIT                          04900019
*                        NUMBER OF TTRS IN USERS DATA FIELD 2 BITS      05000019
*      BYTE 14-16 TTR OF FIRST TEXT RECORD                              05100019
*      BYTE 17    ZERO                                                  05200019
*      BYTE 18-19 TTR OF NOTE LIST OR SCATTER LIST                      05300019
*      BYTE 20    TRANSLATION TABLE                                     05400019
*      BYTE 21    ZERO OR NUMBER OF ENTRIES IN THE NOTE LIST            05500019
*      BYTE 22-23 ATTRIBUTES                                            05600019
*      BYTE 24-26 TOTAL CONTIGUOUS MAIN STORAGE REQUIRED FOR MODULE     05700019
*      BYTE 27-28 LENGTH OF FIRST TEXT RECORD                           05800019
*      BYTE 29    LENGTH OF WTG TABLE (IN DOUBLE WORDS)                 05900019
*      BYTE 30-31 PATH THROUGH LOADS OF ROUTINES                        06000019
*      BYTE 32-36 IDTTR OF EXECUTOR FOR FIRST DCB                       06100019
*      BYTE 37-39 WORKAREA ADDRESS FOR FIRST DCB                        06200019
*      BYTE 40-   TABLE OF IDTTR'S                                      06300019
*      BYTE 32+N(8) IDTTR OF EXECUTOR FOR N TH DCB   (5 BYTES)          06400019
*                   WORKAREA ADDRESS FOR N TH DCB    (3 BYTES)          06500019
*                   IDTTR OF LAST ROUTINE LOAD       (5 BYTES)          06600019
*                   NOT USED                         (3 BYTES)          06700019
*                                                                       06800019
*      CLOSE WORK AREA                                                  06900002
*                                                                       07000019
*ATTRIBUTES- REENTRANT, REUSABLE, RUNS IN USER KEY UNLESS        Y02072 07100002
*            OTHERWISE SPECIFIED, SUPERVISOR STATE               Y02072 07150002
*                                                                       07200019
*NOTES - ALL REGISTER EQUATES BEGIN WITH THE CHARACTER R.               07250002
*      - THIS MODULE CREATED AT RELEASE 19 BY SPLIT OF IGG0201Z         07300002
*      - THE DEB ADDRESS IS GOTTEN FROM THE PROTECTED DCB FOR    Y02072 07300402
*        INTEGRITY REASONS.                                      Y02072 07300802
*                                                                       07302002
*CHANGE ACTIVITY - AS FOLLOWS:                                          07310002
*                                                                     * 07320002
*          VS2 RELEASE 01 DELETIONS                                     07330002
*D173000-174000                                                YM0928   07340002
*                                                                       07342002
*          VS2 RELEASE 02 DELETIONS                                     07344002
*001100,001800,001984,011600,037800,071000,146500-147020,147620, Y02072 07346002
*148500-149600,190000,210000,226500-228600,311000,343500,343700, Y02072 07348002
*452000-453000,389500-393100,71500,430000-432000,444000,87000,   Y02072 07348402
*188000,208800,222080,222240,248000-259500,309810                Y02072 07348802
*436000-450000,123900,291300-291600,305160-305240,               Y02072 07348902
*                                                                YM4640 07349002
*                                                                YM2852 07349102
*                                                                YM5782 07351602
*                                                                YM6889 07353602
*                                                                       07354102
*          VS2 RELEASE 03 DELETIONS                                     07356103
*                                                              @Z30TSMI 07356503
*000039150002                                                  @ZA09146 07359337
*          VS1 RELEASE 01 DELETIONS                                     07362603
*                                                                       07365403
*          RELEASE 20 DELETIONS                                       * 07368203
*3575222200                                                      A36765 07371003
*3575292000-293000,306000                                        S20201 07373803
*3575282000                                                      M2526  07376602
*          RELEASE 21 DELETIONS                                       * 07378602
*0932                                                            A48163 07380602
*0932282200                                                      A42903 07382602
*0932                                                            A45280 07383002
* 387000                                                         A40495 07383102
*D281400,282200-282600                                          SA52447 07383202
*                                                               SA51596 07388802
*                                                               SA53272 07390802
         EJECT                                                          07394402
*                                                                       07400019
* REGISTER USAGE                                                        07500002
*                                                                       07600019
RWK1     EQU   0                        WORK REGISTER                   07700002
R1       EQU   1                        PARAMETER REGISTER              07750002
RWK2     EQU   R1                       WORK REGISTER                   07800002
RDCB     EQU   2                        ADDR OF USERS DCB               07900019
RBASE    EQU   3                        BASE REGISTER                   08000019
RCORE    EQU   4                        ADDR OF CLOSE WORK AREA         08100019
RPAR     EQU   5                        PARAMETER LIST                  08200019
RWTG     EQU   6                        START OF WTG                    08300019
RPARC    EQU   7                        CURRENT ENTRY IN PARAMETER LIST 08400019
RWTGC    EQU   8                        CURRENT ENTRY IN WTG TABLE      08500019
RWK3     EQU   9                        WORK REGISTER                   08600002
RWK8     EQU   10                       WORK REGISTER            Y02072 08700002
RDEB     EQU   11                       DEB ADDRESS                     08800019
RIOB     EQU   12                       IOB REGISTER                    08900002
RWK4     EQU   13                       WORK REGISTER                   09000002
RWK5     EQU   14                       WORK REGISTER                   09100002
RBRNCH   EQU   RWK5                     RETURN REG TO CLOSES TRR Y02072 09150002
R15      EQU   15                       PARAMETER REGISTER              09200002
RWK6     EQU   R15                      WORK REGISTER                   09250002
         EJECT                                                          09260002
*                                                                       09300019
* EQUATES FOR CONSTANTS                                                 09350002
*                                                                       09360002
RDBACKB  EQU   X'03'                    USED TO TEST OPEN ATTRIBUTES    10000019
UPDATE   EQU   X'04'                    OPEN ATTRIBUTE = UPDAT          11900019
OUTINOUT EQU   X'07'                    OPEN ATTR, OUT/OUTIN            12000002
SETSC    EQU   X'23'                    SET SECTOR CCW CMND      S20201 12101420
DA       EQU   X'20'                    DIRECT ACCESS MASK       S20201 12103520
MIOBLEN  EQU   48                       LENGTH OF IOB                   12190002
CLOSEFIN EQU   X'00'                    CLOSE EXEC PROCESSING COMPLETED 12240002
DEFBUFNO EQU   1                        BUFNO NOT SPECIFIED, DEFAULT 1  12290002
ROUNDCNT EQU   8                        FOR ROUNDING             Y02072 12390002
INVALADD EQU   1                        USED TO INVALIDATE       Y02072 12400002
*                                         ADDRESS VECTORS        Y02072 12410002
CPOFSETN EQU   X'30'                    OFFSET TO CP IN NORMAL   Y02072 12420002
*                                         SCHEDULING IOB         Y02072 12430002
CPOFSETC EQU   X'38'                    OFFSET TO CP IN CHAINED  Y02072 12432002
*                                         SCHEDULING IOB         Y02072 12434002
         EJECT                                                          12440002
*                                                                       12490002
* ADDRESSABILITY                                                        12540002
*                                                                       12590002
         USING WTG,RWTG                                                 14360002
         USING WTGENTRY,RWTGC                                           14370002
         BALR  RBASE,0                  ESTABLISH BASE                  14380002
         USING AMCL,RBASE               ESTABLISH ADDRESSIBILITY        14390002
*                                                                       14400019
AMCL     EQU   *                                                        14500019
         B     BEGIN                    BRANCH AROUND MODULE ID  YM4640 14502002
         DC    C'IGG0201Y'              MODULE NAME              YM4640 14504002
         DC    C'@Z30TSMI'              LAST SHIP CODE         @Z30TSMI 14506003
         DC    C'10/15/74'              LAST DATE MODIFIED     @Z30TSMI 14508003
BEGIN    DS    0H                       END OF MODULE ID         YM4640 14510002
*                                                                       14600019
         L     RCORE,WTGDCBWA           GET DCB'S WORK AREA      Y02072 14650002
         USING FORCORE,RCORE            ESTABLISH ADDRESSIBILITY Y02072 14660002
         L     RDCB,DXPDCBAD            GET PROTECTED DCB ADDR   Y02072 14662002
         USING IHADCB,RDCB                                       Y02072 14664002
         L     RDEB,DCBDEBAD            GET VALID DEB ADDR       Y02072 14666002
         USING DEBBASIC,RDEB                                            14668002
         MODESET  KEYADDR=DXUKEY,WORKREG=10                      Y02072 14670002
         SPACE                                                          14680002
         L     RDCB,DXUDCBAD            GET DCB BEING CLOSED     Y02072 14700002
         L     RIOB,DCBIOBA             GET CURR IOB/ICB ADDRESS        15000002
         LA    RIOB,0(RIOB)             CLEAR HIGH ORDER BYTE           15100002
         SR    RWK3,RWK3                CLEAR WORK REG                  15300002
         IC    RWK3,DCBOFFSW            GET WRITE CCW OFFSET            15400002
         TM    DEBOPATB,OUTINOUT        TEST IF OUTPUT/OUTIN            15600002
         BO    SKIPGO                   YES, RWK3 HAS WRITE OFFSET      15700002
         TM    DEBOPATB,UPDATE          TEST IF UPDATE                  15900019
         BO    SKIPGO                   YES, RWK3 HAS WRITE OFFSET      16000002
         IC    RWK3,DCBOFFSR            GET READ  CCW OFFSET            16200002
SKIPGO   EQU   *                                                        16400019
         TM    DCBCIND2,DCBCNQSM        DCB USING QSAM                  16700002
         BZ    AMCL3000                 NO BRANCH                       16800019
         TM    DCBCIND1,DCBCNEXB        EXCHANGE BUFFERING USED         17000002
         BO    AMCL3000                 YES BRANCH                      17100019
         L     RWK5,DCBBUFCB            GET BUFFER POOL CNTRL BLK       17500002
*                                                                       17600019
* IF A RECORD AREA WAS ACQUIRED BY OPEN, IT SHOULD BE RETURNED TO       17700019
* THE SUPERVISOR.                                                       17800019
*                                                                       17900019
         LA    RWK5,0(RWK5)             CLEAR HIGH ORDER BYTE           18000002
         USING BCBLK,RWK5                                               18050002
         TM    BCBFLGS,BCBLRI           RECORD AREA INDICATOR ON        18100002
         BZ    AMCL2010                 BRANCH NO TO CHECK OFLGS        18200019
         TM    DCBCIND2,DCBCNBFP        DID OPEN ACQUIRE POOL           18400002
         BZ    AMCL2010                 BRANCH NO TO CHECK OFLGS        18500019
         L     R1,BCBLRIAR              GET RECORD AREA ADDRESS         18700002
         USING LRILOC,R1                                                18750002
         L     RWK8,LRILGTH             GET LEN OF RECORD AREA   Y02072 18800002
         LA    RWK8,0(RWK8)             CLR HI BYT FOR OR INST   YM6889 18810002
         DROP  R1                                                       18850002
         SPACE 2                                                        18900002
         FREEMAIN R,LV=(RWK8),A=(1),SP=0  FREE RECORD AREA       Y02072 19000002
         SPACE 2                                                        19110002
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 19150002
         SPACE 2                                                        19152002
         OI    FCACLOS1,FCACRECA        INDIC REC AREA FREED     Y02072 19160002
         SPACE 2                                                        19162002
         MODESET  KEYADDR=DXUKEY,WORKREG=10  BACK TO USER KEY    Y02072 19170002
         SPACE 2                                                        19180002
         NI    BCBFLGS,X'FF'-BCBLRI     TURN OFF RECORD AREA FLAG       19200002
         XC    BCBLRIAR,BCBLRIAR        CLEAR RECORD AREA  ADDRESS      19300002
AMCL2010 EQU   *                                                        19500019
         TM    DCBOFLGS,DCBOFEOV        CONCATENATION UNLIKE ATTRIBUTES 19700002
         BZ    AMCL2040                 NO BRANCH TO FREE BUFFERS       19800019
         TM    DCBCIND2,DCBCNBFP        DID OPEN ACQUIRE POOL           20000002
         BZ    AMCL2040                 NO BRANCH AROUND FREEMAIN       20100002
*                                                                       20200019
* FREE BUFFER POOL  OPEN WILL ACQUIRE A NEW ONE LATER                   20300002
*                                                                       20400019
         SR    RWK6,RWK6                CLEAR REGISTER           YM0928 20450002
         IC    RWK6,DCBBUFNO            GET NUMBER OF BUFFERS    YM0928 20460002
*                                        TO BE FREED                    20470002
         LA    R1,BCBLK                 GET CNTRL BLK ADDRESS TO FREE   20500002
         LH    RWK5,BCBBUFSZ            GET BUFFER SIZE                 20600002
         DROP  RWK5                                                     20650002
         USING BCBLK,RWK2                                               20660002
         MR    RWK5,RWK5                TOTAL AMT REQUIRED FOR BUFFERS  20700002
         LA    RWK8,BCBNLN(RWK6)        ADD EIGHT FOR CNTRL BLK  Y02072 20800002
         TM    BCBFLGS,BCBEXTND         BUFCB 16 BYTES           A48163 20850002
         BZ    FREEPOOL                 NO,BUFCB IS 8 BYTES      A48163 20870021
         LA    RWK8,BCBEXLN(RWK8)       ADD EIGHT FOR EXTENDED   Y02072 20880002
*                                         CONTROL BLOCK                 20890002
         DROP  RWK2                                                     20890402
FREEPOOL EQU   *                                                        20892021
         SPACE 2                                                        20900002
         FREEMAIN R,LV=(RWK8),A=(1),SP=0    FREE BUFFER POOL     Y02072 21000002
         SPACE 2                                                        21100002
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 21150002
         SPACE 2                                                        21160002
         OI    FCACLOS1,FCACBUFC        INDIC BUF POOL FREED     Y02072 21170002
         SPACE 2                                                        21180002
         MODESET  KEYADDR=DXUKEY,WORKREG=10  BACK TO USER KEY    Y02072 21190002
         SPACE 2                                                        21192002
         XC    DCBBUFCA,DCBBUFCA        CLEAR ADDRESS IN DCB            21200002
         OI    DCBBUFCB+3,1             SET INVALID ADDRESS             21300002
         B     AMCL3000                 BRANCH TO FREE IOB              21400019
*                                                                       21900019
* SIMULATE THE FREE BUFFER MACRO TO RETURN BUFFERS TO POOL              22000002
*                                                                       22100019
AMCL2040 EQU   *                                                        22200019
         CLI   DCBBUFNO,0               TEST IF BUFNO PRESENT    A36765 22218002
         BE    AMCL3000                 BRANCH IF NO BUFFERS     A36765 22224002
         SR    RWK6,RWK6                CLEAR REG                       22240002
         IC    RWK6,DCBBUFNO            GET NUMBER OF BUFFERS TO FREE   22260002
         L     RWK5,DCBBUFCB            GET BUFFER POOL CNTRL BLK       22280002
         USING BCBLK,RWK5                                               22290002
AMCL2050 EQU   *                                                        22320019
         LA    RWK4,0(RWK3,RIOB)        GET TO RD/WRT CCW ADDR          22400002
         USING CCW,RWK4                                                 22450002
         L     RWK4,CCWADDRA            GET BUFFER ADDRESS              22500002
         LA    RWK4,0(RWK4)             HIGH BYTE CLEARED               22600002
         TM    DEBOPATB,RDBACKB         IS DCB OPENED FOR READ BACKWARD 22900002
         BNM   AMCL2070                 IF NOT, BRANCH.                 23000019
         LH    RWK1,DCBBLKSI            GET SIZE OF ONE BUFFER AND      23100002
         BCTR  RWK1,0                   DECREMENT BY ONE.               23200002
         SR    RWK4,RWK1                POINT TO BEGINNING OF BUFFER.   23300002
AMCL2070 EQU   *                                                        23500019
         USING BUFFER,RWK4                                              23550002
         MVC   BUFNXPTB,BCBBUFAD        UPDATE LAST BUF WITH NEW ONE    23700002
         ST    RWK4,BCBBUFPT            UPDATE BUFFER POOL CNRL BLK     23800002
         USING IOBQSAMN,RIOB                                            23850002
         L     RIOB,IOBNIOBA            GET NEXT IOB/ICB IN CHAIN       23900002
         BCT   RWK6,AMCL2050            IF MORE IOBS/ICBS, LINK BUFFERS 24000002
         SPACE 2                                                        24050002
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 24100002
         SPACE 2                                                        24150002
         OI    FCACLOS1,FCACBUFP        INDIC BUF RET TO POOL    Y02072 24200002
         SPACE 2                                                        24250002
         MODESET  KEYADDR=DXUKEY,WORKREG=10  BACK TO USER KEY    Y02072 24260002
         SPACE 2                                                        24270002
*                                                                       24300019
* PREPARE TO FREE SPACE REQUIRED FOR IOB'S/ICB'S                        24400002
*                                                                       24500019
AMCL3000 EQU   *                                                        24600019
         SR    RWK5,RWK5                CLEAR REG                       26100002
         SR    RWK1,RWK1                CLEAR REG                       26200002
         SR    RWK2,RWK2                CLEAR REG                       26300002
         IC    RWK1,DCBIOBL             GET LEN OF IOB/ICB (DBL WRDS)   26400002
         SLL   RWK1,3                   GET LEN IN BYTES                26500002
         IC    RWK2,DCBNCP              GET NUMBER OF BSAM CP.S         26600002
         TM    DCBCIND2,DCBCNQSM        IS QSAM BEING USED              26700002
         BZ    AMCL3010                 NO BRANCH                       26800019
         IC    RWK2,DCBBUFNO            GET NUMBER OF QSAM CP.S         27000002
AMCL3010 EQU   *                                                        27200019
         TM    DCBCIND2,DCBCNCHS        WAS DCB USING PCI SCHEDULING    27400002
         BO    AMCL3050                 YES BRANCH                      27500019
AMCL3020 EQU   *                                                        27700019
         USING IOBQSAMN,RIOB                                            27750002
         TM    IOBNFLG1,IOBFIRST        THIS THE FIRST IOB IN CHAIN     27900002
         BO    AMCL3060                 YES BRANCH                      28000019
         L     RIOB,IOBNIOBA            GET NEXT IOB             M2526  28180002
         B     AMCL3020                 CONTINUE TO LOOP                28300019
         DROP  RIOB                                                     28350002
AMCL3050 EQU   *                                                        28700019
         L     RIOB,DCBIOBAD            GET MAIN IOB ADDRESS            28900002
         LA    RIOB,0(RIOB)             CLEAR HIGH BYTE                 29000002
         LA    RWK5,MIOBLEN             CNST OF 48 FOR MIOB             29100002
         USING CCW-CPOFSETC,RIOB        LOC OF 1ST CCW IN CP     Y02072 29150002
         CLI   CCWCOMCD,SETSC           RCD READY USED           S20201 29190002
         DROP  RIOB                                              Y02072 29200002
         BNE   AMCL3055                 BRANCH IF NO             S20201 29220020
         LA    RWK5,2*L'CCW(RWK5)       INCREMENT BY SIXTEEN FOR Y02072 29250002
*                                         SET SECTOR IN MIOB            29280002
AMCL3055 EQU   *                                                 S20201 29310020
         LA    RWK5,3*L'CCW+L'IOBSEEK(RWK5) TOTAL LENGTH OF MIOB FOR DA 29500002
         NI    DCBIFLGS,X'FF'-DCBIBIOE  TURN OFF 'NO RETRY'       14140 29600002
AMCL3060 EQU   *                                                        29800019
         LTR   RWK2,RWK2                WERE NO. OF CP SPECIFIED        30000002
         BP    AMCL3065                 YES, BRANCH                     30100019
         LA    RWK2,DEFBUFNO            NO, PROVIDE ONE                 30300002
AMCL3065 EQU   *                                                        30500019
         LR    RWK6,RWK2                SAVE NO. OF IOBS/ICBS    S20201 30532002
         TM    DCBMACF2,DCBMRWRT+DCBMRLDM  TEST BDAM CREATE     SA51596 30533002
         BNO   AMCL3067                 NO, BR AROUND TEST      SA51596 30534002
         USING IOBQSAMN,RIOB                                            30534102
         L     RWK3,IOBSTART            GET BEGIN OF CHAN PGM    YM5782 30534402
         DROP  RIOB                                                     30534502
         USING CCW,RWK3                                          YM5782 30534602
         CLI   CCWCOMCD,SETSC           IS RPS DEVICE USED       YM5782 30534802
         DROP  RWK3                                                     30535202
         BNE   AMCL3080                 NO, BRANCH OUT          SA51596 30536002
         B     AMCL3068                 ELSE ADD 8 TO IOB CORE  SA51596 30537002
AMCL3067 EQU   *                                                SA51596 30538021
         USING CCW-CPOFSETN,RIOB                                        30538402
         CLI   CCWCOMCD,SETSC           RCD READY USED           S20201 30540002
         DROP  RIOB                                                     30542002
         BNE   AMCL3080                 BRANCH NO                S20201 30548020
AMCL3068 EQU   *                                                SA51596 30552021
         TM    DEBOPATB,DEBACCS-UPDATE  ANY BITS OTHER THAN      S20201 30556002
*                                         UPDATE                 S20201 30564002
         BNZ   AMCL3070                 BRANCH IF YES            S20201 30572020
         TM    DEBOPATB,UPDATE          UPDATE BIT ON            S20201 30580002
         BNO   AMCL3070                 BRANCH IF NO             S20201 30588020
         LA    RWK6,ROUNDCNT(RWK6)      FOR UPDATE, ROUND UP     S20201 30596002
         SRL   RWK6,3                     NUMBER OF CHAN PGMS+1  Y02072 30612002
         SLL   RWK6,3                     TO GET NUM OF SECTORS  Y02072 30620002
         B     AMCL3075                 GO AROUND NEXT           S20201 30628020
AMCL3070 EQU   *                                                 S20201 30636020
         LA    RWK6,L'CCW               ONE DW                   S20201 30644002
AMCL3075 EQU   *                                                 S20201 30652020
         AR    RWK5,RWK6                INCREMENT CLEAR CORE     S20201 30660002
*                                         FOR SECTOR AREAS IN IOBS      30668002
AMCL3080 EQU   *                                                 S20201 30676020
         MR    RWK1,RWK1                NUMBER OF CP'S X IOB/ICB SIZE   30700002
         LA    RWK8,0(RWK2,RWK5)        ADD ANY CNSTS REQUIRED   Y02072 30900002
         TM    DCBMACF2,DCBMRWRT+DCBMRLDM TEST BDAM CREATE      SA53272 30909002
         BNO   AMCL3090                 NO, BRANCH OUT          SA53272 30918002
         TM    DCBRECFM,DCBRECTO        IS RECFM OVERFLOW       SA53272 30927002
         BNO   AMCL3090                 NO BRANCH OUT           SA53272 30936002
         LA    RWK8,10*L'CCW(,RWK8)     INCREMENT CORE TO        Y02072 30945002
*                                         INCLUDE ERASE CCWS    SA53272 30954002
         USING IOBQSAMN,RIOB                                            30954102
         L     RWK3,IOBSTART            GET BEGIN OF CHAN PGM    YM5782 30954402
         DROP  RIOB                                                     30954502
         USING CCW,RWK3                                                 30954602
         CLI   CCWCOMCD,SETSC           IS RPS DEVICE USED       YM5782 30954802
         DROP  RWK3                                                     30954902
         BNE   AMCL3090                 NO, BRANCH OUT           YM5782 30955202
         LA    RWK8,3*L'CCW(,RWK8)     ADD FOR RPS OVERFLOW      Y02072 30981002
AMCL3090 EQU   *                                                SA53272 30990000
         SPACE 2                                                        31000002
         FREEMAIN R,LV=(RWK8),A=(RIOB),SP=0  FREE IOB/ICB SPACE  Y02072 31100002
         SPACE 2                                                        31150002
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 31200002
         SPACE 2                                                        31250002
         OI    FCACLOS1,FCACIOB         INDIC IOBS FREED         Y02072 31300002
         SPACE 2                                                        31350002
         MODESET  KEYADDR=DXUKEY,WORKREG=10  BACK TO USER KEY    Y02072 31360002
         SPACE 2                                                        31370002
*                                                                       31400019
* THIS ROUTINE FREES SEGMENT WORK AREA FOR THE DCB WHICH SPECIFIES      31500002
* BFTEK=R,RECFM=VS,MACRF=WL                                             31600002
*                                                                       31900019
         TM    DCBMACF2,DCBMRWRT+DCBMRLDM  TEST IF MACRF=WL             32000002
         BNO   SKIPVRE                  NO, SKIP VRE ROUTINE            32100019
         TM    DCBBFTEK,DCBBFTR         TEST IF BFTEK=R IS SPECIFIED    32300002
         BNO   SKIPVRE                  NO,SKIP VRE ROUTINE             32400019
         TM    DCBRECFM,DCBRECF         TEST IF RECFM=U OR F            32600002
         BO    SKIPVRE                  YES,SKIP VRE ROUTINE            32700019
         TM    DCBRECFM,DCBRECSB        TEST IF RECFM=VS                32900002
         BNO   SKIPVRE                  NO,SKIP VRE ROUTINE             33000019
         TM    DCBMACF2,DCBMRSWA        TEST IF COBOL HAS BILT SWA      33200002
         BO    SKIPVRE                  YES,SKIP VRE PROCESSING         33300019
*                                                                       33400019
* THE POINTER TO THE SEGMENT WORK AREA IS IN DCBEOBW.                   33500002
*                                                                       33600019
         L     R1,DCBEOBW               LOAD ADDR OF SEG WORK AREA C.B. 33700002
         XC    DCBEOBW,DCBEOBW          CLEAR SWA PTR IN DCB            33900002
         USING SWACB,RWK2               ESTABLISH BASE                  34300002
         LH    RWK6,SWACBNO             LOAD NO. OF SEG. WORK AREAS     34320002
         MH    RWK6,SWACBLNG            MULTIPLY NO. * LENGTH           34330002
         LA    RWK8,SWALNG(RWK6)        ADD CONTROL BLOCK LENGTH Y02072 34350002
         DROP  RWK2                                                     34352002
         SPACE 2                                                        34360002
         FREEMAIN R,LV=(RWK8),A=(1),SP=0  FREE SEGMENT WORK AREA Y02072 34370002
         SPACE 2                                                        34420002
         MODESET  EXTKEY=DATAMGT        AUDIT TRAIL IN KEY 5     Y02072 34470002
         SPACE 2                                                        34472002
         OI    FCACLOS1,FCACSWA         INDIC SWA FREED          Y02072 34474002
         SPACE 2                                                        34476002
         MODESET  KEYADDR=DXUKEY,WORKREG=10  BACK TO USER KEY    Y02072 34478002
         SPACE 2                                                        34478402
*                                                                       34480019
* THIS SECTION OF CODE CLEARS BSAM/QSAM/BPAM VECTORS IN DCB             34490002
*                                                                       34510019
SKIPVRE  EQU   *                                                        34520002
         TM    DCBDSORG,DCBDSGPO        IS THIS BPAM            SA59359 34520102
         BO    AMCL5001                 YES, DEB LRECL FIELD    SA59359 34520202
*                                         DOES NOT EXIST        SA59359 34520302
         SR    RWK6,RWK6               CLEAR REGISTER            A45280 34520402
         SR    RWK4,RWK4               CLEAR REGISTER            A45280 34520802
         IC    RWK4,DEBNMEXT           NUMBER OF EXTENTS         A45280 34521202
         IC    RWK6,DEBEXSCL           OBTAIN SCALING FACTOR     A45280 34521602
         SLL   RWK4,0(RWK6)            LENGTH OF DEB EXTENT AREA A45280 34621602
         LA    RWK4,DEBBASND(RWK4)     ACC METHOD SECT           A45280 34671602
         DROP  RDEB                                                     34673602
         USING DEBACSMD,RWK4                                            34681602
         MVC   DCBLRECL,DEBLRECL        RESTORE LRECL            A45280 34721602
         DROP  RWK4                                                     34771602
AMCL5001 SR    RWK6,RWK6                CLEAR REG                       36510002
         ST    RWK6,DCBWCPO             CLEAR OFFSET FIELDS             36600002
         LA    RWK6,INVALADD            TO SET AN INVALID ADDR   Y02072 36650002
         ST    RWK6,DCBIOBA             IOB VECTOR CLEARED              36700002
         ST    RWK6,DCBIOBAD            IOB FOR PCI CLEARED    @Z30TSMI 36710003
         ST    RWK6,DCBEOBW             CLEAR WRITE EOB VECTOR   Y02072 36750002
         TM    DCBCIND2,X'01'           TEST FOR QSAM            Z02260 36752037
         BNO   CLRFLDS                  BR IF NOT QSAM           Z02260 36754037
         STCM  RWK6,B'1100',DCBPRECL    CLEAR DCBPRECL           Z02260 36756037
CLRFLDS  STCM  RWK6,B'0111',DCBCNTRL+1  CLEAR CNTRL MOD ADDR     Y02072 36760037
         STCM  RWK6,B'0111',DCBEOBRA    CLEAR READ EOB VECTOR    Y02072 36770002
         STCM  RWK6,B'0111',DCBREAD+1   CLEAR READ RTN VECTOR    Y02072 36780002
         TM    DCBOFLGS,DCBOFEOV        CONCATENATION UNLIKE ATTRIBUTES 37100002
         BO    AMCL5005                 YES BRANCH                      37200019
         STCM  RWK6,B'0111',DCBPERRA    CLEAR ERR ROUTINE VECTOR Y02072 37250002
AMCL5005 EQU   *                                                        37800019
         TM    DCBCIND2,DCBCNQSM        WAS QSAM USED                   38000002
         BZ    AMCL5009                 NO BRANCH                       38100019
         ST    RWK6,DCBEOB              CLEAR VECTOR                    38300002
AMCL5009 EQU   *                                                        38500019
         XC    DCBCIND1,DCBCIND1        CLEAR SAM INDICATOR      A40495 38650002
         NI    DCBCIND2,DCBCNFEO        CLEAR ALL BUT FEOV INDIC A40495 38700002
         MODESET  EXTKEY=DATAMGT        DATA MANAG KEY FOR STORE Y02072 38950002
         SPACE 2                                                        39000002
         TM    FCACLOS1,FCACFORC        FORCE CLOSE IN CONTROL   Y02072 39050002
         BNO   XCTL                     NO, CONTINUE NORMAL PATH Y02072 39100002
         SR    R15,R15                  RET CD FOR FC EXEC TO    Y02072 39110002
*                                         PASS TO CLOSES TRR     Y02072 39120002
         L     RBRNCH,24(RPAR)          RET ADDR TO FC EXEC    @ZA09146 39150037
         BR    RBRNCH                   RETURN TO FORCE CL EXEC  Y02072 39250002
XCTL     EQU   *                        NORMAL PATH              Y02072 39300002
         MVI   WTGIDTTR,0               CLEAR WTG ENTRY          Y02072 39370002
RELOOP   EQU   *                                                        39450002
         LA    RWTGC,L'WTGENTRY(,RWTGC) STEP TO NEXT ENTRY              39500002
         LA    RPARC,L'PARDCBAD(,RPARC) STEP TO NEXT ENTRY              39550002
         CLC   WTGIDNX,AMIDCNST         IS THIS MODULE NEEDED           39600002
         BCR   8,RBASE                  YES, RECURSE THRU MODULE        39650002
         CLC   WTGIDNX,CLLDB            IS THIS THE END OF THE TABLE    39700002
         BL    RELOOP                   NO, BRANCH                      39750002
         CLC   WTGIDNX,CLLDG            IS THIS THE END OF THE TABLE    39800002
         BH    RELOOP                   NO, BRANCH                      39850002
         LR    RPARC,RPAR               INITIALIZATION                  41200019
         DROP  RWTGC                                                    41250002
         LA    RWTGC,WTGENTRY           POINT TO NEXT WTG ENTRY         41300002
         USING WTGENTRY,RWTGC                                           41350002
AMCL5011 EQU   *                                                        41500019
         CLI   WTGIDTTR,CLOSEFIN        IS THIS ENTRY = ZERO            41700002
         BNE   AMCL5019                 NO BRANCH                       41800019
         LA    RWTGC,L'WTGENTRY(,RWTGC)  POINT TO NEXT WTG ENTRY        42000002
         LA    RPARC,L'PARDCBAD(,RPARC)  POINT TO NEXT PARM ENTRY       42100002
         B     AMCL5011                 BRANCH TO TEST AGAIN            42200019
AMCL5019 EQU   *                                                        42600019
         IECRES LOAD,PREFIX=WTGPREFX,BRANCH=DIRECT,            @Z30TSMI*42900003
               MODID=WTGENTRY           GO TO NEXT ROUTINE     @Z30TSMI 42950003
*                                                                       43300019
         EJECT                                                          43350002
*                                                                       43400002
* CONSTANTS                                                             43450002
*                                                                       43500002
AMIDCNST DC    C'1Y'                    CURRENT MODULE ID        Y02072 43900002
CLLDB    DC    C'0B'                    ID                       Y02072 44500002
CLLDG    DC    C'0G'                    ID                       Y02072 44600002
PATCH    DC    0H'0',50X'00'            PATCH AREA               Y02072 44850002
END      EQU   *                        END OF MODULE            Y02072 44900002
         TITLE 'IGG0201Y - IECDSECS DSECT'                              45100002
         IECDSECS  (MAIN,(IOB,NO)),EXPAND=YES                    Y02072 45200002
         EJECT                                                          45210002
FORCORE  DSECT                                                   Y02072 45250002
         IGGSCW                                                         45310002
         TITLE 'IGG0201Y - DSECT FOR AUDIT TRAIL'                       45320002
         IHAFCAUD  ORG=YES                                       Y02072 45330002
         TITLE 'IGG0201Y - WTG TABLE DSECT'                             45350002
         IECDSECS WTG,PREFX,EXPAND=YES                                  45400003
         ORG   WTG+8                                             Y02072 45402002
WRKRETRN DS    A                        RETURN ADDR TO FORCE     Y02072 45404002
*                                         CLOSE EXECUTOR         Y02072 45406002
         ORG   WTGMODID+2                                               45410002
WTGTTRA  DS    CL3                      TTR                             45420002
WTGKZ    DS    0CL2                     KZ                              45430002
WTGK     DS    C                        K                               45440002
WTGZ     DS    C                        Z                               45442002
WTGC     DS    C                        C                               45444002
         ORG   WTGMODNM                                                 45446002
WTGMOD   DS    CL6                      FIRST 6 CHARS OF MOD NAMEY02072 45448002
         ORG   WTGIDTTR                                                 45448402
WTGIDNX  DS    CL2                      ID NEXT MODULE                  45448802
WTGTTRNX DS    CL3                      TTR NEXT MODULE                 45449202
         ORG   WTGIDTTR+4                                               45449602
WTGDCBWA DS    AL4                      ADDR OF WORK AREA FOR DCB       45449702
         TITLE 'IGG0201Y - CCW DSECT'                                   45450002
         IHACCW  DSECT=YES                                              45500002
         TITLE 'IGG0201Y - CVT DSECT'                                   45510003
CVT      DSECT                                                          45520003
         CVT                                                            45530003
         TITLE 'IGG0201Y - BUFFER CONTROL BLOCK DSECT'                  45550002
         IGGBCB  TYPE=SAM                                               45600002
         TITLE 'IGG0201Y - DEB DSECT'                                   45650002
         IEZDEB                                                         45700002
         TITLE 'IGG0201Y - IOB DSECT'                                   45750002
         IEZIOB                                                         45800002
         TITLE 'IGG0201Y - CLOSE PARAMETER LIST DSECT'                  46050002
         IGGPARML                                                       46100002
         TITLE 'IGG0201Y - SEGMENT WORK AREA DSECT'                     46150002
         IGGSWA                                                         46200002
         TITLE 'IGG0201Y - DCB DSECT'                                   48750002
         DCBD  DSORG=PS                                                 49400019
         END                                                            51000019
