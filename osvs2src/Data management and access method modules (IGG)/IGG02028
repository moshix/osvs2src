         TITLE 'IGG02028 - QISAM LOAD MODE CLOSE - FLUSH BFRS,INDICES'  00100018
IGG02028 CSECT                                                          00102002
*                                                                       00104002
*********************************************************************** 00105002
*                                                                     * 00106002
* MODULE-NAME = IGG02028                                              * 00107002
*                                                                     * 00108002
* DESCRIPTIVE-NAME = ISAM CLOSE, LOAD MODE WITH VLR                   * 00109002
*                                                                     * 00110002
* COPYRIGHT = NONE                                                    * 00111002
*                                                                     * 00112002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00113002
*                                                                     * 00114002
* FUNCTION = ESTABLISH COMMUNICATION WITH PUT AND APPENDAGE ROUTINES, * 00115002
*            STORING APPENDAGE ROUTINE ADDRESS IN DCBRELSE OF THE     * 00116002
*            COPY DCB.  AWAIT COMPLETION OF ALL PRIOR I/O.  IF PUT    * 00117002
*            LOCATE, CHECK SEQUENCE OF LAST PUT.  IF IN ERROR, SYNCH  * 00118002
*            TO PROCESSING ROUTINE FOR SYNAD EXIT.  IF CURRENT        * 00119002
*            BUFFER NOT WRITTEN, SYNCH TO PROCESSING ROUTINE  AND     * 00120002
*            SCHEDULE WRITE.  IF A NULL REUSME LOAD, XCTL TO THE      * 00121002
*            NEXT ISAM CLOSE EXECUTOR.  IF THE LAST TRACK INDEX NEEDS * 00122002
*            TO BE WRITTEN, SYNCH TO PROCESSING ROUTINE AND DO IT.    * 00123002
*            IF LAST CYLINDER INDEX NEEDS TO BE WRITTEN, DO THE SAME. * 00123202
*            IF MASTER INDEX EXISTS, GET CORE FOR REGISTER SAVE AREA  * 00123402
*            AND LINK TO CHANNEL END APPENDAGE; THEN WRITE MASTER     * 00123602
*            INDEX.  FINALLY, FREE REGISTER SAVE AREA CORE.           * 00123802
*                                                                     * 00124002
* NOTES = SEE BELOW                                                   * 00125002
*                                                                     * 00126002
*    DEPENDENCIES = NONE                                              * 00127002
*                                                                     * 00128002
*    RESTRICTIONS = NONE                                              * 00129002
*                                                                     * 00130002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00131002
*                                                                     * 00132002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00133002
*                                                                     * 00134002
* MODULE-TYPE = CLOSE EXECUTOR                                        * 00135002
*                                                                     * 00136002
*    PROCESSOR = ASSEMXF-370R                                         * 00137002
*                                                                     * 00138002
*    MODULE-SIZE = 1159 DECIMAL BYTES                                 * 00139002
*                                                                     * 00140002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00141002
*                                                                     * 00142002
* ENTRY-POINT = IGG02028                                              * 00143002
*                                                                     * 00144002
*    PURPOSE = SEE FUNCTION                                           * 00145002
*                                                                     * 00146002
*    LINKAGE = RECEIVES CONTROL FROM IOS CLOSE WHEN VLR SPECIFIED.    * 00147002
*              RECEIVES CONTROL IN STORAGE PROTECT KEY 5 AND          * 00148002
*              PRIVILEGED STATE.                                      * 00149002
*                                                                     * 00150002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00151002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00152002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00153002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00154002
*               PARAMETER LIST                                        * 00155002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00156002
*                                                                     * 00157002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00158002
*          UPON ENTRY TO THIS MODULE                                  * 00159002
*                                                                     * 00160002
* EXIT-NORMAL = XCTL TO ISAM CLOSE EXECUTOR IGG0202J IN STORAGE       * 00161002
*               PROTECT KEY 5.                                        * 00161202
*                                                                     * 00162002
* EXIT-ERROR = SYNCH TO PROCESSING ROUTINE TO TAKE SYNAD EXIT IF A    * 00163002
*              SEQUENCE ERROR EXISTS.                                 * 00164002
*                                                                     * 00168002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00169002
*                                                                     * 00170002
*    ROUTINES = ISAM LOAD MODE PROCESSING AND APPENDAGE ROUTINES      * 00171002
*                                                                     * 00173002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00174002
*                 FORCORE - CLOSE WORK AREA                           * 00175002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00176002
*                                                                     * 00177002
*    CONTROL-BLOCKS = DCB, DCB COPY, DEB, IOB, CVT, TCB, AND SVRB     * 00178002
*                                                                     * 00179002
*    TABLES = BUFFER CONTROL TABLE                                    * 00180002
*                                                                     * 00181002
* MACROS = MODESET, XCTL, WAIT, EXCP, GETMAIN, AND FREEMAIN           * 00182002
*                                                                     * 00183002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00184002
*                                                                     * 00185002
*                                                                     * 06501002
*********************************************************************** 06502002
         EJECT                                                          06503002
********************                                                    06504002
* DCB REFERENCE    *                                                    06600018
********************                                                    06700018
         DCBD  DSORG=(IS)                                               06800018
         USING IHADCB,R1                                                06900018
         EJECT                                                          07000018
*****************************                                           07050000
* CLOSE WORK AREA REFERENCE *                                           07060000
*****************************                                           07070000
FORCORE  DSECT                          OPEN/CLOSE/EOV WORK AREA Y01021 07080000
         IECDSECT                                                Y01021 07090000
         EJECT                                                          07092000
********************                                                    07100018
* DEB REFERENCE    *                                                    07200018
IHADEB   IGGDEBD                                                        08200021
         EJECT                                                          11000018
*********************************************************************** 11100018
* ISLCOMON REFERENCE     C(DCBWKPT1)=A(ISLCOMMON)                     * 11200018
*********************************************************************** 11300018
ISLCOMON IGGLOAD                                                        13300021
         USING ISLCOMON,R12                                      S21045 15300021
*                                                                       18300018
*                                                                       18400018
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      18500018
*                                                                       18600018
IOBBCT   DSECT                                                          18700018
         USING IOBBCT,R11                                               18800018
         DS    0D                                                       18900018
IOBFLAGS DS    0CL1                     FLAGS                           19000018
IOBPTRA  DS    A                        PTR A                           19100018
IOBB     DS    0CL1                     B                               19200018
IOBPTRB  DS    A                        PTR B                           19300018
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   19400018
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   19500018
         SPACE 4                                                        19600002
********************                                                    19700018
* IOB REFERENCE    *                                                    19800018
********************                                                    19900018
*                                                                       20000018
IHAIOB   DSECT                                                          20100018
         DS    0D                                                       20300018
IOBFLG1  DS    CL1                      FLAGS 1                         20400018
IOBFLG2  DS    CL1                      FLAGS 2                         20500018
AIOBSENS DS    CL2                      SENSE BYTES              Y01021 20700000
IOBECBAD DS    A                        ECB POINTER                     20800018
AIOBCSW  DS    CL8                      CHANNEL STATUS WORD      Y01021 20900000
AIOBSIOC DS    0CL1                     SIO CC                   Y01021 21000000
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       21100018
IOBWT    DS    0CL1                     WEIGHT                          21200018
IOBDCBAD DS    A                        DCB POINTER                     21300018
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     21400018
IOBBCTI  DS    CL2                      BLK CTR INCR                    21500018
IOBECT   DS    CL2                      ERROR CTR                       21600018
IOBDADAD DS    CL8                      DIR ACESS DEV ADR MBBCCHHR      21700018
*                                                                       21800018
********************                                                    21900018
* IXLT REFERENCE   *                                                    22000018
********************                                                    22100018
*                                                                       22200018
IXLT     DSECT                                                          22300018
         USING IXLT,R7                                                  22400018
         DS    0D                                                       22500018
IXLTIND  DS    CL1                      INDICATOR                  LEV1 22600018
IXLBEG   DS    CL8                      BEGINING COUNT MBBCCHHR         22700018
IXLSTP   DS    CL8                      STEPPING COUNT MBBCCHHR         22800018
IXLEND   DS    CL8                      ENDING COUNT   MBBCCHHR         22900018
         DS    CL1                                                      23000018
         DS    CL26                                                LEV2 23100018
         DS    CL26                                                LEV3 23200018
         DS    CL26                                                LEV4 23300018
         EJECT                                                          23350002
CVT      DSECT                                                   Y02072 23360002
         CVT                                                     Y02072 23370002
         SPACE 2                                                        23380002
TCB      IKJTCB                                                  Y02072 23390002
         EJECT                                                          23392002
         IKJRB                                                   Y02072 23394002
         EJECT                                                          23400018
**************************************************************          23500018
IGG02028 CSECT                                                          23600018
**************************************************************          23700018
ISLG500  BALR  R15,0                                                    23800018
         USING *,R15                                                    23900018
BASETAG  L     R1,0(RPARC)                                              24000018
         L     RCORE,4(RWTGC)                                           24100018
         USING FORCORE,RCORE            WA ADDRESSABILITY        Y02072 24150002
         L     R12,DCBWKPT1                                             24200018
         LR    RBASE,R15                                                24300018
         STM   R1,RWTGC,DXCCW1          SAVE REGISTERS 1 - 8     Y02072 24400002
         LR    RWTGC,RCORE              CLOSE WA ADDRESS         Y02072 24450002
         USING FORCORE,RWTGC            WA ADDRESSABILITY        Y02072 24500002
*                                                                       24600018
* EQUATE SYMBOLIC REGISTERS                                             24700018
*                                                                       24800018
R0       EQU   0                                                        24900018
R1       EQU   1                                                        25000018
R2       EQU   2                                                        25100018
R3       EQU   3                                                        25200018
R4       EQU   4                                                        25300018
R5       EQU   5                                                        25400018
R6       EQU   6                                                        25500018
R7       EQU   7                                                        25600018
R10      EQU   10                                                       25900018
R11      EQU   11                                                       26000018
R12      EQU   12                                                       26100018
R13      EQU   13                                                       26200018
R14      EQU   14                                                       26300018
R15      EQU   9                                                        26400018
RBASE    EQU   3                                                        26600018
RCORE    EQU   4                                                        26700018
RPAR     EQU   5                                                        26800018
RWTG     EQU   6                                                        26900018
RPARC    EQU   7                                                        27000018
RWTGC    EQU   8                                                        27100018
RJ       EQU   15                                                       27600018
KEYZERO  EQU   0                        CHANGE TO KEY ZERO       Y02072 27650002
REGSAVE  EQU   64                       REG SAVE AREA SIZE       Y02072 27700002
SUB230   EQU   230                      SUBPOOL FOR REGSAVE      Y02072 27710002
CLOSESW  EQU   X'02'                    CLOSE INDICATOR IOBFLAGS A46890 27750021
ISLKEYVL EQU   X'04'                    KEY SEQUENCE VALID(IXLT) XM6075 27760000
RSLOAD   EQU   X'20'                    RESUME LOAD(DCBST)       XM6075 27770000
*                                                                       27800018
         EJECT                                                          27900018
*********************************************************************** 28000018
* CHART G5 - CLOSE (FINISH PUT) HOUSEKEEPING                          * 28100018
*********************************************************************** 28200018
*                                                                       28300018
ISLG501  TM    DCBST,X'20'              NULL RESUME LOAD?       SA67203 28310002
         BO    ISLG812                  YES, BRANCH TO EXIT     SA67203 28320002
         L     R2,DCBDEBAD              PROTECTED DEB ADDR       Y02072 28350002
         ST    R15,DXCCW6               SAVE BASE ADDR           Y02072 28360002
         LR    R14,R1                   SAVE ADDR OF DCB COPY    Y02072 28362002
         L     R1,DXUDCBAD              ADDR OF USERS DCB        Y02072 28370002
*                                                                       28372002
         MODESET  KEYADDR=DXUKEY,WORKREG=12  CHANGE TO USER KEY  Y02072 28380002
*                                                                       28390002
         L     R12,DCBWKPT1             C(R12)=A(COMMON)                28400002
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 28500018
         L     R11,8(R10)               C(R11)=A(BCT)                   28600018
         CLC   40(4,R10),DCBSYNAD       TEST VPTER 11 VS A(SYNAD)       28700018
         BNE   ISLG5012                 B IF NOT EQUAL                  28800018
         OI    DCBEXCD2,X'20'           SET EXCD2 BIT 2 ON = NO SYNAD   28900018
ISLG5012 EQU   *                        SET BUFF CNTRL TBL FLGS  Y02072 29000002
         OI    IOBFLAGS,X'10'           SET FLAGS BIT-3 ON (CLOSE)      29100018
         NI    IOBFLAGS,X'FD'           SET FLAGS BIT 6 OFF (CLOSE X)   29200018
         NI    IOBFLAGS,X'BF'           SET FLAGS BIT 1 OFF IF ON       29300018
*                                                                       29400018
* SET UP LINES OF COMMUNICATION TO PUT AND APP MODULES                  29500018
*                                                                       29600018
         USING IHADEB,R2                                         S21045 29640002
         L     R4,DEBEXPTR               GET ADDR OF DEB         S21045 29660021
*                                       EXTENSION PTR            S21045 29680021
         USING DEBEXT,R4                                         S21045 29700021
         L     R4,DEBPUT                 C(R4)=A(ISLF800)        S21045 29720021
         DROP  R4                                                S21045 29740021
         LA    R4,6(R4)                 ISLF800+6 = PUT BASE            29800018
         ST    R4,ISLF8AD               STORE ADDR OF PUT BASE          29900018
         A     R4,ISL4                                                  30000018
         ST    R4,ISLFXAD               STORE ADDR OF B TO ISLFX20      30100018
         A     R4,ISL4                                                  30200018
         ST    R4,ISLFYAD               STORE ADDR OF B TO ISLFY01      30300018
         A     R4,ISL4                                                  30400018
         ST    R4,ISLFZAD               STORE ADDR OF B TO ISLFZ01      30500018
         A     R4,ISL4                                                  30600018
         ST    R4,ISLPAAD               STORE ADDR OF B TO ISLPA01      30700018
*                                                                       30800018
         L     R4,DEBAPPAD              C(R4)=ADDR OF DEB AVT    Y02072 30900002
         DROP  R2                       END USING ON DEB         Y02072 30950002
         USING DEBAVT,R4                DEB AVT ADDRESSABILITY   Y02072 31000002
         L     R4,DEBCEA                ADDR OF CE APPENDAGE     Y02072 31050002
         DROP  R4                       END DEB AVT USING        Y02072 31060002
*                                                                       31070002
         MODESET  EXTKEY=DATAMGT        SET DATA MGT KEY (5)     Y02072 31080002
*                                                                       31090002
         USING IHADCB,R14               COPY DCB ADDRESSABILITY  Y02072 31092002
         ST    R4,DCBRELSE              STORE ADDR OF ISLF110    Y02072 31100002
*                                       IN DCB COPY              Y02072 31200002
         DROP  R14                      END USING ON DCB COPY    Y02072 31250002
         USING IHADCB,R1                USER DCB ADDRESSABILITY  Y02072 31260002
*                                                                       31270002
         MODESET  KEYADDR=DXUKEY,WORKREG=2  SET USER'S KEY       Y02072 31280002
*                                                                       31290002
*                                                                       31300018
* AWAIT COMPLETION OF ALL PRIOR I/O ACTIVITY                            31400018
*                                                                       31500018
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   31600018
         BAL   R14,ISLG502              B TO COMMON WAIT                31700018
         LA    R2,ISLIOBB               C(R2)=A(IOBB)                   31800018
         BAL   R14,ISLG502              B TO COMMON WAIT                31900018
         LA    R2,ISLIOBC               C(R2)=A(IOBC)                   32000018
         BAL   R14,ISLG502              B TO COMMON WAIT                32100018
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   32200018
         B     ISLG503                                                  32300018
*                                                                       32400018
         USING IHAIOB,R2                IOB ADDRESSABILITY      Y02072  32450002
ISLG502  L     R4,IOBECBAD              C(R4)=A(ECB)                    32500018
         TM    0(R4),X'40'              TEST ECB BIT 1 (C-BIT)          32600018
         BC    1,0(R14)                 RETURN, I/O COMPLETE-DONT WAIT  32700018
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 32800018
         LR    R6,R14                   SAVE R14                        32900018
         LR    R3,R1                    SAVE R1                         33000018
         LR    R1,R4                    C(R1)=A(ECB)                    33100018
         WAIT  ECB=(1)                  WAIT                            33200018
         LR    R1,R3                    RESTORE R1                      33300018
         LR    R14,R6                   RESTORE R14                     33400018
         BR    R14                      RETURN                          33500018
*                                                                       33600018
*                                                                       33700018
* TEST FOR MOVE OR LOCATE PUT                                           33800018
*                                                                       33900018
ISLG503  TM    DCBMACRF+1,X'10'         TEST MACRF BIT 11               34000018
         BC    1,ISLG508                B IF ON = MOVE PUT              34100018
*                                                                       34200018
* LOCATE PUT - CHECK SEQUENCE OF LAST PUT                               34300018
*                                                                       34400018
*                                       HOUSEKEEPING                    34500018
**************************************************************          34600018
ISLG504  EQU   *                                                        34700018
**************************************************************          34800018
         LH    R4,DCBRKP                C(R4)= RKP (00NN)               34900018
         A     R4,ISLCBF                C(R4)=RKP+CBF = A(KEY IN RCD)   35000018
         SR    R3,R3                                                    35100018
         IC    R3,DCBKEYLE              C(R3)=KEYLEN                    35200018
         BCTR  R3,0                     C(R3)=KEYLEN-1,FOR EXECUTE      35300018
         L     R5,4(R10)                C(R5)=A(KEYSAVE)                35400018
*                                                                       35500018
         TM    DCBEXCD1,X'FE'                                           35600018
         BC    7,ISLG505                                                35700018
         TM    DCBEXCD2,X'C8'           PREVIOUS ERROR                  35800018
         BNE   ISLG505                  YES,BRANCH                      35900018
**************************************************************          36000018
         L     R10,20(R10)             A(CP20,CQ1)                      36100018
         L     R11,ISLCBF              A(REC N)                         36200018
         CLC   82(2,R10),0(R11)        REC LN VALIS                     36300018
         L     R10,DCBWKPT6            RESET REGS                       36400018
         L     R11,8(R10)                                               36500018
         BL    ERROR                   NO REC LN BAD                    36600018
**************************************************************          36700018
         CLC   DCBNREC(4),ISL2          TEST NREC VS 2                  36800018
         BL    ISLG508                  B IF LOW, SEQ ERR IMPOSSIBLE    36900018
*                                                                       37000018
         EX    R3,ISLG504A              C(CBF+RKP) VS C(KEYSAVE)        37100018
         BH    ISLG508                  B IF NEW KEY HIGH, SEQUENCE OK  37200018
*                                                                       37300018
*                                       SEQUENCE NOT OK, TAKE SYNAD     37400018
*                                       ***************************     37500018
ERRORA   EQU   *                        *                        XM6075 37590000
         NI    DCBMACRF+1,X'EF'         TURN BIT 11 BACK OFF (LOCATE)   37600018
         L     R13,ISLF8AD              SET FOREIGN BASE         Y02072 37700002
         BAL   R14,SYNCHRTN             GO TAKE SYNAD EXIT       Y02072 37800002
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)          A35244 37950020
         TM    ISLIXLT,ISLKEYVL         WAS DATA ADDED           XM6075 37960000
         BO    ISLG504                  YES- NOT NULL RESUME LOADXM6075 37970000
         OI    DCBST,RSLOAD             INDICATE NULL RESUME LOADXM6075 37980000
         B     ISLG504                  GO TO HOUSEKEEPING AGAIN        38000018
*                                                                       38100018
ERROR    OI    DCBEXCD2,X'08'                                           38130018
         B     ERRORA                                                   38160018
*                                       PREV SEQ ERR, DROP LAST RCD     38200018
*                                       ***************************     38300018
ISLG505  EX    R3,ISLG505A              MOVE KEY FROM KEYSAVE TO BUFFR  38400018
         NI    DCBEXCD2,X'3F'           TURN EXCD2 BITS 0 AND 1 OFF     38500018
         L     R3,DCBNREC               C(R3)=NREC                      38600018
         BCTR  R3,0                     C(R3)=NREC-1                    38700018
         ST    R3,DCBNREC               C(NREC)=NREC-1                  38800018
         L     R3,IOBPTRB               C(R3)=C(PTRB) = A(CURR SLOT)    38900018
         LA    R3,0(R3)                                                 39000018
         L     R4,0(R3)                 C(R4)=A(CURR BUFFR START)       39100018
         LA    R4,12(R4)                C(R4)=A(1ST RCD IN CURR BUFF)   39200018
         C     R4,ISLCBF                TEST A(1ST RCD) VS C(CBF)       39300018
         BNE   ISLG5085                 B NOT EQUAL TO BACK UP CBF      39400018
*                                                                       39500018
*                                       CBF POINTS TO 1ST RCD IN BUFFR  39600018
         NI    0(R3),X'80'              TURN OFF ALL STATUS BITS        39700018
         LA    R4,IOBABUF               C(R4)=A(SLOT 1)                 39800018
         CR    R3,R4                    TEST A(CURR SLOT) VS A(SLOT 1)  39900018
         BE    ISLG506                  B IF CURR SLOT = SLOT 1         40000018
         S     R3,ISL4                  C(R3)=A(PREV SLOT)              40100018
         B     ISLG507                                                  40200018
ISLG506  L     R3,ISLBUFN               C(R3)=A(SLOT N) = A(PREV SLOT)  40300018
ISLG507  IC    R5,IOBB                  SAVE B                          40400018
         ST    R3,IOBPTRB               STORE A(PREV SLOT) IN PTRB      40500018
         STC   R5,IOBB                  RESTORE B                       40600018
         L     R4,0(R3)                 C(R4)=A(PREV BUF)               40700018
         LA    R4,0(R4)                                                 40800018
         MVC   DCBLPDA(8),DCBFTMI3      LPDA = PREVIOUS LPDA            40900018
         MVC   0(5,R4),DCBLPDA+3        PREV BUF CCHHR = LPDA CCHHR     41000018
         B     ISLG509                                                  41100018
*                                                                       41200018
* BUMP CBF                                                              41300018
*                                                                       41400018
**************************************************************          41500018
ISLG508  EQU   *                                                        41600018
         L     R5,12(R10)              A(CP18,CL1)                      41700018
         L     R4,20(R10)              A(CP20,CQ1)                      41800018
         L     R3,ISLCBF               A(REC N)                         41900018
         MVC   88(2,R4),0(R3)          GET REC LENGTH                   42000018
         LH    R10,88(R4)                                               42100018
         L     R6,IOBPTRB              A(SLOT N)                        42200018
         L     R6,0(R6)                A(BUFF N)                        42300018
         AH    R10,8(R6)               LRECL + BLKL                     42400018
         STH   R10,8(R6)                                                42500018
         AH    R3,DCBRKP               CBF+RKP=A(KEY)                   42600018
         LH    R10,80(R4)              C(R10)=PTR TO CCW SLOT           42700018
         IC    R6,32(R5,R10)                                            42800018
         ST    R3,32(R5,R10)           C(CL7=A(KEY))                    42900018
         STC   R6,32(R5,R10)                                            43000018
         L     R3,ISLCBF                                                43100018
         MVC   ISLCBF(2),0(R3)         +LRECL                           43200018
         AH    R3,ISLCBF                                                43300018
         ST    R3,ISLCBF               PTR TO NXT REC                   43400018
         L     R10,DCBWKPT6            RESET REGS                       43600018
         L     R11,8(R10)                                               43700018
**************************************************************          43800018
         CLC   DCBNREC(4),ISL0          WAS DATA CREATED                43900018
         BE    ISLG509                  NO BRANCH                       44000018
*                                                                       44100018
* TEST IF CURR BUFFR FULL                                               44200018
*                                                                       44300018
**************************************************************          44400018
ISLG5085 EQU   *                                                        44500018
*                                                                       44600018
**************************************************************          44700018
*                                                                       44800018
*                                       CURR BUFFR IS FULL              44900018
*                                                                       45000018
* TEST FOR LOCATE PUT, IF LOCATE (NOT SPECIAL) FULL BUF NOT YET WRITTEN 45100018
*                                                                       45200018
**************************************************************          45300018
*                                                                       45400018
*                                                                       45500018
**************************************************************          45600018
*                                                                       45700018
*                                       LOCATE PUT (NOT SPECIAL)        45800018
         L     R3,IOBPTRB               C(R3)=A(CURR SLOT)              45900018
         NI    0(R3),X'DF'              SET STATUS BITS 1 AND 2 = 10    46000018
         OI    0(R3),X'40'                                              46100018
         SR    R3,R3                                                    46200018
         IC    R3,IOBB                  BUMP B, B=B+1                   46300018
         LA    R3,1(R3)                                                 46400018
         STC   R3,IOBB                                                  46500018
*                                                                       46600018
**************************************************************          46700018
ISLG509  EQU   *                                                        46800018
**************************************************************          46900018
*                                                                       47000018
* TEST IF CURR BUFFR HAS BEEN WRITTEN                                   47100018
*                                                                       47200018
         L     R3,IOBPTRB               C(R3)=A(CURR SLOT)              47300018
         LA    R3,0(R3)                                                 47400018
         TM    0(R3),X'60'              TEST STATUS BITS 1 AND 2        47500018
         BC    8,ISLG801                B IF 00, CURR BUFFR WRITTEN     47600018
         B     ISLG703                  B IF CURR BUFFR FULL BUT A36748 47660020
*                                       NOT                      A36748 47720020
*                                       WRITTEN                         47800018
         EJECT                                                          47900018
*********************************************************************** 48000018
* CHART G7 - CLOSE (WR BUFFERS)                                       * 48100018
*********************************************************************** 48200018
*                                                                       48300018
* TEST B VS FBW                                                         48400018
*                                                                       48500018
ISLG701  EQU   *                        *                        A36748 48600020
         TM    DCBEXCD1,X'FE'                                           48800018
         BC    7,ISLG801                                                48900018
**************************************************************          49000018
*                                                                       49100018
         L     R3,IOBPTRB              A(SLOT X)                        49200018
         OI    0(R3),X'08'             TURN ON EOT BIT                  49300018
*                                                                       49400018
**************************************************************          49500018
*                                                                       49600018
ISLG702  L     R13,ISLFYAD              C(R13)=A(ISLFY01)               49700018
         BAL   R14,SYNCHRTN             GO WRITE BUFFERS         Y02072 49800002
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 50100018
*                                                                       50200018
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   50300018
         BAL   R14,ISLG502              B TO COMMON WAIT                50400018
*                                                                       50500018
* TEST B VS 0                                                           50600018
*                                                                       50700018
ISLG703  EQU   *                        *                        A36748 50750020
         CLC   IOBB(1),ISL0             TEST B VS 0                     50800018
         BH    ISLG701                                                  50900018
*                                                                       51000018
         EJECT                                                          51100018
*********************************************************************** 51200018
* CHART G8 - CLOSE (FORCE IX)                                         * 51300018
*********************************************************************** 51400018
*                                                                       51500018
* WAS LAST TRK IX WRITTEN                                               51600018
*                                                                       51700018
ISLG801  L     RJ,0(R10)                C(RJ)=A(AREA Y)                 51800002
         CLC   DCBNREC(4),ISL0          WAS DATA CREATED                51900018
         BE    ISLG802                  NO, BRANCH                      52000018
         CLC   26(7,RJ),DCBLPDA         TEST LAST NDAT VS LPDA          52100002
         BE    ISLG802                  B IF EQUAL, LAST TRK IX WRITTEN 52200018
*                                                                       52300018
* LAST TRK IX NOT WRITTEN, FORCE LAST TRK IX                            52400018
*                                                                       52500018
         MVC   IOBPTRA+1(3),IOBPTRB+1   SET PTR A = PTR B = CURR BUFFR  52600018
         MVI   ISLFBW+3,X'01'           SET FBW = 1                     52700018
         MVI   IOBB,X'01'               SET B = 1                       52800018
         L     R3,IOBPTRB               C(R3)=A(CURR SLOT)              52900018
         LA    R3,0(R3)                                                 53000018
         OI    0(R3),X'08'              TURN T-BIT ON (STATUS BIT-4)    53100018
         L     R6,20(R10)               C(R6)=A(CP20)                   53200018
         TM    DCBOPTCD,X'80'           TEST OPTCD BIT 0 (WR CHK)       53300018
         BC    1,ISLG8012               B IF WR CHK                     53400018
*                                                                       53500018
         MVI   104(R6),X'03'            NO WR CHK, SET CQ14 = NOP       53600018
         B     ISLG8014                                                 53700018
*                                                                       53800018
ISLG8012 LA    R6,248(R6)               C(R6)=A(CQT1)                   53900018
         MVI   56(R6),X'03'             WR CHK, SET CQT8 = NOP          54000018
*                                                                       54100018
ISLG8014 L     R13,ISLFYAD              C(R13)=A(ISLFY01)               54200018
         BAL   R14,SYNCHRTN             GO WRITE LAST INDEX      Y02072 54300002
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 54600018
*                                                                       54700018
**************************************************************          54800018
*                                                                       54900018
**************************************************************          55000018
*                                                                       55100018
*                                       LAST TRK IX WAS WRITTEN, SO     55200018
*                                       LAST TRK WAS FULL -             55300018
**************************************************************          55400018
ISLG802  EQU   *                                                        55500018
         L     R7,IOBPTRB              A(CURR SLOT)                     55600018
         OI    0(R7),X'04'             TURN ON EOC BIT                  55700018
**************************************************************          55800018
ISLG803  CLI   DCBNLEV,X'00'            TEST NLEV VS 0                  55900018
         BE    ISLG810                  B IF 0, TRK IX ONLY             56000018
*                                                                       56100018
* NLEV NOT 0, WAS LAST CYL IX WRITTEN                                   56200018
*                                                                       56300018
*   TELL APPENDAGE THAT CLOSE IS IN CONTROL.                            56320021
         OI    IOBFLAGS,CLOSESW         SET INDICATOR            A46890 56340021
*                                                                       56360021
         TM    ISLIXLT,X'08'            TEST IXLT LEV1 BIT-4            56400018
         BC    8,ISLG804                B IF 0 = LAST CYL IX WRITTEN    56500018
*                                                                       56600018
* LAST CYL IX NOT WRITTEN, FORCE LAST CYL IX                            56700018
*                                                                       56800018
**************************************************************          56900018
*                                                                       57000018
*                                                                       57100018
         LA    R7,0(R7)                                           15361 57200018
**************************************************************          57300018
         L     R13,ISLFZAD              C(R13)=A(ISLFZ01)               57700018
         BAL   R14,SYNCHRTN             B TO WR LAST CYL IX      Y02072 57900002
         L     R10,DCBWKPT6             C(R10)=A(VPTRS)                 58100018
*                                                                       58200018
ISLG804  CLI   DCBNLEV,X'01'            TEST NLEV VS 1                  58300018
         BE    ISLG810                  B IF NO MASTER LEVEL IX         58400018
         CLC   DCBNREC(4),ISL0          WAS DATA CREATED                58500018
         BE    ISLG810                  NO,BRANCH                       58600018
*                                                                       58700018
* NLEV GR THAN 1, FORCE ANY MASTER IX ENTRIES THAT NEED TO BE WRITTEN   58800018
*                                                                       58900018
         LA    R2,ISLIOBB               C(R2)=A(IOBB)                   59000018
         BAL   R14,ISLG502              B TO COMMON WAIT                59100018
*                                                                       59200018
         LR    R4,R1                    C(R4)=C(R1)=A(DCB)              59300018
*                                                                       59310002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 59350002
*                                                                       59352002
         LA    R14,REGSAVE              SIZE OF REG SAVE AREA    Y02072 59360002
*                                                                       59362002
         GETMAIN  R,LV=(R14),SP=SUB230  GET SAVE AREA FOR APP    Y02072 59370002
*                                                                       59372002
         LR    R13,R1                   SA ADDR FOR APPEND       Y02072 59380002
         LR    R7,R1                    SAVE ADDR FOR FREEMAIN   Y02072 59392002
         L     R1,DXCCW1                ADDRESS OF DCB COPY      Y02072 59394002
         L     R3,DCBDEBAD              PROTECTED DEB ADDRESS    Y02072 59396002
         L     RJ,DCBRELSE              PROTECTED CE APPEND ADDR Y07072 59398002
         LR    R1,R4                    RESTORE USER DCB ADDRESS Y02072 59398402
*                                                                       59400018
         BALR  R14,RJ                   LINK TO APPENDAGE        Y02072 59550002
*                                                                       59700018
*                                       RETURN = 0(R14) = DONT WR       59800018
         L     R15,DXCCW6               RESTORE BASE REG         Y02072 59900002
         B     ISLG809                  FREE REG SAVE AREA       Y02072 60000002
*                                                                       60100018
*                                       RETURN = 8(R14) = WR MASTER     60200018
         L     R15,DXCCW6               RESTORE BASE REG         Y02072 60300002
*                                                                       60310002
         MODESET  KEYADDR=DXUKEY,WORKREG=10  CHANGE TO USER KEY  Y02072 60350002
*                                                                       60360002
         L     R12,DCBWKPT1             C(R10)=A(COMMON)         Y02072 60400002
*                                                                       60600018
* EXECUTE CP21                                                          60700018
*                                                                       60800018
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 60900018
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         61100018
*                                                                       61210002
ISLG809  MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 61250002
*                                                                       61252002
         LR    R1,R7                    ADDRESS OF CORE          Y02072 61260002
*                                                                       61262002
         FREEMAIN  R,LV=REGSAVE,A=(1),SP=SUB230  FREE CORE       Y02072 61270002
*                                                                       61272002
         B     ISLG812                  RESTORE REGS             Y02072 61280002
*                                                                       61300018
ISLG810  MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 61400002
*                                                                       61410002
ISLG812  EQU   *                                                        61450002
         LM    R1,RWTGC,DXCCW1          RESTORE REGISTERS        Y02072 61470002
         DROP  RWTGC                    END USING ON CLOSE WA    Y02072 61480002
         USING BASETAG,RBASE                                            61500018
         MVC   0(L'LOAD2J,RWTGC),LOAD2J ID NEXT LOAD-IGG0202J    Y02072 61600002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       61700018
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       61800018
         CLC   0(2,RWTGC),THISLOAD                                      61900018
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 62000018
         CLI   0(RWTGC),X'00'           TEST FOR END OF WTG TABLE       62100018
         BC    7,RELOOP                 BRANCH=NOT AT END               62200018
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                62300018
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                62400018
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              62500018
         BC    7,TCTLRTN                BRANCH = NOT ZERO               62600018
ITSZERO  LA    RWTGC,8(RWTGC)                                           62700018
         LA    RPARC,4(RPARC)                                           62800018
         B     ZCHECK                                                   62900018
TCTLRTN  EQU   *                                                        63000018
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         63100018
*                                                                       63200002
         USING FORCORE,RCORE                                     Y01021 63250000
         LA    RJ,DXCCW12               WA ADDRESS               Y01021 63300000
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO IGG0202J   Y02072 63400002
*                                                                       63500018
         EJECT                                                          63550002
**********************************************************************  63560002
*        SYNCH TO PROCESSING ROUTINES TO FLUSH BUFFERS,                 63570002
*        INDICIES, AND HANDLE SYNAD EXIT.                               63580002
**********************************************************************  63590002
*                                                                       63590402
         USING FORCORE,RWTGC            CLOSE WORK AREA ADDR     Y02072 63590802
*                                                                       63591202
SYNCHRTN MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 63592002
*                                                                       63592402
         STM   R0,R5,DXCCW8             SAVE REGISTERS 0-5       Y02072 63594002
         L     RJ,CVTPTR                ADDRESS OF CVT           Y02072 63596002
         USING CVT,RJ                   CVT ADDRESSABILITY       Y02072 63598002
         L     RJ,CVTTCBP               ADDR OF TCB POINTERS     Y02072 63598402
         L     RJ,0(RJ)                 TCB ADDRESS              Y02072 63598802
         USING TCB,RJ                   TCB ADDRESSABILITY       Y02072 63599202
         L     RJ,TCBRBP                ADDR OF SVRB             Y02072 63599602
         USING RBBASIC,RJ               RB ADDRESSABILITY        Y02072 63599702
*                                                                       63599802
         MODESET  KEYADDR=KEY0,WORKREG=5  SET PROTECT KEY ZERO   Y02072 63608102
*                                                                       63610102
         STM   R6,R14,RBEXSAVE          SAVE REGISTERS 6-14      Y02072 63624902
         DROP  RJ                       END USING ON RB          Y02072 63633202
         L     R15,ISLF8AD              SET FOREIGN BASE         Y02072 63643202
         LR    RJ,R13                   ENTRY POINT ADDR         Y02072 63653202
*                                                                       63655202
         SYNCH (15)                     SYNCH TO PROCESSING RTN  Y02072 63663202
*                                                                       63663602
         L     R5,CVTPTR                ADDR OF CVT              Y02072 63665202
         USING CVT,R5                   CVT ADDRESSABILITY       Y02072 63665602
         L     R5,CVTTCBP               ADDR OF TCB POINTERS     Y02072 63666002
         L     R5,0(R5)                 TCB ADDRESS              Y02072 63666402
         USING TCB,R5                   TCB ADDRESSABILITY       Y02072 63666502
         L     R5,TCBRBP                SVRB ADDRESS             Y02072 63666602
         USING RBBASIC,R5               RB ADDRESSABILITY        Y02072 63677702
         LM    R6,R14,RBEXSAVE          RESTORE REGISTERS 6-14   Y02072 63687702
         DROP  R5                       END USING ON RB          Y02072 63688102
*                                                                       63688202
         MODESET  KEYADDR=DXUKEY,WORKREG=5   CHANGE TO USER KEY  Y02072 63688502
*                                                                       63690802
         LM    R0,R5,DXCCW8             RESTORE REGISTERS 0-5    Y02072 63693102
         BR    R14                      RETURN                   Y02072 63695402
         SPACE 4                                                        63697702
*                                                                       63700018
* CONSTANTS                                                             63800018
*                                                                       63900018
ISL0     DC    F'0000'                                                  64000018
ISL2     DC    F'0002'                                                  64100018
ISL4     DC    F'0004'                                                  64200018
*                                                                       64250002
KEY0     EQU   ISL0                     STORAGE PROTECT KEY ZERO Y02072 64300002
**************************************************************          64600018
ISLG504A CLC   0(1,R4),0(R5)            KEY COMP TO BE EXECUTED (L)     64700018
ISLG505A MVC   0(1,R4),0(R5)            KEY MOVE TO BE EXECUTED (L)     64800018
*                                                                       64900018
**************************************************************          65000018
THISLOAD DC    C'28'                                                    65100018
*                                                                       65110002
LOAD2J   DC    C'2J'                    ID OF MODULE IGG0202J    Y02072 65120002
*                                                                       65130002
PATCH    DC    XL((*-IGG02028)/20)'00'  ZEROED PATCH AREA        Y02072 65140002
         END                                                            66300018
