         TITLE 'IGG0202I - QISAM LOAD MODE CLOSE- FLUSH BFRS,INDICIES'  00020000
IGG0202I CSECT                                                          00021002
*                                                                       00022002
*********************************************************************** 00023002
*                                                                     * 00024002
* MODULE-NAME = IGG0202I                                              * 00025002
*                                                                     * 00026002
* DESCRIPTIVE-NAME = ISAM CLOSE, LOAD MODE WITH FIXED LENGTH RECORDS  * 00027002
*                                                                     * 00028002
* COPYRIGHT = NONE                                                    * 00029002
*                                                                     * 00030002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00031002
*                                                                     * 00032002
* FUNCTION = FOR A NULL RESUME LOAD, XCTL TO NEXT ISAM CLOSE EXECUTOR,* 00033002
*            OTHERWISE, ESTABLISH COMMUNICATION WITH PUT AND          * 00034002
*            APPENDAGE ROUTINES, STORING APPENDAGE ROUTINE ADDRESS IN * 00035002
*            DCBRELSE OF THE COPY DCB.  AWAIT COMPLETION OF ALL PRIOR * 00036002
*            I/O.  IF PUT LOCATE, CHECK SEQUENCE OF LAST PUT.  IF IN  * 00037002
*            ERROR, SYNCH TO PROCESSING ROUTINE FOR SYNAD EXIT.  IF   * 00038002
*            CURRENT BUFFER IS NOT FULL, SYNCH TO PROCESSING ROUTINE  * 00039002
*            TO PAD OUT BUFFER AND SCHEDULE WRITE.  IF CURRENT BUFFER * 00040002
*            IS FULL, BUT NOT WRITTEN, SYNCH TO PROCESSING ROUTINE TO * 00041002
*            SCHEDULE WRITE.                                          * 00041202
*                                                                     * 00042002
* NOTES = SEE BELOW                                                   * 00043002
*                                                                     * 00044002
*    DEPENDENCIES = NONE                                              * 00045002
*                                                                     * 00046002
*    RESTRICTIONS = NONE                                              * 00047002
*                                                                     * 00048002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00049002
*                                                                     * 00050002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00051002
*                                                                     * 00052002
* MODULE-TYPE = CLOSE EXECUTOR                                        * 00053002
*                                                                     * 00054002
*    PROCESSOR = ASSEMXF-370R                                         * 00055002
*                                                                     * 00056002
*    MODULE-SIZE = 932 DECIMAL BYTES                                  * 00057002
*                                                                     * 00058002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00059002
*                                                                     * 00060002
* ENTRY-POINT = IGG0202I                                              * 00061002
*                                                                     * 00062002
*    PURPOSE = SEE FUNCTION                                           * 00063002
*                                                                     * 00064002
*    LINKAGE = RECEIVES CONTROL FROM IOS CLOSE WHEN FIXED LENGTH      * 00065002
*              RECORDS (FLR) SPECIFIED.  RECEIVES CONTROL IN STORAGE  * 00065202
*              PROTECT KEY 5 AND PRIVILEGED STATE.                    * 00066002
*                                                                     * 00068002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00069002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00070002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00071002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00072002
*               PARAMETER LIST                                        * 00073002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00074002
*                                                                     * 00075002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00076002
*          UPON ENTRY TO THIS MODULE                                  * 00077002
*                                                                     * 00078002
* EXIT-NORMAL = XCTL IN STORAGE PROTECT KEY 5 TO ISAM CLOSE EXECUTOR  * 00079002
*               IGG0202J FOR A NULL RESUME LOAD, OTHERWISE TO IGG0202N* 00079202
*                                                                     * 00080002
* EXIT-ERROR = SYNCH TO PROCESSING ROUTINE TO TAKE SYNAD EXIT IF A    * 00081002
*              SEQUENCE ERROR OCCURS.                                 * 00082002
*                                                                     * 00086002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00087002
*                                                                     * 00088002
*    ROUTINES = ISAM LOAD MODE PROCESSING AND APPENDAGE ROUTINES      * 00089002
*                                                                     * 00091002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00092002
*                 FORCORE - CLOSE WORK AREA                           * 00093002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00094002
*                                                                     * 00095002
*    CONTROL-BLOCKS = DCB, DCB COPY, IOB, CVT, TCB, AND SVRB          * 00096002
*                                                                     * 00097002
* TABLES = NONE                                                       * 00098002
*                                                                     * 00099002
* MACROS = MODESET, SYNCH, WAIT, AND XCTL                             * 00100002
*                                                                     * 00101002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00102002
*                                                                     * 00103002
*                                                                     * 01041002
*********************************************************************** 01042002
         EJECT                                                          01043002
********************                                                    01044002
* DCB REFERENCE    *                                                    01060000
********************                                                    01080000
         DCBD  DSORG=(IS)                                               01100000
         EJECT                                                          01140000
*****************************                                           01144000
* CLOSE WORK AREA REFERENCE *                                           01148000
******************************                                          01152000
FORCORE  DSECT                          OPEN/CLOSE/EOV WORK AREA Y01021 01156000
         IECDSECT                                                Y01021 01156800
         EJECT                                                          01157600
********************                                                    01160000
* DEB REFERENCE    *                                                    01180000
********************                                                    01200000
*                                                                       01220000
IHADEB   IGGDEBD                                                        01420021
         EJECT                                                          01940000
*********************************************************************** 01960000
* ISLCOMON REFERENCE     C(DCBWKPT1)=A(ISLCOMMON)                     * 01980000
*********************************************************************** 02000000
ISLCOMON IGGLOAD                                                        02400021
         USING ISLCOMON,R12                                      S21045 02800021
         EJECT                                                          03280002
*                                                                       03300000
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03320000
*                                                                       03340000
IOBBCT   DSECT                                                          03360000
         USING IOBBCT,R11                                               03380000
         DS    0D                                                       03400000
IOBFLAGS DS    0CL1                     FLAGS                           03420000
IOBPTRA  DS    A                        PTR A                           03440000
IOBB     DS    0CL1                     B                               03460000
IOBPTRB  DS    A                        PTR B                           03480000
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03500000
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03520000
*                                                                       03540002
********************                                                    03560000
* IOB REFERENCE    *                                                    03580000
********************                                                    03600000
*                                                                       03620000
IHAIOB   DSECT                                                          03640000
         DS    0D                                                       03680000
IOBFLG1  DS    CL1                      FLAGS 1                         03700000
IOBFLG2  DS    CL1                      FLAGS 2                         03720000
AIOBSENS DS    CL2                      SENSE BYTES              Y01021 03760000
IOBECBAD DS    A                        ECB POINTER                     03780000
AIOBCSW  DS    CL8                      CHANNEL STATUS WORD      Y01021 03800000
AIOBSIOC DS    0CL1                     SIO CC                   Y01021 03820000
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       03840000
IOBWT    DS    0CL1                     WEIGHT                          03860000
IOBDCBAD DS    A                        DCB POINTER                     03880000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     03900000
IOBBCTI  DS    CL2                      BLK CTR INCR                    03920000
IOBECT   DS    CL2                      ERROR CTR                       03940000
IOBDADAD DS    CL8                      DIR ACESS DEV ADR MBBCCHHR      03960000
*                                                                       03980000
********************                                                    04000000
* IXLT REFERENCE   *                                                    04020000
********************                                                    04040000
*                                                                       04060000
IXLT     DSECT                                                          04080000
         USING IXLT,R7                                                  04100000
         DS    0D                                                       04120000
IXLTIND  DS    CL1                      INDICATOR                  LEV1 04140000
IXLBEG   DS    CL8                      BEGINING COUNT MBBCCHHR         04160000
IXLSTP   DS    CL8                      STEPPING COUNT MBBCCHHR         04180000
IXLEND   DS    CL8                      ENDING COUNT   MBBCCHHR         04200000
         DS    CL1                                                      04220000
         DS    CL26                                                LEV2 04240000
         DS    CL26                                                LEV3 04260000
         DS    CL26                                                LEV4 04280000
         EJECT                                                          04290002
CVT      DSECT                                                   Y02072 04292002
         CVT                                                     Y02072 04294002
         SPACE 2                                                        04296002
TCB      IKJTCB                                                  Y02072 04298002
         EJECT                                                          04298402
         IKJRB                                                   Y02072 04298802
         EJECT                                                          04300000
IGG0202I CSECT                                                          04320000
ISLG500  BALR  R15,0                                                    04340000
         USING *,R15                                                    04360000
BASETAG  L     R1,0(RPARC)                                              04380000
         L     RCORE,4(RWTGC)                                           04400000
         USING FORCORE,RCORE            WA ADDRESSABILITY        Y02072 04410002
         USING IHADCB,R1                COPY DCB ADDRESSABILITY  Y02072 04412002
         L     R12,DCBWKPT1                                             04420000
         LR    RBASE,R15                                                04440000
         STM   R0,RJ,DXCCW1             SAVE REGISTERS           Y02072 04460002
*                                                                       04500000
* EQUATE SYMBOLIC REGISTERS                                             04520000
*                                                                       04540000
R0       EQU   0                                                        04560000
R1       EQU   1                                                        04580000
R2       EQU   2                                                        04600000
R3       EQU   3                                                        04620000
R4       EQU   4                                                        04640000
R5       EQU   5                                                        04660000
R6       EQU   6                                                        04680000
R7       EQU   7                                                        04700000
R8       EQU   8                                                        04720000
RCOPY    EQU   10                       DCB COPY BASE REG        Y02072 04760002
R11      EQU   11                                                       04780000
R12      EQU   12                                                       04800000
R13      EQU   13                                                       04820000
R14      EQU   14                                                       04840000
R15      EQU   9                                                        04860000
RBASE    EQU   3                                                        04900000
RCORE    EQU   4                                                        04920000
RPAR     EQU   5                                                        04940000
RWTG     EQU   6                                                        04960000
RPARC    EQU   7                                                        04980000
RWTGC    EQU   8                                                        05000000
RA       EQU   11                                                       05020000
RB       EQU   12                                                       05040000
RC       EQU   13                                                       05060000
RD       EQU   14                                                       05080000
RJ       EQU   15                                                       05100000
L5       EQU   5                        LENGTH OF ID-TTR                05120400
K0       EQU   0                        CONSTANT                 S20201 05121020
COMPLETE EQU   X'40'                    IOB COMPLETE SW          S20201 05122020
EOT      EQU   X'08'                    BUFFER AT END OF TRACK   S20201 05123020
EOTSW    EQU   X'01'                    DATA SET ENDS ON TRACK   S20201 05124020
*                                       * BOUNDARY. (DCBST)             05125020
ERRORX   EQU   X'DE'                    DCB MARKED IN ERROR      S20201 05126020
L3       EQU   3                        LENGTH                   S20201 05127020
K1       EQU   1                        CONSTANT                 S20201 05128020
K13      EQU   13                       CONSTANT                 S20201 05129020
K10      EQU   10                       CONSTANT                 S20201 05130020
K8       EQU   8                        CONSTANT                 S20201 05131020
CLOSE    EQU   X'40'                    CLOSE SW                 S20201 05132020
K26      EQU   26                       CONSTANT                 S20201 05133020
L7       EQU   7                        LENGTH                   S20201 05137020
CLOSE2   EQU   X'04'                    CLOSE SW                 S20201 05141020
K20      EQU   20                       CONSTANT                 S20201 05145020
WRCHK    EQU   X'80'                    WRITE CHECK SW DCB       S20201 05149020
RSLOAD   EQU   X'20'                    RESUME LOAD IND(DCBST)   XM6075 05149400
ISLKEYVL EQU   X'04'                    KEY SEQUENCE VALID       XM6075 05149800
CP20LAST EQU   X'03'                    CP20(FTIW) WAS SCHEDULED        05151001
*                                                                       05153020
         EJECT                                                          05160000
*********************************************************************** 05180000
* CHART G5 - CLOSE (FINISH PUT) HOUSEKEEPING                          * 05200000
*********************************************************************** 05220000
*                                                                       05240000
         TM    DCBST,X'20'              IS THIS A NULL RESUME LD M0170  05250021
         BO    ISLG820                  YES, BRANCH              M0170  05260000
         L     R2,DCBDEBAD              DEB ADDR FROM COPY DCB   Y02072 05270002
         USING IHADEB,R2                DEB ADDRESSABILITY       Y02072 05280002
         DROP  RCORE                    DROP USING ON WORK AREA  Y02072 05290002
         LR    R8,RCORE                 CLOSE WORK AREA ADDR     Y02072 05292002
         USING FORCORE,R8               WORK AREA ADDRSSABILITY  Y02072 05294002
         LR    RCOPY,R1                 DCB COPY ADDRESS         Y02072 05298002
         L     R1,DXUDCBAD              ADDRESS OF USER DCB      Y02072 05298402
*                                                                       05298502
         MODESET  KEYADDR=DXUKEY,WORKREG=4  CHANGE TO USER KEY   Y02072 05298802
*                                                                       05299202
         L     R11,ISLVPTR3             C(R11)=A(BCT)            XM6075 05300000
         CLC   ISLVPTRB,DCBSYNAD        TEST VPTER 11 VS A(SYNAD)XM6075 05320000
         BNE   ISLG5012                 B IF NOT EQUAL                  05340000
         OI    DCBEXCD2,X'20'           SET EXCD2 BIT 2 ON = NO SYNAD   05360000
ISLG5012 EQU   *                                                 Y02072 05380002
         OI    IOBFLAGS,X'10'           SET FLAGS BIT-3 ON (CLOSE)      05400000
         NI    IOBFLAGS,X'BD'           TURN OFF BITS 1 & 6       VLR   05430018
         NI    DCBST,X'FC'              CLEAR LAST BLK AND TRK    23769 05437018
*                                       BITS IN CASE RESUME LOAD        05444018
*                                       WAS USED                        05451018
*                                                                       05460000
* SET UP LINES OF COMMUNICATION TO PUT AND APP MODULES                  05480000
*                                                                       05500000
         L     R4,DEBEXPTR              DEB EXTENSION ADDRESS    S21045 05512021
         USING DEBEXT,R4                                         S21045 05518021
         L     R4,DEBPUT                PUT VECTOR               S21045 05524021
         DROP  R4                                                S21045 05530021
         LA    R4,6(R4)                 ISLF800+6 = PUT BASE            05540000
         ST    R4,ISLF8AD               STORE ADDR OF PUT BASE          05560000
         LA    R4,4(R4)                                          O19110 05580019
         ST    R4,ISLFXAD               STORE ADDR OF B TO ISLFX20      05600000
         LA    R4,4(R4)                                          O19110 05620019
         ST    R4,ISLFYAD               STORE ADDR OF B TO ISLFY01      05640000
         LA    R4,4(R4)                                          O19110 05660019
         ST    R4,ISLFZAD               STORE ADDR OF B TO ISLFZ01      05680000
         LA    R4,4(R4)                                          O19110 05700019
         ST    R4,ISLPAAD               STORE ADDR OF B TO ISLPA01      05720000
*                                                                       05740000
         L     R4,DEBAPPAD              AVT ADDRESS              S21045 05750021
         DROP  R2                       END USING ON DEB         Y02072 05752002
         USING DEBAVT,R4                                         S21045 05760021
         L     R4,DEBCEA                CHAN END ADDRESS         S21045 05770021
         DROP  R4                                                S21045 05780021
*                                                                       05790002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 05800002
*                                                                       05802002
         USING IHADCB,RCOPY             COPY DCB ADDR            Y02072 05810002
         ST    R4,DCBRELSE              CHAN END APP ADDR IN     Y02072 05812002
*                                       COPY DCB                        05814402
         DROP  RCOPY                    END USING ON COPY        Y02072 05816002
         USING IHADCB,R1                USER DCB ADDR            Y02072 05818002
*                                                                       05818102
         MODESET KEYADDR=DXUKEY,WORKREG=2  CHANGE TO USER KEY    Y02072 05818402
*                                                                       05820000
*                                                                       05840000
* AWAIT COMPLETION OF ALL PRIOR I/O ACTIVITY                            05860000
*                                                                       05880000
         LA    R2,ISLIOBB               C(R2)=A(IOBB)                   05940000
         USING IHAIOB,R2                IOB ADDRESSABILITY       Y02072 05950002
         BAL   R14,ISLG502              B TO COMMON WAIT                05960000
         LA    R2,ISLIOBC               C(R2)=A(IOBC)                   05980000
         BAL   R14,ISLG502              B TO COMMON WAIT                06000000
         BAL   R14,ISLG502A             B TO COMMON WAIT         XM6075 06030000
*                                                                       06320000
* TEST FOR MOVE OR LOCATE PUT                                           06340000
*                                                                       06360000
ISLG503  TM    DCBMACRF+1,X'10'         TEST MACRF BIT 11               06380000
         L     R7,DCBNREC               NUMBER OF RECORDS        A33664 06390020
         BC    1,ISLG508                B IF ON = MOVE PUT              06400000
*                                                                       06420000
* LOCATE PUT - CHECK SEQUENCE OF LAST PUT                               06440000
*                                                                       06460000
*                                       HOUSEKEEPING                    06480000
ISLG504  OI    DCBMACRF+1,X'10'         SET MACRF BIT 11 ON, SIM MOVE   06500000
         LH    R4,DCBRKP                C(R4)= RKP (00NN)               06520000
         A     R4,ISLCBF                C(R4)=RKP+CBF = A(KEY IN RCD)   06540000
         IC    R3,DCBKEYLE              C(R3)=KEYLEN                    06580000
         BCTR  R3,0                     C(R3)=KEYLEN-1,FOR EXECUTE      06600000
         L     R5,ISLVPTR2              C(R5)=A(KEYSAVE)         XM6075 06620000
*                                                                       06640000
         TM    DCBEXCD1,X'FE'                                           06660000
         BC    7,ISLG505                                                06680000
         TM    DCBEXCD2,X'C0'                PREVIOUS ERROR             06700000
         BNE   ISLG505                  YES,BRANCH                      06720000
         LA    R6,R2                    NREC 1 OR LESS           A33664 06730020
         CR    R7,R6                    *                        A33664 06740020
         BL    ISLG508                  B IF LOW, SEQ ERR IMPOSSIBLE    06760000
*                                                                       06780000
         EX    R3,ISLG504A              C(CBF+RKP) VS C(KEYSAVE)        06800000
         BH    ISLG508                  B IF NEW KEY HIGH, SEQUENCE OK  06820000
*                                                                       06840000
*                                       SEQUENCE NOT OK, TAKE SYNAD     06860000
*                                       ***************************     06880000
         NI    DCBMACRF+1,X'EF'         TURN BIT 11 BACK OFF (LOCATE)   06900000
         L     R13,ISLF8AD              ENTRY PT FOR SYNCH       Y02072 06910002
         BAL   R4,SYNCHRTN              SYNCH FOR SYNAD          Y02072 06920002
*                                                                       06960400
         TM    ISLIXLT,ISLKEYVL         DATA ADDED               XM6075 06962000
         BO    ISLG504                  YES - NOT NULL RS LOAD   XM6075 06964000
         OI    DCBST,RSLOAD             NO - MARK AS NULL RS LOADXM6075 06970000
         B     ISLG504                  GO TO HOUSEKEEPING AGAIN        06980000
*                                                                       07000000
*                                       PREV SEQ ERR, DROP LAST RCD     07020000
*                                                                       07021020
ISLG502A EQU   *                        *                        XM6075 07021400
         LA    R2,ISLIOBA               WAIT ON IOBA             XM6075 07021800
ISLG502  L     R4,IOBECBAD              C(R4)=A(ECB)             S20201 07022020
         DROP  R2                       END USING ON IOB         Y02072 07022402
         TM    0(R4),COMPLETE           TEST ECB BIT 1 (C-BIT)   S20201 07023020
         BCR   1,R14                    RETURN, I/O              S20201 07024020
*                                       COMPLETE-DONT WAIT       S20201 07025020
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)          S20201 07026020
         LR    R6,R14                   SAVE R14                 S20201 07027020
         LR    R3,R1                    SAVE R1                  S20201 07028020
         LR    R1,R4                    C(R1)=A(ECB)             S20201 07029020
         WAIT  ECB=(1)                  WAIT                     S20201 07030020
         LR    R1,R3                    RESTORE R1               S20201 07031020
         LR    R14,R6                   RESTORE R14              S20201 07032020
         BR    R14                      RETURN                   S20201 07039020
*                                                                       07046020
*                                       ***************************     07053020
ISLG505  EX    R3,ISLG505A              MOVE KEY FROM KEYSAVE TO BUFFR  07060000
ISLG505B EQU   *                        *                        A33664 07070020
         NI    DCBEXCD2,X'3F'           TURN EXCD2 BITS 0 AND 1 OFF     07080000
         BCTR  R7,0                     NREC-U                   A33664 07100020
         ST    R7,DCBNREC               STORE IT                 A33664 07120020
         L     R3,IOBPTRB               C(R3)=C(PTRB) = A(CURR SLOT)    07160000
         LA    R3,0(R3)                                                 07180000
         L     R4,0(R3)                 C(R4)=A(CURR BUFFR START)       07200000
         LA    R4,8(R4)                 C(R4)=A(1ST RCD IN CURR BUFFR)  07220000
         C     R4,ISLCBF                TEST A(1ST RCD) VS C(CBF)       07240000
         BNE   ISLG5085                 B NOT EQUAL TO BACK UP CBF      07260000
*                                                                       07280000
*                                       CBF POINTS TO 1ST RCD IN BUFFR  07300000
         NI    0(R3),X'80'              TURN OFF ALL STATUS BITS        07320000
         LA    R4,IOBABUF               C(R4)=A(SLOT 1)                 07340000
         CR    R3,R4                    TEST A(CURR SLOT) VS A(SLOT 1)  07360000
         BE    ISLG506                  B IF CURR SLOT = SLOT 1         07380000
         SH    R3,ISL4                  C(R3)=A(PREV SLOT)       O19110 07400019
         B     ISLG507                                                  07420000
ISLG506  L     R3,ISLBUFN               C(R3)=A(SLOT N) = A(PREV SLOT)  07440000
ISLG507  IC    R5,IOBB                  SAVE B                          07460000
         ST    R3,IOBPTRB               STORE A(PREV SLOT) IN PTRB      07480000
         STC   R5,IOBB                  RESTORE B                       07500000
         L     R4,0(R3)                 C(R4)=A(PREV BUF)               07520000
         LA    R4,0(R4)                                                 07540000
         MVC   DCBLPDA(8),DCBFTMI3      LPDA = PREVIOUS LPDA            07560000
         MVC   0(5,R4),DCBLPDA+3        PREV BUF CCHHR = LPDA CCHHR     07580000
         B     ISLG509                                                  07600000
*                                                                       07620000
* BUMP CBF                                                              07640000
*                                                                       07660000
ISLG508  EQU   *                                                 A33664 07668020
         TM    DCBEXCD1,X'20'           PREVIOUS SPACE PROBLEMS  A33664 07676020
         BO    ISLG505B                 YES CORRECT BUFFER PTRS  A33664 07684020
         L     R3,ISLCBF                C(R3)=CBF                A33664 07692020
         A     R3,ISLBMPR               C(R3)=CBF+BMPR                  07700000
         ST    R3,ISLCBF                C(CBF)=CBF+BMPR                 07720000
         NC    DCBNREC,DCBNREC          WAS DATA CREATED         A33664 07740020
         BE    ISLG509                  NO BRANCH                       07760000
*                                                                       07780000
* TEST IF CURR BUFFR FULL                                               07800000
*                                                                       07820000
ISLG5085 CLC   ISLCBF(4),ISLEOB         TEST CBF VS EOB                 07840000
         BL    ISLG601                  B IF CURR BUFFR NOT FULL        07860000
*                                                                       07880000
*                                       CURR BUFFR IS FULL              07900000
*                                                                       07920000
* TEST FOR LOCATE PUT, IF LOCATE (NOT SPECIAL) FULL BUF NOT YET WRITTEN 07940000
*                                                                       07960000
         TM    DCBMACRF+1,X'08'         TEST MACRF BIT 12 (LOCATE)      07980000
         BC    8,ISLG509                B IF 0, MOVE PUT                08000000
*                                                                       08020000
*                                       LOCATE PUT (NOT SPECIAL)        08040000
         L     R3,IOBPTRB               C(R3)=A(CURR SLOT)              08060000
         NI    0(R3),X'DF'              SET STATUS BITS 1 AND 2 = 10    08080000
         OI    0(R3),X'40'                                              08100000
         IC    R3,IOBB                  BUMP B, B=B+1                   08140000
         LA    R3,1(R3)                                                 08160000
         STC   R3,IOBB                                                  08180000
*                                                                       08200000
ISLG509  OI    DCBST,X'02'              TURN ON DCBST BIT 6             08220000
*                                                                       08240000
* TEST IF CURR BUFFR HAS BEEN WRITTEN                                   08260000
*                                                                       08280000
         L     R3,IOBPTRB               C(R3)=A(CURR SLOT)              08300000
         TM    0(R3),X'60'              TEST STATUS BITS 1 AND 2        08340000
         BNE   ISLG701                  B IF CURR BUFFR FULL,    S20201 08342020
*                                       * BUT NOT WRITTEN               08344020
         LA    R4,ISLG810               RETURN ADDRESS           S20201 08346000
         SPACE 5                                                 S20201 08348020
TESTEOT  EQU   *                        *                        S20201 08350020
         L     R3,IOBPTRB               BUFFER PTR               S20201 08352020
         TM    0(R3),EOT                D.S. END ON EOT          S20201 08354020
         BZ    EOT1                     NO - MARK IT ANY WAY     S20201 08356020
         OI    DCBST,EOTSW              DATA SET ENDS ON EOT     S20201 08358020
EOT1     OI    0(R3),EOT                FORCE EOT                S20201 08365020
         BR    R4                       RETURN                   S20201 08372020
         EJECT                                                          08420000
*********************************************************************** 08440000
* CHART G6 - CLOSE (PAD OUT BUFFER)                                   * 08460000
*********************************************************************** 08480000
*                                                                       08500000
* LOCATE LAST WR CKD TO BE EXECUTED IN CP18                             08520000
*                                                                       08540000
ISLG601  L     R3,IOBPTRB               C(R3)=A(CURR SLOT) = X          08560000
         LA    R3,0(R3)                                                 08580000
         LA    R4,IOBABUF               C(R4)=A(1ST SLOT)               08600000
         SR    R3,R4                    C(R3)=NO OF BYTES X IS FROM 1   08620000
         SRA   R3,2                     DIV BY 4, C(R3)=DIFF IN SLOTS   08640000
         L     R5,ISLOFFST              C(R4+R5)=OFFST                  08660000
         MR    R4,R3                    X X OFFST, C(R5) = THE NO OF    08680000
*                                         BYTES WR CKD X IS FROM THE    08700000
*                                         1ST BYTE OF WR CKD 1          08720000
         L     R4,ISLVPTR4              C(R4)=A(CP18)            XM6075 08740000
         LA    R4,24(R4,R5)             C(R4)=A(WR CKD 1)        XM6075 08760000
*                                                                       08800000
* BACK UP CBF, BUFFER NOT FULL                                          08820000
*                                                                       08840000
         L     R3,ISLCBF                C(R3)=CBF                       08860000
         S     R3,ISLBMPR               C(R3)=CBF-BMPR                  08880000
*                                                                       08900000
* SET KEY ADDR IN LAST WR CKD TO REFERENCE LAST REAL RCD                08920000
*                                                                       08940000
         LH    R5,DCBRKP                C(R5)= RKP (00NN)               08960000
         AR    R5,R3                    C(R5)=CBF+RKP = A(LAST KEY)     08980000
         ST    R5,8(R4)                 STORE KEY ADDR WITH OP = 0      09000000
*                                                                       09020000
         A     R3,ISLBMPR               C(R3)=NEW CBF                   09040000
         BCTR  R3,0                     C(R3)=CBF-1                     09060000
         LR    R0,R3                    C(R0)=CBF-1                     09080000
         MVC   TSTWK2C(1),0(R3)         C(WK2C)=C(CBF-1),SAVE    O19110 09100019
*                                       BYT                      O19110 09120019
         MVI   0(R3),X'FF'              C(CBF-1)=BINARY IS = PADDING    09140000
         NI    ISLECBA,X'BF'            INDICATE ECB BUSY SO PROCESSING 09160002
*                                       MODULE WON'T WRITE OUT BUFFER   09180002
*                                       BEFORE LAST BYTE OF RECORD      09190002
*                                       IS RESTORED             OX00614 09192002
ISLG602  L     R13,ISLFXAD              C(R13)=A(ISLFX20)               09200000
         BAL   R4,SYNCHRTN              SYNCH TO MOVE PADDING    Y02072 09220002
*                                                                       09300000
* BUMP CBF                                                              09320000
*                                                                       09340000
         L     R3,ISLCBF                C(R3)=CBF                       09360000
         A     R3,ISLBMPR               C(R3)=CBF+BMPR                  09380000
         ST    R3,ISLCBF                C(CBF)=CBF+BMPR                 09400000
*                                                                       09420000
* TEST FOR EOB, HAS RCD JUST MOVED FILLED A BUFFER                      09440000
*                                                                       09460000
         C     R3,ISLEOB                TEST CBF VS EOB                 09480000
         BL    ISLG602                  B IF NOT EOB                    09500000
*                                                                       09520000
* BUFFER FILLED, EOB                                                    09540000
*                                                                       09560000
         LR    R3,R0                    C(R3)=A(BORROWED BYTE)          09580000
         MVC   0(1,R3),TSTWK2C          RESTORE BYTE             O19110 09610019
         OI    ISLECBA,X'40'            INDICATE ECB NOT BUSY SO        09640002
*                                       PROCESSING MODULE WILL          09660002
*                                       WRITE OUT THIS BUFFER   OX00614 09670002
         SPACE 4                                                        09680002
*********************************************************************** 09700000
* CHART G7 - CLOSE (WR BUFFERS)                                       * 09720000
*********************************************************************** 09740000
*                                                                       09760000
* TEST B VS FBW                                                         09780000
*                                                                       09800000
ISLG701  BAL   R4,TESTEOT               CHECK FOR END OF TRACK   S20201 09807020
*                                                                       09809000
         B     ISLG704                  ENSURE ALL I/0 COMPLETE  A50362 09811000
*                                                                       09813000
ISLG701A EQU   *                        SCHEDULE LOOP            S20201 09814020
*                                       * FORCE INDEX                   09821020
         TM    DCBEXCD1,ERRORX          UNCORRECTABLE ERRORS     S20201 09831020
         BM    ISLG810                  YES TAKE BRANCH           13662 09860000
         CLC   IOBB(1),ISLFBW+3         TEST B VS FBW                   09900000
         BH    ISLG702                  B IF B GR THAN FBW              09920000
         IC    R3,IOBB                  C(R3)=B                         09940000
         STC   R3,ISLFBW+3              C(FBW)=B                        09960000
*                                                                       09980000
ISLG702  L     R13,ISLFYAD              C(R13)=A(ISLFY01)               10000000
         BAL   R4,SYNCHRTN              SYNCH TO WRITE BUFFERS   Y02072 10020002
*                                                                       10100000
ISLG704  EQU   *                        WAIT ON IOBA             A50362 10110000
         BAL   R14,ISLG502A             B TO COMMON WAIT         XM6075 10140000
*                                                                       10160000
* TEST B VS 0                                                           10180000
*                                                                       10200000
         CLI   IOBB,X'00'               TEST B VS 0              O19110 10220019
         BH    ISLG701A                 BR TO SCHEDULE REST      S20201 10240020
*                                                                       10260000
         EJECT                                                          10280000
ISLG810  LM    R0,RJ,DXCCW1             RESTORE ALL REGISTERS    Y02072 12180002
         DROP  R8                       END USING ON WORK AREA   Y02072 12190002
*                                                                       12190402
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 12192002
*                                                                       12194002
         USING BASETAG,RBASE                                            12200000
         MVC   0(L'LOAD2N,RWTGC),LOAD2N NEXT LOAD ID - IGG0202N  Y02072 12220002
         B     RELOOP                   GO SEARCH WTG TABLE             12230000
ISLG820  MVC   0(L'LOAD2J,RWTGC),LOAD2J GO TO 202J.  REGS STILL  Y02072 12232002
*                                       PROPERLY INITIALIZED.           12234000
*                                                                       12236002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       12240000
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       12260000
         CLC   0(2,RWTGC),THISLOAD                                      12280000
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 12300000
         CLI   0(RWTGC),X'F0'           TEST FOR END OF WTG TABLE  MC1A 12320018
         BC    7,RELOOP                 BRANCH=NOT AT END               12340000
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                12360000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                12380000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              12400000
         BC    7,TCTLRTN                BRANCH = NOT ZERO               12420000
ITSZERO  LA    RWTGC,8(RWTGC)                                           12440000
         LA    RPARC,4(RPARC)                                           12460000
         B     ZCHECK                                                   12480000
TCTLRTN  EQU   *                                                        12500000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         12520000
         USING FORCORE,RCORE                                     Y01021 12544000
         LA    RJ,DXCCW12               WA ADDRESS               Y01021 12560000
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 12580002
         EJECT                                                          12600002
***********************************************                         12610002
* SYNCH SUBROUTINE - GO TO PROCESSING ROUTINE *                         12612002
***********************************************                         12614002
*                                                                       12616002
         USING FORCORE,R8               CLOSE WA ADDRESSABILITY  Y02072 12616102
*                                                                       12616202
SYNCHRTN MODESET EXTKEY=DATAMGT         CHANGE TO DATA MGT KEY   Y02072 12616402
*                                                                       12616802
         STM   R0,R5,DXCCW9             SAVE REGISTERS 0-5       Y02072 12618002
         L     RJ,CVTPTR                ADDR OF CVT              Y02072 12618402
         USING CVT,RJ                   CVT ADDRESSABILITY       Y02072 12618802
         L     RJ,CVTTCBP               ADDR OF TCB PTRS         Y02072 12619202
         L     RJ,0(RJ)                 TCB ADDR                 Y02072 12619602
         USING TCB,RJ                   TCB ADDRESSABILITY       Y02072 12619702
         L     RJ,TCBRBP                SVRB ADDRESS             Y02072 12619802
         USING RBBASIC,RJ               RB ADDRESSABILITY        Y02072 12619902
*                                                                       12620302
         MODESET KEYADDR=KEY0,WORKREG=4  CHANGE TO KEY ZERO      Y02072 12621902
*                                                                       12623902
         STM   R6,RJ,RBEXSAVE           SAVE REGISTERS 6-15      Y02072 12626602
         DROP  RJ                       END USING ON RB          Y02072 12628602
         L     R15,ISLF8AD              SET BASE ADDR FOR RTN    Y02072 12630602
         LR    RJ,R13                   ENTRY POINT TO REG 15    Y02072 12633002
*                                                                       12634702
         SYNCH (15)                     GO TO PROCESSING RTN     Y02072 12638302
*                                                                       12638702
         L     RJ,CVTPTR                CVT ADDRESS              Y02072 12640002
         USING CVT,RJ                   CVT ADDRESSABILITY       Y02072 12641902
         L     RJ,CVTTCBP               ADDR OF CVT PTRS         Y02072 12643902
         L     RJ,0(RJ)                 ADDRESS OF TCB           Y02072 12645902
         USING TCB,RJ                   TCB ADDRESSABILITY       Y02072 12646302
         L     RJ,TCBRBP                SVRB ADDRESS             Y02072 12646402
         USING RBBASIC,RJ               RB ADDRESSABILITY        Y02072 12646502
         LM    R6,RJ,RBEXSAVE           RESTORE REGS 6-15        Y02072 12653202
         DROP  RJ                       END USING ON SVRB        Y02072 12655202
*                                                                       12655302
         MODESET KEYADDR=DXUKEY,WORKREG=5 CHANGE TO USER KEY     Y02072 12655602
*                                                                       12656002
         LM    R0,R5,DXCCW9             RESTORE REGS 0-5         Y02072 12657202
         BR    R4                       RETURN                   Y02072 12659202
         EJECT                                                          12659902
*                                                                       12666602
* CONSTANTS                                                             12673302
*                                                                       12680000
ISL4     DC    H'0004'                                           O19110 12700019
KEY0     EQU   ISL4                     STORAGE PROTECT KEY ZERO Y02072 12710002
THISLOAD DC    C'2I'                                             O19110 12720019
*                                                                       12760000
ISLG504A CLC   0(1,R4),0(R5)            KEY COMP TO BE EXECUTED (L)     12780000
ISLG505A MVC   0(1,R4),0(R5)            KEY MOVE TO BE EXECUTED (L)     12800000
*                                                                       12820000
LOAD2J   DC    C'2J'                    ID OF MODULE IGG0202J    Y02072 12830002
LOAD2N   DC    C'2N'                    ID OF MODULE IGG0202N    Y02072 12840002
*                                                                       12850002
PATCH    DC    XL50'00'                 ZEROED PATCH AREA        Y02072 12860002
         SPACE 1                                                        13000002
         END                                                            13020000
