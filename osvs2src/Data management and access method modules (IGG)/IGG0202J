         TITLE 'IGG0202J - QISAM LOAD MODE CLOSE- WRITE EOF'            00020000
IGG0202J CSECT                                                          00021002
*                                                                       00022002
*********************************************************************** 00023002
*                                                                     * 00024002
* MODULE-NAME = IGG0202J                                              * 00025002
*                                                                     * 00026002
* DESCRIPTIVE-NAME = ISAM CLOSE, LOAD MODE                            * 00027002
*                                                                     * 00028002
* COPYRIGHT = NONE                                                    * 00029002
*                                                                     * 00030002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00031002
*                                                                     * 00032002
* FUNCTION = IF NOT A NULL RESUME LOAD, AND HIGH-LEVEL INDICES EXIST  * 00033002
*            FOR FIXED LENGTH RECORDS (FLR), GET CORE FROM SUBPOOL    * 00034002
*            230 FOR A REGISTER SAVE AREA; LINK TO CHANNEL END        * 00034202
*            APPENDAGE TO DETERMINE IF ANY INDICES NEED TO BE         * 00035002
*            WRITTEN; FINISH WRITING INDICES, IF REQUIRED; AND FREE   * 00036002
*            SAVE AREA CORE.  IF NOT A NULL RESUME LOAD, STORE INDEX  * 00037002
*            COUNTS IN DCB; SYNCH TO PUT ROUTINE TO GET A NEW COUNT   * 00038002
*            AND PREFORMAT, IF REQUIRED; FOR FLR, EXECUTE CP21 ONCE   * 00039002
*            TO WRITE EOF INDICATOR FOR PRIME DATA, AND AGAIN FOR     * 00040002
*            INDEPENDENT OVERFLOW, IF REQUIRED.                       * 00041002
*                                                                     * 00042002
* NOTES = SEE BELOW                                                   * 00043002
*                                                                     * 00044002
*    DEPENDENCIES = NONE                                              * 00045102
*                                                                     * 00046002
*    RESTRICTIONS = NONE                                              * 00047002
*                                                                     * 00048002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00049002
*                                                                     * 00050002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00051002
*                                                                     * 00052002
* MODULE-TYPE = CLOSE EXECUTOR                                        * 00053002
*                                                                     * 00054002
*    PROCESSOR = ASSEMXF-370R                                         * 00055002
*                                                                     * 00056002
*    MODULE-SIZE = 1102 DECIMAL BYTES                                 * 00057002
*                                                                     * 00058002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00059002
*                                                                     * 00060002
* ENTRY-POINT = IGG0202J                                              * 00061002
*                                                                     * 00062002
*    PURPOSE = SEE FUNCTION                                           * 00063002
*                                                                     * 00064002
*    LINKAGE = RECEIVES CONTROL FROM ISAM CLOSE EXECUTOR IGG0202N FOR * 00065002
*              FIXED LENGTH RECORDS, OR IGG02028 FOR VLR.  RECEIVES   * 00066002
*              RECEIVES CONTROL IN STORAGE PROTECT KEY 5 AND          * 00066202
*              PRIVILEGED STATE.                                      * 00067002
*                                                                     * 00068002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00069002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00070002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00071002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00072002
*               PARAMETER LIST                                        * 00073002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00074002
*                                                                     * 00075002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00076002
*          UPON ENTRY TO THIS MODULE                                  * 00077002
*                                                                     * 00078002
* EXIT-NORMAL = XCTL IN STORAGE PROTECT KEY 5 TO ISAM CLOSE EXECUTOR  * 00079002
*               IGG0202D FOR A NULL RESUME LOAD, OTHERWISE TO IGG0202K* 00079202
*                                                                     * 00080002
* EXIT-ERROR = NONE                                                   * 00081002
*                                                                     * 00086002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00087002
*                                                                     * 00088002
*    ROUTINES = ISAM LOAD MODE PROCESSING AND APPENDAGE ROUTINES      * 00089002
*                                                                     * 00091002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00092002
*                 FORCORE - CLOSE WORK AREA                           * 00093002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00094002
*                                                                     * 00095002
*    CONTROL-BLOCKS = DCB, DCB COPY, CVT, SVRB, DEB, IOB, AND TCB     * 00096002
*                                                                     * 00097002
* TABLES = BUFFER CONTROL TABLE                                       * 00098002
*                                                                     * 00099002
* MACROS = MODESET, WAIT, GETMAIN, FREEMAIN, EXCP, SYNCH, AND XCTL    * 00100002
*                                                                     * 00101002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00102002
*                                                                     * 00103002
*        RELEASE OS/VS2-02 DELETIONS                                  * 00104002
*                                                               YM01334 00105002
*                                                               YM06944 00155002
*                                                                     * 01001002
*********************************************************************** 01002002
         EJECT                                                          01003002
********************                                                    01004002
* DCB REFERENCE    *                                                    01020000
********************                                                    01040000
         DCBD  DSORG=(IS)                                               01060000
         EJECT                                                          01080002
CVT      DSECT                                                   Y02072 01090002
         CVT                                                     Y02072 01092002
         SPACE 1                                                        01094002
TCB      IKJTCB                                                  Y02072 01096002
         EJECT                                                          01098002
         IKJRB                                                   Y02072 01098402
         EJECT                                                          01100000
*****************************                                           01104000
* CLOSE WORK AREA REFERENCE *                                           01108000
*****************************                                           01112000
FORCORE  DSECT                          OPEN/CLOSE/EOV WORK AREA Y01021 01116000
         IECDSECT                                                Y01021 01116800
         EJECT                                                          01117600
********************                                                    01120000
* DEB REFERENCE    *                                                    01140000
********************                                                    01160000
*                                                                       01180000
IHADEB   DSECT                                                          01200000
         USING IHADEB,R8                                                01220000
         DS    0D                                                       01240000
DEBNMSUB DS    0CL1                                                     01260000
DEBTCBAD DS    A                                                        01280000
DEBAMLNG DS    0CL1                                                     01300000
DEBDEBAD DS    A                                                        01320000
DEBOFLGS DS    0CL1                                                     01340000
DEBIRBAD DS    A                                                        01360000
DEBOPATB DS    0CL1                                                     01380000
DEBSYSPG DS    A                                                        01400000
DEBNMEXT DS    0CL1                                                     01420000
DEBUSRPG DS    A                                                        01440000
DEBPRIOR DS    0CL1                                                     01460000
DEBECBAD DS    A                                                        01480000
DEBPROTG DS    0BL1                                                     01500000
DEBDEBID DS    0BL1                                                     01520000
DEBDCBAD DS    A                                                        01540000
DEBEXSCL DS    0CL1                                                     01560000
DEBAPPAD DS    A                                                        01580000
DEBNIEE  DS    0CL1                                                     01600000
DEBFIEAD DS    A                                                        01620000
DEBNPEE  DS    0CL1                                                     01640000
DEBFPEAD DS    A                                                        01660000
DEBNOEE  DS    0CL1                                                     01680000
DEBFOEAD DS    A                                                        01700000
         DS    CL4                                                      01720000
DEBDVMOD DS    0CL1                                                     01740000
DEBUCBAD DS    A                                                        01760000
DEBBINUM DS    CL2                                                      01780000
DEBSTRCC DS    CL2                                                      01800000
DEBSTRHH DS    CL2                                                      01820000
DEBENDCC DS    CL2                                                      01840000
DEBENDHH DS    CL2                                                      01860000
DEBNMTRK DS    CL2                                                      01880000
         EJECT                                                          01900000
*********************************************************************** 01920000
* ISLCOMON REFERENCE     C(DCBWKPT1)=A(ISLCOMMON)                     * 01940000
*********************************************************************** 01960000
*                                                                       01980000
ISLCOMON DSECT                                                          02000000
         USING ISLCOMON,R12                                             02020000
         DS    0D                                                       02040000
ISLECBA  DS    A                        FOR CP18 AND CP20               02060000
ISLIOBA  DS    CL40                                                     02080000
ISLECBB  DS    A                        FOR CP21                        02100000
ISLIOBB  DS    CL40                                                     02120000
ISLECBC  DS    A                        FOR CP19                        02140000
ISLIOBC  DS    CL40                                                     02160000
ISLAREAZ DS    CL88                     FOR CP19                        02180000
ISLIXLT  DS    CL104                    INDEX LOCATION TABLE            02200000
ISLNIRT  DS    CL3                      HHR OF DUMMY TRACK INDEX        02220000
ISLHIRT  DS    CL1                      NO INDX ENT ON PRIM DATA TRACK  02240000
ISLCBF   DS    F                        BUF CTRL PTR (RCD WITHIN BUF)   02260000
ISLBMPR  DS    F                        USED TO BUMP CBF TO NEXT RCD    02280000
ISLFBW   DS    F                        NO OF BUFS SCHED TO WRITE       02300000
ISLEOB   DS    F                        END OF BUFFR ADR                02320000
ISLNCNT  DS    CL8                      NORMAL IX COUNT, CCHHRKDD       02340000
ISLOCNT  DS    CL8                      OVFLOL IX COUNT, CCHHRKDD       02360000
ISLDCNT  DS    CL8                      DUMMY IX COUNT,  CCHHRKDD       02380000
ISLNDAT  DS    CL10                     NORMAL IX DATA, MBBCCHHRFP      02400000
         DS    CL2                                                      02420000
ISLODAT  DS    CL10                     OVFLOW IX DATA, MBBCCHHRFP      02440000
         DS    CL1                                                      02460000
ISLBUFNO DS    CL1                      DCBBUFNO OR 2                   02480000
ISLBUFN  DS    F                        ADDR OF SLOT N IN BCT           02500000
ISLMVC   DS    F                        COUNT OF EXECUTED MOVE (N-1)    02520000
ISLMVCT  DS    F                        NOMBR OF 255 BYTE MOVES (N+1)   02540000
ISLVRSAV DS    18F                      ISL SAVE AREA                   02560000
ISLAPSAV DS    10F                      APPENDAGE SAVE AREA             02580000
ISLWRSAV DS    16F                      ISL SAVE AREA FOR CLOSE         02600000
*                                                                       02620000
TSTWK1C  DS    F                        WORK AREA                 13711 02640016
TSTWK2C  DS    F                        WORK AREA                 13711 02660016
         DS    F                        WORK AREA                 13711 02680016
ISLNOENT DS    F                        NO ENTRIES REMAINING ON TRACK   02700000
ISLOFFST DS    F                        SIZE OF WR CKD INSTR IN BYTES   02720000
ISLD     DS    F                        DISCPLACEMENT FROM CP18 START   02740000
ISLFSTBF DS    F                        ADDR OF 1ST SCHED BUF (REL)     02760000
ISLLSTBF DS    F                        ADDR OF LAST SCHED BUF (REL)    02780000
ISLCCFAD DS    F                        ADDR OF CC FLAG IN CP18         02800000
ISLKEYAD DS    F                        ADDR OF KEY OF LAST RCD ON TRK  02820000
*                                                                       02840000
ISLF8AD  DS    F                        ADDR OF PUT ISLF800             02860000
ISLFXAD  DS    F                        ADDR OF PUT ISLFX20             02880000
ISLFYAD  DS    F                        ADDR OF PUT ISLFY01             02900000
ISLFZAD  DS    F                        ADDR OF PUT ISLFZ01             02920000
ISLPAAD  DS    F                        ADDR OF PUT ISLPA01             02940000
ISLF1AD  DS    F                        ADDR OF APP ISLF110             02960000
*                                                                       02980000
         SPACE 2                                                        03000002
*                                                                       03020000
* ISLVPTRS REFERENCE       C(DCBWKPT6)=A(ISLVPTRS)                      03040000
*                                                                       03060000
ISLVPTRS EQU   *                                                  25463 03070018
ISLVPTR1 DS    A                        A(AREA Y)                 25463 03080018
ISLVPTR2 DS    A                        A(KEYSAVE)                25463 03090018
ISLVPTR3 DS    A                        A(IOBBCT)                 25463 03100018
ISLVPTR4 DS    A                        A(CP18)                   25463 03110018
ISLVPTR5 DS    A                        A(CP19)                   25463 03120018
ISLVPTR6 DS    A                        A(CP20)                   25463 03130018
ISLVPTR7 DS    A                        A(CP21)                   25463 03140018
ISLVPTR8 DS    A                        SIZE OF ISLCOMON AREA     25463 03150018
ISLVPTR9 DS    A                        SIZE OF CHAN PROG AREA    25463 03160018
ISLVPTRA DS    A                        ADDRESS OF BAD BUFFER     25463 03170018
ISLVPTRB DS    A                        UNUSED                    25463 03180018
ISLVPTRC DS    A                        UNUSED                    25463 03190018
ISLFXWK1 DS    F                        WORK AREA                 13711 03228016
ISLFXWK2 DS    F                        WORK AREA                 13711 03232016
ISLF9WK1 DS    F                        WORK AREA                 13711 03236016
*                                                                       03240000
*                                                                       03260000
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03280000
*                                                                       03300000
IOBBCT   DSECT                                                          03320000
         USING IOBBCT,R11                                               03340000
         DS    0D                                                       03360000
IOBFLAGS DS    0CL1                     FLAGS                           03380000
IOBPTRA  DS    A                        PTR A                           03400000
IOBB     DS    0CL1                     B                               03420000
IOBPTRB  DS    A                        PTR B                           03440000
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03460000
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03480000
         EJECT                                                          03500000
********************                                                    03520000
* IOB REFERENCE    *                                                    03540000
********************                                                    03560000
*                                                                       03580000
IHAIOB   DSECT                                                          03600000
         USING IHAIOB,R2                                                03620000
         DS    0D                                                       03640000
IOBFLG1  DS    CL1                      FLAGS 1                         03660000
IOBFLG2  DS    CL1                      FLAGS 2                         03680000
AIOBSENS DS    CL2                      SENSE BYTES              Y01021 03720000
IOBECBAD DS    A                        ECB POINTER                     03740000
AIOBCSW  DS    CL8                      CHANNEL STATUS WORD      Y01021 03760000
AIOBSIOC DS    0CL1                     SIO CC                   Y01021 03780000
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       03800000
IOBWT    DS    0CL1                     WEIGHT                          03820000
IOBDCBAD DS    A                        DCB POINTER                     03840000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     03860000
IOBBCTI  DS    CL2                      BLK CTR INCR                    03880000
IOBECT   DS    CL2                      ERROR CTR                       03900000
IOBDADAD DS    CL8                      DIR ACESS DEV ADR MBBCCHHR      03920000
*                                                                       03940000
********************                                                    03960000
* IXLT REFERENCE   *                                                    03980000
********************                                                    04000000
*                                                                       04020000
IXLT     DSECT                                                          04040000
         DS    0D                                                       04080000
IXLTIND  DS    CL1                      INDICATOR                  LEV1 04100000
IXLBEG   DS    CL8                      BEGINING COUNT MBBCCHHR         04120000
IXLSTP   DS    CL8                      STEPPING COUNT MBBCCHHR         04140000
IXLEND   DS    CL8                      ENDING COUNT   MBBCCHHR         04160000
         DS    CL1                                                      04180000
         DS    CL26                                                LEV2 04200000
         DS    CL26                                                LEV3 04220000
         DS    CL26                                                LEV4 04240000
         EJECT                                                          04260000
IGG0202J CSECT                                                          04280000
ISGL500  EQU   *                           *                     S20201 04290020
         BALR  RBASE,0                     ADDRESSIBILITY        S20201 04300020
         USING *,RBASE                                           S20201 04310020
BASETAG  L     R1,0(RPARC)                                              04340000
         L     RCORE,4(RWTGC)                                           04360000
         USING IHADCB,R1                COPY DCB                 Y02072 04370002
         USING FORCORE,RCORE            CLOSE WORK AREA          Y02072 04372002
         L     R12,DCBWKPT1                                             04380000
         LR    R15,RBASE                   ADDRESSIBILITY        S20201 04400020
         ST    RBASE,DXCCW10            SAVE BASE ADDRESS        Y02072 04410002
         STM   R1,RJ,DXCCW1             SAVE REGISTERS 1-15      Y02072 04420002
*                                                                       04430002
         MODESET  KEYADDR=DXUKEY,WORKREG=10  CHANGE TO USER KEY  Y02072 04470002
*                                                                       04472002
         LR    R10,RCORE                WA ADDRESSABILITY        Y02072 04480002
         DROP  RCORE                    END USING ON CLOSE WA    Y02072 04482002
         USING FORCORE,R10              CLOSE WA ADDRESSABILITY  Y02072 04484002
         LR    R7,R1                    SAVE DCB COPY ADDR       Y02072 04490002
         L     R1,DXUDCBAD              USER DCB ADDRESS         Y02072 04492002
*                                                                       04500000
* EQUATE SYMBOLIC REGISTERS                                             04520000
*                                                                       04540000
R0       EQU   0                                                        04560000
R1       EQU   1                                                        04580000
R2       EQU   2                                                        04600000
R3       EQU   3                                                        04620000
R4       EQU   4                                                        04640000
R5       EQU   5                                                        04660000
R6       EQU   6                                                        04680000
R7       EQU   7                                                        04700000
R8       EQU   8                                                        04720000
R10      EQU   10                                                       04760000
R11      EQU   11                                                       04780000
R12      EQU   12                                                       04800000
R13      EQU   13                                                       04820000
R14      EQU   14                                                       04840000
R15      EQU   9                                                        04860000
RBASE    EQU   3                                                        04900000
RCORE    EQU   4                                                        04920000
RPAR     EQU   5                                                        04940000
RWTG     EQU   6                                                        04960000
RPARC    EQU   7                                                        04980000
RWTGC    EQU   8                                                        05000000
RA       EQU   11                                                       05020000
RB       EQU   12                                                       05040000
RJ       EQU   15                                                       05100000
REGSAVE  EQU   64                       REG SAVE AREA SIZE       Y02072 05102002
SUB230   EQU   230                      SUBPOOL FOR REG SAVE     Y02072 05104002
FOUR     EQU   4                        CONSTANT OF 4            Y01021 05109000
THIRTY   EQU   30                       BUFFER LIMIT FOR AOS            05110001
*                                                                       05140000
*                                                                       05140920
*   FINISH WRITING ANY HIGH LEVEL INDEXES THAT NEED TO BE WRITTEN       05141820
*   BY LINKING TO THE APPENDAGE.                                        05142720
*                                                                       05143620
         TM    DCBST,X'20'              IS IT A NULL RESUME LD   M0170  05143921
         BO    ISLG9066                 YES, BRANCH              M0170  05144221
         TM    DCBRECFM,X'80'           FIXED                    S20201 05144520
         BZ    ISLG501                  NO - VLR - DONE          S20201 05145420
         CLI   DCBNLEV,X'01'            CYL INDEX ONLY           S20201 05146320
         BNH   ISLG501                  NO MASTER INDEX - BR     S20201 05147220
*   WAIT ON PREVIOUS I/O TO COMPLETE.                                   05148120
         LA    R2,ISLIOBB               CP21                     S20201 05149020
         BAL   R14,ISLG502              LINK TO COMMON WAIT      S20201 05149920
         LR    R4,R1                    DCB ADDRESS              S20201 05185202
*                                                                       05187202
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 05190102
*                                                                       05190202
         LA    R14,REGSAVE              SIZE OF REG SAVE AREA    Y02072 05190502
         DROP  RBASE                    CHANGE BASE             YM01334 05192602
         USING BASETAG,R15              REGISTER                YM01334 05194602
*                                                                       05199202
         GETMAIN  R,LV=(R14),SP=SUB230  GET SAVE AREA FOR APP    Y02072 05201302
*                                                                       05203402
*                                                                       05205502
*   SET UP DEB ADDRESS AND REGISTERS FOR APPENDAGES IGG019GC/GD.        05207602
*                                                                       05209702
         DROP  R1                       END ADDR REAL DCB        Y02072 05211802
         USING IHADCB,R7                USING ON COPY DCB        Y02072 05213902
         L     RJ,DCBRELSE              ADDR OF CE APPENDAGE     Y02072 05216002
         L     R3,DCBDEBAD              DEB ADDR APPENDAGES      Y02072 05218102
         DROP  R7                       END USING ON COPY DCB    Y02072 05220202
         USING IHADCB,R1                USING ON USER DCB        Y02072 05222302
         LR    R13,R1                   SAVAREA ADDR FOR APPEND  Y02072 05224402
         LR    R7,R1                    SAVE ADDR FOR FREEMAIN   Y02072 05226502
         LR    R1,R4                    RESTORE USERS DCB ADDR   Y02072 05228602
*                                                                       05230702
         BALR  R14,RJ                   LINK TO APPENDAGE        Y02072 05232802
*                                                                       05234902
         L     RBASE,DXCCW10            RESTORE ADDRESSABILITY   Y02072 05237002
         DROP  R15                      CHANGE BASE             YM01334 05238902
         USING BASETAG,RBASE            REGISTER                YM01334 05239002
         B     ISLG500                  ALL INDEXES WRITTEN      Y02072 05239102
*                                                                       05241202
*  APPENDAGE RETURNS TO FOLLOWING INSTRUCTION IF EXCP NEEDED            05243302
*                                                                       05245402
         MODESET  KEYADDR=DXUKEY,WORKREG=13 CHANGE TO USER KEY   Y02072 05247502
*                                                                       05249602
         L     RBASE,DXCCW10            RESTORE BASE ADDR       YM01334 05251502
         L     R12,DCBWKPT1             RESTORE LOAD WA ADDR     Y02072 05251702
         LA    R13,ISLVRSAV             SAVE AREA                S20201 05253802
         EXCP  ISLIOBB                  WRITE INDEX              S20201 05255902
*                                                                       05258002
ISLG500  MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 05260102
*                                                                       05262202
         LR    R1,R7                    ADDRESS OF CORE          Y02072 05264302
*                                                                       05266402
         FREEMAIN  R,LV=REGSAVE,A=(1),SP=SUB230    FREE CORE     Y02072 05268502
*                                                                       05270602
         MODESET  KEYADDR=DXUKEY,WORKREG=1  CHANGE TO USER KEY   Y02072 05272702
*                                                                       05274802
         LR    R1,R4                    RESTORE DCB ADDRESS      Y02072 05276902
         EJECT                                                          05279002
*********************************************************************** 05281102
* CHART G5 - CLOSE (FINISH PUT) HOUSEKEEPING                          * 05283202
*********************************************************************** 05285302
*                                                                       05287402
ISLG501  EQU   *                           *                     S20201 05289502
         USING BASETAG,R15                                       S20201 05291602
         L     R12,DCBWKPT1                C(R12) = A(COMMON)    S20201 05293702
         L     R15,DXCCW10              RESTORE BASE ADDRESS     Y02072 05295802
         L     R11,ISLVPTR3             BUFFER CONTROL TABLE     Y02072 05297902
         LA    R2,ISLIOBB               C(R2)=A(IOBB)                   05300000
         LA    R14,ISLG901              C(R14)=A(ISLG901) *WAIT IOBB*   05320000
*                                                                       05340000
ISLG502  L     R4,IOBECBAD              C(R4)=A(ECB)                    05360000
         TM    0(R4),X'40'              TEST ECB BIT 1 (C-BIT)          05380000
         BC    1,0(R14)                 RETURN, I/O COMPLETE-DONT WAIT  05400000
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 05420000
         LR    R3,R1                    SAVE R1                         05460000
         LR    R1,R4                    C(R1)=A(ECB)                    05480000
         LR    R4,R14                   SAVE R14                  13270 05490015
         WAIT  ECB=(1)                  WAIT                            05500000
         LR    R1,R3                    RESTORE R1                      05520000
         LR    R14,R4                   RESTORE R14               13270 05540015
         BR    R14                      RETURN                          05560000
*                                                                       05580000
*                                                                       05600000
* ROUTINE TO ADJUST LAST ENTRY COUNTS FOR HI LEV IXS IN DCB             05620000
*                                                                       05640000
ISLG900  CLC   0(4,R4),ISL0             TEST CCHH VS 0000               05660000
         BE    0(R14)                   B IF 0000 = NO ADJUSTMENT       05680000
         CLC   4(1,R4),ISL0             TEST R VS 0                     05700000
         BNE   0(R14)                   B IF NOT 0 = NO ADJUSTMENT      05720000
         LH    R3,2(R4)                 C(R3) = HH                      05740000
         S     R3,ISL1                  C(R3) = HH-1                    05760000
         STH   R3,2(R4)                 STORE HH-1 IN DCB LAST ENTRY    05780000
         MVC   4(1,R4),DCBHIRCM         R = HIRCM IN DCB LAST ENTRY     05800000
         BR    R14                      RETURN                          05820000
*                                                                       05840000
         EJECT                                                          05860000
*********************************************************************** 05880000
* CHART G9 - CLOSE (WRITE EOF)                                        * 05900000
*********************************************************************** 05920000
*                                                                       05940000
* STORE IX COUNTS IN DCB                                                05960000
*                                                                       05980000
ISLG901  LA    R7,ISLIXLT               C(R7)=A(IXLT)                   06000000
*                                                                       06020000
         MVC   DCBFTCI(7),1(R7)         MOVE CYLINDER  MBBCCHH          06040000
         MVC   DCBFTMI1(7),27(R7)       MOVE MASTER 1  MBBCCHH          06060000
         MVC   DCBFTMI2(7),53(R7)       MOVE MASTER 2  MBBCCHH          06080000
         MVC   DCBFTMI3(7),79(R7)       MOVE MASTER 3  MBBCCHH          06100000
*                                                                       06120000
         MVC   DCBLETI(5),ISLNCNT       MOVE TRACK     CCHHR            06140000
         MVC   DCBLECI(5),12(R7)        MOVE CYLINDER  CCHHR            06160000
         MVC   DCBLEMI1(5),38(R7)       MOVE MASTER 1  CCHHR            06180000
         MVC   DCBLEMI2(5),64(R7)       MOVE MASTER 2  CCHHR            06200000
         MVC   DCBLEMI3(5),90(R7)       MOVE MASTER 3  CCHHR            06220000
*                                                                       06240000
         LA    R4,DCBLECI               C(R4)=A(LECI CCHHR)             06260000
         BAL   R14,ISLG900              B TO ADJUST IF NECESSARY        06280000
         LA    R4,DCBLEMI1              C(R4)=A(LEMI1 CCHHR)            06300000
         BAL   R14,ISLG900              B TO ADJUST IF NECESSARY        06320000
         LA    R4,DCBLEMI2              C(R4)=A(LEMI2 CCHHR)            06340000
         BAL   R14,ISLG900              B TO ADJUST IF NECESSARY        06360000
         LA    R4,DCBLEMI3              C(R4)=A(LEMI3 CCHHR)            06380000
         BAL   R14,ISLG900              B TO ADJUST IF NECESSARY        06400000
*                                                                       06420000
         CLC   DCBFTCI(1),9(R7)         TEST MS   CYLINDER              06440000
         BE    ISLG902                                                  06460000
         MVC   DCBFTCI+1(1),9(R7)       STORE M                         06480000
*                                                                       06500000
ISLG902  CLC   DCBFTMI1(1),35(R7)       TEST MS   MASTER 1              06520000
         BE    ISLG903                                                  06540000
         MVC   DCBFTMI1+1(1),35(R7)     STORE M                         06560000
*                                                                       06580000
ISLG903  CLC   DCBFTMI2(1),61(R7)       TEST MS   MASTER 2              06600000
         BE    ISLG904                                                  06620000
         MVC   DCBFTMI2+1(1),61(R7)     STORE M                         06640000
*                                                                       06660000
ISLG904  CLC   DCBFTMI3(1),87(R7)       TEST MS   MASTER 3              06680000
         BE    ISLG905                                                  06700000
         MVC   DCBFTMI3+1(1),87(R7)     STORE M                         06720000
*                                                                       06740000
* SAVE DCBLPDA (LOC OF LAST DATA RCD)                                   06760000
*                                                                       06780000
ISLG905  MVC   ISLNDAT(8),DCBLPDA       SAVE LPDA                       06800000
         MVC   ISLODAT(8),DCBFTMI3      SAVE FTMI3                      06820000
*                                                                       06840000
* LINK TO PA ROUTINE TO GET NEW COUNT AND PREFORMAT IF NECESSARY        06860000
         L     R3,IOBPTRB               GET PTR TO BUFF SLOT     A33690 06866020
         NI    0(R3),X'FB'              TURN OFF CYLINDER BIT    A33690 06872020
*                                                                       06874002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 06880002
*                                                                       06890002
         STM   R0,R5,DXCCW9             SAVE REGISTERS 0-5       Y02072 06900002
         L     RJ,CVTPTR                ADDR OF CVT              Y02072 06950002
         USING CVT,RJ                   CVT ADDRESSABILITY       Y02072 06960002
         L     RJ,CVTTCBP               ADDR OF TCB PTRS         Y02072 06970002
         L     RJ,0(RJ)                 TCB ADDRESS              Y02072 06980002
         USING TCB,RJ                   TCB ADDRESSABILITY       Y02072 06990002
         L     RJ,TCBRBP                ADDRESS OF SVRB          Y02072 06992002
         USING RBBASIC,RJ               SVRB ADDRESSABILITY      Y02072 06994002
*                                                                       06994102
         MODESET  KEYADDR=KEY0,WORKREG=13  SET TO KEY ZERO       Y02072 06994202
*                                                                       06994302
         STM   R6,R12,RBEXSAVE          SAVE REGISTERS 6-15      Y02072 06996002
         DROP  RJ                       END USING ON SVRB        Y02072 06998002
         L     R13,ISLPAAD              ADDR OF ISLPA01          Y02072 06998402
         L     R15,ISLF8AD              SET BASE FOR PUT RTN     Y02072 06998802
         LR    RJ,R13                   ENTRY POINT              Y02072 06999202
*                                                                       06999302
         SYNCH (15)                     SYNCH TO PUT RTN         Y02072 06999602
*                                                                       06999702
         L     RJ,CVTPTR                ADDRESS OF CVT           Y02072 06999802
         USING CVT,RJ                   CVT ADDRESSABILITY       Y02072 06999902
         L     RJ,CVTTCBP               ADDR OF TCB PTRS         Y02072 07000002
         L     RJ,0(RJ)                 ADDR OF TCB              Y02072 07006602
         USING TCB,RJ                   TCB ADDRESSABILITY       Y02072 07008602
         L     RJ,TCBRBP                SVRB ADDRESS             Y02072 07010602
         USING RBBASIC,RJ               RB ADDRESSABILITY        Y02072 07013002
         LM    R6,R12,RBEXSAVE          RESTORE REGS 6-15        Y02072 07013102
         DROP  RJ                       END USING ON SVRB        Y02072 07013202
*                                                                       07013602
         MODESET KEYADDR=DXUKEY,WORKREG=5 CHANGE TO USER KEY     Y02072 07015202
*                                                                       07017202
         LM    R0,R5,DXCCW9             RESTORE REGS 0-5         Y02072 07019902
*                                                                       07026602
* AWAIT COMPLETION OF ALL PRIOR I/O ACTIVITY                            07033302
*                                                                       07040000
         LA    R2,ISLIOBA               C(R2)=A(IOBA)                   07060000
         BAL   R14,ISLG502              B TO COMMON WAIT                07080000
         LA    R2,ISLIOBB               C(R2)=A(IOBB)                   07100000
         BAL   R14,ISLG502              B TO COMMON WAIT                07120000
         LA    R2,ISLIOBC               C(R2)=A(IOBC)                   07140000
         BAL   R14,ISLG502              B TO COMMON WAIT                07160000
*                                                                       07180000
         LA    R2,ISLIOBB               C(R2)=A(IOBB)                   07200000
*                                                                       07220000
*                                                                       07240000
* SET UP TO WRITE EOF                                                   07260000
*                                                                       07280000
         L     R6,ISLVPTR7              C(R6)=A(CP21)            Y02072 07300002
         NI    20(R6),X'7F'             TURN OFF DC FLAG AT CQ42        07320000
*                                                                       07340000
         L     R6,ISLVPTR1              C(R6)=A(AREA Y)          Y02072 07360002
         MVC   0(5,R6),DCBLPDA+3        MOVE CCHHR FROM LPDA            07380000
         MVC   5(3,R6),ISL0             KDD = 000                       07400000
         CLC   DCBNREC(4),ISL0          NULL DATASET                    07420000
         BNE   ISLG905A                 NO, BRANCH                      07440000
         MVC   0(5,R6),ISLNDAT+3        SET UP COUNT IN AREA Y          07460000
         MVC   IOBDADAD(8),ISLNDAT      IOBB+32=MBBCCHHR FROM LPDA      07480000
         IC    R3,IOBDADAD+7             C(R3)= R                       07500000
         BCTR  R3,0                     C(R3) = R-1                     07520000
        STC    R3,IOBDADAD+7            IOBB+32=MBBCCHHR WITH R=R-1     07540000
         B     ISLG910                                                  07560000
*                                                                       07580000
ISLG905A EQU   *                                                        07600000
         MVC   IOBDADAD(7),DCBLPDA      IOBB+32 = MBBCCHH FROM LPDA     07620000
         SR    R3,R3                                                    07640000
         IC    R3,DCBLPDA+7             C(R3)=R                         07660000
         S     R3,ISL1                  C(R3)=R-1                       07680000
         STC   R3,IOBDADAD+7            IOBB+32 = MBBCCHHR, WITH R=R-1  07700000
*                                                                       07720000
* EXECUTE CP21 - WRITE EOF                                              07740000
*                                                                       07760000
ISLG910  EQU   *                                                        07780000
         TM    DCBRECFM,X'80'           IS IT VLR                 VLR   07786018
         BZ    ISLG911                  YES,BRANCH               M0651  07793020
         LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 07800000
         LR    R4,R1                    SAVE R1                         07820000
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         07840000
         LR    R1,R4                    RESTORE R1                      07860000
*   TEST IF INDEPENDANT OVERFLOW ALREADY USED - RSUME LOAD              07860120
ISLG911  CLI   DCBLIOV+7,X'00'          IND OVFLOW EXISTS        M0651  07860220
         BNE   ISLC020                  BRANCH ALREADY EXISTS    M0651  07860320
*                                       NOT USED - WRITE EOF            07860420
*                                                                 13270 07860815
* SET UP TO WRITE EOF - INDEPENDENT OVERFLOW                      13270 07861615
*                                                                 13270 07862415
ISLG912  EQU   *                                                  VLR   07862818
         CLI   DCBLIOV,X'00'            INDEPENDENT OVERFLOW EXIST13270 07863215
         BE    ISLC020                  BR IF NO IND OFL          13270 07864015
         LA    R2,ISLIOBB               *BR TO 'WAIT' ON CP21 TO  13270 07864815
         BAL   R14,ISLG502              *COMPLETE PRIME DATA EOF  13270 07865615
         MVC   IOBDADAD(8),DCBLIOV      SET SEEK ADDR IN IOB      13270 07866415
         SR    R3,R3                    R3=ZERO                   13270 07867215
         IC    R3,IOBDADAD              R3=M OF FIRST IND OFL EXT 13270 07868015
         SLL   R3,4                     R3=M X 16                 13270 07868815
         L     R8,DXCCW1                ADDRESS OF DCB COPY      Y02072 07870202
         USING IHADCB,R8                USING ON DCB COPY        Y02072 07872202
         L     R8,DCBDEBAD              PROTECTED DEB ADDR       Y02072 07874202
         DROP  R8                       END USING ON DCB COPY    Y02072 07874602
         USING IHADCB,R1                USING ON USER DCB        Y02072 07875002
         LA    R3,32(R3,R8)             R3=A(FIRST IND OFL EXT)   13270 07875302
         MVC   IOBDADAD+1(2),4(R3)      BB OF FIRST IND OFL EXT   13270 07877202
         MVC   0(4,R6),DCBLIOV+3        AREA Y - CCHH FROM LIOV   13270 07879102
         MVI   4(R6),X'01'              AREA Y - R=1              13270 07881002
         MVC   5(3,R6),ISL0             AREA Y - KDD=000          13270 07882902
*                                                                 13270 07884802
*EXECUTE CP 21 - WRITE EOF IN INDEPENDENT OVERFLOW AREA           13270 07886702
*                                                                 13270 07888602
         LA    R13,ISLVRSAV             *C(R13) = A(VRSAV)        13270 07890502
         LR    R4,R1                    *SAVE R1                  13270 07892402
         EXCP  IHAIOB                   *EXECUTE CHANNEL PROGRAM  13270 07894302
         LR    R1,R4                    *RESTORE R1               13270 07896202
*                                                                       07898102
*                                                                       07900000
* RESET MACRF IF LOCATE PUT                                             07920000
*                                                                       07940000
ISLC020  TM    DCBMACRF+1,X'08'         *TEST MACRF BIT 12(LOCATE)13270 07960015
         BC    8,ISLG906                B IF 0, MOVE PUT                07980000
         NI    DCBMACRF+1,X'EF'         TURN BIT 11 OFF FOR LOCATE      08000000
*                                                                       08020000
* RESTORE DCBLPDA (LOC OF LAST DATA RCD)                                08040000
*                                                                       08060000
ISLG906  CLC   DCBLPDA(5),ISLNDAT       EOF ON SAME CYLINDER      15365 08068016
         BE    ISLG9065                 YES--BRANCH               15365 08076016
         TM    DCBRECFM,X'80'           IS IT VLR                 VLR   08078018
         BZ    ISLG9065                 YES, BRANCH               VLR   08080018
         OI    ISLF1AD,X'80'            NO--TURN ON BIT FOR 202L  15365 08084016
ISLG9065 MVC   DCBLPDA(8),ISLNDAT       RESTORE LPDA              15365 08092016
         MVC   DCBFTMI3(8),ISLODAT      RESTORE FTMI3                   08100000
*                                                                       08120000
* RESET BUFFER POOL AND BUFFER POOL CONTROL BLOCK                       08140000
*                                                                       08160000
ISLG9066 EQU   *                                                 M0170  08170021
         SR    R3,R3                                                    08180000
         IC    R3,ISLBUFNO              C(R3)=NO OF BUFFERS             08200000
         L     R11,ISLVPTR3             C(R11) = A(IOBBCT)       Y02072 08212002
         LA    R4,8(R11)                C(R4)=A(SLOT 1) IN BCT          08220000
         LA    R5,12(R11)               C(R5)=A(SLOT 2) IN BCT IF ANY   08240000
ISLG907  BCT   R3,ISLG908               TEST FOR LAST BUF               08260000
         L     R6,0(R4)                 C(R6)=A(BUF N)                  08280000
         L     R3,DCBBUFCB              C(R3)=A(BUF POOL CTL BLK)       08300000
         LA    R3,0(R3)                                                 08320000
         L     R7,0(R3)                 C(R7)=A(BUF N+)                 08340000
         LA    R7,0(R7)                                                 08360000
*                                                                       08362002
*   CHECK IF ISLBUFNO LIMITED FOR AOS TO PREVENT LONG CHANNEL PROGRAMS  08363001
*    IF DCBBUFNO WAS GREATER THAN 30 THEN ISLBUFNO WAS SET 30,          08364001
*    IGG0192G AND IGG0196D.                                             08365001
*                                                                       08365402
         CLC   ISLBUFNO,DCBBUFNO        WAS BUFNO SET FROM DCB          08366001
         BE    AOSOK                    YES - THEN NOT LIMITED.         08367001
*                                       NO - CHECK IF LIMITED FOR AOS   08368001
         CLI   ISLBUFNO,THIRTY          WAS IT LIMITED FOR AOS          08369001
         BNE   AOSOK                    NO - NOT LIMITED O.K.           08370001
         LA    R7,0(R6,R8)              POINT LAST USED BUFFER TO       08371001
*                                       FIRST UNUSED BUFFER             08372001
AOSOK    EQU   *                        *                        Y02072 08374002
         ST    R7,0(R6)                 STORE A(BUF N+) IN BUF N        08380000
         LA    R4,8(R11)                C(R4)=A(SLOT 1)                 08400000
         L     R6,0(R4)                 C(R6)=A(BUF 1)                  08420000
         LA    R6,0(R6)                                                 08440000
         ST    R6,0(R3)                 C(BUF POOL CTL BLK)=A(BUF 1)    08460000
         B     ISLG909                                                  08480000
*                                                                       08500000
*                                       NOT LAST BUF                    08520000
ISLG908  L     R6,0(R4)                 C(R6)=A(BUF B)                  08540000
         L     R7,0(R5)                 C(R7)=A(BUF B+1)                08560000
*   CALCULATE BUFFER LENGTH.                                            08566001
         LR    R8,R7                    LENGTH = A(LAST BUFFER)         08569001
         SR    R8,R6                             -A(PREVIOUS BUFFER)    08572001
         LA    R7,0(R7)                                                 08580000
         ST    R7,0(R6)                 STORE A(BUF B+1) IN BUF B       08600000
         A     R4,ISL4                  C(R4)=A(NEXT SLOT) IN BCT       08620000
         A     R5,ISL4                  C(R5)=A(NEXT SLOT+1) IN BCT     08640000
         B     ISLG907                                                  08660000
*                                                                       08680000
         EJECT                                                          08700000
*                                                                       08720000
* EXIT TO C0                                                            08740000
*                                                                       08760000
ISLG909  LM    R1,RJ,DXCCW1             RESTORE REGISTERS        Y02072 08780002
         DROP  R10                      END CLOSE WA USING       Y02072 08790002
         USING FORCORE,RCORE            CLOSE WA ADDRESSABILITY YM06944 08790402
         L     R1,DXUDCBAD              USERS DCB ADDRESS       YM06944 08792002
         USING BASETAG,RBASE                                            08800000
*                                                                       08802002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 08810002
*                                                                       08812002
         MVC   0(L'LOAD2K,RWTGC),LOAD2K NEXT CLOSE EXECUTOR ID   Y02072 08820002
*                                                                       08822002
         MODESET  KEYADDR=DXUKEY,WORKREG=15  SET USERS KEY      YM06944 08824002
*                                                                       08824102
         DROP  RCORE                    END CLOSE WA ADDR       YM06944 08824402
         TM    DCBST,X'20'              NULL RESUME LOAD         M0170  08825021
         BZ    RELOOP                   NO, BRANCH               M0170  08830021
*                                                                       08830402
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY  YM06944 08832002
*                                                                       08834002
         MVC   0(L'LOAD2D,RWTGC),LOAD2D BYPASS REST OF CLOSE     Y02072 08835002
*                                                                       08837002
RELOOP   EQU   *                        ENSURE IN DATA MGT KEY  YM06944 08837402
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY  YM06944 08839002
*                                                                       08839402
         LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       08840002
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       08860000
         CLC   0(2,RWTGC),THISLOAD                                      08880000
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 08900000
         CLC   0(1,RWTGC),ENDCLOSE      TEST FOR END OF WTG TABLE       08920000
         BC    7,RELOOP                 BRANCH=NOT AT END               08940000
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                08960000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                08980000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              09000000
         BC    7,TCTLRTN                BRANCH = NOT ZERO               09020000
ITSZERO  LA    RWTGC,8(RWTGC)                                           09040000
         LA    RPARC,4(RPARC)                                           09060000
         B     ZCHECK                                                   09080000
TCTLRTN  EQU   *                                                        09100000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         09120000
*                                                                       09140002
         USING FORCORE,RCORE                                     Y01021 09144000
         LA    RJ,DXCCW12               WA ADDRESS               Y01021 09160000
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO NEXT LOAD  Y02072 09180002
         EJECT                                                          09200000
*                                                                       09220000
* CONSTANTS                                                             09240000
*                                                                       09260000
ISL0     DC    F'0000'                                                  09280000
ISL1     DC    F'0001'                                                  09300000
ISL4     DC    F'0004'                                                  09340000
*                                                                       09370002
KEY0     EQU   ISL0                     STORAGE PROTECT KEY ZERO Y02072 09372002
*                                                                       09380000
CONSTIGG DC    C'IGG020'                                                09400000
THISLOAD DC    C'2J'                                                    09420000
ENDCLOSE DC    C'00'                                                    09440000
*                                                                       09440402
LOAD2D   DC    C'2D'                    ID OF MODULE IGG0202D    Y02072 09440802
LOAD2K   DC    C'2K'                    ID OF MODULE IGG0202K    Y02072 09441202
*                                                                       09441602
PATCH    DC    XL((*-IGG0202J)/20)'00'  ZEROED PATCH AREA        Y02072 09441702
         END                                                            09620000
