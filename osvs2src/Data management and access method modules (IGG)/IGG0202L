         TITLE 'IGG0202L   QISAM LOAD MODE CLOSE - PAD TRACK INDEX'     00020002
IGG0202L CSECT                                                          00021002
*                                                                       00022002
*********************************************************************** 00023002
*                                                                     * 00024002
* MODULE-NAME = IGG0202L                                              * 00025002
*                                                                     * 00026002
* DESCRIPTIVE-NAME = ISAM CLOSE, LOAD MODE                            * 00027002
*                                                                     * 00028002
* COPYRIGHT = NONE                                                    * 00029002
*                                                                     * 00030002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00031002
*                                                                     * 00032002
* FUNCTION = WRITE THE FINAL DUMMY, END-INDEX ENTRY.  PAD THE UNUSED  * 00033002
*            TRACK INDEX SPACE OF THE CYLINDER CONTAINING THE LAST    * 00034002
*            PRIME DATA RECORD WITH INACTIVE ENTRIES.                 * 00035002
*                                                                     * 00042002
* NOTES = SEE BELOW                                                   * 00043002
*                                                                     * 00044002
*    DEPENDENCIES = NONE                                              * 00045002
*                                                                     * 00046002
*    RESTRICTIONS = NONE                                              * 00047002
*                                                                     * 00048002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00049002
*                                                                     * 00050002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00051002
*                                                                     * 00052002
* MODULE-TYPE = CLOSE EXECUTOR                                        * 00053002
*                                                                     * 00054002
*    PROCESSOR = ASSEMXF-370R                                         * 00055002
*                                                                     * 00056002
*    MODULE-SIZE = 950 DECIMAL BYTES                                  * 00057002
*                                                                     * 00058002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00059002
*                                                                     * 00060002
* ENTRY-POINT = IGG0202L                                              * 00061002
*                                                                     * 00062002
*    PURPOSE = SEE FUNCTION                                           * 00063002
*                                                                     * 00064002
*    LINKAGE = RECEIVES CONTROL FROM ISAM CLOSE EXECUTOR IGG0202K IN  * 00065002
*              STORAGE PROTECT KEY 5 AND PRIVILEGED STATE.            * 00066002
*                                                                     * 00068002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00069002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00070002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00071002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00072002
*               PARAMETER LIST                                        * 00073002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00074002
*                                                                     * 00075002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00076002
*          UPON ENTRY TO THIS MODULE                                  * 00077002
*                                                                     * 00078002
* EXIT-NORMAL = XCTL TO ISAM CLOSE EXECUTOR IGG0202M IN STORAGE       * 00079002
*               PROTECT KEY 5.                                        * 00079202
*                                                                     * 00080002
* EXIT-ERROR = NONE                                                   * 00081002
*                                                                     * 00086002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00087002
*                                                                     * 00088002
*    ROUTINES = NONE                                                  * 00089002
*                                                                     * 00091002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00092002
*                 FORCORE - CLOSE WORK AREA                           * 00093002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00094002
*                                                                     * 00095002
*    CONTROL-BLOCKS = DCB, DCB COPY, DEB, IOB, CVT, TCB, AND SVRB     * 00096002
*                                                                     * 00097002
* TABLES = NONE                                                       * 00098002
*                                                                     * 00099002
* MACROS = MODESET, EXCP, WAIT, AND XCTL                              * 00100002
*                                                                     * 00101002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00102002
*                                                                     * 00103002
*                                                                     * 01001002
*********************************************************************** 01002002
         EJECT                                                          01003002
********************                                                    01004002
* DCB REFERENCE    *                                                    01020000
********************                                                    01040000
         DCBD  DSORG=(IS)                                               01060000
         USING IHADCB,R1                                                01080000
         EJECT                                                          01100000
*****************************                                           01104000
* CLOSE WORK AREA REFERENCE *                                           01108000
*****************************                                           01112000
FORCORE  DSECT                          OPEN/CLOSE/EOV WORK AREA Y01021 01116000
         IECDSECT                                                Y01021 01116800
         EJECT                                                          01117600
********************                                                    01120000
* DEB REFERENCE    *                                                    01140000
********************                                                    01160000
*                                                                       01180000
IHADEB   DSECT                                                          01200000
         USING IHADEB,R8                                                01220000
         DS    0D                                                       01240000
DEBNMSUB DS    0CL1                                                     01260000
DEBTCBAD DS    A                                                        01280000
DEBAMLNG DS    0CL1                                                     01300000
DEBDEBAD DS    A                                                        01320000
DEBOFLGS DS    0CL1                                                     01340000
DEBIRBAD DS    A                                                        01360000
DEBOPATB DS    0CL1                                                     01380000
DEBSYSPG DS    A                                                        01400000
DEBNMEXT DS    0CL1                                                     01420000
DEBUSRPG DS    A                                                        01440000
DEBPRIOR DS    0CL1                                                     01460000
DEBECBAD DS    A                                                        01480000
DEBPROTG DS    0BL1                                                     01500000
DEBDEBID DS    0BL1                                                     01520000
DEBDCBAD DS    A                                                        01540000
DEBEXSCL DS    0CL1                                                     01560000
DEBAPPAD DS    A                                                        01580000
DEBNIEE  DS    0CL1                                                     01600000
DEBFIEAD DS    A                                                        01620000
DEBNPEE  DS    0CL1                                                     01640000
DEBFPEAD DS    A                                                        01660000
DEBNOEE  DS    0CL1                                                     01680000
DEBFOEAD DS    A                                                        01700000
         DS    CL4                                                      01720000
DEBDVMOD DS    0CL1                                                     01740000
DEBUCBAD DS    A                                                        01760000
DEBBINUM DS    CL2                                                      01780000
DEBSTRCC DS    CL2                                                      01800000
DEBSTRHH DS    CL2                                                      01820000
DEBENDCC DS    CL2                                                      01840000
DEBENDHH DS    CL2                                                      01860000
DEBNMTRK DS    CL2                                                      01880000
         EJECT                                                          01900000
*********************************************************************** 01920000
* ISLCOMON REFERENCE     C(DCBWKPT1)=A(ISLCOMMON)                     * 01940000
*********************************************************************** 01960000
*                                                                       01980000
ISLCOMON DSECT                                                          02000000
         USING ISLCOMON,R12                                             02020000
         DS    0D                                                       02040000
ISLECBA  DS    A                        FOR CP18 AND CP20               02060000
ISLIOBA  DS    CL40                                                     02080000
ISLECBB  DS    A                        FOR CP21                        02100000
ISLIOBB  DS    CL40                                                     02120000
ISLECBC  DS    A                        FOR CP19                        02140000
ISLIOBC  DS    CL40                                                     02160000
ISLAREAZ DS    CL88                     FOR CP19                        02180000
ISLIXLT  DS    CL104                    INDEX LOCATION TABLE            02200000
ISLNIRT  DS    CL3                      HHR OF DUMMY TRACK INDEX        02220000
ISLHIRT  DS    CL1                      NO INDX ENT ON PRIM DATA TRACK  02240000
ISLCBF   DS    F                        BUF CTRL PTR (RCD WITHIN BUF)   02260000
ISLBMPR  DS    F                        USED TO BUMP CBF TO NEXT RCD    02280000
ISLFBW   DS    F                        NO OF BUFS SCHED TO WRITE       02300000
ISLEOB   DS    F                        END OF BUFFR ADR                02320000
ISLNCNT  DS    CL8                      NORMAL IX COUNT, CCHHRKDD       02340000
ISLOCNT  DS    CL8                      OVFLOL IX COUNT, CCHHRKDD       02360000
ISLDCNT  DS    CL8                      DUMMY IX COUNT,  CCHHRKDD       02380000
ISLNDAT  DS    CL10                     NORMAL IX DATA, MBBCCHHRFP      02400000
         DS    CL2                                                      02420000
ISLODAT  DS    CL10                     OVFLOW IX DATA, MBBCCHHRFP      02440000
         DS    CL1                                                      02460000
ISLBUFNO DS    CL1                      DCBBUFNO OR 2                   02480000
ISLBUFN  DS    F                        ADDR OF SLOT N IN BCT           02500000
ISLMVC   DS    F                        COUNT OF EXECUTED MOVE (N-1)    02520000
ISLMVCT  DS    F                        NOMBR OF 255 BYTE MOVES (N+1)   02540000
ISLVRSAV DS    18F                      ISL SAVE AREA                   02560000
ISLAPSAV DS    10F                      APPENDAGE SAVE AREA             02580000
ISLWRSAV DS    16F                      ISL SAVE AREA FOR CLOSE         02600000
*                                                                       02620000
TSTWK1C  DS    F                        WORK AREA                 13711 02640016
TSTWK2C  DS    F                        WORK AREA                 13711 02660016
         DS    F                        WORK AREA                 13711 02680016
ISLNOENT DS    F                        NO ENTRIES REMAINING ON TRACK   02700000
ISLOFFST DS    F                        SIZE OF WR CKD INSTR IN BYTES   02720000
ISLD     DS    F                        DISCPLACEMENT FROM CP18 START   02740000
ISLFSTBF DS    F                        ADDR OF 1ST SCHED BUF (REL)     02760000
ISLLSTBF DS    F                        ADDR OF LAST SCHED BUF (REL)    02780000
ISLCCFAD DS    F                        ADDR OF CC FLAG IN CP18         02800000
ISLKEYAD DS    F                        ADDR OF KEY OF LAST RCD ON TRK  02820000
*                                                                       02840000
ISLF8AD  DS    F                        ADDR OF PUT ISLF800             02860000
ISLFXAD  DS    F                        ADDR OF PUT ISLFX20             02880000
ISLFYAD  DS    F                        ADDR OF PUT ISLFY01             02900000
ISLFZAD  DS    F                        ADDR OF PUT ISLFZ01             02920000
ISLPAAD  DS    F                        ADDR OF PUT ISLPA01             02940000
ISLF1AD  DS    F                        ADDR OF APP ISLF110             02960000
*                                                                       02980000
         SPACE 4                                                        03000002
*                                                                       03020000
* ISLVPTRS REFERENCE       C(DCBWKPT6)=A(ISLVPTRS)                      03040000
*                                                                       03060000
ISLVPTRS EQU   *                                                  25463 03070018
ISLVPTR1 DS    A                        A(AREA Y)                 25463 03080018
ISLVPTR2 DS    A                        A(KEYSAVE)                25463 03090018
ISLVPTR3 DS    A                        A(IOBBCT)                 25463 03100018
ISLVPTR4 DS    A                        A(CP18)                   25463 03110018
ISLVPTR5 DS    A                        A(CP19)                   25463 03120018
ISLVPTR6 DS    A                        A(CP20)                   25463 03130018
ISLVPTR7 DS    A                        A(CP21)                   25463 03140018
ISLVPTR8 DS    A                        SIZE OF ISLCOMON AREA     25463 03150018
ISLVPTR9 DS    A                        SIZE OF CHAN PROG AREA    25463 03160018
ISLVPTRA DS    A                        ADDRESS OF BAD BUFFER     25463 03170018
ISLVPTRB DS    A                        UNUSED                    25463 03180018
ISLVPTRC DS    A                        UNUSED                    25463 03190018
ISLFXWK1 DS    F                        WORK AREA                 13711 03228016
ISLFXWK2 DS    F                        WORK AREA                 13711 03232016
ISLF9WK1 DS    F                        WORK AREA                 13711 03236016
*                                                                       03240000
*                                                                       03260000
* IOBBCT REFERENCE         C(ISLVPTRS+8)=A(IOBBCT)                      03280000
*                                                                       03300000
IOBBCT   DSECT                                                          03320000
         DS    0D                                                       03360000
IOBFLAGS DS    0CL1                     FLAGS                           03380000
IOBPTRA  DS    A                        PTR A                           03400000
IOBB     DS    0CL1                     B                               03420000
IOBPTRB  DS    A                        PTR B                           03440000
IOBS     DS    0CL1                     S - STATUS FIELD FOR BUF NO 1   03460000
IOBABUF  DS    A                        A(BUF NO 1) - ADR OF BUF NO 1   03480000
         EJECT                                                          03500000
********************                                                    03520000
* IOB REFERENCE    *                                                    03540000
********************                                                    03560000
*                                                                       03580000
IHAIOB   DSECT                                                          03600000
         USING IHAIOB,R2                                                03620000
         DS    0D                                                       03640000
IOBFLG1  DS    CL1                      FLAGS 1                         03660000
IOBFLG2  DS    CL1                      FLAGS 2                         03680000
AIOBSENS DS    CL2                      SENSE BYTES              Y01021 03720000
IOBECBAD DS    A                        ECB POINTER                     03740000
AIOBCSW  DS    CL8                      CHANNEL STATUS WORD      Y01021 03760000
AIOBSIOC DS    0CL1                     SIO CC                   Y01021 03780000
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       03800000
IOBWT    DS    0CL1                     WEIGHT                          03820000
IOBDCBAD DS    A                        DCB POINTER                     03840000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     03860000
IOBBCTI  DS    CL2                      BLK CTR INCR                    03880000
IOBECT   DS    CL2                      ERROR CTR                       03900000
IOBDADAD DS    CL8                      DIR ACESS DEV ADR MBBCCHHR      03920000
*                                                                       03940000
********************                                                    03960000
* IXLT REFERENCE   *                                                    03980000
********************                                                    04000000
*                                                                       04020000
IXLT     DSECT                                                          04040000
         USING IXLT,R7                                                  04060000
         DS    0D                                                       04080000
IXLTIND  DS    CL1                      INDICATOR                  LEV1 04100000
IXLBEG   DS    CL8                      BEGINING COUNT MBBCCHHR         04120000
IXLSTP   DS    CL8                      STEPPING COUNT MBBCCHHR         04140000
IXLEND   DS    CL8                      ENDING COUNT   MBBCCHHR         04160000
         DS    CL1                                                      04180000
         DS    CL26                                                LEV2 04200000
         DS    CL26                                                LEV3 04220000
         DS    CL26                                                LEV4 04240000
         EJECT                                                          04245020
CPSX     DSECT                                                          04250020
         IGGLDCP OPTCD=N                LOAD CP SKELETON         S20201 04255020
         EJECT                                                          04260000
IGG0202L CSECT                                                          04280000
ISLC100  BALR  R15,0                                                    04300000
         USING *,R15                                                    04320000
BASETAG  L     R1,0(RPARC)                                              04340000
         L     RCORE,4(RWTGC)                                           04360000
         USING FORCORE,RCORE            WA ADDRESSABILITY        Y02072 04370002
         L     R12,DCBWKPT1             C(R12)=A(COMMON)          22841 04380018
         LR    RBASE,R15                                                04400000
         STM   R1,RJ,DXCCW1             SAVE REGISTERS 1-15      Y02072 04420002
         L     R1,DXUDCBAD              USER'S DCB ADDRESS       Y02072 04422002
         DROP  RCORE                    END CLOSE WA USING       Y02072 04430002
         LR    RWKAREA,RCORE            CLOSE WORK AREA ADDR     Y02072 04460002
         USING FORCORE,RWKAREA          WA ADDRESSABILITY        Y02072 04470002
*                                                                       04472002
         MODESET  KEYADDR=DXUKEY,WORKREG=2  CHANGE TO USER KEY   Y02072 04480002
*                                                                       04500000
* EQUATE SYMBOLIC REGISTERS                                             04520000
*                                                                       04540000
R0       EQU   0                                                        04560000
R1       EQU   1                                                        04580000
R2       EQU   2                                                        04600000
R3       EQU   3                                                        04620000
R4       EQU   4                                                        04640000
R5       EQU   5                                                        04660000
R6       EQU   6                                                        04680000
R7       EQU   7                                                        04700000
R8       EQU   8                                                        04720000
R9       EQU   8                                                        04740000
R10      EQU   10                                                       04760000
RWKAREA  EQU   11                       CLOSE WORK AREA BASE REG Y02072 04780002
R12      EQU   12                                                       04800000
R13      EQU   13                                                       04820000
R14      EQU   14                                                       04840000
R15      EQU   9                                                        04860000
RBASE    EQU   3                                                        04900000
RCORE    EQU   4                                                        04920000
RPAR     EQU   5                                                        04940000
RWTG     EQU   6                                                        04960000
RPARC    EQU   7                                                        04980000
RWTGC    EQU   8                                                        05000000
RJ       EQU   15                                                       05100000
CVTPTR   EQU   16                                                 22922 05110018
L8       EQU   8                        LENGTH                   S20201 05121020
K56      EQU   56                       CONSTANT                 S20201 05122020
K0       EQU   0                        CONSTANT                 S20201 05123020
K1       EQU   1                        CONSTANT                 S20201 05124020
ONE      EQU   1                        CONSTANT                        05124400
K3       EQU   3                        CONSTANT                 S20201 05125020
K4       EQU   4                        CONSTANT                 S20201 05126020
ALL      EQU   X'FF'                    ALL BITS                 S20201 05127020
K8       EQU   8                        CONSTANT                 S20201 05128020
K16      EQU   16                       CONSTANT OF 16           Y01021 05128800
CM28     EQU   CM27+8                   CM28                     S20201 05129020
CM29     EQU   CM27+16                  CM29                     S20201 05130020
*                                                                       05140000
         EJECT                                                          05160000
*********************************************************************** 05180000
* CHART C1 - PAD TRK IX                                               * 05200000
*********************************************************************** 05220000
*                                                                       05240000
ISLC101  EQU   *                                                  22841 05260018
         LA    R2,ISLIOBC               C(R2)=A(IOBC)                   05280000
         L     R10,ISLVPTR5             C(R10)=A(CP91)                  05300000
         USING CM1,R10                  ADDRESSABILITY CP91      S20201 05310020
         SR    R3,R3                    CLEAR REG 3                     05320000
         ST    R3,ISLD                  SET D = 0 END - NEW CYL SWS     05360000
*                                                                       05380000
* SET UP CURR MBBCCHHR TO LOCATE PADDING BASED ON LAST TRK IX           05400000
*                                                                       05420000
         MVC   ISLNDAT+3(5),DCBLETI     CCHHR FROM LETI                 05460000
         C     R3,DCBNREC               RECORD COUNT ZERO        S20201 05461020
         BNZ   ISLC1015                 BRANCH IF NOT             22922 05462018
         L     R13,CVTPTR               FIND USER'S SAVEAREA      22922 05463018
         L     R13,0(R13)               GET TCB POINTER           22922 05464018
         L     R13,4(R13)               GET TCB                   22922 05465018
         L     R13,0(R13)               GET SVRB ADDRESS          22922 05466018
         L     R13,84(R13)              PICK UP SAVEAREA PTR      22922 05467018
         ST    R13,ISLVRSAV+4           SAVE IN CASE OF I/O ERROR 22922 05468018
         B     ISLC1017                 CONTINUE PROCESSING       22922 05469018
ISLC1015 EQU   *                                                  22922 05470018
         IC    R3,ISLNDAT+7             C(R3)=R                         05480000
         LA    R3,1(R3)                 C(R3)=R+1                 21054 05490000
         STC   R3,ISLFXWK2              STORE R+1 FOR COMPARE     21054 05500000
         LA    R3,1(R3)                 C(R3)=R+2                 21054 05510000
         STC   R3,ISLNDAT+7             NDAT = MBBCCHHR WITH R=R+2      05520000
ISLC1017 EQU   *                                                  22922 05530018
*                                                                       05540000
* TEST CURR HH VS NIRT (ARE WE ON LAST TRK OF CURR TRK IX) *1ST TIME*   05560000
*                                                                       05580000
         BAL   R13,DRUMTST              TO DEV TST RTN                  05600000
         BE    ISLC105                  B IF EQUAL (ON LAST TRK)        05620000
*                                                                       05640000
* TEST CURR R VS HIRT (ARE WE AT END OF TRK)                            05660000
*                                                                       05680000
         CLC   ISLFXWK2(1),ISLHIRT      CMPR LETI R+1 VS HIRT R   21054 05688000
         BE    ISLC1035                 END OF TRACK              21054 05696000
         BL    ISLC103                  NOT END OF TRACK          21054 05704000
         MVI   ISLNDAT+7,X'02'          SET CURR R TO 2 WHEN NORM 21054 05712000
*                                       AND OVFLW ENTRIES SPLIT   21054 05720000
*                                       ACROSS A TRACK            21054 05728000
         B     ISLC104                  NORMAL AND OVERFLOW INDEX 21054 05736000
*                                       ENTRIES SPLIT             21054 05744000
DRUMTST  EQU   *                        LAST TRACK TEST                 05752000
         CLC   ISLNDAT+6(1),ISLNIRT+ONE TEST NDAT TRK VS NIRT TRK       05756000
         BR    R13                      RETURN                          05820000
*                                                                       05840000
* TEST CURR HH VS NIRT (ARE WE ON LAST TRK OF CURR TRK IX)              05860000
*                                                                       05880000
ISLC102  BAL   R13,DRUMTST              TO DEVICE TEST ROUTINE          05900000
         BE    ISLC106                  B IF EQUAL (ON LAST TRK)        05920000
*                                                                       05940000
* SET CNT A = HIRT - R + 2 (SIM FIRSH R)                                05960000
*                                                                       05980000
ISLC103  SR    R7,R7                    CNT A = R7                      06000000
         IC    R7,ISLHIRT               CNT A = HIRT                    06020000
         SR    R3,R3                                                    06040000
         IC    R3,ISLNDAT+7             C(R3) = CURR R                  06060000
         SR    R7,R3                    CNT A = HIRT - R                06080000
         LA    R7,2(R7)                 CNT A = HIRT-R+2                06100000
*                                                                       06120000
         BAL   R14,ISLC201              LINK TO C2 RT TO WRITE IX TRK   06140000
*                                                                       06160000
* STEP CURR HH TO NEXT TRK, R = 1                                       06180000
*                                                                       06200000
ISLC1035 MVI   ISLNDAT+7,X'01'          SET CURR R TO 1           21054 06210000
ISLC104  L     R3,ISLNDAT+4             C(R3)= CURR CHHR                06220000
         LA    R3,256(R3)               CURR HH+1                       06240000
         STH   R3,ISLNDAT+6             CURR HH=NEXT HH ; R=1           06280000
*                                                                       06300000
         B     ISLC102                 *B TO PROCESS NEXT TRACK OF IX   06320000
*                                                                       06340000
*---------------------------------------------------------------------- 06360000
*                                                                       06380000
* TEST CURR R VS NIRT (HAVE WE COMPLETED LAST TRK OF CURR IX) *1ST TIME 06400000
*                                                                       06420000
ISLC105  CLC   ISLNDAT+7(1),ISLNIRT+2   TEST NDAT R VS NIRT R           06440000
         BC    12,ISLC106               BRNCH IF TRK NOT COMPLETE  8841 06460000
*                                                                       06480000
* SET NEW CYL SW ON - WE HAVE COMPLETED LAST TRK OF CURR IX             06500000
*                                                                       06520000
         OI    ISLD,X'80'               TURN D BIT 0 ON                 06540000
         B     ISLC109                                            21054 06560000
*                                                                       06580000
* LAST TRACK OF CURR CYLINDER, TEST FOR PREFORMATTED SHARED TRACK       06600000
*                                                                       06620000
ISLC106  EQU   *                        *                               06628000
ISLC1061 CLC   ISLNDAT+3(3),ISLIOBA+35  CURRENT CCH VS EOF CCH    13270 06780015
         BNE   ISLC1065                 B IF NOT LAST USED CYL          06800013
         CLC   ISLNDAT(1),ISLIOBA+32    TEST FOR DIFFERENT M      14089 06806016
         BNE   ISLC1065                                           14089 06812016
ISLC1062 CLI   DCBHIRSH,X'00'           TEST HIRSH VS ZERO        15365 06822016
         BNE   ISLC120                  B IF CURR CYL PREFORMATTED      06840000
*                                                                       06860000
* SET CNT A = NIRT - R + 1 (SIM FIRSH R - 1)                            06880000
*                                                                       06900000
ISLC1065 TM    ISLF1AD,X'80'            EOF ON LPDA'S CYLINDER    15365 06906016
         BZ    ISLC1066                 YES,BRANCH--NORMAL CASE   15365 06912016
         NI    ISLF1AD,X'7F'            NO--TURN OFF BIT          15365 06918016
         B     ISLC1062                 SEE IF PREFORMATTED CYL   15365 06924016
ISLC1066 SR    R7,R7                    CNT A = R7                15365 06930016
         IC    R7,ISLNIRT+2             CNT A = NIRT R                  06940000
         SR    R3,R3                                                    06960000
         IC    R3,ISLNDAT+7             C(R3) = CURR R                  06980000
         SR    R7,R3                    CNT A = NIRT - R                07000000
         LA    R7,1(R7)                 CNT A = NIRT - R + 1      21054 07020000
*                                                                       07040000
* SET END SW ON - WE HAVE ARRIVED AT THE LAST TRK OF CURR IX            07060000
*                                                                       07080000
         OI    ISLD,X'40'               TURN D BIT 1 ON                 07100000
*                                                                       07120000
         BAL   R14,ISLC201              LINK TO C2 RT TO WRITE IX TRK   07140000
ISLC109  EQU   *                                                 A29276 07170019
*                                                                       07200019
*   CHECK IF DATA SET ENDS ON LAST PRIME TRACK OF A CYLINDER. PADDING   07230019
*   COMPLETE IF NOT, MUST PAD NEXT CYLINDER OTHERWISE.                  07260019
*                                                                       07290019
         TM    ISLD,X'10'               HAS EXTRA CYLINDER BEEN  A29276 07320019
*                                       *    PADDED ALREADY             07350019
         BO    ISLC109A                 YES-BR INDICES FINISHED  A29276 07380019
         CLC   DCBLPDA+5(2),DCBLDT      DID DATA SET END ON LST  A29276 07410019
*                                       *    TRACK OF CYLINDER          07440019
         BNE   ISLC109A                 NO.-BR INDICES FINISHED  A29276 07470019
*                                       YES PAD NEXT CYLINDER           07500019
         OI    ISLD,X'10'               PADDING LAST CYLINDER    M4274  07520019
         L     R4,DCBLRAN               DEVICE TABLE ADDRESS     M3639  07550019
*                                                                       07891002
         IC    R7,ISLNDAT+K4            INCREMENT                S20201 07892020
         LA    R7,K1(R7)                * LOW ORDER BYTE         S20201 07893020
         STC   R7,ISLNDAT+K4            OF CYLINDER.    C  C+1   S20201 07894020
         CLI   ISLNDAT+K4,K0            DID LOW BYTE OVERFLOW    S20201 07895020
         BNE   ISLC1093                 NO - VALUE CORRECT       S20201 07896020
         IC    R7,ISLNDAT+K3            YES - INVALID MUST       S20201 07897020
         LA    R7,K1(R7)                * INCREMENT HIGH BYTE    S20201 07898020
         STC   R7,ISLNDAT+K3            * OF CYLINDER   CC+1     S20201 07899020
ISLC1093 EQU   *                        CHECK FOR END OF EXTENT  M3639  08010019
         L     R8,DXCCW1                COPY DCB ADDR            Y02072 08020002
         USING IHADCB,R8                COPY ADDRESSABILITY      Y02072 08022002
         L     R8,DCBDEBAD              ADDRESSABILITY ON DEB    M3639  08030019
         USING IHADEB,R8                R8 = DEB ADDRESS         Y01021 08040800
         USING IHADCB,R1                USER DCB ADDRESSABILITY  Y02072 08042002
         SR    R4,R4                                             M3639  08050019
         IC    R4,ISLNDAT               CURRENT EXTENT           M3639  08070019
         SLL   R4,4                     DISPLACEMENT TO CURRENT  M3639  08090019
*                                       *  EXTENT                       08110019
         LA    R3,DEBNIEE(R4)           ADDRESS OF CURRENT       M3639  08130019
*                                       EXTENT                   M3639  08150019
         MVI   ISLNDAT+7,X'FF'          INITIALIZE RECORD FOR    M3639  08190019
*                                       *  PROCESSING                   08210019
         CLC   ISLNDAT+3(4),10(R3)     AT END OF EXTENT          M3639  08230019
         BNH   ISLC1015                 NO - BR - TO PAD NEW     M3639  08250019
*                                       *  CYLINDER INDEX               08270019
*                                       YES - SWITCH TO THE START OF    08290019
*                                       *  NEXT EXTENT                  08310019
         MVC   ISLNDAT+1(6),20(R3)      INITIAL BBCCHH OF NEXT   M3639  08330019
*                                       *  EXTENT                       08350019
         IC    R7,ISLNDAT               INCREMENT EXTENT         M3639  08370019
         LA    R7,1(R7)                 *                        M4274  08390019
         STC   R7,ISLNDAT               *                        M3639  08410019
         B     ISLC1015                 BR - TO PAD NEXT CYL     M3639  08430019
*                                                                       08480002
*   TRACK INDICES SUFFICIENT PADDED PREPARE TO TRANSFER TO              08640019
*   NEXT ROUTINE                                                        08670019
*                                                                       08680002
ISLC109A MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 08700002
*                                                                       08710002
         LM    R1,R13,DXCCW1            RESTORE REGISTERS        Y02072 08730002
         DROP  RWKAREA                  END CLOSE WA USING       Y02072 08732002
         MVC   0(L'LOAD2M,RWTGC),LOAD2M ID NEXT LOAD - IGG0202M  Y02072 08760002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       08780000
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       08800000
         CLC   0(2,RWTGC),THISLOAD                                      08820000
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 08840000
         CLI   0(RWTGC),X'F0'           TEST FOR END OF WTG TABLE  MC1A 08860018
         BC    7,RELOOP                 BRANCH=NOT AT END               08880000
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                08900000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                08920000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              08940000
         BC    7,TCTLRTN                BRANCH = NOT ZERO               08960000
ITSZERO  LA    RWTGC,8(RWTGC)                                           08980000
         LA    RPARC,4(RPARC)                                           09000000
         B     ZCHECK                                                   09020000
TCTLRTN  EQU   *                                                        09040000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         09060000
*                                                                       09080002
         USING FORCORE,RCORE                                     Y01021 09084000
         LA    RJ,DXCCW12               WA ADDRESS               Y01021 09100000
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15)) XCTL TO IGG0202M   Y02072 09120002
*                                                                       09140000
         DROP  RCORE                    END CLOSE WA USING       Y02072 09170002
         EJECT                                                          09170402
         USING FORCORE,RWKAREA          ESTABLISH WA ADDR        Y02072 09172002
*                                                                       09200000
* CURR TRACK IS PREFORMATTED, SET UP SPECIAL PROCEDURE                  09220000
*                                                                       09240000
ISLC120  MVC   CM7,CM28                 MOVE CM28 TO CM7         S20201 09260020
         SR    R3,R3                                                    09280000
         ST    R3,12(R10)               SET CM2+4 = 0000                09300000
         LA    R4,CM5                   TR TO CM5                S20201 09320020
         ST    R4,IOBCPSAD              STORE CPSTART IN IOBC CP START  09340000
ISLC121  MVC   IOBDADAD(8),ISLNDAT      C(IOBC+32)=CURR MBBCCHHR        09360000
         CLC   ISLNDAT+7(1),ISLNIRT+2   TEST CURR R VS NIRT R           09380000
         BE    ISLC122                  B IF LAST R                     09400000
         IC    R3,ISLNDAT+7             STEP CURR R FOR NEXT IX         09420000
         LA    R3,1(R3)                                           21054 09440000
         STC   R3,ISLNDAT+7                                             09460000
*                                                                       09480000
         BAL   R14,ISLC207              LINK TO C2 RT TO WRITE 1 IX     09500000
*                                                                       09520000
         B     ISLC121                  LOOP TO WR NEXT IX ENTRY        09540000
*                                                                       09560000
*                                       LAST R TO BE WRITTEN            09580000
ISLC122  L     R5,CM27+K4               PTR TO CM27+4-MBBCCHHRFP S20201 09600020
         NI    8(R5),X'EF'              SET F = 20 (DELETE BIT 3)       09620000
*                                                                       09640000
         BAL   R14,ISLC207              LINK TO C2 RT TO WRITE 1 IX     09660000
*                                                                       09680000
         OI    8(R5),X'10'              RESET F = 30              15365 09690016
         OI    ISLD,X'80'               TURN D BIT 0 ON (NEW CYL SW)    09700000
         MVC   CM7,CM29                 MOVE CM29 TO CM7-        S20201 09720020
         B     ISLC109                                            21054 09740000
*                                                                       09760000
         EJECT                                                          09780000
*********************************************************************** 09800000
* CHART C2 - WRITE IX PADDING                                         * 09820000
*********************************************************************** 09840000
*                                                                       09860000
ISLC201  EQU   *                                                        09880000
*                                                                       09900000
* TEST FOR NEW CYLINDER                                                 09920000
*                                                                       09940000
         TM    ISLD,X'80'               TEST NEW CYL SW (D BIT 0)       09960000
         BC    8,ISLC202                B IF OFF                        09980000
*                                                                       10000000
* NEW CYL - SET NEW CYL SW OFF                                          10020000
*                                                                       10040000
         NI    ISLD,X'7F'               SET NEW CYL SW OFF (D BIT 0)    10060000
*                                                                       10080000
* SET F = 30                                                            10100000
*                                                                       10120000
         L     R5,CM27+K4               PTR - CM27+4 -           S20201 10130020
*                                       MBBCCHHRFP               S20201 10140020
         OI    8(R5),X'10'              SET F = 3X (ADD BIT 3)          10160000
         NI    8(R5),X'F7'              SET F = UNCHAINED (BIT 4 OFF)   10180000
         XC    0(8,R5),0(R5)           SET MBBCCHHR = ZEROS             10200000
*                                                                       10220000
* TEST FOR CYL OVFL AREA                                                10240000
*                                                                       10260000
         LR    R4,R10                   C(R4)=A(CM1)                    10280000
         TM    DCBOPTCD,X'08'           TEST OPTCD BIT-4 FOR CYL OVFL   10300000
         BC    7,ISLC203                BRANCH IF ON                    10320000
*                                                                       10340000
*                                                                       10360000
* SET CPSTART IN IOBC TO CM5                                            10380000
*                                                                       10400000
ISLC202  LA    R4,CM5                   TR TO CM5                S20201 10420020
ISLC203  ST    R4,IOBCPSAD              STORE CPSTRT IN IOBC CPSTRT     10440000
*                                                                       10460000
* SET IOBC+32 TO CURR MBBCCHHR, WITH R=R-1                              10480000
*                                                                       10500000
         MVC   IOBDADAD(8),ISLNDAT      C(IOBC+32)=CURR MBBCCHHR        10520000
         L     R8,DXCCW1                COPY DCB ADDRESS         Y02072 10524002
         USING IHADCB,R8                COPY ADDRESSABILITY      Y02072 10534002
         L     R8,DCBDEBAD              C(R8)=A(DEB                     10540000
         USING IHADEB,R8                R8 = DEB ADDRESS         Y01021 10557600
         USING IHADCB,R1                USER DCB ADDRESSABILITY  Y02072 10558402
         L     R3,DEBFPEAD              C(R3)=A(1ST PRIME EXTENT)       10560000
         SR    R4,R4                                                    10580000
         IC    R4,ISLNDAT               C(R4)= CURR 000M                10600000
         BCTR  R4,0                     C(R4)=CURR M-1(FOR EXTENT 0)    10620000
         SLL   R4,4                     C(R4)=(M-1)X16 (USE AS INDEX)   10640000
         LA    R4,0(R4,R3)              C(R4)=A(STRCC OF LAST EXTENT)   10660000
         MVC   IOBDADAD+2(1),5(R4)      SET UP BB                       10680000
         SR    R3,R3                                                    10700000
         IC    R3,IOBDADAD+7            C(R3)=R                         10720000
         BCTR  R3,0                     C(R3)= R-1                      10740000
         STC   R3,IOBDADAD+7            C(IOBC+32)=MBBCCHHR, R=R-1      10760000
*                                                                       10780000
* SET COUNTS IN AREA Z AND TURN ON ALL CC FLAGS IN CP91, TURN 10TH OFF  10800000
*                                                                       10820000
         L     R3,ISL10                 C(R3)=10 = LOOP COUNT           10840000
         LA    R9,ISLAREAZ              C(R9) = A(AREAZ)                10860000
         LA    R4,6(R9)                 C(R4)=A(Z+6) = COUNT 1 ADR      10880000
         SR    R5,R5                                                    10900000
         IC    R5,ISLNDAT+7             C(R5)=CURR R                    10920000
         LA    R6,CM8+K4                CC FLAG FOR CM8          S20201 10940020
ISLC204  MVC   0(4,R4),ISLNDAT+3        MOVE CURR CCHH                  10960000
         STC   R5,4(R4)                 STORE R                         10980000
         OI    0(R6),X'40'              TURN ON CC FLAG IN CP91         11000000
         LA    R4,8(R4)                 STEP Z                          11020000
         LA    R5,1(R5)                 BUMP R                          11040000
         LA    R6,16(R6)                STEP CP91                       11060000
         BCT   R3,ISLC204               LOOP                            11080000
         NI    CM26+K4,X'FF'-CC         TURN OFF LAST CC FLAG    S20201 11100020
*                                                                       11120000
* TEST CNT A VS 1 (ONLY 1 ENTRY ON LAST TRACK OF IX)                    11140000
*                                                                       11160000
         CH    R7,ISL1                  TEST CNT A VS 1           21054 11180000
         BE    ISLC208                  B IF 1, TO WR DUMMY END ONLY    11200000
*                                                                       11220000
* TEST CNT A VS 10 (SET UP A(CC FLAG) OF LAST WR)                       11240000
*                                                                       11260000
         SR    R4,R4                                                    11280000
         LR    R5,R7                    C(R5)=CNT A (SIM FIRSH)         11300000
         BCTR  R5,0                     C(R5)= CNT A-1                  11320000
         D     R4,ISL10                 C(R4)=R                         11340000
*                                       C(R5)=Q                         11360000
         LTR   R4,R4                    TEST R VS 0                     11380000
         BNE   ISLC205                  B IF R NOT 0                    11400000
         L     R4,ISL10                 C(R4)=10                        11420000
         BCTR  R5,0                     C(R5)= Q-1                      11440000
ISLC205  SLL   R4,4                     MULTIPLY R X 16                 11460000
         LA    R6,CM6+K4(R4)            CC FLAG LAST WRITE       S20201 11480020
         LTR   R5,R5                    TEST Q VS 0                     11500000
         BC    7,ISLC206                B IF NOT 0,CNT A WAS GTR 10     11520000
*                                                                       11540000
* TEN OR LESS ENTRIES TO WR                                             11560000
*                                                                       11580000
         NI    0(R6),X'BF'              SET OFF CC FLAG BASED ON CNT A  11600000
ISLC205A SR    R4,R4                                                    11620000
         ST    R4,12(R10)               SET CM2+4 = 0000                11640000
         B     ISLC207                                                  11660000
*                                                                       11680000
* MORE THAN TEN ENTRIES TO WR                                           11700000
*                                                                       11720000
ISLC206  STC   R7,DCBFIRSH+2            SET FIRSH R = CNT A             11740000
         ST    R6,12(R10)               SET CM2+4 = A(CC FLAG)          11760000
*                                                                       11780000
* EXECUTE CP91                                                          11800000
*                                                                       11820000
ISLC207  LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 11840000
         LR    R3,R1                    SAVE R1                         11860000
         L     R4,IOBECBAD              C(R4)=A(ECB)                    11880000
         LR    R6,R14                   SAVE R14                        11900000
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         11920000
*                                                                       11940000
* AWAIT COMPLETION                                                      11960000
*                                                                       11980000
         LR    R1,R4                    C(R1)=A(ECB)                    12000000
         WAIT  ECB=(1)                  WAIT                            12020000
         LR    R1,R3                    RESTORE R1                      12040000
         LR    R14,R6                   RESTORE R14                     12060000
*                                                                       12080000
* SET CPSTART IN IOBC TO CM5                                            12100000
*                                                                       12120000
         LA    R4,CM5                   PTR TO CM5               S20201 12140020
         ST    R4,IOBCPSAD              STORE CPSTART IN IOBC CP START  12160000
*                                                                       12180000
* TEST ENDSW FOR LAST TRACK OF CURR IX                                  12200000
*                                                                       12220000
ISLC208  TM    ISLD,X'40'               TEST D BIT 1 (ENDSW)            12240000
         BCR   8,R14                    RETURN TO C1 IF OFF             12260000
*                                                                       12280000
* LAST TRACK OF CURR IX - SET ENDSW OFF, NEW CYL SW ON                  12300000
*                                                                       12320000
         NI    ISLD,X'BF'               TURN D BIT 1 OFF (ENDSW)        12340000
*                                                                       12380000
* SET UP IOBC AND AREA Z FOR WRITING DUMMY END IX ENTRY                 12400000
*                                                                       12420000
         SR    R3,R3                                                    12440000
         IC    R3,ISLNIRT+2             C(R3)=NIRT R                    12460000
         STC   R3,10(R9)                C(1ST CNT IN AREA Z) = FINAL R  12480000
         BCTR  R3,0                     C(R3)=NIRT R-1 OR PREV R        12500000
         STC   R3,IOBDADAD+7            C(IOBC+32) = PREV R             12520000
         MVC   IOBDADAD+5(2),ISLNDAT+5  C(IOBC+32) = CURR HH            12540000
*                                                                       12560000
* SET CC FLAG FOR CM8 IN CP91 OFF TO WRITE LAST ENTRY                   12580000
*                                                                       12600000
         NI    CM8+K4,X'FF'-CC          TURN OFF CC FLAG         S20201 12620020
*                                                                       12640000
* SET F = 20                                                            12660000
*                                                                       12680000
         L     R5,CM27+K4               PTR - CM27+4 -           S20201 12686020
*                                       MBBCCHHRFP               S20201 12692020
         NI    8(R5),X'EF'              SET F=2 (DELETE BIT 3)    12881 12710015
         B     ISLC205A                 B TO WR LAST ENTRY              12740000
*                                                                       12760000
* --------------------------------------------------------------------* 12780000
         SPACE 3                                                        12800002
*                                                                       12820000
* CONSTANTS                                                             12840000
*                                                                       12860000
CONF8    DC    X'F8F8'                                                  12900000
ISL1     DC    H'01'                                              21054 12950000
ISL10    DC    F'10'                                              21054 13000000
*                                                                       13060000
THISLOAD DC    C'2L'                                                    13080000
*                                                                       13082002
LOAD2M   DC    C'2M'                    ID OF MODULE IGG0202M    Y02072 13084002
*                                                                       13086002
PATCH    DC    XL50'00'                 ZEROED PATCH AREA        Y02072 13088002
         END                                                            13260000
