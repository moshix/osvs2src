         TITLE 'IGG0202M - QISAM LOAD MODE CLOSE- PAD HI-LVL INDICIES'  00020000
IGG0202M CSECT                                                          00021002
*                                                                       00022002
*********************************************************************** 00023002
*                                                                     * 00024002
* MODULE-NAME = IGG0202M                                              * 00025002
*                                                                     * 00026002
* DESCRIPTIVE-NAME = ISAM CLOSE, LOAD MODE                            * 00027002
*                                                                     * 00028002
* COPYRIGHT = NONE                                                    * 00029002
*                                                                     * 00030002
* STATUS = RELEASE OS/VS2-02, LEVEL 0                                 * 00031002
*                                                                     * 00032002
* FUNCTION = IF HIGH-LEVEL INDICES EXIST, WRITE FINAL DUMMY ENTRIES   * 00033002
*            FOR THEM.  PAD ANY UNUSED INDEX SPACE WITH INACTIVE      * 00034002
*            ENTRIES.                                                 * 00035002
*                                                                     * 00042002
* NOTES = SEE BELOW                                                   * 00043002
*                                                                     * 00044002
*    DEPENDENCIES = NONE                                              * 00045002
*                                                                     * 00046002
*    RESTRICTIONS = NONE                                              * 00047002
*                                                                     * 00048002
*    REGISTER-CONVENTIONS = SEE REGISTER EQUATES.                     * 00049002
*                                                                     * 00050002
*    PATCH-LABEL = PATCH, A DC STATEMENT.                             * 00051002
*                                                                     * 00052002
* MODULE-TYPE = CLOSE EXECUTOR                                        * 00053002
*                                                                     * 00054002
*    PROCESSOR = ASSEMXF-370R                                         * 00055002
*                                                                     * 00056002
*    MODULE-SIZE = 1104 DECIMAL BYTES                                 * 00057002
*                                                                     * 00058002
*    ATTRIBUTES = PRIVILEGED, REENTRANT                               * 00059002
*                                                                     * 00060002
* ENTRY-POINT = IGG0202L                                              * 00061002
*                                                                     * 00062002
*    PURPOSE = SEE FUNCTION                                           * 00063002
*                                                                     * 00064002
*    LINKAGE = RECEIVES CONTROL FROM ISAM CLOSE EXECUTOR IGG0202L IN  * 00065002
*              STORAGE PROTECT KEY 5 AND PRIVILEGED STATE.            * 00066002
*                                                                     * 00068002
* INPUT = REGISTERS ESTABLISHED UPON ENTRY ARE                        * 00069002
*         REG 5 (RPAR) POINTS TO THE DCB COPY PARAMETER LIST          * 00070002
*         REG 6 (RWTG) POINTS TO THE O/C/EOV WHERE-TO-GO TABLE        * 00071002
*         REG 7 (RPARC) POINTS TO THE CURRENT ENTRY IN THE DCB COPY   * 00072002
*               PARAMETER LIST                                        * 00073002
*         REG 8 (RWTGC) POINTS TO THE CURRENT ENTRY IN THE WTG TABLE  * 00074002
*                                                                     * 00075002
* OUTPUT = REGISTERS 5 THROUGH 8 WILL BE IN THE SAME CONDITION AS     * 00076002
*          UPON ENTRY TO THIS MODULE                                  * 00077002
*                                                                     * 00078002
* EXIT-NORMAL = XCTL TO ISAM CLOSE EXECUTOR IGG0202D IN STORAGE       * 00079002
*               PROTECT KEY 5.                                        * 00079202
*                                                                     * 00080002
* EXIT-ERROR = SYNCH TO PROCESSING ROUTINE TO TAKE SYNAD EXIT IF AN   * 00081002
*              I/O ERROR OCCURS.                                      * 00082002
*                                                                     * 00086002
* EXTERNAL-REFERENCES = SEE BELOW                                     * 00087002
*                                                                     * 00088002
*    ROUTINES = ISAM LOAD MODE PROCESSING ROUTINE                     * 00089002
*                                                                     * 00091002
*    DATA-AREAS = AREAS REFERENCED ARE:                               * 00092002
*                 FORCORE - CLOSE WORK AREA                           * 00093002
*                 ISLCOMON - ISAM LOAD MODE WORK AREA                 * 00094002
*                                                                     * 00095002
*    CONTROL-BLOCKS = DCB, DCB COPY, DEB, CVT, TCB, IOB, AND SVRB     * 00096002
*                                                                     * 00097002
* TABLES = NONE                                                       * 00098002
*                                                                     * 00099002
* MACROS = MODESET, EXCP, WAIT, SYNCH, AND XCTL                       * 00100002
*                                                                     * 00101002
* CHANGE-ACTIVITY = AS FOLLOWS:                                       * 00102002
*                                                                     * 00103002
*        OS/VS2-02 CHANGES/DELETIONS                                  * 00153002
*                                                               YM06745 00203002
*              OS/VS2 RELEASE 030 CHANGES                               00253000
* D078800-080700,D081400-082000,D082400-082600,C080800-081000,  OZ05937 00303000
*  A081700                                                      OZ05937 00353000
*                                                                     * 00961002
*********************************************************************** 00962002
         EJECT                                                          00963002
********************                                                    00964002
* DCB REFERENCE    *                                                    00980000
********************                                                    01000000
         DCBD  DSORG=(IS)                                               01020000
         USING IHADCB,R1                                                01040000
         EJECT                                                          01060000
*****************************                                           01070000
* CLOSE WORK AREA REFERENCE *                                           01072000
*****************************                                           01074000
FORCORE  DSECT                          OPEN/CLOSE/EOV WORK AREA Y01021 01076000
         IECDSECT                                                Y01021 01078000
         EJECT                                                          01078102
CVT      DSECT                                                   Y02072 01078202
         CVT                                                     Y02072 01078302
         SPACE 2                                                        01083702
TCB      IKJTCB                                                  Y02072 01085702
         EJECT                                                          01087702
         IKJRB                                                   Y02072 01088102
         EJECT                                                          01089202
********************                                                    01094602
* DEB REFERENCE    *                                                    01100000
********************                                                    01120000
*                                                                       01140000
IHADEB   DSECT                                                          01160000
         USING IHADEB,R8                                                01180000
         DS    0D                                                       01200000
DEBNMSUB DS    0CL1                                                     01220000
DEBTCBAD DS    A                                                        01240000
DEBAMLNG DS    0CL1                                                     01260000
DEBDEBAD DS    A                                                        01280000
DEBOFLGS DS    0CL1                                                     01300000
DEBIRBAD DS    A                                                        01320000
DEBOPATB DS    0CL1                                                     01340000
DEBSYSPG DS    A                                                        01360000
DEBNMEXT DS    0CL1                                                     01380000
DEBUSRPG DS    A                                                        01400000
DEBPRIOR DS    0CL1                                                     01420000
DEBECBAD DS    A                                                        01440000
DEBPROTG DS    0BL1                                                     01460000
DEBDEBID DS    0BL1                                                     01480000
DEBDCBAD DS    A                                                        01500000
DEBEXSCL DS    0CL1                                                     01520000
DEBAPPAD DS    A                                                        01540000
DEBNIEE  DS    0CL1                                                     01560000
DEBFIEAD DS    A                                                        01580000
DEBNPEE  DS    0CL1                                                     01600000
DEBFPEAD DS    A                                                        01620000
DEBNOEE  DS    0CL1                                                     01640000
DEBFOEAD DS    A                                                        01660000
         DS    CL4                                                      01680000
DEBDVMOD DS    0CL1                                                     01700000
DEBUCBAD DS    A                                                        01720000
DEBBINUM DS    CL2                                                      01740000
DEBSTRCC DS    CL2                                                      01760000
DEBSTRHH DS    CL2                                                      01780000
DEBENDCC DS    CL2                                                      01800000
DEBENDHH DS    CL2                                                      01820000
DEBNMTRK DS    CL2                                                      01840000
         EJECT                                                          01860000
*********************************************************************** 01880000
* ISLCOMON REFERENCE     C(DCBWKPT1)=A(ISLCOMMON)                     * 01900000
*********************************************************************** 01920000
*                                                                       01940000
ISLCOMON DSECT                                                          01960000
         USING ISLCOMON,R12                                             01980000
         DS    0D                                                       02000000
ISLECBA  DS    A                        FOR CP18 AND CP20               02020000
ISLIOBA  DS    CL40                                                     02040000
ISLECBB  DS    A                        FOR CP21                        02060000
ISLIOBB  DS    CL40                                                     02080000
ISLECBC  DS    A                        FOR CP19                        02100000
ISLIOBC  DS    CL40                                                     02120000
ISLAREAZ DS    CL88                     FOR CP19                        02140000
ISLIXLT  DS    CL104                    INDEX LOCATION TABLE            02160000
ISLNIRT  DS    CL3                      HHR OF DUMMY TRACK INDEX        02180000
ISLHIRT  DS    CL1                      NO INDX ENT ON PRIM DATA TRACK  02200000
ISLCBF   DS    F                        BUF CTRL PTR (RCD WITHIN BUF)   02220000
ISLBMPR  DS    F                        USED TO BUMP CBF TO NEXT RCD    02240000
ISLFBW   DS    F                        NO OF BUFS SCHED TO WRITE       02260000
ISLEOB   DS    F                        END OF BUFFR ADR                02280000
ISLNCNT  DS    CL8                      NORMAL IX COUNT, CCHHRKDD       02300000
ISLOCNT  DS    CL8                      OVFLOL IX COUNT, CCHHRKDD       02320000
ISLDCNT  DS    CL8                      DUMMY IX COUNT,  CCHHRKDD       02340000
ISLNDAT  DS    CL10                     NORMAL IX DATA, MBBCCHHRFP      02360000
         DS    CL2                                                      02380000
ISLODAT  DS    CL10                     OVFLOW IX DATA, MBBCCHHRFP      02400000
         DS    CL1                                                      02420000
ISLBUFNO DS    CL1                      DCBBUFNO OR 2                   02440000
ISLBUFN  DS    F                        ADDR OF SLOT N IN BCT           02460000
ISLMVC   DS    F                        COUNT OF EXECUTED MOVE (N-1)    02480000
ISLMVCT  DS    F                        NOMBR OF 255 BYTE MOVES (N+1)   02500000
ISLVRSAV DS    18F                      ISL SAVE AREA                   02520000
ISLAPSAV DS    10F                      APPENDAGE SAVE AREA             02540000
ISLWRSAV DS    16F                      ISL SAVE AREA FOR CLOSE         02560000
*                                                                       02580000
TSTWK1C  DS    F                        WORK AREA                 13711 02600016
TSTWK2C  DS    F                        WORK AREA                 13711 02620016
         DS    F                        WORK AREA                 13711 02640016
ISLNOENT DS    F                        NO ENTRIES REMAINING ON TRACK   02660000
ISLOFFST DS    F                        SIZE OF WR CKD INSTR IN BYTES   02680000
ISLD     DS    F                        DISCPLACEMENT FROM CP18 START   02700000
ISLFSTBF DS    F                        ADDR OF 1ST SCHED BUF (REL)     02720000
ISLLSTBF DS    F                        ADDR OF LAST SCHED BUF (REL)    02740000
ISLCCFAD DS    F                        ADDR OF CC FLAG IN CP18         02760000
ISLKEYAD DS    F                        ADDR OF KEY OF LAST RCD ON TRK  02780000
*                                                                       02800000
ISLF8AD  DS    F                        ADDR OF PUT ISLF800             02820000
ISLFXAD  DS    F                        ADDR OF PUT ISLFX20             02840000
ISLFYAD  DS    F                        ADDR OF PUT ISLFY01             02860000
ISLFZAD  DS    F                        ADDR OF PUT ISLFZ01             02880000
ISLPAAD  DS    F                        ADDR OF PUT ISLPA01             02900000
ISLF1AD  DS    F                        ADDR OF APP ISLF110             02920000
*                                                                       02940000
*                                                                       02980000
* ISLVPTRS REFERENCE       C(DCBWKPT6)=A(ISLVPTRS)                      03000000
*                                                                       03020000
ISLVPTRS EQU   *                                                  25463 03030018
ISLVPTR1 DS    A                        A(AREA Y)                 25463 03040018
ISLVPTR2 DS    A                        A(KEYSAVE)                25463 03050018
ISLVPTR3 DS    A                        A(IOBBCT)                 25463 03060018
ISLVPTR4 DS    A                        A(CP18)                   25463 03070018
ISLVPTR5 DS    A                        A(CP19)                   25463 03080018
ISLVPTR6 DS    A                        A(CP20)                   25463 03090018
ISLVPTR7 DS    A                        A(CP21)                   25463 03100018
ISLVPTR8 DS    A                        SIZE OF ISLCOMON AREA     25463 03110018
ISLVPTR9 DS    A                        SIZE OF CHAN PROG AREA    25463 03120018
ISLVPTRA DS    A                        ADDRESS OF BAD BUFFER     25463 03130018
ISLVPTRB DS    A                        UNUSED                    25463 03140018
ISLVPTRC DS    A                        UNUSED                    25463 03150018
ISLFXWK1 DS    F                        WORK AREA                 13711 03188016
ISLFXWK2 DS    F                        WORK AREA                 13711 03192016
ISLF9WK1 DS    F                        WORK AREA                 13711 03196016
*                                                                       03200000
         EJECT                                                          03460000
********************                                                    03480000
* IOB REFERENCE    *                                                    03500000
********************                                                    03520000
*                                                                       03540000
IHAIOB   DSECT                                                          03560000
         USING IHAIOB,R2                                                03580000
         DS    0D                                                       03600000
IOBFLG1  DS    CL1                      FLAGS 1                         03620000
IOBFLG2  DS    CL1                      FLAGS 2                         03640000
AIOBSENS DS    CL2                      SENSE BYTES              Y01021 03680000
IOBECBAD DS    A                        ECB POINTER                     03700000
AIOBCSW  DS    CL8                      CHANNEL STATUS WORD      Y01021 03720000
AIOBSIOC DS    0CL1                     SIO CC                   Y01021 03740000
IOBCPSAD DS    A                        CHANNEL PROGRAM START ADR       03760000
IOBWT    DS    0CL1                     WEIGHT                          03780000
IOBDCBAD DS    A                        DCB POINTER                     03800000
IOBCPRAD DS    A                        CHANNEL PROGRAM RESTART ADR     03820000
IOBBCTI  DS    CL2                      BLK CTR INCR                    03840000
IOBECT   DS    CL2                      ERROR CTR                       03860000
IOBDADAD DS    CL8                      DIR ACESS DEV ADR MBBCCHHR      03880000
*                                                                       03900000
********************                                                    03920000
* IXLT REFERENCE   *                                                    03940000
********************                                                    03960000
*                                                                       03980000
IXLT     DSECT                                                          04000000
         USING IXLT,R7                                                  04020000
         DS    0D                                                       04040000
IXLTIND  DS    CL1                      INDICATOR                  LEV1 04060000
IXLBEG   DS    CL8                      BEGINING COUNT MBBCCHHR         04080000
IXLSTP   DS    CL8                      STEPPING COUNT MBBCCHHR         04100000
IXLEND   DS    CL8                      ENDING COUNT   MBBCCHHR         04120000
         DS    CL1                                                      04140000
         DS    CL26                                                LEV2 04160000
         DS    CL26                                                LEV3 04180000
         DS    CL26                                                LEV4 04200000
         EJECT                                                          04205020
IGCX     DSECT                                                          04210020
         IGGLDCP ,                      LOAD CP SKELETON         S20201 04215020
         EJECT                                                          04220000
IGG0202M CSECT                                                          04240000
ISLC300  BALR  R15,0                                                    04260000
         USING *,R15                                                    04280000
BASETAG  L     R1,0(RPARC)                                              04300000
         L     RCORE,4(RWTGC)                                           04320000
         L     R12,DCBWKPT1                                             04340000
         LR    RBASE,R15                                                04360000
         USING FORCORE,RCORE            CLOSE WA ADDRESSABILITY  Y02072 04380002
         STM   R1,R14,DXCCW1            SAVE  REGISTERS 1-14     Y02072 04392002
*                                                                       04392402
         MODESET  KEYADDR=DXUKEY,WORKREG=2   CHANGE TO USER KEY  Y02072 04394002
*                                                                       04394402
         L     R1,DXUDCBAD              USERS DCB ADDRESS        Y02072 04396002
         L     R10,DCBWKPT6                                             04400000
*                                                                       04440000
* EQUATE SYMBOLIC REGISTERS                                             04460000
*                                                                       04480000
R0       EQU   0                                                        04500000
R1       EQU   1                                                        04520000
R2       EQU   2                                                        04540000
R3       EQU   3                                                        04560000
R4       EQU   4                                                        04580000
R5       EQU   5                                                        04600000
R6       EQU   6                                                        04620000
R7       EQU   7                                                        04640000
R8       EQU   8                                                        04660000
R10      EQU   10                                                       04700000
R12      EQU   12                                                       04740000
R13      EQU   13                                                       04760000
R14      EQU   14                                                       04780000
R15      EQU   9                                                        04800000
RBASE    EQU   3                                                        04840000
RCORE    EQU   11                       CLOSE WORK AREA BASE     Y02072 04860002
RPAR     EQU   5                                                        04880000
RWTG     EQU   6                                                        04900000
RPARC    EQU   7                                                        04920000
RWTGC    EQU   8                                                        04940000
RJ       EQU   15                                                       05040000
*                                                                       05080000
K8       EQU   8                        CONSTANT                 S20201 05083020
LEVEL    EQU   26                       LENGTH 1 ENTRY IXLT      S20201 05086020
K4       EQU   4                        CONSTANT                 S20201 05089020
BITS23   EQU   X'30'                    LEVEL 2,3 SWS            S20201 05095020
         EJECT                                                          05100000
*********************************************************************** 05120000
* CHART C3 - PAD HI-LEV IX                                            * 05140000
*********************************************************************** 05160000
*                                                                       05180000
ISLC301  CLI   DCBNLEV,X'00'            TEST NLEV VS 0                  05200000
         BE    ISLC319                  B IF 0 TO END OF JOB            05220000
         LA    R2,ISLIOBC               C(R2)=A(IOBC)                   05240000
         L     R10,16(R10)              C(R10)=A(CP91)                  05260000
         USING CM1,R10                  ADDRESSABILITY ON CP91   S20201 05270020
         LA    R5,1                     C(R5)=0001                      05300000
         XC    ISLD(4),ISLD             SET D=0 END,NEW CYL,CHAIN SWS   05320000
*                                                                       05340000
* SET DCBOPTCD = 0 (NO CYL OVFL)                                        05360000
*                                                                       05380000
         MVI   DCBOPTCD,X'00'           SET OPTCD TO ZERO               05400000
*                                                                       05420000
* LOCATE LEVEL IN INDEX LOCATION TABLE AT CYLINDER INDEX                05440000
*                                                                       05460000
         LA    R7,ISLIXLT               C(R7)=A(IXLT)                   05480000
         OI    0(R7),X'20'              IXLTIND BIT-2 ON IN LEV1        05500000
         NI    26(R7),X'DF'                     BIT-2 OFF IN LEV2       05520000
         NI    52(R7),X'DF'                                  LEV3       05540000
         NI    78(R7),X'DF'                                  LEV4       05560000
         B     ISLC305                                                  05580000
*                                                                       05600000
* STEP TO NEXT LEVEL IN INDEX LOCATION TABLE                            05620000
*                                                                       05640000
ISLC302  LA    R7,ISLIXLT               C(R7)=A(IXLT) FOR CURR LEVEL    05660000
         LA    R5,1                     C(R5)=0001 FOR LEVEL CNT        05700000
ISLC303  LR    R6,R7                    C(R6)=A(IXLT) FOR PREV   S20201 05706020
*                                       LEVEL                    S20201 05712020
         LA    R7,LEVEL(R7)             STEP R7 TO NEXT LEVEL    S20201 05722020
         LA    R5,1(R5)                 STEP COUNT                      05740000
         TM    0(R6),X'20'              TEST IF R6 = PREV LEVEL         05760000
         BZ    ISLC303                  LOOP                     S20201 05800020
*                                                                       05840000
ISLC304  NI    0(R6),X'DF'              PREV IXLTIND BIT-2 OFF          05860000
         OI    0(R7),X'20'              CURR IXLTIND BIT-2 ON           05880000
*                                                                       05900000
* SET F BYTE IN MBBCCHHRFP TO CURR LEVEL, BITS 2 AND 3 ON (INACTIVE)    05920000
*                                                                       05940000
ISLC305  L     R3,CM27+K4                                        S20201 05950020
*                                       C(R3)=C(CM27+4)=A(MBBCCHHS20201 05960020
         STC   R5,K8(R3)                STORE LEVEL              S20201 05980020
         OI    K8(R3),BITS23            SET BITS 2 AND 3 ON      S20201 06000020
         ST    R7,ISLFXWK2              SAVE R7                         06020000
*                                                                       06040000
* GET CURR MBBCCHHR FROM SX, R = R + 1                                  06060000
*                                                                       06080000
         MVC   ISLNDAT(8),9(R7)         NDAT = MBBCCHHR CURR            06100000
         SR    R3,R3                                                    06120000
         IC    R3,ISLNDAT+7             C(R3)=R                         06140000
         LA    R3,1(R3)                 C(R3) =  R+1                    06160000
         STC   R3,ISLNDAT+7             NDAT = MBBCCHHR WITH R=R+1      06180000
*                                                                       06200000
* GET END MBBCCHHR FROM EX                                              06220000
*                                                                       06240000
         MVC   ISLODAT(8),17(R7)        ODAT = MBBCCHHR END             06260000
*                                                                       06280000
* TEST CURR R VS HIRCM, WAS LAST TRACK COMPLETED                        06300000
*                                                                       06320000
         CLC   ISLNDAT+7(1),DCBHIRCM    TEST CURR R VS HIRCM            06340000
         BC    2,ISLC311                B TO ACCESS NEXT TRACK          06360000
*                                                                       06380000
* TEST CURR CCHH VS END CCHH (ARE WE AT LAST TRACK OF CURR LEVEL)       06400000
*                                                                       06420000
ISLC310  CLC   ISLNDAT(7),ISLODAT       TEST CURR VS END MBBCCHH        06440000
         BNL   ISLC318                  B IF LAST TRACK OF LEVEL        06460000
*                                                                       06480000
* TEST CURR HH VS IXLT+22, ARE WE AT HI HH OF A CYLINDER                06500000
*                                                                       06520000
         SR    R7,R7                    CLEAR WORK REGISTER             06540000
         IC    R7,ISLAREAZ+87           GET DEVICE MASK                 06560000
ISLC3101 IC    R3,ISLNDAT+6             C(R3)= CURRENT H                06580000
         NR    R3,R7                    CALCULATE TRACK                 06600000
         IC    R14,ISLIXLT+23                                           06620000
         NR    R14,R7                   CALCULATE TRACK                 06640000
         CLR   R3,R14                   CURRENT HH VS HI HH             06660000
         BNL   ISLC312                  B IF HI HH                      06680000
*                                                                       06700000
* SET CNT A = HIRCM - R +2 (SIM FIRSH R)                                06720000
*                                                                       06740000
         IC    R7,DCBHIRCM              CNT A = HIRCM                   06760000
         IC    R3,ISLNDAT+7             C(R3) = CURR R                  06780000
         SR    R7,R3                    CNT A = HIRCM - R               06800000
         LA    R7,2(R7)                 CNT A=HIRCM - R + 2             06820000
*                                                                       06840000
         BAL   R14,ISLC201              LINK TO C2 RT TO WRITE IX TRK   06860000
*                                                                       06880000
* STEP CURR HH TO NEXT TRK, R = 1                                       06900000
*                                                                       06920000
ISLC311  L     R3,ISLNDAT+4             C(R3)= CURR CHHR                06940000
         LA    R3,256(R3)               CURR HH = NEXT HH               06960000
         IC    R3,ISL1+1                CURR R = 1                12041 06980016
         STH   R3,ISLNDAT+6                                             07000000
*                                                                       07020000
         B     ISLC310                 *B TO PROCESS NEXT TRACK OF IX   07040000
*---------------------------------------------------------------------- 07060000
*                                                                       07080000
* SET TO PROCESS LAST TRK OF CYL, CNT A = HIRCM - R +1 (SIM FIRSH R -1) 07100000
*                                                                       07120000
ISLC312  EQU   *                                                        07140000
         IC    R7,DCBHIRCM              CNT A = HIRCM                   07160000
         IC    R3,ISLNDAT+7             C(R3) = CURR R                  07180000
         SR    R7,R3                    CNT A = HIRCM - R               07200000
         LA    R7,1(R7)                 CNT A = HIRCM-R+1         12041 07220016
*                                                                       07240000
* SET END SW AND CHAINED SW ON                                          07260000
*                                                                       07280000
         OI    ISLD,X'60'               TURN D BITS 1 AND 2 ON          07300000
         MVC   ISLNOENT+3(1),DCBHIRCM   SET R = HI R              P4701 07320000
*                                                                       07340000
* TEST CURR CC VS END CC IN DEB (ARE WE AT END OF EXTENT)               07360000
*                                                                       07380000
         DROP  R1                       END USING ON USER DCB    Y02072 07390002
         L     R4,DXCCW1                PROTECTED DCB ADDR       Y02072 07392002
         USING IHADCB,R4                COPY ADDRESSABILITY      Y02072 07394002
         L     R8,DCBDEBAD              C(R8)= A(DEB)                   07400000
         DROP  R4                       END USING ON COPY DCB    Y02072 07410002
         USING IHADCB,R1                USER DCB ADDRESSABILITY  Y02072 07420002
         SR    R4,R4                                                    07440000
         IC    R4,ISLNDAT               C(R4)= CURRENT 000M             07460000
         SLL   R4,4                     C(R4)=(M-1)X16 (USE AS INDEX)   07500000
         LA    R8,32(R4,R8)             C(R8) = A(CURR EXTENT)     MC1A 07520018
         SR    R3,R3                                                    07540000
         SR    R5,R5                                                    07560000
         CLI   ISLAREAZ+86,X'02'          TEST FOR 2301                 07580000
         BNE   ISLC312B                 BRANCH IF NOT                   07600000
         LA    R4,248                                                   07620000
         IC    R3,ISLNDAT+6             GET CURNT TRK                   07640000
         NR    R3,R4                    REDUCE TO CYL VALUE             07660000
         IC    R5,3(R8)                 GER END TRK                     07680000
         NR    R5,R4                    REDUCE TO CYL VALUE             07700000
         CLR   R3,R5                    CURNT CYL VS END CYL            07720000
         B     ISLC312B+6                                               07740000
ISLC312B CLC   ISLNDAT+3(3),10(R8)      CURR CCH VS. HIGH CCH      MC1A 07760018
         BE    ISLC313                  B IF EQUAL, END OF EXTENT       07780000
*                                                                       07800000
* STEP CC TO NEXT CYL, SAME M                                           07820000
*                                                                       07840000
         LA    R4,ISLNDAT+4             C(R4)=A(CURR CHHR)              07860000
         L     R5,0(R4)                 C(R5)= CHHR             OZ05937 08080000
         SRL   R5,24                    C(R5)=000C              OZ05937 08100000
         AH    R5,ISL1                  000C+1                    12041 08120000
         SLL   R5,24                    C(R5)=C000              OZ05937 08170000
         ST    R5,ISLDCNT+4             ISLDCNT+4=C000                  08220000
         MVC   ISLDCNT(4),ISLNDAT       ISLDCNT=MBBCC000          12749 08230000
         MVI   ISLDCNT+7,X'01'          ISLDCNT=MBBCC001                08280000
         B     ISLC314                                                  08300000
*                                                                       08320000
* STEP M TO NEXT EXTENT AND GET NEXT CC FROM DEB                        08340000
*                                                                       08360000
ISLC313  SR    R4,R4                                                    08380000
         ST    R4,ISLDCNT               CLEAR MBBC                 MC1A 08390018
         IC    R4,ISLNDAT               C(R4)= CURR 000M                08400000
         LA    R8,16(R0,R8)             C(R8) = A(NEXT EXTENT)     MC1A 08430018
         MVC   ISLDCNT+3(4),6(R8)       INSERT CCHH                     08460000
         MVI   ISLDCNT+7,X'01'          CCHH1, BB ALWAYS 0              08480000
         LA    R4,1(R4)                 C(R4) = NEXT M                  08520000
         STC   R4,ISLDCNT               ISLDCNT = MBBCCHHR, R=1         08540000
ISLC314  BAL   R14,ISLC201             LINK TO C2 RTN TO WRITE IX TRK   08560000
*                                                                       08580000
* SET CURR MBBCCHHR = NEXT MBBCCHHR                                     08600000
*                                                                       08620000
         MVC   ISLNDAT(8),ISLDCNT       CURR MBBCCHHR = NEXT MBBCCHHR   08640000
         B     ISLC310                 *B TO PROCESS NEXT TRK OF IX     08660000
*---------------------------------------------------------------------- 08680000
*                                                                       08700000
* SET TO PROCESS LAST TRK OF LEV, CNT A = ENDR - R +1 (SIM FIRSH R -1)  08720000
*                                                                       08740000
ISLC318  SR    R7,R7                    CNT A = R7                      08760000
         IC    R7,ISLODAT+7             CNT A = ENDR                    08780000
         SR    R3,R3                                                    08800000
         IC    R3,ISLNDAT+7             C(R3) = CURR R                  08820000
         SR    R7,R3                    CNT A = ENDR - CURR R           08840000
         LA    R7,1(R7)                 CNT A = ENDR-CURR R +1    12041 08860016
*                                                                       08880000
* SET END SW ON                                                         08900000
*                                                                       08920000
         OI    ISLD,X'40'               TURN D BIT 1                    08940000
         MVC   ISLNOENT+3(1),ISLODAT+7  SET R = END R             P4701 08960000
*                                                                       08980000
         BAL   R14,ISLC201              LINK TO C2 RT TO WRITE IX TRK   09000000
*                                                                       09020000
         L     R7,ISLFXWK2              RESTORE R7                      09040000
*                                                                       09060000
* TEST IXLT TO SEE IF CURR LEVEL WAS LAST LEVEL (ARE WE DONE)           09080000
*                                                                       09100000
         TM    0(R7),X'80'              TEST IXLTIND BIT 0              09120000
         BC    8,ISLC302                B IF 0 TO PROCESS NEXT LEVEL    09140000
*                                                                       09160000
* END OF JOB                                                            09180000
*                                                                       09200000
ISLC319  MVC   DCBOPTCD(1),ISLF9WK1+3   RESTORE DCBOPTCD                09220000
         MVC   DCBFIRSH(3),ISLF9WK1     RESTORE DCBFIRSH                09240000
*                                                                       09260000
* TEST DCBEXCD1 BIT 5 FOR PREVIOUS UNCORRECTABLE WRITE ERROR            09280000
*                                                                       09300000
         TM    DCBEXCD1,X'04'           TEST EXCD1 BIT 5                09320000
         BC    8,ISLC320                B IF NOT ON                     09340000
         OI    DCBST,X'40'              SET FIRST TIME SWITCH ON IN     09360000
*                                       CASE NO DATA WAS CREATED        09380000
         L     RJ,CVTPTR                ADDRESS OF CVT           Y02072 09420002
         USING CVT,RJ                   CVT ADDRESSABILITY       Y02072 09430002
         L     RJ,CVTTCBP               ADDR OF TCB PTRS         Y02072 09440002
         L     RJ,0(RJ)                 TCB ADDRESS              Y02072 09450002
         USING TCB,RJ                   TCB ADDRESSABILITY       Y02072 09452002
         L     RJ,TCBRBP                ADDRESS OF SVRB          Y02072 09454002
         USING RBBASIC,RJ               SVRB ADDRESSABILITY      Y02072 09456002
*                                                                       09456402
         MODESET  KEYADDR=KEY0,WORKREG=14  SET PROTECTION KEY 0  Y02072 09456802
*                                                                       09457202
         STM   R8,RCORE,RBEXSAVE        SAVE REGS 8-11           Y02072 09458402
         L     R15,ISLF8AD              SET FOREIGN BASE ***WR ERROR*** 09458502
         DROP  RJ                       END USING ON SVRB        Y02072 09458802
         LR    RJ,R15                   ENTRY POINT ADDR         Y02072 09459202
*                                                                       09459302
         SYNCH (15)                     GO HANDLE SYNAD EXIT     Y02072 09459602
*                                                                       09459702
         L     RJ,CVTPTR                CVT ADDRESS              Y02072 09459802
         USING CVT,RJ                   CVT ADDRESSABILITY       Y02072 09459902
         L     RJ,CVTTCBP               ADDR OF TCB PTRS         Y02072 09460002
         L     RJ,0(RJ)                 TCB ADDRESS              Y02072 09463202
         USING TCB,RJ                   TCB ADDRESSABILITY       Y02072 09465202
         L     RJ,TCBRBP                ADDRESS OF SVRB          Y02072 09465602
         USING RBBASIC,RJ               SVRB ADDRESSABILITY      Y02072 09466002
         LM    R8,RCORE,RBEXSAVE        RESTORE REGS 8-11        Y02072 09466402
*                                                                       09466702
ISLC320  EQU   *                                                  P4701 09470000
*                                                                       09472002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 09480002
*                                                                       09482002
         LM    R1,R14,DXCCW1            RESTORE REGISTERS        Y02072 09494002
         USING BASETAG,RBASE                                            09500000
         MVC   0(L'LOAD2D,RWTGC),LOAD2D NEXT LOAD - IGG0202D     Y02072 09520002
RELOOP   LA    RWTGC,8(RWTGC)           INCREMENT WTG CURNT ENTRY       09540000
         LA    RPARC,4(RPARC)           INCREMENT DCB CURNT ENTRY       09560000
         CLC   0(2,RWTGC),THISLOAD                                      09580000
         BCR   8,RBASE                  BRANCH=BEGINNING OF THIS MODULE 09600000
         CLI   0(RWTGC),X'F0'           TEST FOR END OF WTG TABLE  MC1A 09620018
         BC    7,RELOOP                 BRANCH=NOT AT END               09640000
ATEND    LR    RPARC,RPAR               INITIALIZE RPARC                09660000
         LA    RWTGC,32(RWTG)           INITIALIZE RWTGC                09680000
ZCHECK   CLI   0(RWTGC),X'00'           TEST FOR ENTRY = 0              09700000
         BC    7,TCTLRTN                BRANCH = NOT ZERO               09720000
ITSZERO  LA    RWTGC,8(RWTGC)                                           09740000
         LA    RPARC,4(RPARC)                                           09760000
         B     ZCHECK                                                   09780000
TCTLRTN  EQU   *                                                        09800000
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID                         09820000
*                                                                       09840002
         USING FORCORE,RCORE                                     Y01021 09850000
         LA    RJ,DXCCW12               WA ADDRESS               Y01021 09860000
         XCTL  EPLOC=(RWTG),DCB=0,SF=(E,(15))  XCTL TO IGG0202D  Y02072 09880002
*                                                                       09900000
         DROP  RBASE                                                    09920000
         EJECT                                                          09940000
*********************************************************************** 09960000
* CHART C2 - WRITE IX PADDING                                         * 09980000
*********************************************************************** 10000000
*                                                                       10020000
ISLC201  EQU   *                                                        10040000
*                                                                       10060000
* TEST FOR NEW CYLINDER                                                 10080000
*                                                                       10100000
         TM    ISLD,X'80'               TEST NEW CYL SW (D BIT 0)       10120000
         BC    8,ISLC202                B IF OFF                        10140000
*                                                                       10160000
* NEW CYL - SET NEW CYL SW OFF                                          10180000
*                                                                       10200000
         NI    ISLD,X'7F'               SET NEW CYL SW OFF (D BIT 0)    10220000
*                                                                       10240000
* SET F = 30                                                            10260000
*                                                                       10280000
         L     R5,CM27+K4                                        S20201 10290020
*                                       C(R5)=C(CM27+4)=A(MBBCCHHS20201 10300020
         OI    8(R5),X'10'              SET F = 3X (ADD BIT 3)          10320000
         NI    8(R5),X'F7'              SET F = UNCHAINED (BIT 4 OFF)   10340000
         XC    0(8,R5),0(R5)            SET MBBCCHHR TO ZEROS           10360000
*                                                                       10380000
* TEST FOR CYL OVFL AREA                                                10400000
*                                                                       10420000
         LR    R4,R10                   C(R4)= A(CM5)                   10440000
         TM    DCBOPTCD,X'08'           TEST OPTCD BIT-4 FOR CYL OVFL   10460000
         BC    7,ISLC203                                                10480000
*                                                                       10500000
* SET CPSTART IN IOBC TO CM5                                            10520000
*                                                                       10540000
ISLC202  LA    R4,CM5                   C(R4)=A(CM5)             S20201 10560020
ISLC203  ST    R4,IOBCPSAD              STORE CPSTRT IN IOBC CP START   10580000
*                                                                       10600000
* SET IOBC+32 TO CURR MBBCCHHR, WITH R=R-1                              10620000
*                                                                       10640000
         MVC   IOBDADAD(8),ISLNDAT      C(IOBC+32)=CURR MBBCCHHR        10660000
         L     RJ,DXCCW1                DCB COPY ADDRESS         Y02072 10670002
         USING IHADCB,RJ                COPY DCB ADDRESSABILITY  Y02072 10672002
         L     R8,DCBDEBAD              C(R8)= A(DEB)                   10680000
         USING IHADEB,R8                R8 = DEB ADDRESS         Y01021 10698400
         DROP  RJ                       END USING ON DCB COPY    Y02072 10698802
         USING IHADCB,R1                USERS DCB                Y02072 10699202
         L     R3,DEBFPEAD              C(R3)= A(1ST PRIME EXTENT       10700000
         SR    R4,R4                                                    10720000
         IC    R4,ISLNDAT               C(R4)= CURR 000M                10740000
         BCTR  R4,0                     C(R4)= M-1                      10760000
         SLL   R4,4                     C(R4)=(M-1)X16                  10780000
         LA    R4,0(R4,R3)              C(R4)=A(M-1 EXTENT)             10800000
         MVC   IOBDADAD+1(2),4(R4)      SET BB                     MC1A 10830018
         IC    R3,IOBDADAD+7            C(R3)=R                         10860000
         BCTR  R3,0                     C(R3)= R-1                      10880000
         STC   R3,IOBDADAD+7            C(IOBC+32)=MBBCCHHR, R=R-1      10900000
*                                                                       10920000
* SET COUNTS IN AREA Z AND TURN ON ALL CC FLAGS IN CP91, TURN 10TH OFF  10940000
*                                                                       10960000
         L     R3,ISL10                 C(R3)=10 = LOOP COUNT           10980000
         LA    R8,ISLAREAZ             R8 = A(AREAZ)                    11000002
         LA    R4,6(R8)                 C(R4)=A(Z+6) = COUNT 1 ADR      11020002
         SR    R5,R5                                                    11040000
         IC    R5,ISLNDAT+7             C(R5)=CURR R                    11060000
         LA    R6,CM8+K4                C(R6)=A(CC FLAG FOR      S20201 11070020
*                                       CM8)-CP91                S20201 11080020
ISLC204  MVC   0(4,R4),ISLNDAT+3        MOVE CURR CCHH                  11100000
         STC   R5,4(R4)                 STORE R                         11120000
         OI    0(R6),X'40'              TURN ON CC FLAG IN CP91         11140000
         LA    R4,8(R4)                 STEP Z                          11160000
         LA    R5,1(R5)                 BUMP R                          11180000
         LA    R6,16(R6)                STEP CP91                       11200000
         BCT   R3,ISLC204               LOOP                            11220000
         NI    CM26+K4,X'FF'-CC         TURN OFF TENTH CC FLAG   S20201 11230020
*                                       IN CP91                  S20201 11240020
*                                                                       11260000
* TEST CNT A VS 1 (ONLY 1 ENTRY ON LAST TRACK OF IX)                    11280000
*                                                                       11300000
         CH    R7,ISL1                  TEST CNT A VS 1           12041 11320016
         BNH   ISLC208                  BR, WRITE DUMMY END ONLY  18218 11340000
*                                                                       11360000
* TEST CNT A VS 10 (SET UP A(CC FLAG) OF LAST WR)                       11380000
*                                                                       11400000
         SR    R4,R4                                                    11420000
         LR    R5,R7                    C(R5)=CNT A (SIM FIRSH)         11440000
         BCTR  R5,0                     C(R5)= CNT A -1                 11460000
         D     R4,ISL10                 C(R4)=R                         11480000
*                                       C(R5)=Q                         11500000
         LTR   R4,R4                    TEST R VS 0                     11520000
         BC    7,ISLC205                BRANCH IF R NOT 0               11540000
         L     R4,ISL10                 C(R4)=10                        11560000
         BCTR  R5,0                     C(R5)= Q-1                      11580000
ISLC205  SLL   R4,4                     MULTIPLY R X 16                 11600000
         LA    R6,CM6+K4(R4)            C(R6)= A(CC FLAG) OF     S20201 11610020
*                                       LAST WR                  S20201 11620020
         LTR   R5,R5                    TEST Q VS 0                     11640000
         BC    7,ISLC206                BRANCH IF NOT 0,CNT GTR 10      11660000
*                                                                       11680000
* TEN OR LESS ENTRIES TO WR                                             11700000
*                                                                       11720000
         NI    0(R6),X'BF'              SET OFF CC FLAG BASED ON CNT A  11740000
         ST    R5,12(R10)               SET CM2+4 = 0000          12749 11770015
         B     ISLC207                                                  11800000
*                                                                       11820000
* MORE THAN TEN ENTRIES TO WR                                           11840000
*                                                                       11860000
ISLC206  STC   R7,DCBFIRSH+2            SET FIRSH R = CNT A             11880000
         ST    R6,12(R10)               SET CM2+4 = A(CC FLAG)          11900000
*                                                                       11920000
* EXECUTE CP91                                                          11940000
*                                                                       11960000
ISLC207  LA    R13,ISLVRSAV             C(R13)=A(VRSAV)                 11980000
         LR    R3,R1                    SAVE R1                         12000000
         L     R4,IOBECBAD              C(R4)=A(ECB)                    12020000
         LR    R6,R14                   SAVE R14                        12040000
         EXCP  IHAIOB                   EXECUTE CHANNEL PROGRAM         12060000
*                                                                       12080000
* AWAIT COMPLETION                                                      12100000
*                                                                       12120000
         LR    R1,R4                    C(R1)=A(ECB)                    12140000
         WAIT  ECB=(1)                  WAIT                            12160000
         LR    R1,R3                    RESTORE R1                      12180000
         LR    R14,R6                   RESTORE R14                     12200000
*                                                                       12220000
* SET CPSTART IN IOBC TO CM5                                            12240000
*                                                                       12260000
         LA    R4,CM5                   C(R4)=A(CM5)             S20201 12280020
         ST    R4,IOBCPSAD              STORE CPSTART IN IOBC CP START  12300000
*                                                                       12320000
* TEST ENDSW FOR LAST TRACK OF CURR IX                                  12340000
*                                                                       12360000
ISLC208  TM    ISLD,X'40'               TEST D BIT 1 (ENDSW)            12380000
         BCR   8,R14                    RETURN TO C1 IF OFF             12400000
*                                                                       12420000
* LAST TRACK OF CURR IX - SET ENDSW OFF, NEW CYL SW ON                  12440000
*                                                                       12460000
         NI    ISLD,X'BF'               TURN D BIT 1 OFF (ENDSW)        12480000
         OI    ISLD,X'80'               TURN D BIT 0 ON (NEW CYL SW)    12500000
*                                                                       12520000
* SET UP IOBC AND AREA Z FOR WRITING DUMMY END IX ENTRY                 12540000
*                                                                       12560000
         SR    R3,R3                                                    12580000
         IC    R3,ISLNOENT+3            C(R3) = R                 P4701 12600000
         STC   R3,10(R8)                C(1ST CNT IN AREA Z) = FINAL R  12620002
         BCTR  R3,0                     C(R3)=NIRT R-1 OR PREV R        12640000
         STC   R3,IOBDADAD+7            C(IOBC+32) = PREV R             12660000
         MVC   IOBDADAD+5(2),ISLNDAT+5  C(IOBC+32) = CURR HH            12680000
*                                                                       12700000
* SET CC FLAG FOR CM8 IN CP91 OFF TO WRITE LAST ENTRY                   12720000
*                                                                       12740000
         NI    CM8+K4,X'FF'-CC          TURN OFF 1ST CC FLAG IN  S20201 12750020
*                                       CP91                     S20201 12760020
*                                                                       12780000
* SET F = 20                                                            12800000
*                                                                       12820000
         L     R5,CM27+K4               C(R5)=A(MBBCCLLRFP)      S20201 12840020
         NI    8(R5),X'EF'              SET F = 2X (DELETE BIT 3)       12860000
         SR    R4,R4                                                    12880000
         ST    R4,12(R10)               SET CM2+4 = 0000                12900000
*                                                                       12920000
* TEST CHAINED SW                                                       12940000
*                                                                       12960000
         TM    ISLD,X'20'               TEST D BIT 2 (CHAINED SW)       12980000
         BC    8,ISLC207                B IF OFF TO WR LAST ENTRY       13000000
         OI    8(R5),X'08'              SET F = CHAINED (BIT 4 ON)      13020000
         NI    ISLD,X'DF'               SET D BIT 2 OFF (CHAINED SW)    13040000
         MVC   0(8,R5),ISLDCNT          MOVE A(NEXT IX) TO MBBCCHHR     13060000
         B     ISLC207                  B TO WR LAST ENTRY              13080000
*                                                                       13100000
* --------------------------------------------------------------------* 13120000
         EJECT                                                          13140000
*                                                                       13160000
* CONSTANTS                                                             13180000
*                                                                       13200000
ISL1     DC    H'0001'                                            12041 13220016
ISL10    DC    F'0010'                                                  13240000
KEY0     EQU   ISL10                    STORAGE PROTECT KEY ZERO Y02072 13250002
*                                                                       13260000
THISLOAD DC    C'2M'                                                    13280000
MASK     DC    X'0018'                                                  13300000
         DC    X'0B18'                                                  13320000
         DC    X'1810'                                                  13340000
         DC    X'1818'                  SHIFT CON FOR CYL SWITCH A51539 13360000
         DC    X'1818'                  SHIFT CON FOR CYL SWITCH A51539 13380000
         DC    X'1818'                  SHIFT CON FOR CYL SWITCH A51539 13390000
*                                                                       13400002
LOAD2D   DC    C'2D'                    MODULE ID                Y02072 13460002
*                                                                       13510002
PATCH    DC    XL((*-IGG0202M)/20)'00'  ZEROED PATCH AREA        Y02072 13520002
         END                                                            13560000
