         TITLE 'IGG0203A - BDAM CLOSE EXECUTOR'                         00020000
IGG0203A CSECT                                                          00040000
*********************************************************************** 00050002
*                                                                     * 00060002
*  MODULE NAME = IGG0203A                                             * 00070002
*                                                                     * 00072002
*  DESCRIPTIVE NAME = BDAM CLOSE EXECUTOR                             * 00074002
*                                                                     * 00074402
*  COPYRIGHT = NONE                                                   * 00074802
*                                                                     * 00075202
*  STATUS RELEASE VS2-2 LEVEL 0                                       * 00075602
*                                                                     * 00075702
*                                                                     * 00075802
*  FUNCTION/OPERATION = THIS MODULE RECEIVES CONTROL DURING THE CLOSE * 00075902
*   OF A BDAM DATA SET AND WILL PURGE ALL I/O REQUESTS WHICH WERE IN  * 00100002
*   PROCESS AT THE TIME CLOSE WAS EXECUTED, FREE ANY IOBS THAT WERE   * 00110002
*   OBTAINED DURING PROCESSING, AND FREE BUFFERS IF THE DYNAMIC       * 00120002
*   BUFFER OPTION WAS USED. IT WILL FREE THE SEGMENT WORK AREA POOL IF* 00120402
*   VARIABLE SPANNED WAS SPECIFIED WITHOUT DYNAMIC BUFFERING. IT WILL * 00120502
*   DEQ ALL ENTRIES IN THE READX LIST AND FREE THE SEGMENTS.          * 00120602
*   AS EACH OPERATION IS COMPLETED AUDIT TRAIL BITS ARE SET TO INDI-  * 00120702
*   CATE THAT EITHER THE OPERATION COMPLETED SUCCESSFULLY OR THAT IT  * 00121402
*   WAS NOT NECESSARY. THESE BITS SERVE ONLY TO INFORM THE USER OF THE* 00123402
*   STATUS OF HIS DATA SET AND THE DISPOSITION OF RESOURCES USED BY IT* 00125402
*   BEFORE RETURNING TO COMMON CLOSE, A BRANCH IS MADE TO THE O/C/E   * 00125502
*   RESIDENT ROUTINE TO COPY THE DCB FROM THE CLOSE WORKAREA INTO     * 00125602
*   THE USER'S DCB CORE.                                              * 00125702
*                                                                     * 00125802
*  NOTES = THE MODULE IS ENTERED IN DATA MANAGEMENT KEY. ALL DEQS,    * 00126502
*   PURGE PROCESSING AND XCTL ARE IN DATA MANAGEMENT KEY.  IOBS       * 00127202
*   AND BUFFERS ARE FREED IN USER KEY.                                * 00127902
*                                                                     * 00128602
*   THIS MODULE WILL BE ENTERED BY THE FORCE CLOSE EXECUTOR DURING    * 00129002
*   ABEND PROCESSING, SHOULD THE ABEND OCCUR DURING OPEN, AFTER THE   * 00129102
*   DCB HAS BEEN COPIED BACK. PROCESSING IS THE SAME UNDER BOTH       * 00129202
*   NORMAL AND ABEND CONDITIONS.                                      * 00129502
*                                                                     * 00129902
*     DEPENDENCIES = NONE                                             * 00130102
*                                                                     * 00130402
*     DATA AREAS = NONE                                               * 00130702
*                                                                     * 00131402
*     RESTRICTIONS = NONE                                             * 00132102
*                                                                     * 00132802
*     REGISTER CONVENTIONS = SEE REGISTER EQUATES BELOW               * 00133502
*                                                                     * 00134202
*     PATCH LABEL = NONE                                              * 00134902
*                                                                     * 00135602
*                                                                     * 00136302
*  MODULE TYPE = CLOSE EXECUTOR                                       * 00137002
*                                                                     * 00137702
*     PROCESSOR = ASSEMBLER XF                                        * 00138402
*                                                                     * 00139102
*     MODULE SIZE = 920 DECIMAL BYTES                                 * 00139802
*                                                                     * 00140502
*     ATTRIBUTES = REENTRANT,ENABLED,PRIVILEGED, ENTERED IN DATA      * 00141202
*       MANAGEMENT KEY. MODESET IS ISSUED TO DO SOME PROCESSING IN    * 00141902
*       USER KEY.                                                     * 00142602
*                                                                     * 00143302
*                                                                     * 00144002
*  ENTRY POINT = 'START'                                              * 00144702
*                                                                     * 00145402
*     PURPOSE = SEE FUNCTION                                          * 00146102
*                                                                     * 00146802
*     LINKAGE = THIS MODULE RECEIVES CONTROL EITHER FROM COMMON CLOSE * 00147502
*       OR ANOTHER EXECUTOR WHEN ITS ID APPEARS AS THE NEXT NON-ZERO  * 00148202
*       ENTRY IN THE WTG TABLE. IT MAY ALSO RECEIVE CONTROL FROM      * 00148902
*       THE FORCE CLOSE EXECUTOR IF AN ABEND OCCURRED DURING OPEN.    * 00149302
*                                                                     * 00151302
*     INPUT - INPUTS TO THIS ROUTINE ARE                              * 00153302
*        REGISTER 5 - BEGINNING OF THE DCB PARAMETER LIST             * 00155302
*        REGISTER 6 - BEGINNING OF THE WHERE-TO-GO TABLE (WTG)        * 00157302
*        REGISTER 7 - BEGINNING OF THE CURRENT ENTRY IN THE DCB       * 00157402
*                     PARAMETER LIST                                  * 00170402
*        REGISTER 8 - ADDRESS OF THE CURRENT ENTRY IN THE WTG         * 00180402
*                                                                     * 00182402
*        OPEN WORKAREA - CONTAINS DCB COPY, PARM LIST, WORKAREA,      * 00182802
*          USER DCB ADDRESS AND KEY, FORCE CLOSE EXEC ADDRESS,        * 00183202
*          WTG TABLE AND AUDIT CONTROL BYTES.                         * 00183602
*                                                                     * 00183702
*                                                                     * 00183802
*     OUTPUT = THIS ROUTINE XCTLS TO COMMON CLOSE. REGISTERS 5 AND 6  * 00184002
*        ARE LEFT UNCHANGED. REGISTERS 7 AND 8 ARE POSITIONED TO      * 00197002
*        THE NEXT UNCOMPLETED ENTRY IN THE PARM LIST AND WTG TABLE.   * 00210002
*                                                                     * 00223002
*           CONTROL BLOCKS/DATA AREAS FREED:                          * 00236002
*                          USL/BCB INCLUDING BUFFERS                  * 00249002
*                          SWA INCLUDING BUFFERS                      * 00262002
*                          READ EXCLUSIVE LIST                        * 00275002
*                          ALL IOBS IN IOB POOL AND UNPOSTED QUEUE    * 00288002
*                                                                     * 00301002
*           ALL ENTRIES IN THE READX LIST WILL HAVE BEEN DEQUEUED;    * 00314002
*           DCB WILL HAVE BEEN RETURNED TO PREOPEN STATE              * 00327002
*                                                                     * 00340002
*     EXIT-NORMAL = XCTL BACK TO COMMON CLOSE IF SCAN OF THE WTG TABLE* 00353002
*        DOES NOT FIND A NON-ZERO ENTRY. OTHERWISE AN XCTL IS MADE    * 00366002
*        TO THE FIRST NON-ZERO ENTRY IN THE TABLE.                    * 00379002
*                                                                     * 00392002
*     EXIT-ABNORMAL = NONE                                            * 00405002
*                                                                     * 00418002
*                                                                     * 00431002
*  EXTERNAL REFERENCES = NONE                                         * 00444002
*                                                                     * 00457002
*     ROUTINES:  PURGE(SVC 16) TO PURGE OUTSTANDING I/0               * 00470002
*                FREEMAIN(SVC 10) IS CALLED TO FREE IOBS, READX LIST, * 00483002
*                          SWAS AND BUFFERS                           * 00496002
*                DEQ(SVC 48) IS CALLED TO DEQ ALL BLOCKS ON READX LIST* 00509002
*                XCTL(SVC 7) IS CALLED TO PASS CONTROL                * 00522002
*                IECRES - O/C/EOV RESIDENT RTN FOR DCB COPYBACK       * 00532002
*                                                                     * 00535002
*                                                                     * 00548002
*  TABLES/WORK AREAS- 1.DCB PARAMETER LIST IS THE ADDRESS OF EACH DCB * 00561002
*   SPECIFIED IN THE CLOSE MACRO INSTRUCTION. THE HI-ORDER BYTE       * 00574002
*   CONTAINS A CODE INDICATING THE MODE .                             * 00587002
*   2.WHERE-TO-GO TABLE CONTAINS THE ID AND TTR OF THE ROUTINE WHICH  * 00600002
*   IS TO PROCESS THE CORRESPONDING DCB AND THE ADDRESS OF A WORK AREA* 00613002
*   ASSIGNED TO THAT DCB.                                             * 00626002
*   3.WORK AREA IS A TEMPORARY AREA IN SP230 USED BY THIS ROUTINE     * 00639002
*   AS A WORKAREA FOR THE PURGE PARAMETER LIST. THE COPY OF THE DCB   * 00652002
*   IN THIS WORKAREA IS REFERENCED THROUGHOUT. INFORMATION CONCERNING * 00665002
*   USER KEY AND DCB LENGTHS ARE ALSO KEPT IN THE WORKAREA.           * 00678002
*                                                                     * 00691002
*                                                                     * 00704002
*  MACROS = FREEMAIN, MODESET, XCTL, DEQ, PURGE, WAIT, IECRES         * 00717002
*                                                                     * 00730002
*                                                                     * 00743002
*                                                                     * 00756002
*  CHANGE ACTIVITY = AS FOLLOWS:                                      * 00769002
*                                                                     * 00782002
*                    OS 21 DELETIONS/CHANGES                          * 00795002
*2964053800-054550                                               A40558 00808002
*2964037300,043600-043800                                        M0045  00821002
*2964036400-037200                                               A35821 00834002
*2964009800,036600,041600,085400-091000,091200                   A35339 00847002
*                    VS1-1 DELETIONS/CHANGES                          * 00860002
*                    VS1-2 DELETIONS/CHANGES                          * 00873002
*                    VS1-3 DELETIONS/CHANGES                          * 00886002
*                    VS2-1 DELETIONS/CHANGES                          * 00899002
*                    VS2-2 DELETIONS/CHANGES                          * 00912002
*000300-000350,017100,017300-017360,020735-020737,023120-026900,024600, 00925002
*032800,033552,036420,036520-036580,038200,039400-039900,044000,051300, 00938002
*053000,056000-062120,064800-065200,067644-067648,074900         Y02072 00951002
*                                                                YM1103 00961002
*                                                                YM1190 00963002
*                                                                YM3242 00963402
*                    UPDATES SUBSEQUENT TO VS2-3                      * 00963637
*C043807                                                        ZA09624 00963837
*C049361                                                        ZA09656 00963937
*C033383,033390,A073510                                        @ZA12264 00964037
*D055200-055220,A055054-055184,055240,063404-063406            @ZA11614 00967037
*                    UPDATES SINCE VS2-3.7                            * 00967737
*A027904-027924,A027944                                        @ZA21099 00968437
*C055120-055124,C055128-055130,C055134,C055153,A055132,        @ZA28352 00969237
*A055141-055148,A063405                                        @ZA28352 00969537
*********************************************************************** 00970137
         EJECT                                                          00977002
*********************************************************************** 00990002
*                         REGISTER USAGE                              * 01020002
*********************************************************************** 01030002
RPARM0   EQU   0         PARM PASSED TO FREEMAIN WITH LENGTH            01090002
R0       EQU   0         PARM REG TO SAVE ALL REGS               YM1190 01100002
RBUF     EQU   1         BASE REGISTER FOR BUFFER CNTRL BLK             01120002
RPARM1   EQU   1         PARM PASSED TO FREEMAIN, PURGE AND WAIT        01132002
RDEQWORK EQU   1         WORK REG FOR DEQ PROCESSING                    01134002
RDCB     EQU   2         USER'S DCB ADDRESS                             01140000
RBASE    EQU   3         BASE REGISTER                                  01160000
RCORE    EQU   4         WORK AREA ADDRESS                              01180000
RPAR     EQU   5         PARAMETER LIST ADDRESS                         01200000
RCVT     EQU   5         CVT ADDRESS                           @ZA28352 01206037
RES      EQU   5         ADDRESS OF O/C/EOV RES RTN            @ZA28352 01212037
RWTG     EQU   6         BEGINNING OF WTG                               01220000
RDXWORK  EQU   6         BASE REG FOR RDXENTRY AND RDX WORK REG         01230002
RPARC    EQU   7         CURRENT ENTRY IN PARAMETER LIST                01240000
RWORKK   EQU   7         WORK REG-SAVES RDXLIST ADDR BET RTNS    Y02072 01242002
RWTGC    EQU   8         CURRENT ENTRY IN WTG                           01244002
RWORKC   EQU   9         WORK REGISTER                                  01250002
RDXLST1  EQU   9         POINTER TO NEXT READX LIST                     01252002
RUSL     EQU   10        PTR TO UNSCHEDULED LIST                        01270002
RDXLST   EQU   10        BASE FOR READX LIST                            01280002
RIOB     EQU   11        BASE FOR IOB DSECT                             01290002
RDEB     EQU   11        BASE FOR DEB DSECT                             01292002
RWORKA   EQU   11        WORK REGISTER, ALSO WORKREG FOR MODESET Y02072 01302002
RWORKB   EQU   11        WORK REGISTER                         @ZA11614 01304037
RDEQ     EQU   11        BASE REGISTER FOR DEQ PARM LIST                01304637
RWORKD   EQU   12        WORK REGISTER                         @ZA11614 01305237
RWORKE   EQU   12        WORK REG -EVEN REG IN ARITH OPERATIONS         01306002
RNUMENT  EQU   12        CTR FOR NUMBER OF READX ENTRIES                01308002
RIOB2    EQU   13        NEXT IOB POINTER                               01310002
RWORKO   EQU   13        WORK REG -ODD REG IN ARITH OPERATIONS          01310402
RUSLSLOT EQU   13        BASE REGISTER FOR USLSLOT                      01312002
RWORKF   EQU   14        WORK REGISTER                                  01320002
RETURN   EQU   14        RETURN REGISTER FROM SUBROUTINES               01330002
RWORKJ   EQU   15        WORK REGISTER                                  01340002
RTCB     EQU   15        BASE REG FOR TCB                               01350002
R15      EQU   15        PARM REG FOR XCTL AND SAVE                     01400002
*********************************************************************** 01590002
         EJECT                                                          01600002
*********************************************************************** 01610002
*                   INITIALIZATION OF REGISTERS                       * 01612002
*********************************************************************** 01614002
START    EQU   *                        PRIMARY ENTRY POINT             01640002
         BALR  RBASE,0                  SET BASE REGISTER               01642002
         USING *,RBASE                  ESTABLISH BASE FOR THIS MOD     01644002
         USING WTG,RWTG                 ESTABLISH BASE FOR WHERE-TO-GO  01650002
         USING WTGENTRY,RWTGC           ESTABLISH BASE FOR CURRENT ENT  01652002
         USING PARML,RPARC              ESTABLISH BASE FOR PARM LIST    01654002
         L     RDCB,PARDCBAD            LOAD DCB ADDRESS                01660002
         USING IHADCB,RDCB              ESTABLISH BASE FOR DCB          01670002
         DROP  RPARC                                                    01672002
         L     RCORE,WTGDCBWA           LOAD WORK AREA ADDRESS          01680002
         USING FORCORE,RCORE            ESTABLISH BASE FOR CLOSE WKAREA 01690002
         DROP  RWTG                                                     01692002
         SPACE 2                                                        01694002
*********************************************************************** 01700002
*  THE FOLLOWING ROUTINE BUILDS THE PURGE LIST IN THE CLOSE WORKAREA  * 01702002
*  AND PURGES ALL OUTSTANDING I/O REQUESTS ASSOCIATED WITH THE DEB.   * 01704002
*********************************************************************** 01706002
         LA    RPARM1,DXCCW6            LOAD ADDR OF PURGE LIST  Y02072 01716002
         USING PPL,RPARM1               EST BASE FOR PARM LIST   Y02072 01718002
         L     RDEB,DCBDEBAD            LOAD ADDRESS OF DEB             01720002
         USING DEBBASIC,RDEB            ESTABLISH BASE FOR DEB          01738002
         ST    RDEB,PPLDSID             STORE INTO PURGE LIST    Y02072 01740002
         MVI   PPLOPT1,PPLDS+PPLHIO     SET PURGE CODE           Y02072 01760002
         LA    RWORKJ,DEBUSRPG          LOAD ADDR OF PURGE CHAIN FIELD  01780002
         ST    RWORKJ,PPLPIRL           AND STORE INTO PURGE BLK Y02072 01800002
         SR    RWORKJ,RWORKJ            STORE ZEROS IN THE ECB PORTION  01820002
         ST    RWORKJ,PPLCC             OF THE PURGE BLOCK       Y02072 01840002
         DROP  RPARM1                   PURGE DESTROYS R1        Y02072 01850002
*                                                                       01880000
         PURGE (1)                      PURGE ANY OUTSTANDING I/O       01900002
*                                                                       01920000
         LA    RPARM1,DXCCW6            LOAD ADDR OF PURGE LIST  Y02072 01930002
         USING PPL,RPARM1               EST BASE FOR PARM LIST   Y02072 01932002
         LA    RPARM1,PPLCC             LOAD WAIT PARAMETER ADDR Y02072 01940002
         DROP  RPARM1                                            Y02072 01950002
         WAIT  ECB=(1)                  WAIT FOR PURGE TO COMPLETE      01960002
         OI    DXATEXC2+1,FCACPURG      SET AUDIT TRAIL INDICA-  Y02072 01962002
*                                       TING PURGED I/O          Y02072 01964002
         DROP  RDEB                                                     01970002
         SPACE 2                                                        01972002
*********************************************************************** 01980002
*  THE FOLLOWING ROUTINE BUILDS A DEQ LIST, USING THE AVT AS A WORK   * 01990002
*  AREA, AND DEQUEUES EACH ENTRY IN THE READX LIST SEGMENTS,IF THE DCB* 02000002
*  SPECIFIED EXCLUSIVE CONTROL.THE READX LIST PTR IS DEBXXARG IN THE  * 02018002
*  DEB EXTENSION. THE NEXT SEGMENT POINTER IS IN FIELD RDXNEXT IN THE * 02018402
*  READX LIST. THIS ROUTINE EXECUTES IN DATA MANAGEMENT KEY.          * 02018802
*********************************************************************** 02019702
DEQRDX   TM    DCBOPTCD,DCBOPTRE        IS THERE AN EXCLUSIVE CONTROL   02019802
         BZ    IOBPOOL                  LIST? BRANCH IF NO.      Y02072 02019902
         L     RDEB,DCBDEBAD            ADDRESS OF DEB                  02029902
         USING DEBBASIC,RDEB            ESTABLISH BASE FOR DEB          02039902
         L     RDEQ,DEBAPPAD            ADDR OF APPENDAGE VECTOR LIST   02043202
*                                       WHICH WILL BE USED FOR DEQ PARM 02045202
         DROP  RDEB                                              A35821 02045602
*                                                                       02046002
*   GET ADDRESS OF READ EXCLUSIVE LIST, FOUND IN DEB EXTENSION          02046402
*                                                                       02046502
         USING DEBAVT,RDEQ              ESTABLISH BASE FOR AVT   Y02072 02046602
         L     RDXLST1,DEBXTNP          GET ADDR OF DEB EXT      Y02072 02054902
         DROP  RDEQ                                              Y02072 02056902
         USING DEBXTN,RDXLST1           ESTABLISH BASE FOR EXT   Y02072 02058902
         L     RDXLST1,DEBXXARG         GET ADDR OF READX LIST   Y02072 02060902
         DROP  RDXLST1                                           Y02072 02062902
         USING DEQAREA,RDEQ             ESTABLISH BASE FOR DEQ PARM LST 02072602
         STM   RWTG,RPARC,DEQREGSV      SAVE REGS IN DEQ WORKAREA       02073002
         LR    RWORKK,RDXLST1           SAVE PTR TO RDXLIST FOR  Y02072 02073102
*                                       NEXT ROUTINE (FREEQIOB)  Y02072 02073202
         MVC   DEQFLAG,LISTDEQ          MOVE DEQ LIST TO DEBAVT  Y02072 02073402
*                                                                       02073802
*        POSITION TO NEXT ENTRY IN READ EXCLUSIVE LIST                  02073902
*                                                                       02074002
FIXPTR   LA    RDXLST,0(RDXLST1)        CLEAR HI-ORDER BYTE      Y02072 02075502
         LTR   RDXLST,RDXLST            LOAD AND TST SEGMENT PTR Y02072 02077502
         USING RDXLIST,RDXLST           ESTABLISH BASE FOR RDXLIST      02077902
         BZ    IOBPOOL                  BRANCH IF NO SEGMENTS    Y02072 02078302
         L     RDXLST1,RDXNEXT          GET NEXT SEGMENT POINTER        02078402
         LA    RNUMENT,RDXMAXCT         NUMBER OF READX LIST SLOTS      02079302
         LA    RDXWORK,RDXENT           STEP POINTER TO FIRST SLOT      02083302
         USING RDXENTRY,RDXWORK         ESTABLISH BASE FOR RDXENTRY     02085302
DLOOP    EQU   *                        DEQ EACH ENTRY IN READX LIST    02087302
         CLC   RDXNQARG,ZEROS           IS THIS SLOT EMPTY       Y02072 02087702
         BE    STPIDX                   BRANCH IF YES                   02087802
*                                                                       02101902
*        DEQ THE CURRENT ENTRY IN THE READ EXCLUSIVE LIST               02102402
*                                                                       02102802
DEQENTRY EQU   *                        DEQ CURRENT READX ENTRY  Y02072 02103202
*                                                                       02115102
         DEQ   (SYSNM,(RDXWORK)),MF=(E,(RDEQ)) DEQ READX ENTRY   Y02072 02115502
*                                                                       02115702
         XC    RDXNQARG,RDXNQARG        CLEAR OUT THIS SLOT      Y02072 02115802
*                                                                       02115902
STPIDX   EQU   *                        POSITION TO NEXT ENTRY   Y02072 02119602
         LA    RDXWORK,RDXENTLN(RDXWORK) UP POINTER TO NEXT SLOT Y02072 02119702
         BCT   RNUMENT,DLOOP            BRANCH IF MORE SLOTS            02119802
         B     FIXPTR                   BR BACK TO PROCESS NEXT SEGMENT 02129602
*                                                                       02130002
         DROP  RDXLST,RDEQ,RDXWORK                                      02132002
         SPACE 2                                                        02132402
*********************************************************************** 02133702
*  THE FOLLOWING ROUTINE FREES IOBS ON THE AVAILABLE POOL.   STARTING * 02134102
*  WITH THE IOB POINTED TO BY DCBIOBAD, THE IOB CHAIN IS SEARCHED FOR * 02134802
*  ALL IOBS FLAGGED AS AVAILABLE. EACH IOB IS CHAINED TO THE NEXT     * 02136802
*  THROUGH THE IOBDPLAD FIELD. IT IS ENTERED IN DATA MANAGEMENT KEY.  * 02137402
*  EXIT FROM THIS ROUTINE IS IN USER KEY.                             * 02139802
*********************************************************************** 02140202
IOBPOOL  EQU   *                        FREE IOBS IN IOB POOL    Y02072 02140302
         OI    DXATEXC2+1,FCACDEQ       SET AUDIT TRAIL INDICA-  Y02072 02140402
*                                       TING ALL ENTRIES ON      Y02072 02151702
*                                       READX LIST ARE DEQUEUED  Y02072 02161702
         L     RIOB2,DCBIOBAD           LOAD IOB POOL POINTER FROM DCB  02168902
*                                                                       02180202
         MODESET  KEYADDR=DXUKEY,WORKREG=11  CHANGE TO USER KEY  Y02072 02191502
*                                                                       02202802
ZEROCHK  LA    RIOB,0(RIOB2)            CLEAR HI-ORDER BYTE - MAKE NEXT 02214102
*                                       IOB THE CURRENT IOB             02225402
         USING IOBSTDRD,RIOB            ESTABLISH BASE FOR IOB DSECT    02236702
         LTR   RIOB,RIOB                IS IOB POOL POINTER ZERO        02248002
         BZ    FREEQIOB                 YES, GO CHECK READX LIST Y02072 02259302
         L     RIOB2,IOBDPLAD           LOAD ADDRESS OF NEXT IOB        02270602
         CLI   IOBDAYLI,AVAIL           IS CURRENT IOB AVAILABLE        02281902
         BE    CHKNEXT                  NO, GO CHECK NEXT IOB           02293202
         BAL   RETURN,FREEIOB           YES, GO FREE CURRENT IOB        02304502
         DROP  RIOB                                                     02315802
CHKNEXT  EQU   *                        GO TO CHECK NEXT IOB     Y02072 02327102
         B     ZEROCHK                  GO TO CHECK NEXT IOB            02338402
         SPACE 2                                                        02349702
*********************************************************************** 02361002
*  IOBS WAITING ON THE UNPOSTED QUEUES ASSOCIATED WITH EACH ENTRY IN  * 02372302
*  THE READ EXCLUSIVE LIST ARE FREED. WHEN ALL IOBS HAVE BEEN FREED   * 02383602
*  FOR THAT SEGMENT, THAT SEGMENT IS FREED AND THE NEXT, IF THERE IS  * 02394902
*  ONE, IS PROCESSED. THE READX LIST PTR IS AT DEBXXARG IN THE DEB    * 02406202
*  EXTENSION. THE NEXT SEGMENT POINTER IS IN FIELD RDXNEXT IN THE     * 02417502
*  READX LIST. THIS ROUTINE IS ENTERED IN USER KEY. IOBS ARE FREED    * 02428802
*  AND EXIT FROM THIS ROUTINE IS IN USER KEY.                         * 02440102
*********************************************************************** 02451402
FREEQIOB EQU   *                        FREE IOBS ON UNPOSTED Q  Y02072 02462702
*                                                                       02472702
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 02473102
*                                                                       02473502
         OI    DXATEXC2+1,FCACIOBP      SET AUDIT TRAIL INDICA-  Y02072 02473902
*                                       TING ALL AVAILABLE IOBS  Y02072 02477702
*                                       IN IOB POOL ARE FREED    Y02072 02479702
*                                                                       02480102
         MODESET  KEYADDR=DXUKEY,WORKREG=9  RETURN TO USER KEY   Y02072 02480502
*                                                                       02480902
         TM    DCBOPTCD,DCBOPTRE        IS EXCL CONTROL OPTION   Y02072 02481502
         BZ    BUFCHK                   NO, GO CHECK BUFFERS     Y02072 02485302
         LR    RDXLST1,RWORKK           RDXLST PTR SAVED BY DEQ  Y02072 02496602
*                                                                       02507902
*        POSITION TO NEXT ENTRY IN READ EXCLUSIVE LIST                  02519202
*                                                                       02530502
LISTPTR  LA    RDXLST,0(RDXLST1)        CLEAR HI-ORDER BYTE             02541802
         LTR   RDXLST,RDXLST            LOAD AND TEST SEGMENT POINTER   02553102
         USING RDXLIST,RDXLST           ESTABLISH BASE FOR RDXLIST      02564402
         BZ    RESTREGS                 BRANCH IF NO SEGMENTS    Y02072 02575702
         L     RDXLST1,RDXNEXT          GET NEXT SEGMENT POINTER        02587002
         LA    RNUMENT,RDXMAXCT         NUMBER OF READX LIST SLOTS      02598302
         LA    RDXWORK,RDXENT           STEP POINTER TO FIRST SLOT      02609602
         USING RDXENTRY,RDXWORK         ESTABLISH BASE FOR RDXENTRY     02620902
*                                                                       02632202
*  THE FOLLOWING ROUTINE FREES IOBS ON THE UNPOSTED QUEUE. THESE IOBS * 02643502
*  ARE WAITING FOR EXCLUSIVE CONTROL OF THE CURRENT ENTRY IN THE      * 02654802
*  READ EXCLUSIVE LIST.                                               * 02666102
*                                                                       02677402
*                                                                       02688702
UNPCHK   L     RIOB2,RDXIOBUQ           GET 1ST IOB WAITING      Y02072 02700002
*                                       FOR THIS ENTRY IN LIST   Y02072 02711302
TZERO4   LA    RIOB,0(RIOB2)            MAKE NEXT IOB CURRENT IOB       02722602
         LTR   RIOB,RIOB                ANY IOBS ON QUEUE               02733902
         BZ    GOTONEXT                 NO, GO TO NEXT ENTRY     Y02072 02745202
         USING IOBSTDRD,RIOB            ESTABLISH IOB BASE       Y02072 02756502
         L     RIOB2,IOBDQPTR           LOAD NEXT IOB ADDRESS           02767802
         DROP  RIOB                                              Y02072 02779102
         MODESET  EXTKEY=DATAMGT        CHG TO DATA MGT KEY    @ZA21099 02790437
         ST    RNUMENT,RDXRSV01         SAVE REGISTER          @ZA21099 02791437
         MODESET  KEYADDR=DXUKEY,WORKREG=11  BACK TO USER KEY  @ZA21099 02792437
         BAL   RETURN,FREEIOB           GO TO FREE THIS IOB             02793437
         L     RNUMENT,RDXRSV01         RESTORE REGISTER       @ZA21099 02794437
         B     TZERO4                   GO TEST FOR END OF QUEUE        02801702
*                                                                       02813002
*     WHEN 9 SLOTS HAVE BEEN INVESTIGATED, FREE THIS SEGMENT            02824302
*                                                                       02835602
GOTONEXT EQU   *                        POSITION TO NEXT ENTRY   Y02072 02846902
         LA    RDXWORK,RDXENTLN(RDXWORK) UP POINTER TO NEXT SLOT Y02072 02858202
         BCT   RNUMENT,UNPCHK           BRANCH IF MORE SLOTS     Y02072 02869502
*                                                                       02880802
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 02892102
*                                                                       02903402
         LA    RPARM0,SP230             PICK UP SUBPOOL NUMBER   Y02072 02914702
         SLL   RPARM0,24                MV SP NUMBER TO TOP BYTE        02926002
         LA    RWORKF,RDXLSTLG          PICK UP LIST SIZE               02937302
         OR    RPARM0,RWORKF            MERGE SIZE WITH SUBPOOL         02948602
         FREEMAIN R,LV=(0),A=(RDXLST)   FREE THE READ EXCLUSIVE LIST    02959902
*                                                                       02971202
         MODESET  KEYADDR=DXUKEY,WORKREG=11   CHANGE TO USER KEY Y02072 02982502
*                                                                       02993802
         B     LISTPTR                  BR BACK TO PROCESS NEXT SEGMENT 03005102
*                                                                       03016402
RESTREGS EQU   *                        RESTORE REGISTERS IN AVT Y02072 03027702
         L     RDEB,DCBDEBAD            GET ADDRESS OF DEB       Y02072 03039002
         USING DEBBASIC,RDEB            ESTABLISH BASE FOR DEB   Y02072 03050302
         L     RDEQ,DEBAPPAD            GET ADDR OF AVT          Y02072 03061602
         DROP  RDEB                                              Y02072 03072902
         USING DEQAREA,RDEQ             ESTAB BASE,DEQ WORKAREA  Y02072 03084202
         LM    RWTG,RPARC,DEQREGSV      RESTORE REGISTERS         M0045 03095502
         DROP  RDEQ                                                     03106802
         DROP  RDXLST                                                   03118102
         DROP  RDXWORK                                                  03129402
         SPACE 2                                                        03140702
*********************************************************************** 03152002
*  THE FOLLOWING ROUTINES FREE IOBS ON THE BUFFER QUEUE AND BUFFERS.  * 03180002
*  THE LOCATION OF THE IOBS WAITING FOR A BUFFER IS DETERMINED BY     * 03190002
*  WHETHER ADDRSPACE IS VIRTUAL OR REAL.  A TEST OF THE TCB IS MADE.  * 03192002
*  ENTRY AND EXIT IS IN USER KEY.                                     * 03192402
*********************************************************************** 03194002
BUFCHK   EQU   *                        CHK FOR DYNAMIC BUFFER   Y02072 03204002
*                                                                       03214002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 03216002
*                                                                       03218002
         OI    DXATEXC2+1,FCACIOBX      SET AUDIT TRAIL INDICA-  Y02072 03218402
*                                       TING ALL IOBS ON UNPOST  Y02072 03218802
*                                       QUEUE ARE FREED AND THE  Y02072 03219202
*                                       READX LIST IS FREED,IF   Y02072 03219602
*                                       EXCLUSIVE CONTROL        Y02072 03219702
*                                                                       03219802
         MODESET  KEYADDR=DXUKEY,WORKREG=11  RETURN TO USER KEY  Y02072 03219902
*                                                                       03226602
         TM    DCBOPTCD,DCBOPTDB        WAS THE DYNAMIC BUFFER OPTION   03233302
*                                       SPECIFIED                       03240002
         BZ    VRETST                   NO GO TEST FOR VAR SPANNED      03260002
         L     RDEB,DCBDEBAD            GET DEB ADDRESS          Y02072 03284402
         USING DEBBASIC,RDEB            ESTABLISH BASE FOR DEB          03287802
         L     RTCB,DEBTCBAD            GET TCB ADDRESS                 03288702
         USING TCB,RTCB                 ESTABLISH BASE FOR TCB          03289602
         TM    TCBFLGS6,TCBRV           DETERMINE TYPE OF ADDRSPCE      03290502
         BO    BCBQ                     BRANCH IF REAL, NO USL          03291402
         DROP  RTCB                                                     03292302
         DROP  RDEB                                                     03292402
*********************************************************************** 03292702
*  FOR TASKS IN VIRTUAL ADDRESS SPACES, THE ADDRESSES OF IOBS WAITING * 03293102
*  FOR BUFFERS ARE PLACED ON THE UNSCHEDULED LIST (USL).  THESE IOBS  * 03294302
*  AND THE USL COPIES (CHAINED TOGETHER), INCLUDING THE BUFFER CONTROL* 03296302
*  BLOCK ADJACENT TO THE FIRST USL, WILL ALL BE FREED.                * 03296402
*********************************************************************** 03296502
         L     RUSL,DCBDYNB             GET ADDR OF CURRENT USL         03302402
         USING USL,RUSL                 ESTABLISH BASE FOR USL          03303602
         SR    RUSLSLOT,RUSLSLOT        CLEAR REGISTER                  03304802
         ICM   RUSLSLOT,ADDR,USLIOB1    GET TOP SLOT ON QUEUE.          03306002
         BZ    FREEUSL                  BRANCH IF NO IOBS ON QUEUE      03307202
         USING USLSLOT,RUSLSLOT         ESTABLISH BASE FOR USLSLOT      03308402
GETIOB   L     RIOB,USLIOBA             GET IOB ADDRESS                 03310802
         LA    RIOB,0(RIOB)             CLEAR HI-ORDER BYTE             03312002
         BAL   RETURN,FREEIOB           FREE IOB'S CORE                 03316802
         C     RUSLSLOT,USLBFRQB        WAS THAT THE LAST IOB ON LIST?  03319202
         BE    FREEUSL                  BRANCH IF YES TO FREE THIS USL  03320402
         TM    USLSLTFL,USLENDL         IS THIS THE BOTTOM OF THE LIST  03321602
         BZ    BUMPLIST                 BRANCH IF NO TO GO TO NEXT IOB  03322802
         LA    RUSLSLOT,USLSLOT1-L'USLSLOT1   GO BACK TO TOP OF LIST    03324002
BUMPLIST LA    RUSLSLOT,USLNXT          BUMP TO NEXT SLOT ON LIST       03325202
         B     GETIOB                                                   03326402
         DROP  RUSLSLOT                                                 03327602
*                                                                     * 03330002
*  FREE ALL BUT THE ORIGINAL COPY OF THE USL. THAT ONE IS CONTIGUOUS  * 03331202
*  WITH THE BUFFER CONTROL BLOCK AND WILL BE FREED WITH IT.           * 03333202
*                                                                     * 03333602
FREEUSL  EQU   *                        FREE THE USL                    03334002
         L     RWORKC,USLCHAIN          SAVE ADDR TO PRIOR USL          03334402
         LR    RPARM1,RUSL              LOAD USL ADDR IN R1 TO   YM1103 03335102
*                                       FREEMAIN                 YM1103 03335502
         LTR   RWORKC,RWORKC            IS THIS THE ORIGINAL COPY       03336902
         BNZ   NEXTUSL                  NO, BRANCH TO FREE THIS LIST    03337602
         L     RPARM0,USLSZFST+BCBTBFRS(RPARM1) GET LGTH OF    @ZA12264 03338337
*                                       USL+BCB+BFR FOR F'MAIN @ZA12264 03339037
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 03339702
*                                                                       03340402
         OI    DXATEXC2+1,FCACIOBU      SET AUDIT TRAIL INDICA-  Y02072 03341102
*                                       TING ALL IOBS ON USL ARE Y02072 03341802
*                                       FREED, INCLUDING USL     Y02072 03342502
*                                                                       03343202
         MODESET  KEYADDR=DXUKEY,WORKREG=14  RETURN TO USER KEY  Y02072 03343902
*                                                                       03344602
         B     FREEBCB                  BRANCH TO FREE BUFFER CTL BLOCK 03345302
NEXTUSL  EQU   *                        FREE THE USL                    03346002
         LH    RPARM0,USLSIZE           LOAD SIZE OF THIS USL COPY      03346702
         BAL   RETURN,FREEAREA          FREE THE USL CORE               03347702
         LR    RUSL,RWORKC              MAKE NEXT USL (SAVED ACROSS     03349402
*                                       FREEMAIN) THE CURRENT USL       03351102
         B     FREEUSL                  GO CHECK NEXT USL               03352802
         DROP  RUSL                                                     03354502
*********************************************************************** 03356202
*  FOR TASKS IN REAL ADDRESS SPACES, THE ADDRESSES OF IOBS WAITING FOR* 03357902
*  BUFFERS ARE CHAINED FROM THE BCBFRQT FIELD IN THE BUFFER CONTROL   * 03359602
*  BLOCK.  THIS ROUTINES FREES EACH IOB ON THIS QUEUE.                * 03361302
*********************************************************************** 03363002
BCBQ     L     RBUF,DCBBUFCB            LOAD BUFFER CONTROL BLOCK ADDR  03364702
         USING BCBDEFR,RBUF             ESTABLISH BASE FOR BCB          03366402
         L     RIOB2,BCBFRQT            LOAD ADDR OF 1ST IOB WAITING    03368102
*                                       FOR A BUFFER                    03369802
         DROP  RBUF                                                     03371502
TZERO5   LA    RIOB,0(RIOB2)            CLEAR HI-ORDER BYTE, MAKE NEXT  03373202
*                                       IOB CURRENT IOB                 03374902
         USING IOBSTDRD,RIOB            ESTABLISH BASE FOR IOB          03376602
         LTR   RIOB,RIOB                ANY IOBS ON QUEUE               03378302
         BZ    BUFREL                   NO, GO FREE BUFFERS             03380002
         L     RIOB2,IOBDQPTR           SAVE NEXT IOB ADDRESS           03400002
         BAL   RETURN,FREEIOB           YES, GO FREE THIS IOB           03440002
         DROP  RIOB                                                     03442002
         B     TZERO5                   AND GO TEST FOR END OF QUEUE    03450002
*********************************************************************** 03460002
*  THE FOLLOWING ROUTINE FREES THE BUFFER CONTROL BLOCK AND CONTIG-   * 03470002
*  UOUS BUFFERS FOR REAL AND VIRTUAL ADDRESS SPACE.                   * 03472002
*********************************************************************** 03474002
BUFREL   L     RBUF,DCBBUFCB            LOAD ADDR OF BUFFER AREA        03480002
         USING BCBDEFR,RBUF             ESTABLISH BASE FOR BCB          03480402
         L     RPARM0,BCBTBRS           GET SIZE OF BUFFER AREA + BCB   03482002
         DROP  RBUF                                                     03485102
FREEBCB  EQU   *                        FREE BCB AND BUFFER AREA        03486002
         BAL   RETURN,FREEAREA          GO TO FREE BUFFER AREA          03488702
*                                                                       03526002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 03536002
*                                                                       03546002
         OI    DXATEXC2+1,FCACIOBB      SET AUDIT TRAIL INDICA-  Y02072 03556002
*                                       TING ALL IOBS ON BUFFER  Y02072 03558002
*                                       QUEUE ARE FREED, INCLU-  Y02072 03560002
*                                       DING BUFFERS AND BCB     Y02072 03562002
*                                                                       03564002
         MODESET  KEYADDR=DXUKEY,WORKREG=14  RETURN TO USER KEY  Y02072 03564402
*                                                                       03564802
         B     CLEANUP                  BRANCH TO CLEANUP DCB    Y02072 03565402
         SPACE 2                                                        03602702
*********************************************************************** 03640002
*  THE FOLLOWING ROUTINE FREES THE SEGMENT WORK AREA IF VARIABLE      * 03677302
*  SPANNED RECORDS WERE USED. THE SWA POOL IS POINTED TO BY THE       * 03714602
*  DCBDYNB FIELD IN THE DCB.                                          * 03751902
*********************************************************************** 03789202
VRETST   TM    DCBBFTEK,DCBBFTKR        TEST FOR VRE (BUFTEK=R)  S19015 03826502
         BZ    CLEANUP                  NO, BRANCH               Y02072 03863802
         TM    DCBMACF2,DCBMRSWA        DID USER SUPPLY SWA      YM3242 03901102
         BO    CLEANUP                  YES, DO NOT FREE IT      Y02072 03938402
         L     RBUF,DCBDYNB             ADDRESS OF SWA POOL CNTRL BLK   03975702
         USING BCBDEFS,RBUF             ESTABLISH BASE FOR SWA          04013002
         LH    RWORKA,BCBBFNUM          NUMBER OF BUFFERS        S19015 04050302
         LH    RWORKO,BCBBFLG           BUFFER LENGTH            S19015 04087602
         DROP  RBUF                                                     04124902
         MR    RWORKE,RWORKA            CALCULATE SWA POOL LG    S19015 04162202
         LA    RPARM0,BCBLNTHS(RWORKO)  ADD BCB LENGTH,MV TO R0  Y02072 04199502
         BAL   RETURN,FREEAREA          GO FREE SWA POOL FROM SP0       04348702
*                                                                       04358702
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 04368702
*                                                                       04378702
         OI    DXATEXC2,FCACSWA         SET AUDIT TRAIL INDICA- ZA09624 04380737
*                                       TING ALL SEGMENT WORK-   Y02072 04382702
*                                       AREAS ARE FREED.         Y02072 04384702
         SPACE 2                                                        04386002
*********************************************************************** 04390002
*  THE FOLLOWING ROUTINE RESTORES & INVALIDATES DCB FIELDS SET BY BDAM* 04392002
*  OPEN.IT IS ENTERED IN USER KEY AND PROCESSES IN DATA MANAGEMENT KEY* 04394002
*********************************************************************** 04396002
CLEANUP  EQU   *                        CLEAN UP DCB FIELDS             04400002
*                                                                       04410002
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY   Y02072 04412002
*                                                                       04414002
         TM    DCBOPTCD,DCBOPTDB        WAS DYN BUFFERING SPECIFIED     04420002
         BZ    NODYNBUF                 NO,GO INVALIDATE DCB ADDRESSES  04440002
         MVI   DCBBUFCB+3,INVALID       YES MAKE BUFFER CONTROL         04450002
*                                       BLOCK POINTER INVALID           04480002
NODYNBUF EQU   *                        CLEAR REST OF FIELDS            04490002
         NI    DCBOPTCD,X'FF'-DCBOPTTO-DCBOPTDB-DCBOPTRE  CLEAR         04500002
*                                       OVERFLO,DYN BUFFERING,AND       04510002
*                                       READ EXCLUSIVE BITS IN THE      04520002
*                                       OPTION FIELD OF THE DCB WHICH   04540002
*                                       MAY HAVE BEEN SET BY BDAM OPEN  04560002
         MVI   DCBCHECK+3,INVALID       INVALIDATE THE CHECK RTN ADDR   04580002
         MVI   DCBDRDX,X'00'            CLEAR NUMBER OF EXTENTS         04610002
         LA    RWORKC,NMSUBVRE          CTR=3 ADDRESSES TO INVALIDATE   04620002
         TM    DCBBFTEK,DCBBFTKR        TEST FOR VS              S19015 04623002
         BZ    INVALIDT                 NO,BRANCH                S19015 04626019
         TM    DCBMACR2,DCBMRSWA        DID USER SUPPLY SWA      S19015 04629002
         BZ    INVALIDT                 NO,BRANCH                S19015 04632019
         LA    RWORKC,NMSUB             INVALIDATE 2 ADDRESSES   S19015 04635002
         DROP  RDCB                                                     04637002
INVALIDT EQU   *                        INVALIDATE SUBRTN ADDRESSES     04640002
         MVI   DCBDFOR-IHADCB+3(RDCB),INVALID  INVALIDATE SUBRTN Y02072 04660002
         LA    RDCB,4(0,RDCB)           INDEX TO NEXT SUBRTN ADDRESS    04680002
         BCT   RWORKC,INVALIDT          TEST IF ALL INVALIDATED,NO GO   04700002
*                                       BACK. YES GO ON.                04720002
         SPACE 4                                                        04730002
*********************************************************************** 04770002
*  ROUTINE TO SCAN DCB LIST FOR OTHER DCBS REQUIRING THIS EXECUTOR.   * 04820002
*  IF NONE ARE FOUND, CONTROL IS TRANSFERRED TO THE NEXT EXECUTOR OF  * 04840002
*  FIRST DCB WHICH IS NOT COMPLETED. THIS ROUTINE IS ENTERED AND      * 04860002
*  PROCESSES IN DATA MANAGEMENT KEY.                                  * 04862002
*********************************************************************** 04870002
JCONOVER EQU   *                        RELOOP CODE                     04890002
         USING WTG,RWTG                 REESTABLISH BASE FOR WTG TABLE  04890402
         MVI   WTGENTRY,X'00'           CLEAR FIRST BYTE IN CURRENT     04892402
*                                       ENTRY OF WHERE-TO-GO TABLE      04894002
*                                                                       04904002
*                                                                       04904402
*   ISSUE IECRES MACRO WHICH CALLS THE O/C/E RESIDENT ROUTINE TO        04904802
*   COPY THE PROTECTED DCB FROM THE CLOSE WORKAREA INTO THE USER'S      04905202
*   DCB CORE.                                                           04905602
*                                                                       04905702
         IECRES  INIT,DCBCOPY=FRWKAR,STM=(R0,R15,WTGPREFX)       YM1190 04905802
*                                                                       04905902
*                                                                       04907902
*                                                                       04910102
* THE FOLLOWING TESTS THE FORCE CLOSE BIT TO DETERMINE IF ENTRY INTO    04914002
* THIS MODULE WAS MADE BY THE FORCE CLOSE EXECUTOR FOR TASK RECOVERY.   04916002
* IF SO, CONTROL IS RETURNED TO FORCE CLOSE WITH A RETURN CODE OF 0     04918002
* PUT IN REG 15 TO INDICATE THAT THIS CLOSE EXECUTOR EXECUTED SUCCESS-  04918402
* FULLY. (IF THIS EXECUTOR ABENDED DURING PROCESSING, A SECOND LEVEL    04920102
* ESTAE WOULD INTERCEPT THE ABEND PROCESSING, SET THE RETURN CODE TO 8, 04922102
* AND RETURN TO THE FORCE CLOSE RECOVERY ROUTINE, ASSOCIATED WITH       04924102
* COMMON CLOSE.)                                                        04926102
*                                                                       04928102
FORCLOS  EQU   *                        ENTRY FROM FORCE CLOSE   Y02072 04930102
         TM    DXATEXC2,FCACFORC        IS THIS FORCE CLOSE?     Y02072 04932102
         BNO   SCAN4EQ                  NO, CONTINUE AS USUAL    Y02072 04934102
         L     RETURN,24(RPAR)          YES,GET FRC CLS RET ADDR Z09656 04936137
         SR    R15,R15                  SET RC=0, SUCCESSFUL     Y02072 04938102
         BR    RETURN                   RETURN TO FORCE CLOSE    Y02072 04940102
*                                                                       04942102
*                                                                       04944102
SCAN4EQ  LA    RWTGC,L'WTGENTRY(RWTGC)  INCREMENT WHERE-TO-GO INDEX     04949402
         LA    RPARC,L'PARDCBAD(RPARC)  INCREMENT DCB PARAMETER INDEX   04954702
         CLC   WTGIDNX,AMIDCNST         IS THIS EXECUTOR NAMED AGAIN    04960002
         BER   RBASE                    YES-RETURN TO START OF ROUTINE  04980002
         CLC   WTGIDNX,CLLDB            IS THIS THE END OF THE TABLE    05020002
         BL    SCAN4EQ                  NO, GO GET NEXT ENTRY           05040002
         CLC   WTGIDNX,CLLDG            IS THIS THE END OF THE TABLE    05060002
         BH    SCAN4EQ                  NO, BRANCH TO GET NEXT ENTRY    05080002
         LR    RPARC,RPAR               RESTORE  BOTH INDEX REGISTERS   05100002
         DROP  RWTGC                                                    05110002
         LA    RWTGC,WTGENTRY           THEIR INITIAL VALUES            05120002
         USING WTGENTRY,RWTGC                                           05132002
SCAN4ANY CLI   WTGIDTTR,0               IS THIS DCB COMPLETED?          05140002
         BNE   XCTLRTN                  IF NOT, GO TO NAMED EXECUTOR.   05160002
         LA    RWTGC,L'WTGENTRY(RWTGC)  INCREMENT BOTH INDEX REGISTERS  05180002
         LA    RPARC,L'PARDCBAD(RPARC)  TO THE NEXT ENTRIES.            05200002
         B     SCAN4ANY                 LOOP TO CHECK COMPLETION        05220002
*                                                                     * 05230002
*   THE FOLLOWING XCTLS TO THE NEXT EXECUTOR FOUND IN THE WTG TABLE   * 05240002
*                                                                     * 05250002
XCTLRTN  EQU   *                        XCTL TO THE NEXT MODULE         05260002
         MVC   WTGMODID,WTGENTRY        MOVE EXECUTOR ID                05280002
         LA    R15,DXCCW12              SET UP FOR XCTL                 05310002
         XCTL  EPLOC=(RWTG),SF=(E,(15)) GO TO NEXT MOD           Y02072 05340002
         DROP  RWTG                                                     05350002
         SPACE 5                                                        05360002
*********************************************************************** 05362002
*  THE FOLLOWING SUBROUTINE DETERMINES THE SIZE OF EACH IOB PASSED TO * 05364002
*  IT (IN REGISTER RIOB) TO BE FREED, AND FREES IT FROM SUBPOOL 0.    * 05366002
*  THIS SUBROUTINE IS ENTERED, PROCESSES, AND EXITS IN USER KEY.      * 05366402
*********************************************************************** 05368002
         USING IOBSTDRD,RIOB            ESTABLISH BASE FOR IOB          05368402
         USING IHADCB,RDCB              ESTABLISH BASE FOR DCB          05368802
FREEIOB  SR    RPARM0,RPARM0            CLEAR REG                A40558 05370002
         AH    RPARM0,IOBDIOBS          ADD IOB LENGTH INTO REG  A40558 05380002
         BNPR  RETURN                   DON'T FREEMAIN IF 0 OR   A40558 05390002
*                                       MINUS                    A40558 05400021
         LR    RPARM1,RIOB              LOAD ADDRESS OF THIS IOB        05460002
         LA    RPARM1,0(RPARM1)         CLEAR HIGH ORDER BYTE IN        05480002
*                                       ADDRESS REGISTER                05500002
         DROP  RIOB                                                     05504037
*********************************************************************** 05504637
*  IF THE USER IS IN SUPERVISOR STATE, SUBPOOL 000 WILL BE     @ZA11614 05505437
*  SPECIFIED FOR THE FREEMAIN. IF THE USER IS IN PROBLEM       @ZA11614 05506237
*  STATE, SUBPOOL 250 WILL BE SPECIFIED TO FORCE SP 000.       @ZA11614 05507037
*********************************************************************** 05507837
         L     RDEB,DCBDEBAD            GET DEB ADDR FROM DCB  @ZA11614 05508837
         USING DEBBASIC,RDEB            ESTABLISH BASE FOR DEB @ZA11614 05509437
         L     RTCB,DEBTCBAD            GET TCB ADDR FROM DEB  @ZA11614 05510037
         USING TCB,RTCB                 ESTABLISH BASE FOR TCB @ZA11614 05510637
         DROP  RDEB                                            @ZA11614 05511237
         LA    RTCB,0(RTCB)             CLEAR HI BYTE          @ZA11614 05511637
         L     RWORKB,CVTPTR(,0)        CVT ADDRESS            @ZA28352 05512037
         L     RWORKB,0(,RWORKB)        TCBWORDS ADDRESS       @ZA28352 05512237
         L     RWORKB,4(RWORKB)         CURRENT TCB ADDRESS    @ZA28352 05512437
         LA    RWORKB,0(RWORKB)         CLEAR HI BYTE          @ZA11614 05512637
         CR    RTCB,RWORKB              IS THIS THE TCB FOR    @ZA28352 05512837
*                                       TASK WHICH OPENED DCB? @ZA28352 05513037
         L     RWORKD,0(RWORKB)         CURRENT RB ADDRESS     @ZA28352 05513237
         BE    TESTATE                  YES-GO CHECK STATE     @ZA28352 05513437
**************************************************************          05514037
*  CLOSE WAS NOT ISSUED UNDER THE SAME TCB AS OPEN.          * @ZA28352 05514137
*  GO TO PROBLEM DETERMINATION MODULE TO ABEND 014-04.       * @ZA28352 05514237
**************************************************************          05514337
         MODESET  EXTKEY=DATAMGT        CHANGE TO DATA MGT KEY @ZA28352 05514437
         L     RCVT,CVTPTR(,0)          LOAD ADDR OF CVT       @ZA28352 05514537
         L     RES,CVTDMSR-CVT(,RCVT)    LOAD ADDR OF IFG019RA @ZA28352 05514737
         DMABCOND 1,PDLOAD,RETURN=NONE                         @ZA28352 05514837
TESTATE  TM    17(RWORKD),X'01'         IS RBOPSW PROB STATE?  @ZA28352 05515337
         BNO   OKZERO                   BRANCH IF SUPVR STATE  @ZA11614 05515537
         DROP  RTCB                                            @ZA11614 05515737
         TM    DXUKEY,X'F0'             IF USER KEY IS ZERO    @ZA11614 05516237
         BZ    SET250                   USE SP 250             @ZA11614 05516737
         MODESET  EXTKEY=ZERO           CHANGE TO ZERO KEY     @ZA11614 05517237
SET250   ICM   RPARM0,8,DC250           SUBPOOL IN HI BYTE     @ZA11614 05517737
OKZERO   TM    DCBBFTEK,DCBBFTKR        TEST FOR BFTEK=R       @ZA11614 05518437
         BZ    FREEAREA                 NO, BRANCH               S19015 05519437
         AH    RPARM0,PREFXIOB          ADD 8 TO SIZE OF IOB     S19015 05520437
         SH    RPARM1,PREFXIOB          SUBTRACT 8 FROM IOB ADDR S19015 05521437
FREEAREA FREEMAIN  R,LV=(0),A=(1)       FREE THE IOB OR BUFFER FROM SP0 05523037
         MODESET  KEYADDR=DXUKEY,WORKREG=11                    @ZA11614 05524037
         BR    RETURN                   RETURN TO MAIN ROUTINE          05560002
*********************************************************************** 05610002
          EJECT                                                         06190002
*********************************************************************** 06200002
*                             CONSTANTS                               * 06210002
*********************************************************************** 06212002
AMIDCNST DC    C'3A'                    BDAM IDENTIFIER                 06220002
PREFXIOB DC    H'8'                     SIZE OF IOB PREFIX       S19015 06230019
CLLDB    DC    C'0B'                    CLOSE LOAD B                    06240002
CLLDG    DC    C'0G'                    CLOSE LOAD G                    06260002
         DS    0F                                                       06280000
SYSNM    DC    C'SYSZ'                  MAJOR QUEUE NAME         Y02072 06300002
         DC    C'GGLG'                                                  06320000
ZEROS    DC    X'0000000000000000'      CLEAR COMPARE CONSTANT          06340000
         DS    0F                                              @ZA11614 06340437
PDLOAD   DC    C'6M',VL3(IGG0206M)      PROB DETER MODULE      @ZA28352 06340537
DC250    DC    X'FA000000'              SUBPOOL 250 CONSTANT   @ZA11614 06340837
LISTDEQ  DEQ   (,,L'RDXNQARG,SYSTEM),RET=HAVE,MF=L   DEQ LIST    Y02072 06340937
         ORG   LISTDEQ+4                ONLY NEED 1ST 4 BYTES    Y02072 06341037
MODID    DC    C'IGG0203A'              MODULE ID                Y02072 06341237
FIX      DC    C'OZ28352 '              FIX NUMBER             @ZA11614 06341437
DATE     DC    CL8'&SYSDATE'            DATE OF LATEST FIX      ZA09656 06341637
PATCH    DC    XL((*-START)/20)'0'      5% PATCH AREA            Y02072 06342002
*********************************************************************** 06350002
*                             EQUATES                                 * 06352002
*********************************************************************** 06354002
AVAIL    EQU   X'FF'                    AVAILABILITY FLAG IN IOB        06600000
INVALID  EQU   X'01'                    MOVE THIS INTO ADDR FIELD TO    06664002
*                                       INVALIDATE AN ADDR IN THE DCB   06714002
SP230    EQU   230                      SUBPOOL OF READX LIST    Y02072 06764102
ADDR     EQU   B'0111'                  MASK FOR INSERTING 24-BIT ADDR  06764202
NMSUBVRE EQU   3                        NUMBER OF ADDRESSES      Y02072 07320002
*                                       INVALIDATED IN DCB IF VS Y02072 07340002
NMSUB    EQU   2                        NUMBER OF ADDR IF NOT VS Y02072 07350002
BCBTBFRS EQU   12                       OFFSET TO BCBTBRS1     @ZA12264 07351037
RESXCTL  EQU   4                        OFFSET FOR XCTL        @ZA28352 07351537
*********************************************************************** 07352002
         EJECT                                                          07480000
*********************************************************************** 07482002
*                          DSECTS                                     * 07484002
*********************************************************************** 07486002
         IGGPARML                                                Y02072 07489902
         IGGBCB                                                  Y02072 07492002
         EJECT                                                          07492402
         IGGSWA                                                  Y02072 07494002
         IGGRDX                                                  Y02072 07496002
         IGGUSL                                                  Y02072 07506002
         EJECT                                                          07520002
         DCBD  DSORG=(DA)                                               07540000
         EJECT                                                          07560000
         IEZIOB                                                         07570002
         EJECT                                                          07572002
         IEZDEB                                                         08540021
*********************************************************************** 08540402
*  THE FOLLOWING DSECT FORMATS THE DEQ PARAMETER LIST, WHICH IS BUILT * 08540802
*  IN THE FIRST 12 BYTES OF THE AVT.                                  * 08541202
*********************************************************************** 08541602
DEB      DSECT                                                          08543202
         ORG   DEBAVT                                                   08546802
DEQAREA  DS    0CL28               WORKAREA-DEQ PARMLST AND REG SAVE    08547202
DEQPARM  DS    0CL12               PARAMETER LIST FOR DEQ               08548402
DEQFLAG  DS    XL4                 FLAGS INDICATING DEQ OPTIONS  Y02072 08550002
DEQMAJOR DS    A                   ADDRESS OF MAJOR QNAME               08569902
DEQMINOR DS    A                   ADDR OF MINOR QNAME                  08571902
DEQREGSV DS    2F                  REGS 6 AND 7 ARE SAVED HERE          08573902
         EJECT                                                          08582002
         IECDSECS  (MAIN,(IOB,NO)),RRPL,PREFX,WTG,EXPAND=YES     YM1190 08584002
WTGTABLE DSECT                                                   YM1190 08584402
         ORG   WTG+8                                             Y02072 08586002
WRKRETRN DS    A                   ADDR OF FORCE CLOSE EXEC      Y02072 08588002
         ORG   WTGIDTTR                                                 08590002
WTGIDNX  DS    CL2                 ID OF THE NEXT MODULE                08592002
WTGTTRNX DS    CL3                 TTR OF THE NEXT MODULE               08592402
         ORG   WTGIDTTR+4                                               08592802
WTGDCBWA DS    A                   ADDR OF WORKAREA FOR THE DCB         08593202
FORCORE  DSECT                     WORKAREA DSECT CONTINUED      Y02072 08594002
         IHAFCAUD  ORG=YES                                       Y02072 08596002
         EJECT                                                          08640002
         IECDPPL                                                 Y02072 08690002
         EJECT                                                          08740002
         IKJTCB                                                         09140901
         EJECT                                                          09150902
         CVT   DSECT=YES                                         YM1190 09152902
         END                                                            09160000
