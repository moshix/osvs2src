 TITLE 'IGG0203M - BTAM LINE GROUP CLOSE EXECUTOR'                      00350002
IGG0203M CSECT                                                          00400002
*                                                              @YA02128 00410002
*        FOLLOWING CHANGES APPLIED:                            @YA02128 00420002
*                                                              @YA02128 00440002
*                                                                       00450002
*                                                                       00500002
* D061000-061500,C062000-062500                              LD YA02147 00550002
* A085600-085988,A259000,A276200                             LD YA02169 00600002
* A076020                                                     LD YM7707 00610000
* D096100-096200                                            LD @ZA00520 00620000
* C036500                                                   L5 @ZA02840 00630003
* A036600-036800                                            L5 @ZA02840 00640003
*                                                                       00650002
*        YA03971  (1/3/74)                                              00660002
*        ZA00545  (11/15/74)                                            00670003
*        ZA00546  (11/15/74)                                            00680003
*        ZA00547  (11/15/74)                                            00690003
*        ZA02840  (02/25/75)                                            00692003
*        ZA03207  (03/24/75)          ZA03557  (03/10/75)               00694003
*        ZA03561  (03/10/75)          ZA03973  (04/29/75)               00695003
*        ZA04076  (04/17/75)          ZA04082  (04/17/75)               00696003
*        AZ07660  (12/05/75)          AZ08049  (01/26/76)             * 00697000
*        AZ09347  (04/08/76)          AZ10045  (06/07/76)             * 00698000
*        AZ14146  (11/01/76)          AZ17707  (02/15/77)               00699000
*                                                                       00700002
*********************************************************************** 00750002
*                                                                     * 00800002
* STATUS -          CHANGE LEVEL 003    8/16/74                       * 00850000
*                                                                     * 00900002
* FUNCTION -       THE CLOSE EXECUTOR LOGICALLY DETACHES A COMMUNI-   * 00950002
*                  CATION LINE GROUP FROM THE SYSTEM. THE ROUTINE     * 01000002
*                  PERFORMS THE FOLLOWING FUNCTIONS -                 * 01050002
*                                                                     * 01100002
*                    1. HALTS ANY OUTSTANDING ENABLE COMMANDS.        * 01150002
*                                                                     * 01200002
*                    2. STOPS ACTIVITY ON THE LINES.                  * 01250002
*                                                                     * 01300002
*                    3. DISABLES THE LINES.                           * 01350002
*                                                                     * 01400002
*                    4. FREES THE STORAGE OBTAINED BY OPEN FOR        * 01450002
*                                                                     * 01500002
*                       INPUT/OUTPUT BLOCKS.                          * 01550002
*                                                                     * 01600002
*                    5. REINITIALIZES DCB FIELDS.                     * 01650002
*                    6. FREES THE STORAGE OCCUPIED BY THE BUFFER      * 01700002
*                       POOL IF A BUFFER POOL WAS OBTAINED BY THE     * 01750002
*                       OPEN EXECUTOR.                                * 01800002
*                                                                     * 01850002
* ENTRY POINT -    ENTRY IS TO THE FIRST EXECUTABLE INSTRUCTION.      * 01900002
*                                                                     * 01950002
* INPUT -          REGISTER 5 - START OF PARAMETER LIST               * 02000002
*                                                                     * 02050002
*                  REGISTER 6 - START OF WHERE-TO-GO TABLE            * 02100002
*                                                                     * 02150002
*                  REGISTER 7 - CURRENT ENTRY IN PARAMETER LIST       * 02200002
*                                                                     * 02250002
*                  REGISTER 8 - CURRENT ENTRY IN WHERE-TO-GO TABLE    * 02300002
*                                                                     * 02350002
* OUTPUT -         NONE                                               * 02400002
*                                                                     * 02450002
* EXIT -           CONTROL IS GIVEN TO THE SYSTEM CLOSE ROUTINE.      * 02500002
*                                                                     * 02550002
* ATTRIBUTES -     THIS ROUTINE IS EXECUTED IN THE TRANSIENT AREA     * 02600002
*                  AS ENABLED AND REENTRANT.                          * 02650002
*                                                                     * 02700002
*********************************************************************** 02750002
         EJECT                                                          02800002
         USING IECTIOB,RCORE                                            02850002
         USING IHADCB,RDCB                                              02900002
         USING IECTDEB,RDEB                                             02950002
         BALR  RBASE,0                                                  03000002
         USING *,RBASE                                                  03050002
         B     BEGIN                                                    03100002
         DC    C'IGG0203M'                                              03150003
         DC    C'** MVS *'                                              03180003
         DC    C'&SYSDATE'         ASSEMBLY DATE            LD @ZA00545 03210003
         DC    C'UZ06852'          PTF NUMBER                           03215000
         DC    S(*)                                                     03220003
PATCH    DC    20F'0'                                                   03230003
         DS    0H                                                       03250000
BEGIN    EQU   *                                                        03270000
*                                      INITIALIZATION OF REGISTERS FOR  03300002
*                                      DEB,DCB AND IOB                  03350002
         L     RDCB,0(RPARC,0)         ACCESS POINTER TO DCB            03400002
         L     RDEB,DCBDEBAD           ACCESS POINTER TO DEB            03450002
         L     RJ,4(RWTGC)    LOAD ADDRESS OF DCB WORK AREA.   @ZA09347 03460000
         USING WORKAREA,RJ                                     @ZA09347 03470000
         ST    RDEB,DXCCW          SAVE DEB ADDR FOR PURGE     @ZA09347 03480000
         L     RDEB,28(RDEB)           POINT TO APPENDAGE TABLE OF DEB  03500002
*                                 OR TRUE START OF DEB FOR DSECT.       03550002
         L     RCORE,DCBIOBAD           GET IOB ADDRESS MINUS SIZE.     03600002
         MVC   DEBSIOA+1(THREE),DEBEOEA+1     SET           L5 @ZA02840 03650003
         MVC   DEBPCIA+1(THREE),DEBEOEA+1       APPENDAGE   L5 @ZA02840 03660003
         MVC   DEBCEA+1(THREE),DEBEOEA+1          ADDRESS   L5 @ZA02840 03670003
         MVC   DEBXCEA+1(THREE),DEBEOEA+1          TO IOS   L5 @ZA02840 03680003
         NI    DEBSIOA,NOPGFIX          TURN OFF PAGE FIX      @ZA02840 03690003
*                        APPENDAGE FLAG REQUIRED FLAG          @ZA02840 03692003
         TM    DCBDEVTP,X'FF'           TEST FOR STRAM             000C 03700002
         BC    14,NOSTRAM               IF NOT, BRANCH             000C 03750002
         MVC   0(5,RWTGC),STRAMID       MOVE IN STRAM ID           000C 03800002
         B     STRAMOUT                                            000C 03850002
NOSTRAM  SR    RB,RB          CLEAR REGISTER                            03900000
         IC    RB,DCBEIOBX    GET IOB  SIZE                             03950000
         SR    RC,RC                                                    04000002
         IC    RC,DEBNMEXT              GET NUMBER OF EXTENTS.          04050002
         L     RTIOT,DEBTCBAD-1                                         04100002
         TM    TCBFLG(RTIOT),ABCLOSE   WAS CLOSE INITIATED BY ABEND?    04150002
         BO    DISABLER            IF SO, GO DIRECTLY TO DISABLE        04200002
*    ROUTINE, AS ABEND WILL HAVE PURGED ALL OUTSTANDING I/O REQUESTS.   04250002
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 04300002
         SPACE 2                                                        04350002
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 04400002
         SPACE 1                                                        04450002
         AR    RCORE,RB                 INITIALIZE IOB REGISTER  A25673 04550002
*         TWO LINES OF CODE DELETED BY APAR ------------->     @ZA09347 04600000
         MODESET KEYADDR=DXUKEY,WORKREG=1   ASSUME USER KEY      Y02947 04700002
         OI    IOBFLAG2,RESETPL     TERMINATE POLLING            Y02947 04750002
         MODESET EXTKEY=DATAMGT    GET TO KEY 5                         04800002
         L     RB,DXCCW       SAVE ORGINAL DEB ADDRESS         @ZA09347 04820000
         LA    RF,DXCCW         LOAD ADDRESS OF AREA TO BE USED  Y02947 04850002
*                                  AS PARAMETER LIST FOR PURGE.         04900002
         LA    RTIOT,DEBNMSUB           LOAD ADDRESS OF DEB ORIGIN.     05050002
         ST    RTIOT,DXCCW   STORE DED ADDRESS IN PARM LIST    @ZA09347 05100000
         MVI   0(RF),PURGEOPT  MOVE PARAMETER LIST OPTION BYTE @ZA09347 05110000
*                             TO PARAMETER LIST AREA.                   05120000
*         ONE LINE OF CODE DELETED BY APAR -------------->     @ZA09347 05150000
         L     RTIOT,DEBTCBAD-1                                         05200002
         LA    RTIOT,0(RTIOT)           CLEAR HIGH ORDER BYTE OF TCB    05250002
*    ADDRESS SO THAT IT WILL NOT LOOK LIKE A COMPLETION CODE.           05300002
         ST    RTIOT,4(RF)              STORE TCB ADDRESS IN PARAMETER  05350002
*                                  LIST.                                05400002
         LA    RTIOT,DEBSYSPG-1         STORE ADDRESS OF DEB SYSTEM     05450002
         ST    RTIOT,8(RF)         PURGE FIELD IN PARAMETER LIST.       05500002
         LA    RTIOT,4(RF)              LOAD ADDRESS OF TCB FIELD IN    05550002
*                                  PARAMETER LIST TO BE USED AS ECB.    05600002
         LA    RC,DXCCW+12        LOAD ADDRESS OF CCW AREA PLUS  Y02947 05650002
*    12 IN DCB WORK AREA FOR USE AS A REGISTER SAVE AREA.               05700002
         MODESET KEYADDR=DXUKEY,WORKREG=10  ASSUME USER KEY             05750002
         SVC   16                       ISSUE PURGE SVC.                05800002
         MODESET EXTKEY=DATAMGT    GET TO KEY 5                @ZA09347 05800100
         L     RJ,4(RWTGC)   LOAD ADDRESS OF DCB WORK AREA     @ZA09347 05800200
         LA    RJ,0(RJ)      CLEAR HIGH ORDER BYTE             @ZA09347 05800300
         ST    RB,DXCCW      RESTORE ORIGINAL DEB ADDRESS      @ZA09347 05800400
         MODESET KEYADDR=DXUKEY,WORKREG=10  ASSUME USER KEY    @ZA09347 05800500
         SR    RC,RC                                                    05850002
         IC    RC,DEBNMEXT              RE-INITIALIZE NUMBER OF         05900002
*                                  EXTENTS REGISTER.                    05950002
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 06000002
*    THE FOLLOWING SECTION OF CODE ISSUES DISABLE COMMANDS TO ALL       06050002
*    COMMUNICATION LINES IN THE LINE GROUP.                             06100002
         SPACE 1                                                        06150002
DISABLER EQU   *                                                        06200002
         L     RUCB,DEBUCBAD       GET FIRST UCB ADDRESS                06250002
         CLI   UCBCLASS(RUCB),GRPHCDVC  IS DEVICE 3270                  06300002
         BNE   ENDANR              NO, SKIP ANR CLEAN-UP AND   @ZA03207 06350003
*                        SEE IF ANY PAGES ARE TO BE FREED      @ZA03207 06360003
*                                                                       06400002
         L     RF,ATNIRBAD(RUCB)   GET ADDRESS OF IRB                   06550002
         LA    RF,ZERO(RF)         CLEAR HI ORDER BYTE       LD YA03240 06600000
         L     RB,RDYQ(RUCB)       GET ADDR OF READYQ IRB    LD YA03240 06605000
         LA    RB,ZERO(RB)         CLEAR HI ORDER BYTE       LD YA03240 06610000
         SR    RC,RC               CLEAR REG                 LD YA03240 06615000
         SR    RD,RD               CLEAR REG                 LD YA03240 06620000
         IC    RD,DEBNMEXT         GET NUM. OF DEVICES       LD YA03240 06625000
         MODESET EXTKEY=ZERO       RESUME KEY ZERO           LD YA03240 06630000
CLIRBPT  IC    RDCB,UCBGCB(RUCB)   SAVE GCB                  LD YA03240 06635000
         XC    UCBATTN(ANRATNXT,RUCB),UCBATTN(RUCB)          LD YA03240 06640000
*                                  CLEAR READYQ IRB PTR      LD YA03240 06645000
         STC   RDCB,UCBGCB(RUCB)   RESTORE GCB               LD YA03240 06650000
         LA    RC,FOUR(RC)         BUMP TO NEXT UCB          LD YA03240 06655000
         L     RUCB,DEBUCBAD(RC)   POINT TO NEXT UCB         LD YA03240 06660000
         BCT   RD,CLIRBPT          LOOP TO CLEAR IRB PTR     LD YA03240 06665000
         LR    RUCB,RB             RDY Q IRB ADDRESS        L5 @ZA04076 06665403
         LTR   RF,RF               IS ATN IRB ADDR ZERO?       @ZA03557 06667003
         BZ    TSTRDYQ             YES, GO TEST READYQ         @ZA03557 06669003
         BAL   RDCB,IRBFREE        GO FREE THE IRB          L5 @ZA04076 06679003
TSTRDYQ  LTR   RF,RUCB             IS RDY Q IRB ADDR ZERO?  L5 @ZA04076 06700003
         BZ    NORDYQP             YES,COMTINUE             L5 @ZA04076 06710003
         BAL   RDCB,IRBFREE        GO FREE THE IRB          L5 @ZA04076 06712003
         B     NORDYQP             CONTINUE                 L5 @ZA04076 06714003
IRBFREE  EQU   *                                            L5 @ZA04076 06714403
         SR    RB,RB               CLEAR REG                 LD YA03240 06715000
         IC    RB,NINE(RF)         GET READYQ IRB SIZE       LD YA03240 06720000
         SLL   RB,THREE            CHANGE TO BYTES           LD YA03240 06725000
         LA    RE,ZERO(RB)         PUT IN PARM               LD YA03240 06730000
         O     RE,IRBPOOL          OR IN SUBPOOL NUMBER      LD YA03240 06735000
         LA    RD,TWO              NUMBER OF IQES           L5 @ZA04076 06747003
         L     RC,NXTAVAL(RF)      ADDR AVAIL. READYQ IQE    LD YA03240 06755000
IQELOOP  LA    RC,ZERO(RC)         CLEAR HI ORDER BYTE       LD YA03240 06760000
         LTR   RC,RC               IQE ADDR AVAILABLE        LD YA03240 06770000
         BZ    CVTFREE             NO,BRANCH                 LD YA03240 06775000
         L     RC,ZERO(RC)         GET NEXT IQE PRT          LD YA03240 06780000
         BCT   RD,IQELOOP                                    LD YA03240 06785000
         SH    RF,HEADER           ALLOW FOR 20 BYTE PREFIX L5 @ZA04082 06790003
         FREEMAIN R,LV=(0),A=(1)   FREE IRB                  LD YA03240 06795000
         BR    RDCB                RETURN TO NSI             LD YA03240 06800000
CVTFREE  EQU   *                                             LD YA03240 06805000
         SR    RC,RC               CLEAR REG                 LD YA03240 06810000
         L     RC,CVTPTR           GET CVT ADDRESS           LD YA03240 06815000
         USING CVT,RC              CVT ADDRESSABILITY        LD YA03240 06820000
         LA    RC,CVTEXIT          GET ADDR OF SVC 3         LD YA03240 06825000
         DROP  RC                                            LD YA03240 06830000
         ST    RC,RBEP(RF)         PLACE SVC INTO EP         LD YA03240 06835000
         XC    RBOPSW+ONE(THREE,RF),RBOPSW+ONE(RF)           LD YA03240 06840000
         OC    RBOPSW+ONE(THREE,RF),RBEP+ONE(RF)             LD YA03240 06845000
         OI    RBSTAB(RF),TWO      RB CAN BE FREED           LD YA03240 06850000
         BR    RDCB                RETURN TO NSI             LD YA03240 06855000
NORDYQP  EQU   *                                             LD YA03240 06860000
         L     RDCB,ZERO(RPARC)    GET DCB ADDRESS           LD YA03240 06865000
         SR    RC,RC              CLEAR THE INDEX REG          @YA02128 06890802
         IC    RC,DEBNMEXT        RESTORE NUMBER EXTENTS       @YA02128 06892802
         L     RUCB,DEBUCBAD      RESTORE FIRST UCB POINTER    @YA02128 06893202
         SR    RF,RF               INITIALIZE INDEX                     06950002
*         TWO LINES OF CODE DELETED BY APAR ----------->       @ZA09347 07450000
         MODESET EXTKEY=DATAMGT    ASSUME DATAMGT KEY         LD YM5674 07460002
         B     ENDANR1             BRANCH AROUND SYSEVENT MAC LD YM5674 07470002
ENDANR   EQU   *                   END OF 3270 CODE                     07500002
         MODESET EXTKEY=DATAMGT         ASSUME DATA MGT KEY   LD Y02947 07510000
         DROP  RCORE                                           @AZ17707 07520000
         L     TCBREG,DEBTCBAD-1       SET TCB ADDRESSABILITY  @AZ17707 07530000
         USING TCB,TCBREG              TCB ADDRESSABILITY      @AZ17707 07540000
         TM    TCBFLGS6,TCBRV          VIRTUAL=REAL JOB?       @AZ17707 07550000
         BO    ENDANR1                 YES, DON'T ISSUE OKSWAP @AZ17707 07560000
         DROP  TCBREG                                          @AZ17707 07570000
         SR    RE,RE               CLEAR REG                  LD YM7707 07602000
         SYSEVENT OKSWAP           MAKE MEMORY....            LD YM5674 07610002
*                                      SWAPPABLE AGAIN.       LD YM5674 07620002
ENDANR1  EQU   *                                              LD YM5674 07630002
         USING IECTIOB,RCORE        RESET IOB ADDRESSABILITY   @ZA17707 07633000
         SR    RB,RB               GET NUMBER OF DEVICES       @ZA09347 07636000
         IC    RB,DCBEIOBX       GET  IOBSIZE                  @ZA09347 07642000
         L     RDCB,0(RPARC)            RE-INITIALIZE DCB REGISTER.     07650002
         L     RCORE,DCBIOBAD           GET IOB ADDRESS MINUS SIZE.     07700002
         OI    DCBIFLGS,X'0C'           INDICATE NO ERP IN CLOSE        07750002
         L     RJ,FOUR(RWTGC)       WORKAREA ADDRESSABILITY   LD YM5674 07770002
         MODESET KEYADDR=DXUKEY,WORKREG=14   ASSUME USER KEY     Y02947 07800002
         LR    RTIOT,RC                 LOAD NUMBER OF EXTENTS TO COUNT 07850002
*                                  REGISTER.                            07900002
         L     RDCB,DXUDCBAD       POINT TO USER DCB                    07950002
         OI    DCBIFLGS,X'0C'      INDICATE NO ERP TO CLOSE             08000002
         LA    RDCB,IOBERCCW(RB)        LOAD ECB ADDRESS.     LD YM5655 08050002
EXCPLOOP AR    RCORE,RB                 INITIALIZE IOB REGISTER TO      08100002
*                                  POINT AT NEXT IOB.                   08150002
         SR    RD,RD                                                    08200002
         IC    RD,IOBUCBX                                               08250002
         SLL   RD,2                                                     08300002
         TM    IOBINCAM,X'80'          SAD/ENABLE FAILURE        A30762 08350002
         BO    SADOFF                  YES, AVOID DISABLE        A30762 08400002
         L     RUCB,DEBUCBAD(RD)        LOAD UCB ADDRESS.               08450002
         CLI   UCBCLASS(RUCB),GRPHCDVC  IS DEVICE 3270                  08500002
         BE    CLEARDVC                 YES, CLEAR DEVICE    LD YA03971 08550000
         CLI   UCBTYP+3(RUCB),IBM32701  TEST FOR IBM TYPE III ADAPTER   08600002
         BE    LOOPTEST            ON A 2701 CONTROL UNIT.              08650002
         TM    UCBFL1(RUCB),XE8    DEV NOT READY OR BUSY    LD @ZA00546 08660003
         BM    LOOPTEST            EITHER, BYPASS EXCP      LD @ZA00546 08670003
         ST    RDCB,IOBECBPT            STORE ECB ADDRESS IN IOB.       08700002
         XC    IOBERCCW(4),IOBERCCW     CLEAR ECB              @ZA03207 08710003
         MVC   IOBCPA(8),DISABLE                                        08750002
         MVC   IOBCPA+8(8),IONOP                                   000E 08800002
         LA    RF,IOBCPA                SET UP START OF CHANNEL         08850002
         ST    RF,IOBSTART         PROGRAM ADDRESS.                     08900002
         L     RF,DEBTCBAD-ONE      GET TCB ADDRESS          LD YA03237 08960002
         TM    TCBFLG(RF),ABCLOSE    ABEND ISSUED CLOSE?     LD YA03237 09000002
         LR    RF,RCORE                                                 09010002
         BZ    ISSUEXCP                 NO, ISSUE EXCP       LD YA02169 09050002
REPSTEST LA    RE,LOOPCNT               LOAD LOOP COUNT        @ZA03973 09100003
REPTTEST EQU   *                                             LD YA02169 09150002
         BCT   RE,TESTUCB                                    LD YA02169 09200002
         B     SADOFF         TURN OFF SAD/ENAB EHWN CNT=0   LD YA02169 09250002
TESTUCB  EQU   *                                             LD YA02169 09300002
         TM    UCBFL1(RUCB),XE8         IS LINE HUNG?        LD YA02169 09350002
         BC    FIVE,REPTTEST                                 LD YA02169 09400002
ISSUEXCP EQU   *                                             LD YA02169 09450002
         EXCP  (1)                                                      09500002
         LR    RF,RDCB                  LOAD ECB ADDRESS FOR WAIT.      09550002
         MVI   IOBINCAM+1,X'00'    SET TIMER COUNT TO ZERO     @ZA14146 09553000
STIMER   STIMER WAIT,BINTVL=TIME        WAIT 1/2 SECOND     LD @ZA14146 09556000
         TM    0(2),X'7F'               IS ECB POSTED       LD @ZA14146 09562000
         BNZ   SADOFF                   BRANCH IF YES          @ZA14146 09563000
         CLI   IOBINCAM+1,X'0D'         IS COUNT MAX 7         @ZA14146 09564000
         BNL   GOPURGE                  YES, GO PURGE          @ZA14146 09565000
         IC    RF,IOBINCAM+1            STORE NEW STIMER COUNT @ZA14146 09566000
         LA    RF,1(RF)                 UPDATE COUNT BY ONE    @ZA14146 09567000
         STC   RF,IOBINCAM+1            STORE NEW TIMER COUNT  @ZA14146 09568000
         B     STIMER                   REISSUE TIMER 1/2 SEC. @ZA14146 09569000
GOPURGE  EQU   *                                               @ZA10045 09572000
         STC   RTIOT,IOBCPA+SIXTEEN YES, SAVE COUNT REG     LD @ZA00546 09580003
         BAL   RD,PURGE2           BAL TO PURGE SUBRTN      LD @ZA00546 09590003
         SR    RTIOT,RTIOT         CLEAR REG                LD @ZA00546 09592003
         IC    RTIOT,IOBCPA+SIXTEEN RESTORE COUNT REG       LD @ZA00546 09594003
*                       THREE LINES DELETED BY---------------->@ZA14146 09600000
*                                                                     * 09610000
*        2 LINES OF CODE REMOVED FOR OZ00520                          * 09620000
*                                                                     * 09630000
SADOFF   NI    IOBINCAM,X'7F'          TURN OFF SAD/ENABLE       A30762 09650002
LOOPTEST EQU   *                                                        09700002
         BCT   RTIOT,EXCPLOOP                                           09750002
         B     FREEIOBS                 GO TO FREE IOB'S     LD YA03971 09770000
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 09850002
         SPACE 1                                                        09860002
PURGE2   EQU   *                                            LD @ZA00546 09870003
         MODESET EXTKEY=DATAMGT    DATA MANAGEMENT KEY      LD @ZA00546 09880003
         L     RJ,FOUR(RWTGC)      WORKAREA ADDRESSABILITY  LD @ZA00546 09890003
         XC    DXCCW+L4(L8),DXCCW+L4    CLEAR PARM LIST        @ZA09347 09892000
*         ONE LINE OF CODE DELETED BY APAR ------------->      @ZA09347 09894000
         MVI   DXCCW,PURGOPTN      PURGE OPTION             LD @ZA00546 09896003
         PURGE DXCCW               ISSUE PURGE/HALT I/O     LD @ZA00546 09898003
         L     RJ,FOUR(RWTGC)      WORKAREA ADDRESSABILITY  LD @ZA00546 09898403
         MODESET KEYADDR=DXUKEY,WORKREG=15                  LD @ZA00546 09898803
         BR    RD                  RETURN TO CALLER         LD @ZA00546 09899203
         SPACE 1                                                        09900002
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 09902000
*        THIS SECTION WILL CLEAR THE 3270'S SCREEN                      09904000
         SPACE 1                                                        09906000
CLEARDVC EQU   *                                             LD YA03971 09908000
         ST    RDCB,IOBECBPT            STORE ECB ADDR...    LD YA03971 09910000
*                                       IN IOB               LD YA03971 09912000
         XC    IOBERCCW(4),IOBERCCW     CLEAR ECB              @ZA03207 09912403
         MVC   IOBCPA+FOUR(FIVE),CLEARCCW  MOVE ER/WR CCW    LD YA03971 09914000
*                                       AND WCC TO IOB       LD YA03971 09916000
         LA    RF,IOBCPA+EIGHT          ADDR OF DATA AREA               09918000
         ST    RF,IOBCPA                STORE IT IN CCW      LD YA03971 09920000
         MVI   IOBCPA,X05               OP CODE FOR CCW      LD YA03971 09922000
         LA    RF,IOBCPA                ADDR OF CCW          LD YA03971 09924000
         ST    RF,IOBSTART              FOR I/O              LD YA03971 09926000
         LR    RF,RCORE                 ADDR OF IOB          LD YA03971 09928000
         B     REPSTEST                 ISSUE EXCP             @ZA03973 09930003
         SPACE 1                                                        09932000
*                                                                       09934000
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 09936000
         SPACE 2                                                        09938000
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 09950002
*    THE FOLLOWING SECTION OF CODE FREES THE CORE USED FOR IOB'S.       10000002
         SPACE 1                                                        10050002
FREEIOBS EQU   *                                                        10100002
         L     RDCB,0(RPARC)            RE-INITIALIZE DCB REGISTER.     10150002
*                                                                       10200002
*             15 LINES DELETED BY THE FOLLOWING APAR           @ZA03207 10210003
*                                                                       10260003
CONTINUE EQU   *                                              LD Y02947 10950002
         L     RUCB,DEBUCBAD          UCB ADDR                 @ZA03207 10960003
         CLI   UCBCLASS(RUCB),GRPHCDVC LOCAL 3270 DEVICE       @ZA03207 10970003
         BNE   FREETCCW               NO, CHECK ERP EXT        @ZA03207 10980003
RETURN   EQU   *                                               @ZA03207 10990003
         L     RF,DCBIOBAD              GET IOB ADDRESS MINUS SIZE.     11000002
         AR    RF,RB                    ADD SIZE TO GET TRUE IOB ADDR.  11050002
         L     RUCB,DEBUCBAD          UCB ADDR                 @ZA03207 11060003
         CLI   UCBCLASS(RUCB),GRPHCDVC LOCAL 3270 DEVICE       @ZA03207 11070003
         BE    NOEXT                  YES, NO ERP EXT          @ZA03207 11080003
         LA    RB,4(RB)               LENGTH OF ERP EXT ENTRY  @ZA03207 11090003
*                          FOR REMOTES ONLY                    @ZA03207 11092003
NOEXT    EQU   *                                               @ZA03207 11094003
         MR    RB,RB                    MULTIPLY TO GET TOTAL SIZE.     11100002
         CLI   UCBCLASS(RUCB),GRPHCDVC LOCAL 3270 DEVICE       @ZA03207 11102003
         BE    NOEXT1                 YES, NO ERP EXT          @ZA03207 11104003
         LA    RC,4(RC)                 ADD 4 MORE FOR THE 0TH @ZA03207 11110003
*                                       IN THE ERP EXT         @ZA03207 11120003
NOEXT1   EQU   *                                               @ZA03207 11130003
         LA    RE,0(RC)                 CLEAR HIGH ORDER BYTE.          11150002
         O     RE,IOBPOOL               PLACE SUBPOOL NUMBER IN HIGH    11200002
*                                  ORDER BYTE.                          11250002
         FREEMAIN R,LV=(0),A=(1)       FREEMAIN FOR IOB                 11300002
         L     RB,DEBIRBAD-1            GET ADRS OF PNTRS TO IRBS  000E 11350002
         LA    RB,0(RB)                 CLEAR HI-ORDER BYTE        000E 11400002
         LTR   RB,RB                    WAS ADDRESS ZERO           000E 11450002
         BZ    BUFPOOL                  IF SO, BRANCH              000E 11500002
         MODESET EXTKEY=DATAMGT         BACK TO DATA MGT KEY     Y02947 11550002
         XC    DEBIRBAD(3),DEBIRBAD     CLEAR ADDRESS FIELD        000E 11600002
         MODESET EXTKEY=ZERO                                  LD YM4059 11650002
         L     RC,0(RB)                 GET ADDRESS OF ONLT IRB    000E 11700002
         MODESET EXTKEY=DATAMGT                               LD YM4059 11750002
         LTR   RC,RC                    IS ADDRESS PRESENT         000E 11800002
         BZ    NOTONLT                  IF NOT, BRANCH             000E 11850002
         LA    RDCB,NOTONLT        RETURN ADDR FOR SUBRTN   LD @ZA00547 11860003
         SR    RE,RE               CLEAR REG                LD @ZA00547 11870003
         L     RJ,FOUR(RWTGC)      WORKAREA ADDRESSABILITY  LD @ZA00547 11872003
         MODESET KEYADDR=DXUKEY,WORKREG=15   USER'S KEY     LD @ZA00547 11880003
         IC    RE,DEBNMEXT         NO. DEVICES TIMES 2...   LD @ZA00547 11892003
         AR    RE,RE               ...IS TOTAL NO. IQES     LD @ZA00547 11894003
         MODESET EXTKEY=ZERO       KEY ZERO                 LD @ZA00547 11896003
         L     RJ,NXTAVAL(RC)      GET 1'ST FREE IQE        LD @ZA00547 11898003
         LR    RF,RC               PRIME REG FOR SUBRTN     LD @ZA00547 11898403
ONLTLOOP EQU   *                                            LD @ZA00547 11898803
         LA    RJ,ZERO(RJ)         CLEAR HI-ORDER BYTE      LD @ZA00547 11899203
         LTR   RJ,RJ               IQE ADDR AVAILABLE       LD @ZA00547 11899603
         BZ    CVTFREE             NO, LET EXIT FREE IRB.   LD @ZA00547 11899703
         L     RJ,ZERO(RJ)         GET NEXT IQE ADDRESS.    LD @ZA00547 11899803
         BCT   RE,ONLTLOOP         LOOP TO CHECK ALL IQES.  LD @ZA00547 11899903
         MODESET EXTKEY=DATAMGT    DATA MANAGEMENT KEY      LD @ZA00547 11916603
         LR    RC,RF               RESTORE IRB ADDRESS      LD @ZA00547 11926603
         BAL   RDCB,FREEIRB             GO FREE CORE               000E 11933302
NOTONLT  EQU   *                                              LD YM4059 11950002
         MODESET EXTKEY=ZERO                                  LD YM4059 12000002
         L     RC,4(RB)                 GET ADDRESS OF PTOP IRB    000E 12050002
         MODESET EXTKEY=DATAMGT                               LD YM4059 12100002
         LTR   RC,RC                    IS ADDRESS PRESENT         000E 12150002
         BZ    NOTPTOP                  IF NOT BRANCH              000E 12200002
         L     R2,0(RC)                 GET ADR OF SAVE     LD @ZA00545 12250003
         LA    R2,0(R2)                 CLEAR HIGH BYTE     LD @ZA00545 12300003
         LTR   R2,R2                    SAVE AREA EXIST?    LD @ZA00545 12350003
         BZ    NOPTOPSV                 NO, PROCESS IRB         YA01234 12400002
         LA    RJ,72                    SAVE AREA SIZE          YA01234 12450002
         O     RJ,IOBPOOL               USER SUBPOOL            YA01234 12500002
         LR    RF,R2                    ADDR FOR FREEMAIN   LD @ZA00545 12550003
         LR    RE,RJ                    SUBPOOL & SIZE          YA01234 12600002
         FREEMAIN R,LV=(0),A=(1)        FREE SAVE AREA          YA01234 12650002
NOPTOPSV EQU   *                        PROCESS THE IRB         YA01234 12700002
         BAL   RDCB,FREEIRB             GO FREE CORE               000E 12750002
NOTPTOP  EQU  *                                                  Y02947 12800002
         L     RJ,4(RWTGC)               ADDR OF OPEN WORK AREA  Y02947 12850002
         MODESET KEYADDR=DXUKEY,WORKREG=13   ASSUME USER KEY     Y02947 12900002
         LR    RF,RB                    ADDRESS OF PNTRS IN REG 1Y02947 12950002
         LA    RE,16                    LNGTH 16 BYTES             000E 13000002
         O     RE,IOBPOOL               OR IN SUBPOOL NUMBER       000E 13050002
         FREEMAIN  R,LV=(0),A=(1)       FREE IRB PNTRS                  13100002
         B     BUFPOOL                                             000E 13150002
FREEIRB  SR    RJ,RJ                    CLEAR REGISTER             000E 13200002
         IC    RJ,DEBNMEXT              GET NUMBER OF EXTENTS      000E 13250002
         SLL   RJ,2                     MULTIPLY BY 8              000E 13300002
         LA    RJ,1(RJ)                 ADD ONE                    000E 13350002
         SLL   RJ,3                     MULTIPLY BY EIGHT          000E 13400002
         LA    RJ,96(RJ)                ADD IRB SIZE               000E 13450002
         O     RJ,IRBPOOL               OR IN SUBPOOL NUMBER       000E 13500002
         LR    RE,RJ                    PUT COUNT IN REG 0         000E 13550002
         LR    RF,RC                    PUT ADDRESS IN REG 1       000E 13600002
         FREEMAIN R,LV=(0),A=(1)        FREE IRB                   000E 13650002
         BR    RDCB                                                000E 13700002
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 13750002
         SPACE 2                                                        13800002
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 13850002
*    THE FOLLOWING SECTION OF CODE FREES THE CORE USED FOR A BUFFER     13900002
*    POOL, IF THE BUFFER POOL WAS CREATED BY OPEN.                      13950002
         SPACE 1                                                        14000002
BUFPOOL  L     RJ,4(RWTGC)                                       Y02947 14050002
         L     RDCB,DXUDCBAD            POINT TO USER'S DCB      Y02947 14100002
         TM    DCBMACRF,X'04'           TEST WHETHER BUFFER POOL SHOULD 14150002
         BZ    DCBINIT             BE FREED.  IF NOT, BRANCH.           14200002
         MODESET EXTKEY=DATAMGT                                         14250002
         L     RDCB,ZERO(RPARC)    COPY DCB ADDRESS                     14300002
         NI    DCBMACRF,X'FB'           CLEAR BIT THAT INDICATES BUFFER 14350002
*                                  POOL SHOULD BE FREED BY CLOSE.       14400002
         L     RF,DCBBUFCB              LOAD BUFFER CONTROL BLOCK       14450002
*                                  ADDRESS.                             14500002
         LA    RF,0(RF)                ZERO OUT HI BYTE          A32442 14550002
         LH    RB,DCBBUFL                                               14600002
         SR    RC,RC                                                    14650002
         IC    RC,DCBBUFNO                                              14700002
         MR    RB,RB                                                    14750002
         LA    RE,8(RC)                 LOAD BUFFER POOL SIZE TO        14800002
*                                  PARAMETER LIST REGISTER.             14850002
         O     RE,IOBPOOL               PLACE SUBPOOL NUMBER IN HIGH    14900002
*    ORDER BYTE OF PARAMETER LIST REGISTER.                             14950002
*                                                                       15000002
         MODESET KEYADDR=DXUKEY,WORKREG=13   ASSUME USER KEY  LD Y02947 15050002
*                                                                       15100002
         FREEMAIN R,LV=(0),A=(1)                                        15150002
*                                                                       15200002
         MODESET EXTKEY=DATAMGT                               LD Y02947 15250002
*                                                                       15300002
         MVC   DCBBUFCB+1(3),CLEARMSK+1 RE-INITIALIZE BUFFER CONTROL    15350002
*                                  BLOCK ADDRESS FIELD IN DCB.          15400002
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 15450002
         SPACE 2                                                        15500002
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 15550002
*    THE FOLLOWING SECTION OF CODE RE-INITIALIZES DCB FIELDS.           15600002
*     IF LOCAL 3270 IOB SIZE CHANGES FROM X'58', THE           @ZA08049 15610003
*      FOLLOWING (CLI) MUST BE CHANGED.                        @ZA08049 15620003
         SPACE 1                                                        15650002
DCBINIT  EQU   *                                                        15700002
         CLI   DCBEIOBX,L3270      IF NOT L3270, THERE WAS NO  @ZA08049 15750003
         BNE   NOCLRLRB          READY Q, SO DON'T CLEAR LERB  @ZA08049 15770003
         TM    DCBLERB,IGG019UP  READYQ SPEC BTAM'S ROUTINE    @ZA08049 15790003
         BNO   NOCLRLRB        NO, DON'T CLEAR ADDRESS         @ZA08049 15810003
         NI    DCBLERB,ALLON-IGG019UP CLEAR READYQ FLAG        @ZA08049 15830003
         XC    DCBLERB+L1(L3),DCBLERB+L1 CLEAR ADDRESS         @ZA08049 15850003
*                                       READYQ  IS  RESET      @ZA08049 15870003
*              TWO LINES OF CODE DELETED BY APAR -------->     @ZA07660 15890003
NOCLRLRB MVC   DCBIOBAD(L4),CLEARMSK    REINIT IOB ADDRESS     @ZA08049 15980003
*                                         FIELD IN DCB         @ZA08049 16000003
         XC    DCBEIOBX(L1),DCBEIOBX  REINIT DCB'S IOB SIZE    @ZA08049 16020003
         XC    DCBREAD+L1(L3),DCBREAD+L1   REINIT R/W ADDRESS  @ZA08049 16040003
         XC    DCBIFLGS(L1),DCBIFLGS  REINIT IOS ERROR FLAGS   @ZA08049 16060003
         IC    RD,DCBMACRF                                       Y02947 16350002
         L     RJ,FOUR(RWTGC)      CLOSE WORK AREA                      16400002
         L     RDCB,DXUDCBAD       USER DCB ADDRESS                     16450002
         MODESET KEYADDR=DXUKEY,WORKREG=13   USER KEY                   16500002
         STC   RD,DCBMACRF          (NOT MAPPED BY SYS CLOSE)    Y02947 16550002
         L     RDCB,0(RPARC)           POINT TO COPY DCB                16600002
         MODESET EXTKEY=DATAMGT                               LD Y02947 16650002
         XC    0(2,RWTGC),0(RWTGC)     CLEAR ID TO INDICATE COMPLETION  16700002
*                                  OF EXECUTOR.                         16750002
STRAMOUT EQU   *                                                        16800002
         USING WTG,RWTG                                                 16850002
         LR    RF,RCORE                 SAVE IOB ADDRESS      LD Y02947 16900002
         L     RCORE,4(RWTGC)           WORK ADREA ADDRESS    LD Y02947 16950002
         L     RJ,WTGPREFX              WTG PREFIX ADDRESS    LD Y02947 17000002
         STM   RE,RD,IECREGSV-IECPREFX(RJ)  SAVE REGS         LD Y02947 17050002
         IECRES INIT,DCBCOPY=FRWKAR                           LD Y02947 17100002
         LR    RJ,RWTG                  REG SAVEAREA ADDR        YM5668 17150002
         LM    RE,RD,IECREGSV-IECPREFX(RJ)  RESTORE REGS      LD Y02947 17200002
         L     RJ,4(RWTGC)              ADDR OPEN WORK AREA   LD Y02947 17250002
         LR    RCORE,RF                 RESTORE IOBADDRESS    LD Y02947 17300002
RELOOP   LA    RWTGC,WGOFF(0,RWTGC)     INCREMENT CURRENT WTG REGISTER. 17350002
         LA    RPARC,PLOFF(0,RPARC)     INCREMENT CURRENT PARAMETER     17400002
*                                  LIST REGISTER TO NEXT ENTRY.         17450002
         CLC   0(2,RWTGC),AMIDCNST     IF THE NEXT WTG ENTRY CALLS FOR  17500002
         BCR   8,RBASE             BTAM CLOSE, REEXECUTE THIS EXECUTOR. 17550002
         CLC   0(2,RWTGC),CLOSEIDL                                      17600002
         BL    RELOOP                                                   17650002
         CLC   0(2,RWTGC),CLOSEIDH                                      17700002
         BH    RELOOP                                                   17750002
         LR    RPARC,RPAR               REINITIALIZE CURRENT WTG REG    17800002
         LA    RWTGC,WAOFF(0,RWTG) AND CURRENT PARAMETER LIST REG.      17850002
ZCHECK   CLI   0(RWTGC),X'00'     TEST FOR ZERO ENTRY                   17900002
         BNE   XCTLRTNE            IF NOT ZERO, GO TO TRANSFER CONTROL. 17950002
         LA    RWTGC,WGOFF(0,RWTGC) IF ZERO, GET NEXT ENTRY AND RETURN  18000002
         LA    RPARC,PLOFF(0,RPARC) TO ZCHECK.                          18050002
         B     ZCHECK                                                   18100002
*    *    *    *    *    *    *    *    *    *    *    *    *    *    * 18150002
XCTLRTNE EQU   *                                                        18200002
         LA    RJ,DXCCW12               POINT TO DOUBLE WORD LIST.      18250002
         MVC   6(2,RWTG),0(RWTGC)       MOVE ID TO NAME FIELD.          18300002
         MVC   14(3,RWTG),2(RWTGC)      MOVE TTR TO WTG TABLE.          18350002
         XCTL  DE=(RWTG),SF=(E,(15))                                    18400002
         EJECT                                                          18450002
*                                                                     * 18500002
*                                                                     * 18550002
*        THIS ROUTINE WILL UNFIX ALL PAGES THAT WERE FIXED (BUT       * 18610003
*        NOT FREED) BY THE ERROR RECOVERY PROCEDURES. (REMOTE ONLY)   * 18620003
*                                                                     * 18800002
*                                                                     * 18850002
*        SUBROUTINE REGISTER DEFINITION                               * 18900002
*                                                                     * 18950002
*                                                                     * 19000002
         SPACE 3                                                        19050002
GETMNIN  EQU   0                   INPUT FOR GETMAIN          LD Y02947 19100002
ECBREG   EQU   0                   ECB REGISTER FOR PGFREE    LD Y02947 19150002
*        1 LINE DELETED BY THE FOLLOWING APAR                  @ZA03207 19200003
GETMNOUT EQU   1                   OUTPUT FROM GETMAIN        LD Y02947 19250002
FREELIST EQU   1                   START ADDRES FOR PGFREE     @ZA03207 19300003
ENDADDR  EQU   2                   END ADDRESS FOR PGFREE     LD Y02947 19350002
TCBREG   EQU   4                   TCB REGISTER               LD Y02947 19400002
IOBADR   EQU   5                   ADDRESS OF IOB'S           LD Y02947 19450002
IOBSIZE  EQU   6                   SIZE OF IOB'S              LD Y02947 19500002
NUMIOBS  EQU   7                   NUMBER OF IOB'S             @ZA03207 19550003
WORKREG  EQU   8                   WORK REGISTER              LD Y02947 19600002
TCCW     EQU   9                   TCCW ADDR (ERP'S)           @ZA03207 19650003
SAVEREG  EQU   10                  SAVEAREA REGISTER          LD Y02947 19700002
CVTREG   EQU   11                  CVT ADDRESS                LD Y02947 19750002
RTNREG   EQU   14                  RETURN REGISTER            LD Y02947 19800002
LINKREG  EQU   15                  LINK REGISTER              LD Y02947 19850002
         SPACE 5                                                        19900002
FREETCCW EQU   *                                               @ZA03207 19950003
         MODESET EXTKEY=DATAMGT    DATA MANAGEMENT KEY 0F 5    @ZA03207 19960003
         L     GETMNIN,SAVEAREA    GETMAIN BYTES AND SUBPOOL  LD Y02947 20000002
         GETMAIN R,LV=(0)          GETMAIN FOR SAVEAREA       LD Y02947 20050002
         STM   GETMNIN,LINKREG,ZERO(GETMNOUT) SAVE REGS       LD Y02947 20100002
         LR    SAVEREG,GETMNOUT    SAVE ADDRES OF GETMAINT    LD Y02947 20150002
         L     IOBADR,DCBIOBAD     IOBADDR MINUS SIZE         LD Y02947 20200002
         SR    IOBSIZE,IOBSIZE     CLEAR REGISTER 6           LD Y02947 20250002
         IC    IOBSIZE,DCBEIOBX    SIZE OF IOB'S              LD Y02947 20300002
         LA    IOBADR,ZERO(IOBSIZE,IOBADR) ADDR OF 1ST IOB     @ZA03207 20350003
         SR    NUMIOBS,NUMIOBS        CLEAR REG                @ZA03207 20400003
         IC    NUMIOBS,DEBNMEXT       NUMBER OF IOB'S          @ZA03207 20450003
         L     LINKREG,4(WORKREG)     WORKAREA ADDR            @ZA03207 20500003
         MODESET KEYADDR=DXUKEY,WORKREG=14   GET USER KEY      @ZA03207 20550003
         LR    WORKREG,IOBADR         ADDR OF 1ST IOB          @ZA03207 21160003
NEXT     LA    WORKREG,ZERO(IOBSIZE,WORKREG) ADDR NEXT IOB     @ZA03207 21170003
         BCT   NUMIOBS,NEXT           WHEN WE FALL THRU,       @ZA03207 21180003
*                     WORKREG POINTS TO ERP EXT                @ZA03207 21190003
         L     TCBREG,0(WORKREG)        ADDR OF TRANSLATOR...  @ZA03207 21190103
*                  PUT THERE BY IGE0904B...                    @ZA03207 21190203
         LA    TCBREG,0(TCBREG)         CLEAR HIGH ORDER BYTE  @ZA03207 21190303
         LA    WORKREG,4(WORKREG)       POINT TO 1ST ENTRY IN  @ZA03207 21190903
*                        ERP EXT CORRESPONDING TO RLN 1        @ZA03207 21192903
         MODESET EXTKEY=DATAMGT       DATA MANAGEMENT KEY      @ZA03207 21193403
         IC    NUMIOBS,DEBNMEXT       NUMBER OF IOB'S          @ZA03207 21194003
         MODESET KEYADDR=DXUKEY,WORKREG=14   GET USER KEY      @ZA03207 21194603
AGAIN    L     RTNREG,0(WORKREG)      GET ENTRY CONTENTS       @ZA03207 21195203
         LA    RTNREG,0(RTNREG)       CLEAR HI ORDER BYTE      @ZA03207 21196003
         LTR   RTNREG,RTNREG          ENTRY = 0 MEANS NOTHING  @ZA03207 21196403
*                                     NEEDS TO BE UNFIXED      @ZA03207 21197003
         BNZ   UNFIX                  UNFIX NECESSARY PAGES    @ZA03207 21198003
CHECK    LA    WORKREG,4(WORKREG)     ADDR NEXT ERP EXT ENTRY  @ZA03207 21198403
         BCT   NUMIOBS,AGAIN          FINISHED WHEN FALL THRU  @ZA03207 21198803
         B     DONE                   ALL PAGES FREED          @ZA03207 21199403
UNFIX    EQU   *                                               @ZA03207 21200003
*                                                             LD Y02947 21250002
*                                                             LD Y02947 21300002
*        FOR BRANCH ENTRY TO THE TRANSLATOR (IECVTCCW)         @ZA03207 21350003
*        WE MUST BE IN KEY 0, WITH A LOCAL LOCK HELD.         LD Y02947 21400002
*          REG0 = ZERO                                         @ZA03207 21410003
*          REG1 = ADDR OF TCCW                                 @XA03207 21420003
*          REG14 = RETURN ADDR                                 @ZA03207 21442003
*          REG15 = TRANSLATOR (IECVTCCW) ENTRY ADDR            @ZA03207 21444003
*                                                             LD Y02947 21450002
*                                                             LD Y02947 21500002
         SPACE 3                                                        21550002
         MODESET EXTKEY=ZERO       GET KEY 0                  LD Y02947 21600002
         SPACE 3                                                        21650002
GETLOCK  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=(PGFREE,        *21700002
               IGG0203,(RELLOCK))                             LD Y02947 21750002
         SPACE 3                                                        21800002
         SR    ECBREG,ECBREG          ECB ADDR FOR IECVTCCW    @ZA03207 22050003
         L     TCCW,ZERO(WORKREG)     TCCW ADDR FROM ERP EXT   @ZA03207 22100003
         LR    LINKREG,TCBREG         ADDR OF IECVTCCW         @ZA03207 22150003
         MVI   4(TCCW),X'08'        UNFIX OPTION OF TRANSLATOR @ZA03207 22200003
         LR    FREELIST,TCCW            REG1 = TCCW ADDR       @ZA03207 22250003
         BALR  RTNREG,LINKREG      LINK TO PAGE SERVICES      LD Y02947 22400002
         SPACE 3                                                        22450002
RELLOCK  SETLOCK RELEASE,TYPE=LOCAL,RELATED=(PGFREE,IGG0203M,(GETLOCK)) 22500002
         SPACE 3                                                        22550002
NEXTBLK  LTR   FREELIST,FREELIST      END OF CHAIN             @ZA03207 22560003
         BZ    RESET                  YES, CLEAR ERP EXT ENTRY @ZA03207 22570003
         L     GETMNIN,TCCWPOOL    SUBPOOL AND LENGTH          @ZA03207 22572003
         L     TCCW,0(FREELIST)       SAVE LINK POINTER        @ZA03207 22580003
         FREEMAIN R,LV=(0),A=(1)     FREE TCCW                 @ZA03207 22590003
         LR    FREELIST,TCCW          RESET CHAIN BASE         @ZA03207 22592003
         B     NEXTBLK                                         @ZA03207 22594003
RESET    EQU   *                                               @ZA03207 22596003
         L     LINKREG,X20(SAVEREG)   RESTORE REGISTER 8      LD Y02947 22600003
         L     LINKREG,FOUR(LINKREG)  RESTORE WORKAREA ADDR   LD Y02947 22650003
*                                                             LD Y02947 22700002
*                                                             LD Y02947 22750002
*        RETURN TO USER KEY                                   LD Y02947 22800002
*                                                             LD Y02947 22850002
*                                                             LD Y02947 22900002
         SPACE 2                                                        22950002
         MODESET KEYADDR=DXUKEY,WORKREG=14                    LD Y02947 23000002
         SPACE 2                                                        23050002
*                                                             LD Y02947 23100002
         XC    ZERO(4,WORKREG),ZERO(WORKREG) CLEAR TCCW ADDR   @ZA03207 23150003
*                              AFTER FREEING                   @ZA03207 23200003
         B     CHECK                  SEE IF ANY MORE          @ZA03207 23250003
DONE     EQU   *                                               @ZA03207 23300003
         SPACE 2                                                        23650002
         MODESET EXTKEY=DATAMGT       DATA MANAGEMENT KEY      @ZA03207 23660003
         L     GETMNIN,SAVEAREA    SET PARAMETERS FOR FREE    LD Y02947 23700002
         LR    GETMNOUT,SAVEREG    THE SAVEAREA               LD Y02947 23750002
         LM    ENDADDR,LINKREG,EIGHT(SAVEREG) RESTORE REGS    LD Y02947 23800002
         FREEMAIN R,LV=(0),A=(1)   FREE SAVEAREA              LD Y02947 23850002
         L     RJ,4(RWTGC)         WORKAREA ADDRESS            @ZA03207 23900003
         MODESET KEYADDR=DXUKEY,WORKREG=15     USER KEY        @ZA03207 23902003
         B     RETURN                 RETURN TO MAINSTREAM     @ZA03207 23910003
         EJECT                                                          23950002
**********                                                              24000002
*                                                                       24050002
*        CONSTANTS                                                      24100002
*                                                                       24150002
**********                                                              24200002
         DS    0F                                             LD Y02947 24250002
SAVEAREA DC    X'E6000040'         SAVEAREA SUBPOOL AND LNGTH  @ZA03207 24300003
IOBPOOL  DC    X'FA000000'              SUBPOOL NUMBER OF 250 FOR IOB'S 24400002
IRBPOOL  DC    X'FD000000'                                         000E 24450002
TCCWPOOL DC    X'FF0000A0'         SUBPOOL AND LENGTH OF TCCW  @ZA03207 24460003
CLEARMSK DC    X'00000001'                                              24500002
DISABLE  DC    X'2F00000060240001'      DISABLE COMMAND.           000E 24550002
IONOP    DC    X'0300000020240001'      I/O NOP COMMAND            000E 24600002
FULL0    DC    F'0'                   FULL WORD OF ZEROS       @ZA03207 24610003
LIST     DC    X'80000000'            INDICATES A LIST ,       @ZA03207 24620003
*                        RATHER THAN REGISTERS                 @ZA03207 24630003
STRAMID  DC    C'3W'                                               000C 24650002
         DC    X'00000000'                                         000C 24700002
CLOSEIDL DC    C'0B'           LOW RANGE OF ID'S OF LAST LOAD OF CLOSE  24750002
CLOSEIDH DC    C'0G'           HIGH RANGE OF ID'S OF LAST LOAD OF CLOSE 24800002
AMIDCNST DC    C'3M'              ID OF THIS EXECUTOR                   24850002
CLEARCCW DC    X'20240001'              CCW FOR ERASE/WRITE  LD YA03971 24860000
         DC    X'C3'                    WRITE CONTRL CHAR.   LD YA03971 24870000
HEADER   DC    H'32'               HEADER SIZE FOR IRBS     L5 @ZA04082 24880003
TIME     DC    F'50'                                                    24885000
         EJECT                                                          24900002
**********                                                              24950002
*                                                                       25000002
*        REGISTER DEFINITIONS                                           25050002
*                                                                       25100002
**********                                                              25150002
RE       EQU   0                       WORK/PARAMREG                    25200002
RF       EQU   1                       WORK/PARAMREG                    25250002
RTCB     EQU   1                       TCB ADDRESS            LD Y02947 25300002
RDCB     EQU   2                       DCB ADDRESS                      25350002
R2       EQU   RDCB                    WORK REGISTER        LD @ZA00545 25360003
RBASE    EQU   3                       BASE REGISTER                    25400002
RCORE    EQU   4                       IOB ADDRESS                      25450002
RPAR     EQU   5                       START OF PARAMETER LIST          25500002
RWTG     EQU   6                       START OF WTG                     25550002
RPARC    EQU   7                       CURRENT ENTRY IN PARAMETER LIST  25600002
RWTGC    EQU   8                       CURRENT ENTRY IN WTG TABLE       25650002
RTIOT    EQU   9                       TIOT ADDRESS                     25700002
RUCB     EQU   10                      CURRENT UCB                      25750002
RDEB     EQU   11                      DEB ADDRESS                      25800002
RB       EQU   12                      WORK REG                         25850002
RC       EQU   13                      WORK REG                         25900002
RD       EQU   14                      WORK/PARAMREG                    25950002
RJ       EQU   15                      WORK/PARAMREG                    26000002
**********                                                              26050002
*                                                                       26100002
*        MISCELLANEOUS EQUATES                                          26150002
*                                                                       26200002
**********                                                              26250002
TCCWFIX  EQU   12                     OFFSET IN TCCW OF FIX    @ZA03207 26260003
*                                           LIST               @ZA03207 26270003
PGFREE   EQU   X'20'                  PAGE FREE FLAG           @ZA03207 26280003
SBPOOL   EQU   255                    TCCW SUBPOOL             @ZA03207 26290003
L160     EQU   160                    TCCW LENGTH              @ZA03207 26292003
LEN4     EQU   4                                                        26300002
LOOPCNT  EQU   4095                LOOP COUNT                LD YA02169 26350002
IRBSTAB  EQU   10                  DISPLACE FOR IRBSTAB FLAGS   YA01235 26400002
WAOFF    EQU   32                       OFFSET OF FIRST WTG ENTRY FROM  26450002
*                                  START OF WTG.                        26500002
PLOFF    EQU   4                        OFFSET OF DCB ENTRIES.          26550002
WGOFF    EQU   8                        OFFSET OF WTG ENTRIES.          26600002
PURGEOPT EQU   X'E0'               OPTION BYTE FOR PURGE                26650002
PURGOPTN EQU   X'A0'               OPTION BYTE FOR PURGE    LD @ZA00546 26660003
ZERO     EQU   0                                              LD Y02947 26700002
ONE      EQU   1                                              LD Y02947 26750002
FIVE     EQU   5                                              LD Y02947 26800002
EIGHT    EQU   8                                              LD Y02947 26850002
IDALNGTH EQU   320                 LENGTH OF TWO IDAL'S       LD Y02947 26900002
TCBFLG   EQU   29                                                       26950002
ABCLOSE  EQU   X'04'                                                    27000002
UCBFL1   EQU   6                                                        27050002
UCBTYP   EQU   16                                                       27100002
ARMSEEK  EQU   X'02'                                                    27150002
SWITCHED EQU   X'90'                                                    27200002
IBM32701 EQU   X'82'                                                    27250002
RESETPL  EQU   X'01'                                                    27300002
BUSY     EQU   X'40'                                                    27350002
CCPOLL   EQU   X'09'                                               000E 27400002
CCNOOP   EQU   X'03'                                               000E 27450002
CCTIC    EQU   X'08'                                               000E 27500002
COMCHAIN EQU   X'40'                                               000E 27550002
APOLL    EQU   X'40'                                               000E 27600002
TRMTST   EQU   X'10'                                                    27650002
CCPREPAR EQU   X'06'                                                    27700002
CCENABLE EQU   X'27'                                                    27750002
CCWCCSLI EQU   X'60'                                                    27800002
GRPHCDVC EQU   X'10'               GRAPHIC DEVICE CLASS                 27850002
UCBCLASS EQU   18                  DISP TO DEVICE CLASS IN UCB          27900002
ANRATNXT EQU   14                  LENGTH OF ATTN HANDLING FIELDS       27950002
*                                       IN UCB EXTENSION                28000002
OLTEP    EQU   X'80'               UCB OLTEP FLAG                       28050002
X20      EQU   X'20'               REG 8 DISP. IN SAVEAREA    LD Y02947 28100002
XE8      EQU   X'E8'               MASK FOR LINE HUNGED UP   LD YA02169 28150002
X05      EQU   X'05'                    OPCODE FOR ER/WR CCW LD YA03971 28170000
ALLON    EQU   X'FF'               MASK OF ALL ONE'S                    28200002
ATNIRBSZ EQU   116                 SIZE OF ANR ATTN IRB & IQE           28250002
ATNIRBAD EQU   28                  DISP TO IRB ADDR IN UCB              28300002
UCBGCB   EQU   27                  DISP TO GCB IN UCB                   28350002
UCBGRAF  EQU   28                 DISP TO GRAPHIC STATUS       @YA02128 28360002
RDYQ     EQU   32                 OFFSET TO READY IRB POINTER  @YA02128 28370002
IGG019UP EQU   X'01'              FLAG FOR DEFAULT ROUTINE     @YA02128 28390002
UCBATTN  EQU   26                  DISP TO ATTN FIELDS IN UCB           28400002
L1       EQU   1                                               @ZA08049 28405003
TWO      EQU   2                                             LD YA03240 28410000
L3       EQU   3                                               @ZA08049 28415003
THREE    EQU   3                                             LD YA03240 28420000
L4       EQU   4                                               @ZA08049 28430003
FOUR     EQU   4                                                        28450002
L8       EQU   8                                               @ZA09347 28454000
NINE     EQU   9                                             LD YA03240 28458000
TWELVE   EQU   12                                           LD @ZA00546 28458403
SIXTEEN  EQU   16                  DISPLACEMENT             LD @ZA00546 28460003
NXTAVAL  EQU   X'60'               NEXT AVAILABLE IQE        LD YA03240 28466000
RBSTAB   EQU   11                  STATUS AND ATTRIBUTE BIT  LD YA03240 28474000
RBEP     EQU   12                  ENTRY POINT               LD YA03240 28482000
RBOPSW   EQU   20                  OLD PSW                   LD YA03240 28490000
NOPGFIX  EQU   X'7F'       NO PAGE FIX REQUIRED IN DEB AVT     @ZA02840 28492003
L3270    EQU   X'58'      SIZE OF LOCAL 3270 IOB               @ZA08049 28496003
TIMELNG  EQU   4                                                        28497000
         EJECT                                                          28500002
CVT      DSECT                                                LD Y02947 28550002
         CVT                                                            28600002
         EJECT                                                          28650002
         DCBD  DSORG=BX                                                 28700002
         EJECT                                                          28750002
         IECDSECS WTG,PREFX,EXPAND=YES                        LD Y02947 28800002
         EJECT                                                          28850002
         IECTDEBX                                                       28900002
         EJECT                                                          28950002
         IECTIOBX                                                       29000002
         EJECT                                                          29050002
         IHAPSA                                                         29100002
         EJECT                                                          29150002
WORKAREA DSECT                                                   Y02947 29200002
         IECDSECT IOB=NO                                         Y02947 29250002
         EJECT                                                          29300002
         IKJTCB DSECT=YES                                               29350002
         END                                                            29400002
