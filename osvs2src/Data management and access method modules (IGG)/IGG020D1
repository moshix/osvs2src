 TITLE 'IGG020D1 - PARTIAL RELEASE - DADSM UPDATE'                      00020000
IGG020D1 CSECT                                                          00028021
*          RELEASE 16 DELETIONS                                         00036000
*3001090600                                                        AAAA 00040016
*          RELEASE 17 DELETIONS                                         00044000
*0762001100,045000,083000                                         DM0D  00048000
*0762064200                                                       20055 00050000
*          RELEASE 18 DELETIONS                                         00052000
*3462                                                             22500 00056018
*3462                                                             MCS   00058018
*          RELEASE 19 DELETIONS                                         00060000
*0945039600-044800,072400,076800                                 O19117 00064019
*          RELEASE 20 DELETIONS                                         00068000
*3043                                                            A35327 00072020
*          RELEASE 21 DELETIONS                                         00076000
*0980005400,006400-006600,007000-008600,009800,011000,036800,    A37199 00077021
*0980045400,056000-056200,076600,082800,084000,084400,087600,    A37199 00078021
*0980090800-091000                                               A37199 00079021
*0980000280,007600,015800-016000,089400-090000,090400            A39292 00080021
*          RELEASE 21.7 DELETIONS                                       00081002
*0000003200,016200-016400,017800-018400,072600,075700,083050-   SA54549 00082002
*0000083150,084800,086000-086800                                SA54549 00082402
*0000000840-001000,018600,019000,027000,028400,031000-          SA56400 00084002
*0000032400,050400,075600                                       SA56400 00084202
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00085002
*0000000030-000150,000850,001200,003400-003600,004800-005200,    Y02080 00085102
*0000007100-007200,007500-007600,015730-015740,016800,041600,    Y02080 00085202
*0000043000-045280,083000,083040,083050,083400,083600-088800     Y02080 00085302
*0000026630-026640,037600                                       XA01999 00085402
*0000                                                           YA02385 00085502
*          VS1 RELEASE 02 DELETIONS/CHANGES                             00095002
*0000028410-028430                                               XM0835 00095102
*                                                                       00105002
* MODULE NAME - IGG020D1                                                00105202
*                                                                       00105402
* DESCRIPTIVE NAME - PARTIAL RELEASE / DADSM UPDATE                     00105602
*                                                                       00105802
* COPYRIGHT - NONE                                                      00106002
*                                                                       00106202
* CHANGE ACTIVITY - SEE DELETIONS/CHANGES FOLLOWING THE CSECT CARD      00106402
*                                                                       00106602
*STATUS CHANGE LEVEL 010                                                00110021
*ATTRIBUTES - REENTRANT                                                 00120002
*                                                                       00140000
*FUNCTION - THIS MODULE UPDATES THE EXTENTS IN THE FORMAT 5 DSCB        00160000
*           RECORDS. THE NEW EXTENTS ARE PASSED TO THIS MODULE IN       00180000
*           A TABLE IN THE WORK AREA. WHEN AN EXTENT FROM THE TABLE     00200000
*           IS CONTIGUOUS WITH ONE OR TWO OF THE EXTENTS IN A FORMAT    00220000
*           5 DSCB RECORD, THE EXTENTS IN THAT RECORD ARE REPLACED      00240000
*           WITH ONE EXTENT THAT DESCRIBES THE ENTIRE AREA.             00260000
*                                                                       00280000
*ENTRIES-THE ONLY ENTRY POINT TO THIS MODULE IS IGG020D1. ENTRY         00300000
*        IS MADE FROM IGG020D0.                                         00320002
*                                                                       00380000
*SUPERVISOR CALLS AND MACROS. THE FOLLOWING ARE SUPERVISOR CALLS        00400000
*          ISSUED IN THE MACRO EXPANSIONS:                              00420000
*                    EXCP(0) READ FROM OR WRITE TO DIRECT ACCESS DEVICE 00440000
*                    WAIT(1) WAIT ON EVENT CONTROL BLOCK                00460000
*                                                                       00560000
*OTHER MACROS USED                                                      00580000
*                    IECPRLWA - DEFINES THE PARTIAL RELEASE WORK AREA   00590002
*                    IECSDSL1 - ENABLES SYMBOLIC ADDRESSING OF DSCBS    00600000
*                    IECDSECT - DEFINES THE CLOSE WORK AREA             00610002
*                                                                       00620000
*INPUT - AT ENTRY TO THIS MODULE, REGISTER 11 POINTS TO THE RELEASE     00630021
*        WORK AREA, WHICH CONTAINS THE FORMAT 4 DSCB, THE FIRST         00640021
*        FORMAT 5 DSCB, AND THE DADSM EXTENT TABLE. REGISTER 13         00650021
*        POINTS TO THE I/O SUPPORT WORK AREA, WHICH CONTAINS THE        00660021
*        UPDATED FORMAT 1 DSCB.                                         00670021
*        REGISTER 9 REFLECTS THE NUMBER OF EXTENTS IN THE               00672002
*        DADSM TABLE.                                                   00674002
*                                                                       00680000
*OUTPUT - UPDATED FORMAT 5 DSCB'S.                                      00690021
*                                                                       00700021
*STORAGE - PROGRAM CODE CSECT    = LESS THAN 2048 BYTES                 00710002
*          RELEASE WORK AREA     = 620 BYTES                            00720002
*          RPS WORK AREA         = 128 BYTES                            00722002
*          I/O SUPPORT WORK AREA                                        00724002
*                                                                       00730021
*EXITS -                                                                00740021
*        NORMAL - BRANCH TO IGG020P3 WITH ZERO IN REGISTER 2            00750002
*        ERROR  - BRANCH TO IGG020P3 WITH THE FOLLOWING ERROR           00760002
*                 CODE IN REGISTER 2:                                   00770021
*                                                                       00780021
*        X'10' - PERMANENT I/O ERROR                                    00790021
*                                                                       00800021
*                                                                       00880000
*REGISTER USAGE                                                         00900000
R0       EQU   0                                                        00920000
TEMP     EQU   0                                                        00940000
R1       EQU   1                                                        00960000
ERRETREG EQU   2                                                        01000000
R2       EQU   2                                                        01020000
R3       EQU   3                                                        01040000
R4       EQU   4                                                        01060000
R5       EQU   5                                                        01080000
COUNT    EQU   5                                                        01120000
R6       EQU   6                                                        01140000
INDEX3   EQU   6                                                        01160000
WORKREG1 EQU   7                                                        01180000
COUNT1   EQU   7                                                        01200000
INDEX2   EQU   8                                                        01220000
RTKK     EQU   8                                                        01240000
EXTCTR   EQU   9                                                        01260000
RINSCAN  EQU   9                                                        01280000
R10      EQU   10                                                       01300000
INDEX1   EQU   10                                                       01320000
ROUTSCAN EQU   10                                                       01340000
WRKAREA  EQU   11                                                       01360000
RXBASE   EQU   12                                                       01380000
R13      EQU   13                                                       01400000
RXCLOWKA EQU   13                                                       01420000
BRANCH   EQU   14                                                       01440000
RINEND   EQU   15                                                       01460000
R15      EQU   15                                                       01480000
WORKREG  EQU   15                                                       01500000
WORKREG2 EQU   15                                                       01520000
RX       EQU   15                                                       01540000
*                                                                       01548021
*** OTHER EQUATES                                                       01556021
*                                                                       01564021
IOERROR  EQU   X'10'                    I/O ERROR CODE           A37199 01572002
K0       EQU   0                        ZERO DISPLACEMENT       SA56400 01575002
TWO      EQU   2                        DISPLACEMENT OF TWO     SA56400 01576002
K2       EQU   2                        LENGTH OF TWO           SA56400 01577002
K4       EQU   4                        DISPLACEMENT OF FOUR    SA56400 01578002
K6       EQU   6                        DISPLACEMENT IS SIX     SA56400 01579002
*                                                                       01580021
         BALR  RXBASE,0                 LOAD BASE REGISTER      SA54549 01620002
         USING *,RXBASE                 BASE FOR MODULE         SA54549 01640002
         USING CLOSEWKA,RXCLOWKA                                        01660000
         USING PRLSEWKA,WRKAREA         WORK AREA ADDRESSABILITY Y02080 01680002
         USING CVT,R15                                                  01700000
*                                                                       01720000
*** THIS SECTION INITIALIZES DSCB CCHHR'S AND COUNTERS.                 01740000
*                                                                       01760000
SETICCHH EQU   *                                                        01880000
         MVC   INCCHHR(5),DS5PTRDS           SET NEXT FORMAT 5 CCHHR    01920000
*                                            FOR NEXT DADSM INPUT.      01940000
SETNCCHH EQU   *                                                        01960000
         MVC   NEXTDADS(5),INCCHHR          INITIALIZE NEXT DADSM PTR   01980000
*                                            DADSM.                     02000000
         LA    INDEX1,ENTRIES                SET INDEX FOR DADSMTBL     02020000
*                                            ENTRIES.                   02040000
         BAL   BRANCH,CVTORTA0               BRANCH TO CONVERT EXTENTS  02060000
*                                            OF INPUT FORMAT 5 FROM     02080000
*                                            XXYYZ TO RTA-RTA+1.        02100000
         LA    COUNT1,26                     LOAD TRANSFER DADSM COUNT  02120000
*                                            TO OUTPUT FOR 26 EXTENTS.  02140000
         EX    R0,SETOUT                    CLEAR OUTPUT DADSM AREA.    02160000
         LA    INDEX3,OUTDSCB+36             SET INDEX FOR OUTPUT AREA. 02180000
         LTR   COUNT,COUNT             ALL SPACE ALLOCATED              02200000
         BZ    OUTPUT4                 YES                              02220000
*                                                                       02240000
*** THIS SECTION MERGES ENTRIES FROM THE DADSM EXTENT TABLE WITH        02260000
*   ENTRIES FROM INPUT FORMAT 5 DSCB.                                   02280000
*                                                                       02300000
MERGE1   CLC   2(2,INDEX1),0(INDEX2)         COMPARE FOR CONTIGUOUS     02320000
*                                            EXTENTS BETWEEN RTA+1 OF   02340000
*                                            ENTRY AND RTA OF EXTENT.   02360000
         BH    MERGE3                        THE RTA OF THE ENTRY IS    02380000
*                                            GREATER THAN THE RTA OF    02400000
*                                            THE EXTENT.                02420000
         BL    MERGE8                        ENTRY GOES BEFORE 1ST      02440000
*                                            EXTENT.                    02460000
         MVC   0(2,INDEX2),0(INDEX1)         ENTRY AND DADSM ARE        02480000
*                                            CONTIGUOUS SET RTA+1 OF    02500000
*                                            EXTENT=RTA OF ENTRY.       02520000
MERGE2   LA    INDEX1,4(INDEX1)              INCREMENT DADSMTBL INDEX   02540000
*                                            FOR NEXT ENTRY.            02560000
         BCT   EXTCTR,MERGE3                 DECREMENT THE NUMBER OF    02580000
*                                            ENTRIES IN DADSMTBL AND    02600000
*                                            BRANCH IF MORE ENTRIES     02620000
*                                            TO CHECK FOR CONTIGUOUS    02640000
*                                            EXTENTS.                   02660000
MERGE6   EQU   *                                                        02661002
         MVC   K0(K4,INDEX3),K0(INDEX2) XFER INPUT TO           SA56400 02661202
*                                       OUTPUT                  SA56400 02662002
         LTR   COUNT,COUNT              ALL SPACE ALLOCATED     XA01999 02663002
         BZ    OUTPUT3                  BRANCH IF YES           XA01999 02664002
MERGE6A  LA    INDEX2,K4(INDEX2)        INCREMENT INPUT INDEX   SA56400 02665002
         BCT   COUNT,MERGE10            REDUCE EXTENT COUNT     SA56400 02666002
         BCTR  COUNT1,R0                REDUCE XFER COUNT       SA56400 02667002
         B     OUTPUT2                                          SA56400 02668002
MERGE3   CLC   0(2,INDEX1),2(INDEX2)         COMPARE FOR CONTIGUOUS     02720000
*                                            EXTENTS BETWEEN RTA+1 OF   02740000
*                                            EXTENT AND RTA OF ENTRY.   02760000
         BH    MERGE6                        ENTRY GREATER THAN EXTENT  02780002
         BL    OVERLAP                  BRANCH IF EXTENT        SA56400 02781002
*                                       IN ENTRIES OVERLAPS     SA56400 02782002
*                                       EXTENT IN F5            SA56400 02783002
         CLC   2(2,INDEX1),4(INDEX2)         COMPARE FOR A COLLAPSE     02800000
*                                            BETWEEN ENTRY AND EXTENTS. 02820000
         BL    MERGE5                   NO COLLAPSE             SA56400 02840002
         BH    CHECK                    CHECK IF OVERLAPPING     XM0835 02841002
*                                       EXTENTS WERE FOUND       XM0835 02843002
MERGE4   MVC   4(2,INDEX2),0(INDEX2)         DADSM COLLAPSE-MOVE RTA    02860000
*                                            OF EXTENT TO RTA OF NEXT   02880000
*                                            EXTENT.                    02900000
         LA    INDEX2,4(INDEX2)              INCREMENT INPUT FORMAT 5   02920000
*                                            INDEX FOR NEXT EXTENT.     02940000
         BCT   COUNT,MERGE2                  REDUCE NUMBER OF EXTENTS   02960000
*                                            AND CHECK NEXT ENTRY.      02980000
         LA    COUNT,1                       LAST EXTENT.               03000000
MERGE5   MVC   2(2,INDEX2),2(INDEX1)         RTA+1 OF EXTENT=RTA OF     03020000
*                                            ENTRY MOVE RTA OF ENTRY    03040000
         B     MERGE2                  CHECK FOR CONTIGUOUS             03060000
*                                      DADSMTBL ENTRIES                 03080000
MERGE8   LA    R1,4                    SET                              03260000
         SR    INDEX2,R1               ENTRY INDEX.                     03280000
         MVC   0(4,INDEX2),0(INDEX1)   MOVE ENTRY BEFORE EXTENT.        03300000
         LA    COUNT,1(COUNT)          INCREMENT EXTENT COUNT           03320000
         B     MERGE2                  CHECK FOR CONTIG DADSMTBL        03340000
CHECK    EQU   *                                                 XM0835 03340202
         NC    K4(K4,INDEX2),K4(INDEX2) IS NEXT EXTENT IN F5     XM0835 03340402
*                                       ALL ZEROES               XM0835 03340602
         BZ    MERGE5                   IF YES, NO OVERLAPPING   XM0835 03340802
*                                       EXTENTS WERE FOUND       XM0835 03341002
         LTR   COUNT,COUNT              ALL SPACE ALLOCATED     XA01999 03341102
         BZ    MERGE5                   BRANCH IF YES           XA01999 03341502
*                                                                       03342102
*** THIS SECTION MERGES ENTRIES FROM THE DADSM EXTENT TABLE             03342202
*   WITH ENTRIES FROM INPUT FORMAT 5 DSCB WHEN OVERLAPPING              03342302
*   EXTENTS HAVE BEEN DETECTED AND SETS A SWITCH SO THAT THE DIRF       03342402
*   BIT WILL REMAIN ON AT EXIT FROM PARTIAL RELEASE                     03342502
*                                                                       03342602
OVERLAP  EQU   *                                                        03342702
         OI    DADSMTBL,ERXTENT         INDICATE OVERLAPPING    SA56400 03342802
*                                       EXTENTS                 SA56400 03342902
         CLC   K0(TWO,INDEX1),K0(INDEX2) IS RTA IN ENTRIES      SA56400 03343002
*                                       LOWER THAN RTA IN F5    SA56400 03343202
         BNL   NEXTRTA                  BR IF ENTRIES RTA IS    SA56400 03344002
*                                       HIGH OF EQUAL           SA56400 03344202
         MVC   K0(TWO,INDEX2),K0(INDEX1)  MOVE ENTRIES RTA      SA56400 03345002
*                                       OVER FORMAT 5 RTA       SA56400 03345202
NEXTRTA  EQU   *                                                SA56400 03347002
         CLC   K2(TWO,INDEX1),K2(INDEX2)  IS RTA+1 IN ENTRIES   SA56400 03348002
*                                       HIGHER THAN RTA+1 IN F5 SA56400 03348202
         BNH   MERGE2                   IF HI OR EQAL, BRANCH   SA56400 03349002
         MVC   K2(TWO,INDEX2),K2(INDEX1)  MOVE ENTRIES RTA+1    SA56400 03350002
*                                       OVER F5 RTA+1           SA56400 03350202
         NC    K4(K4,INDEX2),K4(INDEX2) IS IT END OF INPUT F5   SA56400 03352202
         BZ    MERGE6                   BRANCH IF YES           SA56400 03352602
         CLC   K2(TWO,INDEX2),K4(INDEX2)  SHOULD EXTENTS        SA56400 03353002
*                                       BE COLLAPSED            SA56400 03353202
         BL    MERGE2                   BRANCH IF NO            SA56400 03354002
         CLC   K2(TWO,INDEX2),K6(INDEX2)  DOES CURRENT EXTENT   SA56400 03354202
*                                       IN FORMAT 5 ENGULF NEXT SA56400 03354402
*                                       EXTENT IN FORMAT 5      SA56400 03354602
         BNH   MERGE4                   BRANCH IF NO                    03354802
         MVC   K6(TWO,INDEX2),K2(INDEX2)  MOVE ENDING ADDRESS   SA56400 03354902
*                                       INTO NEXT EXTENT        SA56400 03355902
         B     MERGE4                                           SA54600 03356902
MERGE10  BCT   COUNT1,OUTPUT7                REDUCE OUTPUT XFER COUNT   03360000
*                                            AND BRANCH TO OUTPUT CHECK 03380000
*                                                                       03400000
*** THIS SECTION DETERMINES WHEN AND WHAT TYPE OF DSCB (FORMAT 0,       03420000
*   FORMAT 4 OR FORMAT 5) SHOULD BE WRITTEN.                            03440000
*                                                                       03460000
OUTPUT1  LTR   COUNT,COUNT                   CHECK NUMBER EXTENTS.      03480000
         BP    COLLAPSE                      EXTENTS LEFT.              03500000
OUTPUT2  CLI   INCCHHR+4,X'00'               ANY MORE FORMAT 5 DSCBS.   03520000
         BNE   DADSMIN                       YES.                       03540000
OUTPUT3  LA    INDEX3,4(INDEX3)        INCREMENT OUTPUT INDEX.          03560000
         LTR   EXTCTR,EXTCTR           ANY MORE ENTRIES                 03580000
         BZ    OUTPUT5                      NO                          03600000
         LTR   COUNT1,COUNT1                ARE 26 EXTENTS IN OUTPUT    03620000
         BP    OUTPUT4                      NO                          03640000
         BAL   BRANCH,DADSMOUT              OUTPUT DADSM                03660000
         SR    COUNT,COUNT                                       A37199 03680021
OUTPUT4  EQU   *                                                        03700000
         BCTR  COUNT1,0                      DECREMENT XFER COUNT       03720000
         LR    INDEX2,INDEX1           SET INDEX FOR XFER ENTRY.        03740000
         B     MERGE2                                                   03780000
OUTPUT5  EQU   *                                                        03800000
         BAL   BRANCH,DADSMOUT              WRITE FORMAT 5.             03820000
         TM    DXCCW7+7,1                   IS FORMAT 0 PENDING.        03840000
         BZ    WRTVTOC                      BRANCH IF NO                03860000
         LH    WORKREG2,HOLENUM             INCREMENT HOLE COUNT        03880000
         LA    WORKREG2,1(WORKREG2)           IN DADSM TABLE.           03900000
         STH   WORKREG2,HOLENUM                                         03920000
         BAL   WORKREG1,SETSEEK             OUTPUT  FORMAT 0.           03940000
WRTVTOC  EQU   *                                                 O19117 04030019
         SR    ERRETREG,ERRETREG        ZERO ERROR CODE          O19117 04120019
*                                                                       04140021
*** THIS SECTION BRANCHES TO THE LAST LOAD OF PARTIAL RELEASE.          04160002
*                                                                       04180021
XCTL     EQU   *                                                 O19117 04210019
        IECRES LOAD,EXTPR=(WRKAREA),MODID=PRECLOSE,BRANCH=DIRECT Y02080 04300002
*                                                                       04536021
*** THIS SECTION TESTS IF A FORMAT 5 DSCB MUST BE WRITTEN TO THE VTOC.  04544021
*                                                                       04552021
OUTPUT6  EQU   *                                                        04560000
         LTR   COUNT,COUNT        ANY MORE EXTENTS                22500 04566018
         BZ    OUTPUT2            NO,BRANCH                       22500 04572018
         LA    BRANCH,BYINDEX               SET RETURN FROM DADSMOUT.   04580000
         LTR   COUNT1,COUNT1                26 EXTS XFERED TO OUTPUT.   04600000
         BZ    DADSMOUT                     YES-WRITE DADSM RECORD.     04620000
OUTPUT7  EQU   *                                                        04640000
         LA    INDEX3,4(INDEX3)             NO-INCREMENT OUTPUT INDEX.  04660000
BYINDEX  EQU   *                                                        04680000
         LTR   EXTCTR,EXTCTR           ANY MORE ENTRIES                 04700000
         BZ    MERGE6                        XFER EXTENTS TO OUTPUT.    04720000
         B     MERGE1                        CHECK EXTENTS AND ENTRIES. 04740000
*                                                                       04760000
*** THIS MODIFIES THE CHANNEL PROGRAM TO READ IN A FORMAT 5 DSCB.       04780000
*                                                                       04800000
DADSMIN  LA    WORKREG2,INCCHHR              MODIFY SEARCH ID EQUAL     04820000
         ST    WORKREG,DXCCW9               CHANNEL PROGRAM FOR         04840000
         MVI   DXCCW9,X'31'                 READING IN FMT 5 DSCB.      04860000
         NI    DXCCW11+4,X'EF'              TURN OFF SKIP FLAG IN       04880000
         MVC   DXDAADDR+3(5),INCCHHR        CCHHR OF NEXT FMT 5 IN      04900000
*                                            SEEK ADDRESS.              04920000
         LA    WORKREG,DXCCW9               GET STARTING CCW ADDRESS.   04940000
         BAL   BRANCH,EXECUTIO               READ IN NEXT FORMAT5.      04960000
         BAL   BRANCH,CVTORTA0               CONVERT FORMAT5 EXTENTS    04980000
*                                            TO RTA-RTA+1.              05000000
         CLC   2(2,INDEX3),0(INDEX2)        ARE EXTS CONTIGUOUS.        05020000
         BL    NEXTOUT                  BRANCH IF NOT CONTIG    SA56400 05040002
         EX    R0,COLLAPS3                  MERGE CONTIGUOUS EXTENTS.   05060000
         LA    INDEX2,4(INDEX2)             INCREMENT INPUT INDEX.      05080000
         BCTR  COUNT,0                      DECREMENT INPUT EXTS CTR.   05100000
NEXTOUT  EQU   *                                                        05120000
         EX    R0,SETNCCHH             SET NEXT OUTPUT FORMAT 5.        05140000
         EX    R0,SETICCHH             SET NEXT INPUT  FORMAT 5.        05160000
         MVC   DXCCW9(4),DXCCW6             RESET CHANNEL PROGRAM ADDR. 05180000
*                                                                       05200000
*** THIS SECTION CREATES A SINGLE EXTENT FOR EACH SET OF CONTIGUOUS     05220000
*   EXTENTS.                                                            05240000
*                                                                       05260000
COLLAPSE LTR   EXTCTR,EXTCTR                 ANY MORE ENTRIES.          05280000
         BZ    OUTPUT6                       NO.                        05300000
COLLAPS1 CLC   0(2,INDEX1),2(INDEX3)         COMPARE FOR DADSM COLLAPSE 05320000
         BNE   OUTPUT6                       NO                         05340000
         EX    R0,MERGE1                    COMPARE ENTRY AND EXTENT.   05360000
         BNE   OUTPUT6                       NO                         05380000
COLLAPS3 EQU   *                                                        05400000
         MVC   2(2,INDEX3),2(INDEX2)         YES                        05420000
         LA    INDEX1,4(INDEX1)              INCREMENT DADSMTBL INDEX.  05440000
         LA    INDEX2,4(INDEX2)              INCREMENT INPUT INDEX.     05460000
         BCT   EXTCTR,COLLAPS2                                          05480000
         BCT   COUNT,OUTPUT6                 NO MORE ENTRIES-OUTPUT     05500000
         B     OUTPUT2                                                  05520000
COLLAPS2 BCT   COUNT,COLLAPS1                CHECK FOR ANOTHER COLLAPSE 05540000
         B     OUTPUT2                                                  05560000
*                                                                       05580000
*** THIS SECTION CONVERTS THE FORMAT 5 DSCB FROM RTA/RTA+1 FORMAT       05600021
*   TO ITS FINAL XXYYZ FORMAT AND WRITES IT TO THE VTOC.                05620021
*                                                                       05640000
DADSMOUT LR    WORKREG1,BRANCH               SAVE BRANCH ADDRESS        05660000
         STM   R6,R10,SAVEREGS                                          05680000
         OI    DXCCW11+4,X'10'              TURN ON SKIP FLAG.          05700000
         LA    RINEND,26                     SET COUNT INDEX            05720000
         LA    ROUTSCAN,OUTDSCB+5            SET OUTPUT INDEX           05740000
         LA    RINSCAN,OUTDSCB+36            SET INPUT INDEX            05760000
NEXTEXT  LH    RTKK,DS4DEVSZ+2               LOAD TRACKS PER CYLINDER   05780000
         LH    R1,0(RINSCAN)                 R1= RTA                    05800000
         LH    R3,2(RINSCAN)                 R3= RTA+1                  05820000
         SR    R0,R0                         ZERO                       05840000
         LR    R2,R0                         DIVIDE REGS.               05860000
         LR    R4,R3                                                    05880000
         SR    R4,R1                         R4=RTA+1-RTA               05900000
         CLR   R4,RTKK                                                  05920000
         BNL   MORETH1                       MORE THAN ONE CYL POSSIBLE 05940000
         MVC   2(2,ROUTSCAN),ZERO            ZERO YY.                   05960000
         STC   R4,4(ROUTSCAN)                SET Z.                     05980000
         B     MOVEXTA                                                  06000000
MORETH1  DR    R0,RTKK                       RTA  /RTKK                 06020000
         DR    R2,RTKK                       RTA+1/RTKK                 06040000
         SR    R3,R1                                                    06060000
         LTR   R0,R0                         EXCESS TRACKS              06080000
         BP    NOTCYL                        YES                        06100000
         STC   R2,4(ROUTSCAN)                SET Z                      06120000
         B     STORECYL                                                 06140000
NOTCYL   SR    RTKK,R0                                                  06160000
         LTR   R3,R3                                                    06180000
         BZ    ADD2                                                     06200000
         BCTR  R3,0                                                     06220000
ADD2     AR    RTKK,R2                                                  06240000
         STC   RTKK,4(ROUTSCAN)              SET Z                      06260000
STORECYL STH   R3,HOLD                                                  06280000
         MVC   2(2,ROUTSCAN),HOLD            SET YY.                    06300000
MOVEXTA  MVC   0(2,ROUTSCAN),0(RINSCAN)      SET XX                     06320000
         LA    ROUTSCAN,5(ROUTSCAN)          INCREMENT OUTPUT INDEX     06340000
         LA    RINSCAN,4(RINSCAN)            INCREMENT INPUT INDEX      06360000
         BCT   RINEND,NEXTEXT                BACK FOR NEXT EXTENT       06380000
         LM    R6,R10,SAVEREGS               RESET REGISTERS            06400000
         OC    OUTDSCB+5(130),OUTDSCB+5  OUTPUT AREA ZERO         20055 06420000
         BE    ZEROUT                        YES                        06440000
         MVC   OUTDSCB(4),FIVE               SET UP FORMAT 5            06460000
         MVC   OUTDSCB+4(40),OUTDSCB+5       MOVE OVER ID BYTE          06480000
         MVI   OUTDSCB+44,X'F5'              INSERT ID BYTE.            06500000
ZEROUT   EQU   *                                                        06520000
         MVC   OUTDSCB+135(5),NEXTDADS      SET DADSM POINTER.          06540000
         EX    R0,COMPOUT               IS THIS A VALID CHAIN ADDR.     06560000
         BNE   SKIPFLAG                 YES-DONT MODIFY CHAIN.          06580000
         EX    R0,ZEROPTR               NO-POINT TO NEXT F5 DSCB.       06600000
SKIPFLAG EQU   *                                                        06620000
         OI    DXCCW11+4,X'10'              TURN ON SKIP FLAG.          06640000
         CLI   INCCHHR+4,X'00'               ANY MORE FORMAT 5          06660000
         BE    FINDHOLE                     FIND HOLE                   06680000
SETSEEK  MVC   DXDAADDR+3(5),OUTCCHHR       SET UP SEEK ADDRESS.        06700000
         LA    WORKREG,DXCCW6               SET CHANNEL PROGRAM START.  06720000
         BAL   BRANCH,EXECUTIO               WRITE OUT UPDATED DADSM.   06740000
COMPOUT  EQU   *                                                        06760000
         CLC   OUTCCHHR(5),NEXTDADS          NEXT OUTPUT EQU THIS OUT   06780000
         BE    NXTOUTIN                                                 06800000
SETNEXT  MVC   OUTCCHHR(5),NEXTDADS         SET NEXT DADSM POINTER.     06820000
         B     TESTZERO                     TEST FOR FORMAT 0 PENDING   06840000
NXTOUTIN MVC   OUTCCHHR(5),INCCHHR           SET NEXT OUTPUT            06860000
TESTZERO TM    OUTDSCB+139,X'FF'            TEST FOR END OF OUTPUT.     06880000
         BNE   SETOUT                       BRANCH IF NO.               06900000
         TM    OUTCCHHR+4,X'FF'             TEST FOR END OF INPUT.      06920000
         BZ    SETOUT                       BRANCH IF YES.              06940000
         OI    DXCCW7+7,1                   INDICATE FORMAT 0 NEEDED.   06960000
SETOUT   XC    OUTDSCB(140),OUTDSCB          ZERO OUTPUT AREA           06980000
         LA    INDEX3,OUTDSCB+36             SET OUTPUT INDEX.          07000000
         LR    BRANCH,WORKREG1               RESET BRANCH REG.          07020000
         LA    COUNT1,26                     SET INDEX FOR OUTPUT XFER. 07040000
         BR    BRANCH                        EXIT FROM SUBROUTINE.      07060000
FINDHOLE LR    TEMP,COUNT                   ANY EXTENTS                 07080000
         ALR   TEMP,EXTCTR                  OR ENTRIES LEFT             07100000
         BZ    ZEROPTR                      NO                          07120000
         EX    R0,COMPOUT              NEED  A HOLE.                    07140000
         BE    SEARCHOL                 BRANCH IF EQUAL                 07160000
         CLI   NEXTDADS+4,0             IS CHAIN ADDRESS ZERO           07180000
         BNE   SETSEEK                  BRANCH IF NO.                   07200000
SEARCHOL EQU   *                                                        07220000
         MVC   DXDAADDR+3(4),VTOCADR    INSERT VTOC ADR INTO IOB O19117 07240019
         LA    WORKREG,DXCCW1               SET UP CHANNEL PROGRM STRT. 07280000
         BAL   BRANCH,EXECUTIO               FIND HOLE FOR NEXT OUTPUT  07300000
*                                            AND OUTPUT DADSM.          07320000
         MVC   DXDAADDR+3(L'OUTCCHHR),OUTCCHHR  UPDATE IOB SEEK YA02385 07321002
         LA    WORKREG,DXCCW6           SET UP TO READ          SA54549 07330002
         BAL   BRANCH,EXECUTIO          IN FORMAT ZERO          SA54549 07332002
         LH    WORKREG,HOLENUM          GET NO OF F0'S CREATED.         07340000
         BCTR  WORKREG,0                                                07360000
         STH   WORKREG,HOLENUM          SAVE NO IN DADSM TABLE.         07380000
         MVC   NEXTDADS(5),OUTDSCB+135       SET NEXT OUTPUT            07400000
         B     SETNEXT                                                  07420000
ZEROPTR  MVC   OUTDSCB+135(5),INCCHHR        ZERO POINTER               07440000
         B     SETSEEK                                                  07460000
*                                                                       07480000
*** THIS IS THE CHANNEL PROGRAM INITIATING SECTION.                     07500000
*                                                                       07520000
EXECUTIO ST    WORKREG,IOBSIOCC             SET CCW PTR INTO IOB.       07540000
         EXCP  DXIOB                                                    07580000
         WAIT  ECB=DXECB                                                07600000
         TM    DXECB,X'20'                  TEST FOR PERM I/O ERROR.    07620000
         BCR   5,BRANCH                     RETURN IF NO I/O ERROR      07640000
         LA    ERRETREG,IOERROR         LOAD I/O ERROR CODE      A37199 07660021
         B     XCTL                     ADVANCE TO NEXT LOAD     O19117 07680019
*                                                                       07700000
*** THIS SECTION CONVERTS THE FORMAT 5 DSCB FROM ITS VTOC FMT (XXYYZ)   07720000
*   TO A WORKABLE FMT (STARTING RTA-ENDING RTA+1).                      07740000
*                                                                       07760000
CVTORTA0 STM   R6,R10,SAVEREGS               SAVE REGS.                 07780000
         SR    R2,R2                         ZERO R2.                   07800000
         SR    COUNT,COUNT                   AND COUNT.                 07820000
         MVC   INDSCB+44(90),INDSCB+45       MOVE INPUT OVER ID BYTE.   07840000
         LA    RINSCAN,INDSCB+4             SET INPUT INDEX             07860000
         LR    ROUTSCAN,RINSCAN             SET OUTPUT INDEX.           07880000
         LA    RX,26                         SET CONVERT COUNT.         07900000
TEST0    CLC   0(2,RINSCAN),ZERO             EXTENT ZERO.               07920000
         BE    INCRIN                        YES.                       07940000
         MVC   HOLD(5),0(RINSCAN)            HOLD XXYYZ.                07960000
         LH    R1,HOLD+2                     R1=YY.                     07980000
         MH    R1,DS4DEVSZ+2                 MULT BY TRACKS PER CYL.    08000000
         IC    R2,HOLD+4                     R2=Z.                      08020000
         ALR   R1,R2                         R1= TRACKS+Z.              08040000
         AH    R1,HOLD                       R1=RTA+1.                  08060000
         STH   R1,2(ROUTSCAN)                SET RTA+1 IN OUTPUT.       08080000
         MVC   0(2,ROUTSCAN),HOLD            SET RTA IN OUTPUT.         08100000
         LA    ROUTSCAN,4(ROUTSCAN)          INCREMENT OUTPUT INDEX.    08120000
         LA    COUNT,1(COUNT)                INCREMENT CONVERT COUNT.   08140000
INCRIN   LA    RINSCAN,5(RINSCAN)            INCREMENT INPUT INDEX.     08160000
         BCT   RX,TEST0                      BACK FOR NEXT CONVERT      08180000
         ST    RX,0(ROUTSCAN)           CLEAR NEXT ENTRY         O19117 08190019
         LM    R6,R10,SAVEREGS               RESET REGS.                08200000
         LA    INDEX2,INDSCB+4         SET EXTENT INPUT INDEX.          08220000
         BR    BRANCH                        BRANCH OUT.                08240000
*                                                                       08245021
*** CONSTANTS                                                           08250021
*                                                                       08255021
FIVE     DC    X'05050505'                                              08260000
*                                                                       08302002
*** TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                       08304002
*                                                                       08304402
         XCTLTABL ID=(PRECLOSE,P3),SVC=020,LENGTH=,BRT=YES       Y02080 08305002
         EJECT                                                  SA54549 08315002
*                                                                       08316021
*** CVT DSECT                                                           08317021
*                                                                       08318021
CVT      DSECT                                                          08320000
         CVT                            CVT DSECT                Y02080 08340002
         EJECT                                                  SA54549 08342002
*                                                                       08345021
*** RELEASE WORK AREA                                                   08350021
*                                                                       08355021
WORKAREA IECPRLWA EP,F4,D1=(5)          RELEASE WORK AREA        Y02080 08360002
SAVEREGS EQU   IECREGSV+12              REGISTER SAVE AREA       Y02080 08380002
         EJECT                                                  SA54549 08882002
*                                                                       08885021
*** I/O SUPPORT WORK AREA                                               08890021
*                                                                       08895021
CLOSEWKA DSECT                                                          08900000
         IECDSECT                                                       08920000
ZERO     EQU   DXCCW4+4                                                 09020000
         END                                                            09120000
