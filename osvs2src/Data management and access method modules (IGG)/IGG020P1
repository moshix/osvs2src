 TITLE 'IGG020P1 - PARTIAL RELEASE - ENTRY POINT'                       00020000
IGG020P1 CSECT                                                          00026021
*          RELEASE 16 DELETIONS                                         00032000
*1463                                                             5M03B 00033016
*1463077400,077600                                                 AAAA 00035016
*1463                                                             17305 00036016
*          RELEASE 17 DELETIONS                                         00038000
*6039000900,001600-002200,060000,069400.                           DM0D 00041000
*6039029200                                                       18924 00042000
*6039019000                                                       19689 00043000
*          RELEASE 18 DELETIONS                                         00044000
*3479                                                             MCS   00047018
*          RELEASE 19 DELETIONS                                         00050000
*0946019400,029000,037300,048600-050600,057800-060200            O19117 00053019
*0946041200,043320                                               A25991 00054019
*          RELEASE 20 DELETIONS                                         00056000
*          RELEASE 21 DELETIONS                                         00062000
*0980001000-001200,001500-003000,004800-005000,005400-005800,    A37199 00062121
*0980006200-006400,006800-007600,008400,009000,009800-010200,    A37199 00062221
*0980010800,011400,011800,012200-012400,013000,014200,014600-    A37199 00062321
*0980015000,017400-017600,018200,019200,020000,024800-025200,    A37199 00062421
*0980028000,031200,034800-035000,037160-037240,042200-043000,    A37199 00062521
*0980048300,050800,064200-064400,069800,070800,071200,074400,    A37199 00062621
*0980075520                                                      A37199 00062721
*0980000260,006400,015600-015800,018900-019000,021200,029400,    A39292 00063021
*0980036200,044600,053600,054000,054600-054800,056200,057400,    A39292 00064021
*0980066400,069600-069800,076200-077000                          A39292 00065021
*          RELEASE 21.7 DELETIONS                                       00065402
*0000002400,005300-005600,006900-007400,016400,024200-024400,   SA54549 00067002
*0000025280,027000,028200,029360,029460,037000,037320-037480,   SA54549 00067402
*0000045000,046400-048400,063200,064200,068800,069480-069640,   SA54549 00067802
*0000071600,073000-073600                                       SA54549 00071002
*0000018200,022400-023800,050200-050400,063000,067400-067600    SA53147 00071102
*0000069100                                                     SA53147 00071202
*          RELEASE 22 DELETIONS                                         00072502
*          VS2 RELEASE 01 DELETIONS                                     00072602
*0000                                                            YM2930 00072702
*0000026500,026660-026708                                        YM4398 00072802
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00074502
*0000000280,000304-000308,000740-000800,003200-003400,004400,    Y02080 00074602
*0000005820,006200-006400,006800-006900,007100,015300,015630-    Y02080 00074702
*0000015650,016600,017600,018100-018200,018450-018550,019300-    Y02080 00074802
*0000019700,025320,025360-025680,025800,026100,026480,026720,    Y02080 00074902
*0000029300,036350,036450,036550,039400,048800,049800-050800,    Y02080 00075002
*0000066400,067600,068000,069200-069416,069440,069480,070200,    Y02080 00075102
*0000070400-075600                                               Y02080 00075202
*0000017200,019900-020080,026140,069580-070220,077900-078200     Y02144 00075402
*0000000030-000150,005820,019860,019900,020100,026480,026660-    Y02082 00075502
*0000026740,028600-028800,029100-031000,066200,066600            Y02082 00075602
*0000027000-027100                                               YM3912 00075702
*0000029240-029250,029830-029840,069060,069100                   YM2880 00075902
*0000                                                            YM2887 00076202
*0000                                                            YM5371 00076602
*0000030710-030730,030770-030790                                 YM5709 00077002
*0000026130,026148-026156                                        YM6546 00077402
*0000020020,026100-026110,069500                                 YM3997 00077702
*0000029980,030130,030820                                        YM4653 00078002
*0000004700,018800,029320,029880-029890,029940,029960-029970,    YM8507 00078502
*0000030000,030030-030050,030110-030130,030210,030910-030920,    YM8507 00078602
*0000078400                                                      YM8507 00078702
*                                                                       00085002
*                                                                       00089002
*STATUS CHANGE LEVEL 010                                                00090021
*                                                                       00095002
*MODULE NAME - IGG020P1                                                 00100002
*                                                                       00105002
*DESCRIPTIVE NAME - PARTIAL RELEASE - ENTRY POINT                       00110002
*                                                                       00115002
*COPYRIGHT - NONE                                                       00120002
*                                                                       00125002
*CHANGE ACTIVITY - SEE DELETIONS/CHANGES FOLLOWING CSECT CARD           00130002
*                                                                       00140000
*FUNCTION - THIS MODULE RELEASES ANY UNUSED SPACE THAT WAS              00160021
*        ALLOCATED IN THE DATA SET'S FORMAT 1 DSCB.                     00180021
*                                                                       00182002
*DEPENDENCIES - REGISTER 7 ON ENTRY FROM RESTART MUST POINT TO   YM8507 00184002
*        THE RESTART WORKAREA MAPPED BY IEEVRSWA, DSECT NAME     YM8507 00186002
*        RSTWA. LABEL RSINT POINTS TO THE FIRST OF ALL THE DEBS  YM8507 00188002
*        BEING REESTABLISHED FOR THE TASK.                       YM8507 00190002
*                                                                       00200021
*ENTRIES - THE ENTRY POINT TO THIS MODULE IS IGG020P1. ENTRY IS         00220021
*        MADE FROM CLOSE MODULE IFG0202E OR FROM THE REPOSITION I/O     00240002
*        FUNCTION OF CHECKPOINT/RESTART.                                00260021
*                                                                       00360000
*SUPERVISOR CALLS                                                       00380000
*        SVC   EXCP (0)  READ/WRITE DISK                                00400000
*        SVC   WAIT (1)  WAIT FOR COMPLETION OF I/O                     00420000
*                                                                       00460000
*INPUT - REGISTER 2 POINTS TO THE USER'S DCB FOR RESTART, AND    YM8507 00470002
*        TO THE COPY DCB FOR CLOSE. REGISTER 4 POINTS TO         YM8507 00472002
*        THE I/O SUPPORT WORK AREA WHICH CONTAINS THE DATA PORTION      00480021
*        OF THE FORMAT 1 DSCB. REGISTER 10 POINTS TO THE UCB.           00490021
*        REGISTER 7 POINTS TO RESTART WORKAREA IF FROM RESTART.  YM8507 00492002
*                                                                       00520000
*OUTPUT - REGISTER 11 POINTS TO THE RELEASE WORK AREA WHICH CONTAINS    00530002
*        THE DATA PORTION OF THE FORMAT 4 DSCB, AND THE DADSM           00540002
*        EXTENT TABLE, WHOSE ENTRIES REPRESENT THE SPACE BEING          00550002
*        RELEASED FROM THE FORMAT 1 DSCB.                               00560002
*        REGISTER 13 POINTS TO THE I/O SUPPORT WORK AREA, WHICH         00570021
*        CONTAINS THE PARTIALLY UPDATED FORMAT 1 DSCB.                  00580002
*        IF THIS MODULE IS BRANCHING TO IGG020P2, REGISTER 5 WILL       00582002
*        CONTAIN THE NUMBER OF ENTRIES IN THE DADSM TABLE.              00590002
*                                                                       00600000
*STORAGE - PROGRAM CODE CSECT    = LESS THAN 2048 BYTES                 00620002
*          RELEASE WORK AREA     = 620 BYTES                            00630002
*          RPS WORK AREA         = 128 BYTES                            00640002
*          I/O SUPPORT WORK AREA                                        00650002
*                                                                       00660000
*EXITS -                                                                00670021
*        NORMAL - BRANCH TO IGG020P2                                    00680002
*        ERROR  - IF AN I/O ERROR OCCURRED, BRANCH TO IGG020P3          00690002
*                 WITH X'10' ERROR CODE IN REGISTER 2.                  00700002
*                 BRANCH TO IGG020D0 TO WRITE BACK THE FORMAT 1         00710002
*                 WITH ONE OF THE FOLLOWING CODES IN REGISTER 2:        00720002
*                 X'00' - NO EXTENTS BEING RELEASED                     00722002
*                 X'02' - UNABLE TO FIND EXTENT IN THE FORMAT 1 DSCB    00730002
*                 X'08' - ANOTHER DCB IS OPEN TO THE DATA SET           00732002
*                 X'20' - NO ROOM IN THE VTOC                           00740002
*                                                                       00780000
*REGISTER USAGE                                                         00800000
R0       EQU   0                                                        00820000
RX1      EQU   1                       WORK                             00860000
R1       EQU   1                                                        00880000
ERRETREG EQU   2                                                        00920000
R2       EQU   2                                                        00940000
RX2      EQU   2                       WORK                             00960000
R3       EQU   3                                                        01040000
RX4      EQU   4                       WORK                             01060000
R4       EQU   4                                                        01100000
R5       EQU   5                                                        01120000
R6       EQU   6                                                        01160000
R7       EQU   7                                                        01200000
R8       EQU   8                                                        01260000
R9       EQU   9                                                        01280000
RXUSRDCB EQU   9                       BASE FOR USERS DCB               01320000
RXUCB    EQU   10                      POINTER TO THE UCB               01340000
RXWKA    EQU   11                      BASE FOR WORK AREA               01360000
RXBASE   EQU   12                      BASE FOR MAIN PROGRAM            01380000
RXCLOWKA EQU   13                      BASE FOR CLOSE'S WORK AREA       01400000
RLINK    EQU   14                      SUBROUTINE LINK REGISTER         01440000
R15      EQU   15                                                       01520000
*                                                                       01522021
*** OTHER EQUATES                                                       01524021
*                                                                       01526021
K0       EQU   0                        CONSTANT OF 0            Y02082 01526202
K1       EQU   1                        CONSTANT OF 1            Y02082 01526402
K2       EQU   2                        CONSTANT OF 2            Y02080 01527002
K3       EQU   3                        CONSTANT OF 3            Y02082 01527502
K4       EQU   4                        4 BYTES                 SA54549 01528002
K5       EQU   5                        CONSTANT OF 5            Y02082 01528202
K6       EQU   6                        6 BYTES                 SA54549 01528402
K12      EQU   12                       CONSTANT OF 12           Y02082 01529002
SVRBEXSA EQU   96                       SVRB EXTENDED SAVEAREA   YM8507 01529402
RTNCODE8 EQU   8                        ERROR RETURN CODE OF 8   Y02082 01530002
DS1EXTUL EQU   X'40'                    USER LABEL EXTENT        Y02082 01531002
ALLBITS  EQU   X'FF'                    MASK OF ALL ONES         Y02082 01532002
BLANK    EQU   C' '                     EBCDIC BLANK             YM2880 01533002
DEBDADEV EQU   X'04'                    DEB EXTENT SCALE FOR DA  Y02082 01534002
DIRFBIT  EQU   X'04'                    VTOC INTERRUPT BIT       O19117 01540019
NOTINF1  EQU   X'02'                    EXTENT NOT FOUND ERROR   A37199 01547021
OPENDS   EQU   X'08'                    OPEN DATA SET ERROR      Y02082 01548002
IOERROR  EQU   X'10'                    I/O ERROR CODE           A37199 01554021
NOROOM   EQU   X'20'                    NO ROOM IN VTOC ERROR    A37199 01561021
*                                                                       01570021
         BALR  RXBASE,0                      LOAD BASE REGISTER         01600000
         USING *,RXBASE                 BASE FOR MODULE         SA54549 01610002
         USING CVT,R15                      CVT BASE REGISTER.          01620000
         USING PRLSEWKA,RXWKA           WORK AREA ADDRESSABILITY Y02080 01660002
         USING IHADCB,RXUSRDCB         ESTABLISH BASE FOR USERS DCB     01680000
         USING CLOSEWKA,RXCLOWKA       ESTABLISH BASE FOR CLOS WKAREA   01700000
         USING UCB,RXUCB                UCB ADDRESSABILITY       Y02144 01720002
*                                                                       01740021
*** THIS SECTION OBTAINS CORE FOR THE PARTIAL RELEASE WORK AREA.        01760002
*                                                                       01780000
BEGINA   LA    RXCLOWKA,0(RX4)              GET PTR TO CLOSE WORKAREA.  01800000
         IECRES GET,PREFIX=FIRST,LV=PWALNGTH,ID=PRWA,            Y02080X01810002
               STM=(RX2,RXCLOWKA,DXCCW1)  OBTAIN WORK AREA       Y02080 01820002
         LR    RXWKA,RX1                     LOAD GETMAIN AREA BASE REG 01840000
         MVC   WTGMODNM,FIRSTLD         MOVE IN MODULE NAME      YM5371 01842002
*                                                                       01844002
         MODESET EXTKEY=ZERO            SWITCH TO KEY 0 BEFORE   Y02082X01845002
                                        SAVING REGISTERS IN SVRB Y02082 01850002
         BAL   RLINK,FINDSVRB               GET POINTER TO SVRB.        01860000
         STM   RX2,RXUCB,SVRBEXSA(R15)  SAVE REGISTERS FOR CLOSE YM8507 01880002
         LR    RXUSRDCB,RX2                  LOAD USERS DCB ADR.IN BASE 01980000
         ST    RXUSRDCB,DCBSAVE         SAVE USER'S DCB POINTER SA54549 01980402
         LTR   R4,R4                    ENTERED FROM            SA54549 01982002
*                                       CHECKPOINT/RESTART      SA54549 01984002
         BP    SETKEY5                  BRANCH IF NO             Y02082 01986002
         OI    DADSMTBL,FROMCR          TURN INDICATOR ON       SA54549 01988002
*                                                                       01989002
         IECRES LOAD,MODNM=FIRSTLD,EXTPR=(RXWKA),BRANCH=NO       Y02080X01990002
                                        LET OPTIONAL TRACE PRINT Y02080X01991002
                                        THIS MODULE'S NAME       Y02080 01992002
         B     SETFNCTN                 INITIALIZE THE RECOVERY  Y02144 01993002
*                                       ROUTINE PARAMETER LIST   Y02144 01994002
SETKEY5  EQU   *                        RETURN TO DATAMGT KEY    Y02082 01995002
         MODESET EXTKEY=DATAMGT         RETURN TO DATAMGT KEY IF Y02082X01996002
                                        ENTERED FROM CLOSE       Y02082 01997002
*                                                                       01998002
*** THIS SECTION INITIALIZES THE RECOVERY ROUTINE PARAMETER LIST.       01999002
*                                                                       02000002
SETFNCTN EQU   *                        INITIALIZE LIST          Y02144 02001002
         L     RX1,IECRRPRM             RECOVERY RTN LIST ADDR   Y02144 02003002
         USING RRPLIST,RX1              PARM LIST ADDRESSABILITY Y02144 02004002
         OI    RRFUNCTN,RRFPRLSE        SET RELEASE FUNCTION BIT Y02144 02005002
         ST    RXUCB,RRUCBPTR           SAVE UCB ADDRESS         Y02144 02006002
         DROP  RX1                                               Y02144 02007002
*                                                                       02008002
*** THIS SECTION INITIALIZES THE CHANNEL PROGRAM.                       02009002
*                                                                       02010002
CHANPROG EQU   *                                                SA54549 02012002
         XC    DXDAADDR(2),DXDAADDR         CLEAR FIRST TWO BYTES OF SK 02020000
         LM    R0,R5,CCWX1                  PICK UP FIRST 3 CCWS.       02040000
         ALR   R0,RXCLOWKA                  MODIFY ADDR OF CCWS IN      02060000
*                                           CLOSE WORK AREA.            02080000
         ALR   R2,RXCLOWKA                  CLOSE AREA HAS CCW'S.       02100000
         ALR   R4,RXWKA                 WRITE FROM OUTDSCB       A39292 02120021
         STM   R0,R5,DXCCW1                 STORE FIRST 6 CCW'S.        02140000
         LA    R2,DXCCW4                    MODIFY TIC ADDRESS.         02160000
         ST    R2,IOBSIOCC                  INSERT STARTING CCW IN IOB. 02180000
         STM   R0,R5,DXCCW4                 STORE LAST 3 OF 6 CCW'S.    02200000
         MVI   DXCCW5,X'08'                 INSERT TIC OP CODE.         02220000
*   BUILD CCW6 AND CCW7 TO READ F4 DSCB AND COUNT OF FIRST F5 DSCB      02230002
         LM    R0,R3,CCWX6              LOAD CCWS 6-7           SA53147 02240002
         ALR   R0,RXWKA                 RELOCATE READ AREA ADDR SA53147 02260002
         ALR   R2,RXWKA                 RELOCATE READ IN AREA   SA53147 02280002
*                                       FOR READ COUNT          SA53147 02300002
         STM   R0,R3,DXCCW6             STORE CCW6 AND CCW7     SA53147 02320002
         LA    R2,DXDAADDR                  PICK UP PTR TO SAVE AREA.   02400000
*                                                                       02460000
*** THIS SECTION GETS THE TTR OF THE VTOC FROM THE UCB AND CONVERTS     02470021
*   IT TO AN MBBCCHHR. AFTER ENQ'ING ON THE VTOC, IT READS THE          02480021
*   FORMAT 4 DSCB AND DETERMINES IF THERE IS AN UNUSED DSCB IN THE      02490021
*   VTOC (IN CASE ONE IS NEEDED FOR AN ADDITIONAL FORMAT 5 DSCB).       02500021
*                                                                       02524013
         LA    R0,SRTEVOLI             R0 = POINTER TO VOLUME LABELAAAA 02534016
         ST    R0,DXCCW12              SET RNAME POINTER IN ENQ LISAAAA 02574016
         L     R0,SRTEFSCT              LOAD TTR OF F4 CCHHR     Y02080 02580002
         MVC   DXDEBSCC(K4),CCWX2+K4    MOVE BEGINNING CCHH     SA54549 02590002
*                                       INTO DEB                SA54549 02592002
         MVC   DXDEBECC(K6),ECCHHTRK    MOVE ENDING CCHH AND    SA54549 02594002
*                                       NUMBER OF TRACKS INTO   SA54549 02596002
*                                       DEB                     SA54549 02598002
         BAL   RLINK,CCHHCVT            *** CONVERT TTR0 TO MBBCCHHR.   02600000
         TM    UCBTBYT2,UCB2OPT3        TEST FOR RPS DEVICE     SA53147 02602002
         BNO   SKIPRPS                  BRANCH IF NOT RPS       SA53147 02604002
         LA    R3,DXDEB                 PTR TO DEB IN CLOSE     SA53147 02606002
*                                       WORK AREA               SA53147 02608002
         IECRPS RDEB=R3,WKREG1=R6,EXTPR=RXWKA  INITIALIZE FOR    YM3997X02610002
                                        RPS PROCESSING           YM3997 02611002
*                                                                       02612002
         MVC   WTGMODNM,FIRSTLD         RESTORE MODULE NAME      YM5371 02612402
*                                                                       02614002
         TM    DADSMTBL,FROMCR          TEST IF ENTRY FROM C/R   Y02082 02614402
         BO    SKIPRPS                  BRANCH IF C/R            YM6546 02614802
         MODESET EXTKEY=DATAMGT         RETURN TO KEY 5 IF CLOSE YM6546 02615202
*                                                                       02615602
SKIPRPS  EQU   *                                                SA53147 02616002
         MVC   MJNAME,VTOCNAME         INSERT MAJOR Q N AME             02620000
         SR    R1,R1                    ZERO REGISTER            Y02080 02624002
         STH   R1,ENQAREA+K2            CLEAR FOR RESERVE MACRO  Y02080 02628002
         MVI   ENQAREA,255             INDICATE LAST Q AREA             02640000
        RESERVE (MJNAME,,E,6,SYSTEMS),SMC=STEP,MF=(E,ENQAREA),   YM3022X02656002
               UCB=DXDEB+32                                             02664016
*                                                                       02665002
         OI    DSMADTB2,DSMVTOCR+DSMSMCE  SET VTOC ENQ'ED SMC    Y02144 02666002
*                                                                       02667002
         DROP  RXUCB                                             Y02082 02677002
         USING CVT,R15                                                  02680013
         BAL   RLINK,RDDSCBT            *** READ VTOC DSCB              02720000
         LH    R6,DS4DSREC                  GET VTOC HOLE COUNTER.      02740000
         LTR   R6,R6                        IS THERE A HOLE IN VTOC.    02760000
         BP    SETVTOC                      YES-GO TO SAVE VTOC ADDR.   02780000
         LA    ERRETREG,NOROOM          NO, SET ERROR CODE       A37199 02800021
         B     WRITF1                   EXIT TO WRITE           SA54549 02820002
*                                       BACK FORMAT 1           SA54549 02830002
*                                                                       02840000
*** THIS SECTION WRITES BACK THE FORMAT 4 DSCB WITH THE DIRF BIT SET.   02860002
*                                                                       02880002
SETVTOC  EQU   *                                                 O19117 02882019
         MVC   VTOCADR(5),DXDAADDR+3    SAVE VTOC DSCB ADDRESS   O19117 02884019
         XI    DS4VTOCI,DIRFBIT         SET/RESET DIRF BIT       O19117 02886019
         TM    DS4VTOCI,DIRFBIT         TEST RESULTS             O19117 02888019
         BZ    SKPWRT                   BR IF PREVIOUS INTERRUPT O19117 02890019
         MVI   DXCCW6,X'05'             SET UP DATA CMMD         O19117 02892019
         MVI   DXCCW6+4,X'00'           RESET CMMD CHAIN         O19117 02894019
         BAL   RLINK,RDDSCBT            GO WRITE BACK F4         O19117 02896019
*                                                                       02897002
*** THIS SECTION VERIFIES THAT NO OTHER JOB IS OPEN TO THE DATA SET     02898002
*   AND THAT THE CURRENT JOB HAS NO OTHER DCB OPEN TO THE DATA SET.     02899002
*                                                                       02899502
SKPWRT   EQU   *                                                 O19117 02900019
         SR    ERRETREG,ERRETREG        ZERO RETURN CODE REG     Y02082 02901002
         CLI   DSCNOEXT,K0              CHECK NUMBER OF EXTENTS  Y02082 02902002
         BE    WRITF1                   BRANCH IF MODEL DSCB     Y02082 02903002
         L     R15,CVTPTR               LOAD CVT ADDRESS         Y02082 02904002
         L     R15,CVTTCBP              LOAD TCB/ASCB POINTERS   Y02082 02905002
         L     RX2,K4(,R15)             LOAD CURRENT TCB ADDRESS Y02082 02906002
         USING TCB,RX2                  TCB ADDRESSABILITY       Y02082 02907002
         TM    PTYPEFLG,FROMCR          TEST IF ENTRY FROM C/R   Y02082 02908002
         BNO   TIOTENQ                  BRANCH IF FROM CLOSE     Y02082 02909002
*                                                                       02910002
*** FOR ENTRY FROM CHKPT/RESTART, THIS SECTION ISSUES AN EXCLUSIVE      02911002
*   ENQ DIRECTED TO THE INITIATOR'S TCB WITH A MAJOR RESOURCE NAME OF   02912002
*   SYSDSN AND THE DATA SET NAME AS THE MINOR RESOURCE NAME.  IF THE    02913002
*   RETURN CODE INDICATES THAT THE TASK PREVIOUSLY HAD CONTROL OF THE   02914002
*   RESOURCE, THEN THE ENQ IS REISSUED IN A SUCCEEDING SECTION OF CODE. 02915002
*                                                                       02916002
DSNENQ1  EQU   *                        ENQ DSNAME               Y02082 02917002
         LA    RX4,JFCBDSNM             POINT TO DATA SET NAME   Y02082 02918002
         L     R3,TCBJSCB               LOAD JSCB ADDRESS        Y02082 02919002
         USING IEZJSCB,R3               JSCB ADDRESSABILITY      Y02082 02920002
         L     R3,JSCBACT               GET ACTIVE JSCB ADDRESS  YM2887 02920502
         L     R3,JSCBTCBP              INITIATOR'S TCB ADDRESS  Y02082 02921002
         DROP  R3                                                Y02082 02921502
         MVC   MJNAME(L'SYSDSN),SYSDSN  MAJOR RESOURCE NAME      Y02082 02922002
         MVC   ENQAREA(ENQLTH1),ENQLIST1  MOVE IN ENQ PARM LIST  Y02082 02923002
         LA    R5,JFCBDSNM+L'JFCBDSNM-K1  LAST BYTE OF DSNAME    YM2880 02923402
TESTDSN1 EQU   *                        SEARCH FOR NON-BLANK     YM2880 02923802
         CLI   K0(R5),BLANK             IS THIS ONE A BLANK      YM2880 02924202
         BNE   GETLNTH1                 BRANCH IF NO TO COMPUTE  YM2880X02924602
                                        LENGTH OF NAME FOR ENQ   YM2880 02925002
         BCT   R5,TESTDSN1              TRY NEXT BYTE            YM2880 02925402
GETLNTH1 EQU   *                        CALCULATE LENGTH         YM2880 02925802
         LA    R6,JFCBDSNM-K1           BYTE PRECEDING DSNAME    YM2880 02926202
         SR    R5,R6                    R5 HAS LENGTH FOR ENQ    YM2880 02926602
         ENQ   (MJNAME,(RX4),,(R5)),TCB=(R3),RET=USE,            YM2880X02926702
               MF=(E,ENQAREA)           ENQ EXCLUSIVELY ON DSN   YM2880 02926802
*                                                                       02926902
         LTR   R15,R15                  TEST RETURN CODE         Y02082 02927002
         BNZ   ERRTEST                  BRANCH IF NOT SUCCESSFUL Y02082 02928002
*                                                                       02929002
         OI    DSMADTB2,DSMDSNE         SET DSN ENQ'ED SWITCH    Y02082 02930002
         ST    RX4,DSMADTW3             SAVE POINTER TO DSNAME   Y02082 02931002
         B     DEBSRCH                  SEARCH DEB CHAIN         YM8507 02932002
ERRTEST  EQU   *                        ERROR TEST               Y02082 02933002
         CLI   ENQAREA+K3,RTNCODE8      TEST IF TASK ALREADY     Y02082 02934002
*                                       ENQ'ED ON SYSDSN         Y02082 02935002
         BE    DSNENQ2                  BRANCH IF YES            Y02082 02936002
OPENERR  EQU   *                        OPEN DATA SET ERROR      Y02082 02937002
         LA    ERRETREG,OPENDS          OPEN DATA SET ERROR      Y02082 02938002
         B     WRITF1                   GO REWRITE THE F1 DSCB   Y02082 02939002
*                                                                       02940002
*** FOR ENTRY FROM CLOSE, THIS SECTION ISSUES AN ENQ RET=CHNG WITH A    02941002
*   MAJOR NAME OF SYSZTIOT AND A MINOR NAME COMPOSED OF THE ASID/DSAB   02942002
*   QDB ADDRESS.  IT THEN READS THE KEY OF THE FORMAT 1 DSCB, SINCE     02943002
*   JFCBDSNM MAY NOT CONTAIN THE DATA SET NAME.                         02944002
*                                                                       02945002
TIOTENQ  EQU   *                        ENQ TIOT                 Y02082 02946002
         L     RX1,K12(,R15)            LOAD CURRENT ASCB ADDR   Y02082 02947002
         USING ASCB,RX1                 ASCB ADDRESSABILITY      Y02082 02948002
         MVC   MINAME(L'ASCBASID),ASCBASID  ASID TO MINOR NAME   Y02082 02949002
         DROP  RX1                                               Y02082 02950002
         L     RX1,TCBJSCB              LOAD JSCB ADDRESS        Y02082 02951002
         USING IEZJSCB,RX1              JSCB ADDRESSABILITY      Y02082 02952002
         L     RX1,JSCBACT              ACTIVE JSCB ADDRESS      Y02082 02953002
         MVC   MINAME+K2(L'JSCDSABQ),JSCDSABQ  DSAB QDB ADDRESS  Y02082 02954002
         DROP  RX1                                               Y02082 02955002
         MVC   MJNAME(L'SYSZTIOT),SYSZTIOT  MAJOR RESOURCE NAME  Y02082 02956002
         MVC   ENQAREA(ENQLTH),ENQLIST  MOVE IN ENQ PARM LIST    Y02082 02957002
         ENQ   (MJNAME,MINAME),MF=(E,ENQAREA),RET=CHNG           Y02082X02958002
                                        ENQ EXCLUSIVELY ON TIOT  Y02082 02959002
*                                                                       02960002
         LTR   R15,R15                  TEST RETURN CODE         Y02082 02961002
         BNZ   OPENERR                  BRANCH IF NOT SUCCESSFUL Y02082 02962002
         L     RX1,DCBDEBAD             LOAD DEB ADDRESS         Y02082 02963002
         LA    RX1,K0(RX1)              CLEAR HIGH-ORDER BYTE    Y02082 02964002
         SH    RX1,SIXTEEN              GET DEB PREFIX ADDRESS   Y02082 02965002
         MVC   DXDAADDR+K3(K5),K3(RX1)  MOVE IN FORMAT 1 CCHHR   Y02082 02966002
         LA    R0,DXCCW1                                         Y02082 02967002
         ST    R0,IOBSIOCC              MODIFY CCW PTR IN IOB    Y02082 02968002
         BAL   RLINK,RDDSCBT            GO READ F1 KEY AND DATA  Y02082 02969002
         LA    R5,DS1DSNAM+L'DS1DSNAM-K1  LAST BYTE OF DSNAME    YM2880 02969402
TESTDSN2 EQU   *                        SEARCH FOR NON-BLANK     YM2880 02969802
         CLI   K0(R5),BLANK             IS THIS ONE A BLANK      YM2880 02970202
         BNE   GETLNTH2                 BRANCH IF NO TO COMPUTE  YM2880X02970602
                                        LENGTH OF NAME FOR ENQ   YM2880 02971002
         BCT   R5,TESTDSN2              TRY NEXT BYTE            YM2880 02971402
GETLNTH2 EQU   *                        CALCULATE LENGTH         YM2880 02971802
         LA    R6,DS1DSNAM-K1           BYTE PRECEDING DSNAME    YM2880 02971902
         SR    R5,R6                    R5 HAS LENGTH FOR ENQ    YM2880 02972202
         LA    RX4,DS1DSNAM             POINT TO DATA SET NAME   Y02082 02972602
         L     R3,TCBJSCB               LOAD JSCB ADDRESS        Y02082 02972702
         USING IEZJSCB,R3               JSCB ADDRESSABILITY      Y02082 02973002
         L     R3,JSCBACT               GET ACTIVE JSCB ADDRESS  YM2887 02973402
         L     R3,JSCBTCBP              INITIATOR'S TCB ADDRESS  Y02082 02974002
         DROP  R3                                                Y02082 02975002
*                                                                       02976002
*** THIS SECTION ISSUES AN ENQ RET=CHNG ON SYSDSN.  REGISTER 4 POINTS   02977002
*   TO THE DSN, AND REGISTER 3 CONTAINS THE INITIATOR'S TCB ADDRESS.    02978002
*                                                                       02979002
DSNENQ2  EQU   *                        ENQ EXCLUSIVELY ON DSN   Y02082 02980002
         MVC   MJNAME(L'SYSDSN),SYSDSN  MAJOR RESOURCE NAME      Y02082 02981002
         MVC   ENQAREA(ENQLTH2),ENQLIST2  MOVE IN ENQ PARM LIST  Y02082 02982002
         ENQ   (MJNAME,(RX4),,(R5)),TCB=(R3),RET=CHNG,           YM2880X02983002
               MF=(E,ENQAREA)           ENQ EXCLUSIVELY ON DSN   YM2880 02984002
*                                                                       02985002
         LTR   R15,R15                  TEST RETURN CODE         Y02082 02986002
         BNZ   OPENERR                  BRANCH IF NOT SUCCESSFUL Y02082 02987002
*                                       SEARCH THE DEBS IF C/R   Y02082 02990002
*                                                                       02991002
*** THIS SECTION SEARCHES THE JOB'S DEBS TO ENSURE THAT THE CURRENT     02992002
*   JOB HAS NO OTHER DCB OPEN TO THE DATA SET.                          02993002
*                                                                       02993102
*        IF CALLED FROM CLOSE, WE WILL INSPECT EACH DEB IN       YM8507 02993202
*        THE JOB STEP'S DEB TABLE.                               YM8507 02993402
*        IF CALLED FROM EITHER CLOSE OR RESTART THE DEB CHAIN    YM8507 02993602
*        WILL BE SEARCHED (TCB DEB CHAIN FOR CLOSE, RESTART'S    YM8507 02993802
*        DEB CHAIN IF RESTART).                                  YM8507 02994002
*                                                                       02994202
DEBSRCH  EQU   *                        SEARCH DEBS              Y02082 02995002
         MODESET EXTKEY=ZERO            SWITCH TO KEY ZERO       Y02082 02995502
*                                                                       02998502
         STM   RXWKA,RLINK,IECREGSV+K12  SAVE SETLOCK REGISTERS  Y02082 02999002
         LR    R3,RXWKA                 SAVE WORK AREA BASE      YM8507 03000002
GETLOCK  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,  PREVENT DEBCHK  Y02082*03001002
               RELATED=(DEBTBL,IGG020P1(FREELOCK))               Y02082 03002002
         LM    RXWKA,RLINK,IECREGSV+K12-PRLSEWKA(R3)  RESTORE    YM8507 03003002
*                                                                       03003202
         TM    PTYPEFLG,FROMCR          TEST FOR RESTART         YM8507 03003402
         BZ    DTBLSRCH                 BR IF NO-SEARCH DEBTABLE YM8507 03003602
         L     R15,SVRBPTR              GET SVRB ADDRESS         YM8507 03003802
         L     R15,SVRBEXSA+(R7-R2)*K4(R15) GET RESTART'S R7     YM8507 03004002
         USING RSTWA,R15                RESTART WORKAREA         YM8507 03004202
         LA    R1,RSINT-K4              ADDR-4 OF FIRST DEB      YM8507 03004402
         DROP  R15                                               YM8507 03004602
         OI    PTYPEFLG,DCHNSRCH        SET CHAIN SEARCH ACTIVE  YM8507 03004802
         B     DEBCHAIN                 SEARCH CHAIN             YM8507 03005002
DTBLSRCH EQU   *                        SEARCH DEB TABLE         YM8507 03005202
         L     R1,TCBJSCB               LOAD JSCB ADDRESS        YM8507 03005402
         USING IEZJSCB,R1               JSCB ADDRESSABILITY      YM8507 03005602
         L     R1,JSCBDBTB              ADDR OF DEB TABLE        YM8507 03005802
         LTR   R1,R1                    IS ADDR ZERO             Y02082 03006002
         BZ    NOPENDS                  BRANCH IF YES            Y02082 03007002
         LH    R2,K0(,R1)               LAST ENTRY OFFSET        Y02082 03008002
         AR    R2,R1                    ADDRESS OF LAST ENTRY    Y02082 03009002
NXTDEB   EQU   *                        NEXT DEB                 Y02082 03010002
         TM    PTYPEFLG,DCHNSRCH        IS CHAIN SEARCH ACTIVE   YM8507 03010202
         BZ    NXTABLE                  BRANCH IF NO             YM8507 03010402
DEBCHAIN EQU   *                        NEXT DEB IN CHAIN        YM8507 03010602
         USING DEBBASIC,R3                                       YM8507 03010702
         ICM   R3,B'0111',DEBDEBAD-DEBBASIC+K1(R1) GET NEXT DEB  YM8507 03010802
         BZ    NOPENDS2                 NO MORE DEBS             YM8507 03010902
         LR    R1,R3                    SAVE DEB ADDRESS         YM8507 03011002
         TM    PTYPEFLG,FROMCR          TEST TO SEE IF, IN FACT, YM8507 03011202
*                                       RESTART CALLED US        YM8507 03011302
         BO    CRDCBDEB                 CHECK FOR CURRENT DEB    YM8507 03011402
         L     RXUSRDCB,DCBSAVE         COPIED DCB FROM CLOSE    YM8507 03011602
         CLM   R3,B'0111',DCBDEBAD+K1   CURRENT DEB              YM8507 03011802
         BE    DEBCHAIN                 BR IF YES-GET NEXT DEB   YM8507 03012002
         B     CHKDEB                   BR IF NO-CHECK DEB       YM8507 03012202
CRDCBDEB EQU   *                        RESTART DCB IS USER'S    YM8507 03012402
         CLC   DEBDCBAD+K1(K3),DCBSAVE+K1 CURRENT DEB            YM8507 03012602
         BE    DEBCHAIN                 BR IF YES-GET NEXT DEB   YM8507 03012802
         B     CHKDEB                   CHECK THE DEB            YM8507 03013002
NXTABLE  EQU   *                        NEXT DEB IN TABLE        YM8507 03013202
         LA    R1,K4(,R1)               POINT TO NEXT ENTRY      YM8507 03013402
         CR    R1,R2                    END OF DEB TABLE         YM8507 03013602
         BE    NOPENDS                  BRANCH IF YES            YM8507 03013802
         OC    K0(K4,R1),K0(R1)         EMPTY ENTRY              Y02082 03014002
         BZ    NOPENDS                  BRANCH IF YES            Y02082 03015002
         TM    K3(R1),ALLBITS           DELETED ENTRY            Y02082 03016002
         BO    NXTDEB                   BRANCH IF YES            Y02082 03017002
*                                       R1 POINTS TO A FULLWORD  Y02082 03018002
*                                       CONTAINING A DEB POINTER Y02082 03019002
         L     R3,K0(,R1)               LOAD DEB ADDRESS         Y02082 03020002
CHKDEB   EQU   *                        CHECK THE DEB            YM8507 03021202
         LA    R4,DEBBASIC-DEBAMTYP     OFFSET BACK TO DEBAMTYP  Y02082 03022002
         LCR   R4,R4                    MAKE OFFSET NEGATIVE     Y02082 03023002
         AR    R4,R3                    R4 POINTS TO DEBAMTYP    Y02082 03024002
         USING DEBAMTYP,R4                                       Y02082 03025002
         CLI   DEBAMTYP,K0              AMTYP ABSENT             Y02082 03026002
         BE    AMVALID                  BRANCH IF YES--VALID     Y02082 03027002
         CLC   DEBAMTYP,AMBPAM          BPAM DEB                 Y02082 03028002
         BE    AMVALID                  BRANCH IF YES--VALID     Y02082 03029002
         CLC   DEBAMTYP,AMBDAM          BDAM DEB                 Y02082 03030002
         BE    AMVALID                  BRANCH IF YES            Y02082 03031002
         CLC   DEBAMTYP,AMSAM           SAM DEB                  Y02082 03032002
         BE    AMVALID                  BRANCH IF YES            Y02082 03033002
         CLC   DEBAMTYP,AMEXCP          EXCP DEB                 Y02082 03034002
         BE    AMVALID                  BRANCH IF YES            Y02082 03035002
         CLC   DEBAMTYP,AMISAM          ISAM DEB                 Y02082 03036002
         BNE   NXTDEB                   BRANCH IF NO-THIS DEB    Y02082 03037002
*                                       NEED NOT BE CHECKED      Y02082 03038002
         CLI   DEBNMEXT,K1              0 OR ONE EXTENT IN ISAM  Y02082 03039002
*                                       DEB                      Y02082 03040002
         BNH   NXTDEB                   INVALID ISAM DEB         Y02082 03041002
         DROP  R4                                                Y02082 03042002
         SR    R4,R4                    ZERO FOR IC              Y02082 03043002
         IC    R4,DEBNMEXT              INSERT NUMBER OF EXTENTS Y02082 03044002
         BCTR  R4,K0                    REDUCE BY ONE            Y02082 03045002
         LA    R3,DEBNMTRK-DEBUCBAD+L'DEBNMTRK(,R3)  SKIP FIRST  Y02082 03046002
*                                       EXTENT FOR ISAM          Y02082 03047002
         B     CHKEXTNT                 GO TO CHECK EACH EXTENT  Y02082 03048002
AMVALID  EQU   *                        VALID AM TYPE            Y02082 03049002
         CLI   DEBNMEXT,K0              ARE THERE ANY EXTENTS    Y02082 03050002
         BZ    NXTDEB                   BRANCH IF NO             Y02082 03051002
         CLI   DEBEXSCL,DEBDADEV        IS EXTENT SCALE 4 FOR DA Y02082 03052002
         BNE   NXTDEB                   BRANCH IF NO             Y02082 03053002
         L     R4,DEBSUCBA              GET UCB ADDRESS          Y02082 03054002
         USING UCBOB,R4                                          Y02082 03055002
         LA    R4,K0(,R4)               CLEAR HIGH BYTE          Y02082 03056002
         LTR   R4,R4                    IS THERE A UCB           Y02082 03057002
         BZ    NXTDEB                   BRANCH IF NO             Y02082 03058002
         TM    UCBTBYT3,UCB3DACC        IS IT DIRECT ACCESS      Y02082 03059002
         BZ    NXTDEB                   BRANCH IF NO             Y02082 03060002
         DROP  R4                                                Y02082 03061002
         SR    R4,R4                    ZERO FOR IC              Y02082 03062002
         IC    R4,DEBNMEXT              NUMBER OF EXTENTS        Y02082 03063002
CHKEXTNT EQU   *                        CHECK EXTENT             Y02082 03064002
         LA    R3,DEBBASND              INCREMENT PAST BASIC     Y02082 03065002
*                                       SECTION OF DEB           Y02082 03066002
         USING DEBDASD,R3                                        Y02082 03067002
CMPREXTS EQU   *                        CHECK CCHH               Y02082 03068002
         CLC   DEBUCBA,DXDEBUCB+K1      TEST IF SAME UCB         YM4653 03068402
         BNE   NEXTXTNT                 BRANCH IF NOT            YM4653 03068802
         CLI   DSCEXTYP,DS1EXTUL        IS FIRST EXTENT USER LBL Y02082 03069002
         BNE   NOTUL                    BRANCH IF NOT            Y02082 03070002
         CLC   DEBSTRCC(L'DEBSTRCC+L'DEBSTRHH),DSCEXT1+K2  IS    YM5709X03071002
                                        THE DEB'S STARTING CCHH  YM5709X03072002
                                        EQUAL TO THE DSCB'S      YM5709 03073002
         BE    NOPRLSE                  BRANCH IF YES            Y02082 03074002
         B     NEXTXTNT                 GET NEXT EXTENT          Y02082 03075002
NOTUL    EQU   *                        NOT USER LBL EXTENT      Y02082 03076002
         CLC   DEBSTRCC(L'DEBSTRCC+L'DEBSTRHH),DSCLOWLM  IS      YM5709X03077002
                                        THE DEB'S STARTING CCHH  YM5709X03078002
                                        EQUAL TO THE DSCB'S      YM5709 03079002
         BE    NOPRLSE                  BRANCH IF YES            Y02082 03080002
NEXTXTNT EQU   *                        NEXT EXTENT              Y02082 03081002
         LA    R3,DEBNMTRK+L'DEBNMTRK   INCREMENT TO NEXT EXTENT YM4653 03082002
         BCT   R4,CMPREXTS              TRY NEXT EXTENT          Y02082 03083002
         B     NXTDEB                   NO MORE EXTENTS          Y02082 03084002
NOPRLSE  EQU   *                        OPEN DATA SET ERROR      Y02082 03085002
         LA    R3,OPENERR               SET UP BRANCH ADDRESS AS Y02082 03086002
*                                       THE DATA SET IS OPEN AND Y02082 03087002
*                                       CANNOT BE RELEASED       Y02082 03088002
         B     FREELOCK                 FREE THE LOCAL LOCK      Y02082 03089002
NOPENDS  EQU   *                        GET BRANCH ADDR          Y02082 03090002
         TM    PTYPEFLG,DCHNSRCH        DEB CHAIN SEARCH ACTIVE  YM8507 03090202
         BO    NOPENDS2                 BR IF YES-SEARCHING DONE YM8507 03090402
         L     R3,CVTPTR                CVT ADDR                 YM8507 03090602
         L     R3,CVTTCBP-CVT(,R3)      TCB POINTERS             YM8507 03090802
         L     R3,K4(,R3)               TCB ADDRESS              YM8507 03091002
         LA    R1,TCBDEB-TCB-K4(,R3)    ADDRESS-4 OF FIRST DEB   YM8507 03091202
         OI    PTYPEFLG,DCHNSRCH        SET CHAIN SEARCH ACTIVE  YM8507 03091402
         B     DEBCHAIN                 START DEB CHAIN SEARCH   YM8507 03091602
NOPENDS2 EQU   *                        ABSOLUTELY NO OPEN D.S.  YM8507 03091802
         LA    R3,GETFDAD               SET UP BRANCH ADDRESS    YM8507 03092002
*                                                                       03092202
FREELOCK EQU   *                        RELEASE LOCAL LOCK       YM8507 03092402
         NI    PTYPEFLG,ALLBITS-DCHNSRCH CHAIN SEARCH INACTIVE   YM8507 03092602
         LR    R1,RXWKA                 SAVE WORK AREA BASE      Y02082 03093002
         STM   RXWKA,RLINK,IECREGSV+K12  SAVE SETLOCK REGISTERS  Y02082 03094002
         SETLOCK RELEASE,TYPE=LOCAL,    RELEASE LOCAL LOCK       Y02082*03095002
               RELATED=(DEBTBL,IGG020P1(GETLOCK))                Y02082 03096002
         LM    RXWKA,RLINK,IECREGSV+K12-PRLSEWKA(R1)  RESTORE    Y02082 03098002
         TM    PTYPEFLG,FROMCR          TEST IF ENTRY FROM C/R   YM8507 03098102
         BOR   R3                       BRANCH IF C/R-STAY KEY 0 YM8507 03098202
         MODESET EXTKEY=DATAMGT         RETURN TO DATAMGT KEY    Y02082 03098502
         BR    R3                       RETURN                   Y02082 03099002
*                                                                       03099502
GETFDAD  MVC   MBBCCHHR+K3(K4),DCBFDAD+K3  INSERT NEW CCHH       Y02082 03100002
         MVC   USEXTNUM,DCBFDAD         SAVE M OF USER'S DCBFDAD Y02082 03101002
         LA    R6,ENTRIES                                        Y02082 03102002
         SR    R5,R5                    CLEAR COUNT REGISTER     Y02082 03103002
         TM    JFCBCTRI,JFCBCYL         TEST IF A CYLINDER REQ   Y02082 03104002
         BO    ROUNDCYL                 BRANCH IF A CYL REQUEST  Y02082 03105002
         TM    JFCBCTRI,JFCBAVR+JFCROUND  TEST IF A ROUNDED      Y02082 03106002
*                                       RECORD REQUEST           Y02082 03106502
         BNO   SAVEFMT3                 BRANCH IF NOT            Y02082 03107002
*                                                                       03108002
*** THIS SECTION CHECKS TO SEE IF THE LAST TRACK WRITTEN WAS CYLINDER   03109002
*   ALIGNED. IF NOT, IT ROUNDS THE EXTENT TO BE RELEASED TO THE         03110021
*   NEXT CYLINDER.                                                      03120021
*                                                                       03140000
ROUNDCYL LA    R4,1                         YES-SET CONVERSION COUNT.   03160000
         MVC   HOLD(4),DCBFDAD+3            GET LAST ACTIVE TRACK.      03180000
         BAL   RLINK,RTACVT             *** CONVERT CCHH TO RTA         03200000
         LH    R9,ENTRIES                   PICK UP LAST ACTIVE TRK RTA 03220000
         SR    R8,R8                        CLEAR REG FOR DIVISION.     03240000
         LH    R0,DS4DEVSZ+2                PICK UP NO OF TRKS/CYL.     03260000
         DR    R8,R0                        DETERMINE CYL ALIGNMENT     03280000
         BCTR  R0,0                         SET R0 TO LAST TRACK OF CYL 03300000
         CLR   R0,R8                        IS REMAINDER EQ TO LAST TRK 03320000
         BE    SAVEFMT3                     YES-EXTENT IS CYL ALIGNED.  03340000
         OI    DADSMTBL,X'01'               TURN ON ROUND BIT.          03360000
         MH    R9,DS4DEVSZ+2                CONVERT CYL'S TO TRKS.      03380000
         AR    R0,R9                        ROUND RTA TO CYL ALGNMENT   03400000
         SLL   R0,16                        POSITION TT00.              03420000
         LA    R2,MBBCCHHR                  GET POINTER TO SAVE AREA.   03440000
*                                                                       03460000
*** THIS SECTION DETERMINES WHETHER THE EXTENT THAT CONTAINS THE        03480021
*   LAST TRACK WRITTEN IS LOCATED IN THE FORMAT 1 OR FORMAT 3 DSCB.     03500021
*                                                                       03520000
         BAL   RLINK,CCHHCVT                CONVERT ROUNDED EXT TO CCHH 03540000
SAVEFMT3 MVC   DXDAADDR+3(5),DSCNEXT        SAVE                        03560000
         MVC   OUTCCHHR(5),DSCNEXT           CHAIN ADDRESS              03580000
         LA    R6,ENTRIES                   RESTORE DADSMTBL PTR.       03600000
         L     R9,DCBSAVE               RESTORE USER'S DCB PTR   A39292 03610021
         CLI   DSCEXTYP,X'40'           TEST FOR USER LABEL.            03625013
         BNE   NOLABEL                  BR-IF NO USER LABEL EXTENT.     03630013
         IC    R8,USEXTNUM              GET M OF DCBFDAD         Y02080 03635002
         LA    R8,1(R8)                 ACCOUNT FOR USER LABEL EXTENT.  03640013
         STC   R8,USEXTNUM              SAVE UPDATED M           Y02080 03645002
NOLABEL  EQU   *                                                        03650013
         CLI   USEXTNUM,K2              IS EXTENT IN F1 OR F3    Y02080 03655002
         BNH   F1RUTINE                     ENTRY IS IN F1-PROCESS IT.  03660000
         CLI   DSCNEXT+4,X'00'              OTHERWISE TEST FOR F3.      03680000
         BNE   OUT                      GO READ F3 IF PRESENT   SA54549 03700002
F1EXNOER EQU   *                                                 O19117 03708019
         LA    ERRETREG,NOTINF1         SET ERROR CODE           A37199 03718021
WRITF1   EQU   *                                                SA54549 03728002
         LA    R3,D0                    PREPARE TO XCTL TO      SA54549 03730002
*                                       IGG020D0 TO WRITE       SA54549 03730402
*                                       BACK FORMAT 1           SA54549 03730802
         B     XCTL                                             SA54549 03731202
*                                                                       03760000
***  THIS LOCATES THE PROPER EXTENT IN THE FORMAT 1 DSCB CONTAINING THE 03780000
*    LAST TRACK WRITTEN,AND THEN TESTS FOR CYLINDER TYPE ALLOCATION.    03800000
*                                                                       03820000
F1RUTINE XC    DSCNEXT(5),DSCNEXT           CLEAR CHAIN ADDR OF F1.     03840000
         MVI   INCCHHR+4,X'FF'              INDICATE EXTENT IS IN F1.   03860000
         LA    R7,DSCEXTYP                                              03880000
         LA    R8,DSCEXT2+10                SET UP END OF EXTNTS PTR.   03900000
         SR    R3,R3                        CLEAR REGISTER.             03920000
         IC    R3,USEXTNUM              GET M OF DCBFDAD         Y02080 03940002
         MH    R3,TEN                                                   03960000
         AR    R7,R3                        LOCATE PROPER EXT IN F1.    03980000
         TM    JFCBCTRI,X'C0'           WAS THIS A CYLINDER       17305 03990016
*                                       REQUEST                   17305 04000016
         BO    CYLREQ                       BRANCH IF CYLINDER.         04020000
         TM    JFCBCTRI,X'41'           WAS ROUNDED RECORD        17305 04030016
*                                       REQUESTED                 17305 04040016
         BO    CYLREQ                       BR-IF REC ROUNDED REQ.      04060000
         MVI   0(R7),X'01'                  NO-TURN OFF CYL ALGNMNT BIT 04080000
CYLREQ   CLC   6(4,R7),MBBCCHHR+3           CHECK FOR LAST TRK OF EXT.  04100000
UPDATE   LA    R7,10(R7)      UPDATE SCAN REG TO NEXT EXTENT     A25991 04120019
         BE    CHECKLST                     CHECK FOR LAST TRK IF LAST  04140000
         SH    R7,TEN                       DECREMENT SCAN REG IF NOT   04160000
*                                           LAST TRACK OF EXTENT.       04180000
         CLC   MBBCCHHR+3(4),2(R7)      IS CCHH IN THIS EXTENT.   17305 04190016
         BL    F1EXNOER                 BR TO ERROR IF NOT.             04200013
         MVC   HOLD+4(4),6(R7)              SAVE PREVIOUS CCHH.         04320000
         EX    0,CYLREQ        CCHH WITHIN EXTENT                 18924 04323000
         BH    WITHIN          YES,CONTINUE                       18924 04326000
         EX    0,GETFDAD  FALL BACK TO LAST TRK ACT USED          18924 04329000
         EX    0,CYLREQ       IS CCHH OF LAST TRK WITHIN EXTENT  A25991 04330019
         BL    F1EXNOER       NO, IT IS BEYOND END-OF-EXTENT     A25991 04331019
         B     UPDATE         BRANCH TO TRY AGAIN                A25991 04333019
*                                                                       04333321
*** THIS SECTION SETS UP THE CCHH PARAMETERS TO BE CONVERTED TO         04333621
*   STARTING RTA AND ENDING RTA+1. IT THEN PLACES THESE RTA'S IN        04333921
*   THE EXTENT TABLE.                                                   04334221
*                                                                       04334521
WITHIN   EQU   *                                                  18924 04335000
         MVC   6(4,R7),MBBCCHHR+3           INSERT NEW CCHH.            04340000
         MVC   HOLD(4),MBBCCHHR+3           SAVE NEW CCHH OF EXT USED.  04360000
         BAL   RLINK,CVTORTA                CONVERT RELSED CCHH TO RTA. 04380000
         LH    R9,ENTRIES                                               04400000
         LA    R9,1(R9)                     INCREMENT FIRST ENTRY       04420000
         STH   R9,ENTRIES                   FOR AVAIL INDICATION.       04440000
         L     R9,DCBSAVE               RESTORE USER'S DCB PTR   A39292 04460021
CHECKLST CLR   R7,R8                        IS THIS THE LAST EXTENT     04480000
         BE    OUT                      YES - GO TO NEXT LOAD   SA54549 04500002
*                                       OF PARTIAL RELEASE      SA54549 04510002
         CLI   0(R7),0                      NO-IS THIS EXTNT ZERO       04520000
         BE    OUT                          YES-XCTL TO NEXT LOAD       04540000
         MVC   HOLD(8),2(R7)                GET EXT FOR DADSM UPDATE.   04560000
         XC    0(10,R7),0(R7)               CLEAR F1 RELEASED EXTENT.   04580000
         BAL   RLINK,CVTORTA                CONVERT EXTEXT TO RTA FOR   04600000
         B     CHECKLST                     CHECK FOR LAST EXTENT.      04620000
*                                                                       04860019
* * THIS SECTION BRANCHES TO ANOTHER LOAD OF PARTIAL RELEASE.           04880002
*                                                                       04900019
OUT      EQU   *                                                 O19117 04920019
         LA    R3,NEXTXCTL              FETCH NEXT LOAD PNTR     O19117 04940019
XCTL     EQU   *                                                 O19117 04960019
         IECRES LOAD,EXTPR=(RXWKA),MODNM=(R3),BRANCH=DIRECT      Y02080 05000002
*                                                                       05100000
*** THIS SECTION SETS UP LINKAGE TO THE CVT ROUTINE.                    05120000
*                                                                       05140000
CCHHCVT  L     R15,CVTPTR                                               05160000
         USING CVT,R15                                           YM8507 05162002
         L     R15,CVTPCNVT                 SET UP BASE AND ENTRY-CVT   05180000
         LA    R4,1                         INSERT LOOP COUNT.          05200000
         LA    R6,ENTRIES                   PICK UP DADSM TABLE PTR.    05220000
         B     CCHHLINK                     GO TO CONVERT RTA TO CCHH.  05240000
CVTORTA  LA    R4,2                         INSERT COUNT                05260000
RTACVT   L     R15,CVTPTR                                               05280000
         L     R15,CVTPRLTV                 SET UP BASE  FOR CVT ROUT.  05300000
         MVC   MBBCCHHR+3(4),HOLD           MOVE CCHH TO BE CONVERTED.  05320000
         LA    R2,MBBCCHHR                  POINT TO CCHH AREA.         05340000
CCHHLINK EQU   *                                                 A39292 05350021
         STM   R9,R15,SAVEREGS          SAVE REGISTERS           A39292 05360021
         NI    CONVCON+1,X'00'         ZERO RTA INCREMENT               05380000
         LR    R3,RXWKA                 SAVE WORKAREA REGISTER   A39292 05400021
         LA    R1,DXDEB                     PICK UP DEB PTR.            05420000
CVTLINK1 BALR  RLINK,R15                    CONVERT CCHH TO RTA.        05440000
         LM    RXWKA,RXBASE,8+SAVEREGS-FIRST(R3)  RESTORE RLSE   A39292 05460021
*                                       WORKAREA AND BASE REGS   A39292 05480021
         SRL   R0,16                                                    05500000
         AH    R0,CONVCON                                               05520000
         STH   R0,0(R6)                     STORE RTA INTO DADSNTBL.    05540000
         LA    R6,2(R6)                     INCREMENT DADSMTBL PTR.     05560000
         XI    CONVCON+1,1                  FLIPFLOP RTA INCREMENT.     05580000
         BCT   R4,FLIPFLOP                  CONTINUE IF COUNT NOT ZERO. 05600000
         LM    R9,R15,SAVEREGS-FIRST(R3)  RESTORE VOLATILE REGS  A39292 05620021
         BR    RLINK                        RETURN.                     05640000
FLIPFLOP EQU   *                                                        05660000
         MVC   MBBCCHHR+3(4),HOLD+4         PICK UP NEXT EXTENT.        05680000
         LA    R5,1(R5)                     INCREMENT ENTRY NO IN TBL.  05700000
         LA    R7,10(R7)                    UPDATE F1 EXTENT PTR.       05720000
         L     R15,24+SAVEREGS-FIRST(R3)  RESTORE CVT POINTER    A39292 05740021
         B     CVTLINK1                     LOOP TO CONVERT NEXT EXTNT  05760000
*                                                                       06040000
*** THIS LOCATES THE SUPERVISOR REQUEST BLOCK OF WHICH ITS EXTENSION    06060000
*   IS USED AS A REGISTER SAVE AREA.                                    06080000
*                                                                       06100000
FINDSVRB L     R15,CVTPTR                   PICK UP CVT POINTER.        06120000
         L     R15,CVTTCBP                  GET POINTER TO TCB ADDR.    06140000
         L     R15,4(R15)                   GET POINTER TO CURRENT TCB. 06160000
         L     R15,0(R15)                   PICK UP SVRB ADDR.          06180000
         ST    R15,SVRBPTR                  SAVE POINTER TO SVRB.       06200000
         BR    RLINK                        SAVE VOL REGS IN SVRB.      06220000
*                                                                       06240000
*** THIS SECTION INITIATES THE CHANNEL PROGRAM.                         06260000
*                                                                       06280000
RDDSCBT  EQU   *                                                SA53147 06300002
         EXCP  DXIOB                        READ DSCB                   06340000
         WAIT  ECB=DXECB                    WAIT FOR COMPLETION.        06360000
         TM    DXECB,X'20'                  TEST FOR PERM I/O ERR.      06380000
         BCR   5,RLINK                      RETURN IF NO I/O ERR.       06400000
         LA    ERRETREG,IOERROR         LOAD I/O ERROR CODE      A37199 06410021
LEAVE    EQU   *                                                SA54549 06420002
         LA    R3,PRECLOSE              PREP FOR LAST LOAD      SA54549 06422002
         B     XCTL                                             SA54549 06424002
*                                                                       06430021
*** CHANNEL PROGRAM                                                     06440021
*                                                                       06450021
         DS    0F                                                       06460000
CCWX1    DC    X'31'                                                    06480000
         DC    AL3(DXDAADDR+3-CLOSEWKA)                                 06500000
         DC    X'4000'                                                  06520000
         DC    H'5'                                                     06540000
CCWX2    DC    X'08'                                                    06560000
         DC    AL3(DXCCW1-CLOSEWKA)                                     06580000
         DC    F'0'                                                     06600000
CCWX3    DC    X'0E'                    READ F1 KEY AND DATA     Y02082 06620002
         DC    AL3(OUTDSCB-PRLSEWKA)    DATA ADDR                Y02080 06640002
         DC    H'0'                     NO COMMAND CHAINING      Y02082 06660002
         DC    H'140'                                                   06680000
*CCWX4                                      SAME AS CCWX1.              06700000
*CCWX5                                      TIC TO CCW4                 06720000
CCWX6    DC    X'06'                    READ DATA COMMAND       SA53147 06740002
         DC    AL3(IECSDSL4-PRLSEWKA)   ADDR OF READ AREA        Y02080 06760002
         DC    X'4000'                  COMMAND CHAINING        SA53147 06764002
         DC    H'96'                    LENGTH OF 96 BYTES      SA53147 06768002
CCWX7    DC    X'92'                        READ COUNT FOR F5 DSCB.     06780000
         DC    AL3(DADSMADR-PRLSEWKA)   ADDRESS OF F5 CCHHR      Y02080 06800002
         DC    X'2000'                                                  06820000
         DC    H'5'                                                     06840000
*                                                                       06845021
*** CONSTANTS                                                           06850021
*                                                                       06855021
TEN      DC    H'10'                                                    06860000
SIXTEEN  DC    H'16'                    SIXTEEN BYTES            Y02082 06865002
ECCHHTRK DC    4X'FF'                   ENDING CCHH MOVED INTO  SA54549 06870002
*                                       DEB ALONG WITH NEXT TWO SA54549 06872002
*                                       CONSTANTS               SA54549 06874002
         DC    X'7F'                    1ST BYTE OF TRACKS TO   SA54549 06876002
*                                       BE MOVED INTO DEB       SA54549 06878002
ENABLE   DC    X'FF'                    ENABLE INTERRUPTS PLUS  SA54549 06880002
*                                       USED AS LAST BYTE OF    SA54549 06890002
*                                       TRACKS MOVED INTO DEB   SA54549 06892002
SYSZTIOT DC    CL8'SYSZTIOT'            TIOT MAJOR RESOURCE NAME Y02082 06894002
SYSDSN   DC    CL8'SYSDSN'              DSN MAJOR RESOURCE NAME  Y02082 06896002
VTOCNAME DC    CL8'SYSVTOC '                                            06900000
ENQLIST  ENQ   (,,E,6,SYSTEM),RET=CHNG,MF=L  TIOT ENQ PARM LIST  Y02082 06902002
ENQLTH   EQU   *-ENQLIST                LENGTH OF ENQ PARM LIST  Y02082 06904002
ENQLIST1 ENQ   (,,E,,SYSTEM),RET=USE,MF=L  FIRST DSN ENQ LIST    YM2880 06906002
ENQLTH1  EQU   *-ENQLIST1               LENGTH OF ENQ PARM LIST  Y02082 06908002
ENQLIST2 ENQ   (,,E,,SYSTEM),RET=CHNG,MF=L  2ND DSN ENQ LIST     YM2880 06910002
ENQLTH2  EQU   *-ENQLIST2               LENGTH OF ENQ PARM LIST  Y02082 06912002
*                                                                       06920002
*        DEB ACCESS METHOD TYPE VALUES                                  06922002
*                                                                       06924002
AMBPAM   DEBCHK AM=BPAM,MF=L            BPAM AMTYPE              Y02082 06926002
AMBDAM   DEBCHK AM=BDAM,MF=L            BDAM AMTYPE              Y02082 06928002
AMSAM    DEBCHK AM=SAM,MF=L             SAM AMTYPE               Y02082 06930002
AMEXCP   DEBCHK AM=EXCP,MF=L            EXCP AMTYPE              Y02082 06932002
AMISAM   DEBCHK AM=ISAM,MF=L            ISAM AMTYPE              Y02082 06934002
*                                                                       06942002
*** TABLE OF MODULE NAMES AND ENTRY POINT ADDRESSES                     06944002
*                                                                       06946002
         XCTLTABL ID=(FIRSTLD,IGG020P1,NEXTXCTL,IGG020P2,        Y02080X06948002
               D0,IGG020D0,PRECLOSE,IGG020P3,RPS19EK,IGG019EK),  YM3997X06950002
               SVC=020,LENGTH=,BRT=YES                           Y02080 06970002
         SPACE 2                                                 Y02144 06980002
         IECDSECS ASCB,CVT,IEZDEB,JSCB,PSA,TCB,RRPL,UCB,         Y02082X07000002
               EXPAND=YES                                        Y02082 07010002
*                                                                       07025021
*** RELEASE WORK AREA                                                   07030021
*                                                                       07035021
WORKAREA IECPRLWA EP,F4,D2=(1),ADT=YES  RELEASE WORK AREA        Y02144 07040002
SAVEREGS EQU   IECREGSV+12              REGISTER SAVE AREA       Y02080 07550002
         EJECT                                                  SA54549 07562002
*                                                                       07565021
*** I/O SUPPORT WORK AREA                                               07570021
*                                                                       07575021
CLOSEWKA DSECT                                                          07580000
         IECDSECT                                                       07600000
MINAME   EQU   DXCCW8+K2                ENQ MINOR NAME           Y02082 07700002
MJNAME   EQU   DXCCW9                   ENQ MAJOR NAME           Y02082 07720002
ENQAREA  EQU   DXCCW11                                             AAAA 07750016
         EJECT                                                          07760002
         DCBD  DSORG=(PS)                                               07780000
         EJECT                                                          07840002
         IEEVRSWA VER=3                 RESTART WORKAREA         YM8507 07840202
         END                                                            07860000
