         TITLE 'IGG0210A - SECOND LOAD OF BPAM STOW ROUTINE'            00100021
IGG0210A CSECT                                                          00200021
         SPACE                                                          00300021
*********************************************************************** 00400021
*                                                                     * 00500021
* MODULE NAME = IGG0210A                                              * 00502002
*                                                                     * 00504002
* DESCRIPTIVE NAME = SECOND LOAD OF BPAM STOW ROUTINE                 * 00506002
*                                                                     * 00508002
* COPYRIGHT = NONE                                                    * 00510002
*                                                                     * 01000021
* STATUS = RELEASE VS2-4, LEVEL 04/07/78                              * 01100037
*                                                                     * 01102002
*                                                                     * 01600021
* FUNCTION = WRITES AN EOD MARKER FOLLOWING THE LAST MEMBER WRITTEN   * 01700002
*            IF THE FOLLOWING CONDITIONS ARE MET:                     * 01800002
*            1 - THE FUNCTION REQUESTED IS AN ADD OR A REPLACE.       * 02000002
*            2 - THE ENTRY BEING ADDED OR REPLACED IS NOT AN ALIAS.   * 02100002
*            3 - THE USER'S DCB IS NOT OPEN FOR RDBACK OR UPDATE.     * 02200002
*            4 - THE LAST I/O OPERATION PERFORMED BY THE CALLER WAS A * 02300002
*                WRITE.                                               * 02300402
*                                                                     * 02400021
*            RETURNS, TO THE CALLER, THE TTR OF THE LAST MEMBER       * 02500002
*            WRITTEN IF THE FOLLOWING CONDITIONS ARE MET:             * 02600002
*            1 - THE FUNCTION REQUESTED IS AN ADD OR A REPLACE.       * 02700002
*            2 - THE ENTRY BEING ADDED OR REPLACED IS NOT AN ALIAS.   * 02800002
*                                                                     * 02900021
*            BUILDS, IN THE STOW WORK AREA, THE CHANNEL PROGRAM USED  * 03000002
*            BY THE THIRD LOAD (IGG021AB) TO PERFORM THE I/O OPERA-   * 03100002
*            TIONS ON THE DIRECTORY NECESSARY TO ACCOMPLISH THE       * 03200002
*            FUNCTION REQUESTED.                                      * 03202002
*                                                                     * 03204002
*                                                                     * 03300021
* NOTES = SEE BELOW                                                   * 03302002
*                                                                     * 03304002
*    DEPENDENCIES = NONE                                              * 03306002
*                                                                     * 03308002
*    RESTRICTIONS = NONE                                              * 03310002
*                                                                     * 03312002
*    REGISTER CONVENTIONS = SEE REGISTER EQUATES BELOW                * 03314002
*                                                                     * 03316002
*    PATCH LABEL = PATCH                                              * 03318002
*                                                                     * 03318402
*                                                                     * 03320002
* MODULE TYPE = SVC ROUTINE                                           * 03322002
*                                                                     * 03324002
*    ATTRIBUTES = REENTRANT, ENABLED, PRIVILEGED, ENTERED IN          * 03326002
*                 SUPERVISOR KEY AND ISSUES A MODESET TO RUN IN THE   * 03328002
*                 CALLER'S KEY.                                       * 03330002
*                                                                     * 03332002
*                                                                     * 03400021
* ENTRY POINT = IGG0210A                                              * 03500002
*                                                                     * 03800021
*    LINKAGE = THIS ROUTINE RECEIVES CONTROL FROM THE                 * 03802003
*              FIRST LOAD OF STOW - IGC0002A.                         * 03804002
*                                                                     * 03806002
*    INPUT = THE FOLLOWING PARAMETERS ARE PASSED WHEN CONTROL IS      * 03900002
*            RECEIVED AS DESCRIBED ABOVE.                             * 04100002
*            REGISTER 10 - CONTAINS THE ADDRESS OF STOW'S WORK AREA.  * 04200002
*            REGISTER 11 - CONTAINS THE ADDRESS OF THE CALLER'S DCB.  * 04300002
*                                                                     * 04500021
*    OUTPUT = SAME REGISTERS AS INPUT.  FOR THE FUNCTIONS OF ADD OR   * 04600002
*             REPLACE WITHOUT THE ALAIS OPTION, THE BEGINNING RELATIVE* 04800002
*             ADDRESS (TTR) OF THE MEMBER ADDED OR REPLACED IS        * 05000002
*             RETURNED WITHIN THE TTR FIELD OF THE PARAMETER LIST     * 05100002
*             PASSED TO STOW.                                         * 05200002
*                                                                     * 05400021
*    EXITS-NORMAL = BRANCHES TO IGG021AB.                             * 05402003
*                                                                     * 05408002
*    EXITS-ERROR = RETURNS TO THE CALLER VIA A BR 14 WITH REASON CODE * 05410002
*                  REGISTER 0 AND RETURN CODE REGITSER 15 CONTAINING  * 05412002
*                  THE FOLLOWING:                                     * 05414002
*                  REG 0   REG 15              CONDITION              * 05416002
*                    2       16  - AN I/O ERROR OCCURED WHILE WRITING * 05418002
*                                  AN EOD MARKER AFTER THE MEMBER.    * 05420002
*                                                                     * 05420402
*                                                                     * 05422002
* EXTERNAL REFERENCES = SEE BELOW                                     * 05500002
*                                                                     * 05502002
*    ROUTINES = IECPRLTV - USED TO CONVERT AN ABSOLUTE DIRECT ACCESS  * 05504002
*               ADDRESS, MBBCCHHR, TO ITS RELATIVE EQUIVALENT, TTRN.  * 05600002
*                                                                     * 05602002
*               IECPCNVT - CONVERTS A RELATIVE DIRECT ACCESS ADDRESS  * 05800002
*               AND CONCATENATION NUMBER, TTRN, TO ITS ABSOLUTE       * 05900002
*               EQUIVALENT, MBBCCHHR.                                 * 06000002
*                                                                     * 06000402
*               MODESET - USED TO CHANGE THE STORAGE PROTECT KEY.     * 06002002
*                                                                     * 06200021
*               SETLOCK - USED TO OBTAIN AND RELEASE THE LOCAL LOCK.  * 06202002
*                                                                     * 06204002
*               DEBCHK - USED TO VERIFY THE CALLER'S DEB ADDRESS.     * 06206002
*                                                                     * 06208002
*               ABEND(SVC 13) - USED TO ABEND THE USER WITH A SYSTEM  * 06210002
*               COMPLETION CODE OF 115 IF DEBCHK IS NOT SUCCESSFUL.   * 06212002
*                                                                     * 06214002
*               EOV(SVC 55) - USED TO EXTEND THE DATA SET WHEN THE    * 06300002
*               CURRENT EXTENT DOES NOT CONTAIN SUFFICIENT SPACE TO   * 06400002
*               WRITE AN EOD MARKER.                                  * 06500002
*                                                                     * 06600021
*               EXCP(SVC 0) AND WAIT(SVC 1) - ARE USED TO PERFORM I/O * 06700002
*               OPERATIONS.                                           * 06702002
*                                                                     * 06704002
*               FREEMAIN(SVC 10) - IS USED TO FREE STOW'S WORK AREA   * 06800002
*               IN THE EVENT OF AN I/O ERROR.                         * 06900002
*                                                                     * 08200021
*    DATA AREAS = NONE                                                * 08202002
*                                                                     * 08204002
*    CONTROL BLOCKS = CVT,DCB,DEB,DVCT,ECB,IOB,PSA,SVRB,TCB           * 08206002
*                                                                     * 08206402
*                                                                     * 08208002
* TABLES = THIS MODULE USES THE STOW WORK AREA, THE FORMAT AND        * 08300002
*          CONTENTS OF WHICH ARE DESCRIBED IN THE DSECT AT THE END OF * 08400002
*          THE LISTING.                                               * 08402002
*                                                                     * 08404002
*                                                                     * 08600021
* MACROS = ACTION MACROS - MODESET,SETLOCK,ABEND,EOV,EXCP,WAIT,       * 08700002
*             FREEMAIN                                                * 08702003
*                                                                     * 09000021
*          MAPPING MACROS - CVT,DCBD,IEZDEB,IHADVCT,IHAPSA,IHARB,     * 09002002
*             IHASTOW,IKJTCB,IGGSTW                                   * 09004002
*                                                                     * 09006002
*                                                                     * 09500021
* CHANGE ACTIVITY = AS FOLLOWS:                                       * 09600002
*                                                                     * 09600402
*          RELEASE 21 DELETIONS                                       * 09602002
*    THIS MODULE WAS REWRITTEN FOR RELEASE 21.  THE FOLLOWING APARS   * 09602402
*    WERE CORRECTED.  28169, 33374, 35322, 42484, AND 43923.          * 09602802
*                                                                 M0965 09604002
*                                                               SA66881 09604437
*          VS1 RELEASE 01 DELETIONS                                   * 09606002
*                                                                XM5415 09608002
*          VS1 RELEASE 02 DELETIONS                                   * 09608402
*                                                                XM9034 09608802
*          VS1 RELEASE 03 DELETIONS                                   * 09609002
*                                                               XA02388 09609202
* SEE CODE FLAGGED SA66881 FOR APAR XA03384                     XA03384 09609637
*          VS1 RELEASE 04 DELETIONS                                     09609737
* SEE CODE FLAGGED YA06505 FOR APAR XA06889                     XA06889 09609837
*          VS2 RELEASE 01 DELETIONS                                   * 09610002
*D365000                                                         YM0943 09612002
*                                                               YA06505 09612437
*          VS2 RELEASE 02 DELETIONS                                   * 09614002
*D001500,005500,008200,138000-140000,260000,271000-273000,288000,Y02072 09616002
*D292000,294000,300000-302000,410000-411000,413000,421000-422000,Y02072 09618002
*D482000-483000,485000-486000,493000-669000                      Y02072 09620002
*                                                                YM5733 09620402
*          VS2 RELEASE 03 DELETIONS                                   * 09670403
*                                                              @Z30TSMI 09677837
*          VS2 RELEASE 04 DELETIONS                                     09692637
* SEE CODE FLAGGED YA06505 AND SA66881 FOR APAR ZA01548         ZA01548 09700037
*A364000-364500,365500,481006-481012                           @ZA12202 09730037
*                                                              @ZA12202 09760037
*C481006-481012                                                @ZA31380 09780037
*A254000-256800,270200                                         @ZA31380 09786037
*D298000                                                       @ZA31777 09793037
*********************************************************************** 09800021
         EJECT                                                          09900021
*********************************************************************** 10000021
****                                                               **** 10100021
****     REGISTER EQUATES                                          **** 10200021
****                                                               **** 10300021
*********************************************************************** 10400021
         SPACE                                                          10500021
R0       EQU   0                        WORK/PARAMETER REGISTER         10600021
R1       EQU   1                        WORK/PARAMETER REGISTER         10700021
RDEB     EQU   R1                       DEB ADDRESS                     10800021
R2       EQU   2                        WORK REGISTER                   10900021
REXTNO   EQU   R2                       NUMBER OF DEB EXTENTS    Y02072 10950002
R3       EQU   3                        WORK REGISTER                   11000021
RCVT     EQU   R3                       CVT ADDRESS                     11100021
R4       EQU   4                        WORK REGISTER                   11200021
RDEVTBL  EQU   R4                       ADDR OF DEVICE CHAR TABLE       11300021
R5       EQU   5                        WORK REGISTER                   11400021
RVOLSEQ  EQU   R5                       USED TO SAVE DEBVOLSEQ   Y02072 11450002
RAREA    EQU   6                        POINTER TO WORK AREA            11500021
RDCB     EQU   7                        POINTER TO THE USER'S DCB       11600021
RBASE    EQU   8                        BASE REGISTER                   11700021
R9       EQU   9                        WORK REGISTER                   11800021
RWORK1   EQU   R9                       WORK REGISTER                   11900021
RRETURN  EQU   RWORK1                   SUBROUTINE RETURN REG    Y02072 11950002
R10      EQU   10                       WORK/PARAMETER REGISTER         12000002
*                                       USED TO PASS WORK AREA BETWEEN  12010002
*                                       LOADS OF STOW                   12020002
RWORK2   EQU   R10                      WORK REGISTER                   12050002
R11      EQU   11                       WORK/PARAMETER REGISTER         12100002
*                                       USED TO PASS THE DCB BETWEEN    12110002
*                                       LOADS OF STOW                   12120002
RWORK3   EQU   R11                      WORK REGISTER                   12150002
R13      EQU   13                       WORK REGISTER                   12300021
RWORK4   EQU   R13                      WORK REGISTER                   12400002
R14      EQU   14                       LINK/WORK REGISTER              12500002
R15      EQU   15                       RETURN CODE /LINK /WORK REG     12600002
         EJECT                                                          12700021
*********************************************************************** 12800021
****                                                               **** 12900021
****     MASKS, DISPLACEMENTS, AND OTHER EQUATES                   **** 13000021
****                                                               **** 13100021
*********************************************************************** 13200021
         SPACE                                                          13300021
RCDZERO  EQU   X'00'                    USED TO SET TTR TO IND RECORD 0 13500021
RCDONE   EQU   X'01'                    USED TO SET TTR TO IND RECORD 1 13600021
IOERROR  EQU   X'10'                    I/O ERROR CODE                  13700021
STOWABCD EQU   X'115'                   ABEND CODE FOR FOR A     Y02072 13702002
*                                       DEBCHK FAILURE IN STOW   Y02072 13704002
EODERROR EQU   2                        IND I/O ERROR ENCOUNTER- Y02072 13950002
*                                       ED WRITING EOD MARKER    Y02072 14000002
EXTLNGTH EQU   16                       LENGTH OF A DASD DEB EXTENT     14100021
EOV      EQU   55                       EOV SVC NUMBER                  14200021
         EJECT                                                          14300021
****                                                                    14400021
****     ESTABLISH ADDRESSABILITY                                       14500021
****                                                                    14600021
         BALR  RBASE,0                  INITIALIZE BASE REGISTER        14700002
         USING *,RBASE                  ESTABLISH ADDRESSABILITY        14800021
         LR    RAREA,R10                CHANGE WORK AREA BASE REGISTER  14900021
         LR    RDCB,R11                 CHANGE DCB BASE REGISTER        15000021
         USING STWAREA,RAREA            ESTABLISH WORK AREA BASE REG    15100021
         USING IHADCB,RDCB              ESTABLISH DCB BASE REGISTER     15200021
         L     RDEB,DCBDEBAD            GET ADDRESS USER'S DEB   Y02072 15300002
         USING DEBBASIC,RDEB            ESTABLISH DEB BASE REGISTER     15400021
         L     RCVT,CVTPTR              GET CVT ADDRESS                 15500021
         USING CVT,RCVT                 ESTABLISH CVT BASE REGISTER     15600021
         SPACE 2                                                        15700021
****                                                                    15800021
****     IF THE FUNCTION IS ADD OR REPLACE, DETERMINE IF AN END OF DATA 15900021
****     MARKER MUST BE WRITTEN AFTER THE ASSOCIATED MEMBER.            16000021
****                                                                    16100021
         TM    STWFLAG1,STWCHNG+STWDEL  IS FUNCT CHANGE OR DELETE       16200021
         BNZ   BLDCHPGM                 YES, GO TO BUILD CHANNEL PGM    16300021
         TM    STWCTTRN,STWALIAS        IS NEW ENTRY AN ALIAS           16400021
         BO    BLDCHPGM                 YES, GO TO BUILD CHANNEL PGM    16500021
         TM    DEBOPATB,DEBACCS-(DEBUPDAT+DEBRDBCK)  IS DATA SET OPEN   16600002
*                                       FOR INPUT, RDBACK, OR UPDATE    16700002
         BZ    RETRNTTR                 YES, GO TO RETURN TTR TO USER   16800021
         TM    STWFLAG1,STWDCBWR        WAS LAST OPERATION ON USER'S    16900021
*                                       DCB A WRITE                     17000021
         BNO   RETRNTTR                 NO, GO TO RETURN TTR TO USER    17100021
         SPACE 2                                                        17200021
****                                                                    17300021
****     CHECK THE VOLUME AND THE CURRENT TRACK TO DETERMINE IF SPACE   17400021
****     IS AVAILABLE TO WRITE THE EOD MARKER.                          17500021
****                                                                    17600021
SPACECHK EQU   *                                                        17700021
         L     RDEVTBL,DCBDVTBL         GET ADDR OF DEVICE CHAR TABLE   17800021
         USING DVCT,RDEVTBL             ESTABLISH DEVICE TABLE BASE REG 17900002
         SR    RWORK1,RWORK1            CLEAR REGISTER                  18000021
         IC    RWORK1,DVCOVLB           GET OVERHEAD FOR KEYED RECORD   18100002
*                                       WHICH IS LAST ON TRACK          18200021
         TM    DVCFLAGS,DVC2BOV         USING TWO BYTE OVERHEAD         18300002
         BNO   NOT2BYT1                 NO, CONT SIZE CALCULATION       18400021
         LH    RWORK1,DVCOVHD           GET TWO BYTE OVERHEAD           18500002
         SPACE                                                          18600021
NOT2BYT1 EQU   *                                                        18700021
         SR    RWORK4,RWORK4            CLEAR REGISTER                  18800002
         IC    RWORK4,DVCOVNK           OVERHEAD FOR RECORD KEY         18900002
         SR    RWORK1,RWORK4            SUBTRACT KEY OVERHEAD           19000002
         LA    RWORK1,1(,RWORK1)        OVERHEAD FOR KEY AND DATA       19100021
*                                       LENGTH OF ZERO                  19200021
         CH    RWORK1,DCBTRBAL          WILL TRACK HOLD EOD RECORD      19300021
         BNH   UPTRKBAL                 YES, GO TO UPDATE TRACK BALANCE 19400021
         SPACE 2                                                        19500021
*********************************************************************** 19600021
****                                                               **** 19700021
****     THE FOLLOWING ROUTINE IS USED TO DETERMINE THE NEXT TRACK **** 19800021
****     ADDRESS.  THIS IS DONE BY ADDING 1 TO THE CURRENT TT AND  **** 19900021
****     SENDING THIS VALUE TO THE RESIDENT CONVERT ROUTINE.  IF   **** 20000021
****     THE NUMBER OF TRACKS IN THE DEB IS EXCEEDED, THE CONVERT  **** 20100021
****     ROUTINE WILL RETURN A CODE OF 4 IN REGISTER 15.  INPUT TO **** 20200021
****     AND OUTPUT FROM THE RESIDENT CONVERT ROUTINE IS AS        **** 20300021
****     FOLLOWS.                                                  **** 20400021
****                                                               **** 20500021
****     IECPRLTV - CONVERTS AN ABSOLUTE DIRECT ACCESS ADDRESS,    **** 20600021
****                MBBCCHHR, TO ITS RELATIVE EQUIVALENT, TTRN.    **** 20700021
****                                                               **** 20800021
****                INPUT REGISTERS -                              **** 20900021
****                  1  - ADDRESS OF DEB                          **** 21000021
****                  2  - ADDRESS OF MBBCCHHR IN CORE             **** 21100021
****                  14 - ENTRY ADDRESS                           **** 21200021
****                  15 - ENTRY ADDRESS                           **** 21300021
****                                                               **** 21400021
****                OUTPUT REGISTERS -                             **** 21500021
****                  0  - TTR0 RESULT                             **** 21600021
****                  1-8  TRANSPARENT                             **** 21700021
****                  9-13 DESTROYED                               **** 21800021
****                  14 - TRANSPARENT                             **** 21900021
****                  15 - ZERO                                    **** 22000021
****                                                               **** 22100021
****     IECPCNVT - CONVERTS A RELATIVE DIRECT ACCESS ADDRESS AND  **** 22200021
****                CONCATENATION NUMBER, TTRN, TO ITS ABSOLUTE    **** 22300021
****                EQUIVALENT, MBBCCHHR.                          **** 22400021
****                                                               **** 22500021
****                INPUT REGISTERS -                              **** 22600021
****                  0  - ACTUAL TTRN                             **** 22700021
****                  1  - ADDRESS OF DEB                          **** 22800021
****                  2  - ADDRESS OF 8 BYTE AREA FOR MBBCCHHR     **** 22900021
****                  14 - RETURN ADDRESS                          **** 23000021
****                  15 - ENTRY ADDRESS                           **** 23100021
****                                                               **** 23200021
****                OUTPUT REGISTERS -                             **** 23300021
****                  0  - DESTROYED                               **** 23400021
****                  1-8  TRANSPARENT                             **** 23500021
****                  9-13 DESTROYED                               **** 23600021
****                  14 - TRANSPARENT                             **** 23700021
****                  15 - ERROR CODE                              **** 23800021
****                                                               **** 23900021
****                THE ERROR CODE FOR IECPCNVT WILL BE 0 FOR      **** 24000021
****                SUCCESSFUL CONVERSION, OR 4 IF THE VALUE OF TT **** 24100021
****                EXCEEDS THE TOTAL EXTENTS ASSIGNED.            **** 24200021
****                                                               **** 24300021
*********************************************************************** 24400021
         LA    R2,DCBFDAD               GET ADDRESS OF MBBCCHHR         24500021
         L     R15,CVTPRLTV             GET ENTRY PT IN CONVERT ROUTINE 24600021
*                                       TO CONVERT MBBCCHHR TO TTRN     24700021
         BALR  R14,R15                  GO TO CONVERT ROUTINE           24800021
         LR    RWORK1,R0                SAVE TTRN                       24900021
         AL    R0,CON10000              CALC NEXT RELATIVE TRACK ADDR   25000021
         AH    RWORK1,CON00100          CALC NEXT RCD ON CURRENT TRACK  25100021
         CL    RWORK1,DCBRELAD          IS NEXT RECORD FIRST IN MEMBER  25200021
         BNE   CONVRTTR                 NO, GO TO CONVERT TTR           25300021
         LR    R5,R0                    SAVE TTRN + 1          @ZA31380 25400037
         L     R15,CVTPCNVT             ENTRY PT TO CNVRT RTN  @ZA31380 25420037
         BALR  R14,R15                  BR TO CNVT TTR-MBBCCHHR@ZA31380 25440037
         LTR   R15,R15                  TEST RC-EXCEED EXTENTS @ZA31380 25460037
*                                       IN THE DEB             @ZA31380 25480037
         BZ    STFIRST                  NO CONTINUE PROCESSING @ZA31380 25500037
         CLI   DEBNMEXT,X'10'           CHECK FOR 16 EXTENTS   @ZA31380 25520037
         BE    GOEOV                    YES- TO TO DEBCHK -EOV @ZA31380 25540037
STFIRST  EQU   *                                               @ZA31380 25560037
         ST    R5,DCBRELAD              SET DCBRELAD TO 1ST REC@ZA31380 25580037
         MVI   DCBRELAD+2,RCDONE        RECORD OF NEXT TRACK   @ZA31380 25600037
         MVC   STWTTR,DCBRELAD          UPDATE ENTRY TTR FIELD @ZA31380 25620037
         LTR   R15,R15                  EXCEED EXTENTS ?       @ZA31380 25640037
         BZ    SETRCD0                  NO, GO TO RESET REC NO @ZA31380 25660037
         B     GOEOV                    GO - DEBCHK - EOV      @ZA31380 25680037
         SPACE                                                          25800021
CONVRTTR EQU   *                                                        25900021
         L     R15,CVTPCNVT             GET ENTRY PT IN CONVERT ROUTINE 26100021
*                                       TO CONVERT TTR TO MBBCCHHR      26200021
         BALR  R14,R15                  GO TO CONVERT ROUTINE           26300021
         LTR   R15,R15                  DOES IT EXCEED EXTENTS IN DEB   26400021
         BZ    SETRCD0                  NO, GO TO RESET RECORD NUMBER   26500021
*                                       AND TRACK BALANCE               26600021
         SPACE 2                                                        26700021
****                                                                    26800021
****     GO TO EOV TO GET SPACE FOR THE EOD MARKER.                     26900021
****                                                                    27000021
GOEOV    EQU   *                                               @ZA31380 27020037
         BAL   RRETURN,CHECKDEB         BR TO DEB CHECK ROUTINE  Y02072 27050002
*                                       UPON RETURN, REG 1 WILL  Y02072 27100002
*                                       CONTAIN VERIF'D DEB ADDR Y02072 27150002
         SR    REXTNO,REXTNO            CLEAR REGISTER           Y02072 27400002
         IC    REXTNO,DEBNMEXT          GET NO. EXTENTS IN DEB   Y02072 27500002
         SLL   REXTNO,4                 MULTIPLY EXTENTS BY 16   Y02072 27600002
         LA    RWORK1,DEBBASND(REXTNO)  POINT TO ACCESS METHOD   Y02072 27800002
*                                       SECTION OF THE USER'S DEB       27900021
         USING DEBACSMD,RWORK1          EST ACCESS METHOD SECTION BASE  28000002
         L     RVOLSEQ,DEBVOLSQ         SAVE DEBVOLSQ CONTENTS   Y02072 28100002
         MVC   DEBVOLSQ,VOLSEQNO        SET CURRENT AND TOTAL NUMBER    28200021
*                                       OF VOLUMES TO ONE FOR EXCP      28300021
         DROP  RWORK1                   DROP ACCESS METHOD SECTION BASE 28400002
         BAL   RRETURN,FREELOCK         BR TO FREE LOCAL LOCK    Y02072 28450002
*                                       AND RTRN TO CALLER'S KEY Y02072 28460002
         LH    RWORK1,DCBMACRF          SAVE USER'S ACCESS METHOD FLAGS 28500002
         MVI   DCBMACF1,DCBMRECP+DCBMRABC IND EXCP & ACCURATE BLCK CNT  28600002
         MVI   DCBMACF2,0               CLEAR SECOND BYTE               28700002
         DROP  RDEB                     DROP DEB BASIC SECT BASE Y02072 28750002
         EOV   (RDCB)                   ISSUE EOV SVC            Y02072 28900002
         TM    DCBCIND2,DCBCNCLO        DID CLOSE ISSUE STOW     XM9034 28950002
         BNO   NOTCLOSE                 CONTINUE IF NOT          XM9034 28960002
         OI    DCBOFLGS,DCBOFIOF        RESET DCB BUSY BIT       XM9034 28970002
         SPACE                                                          28980002
NOTCLOSE EQU   *                                                 XM9034 28990002
         STH   RWORK1,DCBMACRF          RESTORE USER'S FLAGS            29000002
         L     RDEB,DCBDEBAD            GET ADDR OF THE CALLER'S Y02072 29100002
*                                       NEW DEB                  Y02072 29150002
         USING DEBBASIC,RDEB            EST BASE FOR DEB BASIC SECTION  29300021
         BAL   RRETURN,CHECKDEB         BR TO DEB CHECK ROUTINE  Y02072 29350002
*                                       UPON RETURN, REG 1 WILL  Y02072 29400002
*                                       CONTAIN VERIF'D DEB ADDR Y02072 29450002
         TM    DCBCIND2,DCBCNCLO        DID CLOSE ISSUE STOW    XA02388 29452002
         BNO   NOTCLOS2                 CONTINUE IF NOT         XA02388 29454002
         OI    DEBFLGS1,DEBF1CEV        IND EOV ISSUED DURING   XA02388 29456002
*                                       CLOSE                   XA02388 29458002
         SPACE                                                          29460002
NOTCLOS2 EQU   *                                                XA02388 29462002
         LA    RWORK2,DEBBASND(REXTNO)  POINT TO THE NEW EXTENT  Y02072 29500002
*                                       IN THE CALLER'S DEB      Y02072 29650002
         USING DEBACSMD-EXTLNGTH,RWORK2 EST DEB ACCESS METHOD    Y02072 29700002
*                                       SECTION BASE REGISTER    Y02072 29750002
         DROP  RWORK2                   DROP DEB ACCESS METHOD   Y02072 29900002
*                                       SECTION BASE REGISTER    Y02072 29910002
         BAL   RRETURN,FREELOCK         BR TO FREE LOCAL LOCK    Y02072 29950002
*                                       AND RTRN TO CALLER'S KEY Y02072 30000002
         USING DEBDASD,RWORK2           EST DEB DASD SECTION     Y02072 30300002
*                                       BASE REGISTER            Y02072 30350002
         SRL   REXTNO,4                 CALCULATE EXTENT NUMBER  Y02072 30400002
         STC   REXTNO,DCBFDAD           UPDATE EXTENT NO.IN DCB  Y02072 30500002
         MVC   DCBFDAD+1(L'DCBFDAD-2),DEBBINUM  UPDATE BIN, CYLINDER,   30600021
*                                       AND HEAD NUMBERS IN DCB         30700021
         DROP  RWORK2                   DROP DASD SECTION BASE   Y02072 30800002
         SPACE 2                                                        30900021
****                                                                    31000021
****     SINCE THE NEXT RECORD WILL BE WRITTEN ON A NEW TRACK, THE      31100021
****     DCBFDAD FIELD MUST BE UPDATED TO INDICATE RECORD 0 OF THE NEW  31200021
****     TRACK, AND DCBTRBAL MUST BE RESET TO MAXIMUM TRACK CAPACITY.   31300021
****                                                                    31400021
SETRCD0  EQU   *                                                        31500021
         MVI   DCBFDAD+7,RCDZERO        SET RECORD TO ZERO              31600021
         MVC   DCBTRBAL,DVCTRKLN        SET TRACK BALANCE TO MAX.       31700002
         SPACE 2                                                        31800021
****                                                                    31900021
****     CALCULATE AMOUNT OF TRACK WHICH WILL BE USED TO WRITE THE EOD  32000021
****     MARKER AND UPDATE THE DCBTRBAL FIELD.                          32100021
****                                                                    32200021
UPTRKBAL EQU   *                                                        32300021
         SR    RWORK4,RWORK4            CLEAR REGISTER                  32400002
         IC    RWORK4,DVCOVNLB          GET OVERHEAD FOR KEYED RECORD   32500002
*                                       WHICH IS NOT LAST ON TRACK      32600021
         TM    DVCFLAGS,DVC2BOV         USING TWO BYTE OVERHEAD         32700002
         BNO   NOT2BYT2                 NO, CONTINUE OVERHEAD CALC      32800021
         LH    RWORK4,DVCOVHD           GET TWO BYTE OVERHEAD           32900002
         SPACE                                                          33000021
NOT2BYT2 EQU   *                                                        33100021
         LA    RWORK4,1(,RWORK4)        OVERHEAD FOR KEY AND DATA       33200002
*                                       LENGTH OF ZERO                  33300021
         SR    RWORK1,RWORK1            CLEAR REGISTER                  33400021
         IC    RWORK1,DVCOVNK           GET OVERHEAD FOR RECORD KEY     33500002
         SR    RWORK4,RWORK1            SUBTRACT KEY OVERHEAD           33600002
         LH    RWORK1,DCBTRBAL          GET CURRENT TRACK BALANCE       33700021
         SR    RWORK1,RWORK4            CALCULATE NEW BALANCE           33800002
         STH   RWORK1,DCBTRBAL          UPDATE DCBTRBAL FIELD           33900021
         SPACE 2                                                        34000021
****                                                                    34100021
****     UPDATE DCBFDAD FIELD TO POINT TO END OF DATA MARKER.           34200021
****                                                                    34300021
         MVC   IOBSEEK,DCBFDAD          PUT NEW MBBCCHHR IN IOB         34400021
         SR    RWORK1,RWORK1            CLEAR REGISTER                  34500021
         IC    RWORK1,DCBFDAD+7         GET RECORD NUMBER               34600021
         LA    RWORK1,1(,RWORK1)        UPDATE RECORD NUMBER BY ONE     34700021
         STC   RWORK1,DCBFDAD+7         UPDATE DCBFDAD FIELD            34800021
         SPACE 2                                                        34900021
****                                                                    35000021
****     BUILD AND EXECUTE THE CHANNEL PROGRAM TO WRITE THE EOD MARKER. 35100021
****                                                                    35200021
         LM    R9,R14,EODCHPGM          GET SKELETON CHANNEL PROGRAM    35300021
         AR    R9,RAREA                 ESTABLISH SEARCH ADDRESS        35400021
         AR    R11,RAREA                ESTABLISH TIC ADDRESS           35500021
         AR    R13,RAREA                ESTABLISH BUFFER ADDRESS        35600021
         STM   R9,R14,STWWRDCP          CREATE CHANNEL PGM IN WORK AREA 35700021
         ST    R11,IOBSTART             PUT CHANNEL PGM ADDRESS IN IOB  35800021
         USING BUFFER,R13               ESTABLISH BUFFER BASE REGISTER  35900021
         MVC   BUFCCHHR,DCBFDAD+3       MOVE CCHHR TO BUFFER COUNT FLD  36000002
         XC    BUFKDD,BUFKDD            SET KEY AND DATA LENGTH TO ZERO 36100002
         DROP  RDEB                     DROP DEB BASE REIGISTER         36200021
         IC    RWORK1,IOBCSW+3          SAVE HI-ORDER BYTE OF    M0965  36250021
*                                       CSW STATUS FIELD         M0965  36260021
         EXCP  IOBSTDRD                 EXECUTE CHANNEL PROGRAM         36300021
         TM    ECBCC,ECBPOST            DID ECB GET POSTED?    @ZA12202 36400037
         BO    BYWAIT                   BYPASS WAITING ON ECB  @ZA12202 36450037
         WAIT  ECB=ECBCC                WAIT FOR I/O TO COMPLETE        36500037
BYWAIT   EQU   *                        ECB HAS BEEN POSTED    @ZA12202 36550037
         TM    ECBCC,ECBNORM            DID I/O COMPLETE NORMALLY       36600021
         BNO   ERROR                    NO, RETURN TO THE USER          36700021
         STC   RWORK1,IOBCSW+3          RESTORE HI-ORDER BYTE OF M0965  36750021
*                                       CSW STATUS FIELD         M0965  36760021
         SPACE 2                                                        36800021
****                                                                    36900021
****     UPDATE THE DCBRELAD FIELD FOR NEXT MEMBER TO BE WRITTEN.       37000021
****                                                                    37100021
         L     RDEB,DCBDEBAD            RESTORE DEB ADDRESS      Y02072 37200002
         USING DEBBASIC,RDEB            ESTABLISH DEB BASE REGISTER     37300002
         LA    R2,DCBFDAD               GET ADDRESS OF MBBCCHHR         37400021
         L     R15,CVTPRLTV             GET ENTRY PT IN CONVERT ROUTINE 37500021
*                                       TO CONVERT MBBCCHHR TO TTRN     37600021
         BALR  R14,R15                  GO TO CONVERT ROUTINE           37700021
         AH    R0,CON00100              UPDATE TTRN TO NEXT RECORD      37800021
         ST    R0,DCBRELAD              UPDATE DCBRELAD FIELD           37900021
         SPACE 2                                                        38000021
****                                                                    38100021
****     RESTORE THE EXTENT NUMBER IN THE IOBSEEK FIELD TO REFLECT THE  38200021
****     FIRST EXTENT OF THE DATA SET.                                  38300021
****                                                                    38400021
         MVI   IOBM,0                   INDICATE FIRST EXTENT           38500002
         SPACE 2                                                        38600021
****                                                                    38700021
****     IF THE FUNCTION IS ADD OR REPLACE AND THE MEMBER IS NOT AN     38800021
****     ALAIS, RETURN THE TTR OF THE MEMBER TO THE USER.               38900021
****                                                                    39000021
RETRNTTR EQU   *                                                        39100021
         L     RWORK1,STWPARM           GET ADDR OF USER'S PARM AREA    39200021
         USING STOW,RWORK1              ESTABLISH BASE FOR USER'S AREA  39300002
         MVC   STOTTR,STWTTR            RETURN TTR TO USER              39400002
         DROP  RWORK1                   DROP BASE FOR USER'S PARM AREA  39500021
         SPACE 2                                                        39600021
****                                                                    39700021
****     CREATE THE WRITE/READ CHANNEL PROGRAM USED BY THE THIRD LOAD   39800021
****     AND BRANCH TO THE THIRD LOAD TO PROCESS THE USER'S REQUEST.    39900003
****                                                                    40000021
BLDCHPGM EQU   *                                                        40100021
         DROP  RDEB                     DROP DEB BASE REGISTER          40200021
         LM    R9,R2,WRDCHPGM           GET SKELETON OF THE WRITE/READ  40300021
*                                       CHANNEL PROGRAM                 40400021
         AR    R11,RAREA                ESTABLISH TIC ADDRESS           40500021
         STM   R9,R2,STWWRDCP           CREATE WRITE/READ CHANNEL       40600021
*                                       PROGRAM IN STOW'S WORK AREA     40700021
         MVC   STWRCKD4(STWRCKD4-STWRCKD3),WRDRCKD3 SET UP 3RD  YA06505 40750037
*                                       RCKD WHICH WILL READ IN YA06505 40760037
*                                       2ND DIRECTORY BLK       YA06505 40770037
         LR    R10,RAREA                RESTORE WORK AREA REGISTER      40800021
         LR    R11,RDCB                 RESTORE DCB REGISTER            40900021
*                                                                       41200002
         L     R15,V21AB                ADDRESS OF NEXT LOAD   @Z30TSMI 41400003
         BR    R15                      BRANCH TO NEXT LOAD    @Z30TSMI 41450003
         SPACE 2                                                        41500021
****                                                                    41600021
****     FREE THE GOTTEN CORE, PUT THE REASON CODE IN REGISTER 0, THE   41700002
****     RETURN CODE IN REGISTER 15, AND RETURN TO THE CALLER.          41800002
****                                                                    41900021
ERROR    EQU   *                                                        42000021
         FREEMAIN R,LV=CORESIZE,A=(RAREA),SP=229  FREE CORE      Y02072 42300002
         NI    DCBIFLGS,X'FF'-DCBIFEC   TURN OFF ERROR FLAGS     Y02072 42302002
         LA    R0,EODERROR              GET REASON CODE          Y02072 42310002
         LA    R15,IOERROR              IND AN I/O ERROR OCCURED YM0943 42350001
         USING PSA,0                    ESTABLISH PSA BASE REG   Y02072 42370002
         L     RWORK1,PSATOLD           GET ADDR OF CURRENT TCB  Y02072 42380002
         USING TCB,RWORK1               ESTABLISH TCB BASE REG   Y02072 42382002
         L     RWORK1,TCBRBP            GET SVRB ADDRESS         Y02072 42390002
         USING RBSECT,RWORK1            EST SVRB BASE REG        Y02072 42392002
         L     R14,XSAREG14             RESTORE RETURN REGISTER  Y02072 42394002
         DROP  RWORK1                   DROP SVRB BASE REG       Y02072 42396002
         SPACE 2                                                        42398002
****                                                                    42398402
****     MODESET TO KEY 0 AND RETURN TO THE CALLER.                     42398802
****                                                                    42399202
         MODESET EXTKEY=SUPR            MODESET TO KEY 0         Y02072 42399602
         BR    R14                      RETURN TO THE CALLER     Y02072 42400002
         SPACE 2                                                        42450002
*********************************************************************** 42460002
****                                                               **** 42470002
****     THIS SUBROUTINE MODESETS TO KEY 0, OBTAINS THE LOCAL      **** 42480002
****     LOCK, AND USES THE BRANCH ENTRY TO THE DEB CHECK ROUTINE  **** 42490002
****     TO VERIFY THE DEB ADDRESS OBTAINED FROM THE CALLER'S DCB. **** 42492002
****     IF THE DEB CHECK IS NOT SUCCESSFUL A SYSTEM 115 ABEND     **** 42492102
****     WILL BE ISSUED.  OTHERWISE, CONTROL IS RETURNED TO THE    **** 42492202
****     CALLING ROUTINE.                                          **** 42492302
****                                                               **** 42492402
****     INPUT REGISTERS -                                         **** 42492802
****          1       - ADDRESS OF THE DEB TO BE VERIFIED          **** 42493202
****          RRETURN - RETURN ADDRESS TO THE CALLER               **** 42494002
****          RCVT    - ADDRESS OF THE CVT                         **** 42494102
****                                                               **** 42494202
****     OUTPUT REGISTERS -                                        **** 42494302
****          0,2-9 - UNCHANGED                                    **** 42494402
****          1     - ADDRESS OF THE VERIFIED DEB                  **** 42494502
****          10-15 - DESTROYED                                    **** 42495002
****                                                               **** 42495602
*********************************************************************** 42495802
CHECKDEB EQU   *                                                 Y02072 42496002
         MODESET EXTKEY=SUPR            MODESET TO KEY 0         Y02072 42498002
GETLOCK  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02072X42498402
               RELATED=(DEB,IGG0210A,FREELOCK)                   Y02072 42498802
         L     R10,CVTTCBP              GET ADDR OF TCB PTRS     Y02072 42498902
         L     R10,4(,R10)              GET ADDR OF CURRENT TCB  Y02072 42499002
         L     R15,CVTEXT2              GET ADDR OF CVT EXT 2    Y02072 42499102
         USING CVTXTNT2,R15             EST CVT EXT 2 BASE REG   Y02072 42499202
         L     R15,CVTDEBVR             GET ADDR OF DEB CHECK    Y02072 42499602
         DROP  R15                      DROP CVT EXT 2 BASE REG  Y02072 42501602
         LA    RDEB,0(,RDEB)            CLEAR HI-ORDER BYTE      YM5733 42502002
         BALR  R14,R15                  GO TO DEB CHECK ROUTINE  Y02072 42503602
         BR    RRETURN                  RETURN IF DEB CHECK WAS  Y02072 42505602
         NOPR  0                        SUCCESSFUL               Y02072 42507602
         BAL   RRETURN,FREELOCK         BR TO FREE LOCAL LOCK    Y02072 42509602
         ABEND STOWABCD,,,SYSTEM        ABEND IF DEB CHECK WAS   Y02072X42533202
                                        NOT SUCCESSFUL           Y02072 42543202
         SPACE 2                                                        42553202
*********************************************************************** 42563202
****                                                               **** 42565202
****     THIS SUBROUTINE FREES THE LOCAL LOCK AND MODESETS BACK    **** 42565602
****     TO THE KEY OF THE CALLER.                                 **** 42566002
****                                                               **** 42566102
****     INPUT REGISTERS -                                         **** 42566202
****          RCVT    - ADDRESS OF THE CVT                         **** 42566302
****          RRETURN - RETURN ADDRESS TO THE CALLER               **** 42568302
****                                                               **** 42568702
****     OUTPUT REGISTERS -                                        **** 42569102
****          0-9,15 - UNCHANGED                                   **** 42569502
****          11-14  - DESTROYED                                   **** 42569902
****                                                               **** 42570302
*********************************************************************** 42572302
FREELOCK SETLOCK RELEASE,TYPE=LOCAL,                             Y02072X42577702
               RELATED=(DEB,IGG0210A,GETLOCK)                    Y02072 42587702
         L     RWORK3,CVTTCBP           GET ADDR OF TCB PTRS     Y02072 42588102
         L     RWORK3,4(,RWORK3)        GET ADDR OF CURRENT TCB  Y02072 42588502
         USING TCB,RWORK3               ESTABLISH TCB BASE REG   Y02072 42588602
         MODESET EXTKEY=RBT234,WORKREG=12                        Y02072 42588702
         BR    RRETURN                  RETURN TO CALLING RTN    Y02072 42588802
         DROP  RWORK3                   DROP TCB BASE REGISTER   Y02072 42592502
         EJECT                                                          42596302
*********************************************************************** 42600021
****                                                               **** 42700021
****     SKELETON CHANNEL PROGRAMS                                 **** 42800021
****                                                               **** 42900021
*********************************************************************** 43000021
         SPACE                                                          43100021
WRDCHPGM DS    0F                       THIS CHANNEL PROGRAM IS         43200021
*                                       USED BY IGG021AB FOR WRITING    43300021
*                                       AND READING DIRECTORY BLOCKS    43400021
WRDSRHID DC    X'31'                    SEARCH ID EQUAL                 43500021
         DC    AL3(0)                   POINTER TO SEARCH ARGUMENT      43600021
         DC    X'4000'                  COMMAND CHAINING                43700021
         DC    X'0005'                  NUMBER OF BYTES                 43800021
WRDTIC   DC    X'08'                    TRANSFER CONTROL TO SEARCH ID   43900021
         DC    AL3(STWSRCH2-STWAREA)    ADDRESS OF SEARCH ID            44000021
         DC    XL4'00'                  NOT USED BUT REQUIRED           44100021
WRDWRCKD DC    X'0D'                    WRITE KEY AND DATA              44200021
         DC    AL3(0)                   ADDRESS OF KEY AND DATA         44300021
         DC    X'5000'                  COMMAND CHAIN AND SUPPRESS DATA 44400021
*                                       TRANSFER WHEN CCW IS CHANGED    44500021
*                                       TO A WRITE                      44600021
         DC    X'0108'                  NO. OF BYTES TO BE TRANSFERED   44700021
WRDRCKD1 DC    X'9E'                    READ COUNT, KEY, AND DATA       44800021
         DC    AL3(STWBUF3-STWAREA)     ADDR OF COUNT, KEY, AND DATA    44900021
         DC    X'5000'                  SUPRESS DATA TRANSFER           45000021
         DC    X'0110'                  NO. OF BYTES TO BE TRANSFERED   45100021
WRDRCKD2 DC    X'9E'                    READ COUNT, KEY, AND DATA       45200021
         DC    AL3(STWBUF3-STWAREA)     ADDR OF COUNT, KEY, AND DATA    45300021
         DC    X'0000'                  FLAGS                           45400021
         DC    X'0110'                  NO. OF BYTES TO BE TRANSFERED   45500021
WRDRCKD3 DC    X'9E'                    READ COUNT, KEY, DATA   YA06505 45550037
         DC    AL3(0)                   BUFFER ADDR TO READ CKD YA06505 45560037
         DC    X'0000'                  FLAGS                   YA06505 45570037
         DC    X'0110'                  NO. OF BYTES TRANSFERED YA06505 45580037
         SPACE 2                                                        45600021
EODCHPGM DS    0F                       THIS CHANNEL PROGRAM IS USED TO 45700021
*                                       WRITE THE EOD MARKER FOLLOWING  45800021
*                                       A MEMBER                        45900021
EODSRHID DC    X'31'                    SEARCH ID EQUAL                 46000021
         DC    AL3(IOBSEEK+3-STWAREA)   POINTER TO SEARCH ARGUMENT      46100021
         DC    X'4000'                  COMMAND CHAINING                46200021
         DC    X'0005'                  NUMBER OF BYTES                 46300021
EODTIC   DC    X'08'                    TRANSFER CONTROL TO SEARCH ID   46400021
         DC    AL3(STWSRCH2-STWAREA)    ADDRESS OF SEARCH ID            46500021
         DC    XL4'00'                  NOT USED BUT REQUIRED           46600021
EODWRCKD DC    X'1D'                    WRITE COUNT, KEY, AND DATA      46700021
         DC    AL3(STWBUF3-STWAREA)     ADDRESS OF COUNT FIELD          46800021
         DC    X'0000'                  FLAGS                           46900021
         DC    X'0008'                  NO. OF BYTES TO BE TRANSFERED   47000021
         EJECT                                                          47100021
*********************************************************************** 47200021
****                                                               **** 47300021
****     CONSTANTS                                                 **** 47400021
****                                                               **** 47500021
*********************************************************************** 47600021
         SPACE                                                          47700021
CON10000 DC    F'65536'                 USED TO ADD 1 TO REL TRACK NO.  47800021
CON00100 DC    H'256'                   USED TO ADD 1 TO REL RECORD NO. 47900021
V21AB    DC    V(IGG021AB)              ADDRESS OF NEXT LOAD   @Z30TSMI 47950003
VOLSEQNO DC    X'00010001'              USED TO SET CURRENT AND TOTAL   48000021
*                                       NUMBER OF VOLUMES TO ONE        48100021
         DC    CL8'@ZA31380'            LATEST FLAG            @ZA31380 48100637
         DC    CL8'&SYSDATE'            LATEST DATE            @ZA31380 48101037
PATCH    DC    0XL50'0',C'IGG0210A',42X'0'  50 BYTE PATCH AREA   Y02072 48102002
         EJECT                                                          48400021
*********************************************************************** 48700021
****                                                               **** 48800021
****     CONTROL BLOCK DEFINITIONS                                 **** 48900002
****                                                               **** 49000021
*********************************************************************** 49100021
         SPACE                                                          49200002
         CVT   DSECT=YES                                         Y02072 67000002
         EJECT                                                          67100021
         DCBD  DSORG=PO                                                 67200021
         EJECT                                                          67300021
         IEZDEB                                                         67400021
*                                                                       67450002
*        THE FOLLOWING ARE EQUATES TO BE USED IN THE DEBOPATB           67460002
*        FIELD.  THEY WILL BE REMOVED WHEN THE DEB DSECT IS             67470002
*        UPDATED TO INCLUDE THEM.                                       67480002
*                                                                       67490002
DEBRDBCK EQU   X'01'                    READ BACKWARDS FLAG             67492002
DEBUPDAT EQU   X'04'                    UPDATE FLAG                     67494002
         EJECT                                                          67544002
         IHADVCT                                                        67594002
         EJECT                                                          67644002
         IHAPSA                                                  Y02072 67654002
         EJECT                                                          67664002
         IHARB                                                   Y02072 67694002
         EJECT                                                          67696002
         IHASTOW                                                        67698002
         EJECT                                                          67744002
         IKJTCB                                                  Y02072 67794002
         EJECT                                                          67844002
         IGGSTW                                                  Y02072 67894002
         END                                                            92200000
