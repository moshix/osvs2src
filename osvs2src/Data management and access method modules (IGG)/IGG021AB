         TITLE 'IGG021AB - THIRD LOAD OF BPAM STOW ROUTINE'             00100021
IGG021AB CSECT                                                          00200021
         SPACE                                                          00300021
*********************************************************************** 00400021
*                                                                     * 00500021
* MODULE NAME = IGG021AB                                              * 00502002
*                                                                     * 00504002
* DESCRIPTIVE NAME = THIRD LOAD OF BPAM STOW ROUTINE                  * 00506002
*                                                                     * 00508002
* COPYRIGHT = NONE                                                    * 00510002
*                                                                     * 01000021
* STATUS = RELEASE VS2-4, DATE OF LAST CHANGE 6/28/76                 * 01100037
*                                                                     * 01500021
*                                                                     * 01600021
* FUNCTION = MAINTAINS PARTITIONED DATA SET DIRECTORIES IN ASCENDING  * 01700002
*            ORDER OF THE BINARY VALUES OF THE NAMES OF THE MEMBERS.  * 01800002
*            THIS IS ACCOMPLISHED BY ADDING, REPLACING, CHANGING THE  * 01900002
*            NAME OF, OR DELETING DIRECTORY ENTRIES.  IF THE FUNCTION * 02000002
*            REQUESTED IS ADD, REPLACE, OR CHANGE, AND IF THERE ARE   * 02100002
*            NO UNUSED DIRECTORY BLOCKS, THEN A DRY RUN WILL BE MADE  * 02200002
*            AGAINST THE DIRECTORY TO DETERMINE IF SUFFICIENT SPACE   * 02300002
*            IS AVAILABLE IN WHICH TO PERFORM THE REQUESTED FUNCTION. * 02400002
*            FOLLOWING THE DRY RUN, OR IN THE CASE WHERE A DRY RUN IS * 02500002
*            NOT REQUIRED, THE DIRECTORY WILL BE ALTERED BY EXPANDING * 02600002
*            AND/OR COMPRESSING THE DIRECTORY IN ORDER TO PERFORM THE * 02700002
*            THE REQUESTED FUNCTION.                                  * 02800002
*                                                                     * 02900021
*                                                                     * 03000021
* NOTES = SEE BELOW                                                   * 03002002
*                                                                     * 03004002
*    DEPENDENCIES = CHARACTER CODE DEPENDENCY - THIS MODULE IS DEPEN- * 03006002
*                   DENT ON THE FOLLOWING EBCDIC CHARACTERS:          * 03008002
*                   X'FFFFFFFF' - INDICATES THE LAST ENTRY IN A       * 03010002
*                   DIRECTORY.                                        * 03012002
*                                                                     * 03014002
*    RESTRICTIONS = NONE                                              * 03016002
*                                                                     * 03018002
*    REGISTER CONVENTIONS = SEE REGISTER EQUATES BELOW                * 03020002
*                                                                     * 03022002
*    PATCH LABEL = PATCH                                              * 03024002
*                                                                     * 03026002
*                                                                     * 03028002
* MODULE TYPE = SVC ROUTINE                                           * 03030002
*                                                                     * 03032002
*    ATTRIBUTES = REENTRANT, ENABLED, PRIVILEGED, ENTERED IN          * 03034002
*                 SUPERVISOR KEY AND ISSUES A MODESET TO RUN IN THE   * 03036002
*                 CALLER'S KEY.                                       * 03038002
*                                                                     * 03040002
*                                                                     * 03042002
* ENTRY POINT = IGG021AB                                              * 03100002
*                                                                     * 03102002
*    LINKAGE = THIS ROUTINE RECEIVES CONTROL VIA A BRANCH FROM THE    * 03104037
*              SECOND LOAD OF STOW - IGG0210A.                        * 03106002
*                                                                     * 03400021
*    INPUT = THE FOLLOWING PARAMETERS ARE PASSED WHEN CONTROL IS      * 03500002
*            RECEIVED AS DESCRIBED ABOVE:                             * 03600002
*            REGISTER 10 - CONTAINS THE ADDRESS OF STOW'S WORK AREA.  * 03800002
*            REGISTER 11 - CONTAINS THE ADDRESS OF THE USER'S DCB.    * 03900002
*                                                                     * 04100021
*    OUTPUT = REGISTER 0  - CONTAINS THE REASON CODE.                 * 04200002
*             REGISTER 15 - CONTAINS THE RETURN CODE.                 * 04300002
*                                                                     * 04400021
*    EXITS-NORMAL = RETURNS TO THE CALLER VIA A BR 14 WITH REASON     * 04402002
*                   CODE REGISTER 0 AND RETURN CODE REGISTER 15       * 04404002
*                   CONTAINING THE FOLLOWING:                         * 04406002
*                   REG 0   REG 15             CONDITION              * 04406102
*                     0        0  - INDICATES NORMAL COMPLETION OF    * 04406202
*                                   THE CALLER'S REQUEST.             * 04406602
*                     0        8  - INDICATES THAT THE ENTRY TO BE    * 04407202
*                                   REPLACED COULD NOT BE FOUND, BUT  * 04407602
*                                   HAS BEEN ADDED TO THE DIRECTORY.  * 04410002
*                                                                     * 04500021
*    EXITS-ERROR = RETURNS TO THE CALLER VIA A BR 14 WITH REASON CODE * 04502002
*                  REGISTER 0 AND RETURN CODE REGISTER 15 CONTAINING  * 04504002
*                  THE FOLLOWING:                                     * 04506002
*                  REG 0   REG 15              CONDITION              * 04506402
*                    0       12  - INDICATES THERE IS NOT SUFFICIENT  * 04506802
*                                  SPACE REMAINING IN THE DIRECTORY   * 04506902
*                                  TO PERFORM THE ADD, REPLACE, OR    * 04507002
*                                  CHANGE FUNCTION REQUESTED.         * 04507102
*                    1       16  - INDICATES AN I/O ERROR OCCURED     * 04507202
*                                  WHILE WRITING OR READING DIRECTORY * 04514002
*                                  BLOCKS.                            * 04516002
*                                                                     * 04518002
*                                                                     * 04520002
* EXTERNAL REFERENCES = SEE BELOW                                     * 04600002
*                                                                     * 04602002
*    ROUTINES = EXCP(SVC 0) AND WAIT(SVC 1) - ARE USED TO PERFORM I/O * 04604002
*               OPERATIONS.                                           * 04700002
*                                                                     * 04800021
*               FREEMAIN(SVC 10) - IS USED TO FREE STOW'S WORK AREA   * 04900002
*               PRIOR TO EITHER A NORMAL OR AN ERROR EXIT.            * 05000002
*                                                                     * 05002002
*               MODESET - USED TO CHANGE THE STORAGE PROTECT KEY.     * 05004002
*                                                                     * 05100021
*    DATA AREAS = NONE                                                * 05200002
*                                                                     * 06900021
*    CONTROL BLOCKS = CVT,DCB,DEB,ECB,IOB,SVRB,TCB                    * 06902002
*                                                                     * 07000021
*                                                                     * 07002002
* TABLES = THIS MODULE USES THE STOW WORK AREA, THE FORMAT AND        * 07100002
*          CONTENTS OF WHICH ARE DESCRIBED IN THE DSECT AT THE END OF * 07200002
*          THE LISTING.                                               * 07300002
*                                                                     * 07400021
*                                                                     * 07500021
* MACROS = ACTION MACROS - EXCP,WAIT,FREEMAIN,MODESET                 * 07800002
*                                                                     * 07900021
*          MAPPING MACROS - CVT,DCBD,IEZDEB,IHAPDS,IHAPSA,IHARB,      * 08300002
*             IKJTCB,IGGSTW                                           * 08302002
*                                                                     * 08400021
*                                                                     * 08402002
* CHANGE ACTIVITY = AS FOLLOWS:                                       * 08500002
*                                                                     * 08502002
*          RELEASE 21 DELETIONS                                       * 08552002
*    THIS MODULE IS NEW FOR RELEASE 21.  THE FOLLOWING APARS WERE     * 08556002
*    CORRECTED.  28169, 33374, 35322, 42484, AND 43923.               * 08558002
*                                                                 M1088 08558402
*          RELEASE 21.8 CHANGES/DELETIONS                             * 08558537
*A515500-515900,538500-538600,552500-552940                     SA66881 08558837
*D539000                                                        SA66881 08559237
*A297500-297600,397500-397600,474500-474992                     SA72739 08559637
*          VS1 RELEASE 01 DELETIONS                                   * 08560002
*                                                                XM5415 08562002
*          VS1 RELEASE 02 DELETIONS                                   * 08562402
*                                                               OX00801 08562802
*          VS1 RELEASE 03 DELETIONS                                   * 08563002
* SEE CODE FLAGGED SA66881 FOR VS1 APAR XA03384                 XA03384 08563137
* SEE CODE FLAGGED YA06505 FOR VS1 APAR XA06889                 XA06889 08567737
*                                                               XA02065 08572437
*          VS2 RELEASE 01 DELETIONS                                   * 08577037
*                                                                YM0943 08581637
*C158500                                                        YA06505 08583637
*A158600-159600,379500-379800,419500-419800,434500-434800,      YA06505 08585637
*A449800-449993,540600-540984,133100                            YA06505 08586037
*D449800-450332                                                 YA06505 08586137
*          VS2 RELEASE 02 DELETIONS                                   * 08614837
*D001500,005500,007600,118700,119500,134000,507000-508000,       Y02072 08629037
*D668000-831000                                                  Y02072 08643237
*          VS2 RELEASE 03 CHANGES/DELETIONS                             08657437
* SEE CODE FLAGGED YA06505/SA72739 AND ZA01548(IGGSTOW MACRO)   ZA01548 08671637
*          VS2 RELEASE 04 CHANGES/DELETIONS                             08681637
*A218500-218700,221500,488500-488700                           @ZA02261 08683637
*A270300-270800,323300-323800                                  @ZA08321 08684637
*A449500-449620,667005-667015  OS77114,OX13215,OY12725,OZ10222 @ZA10229 08685837
*                                                                     * 08692837
*A651000-651200,651600                                         @ZA12202 08694837
*C667015                                                       @ZA12202 08696837
*********************************************************************** 08700021
         EJECT                                                          08800021
*********************************************************************** 08900021
****                                                               **** 09000021
****     REGISTER EQUATES                                          **** 09100021
****                                                               **** 09200021
*********************************************************************** 09300021
         SPACE                                                          09400021
R0       EQU   0                        WORK/PARAMETER REGISTER         09500021
R1       EQU   1                        WORK/PARAMETER REGISTER         09600021
RWORK1   EQU   R1                       WORK REGISTER                   09700021
R2       EQU   2                        WORK REGISTER                   09800021
RIBFR    EQU   R2                       POINTER TO INPUT BFR            09900021
R3       EQU   3                        WORK REGISTER                   10000021
RMOVE    EQU   R3                       PTR TO NEXT ELEMENT TO BE MOVED 10100021
R4       EQU   4                        WORK REGISTER                   10200021
REMAIN   EQU   R4                       AMOUNT OF DATA IN INPUT BFR     10300021
R5       EQU   5                        WORK REGISTER                   10400021
ROBFR    EQU   R5                       POINTER TO OUTPUT BFR           10500021
R6       EQU   6                        WORK REGISTER                   10600021
RFILL    EQU   R6                       PTR TO NEXT SPACE IN OUTPUT BFR 10700021
R7       EQU   7                        WORK REGISTER                   10800021
RSPACE   EQU   R7                       UNUSED SPACE IN OUTPUT BFR      10900021
R8       EQU   8                        WORK REGISTER                   11000021
RSIZE    EQU   R8                       AMOUNT OF DATA TO BE MOVED      11100021
REASONCD EQU   RSIZE                    ERROR REASON CODE        Y02072 11150002
R9       EQU   9                        WORK REGISTER                   11200021
RWORK2   EQU   R9                       WORK REGISTER                   11300021
RRETCODE EQU   RWORK2                   USED TO PASS RETURN CODE TO     11350002
*                                       ERROR ROUTINE                   11360002
RAREA    EQU   10                       POINTER TO WORK AREA            11400021
RDCB     EQU   11                       POINTER TO THE USER'S DCB       11500021
RBASE    EQU   12                       BASE REGISTER                   11600021
R13      EQU   13                       WORK REGISTER                   11700021
REXCPRET EQU   R13                      RETURN REG FROM EXCP ROUTINE    11750002
RCALCRET EQU   REXCPRET                 RETURN REG FROM CALC RTN        11760002
R14      EQU   14                       RETURN ADDR/WORK REGISTER       11800021
RMOVERET EQU   R14                      RETURN REG FROM MOVE RTN        11850002
RREADRET EQU   RMOVERET                 RETURN REG FROM WR1RD1 RTN      11860002
R15      EQU   15                       RETURN CODE/WORK REGISTER       11900021
RMOVESZ  EQU   R15                      INPUT LENGTH FOR MOVE RTN       11960002
         EJECT                                                          12000021
*********************************************************************** 12100021
****                                                               **** 12200021
****     MASKS, DISPLACEMENTS, AND OTHER EQUATES                   **** 12300021
****                                                               **** 12400021
*********************************************************************** 12500021
         SPACE                                                          12600021
RCDZERO  EQU   X'00'                    USED TO INDICATE RECORD ZERO    12700021
NOTLAST  EQU   X'00'                    USED TO CHK STATUS OF DIRECTORY 12800021
UNITEXPT EQU   X'01'                    MASK FOR UNIT EXCEPTION         12900021
NOROOM   EQU   X'0C'                    NO ROOM IN DIRECTORY ERROR CODE 13000021
IOERROR  EQU   X'10'                    I/O ERROR CODE                  13100021
STOWPERF EQU   X'80'                    USED TO INDICATE STOW    M1088  13150021
*                                       HAS BEEN PERFORMED       M1088  13160021
DIRECTRY EQU   1                        IND I/O ERROR ENCOUNTER- Y02072 13210002
*                                       ED IN THE DIRECTORY      Y02072 13260002
OFF      EQU   X'FF'                    ALL-FLAGS-ON MASK       YA06505 13310037
         EJECT                                                          13700021
****                                                                    13800021
****     ESTABLISH ADDRESSABILITY                                       13900021
****                                                                    14000021
         BALR  RBASE,0                  INITIALIZE BASE REGISTER        14100002
         USING *,RBASE                  ESTABLISH ADDRESSABILITY        14200021
         USING STWAREA,RAREA            ESTABLISH WORK AREA BASE REG    14300021
         USING IHADCB,RDCB              ESTABLISH DCB BASE REGISTER     14400021
         SPACE 2                                                        14500021
****                                                                    14600021
****     IF THE FIRST LOAD HAS OVERLAID THE TWO DIRECTORY BLOCKS WHICH  14700021
****     CONTAIN THE ONLY OR LOWER OF TWO ARGUMENTS, THEY MUST BE       14800021
****     RE-READ AT THIS TIME.                                          14900021
****                                                                    15000021
         TM    STWFLAG1,STWFLOW         HAS FIRST LOAD OVERLAID FIRST   15100021
*                                       DIRECTORY BLOCKS READ           15200021
         BNO   INITPTRS                 NO, GO TO INIT BUFFER POINTERS  15300021
         SPACE 2                                                        15400021
****                                                                    15500021
****     RE-READ ORIGINAL DIRECTORY BLOCKS.                             15600021
****                                                                    15700021
INITBFRS EQU   *                                                        15800021
         NI    STWFLAG1,OFF-STWFLOW-STWMERGE    RE-SET FUNCTION YA06505 15850037
*                                       FLOW/MERGE INDICATORS   YA06505 15860037
         MVI   STWRDFL3,0               TURN OFF COMMAND CHAIN  YA06505 15910037
*                                       AND SKIP IF MERGE OCCUR YA06505 15960037
         LA    RWORK1,STWINCP           GET ADDR OF BUFFER INITIALI-    16000021
*                                       ZATION CHANNEL PROGRAM          16100021
         ST    RWORK1,IOBSTART          SET UP CHANNEL PROG ADDR IN IOB 16200021
         L     RWORK1,DCBDEBAD          GET ADDR OF CALLERS DEB  Y02072 16300002
         USING DEBBASIC,RWORK1          ESTABLISH DEB BASE REGISTER     16400002
         MVC   IOBCC(L'IOBCC+L'IOBHH),DEBBASND+(DEBSTRCC-DEBDASD)       16500002
*                                       GET DATA SET STARTING CCHH      16550002
*                                       FROM THE DEB                    16600002
         MVI   IOBR,RCDZERO             SET SEARCH TO BEGIN AT RECORD 0 16700021
         DROP  RWORK1                   DROP DEB BASE REGISTER          16800002
         MVC   STWKYAD1,STWPARM+1       SET KEY TO READ ORIGINAL BLOCKS 16900021
         BAL   REXCPRET,EXCP            GO ISSUE EXCP                   17000002
         SPACE 2                                                        17100021
****                                                                    17200021
****     INITIALIZE INPUT BUFFER, OUTPUT BUFFER, AND CHANNEL PROGRAM    17300021
****     POINTERS.                                                      17400021
****                                                                    17500021
INITPTRS EQU   *                                                        17600021
         LA    RIBFR,STWBUF1            INIT INPUT PTR TO FIRST BUFFER  17700021
         LA    RWORK1,STWBUF2           GET ADDRESS OF SECOND BUFFER    17800021
         LA    ROBFR,STWBUF3            INIT OUTPUT PTR TO THIRD BFR    17900021
         USING BUFFER,ROBFR             ESTABLISH BASE FOR THIRD BUFFER 18000021
         ST    RIBFR,BUFADDR            CHAIN FIRST BUFFER TO THIRD     18100021
         DROP  ROBFR                    DROP THIRD BUFFER BASE REG      18200021
         USING BUFFER,RWORK1            ESTABLISH BASE FOR SECOND BFR   18300021
         ST    ROBFR,BUFADDR            CHAIN THIRD BUFFER TO SECOND    18400021
         DROP  RWORK1                   DROP SECOND BUFFER BASE REG     18500021
         USING BUFFER,RIBFR             ESTABLISH INPUT BFR BASE REG    18600021
         ST    RWORK1,BUFADDR           CHAIN SECOND BUFFER TO FIRST    18700021
         LH    RWORK2,STWOFFLW          GET OFFSET TO ADD OR DELETE     18800021
*                                       POSITION WITHIN INPUT BUFFER    18900021
         AR    RWORK2,RIBFR             CALC ADDRESS OF SAME            19000021
         LH    REMAIN,BUFN              GET USED SPACE IN INPUT BLOCK   19100021
         SH    REMAIN,COUNTSZ           CALCULATE SIZE OF ENTRIES       19200021
         LA    RWORK1,STWWRDCP          GET ADDR OF WRITE/READ CHANNEL  19300021
*                                       PROGRAM                         19400021
         ST    RWORK1,IOBSTART          SET UP CHANNEL PROG ADDR IN IOB 19500021
         SPACE 2                                                        19600021
****                                                                    19700021
****     MOVE THE DIRECTORY ENTRIES PRECEDING THE ADD OR DELETE         19800021
****     LOCATION TO THE OUTPUT BUFFER.                                 19900021
****                                                                    20000021
         LA    RMOVE,BUFENTRY           INIT MOVE POINTER TO THE FIRST  20100021
*                                       ENTRY IN THE INPUT BUFFER       20200021
         LR    RMOVESZ,RWORK2           CALCULATE SIZE OF ENTRIES PRE-  20300002
         SR    RMOVESZ,RMOVE            CEDING THE ADD LOCATION         20400002
         DROP  RIBFR                    DROP INPUT BFR BASE REG         20500021
         USING BUFFER,ROBFR             ESTABLISH OUTPUT BFR BASE REG   20600021
         LA    RFILL,BUFENTRY           INIT FILL PTR WITHIN OUTPUT BFR 20700021
         MVC   BUFCNT,BUFCNT-BUFFER(RIBFR)  MOVE COUNT FIELD TO         20800021
*                                       OUTPUT BUFFER                   20900021
         LA    RSPACE,L'BUFENTRY        INIT UNUSED SPACE IN OUTPUT BFR 21000021
         BAL   RMOVERET,MOVEMANY        MOVE ENTRIES TO OUTPUT BFR      21100002
         DROP  ROBFR                    DROP OUTPUT BFR BASE REG        21200021
         SPACE 2                                                        21300021
****                                                                    21400021
****     DETERMINE THE FUNCTION TO BE PERFORMED.                        21500021
****                                                                    21600021
         TM    STWFLAG1,STWADD+STWREPL+STWCHNG   IS FUNCTION DELETE     21700021
         BZ    DELETE                   YES, GO DO DELETE               21800021
         TM    DCBMACF1,DCBMRECP        TEST FOR EXCP          @ZA02261 21850037
         BO    NOEXCP                   YES,BYPASS CHECK ON    @ZA02261 21860037
*                                       DIRECTORY BLOCK        @ZA02261 21870037
         CLI   DCBDIRCT+1,NOTLAST       ARE THERE ANY ENTRIES IN THE    21900021
*                                       LAST DIRECTORY BLOCK            22000021
         BE    ADDCHECK                 NO, NO NEED FOR A DRY RUN       22100021
NOEXCP   EQU   *                                               @ZA02261 22150037
         XI    STWFLAG1,STWDRYRN        SET DRY RUN SWITCH              22200021
         SPACE                                                          22300021
ADDCHECK EQU   *                                                        22400021
         TM    STWFLAG1,STWADD+STWREPL  IS FUNCTION ADD, ADD-DELETE     22500021
*                                       CHANGE, OR REPLACE              22600021
         BZ    DELETE                   NO, GO DO DELETE-ADD CHANGE     22700021
         SPACE 2                                                        22800021
****                                                                    22900021
****     PERFORM INITIALIZATION FOR ADD, ADD-DELETE CHANGE, AND REPLACE 23000021
****     FUNCTIONS.  ALSO DETERMINE WHETHER THE ENTRY TO BE ADDED WILL  23100021
****     FIT IN THE FIRST OUTPUT BLOCK.                                 23200021
****                                                                    23300021
         TM    STWFLAG1,STWREPL         IS FUNCTION REPLACE             23400021
         BNO   FITCHK                   NO, GO CHECK NEW ENTRY FIT      23500021
         BAL   RCALCRET,CALCSIZE        GO CALC SIZE OF REPLACED ENTRY  23600002
         SR    REMAIN,RSIZE             DECR AMOUNT IN INPUT BUFFER     23700021
         LA    RWORK2,0(RSIZE,RWORK2)   INCR REMAINING ENTRIES POINTER  23800021
*                                       PAST ENTRY BEING REPLACED       23900021
         SPACE                                                          24000021
FITCHK   EQU   *                                                        24100021
         LA    RMOVE,STWNEWNM           POINT TO ENTRY TO BE ADDED      24200021
         BAL   RCALCRET,CALCSIZE        GO CALC SIZE OF NEW ENTRY       24300002
         LA    REMAIN,0(RSIZE,REMAIN)   ADD NEW ENTRY SIZE TO AMOUNT    24400021
*                                       OF DATA IN THE INPUT BUFFER     24500021
         TM    STWFLAG1,STWCHNG+STWDEL  IS FUNCTION DELETE-ADD CHANGE   24600021
         BO    ADD                      YES, BYPASS DRY RUN AND FIT CHK 24700021
         TM    STWFLAG1,STWDRYRN        IS THIS A DRY RUN               24800021
         BNO   ADD                      NO, GO TO ADD NEW ENTRY         24900021
         CR    REMAIN,RSPACE            CAN NEW ENTRY BE ADDED TO FIRST 25000021
*                                       INPUT BLOCK                     25100021
         BH    ADD                      NO, GO TO BEGIN MOVING DATA     25200021
         NI    STWFLAG1,X'FF'-STWDRYRN  TURN OFF DRY RUN SWITCH         25300002
         SPACE 2                                                        25400021
****                                                                    25500021
****     IF SPACE IS AVAILABLE, MOVE THE ENTRY TO BE ADDED INTO THE     25600021
****     CURRENT OUTPUT BUFFER.  OTHERWISE, WRITE THE OUTPUT BUFFER,    25700021
****     READ IN ANOTHER BLOCK, AND CONSTRUCT A NEW OUTPUT BUFFER AND   25800021
****     MOVE THE ENTRY TO BE ADDED INTO IT.                            25900021
****                                                                    26000021
ADD      EQU   *                                                        26100021
         LR    RMOVESZ,RSIZE            AMOUNT OF DATA TO BE MOVED      26200002
         BAL   RMOVERET,MOVEONE         MOVE NEW ENTRY TO OUTPUT BFR    26300002
         LTR   RMOVESZ,RMOVESZ          WAS MOVE SUCCESSFUL             26400002
         BZ    MOVEREST                 YES, CONT FILLING OUTPUT BFR    26500021
         TM    IOBCSW+3,UNITEXPT        DID UNIT EXCEPTION OCCUR FOR    26600021
*                                       LAST READ ISSUED                26700021
         BO    NOTROOM                  YES, IND NO ROOM IN DIRECTORY   26800021
         BAL   RREADRET,WR1RD1          GO WRITE OUTPUT BFR AND READ    26900002
*                                       ANOTHER BLOCK INTO IT           27000021
         TM    STWFLAG1,STWMERGE        DID MERGE 2 BLKS OCCUR @ZA08321 27030037
         BO    ADD                      YES - BYPASS SET UP OF @ZA08321 27060037
*                                       COUNT FIELD            @ZA08321 27080037
         USING BUFFER,ROBFR             ESTABLISH OUTPUT BFR BASE REG   27100021
         L     RWORK1,BUFADDR           GET ADDR OF NEXT BLOCK READ     27200021
         MVC   BUFCNT,BUFCNT-BUFFER(RWORK1)  SET UP COUNT FIELD FOR     27300021
*                                       NEXT WRITE                      27400021
         B     ADD                      MOVE NEW ENTRY INTO OUTPUT BFR  27500021
         SPACE 2                                                        27600021
****                                                                    27700021
****     MOVE THE ENTRIES REMAINING IN THE INPUT BUFFER, WHICH FOLLOW   27800021
****     THE ADD OR REPLACE LOCATION, TO THE OUTPUT BUFFER.             27900021
****                                                                    28000021
MOVEREST EQU   *                                                        28100021
         LR    RMOVE,RWORK2             RESTORE MOVE POINTER TO ENTRIES 28200021
*                                       FOLLOWING THE ADD OR REPL LOC   28300021
         B     EXPAND                   BR TO COMPLETE DIRECTORY        28400021
         SPACE 2                                                        28500021
****                                                                    28600021
****     EXPAND THE DIRECTORY TO COMPENSATE FOR THE ENTRY JUST ADDED.   28700021
****                                                                    28800021
BYPASS   EQU   *                                                        28900021
         LA    RMOVE,0(RSIZE,RMOVE)     INCR MOVE PTR PAST ENTRY TO BE  29000021
*                                       DELETED FOR ADD-DELETE CHANGE   29100021
         SR    REMAIN,RSIZE             DECR DATA REMAINING BY DELETED  29200021
*                                       ENTRY SIZE                      29300021
         OI    STWFLAG1,STWFLOW         IND CHANGE SWITCH PERFORMED     29400021
         SPACE                                                          29500021
EXPAND   EQU   *                                                        29600021
         LTR   REMAIN,REMAIN            ANY MORE ENTRIES IN INPUT BFR   29700021
         BM    BADDIR                   SOMETHINGS WRONG WITH   SA72739 29750037
*                                       DIRECTORY - GET OUT     SA72739 29760037
         BZ    ADDENDCK                 NO, GO CHK IF BOTH BFRS HAVE    29800021
*                                       BEEN PROCESSED                  29900021
         BAL   RCALCRET,CALCSIZE        GET SIZE OF NEXT ENTRY          30000002
         SPACE                                                          30002002
CHKDELET EQU   *                                                XA02065 30004002
         TM    STWFLAG1,STWCHNG+STWADD  IS FUNCTION ADD-DELETE CHANGE   30100021
         BNO   MOVENTRY                 NO, GO TO MOVE ENTRY            30200021
         USING PDS2,RMOVE               ESTABLISH ENTRY BASE REGISTER   30300002
         CLC   PDS2NAME,STWOLDNM        IS THIS ENTRY TO BE DELETED     30400002
         BE    BYPASS                   YES, GO TO GET NEXT ENTRY       30500021
         DROP  RMOVE                    DROP ENTRY BASE REGISTER        30600021
         SPACE                                                          30700021
MOVENTRY EQU   *                                                        30800021
         LR    RMOVESZ,RSIZE            SIZE OF ENTRY TO BE MOVED       30900002
         BAL   RMOVERET,MOVEONE         GO MOVE ENTRY INTO OUTPUT BFR   31000002
         LTR   RMOVESZ,RMOVESZ          WAS MOVE SUCCESSFUL             31100002
         BZ    EXPAND                   YES, GO GET NEXT ENTRY          31200021
         SPACE 2                                                        31300021
****                                                                    31400021
****     WRITE COMPLETED OUTPUT BUFFER AND READ IN ANOTHER DIRECTORY    31500021
****     BLOCK.                                                         31600021
****                                                                    31700021
         TM    IOBCSW+3,UNITEXPT        DID UNIT EXCEPTION OCCUR FOR    31800021
*                                       LAST READ ISSUED                31900021
         BO    NOTROOM                  YES, IND NO ROOM IN DIRECTORY   32000021
         SPACE                                                          32100021
CONTADD  EQU   *                                                        32200021
         BAL   R14,WR1RD1               GO TO WRITE/READ ROUTINE        32300021
         TM    STWFLAG1,STWMERGE        DID 2 BLKS MERGE OCCUR @ZA08321 32330037
         BO    CHKDELET                 YES - BYPASS SET UP OF @ZA08321 32360037
*                                       COUNT FIELD            @ZA08321 32380037
         L     RWORK1,BUFADDR           GET ADDR OF NEXT BLOCK READ     32400021
         MVC   BUFCNT,BUFCNT-BUFFER(RWORK1)  SET UP COUNT FIELD FOR     32500021
*                                       NEXT WRITE                      32600021
         B     CHKDELET                 GO CHK ENTRY FOR DELETE XA02065 32700002
         SPACE 2                                                        32800021
****                                                                    32900021
****     DETERMINE IF THE NEXT TO THE LAST BLOCK READ HAS BEEN          33000021
****     PROCESSED.                                                     33100021
****                                                                    33200021
ADDENDCK EQU   *                                                        33300021
         CLC   BUFKEY,HIGHKEY           HAS LAST ENTRY BEEN PROCESSED   33400021
         BNE   BFRCHECK                 NO, GO TO CHECK INPUT BFRS      33500021
         TM    STWFLAG1,STWDRYRN        IS THIS A DRY RUN               33600021
         BO    INITBFRS                 YES, GO TO END DRY RUN          33700021
         B     UPDTEDCB                 GO TO UPDATE DCBDIRCT FIELD     33800021
         SPACE                                                          33900021
BFRCHECK EQU   *                                                        34000021
         LR    RWORK1,RIBFR             SAVE PTR FOR LATER COMPARISON   34100021
         DROP  ROBFR                    DROP OUTPUT BUFFER BASE REG     34200021
         USING BUFFER,RIBFR             ESTABLISH INPUT BUFFER BASE REG 34300021
         L     RIBFR,BUFADDR            GET ADDR OF NEXT BLOCK READ     34400021
         LH    REMAIN,BUFN              GET USED SPACE IN INPUT BLOCK   34500021
         SH    REMAIN,COUNTSZ           CALCULATE SIZE OF ENTRIES       34600021
         LA    RMOVE,BUFENTRY           INIT MOVE PTR TO FIRST ENTRY    34700021
         CR    RWORK1,ROBFR             HAS NEXT TO LAST BLOCK READ     34800021
*                                       BEEN PROCESSED                  34900021
         BE    EXPAND                   NO, CONT EXPANDING DIRECTORY    35000021
         SPACE 2                                                        35100021
****                                                                    35200021
****     IF THIS IS A DRY RUN, RETURN TO THE BEGINNING OF THE PROGRAM   35300021
****     TO MAKE THE ALTERATION RUN ON THE DIRECTORY.                   35400021
****                                                                    35500021
         TM    STWFLAG1,STWDRYRN        IS THIS A DRY RUN               35600021
         BO    INITBFRS                 YES, GO TO END DRY RUN          35700021
         SPACE 2                                                        35800021
****                                                                    35900021
****     DETERMINE IF THE DELETE FUNCTION REMAINS TO BE PERFORMED FOR   36000021
****     ADD-DELETE CHANGE.                                             36100021
****                                                                    36200021
DELETECK EQU   *                                                        36300021
         TM    STWFLAG1,STWCHNG+STWADD  IS FUNCT ADD-DELETE CHANGE      36400021
         BNO   SWTODEL                  NO, GO CHK FOR SWITCH TO DELETE 36500021
         BAL   RCALCRET,CALCSIZE        CALC SIZE OF FIRST ENTRY IN BFR 36600002
         TM    STWFLAG1,STWFLOW         HAS BLOCK WITH ENTRY TO BE      36700021
*                                       DELETED BEEN PROCESSED          36800021
         BNO   CONTADD                  NO, CONT READING AND WRITING    36900021
*                                       UNTIL BLOCK IS FOUND            37000021
         SPACE 2                                                        37100021
****                                                                    37200021
****     IF THE FUNCTION BEING PERFORMED IS CHANGE OR REPLACE, GO TO    37300021
****     THE DELETE ROUTINE TO ENSURE THAT THE DIRECTORY HAS BEEN       37400021
****     COMPRESSED.                                                    37500021
****                                                                    37600021
SWTODEL  EQU   *                                                        37700021
         TM    STWFLAG1,STWCHNG+STWREPL IS FUNCT CHANGE OR REPLACE      37800021
         BNZ   COMPRESS                 YES, GO TO COMPRESS DIRECTORY   37900021
         TM    STWFLAG1,STWMERGE        DID WE MERGE A BLK     YA06505  37950037
*                                       DURING COMPRESS        YA06505  37960037
         BO    COMPRESS                 IF YES MUST COMPRESS   YA06505  37970037
*                                       THE ENTIRE DIRECTORY   YA06505  37980037
         B     WRLAST                   NO, GO TO WRITE LAST BLOCK      38000021
         SPACE 2                                                        38100021
****                                                                    38200021
****     DELETE THE DIRECTORY ENTRY FOR THE FUNCTIONS OF DELETE OR      38300021
****     ADD-DELETE CHANGE.                                             38400021
****                                                                    38500021
DELETE   EQU   *                                                        38600021
         BAL   RCALCRET,CALCSIZE        CALC SIZE OF ENTRY TO BE        38700002
*                                       DELETED                         38800021
         SR    REMAIN,RSIZE             DECR DATA SIZE BY DELETED ENTRY 38900021
         LA    RMOVE,0(RSIZE,RMOVE)     INCR NEXT ENTRY PTR PAST ENTRY  39000021
         SPACE 2                                                        39100021
****                                                                    39200021
****     COMPRESS THE REMAINING ENTRIES IN THE DIRECTORY TO COMPENSATE  39300021
****     FOR THE SPACE LEFT BY THE DELETED ENTRY.                       39400021
****                                                                    39500021
COMPRESS EQU   *                                                        39600021
         LTR   REMAIN,REMAIN            ANY MORE ENTRIES IN INPUT BFR   39700021
         BM    BADDIR                   SOMETHINGS WRONG WITH   SA72739 39750037
*                                       DIRECTORY - GET OUT     SA72739 39760037
         BZ    DELENDCK                 NO, GO TO CHK FOR LAST ENTRY    39800021
         TM    STWFLAG1,STWCHNG+STWDEL  IS FUNCT DELETE-ADD CHANGE      39900021
         BNO   COMPMOVE                 NO, CONT COMPRESSING DIRECTORY  40000021
         TM    STWFLAG1,STWFLOW         HAS CHANGE SW BEEN PERFORMED    40100021
         BO    COMPMOVE                 YES, CONT COMPRESSING DIRECTORY 40200021
         USING PDS2,RMOVE               ESTABLISH ENTRY BASE REGISTER   40300002
         CLC   PDS2NAME,STWNEWNM        IS THIS THE LOCATION FOR THE    40400002
*                                       NEW ENTRY                       40500021
         BH    SWTOADD                  YES, GO TO SWITCH TO ADD MODE   40600021
         DROP  RMOVE                    DROP ENTRY BASE REGISTER        40700021
         SPACE                                                          40800021
COMPMOVE EQU   *                                                        40900021
         BAL   RCALCRET,CALCSIZE        GET SIZE OF NEXT ENTRY          41000002
         LR    RMOVESZ,RSIZE            SIZE OF ENTRY TO BE MOVED       41100002
         BAL   RMOVERET,MOVEONE         GO MOVE ENTRY INTO OUTPUT BFR   41200002
         LTR   RMOVESZ,RMOVESZ          WAS MOVE SUCCESSFUL             41300002
         BZ    COMPRESS                 YES, GO GET NEXT ENTRY          41400021
         LA    RWORK1,L'BUFN(,REMAIN)   INCR SIZE OF ENTRIES LEFT IN    41500021
*                                       INPUT BFR BY SIZE FIELD LENGTH  41600021
         CH    RWORK1,BUFN              HAVE ANY ENTRIES BEEN MOVED     41700021
*                                       FROM THE INPUT BFR              41800021
         BNE   CONTCOMP                 YES, CONTINUE COMPRESSING       41900021
         TM    STWFLAG1,STWMERGE        DID WE MERGE A BLK     YA06505  41950037
*                                       DURING COMPRESS        YA06505  41960037
         BO    CONTCOMP                 IF YES MUST COMPRESS   YA06505  41970037
*                                       THE ENTIRE DIRECTORY   YA06505  41980037
         TM    STWFLAG1,STWCHNG+STWDEL  IS FUNCT DELETE-ADD CHANGE      42000021
         BNO   WRLAST                   NO, GO TO WRITE OUT LAST BLOCK  42100021
*                                       PROCESSED                       42200021
         TM    STWFLAG1,STWFLOW         HAS CHANGE SW BEEN PERFORMED    42300021
         BO    WRLAST                   YES, GO TO WRITE OUT LAST BLOCK 42400021
*                                       PROCESSED                       42500021
         SPACE 2                                                        42600021
****                                                                    42700021
****     WRITE COMPLETED OUTPUT BUFFER AND READ IN ANOTHER DIRECTORY    42800021
****     BLOCK.                                                         42900021
****                                                                    43000021
CONTCOMP EQU   *                                                        43100021
         BAL   RREADRET,WR1RD1          GO TO WRITE/READ ROUTINE        43200002
         DROP  RIBFR                    DROP INPUT BFR BASE REGISTER    43300021
         USING BUFFER,ROBFR             ESTABLISH OUTPUT BFR BASE REG   43400021
         TM    STWFLAG1,STWMERGE        DID MERGE OF 2 BLKS    YA06505  43450037
*                                       INTO ONE OCCUR         YA06505  43460037
         BO    COMPMOVE                 YES, THEN COUNT FIELD  YA06505  43470037
*                                       IN OUTPUT BUFFER IS OK YA06505  43480037
         MVC   BUFCNT,BUFCNT-BUFFER(RIBFR)  MOVE COUNT FIELD TO OUTPUT  43500021
*                                       BUFFER                          43600021
         B     COMPMOVE                 CONT COMPRESSING DIRECTORY      43700021
         SPACE 2                                                        43800021
****                                                                    43900021
****     DETERMINE IF THE LAST DIRECTORY ENTRY HAS BEEN PROCESSED.  IF  44000021
****     SO, GO TO UPDATE THE DCBDIRCT FIELD.  OTHERWISE, CONTINUE      44100021
****     COMPRESSING THE DIRECTORY.                                     44200021
****                                                                    44300021
DELENDCK EQU   *                                                        44400021
         CLC   BUFKEY,HIGHKEY           HAS LAST ENTRY BEEN PROCESSED   44500021
         BE    UPDTEDCB                 YES, GO TO UPDATE DCBDIRCT FLD  44600021
         DROP  ROBFR                    DROP OUTPUT BFR BASE REGISTER   44700021
         USING BUFFER,RIBFR             ESTABLISH INPUT BFR BASE REG    44800021
         L     RIBFR,BUFADDR            GET ADDR OF NEXT INPUT BFR      44900021
         TM    STWFLAG1,STWMERGE        MERGE OF 2 BLKS        @ZA10229 44950037
         BZ    CHECKBUF                 NO -CONTINUE           @ZA10229 44953037
         BAL   R14,WR1RD1               WRITE OUT ONE BLK      @ZA10229 44956037
         B     BYWRTBLK                 CONTINUE               @ZA10229 44959037
CHECKBUF EQU   *                                               @ZA10229 44962037
         CR    RIBFR,ROBFR              HAVE BOTH INPUT BUFFERS OX00801 44965037
*                                       BEEN EMPTIED            OX00801 44968037
         BNE   BYWRTBLK                 CONT COMPRESS IF NOT    OX00801 44971037
****                                                                    44980037
****     TWO DIRECTORY BLOCKS HAVE MERGED INTO ONE. MUST SET            44982037
****     A SWITCH SO THAT COMPRESS WILL CONTINUE TO END OF              44984037
****     THE DIRECTORY.  TWO DIRECTORY BLOCKS WILL BE READ IN           44986037
****     AT THIS POINT INSTEAD OF JUST ONE. THE NEW OUTPUT              44988037
****     BUFFER MUST PROGRESS TWO BUFFERS FORWARD THIS TIME.            44988437
****                                                                    44988837
         OI    STWFLAG1,STWMERGE        SET BIT IDENTIFYING     YA06505 44989237
*                                       THIS MERGE OF 2 BLKS    YA06505 44989637
         OI    STWRDFL3,STWCMDCH        TURN ON COMMAND CHAIN   YA06505 44989737
*                                       TO READ A 2ND BLOCK     YA06505 44989837
         MVC   STWRDAD4,BUFADDR+1       MAKE NXT BUFFER THE IN- YA06505 44989937
*                                       PUT BUFFER FOR 2ND BLK  YA06505 44993537
         BAL   R14,WR1RD1               GO WRT 1 BLK,READ 2     YA06505 44995537
         DROP  RIBFR                    DROP INPUT BUFFER       YA06505 44995937
         USING BUFFER,ROBFR             OUTPUT BUFFER IS BASE   YA06505 44996337
         L     ROBFR,BUFADDR            UPDATE NEW OUTPUT BUF   YA06505 44996737
*                                       1 MORE BUFFER, SINCE WE YA06505 44997137
*                                       READ 2 BLKS IN. THE     YA06505 44997437
*                                       COUNT FIELD IN THIS NEW YA06505 44997837
*                                       OUTPUT BUFFER IS OK     YA06505 44997937
         LA    RFILL,BUFENTRY           INITIALIZE FILL POINTER YA06505 44998037
*                                       FOR THIS OUTPUT BUFFER  YA06505 44998137
         OI    STWRDFL3,STWSKIP         SUPPRESS DATA TRANSFER  YA06505 44998237
*                                       ON THIS RD - WILL BE 2  YA06505 44998337
*                                       BLKS AHEAD FROM NOW ON  YA06505 44998637
         DROP  ROBFR                    DROP OUTPUT BUFFER      YA06505 44999037
*                                                                       44999137
BYWRTBLK EQU   *                                                OX00801 44999237
         USING BUFFER,RIBFR             INPUT BUFFER IS BASE    YA06505 44999337
         LH    REMAIN,BUFN              GET USED SPACE IN INPUT BLOCK   45066702
         SH    REMAIN,COUNTSZ           CALCULATE SIZE OF ENTRIES       45100021
         LA    RMOVE,BUFENTRY           INIT MOVE PTR TO FIRST ENTRY    45200021
         B     COMPRESS                 CONT COMPRESSING DIRECTORY      45300021
         DROP  RIBFR                    DROP INPUT BFR BASE REGISTER    45400021
         SPACE 2                                                        45500021
****                                                                    45600021
****     GO TO THE ADD ROUTINE TO ADD THE NEW ENTRY FOR THE DELETE-ADD  45700021
****     CHANGE FUNCTION.                                               45800021
****                                                                    45900021
SWTOADD  EQU   *                                                        46000021
         OI    STWFLAG1,STWFLOW         IND CHANGE SWITCH HAS BEEN      46100021
*                                       PERFORMED                       46200021
         LR    RWORK2,RMOVE             INIT MOVE PTR FOR ADD ROUTINE   46300021
         B     FITCHK                   GO TO ADD NEW ENTRY             46400021
         SPACE 2                                                        46500021
****                                                                    46600021
****     IF UNIT EXCEPTION OCCURED WHILE ATTEMPTING TO READ ANOTHER     46700021
****     BLOCK, WHICH IS REQUIRED TO EXPAND THE DIRECTORY, RETURN TO    46800021
****     THE USER WITH A 'NO ROOM' ERROR CODE.                          46900021
****                                                                    47000021
NOTROOM  EQU   *                                                        47100021
         LA    RRETCODE,NOROOM          SET NO ROOM ERROR CODE   YM0943 47200002
         B     RTRNUSR1                 GO TO RETURN ROUTINE     Y02072 47300002
         SPACE 2                                                        47400021
****                                                                    47450037
****     SOMETHING IS WRONG WITH THE USER'S DIRECTORY. EITHER           47460037
****     THE TOTAL LENGTH OF BYTES USED IN THE DIRECTORY IS             47470037
****     WRONG OR THE BYTES OF USER INFORMATION FOR A MEMBER            47480037
****     IS WRONG. THIS PROBLEM IS DETECTED WHEN THE BYTE               47490037
****     COUNTER HAS GONE NEGATIVE.                                     47492037
****                                                                    47494037
BADDIR   EQU   *                        DIRECTORY IS BAD        SA72739 47496037
         LA    R9,IOERROR               PROBLEM IS UNKNOWN AND  SA72739 47498037
*                                       MAY BE CAUSED BY IO ERR SA72739 47498437
         B     RTRNUSR1                 GO TO RETURN ROUTINE    SA72739 47499237
****                                                                    47500021
****     IF THE LAST BLOCK OF THE DIRECTORY WAS USED, STORE INTO THE    47600021
****     DCBDIRCT FIELD ONE LESS THAN THE NUMBER OF BYTES USED IN THE   47700021
****     BLOCK.  OTHERWISE, SET THE DCBDIRCT FIELD TO ZEROS.            47800021
****                                                                    47900021
UPDTEDCB EQU   *                                                        48000021
         SR    RWORK1,RWORK1            INIT REG TO IND NOT LAST BLOCK  48100021
         TM    IOBCSW+3,UNITEXPT        DID UNIT EXCEPTION OCCUR ON     48200021
*                                       LAST BLOCK READ                 48300021
         BNO   STDIRCT                  NO, GO TO STORE NOT LAST INDR   48400021
         LA    RWORK1,L'BUFDATA-1       GET BUFFER DATA LENGTH MINUS 1  48500021
         SR    RWORK1,RSPACE            CALC ONE LESS THAN USED SPACE   48600021
         SPACE                                                          48700021
STDIRCT  EQU   *                                                        48800021
         TM    DCBMACF1,DCBMRECP        TEST FOR EXCP          @ZA02261 48850037
         BO    WRLAST                   YES, BYPASS UPDATE     @ZA02261 48860037
*                                       ON DCBDIRCT FIELD      @ZA02261 48870037
         STC   RWORK1,DCBDIRCT+1        UPDATE DCBDIRCT FIELD           48900021
         SPACE 2                                                        49000021
****                                                                    49100021
****     WRITE THE LAST DIRECTORY BLOCK PROCESSED.                      49200021
****                                                                    49300021
WRLAST   EQU   *                                                        49400021
         NI    STWWFLG2,X'FF'-STWCMDCH  SUPPRESS THE READ OPERATIONS    49500002
         BAL   RREADRET,WR1RD1          GO TO WRITE LAST BLOCK          49600002
         OI    DCBCIND2,STOWPERF        INDICATE STOW PERFORMED  M1088  49650021
         SPACE 2                                                        49700021
****                                                                    49800021
****     FREE THE GOTTEN CORE, PUT THE REASON CODE IN REGISTER 0, THE   49900002
****     RETURN CODE IN REGISTER 15, AND RETURN TO THE CALLER.          50000002
****                                                                    50100021
         SR    RRETCODE,RRETCODE        CLEAR REGISTER           YM0943 50200002
         IC    RRETCODE,STWRTN          GET RETURN CODE SAVED BY YM0943 50300002
*                                       THE FIRST LOAD           YM0943 50400001
         SPACE                                                          50410002
RTRNUSR1 EQU   *                                                 Y02072 50450002
         SR    REASONCD,REASONCD        CLEAR REASON CODE REG    Y02072 50460002
         SPACE                                                          50500021
RTRNUSR2 EQU   *                                                 Y02072 50600002
         FREEMAIN  R,LV=CORESIZE,A=(RAREA),SP=229  FREE AREA     Y02072 50900002
         SPACE                                                          50902002
         LR    R0,REASONCD              GET THE REASON CODE      Y02072 50910002
         LR    R15,RRETCODE             GET THE RETURN CODE      YM0943 50950002
         USING PSA,0                    ESTABLISH PSA BASE REG   Y02072 50962002
         L     RWORK1,PSATOLD           GET CURRENT TCB ADDR     Y02072 50980002
         USING TCB,RWORK1               ESTABLISH TCB BASE REG   Y02072 50982002
         L     RWORK1,TCBRBP            GET STOW SVRB ADDR       Y02072 50990002
         USING RBSECT,RWORK1            EST SVRB BASE REG        Y02072 50992002
         L     R14,XSAREG14             RESTORE RETURN REGISTER  Y02072 50996002
         DROP  RWORK1                   DROP SVRB BASE REG       Y02072 50998002
         SPACE 2                                                        50998402
****                                                                    50998802
****     MODESET TO KEY 0 AND RETURN TO THE CALLER.                     50999202
****                                                                    50999602
         MODESET EXTKEY=SUPR            MODESET TO KEY 0         Y02072 50999702
         BR    R14                      RETURN TO THE CALLER     Y02072 51000002
         EJECT                                                          51100021
*********************************************************************** 51200021
****                                                               **** 51300021
****     THIS SUBROUTINE IS USED TO COMPLETE THE OUTPUT BUFFER,    **** 51400021
****     SET UP THE CHANNEL PROGRAM TO WRITE THE OUTPUT BUFFER AND **** 51500021
****     READ ANOTHER DIRECTORY BLOCK INTO A FOURTH BUFFER,        **** 51550037
****     FROM WHERE IT IS MOVED INTO THE OUTPUT BUFFER. IF         **** 51560037
****     TWO INPUT BLOCKS MERGED COMPLETELY INTO ONE OUTPUT        **** 51570037
****     BUFFER, TWO NEW BLOCKS ARE READ IN. A NEW OUTPUT          **** 51580037
****     BUFFER (THE NEXT IN THE CHAIN) IS INITIALIZED.            **** 51590037
****                                                               **** 51800021
****     INPUT REGISTERS -                                         **** 51900021
****           RIBFR  - ADDRESS OF THE INPUT BUFFER                **** 52000021
****           ROBFR  - ADDRESS OF THE OUTPUT BUFFER               **** 52100021
****           RSPACE - UNUSED SPACE IN THE OUTPUT BUFFER          **** 52200021
****           R14    - RETURN ADDRESS                             **** 52300021
****                                                               **** 52400021
****     OUTPUT REGISTERS -                                        **** 52500021
****           RIBFR  - SAME AS ENTRY                              **** 52600021
****           ROBFR  - ADDRESS OF NEW OUTPUT BUFFER               **** 52700021
****           RSPACE - INITIALIZED TO BUFFER ENTRY AREA SIZE      **** 52800021
****           RFILL  - ADDRESS OF OUTPUT BUFFER ENTRY AREA        **** 52900021
****                                                               **** 53000021
*********************************************************************** 53100021
WR1RD1   EQU   *                                                        53200021
         LA    RWORK1,L'BUFDATA         GET SIZE OF BUFFER DATA AREA    53300021
         SR    RWORK1,RSPACE            CALC USED SPACE IN OUTPUT BFR   53400021
         USING BUFFER,ROBFR             ESTABLISH OUTPUT BFR BASE REG   53500021
         STH   RWORK1,BUFN              PUT USED SPACE INTO OUTPUT BFR  53600021
         ST    ROBFR,STWIDAD2-1         SET UP SEARCH ID ADDRESS        53700021
         MVI   STWSRCH2,STWIDEQ         RESTORE SEARCH ID EQUAL COMMAND 53800021
         LA    RWORK1,STWBUF4           POINT TO INPUT BUFFER   SA66881 53850037
         ST    RWORK1,STWRDAD3-1        SET UP C/K/D ADDRESS    SA66881 53860037
         MVI   STWRCKD3,STWRDCKD        RESTORE READ C/K/D COMMAND      54000021
*                                                                       54050037
         TM    STWRDFL3,STWSKIP         HAVE THE NEXT 2 BLKS    YA06505 54060037
*                                       BEEN READ IN ALREADY    YA06505 54070037
*                                       (DID A MERGE OCCUR?)    YA06505 54080037
         BNO   BUFOK                    NO, THEN READ IN NEXT   YA06505 54090037
         MVC   STWRDAD4,STWRDAD3        YES, SET UP LAST READ   YA06505 54092037
*                                       CKD WITH BUFFER 4 ADDR  YA06505 54094037
*                                       HAVE READ IN THE 2 BLKS YA06505 54096037
*                                       AFTER THE ONE WRITTEN   YA06505 54098037
BUFOK    EQU   *                        SET UP WRITE ADDRESS    YA06505 54098437
         LA    RWORK1,BUFKEY            GET ADDRESS OF KEY AREA         54100021
         ST    RWORK1,STWWRAD2-1        SET UP WRITE KEY/DATA ADDRESS   54200021
         MVI   STWWRKD1,STWWRKD         RESTORE WRITE KEY/DATA COMMAND  54300021
         TM    STWFLAG1,STWDRYRN        IS THIS A DRY RUN               54400021
         BNO   GOTOEXCP                 NO, GO TO ISSUE EXCP            54500021
         MVI   STWWRKD1,STWRDKD         REPLACE WRITE COMMAND WITH A    54600021
*                                       READ IN ORDER TO SUPPRESS DATA  54700021
*                                       TRANSFER FOR THE WRITE CCW      54800021
         SPACE                                                          54900021
GOTOEXCP EQU   *                                                        55000021
         MVC   IOBCC(5),0(ROBFR)        SET UP CCHHR OF IOBSEEK FIELD   55100021
         BAL   REXCPRET,EXCP            GO ISSUE EXCP                   55200002
         MVC   0(L'BUFCNT+L'BUFKEY,ROBFR),STWBUF4 MOVE C/K FLDS SA66881 55250037
         MVC   16(L'BUFDATA,ROBFR),STWBUF4+16 MOVE DIR. BLOCK   SA66881 55260037
****                                                                    55270037
****     THE COUNT/KEY/DATA FIELDS ARE NOT READ DIRECTLY INTO           55292437
****     THE OUTPUT BUFFER, TO PROTECT THE OUTPUT BUFFER, SHOULD        55292837
****     ERROR RETRY BE REQUIRED.                                       55293237
****                                                                    55294037
         L     ROBFR,BUFADDR            INIT OUTPUT BFR POINTER         55300021
         LA    RFILL,BUFENTRY           INIT FILL POINTER               55400021
         LA    RSPACE,L'BUFENTRY        INIT UNUSED SPACE IN OUTPUT BFR 55500021
         DROP  ROBFR                    DROP OUTPUT BFR BASE REG        55600021
         BR    RREADRET                 RETURN TO CALLER                55700002
         EJECT                                                          55800021
*********************************************************************** 55900021
****                                                               **** 56000021
****     THIS SUBROUTINE IS USED TO MOVE AN ENTRY OR ENTRIES FROM  **** 56100021
****     THE INPUT BUFFER TO THE OUTPUT BUFFER AND UPDATE THE KEY  **** 56200021
****     FIELD OF THE OUTPUT BUFFER FOLLOWING EACH MOVE.  THERE    **** 56300021
****     ARE TWO ENTRY POINTS TO THIS SUBROUTINE.  THE FIRST IS    **** 56400021
****     USED TO MOVE ONE OR MORE ENTRIES OF UNKNOWN SIZE AND THE  **** 56500021
****     SECOND TO MOVE ONE ENTRY OF KNOWN SIZE.                   **** 56600021
****                                                               **** 56700021
****     INPUT REGISTERS -                                         **** 56800021
****           RMOVE  - ADDRESS DATA IS TO BE MOVED FROM           **** 56900021
****           RFILL  - ADDRESS DATA IS TO BE MOVED TO             **** 57000021
****           RSIZE  - SIZE OF ENTRY (SECOND ENTRY ONLY)          **** 57100021
****           REMAIN - AMOUNT OF DATA REMAINING IN INPUT BUFFER   **** 57200021
****           RSPACE - AMOUNT OF UNUSED SPACE IN OUTPUT BUFFER    **** 57300021
****           ROBFR  - ADDRESS OF OUTPUT BUFFER                   **** 57400021
****           R15    - AMOUNT OF DATA TO BE MOVED (EQUAL TO RSIZE **** 57500021
****                    FOR SECOND ENTRY)                          **** 57600021
****           R14    - RETURN ADDRESS                             **** 57700021
****                                                               **** 57800021
****     OUTPUT REGISTERS -                                        **** 57900021
****           RMOVE  - INCREMENTED BY AMOUNT OF DATA MOVED        **** 58000021
****           RFILL  - INCREMENTED BY AMOUNT OF DATA MOVED        **** 58100021
****           RSIZE  - AMOUNT OF DATA REMAINING TO BE MOVED       **** 58200021
****           REMAIN - AMOUNT OF DATA REMAINING IN INPUT BUFFER   **** 58300021
****           RSPACE - AMOUNT OF UNUSED SPACE IN OUTPUT BUFFER    **** 58400021
****           ROBFR  - SAME AS INPUT                              **** 58500021
****           R15    - AMOUNT OF DATA UNABLE TO MOVE              **** 58600021
****                                                               **** 58700021
*********************************************************************** 58800021
MOVEMANY EQU   *                                                        58900021
         LTR   RMOVESZ,RMOVESZ          HAS ALL DATA BEEN MOVED         59000002
         BZR   RMOVERET                 YES, RETURN TO CALLER           59100002
         BAL   RCALCRET,CALCSIZE        GO GET SIZE OF NEXT ENTRY       59200002
         SPACE                                                          59300021
MOVEONE  EQU   *                                                        59400021
         CR    RSPACE,RSIZE             WILL ENTRY FIT IN OUTPUT BFR    59500021
         BLR   RMOVERET                 NO, RETURN TO CALLER            59600002
         SR    RMOVESZ,RSIZE            CALC AMOUNT LEFT TO BE MOVED    59700002
         SR    REMAIN,RSIZE             DECR DATA LEFT IN INPUT BFR     59800021
         SR    RSPACE,RSIZE             DECR UNUSED SPACE IN OUTPUT BFR 59900021
         USING BUFFER,ROBFR             ESTABLISH OUTPUT BFR BASE REG   60000021
         USING PDS2,RMOVE               ESTABLISH ENTRY BASE REG        60100002
         MVC   BUFKEY,PDS2NAME          UPDATE OUTPUT BFR KEY FIELD     60200002
         DROP  ROBFR,RMOVE              DROP BASE REGISTERS             60300021
         BCTR  RSIZE,R0                 DECR REG FOR CORRECT MOVE LNTH  60400021
         EX    RSIZE,MOVEIT             MOVE ENTRY TO OUTPUT BFR        60500021
         LA    RMOVE,1(RSIZE,RMOVE)     INCR MOVE PTR PAST MOVED ENTRY  60600021
         LA    RFILL,1(RSIZE,RFILL)     INCR FILL PTR PAST MOVED ENTRY  60700021
         B     MOVEMANY                 CONTINUE MOVING ENTRIES         60800021
         SPACE                                                          60900021
MOVEIT   EQU   *                                                        61000021
         MVC   0(0,RFILL),0(RMOVE)      MOVE FOR EXECUTE INSTRUCTION    61100021
         SPACE 2                                                        61200021
*********************************************************************** 61300021
****                                                               **** 61400021
****     THIS SUBROUTINE IS USED TO CALCULATE THE SIZE OF A        **** 61500021
****     DIRECTORY ENTRY AND RETURN IT IN REGISTER R15.            **** 61600021
****                                                               **** 61700021
****     INPUT REGISTERS -                                         **** 61800021
****           RMOVE - ADDR OF ENTRY WHOSE SIZE IS TO BE CALCULATED**** 61900021
****           R13   - RETURN ADDRESS                              **** 62000021
****                                                               **** 62100021
****     OUTPUT REGISTERS -                                        **** 62200021
****           RMOVE - SAME AS INPUT                               **** 62300021
****           RSIZE - SIZE OF ENTRY                               **** 62400021
****                                                               **** 62500021
*********************************************************************** 62600021
CALCSIZE EQU   *                                                        62700021
         USING PDS2,RMOVE               ESTABLISH ENTRY BASE REGISTER   62800002
         IC    RSIZE,PDS2INDC           GET USER DATA SIZE              62900002
         SLL   RSIZE,27                 SHIFT OFF ALAIS BIT AND NUMBER  63000021
*                                       OF TTRN'S                       63100021
         SRL   RSIZE,26                 REPOSITION DATA SIZE AND CON-   63200021
*                                       VERT HALFWORDS TO BYTES         63300021
         LA    RSIZE,L'PDS2NAME+L'PDS2TTRP+L'PDS2INDC(,RSIZE)           63400002
*                                       CALCULATE TOTAL SIZE OF ENTRY   63402002
         DROP  RMOVE                    DROP ENTRY BASE REGISTER        63500021
         BR    RCALCRET                 RETURN TO USER                  63600002
         SPACE 2                                                        63700021
*********************************************************************** 63800021
****                                                               **** 63900021
****     THIS SUBROUTINE IS USED TO EXECUTE A CHANNEL PROGRAM AND  **** 64000021
****     CHECK THE STATUS FOLLOWING COMPLETION.                    **** 64100021
****                                                               **** 64200021
****     INPUT REGISTERS -                                         **** 64300021
****           R13 - RETURN ADDRESS                                **** 64400021
****                                                               **** 64500021
****     OUTPUT REGISTERS - NONE                                   **** 64600021
****                                                               **** 64700021
*********************************************************************** 64800021
EXCP     EQU   *                                                        64900021
         EXCP  IOBSTDRD                 EXECUTE CHANNEL PROGRAM         65000021
         TM    ECBCC,ECBPOST            HAS ECB BEEN POSTED ?? @ZA12202 65100037
         BO    BYWAIT                   BYPASS WAITING ON ECB  @ZA12202 65120037
         WAIT  ECB=ECBCC                WAIT FOR I/O TO COMPLETE        65140037
BYWAIT   EQU   *                        ECB HAS BEEN POSTED    @ZA12202 65160037
         TM    ECBCC,ECBNORM            DID I/O COMPLETE NORMALLY       65200021
         BOR   REXCPRET                 YES, RETURN TO CALLER           65300002
         NI    DCBIFLGS,X'FF'-DCBIFEC   TURN OFF ERROR FLAGS     Y02072 65350002
         TM    IOBCSW+3,UNITEXPT        DID UNIT EXCEPTION OCCUR        65400021
         BOR   REXCPRET                 YES, RETURN TO CALLER           65500002
         LA    REASONCD,DIRECTRY        INDICATE ERROR OCCURED   Y02072 65550002
*                                       IN THE DIRECTORY         Y02072 65560002
         LA    RRETCODE,IOERROR         IND AN I/O ERROR OCCURED YM0943 65600002
         B     RTRNUSR2                 GO TO RETURN TO USER     Y02072 65700002
         EJECT                                                          65800021
*********************************************************************** 65900021
****                                                               **** 66000021
****     CONSTANTS                                                 **** 66100021
****                                                               **** 66200021
*********************************************************************** 66300021
         SPACE                                                          66400021
COUNTSZ  DC    Y(L'BUFN)                SIZE OF DIRECTORY BLOCK DATA    66500021
*                                       COUNT FIELD                     66600021
HIGHKEY  DC    8X'FF'                   KEY OF HIGHEST DIRECTORY ENTRY  66700021
         DC    C'IGG021AB'              NAME OF MODULE         @ZA10229 66700537
         DC    CL8'&SYSDATE'            DATE OF CHANGE         @ZA10229 66701037
         DC    C'@ZA12202'              LATEST FLAG            @ZA12202 66701537
PATCH    DC    0XL50'0',C'IGG021AB',42X'0'  50 BYTE PATCH AREA   Y02072 66702002
         EJECT                                                          83200021
*********************************************************************** 83210002
****                                                               **** 83220002
****     CONTROL BLOCK DEFINITIONS                                 **** 83230002
****                                                               **** 83240002
*********************************************************************** 83242002
         SPACE                                                          83244002
         CVT   DSECT=YES                                         Y02072 83250002
         EJECT                                                          83260002
         DCBD  DSORG=PO                                                 83300021
         EJECT                                                          83400021
         IEZDEB                                                         83500021
         EJECT                                                          83502002
         IHAPDS PDSBLDL=NO                                              83504002
         EJECT                                                          83550002
         IHAPSA                                                  Y02072 83552002
         EJECT                                                          83554002
         IHARB                                                   Y02072 83560002
         EJECT                                                          83570002
         IKJTCB                                                  Y02072 83580002
         EJECT                                                          83590002
         IGGSTW                                                  Y02072 83592002
         END   IGG021AB                                                 83600021
