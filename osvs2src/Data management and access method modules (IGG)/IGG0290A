         TITLE 'IGG0290A - DADSM SCRATCH - SEARCH FOR DSCB(S)'   S21040 00010021
IGG0290A CSECT                                                          00020021
*                                                                       00030021
*          RELEASE 18 DELETIONS                                       * 00042018
*1666000600                                                       22833 00044018
*          RELEASE 19 DELETIONS                                       * 00046018
*1021031200,036800,058200,061400,069800                          O19117 00047019
*1021                                                            M4917  00047519
*1021043200-044400                                               M4504  00047719
*1021027900,059200-060400                                        M3097  00047819
*          RELEASE 20 DELETIONS                                       * 00048018
*1331050600,051000,051400,052000,052400-053400,054000,054400-    A31333 00048620
*1331055000,055800,056800                                        A31333 00049220
*1331076200                                                      A34916 00049620
*          RELEASE 21 DELETIONS                                       * 00050018
*1198002100,003400,006800,008000,009400,084700,093600            A37199 00050221
*1198000000-000400,002000-002800,003200-003400,005600,007200-    S21040 00050421
*1198007600,008000,010800,011200,011600,012000-012200,012600,    S21040 00050821
*1198014500-015000,031600,034400-057000,060800,072200-079000,    S21040 00051221
*1198079200-079400,080800                                        S21040 00051621
*          RELEASE 21.7 DELETIONS                                       00053702
*0000000520-000620,075000-080800,089000-090200                  SA56400 00053802
*0000021400,067600                                              SA48172 00054002
*0000                                                           SA53691 00054202
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00056002
*0000001000,003800,005200-005400,007000-007400,008000-008200,    Y02080 00056102
*0000015600-016000,021600,024480,026700-027600,027900,038200-    Y02080 00056202
*0000042200,060630-060750,061600,073000,080800-093700,094000     Y02080 00056302
*0000006400,022800,023800-024400,057200,057600,059200,059800,    Y02078 00056402
*0000060200,093720-094000                                        Y02078 00056502
*0000001400-002700,003400-006200,006900-007400,008000-008200,    Y02082 00056602
*0000014700-014850,024440-025200,025600                          Y02082 00056702
*0000025800                                                      Y02134 00056802
*0000020000-020200,026000,068600                                 YM1337 00056902
*0000023950,024100,024790                                        YM4653 00057002
*0000                                                            YM7039 00059002
*                                                                       00064018
*         VS2 RELEASE 03  SU32                                 @G32DSPD 00064532
* DELETIONS - 071988                                           @G32DSPD 00064632
* CHANGES   - 025378,025403-025424,071880,071988-071946        @G32DSPD 00064832
* ADD                                                          @ZA25881 00064932
*                                                                       00065002
*MODULE NAME - IGG0290A                                                 00066002
*                                                                       00067002
*DESCRIPTIVE NAME - DADSM SCRATCH - SEARCH FOR DSCB(S)                  00068002
*                                                                       00069002
*COPYRIGHT - NONE                                                       00070002
*                                                                       00071002
*CHANGE ACTIVITY - SEE DELETIONS/CHANGES FOLLOWING CSECT CARD           00071202
*                                                                       00071402
*STATUS CHANGE LEVEL 006                                                00072021
*                                                                       00080000
*ATTRIBUTES - REENTRANT                                                 00100002
*                                                                       00120000
*FUNCTION - THIS MODULE READS IN THE FORMAT 4 DSCB AND SEARCHES FOR     00140002
*          THE FORMAT 1 DSCB TO BE SCRATCHED.  IF THE ENQ (ISSUED IN    00160002
*          MODULE IGC0002I) INDICATED THAT SOMEONE COULD BE OPEN TO     00180002
*          THE DATA SET, THIS MODULE THEN SEARCHES THE JOB'S DEBS TO    00200002
*          ENSURE THAT NO ONE IS CURRENTLY OPEN TO THE DATA SET.        00220002
*          IF THE DATA SET IS PASSWORD PROTECTED, CONTROL IS GIVEN      00240002
*          TO MODULE SECLOADA.  THE EXPIRATION DATA IS TESTED IF THE    00260002
*          PURGE DATE OVERRIDE OPTION IS NOT SET IN THE SCRATCH         00280002
*          PARAMETER LIST.  IF NO ONE IS OPEN TO THE DATA SET, AND      00284002
*          EITHER THE EXPIRATION DATE IS PAST OR THE OVERRIDE OPTION    00288002
*          WAS SPECIFIED, CONTROL IS GIVEN TO MODULE IGG0299A.          00292002
*          OTHERWISE, THIS MODULE GIVES CONTROL TO IGG0290D.            00296002
*          IF A DATA SET IS RAC PROTECTED, VERIFY THE USER     @Z40RSGD 00298032
*          AUTHORIZATION TO SCRATCH THE DATA SET (RACHECK).    @Z40RSGD 00298432
*                                                                       00300000
*ENTRIES - THE ONLY ENTRY POINT TO THIS MODULE IS IGG0290A.  ENTRY IS   00320021
*          MADE FROM THE SECOND LOAD OF SCRATCH (IGG0290E) AND FROM     00340002
*          THE PASSWORD PROTECTION MODULE (SECLOADA).                   00360002
*                                                                       00380002
*SUPERVISOR CALLS AND EXTERNAL ROUTINES USED BY THIS MODULE -           00400002
*          EXCP(0)  - READS FROM A DIRECT ACCESS DEVICE                 00420002
*          WAIT(1)  - WAITS ON AN EVENT CONTROL BLOCK                   00440002
*          SETLOCK  - OBTAINS/RELEASES THE LOCAL MEMORY LOCK            00460002
*          MODESET  - SWITCHES TO THE CALLER'S KEY                      00480002
*          IECRES   - LOADS/BRANCHES TO ANOTHER MODULE                  00500002
*                                                                       00520002
*OTHER MACROS USED -                                                    00540002
*          IECDSECS - EXPANDS THE CVT, RB, TCB, JSCB, IEZDEB, UCB,      00560002
*                     AND PSA DSECTS                                    00580002
*          IECSDSL1 - ENABLES SYMBOLIC ADDRESSING OF DSCB'S             00600002
*          IECSCRWA - EXPANDS THE SCRATCH WORK AREA                     00620002
*          XCTLTABL - BUILDS A LIST OF MODULE NAMES AND ADDRESSES       00640002
*                                                                       00660000
*INPUT -   AT ENTRY TO THIS MODULE, REGISTER 13 POINTS TO THE WORK      00665002
*          AREA.  REGISTER 8 POINTS TO THE CURRENT ENTRY IN THE         00670002
*          VOLUME LIST.  REGISTER 10 POINTS TO THE PARAMETER LIST.      00675002
*          IF REENTRY FROM SECLOADA, REGISTER 10 CONTAINS ONE OF        00680002
*          THE FOLLOWING RETURN CODES:                                  00685002
*          X'00000000' - SUCCESSFUL PASSWORD CHECKING                   00690002
*          X'01000000' - UNSUCCESSFUL PASSWORD CHECKING                 00695002
*          X'02000000' - I/O ERROR OR NO PASSWORD DATA SET ON SYSRES    00700002
*                                                                       00705002
*OUTPUT -  REGISTER 8 AND 13 ARE AS AT ENTRY TO THE MODULE.  THE        00710002
*          DATA PORTIONS OF THE FORMAT 1 AND FORMAT 4 DSCB'S HAVE       00715002
*          BEEN READ INTO THE WORK AREA.                                00720002
*          THE FOLLOWING ADDITIONAL INFORMATION IS PASSED TO SECLOADA:  00725002
*          REGISTER 1 CONTAINS THE DSAB ADDRESS.                        00730002
*          REGISTER 4 POINTS TO THE DATA PORTION OF THE FORMAT 1 DSCB.  00735002
*          REGISTER 5 POINTS TO THE IOB.                                00740002
*          REGISTER 10 CONTAINS THE VALUE X'03000000'.                  00745002
*          REGISTER 11 POINTS TO THE DATA SET NAME.                     00750002
*          REGISTER 13 POINTS TO THE EXTENDED PREFIX OF THE WORK AREA.  00755002
*                                                                       00780000
*STORAGE - PROGRAM CODE CSECT = LESS THAN 2048 BYTES                    00800002
*          WORK AREA = 896 BYTES                                        00820002
*          RPS WORK AREA = 128 BYTES                                    00830002
*                                                                       00840000
*ERROR CONDITIONS - DSCB NOT FOUND IN VTOC                              00860000
*                   PURGE DATE NOT PAST AND OVER RIDE OPTION OFF        00880000
*                   IMPROPER PASSWORD PRESENTED                         00900000
*                   DATA SET IS OPEN                                    00910002
*                   PERMANENT I/O ERROR                                 00920000
*                   USER NOT AUTHORIZED TO SCRATCH RAC DEFINED @Z40RSGD 00922032
*                   DATA SET.                                  @Z40RSGD 00924032
*                                                                       00930021
*                                                                       00960000
*NOTES - THIS MODULE WAS SPLIT IN RELEASE 21.  THE SECOND HALF IS       00965021
*        MODULE IGG0299A.                                               00970021
*                                                                       00975021
*REGISTER USAGE                                                         00980000
R0       EQU   0                                                        01000000
R1       EQU   1                                                        01020000
R2       EQU   2                                                        01040000
R3       EQU   3                                                        01060000
R4       EQU   4                                                        01100000
R5       EQU   5                                                        01140000
VOLCTR   EQU   R5                       COUNT OF REMAINING VOLS  Y02082 01160002
R6       EQU   6                                                        01180000
R7       EQU   7                                                        01240000
VOLISTX  EQU   8                                                        01280000
RCVTT    EQU   9                                               @ZA25881 01300032
PL       EQU   10                                                       01320000
R10      EQU   10                                                       01340000
R11      EQU   11                                                       01360000
RBASE    EQU   12                                                       01380000
RWKAREA  EQU   13                                                       01400000
RETURN   EQU   14                                                       01420000
WORKREG  EQU   15                                                       01440000
*                                                                       01442021
* OTHER EQUATES                                                         01444021
*                                                                       01446021
ZERO     EQU   0                        CONSTANT OF ZERO         Y02082 01447002
K1       EQU   1                        CONSTANT OF 1            Y02078 01448002
K3       EQU   3                        CONSTANT OF 3            Y02082 01449002
D2       EQU   2                        DISPLACEMENT OF 2        S21040 01450021
D4       EQU   4                        DISPLACEMENT OF 4        S21040 01460021
K4       EQU   4                        CONSTANT OF 4            Y02078 01461002
K5       EQU   5                        CONSTANT OF 5            Y02080 01462002
K6       EQU   6                        CONSTANT OF 6            Y02078 01463002
K12      EQU   12                       CONSTANT OF 12           Y02082 01464002
SEEKCYL  EQU   3                        OFFSET TO CCHHR IN SEEK  Y02080 01465002
RTNCODE8 EQU   8                        ERROR RETURN CODE OF 8   Y02082 01466002
STATUS   EQU   11                       DISP. TO VOLIST STATUS   Y02078 01467002
ENTRYL   EQU   12                       VOL LIST ENTRY LENGTH    Y02082 01468002
ALLBITS  EQU   X'FF'                    MASK OF ALL ONES         Y02082 01469002
DEBDADEV EQU   X'04'                    DEB EXTENT SCALE FOR DA  Y02082 01470002
NOF1     EQU   X'01'                    NO F1 DSCB ERROR CODE    Y02078 01471002
PSWDERR  EQU   X'02'                    PASSWORD ERROR CODE      Y02078 01472002
PURGERR  EQU   X'03'                    PURGE DATE ERROR CODE    Y02078 01473002
IOERR    EQU   X'04'                    I/O ERROR CODE           Y02078 01474002
OPENDS   EQU   X'07'                    OPEN/SCRATCH ERROR CODE  Y02082 01475002
DOSBIT   EQU   X'80'                    DOS BIT IN DS4VTOCI      Y02078 01476002
DIRFBIT  EQU   X'04'                    DIRF BIT IN DS4VTOCI     Y02078 01477002
DS1EXTUL EQU   X'40'                    USER LABEL BIT IN EXTENT Y02082 01478002
PSWDDS   EQU   X'10'                    PASSWORD-PROTECTED D/S   Y02082 01479002
CC       EQU   X'40'                    COMMAND CHAINING BIT     Y02082 01480002
CSWAD    EQU   8                        CSW OFFSET IN IOB       SA53691 01481002
UCBADDR  EQU   32                       DISP. TO UCB ADDR IN DEB YM4653 01482002
SKIP     EQU   X'10'                    CCW SKIP FLAG           SA48172 01492002
SLI      EQU   X'20'                    CCW SUPPRESS LENGTH     SA48172 01494002
*                                       INDICATOR               SA48172 01496002
RACERROR EQU   X'08'                    SCRATCH FAILED DUE TO  @Z40RSGD 01498032
*                                       ERROR IN RAC FUNCTION  @Z40RSGD 01498432
DS1RACDF EQU   X'40'                    DS1DSIND-DATA SET IS   @Z40RSGD 01498832
*                                       RAC DEFINED            @Z40RSGD 01499232
VSAMDSSP EQU   X'08'                    VSAM DATA SPACE        @Z40RSGD 01499632
*                                                                       01500021
         BALR  RBASE,R0                                                 01520000
         USING BEGIN,RBASE                                              01540000
         USING SCRTHWKA,RWKAREA         WORK AREA ADDRESSABILITY Y02080 01560002
*                                                                       01605021
* THIS SECTION RELOCATES AND EXECUTES THE CHANNEL PROGRAM.              01610021
*                                                                       01615021
BEGIN    EQU   *                                                        01620000
         LTR   PL,PL                    IF PASSWORD ENTRY IS IT OKAY.   01640000
         BZ    PASSOKAY                 BRANCH IF YES.                  01660000
         ST    PL,FIELD1                SAVE PARAMETER LIST POINTER.    01680000
         TM    FIELD1,3                 IS THIS A PASSWORD ERROR.       01700000
         BNE   PSWDEXIT                 BRANCH IF YES.                  01720000
         LM    R0,R7,CHANPROG           LOAD CCW1 TO CCW4 CONSTANTS.    01740000
         AR    R0,RWKAREA               RESOLVE ADDR IN CCW1            01760000
         AR    R2,RWKAREA               RESOLVE ADDR IN CCW2            01780000
         AR    R4,RWKAREA               RESOLVE ADDR IN CCW3            01800000
         AR    R6,RWKAREA               RESOLVE ADDR IN CCW4            01820000
         STM   R0,R7,CCW1               STORE CCW1 TO CCW4              01840000
         LA    WORKREG,CCW9-CCW1                                        01860000
         AR    R2,WORKREG               RESOLVE ADDR IN CCW5            01880000
         STM   R2,R3,CCW5               STORE CCW5                      01900000
         LA    WORKREG,CCW11-CCW9                                       01920000
         AR    R2,WORKREG               RESOLVE ADDR IN CCW8            01940000
         STM   R2,R3,CCW8               STORE CCW8                      01960000
         LM    R0,R7,CHANPROG+32        LOAD CCW9 TO CCW12 CONSTANTS    01980000
         AR    R0,RWKAREA               RESOLVE ADDR IN CCW9     YM1337 02020002
         AR    R2,RWKAREA               RESOLVE ADDR IN CCW10           02040000
         AR    R4,RWKAREA               RESOLVE ADDR IN CCW11           02060000
         AR    R6,RWKAREA               RESOLVE ADDR IN CCW12           02080000
         STM   R0,R7,CCW9               STORE CCW9 TO CCW12             02100000
         STM   R0,R1,CCW6               STORE CCW6                      02120000
         STM   R4,R5,CCW7               STORE CCW7              SA48172 02140002
         MVI   CCW7+4,SLI+SKIP          SET SLI AND SKIP BITS   SA48172 02152002
         MVI   DS1FMTID,X'00'           ZERO FORMAT ID OF INPUT AREA    02180000
EXECUTE  EQU   *                                                        02200000
         BAL   RETURN,EXCPIO            SEARCH FOR CORRECT DSCB.        02220000
         L     R2,IOB+CSWAD             GET CSW COMMAND ADDRESS SA56391 02222002
         LA    R2,0(R2)                 CLEAR HIGH BYTE         SA56391 02224002
         LA    R3,CCW8                  GET CCW8 ADDRESS        SA56391 02226002
         CLR   R2,R3                    DOES CSW POINT TO CCW8  SA56391 02228002
         BE    NOTFOUND                 YES, DATA SET NOT FOUND SA56391 02230002
         CLI   DS1FMTID,X'F1'           TEST FOR FMT 1 DSCB IN CORE     02240000
         BE    NEWDSCB                                                  02260000
         B     PERMERR                  BAD VTOC - I/O ERR CODE SA56391 02265002
NOTFOUND EQU   *                                                SA56391 02270002
         TM    DS4VTOCI,DOSBIT+DIRFBIT  TEST IF DOS OR DIRF SET  Y02078 02280002
         BZ    NODSCB                                                   02300000
         TM    ERCODE,X'80'             TEST FOR SECOND PASS            02320000
         BO    NODSCB                                                   02340000
         OI    ERCODE,X'80'             TURN ON FIRST PASS INDICATOR    02360000
         CLC   DS4HPCHR(K4),DS4VTOCE+K6  TEST IF CCHH OF 'HIGH   Y02078 02362002
*                                       WATER' MARK IS THE LAST  Y02078 02364002
*                                       TRACK IN THE VTOC        Y02078 02366002
         BNE   NEWHIGH                  BRANCH IF NOT            Y02078 02368002
         CLC   DS4HPCHR+D4(K1),DS4DEVDT  TEST IF R OF THE 'HIGH  Y02078 02370002
*                                       WATER' MARK IS THE LAST  Y02078 02372002
*                                       RECORD ON THE TRACK      Y02078 02374002
         BE    NODSCB                   BRANCH IF YES            Y02078 02376002
NEWHIGH  EQU   *                        SET NEW CCHHR            Y02078 02378002
         MVC   DS4HPCHR(K4),DS4VTOCE+K6  MOVE IN NEW CCHH        Y02078 02380002
         MVC   DS4HPCHR+D4(K1),DS4DEVDT  MOVE IN NEW R           Y02078 02381002
         MVI   CCW3+K4,CC+SKIP          DO NOT REREAD THE F4     Y02078 02382002
         B     EXECUTE                  SEARCH FOR THE F1 AGAIN  Y02078 02383002
*                                                                       02384002
* THIS SECTION SEARCHES THE JOB'S DEBS IF NECESSARY IN ORDER TO         02385002
* ENSURE THAT NO ONE IS OPEN TO THE DATA SET BEING SCRATCHED.           02386002
*                                                                       02387002
NEWDSCB  EQU   *                        DEB SEARCH               Y02082 02388002
         TM    SISW1,DEBSRCH            IS A DEB SEARCH NEEDED   Y02082 02389002
         BZ    PSWDCHK                  BRANCH IF NOT            Y02082 02390002
         L     R1,TCBADDR               CURRENT TCB ADDRESS      Y02082 02391002
         USING TCB,R1                                            Y02082 02392002
         L     R1,TCBJSCB               JSCB ADDRESS             Y02082 02393002
         USING IEZJSCB,R1                                        Y02082 02394002
         STM   R11,RETURN,IECREGSV+K12  SAVE SETLOCK REGISTERS   Y02082 02396002
         LR    R2,RWKAREA               SAVE WORKAREA BASE       Y02082 02397002
GETLOCK  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,  PREVENT DEBCHK  Y02082*02398002
               RELATED=(DEBTBL,IGG0290A(FREELOCK))               Y02082 02399002
         LR    RWKAREA,R2               RESTORE WORKAREA BASE    Y02082 02400002
         LM    R11,RETURN,IECREGSV+K12  RESTORE SETLOCK REGS     Y02082 02401002
         L     R1,JSCBDBTB              ADDR OF DEB TABLE        Y02082 02402002
         LTR   R1,R1                    IS ADDR ZERO             Y02082 02403002
         BZ    NOPENDS                  BRANCH IF YES            Y02082 02404002
         LH    R2,ZERO(,R1)             LAST ENTRY OFFSET        Y02082 02405002
         AR    R2,R1                    ADDRESS OF LAST ENTRY    Y02082 02406002
NXTDEB   EQU   *                        NEXT DEB                 Y02082 02407002
         LA    R1,K4(,R1)               POINT TO NEXT ENTRY      Y02082 02408002
         CR    R1,R2                    END OF DEB TABLE         Y02082 02409002
         BE    NOPENDS                  BRANCH IF YES            YM4653 02410002
         OC    ZERO(K4,R1),ZERO(R1)     EMPTY ENTRY              Y02082 02411002
         BZ    NOPENDS                  BRANCH IF YES            Y02082 02412002
         TM    K3(R1),ALLBITS           DELETED ENTRY            Y02082 02413002
         BO    NXTDEB                   BRANCH IF YES            Y02082 02414002
*                                       R1 POINTS TO A FULLWORD  Y02082 02415002
*                                       CONTAINING A DEB POINTER Y02082 02416002
         L     R3,ZERO(,R1)             LOAD DEB ADDRESS         Y02082 02417002
         USING DEBBASIC,R3                                       Y02082 02418002
         LA    R4,DEBBASIC-DEBAMTYP     OFFSET BACK TO DEBAMTYP  Y02082 02419002
         LCR   R4,R4                    MAKE OFFSET NEGATIVE     Y02082 02420002
         AR    R4,R3                    R4 POINTS TO DEBAMTYP    Y02082 02421002
         USING DEBAMTYP,R4                                       Y02082 02422002
         CLI   DEBAMTYP,ZERO            AMTYP ABSENT             Y02082 02423002
         BE    AMVALID                  BRANCH IF YES--VALID     Y02082 02424002
         CLC   DEBAMTYP,AMBPAM          BPAM DEB                 Y02082 02425002
         BE    AMVALID                  BRANCH IF YES--VALID     Y02082 02426002
         CLC   DEBAMTYP,AMBDAM          BDAM DEB                 Y02082 02427002
         BE    AMVALID                  BRANCH IF YES            Y02082 02428002
         CLC   DEBAMTYP,AMSAM           SAM DEB                  Y02082 02429002
         BE    AMVALID                  BRANCH IF YES            Y02082 02430002
         CLC   DEBAMTYP,AMEXCP          EXCP DEB                 Y02082 02431002
         BE    AMVALID                  BRANCH IF YES            Y02082 02432002
         CLC   DEBAMTYP,AMISAM          ISAM DEB                 Y02082 02433002
         BNE   NXTDEB                   BRANCH IF NO-THIS DEB    Y02082 02434002
*                                       NEED NOT BE CHECKED      Y02082 02435002
         CLI   DEBNMEXT,K1              0 OR ONE EXTENT IN ISAM  Y02082 02436002
*                                       DEB                      Y02082 02437002
         BNH   NXTDEB                   INVALID ISAM DEB         Y02082 02438002
         DROP  R4                                                Y02082 02439002
         SR    R4,R4                    ZERO FOR IC              Y02082 02440002
         IC    R4,DEBNMEXT              INSERT NUMBER OF EXTENTS Y02082 02441002
         BCTR  R4,ZERO                  REDUCE BY ONE            Y02082 02442002
         LA    R3,DEBNMTRK-DEBUCBAD+L'DEBNMTRK(,R3)  SKIP FIRST  Y02082 02443002
*                                       EXTENT FOR ISAM          Y02082 02444002
         B     CHKEXTNT                 GO TO CHECK EACH EXTENT  Y02082 02445002
AMVALID  EQU   *                        VALID AM TYPE            Y02082 02446002
         CLI   DEBNMEXT,ZERO            ARE THERE ANY EXTENTS    Y02082 02447002
         BZ    NXTDEB                   BRANCH IF NO             Y02082 02448002
         CLI   DEBEXSCL,DEBDADEV        IS EXTENT SCALE 4 FOR DA Y02082 02449002
         BNE   NXTDEB                   BRANCH IF NO             Y02082 02450002
         L     R4,DEBSUCBA              GET UCB ADDRESS          Y02082 02451002
         USING UCBOB,R4                                          Y02082 02452002
         LA    R4,ZERO(,R4)             CLEAR HIGH BYTE          Y02082 02453002
         LTR   R4,R4                    IS THERE A UCB           Y02082 02454002
         BZ    NXTDEB                   BRANCH IF NO             Y02082 02455002
         TM    UCBTBYT3,UCB3DACC        IS IT DIRECT ACCESS      Y02082 02456002
         BZ    NXTDEB                   BRANCH IF NO             Y02082 02457002
         DROP  R4                                                Y02082 02458002
         SR    R4,R4                    ZERO FOR IC              Y02082 02459002
         IC    R4,DEBNMEXT              NUMBER OF EXTENTS        Y02082 02460002
CHKEXTNT EQU   *                        CHECK EXTENT             Y02082 02461002
         LA    R3,DEBBASND              INCREMENT PAST BASIC     Y02082 02462002
*                                       SECTION OF DEB           Y02082 02463002
         USING DEBDASD,R3                                        Y02082 02464002
CMPREXTS EQU   *                        CHK FOR USER LBL EXTENT  Y02082 02465002
         CLC   DEBUCBA,WKADEB+UCBADDR+K1  TEST IF SAME UCB       YM4653 02465202
         BNE   NEXTXTNT                 BRANCH IF NOT            YM4653 02465402
         TM    DS1EXT1,DS1EXTUL         IS FIRST EXTENT USER LBL Y02082 02466002
         BZ    NOTUL                    BRANCH IF NOT            Y02082 02467002
         CLC   DEBSTRCC(L'DEBSTRCC+L'DEBSTRHH),DS1EXT2+D2 IS THE Y02082 02468002
*                                       DEB'S STARTING CCHH      Y02082 02469002
*                                       EQUAL TO THE DSCB'S      Y02082 02470002
         BE    NOSCRTCH                 BRANCH IF YES            Y02082 02471002
         B     NEXTXTNT                 GET NEXT EXTENT          Y02082 02472002
NOTUL    EQU   *                        NOT USER LBL EXTENT      Y02082 02473002
         CLC   DEBSTRCC(L'DEBSTRCC+L'DEBSTRHH),DS1EXT1+D2  IS    Y02082 02474002
*                                       THE DEB'S STARTING CCHH  Y02082 02475002
*                                       EQUAL TO THE DSCB'S      Y02082 02476002
         BE    NOSCRTCH                 BRANCH IF YES            Y02082 02477002
NEXTXTNT EQU   *                        NEXT EXTENT              Y02082 02478002
         LA    R3,DEBNMTRK+L'DEBNMTRK   INCREMENT TO NEXT EXTENT YM4653 02479002
         BCT   R4,CMPREXTS              TRY NEXT EXTENT          Y02082 02480002
         B     NXTDEB                   NO MORE EXTENTS          Y02082 02481002
NOSCRTCH EQU   *                        CANNOT BE SCRATCHED      Y02082 02482002
         LA    R3,OPENERR               SET UP BRANCH ADDRESS AS Y02082 02483002
*                                       THE DATA SET IS OPEN AND Y02082 02484002
*                                       CANNOT BE SCRATCHED      Y02082 02485002
         B     FREELOCK                 FREE THE LOCAL LOCK      Y02082 02486002
NOPENDS  EQU   *                        GET ADDRESS              Y02082 02487002
         LA    R3,PSWDCHK               SET UP BRANCH ADDRESS    Y02082 02488002
FREELOCK EQU   *                        SAVE BASE                Y02082 02489002
         LR    R1,RWKAREA               SAVE WORKAREA BASE       Y02082 02490002
         STM   R11,RETURN,IECREGSV+K12  SAVE SETLOCK REGISTERS   Y02082 02491002
         SETLOCK RELEASE,TYPE=LOCAL,    RELEASE LOCAL LOCK       Y02082*02492002
               RELATED=(DEBTBL,IGG0290A(GETLOCK))                Y02082 02493002
         LR    RWKAREA,R1               RESTORE WORKAREA BASE    Y02082 02494002
         LM    R11,RETURN,IECREGSV+K12  RESTORE SETLOCK REGS     Y02082 02495002
         BR    R3                       RETURN                   Y02082 02496002
*                                                                       02497002
* A DEB HAS BEEN FOUND OPEN TO THE DATA SET BEING SCRATCHED.            02498002
* THE CURRENT AND ALL SUBSEQUENT VOLUME ENTRIES WILL HAVE THEIR         02499002
* ERROR CODES SET TO X'07'.                                             02500002
*                                                                       02501002
OPENERR  EQU   *                        DATA SET OPEN            Y02082 02502002
         LH    VOLCTR,VOLNUM            NUMBER OF VOLS REMAINING Y02082 02503002
*                                       NOT COUNTING CURRENT ONE Y02082 02504002
         LA    VOLCTR,K1(,VOLCTR)       COUNT INCLUDING CURRENT  Y02082 02505002
         L     R1,TCBADDR               LOAD TCB ADDRESS         Y02082 02506002
         USING TCB,R1                                            Y02082 02507002
         MODESET EXTKEY=RBT234,WORKREG=2  SWITCH TO CALLER'S KEY Y02082 02508002
SETERRCD EQU   *                        SET ERROR CODE           Y02082 02509002
         MVI   STATUS(VOLISTX),OPENDS   SET ERROR CODE           Y02082 02510002
         LA    VOLISTX,ENTRYL(,VOLISTX)  INCREMENT TO NEXT ENTRY Y02082 02511002
         BCT   VOLCTR,SETERRCD          BRANCH TO CONTINUE       Y02082 02512002
         MODESET EXTKEY=ZERO            RETURN TO KEY 0          Y02082 02513002
         LA    WORKREG,ENTRYL           VOL LIST ENTRY LENGTH    Y02082 02514002
         SR    VOLISTX,WORKREG          POINT TO LAST ENTRY      Y02082 02515002
         OI    STYPEFLG,EXITBIT         SET EXIT BIT             Y02082 02516002
         B     ERREXIT                  EXIT TO IGG0290D         Y02082 02517002
*                                                                       02518002
* SECLOADA IS GIVEN CONTROL IF THE DATA SET IS PASSWORD PROTECTED.      02519002
*                                                                       02520002
PSWDCHK  EQU   *                        PASSWORD CHECK           Y02082 02521002
*                                                              @Z40RSGD 02521432
* IF THE DATA SET IS RAC PROTECTED VERIFY USER AUTHORIZATION   @Z40RSGD 02521832
* TO SCRATCH IT VIA RAC INSTEAD OF PASSWORD CHECKING.          @Z40RSGD 02521932
*                                                              @Z40RSGD 02525532
         TM    DS1DSIND,DS1RACDF        IS THE DATA SET RAC    @Z40RSGD 02527532
*                                       DEFINED                @Z40RSGD 02527932
         BZ    NORACHCK                 NO-CONTINUE            @Z40RSGD 02528332
         L     R1,TCBADDR               LOCATE TCB             @Z40RSGD 02528732
         USING TCB,R1                                          @Z40RSGD 02529132
         L     R1,TCBJSCB               LOCATE JSCB            @Z40RSGD 02532532
         USING IEZJSCB,R1                                      @Z40RSGD 02534532
         L     R1,JSCBACT               PICK ACTIVE JSCB       @G32DSPD 02534732
         TM    JSCBSWT1,JSCBPASS        IS RAC PROCESSING TO   @Z40RSGD 02534932
*                                       BE BYPASSED            @Z40RSGD 02535032
         BO    NORACHCK                                        @Z40RSGD 02535132
         DROP  R1                       NOT NEEEDED            @Z40RSGD 02535232
         CLI   DS1DSORG+1,VSAMDSSP      IS IT A VSAM DATA      @Z40RSGD 02535332
*                                       SPACE                  @Z40RSGD 02535732
         BE    ERRX08                   YES-ERROR-RAC DEFINED  @Z40RSGD 02536132
*                                       VSAM DATA SPACES NOT   @Z40RSGD 02536232
*                                       LEGAL                  @Z40RSGD 02536332
         MVC   RACHECK(LRACHECK),MRACHECK BUILD RACHECK        @Z40RSGD 02537232
*                                       PARAMETER LIST         @Z40RSGD 02538732
         NI    SISW1,255-VOLRACHK      INIT VOLRACF SW         @G32DSPD 02538832
* CHECK RAC AUTHORIZATION TO SCRATCH DATA SET.                 @Z40RSGD 02538932
         RACHECK ENTITY=PDSNAME,                               @Z40RSGDX02539032
               VOLSER=PVOLSER,                                 @Z40RSGDX02539132
               MF=(E,RACHECK)                                  @Z40RSGD 02539632
         LTR   WORKREG,WORKREG          DOES RAC AUTHORIZE     @Z40RSGD 02539732
*                                       SCRATCH                @Z40RSGD 02539832
         BZ    NAMEOKAY                 YES-BYPASS PASSWORD    @Z40RSGD 02539932
*                                       CHECKING               @Z40RSGD 02540032
***                                                                     02540332
***                                                                     02540432
         L     R1,CVTPTR                LOAD CVT ADDRESSS      @ZA25881 02540532
         USING CVT,R1                   CVT ADDRESSABILITY     @ZA25881 02540632
         L     R1,CVTRAC                LOAD RACF CVT ADDRESS  @ZA25881 02540732
         LTR   R1,R1                    IS RACF INSTALLED      @ZA25881 02540832
         BZ    ERRX08                   NO -ERROR-NO RACHECKS  @ZA25881 02540932
*                                       WITHOUT RACF           @ZA25881 02541032
         USING RCVT,R1                  ADDRESS RACF CVT       @ZA25881 02541132
         TM    RCVTSTA1,RCVTDASD        TEST FOR DASDVOL       @ZA25881 02541232
*                                       PROTECTION OPTION      @ZA25881 02541332
         BNO   ERRX08                   BRANCH IF NOT                   02541432
***                                                                     02541532
***                                                                     02541632
*                                                              @G32DSPD 02541732
* ALLOW USER TO SCRATCH IF HE HAS ALTER ACCESS TO THE VOLUME   @G32DSPD 02541832
         MVC   RACHECK(LVRACHEK),VRACHECK BUILD RACHECK        @G32DSPD 02541932
         RACHECK ENTITY=PVOLSER,                               @G32DSPD*02542032
               MF=(E,RACHECK)                                  @G32DSPD 02542132
         LTR   WORKREG,WORKREG          USER AUTHORIZED ?      @G32DSPD 02542232
         BNZ   ERRX08                   NO,NOT AUTHORIZED      @G32DSPD 02542332
         OI    SISW1,VOLRACHK           YES,VOLUME AUTHORIZED  @G32DSPD 02542432
         B     NAMEOKAY                 OKAY TO GO SCRATCH     @G32DSPD 02542532
ERRX08   EQU   *                        RAC ERROR              @Z40RSGD 02544532
         MVI   STATUS(VOLISTX),RACERROR POST RAC ERROR         @Z40RSGD 02544632
         B     ERREXIT                  ERROR-TERMINATE        @Z40RSGD 02545032
*                                       SCRATCH                @Z40RSGD 02545432
NORACHCK EQU   *                        RACHECK WAS NOT        @Z40RSGD 02545832
         TM    STYPEFLG,PSWDCHKD        WAS PASSWORD CHECKED     Y02082 02546632
         BO    NAMEOKAY                 BRANCH IF YES            Y02082 02548432
         TM    DS1DSIND,PSWDDS          TEST IF PASSWORD PROTECT Y02082 02551332
         BZ    NAMEOKAY                 BRANCH IF NO.                   02554232
         OI    STYPEFLG,PSWDCHKD        SET PASSWORD CHECKED BIT Y02082 02557132
         L     R1,DSABADDR              DSAB ADDR IN REGISTER 1  Y02082 02560002
         LA    R4,DS1FMTID              POINTER TO F1 DSCB       Y02134 02580002
         LA    R11,PDSNAME              POINT TO DATA SET NAME.  YM1337 02600002
         LA    R10,3                    INDICATE TO READPSWD THAT IT    02620000
         SLL   R10,24                   WAS CALLED BY SCRATCH.          02640000
         LA    R5,IOB                   POINT TO IOB.                   02660000
         LA    R2,SECLOAD               POINT TO SECLOADA        Y02080 02680002
         SR    RETURN,RETURN            SET ENTRY OFFSET         Y02134 02685002
         B     XCTLEXIT                 GO BRANCH TO SECLOADA    Y02080 02700002
*                                                                       02765021
* THIS SECTION TESTS IF THE PURGE DATE IS PAST.                         02770021
*                                                                       02775021
PASSOKAY EQU   *                                                        02780000
         XC    SEEK,SEEK                ZERO SEEK ADDRESS        Y02080 02785002
         MVC   SEEK+SEEKCYL(K5),VTOCADR  RESTORE SEEK ADDRESS    Y02080 02790002
         L     PL,OLDPLPTR              PICK UP PARAMETER LIST POINTER  02800000
         LA    R6,CCW1                  RESTORE CCW POINTER IN IOB.     02820000
         ST    R6,IOB+16                                                02840000
NAMEOKAY EQU   *                                                        02860000
         TM    DS4VTOCI,X'80'           IS THIS A BOS PACK              02880000
         BZ    STOREPTR                                                 02900000
         OI    DADSMTBL,2              SET BOS BIT.                     02920000
STOREPTR MVC   OUTCCHHR(5),OUTDSCB+135  STORE FMT 1 DSCB CCHHR          02940000
         SR    WORKREG,WORKREG          ZERO REG                        02960000
         STC   WORKREG,ERCODE           TURN OFF FIRST PASS INDICATOR   02980000
         IC    WORKREG,OUTCCHHR+4       PICK UP R OF NEXT RECORD        03000000
         BCTR  WORKREG,R0               DECREMENT R BY ONE              03020000
         LTR   WORKREG,WORKREG          TEST FOR LAST RECORD            03040000
         BNE   NOTLAST                                                  03060000
         IC    WORKREG,DS4DEVDT         PICK UP R OF LAST RECORD        03080000
NOTLAST  STC   WORKREG,OUTCCHHR+4       STORE R                         03100000
         TM    2(PL),X'10'              TEST FOR PURGE DATE OVERRIDE    03140000
         BO    EXITMOD                  IF YES, GO PREPARE       S21040 03150021
*                                       TO XCTL                         03160021
         USING CVT,RCVTT                CVT ADDRESSABILITY     @ZA25881 03165032
         L     RCVTT,CVTPTR             RELOAD CVT ADDRESS     @ZA25881 03170032
         L     R2,CVTDATE               LOAD CURRENT DATE IN PACKED DEC 03180000
         XC    FIELD1(6),FIELD1         ZERO DOUBLE WORD FIELD          03200000
         STH   R2,FIELD1+6              STORE DDDZ IN DOUBLE WORD FIELD 03220000
         SRDL  R2,4                     SHIFT Z TO REG 3                03240000
         SRL   R2,12                    SHIFT DDD OUT OF REG 2          03260000
         SLDL  R2,4                     SHIFT Z TO REG 2                03280000
         CVB   R3,FIELD1                CONVERT DDDZ TO BINARY          03300000
         STH   R2,FIELD1+6              STORE 0YYZ IN DOUBLE WORD FIELD 03320000
         CVB   R2,FIELD1                CONVERT 0YYZ TO BINARY          03340000
         STH   R3,FIELD1+6              STORE BINARY DD (DAY OF YEAR)   03360000
         STC   R2,FIELD1+5              STORE BINARY Y  (YEAR)          03380000
         CLC   DS1EXPDT(3),FIELD1+5     COMPARE PURGE DATE AND DATE     03400000
         BH    NOPURGE                                                  03420000
EXITMOD  EQU   *                        EXIT                     Y02080 03820002
         LA    R2,LOAD3                 MODULE ID OF IGG0299A    S21040 04620021
         B     XCTLEXIT                 GO XCTL TO IGG0299A      S21040 05020021
NOPURGE  EQU   *                        PURGE DATE ERROR         Y02078 05720002
         LA    R3,PURGERR               SET PURGE DATE ERROR     Y02078 05730002
         B     SETCODE                                                  05740000
NODSCB   EQU   *                        NO F1 DSCB               Y02078 05760002
         LA    R3,NOF1                  SET NO F1 DSCB ERROR     Y02078 05770002
         B     SETCODE                                                  05780000
*                                                                       05785021
* THIS ROUTINE EXECUTES A CHANNEL PROGRAM.                              05790021
*                                                                       05795021
EXCPIO   EQU   *                                                        05800000
         EXCP  IOB                      EXECUTE CHANNEL PROGRAM.        05840000
         WAIT  ECB=ECB                  WAIT FOR COMPLETION.            05860000
         TM    ECB,X'20'                TEST FOR I/O ERROR.             05880000
         BCR   7,RETURN                 RETURN IF OKAY.                 05900000
PERMERR  EQU   *                                                SA56391 05910002
         LA    R3,IOERR                 SET I/O ERROR            Y02078 05920002
         B     SETCODE                                           M3097  05940019
PSWDEXIT EQU   *                                                 M3097  05960019
         OI    STYPEFLG,EXITBIT         SET EXIT BIT             YM7039 05970002
         LA    R3,PSWDERR               SET PASSWORD ERROR       Y02078 05980002
SETCODE  EQU   *                                                 M3097  06000019
         L     R1,TCBADDR               LOAD TCB ADDRESS         Y02078 06005002
         USING TCB,R1                   TCB ADDRESSABILITY       Y02078 06010002
         MODESET EXTKEY=RBT234,WORKREG=2  SWITCH TO CALLER'S KEY Y02078 06015002
         STC   R3,STATUS(VOLISTX)       PUT ERROR CODE IN VOLIST Y02078 06020002
         MODESET EXTKEY=ZERO            RETURN TO KEY ZERO       Y02082 06025002
         DROP  R1                                                Y02078 06030002
ERREXIT  EQU   *                        ERROR EXIT               Y02082 06035002
         LA    WORKREG,RTNCODE8         SET ERROR CODE OF 8      Y02082 06040002
         STH   WORKREG,ERCODE           SAVE CALLER'S ERROR CODE Y02082 06045002
         LA    R2,LOAD4                 POINT TO PROPER ID.             06060000
XCTLEXIT EQU   *                        EXIT                     Y02080 06065002
         IECRES LOAD,EXTPR=(RWKAREA),MODNM=(R2),BRANCH=DIRECT    Y02080 06070002
*                                                                       06085021
*** PROGRAM CONSTANTS                                                   06100000
*                                                                       06120000
*                                                                       06125002
*        DEB ACCESS METHOD TYPE VALUES                                  06130002
*                                                                       06135002
AMBPAM   DEBCHK AM=BPAM,MF=L            BPAM AMTYPE              Y02082 06140002
AMBDAM   DEBCHK AM=BDAM,MF=L            BDAM AMTYPE              Y02082 06145002
AMSAM    DEBCHK AM=SAM,MF=L             SAM AMTYPE               Y02082 06150002
AMEXCP   DEBCHK AM=EXCP,MF=L            EXCP AMTYPE              Y02082 06155002
AMISAM   DEBCHK AM=ISAM,MF=L            ISAM AMTYPE              Y02082 06160002
*                                                                       06180000
*** THE FOLLOWING CHANNEL PROGRAM SEARCHES THE VTOC FOR THE NAMED DSCB. 06200000
*** THE VTOC DSCB AND THE NAMED DSCB ARE READ INTO THE INPUT AREAS.     06220000
*                                                                       06240000
CHANPROG DS    0F                                                       06260000
*CCW1                                                                   06280000
         DC    X'31'                    SEARCH EQUAL ID (INCCHHR)       06300000
         DC    AL3(0+INCCHHR-FIRST)                                     06320000
         DC    X'4000'                                                  06340000
         DC    H'5'                                                     06360000
*CCW2                                                                   06380000
         DC    X'08'                    TIC TO CCW1                     06400000
         DC    AL3(0+CCW1-FIRST)                                        06420000
         DC    F'0'                                                     06440000
*CCW3                                                                   06460000
         DC    X'06'                    READ DATA (VTOC DSCB)           06480000
         DC    AL3(0+VTOCDSCB-FIRST)                                    06500000
         DC    X'4000'                                                  06520000
         DC    H'96'                                                    06540000
*CCW4                                                                   06560000
         DC    X'F1'                    SERACH HI-EQ ID (LAST FMT 1)    06580000
         DC    AL3(0+DS4HPCHR-FIRST)                                    06600000
         DC    X'4000'                                                  06620000
         DC    H'5'                                                     06640000
*CCW5                                   TO BE CONSTRUCTED               06660000
*                                       TIC TO CCW9                     06680000
*CCW6                                   TO BE CONSTRUCTED               06700000
*                                       SEARCH EQUAL KEY (DS NAME)      06720000
*CCW7                                   TO BE CONSTRUCTED               06740000
*                                       READ DATA OF THE LAST   SA48172 06750002
*                                       FORMAT 1 WITH THE SKIP  SA48172 06752002
*                                       BIT SET IN ORDER TO END SA48172 06754002
*                                       THE CHANNEL PROGRAM     SA48172 06756002
*CCW8                                   TO BE CONSTRUCTED               06780000
*                                       TIC TO CCW11                    06800000
*CCW9                                                                   06820000
         DC    X'29'                    SEARCH EQUAL KEY (DS NAME)      06840000
         DC    AL3(PDSNAME-FIRST)                                YM1337 06860002
         DC    X'6000'                                                  06880000
         DC    H'44'                                                    06900000
*CCW10                                                                  06920000
         DC    X'08'                    TIC TO CCW4                     06940000
         DC    AL3(0+CCW4-FIRST)                                        06960000
         DC    H'0'                                              O19117 06970019
THREE    DC    H'3'                                              O19117 06980019
*CCW11                                                                  07000000
         DC    X'06'                    READ DATA (INDSCB+44)           07020000
         DC    AL3(44+INDSCB-FIRST)                                     07040000
         DC    X'4000'                                                  07060000
         DC    H'96'                                                    07080000
*CCW12                                                                  07100000
         DC    X'12'                    READ COUNT (INTO OUTDSCB+136)   07120000
         DC    AL3(135+OUTDSCB-FIRST)                                   07140000
         DC    X'2000'                                                  07160000
         DC    H'5'                                                     07180000
RCUNAUTH DC    X'08'                    UNAUTH RETURN CODE     @Z40RSRB 07187032
MRACHECK RACHECK CLASS='DATASET',       MASTER RACHECK         @G32DSPDX07188032
               DSTYPE=N,                PARAMETER LIST         @Z40RSGDX07192032
               ATTR=ALTER,                                     @Z40RSGDX07194032
               MF=L                                            @Z40RSGD 07196032
LRACHECK EQU   *-MRACHECK               LENGTH RACHECK         @Z40RSGD 07198032
*                                       PARAMETER LIST         @Z40RSGD 07198432
* MASTER RACF PARAMETER LIST FOR VOLUME RACHECKS               @G32DSPD 07198832
VRACHECK RACHECK CLASS='DASDVOL',                              @G32DSPD*07199032
               ATTR=ALTER,                                     @G32DSPD*07199232
               MF=L                                            @G32DSPD 07199432
LVRACHEK EQU   *-VRACHECK               PARAMETER LIST LENGTH  @G32DSPD 07199632
*                                                                       07200000
*** TABLE OF MODULE NAMES AND ENTRY POINT ADDRESSES                     07300002
*                                                                       08072002
         XCTLTABL ID=(LOAD3,IGG0299A,LOAD4,IGG0290D,             Y02080X08080002
               SECLOAD,SECLOADA),SVC=029,LENGTH=,BRT=YES         Y02080 08085002
         SPACE 2                                                 Y02082 08090002
         IECDSECS CVT,RB,TCB,JSCB,IEZDEB,UCB,PSA,EXPAND=YES      Y02082 08095002
WORKAREA IECSCRWA EP,F4,D1=(1)          SCRATCH WORK AREA        Y02080 08100002
RACHECK  EQU   SCRTHWKA                 RACHECK PARAMETER LIST @Z40RSGD 08150032
         ICHPRCVT                       RACF CVT               @ZA25881 09420032
         END                                                            09470032
