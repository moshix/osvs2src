         TITLE 'IGG0290B - DADSM SCRATCH - UPDATE FORMAT 6 DSCB' A36312 00018021
IGG0290B CSECT                                                          00021021
*TITLE   DADSM SCRATCH  UPDATE FORMAT 6 DSCB                            00026018
*          RELEASE 17 DELETIONS                                         00032018
*          RELEASE 18 DELETIONS                                         00038018
*0095031800,033800,034800,035800-041200,043200                    20344 00041018
*0095028600,029000                                                20873 00044018
*          RELEASE 19 DELETIONS                                         00050018
*          RELEASE 20 DELETIONS                                         00056018
*1021025200,057400,059000                                        A31333 00059020
*          RELEASE 21 DELETIONS                                         00062018
*1198000200,001800-002200,002600-002800,003600-005000,005400-    A36312 00063021
*1198005600,010800-011200,025420-025500,026000,029400,031400,    A36312 00064021
*1198034660,035000-035200,036400-036700,037300-038700,041600,    A36312 00065021
*1198071400                                                      A36312 00066021
*          RELEASE 21.7 DELETIONS                                       00066402
*0000000680-000860,006200,057300-059000,066600-068000           SA56400 00066802
*          VS1 RELEASE 2 DELETIONS                                      00068802
*0000                                                           XM1038  00070802
*                                                                       00076802
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00080002
*0000000030-000150,001000,003200,004600,011800-012000,035800,    Y02080 00080102
*0000036000,047860,048600-049600,057240,059050-070600,071000-    Y02080 00080202
*0000071200                                                      Y02080 00080302
*0000002240,011040,016400-016600                                 Y02078 00080402
*0000                                                            Y02082 00080502
*                 VS2 RELEASE 030 CHANGES                               00083503
*0000                                                          @ZA07591 00086503
*                                                                       00090002
*                                                                       00091002
* MODULE NAME - IGG0290B                                                00092002
*                                                                       00092202
* DESCRIPTIVE NAME - DADSM SCRATCH - UPDATE FORMAT 6 DSCB               00092402
*                                                                       00092602
* COPYRIGHT - NONE                                                      00092802
*                                                                       00092902
* CHANGE ACTIVITY - SEE DELETIONS/CHANGES FOLLOWING CSECT CARD          00093902
*                                                                       00094102
* STATUS CHANGE LEVEL 003                                               00094902
*ATTRIBUTES - REENTRANT                                                 00100002
*                                                                       00120000
*FUNCTION - THIS MODULE UPDATES THE EXTENTS IN THE FORMAT 6 DSCB        00140000
*          RECORDS. THE NEW EXTENTS ARE PASSED TO THIS MODULE IN        00160000
*          A TABLE IN THE WORK AREA. FOR EACH SPLIT CYLINDER DATA SET   00168021
*          ENTRY IN THIS DADSM TABLE, THE CORRESPONDING EXTENT IS       00176021
*          FOUND IN A FORMAT 6 DSCB, AND ITS DATA SET COUNT IS          00184021
*          DECREMENTED BY ONE. IF THIS BYTE BECOMES ZERO, THE SPACE     00192021
*          DESCRIBED BY THE FORMAT 6 EXTENT IS FREED, AND ITS           00200021
*          RTA/RTA+1 IS PLACED IN THE DADSM TABLE SO THAT A LATER       00208021
*          LOAD OF SCRATCH CAN ADD THIS AVAILABLE SPACE TO A            00216021
*          FORMAT 5 DSCB. IF THE DOS BIT OR DIRF BIT IS SET IN THE      00224002
*          FORMAT 4 DSCB, THE EXTENTS WILL NOT BE RETURNED TO THE       00226002
*          FORMAT 5 DSCB, AND CONTROL IS PASSED DIRECTLY TO THE         00228002
*          LAST LOAD OF SCRATCH.                                        00230002
*                                                                       00240000
*ENTRIES - THE ONLY ENTRY POINT TO THIS MODULE IS IGG0290B. ENTRY       00260021
*          IS MADE FROM IGG0299A.                                       00280021
*                                                                       00300000
*                                                                       00340000
*SUPERVISOR CALLS ISSUED:                                               00370021
*          EXCP(0)  READ FROM OR WRITE TO A DIRECT ACCESS DEVICE        00400021
*          WAIT(1)  WAIT ON AN EVENT CONTROL BLOCK                      00430021
*                                                                       00520000
*MACROS USED:                                                           00540021
*          IECDSECS - EXPANDS THE CVT, RB, AND TCB DSECTS               00550002
*          IECSDSL1 - ENABLES SYMBOLIC ADDRESSING OF DSCBS              00560021
*          IECSCRWA - SCRATCH WORK AREA EXPANSION                       00570002
*                                                                       00580000
*INPUT - AT ENTRY TO THIS MODULE REGISTER 13 POINTS TO THE WORK AREA.   00600000
*                                                                       00610021
*OUTPUT - UPDATED FORMAT 6 DSCB. REGISTER 9 INDICATES NUMBER OF         00620002
*         EXTENTS IN DADSM TABLE.                                       00630002
*                                                                       00640000
*ERROR CONDITION - THE ONLY ERROR INDICATED IS PERMANENT I/O ERROR.     00660000
*                                                                       00662002
*NOTES - UNLIKE THE ALLOCATE, EXTEND, AND PARTIAL RELEASE FUNCTIONS     00664002
*        OF DADSM, IF THE DIRF BIT IS SET IN THE FORMAT 4 DSCB IN       00666002
*        THE SCRATCH WORK AREA, THIS INDICATES THAT THE DIRF BIT        00668002
*        WAS PREVIOUSLY SET IN THE FORMAT 4 DSCB.                       00670002
*                                                                       00680000
*REGISTER USAGE                                                         00700000
R0       EQU   0                                                        00720000
R1       EQU   1                                                        00740000
R2       EQU   2                                                        00760000
INDEX2   EQU   2                                                        00780000
R3       EQU   3                                                        00800000
INDEX3   EQU   3                                                        00820000
INDEX4   EQU   4                                                        00840000
COUNT1   EQU   5                                                        00860000
EXTCTR   EQU   6                                                        00880000
COUNT3   EQU   7                                                        00900000
VOLISTX  EQU   8                                                        00920000
COUNT4   EQU   9                                                        00940000
INDEX1   EQU   10                                                       00960000
RTA      EQU   11                                                       00980000
RBASE    EQU   12                                                       01000000
RWKAREA  EQU   13                                                       01020000
RETURN   EQU   14                                                       01040000
WORKREG  EQU   15                                                       01060000
*                                                                       01070021
* OTHER EQUATES                                                         01080021
*                                                                       01090021
ONE      EQU   1                        VALUE ONE                A36312 01100021
K5       EQU   5                        CONSTANT OF FIVE        SA56400 01102002
DOSBIT   EQU   X'80'                    TEST FOR DOS VOLUME      Y02078 01104002
DIRFBIT  EQU   X'04'                    TEST FOR DIRF BIT        Y02078 01106002
*                                                                       01110021
         BALR  RBASE,R0                                                 01140000
         USING BEGIN,RBASE                                              01160000
         USING SCRTHWKA,RWKAREA         WORK AREA ADDRESSABILITY Y02080 01180002
*                                                                       01204021
* THIS SECTION MODIFIES THE CHANNEL PROGRAM TO READ AND WRITE           01208021
* FORMAT 6 DSCB'S.                                                      01212021
*                                                                       01216021
BEGIN    MVC   CCW5(8),CCW7            STORE CCW5                       01220000
         LM    R0,R1,CCW2              PICK UP TIC CONSTANT             01240000
         LA    WORKREG,CCW2-CCW1                                        01260000
         AR    R0,WORKREG              RESOLVE ADDR IN CCW4             01280000
         STM   R0,R1,CCW4              STORE CCW4                       01300000
         LA    WORKREG,CCW6-CCW2                                        01320000
         AR    R0,WORKREG              RESOLVE ADDR IN CCW7             01340000
         STM   R0,R1,CCW7              STORE CCW7                       01360000
         MVC   CCW2(8),CCW12           SET UP CCW2                      01380000
         MVI   CCW2,X'92'                                               01400000
         MVI   CCW2+4,X'60'            STORE CCW2                       01420000
*                                       RETAIN CCW10                    01440000
*                                       RETAIN CCW11                    01460000
         MVC   CCW6(8),CCW1            STORE CCW6                       01480000
         MVC   CCW9(8),CCW1            STORE CCW9                       01500000
         MVC   CCW1(8),CCW8            STORE CCW1                       01520000
         LM    R0,R3,CHALPROG          LOAD CCW CONSTANTS               01540000
         AR    R0,RWKAREA              RESOLVE ADDR IN CCW3             01560000
         AR    R2,RWKAREA              RESOLVE ADDR IN CCW8             01580000
         STM   R0,R1,CCW3              STORE CCW3                       01600000
         STM   R2,R3,CCW8              STORE CCW8                       01620000
         TM    DS4VTOCI,DOSBIT+DIRFBIT  TEST IF DOS AND/OR DIRF  Y02078 01640002
*                                      BIT IS SET IN THE F4 DSCB Y02078 01650002
         BNZ   LEAVE                   IF EITHER IS SET, DO NOT  Y02078 01660002
*                                      RETURN EXTENTS TO THE F5  Y02078 01670002
         SR    R0,R0                   ZERO REG                         01680000
         LR    EXTCTR,R0               ZERO EXTENT COUNTER              01700000
         IC    EXTCTR,EXTNUM           PICK UP NUMBER OF ENTRIES        01720000
         LTR   EXTCTR,EXTCTR           TEST FOR NO ENTRIES              01740000
         BZ    LEAVE                   BR IF NONE               SA56400 01760002
*                                                                       01765021
* THIS SECTION SORTS THE DADSM TABLE ENTRIES INTO ASCENDING ORDER.      01770021
*                                                                       01775021
NEWPASS  LA    INDEX1,ENTRIES          POINT INDEX1 TO FIRST ENTRY      01780000
         LA    INDEX2,4(INDEX1)        POINT INDEX2 TO SECOND ENTRY     01800000
         LA    INDEX3,1                INITIALIZE COMPARE COUNTER       01820000
         BCT   EXTCTR,NEWPAIR          DECREMENT EXTENT COUNTER         01840000
         B     TESTCYLS                BRANCH WHEN NUM OF EXTS = 1      01860000
*                                                                       01880000
SHIFT    LR    INDEX1,INDEX2           POINT INDEX1 TO ITS NEXT ENTRY   01900000
         LA    INDEX2,4(INDEX2)        POINT INDEX2 TO ITS NEXT ENTRY   01920000
         CLR   INDEX3,EXTCTR           IS NUM COMPARES = NUM OF EXTS-1  01940000
         BE    NEWPASS                 BR IF YES                        01960000
         LA    INDEX3,1(INDEX3)        INCREMENT COMPARE COUNTER        01980000
NEWPAIR  CLC   0(2,INDEX1),0(INDEX2)   COMPARE ON LOW RTA               02000000
         BNH   SHIFT                   BR IF PROPER ORDER               02020000
EXCHANGE MVC   FIELD1(4),0(INDEX1)     TEMP STORE THE INDEX1 ENTRY      02040000
         MVC   0(4,INDEX1),0(INDEX2)   MOVE INDEX2 ENTRY TO INDEX1      02060000
         MVC   0(4,INDEX2),FIELD1      MOVE INDEX1 ENTRY TO INDEX2      02080000
         B     SHIFT                                                    02100000
*                                                                       02120000
* THIS SECTION INITIALIZES THE EXTENT POINTERS AND EXTENT COUNTERS FOR  02125021
* THE FORMAT 6 INPUT DSCB, FORMAT 6 OUTPUT DSCB, AND DADSMTBL ENTRIES.  02130021
*                                                                       02135021
TESTCYLS TM    DADSMTBL,X'08'          TEST FOR SHARED CYLINDERS        02140000
         BZ    FINISH                                                   02160000
         IC    EXTCTR,EXTNUM           PICK UP NUMBER OF ENTRIES        02180000
         MVC   INDSCB+44(90),INDSCB+45 OVERLAY FORMAT BYTE              02200000
         MVI   INDSCB+134,X'00'                                   20344 02210018
         XC    OUTDSCB(140),OUTDSCB    ZERO OUTPUT DSCB                 02220000
         LA    INDEX2,ENTRIES          POINT TO FIRST ENTRY IN TABLE    02240000
         LA    COUNT1,26               PICK UP NUMBER OF EXTENTS (IN)   02260000
         LA    INDEX1,INDSCB+4         POINT TO EXTENTS IN INPUT DSCB   02280000
         LR    COUNT3,COUNT1           PICK UP NUMBER OF EXTENTS (OUT)  02300000
         LA    INDEX3,OUTDSCB+5        POINT TO EXTENTS IN OUTPUT DSCB  02320000
         LR    INDEX4,INDEX2           POINT TO ENTRIES IN TABLE        02340000
         LR    COUNT4,R0               ZERO REG                         02360000
         LR    RTA,R0                  ZERO REG                         02380000
         MVC   OUTCCHHR(5),INCCHHR     PICK UP OUTPUT CCHHR             02400000
         MVC   NEXTDADS(5),INCCHHR     HOLD OUTPUT CCHHR                02420000
         MVC   INCCHHR(5),DS5PTRDS     PICK UP CONT POINTER             02440000
*                                                                       02445021
* THIS SECTION COMPARES THE DADSMTBL ENTRY TO A FORMAT 6 INPUT EXTENT.  02450021
*                                                                       02455021
COMPARE  CLI   2(INDEX2),X'FF'         CHECK EXTENT TYPE                02460000
         BNE   NOTSPLIT                BR IF NOT SPLIT CYL              02480000
         CLC   0(2,INDEX2),0(INDEX1)   CHECK RTA OF ENTRY WITH F6       02500000
         BL    PERMERR                 BR IF PAST RIGHT ONE             02540000
         BE    DECRMENT                 BRANCH IF EQUAL          A31333 02541020
         CLC   0(4,INDEX2),FAKEXT       IS THIS A DUMMY EXTENT?  A36312 02541921
         BE    MOVEEXT                  BRANCH IF YES            A36312 02542821
         BAL   RETURN,WITHINF6          CALCULATE RTA+1 OF F6    A36312 02543721
*                                       EXTENT                   A36312 02544621
         CH    R1,0(INDEX2)             TEST IF ENTRY LIES       A36312 02545521
*                                       WITHIN THE F6 EXTENT     A36312 02546421
         BNH   MOVEEXT                  BRANCH IF NO             A36312 02547321
*                                                                       02548221
* THIS SECTION DECREMENTS THE DATA SET COUNT BYTE IN THE F6 EXTENT.     02549121
*                                                                       02550021
DECRMENT EQU   *                                                 A31333 02551020
         SR    WORKREG,WORKREG         ZERO REG                         02560000
         IC    WORKREG,4(INDEX1)       PICK UP Z (NUM OF DATA SETS)     02580000
         BCT   WORKREG,LOOKAHED         DECREMENT DATA SET CTR   A36312 02586021
*                                       BRANCH IF GREATER THAN 0 A36312 02592021
*                                                                       02598021
* THIS SECTION MOVES THE RTA/RTA+1 OF THE F6 EXTENT TO THE DADSMTBL.    02604021
*                                                                       02610021
         MVC   0(4,INDEX4),0(INDEX1)   MOVE XXYY TO DADSMTBL            02620000
         LH    RTA,2(INDEX4)           PICKUP NO. OF CYLS (YY)          02640000
         MH    RTA,DS4DEVSZ+2          MULT BY TKS PER CYL              02660000
         AH    RTA,0(INDEX4)           ADD BEGIN RTA                    02680000
         STH   RTA,2(INDEX4)           STORE END RTA+1 IN DADSM TABLE   02700000
INCINDX  EQU   *                                                        02720000
         LA    COUNT4,1(COUNT4)        INCREMENT ENTRY COUNTER          02740000
         LA    COUNT3,1(COUNT3)         INCREMENT OUTPUT COUNTER  20344 02750018
         LA    INDEX4,4(INDEX4)        INCREMENT ENTRY POINTER (NEW)    02760000
         BCT   EXTCTR,NXTENTRY         DECREMENT ENTRY COUNTER          02780000
         B     ENDENTRY                                                 02800000
*                                                                       02820000
* THIS SECTION INCREMENTS THE DADSMTBL POINTERS AND COUNTER.            02826021
*                                                                       02832021
NOTSPLIT EQU   *                                                        02840000
         MVC   0(4,INDEX4),0(INDEX2)    COMPACT DADSM TABLE.            02880000
         LA    COUNT4,1(COUNT4)         INCREMENT ENTRY COUNTER   20873 02886018
         LA    INDEX4,4(INDEX4)         INCREMENT ENTRY PTR(NEW)  20873 02892018
         LA    INDEX2,4(INDEX2)                                   20873 02898018
         BCT   EXTCTR,COMPARE                                     20873 02904018
         MVC   0(5,INDEX3),0(INDEX1)   MOVE XXYYZ TO OUT DSCB  @ZA07591 02907003
         B     ENDENTRY                                           20873 02910018
*                                                                       02920000
* THIS SECTION TESTS IF THE NEXT ENTRY LIES WITHIN THE SAME F6 EXTENT.  02922021
* IF NOT, IT MOVES THE XXYY OF THE F6 EXTENT AND THE NEW Z INTO THE     02924021
* OUTPUT F6 DSCB.                                                       02926021
*                                                                       02928021
LOOKAHED EQU   *                                                 A36312 02930021
         CH    EXTCTR,ONEENTRY          IS THIS THE LAST ENTRY   A36312 02932021
         BE    MOVEXXYY                 BRANCH IF LAST ENTRY     A36312 02934021
         BAL   RETURN,WITHINF6          CALCULATE RTA+1 OF F6    A36312 02936021
*                                       EXTENT                   A36312 02938021
         CH    R1,4(INDEX2)             DOES NEXT ENTRY LIE      A36312 02940021
*                                       WITHIN SAME F6 EXTENT    A36312 02942021
         BH    SAVENEWZ                 BRANCH IF YES            A36312 02944021
MOVEXXYY EQU   *                                                 A36312 02946021
         MVC   0(4,INDEX3),0(INDEX1)    MOVE XXYY TO OUTPUT DSCB A36312 02948021
         STC   WORKREG,4(INDEX3)       STORE NEW Z IN OUTPUT DSCB       02960000
         BCT   EXTCTR,NXTENTRY         DECREMENT ENTRY COUNTER          02980000
*                                                                       02990021
ENDENTRY LA    INDEX2,FAKEXT           POINT TO PSEUDO ENTRY            03000000
         B     CHECKIN                                                  03020000
*                                                                       03040000
NXTENTRY LA    INDEX2,4(INDEX2)        INCREMENT ENTRY POINTER (OLD)    03060000
         B     CHECKIN                                                  03080000
*                                                                       03100000
SAVENEWZ EQU   *                                                 A36312 03102021
         STC   WORKREG,4(INDEX1)        STORE NEW DATA SET COUNT A36312 03104021
         BCTR  EXTCTR,0                 DECREMENT NO OF ENTRIES  A36312 03106021
         LA    INDEX2,4(INDEX2)         POINT TO NEXT ENTRY      A36312 03108021
         B     COMPARE                  GO COMPARE               A36312 03110021
*                                                                       03112021
* THIS SECTION CHECKS TO SEE IF THERE ARE ANY MORE EXTENTS IN THE F6    03114021
* INPUT DSCB. IF NOT, IT READS THE NEXT F6 IN THE CHAIN.                03116021
*                                                                       03118021
MOVEEXT  MVC   0(5,INDEX3),0(INDEX1)   MOVE XXYYZ TO OUTPUT DSCB        03120000
CHECKIN  EQU   *                                                 A36312 03130021
         BCT   COUNT1,MOREIN            DECREMENT INPUT EXTENT   A36312 03140021
*                                       COUNTER                  A36312 03150021
         TM    INCCHHR+4,X'FF'         TEST FOR CONT POINTER            03160000
         BZ    LASTEXT1                                           20344 03180018
         LA    WORKREG,INCCHHR         SET UP NEW CCW9                  03200000
         ST    WORKREG,CCW9                                             03220000
         MVI   CCW9,X'31'              STORE CCW9                       03240000
         LA    WORKREG,CCW9                                             03260000
         NI    CCW11+4,X'EF'           TURN OFF SKIP FLAG               03280000
         MVC   SEEK+3(5),INCCHHR       SET UP IOS SEEK                  03300000
         BAL   RETURN,EXECUTIO         READ NEXT DSCB                   03320000
         MVC   CCW9(4),CCW6            RESTORE CCW9                     03340000
         MVC   NEXTDADS(5),INCCHHR     HOLD CCHHR                       03360000
         MVC   INDSCB+44(90),INDSCB+45 OVERLAY FORMAT BYTE              03400000
         MVI   INDSCB+134,X'00'                                   20344 03410018
         LA    COUNT1,26               PICK UP NUMBER OF EXTENTS (IN)   03420000
         LA    INDEX1,INDSCB+4         POINT TO EXTENTS IN INPUT DSCB   03440000
         B     CHECKOUT                                                 03460000
LASTEXT1 EQU   *                                                  20344 03462018
         CLC   OUTDSCB+5(4),ZERO        ANY EXTENTS               20344 03464018
         BE    LASTEXT3                 BRANCH IF NO EXTENTS     A36312 03466021
         LA    RETURN,ENDUPD2                                     20344 03468018
*                                                                       03468521
* THIS SECTION WRITES FORMAT 6 AND FORMAT 0 DSCBS.                      03469021
*                                                                       03469521
WRTFMT6  EQU   *                                                  20344 03470018
         MVC   OUTDSCB(4),SIX           MOVE IN 06060606          20344 03472018
         MVC   OUTDSCB+4(40),OUTDSCB+5  SHIFT KEY PORTION         20344 03474018
         MVI   OUTDSCB+44,X'F6'         INSERT FMT6 ID            20344 03476018
WRTFMT62 EQU   *                                                  20344 03478018
         MVC   SEEK+3(5),OUTCCHHR       SET UP IOS SEEK           20344 03480018
         LA    WORKREG,CCW6             PICK UP START CCW,S       20344 03482018
         OI    CCW11+4,X'10'            TURN ON SKIP FLAG         20344 03484018
         B     EXECUTIO                 EXCP                      20344 03486018
*                                                                       03489021
* THIS SECTION TESTS IF THERE ARE ANY MORE EXTENTS IN THE OUTPUT DSCB.  03492021
* IF NOT, IT WRITES OUT THE OUTPUT FORMAT 6 DSCB.                       03495021
*                                                                       03498021
MOREIN   EQU   *                                                 A36312 03501021
         LA    INDEX1,5(INDEX1)         INCREMENT INPUT EXTENT   A36312 03504021
*                                       POINTER                  A36312 03507021
CHECKOUT EQU   *                                                 A36312 03510021
         BCT   COUNT3,MOREOUT           DECREMENT EXTENT CTR     A36312 03513021
*                                       BRANCH IF MORE EXTENTS   A36312 03516021
*                                                                       03519021
* THIS SECTION TESTS IF THE FORMAT 6 POINTER IN THE FORMAT 4 DSCB       03522021
* NEEDS TO BE ZEROED.                                                   03525021
*                                                                       03528021
LASTEXT2 CLC   OUTDSCB+5(4),ZERO       TEST FOR NO EXTENTS              03540000
         BNE   DADSOUT1                BR IF AN EXTENT                  03560000
LASTEXT3 EQU   *                                                  20344 03570018
         CLC   OUTCCHHR,DS4F6PTR        TEST IF FIRST F6 DSCB    Y02080 03580002
         BNE   ENDUPDAT                                           20344 03590018
         XC    DS4F6PTR,DS4F6PTR        ZERO F6 PTR IN F4 DSCB   Y02080 03600002
         B     ENDUPDAT                                           20344 03610018
*                                                                       03611021
* THIS SECTION TESTS IF THE CHAINING POINTER OF THE FORMAT 6 DSCB       03612021
* NEEDS TO BE FILLED IN. IF THERE IS ONLY ONE ENTRY LEFT IN THE         03613021
* DADSMTBL, THIS LAST ENTRY IS A SPLIT CYLINDER ENTRY, THERE IS         03614021
* ONLY ONE EXTENT LEFT IN THE INPUT FORMAT 6 DSCB, ITS DATA SET         03615021
* COUNT IS ONE, AND THE RTA/RTA+1 OF THE ENTRY IS CONTAINED IN          03616021
* THE RTA/RTA+1 OF THE INPUT FORMAT 6 EXTENT, THEN THE CHAINING         03617021
* POINTER IN THE OUTPUT FORMAT 6 IS ZERO.                               03618021
*                                                                       03619021
DADSOUT1 EQU   *                                                  20344 03620018
         TM    4(INDEX1),X'FF'          ANY ENTRIES LEFT          20344 03630018
         BZ    DADSOUT2                 BRANCH IF NOT            A36312 03631021
         LTR   EXTCTR,EXTCTR            ANY ENTRIES LEFT         A36312 03632021
         BZ    NEWF6                    BRANCH IF NOT            A36312 03633021
         TM    9(INDEX1),X'FF'          IS THERE A SECOND EXTENT A36312 03634021
*                                       IN THE INPUT AREA        A36312 03635021
         BC    7,NEWF6                  BRANCH IF YES            A36312 03636021
         CLI   4(INDEX1),ONE            IS THE DATA SET COUNT 1  A36312 03637021
         BNE   NEWF6                    BRANCH IF NOT            A36312 03638021
         CLI   2(INDEX2),X'FF'          IS IT A SPLIT CYLINDER   A36312 03639021
*                                       ENTRY?                   A36312 03640021
         BNE   NEWF6                    BRANCH IF NOT            A36312 03641021
         CLC   0(2,INDEX2),0(INDEX1)    COMPARE RTA TO F6 EXTENT A36312 03642021
         BE    WRITEF6                  BRANCH WITHOUT PLACING   A36312 03643021
*                                       CHAINING PTR IN DSCB     A36312 03644021
         BAL   RETURN,WITHINF6          CALCULATE RTA+1 OF F6    A36312 03645021
*                                       EXTENT                   A36312 03646021
         CH    R1,0(INDEX2)             TEST IF ENTRY LIES       A36312 03647021
*                                       WITHIN THE F6 EXTENT     A36312 03648021
         BH    WRITEF6                  BRANCH IF YES WITHOUT    A36312 03649021
*                                       PLACING CHAINING PTR     A36312 03650021
NEWF6    EQU   *                                                 A36312 03651021
         MVC   OUTDSCB+135(5),NEXTDADS  MOVE IN CHAIN POINTER    A36312 03652021
WRITEF6  EQU   *                                                 A36312 03653021
         BAL   RETURN,WRTFMT6           WRITE FORMAT 6           A36312 03654021
         MVC   OUTCCHHR(5),INCCHHR      UPDATE POINTERS          A36312 03655021
         MVC   INCCHHR(5),DS5PTRDS                                20344 03680018
         XC    OUTDSCB(140),OUTDSCB     ZERO OUTPUT AREA          20344 03690018
         LA    COUNT3,26                NO. OF OUTPUT EXTENDS     20344 03700018
         LA    INDEX3,OUTDSCB+5         POINT TO OUTPUT EXTEND    20344 03710018
         B     COMPARE                                            20344 03720018
*                                                                       04140000
* THIS SECTION TESTS IF ANY EXTENT HAS BEEN MOVED TO THE OUTPUT DSCB.   04148021
*                                                                       04156021
MOREOUT  EQU   *                                                 A36312 04164021
         LTR   RTA,RTA                  ANY MOVE TO OUTPUT DSCB? A36312 04172021
         BZ    NEXTEXT                 BR IF YES                        04180000
         SR    RTA,RTA                 ZERO REG                         04200000
         B     COMPARE                                                  04220000
*                                                                       04240000
NEXTEXT  LA    INDEX3,5(INDEX3)        INCREMENT OUTPUT EXTENT POINTER  04260000
         B     COMPARE                                                  04280000
*                                                                       04300000
* THIS SECTION WRITES OUT THE LAST FORMAT 6 DSCB.                       04301021
*                                                                       04302021
DADSOUT2 EQU   *                                                  20344 04303018
         BAL   RETURN,WRTFMT6           WRITE FMT 6               20344 04306018
         MVC   OUTCCHHR(5),INCCHHR      UPDATE PTR                20344 04309018
ENDUPDAT EQU   *                                                  20344 04312018
         LH    WORKREG,HOLENUM          LOAD NO OF HOLES          20344 04315018
         LA    WORKREG,1(WORKREG)       ADD 1                     20344 04318018
         STH   WORKREG,HOLENUM          RESTORE                   20344 04321018
         XC    OUTDSCB(140),OUTDSCB     ZERO OUTPUT AREA          20344 04324018
         BAL   RETURN,WRTFMT62          WRITE FMT 0               20344 04327018
ENDUPD2  EQU   *                                                  20344 04330018
         STC   COUNT4,EXTNUM            STORE NO. OF ENTRIES      20344 04333018
         MVC   INCCHHR(5),DADSMADR      INSERT FMT 5 CCHHR.             04340000
         LA    WORKREG,INCCHHR         SET UP NEW CCW9                  04360000
         ST    WORKREG,CCW9                                             04380000
         MVI   CCW9,X'31'              STORE CCW9                       04400000
         LA    WORKREG,CCW9                                             04420000
         NI    CCW11+4,X'EF'           TURN OFF SKIP FLAG               04440000
         MVC   SEEK+3(5),INCCHHR       SET UP IOS SEEK                  04460000
         BAL   RETURN,EXECUTIO         READ FIRST F5 DSCB               04480000
         MVC   CCW9(4),CCW6            RESTORE CCW9                     04500000
FINISH   EQU   *                                                        04502002
         SR    COUNT4,COUNT4           ZERO ENTRIES COUNTER     SA56400 04510002
         IC    COUNT4,EXTNUM           SET ENTRIES COUNTER TO   SA56400 04512002
*                                      THE NUMBER OF ENTRIES IN SA56400 04514002
*                                      DADSMTBL                 SA56400 04516002
         LTR   COUNT4,COUNT4           CHECK NUMBER OF ENTRIES  SA56400 04518002
         BZ    LEAVE                   NO ENTRIES EXIT          SA56400 04518402
         MVC   OUTCCHHR(K5),DADSMADR   OUTCCHHR = 1ST FORMAT    SA56400 04532002
*                                      5 DSCB                   SA56400 04532402
         MVC   INCCHHR(K5),DS5PTRDS    SET NEXT FORMAT 5 CCHHR  SA56400 04534002
*                                      FOR NEXT DADSM INPUT     SA56400 04536002
         MVC   NEXTDADS(K5),INCCHHR    INIT NEXT DADSM PTR      SA56400 04538002
         LA    R2,LOAD4                 POINT TO PROPER ID.             04540000
         B     XCTLEXIT                                                 04560000
*                                                                       04565021
* THIS ROUTINE EXECUTES A CHANNEL PROGRAM.                              04570021
*                                                                       04575021
EXECUTIO ST    WORKREG,IOB+16          SET UP CCW PTR IN IOB            04580000
         MVI   ECB,0                    CLEAR ECB FLAGS.                04600000
         EXCP  IOB                                                      04620000
         WAIT  1,ECB=ECB                                                04640000
         TM    ECB,X'20'               TEST FOR PERMANENT I/O ERROR     04660000
         BCR   5,RETURN                 RETURN IF NO I/O ERROR.         04680000
*                                                                       04700000
         L     R1,TCBADDR               LOAD TCB ADDRESS         Y02078 04704002
         USING TCB,R1                   TCB ADDRESSABILITY       Y02078 04708002
         MODESET EXTKEY=RBT234,WORKREG=2  SWITCH TO CALLER'S KEY Y02078 04712002
PERMERR  MVI   11(VOLISTX),X'04'       STORE ERROR CODE IN VOL LIST     04720000
         MODESET EXTKEY=ZERO            RETURN TO KEY ZERO       Y02082 04724002
         DROP  R1                                                Y02078 04728002
         LA    WORKREG,8                                                04740000
         STH   WORKREG,ERCODE          STORE ERROR CODE IN WORK AREA    04760000
*                                                                       04780000
* THIS SECTION BRANCHES TO IGG0290C OR IGG0290D.                        04786002
*                                                                       04792021
LEAVE    EQU   *                                                        04800000
         LA    R2,LOAD5                 POINT TO PROPER ID.             04820000
XCTLEXIT EQU   *                                                        04840000
         IECRES LOAD,EXTPR=(RWKAREA),MODID=(R2),BRANCH=DIRECT    Y02080 04900002
*                                                                       04961021
* THIS ROUTINE CALCULATES THE RTA+1 OF THE FORMAT 6 EXTENT.             04962021
*                                                                       04963021
WITHINF6 EQU   *                                                 A36312 04964021
         MVC   FIELD1(2),2(INDEX1)      GET NO. OF SHARED CYLS   A36312 04965021
         LH    R1,FIELD1                                         A36312 04966021
         MH    R1,DS4DEVSZ+2            FIND NO. OF SHARED TRKS  A36312 04967021
         MVC   FIELD1(2),0(INDEX1)      GET BEGINNING TRACK ADDR A36312 04968021
         AH    R1,FIELD1                R1 CONTAINS RTA+1        A36312 04969021
         BR    RETURN                   RETURN                   A36312 04970021
*                                                                       04980000
*** PROGRAM CONSTANTS                                                   05000000
*                                                                       05020000
FAKEXT   DC    X'FFFFFFFF'                                              05040000
SIX      DC    X'06060606'                                              05060000
ONEENTRY DC    H'1'                     VALUE ONE                A36312 05070021
*                                                                       05080000
*** THE FOLLOWING CHANNEL PROGRAM SEARCHES FOR A FORMAT 0 DSCB RECORD   05100000
*** AND WRITES OR READS A DADSM DSCB.                                   05120000
*                                                                       05140000
CHALPROG DS    0F                                                       05160000
*CCW1                                   TO BE CONSTRUCTED               05180000
*                                       READ HOME ADDRESS               05200000
*CCW2                                   TO BE CONSTRUCTED               05220000
*                                       READ COUNT (INTO OUTDSCB+136)   05240000
*CCW3                                                                   05260000
         DC    X'29'                   SEARCH EQUAL KEY (FMT 0 DSCB)    05280000
         DC    AL3(4+CCW4-FIRST)                                        05300000
         DC    X'6000'                                                  05320000
         DC    H'4'                                                     05340000
*CCW4                                   TO BE CONSTRUCTED               05360000
*                                       TIC TO CCW2                     05380000
*CCW5                                   TO BE CONSTRUCTED               05400000
*                                       CONTROL SEEK                    05420000
*CCW6                                   TO BE CONSTRUCTED               05440000
*                                       SEARCH EQUAL ID (OUTCCHHR)      05460000
*CCW7                                   TO BE CONSTRUCTED               05480000
*                                       TIC TO CCW6                     05500000
*CCW8                                                                   05520000
         DC    X'0D'                   WRITE KEY AND DATA (OUTDSCB)     05540000
         DC    AL3(0+OUTDSCB-FIRST)                                     05560000
         DC    X'4000'                                                  05580000
         DC    H'140'                                                   05600000
*CCW9                                   TO BE CONSTRUCTED               05620000
*                                       SEARCH EQUAL ID (OUTCCHHR)      05640000
*CCW10                                  TO BE CONSTRUCTED               05660000
*                                       TIC TO CCW9                     05680000
*CCW11                                  TO BE CONSTRUCTED               05700000
*                                       READ KEY DATA (INDSCB)          05720000
*                                                                       05722021
*** TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                       05724002
*                                                                       05726021
         XCTLTABL ID=(LOAD4,0C,LOAD5,0D),SVC=029,LENGTH=,BRT=YES Y02080 05730002
         SPACE 2                                                 Y02078 05750002
         IECDSECS CVT,RB,TCB,EXPAND=YES  CVT, RB, AND TCB DSECTS Y02078 05760002
WORKAREA IECSCRWA EP,F4,D1=(5)          SCRATCH WORK AREA        Y02080 05770002
ZERO     EQU   CCW4+4                                                   07080000
         END   IGG0290B                                          A36312 47120021
