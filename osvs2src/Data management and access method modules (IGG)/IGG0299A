         TITLE 'IGG0299A - DADSM SCRATCH - REMOVE DSCB(S)'              00010021
IGG0299A CSECT                                                          00020021
*                                                                     * 00030021
*0000003400,007200-007600,008000,009400,036600,084700,093200-    A37199 00037021
*0000093600                                                      A37199 00044021
*          RELEASE 21.7 DELETIONS                                       00046002
*0000000520-000620,079240-080800,089000,090200                 SA56400  00048002
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00049002
*0000001000,003800,005200-005400,006800,008000-008200,009700,    Y02080 00049102
*0000014570,014780,015600,016000,022200,041200,041720,042000,    Y02080 00049202
*0000045200-046000,048200,049800,050600,051200,051500,051900,    Y02080 00049302
*0000054200,055800,076400,079120,080700-093400,094000            Y02080 00049402
*0000006400,008600-009200,043400,057600-057800,093500-094000     Y02078 00049502
*0000050800                                                      Y02082 00049602
*          VS2 RELEASE 03 DELETIONS/CHANGES                    @ZM30032 00050003
*0000                                                          @Y30LSTG 00055003
*          VS2 SU32 DELETIONS/CHANGES                          @G32DSFS 00058037
*D028188-028196,                                               @G32DSFS 00061037
*          VS2 RELEASE 037 CHANGES                                      00064037
*A015183,A036300-036310,C036315                                @ZA16029 00064537
*                                                              @G60ASBJ 00065060
*          VS2 SU60 DELETIONS/CHANGES                          @G60ASBJ 00065160
*                                                              @G60ASBJ 00065260
*A 006520,015121-015122,021200-021830,022240-022560            @G60ASBJ 00065360
*C 022040                                                      @G60ASBJ 00065460
*                                                              @G60ASBJ 00065560
* MODULE NAME - IGG0299A                                                00066002
*                                                                       00067002
* DESCRIPTIVE NAME - DADSM SCRATCH - REMOVE DSCB(S)                     00068002
*                                                                       00069002
* COPYRIGHT - NONE                                                      00070002
*                                                                       00071002
* CHANGE ACTIVITY - SEE DELETIONS/CHANGES FOLLOWING CSECT CARD          00071202
*                                                                       00071402
* STATUS CHANGE LEVEL 001                                               00072021
*                                                                       00080021
*ATTRIBUTES - REENTRANT                                                 00100002
*                                                                       00120021
*FUNCTION - THE MODULE EXTRACTS THE EXTENTS FROM THE FORMAT 1 OR 3 DSCB 00150021
*           RECORDS.  THESE EXTENTS ARE THEN CONVERTED FROM CCHHCCHH TO 00180021
*           BEGINNING RTA AND ENDING RTA+1, AND ARE STORED IN A TABLE   00210021
*           IN THE WORKAREA.  THE FORMAT 1, 2, AND 3 DSCB RECORDS IN    00240021
*           THE VTOC ARE ZEROED OUT.  IF THE DATA SET TO BE    @Y30LSTG 00270003
*           SCRATCHED RESIDES ON A VIRTUAL MSS  VOLUME, THIS   @Y30LSTG 00275003
*           MODULE WILL SET UP THE PARAMETER LIST WHICH WILL   @Y30LSTG 00280003
*           LATER BE USED IN IGG0290D TO RELINQUISH THE DASD   @Y30LSTG 00285003
*           SPACE.                                             @Y30LSTG 00290003
*           THE RAC DEFINITIONS ARE DELETED FOR RAC DEFINED    @Z40RSGD 00297537
*           DATA SETS (RACDEF).                                @Z40RSGD 00305037
*                                                                       00312537
*ENTRIES - THE ONLY ENTRY POINT TO THIS MODULE IS IGG0299A.  ENTRY IS   00320021
*          MADE FROM THE FOURTH LOAD OF SCRATCH - IGG0290A.             00340021
*                                                                       00360021
*                                                                       00400021
*SUPERVISOR CALLS AND MACROS. THE FOLLOWING ARE SUPERVISOR CALLS        00420021
*          ISSUED IN THE MACRO EXPANSIONS:                              00440021
*                    EXCP(0) READ FROM OR WRITE TO DIRECT ACCESS DEVICE 00460021
*                    WAIT(1) WAIT ON EVENT CONTROL BLOCK                00480021
*                                                                       00500021
*                                                                       00580021
*OTHER MACROS USED                                                      00600021
*                    IECSDSL1 - ENABLES SYMBOLIC ADDRESSING OF DSCBS    00620021
*                    IECSCRWA - SCRATCH WORK AREA EXPANSION             00630002
*                    IECDSECS - EXPANDS THE CVT, RB, AND TCB DSECTS     00640002
*                    IECRES - GET CORE FOR RIDDING DASD SPACE  @Y30LSTG 00645003
*                                                                       00660021
*INPUT - AT ENTRY TO THIS MODULE REGISTER 13 POINTS TO THE WORKAREA     00670021
*        AND REGISTER 9 POINTS TO THE CVT.                              00680002
*                                                                       00700021
*OUTPUT - THE FORMAT 1, 2, AND 3 DSCB'S FOR THE DATA SET ARE ZEROED     00710021
*          OUT. WHEN CONTROL IS TRANSFERRED TO THE NEXT LOAD, MODULE    00720021
*          IGG0290B, REGISTER 13 POINTS TO THE WORK AREA. THE DADSM     00730021
*          TABLE IN THE WORK AREA CONTAINS THE EXTENTS OF THE DATA SET. 00740021
*                                                                       00780021
*STORAGE - PROGRAM CODE CSECT = LESS THAN 1024 BYTES                    00800002
*          WORK AREA = 900 BYTES                               @Y30LSTG 00820003
*          RPS WORK AREA = 128 BYTES                                    00830002
*                                                                       00840021
*ERROR CONDITIONS - PERMANENT I/O ERROR                                 00860002
*         - ERROR IN RACDEF                                   @Z40RSGD  00910037
*                                                                       00930021
*                                                                       00960021
*NOTES - THIS MODULE WAS SPLIT IN RELEASE 21.  THE FIRST HALF IS        00965021
*        MODULE IGG0290A.  AFTER THE REWRITE OF THE FORMAT 4 DSCB       00970002
*        (UNLIKE THE ALLOCATE, EXTEND, AND PARTIAL RELEASE FUNCTIONS    00971002
*        OF DADSM), IF THE DIRF BIT IS SET IN THE FORMAT 4 DSCB IN      00972002
*        THE SCRATCH WORK AREA, THIS INDICATES THAT THE DIRF BIT        00973002
*        WAS PREVIOUSLY SET IN THE FORMAT 4 DSCB.                       00974002
*                                                                       00975021
*REGISTER USAGE                                                         00980021
R0       EQU   0                                                        01000021
R1       EQU   1                                                        01020021
R2       EQU   2                                                        01040021
R3       EQU   3                                                        01060021
EXTCTR   EQU   4                                                        01120021
R5       EQU   5                                                        01140021
R6       EQU   6                                                        01180021
INDEX1   EQU   6                                                        01200021
INDEX2   EQU   7                                                        01220021
R7       EQU   7                                                        01240021
R8       EQU   8                                                        01260021
VOLISTX  EQU   8                                                        01280021
RCVT     EQU   9                                                        01300021
R10      EQU   10                                                       01340021
R11      EQU   11                                                       01360021
RBASE    EQU   12                                                       01380021
RWKAREA  EQU   13                                                       01400021
RETURN   EQU   14                                                       01420021
WORKREG  EQU   15                                                       01440021
*                                                                       01442021
* OTHER EQUATES                                                         01444021
*                                                                       01446021
DIRFBIT  EQU   X'04'                    VTOC INTERRUPT BIT       O19117 01450021
DOSBIT   EQU   X'80'                    DOS BIT IN F4                   01464021
NOCC     EQU   X'00'                    SUPPRESS COMMAND CHAIN.         01471021
WRITE    EQU   X'05'                    WRITE DATA COMMAND              01485021
D4       EQU   4                        DISPLACEMENT OF 4               01492021
K16      EQU   16                       CONSTANT                        01499021
L90      EQU   90                       LENGTH OF 90                    01506021
K2       EQU   2                        CONSTANT OF 2            Y02080 01508002
K3       EQU   3                        CONSTANT OF 3            Y02080 01509002
CCHHL    EQU   4                        LENGTH OF CCHH           Y02080 01510002
K6       EQU   6                        CONSTANT OF 6            Y02080 01511002
K12      EQU   12                       CONSTANT OF 12           Y02080 01512002
RACPASS  EQU   X'40'                    BYPASS RACDEF -        @G60ASBJX01512160
                                        CAMLST SWITCH          @G60ASBJ 01512260
DS1RACDF EQU   X'40'                    DS1DSIND-RAC DEFINED   @Z40RSGD 01512437
RACERR08 EQU   8                        NOT-RAC DEFINED        @Z40RSGD 01512837
RACERR09 EQU   9                        DATA SET ASSOCIATED    @Z40RSGD 01512937
*                                       WITH OTHER RAC         @Z40RSGD 01513037
*                                       ENTITIES               @Z40RSGD 01513237
ZERO     EQU   0                        QUANTITY OF ZERO       @Y30LSTG 01515637
D0       EQU   0                        DISPLACEMENT OF ZERO   @Y30LSTG 01515837
D1       EQU   1                        DISPLACEMENT OF ONE    @Y30LSTG 01516037
D2       EQU   2                        DISPLACEMENT OF TWO    @Y30LSTG 01516237
D3       EQU   3                        DISPLACEMENT OF THREE  @Y30LSTG 01516437
D6       EQU   6                        DISPLACEMENT OF SIX    @Y30LSTG 01516637
D7       EQU   7                        DISPLACEMENT OF SEVEN  @Y30LSTG 01516837
D8       EQU   8                        DISPLACEMENT OF EIGHT  @Y30LSTG 01517037
D10      EQU   10                       DISPLACEMENT OF TEN    @Y30LSTG 01517237
D28      EQU   28                       TWENTY-EIGHT           @Y30LSTG 01517437
L1       EQU   1                        LENGTH OF ONE          @Y30LSTG 01517637
L2       EQU   2                        LENGTH OF TWO          @Y30LSTG 01517837
LABELS   EQU   X'40'                    MASK FOR USER LABELS   @Y30LSTG 01518037
VIRTDASD EQU   X'08'                    MASK FOR VIRTUAL DASD  @Y30LSTG 01518237
RECROUND EQU   X'41'                    RECORD ROUND OPTION    @ZA16029 01518337
CYL      EQU   X'C0'                    CYL ALLOC COMPARATOR   @Y30LSTG 01518437
RELINQ   EQU   X'04'                    RELINQUISH OP CODE     @Y30LSTG 01518637
ISAMDS   EQU   X'80'                    ISAM INDICATOR         @Y30LSTG 01518837
SPLTCYL  EQU   X'80'                    SPLIT CYLINDERS IND    @Y30LSTG 01519037
ACQPLN   EQU   96                       LENGTH OF PARM LIST    @Y30LSTG 01519237
UCBPTR   EQU   32                       POINTER TO UCB IN DEB  @Y30LSTG 01519437
*                                                              @Y30LSTG 01519637
*                                                                       01526637
STATUS   EQU   11                       OFFSET TO ERROR FLAG   @Z40RSGD 01528637
         BALR  RBASE,R0                                                 01533337
         USING BEGIN,RBASE                                              01540021
         USING SCRTHWKA,RWKAREA         WORK AREA ADDRESSABILITY Y02080 01560002
         USING CVT,RCVT                                                 01580021
*                                                                       01604021
* THIS SECTION SETS UP TO ADD THE EXTENTS IN THE FORMAT 1 DSCB          01608021
* TO THE DADSM TABLE.                                                   01612021
*                                                                       01616021
BEGIN    EQU   *                                                        01620021
* IF DATASET IS RAC-DEFINED DELETE DEFINITION BEFORE           @Z40RSGD 01670037
* UPDATING DSCBS.                                              @Z40RSGD 01720037
*                                                              @Z40RSGD 01770037
         TM    DS1DSIND,DS1RACDF        IS IT RAC DEFINED      @Z40RSGD 01820037
         BZ    BEGIN2                   NO-CONTINUE            @Z40RSGD 01870037
         L     R1,TCBADDR               LOCATE TCB             @Z40RSGD 01920037
         USING TCB,R1                                          @Z40RSGD 01970037
         L     R1,TCBJSCB               LOCATE JSCB            @Z40RSGD 02020037
         USING IEZJSCB,R1                                      @Z40RSGD 02070037
         L     R1,JSCBACT               GET ACTIVE JSCB        @G32DSPD 02090037
*************************************************************  @G60ASBJ 02120060
*                                                           *  @G60ASBJ 02127060
*  THE RACDEF WILL BE BYPASSED IF THE FOLLOWING CONDITIONS  *  @G60ASBJ 02134060
*  ARE MET:                                                 *  @G60ASBJ 02141060
*           (1) THE CALLER IS AUTHORIZED.                   *  @G60ASBJ 02148060
*           (2) JSCBPASS BIT IS SET TO 1.                   *  @G60ASBJ 02155060
*           (3) THE SECOND BIT OF THE SECOND BYTE OF THE    *  @G60ASBJ 02162060
*               SCRATCH (CAMLST) PARAMETER LIST IS 1.       *  @G60ASBJ 02169060
*                                                           *  @G60ASBJ 02176060
*************************************************************  @G60ASBJ 02183060
         TM    JSCBSWT1,JSCBPASS        IS RAC PROCESSING TO   @Z40RSGD 02190060
*                                       BE BYPASSED            @Z40RSGD 02197060
         BNO   BEGIN1                   NO - DON'T BYPASS      @G60ASBJ 02204060
*                                                              @G60ASBJ 02224060
* TEST CAMLST PARAMETER LIST BYTE 1 BIT 1.                     @G60ASBJ 02228060
* IF SET TO 1, BYPASS THE RACDEF.                              @G60ASBJ 02232060
*                                                              @G60ASBJ 02236060
         L     R1,OLDPLPTR              GET PARAMETER LIST     @G60ASBJX02240060
                                        POINTER                @G60ASBJ 02244060
         TM    D1(R1),RACPASS           BYPASS RACDEF ?        @G60ASBJ 02248060
         BO    BEGIN2                   YES, BYPASS RACDEF     @G60ASBJ 02252060
BEGIN1   DS    0H                       CONTINUE WITH DELETE   @G60ASBJ 02256060
* DELETE DEFINITION                                            @Z40RSGD 02270037
         MVC   RACDEF(LRACDEF),MRACDEF  SET UP PARM LIST       @Z40RSGD 02320037
         RACDEF ENTITY=PDSNAME,                                @Z40RSGDX02370037
               VOLSER=PVOLSER,                                 @Z40RSGDX02420037
               DSTYPE=N,                                       @Z40RSGDX02470037
               MF=(E,RACDEF)                                   @Z40RSGD 02520037
         LTR   WORKREG,WORKREG          TEST RACDEF COMPLETION @Z40RSGD 02810037
         BZ    BEGIN2 STATUS            OK-CONTINUE            @Z40RSGD 02812037
* PROFILE DELETE FAILED,BUT SCRATCH ANYWAY IF USER HAS ALTER   @G32DSPD 02812237
* AUTHORIZATION FOR THE VOLUME                                 @G32DSPD 02812437
         TM    SISW1,VOLRACHK           USER HAS VOLUME ACCESS @G32DSPD 02812637
         BO    BEGIN2                   YES,OK-CONTINUE        @G32DSPD 02813237
         L     R1,TCBADDR               TCB ADDRESSABILITY     @Z40RSGD 02814037
         USING TCB,R1                                          @Z40RSGD 02816037
         MODESET EXTKEY=RBT234,WORKREG=2  RESET KEY            @Z40RSGD 02818037
         DROP  R1                                              @Z40RSGD 02818137
         MVI   11(VOLISTX),RACERR08     ASSUME RETURN CODE 4   @Z40RSGD 02818437
         B     SETCODE2                 ERROR-TERMINATE        @Z40RSGD 02819737
BEGIN2   EQU   *                        CONTINUE               @Z40RSGD 02819837
         TM    DADSMTBL,DOSPACK         TEST FOR DOS PACK               02820021
         BO    MOVECCW                 BR IF YES.                       03460021
BLDTAB   MVC   INDSCB+4(30),DS1EXT1     SET UP BOUNDARIES               03480021
         LA    INDEX2,ENTRIES           LOAD DADSM TABLE INDEX          03500021
         SR    EXTCTR,EXTCTR                                            03520021
         IC    EXTCTR,DS1NOEPV         PICK UP NO. OF EXTENTS.          03540021
         CH    EXTCTR,SIXTEEN           MORE THAN 16 EXTENTS            03540421
         BNH   GOON                     IF NO, CONTINUE                 03540821
         OI    DS4VTOCI,DOSBIT          IF YES, SET DOS BIT, F4         03541221
         LA    EXTCTR,K16               16 TO NO. OF EXTS CNTR          03541621
         MVI   CCW3,WRITE               SET CCW TO WRITE F4             03542021
         MVI   CCW3+D4,NOCC             SUPPRESS COMMAND CHAIN.         03542421
         BAL   RETURN,EXCPIO            GO WT F4 WITH DOS BIT ON        03542821
GOON     EQU   *                                                        03543221
         CLI   DS1EXT1,X'40'   USER LABELS                        22833 03544021
         BNE   NOUSER           NO,                               22833 03548021
         LA    EXTCTR,1(EXTCTR) YES, INCR EXT CNT+1 FOR INTRNL USE22833 03552021
NOUSER   EQU   *                                                  22833 03556021
         STC   EXTCTR,EXTNUM           SAVE FOR LATER.                  03560021
         CLI   EXTNUM,3                CHECK THEIR NUMBER.              03580021
         BNH   ONLYF1                  BRIF ONLY F1 DSCB.               03600021
         LA    EXTCTR,3                SET LIMIT FOR EXT CONVERT.       03620021
ONLYF1   EQU   *                                               @Y30LSTG 03621003
*                                                              @Y30LSTG 03622003
* THIS SECTION GETS CORE FOR A PARAMETER LIST, ASSUMING ONE    @Y30LSTG 03623003
* DOESN'T ALREADY EXIST, TO BE USED LATER BY THE ICBACREL MACRO@Y30LSTG 03624003
* THIS IS DONE ONLY IF THE DATA SET TO BE SCRATCHED IS ON MSS  @Y30LSTG 03625003
* VIRTUAL DASD.                                                @Y30LSTG 03625203
*                                                              @Y30LSTG 03625403
         L     R1,WKADEB+UCBPTR        POINT TO UCB            @Y30LSTG 03626003
         USING UCB,R1                  ESTABLISH ADDRESSABILITY@Y30LSTG 03627003
         TM    UCBTBYT2,VIRTDASD       VIRTUAL DASD            @Y30LSTG 03628003
         BNO   NOVIRTD                 NO, DONT DO ANYTHING    @ZM30032 03629003
         TM    DS1SCALO,CYL            CYL ALLOCATIONS         @Y30LSTG 03629503
         BO    TEST2                   YES,GO TO NEXT CHECK    @ZA16029 03630037
         TM    DS1SCALO,RECROUND       RECORD ROUND OPTION?    @ZA16029 03630537
         BNO   NOVIRTD                 NO,DON'T RELINQUISH     @ZA16029 03631037
TEST2    CLI   DS1EXT1,SPLTCYL         SPLIT CYLINDERS?        @Y30LSTG 03631537
         BE    NOVIRTD                 YES, DONT DO ANYTHING   @Y30LSTG 03632103
         CLI   DS1NOEPV,ZERO           ANY EXTENTS             @Y30LSTG 03635003
         BE    NOVIRTD                 NO, BRANCH OUT          @ZM30032 03636703
         TM    DS1DSORG,ISAMDS         IS IT ISAM DATA SET     @Y30LSTG 03638403
         BO    NOVIRTD                 YES, DON'T REQINQUISH   @Y30LSTG 03640103
         L     R1,RELQADR              GET ADDR OF PARM LIST   @Y30LSTG 03641803
         LTR   R1,R1                   FROM PREV. VOL.         @Y30LSTG 03643503
         BNZ   VIRTD                   YES, DONT NEED ANOTHER  @ZM30032 03645203
         IECRES GET,EXTPR=(RWKAREA),ID=SCWA,LV=ACQPLN,         @Y30LSTG.03646903
               STM=(R2,RETURN,IECREGSV+K12)                    @Y30LSTG 03648603
         ST    R1,RELQADR              SAVE ADDRESS OF AREA    @Y30LSTG 03650303
         MODESET EXTKEY=ZERO            RE-ESTABLISH KEY ZERO  @Y30LSTG 03652003
*                                                              @Y30LSTG 03653703
* THIS SECTION FILLS THE PARM LIST FROM THE FORMAT 1 DSCB      @Y30LSTG 03655403
* WHEN THE DATA SET RESIDES ON MSS  VIRTUAL DASD.              @Y30LSTG 03657103
*                                                              @Y30LSTG 03658803
VIRTD    EQU   *                                               @Y30LSTG 03660503
         MVC   D7(L1,R1),DS1NOEPV      PUT IN # OF EXTENTS     @Y30LSTG 03662203
         MVI   D4(R1),RELINQ           MOVE IN OP CODE         @Y30LSTG 03663903
         MVI   D3(R1),ACQPLN           MOVE IN LENGTH          @Y30LSTG 03665603
         LA    R10,D28(,R1)            POINT TO START OF EXTS. @Y30LSTG 03667303
         LA    R6,INDSCB+D4            POINT TO 1ST DSCB EXT   @Y30LSTG 03669003
         LR    R5,EXTCTR               GET # EXTENTS IN DSCB   @Y30LSTG 03670703
         CLI   DS1EXT1,LABELS          ARE THERE USER LABELS   @Y30LSTG 03672403
         BNE   NOLABELS                NO, EVERYTHING ALL SET  @Y30LSTG 03674103
         BCTR  R5,R0                   YES, CANNOT FREE IT     @Y30LSTG 03675803
         LA    R6,D10(,R6)             SKIP OVER LABEL EXTENT  @Y30LSTG 03677503
NOLABELS EQU   *                                               @Y30LSTG 03679203
         STC   R5,D0(,R1)              SAVE NUM EXTS -THIS DSCB@Y30LSTG 03680903
         BAL   RETURN,EXTBUILD         GO FILL THE EXTENTS     @Y30LSTG 03682603
NOVIRTD  EQU   *                                               @Y30LSTG 03684303
*                                                              @Y30LSTG 03686003
         BAL   RETURN,CVTEXTS          CONVERT CCHH'S TO RTA'S.         03687703
*                                                                       03689403
* THIS SECTION WRITES BACK THE FORMAT 4 DSCB, IF NECESSARY.             03691103
*                                                                       03692803
MOVECCW  EQU   *                                                 O19117 03694503
         XI    DS4VTOCI,DIRFBIT         SET/RESET DIRF BIT       O19117 03696203
         TM    DS4VTOCI,DIRFBIT         TEST RESULTS             O19117 03697903
         BZ    SKPWR                    BR IF PREVIOUS INTERRUPT O19117 03699603
         MVI   CCW3,X'05'               SET WR DATA CMMD         O19117 03701303
         MVI   CCW3+4,X'00'             RESET CMMD CHAIN         O19117 03703003
         BAL   RETURN,EXCPIO            GO WRITE BACK F4         O19117 03704703
*                                                                       03706403
* THIS SECTION MODIFIES THE CHANNEL PROGRAM TO READ AND WRITE DSCB'S.   03708103
*                                                                       03709803
SKPWR    EQU   *                                                 O19117 03711503
         XI    DS4VTOCI,DIRFBIT         RESET/SET DIRF BIT       O19117 03713203
         EX    0,ISAMDSCB               STORE CONT PNTR          O19117 03714903
         MVC   CCW9(8),CCW1             STORE CCW9               O19117 03716603
         MVC   CCW5(8),CCW10       STORE CCW5                           03718303
         L     R1,CCW10                                                 03720021
         LA    WORKREG,CCW9-CCW4                                        03740021
         AR    R1,WORKREG               RESOLVE ADDR IN CCW10           03760021
         ST    R1,CCW10            STORE CCW10                          03780021
         L     R1,CCW1                                                  03800021
         LA    WORKREG,5                                                03820021
         AR    R1,WORKREG               RESOLVE ADDR IN CCW1            03840021
         ST    R1,CCW1             STORE CCW1                           03860021
         MVC   CCW4(8),CCW1        STORE CCW4                           03880021
         LM    R0,R5,CHANLPRG      LOAD CCW CONSTANTS                   03900021
         AR    R0,RWKAREA          RESOLVE ADDR IN CCW6                 03920021
         AR    R2,RWKAREA          RESOLVE ADDR IN CCW7                 03940021
         STM   R0,R5,CCW6               STORE CCW6 TO CCW8              03960021
         STM   R0,R1,CCW11              SET UP CCW11                    03980021
         MVI   CCW11+4,X'00'            STORE CCW11                     04000021
         LA    R0,SEEK                 M OF SEEK ADDR MUST BE ZERO.     04020021
         LA    R1,1                                                     04040021
         STM   R0,R1,CCW3               SET UP CCW3                     04060021
         MVI   CCW3,X'0D'                                               04080021
         MVI   CCW3+4,X'60'             STORE CCW3                      04100021
*                                                                       04110037
TESTPTR  TM    INCCHHR+4,X'FF'          TEST  CONT POINTER              04163237
         BZ    LASTDSCB                                                 04167837
*                                                                       04172437
* THIS SECTION WRITES A FORMAT 0 DSCB OVER A FORMAT 1, FORMAT 2,        04177037
* OR FORMAT 3 DSCB OR READS THE FIRST FORMAT 5 OR FORMAT 6 DSCB         04181637
* BEFORE BRANCHING TO THE NEXT LOAD OF SCRATCH - IGG0290B.              04186237
*                                                                       04190837
ZEROUT   MVI   OUTDSCB,X'00'            ZERO FIRST BYTE OF OUTPUT DSCB  04195437
         MVC   INLINESK+K2(CCHHL),INCCHHR  SET UP SEEK ADDRESS   Y02080 04200002
         MVC   SEEK+3(5),OUTCCHHR      SET UP SEEK FOR IOS.             04220021
         BAL   RETURN,EXCPIO            ZERO DSCB.                      04240021
         LH    WORKREG,DADSMTBL+2       LOAD COUNT OF DSCBS             04260021
         LA    WORKREG,1(WORKREG)       INCREMENT DSCB COUNTER          04280021
         STH   WORKREG,DADSMTBL+2       STORE COUNT OF DSCBS            04300021
         CLI   DS3FMTID,X'F2'           TEST FOR F2 DSCB OR LESS M4504  04320021
         BL    IOERROR                  BRANCH IF LESS THAN F2   Y02078 04340002
         MVC   OUTCCHHR(5),INCCHHR      STORE INPUT DSCB CCHHR   M4504  04360021
         BE    ISAMDSCB                 BR IF F2                 M4504  04380021
         CLI   DS3FMTID,X'F3'           TEST FOR F3 DSCB         M4504  04400021
         BE    MOREXTS                  BR IF F3                 M4504  04420021
FINISH   EQU   *                                                        04460021
         NI    DADSMTBL,X'EF'           TURN OFF NO VOLUME MOUNTED BIT  04480021
         LA    R2,LOAD3                 POINT TO PROPER ID.             04500021
XCTLEXIT EQU   *                        EXIT TO NEXT LOAD        Y02080 04520002
         IECRES LOAD,EXTPR=(RWKAREA),MODID=(R2),BRANCH=DIRECT    Y02080 04540002
*                                                                       04608021
* THIS SECTION SETS UP TO ADD THE EXTENTS IN THE FORMAT 3 DSCB          04616021
* TO THE DADSM TABLE.  IF THE DATA SET RESIDES ON MSS  VIRTUAL @Y30LSTG 04624003
* DASD, THIS ROUTINE ALSO COMPLETES THE PARAMETER LIST FOR     @Y30LSTG 04629003
* RELINQUISHING THE REAL DASD SPACE.                           @Y30LSTG 04630003
*                                                                       04632021
MOREXTS  MVC   DS3FMTID(L90),DS3ADEXT   SET UP BOUNDARIES               04640021
*                                                              @Y30LSTG 04641003
         L     R1,RELQADR               GET ADDR OF PARAM LIST @Y30LSTG 04642003
         LTR   R1,R1                    IS THERE ONE           @Y30LSTG 04643003
         BZ    SETCTRS                  NO, BRANCH OUT         @ZM30032 04644003
         CLI   D4(R1),RELINQ            VALID PARM LIST        @Y30LSTG 04645003
         BNE   SETCTRS                  NO, BRANCH OUT         @ZM30032 04646003
         SR    R6,R6                    ZERO A WORK REG        @Y30LSTG 04647003
         LR    R5,R6                    ZERO ANOTHER           @Y30LSTG 04648003
         IC    R6,D0(,R1)               GET # EXT IN F1        @Y30LSTG 04649003
         IC    R5,D7(,R1)               GET TOTAL # EXTENTS    @Y30LSTG 04651003
         SR    R5,R6                    GET # EXTS IN F3       @Y30LSTG 04652003
         LA    R6,INDSCB+D4             POINT TO DSCB ENTRIES  @Y30LSTG 04653003
         L     R10,D8(,R1)              POINT TO WHERE LEFT OFF@Y30LSTG 04654003
         LA    RETURN,SETCTRS           SET UP RETURN REG      @Y30LSTG 04655003
*                                                              @Y30LSTG 04656003
* THIS SECTION FILLS IN THE EXTENT ENTRIES FROM F1 AND F3 DSCBS@Y30LSTG 04657003
* INTO THE RELINQUISH PARAMETER LIST TO BE USED IN IGG0290D.   @Y30LSTG 04657203
*                                                              @Y30LSTG 04658003
EXTBUILD EQU   *                                               @Y30LSTG 04659003
         MVC   D0(L2,R10),D2(R6)        MOVE IN LOW CC         @Y30LSTG 04660003
         MVC   D2(L2,R10),D6(R6)        MOVE IN HIGH CC        @Y30LSTG 04661003
         LA    R10,D4(R10)              INCR TO NEXT PARM ENTRY@Y30LSTG 04662003
         LA    R6,D10(R6)               TO NEXT DSCB ENTRY     @Y30LSTG 04663003
         BCT   R5,EXTBUILD              GO BACK FOR MORE EXTS  @Y30LSTG 04664003
         ST    R10,D8(R1)               SAVE PTR TO NEXT       @Y30LSTG 04665003
         BR    RETURN                   RETURN TO CALLING RTINE@Y30LSTG 04665503
SETCTRS  EQU   *                                               @Y30LSTG 04666003
*                                                              @Y30LSTG 04667003
         LA    INDEX2,ENTRIES+12        LOAD DADSM TABLE INDEX          04680021
         SR    EXTCTR,EXTCTR                                            04700021
         IC    EXTCTR,EXTNUM           GET TOTAL NO. OF EXTENTS.        04720021
         SH    EXTCTR,THREE            NUMBER OF EXTENTS IN F3 DSCB.    04740021
         BAL   RETURN,CVTEXTS                                           04760021
         B     ISAMDSCB                 THIS BR WAS INSERTED TO         04764021
*                                        FACILITATE SCRATCHING A DATA   04768021
*                                        SET OF MORE THAN 16 EXTENTS.   04772021
*                                        IT CAUSES A RETURN TO READ AND 04776021
*                                        PROCESS THE NEXT FMT 3 DSCB.   04780021
*                                                                       04780821
* THIS SECTION INITIALIZES THE POINTERS NEEDED TO READ THE FIRST        04781621
* FORMAT 5 OR FORMAT 6 DSCB.                                            04782421
*                                                                       04783221
LASTDSCB TM    DS4VTOCI,DOSBIT          TEST FOR SPECIAL SUPPORT        04784021
         BO    NOSHRCYL                 PACK AND BRANCH IF YES          04788021
         TM    DADSMTBL,SHRCYL          TEST FOR SHARED CYLS            04792021
         BZ    NOSHRCYL                                                 04800021
         MVC   INCCHHR,DS4F6PTR         SET UP ADDR OF F6 DSCB   Y02080 04820002
         B     ZEROUT                                                   04840021
ISAMDSCB MVC   INCCHHR(5),DS3PTRDS      STORE CONT POINTER              04860021
         B     TESTPTR                                                  04880021
NOSHRCYL EQU   *                                                        04900021
         MVC   INCCHHR(5),DADSMADR      GET DADSM CCHHR.                04920021
         B     ZEROUT                                                   04940021
*                                                                       04944021
* THIS SECTION CONVERTS THE EXTENTS TO RTA/RTA+1 FORMAT AND ADDS        04948021
* THEM TO THE DADSM TABLE.                                              04952021
*                                                                       04956021
CVTEXTS  LA    INDEX1,INDSCB+4          LOAD EXTENTS INDEX              04960021
         XC    FIELD1,FIELD1            CLEAR CONVERSION AREA    Y02080 04980002
         LTR   EXTCTR,EXTCTR           TEST EXTENT COUNTER.             05000021
         BCR   13,RETURN               BR IF NO EXTENTS.                05020021
         LR    R5,RWKAREA               SAVE WORK AREA POINTER.         05040021
         STM   RCVT,R3,IECREGSV+K12     SAVE REGISTERS 9 - 3     Y02080 05060002
         LA    R1,WKADEB                POINTER TO DEB           Y02082 05080002
         LA    R2,FIELD1                POINT TO CONVERSION AREA Y02080 05120002
FIRSTCVT EQU   *                                                 A31333 05130021
         LA    R3,2                     SET LOOP CONTROL         A31333 05140021
         MVC   FIELD1+K3(CCHHL),K2(R6)  INSERT CCHH TO CONVERT   Y02080 05150002
CVTLOOP  L     WORKREG,CVTPRLTV        GET ENTRY TO THE CONVERT RTNE.   05160021
         BALR  RETURN,WORKREG           CONVERT CCHH TO TTR0.           05180021
         LM    RCVT,RWKAREA,IECREGSV+K12-SCRTHWKA(R5)  RESTORE   Y02080 05190002
*                                       REGS                     A31333 05200021
         SRA   R3,1                     DECREMENT LOOP COUNTER   A31333 05210021
         SRL   R0,16                    GET TT. TT = RTA.               05220021
         CLI   0(R6),X'80'             IS THIS A SHARED CYLINDER EXT.   05360021
         BE    SHAREXTS                 BRANCHIF SHARED CYLINDER        05380021
         LTR   R3,R3                    WAS UPPER CCHH CONVERTED A31333 05390021
         BZ    CONT                     BRANCH IF YES            A31333 05400021
         STH   R0,0(INDEX2)             STORE LOWER RTA          A31333 05410021
         MVC   FIELD1+K3(CCHHL),K6(R6)  PICK UP HIGH CCHH        Y02080 05420002
         B     CVTLOOP                  GO CONVERT UPPER CCHH    A31333 05430021
CONT     EQU   *                                                 A31333 05440021
         LA    R11,1                                             A31333 05450021
         AR    R0,R11                   ADD 1 TO RTA             A31333 05460021
         STH   R0,2(INDEX2)             STORE UPPER RTA+1        A31333 05470021
INCRINDX LA    R6,10(R6)                UPDATE CCHH INDEX.              05520021
         LA    R7,4(R7)                 UPDATE RTA INDEX.               05540021
         BCT   EXTCTR,FIRSTCVT          BR IF ANOTHER EXTENT.           05560021
         LM    RCVT,R3,IECREGSV+K12     RESTORE REGISTERS 9 - 3  Y02080 05580002
         BR    RETURN                   RETURM.                         05600021
*                                                                       05620021
SHAREXTS OI    DADSMTBL,8              INDICATE SHARED CYL'S.           05640021
         MVI   2(INDEX2),X'FF'         INDICATE SHARED CYL EXTENTS.     05660021
         STH   R0,0(INDEX2)             STORE RTA                A31333 05680021
         B     INCRINDX                INCREMENT INDICES.               05700021
*                                                                       05785021
* THIS ROUTINE EXECUTES A CHANNEL PROGRAM.                              05790021
*                                                                       05795021
EXCPIO   EQU   *                                                        05800021
         EXCP  IOB                      EXECUTE CHANNEL PROGRAM.        05840021
         WAIT  ECB=ECB                  WAIT FOR COMPLETION.            05860021
         TM    ECB,X'20'                TEST FOR I/O ERROR.             05880021
         BCR   7,RETURN                 RETURN IF OKAY.                 05900021
IOERROR  EQU   *                        I/O ERROR                Y02078 05904002
         L     R1,TCBADDR               LOAD TCB ADDRESS         Y02078 05908002
         USING TCB,R1                   TCB ADDRESSABILITY       Y02078 05912002
         MODESET EXTKEY=RBT234,WORKREG=2  SWITCH TO CALLER'S KEY Y02078 05916002
         MVI   11(VOLISTX),X'04'        SET I/O ERR IN VOL LST   M3097  05920021
SETCODE2 EQU   *                        RESET KEY              @Z40RSGD 05922037
         MODESET EXTKEY=ZERO            RETURN TO KEY ZERO       Y02082 05930002
         DROP  R1                                                Y02078 05940002
SETCODE  EQU   *                                                 M3097  06000021
         MVI   ERCODE+1,X'08'           SET ERROR INDICATION     M3097  06020021
         LA    R2,LOAD4                 POINT TO PROPER ID.             06060021
         B     XCTLEXIT                                                 06080021
*                                                                       06090021
*** PROGRAM CONSTANTS                                                   06100021
*                                                                       06120021
THREE    DC    H'3'                     NUMBER OF EXTENTS IN F1         06420021
SIXTEEN  DC    H'16'                    MAX NO. OF EXTENTS IF OS        06720021
RET04    DC    H'4'                     USED TO TEST RETURN    @Z40RSGD 06770037
*                                       CODE FROM RACDEF       @Z40RSGD 06820037
*                                                                       06920021
*** THE FOLLOWING CHANNEL PROGRAM WRITES A FORMAT 0 DSCB RECORD.        07220021
*** THE FIRST DADSM DSCB IS READ INTO THE INPUT AREA.                   07240021
*                                                                       07260021
CHANLPRG DS    0F                                                       07280021
*CCW1                                   TO BE CONSTRUCTED               07300021
*                                       SEARCH EQUAL ID (OUTCCHHR)      07320021
*CCW2                                   TO BE CONSTRUCTED               07340021
*                                       TIC TO CCW1                     07360021
*CCW3                                   TO BE CONSTRUCTED               07380021
*                                       WRITE KEY AND DATA (OUTDSCB)    07400021
*CCW4                                   TO BE CONSTRUCTED               07420021
*                                       SEARCH EQUAL ID (OUTCCHHR)      07440021
*CCW5                                   TO BE CONSTRUCTED               07460021
*                                       TIC TO CCW4                     07480021
*CCW6                                                                   07500021
         DC    X'0E'                   READ KEY AND DATA (INDSCB)       07520021
         DC    AL3(0+INDSCB-FIRST)                                      07540021
         DC    X'5000'                                                  07560021
         DC    H'140'                                                   07580021
*CCW7                                                                   07600021
         DC    X'07'                    SEEK                     A34916 07620021
         DC    AL3(INLINESK-FIRST)      SEEK ADDR                Y02080 07640002
         DC    X'4000'                                                  07660021
         DC    H'6'                                                     07680021
*CCW8                                                                   07700021
         DC    X'1A'                    READ HOME ADDRESS               07720021
         DC    AL3(0)                                                   07740021
         DC    X'5000'                                                  07760021
         DC    H'5'                                                     07780021
*CCW9                                   TO BE CONSTRUCTED               07800021
*                                       SEARCH EQUAL ID                 07820021
*CCW10                                  TO BE CONSTRUCTED               07840021
*                                       TIC TO CCW9                     07860021
*CCW11                                  TO BE CONSTRUCTED               07880021
*                                       READ KEY AND DATA               07900021
MRACDEF  RACDEF TYPE=DELETE,            RACDEF MASTER PARM     @Z40RSGDX07902037
               DSTYPE=N,                LIST                   @Z40RSGDX07904037
               MF=L                                            @Z40RSGD 07904437
LRACDEF  EQU   *-MRACDEF                LENGTH PARM LIST       @Z40RSGD 07904837
*                                                                       07906021
*** TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                       07912002
*                                                                       07918021
         XCTLTABL ID=(LOAD3,0B,LOAD4,0D),SVC=029,LENGTH=,BRT=YES Y02080 08070002
         SPACE 2                                                 Y02078 08080002
         IECDSECS CVT,RB,TCB,JSCB,UCB,EXPAND=YES CVT, RB, JSCB @Z40RSGD 08082037
*                                       AND TCB                @Z40RSGD 08082437
*                                       UCB DSECTS.            @Y30LSTG 08085503
WORKAREA IECSCRWA EP,F4,D1=(1,3)        SCRATCH WORK AREA        Y02080 08090002
RACDEF   EQU   SCRTHWKA                 RACDEF PARAMETER LIST  @Z40RSGD 08140037
         END                                                            09420021
