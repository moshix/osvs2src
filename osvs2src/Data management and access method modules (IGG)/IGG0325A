     TITLE 'IGG0325A - DADSM - HOUSEKEEPING && DUPLICATE NAME SEARCH'   00008021
IGG0325A CSECT                                                          00016020
*                                                                       00018002
*MODULE NAME = IGG0325A                                                 00018102
*                                                                       00018202
*DESCRIPTIVE NAME = DADSM - HOUSEKEEPING & DUPLICATE NAME SEARCH        00018302
*                                                                       00019402
*COPYRIGHT = NONE                                                       00021402
*                                                                       00021802
*CHANGE ACTIVITY = SEE BELOW                                            00022202
*                                                                       00022602
*          VS2 RELEASE 01 DELETIONS                                     00023002
*0000                                                            YM2930 00024102
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00025202
*0000000180,000220,000570,009200-009400,012800-013200,013600-    Y02080 00026302
*0000013900,016320-016400,016800,025000,032000,033600-034000,    Y02080 00027402
*0000035300,036200,040200,041880,041912,041920,049400-051200,    Y02080 00028502
*0000052030-052090,052120-052400,053800,061080,061320,064442-    Y02080 00029602
*0000064450,064463-064481,064571-064580,065000,067800,072000-    Y02080 00030702
*0000073000,073400-076720,082300,082780-083200,083300-084200,    Y02080 00031802
*0000089800-090200,090600-091600,092200-096000,099000,102000-    Y02080 00032902
*0000103400,104200,104400,107600,109810-134600                   Y02080 00034002
*0000010600-010800,049400-051200                                 Y02132 00035102
*0000003300,032600-032800,064481,064487,064553-064562,064750     Y02078 00036202
*0000000010-000050,061100,061240-061304                          Y02082 00037302
*0000                                                            Y02144 00038402
*0000                                                            Y02072 00039502
*          RELEASE 20 DELETIONS                                         00040602
*                                                                S20201 00041702
*          RELEASE 21 DELETIONS                                         00042802
*1192                                                            A37199 00043902
*1192033800,038600,039000-039100,040200,065600                   A40967 00045002
*1192006500-006600,006700-006800,007200-007300,011000-011200,    A42477 00046102
*1192033200-033400,034000,074600-074800,084200,113600            A42477 00047202
*1192                                                            M0123  00048302
*0000000080,007100,011400,016100,034300,064427-064436,064448-    A46776 00049402
*0000064451,065420-065440,065580,065660,065700-065720,072200,    A46776 00050502
*0000073000-073350,077400-077700,078200,082400-082600,082720-    A46776 00051602
*0000082760,083400,085200,085600,087000-089200,103700,104300-    A46776 00052702
*0000105700,109400-109800                                        A46776 00053802
*1192003000-005600,006100-006300,007000-007100,013600-013800,    S21016 00054902
*1192014200,016200-016400,024600,025200-031800,033800,063400-    S21016 00056002
*1192064400,064445-064454,064600-064800,082400,104850-104950     S21016 00057102
*          RELEASE 21.7 DELETIONS                                       00058202
*0000099200                                                     SA48172 00059302
*0000006900,047060,052010-052020,063200-064000,064409-064437,   SA56426 00060402
*0000064457,064472,064508-064517,064582-064589                  SA56426 00061502
*0000006160-006320,007500-007600,083400-084000,102000-103000    SA53147 00062602
*0000065760-065800                                              SA53153 00063702
*          RELEASE 22 DELETIONS                                         00064802
*                                                                       00065902
*STATUS CHANGE LEVEL 002                                                00067021
*FUNCTION  THIS MODULE LINKS TO THE RESIDENT DIRECT ACCESS            * 00077420
*   CONVERSION ROUTINE TO CONVERT THE 'TTR0' OF THE VTOC TO  ABSOLUTE * 00120020
*   ADDRESS.  IT LINKS TO THE ENQ ROUTINE TO ENQUE THE VTOC ON THIS   * 00140020
*   VOLUME.  IT INITIALIZES AND RELOCATES TO THE WORK AREA A CHANNEL  * 00160020
*   PROGRAM TO PERFORM THE FOLLOWING OPERATIONS.  READ IN THE DATA    * 00180020
*   PORTION OF THE FORMAT 4 DSCB, READ IN COUNT/KEY/DATA OF THE FIRST * 00200020
*   FORMAT 5 DSCB, AND PERFORM A DUPLICATE NAME SEARCH OF THE FORMAT 1* 00220020
*   DSCB'S IN THE VTOC.  IF A DUPLICATE NAME FORMAT 1 DSCB IS FOUND   * 00240020
*   IT READS THE DATA PORTION OF THE DUPLICATE NAME FORMAT 1 DSCB AND * 00260020
*   THE COUNT OF THE NEXT RECORD.  THIS MODULE TESTS THE FORMAT 4 DSCB* 00280020
*   TO DETERMINE IF THE DOS OR DIRF BIT IS SET.  IF SO, IT BRANCHES TO* 00330002
*   IGG0325Z, THE FIRST LOAD OF THE DOS/OS VTOC CONVERSION ROUTINE,   * 00380021
*   IN ORDER TO BUILD VALID FORMAT 5 AND FORMAT 6 DSCB'S. AFTER       * 00430021
*   REENTRY FROM THE DOS/OS VTOC CONVERSION ROUTINE, THE DUPLICATE    * 00480021
*   NAME SEARCH IS REINITIATED.                                       * 00530021
*                                                                     * 00580020
*ENTRY POINTS:                                                        * 00600020
*        IGG0325A - ENTRY IS MADE FROM IGC0003B (SPACE ALLOCATION     * 00608021
*        INITIAL LOAD) OR REENTRY FROM IGG0325T (THE LAST LOAD OF     * 00616002
*        THE VTOC CONVERSION ROUTINES) TO CONTINUE ALLOCATION OF      * 00624002
*        SPACE ON A DIRECT ACCESS VOLUME.                             * 00632002
*                                                                     * 00640020
*INPUT:                                                               * 00650021
*        REGISTER 4 HAS AN ENTRY INDICATOR: IF ZERO, IT INDICATES     * 00663021
*        REENTRY FROM THE DOS/OS VTOC CONVERSION ROUTINE MODULES.     * 00666021
*        REGISTER 7 POINTS TO THE UCB, IF ENTERED FROM IGC0003B.      * 00690021
*        REGISTER 11 WILL POINT TO THE JFCB OR PARTIAL DSCB.          * 00710021
*        REGISTER 13 WILL POINT TO ALLOCATE'S WORK AREA.              * 00740020
*                                                                     * 00900020
*OUTPUT: WHEN A NON ERROR TRANSFER IS MADE TO ANOTHER MODULE,         * 00920002
*   THE WORK AREA WILL CONTAIN THE DATA PORTION OF THE FORMAT 4       * 00940002
*   DSCB, THE KEY AND DATA OF THE FIRST FORMAT 5 DSCB, AND THE        * 00960020
*   ABSOLUTE ADDRESS OF THE FORMAT 4 AND FORMAT 5 DSCB'S.  IF A       * 00980020
*   DUPLICATE NAME FORMAT 1 DSCB WAS FOUND THE WORK AREA WILL ALSO    * 01000020
*   CONTAIN THE DATA PORTION OF THE DUPLICATE NAME FORMAT 1 DSCB AND  * 01020020
*   THE COUNT OF THE NEXT RECORD.                                     * 01040020
*   REGISTER 11 WILL POINT TO THE JFCB OR PARTIAL DSCB.               * 01140021
*   REGISTER 13 WILL POINT TO THE WORK AREA.                          * 01160020
*                                                                     * 01180020
*EXTERNAL ROUTINES:                                                   * 01200020
*        CVTPCNVT - TTR CONVERSION ROUTINE                            * 01220020
*        EXCP(0) - READ FROM OR WRITE TO DIRECT ACCESS DEVICE         * 01240020
*        WAIT(1) - WAIT ON EVENT CONTROL BLOCK                        * 01260020
*        RESERVE(56) - ENQUEUE THE VTOC                               * 01320002
*                                                                     * 01340020
*EXITS:                                                               * 01350021
*   NORMAL - BRANCH TO IGG0325B FOR NON-ISAM SPACE ALLOCATION         * 01360002
*            BRANCH TO IGG0325Z FOR DOS/OS VTOC CONVERSION            * 01370002
*            BRANCH TO IGG032I1 FOR ISAM ALLOCATION                   * 01380002
*   ERROR  - BRANCH TO IGG0325H WITH CODE IN ERROR CODE PASS REGISTER * 01390002
*                                                                     * 01400020
*   ERROR CODES THAT CAN BE ISSUED BY THIS MODULE:                    * 01420021
*                                                                     * 01440020
*   04 - DSNAME OF REQUEST ALREADY EXISTS ON THIS VOLUME - INITIAL    * 01460020
*   ALLOCATION NOT POSSIBLE UNDER THE NAME GIVEN                      * 01480020
*                                                                     * 01500020
*   0C - PERMANENT I/O ERROR                                          * 01520020
*                                                                     * 01540020
*   18 - AVERAGE RECORD LENGTH SPECIFIED IN REQUEST IS GREATER THAN   * 01560020
*   65,535 BYTES IN LENGTH                                            * 01580020
*                                                                     * 01600020
*   34 - INVALID JFCB OR PARTIAL DSCB POINTER                         * 01610021
*                                                                     * 01620021
*   40 - INVALID USER LABEL REQUEST                                   * 01630021
*                                                                     * 01650021
*   A4 - ALLOCATION TERMINATED DUE TO DOS STACKED PACK FORMAT         * 01653002
*                                                                     * 01656002
*                                                                     * 01660020
*TABLES/WORK AREAS: DADSM WORK AREA DESCRIBED BY MACRO 'IECALLWA'     * 01680002
*                                                                     * 01700020
*              ***************************************                * 01720020
*              *             DADSM TABLE             *                * 01740020
*              ***************************************                * 01760020
*                                                                     * 01780020
*              ***************************************                * 01800020
*              *        *         *                  *                * 01820020
*              *  TYPE  *  NO OF  *     USED HOLE    *                * 01840020
*              *  FLAG  * ENTRIES *      COUNTER     *                * 01860020
*              *        *         *                  *                * 01880020
*              ***************************************                * 01900020
*              *                  *                  *                * 01920020
*              *       RTA        *      RTA+1       *                * 01940020
*              *                  *                  *                * 01960020
*              ***************************************                * 01980020
*              *                  *                  *                * 02000020
*              *       RTA        *      RTA+1       *                * 02020020
*              *                  *                  *                * 02040020
*              ***************************************                * 02060020
*              *                  *                  *                * 02080020
*              *       RTA        *      RTA+1       *                * 02100020
*              *                  *                  *                * 02120020
*              ***************************************                * 02140020
*              *                  *                  *                * 02160020
*              *       RTA        *      RTA+1       *                * 02180020
*              *                  *                  *                * 02200020
*              ***************************************                * 02220020
*              *                  *                  *                * 02240020
*              *       RTA        *      RTA+1       *                * 02260020
*              *                  *                  *                * 02280020
*              ***************************************                * 02300020
*                                                                     * 02320020
*              TYPEFLG  =  02 - BPAM DIRECTORIES REQUESTED.           * 02340020
*                                                                     * 02344021
*                       =  40 - USER LABELS REQUESTED                 * 02348021
*                                                                     * 02352021
*                       =  80 - SET MUST COMPLETE IS ACTIVE           * 02356021
*                                                                     * 02360020
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.  * 02380020
*                                                                     * 02400020
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.      * 02420020
*                                                                     * 02440020
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT* 02460021
*                                                                     * 02480020
*ATTRIBUTES: REENTRANT                                                * 02500002
*                                                                     * 02600002
*OTHER MACROS USED:                                                   * 03200002
*   IECALLWA - ALLOCATE WORK AREA EXPANSION                           * 03210002
*   IECSDSL1 - BUILD DSCB'S                                           * 03220020
*   IEFJFCBN - BUILD JFCB                                             * 03240020
*   IECDSECS - EXPANDS THE CVT, RRPL, AND UCB DSECTS                  * 03260002
*                                                                     * 03300020
*STORAGE: PROGRAM CODE - LESS THAN 1024 BYTES                         * 03380002
*   WORK AREA - AS DEFINED IN THE IECALLWA MACRO                      * 03400002
*   RPS WORK AREA - AS DEFINED IN THE IECRPS MACRO                    * 03410002
*                                                                     * 03420020
*NOTE: THIS MODULE IS NEW IN RELEASE 20.1.                            * 03430021
*                                                                       03440020
*REGISTER USAGE-                                                        03460020
*                                                                       03480020
         BALR  BASEREG,0                                                03580020
         USING BEGINA,BASEREG                                           03600020
         USING ALLOCWKA,RWKAREA         WORK AREA ADDRESSABILITY Y02080 03620002
         USING JFCBKEN,RJFCBPTR                                         03640020
         USING UCB,RUCBPTRL                                             03660020
         USING CVT,RCVT                                                 03680020
*                                                                       03700020
REGZERO  EQU   0                                                        03720020
REGONE   EQU   1                                                        03740020
REGTWO   EQU   2                                                        03760020
FREEREGE EQU   2                        EVEN WORK REGISTER              03780020
REGTHREE EQU   3                                                        03800020
FREEREGO EQU   3                        ODD WORK REGISTER               03820020
REGFOUR  EQU   4                                                        03840020
REGFIVE  EQU   5                                                        03880020
REGSIX   EQU   6                                                        03920020
REGSEVEN EQU   7                                                        03940020
RUCBPTRL EQU   7                        UCB POINTER                     03960020
REGEIGHT EQU   8                        WORK REGISTER                   03980020
RERRPASS EQU   8                        ERROR PASS REGISTER             04000020
REGNINE  EQU   9                        WORK REGISTER                   04040020
REGTEN   EQU   10                       WORK REGISTER                   04060020
RJFCBPTR EQU   11                       JFCB POINTER                    04080020
BASEREG  EQU   12                       BASE REGISTER                   04100020
RWKAREA  EQU   13                       WORK AREA POINTER               04120020
RBAK     EQU   14                                                       04140020
RCVT     EQU   15                                                       04160020
REGFTEN  EQU   15                       WORK REGISTER                   04180020
*                                                                       04182021
* OTHER EQUATES                                                         04184021
*                                                                       04186021
ZERO     EQU   0                        CONSTANT OF 0            A46776 04188421
TWO      EQU   2                                                   UL17 04190020
THREE    EQU   3                        CONSTANT OF 3            A46776 04190421
K4       EQU   4                        CONSTANT OF 4            Y02080 04190502
FOUR     EQU   4                        CONSTANT OF 4            A46776 04190821
K12      EQU   12                       CONSTANT OF 12           Y02080 04191202
INVALPTR EQU   X'34'                    INVALID JFCB OR PARTIAL  A46776 04191621
*                                       DSCB POINTER             A46776 04191721
CHAINING EQU   X'40'                    CCW COMMAND CHAINING BIT Y02080 04192002
IOERR    EQU   X'0C'                    I/O ERROR RETURN CODE   SA53153 04192202
CSWAD    EQU   8                        CSW OFFSET IN IOB       SA53153 04192402
F1ID     EQU   C'1'                     F1 DSCB IDENTIFIER      SA53153 04192602
DSORGPO  EQU   X'02'                    DSORG = PO               A46776 04193021
DIRFBIT  EQU   X'04'                    VTOC INTERRUPT BIT       O19117 04195020
JFCBSUL  EQU   X'08'                    USER LABEL REQUEST       A42477 04197021
DOSBIT   EQU   X'80'                    DOS CONTAMINATION BIT   SA56426 04198021
DOSSTKPK EQU   X'10'                    DOS STACKED PACK BIT     Y02072 04198302
STACKERR EQU   X'A4'                    STACKED PACK RETURN CODE Y02072 04198602
READCMMD EQU   X'06'                    READ DATA COMMAND        Y02078 04199002
*                                                                       04200020
* * * * * * * * * * * * *                                               04220020
*                                                                       04240020
*                                                                       04260020
* * * * * * * * * * * * *                                               04280020
*                                                                       04300020
BEGINA   EQU   *                                                 O19117 04306020
         LTR   REGTEN,REGFOUR           ENTRY FOR DOS CONVERT           04506020
         BZ    MOVECHPG                 YES, GO BUILD CHAN PGM  SA56426 04706021
*                                                                       05140020
* THIS SECTION LINKS TO THE 'ADDRESS CONVERSION' ROUTINE TO GET THE     05160020
* VTOC ADDRESS.                                                         05180020
*                                                                       05200020
         L     REGZERO,UCBVTOC          PICK UP THE VTOC TTR0    Y02080 05209002
         MVC   MIELNAME(6),SRTEVOLI     SAVE VOLUME SERIAL NUMBER  AAAA 05210020
         IC    REGZERO,ZEROS            CLEAR THE LOW ORDER BYTE Y02080 05230002
         STM   REGNINE,RWKAREA,IECREGSV+K12  SAVE REGISTERS      Y02080 05240002
         LA    REGTWO,SEEK              LOAD POINTER TO 8 BYTE AREA     05260020
         LA    REGONE,DEB               LOAD POINTER TO THE DEB         05280020
         LR    REGTHREE,RWKAREA         SAVE WORK AREA POINTER          05300020
         L     RCVT,CVTPTR              LOAD COMM VECTOR TABLE BASE     05320020
         L     RCVT,CVTPCNVT            LOAD CONVERSION ROUTINE BASE    05340020
         BALR  RBAK,RCVT                GO TO CONVERSION ROUTINE        05360020
         LM    REGNINE,RWKAREA,IECREGSV+K12-FIRST(REGTHREE)      Y02080 05380002
SETSEEK  MVC   VTOCADR(5),SEEK+3      SAVE VTOC ADDRESS            OC58 05400020
*                                                                       05420020
* THIS SECTION RELOCATES THE CHANNEL PROGRAM TO THE WORKAREA.  IT ALSO  05440020
* INITIALIZES IT TO READ IN THE FORMAT 4 DSCB AND PERFORM A             05460021
* DUPLICATE NAME SEARCH                                                 05465021
*                                                                       05500020
*                                                                       05520020
MOVECHPG LM    REGZERO,REGNINE,CHANPROG  LOAD FIRST 5 CCW'S        OC58 05540020
         ALR   REGZERO,RWKAREA                                          05560020
         ALR   REGTWO,RWKAREA                                           05580020
         ALR   REGFOUR,RWKAREA                                          05600020
         ALR   REGSIX,RWKAREA                                           05620020
         ALR   REGEIGHT,RWKAREA                                         05640020
         STM   REGZERO,REGNINE,CCW1     STORE FIRST 5 CCW'S             05660020
         LM    REGZERO,REGSEVEN,CCWP6   LOAD CCW'S 6 THRU 9      O19117 05680020
         ALR   REGZERO,RWKAREA          RELOCATE                 O19117 05700020
         ALR   REGTWO,RJFCBPTR            CCW                    O19117 05720020
         ALR   REGFOUR,RWKAREA              DATA                 O19117 05740020
         ALR   REGSIX,RWKAREA                 ADDRESSES          O19117 05760020
         STM   REGZERO,REGSEVEN,CCW6    STORE CCW'S 6 THRU 9     O19117 05780020
         LM    REGFOUR,REGNINE,CCWP11   LOAD CCW'S 11 THRU 13    O19117 05800020
         ALR   REGFOUR,RWKAREA          RELOCATE                 O19117 05820020
         ALR   REGSIX,RWKAREA             CCW DATA               O19117 05840020
         ALR   REGEIGHT,RWKAREA             ADDRESSES            O19117 05860020
         STM   REGTWO,REGNINE,CCW10     STORE CCW'S 10 THRU 13   O19117 05880020
*                                                                       05920020
         LTR   REGTEN,REGTEN            Q - DOS CONVERT RE-ENTRY O19117 05930020
         BZ    EXECUTET                 IF YES, BR - SKIP ENQ    O19117 05940020
         L     RUCBPTRL,DEB+32          RELOAD UCB POINTER       O19117 05950020
*                                                                       05960020
* LINK TO ENQ ROUTINE TO ENQ THE VTOC ON THIS VOLUME.                   05980020
*                                                                       06000020
         MVC   MJELNAME(8),VTOCNAME     MOVE MAJOR QUE NAME TO WORKAREA 06020020
         MVI   ENQAREA,X'FF'            SET LAST ENTRY CODE             06040020
         SR    REGONE,REGONE            CLEAR CODE AND RETURN FIELDS    06060020
         STH   REGONE,ENQAREA+2                                         06080020
*                                                                       06100020
       RESERVE (MJELNAME,MIELNAME,E,6,SYSTEMS),MF=(E,ENQAREA),   YM3022X06116002
               UCB=DEB+32                                               06124020
*                                                                       06126002
         OI    DSMADTB2,DSMVTOCR        SET VTOC ENQ'ED SWITCH   Y02144 06128002
         L     REGONE,IECRRPRM          RECOVERY RTN LIST ADDR   Y02144 06130002
         USING RRPLIST,REGONE           PARM LIST ADDRESSABILITY Y02144 06132002
         LA    RUCBPTRL,ZERO(RUCBPTRL)  CLEAR HIGH ORDER BYTE    Y02144 06134002
         ST    RUCBPTRL,RRUCBPTR        SAVE THE UCB ADDRESS     Y02144 06136002
         DROP  REGONE                                            Y02144 06138002
*                                                                       06140020
* THIS SECTION LINKS TO IOS FOR ALL I/O OPERATIONS.                     06160020
*                                                                       06180020
EXECUTET EXCP  IOB                                                      06200020
         WAIT  1,ECB=ECB                                                06220020
         TM    ECB,X'20'               CHECK FOR PERMANENT I/O ERROR    06240020
         LA    RERRPASS,X'0C'           PREPARE FOR POSSIBLE     O19117 06260020
*                                       ERROR EXIT                      06280020
         BNO   ERREXIT                  BR IF I/O ERROR          O19117 06300020
         MVC   DADSMADR(5),DSCBF5-8     SAVE 1ST F5 ADDR         M4523  06440320
         MVC   FMTOUTAD(5),DADSMADR     SETUP 1ST F5 OUTPUT ADDR M4523  06440620
*                                                                       06443921
* IF THE DIRFBIT WAS NOT PREVIOUSLY SET, OR IF THIS MODULE WAS NOT      06444202
* NOT REENTERED FROM THE VTOC CONVERSION ROUTINES, THIS SECTION         06444502
* MODIFIES THE CHANNEL PROGRAM TO REWRITE THE FORMAT 4 DSCB WITH        06444802
* THE DIRFBIT SET.                                                      06445002
*                                                                       06445421
DIRFTEST EQU   *                                                SA56426 06445721
         TM    CCW3+K4,CHAINING         TEST IF LAST I/O WAS FOR Y02080 06446302
*                                       REWRITE OF FORMAT 4 DSCB Y02080 06447202
         BZ    DOSTEST                  BRANCH IF YES            Y02078 06448102
         MVC   CCW9+FOUR(FOUR),IOB+CSWAD  SAVE CSW COMMAND ADDR SA53153 06448202
         LTR   REGTEN,REGTEN            TEST IF RE-ENTRY        SA56426 06448421
*                                       FROM DOS CONVERT RTNS   SA56426 06448621
         BZ    DIRBYP3                  BRANCH IF YES            Y02078 06448702
         XI    DS4VTOCI,DIRFBIT         SET/RESET DIRF BIT       O19117 06449020
         LA    RERRPASS,STACKERR        SET STACKED PACK FLAG    Y02072 06449202
         TM    DS4VTOCI,DOSSTKPK        IS THIS A STACKED PACK?  Y02072 06449402
         BO    ERREXIT                  YES - ERROR              Y02072 06449602
         TM    DS4VTOCI,DIRFBIT         TEST RESULTS             O19117 06449920
         BZ    DIRBYP2                  BRANCH IF DIRF BIT      SA56426 06450821
*                                       PREVIOUSLY SET          SA56426 06451721
         MVI   CCW3,X'05'               SET WR DATA CMMD         O19117 06452620
         MVI   CCW3+4,X'00'             RESET CMMD CHAIN         O19117 06453520
         B     EXECUTET                 GO WRITE BACK F4         O19117 06454420
DIRBYP2  EQU   *                                                SA56426 06456521
         OI    ACNVSW,DIRFSET           INDICATE ENTRY TO VTOC   Y02078 06457502
*                                       CONVERT RTNS DUE TO DIRF Y02078 06460002
         B     GOCNVERT                 GO CONVERT THE VTOC      Y02078 06462502
*                                                                       06465021
* THIS SECTION TESTS IF THIS IS A DOS OR DOS-CONTAMINATED VOLUME.       06470021
* IF SO, IT BRANCHES TO THE DOS/OS VTOC CONVERSION ROUTINE.             06475002
*                                                                       06480021
DOSTEST  EQU   *                        BRANCH LABEL             Y02078 06482002
         MVI   CCW3,READCMMD            RESTORE READ DATA CMMD   Y02078 06484002
         TM    DS4VTOCI,DOSBIT          TEST IF DOS VOLUME      SA56426 06490021
         BZ    DIRBYP3                  NO, DO NOT CONVERT VTOC SA56426 06495021
GOCNVERT EQU   *                        BRANCH LABEL             Y02078 06495502
         OI    DS4VTOCI,DIRFBIT         SET DIRF BIT PRIOR TO   SA56426 06496021
*                                       GOING TO DOS CONVERT    SA56426 06497021
         OI    ACNVSW,ALLOCID           ENTRY TO VTOC CONVERT    Y02078 06498002
*                                       ROUTINES FROM ALLOCATE   Y02078 06499002
         LA    REGFOUR,ALLOC02          GO BRANCH TO IGG0325Z    Y02080 06500002
         B     XCTLHERE                 GO XCTL                 SA56426 06505021
*                                                                       06510021
* THIS SECTION DETERMINES IF A USER LABEL TRACK MUST BE ALLOCATED.      06515021
* IT ALSO DETERMINES IF A DUPLICATE NAME DSCB WAS FOUND.                06520021
*                                                                       06525021
DIRBYP3  EQU   *                                                SA56426 06530021
         LA    RERRPASS,X'40'           PREPARE FOR POSSIBLE     O19117 06540620
*                                       ERROR EXIT                      06541220
         LTR   RJFCBPTR,RJFCBPTR        TEST FOR PARTIAL DSCB    A46776 06542021
         BM    PARTIAL                  BRANCH IF YES            A46776 06544021
         BZ    NOJFCB                   ERROR IF POINTER IS ZERO A46776 06545021
         TM    JFCBLTYP,X'08'           USER LABELS REQUESTED      UL17 06546020
         BZ    CKFORDUP                 BRANCH IF NO               UL17 06548020
         TM    JFCDSORG,X'82'           IS THIS IS OR PARTITIONED  UL17 06550020
         BNZ   ERREXIT                  IF YES, BR               O19117 06552020
         TM    JFCDSORG+1,X'80'         IS THIS GRAPHICS           UL17 06554020
         BNZ   ERREXIT                  IF YES, BR               O19117 06556020
         CLC   JFCBDQTY(THREE),ZEROS    CHECK FOR DIRECTORY      A46776 06558021
         BE    SETUSER                  BRANCH IF NOT            A40967 06560021
         B     ERREXIT                  NO LABELS IF PARTITIONED A40967 06562021
NOJFCB   EQU   *                                                 A46776 06563021
         LA    RERRPASS,INVALPTR        INVALID JFCB POINTER     A46776 06564021
         B     ERREXIT                  GO XCTL                  A46776 06565021
PARTIAL  EQU   *                                                 A46776 06565221
         TM    PD1EXT1,USRLBL           USER LABELS REQUESTED    A46776 06566021
         BZ    CKFORDUP                 BRANCH IF NO               UL17 06568020
         TM    PD1DSORG,DSORGPO         TEST FOR PARTITIONED     A46776 06570021
         BO    ERREXIT                  BRANCH IF DSORG = PO     A46776 06572021
SETUSER  OI    TYPEFLG,USRLBL           SET USER LABEL INDICATOR   UL17 06574020
CKFORDUP EQU   *                                                SA53153 06580002
         L     REGTWO,CCW9+FOUR         GET CSW COMMAND ADDRESS SA53153 06590002
*                                       FOR FIRST EXCP          SA53153 06600002
         LA    REGTWO,0(REGTWO)         CLEAR HIGH BYTE         SA53153 06610002
         LA    REGTHREE,CCW9            GET CCW9 ADDRESS        SA53153 06620002
         SR    REGONE,REGONE            PREPARE TO RESTORE CCW9 SA53153 06630002
         ST    REGONE,CCW9+FOUR         TO ITS ORIGINAL STATUS  SA53153 06640002
         CLR   REGTWO,REGTHREE          WAS DSNAME FOUND        SA53153 06650002
         BE    NODSNAME                 BRANCH IF NOT FOUND     SA53153 06660002
         CLI   F5OUT,F1ID               WAS A DUPLICATE NAME    SA53153 06670002
*                                       DSCB FOUND              SA53153 06680002
         BE    SAMENAME                 BRANCH IF YES           SA53153 06690002
         LA    RERRPASS,IOERR           LOAD I/O ERROR CODE     SA53153 06700002
         B     ERREXIT                  BAD VTOC EXIT           SA53153 06710002
NODSNAME EQU   *                                                SA53153 06720002
         MVI   ASWITCH,FRSTF5           SET FIRST F5 IN CORE     Y02080 06780002
*                                       SWITCH                   O19117 06980020
         LTR   RJFCBPTR,RJFCBPTR        TEST FOR PARTIAL DSCB    A46776 07310021
         BM    CYLTRKRC                 BRANCH IF PARTIAL DSCB   A46776 07320021
         B     CHEKDSET                 GO TEST FOR ZERO QTY REQ Y02080 07340002
*                                                                       07680020
* IF DUPLICATE NAME IS FOUND A TEST IS MADE FOR AN ISAM DATA SET        07700020
*                                                                       07720020
SAMENAME EQU   *                                                 A46776 07730021
         LTR   RJFCBPTR,RJFCBPTR        TEST FOR PARTIAL DSCB    A46776 07740021
         BM    NOTISAM                  BRANCH IF PARTIAL DSCB   A46776 07770021
*                                                                       07800020
* NOT A UTILITY SPACE ALLOCATION REQUEST - TEST FOR ISAM IN THE JFCB    07820021
*                                                                       07840020
OKHERE   TM    JFCDSORG,X'80'                                           07860020
         BO    ISAMALLO                 IF ISAM, BR              O19117 07880020
*                                                                       07900020
* NOT ISAM - ERROR EXIT                                                 07920020
*                                                                       07940020
NOTISAM  LA    RERRPASS,X'04'           SET ERROR CODE 'DUPL NAME DSCB  07960020
         B     ERREXIT                                                  07980020
*                                                                       08000020
* THIS SECTION CHECKS FOR ZERO QUANTITY                                 08020020
*                                                                       08040020
CHEKDSET L     FREEREGE,JFCBPQTY       PICK UP PRIMARY QUANTITY         08060020
         SRL   FREEREGE,8              POSITION                         08080020
         SR    FREEREGO,FREEREGO                                        08100020
         CR    FREEREGE,FREEREGO       CHECK FOR ZERO QTY REQUEST       08120020
         BH    CHEKREC                  NOT ZERO QUANTITY               08140020
         TM    JFCDSORG,X'80'           DSORG=IS                  24988 08146020
         BO    ISAMALLO                 IF YES, BRANCH            24988 08152020
*                                                                       08160020
* TRANSFER CONTROL TO THE NEXT MODULE OF SPACE ALLOCATION               08180020
*                                                                       08200020
CYLTRKRC SR    RERRPASS,RERRPASS        CLEAR ERROR PASS REGISTER       08220020
         LA    REGFOUR,ALLOC01          POINT TO ID OF NEXT LOAD Y02080 08230002
         B     XCTLHERE                 GO XCTL                  S21016 08264021
ERREXIT  EQU   *                                                 S21016 08268021
         LA    REGFOUR,ALLOC03          BRANCH TO IGG0325H       Y02080 08278002
XCTLHERE EQU   *                                                 A46776 08325021
       IECRES LOAD,EXTPR=(RWKAREA),MODID=(REGFOUR),BRANCH=DIRECT Y02080 08375002
*                                                                       08440020
* THIS SECTION CHECKS FOR A RECORD LENGTH GREATER THAN 65,535 BYTES.    08460020
*                                                                       08480020
CHEKREC  TM    JFCBCTRI,X'C0'          IS THIS A CYLINDER REQUEST       08500020
         BO    ISAMTEST                 BRANCH IF YES            A46776 08520021
         TM    JFCBCTRI,X'40'          IS THIS AN AVERAGE RECORD REQ    08540020
         BZ    ISAMTEST                 BRANCH IF NO             A46776 08560021
         CLC   JFCBDRLH(1),ZEROS        IS THE RCD/LNGTH FIELD HIGH     08580020
*                                       BYTE EQUAL TO ZERO              08600020
         LA    RERRPASS,X'18'           PREPARE FOR POSSIBLE     O19117 08610020
*                                       ERROR EXIT                      08620020
         BNE   ERREXIT                  BR IF RCD TOO LONG       O19117 08630020
*                                                                       08640020
* TEST FOR ISAM ON DUPLICATE NAME DSCB NOT FOUND                        08660020
*                                                                       08680020
ISAMTEST EQU   *                                                 A46776 08700021
         TM    JFCDSORG,JFCORGIS        TEST FOR ISAM            A46776 08720021
         BZ    CYLTRKRC                 BRANCH IF NOT ISAM       A46776 08740021
*                                                                       09040020
* THIS SECTION RELOCATES THE FORMAT 1 DSCB FOR ISAM ALLOCATE.           09060002
*                                                                       09080002
ISAMALLO EQU   *                                                        09100002
         MVC   DSMADTW4,ADSABLST        SAVE DSAB LIST ADDRESS   Y02144 09120002
         OI    DSMADTB1,DSMISAM         SET ISAM ALLOCATE BIT    Y02144 09140002
*                                                                       09160002
         MVC   CCW1(96),F5OUT          RELOCATE THE DATA PORTION OF     09180020
         MVC   DSCBF1+44(96),CCW1         THE DUPLICATE NAME DSCB       09200020
         LA    REGFOUR,ISAMLOAD         SET UP FOR 1ST ISAM LOAD Y02080 09250002
         B     XCTLHERE                 GO BRANCH TO IGG032I1    Y02080 09300002
*                                                                       09720020
***   CHANNEL PROGRAMS FOR SEEK VTOC AND SEARCH FOR SAME NAME   ***     09740020
*                                                                       09760020
CCWP1    CCW   X'31',SEEK+3-FIRST,X'40',5  SEARCH EQUAL ID FOR VTOCOC58 09780020
CCWP2    CCW   X'08',CCW1-FIRST,0,0          TIC BACK TO SEARCH         09800020
CCWP3    CCW   X'06',DS4IDFMT-FIRST,X'40',96 READ DATA FOR VTOC DSCB    09820020
CCWP4    CCW   X'9E',DSCBF5-8-FIRST,X'40',148  READ COUNT//KEY/DATA F5. 09840020
CCWP5    CCW   X'F1',DS4HPCHR-FIRST,X'40',5  TEST FOR LAST F1 DSCB      09860020
CCWP6    CCW   X'08',CCW10-FIRST,0,0         TIC TO SEARCH NAME EQUAL   09880020
CCWP7    CCW   X'A9',0,X'60',44         SKE ON DATA SET NAME     Y02080 09900002
CCWP8    CCW   X'06',F5OUT-FIRST,X'30',96  READ DATA (SKIP BIT) SA48172 09920021
*                                       OF LAST FORMAT 1 TO END SA48172 09930021
*                                       THE CHANNEL PROGRAM     SA48172 09932021
CCWP9    CCW   X'08',CCW12-FIRST,0,0         TIC TO READ DATA DSCB F1   09940020
*CCWP10        (WILL BE DUPLICATED FROM CCWP7)                          09960020
CCWP11   CCW   X'08',CCW5-FIRST,0,0          TIC BACK TO SEARCH LAST F1 09980020
CCWP12   CCW   X'06',F5OUT-FIRST,X'40',96  READ DATA ON DUP NAME DSCB   10000020
CCWP13   CCW   X'12',COUNT-FIRST,X'20',5     READ COUNT OF NEXT DSCB F1 10020020
CHANPROG EQU   CCWP1                                                    10040020
ZEROS    EQU   CCWP11+FOUR              FOUR BYTES OF ZEROS      A46776 10050021
*                                                                       10060020
* * * * * * * * * * * * *                                               10080020
*                                                                       10100020
***   CONSTANTS                                                         10120020
*                                                                       10140020
* * * * * * * * * * * * *                                               10160020
*                                                                       10180020
VTOCNAME DC    CL8'SYSVTOC'             MAJOR QUEUE NAME                10360020
*                                                                       10400020
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         10420002
*                                                                       10430021
XCTLTABL XCTLTABL ID=(ALLOC01,5B,ALLOC02,5Z,ALLOC03,5H,          Y02080X10440002
               ISAMLOAD,I1),SVC=032,LENGTH=,BRT=YES              Y02080 10490002
         EJECT                                                   Y02080 10540002
*                                                                       10620020
* * * * * * * * * * * * *                                               10640020
*                                                                       10660020
*                                                                       10680020
* * * * * * * * * * * * *                                               10700020
*                                                                       10720020
JFCBKEN  DSECT                                                          10740020
         IEFJFCBN                                                       10780020
         EJECT                                                   Y02080 10790002
*                                                                       10800020
* * * * * * * * * * * * *                                               10820020
*                                                                       10840020
***   DSECT FOR THE PARTIAL DSCB PASSED TO ALLOCATE BY IEHMOVE   A46776 10850021
*                                                                       10860020
* * * * * * * * * * * * *                                               10880020
*                                                                       10900020
         ORG   INFMJFCB                                                 10920020
PD1DSNAM DS    CL44                DATA SET NAME                        10922021
PD1FMTID DS    CL1                 FORMAT IDENTIFIER                    10924021
PD1DSSN  DS    CL6                 DATA SET SERIAL NUMBER               10926021
PD1VOLSQ DS    XL2                 VOLUME SEQUENCE NUMBER               10928021
PD1CREDT DS    XL3                 CREATION DATE                        10930021
PD1EXPDT DS    XL3                 EXPIRATION DATE                      10932021
PD1NOEPV DS    XL1                 NUMBER OF EXTENTS ON VOLUME          10934021
PD1NOBDB DS    XL1                 NUMBER OF BYTES USED IN LAST         10936021
*                                     DIRECTORY BLOCK                   10938021
         DS    XL1                 RESERVED                             10940021
PD1SYSCD DS    CL13                SYSTEM CODE                          10942021
         DS    XL7                 RESERVED                             10944021
PD1DSORG DS    XL2                 DATA SET ORGANIZATION                10946021
PD1RECFM DS    XL1                 RECORD FORMAT                        10948021
PD1OPTCD DS    XL1                 OPTION CODE                          10950021
PD1BLKL  DS    XL2                 BLOCK LENGTH                         10952021
PD1LRECL DS    XL2                 RECORD LENGTH                        10954021
PD1KEYL  DS    XL1                 KEY LENGTH                           10956021
PD1RKP   DS    XL2                 RELATIVE KEY POSITION                10958021
PD1DSIND DS    XL1                 DATA SET INDICATORS                  10960021
PD1SCALO DS    XL4                 SECONDARY ALLOCATION                 10962021
PD1LSTAR DS    XL3                 LAST USED TRACK AND BLOCK ON TRACK   10964021
PD1TRBAL DS    XL2                 BYTES REMAINING ON LAST TRACK USED   10966021
         DS    XL2                 RESERVED                             10968021
PD1EXT1  DS    XL1                 EXTENT TYPE INDICATOR                10970021
         DS    XL2                 UNUSED                               10972021
PDPRIQTY DS    F                   PRIMARY SPACE REQUEST IN TRACKS      10974021
PDDIRQTY DS    F                   NUMBER OF DIRECTORY BLOCKS           10976021
         SPACE 2                                                 Y02080 11120002
         IECDSECS CVT,RRPL,UCB,EXPAND=YES                        Y02144 11130002
DSCBWKAR IECALLWA EP,F4,ADT=YES         ALLOCATE WORK AREA       Y02144 11140002
ENQAREA  EQU   ADSCBF4                  ENQUEUE PARAMETER LIST   Y02080 13060002
MJELNAME EQU   ADSCBF4+16               MAJOR ELEMENT NAME       Y02080 13080002
         END                                                            53460020
