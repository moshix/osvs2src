 TITLE 'IGG0325D - DADSM - CYLINDER, TRACK, RECORD ALLOCATION'   Y02080 00020002
IGG0325D CSECT                                                          00021021
*                                                                       00021402
*MODULE NAME = IGG0325D                                                 00021802
*                                                                       00021902
*DESCRIPTIVE NAME = DADSM - CYLINDER, TRACK, RECORD ALLOCATION          00023902
*                                                                       00025902
*COPYRIGHT = NONE                                                       00027902
*                                                                       00029002
*CHANGE ACTIVITY = SEE BELOW                                            00031002
*                                                                       00031402
*          RELEASE 17 DELETIONS                                         00031702
*1462000400,001800,027600,045400-050400,060200,072400,072420-      UL17 00032802
*    072520,078000,079400,084200,086000.                           UL17 00033902
*          RELEASE 18 DELETIONS                                         00035002
*          RELEASE 19 DELETIONS                                         00036002
*          RELEASE 20 DELETIONS                                         00038002
*2410                                                            A34038 00040002
*          RELEASE 21 DELETIONS                                         00042002
*1192001600-001800,002400-002600,003800,005400,007300,017200,    A42477 00044002
*1192019000-019200,019600-019800,025200-025600,029800-030000,    A42477 00046002
*1192031200-031400,042200-042400,072320-072340,074400,083200-    A42477 00048002
*1192083400,084200,086000,089600,107400                          A42477 00050002
*0000000200,000220,000600-001700,004200,007800,028000-028200,    A46776 00052002
*0000039400,039800,040200,050600,051000,072400,077860,084200-    A46776 00054002
*0000086000,107200                                               A46776 00056002
*          RELEASE 22 DELETIONS                                         00058002
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00060002
*0000000030-000200,000220,000400-000440,001600-001700,002400-    Y02080 00062002
*0000002600,004800,006800,007200-007400,009400,017600,019400-    Y02080 00064002
*0000019700,027200,028400-029400,033600,036400,038000,038400,    Y02080 00066002
*0000039000,041800-042300,052400-052800,061400,065400,072000,    Y02080 00068002
*0000072400-073600,074000,074400,083800,084500-091400,091800-    Y02080 00070002
*0000094600,094800-105600                                        Y02080 00072002
*                                                                       00074002
* STATUS CHANGE LEVEL 004                                               00076002
*FUNCTION/OPERATION:  THIS MODULE PROCESSES CYLINDER, TRACK, AND      * 00078002
*   AVERAGE/RECORD SPACE REQUESTS WITH ANY OF THESE OPTIONS: MXIG,    * 00080021
*   ALX, CONTIG, BLANK.  IT ALSO PROCESSES IEHMOVE'S SPACE REQUESTS.  * 00100021
*   IT DETERMINES IF THE REQUESTED SPACE IS AVAILABLE ON THIS VOLUME  * 00120021
*   AND IF YES, ALLOCATES IT.  IT INSURES THAT CYLINDER REQUESTS ARE  * 00140021
*   ON CYLINDER BOUNDARIES.  IT CREATES THE DADSM TABLE ENTRIES TO    * 00150021
*   BE USED BY THE 'F1 AND F3 BUILD' AND 'DADSM UPDATE' ROUTINES.     * 00160002
*                                                                     * 00200000
*ENTRY POINTS:                                                        * 00220000
*   IGG0325D - ENTRY IS MADE FROM IGG0325B OR FROM IGG0325K.          * 00240002
*                                                                     * 00280000
*INPUT: AT ENTRY TO THIS MODULE THE WORK AREA CONTAINS THE DATA       * 00300000
*   PORTION OF THE FORMAT 4 DSCB AND ITS ADDRESS, THE FIRST DADSM     * 00320000
*   RECORD (F5) AND ITS ADDRESS, A DEB, AN IOB, AN ECB, AND A CHANNEL * 00340000
*   PROGRAM TO READ DADSM RECORDS.                                    * 00360000
*   THE FIRST FORMAT 5 DSCB IN CORE SWITCH WILL BE ON.                * 00380021
*   REGISTER 10 WILL CONTAIN THE SPACE REQUEST IN TRACKS.             * 00400000
*   REGISTER 11 WILL POINT TO A JFCB OR PARTIAL DSCB.                 * 00420021
*   REGISTER 13 WILL POINT TO THE WORK AREA.                          * 00440000
*                                                                     * 00460000
*OUTPUT: UPON TRANSFER OF CONTROL, THE WORK AREA AND REGISTERS WILL   * 00480002
*   BE AS AT INPUT WITH THE FOLLOWING ADDITIONS.                      * 00500000
*   REGISTER 10 WILL NO LONGER CONTAIN THE SPACE REQUEST.             * 00520000
*   THE FIRST FORMAT 5 DSCB IN CORE SWITCH WILL BE OFF IF ALLOCATION  * 00540021
*   WAS NOT FROM THE FIRST DADSM RECORD.                              * 00560000
*   THE DADSM TABLE WILL CONTAIN THE EXTENTS ALLOCATED.               * 00580000
*                                                                     * 00600000
*EXTERNAL ROUTINES:                                                   * 00620000
*        EXCP(0) - READ FROM OR WRITE TO DIRECT ACCESS DEVICE         * 00640000
*        WAIT(1) - WAIT ON EVENT CONTROL BLOCK                        * 00660000
*        IECRES  - BRANCH TO OTHER MODULES                            * 00680002
*                                                                     * 00700000
*EXITS-NORMAL: BRANCH TO IGG0325E TO BUILD AND WRITE OUT F1'S AND F3'S* 00720002
*   -ERROR: BRANCH TO IGG0325H WITH CODE IN ERROR CODE PASS REGISTER  * 00740002
*                                                                     * 00760000
*   ERROR CODES THAT CAN BE ISSUED BY THIS MODULE:                    * 00780021
*                                                                     * 00800000
*   08 - NO ROOM AVAILABLE IN THE VTOC                                * 00820000
*                                                                     * 00840000
*   0C - PERMANENT I/O ERROR                                          * 00860000
*                                                                     * 00880000
*   14 - REQUESTED QUANTITY NOT AVAILABLE                             * 00900000
*                                                                     * 00920000
*TABLES/WORK AREAS: DADSM WORK AREA DESCRIBED BY MACRO 'IECALLWA'     * 00940002
*                                                                     * 00960000
*              ***************************************                * 00980000
*              *             DADSM TABLE             *                * 01000000
*              ***************************************                * 01020000
*                                                                     * 01040000
*              ***************************************                * 01060000
*              *        *         *                  *                * 01080000
*              *  TYPE  *  NO OF  *     USED HOLE    *                * 01100000
*              *  FLAG  * ENTRIES *      COUNTER     *                * 01120000
*              *        *         *                  *                * 01140000
*              ***************************************                * 01160000
*              *                  *                  *                * 01180000
*              *       RTA        *      RTA+1       *                * 01200000
*              *                  *                  *                * 01220000
*              ***************************************                * 01240000
*              *                  *                  *                * 01260000
*              *       RTA        *      RTA+1       *                * 01280000
*              *                  *                  *                * 01300000
*              ***************************************                * 01320000
*              *                  *                  *                * 01340000
*              *       RTA        *      RTA+1       *                * 01360000
*              *                  *                  *                * 01380000
*              ***************************************                * 01400000
*              *                  *                  *                * 01420000
*              *       RTA        *      RTA+1       *                * 01440000
*              *                  *                  *                * 01460000
*              ***************************************                * 01480000
*              *                  *                  *                * 01500000
*              *       RTA        *      RTA+1       *                * 01520000
*              *                  *                  *                * 01540000
*              ***************************************                * 01560000
*                                                                     * 01580000
*              TYPEFLG  =  02 - BPAM DIRECTORIES REQUESTED.           * 01600000
*                                                                     * 01604021
*                       =  40 - USER LABELS REQUESTED                 * 01608021
*                                                                     * 01612021
*                       =  80 - SET MUST COMPLETE IS ACTIVE           * 01616021
*                                                                     * 01620000
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.  * 01640000
*                                                                     * 01660000
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.      * 01680000
*                                                                     * 01700000
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT* 01720021
*                                                                     * 01740000
*ATTRIBUTES: REENTRANT                                                * 01760002
*                                                                     * 01780000
*NOTES:                                                               * 01800000
*   OTHER MACROS USED                                                 * 01820000
*   IECALLWA - ALLOCATE WORK AREA EXPANSION                           * 01830002
*   IECSDSL1 - BUILD DSCB'S                                           * 01840000
*   IEFJFCBN - BUILD JFCB                                             * 01860000
*   CVT - BUILD CVT                                                   * 01870002
*                                                                     * 01880000
*STORAGE: PROGRAM CODE CSECT - LESS THAN 1024 BYTES                   * 01960002
*   WORK AREA - AS DEFINED IN THE IECALLWA MACRO                      * 01970002
*   RPS WORK AREA - AS DEFINED IN THE IECRPS MACRO                    * 01980002
*                                                                     * 02000000
*                                                                       02020000
*REGISTER USAGE:                                                        02040000
*                                                                       02046021
R1       EQU   1                                                 A42477 02052021
RCNT     EQU   1                        LOOP COUNTER                    02060000
ROUT     EQU   2                        OUTPUT POINTER                  02080000
RIN      EQU   3                        DADSM POINTER                   02100000
RTA1     EQU   4                        CONVERSION ROUTINE RTA+1 REG    02120000
R4       EQU   4                                                 A42477 02130021
R5       EQU   5                                                        02140000
RTA      EQU   5                       CONVERSION ROUTINE RTA REG       02160000
R6       EQU   6                                                        02180000
RHH      EQU   6                        CONVERSION ROUTINE TRK REG      02200000
R7       EQU   7                                                        02220000
RCC      EQU   7                        CONVERSION ROUTINE CYL REG      02240000
RTTRPTR  EQU   7                        PTR TO XCTL BY TTR TABLE ENTRY  02260000
R8       EQU   8                                                        02280000
RTRK     EQU   8                        CONTAINS NBR OF TRKS/CYL        02300000
RERRPASS EQU   8                        ERROR PASS REGISTER             02320000
R9       EQU   9                                                        02340000
RA       EQU   10                                                       02360000
REQ      EQU   10                 PRIMARY QUANTITY PASSED FROM CTR      02380000
RJFCB    EQU   11                       JFCB POINTER                    02400000
RBASE    EQU   12                       BASE REGISTER                   02420000
RWKA     EQU   13                       WORK AREA POINTER               02440000
RBAK     EQU   14                 RETURN REGISTER                       02460000
RF       EQU   15                                                       02480000
*                                                                       02481021
* OTHER EQUATES                                                         02482021
*                                                                       02483021
TWO      EQU   2                        CONSTANT OF TWO          Y02080 02485002
FOUR     EQU   4                                                   UL17 02486000
EIGHT    EQU   8                                                   UL17 02492000
*                                                                       02500000
*                                                                       02580000
*        THIS SECT INITIALIZES REGISTERS AND WORK AREAS,CHECKS          02600000
*        DADSM HOLES, CONVERTS THE FIRST DADSM RECORD THAT IS           02620000
*        ALREADY IN CORE, AND CALLS SUBROUTINES TO FILL THE REQUEST.    02640000
*                                                                       02660000
         BALR  RBASE,0                                                  02680000
         USING START,RBASE                                              02700000
         USING ALLOCWKA,RWKA            WORK AREA ADDRESSABILITY Y02080 02720002
         USING JFCBFLD,RJFCB                                            02740000
*                                                                       02742002
START    TM    TYPEFLG,X'40'            TEST FOR USER LABEL        UL17 02750000
         BO    CONTINUE                 BRANCH IF YES              UL17 02760000
         BAL   RBAK,NOTIOERR            CONVERT FIRST FORMAT 5     UL17 02770000
CONTINUE LA    RF,2                     INITIALIZE FOR HOLE CHECK       02780000
         LTR   RJFCB,RJFCB              TEST FOR PARTIAL DSCB    A46776 02800021
         BM    PARTIAL                  BRANCH IF YES            A46776 02820021
TSTCONT  CH    RF,DS4DSREC              CONTIG/MXIG - ARE 2 HOLES AVAIL 02960000
         BH    SETERR                   BRANCH IF NOT            A42477 02990021
TSTCONTA TM    JFCBCTRI,X'08'           IS THIS A CONTIG REQUEST        03020000
         BO    CONTIG                   BRANCH IF YES                   03040000
         TM    JFCBCTRI,X'04'           IS THIS A MXIG REQUEST          03060000
         BO    MXIG                     BRANCH IF YES                   03080000
         CH    RF,DS4DSREC              BLANK/ALX - ARE 3 HOLES AVAIL   03100000
         BNL   SETERR                   BRANCH IF NOT            A42477 03130021
TSTCONTB TM    JFCBCTRI,X'02'           IS THIS AN ALX REQUEST          03160000
         BO    ALX                      BRANCH IF YES                   03180000
         B     BLANK                    NO-GO TO BLANK OPTION           03200000
SETERR   LA    RERRPASS,X'08'           SET ERROR CODE 'INSUFFICIENT    03220000
*                                       HOLES IN THE VTOC               03240000
         B     ERROR                    GO FREE WORK AREA               03260000
*                                                                       03280000
* EXECUTE CHANNEL PROGRAM TO READ DADSM-CHECK FOR PERM I/O ERROR        03300000
*                                                                       03320000
READF5   MVC   IDAREA(5),DS5PTRDS                                       03340000
         NI    ASWITCH,X'FF'-FRSTF5     CLEAR 1ST F5 IN CORE SW  Y02080 03360002
READF5A  MVC   SEEK+3(4),IDAREA                                         03380000
         LA    RF,CCW9                                                  03400000
         ST    RF,IOB+16                                                03420000
         MVI   ECB,X'00'                                                03440000
         EXCP  IOB                                                      03460000
         WAIT  ECB=ECB                                                  03480000
         TM    ECB,X'20'          TEST FOR PERM I/O ERROR               03500000
         BC    1,NOTIOERR                                               03520000
         LA    RERRPASS,X'0C'           SET ERROR CODE 'PERM I/O ERROR  03540000
         B     ERROR                                                    03560000
NOTIOERR MVC   DS5FMTID(90),DS5MAVET    REMOVE ID FROM DADSM RECORD     03580000
*                                                                       03600000
*THIS SECTION CONVERTS DADSM FROM XXYYZ TO RTA - NO OF TRACKS. ASSURES  03620000
*THAT CYLINDER REQUESTS AND AVERAGE RECORD LENGTH REQUESTS WITH ROUND   03640002
*OPTION ARE ALIGNED ON CYLINDER BOUNDARIES                              03660000
*                                                                       03680000
CONVF5   LA    RCNT,26                 SET TO MAX NBR OF EXTENTS        03700000
         LH    RTRK,DS4DEVSZ+2         LOAD NBR OF TRKS/CYL             03720000
         LA    RIN,DS5AVEXT        SET INPUT PTR TO 1ST EXTENT          03740000
         LA    ROUT,DS1DSNAM       SET UP OUTPUT PTR FOR CONVERTED EXTS 03760000
       XC      DS1DSNAM(140),DS1DSNAM  CLEAR OUTPUT AREA                03780000
TESTO    EQU   *                       BRANCH LABEL              Y02080 03790002
         MVC   FULLWORD(FOUR),0(RIN)   ALIGN RTA AND NBR CYLS    Y02080 03800002
         SR    RTA1,RTA1               CLEAR HIGH DIVIDEND REGISTER     03820000
         LH    RTA,FULLWORD            GET RTA                   Y02080 03840002
         LTR   RTA,RTA                 IS THIS EXTENT ZERO              03860000
         BZ    INCRIN                  BRANCH IF YES                    03880000
         LH    RCC,FULLWORD+TWO        GET NUMBER OF FULL CYLS   Y02080 03900002
         MR    RHH,RTRK                CONVERT CYLS TO TRKS             03920000
         LTR   RJFCB,RJFCB             TEST FOR PARTIAL DSCB     A46776 03940021
         BP    TESTYPE                 BRANCH IF NO                     03960000
         TM    PD1SCALO,JFCBCYL        TEST FOR CYLINDER REQUEST A46776 03980021
         BC    1,CYLREQ                BRANCH IF YES                    04000000
         TM    PD1SCALO,JFCBAVR+JFCROUND  TEST IF A RECORD       A46776 04020021
*                                      ROUNDED REQUEST           A46776 04030021
         BC    1,CYLREQ                BRANCH IF YES                    04040000
ADD      IC    RHH,4(RIN)              GET EXCESS TRKS                  04060000
         AR    RCC,RHH                 CALCULATE TOTAL TRKS THIS EXT    04080000
         B     ADDA                    GO STORE RTA AND NBR TRKS        04100000
TESTYPE  TM    JFCBCTRI,X'C0'          IS THIS A CYL REQUEST            04120000
         BO    CYLREQ                  BRANCH IF YES                    04140000
         TM    JFCBCTRI,X'41'          IS THIS A RCD ROUNDED REQ        04160000
         BNO   ADD                     BRANCH IF NO              Y02080 04180002
CYLREQ   DR    RTA1,RTRK               CONVERT RTA TO CYLS AND TRKS     04260000
         LR    RHH,RTA1                SAVE TRK REMAINDER               04280000
         MR    RTA1,RTRK               RECONVERT CYLS TO TRKS           04300000
         LTR   RHH,RHH                 WAS THERE A TRK REMAINDER        04320000
         BZ    ADDA                    BRANCH IF NO                     04340000
         AR    RTA,RTRK                YES-STEP RTA UP TO NEXT CYL      04360000
ADDA     STH   RTA,0(ROUT)             STORE RTA IN OUTPUT              04380000
         STH   RCC,2(ROUT)             STORE NBR OF TRKS AVAIL          04400000
CONT     LA    ROUT,4(ROUT)            STEP OUTPUT POINTER              04420000
INCRIN   LA    RIN,5(RIN)              STEP INPUT POINTER               04440000
         BCT   RCNT,TESTO              BRANCH IF MORE EXTENTS           04460000
         LA    ROUT,DS1DSNAM           RESET OUTPUT POINTER             04480000
         BR    RBAK                                                     04500000
*                                                                       04520000
* THIS SECTION TESTS THAT THERE ARE SUFFICIENT UNUSED DSCB'S            04570021
* TO SATISFY A SPACE REQUEST FROM IEHMOVE.                              04620021
*                                                                       04670021
PARTIAL  EQU   *                                                 A46776 04720021
         CH    RF,DS4DSREC             ASSUME CONTIG - TEST FOR  A46776 05060021
*                                      TWO AVAILABLE DSCB'S      A46776 05070021
         BH    SETERR                  BRANCH IF NO                     05080000
         TM    PD1SCALO,JFCONTIG+JFCMIXG  TEST IF CONTIG OR MXIG A46776 05100021
         BNE   CONTIG                  BRANCH IF YES                    05120000
         CH    RF,DS4DSREC             PROCESS AS BLANK - ARE 3         05140000
*                                      HOLES AVAILABLE                  05160000
         BL    BLANK                   BRANCH IF YES                    05180000
         B     SETERR                  NO-GO SET ERROR CODE             05200000
*                                                                       05220000
* THIS SECTION FINDS THE EXTENT IF CONTIG WAS SPECIFIED.  IT IS         05240002
* ALSO USED FOR THE BLANK OPTION, TO FIND THE AVAILABLE EXTENT          05260002
* WHICH IS LARGER BUT CLOSEST IN SIZE TO THE REQUESTED QUANTITY.        05280002
*                                                                       05300000
CONTIG   MVI   DADSMTBL+6,X'FF'                                         05320000
COMPARE  CH    REQ,2(ROUT)        COMPARE REQUEST TO EXTENT             05340000
         BH    UPREGS             REQUEST TO HIGH GO UPDATE POINTER     05360000
TESTEQ   BE    FILLREQ                                                  05380000
         CLC   2(2,ROUT),DADSMTBL+6    LOW-COMPARE TO DADSM VALUE       05400000
         BNL   UPREGS                  TO HIGH UPDATE POINTER           05420000
BLKENTRY MVC   DADSMTBL+4(4),0(ROUT)   MOVE EXTENT TO DADSMTAB          05440000
UPREGS   LA    ROUT,4(ROUT)                                             05460000
         CLC   0(2,ROUT),ZEROS          IS THIS THE END OF EXTENTS      05480000
         BH    COMPARE            NO- GET NEXT                          05500000
         TM    DS5PTRDS+4,X'FF'   IS A CHAIN ADDRESS AVAILABLE          05520000
         BZ    FILLCONT           FILL REQUEST                          05540000
         BAL   RBAK,READF5        READ NEXT DADSM RECORD                05560000
         B     COMPARE            RETURN FOR MORE                       05580000
BLANK    CH    REQ,2(ROUT)        COMPARE REQUEST TO EXTENT             05600000
         BE    FILLREQ            GO FILL REQUEST                       05620000
         BL    BLKENTRY           REQUEST CAN BE FILLED AS CONTIGUOUS   05640000
         BAL   14,PSHDOWN         GO TO PUSHDOWN LIST                   05660000
         LA    ROUT,4(ROUT)       INCREMENT EXTENT POINTER              05680000
         CLC   0(2,ROUT),ZEROS          IS THIS THE END OF EXTENTS      05700000
         BH    BLANK              NO- GET NEXT                          05720000
         TM    DS5PTRDS+4,X'FF'   IS A CHAIN AVAILABLE                  05740000
         BZ    FINDEXT            NO-PROCESS PUSHDOWN LIST              05760000
         BAL   14,READF5          YES-READ NEW DADSM DSCB               05780000
         B     BLANK              RETURN FOR MORE                       05800000
*                                                                       05820000
* ALX OPTION SPECIFIED                                                  05840000
*                                                                       05860000
MXIG     EQU   *                                                   UL17 05870000
ALX      CH    REQ,2(ROUT)        COMPARE REQUEST TO EXTENT             05880000
         BH    HIREQ              HIGH REQUEST                          05900000
         BAL   14,PSHDOWN         GO TO PUSHDOWN LIST                   05920000
HIREQ    LA    ROUT,4(ROUT)       INCREMENT POINTER                     05940000
         CLC   0(2,ROUT),ZEROS          IS THIS THE END OF EXTENTS      05960000
         BH    ALX                NO- GET NEXT                          05980000
         TM    DS5PTRDS+4,X'FF'   IS A CHAIN AVAILABLE                  06000000
         BZ    CKETYPE                  BRANCH IF NO               UL17 06020000
         BAL   14,READF5          READ NEXT DADSM DSCB                  06040000
         B     ALX                RETURN FOR MORE                       06060000
CKETYPE  TM    JFCBCTRI,X'04'           IS THIS MXIG REQUEST       UL17 06066000
         BO    FINDEXT                  BRANCH IF YES              UL17 06072000
         TM    TYPEFLG,X'40'            TEST FOR USER LABEL      A34038 06073020
         BNO   MOVELIST                 BRANCH IF NOT            A34038 06074020
         LA    RF,4                     INITIALIZE FOR 4 ENTRIES A34038 06075020
         B     TABLEPTR                 GO POINT TO DADSM TABLE  A34038 06076020
MOVELIST LA    RF,5                                                     06080000
TABLEPTR EQU   *                                                 A34038 06090020
         LA    R8,DADSMTBL+4      START OF DADSM TABLE POINTER          06100000
         SR    R9,R9                                                    06120000
         LA    R6,PDLIST1               POINT TO PUSHDOWN LIST   Y02080 06140002
         CLC   0(4,R6),ZEROS            IS LIST BLANK                   06160000
         BE    QTYNOTAV           REQUEST CAN NOT BE FILLED             06180000
ALXMOVE  LH    R5,0(R6)           MOVE EXTENTS TO DADSM TABLE           06200000
         STH   R5,0(R8)                                                 06220000
         AH    R5,2(R6)                                                 06240000
         STH   R5,2(R8)                                                 06260000
         LA    R9,1(R9)           ADD ONE TO NUMBER OF EXTENTS          06280000
         LA    R8,4(R8)           UPDATE POINTER                        06300000
         LA    R6,4(R6)           UPDATE LIST POINTER                   06320000
         CLC   0(4,R6),ZEROS            ARE THERE MORE EXTENTS          06340000
         BE    EXTNO              GO TO ENTER NUMBER OF EXTENTS         06360000
         BCT   RF,ALXMOVE                                               06380000
         ST    RF,PDLIST5               CLEAR LAST SLOT IN PDLIST       06400000
         B     EXTNO              END OF TABLE                          06420000
*                                                                       06440000
* THIS ROUTINE BUILDS A PUSHDOWN LIST WHEN MORE THAN ONE EXTENT IS      06460000
* NEEDED TO FILL QTY REQUESTED (BLANK OR ALX OPTION)                    06480000
*                                                                       06500000
PSHDOWN  LA    R5,4                                                     06520000
         LA    R6,PDLIST1               ADDRESS OF PUSHDOWN LIST Y02080 06540002
         LA    R7,4(R6)      POINT  TO SECOND EXTENT IN LIST            06560000
FINDLOW  CLC   2(2,R6),2(R7)                                            06580000
         BNH   UPREG                                                    06600000
         LR    R6,R7                                                    06620000
UPREG    LA    R7,4(R7)                                                 06640000
         BCT   R5,FINDLOW                                               06660000
         CLC   2(2,ROUT),2(R6)    EXTENT IN LIST LOWER THAN NEW         06680000
         BNH   PSHRTRN                                                  06700000
         MVC   0(4,R6),0(ROUT)    REPLACE LOW EXTENT IN LIST            06720000
PSHRTRN  BR    RBAK               RETURN                                06740000
*                                                                       06760000
*   EXIT ROUTINES                                                       06780000
*                                                                       06800000
QTYNOTAV LA    RERRPASS,X'14'           SET ERROR CODE 'QTY NOT AVAIL   06820000
*                                                                       06840000
* TRANSFER CONTROL TO THE LAST MODULE OF SPACE ALLOCATION TO RELEASE    06860000
* THE WORK AREA,DEQ THE VTOC,PASS THE ERROR CODE,AND EXIT TO CALLER.    06880000
*                                                                       06900000
ERROR    LA    RTTRPTR,ALLOCD2          LOAD PTR TO LAST ALLOC LOAD     06920000
         B     XCTLHERE                                                 06940000
*                                                                       06960000
FILLCONT TM    DADSMTBL+6,X'FF'     IS DADSM TABLE EMPTY.               06980000
         BO    QTYNOTAV           YES QUANTITY NOT AVAILABLE            07000000
         STH   REQ,DADSMTBL+6          ENTER REQUEST                    07020000
         B     RTARTA1                 GO CHANGE FORMAT                 07040000
FILLREQ  STH   REQ,DADSMTBL+6          FILL REQUEST FROM POINTER        07060000
         MVC   DADSMTBL+4(2),0(ROUT)                                    07080000
RTARTA1  LH    R5,DADSMTBL+4      ENTER EXTENTS IN DADSMTBL FORMAT      07100000
         AH    R5,DADSMTBL+6                                            07120000
         STH   R5,DADSMTBL+6                                            07140000
         MVI   DADSMTBL+1,X'01'   ENTER ONE EXTENT                      07160000
*                                                                       07180000
* SET UP WTG TABLE TO BRANCH TO THE F1/F3 SPACE ALLOCATION MODULE.      07200002
*                                                                       07220000
EXRQFILL TM    TYPEFLG,X'40'            TEST FOR USER LABEL        UL17 07222000
         BZ    LOADPTR                  BRANCH IF NOT              UL17 07224000
         IC    R9,DADSMTBL+1            NUMBER OF ENTRIES IN TABLE UL17 07226000
         LA    R9,1(R9)                 INCREMENT FOR USER LABEL   UL17 07228000
         STC   R9,DADSMTBL+1            PLACE IN TABLE             UL17 07230000
         LM    R1,R4,DADSMTBL+4         MOVE ENTRIES             A42477 07232021
         STM   R1,R4,DADSMTBL+EIGHT       FOR USER LABEL         A42477 07234021
         MVC   DADSMTBL+4(FOUR),USERLBL                            UL17 07236000
LOADPTR  LA    RTTRPTR,ALLOCA3                                     UL17 07238000
*                                                                       07380000
* BRANCH TO A SUBSEQUENT DADSM ALLOCATE MODULE.                         07400002
*                                                                       07420000
XCTLHERE EQU   *                        BRANCH LABEL             Y02080 07430002
         IECRES LOAD,EXTPR=(RWKA),MODID=(RTTRPTR),BRANCH=DIRECT  Y02080 07440002
*                                                                       07460000
FINDEXT  LA    R8,DADSMTBL+4      DADSMTBL POINTER                      07480000
         TM    TYPEFLG,X'40'            TEST FOR USER LABEL      A34038 07483020
         BNO   INIT5ENT                 BRANCH IF NOT            A34038 07486020
         LA    RF,4                     INITIALIZE FOR 4 ENTRIES A34038 07489020
         B     ZEROREG9                 GO ZERO REGISTER 9       A34038 07492020
INIT5ENT EQU   *                                                 A34038 07495020
         LA    RF,5                                                     07500000
ZEROREG9 EQU   *                                                 A34038 07510020
         SR    R9,R9                                                    07520000
FINDMLTI LR    R5,RF                    LOAD INNER LOOP COUNTER         07540000
         LA    R6,4(R8)                 PUSHDOWN LIST POINTER           07560000
         LA    R7,4(R6)           POINTER TO NEXT VALUE                 07580000
COMPVAL  BCTR  R5,0                     DECREMENT COUNT                 07600000
         CLC   2(2,R6),2(R7)            FIND LOW ENTRY                  07620000
         BNL   UPPTR2             UPDATE POINTER TO NEXT VALUE          07640000
         LR    R6,R7              UPDATE OLD TO NEW HIGH                07660000
UPPTR2   LA    R7,4(R7)                                                 07680000
         LTR   R5,R5                    IS LOOP COMPLETED               07700000
         BNE   COMPVAL                  BRANCH IF NO                    07720000
         CLC   2(2,R6),ZEROS            TEST FOR ZERO QUANTITY          07740000
         BE    QTYNOTAV                                                 07760000
         LH    R7,2(R6)           LOAD TRACK VALUE OF HIGH EXTENT       07780000
         LTR   RJFCB,RJFCB              TEST FOR PARTIAL DSCB    A46776 07786021
         BM    BLKREQ                   BRANCH IF YES              UL17 07792000
         TM    JFCBCTRI,X'04'           TEST FOR MXIG              UL17 07798000
         BO    LASTFILL                 BRANCH TO FILL MXIG        UL17 07804000
BLKREQ   SR    REQ,R7                                              UL17 07810000
         LTR   REQ,REQ            TEST                                  07820000
         BZ    LASTFILL           ZERO LAST EXTENT FILLS REQUEST        07840000
         BM    SHAVE              EXTENT EXCEEDS REQUEST                07860000
         MVC   0(2,R8),0(R6)      MORE EXTENTS NEEDED                   07880000
         AH    R7,0(R8)                                                 07900000
         STH   R7,2(R8)           STORE RTA+1 IN DADSM TABLE            07920000
         LA    R9,1(R9)                 ADD 1 TO NUMBER TO ALLOCATEUL17 07940000
         LA    R8,4(R8)           UPDATE DADSMTBL POINTER               07960000
         MVC   0(4,R6),0(R8)            PDLIST 1ST ENTRY TO USED ENTRY  07980000
         MVC   0(4,R8),ZEROS            CLEAR NEXT DADSM ENTRY          08000000
         BCT   RF,FINDMLTI        GET NEXT EXTENT                       08020000
         B     QTYNOTAV                                                 08040000
SHAVE    AR    R7,REQ                                                   08060000
LASTFILL MVC   0(2,R8),0(R6)                                            08080000
         AH    R7,0(R8)                                                 08100000
         STH   R7,2(R8)           STORE RTA+1 IN DADSM TABLE            08120000
         LA    R9,1(R9)                                                 08140000
EXTNO    STC   R9,DADSMTBL+1      STORE NUMBER OF EXTENTS ALLOCATED     08160000
         B     EXRQFILL           GO TO EXIT                            08180000
*                                                                       08200000
* * * * * * * * * * * * *                                               08220000
*                                                                       08240000
***   CONSTANTS                                                         08260000
*                                                                       08280000
* * * * * * * * * * * * *                                               08300000
*                                                                       08360000
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         08380002
*                                                                       08400000
         XCTLTABL ID=(ALLOCA3,5E,ALLOCD2,5H),SVC=032,BRT=YES,    Y02080C08450002
               LENGTH=                                           Y02080 08500002
         EJECT                                                   Y02080 08550002
DSCBWKAR IECALLWA EP,F4,D1=(1),D2=(5)   ALLOCATE WORK AREA       Y02080 08740002
ZEROS    EQU   CCW4+4                                                   09160000
USERLBL  EQU   CCW10+4                                             UL17 09470000
         EJECT                                                   Y02080 09520002
CVT      DSECT                          CVT DSECT                Y02080 09570002
         CVT                                                     Y02080 09620002
         EJECT                                                   Y02080 09670002
*                                                                       10580000
* * * * * * * * * * * * *                                               10600000
*                                                                       10620000
* * * * * * * * * * * * *                                               10640000
*                                                                       10660000
JFCBFLD  DSECT                                                          10680000
         IEFJFCBN                                                       10700000
         EJECT                                                   Y02080 10710002
*                                                                       10750021
* * * * * * * * * * * * *                                               10800021
*                                                                       10850021
***   DSECT FOR THE PARTIAL DSCB PASSED TO ALLOCATE BY IEHMOVE   A46776 10900021
*                                                                       10950021
* * * * * * * * * * * * *                                               11000021
*                                                                       11050021
         ORG   INFMJFCB                                                 11100021
PD1DSNAM DS    CL44                DATA SET NAME                        11150021
PD1FMTID DS    CL1                 FORMAT IDENTIFIER                    11200021
PD1DSSN  DS    CL6                 DATA SET SERIAL NUMBER               11250021
PD1VOLSQ DS    XL2                 VOLUME SEQUENCE NUMBER               11300021
PD1CREDT DS    XL3                 CREATION DATE                        11350021
PD1EXPDT DS    XL3                 EXPIRATION DATE                      11400021
PD1NOEPV DS    XL1                 NUMBER OF EXTENTS ON VOLUME          11450021
PD1NOBDB DS    XL1                 NUMBER OF BYTES USED IN LAST         11500021
*                                     DIRECTORY BLOCK                   11550021
         DS    XL1                 RESERVED                             11600021
PD1SYSCD DS    CL13                SYSTEM CODE                          11650021
         DS    XL7                 RESERVED                             11700021
PD1DSORG DS    XL2                 DATA SET ORGANIZATION                11750021
PD1RECFM DS    XL1                 RECORD FORMAT                        11800021
PD1OPTCD DS    XL1                 OPTION CODE                          11850021
PD1BLKL  DS    XL2                 BLOCK LENGTH                         11900021
PD1LRECL DS    XL2                 RECORD LENGTH                        11950021
PD1KEYL  DS    XL1                 KEY LENGTH                           12000021
PD1RKP   DS    XL2                 RELATIVE KEY POSITION                12050021
PD1DSIND DS    XL1                 DATA SET INDICATORS                  12100021
PD1SCALO DS    XL4                 SECONDARY ALLOCATION                 12150021
PD1LSTAR DS    XL3                 LAST USED TRACK AND BLOCK ON TRACK   12200021
PD1TRBAL DS    XL2                 BYTES REMAINING ON LAST TRACK USED   12250021
         DS    XL2                 RESERVED                             12300021
PD1EXT1  DS    XL1                 EXTENT TYPE INDICATOR                12350021
         DS    XL2                 UNUSED                               12400021
PDPRIQTY DS    F                   PRIMARY SPACE REQUEST IN TRACKS      12450021
PDDIRQTY DS    F                   NUMBER OF DIRECTORY BLOCKS           12500021
         END   IGG0325D                                          A42477 50720021
