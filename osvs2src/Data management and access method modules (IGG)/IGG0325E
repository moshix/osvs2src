 TITLE 'IGG0325E - DADSM - BUILD F1/F3 ROUTINE'                         00020000
IGG0325E CSECT                                                          00020521
*                                                                       00020902
*MODULE NAME = IGG0325E                                                 00021302
*                                                                       00021402
*DESCRIPTIVE NAME = DADSM - BUILD F1/F3 ROUTINE                         00023302
*                                                                       00025302
*COPYRIGHT = NONE                                                       00025702
*                                                                       00025802
*CHANGE ACTIVITY = SEE BELOW                                            00025902
*                                                                       00026002
*          RELEASE 16 DELETIONS                                         00027802
*009206610662-0668                                                 7493 00029702
*1462086400,113200                                                 AAAA 00031602
*1462                                                             13559 00033502
*          RELEASE 17 DELETIONS                                         00035402
*1708000230,000550,009600,009800,033600,046200-046800,052200-      UL17 00037302
*    054000,054800,067400,068200-069000,070600,073800-077400,      UL17 00039202
*    090800-091000.                                                UL17 00041102
*          RELEASE 18 DELETIONS                                         00043002
*2410054680,054920,056000,059800                                  22833 00044902
*          RELEASE 19 DELETIONS                                         00046802
*          RELEASE 20 DELETIONS                                         00048702
*1027063200                                                      A36720 00050602
*1027054650-054920,064200                                        A32526 00052502
*1027062200                                                      S20016 00054402
*1027                                                            A31576 00056302
*          RELEASE 21 DELETIONS                                         00058202
* 063200                                                         M1769  00060102
*1192002600,003800-004000,021600-021800,022200-022400,066600-    A42477 00062002
*1192067400,073400,090400,092600,096800                          A42477 00063902
*1192060000                                                      M0184  00065802
*1192000210,019600,028800-029400,089400-089600,090400,092600,    S21042 00067702
*1192117200                                                      S21042 00069602
*0000001600-002000,006000,040800,054400,055400,055800,056400-    A46776 00071502
*0000058200,067000-069800,070860,071400,072200-072400,084600-    A46776 00073402
*0000084800,085800-086200,090400-092600,115200-115800            A46776 00075302
*          RELEASE 22 DELETIONS                                         00077202
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00079102
*0000000030-000150,000640-000704,004000,006600,007200,008800,    Y02080 00081002
*0000009400-010200,011800,020000,022000-022300,027544,030200,    Y02080 00082902
*0000031400,070200,072400-072600,073000,073400-073600,090000,    Y02080 00084802
*0000090300-098600,099000-114600,115896-116600,117000            Y02080 00086702
*0000                                                            Y02144 00088602
*0000                                                            Y02082 00090502
*0000009000,021200,084700,085000-086600,089200-089500,112800-    YM3995 00090902
*0000113000,116600-117000                                        YM3995 00091302
*                                                                     * 00091402
*          VS2 SU32 DELETIONS                                  @G32DSFS 00091700
*D055920-056140,055920-056040                                  @G32DSFS 00091800
*          VS2 RELEASE 03.0 DELETIONS/CHANGES                         * 00091900
*0000089500                                                     ZA00704 00092000
*          VS2 RELEASE 03.7 CHANGES/SU808                               00092100
*A064312-064330,C064333                                        @ZA15055 00092200
*                                                                       00092600
*STATUS CHANGE LEVEL 007                                                00094302
*FUNCTION/OPERATION: THIS MODULE BUILDS AND WRITES FORMAT 1 AND       * 00096202
*   FORMAT 3 DSCB'S AS REQUIRED.  IT PROCESSES THE ALLOCATED SPACE    * 00098102
*   EXTENTS IN THE DADSM TABLE TO GENERATE THE F1/F3 EXTENTS.  THIS IS* 00100000
*   ACCOMPLISHED BY LINKING TO THE 'TTR CONVERT ROUTINE' TO CONVERT   * 00120000
*   THE DADSM TABLE 'RTA' FORM EXTENTS INTO 'CCHH' FORM.  THE         * 00140000
*   OTHER APPROPRIATE FORMAT 1 DSCB FIELDS ARE FILLED WITH DATA       * 00160021
*   TAKEN FROM EITHER A JFCB OR A PARTIAL DSCB.  IF A DIRECTORY       * 00180021
*   IS REQUESTED, A CHECK IS MADE TO DETERMINE IF THE DIRECTORY       * 00200021
*   QUANTITY REQUESTED WILL FIT INTO THE LARGEST EXTENT ALLOCATED     * 00220000
*   TO THIS REQUEST.                                                  * 00240000
*   THE VTOC HAS BEEN ENQ'ED BY IGG0325A, AND AS THIS MODULE CHANGES  * 00260021
*   SPACE EXTENTS IN THE VTOC IT WILL PERFORM A 'SET MUST COMPLETE'   * 00280000
*   FUNCTION PRIOR TO THE FIRST WRITE.                                * 00300000
*   DEFINES DATA SETS TO RAC IF AUTOMATIC DATA SET PROTECTION  @Z40RSGD 00310032
*   IS INDICATED IN THE JFCB.                                  @Z40RSGD 00312032
*                                                                     * 00320000
*ENTRY POINTS:                                                        * 00340000
*        IGG0325E - ENTRY IS MADE FROM IGG0325B ON A ZERO QUANTITY    * 00360000
*   REQUEST, FROM IGG0325K FOR A ZERO QUANTITY REQUEST SPECIFYING     * 00370021
*   USER LABELS, FROM IGG0325C FOR AN ABSOLUTE TRACK REQUEST, AND     * 00380021
*   FROM IGG0325D FOR CYLINDER, TRACK, OR RECORD SPACE REQUESTS.      * 00390021
*                                                                     * 00420000
*INPUT: UPON ENTRY TO THIS MODULE THE WORK AREA CONTAINS THE DATA     * 00440000
*   PORTION OF THE FORMAT 4 DSCB AND ITS ADDRESS, THE ADDRESS OF THE  * 00460000
*   FIRST DADSM RECORD (F5), A DEB, AN IOB, AN ECB, AND A CHANNEL     * 00480000
*   PROGRAM TO SEARCH FOR HOLES AND WRITE FORMAT 1 AND FORMAT 3       * 00500000
*   DSCB'S.  IF THE FIRST DADSM RECORD IS STILL IN CORE THE 'FIRST    * 00520000
*   FORMAT 5 DSCB IN CORE SWITCH' WILL BE ON.                         * 00540000
*   THE DADSM TABLE WILL CONTAIN THE ACTUAL SPACE ALLOCATED TO THIS   * 00560000
*   REQUEST IF OTHER THAN A ZERO QUANTITY REQUEST.                    * 00580000
*   REGISTER 11 WILL POINT TO A JFCB OR A PARTIAL DSCB.               * 00600021
*   REGISTER 13 WILL POINT TO THE WORK AREA.                          * 00620000
*                                                                     * 00640000
*OUTPUT: UPON TRANSFER OF CONTROL, THE WORK AREA AND REGISTERS WILL   * 00660002
*   BE AS AT INPUT.  FORMAT 1 DSCB'S AND FORMAT 3 DSCB'S WILL BE      * 00680000
*   WRITTEN OUT ON THIS VOLUME AS REQUIRED.                           * 00700000
*   IF NOT AN ERROR EXIT THE 'SET MUST COMPLETE INDICATOR' WILL BE ON.* 00720002
*   IF DIRECTORIES WERE REQUESTED THE LOW CCHH OF THE FIRST FORMAT 1  * 00740000
*   DSCB EXTENT WILL BE SAVED IN THE WORK AREA.                       * 00760000
*                                                                     * 00780000
*EXTERNAL ROUTINES:                                                   * 00800000
*        CVTPCNVT - TTR CONVERSION ROUTINE                            * 00820000
*        EXCP(0) - READ FROM OR WRITE TO DIRECT ACCESS DEVICE         * 00840000
*        WAIT(1) - WAIT ON EVENT CONTROL BLOCK                        * 00860000
*        STATUS  - SET STEP MUST COMPLETE IN THE TCB                  * 00900002
*        IECRES  - BRANCH TO OTHER MODULES                            * 00910002
*                                                                     * 00920000
*EXITS-NORMAL: BRANCH TO IGG0325H WITH ZERO IN THE ERROR CODE PASS    * 00940002
*              REGISTER ON ZERO QUANTITY REQUESTS.  BRANCH TO         * 00960002
*              IGG0325G ON ALL OTHER REQUESTS TO UPDATE F5 DSCBS.     * 01000002
*   -ERROR: BRANCH TO IGG0325H WITH CODE IN ERROR CODE PASS REGISTER. * 01020002
*                                                                     * 01040000
*   ERROR CODES THAT CAN BE ISSUED BY 'BUILD F1/F3 ROUTINE'           * 01060000
*                                                                     * 01080000
*   0C - PERMANENT I/O ERROR                                          * 01100000
*                                                                     * 01120000
*   38 - DIRECTORY QUANTITY REQUEST ERROR                             * 01140000
*                                                              @Z40RSGD 01150032
*   A8 - RACDEF FAILED DATA SET ALREADY DEFINED.               @Z40RSGD 01152032
*                                                              @Z40RSGD 01154032
*   AC - USER NOT AUTHORIZED TO DEFINE DATA SET.               @Z40RSGD 01156032
*                                                                     * 01160000
*TABLES/WORK AREAS: DADSM WORK AREA DESCRIBED BY MACRO 'IECALLWA'     * 01180002
*                                                                     * 01200000
*              ***************************************                * 01220000
*              *             DADSM TABLE             *                * 01240000
*              ***************************************                * 01260000
*                                                                     * 01280000
*              ***************************************                * 01300000
*              *        *         *                  *                * 01320000
*              *  TYPE  *  NO OF  *     USED HOLE    *                * 01340000
*              *  FLAG  * ENTRIES *      COUNTER     *                * 01360000
*              *        *         *                  *                * 01380000
*              ***************************************                * 01400000
*              *                  *                  *                * 01420000
*              *       RTA        *      RTA+1       *                * 01440000
*              *                  *                  *                * 01460000
*              ***************************************                * 01480000
*              *                  *                  *                * 01500000
*              *       RTA        *      RTA+1       *                * 01520000
*              *                  *                  *                * 01540000
*              ***************************************                * 01560000
*              *                  *                  *                * 01580000
*              *       RTA        *      RTA+1       *                * 01600000
*              *                  *                  *                * 01620000
*              ***************************************                * 01640000
*              *                  *                  *                * 01660000
*              *       RTA        *      RTA+1       *                * 01680000
*              *                  *                  *                * 01700000
*              ***************************************                * 01720000
*              *                  *                  *                * 01740000
*              *       RTA        *      RTA+1       *                * 01760000
*              *                  *                  *                * 01780000
*              ***************************************                * 01800000
*                                                                     * 01820000
*              TYPEFLG  =  02 - BPAM DIRECTORIES REQUESTED.           * 01840000
*                                                                     * 01844021
*                       =  40 - USER LABELS REQUESTED                 * 01848021
*                                                                     * 01852021
*                       =  80 - SET MUST COMPLETE IS ACTIVE           * 01856021
*                                                                     * 01860000
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.  * 01880000
*                                                                     * 01900000
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.      * 01920000
*                                                                     * 01940000
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT* 01960021
*                                                                     * 01980000
*ATTRIBUTES: REENTRANT                                                * 02000002
*                                                                     * 02020000
*NOTES:                                                               * 02040000
*   OTHER MACROS USED                                                 * 02060000
*   IECALLWA - ALLOCATE WORK AREA EXPANSION                           * 02070002
*   IECSDSL1 - BUILD DSCB'S                                           * 02080000
*   IEFJFCBN - BUILD JFCB                                             * 02100000
*   IECDSECS - EXPANDS THE CVT, PSA,TCB,JFCB, AND SCVT DSECTS         * 02120032
*                                                                     * 02140000
*                                                                     * 02210021
*STORAGE: PROGRAM CODE CSECT - LESS THAN 1024 BYTES                   * 02220002
*   WORK AREA - AS DEFINED IN THE IECALLWA MACRO                      * 02230002
*   RPS WORK AREA - AS DEFINED IN THE IECRPS MACRO                    * 02240002
*                                                                     * 02260000
*                                                                       02280000
*REGISTER USAGE:                                                        02300000
*                                                                       02320000
R0       EQU   0                                                        02340000
R1       EQU   1                                                        02360000
R2       EQU   2                                                        02380000
RHH      EQU   2                        ALIGN CHECK WORK REG            02400000
R3       EQU   3                                                        02420000
RCC      EQU   3                        ALIGN CHECK WORK REG            02440000
RTABL    EQU   4                        POINTER TO DADSM TABLE          02460000
RXNUM    EQU   5                        EXTENT SEQUENCE NUMBER          02480000
RXPTR    EQU   6                        POINTER TO F1/F3 EXTENT FIELD   02500000
RCNT     EQU   7                        NUMBER OF ENTRIES IN DADSM TBL  02520000
RTTRPTR  EQU   7                        PTR TO XCTL BY TTR TABLE ENTRY  02540000
RTRK     EQU   8                        CONTAINS TRKS/CYL               02560000
RERRPASS EQU   8                        ERROR PASS REGISTER             02580000
DRBAK    EQU   9                        CHAN PROG RETURN REGISTER       02600000
RWORK    EQU   9                        WORK REGISTER          @ZM43025 02610032
RJFCBA   EQU   10                       ALTERNATE JFCB POINTER          02620000
RJFCB    EQU   11                                                       02640000
RBASE    EQU   12                 BASE REGISTER                         02660000
RWKA     EQU   13                 WORK AREA BASE                        02680000
RBAK     EQU   14                 RETURN REGISTER                       02700000
RERR     EQU   15                 ERROR CODE REGISTER                   02720000
RCVT     EQU   15                       CONVERSION ROUTINE LINK REG     02740000
*                                                                       02744020
* OTHER EQUATES                                                         02748020
*                                                                       02752020
ONEENTRY EQU   1                        ONE DADSMTBL ENTRY       A46776 02752221
K1       EQU   1                        CONSTANT OF ONE          Y02082 02752402
STEPMC   EQU   1                        STATUS STEP MC INDICATOR YM3995 02752802
TWO      EQU   2                        CONSTANT OF TWO          A46776 02753021
FOUR     EQU   4                        CONSTANT OF FOUR       @ZM43025 02754032
DSORGPO  EQU   X'02'                    DSORG = PO IN F1 DSCB    A36720 02756020
DSORGU   EQU   X'01'                    UNMOVABLE BIT IN DSORG   M1769  02758021
RDWOPSWD EQU   X'04'                    DSCB RD-W/O-PASSWORD BIT Y02080 02758402
* EQUATES FOR RACDEF SUPPORT                                   @Z40RSGD 02758532
DS1RACDF EQU   X'40'                    DS1DSIND-DATA SET IS   @Z40RSGD 02758632
*                                       RAC DEFINED            @Z40RSGD 02758732
RACERR   EQU   X'A4'                    USED TO CONSTRUCT RAC  @Z40RSGD 02764032
*                                       ERROR CODES            @Z40RSGD 02766032
RESBITS  EQU   X'13'                    DSORG RESERVE BITS       Y02080 02769432
*                                                                       02774732
* * * * * * * * * * * * *                                               02780000
*                                                                       02800000
*                                                                       02820000
* * * * * * * * * * * * *                                               02840000
*                                                                       02860000
* REGISTER USAGE                                                        02910021
*                                                                       02960000
         BALR  RBASE,0                                                  02980000
         USING BLDF1F3,RBASE                                            03000000
         USING ALLOCWKA,RWKA            WORK AREA ADDRESSABILITY Y02080 03020002
         USING CVT,RCVT                                                 03040000
         USING JFCBFLD,RJFCB                                            03060000
*                                                                       03080000
BLDF1F3  MVI   CCW11+4,X'10'            SET SKIP FLAG IN WRT CK CCW     03100000
         XC    DS1DSNAM(140),DS1DSNAM   CLEAR FORMAT 1 DSCB AREA        03120000
         NI    SWITCH,X'FF'-PRCNTL      CLEAR CONTROL SWITCH     Y02080 03140002
         LR    RJFCBA,RJFCB             INITIALIZE ALTERNATE JFCB PTR   03160000
         SR    RCNT,RCNT                                                03180000
         IC    RCNT,ENTRYNUM           GET NBR OF DADSMTBL ENTRIES      03200000
         LTR   RCNT,RCNT               IS THIS A ZERO QTY REQUEST       03220000
         BZ    BLDF1                   BRANCH IF YES                    03240000
*                                                                       03260000
* THIS SECTION CHECKS IF THE FIRST ENTRY IN THE DADSMTBL WILL FILL      03280000
* THE DIRECTORY QUANTITY REQUESTED.  BLANK AND ALX OPTION               03300000
*                                                                       03320000
         LA    R2,ENTRIES              POINT TO FIRST DADSMTBL ENTRY    03340000
       TM      TYPEFLG,X'42'            DIRECTORIES OR USER LABEL UL17  03360000
         BZ    FIRSTPAS                BRANCH IF NO                     03380000
         LA    R2,ENTRIES+4            BYPASS THE FIRST DADSMTBL ENTRY  03400000
         LH    R0,ENTRIES+2            GET 1ST ENTRY RTA+1              03420000
         SH    R0,ENTRIES              CALCULATE NBR OF TRKS            03440000
         CH    R0,TTRLL                WILL THE 1ST ENTRY FILL DIR REQ  03460000
         BNH   DIRERR                   BRANCH IF NO                    03480000
         BCT   RCNT,FIRSTPAS           DECREMENT COUNT AND GO SORT      03500000
         B     START1                  ONE ENTRY - BYPASS SORT          03520000
*                                                                       03540000
* DIRECTORY ERROR - BLANK OR ALX OPTION.  THE FIRST ENTRY IN THE        03560000
* DADSMTBL WILL NOT FILL THE DIRECTORY QUANTITY REQUESTED.              03580000
*                                                                       03600000
DIRERR   LA    RERRPASS,X'38'           SET ERROR CODE 'DIR QTY ERROR   03620000
         B     ERREXIT                                                  03640000
*                                                                       03660000
*                                                                       03680000
* ROUTINE TO SORT DADSM TABLE INTO ASCENDING RTA SEQUENCE               03700000
*                                                                       03720000
FIRSTPAS LR    RTABL,R2                SET UP DADSMTBL POINTER          03740000
         LR    R3,RCNT                 LOAD SORT LOOP COUNTER           03760000
DCOUNT   BCT   R3,NEWPAIR              ARE THERE MORE COMPARISIONS      03780000
         BCT   RCNT,FIRSTPAS           NO-ANY MORE SORT PASSES          03800000
         B     START1                  BRANCH IF NO                     03820000
NEWPAIR  CLC   0(2,RTABL),4(RTABL)     FIRST HIGHER THAN SECOND         03840000
         BL    SHIFT                   BRANCH IF NO                     03860000
         LM    R0,R1,0(RTABL)          LOAD THESE TWO ENTRIES           03880000
         ST    R0,4(RTABL)             EXCHANGE THESE                   03900000
         ST    R1,0(RTABL)                  TWO ENTRIES                 03920000
SHIFT    LA    RTABL,4(RTABL)          STEP DADSMTBL PTR TO NEXT PAIR   03940000
         B     DCOUNT                                                   03960000
*                                                                       03980000
* THIS SECTION CALCULATES CCHHCCHH OF EACH EXTENT AND STORES THEM IN    04000000
* THE F1 DSCB. THE EXTENT NUMBER IS ALSO STORED HERE.                   04020000
*                                                                       04040000
START1   TM    SWITCH,PRCNTL           IS PROCESS CONTROL SWITCH ON     04060000
         BO    EXIT6A                   BRANCH IF YES            A46776 04080021
         IC    RCNT,ENTRYNUM      PICK UP NUMBER OF ENTRIES IN TABLE    04100000
RESET1   LA    RTABL,ENTRIES-2          POINT TO 1ST ENTRY IN DADSM TBL 04120000
         LA    RXPTR,DS1EXT1-4          INITIALIZE EXTENT POINTER       04140000
         SR    RXNUM,RXNUM        CLEAR EXTENT SEQ REGISTER             04160000
         LA    R1,3               INSERT MAXIMUM EXTENTS IN F1 DSCB.    04180000
         CLR   R1,RCNT                 IS FORMAT 3 DSCB NEEDED.         04200000
         BL    BLDF3              YES- GO AND CREATE F3 DSCB.           04220000
RETURNF1 LA    DRBAK,BLDF1             INSERT RETURN ADDRESS            04240000
BIGLOOP  LA    RBAK,UPPEREXT      INSERT RETURN ADDRESS                 04260000
CALEXT   STC   RXNUM,5(RXPTR)           INSERT EXTENT NUMBER            04280000
CALOOP   LH    R0,2(RTABL)              GET LOW RTA                     04300000
GOCVT    SLL   R0,16                   POSITION RTA TO 'TT' OF TTR0     04320000
         STM   DRBAK,RWKA,REGSAVEA     SAVE REGISTERS                   04340000
         ST    RBAK,PDLIST5            SAVE RETURN REGISTER             04360000
         LA    R1,DEB                   LOAD DEB POINTER                04380000
         LA    R2,MBBCCHHR              LOAD POINTER TO 8 BYTE AREA     04400000
         L     RCVT,CVTPTR              LOAD COMM VECT TABLE BASE       04420000
         L     RCVT,CVTPCNVT            LOAD CONVERSION ROUTINE BASE    04440000
         LR    R3,RWKA                  SAVE WORKAREA POINTER           04460000
         BALR  RBAK,RCVT                GO TO CONVERSION ROUTINE        04480000
         LM    DRBAK,RWKA,REGSAVEA-FIRST(R3)  RESTORE REGISTERS         04500000
         L     RBAK,PDLIST5            RESTORE RETURN REGISTER          04520000
         MVC   6(4,RXPTR),MBBCCHHR+3    MOVE CCHH TO EXTENT             04540000
         BR    RBAK                                                     04560000
UPPEREXT LA    RTABL,2(RTABL)           UPDATE POINTER FOR UPPER RTA    04580000
         LA    RXPTR,4(RXPTR)           UPDATE POINTER FOR UPPER CCHH   04600000
NOTSPLIT LH    R0,2(RTABL)              GET UPPER RTA+1                 04700000
         BCTR  R0,0                     DECREMENT TO HIGH RTA           04720000
         BAL   RBAK,GOCVT               GO TO CONVERSION ROUTINE        04740000
*                                                                       04760000
* THIS ROUTINE TESTS WHETHER EXTENT IS CYLINDER ALIGNED AND SETS        04780000
* THE ALIGNMENT CODE IN THE EXTENT TYPE FIELD.                          04800000
*                                                                       04820000
ALIGNCHK SR    RHH,RHH                  CLEAR DIVIDION REG              04840000
         LH    RCC,0(RTABL)             GET LOW RTA                     04860000
         LH    RTRK,DS4DEVSZ+2          GET TRKS/CYL                    04880000
         DR    RHH,RTRK                 CONVERT TO CCHH                 04900000
         LTR   RHH,RHH                  IS THERE A TRK REMAINDER        04920000
         BNE   NOTALIGN                 BRANCH IF YES                   04940000
         LH    RCC,2(RTABL)             GET HIGH RTA                    04960000
         DR    RHH,RTRK                 CONVERT TO CCHH                 04980000
         LTR   RHH,RHH                  IS THERE A TRK REMAINDER        05000000
         BNE   NOTALIGN                 BRANCH IF NO                    05020000
         MVI   0(RXPTR),X'81'           SET ALIGN CODE                  05040000
         B     ALIGNRTN                                                 05060000
NOTALIGN MVI   0(RXPTR),X'01'           SET NOT ALIGN CODE              05080000
ALIGNRTN BCT   RCNT,UPDATE1                                             05100000
         BR    DRBAK                    RETURN TO CALLING ROUTINE       05120000
UPDATE1  LA    RTABL,2(RTABL)     UPDATE DADSM TABLE POINTER            05140000
         LA    RXNUM,1(RXNUM)     INCREMENT EXTENT SEQUENCE CTR         05160000
         LA    RXPTR,6(RXPTR)                                           05180000
         B     BIGLOOP            BRANCH TO CLACULATE NEXT EXTENT       05200000
*                                                                       05420000
* THIS SECTION BUILDS A FORMAT 1 DSCB FROM A PARTIAL F1 DSCB.           05440021
*                                                                       05460000
BLDF1    EQU   *                                                 A32526 05470020
         TM    TYPEFLG,SMCDONE     HAS MUST CMPLT BEEN SET        22833 05496018
         BO    BLDF1B                   BRANCH IF YES                   05500000
         BAL   DRBAK,DOSMC              GO SET MUST COMPLETE            05520000
BLDF1B   EQU   *                                                 A46776 05530021
         LTR   RJFCB,RJFCB              TEST IF PARTIAL DSCB     A46776 05540021
         BP    BLDF1A                                                   05560000
         MVC   DS1DSNAM(PD1LSTAR-PD1DSNAM),PD1DSNAM  MOVE IN     A46776 05580021
*                                       THE FORMAT 1 DSCB FIELDS A46776 05590021
         MVC   DS1LSTAR(5),TTRLL                                        05620000
         B     EXIT5A                                                   05840000
*                                                                       05860000
* BUILD FORMAT 1 DSCB ROUTINE                                           05880000
*                                                                       05900000
BLDF1A   MVI   DS1FMTID,X'F1'                                           05920000
         MVC   DS1DSSN(6),JFCBVOLS      INSERT FILE SERIAL NUMBER       05940000
         MVI   DS1VOLSQ+1,X'01'        INSERT VOLUME SEQUENCE NUMBER    05960000
         MVC   DS1SYSCD(13),SYSCODE     MOVE IN SYSTEM CODE      M0184  05990021
         MVC   DS1LSTAR(5),TTRLL       INSERT LAST TRACK USED AND       06020000
*                                      SPACE REMAINING ON LAST TRACK    06040000
         MVC   DS1SCALO(4),JFCBCTRI     MOVE IN SPACE PARAMETERS        06060000
*                                                                       06070032
* SET RAC PROTECTED INDICATOR IF REQUESTED.                    @Z40RSGD 06072032
*                                                                       06074032
         TM    JFCFLGS1,JFCBADSP        AUTO DATA SET PROTECT  @Y40RSGD 06076032
         BZ    NORACBIT                 NO-CONTINUE            @Z40RSGD 06078032
         OI    DS1DSIND,DS1RACDF        YES-SET RAC PROTECTED  @Z40RSGD 06078432
*                                       BIT                    @Z40RSGD 06078832
NORACBIT EQU   *                        RAC INDICATOR IN DSCB  @Z40RSGD 06079232
*                                       CORRECT                @Z40RSGD 06079632
         DROP  RJFCB                                                    06080000
         USING JFCBFLD,RJFCBA                                           06100000
EXIT5    MVC   DS1DSNAM(44),JFCBDSNM                                    06120000
         MVC   DS1CREDT(6),JFCBCRDT     INSERT CREATION AND EXPIRATION  06140000
         MVC   DS1DSORG(8),JFCDSORG     INSERT DSORG FIELD              06160000
*                                       RECORD FORMAT, OPTION CODE,     06180000
*                                       BLOCK AND RECORD LENGTH.        06200000
         NI    DS1DSORG+K1,X'FF'-RESBITS CLEAR THE RESERVED BITS Y02082 06205002
         TM    JFCBIND2,JFCBSCTY        DOES JFCB SPEC SECURITY  S20016 06220020
         BZ    NOSECTY                  BRANCH IF NO                    06240000
         OI    DS1DSIND,X'10'           SET SECURITY BIT IN DSCB F1     06260000
         TM    JFCBIND2,JFCBRWPW        DOES JFCB SPEC RWPW OPTN S20016 06265020
         BNO   NOSECTY                  BRANCH IF NO             S20016 06270020
         OI    DS1DSIND,RDWOPSWD        IND SECTY IS FOR WR ONLY S20016 06275020
NOSECTY  CLC   JFCBDQTY(3),ZEROS        IS THIS A DIRECTORY REQUEST     06280000
         BE    MOVEKEY                  BRANCH IF NO                    06300000
         NI    DS1DSORG,DSORGU          LEAVE UNMOVABLE BIT ON   M1769  06310021
         OI    DS1DSORG,DSORGPO         SET DSORG=PO IN F1 DSCB  M1769  06320021
MOVEKEY  MVC   DS1KEYL(1),JFCKEYLE      INSERT KEY LENGTH               06340000
         MVC   DS1RKP(2),JFCRKP         INSERT RELATIVE KEY POSITION    06360000
         DROP  RJFCBA                                                   06380000
         USING JFCBFLD,RJFCB                                            06400000
EXIT5A   EQU   *                                                 A32526 06404020
         IC    R0,ENTRYNUM              PICK UP NO. EXTENTS      A32526 06408020
         TM    TYPEFLG,X'40'            USER LABELS REQUESTED    A32526 06412020
         BZ    NOUSER                   BRANCH IF NO             A32526 06416020
         MVI   DS1EXT1,X'40'            INSERT USER LABEL IND    A32526 06420020
         BCTR  R0,0                     DO NOT COUNT U.L. EXTENT A32526 06424020
NOUSER   EQU   *                                                 A32526 06428020
         STC   R0,DS1NOEPV              PUT # EXTENTS IN DSCB  @Z40RSGD 06428432
*                                                                       06430032
* DEFINE DATA SET TO RAC IF REQUESTED                          @Z40RSGD 06430432
*                                                                       06430832
         LTR   RJFCB,RJFCB              TEST FOR PARTIAL DSCB  @G32DSFS 06430932
         BNP   RACDEFOK                 YES,SKIP RACDEF        @G32DSFS 06431032
         L     RCVT,CVTPTR              GET CVT ADDRESS        @ZA15055 06431232
         L     RCVT,CVTRAC              LOAD ACCESS CNTL       @ZA15055 06431532
         LA    RCVT,0(,RCVT)            CLEAR HI-ORD           @ZA15055 06431832
         LTR   RCVT,RCVT                RAC ACTIVE?            @ZA15055 06432132
         BNZ   TST2                     YES-GO TO NEXT TEST    @ZA15055 06432432
         NI    DS1DSIND,X'FF'-DS1RACDF  INSURE RAC PROTECT OFF @ZA15055 06432732
         B     RACDEFOK                 NO-RAC CONTINUE        @ZA15055 06433032
TST2     TM    DS1DSIND,DS1RACDF        RACDEF NECESSARY       @ZA15055 06433332
         BZ    RACDEFOK                 NO-CONTINUE            @Z40RSGD 06433632
         MVC   RACDEF(LRACDEF),MRACDEF  INITIALIZE RACDEF      @Z40RSGD 06433932
*                                       PARAMETER LIST         @Z40RSGD 06434232
         RACDEF ENTITY=DS1DSNAM,        DEFINE NEW DS TO RAC   @Z40RSGDX06435732
               VOLSER=MIELNAME,                                @Z40RSGDX06437532
               MF=(E,RACDEF)                                   @Z40RSGD 06439532
         LTR   RERR,RERR                RACDEF SUCCESSFUL      @Z40RSGD 06442032
         BZ    RACDEFOK                 YES-CONTINUE           @Z40RSGD 06442432
* RACDEF FAILED SET ERROR CODE X'A8' FOR PREVIOUSLY DEFINED    @Z40RSGD 06442832
* AND X'AC' IF USER NOT AUTHORIZED TO ISSUE RACDEF             @Z40RSGD 06442932
         LA    RERRPASS,RACERR(RERR)    SET ERROR CODE         @Z40RSGD 06443032
         B     ERREXIT                  ERROR TERMINATE ALLOC  @Z40RSGD 06443132
RACDEFOK EQU   *                        RACDEF PROCESSING      @Z40RSGD 06449232
*                                       COMPLETE               @Z40RSGD 06451232
         BAL   DRBAK,BCHNLGO            WRITE F1 DSCB            A32526 06461732
*                                                                       06467832
* THIS SECTION UPDATES THE HIGH WATER MARK AND THE HOLE COUNT IN        06473932
* THE VTOC DSCB                                                         06480000
*                                                                       06500000
         CLC   IDAREA(5),DS4HPCHR      TEST FOR HI WATER MARK           06520000
         BNH   OLDHIWAT                                                 06540000
         MVC   DS4HPCHR(5),IDAREA      MOVE IN NEW HI WATER MARK        06560000
OLDHIWAT LH    RTABL,DS4DSREC           GET NUMBER OF AVAIL HOLES       06580000
         BCTR  RTABL,0                  DECREMENT COUNT BY ONE          06600000
         STH   RTABL,DS4DSREC           RESET NUMBER OF AVAIL HOLES     06620000
         MVC   CCHHR(5),IDAREA     SAVE CCHHR OF F1 DSCB         S21042 06630021
         CLI   ENTRYNUM,X'00'           IS THIS A ZERO QTY REQUEST      06640013
         BNE   TSTDIR                   BRANCH IF NO             A46776 06700021
         SR    RERRPASS,RERRPASS        ZERO ERROR PASS REGISTER A46776 06760021
ERREXIT  EQU   *                                                 A46776 06770021
         LA    RTTRPTR,ALLOCD2          POINT TO LAST LOAD       A46776 06780021
         B     EXIT6B                   GO XCTL                  A46776 06800021
TSTDIR   EQU   *                                                 A46776 06850021
         TM    TYPEFLG,DIRREQ           IS THIS A DIRECTORY REQ  A46776 06920021
         BZ    EXIT6                    BRANCH IF NO             A46776 06940021
         MVC   SLOWCCHH,DS1EXT1+TWO     SAVE LOW CCHH            A46776 06960021
*                                                                       07000000
* THIS SECTION DETERMINES IF THE DADSMTBL MUST BE RESORTED.             07020002
*                                                                       07040000
EXIT6    TM    TYPEFLG,X'42'            DIRECTORIES OR USER LABEL UL17  07060000
         BZ    EXIT6A                  BRANCH IF NO                     07080000
         CLI   ENTRYNUM,ONEENTRY        TEST FOR ONE ENTRY       A46776 07086021
         BE    EXIT6A                   YES, DO NOT SORT EXTENTS A31576 07092020
         OI    SWITCH,PRCNTL           SET PROCESS CONTROL SWITCH       07100000
         LA    R2,ENTRIES               LOAD PTR TO DADSMTBL ENTRIES    07120000
         SR    RCNT,RCNT                                                07160000
         IC    RCNT,ENTRYNUM           GET NBR OF DADSMTBL ENTRIES      07180000
         B     FIRSTPAS                GO RE-SORT THE DADSMTBL          07200000
EXIT6A   EQU   *                                                 A46776 07210021
         LA    RTTRPTR,ALLOCD1          POINT TO UPDATE MODULE   A46776 07220021
EXIT6B   EQU   *                                                 A46776 07232021
*                                                                       07280000
* BRANCH TO A SUBSEQUENT SPACE ALLOCATION MODULE.                       07300002
*                                                                       07320000
         IECRES LOAD,EXTPR=(RWKA),MODID=(RTTRPTR),BRANCH=DIRECT  Y02080 07340002
*                                                                       07760000
* THIS ROUTINE BUILDS AND WRITES F3 DSCB                                07780000
*                                                                       07800000
BLDF3    MVC   DS1DSNAM(4),THREES INSERT FORMAT THREE KEY.              07820000
         MVI   DS1FMTID,X'F3'                                           07840000
         LA    RTABL,12(RTABL)                                          07860000
         SR    RCNT,R1            COMPUTE NUMBER OF EXTENTS REMAINING.  07880000
         LA    RXPTR,DS1DSNAM           SET PTR TO EXTENT FIELD OF F3   07900000
         LA    RXNUM,3            GET EXTENT SEQ NUMBER.                07920000
         BAL   DRBAK,BIGLOOP            CREATE F3 EXTENTS               07940000
         BAL   DRBAK,DOSMC              GO SET MUST COMPLETE            07960000
WRTF3    BAL   DRBAK,BCHNLGO            WRITE F3 DSCB                   07980000
         MVC   DS1PTRDS(5),IDAREA       MOVE CHAIN ADDRESS TO F1        08000000
         XC    DS1DSNAM+45(90),DS1DSNAM+45    ZERO DSCB.                08020000
         LA    RCNT,3             INSERT NUMBER OF EXT IN F1            08040000
         LH    RTABL,DS4DSREC           GET NUMBER OF AVAIL HOLES       08060000
         BCTR  RTABL,0                  DECREMENT COUNT BY ONE          08080000
         STH   RTABL,DS4DSREC           RESET NUMBER OF AVAIL HOLES     08100000
         B     RESET1                                                   08120000
*                                                                       08140000
* THIS SECTION LINKS WITH IOS FOR ALL I/O OPERATIONS                    08160000
*                                                                       08180000
BCHNLGO  EQU   *                                                  13559 08200016
         MVC   SEEK+3(4),VTOCADR       INSERT SEEK ADDRESS        13559 08220016
         LA    R0,CCW1                 START CHANNEL PROGRAM ...  13559 08240016
         ST    R0,IOB+16                  AT CCW1.                13559 08260016
         MVI   ECB,X'00'               CLEAR STATUS BYTE          13559 08280016
         EXCP  IOB                     SEARCH FOR F0              13559 08300016
         WAIT  ECB=ECB            WAIT FOR COMPLETION.                  08320000
         TM    ECB,X'20'               TEST FOR PERMANENT I/O ERROR.    08340000
         BZ    IOERROR                 BRANCH IF ERROR            13559 08342016
         MVC   CCW7+4(4),CCW2          SAVE CCW2                  13559 08344016
         LA    R0,CCW6                                            13559 08346016
         ST    R0,CCW2                 PREPARE TO TIC TO CCW6     13559 08348016
         MVI   CCW2,X'08'              INSERT TIC OP CODE         13559 08350016
         MVI   CCW6,X'B1'              MULTI-TRACK SEARCH         13559 08352016
         MVI   ECB,X'00'               CLEAR STATUS BYTE          13559 08354016
         EXCP  IOB                     WRITE DSCB                 13559 08356016
         WAIT  ECB=ECB                                            13559 08358016
         MVC   CCW2(4),CCW7+4          RESTORE CCW2               13559 08360016
         MVI   CCW6,X'31'              SINGLE TRACK SEARCH        13559 08362016
         TM    ECB,X'20'               TEST FOR PERM I/O ERROR    13559 08364016
         BCR   5,DRBAK                 RETURN IF NO ERROR         13559 08366016
*                                                                       08380000
* ERROR - PERMANENT I/O ERROR                                           08400000
*                                                                       08420000
IOERROR  EQU   *                                                  13559 08430016
         LA    RERRPASS,X'0C'           SET ERROR CODE 'PERM I/O ERROR  08440000
         B     ERREXIT                  GO XCTL                  A46776 08450021
*                                                                       08460021
* LINK TO THE STATUS ROUTINE TO PERFORM A STEP MUST COMPLETE            08470002
*                                                                       08480021
DOSMC    EQU   *                        SET STEP MUST COMPLETE   YM3995 08482002
         STM   RJFCB,RBAK,REGSAVEA      SAVE REGISTERS 11-14     YM3995 08490002
         LR    R3,RWKA                  SAVE WORK AREA ADDRESS   YM3995 08500002
GETLOCK  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  YM3995X08510002
               RELATED=(LOCAL,IGG0325E(RLSELOCK))  OBTAIN LOCK   YM3995 08520002
         LM    RJFCB,RBAK,REGSAVEA-ALLOCWKA(R3)  RESTORE REGS    YM3995 08530002
*                                                                       08540002
         L     RCVT,CVTPTR              LOAD CVT ADDRESS         YM3995 08550002
         L     RCVT,CVTABEND            LOAD SECONDARY CVT PTR   YM3995 08560002
         USING SCVTSECT,RCVT            2NDRY CVT ADDRESSABILITY YM3995 08570002
         L     RCVT,SCVTSTAT            LOAD STATUS EP ADDRESS   YM3995 08580002
         LA    R0,STEPMC                INDICATE STEP MC         YM3995 08590002
         XR    R1,R1                    INDICATE STATUS SET      YM3995 08600002
*                                                                       08610002
         BALR  RBAK,RCVT                LINK TO STATUS ROUTINE   YM3995 08620002
*                                                                       08630002
RLSELOCK EQU   *                        RELEASE THE LOCK         YM3395 08640002
         STM   RJFCB,RBAK,REGSAVEA      SAVE REGISTERS 11-14     YM3995 08650002
         LR    R3,RWKA                  SAVE WORK AREA ADDRESS   YM3995 08660002
         SETLOCK RELEASE,TYPE=LOCAL,                             YM3995X08670002
               RELATED=(LOCAL,IGG0325E(GETLOCK))  RELEASE LOCK   YM3995 08672002
         LM    RJFCB,RBAK,REGSAVEA-ALLOCWKA(R3)  RESTORE REGS    YM3995 08674002
*                                                                       08680000
         OI    DSMADTB2,DSMSMCE         SET ENQ'ED SMC SWITCH    Y02144 08690002
         OI    TYPEFLG,SMCDONE          TURN ON SMC SWITCH              08700000
         BR    DRBAK                                                    08720000
*                                                                       08740000
* * * * * * * * * * * * *                                               08760000
*                                                                       08780000
***   CONSTANTS                                                         08800000
*                                                                       08820000
* * * * * * * * * * * * *                                               08840000
*                                                                       08860000
FIVE     DC    H'5'                                                     08880000
THREES   DC    X'03030303'                                              08900000
SYSCODE  DC    CL13'IBMOSVS2'           SYSTEM CODE             ZA00704 08950002
MRACDEF  RACDEF DSTYPE=N,               RACDEF MASTER          @Z40RSGDX08960032
               TYPE=DEFINE,             PARAMETER LIST         @Z40RSGDX08970032
               MF=L                                            @Z40RSGD 08972032
LRACDEF  EQU   *-MRACDEF                LENGTH RACDEF          @Z40RSGD 08974032
*                                                                       08980000
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         09000002
*                                                                       09020000
         XCTLTABL ID=(ALLOCD1,5G,ALLOCD2,5H),SVC=032,BRT=YES,    Y02080X09030002
               LENGTH=                                           Y02080 09080002
*                                       PARAMETER LIST         @Z40RSGD 09122032
         SPACE 2                                                 Y02080 09130002
         IECDSECS CVT,PSA,SCVT,TCB,JSCB,EXPAND=YES               YM3995 09140032
DSCBWKAR IECALLWA EP,F4,D1=(1),D2=(5),ADT=YES  ALLOCATE WORKAREA Y02144 09180002
ZEROS    EQU   CCW4+4                                                   09880000
SWITCH   EQU   ASWITCH                  ALLOCATE SWITCH EQUATE   Y02080 09930002
ENTRYNUM EQU   AENTRYNM                 NUMBER OF ENTRIES EQUATE Y02080 09980002
ENTRIES  EQU   AENTRIES                 EQUATE FOR AENTRIES      Y02080 10030002
REGSAVEA EQU   IECREGSV+12              REGISTER SAVE AREA       Y02080 10060002
RACDEF   EQU   REGSAVEA                 RACDEF PARAMETER LIST  @Z40RSGD 10110032
         EJECT                                                   Y02080 11350002
JFCBFLD  DSECT                                                          11480000
         IEFJFCBN                                                       11500000
         EJECT                                                   Y02080 11502002
*                                                                       11510021
* * * * * * * * * * * * *                                               11520021
*                                                                       11530021
***   DSECT FOR THE PARTIAL DSCB PASSED TO ALLOCATE BY IEHMOVE   A46776 11540021
*                                                                       11550021
* * * * * * * * * * * * *                                               11552021
*                                                                       11554021
         ORG   INFMJFCB                                                 11556021
PD1DSNAM DS    CL44                DATA SET NAME                        11558021
PD1FMTID DS    CL1                 FORMAT IDENTIFIER                    11558421
PD1DSSN  DS    CL6                 DATA SET SERIAL NUMBER               11558821
PD1VOLSQ DS    XL2                 VOLUME SEQUENCE NUMBER               11559221
PD1CREDT DS    XL3                 CREATION DATE                        11559621
PD1EXPDT DS    XL3                 EXPIRATION DATE                      11559721
PD1NOEPV DS    XL1                 NUMBER OF EXTENTS ON VOLUME          11559821
PD1NOBDB DS    XL1                 NUMBER OF BYTES USED IN LAST         11559921
*                                     DIRECTORY BLOCK                   11566621
         DS    XL1                 RESERVED                             11568621
PD1SYSCD DS    CL13                SYSTEM CODE                          11570621
         DS    XL7                 RESERVED                             11572621
PD1DSORG DS    XL2                 DATA SET ORGANIZATION                11573021
PD1RECFM DS    XL1                 RECORD FORMAT                        11573121
PD1OPTCD DS    XL1                 OPTION CODE                          11573221
PD1BLKL  DS    XL2                 BLOCK LENGTH                         11575421
PD1LRECL DS    XL2                 RECORD LENGTH                        11577421
PD1KEYL  DS    XL1                 KEY LENGTH                           11577521
PD1RKP   DS    XL2                 RELATIVE KEY POSITION                11577621
PD1DSIND DS    XL1                 DATA SET INDICATORS                  11577721
PD1SCALO DS    XL4                 SECONDARY ALLOCATION                 11578421
PD1LSTAR DS    XL3                 LAST USED TRACK AND BLOCK ON TRACK   11578821
PD1TRBAL DS    XL2                 BYTES REMAINING ON LAST TRACK USED   11579221
         DS    XL2                 RESERVED                             11584421
PD1EXT1  DS    XL1                 EXTENT TYPE INDICATOR                11586421
         DS    XL2                 UNUSED                               11588421
PDPRIQTY DS    F                   PRIMARY SPACE REQUEST IN TRACKS      11588821
PDDIRQTY DS    F                   NUMBER OF DIRECTORY BLOCKS           11589221
         END   IGG0325E                                          S21042 51700021
