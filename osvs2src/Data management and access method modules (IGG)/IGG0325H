 TITLE 'IGG0325H - DADSM - UPDATE FORMAT 4 DSCB AND RETURN'      Y02080 00020002
IGG0325H CSECT                                                          00023021
*                                                                       00025002
*MODULE NAME = IGG0325H                                                 00025402
*                                                                       00025802
*DESCRIPTIVE NAME = DADSM - UPDATE FORMAT 4 DSCB AND RETURN             00025902
*                                                                       00027102
*COPYRIGHT = NONE                                                       00029102
*                                                                       00029502
*CHANGE ACTIVITY = SEE BELOW                                            00029902
*                                                                       00030302
*          RELEASE 16 DELETIONS                                         00030602
*1462044000,045200                                                 AAAA 00031802
*          RELEASE 17 DELETIONS                                         00033002
*          RELEASE 18 DELETIONS                                         00034202
*          RELEASE 19 DELETIONS                                         00035402
*0783027600,028600-028800,030200,031600-033400,034600,042000,    O19117 00036602
*0783044400,045600,049000,050200-054000                          O19117 00037802
*          RELEASE 20 DELETIONS                                         00039002
*3033046600                                                      S20201 00040202
*          RELEASE 21 DELETIONS                                         00041402
*1197002600,004800-005000,019600-019800,020200-020400,064200     A37199 00042602
*1197000230,000600-001800,004200,005400,006400,008400-008800,    S21042 00043802
*1197082460                                                      S21042 00045002
*1197017800,021400,022800,023200,024409-024427,025600-026200,    S21042 00046202
*1197027700,028000-028540,030000,032600,034600,037200,038200-    S21042 00047402
*1197038400,040200-040400,048000,057600,058000,058400,059800,    S21042 00048602
*1197083000                                                      S21042 00049802
*0000000950,006280-006520,027612,027741-027744,027753,033800,    A46776 00051002
*0000034800-036400,036800,037100,037800,038100,038600,054200-    A46776 00052202
*0000055000,058400-059800,061800,080100,082520-082800            A46776 00053402
*0000039200,046600,057110-057200                                SA49351 00054602
*          RELEASE 22 DELETIONS                                         00055802
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00057002
*0000000030-000200,000470-000500,001250,001550-001750,002600-    Y02080 00058202
*0000003000,004800-005200,006200,007400-007800,008400-008600,    Y02080 00059402
*0000009200,010000,018200,020000-020300,024429,024490,027000,    Y02080 00060602
*0000027648-027654,027663-027699,027693-027702,027711,027726,    Y02080 00061802
*0000027732,027900-028100,029000,033800,034600-034700,035400,    Y02080 00063002
*0000037100,037420-037580,038200,038400,038600,039200-040800,    Y02080 00064202
*0000043900,044100,045100,045300,045600-045620,045644-045652,    Y02080 00065402
*0000045654-045655,045690-045700,046580-046600,047000,056970-    Y02080 00066602
*0000057040,058000,058400-082000,082040-082160                   Y02080 00067802
*0000082020-082040                                               Y02078 00069002
*0000045400                                                      Y02144 00070202
*0000024445-024454,024467-024470,045650-045660.057410            YM3048 00070602
*0000020300-020400,059700                                        XM2969 00071002
*0000045670-045730                                               YM3997 00071102
*                                                                       00071402
*STATUS CHANGE LEVEL 005                                                00072602
*                                                                       00073237
*OZ28204  ACQUIRE DIRECTORY SPACE FOR MSS VIRTUAL VOLUMES       OZ28204 00073437
*OZ28204  ADDITIONS AND CHANGES                                 OZ28204 00073637
*008100,022500,024425,024592-024596,035860,037400-037460,       OZ28204 00073837
*038440-038720,482800-485800                                    OZ28204 00074037
*                                                                       00074237
*FUNCTION/OPERATION: THIS MODULE CONVERTS THE CCHHR OF THE FORMAT 1   * 00075021
*   DSCB TO A TTR AND STORES IT IN THE JFCB FOR TASK SCHEDULER        * 00085021
*   ALLOCATION REQUESTS OR IN THE PARTIAL DSCB FOR UTILITY SPACE      * 00095021
*   ALLOCATION REQUESTS. IT ALSO CONVERTS THE CCHHR OF A DUPLICATE    * 00105021
*   NAME DSCB FOR UTILITY SPACE ALLOCATION REQUESTS. THIS MODULE      * 00115021
*   WRITES A FORMAT 0 DSCB, IF REQUIRED, AND WRITES THE UPDATED       * 00125002
*   FORMAT 4 DSCB INTO THE VTOC. IF DIRECTORIES ARE REQUESTED, IT     * 00135021
*   SETS UP THE DEB FOR CVOL TO WRITE DIRECTORIES. OTHERWISE, IT      * 00145021
*   FREES ANY WORK AREAS AND RETURNS.  FOR ERROR CONDITIONS, IT LOADS * 00155002
*   THE ERROR CODE INTO REGISTER 15 BEFORE RETURNING.  AN RMC/DEQ OR  * 00165002
*   A DEQ IS PERFORMED BEFORE A BRANCH TO IGG0CLF2 (CVOL) OR A RETURN.* 00175002
*   IF AN I/O ERROR HAS OCCURRED IN AN ALLOCATE FUNCTION, THIS MODULE * 00185002
*   ISSUES MESSAGE IEC603I WITH CODE=0 TO THE OPERATOR.               * 00195002
*                                                                     * 00200000
*ENTRY POINTS:                                                        * 00220000
*        IGG0325H - ENTRY IS MADE FROM IGG0325E ON ZERO QUANTITY      * 00240000
*   REQUESTS, FROM IGG0325G ON ALL SPACE REQUESTS, AND ON AN ERROR    * 00260002
*   CONDITION FROM IGG0325T OR FROM ANY ALLOCATE MODULE (EXCEPT ISAM  * 00280002
*   ALLOCATE AND VIO ALLOCATE) THAT ENCOUNTERED THE ERROR.            * 00300002
*                                                                     * 00320000
*INPUT: WORK AREA USED BY PREVIOUS DADSM MODULES, THE UPDATED         * 00340000
*   FORMAT 4 DSCB IN THE WORK AREA, AND A CHANNEL PROGRAM TO WRITE    * 00360000
*   OUT THE UPDATED FORMAT 4 DSCB AND A ZERO RECORD IF REQUIRED.      * 00380000
*   ALSO ON ERROR CONDITIONS THE ERROR CODE PASS REGISTER (8) WILL    * 00400000
*   CONTAIN THE APPROPRIATE CODE FOR THE ERROR ENCOUNTERED. IF        * 00420021
*   DIRECTORIES WERE REQUESTED THE LOW CCHH FROM THE FIRST EXTENT     * 00440000
*   ALLOCATED TO THIS REQUEST WILL BE IN THE WORK AREA.               * 00460000
*   IF A DUPLICATE NAME DSCB WAS FOUND, THE WORK AREA WILL CONTAIN    * 00528021
*   THE CCHHR OF THE NEXT DSCB. ALSO, IF A FORMAT 1 DSCB WAS CREATED, * 00536021
*   THE WORK AREA WILL CONTAIN THE CCHHR OF THIS F1 DSCB. IF AN SMC   * 00544021
*   WAS PERFORMED, THE SET MUST COMPLETE INDICATOR WILL BE ON.        * 00552021
*                                                                     * 00560000
*OUTPUT: UPDATED FORMAT 4 DSCB AND A ZERO RECORD DSCB IF REQUIRED.    * 00580000
*   ON DIRECTORY REQUESTS THE WORK AREA WILL CONTAIN A DEB WITH THE   * 00600000
*   REQUIRED DATA FOR CVOL.  REGISTERS 1 AND 2 WILL ALSO CONTAIN      * 00620002
*   ADDITIONAL DATA FOR CVOL.  THE JFCB OR THE PARTIAL DSCB WILL      * 00628021
*   CONTAIN THE TTR OF THE F1 DSCB FOR BOTH SCHEDULER AND UTILITY     * 00636021
*   SPACE ALLOCATION REQUESTS AND THE TTR OF ANY DUPLICATE NAME DSCB  * 00644021
*   FOR UTILITY SPACE REQUESTS.                                       * 00652021
*                                                                     * 00660000
*EXTERNAL ROUTINES:                                                   * 00680000
*        EXCP(0) - READ FROM OR WRITE TO DIRECT ACCESS DEVICE         * 00700000
*        WAIT(1) - WAIT ON EVENT CONTROL BLOCK                        * 00720000
*        IECRES  - FREE WORK AREA(S), BRANCH TO ANOTHER MODULE        * 00740002
*        WTO(35) - WRITE MESSAGE TO OPERATOR                          * 00770002
*        DEQ(48) - RELEASE MUST COMPLETE AND DEQ THE VTOC             * 00800000
*        MSS(126)- ACQUIRE VIRTUAL VOLUME SPACE                OZ28204* 00810037
*                                                                     * 00820000
*EXITS:                                                               * 00830021
*   NORMAL - CLEAR REGISTER 15 AND RETURN TO THE EXIT PROLOG ADDRESS  * 00840002
*            BRANCH TO IGG0CLF2 (CVOL) TO BUILD REQUESTED DIRECTORIES * 00850002
*   ERROR  - PUT ERROR CODE INTO REGISTER 15 AND RETURN VIA CVTEXPRO  * 00860002
*                                                                     * 00900000
*   ERROR CODES THAT CAN BE ISSUED BY MODULE IGG0325H:                * 00920002
*                                                                     * 00940000
*   0C - PERMANENT I/O ERROR                                          * 00960000
*                                                                     * 00980000
*TABLES/WORK AREAS: ALLOCATE WORK AREA DESCRIBED BY MACRO 'IECALLWA'  * 01000002
*                                                                     * 01020000
*              ***************************************                * 01040000
*              *             DADSM TABLE             *                * 01060000
*              ***************************************                * 01080000
*                                                                     * 01100000
*              ***************************************                * 01120000
*              *        *         *                  *                * 01140000
*              *  TYPE  *  NO OF  *     USED HOLE    *                * 01160000
*              *  FLAG  * ENTRIES *      COUNTER     *                * 01180000
*              *        *         *                  *                * 01200000
*              ***************************************                * 01220000
*              *                  *                  *                * 01240000
*              *       RTA        *      RTA+1       *                * 01260000
*              *                  *                  *                * 01280000
*              ***************************************                * 01300000
*              *                  *                  *                * 01320000
*              *       RTA        *      RTA+1       *                * 01340000
*              *                  *                  *                * 01360000
*              ***************************************                * 01380000
*              *                  *                  *                * 01400000
*              *       RTA        *      RTA+1       *                * 01420000
*              *                  *                  *                * 01440000
*              ***************************************                * 01460000
*              *                  *                  *                * 01480000
*              *       RTA        *      RTA+1       *                * 01500000
*              *                  *                  *                * 01520000
*              ***************************************                * 01540000
*              *                  *                  *                * 01560000
*              *       RTA        *      RTA+1       *                * 01580000
*              *                  *                  *                * 01600000
*              ***************************************                * 01620000
*                                                                     * 01640000
*              TYPEFLG  =  02 - BPAM DIRECTORIES REQUESTED.           * 01660000
*                                                                     * 01680000
*                       =  40 - USER LABELS REQUESTED                 * 01684021
*                                                                     * 01688021
*                       =  80 - SET MUST COMPLETE IS ACTIVE           * 01692021
*                                                                     * 01696021
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.  * 01700000
*                                                                     * 01720000
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.      * 01740000
*                                                                     * 01760000
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT* 01780021
*                                                                     * 01800000
*ATTRIBUTES: REENTRANT                                                * 01820002
*                                                                     * 01840000
*NOTES:                                                               * 01860000
*   OTHER MACROS USED                                                 * 01880000
*   CVT - CVT MACRO EXPANSION                                         * 01890002
*   IECSDSL1 - BUILD DSCB'S                                           * 01900000
*   IECALLWA - ALLOCATE WORK AREA MACRO EXPANSION                     * 01910002
*   IEFJFCBN - BUILD JFCB                                             * 01920000
*                                                                     * 01940000
*                                                                     * 02000002
*STORAGE: PROGRAM CODE - LESS THAN 1024 BYTES                         * 02020002
*   WORK AREA - AS DEFINED IN THE IECALLWA MACRO                 XM2969 02030002
*   RPS WORK AREA - AS DEFINED IN THE IECRPS MACRO               XM2969 02040002
*                                                                     * 02060000
*                                                                       02080000
*REGISTER USAGE-                                                        02100000
*                                                                       02120000
RZERO    EQU   0                  REGISTER ZERO                  S21042 02130021
RONE     EQU   1                  REGISTER ONE                   S21042 02140021
R1       EQU   1                  XCTL TO CVOL REGISTER                 02160000
R2       EQU   2                  XCTL TO CVOL REGISTER                 02180000
RTWO     EQU   2                  REGISTER TWO                   S21042 02184021
RTTR     EQU   2                  POINTER TO TTR FIELD           S21042 02188021
ALTRWKA  EQU   3                  ALTERNATE WORKAREA POINTER     S21042 02192021
RWORK    EQU   3                  WORK REGISTER                  S21042 02196021
R3       EQU   3                  XCTL TO CVOL REGISTER                 02200000
R4       EQU   4                  XCTL TO CVOL REGISTER                 02220000
R5       EQU   5                  XCTL TO CVOL REGISTER                 02240000
DSAVREG  EQU   5                  PO DIRECTORY REQUEST SAVE REG OZ28204 02250037
R6       EQU   6                  HOLD ERROR CODE REGISTER              02260000
R7       EQU   7                        WORK REGISTER            O19117 02270019
RCHP     EQU   7                  CHANNEL PROGRAM START POINTER  S21042 02280021
RUCBPTR  EQU   7                        UCB POINTER              Y02078 02290002
RERRPASS EQU   8                        ERROR PASS REGISTER             02300000
RERRSAVE EQU   9                  ERROR CODE SAVE REGISTER       S21042 02320021
RJFCB    EQU   11                 JFCB POINTER                          02340000
RBASE    EQU   12                 BASE REGISTER                         02360000
RWKA     EQU   13                 WORK AREA POINTER.                    02380000
RBAK     EQU   14                 RETURN REGISTER                       02400000
RWRK     EQU   15                 WORK REGISTER                         02420000
RERR     EQU   15                 ERROR CODE REGISTER                   02440000
RCVT     EQU   15                 POINTER TO CVT                 S21042 02440421
*                                                                       02440921
* OTHER EQUATES                                                         02441421
*                                                                       02441921
ZERO     EQU   0                        VALUE ZERO               S21042 02442421
ONE      EQU   1                        CONSTANT OF 1           OZ28204 02442537
TWO      EQU   2                        CONSTANT OF 2            A46776 02442621
K3       EQU   3                        CONSTANT OF 3            Y02080 02442802
K4       EQU   4                        CONSTANT OF 4            XM2969 02443202
FOURCH   EQU   4                        CONSTANT NUMBER 4        S20201 02443620
K12      EQU   12                       CONSTANT OF 12           Y02080 02444002
APDIS    EQU   28                       DISP. TO AVT ADDR IN DEB S20201 02446320
DEBSCCHH EQU   38                       DISP. TO STARTING CCHH   Y02080 02446402
AVTDS    EQU   120                      DISP. TO AVT PTR. IN     S20201 02447220
*                                       W.A.                     S20201 02448120
DIRFBIT  EQU   X'04'                    VTOC INTERRUPT BIT       O19117 02450019
UCBADDR  EQU   32                       DISP. TO UCB ADDR IN DEB Y02078 02451002
UUU      EQU   37                       DISP. TO UUU IN MESSAGE  Y02078 02452002
VOLSER   EQU   41                       DISP. TO VOLSER IN MSG   Y02078 02453002
ZEROFLAG EQU   X'00'                    ZERO FLAGS FOR READ      XM2969 02455002
WRTCCW   EQU   X'0D'                    WRITE CCW CODE           XM2969 02457002
READCCW  EQU   X'0E'                    READ CCW CODE            XM2969 02459002
CYLBOUND EQU   X'C0'                    CYLINDER ALLOCATION     OZ28204 02459237
CYLROUND EQU   X'01'                    ROUND ALLOCATION        OZ28204 02459437
VIRTDASD EQU   X'08'                    VIRTUAL DASD BIT        OZ28204 02459637
*                                                                       02460000
* * * * * * * * * * * * *                                               02480000
*                                                                       02500000
*                                                                       02520000
* * * * * * * * * * * * *                                               02540000
*                                                                       02640000
         BALR  RBASE,0                                                  02660000
         USING START,RBASE                                              02680000
         USING ALLOCWKA,RWKA            WORK AREA ADDRESSABILITY Y02080 02700002
         USING JFCBFLD,RJFCB                                            02720000
         USING CVT,RCVT                                          S21042 02730021
*                                                                       02740000
START    EQU   *                                                 O19117 02750019
         XI    DS4VTOCI,DIRFBIT         RESET/SET DIRF BIT       O19117 02760019
         LR    RERRSAVE,RERRPASS        SAVE ERROR CODE          S21042 02760321
         CH    RERRPASS,DUPNAME         TEST IF DUP NAME DSCB    S21042 02760621
         BNE   NOERRTST                 BRANCH IF NOT            S21042 02760921
         LTR   RJFCB,RJFCB              TEST FOR PARTIAL DSCB    A46776 02761221
         BP    NOERRTST                 BRANCH IF NOT            S21042 02761521
         SR    RWORK,RWORK              CLEAR REGISTER           S21042 02761821
         IC    RWORK,IDAREA+4           GET RECORD NUMBER        S21042 02762121
         BCT   RWORK,SAVEREC            DECREMENT RECORD NUMBER  S21042 02762421
         IC    RWORK,DS4DEVDT           SET RECORD NUMBER TO     S21042 02762721
*                                       MAX NUMBER OF DSCB'S/TRK S21042 02763021
SAVEREC  EQU   *                                                 S21042 02763321
         STC   RWORK,IDAREA+4                                    S21042 02763621
         MVC   CCHHR(5),IDAREA          MOVE IN CCHHR            S21042 02763921
         B     CONVERT                  GO CONVERT CCHHR TO TTR  S21042 02764221
NOERRTST EQU   *                                                 S21042 02764521
         LTR   RERRPASS,RERRPASS        TEST FOR ERROR CODE OF 0 S21042 02765721
         BNZ   TESTDIRF                 BRANCH IF NOT            S21042 02766021
*                                                                       02767221
* CONVERT THE F1 DSCB CCHHR OR THE DUPLICATE NAME CCHHR TO A TTR        02767521
* USING THE RESIDENT CONVERSION ROUTINE.                                02767821
*                                                                       02768121
CONVERT  EQU   *                                                 S21042 02768421
         LA    R1,DEB                   POINTER TO DEB           S21042 02768721
         LA    R2,MBBCCHHR              POINTER TO MBBCCHHR      S21042 02769021
         XC    MBBCCHHR,MBBCCHHR        CLEAR CONVERT AREA       Y02080 02769402
         MVC   MBBCCHHR+K3(L'CCHHR),CCHHR  MOVE IN F1 CCHHR      Y02080 02769602
         STM   RERRSAVE,RWKA,IECREGSV+K12 SAVE REGISTERS         Y02080 02770202
         LR    ALTRWKA,RWKA             GET POINTER TO WORKAREA  S21042 02770521
         DROP  RWKA                                              S21042 02770821
         USING ALLOCWKA,ALTRWKA         WORK AREA ADDRESSABILITY Y02080 02771102
         L     RCVT,CVTPTR              LOAD CVT BASE            S21042 02771421
         L     RCVT,CVTPRLTV            LOAD TTR CONVERT ROUTINE S21042 02771721
*                                       BASE                     S21042 02772021
         BALR  RBAK,RCVT                CONVERT CCHHR            S21042 02772321
         LM    RERRSAVE,RWKA,IECREGSV+K12 RESTORE REGISTERS      Y02080 02772602
         DROP  ALTRWKA                                           S21042 02772921
         USING ALLOCWKA,RWKA            WORK AREA ADDRESSABILITY Y02080 02773202
         ST    RZERO,FULLWORD                                    S21042 02773521
         DROP  RCVT                                              S21042 02773821
         LTR   RJFCB,RJFCB              TEST FOR PARTIAL DSCB    A46776 02774121
         BP    NOTPDSCB                 BRANCH IF NO             A46776 02774421
         LA    RTTR,DSCBTTR             POINT TO TTR FIELD       S21042 02774721
         B     STORETTR                 GO MOVE IN TTR           S21042 02775021
NOTPDSCB EQU   *                                                 A46776 02775321
         LA    RTTR,JFCBDSCB            POINT TO TTR FIELD       S21042 02775621
STORETTR EQU   *                                                 S21042 02775921
         MVC   0(3,RTTR),FULLWORD       MOVE IN TTR              S21042 02776221
         LTR   RERRSAVE,RERRSAVE        TEST FOR ERROR CODE OF 0 S21042 02776521
         BE    TSTZERO                  BRANCH IF YES                   02780000
TESTDIRF EQU   *                                                 S21042 02820021
         TM    DS4VTOCI,DIRFBIT         TEST RESULTS             O19117 02861019
         BO    ERREXIT                  BR IF PREVIOUS INTERRUPT O19117 02868019
         CH    RERRPASS,IOCODE          Q - I/O ERROR            O19117 02875019
         BE    ERREXIT                  IF YES, BR               O19117 02882019
         B     WRITEF4                  GO WRITE F4              O19117 02889019
*                                                                       02891021
* WRITE A ZERO RECORD IF NECESSARY.                                     02893021
*                                                                       02895021
TSTZERO  EQU   *                        TEST TO WRITE AN F0      Y02080 02897002
         TM    ACNVSW,AF5ZERO           DOES F5 WITH ALL ZERO    XM2969 02899002
*                                       EXTENTS EXIST            XM2969 02899402
         BNO   READPREV                 NO, BYPASS READING       XM2969 02899802
*                                       PREVIOUS F5              XM2969 02899902
         TM    ASWITCH,FRSTF5           IS FIRST F5 IN CORE      XM2969 02906602
*                                       INDICATOR SET            XM2969 02908602
         BO    READPREV                 BRANCH IF NOT SET        XM2969 02910602
         MVC   IDAREA,ALLCCHHR          MOVE SEARCH ARGUEMENT    XM2969 02912602
         MVI   CCW11+K4,ZEROFLAG        ZERO FLAGS FOR READ      XM2969 02913002
         LA    RCHP,CCW9                ADDR OF CHAN PGM START   XM2969 02913102
         BAL   R2,CHANNLGO              BAL TO READ F5           XM2969 02913202
         MVC   FMTINAD,DS5PTRDS         SAVE CCHHR OF NEXT F5    XM2969 02919902
         XC    DS5PTRDS,DS5PTRDS        ZERO CHAIN POINTER       XM2969 02921902
         MVI   CCW11,WRTCCW             CHANGE READ CCW TO WRITE XM2969 02923902
         BAL   R2,CHANNLGO              BAL TO WRITE BACK F5     XM2969 02925902
         MVI   CCW11,READCCW            RESTORE READ CCW         XM2969 02926302
         B     SETADDR                  CONTINUE                 XM2969 02926402
READPREV EQU   *                        BRANCH LABEL             XM2969 02926502
         TM    ASWITCH,WRZERO           IS WRITE F0 DSCB PENDING Y02080 02926602
         BZ    WRITEF4                  NO - CONTINUE TESTING           02933302
SETADDR  EQU   *                        BRANCH LABEL             XM2969 02935302
         MVC   IDAREA(5),FMTINAD        SET UP ADDR OF RCD TO BE ZEROED 02940000
         XC    DS1DSNAM(140),DS1DSNAM   CLEAR OUTPUT AREA               02960000
         MVI   CCW11+4,X'10'            TURN ON SKIP FLAG               02980000
         LA    RCHP,CCW6                START CHAN PROG AT CCW6  S21042 03000021
         BAL   R2,CHANNLGO              GO WRITE AN F0           O19117 03020019
         LH    RWRK,DS4DSREC            GET NBR OF AVAIL HOLES          03040000
         LA    RWRK,1(RWRK)             INCREMENT BY ONE                03060000
         STH   RWRK,DS4DSREC            RESET HOLE COUNT                03080000
*                                                                       03100000
* THIS ROUTINE SETS UP CHANNEL PROGRAM AND WRITES F4 DSCB               03120000
*                                                                       03140000
WRITEF4  EQU   *                                                 O19117 03150019
         MVC   IDAREA(5),VTOCADR        START SEEK/SRCH ON VTOC  O19117 03160019
         LM    R2,R7,XCCW1              LOAD 1ST 3 CCW'S         O19117 03170019
         ALR   R2,RWKA                  RESOLVE                  O19117 03180019
         ALR   R4,RWKA                    CORE                   O19117 03190019
         ALR   R6,RWKA                      ADDRESSES            O19117 03200019
         STM   R2,R7,CCW1               STORE 1ST 3 CCW'S        O19117 03210019
         LM    R4,R7,XCCW5              LOAD LAST 2 CCW'S        O19117 03220019
         ALR   R4,RWKA                  RESOLVE CORE             O19117 03230019
         ALR   R6,RWKA                    ADDRESSES              O19117 03240019
         STM   R2,R7,CCW4               STORE LAST 3 CCW'S       O19117 03250019
         LA    RCHP,CCW1                START CHAN PROG AT CCW1  S21042 03260021
         BAL   R2,CHANNLGO              GO WRITE F4              O19117 03270019
*                                                                       03360000
* FOR A DIRECTORY REQUEST, THIS SECTION PREPARES TO BRANCH TO CVOL.     03380002
*                                                                       03400000
TSTDIR   TM    TYPEFLG,X'02'            ARE DIRECTORIES REQUESTED       03420000
         BZ    GOODEND                 BRANCH IF NO                     03440000
         BAL   R2,CVOLDEQ               GO DEQ VTOC BEFORE XCTL  O19117 03450019
         MVC   DEB+DEBSCCHH(FOURCH),SLOWCCHH  MOVE THE STARTING  Y02080 03540002
*                                       CCHH TO THE DEB FOR CVOL A46776 03546021
         XR    RWORK,RWORK             ZERO WORK REG            OZ28204 03586037
         LTR   RJFCB,RJFCB             TEST FOR PARTIAL DSCB     A46776 03620021
         BP    LOADDQTY                BRANCH IF NO              A46776 03640021
*                                                                       03660000
* UTILITY SPACE REQUEST - PICK UP DIRECTORY QUANTITY FROM PARTIAL DSCB  03680021
*                                                                       03700000
         L     RONE,PDDIRQTY            LOAD NUMBER OF DIRECTORY Y02080 03710002
*                                       BLOCKS REQUESTED         S21042 03720021
         IC    RWORK,PD1SCALO           LOAD ALLOCATION TYPE    OZ28204 03740037
         B     CK4MSSV                                          OZ28204 03746037
*                                                                       03760000
* NOT A UTILITY REQUEST - PICK UP DIRECTORY QUANTITY FROM THE JFCB      03780021
*                                                                       03800000
LOADDQTY EQU   *                                                 A46776 03810021
         L     RONE,JFCBDQTY            LOAD NUMBER OF DIRECTORY Y02080 03820002
*                                       BLOCKS REQUESTED         S21042 03830021
         SRL   RONE,8                   POSITION THIS NUMBER     Y02080 03840002
         IC    RWORK,JFCBCTRI           LOAD ALLOCATION TYPE    OZ28204 03844037
CK4MSSV  EQU   *                                                OZ28204 03844437
*      CHECK FOR A MSS VIRTUAL VOLUME AND ISSUE AN ACQUIRE      OZ28204 03844837
*      ORDER FOR THE DIRECTORY EXTENTS IF MSS.                  OZ28204 03845237
         L     RUCBPTR,DEB+UCBADDR      POINT TO UCB            OZ28204 03845637
         USING UCB,RUCBPTR                                      OZ28204 03846037
         TM    UCBTBYT2,VIRTDASD        MSS VIRTUAL VOLUME?     OZ28204 03846437
         BNO   LOADPTR                  NO, BY PASS ACQUIRE     OZ28204 03846837
         LR    DSAVREG,RONE             SAVE NUM OF DIRC BLKS   OZ28204 03847237
         LA    RONE,DSCBF1              POINT TO ACQUIRE LIST   OZ28204 03847637
         USING ACQLST,RONE                                      OZ28204 03848037
         XC    ACQLST(ACQLTH),ACQLST    ZERO ACQUIRE LIST       OZ28204 03848437
         MVI   ACQLST+3,ACQLTH          LENGTH OF LIST          OZ28204 03848837
         MVC   ARVOL,UCBVOLI            MOVE IN VOLSER          OZ28204 03849237
         MVI   ARNMEXTS,ONE             SET TO ONE EXTENT       OZ28204 03849637
         MVI   AROP,ACQOP               SET ACQUIRE OP CODE     OZ28204 03850037
         STC   RWORK,AREXT              PREPARE TO TEST ALLOC   OZ28204 03850437
*                                       TYPE CYL OR TRK BOUNDRY OZ28204 03850837
         TM    AREXT,CYLBOUND           CYLINDER BOUNDRY ?      OZ28204 03851237
         BO    INHIBIT                  YES, INHIBIT STAGE      OZ28204 03851637
         TM    AREXT,CYLROUND           CYLINDER BOUNDRY ?      OZ28204 03852037
         BO    INHIBIT                  YES, INHIBIT STAGE      OZ28204 03852437
         B     COMPEXT                  NO, STAGE DATA          OZ28204 03852837
INHIBIT  EQU   *                                                OZ28204 03853237
         OI    ARFLAG,INHFLG            SET INHIBIT STAGE       OZ28204 03853637
COMPEXT  EQU   *                                                OZ28204 03854037
*      COMPUTE THE CYLINDERS REQUIRED TO CONTAIN                OZ28204 03854437
*      DIRECTORY REQUEST.                                       OZ28204 03854837
         DROP  RUCBPTR                  REMOVE UCB PTR          OZ28204 03855237
         MVC   AREXT(2),SLOWCCHH        INIT BEGINING AND ENDINGOZ28204 03855637
         MVC   AREXT+2(2),SLOWCCHH      TO THE SAME CYLINDER    OZ28204 03856037
         XR    R4,R4                    ZERO WORK REG           OZ28204 03856437
         IC    R4,DS4DEVDB              R4=DIRC BLKS PER TRACK  OZ28204 03856837
         CR    DSAVREG,R4               REQUESTED DIRC BLKS GT  OZ28204 03857237
*                                       THAN DIRC BLKS PER TRK? OZ28204 03857637
         BNH   DOACQ                    NO , GO ISSUE ACQUIRE   OZ28204 03858037
*      COMPUTE TTR OF DIRECTORY                                 OZ28204 03858437
         XR    R2,R2                    ZERO WORK REG           OZ28204 03858837
         LR    R3,DSAVREG               R3=NUMBER OF DIRC REQ.  OZ28204 03859237
         DR    R2,R4                    R3=TT OF DIREC EXTENT   OZ28204 03859637
         LTR   R2,R2                    R4=REMAINDER ?          OZ28204 03860037
         BZ    STOREXT                  NO , ON TRK BOUNDRY     OZ28204 03860437
         LA    R3,1(R3)                 ROUND TO NEXT TRACK     OZ28204 03860837
STOREXT  EQU   *                                                OZ28204 03861237
*      CONVERT TTR TO MBBCCHHR                                  OZ28204 03861637
         LR    RZERO,R3                 R0=XXTT                 OZ28204 03862037
         SLL   RZERO,16                 R0=TTRN                 OZ28204 03862437
         LA    R2,AREXT+4               R2=POINTER TO MBBCCHHR  OZ28204 03862837
         LA    RONE,DEB                 R1=POINTER TO DEB       OZ28204 03863237
         STM   RERRSAVE,RWKA,IECREGSV+K12 SAVE REGS             OZ28204 03863637
         LR    ALTRWKA,RWKA             USE ALTRN WORK AREA REG OZ28204 03864037
         DROP  RWKA                                             OZ28204 03864437
         USING ALLOCWKA,ALTRWKA                                 OZ28204 03864837
         L     RCVT,CVTPTR              POINT CONVERT ROUTINE   OZ28204 03865237
         USING CVT,RCVT                                         OZ28204 03865637
         L     RCVT,CVTPCNVT                                    OZ28204 03866037
         BALR  RBAK,RCVT                GO TO CONVERT ROUTINE   OZ28204 03866437
         LM    RERRSAVE,RWKA,IECREGSV+K12 RESTORE REGS          OZ28204 03866837
         DROP  ALTRWKA                                          OZ28204 03867237
         USING ALLOCWKA,RWKA            RETURN TO WORK REG      OZ28204 03867637
         DROP  RCVT                                             OZ28204 03868037
         LA    RONE,DS1DSNAM            POINT TO ACQUIRE LIST   OZ28204 03868437
         MVC   AREXT+2(2),AREXT+7       SAVE ENDING CC IN LIST  OZ28204 03868837
         XC    AREXT+4(8),AREXT+4       ZERO WORK AREA USED     OZ28204 03869237
DOACQ    EQU   *                                                OZ28204 03869637
         ICBACREL  TYPE=ACQ,MF=(E,(1))  ISSUE ACQUIRE           OZ28204 03870037
*     NO TEST IS MADE FOR SUCCESSFUL COMPLETION.FORMATTING      OZ28204 03870437
*     OF DIRECTORY WILL CYLINDER FAULT IF UNSUCESSFUL.          OZ28204 03870837
         DROP  RONE                                             OZ28204 03871237
         LR    RONE,DSAVREG             RESTORE NUMBER OF REQ.  OZ28204 03871637
*                                       DIRECTORY BLOCKS        OZ28204 03872037
LOADPTR  EQU   *                                                 A46776 03872437
         SR    R2,R2                    GET NBR OF DIR/BLKS PER TRACK   03880000
         IC    R2,DS4DEVDB                                              03900000
         IECRES LOAD,EXTPR=(RWKA),MODNM=CVOLNAME,BRANCH=DIRECT   Y02080 04010002
*                                                                       04100000
* SUCCESSFUL ALLOCATION EXIT                                            04120000
*                                                                       04140000
GOODEND  SR    RERRPASS,RERRPASS        CLEAR ERROR HOLD REGISTER       04160000
*                                                                       04180000
ERREXIT  EQU   *                                                 O19117 04190019
         LA    R2,RETURN                RETURN REG EQUAL         O19117 04200019
*                                       FREEMAIN                 O19117 04210019
CVOLDEQ  MVC   MJELNAME(8),VTOCNAME     MOVE MAJOR QUE NAME TO WORKAREA 04220000
         MVI   DEQAREA,X'FF'            SET LAST ENTRY CODE             04240000
         SR    R1,R1                    CLEAR OPTION AND RTN FIELDS     04260000
         STH   R1,DEQAREA+2                                             04280000
         TM    TYPEFLG,SMCDONE          IS SET MUST COMP SWITCH ON      04300000
         BZ    NOSMC                    BRANCH IF NO                    04320000
*                                                                       04340000
* LINK TO THE DEQ ROUTINE TO RELEASE MUST COMPLETE AND DEQ THE VTOC     04360000
*                                                                       04380000
         DEQ   (MJELNAME,MIELNAME,6,SYSTEMS),RMC=STEP,MF=(E,DEQAREA)    04400016
*                                                                       04420000
         NI    DSMADTB2,X'FF'-DSMVTOCR-DSMSMCE  RESET ENQ'ED SWS Y02144 04430002
         BR    R2                                                O19117 04440019
*                                                                       04460000
* LINK TO THE DEQ ROUTINE TO DEQ THE VTOC                               04480000
*                                                                       04500000
NOSMC    DEQ   (MJELNAME,MIELNAME,6,SYSTEMS),MF=(E,DEQAREA)             04520016
*                                                                       04530002
         NI    DSMADTB2,X'FF'-DSMVTOCR  RESET VTOC ENQ'ED SWITCH Y02144 04540002
         BR    R2                       RETURN                   Y02080 04541002
*                                                                       04542002
* THIS SECTION ISSUES MESSAGE IEC603I IF AN I/O ERROR OCCURRED.         04543002
*                                                                       04544002
RETURN   EQU   *                        TEST FOR I/O ERROR       Y02080 04545002
         CH    RERRPASS,IOCODE          TEST FOR I/O ERROR       Y02078 04546002
         BNE   RPSTEST                  BRANCH IF NO I/O ERROR   Y02078 04547002
         MVC   DSCBF1(MSGEND-ERRMSG),ERRMSG  MOVE IN MESSAGE     Y02078 04548002
         L     RUCBPTR,DEB+UCBADDR      LOAD UCB ADDRESS         Y02078 04549002
         USING UCB,RUCBPTR              UCB ADDRESSABILITY       Y02078 04550002
         MVC   DSCBF1+UUU(L'UCBNAME),UCBNAME  MOVE IN EBCDIC     Y02078 04551002
*                                       CHANNEL/UNIT ADDRESS     Y02078 04552002
         MVC   DSCBF1+VOLSER(L'SRTEVOLI),SRTEVOLI  MOVE IN VOLID Y02078 04553002
         WTO   MF=(E,DSCBF1)            ISSUE ERROR MESSAGE      Y02078 04554002
*                                                                       04555002
RPSTEST  EQU   *                        TEST FOR RPS             Y02078 04556002
         TM    DSMADTB1,DSMRPSAP        TEST IF RPS APPENDAGE    YM3048X04558002
                                        IGG019EK WAS LOADED      YM3048 04560002
         BNO   CONTINUE                 BRANCH IF NOT            YM3048 04562002
         L     RONE,DEB+APDIS           POINT TO APPENDAGE TABLE S20201 04563020
         MVC   DEB+APDIS(FOURCH),AVTDS(RONE) RESTORE DEB AVT PTR YM3997 04567002
         NI    DSMADTB1,X'FF'-DSMRPSAP  RESET RPS APP LOADED SW  Y02144 04575002
*                                                                       04580000
* FREE WORK AREA IF SUCCESSFUL ALLOCATION OR IF UNABLE TO COMPLETE      04600000
* ALLOCATION                                                            04620000
*                                                                       04640000
CONTINUE EQU   *                                                 S20201 04650020
         IECRES FREE,PREFIX=FIRST,A=(RWKA)  FREE WORK AREAS      Y02080 04660002
         USING CVT,RCVT                 CVT ADDRESSABILITY       Y02080 04662002
         L     RCVT,CVTPTR              LOAD CVT ADDRESS         Y02080 04670002
         L     RBAK,CVTEXPRO            LOAD EXIT PROLOG ADDRESS Y02080 04672002
         LR    RERR,RERRPASS            LOAD ERROR REGISTER             04680000
         RETURN ,                       RETURN                   Y02080 04710002
*                                                                       04720000
* THIS SECTION LINKS TO IOS FOR ALL I/O OPERATIONS                      04740000
*                                                                       04760000
CHANNLGO MVI   ECB,X'00'                                                04780000
         ST    RCHP,IOB+16              STORE START OF CHAN PROG S21042 04800021
         MVC   SEEK+3(4),IDAREA                                         04820000
         EXCP  IOB                                                      04840000
         WAIT  ECB=ECB                                                  04860000
         TM    ECB,X'20'                TEST FOR A PERMANENT I/O ERROR  04880000
         BNO   IOERR                    IF I/O ERROR, BR         O19117 04885019
         LTR   RERRPASS,RERRPASS        WAS THIS A FORCE F4      O19117 04890019
*                                       WRITE                    O19117 04895019
         BCR   8,R2                     IF NOT, BR               O19117 04900019
         B     ERREXIT                  YES, TAKE ERROR EXIT     O19117 04905019
IOERR    EQU   *                                                 O19117 04910019
*                                                                       04920000
* ERROR - PERMANENT I/O ERROR                                           04940000
*                                                                       04960000
         LA    RERRPASS,X'0C'           SET ERROR CODE 'PERM I/O ERROR  04980000
         B     ERREXIT                                                  05000000
*                                                                       05520000
* * * * * * * * * * * * *                                               05540000
*                                                                       05560000
***   CONSTANTS                                                         05580000
*                                                                       05600000
* * * * * * * * * * * * *                                               05620000
*                                                                       05690000
ERRMSG   WTO   'IEC603I VTOC ERRORS MAY EXIST ON UUU,VOLSER,0',  Y02078X05691002
               ROUTCDE=(4,10),DESC=4,MF=L                        Y02078 05692002
MSGEND   EQU   *                        MSG DELIMITER            Y02078 05693002
VTOCNAME DC    CL8'SYSVTOC'             MAJOR QUEUE NAME                05740000
IOCODE   DC    H'12'                    I/O ERROR CODE           O19117 05740719
DUPNAME  DC    H'4'                     DUP NAME ERROR CODE      S21042 05740821
*                                                                       05741419
* CHANNEL PROGRAM SKELETON                                              05742119
*                                                                       05742819
         DS    0F                                                O19117 05743519
XCCW1    DC    X'31'                    SEARCH ID EQUAL          O19117 05744219
         DC    AL3(IDAREA-FIRST)                                 O19117 05744919
         DC    X'4000'                                           O19117 05745619
         DC    H'5'                                              O19117 05746319
XCCW2    DC    X'08'                    TIC                      O19117 05747019
         DC    AL3(CCW1-FIRST)                                   O19117 05747719
         DC    F'0'                                              O19117 05748419
XCCW3    DC    X'05'                    WRITE DATA               O19117 05749119
         DC    AL3(DS4IDFMT-FIRST)                               O19117 05749819
         DC    X'4000'                                           O19117 05750519
         DC    H'96'                                             O19117 05751219
*XCCW4         (WILL BE DUPLICATED FROM XCCW1)                          05751919
XCCW5    DC    X'08'                    TIC                      O19117 05752619
         DC    AL3(CCW4-FIRST)                                   O19117 05753319
         DC    F'0'                                              O19117 05754019
XCCW6    DC    X'06'                    READ DATA/SKIP (WRITE    O19117 05754719
*                                       CK)                      O19117 05755419
         DC    AL3(DS4IDFMT-FIRST)                               O19117 05756119
         DC    X'1000'                                           O19117 05756819
         DC    H'96'                                             O19117 05757519
*                                                                       05780000
* TABLE OF MODULE NAMES AND ENTRY POINT ADDRESSES                       05800002
*                                                                       05820000
         XCTLTABL ID=(CVOLNAME,IGG0CLF2),SVC=032,LENGTH=,BRT=YES Y02080 05870002
         EJECT                                                   Y02080 05920002
DSCBWKAR IECALLWA EP,F4,D1=(1),D2=(5),ADT=YES ALLOCATE WORK AREA XM2969 05970002
DEQAREA  EQU   ADSCBF4                  DEQUEUE PARAMETER LIST   Y02080 08020002
MJELNAME EQU   DEQAREA+16               MAJOR ELEMENT NAME       Y02080 08040002
         SPACE 2                                                 Y02078 08090002
         IECDSECS CVT,UCB,EXPAND=YES    CVT AND UCB DSECTS       Y02078 08140002
JFCBFLD  DSECT                                                          08220000
         IEFJFCBN                                                       08240000
         EJECT                                                   Y02080 08250002
*                                                                       08290021
* * * * * * * * * * * * *                                               08340021
*                                                                       08390021
***   DSECT FOR THE PARTIAL DSCB PASSED TO ALLOCATE BY IEHMOVE   A46776 08440021
*                                                                       08490021
* * * * * * * * * * * * *                                               08540021
*                                                                       08590021
         ORG   INFMJFCB                                                 08640021
PD1DSNAM DS    CL44                DATA SET NAME                        08690021
PD1FMTID DS    CL1                 FORMAT IDENTIFIER                    08740021
PD1DSSN  DS    CL6                 DATA SET SERIAL NUMBER               08790021
PD1VOLSQ DS    XL2                 VOLUME SEQUENCE NUMBER               08840021
PD1CREDT DS    XL3                 CREATION DATE                        08890021
PD1EXPDT DS    XL3                 EXPIRATION DATE                      08940021
PD1NOEPV DS    XL1                 NUMBER OF EXTENTS ON VOLUME          08990021
PD1NOBDB DS    XL1                 NUMBER OF BYTES USED IN LAST         09040021
*                                     DIRECTORY BLOCK                   09090021
         DS    XL1                 RESERVED                             09140021
PD1SYSCD DS    CL13                SYSTEM CODE                          09190021
         DS    XL7                 RESERVED                             09240021
PD1DSORG DS    XL2                 DATA SET ORGANIZATION                09290021
PD1RECFM DS    XL1                 RECORD FORMAT                        09340021
PD1OPTCD DS    XL1                 OPTION CODE                          09390021
PD1BLKL  DS    XL2                 BLOCK LENGTH                         09440021
PD1LRECL DS    XL2                 RECORD LENGTH                        09490021
PD1KEYL  DS    XL1                 KEY LENGTH                           09540021
PD1RKP   DS    XL2                 RELATIVE KEY POSITION                09590021
PD1DSIND DS    XL1                 DATA SET INDICATORS                  09640021
PD1SCALO DS    XL4                 SECONDARY ALLOCATION                 09690021
PD1LSTAR DS    XL3                 LAST USED TRACK AND BLOCK ON TRACK   09740021
PD1TRBAL DS    XL2                 BYTES REMAINING ON LAST TRACK USED   09790021
         DS    XL2                 RESERVED                             09840021
PD1EXT1  DS    XL1                 EXTENT TYPE INDICATOR                09890021
         DS    XL2                 UNUSED                               09940021
PDPRIQTY DS    F                   PRIMARY SPACE REQUEST IN TRACKS      09990021
PDDIRQTY DS    F                   NUMBER OF DIRECTORY BLOCKS           10040021
DSCBTTR  EQU   PD1SYSCD            TTR FIELD IN PARTIAL DSCB     A46776 10090021
         EJECT                                                  OZ28204 48280037
ACQLST   DSECT                     MSS VOLUME ACQUIRE LIST      OZ28204 48330037
ACQOP    EQU   X'02'               ACQUIRE OP CODE              OZ28204 48380037
ACQLTH   EQU   96                  LENGTH OF ACQUIRE ORDER      OZ28204 48430037
INHFLG   EQU   X'20'               INHIBIT STAGE FLAG           OZ28204 48480037
         ICBACREL  TYPE=ACQ,MF=L                                OZ28204 48530037
         END   IGG0325H                                          S21042 48580037
