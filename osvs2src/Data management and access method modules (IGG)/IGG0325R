 TITLE 'IGG0325R - FORMAT 5 DSCB PROCESSING'                            00100002
IGG0325R CSECT                                                          00150021
*                                                                       00160002
* MODULE NAME = IGG0325R                                                00170002
*                                                                       00180002
* DESCRIPTIVE NAME = FORMAT 5 DSCB PROCESSING                           00190002
*                                                                       00192002
* COPYRIGHT = NONE                                                      00194002
*                                                                       00196002
* CHANGE ACTIVITY = SEE BELOW                                           00198002
*                                                                     * 00200018
*          RELEASE 19 DELETIONS                                       * 00207018
*          RELEASE 20 DELETIONS                                       * 00214018
*1026033000,054000,345000-346000                                 A31534 00217020
*1026008000-010000,013000-014000,016000-026000,032000-034000,    A31333 00218020
*1026114000,116000-118000,186000,201000-206000,223000,226000,    A31333 00219020
*1026269000,271000-274000,340000-342000,350000                   A31333 00220020
*1026190000-191000,311000,313000-315000,332000,335000            A36311 00220520
*          RELEASE 21 DELETIONS                                       * 00221018
*1191005000-010000,012500-014500,173000-175000,196000,353000,    M0124  00221721
*1191355000-364000,366000-376000,378000,381000-404000,406000-    M0124  00222421
*1191408000,414000,417000,419000-421000,428000                   M0124  00223121
*1191032800,093000,345000-346000                                 S21040 00224021
*0000001000,222000                                               A53183 00226021
*          RELEASE 22 DELETIONS                                       * 00228018
*          VS2 RELEASE 02 DELETIONS/CHANGES                           * 00235002
*0000000100-000500,002350-002630,015900-016200,019200-019500,    Y02080 00235102
*0000030000,031600,032200,032700,037000,045000,064000-071000,    Y02080 00235202
*0000073000,076000,080000,084000-092000,096000,100000-103000,    Y02080 00235302
*0000108000,121000,132000,135000,138000,142000-143000,145000-    Y02080 00235402
*0000146000,148000,160000-161000,165000-166000,170000,181000,    Y02080 00235502
*0000183100-183200,184000,185000,189000-191300,192000-193000,    Y02080 00235602
*0000193600-195600,197000-199000,225000,227000,229000,257000-    Y02080 00235702
*0000259000,261000,263000-265000,284000,286000,288000-289000,    Y02080 00235802
*0000293000,298000-299000,310300,310800,311000,318000,336000-    Y02080 00235902
*0000339000,339400,341000-365000,378000-405000,411500-418000,    Y02080 00236002
*0000424000-436000,438000,441000-442000,444000-506000            Y02080 00236102
*0000015300-024600,031300-031900,032500,033100-034600,039000,    Y02078 00236202
*0000049500-050000,072000,075500,082300-082600,086000,100000-    Y02078 00236302
*0000100100,108000-110000,132000,139000,141000-144000,149000-    Y02078 00236402
*0000151000,153000-154000,156000-158000,160000-162000,164000-    Y02078 00236502
*0000166000,182000-183100,183700,185000-187000,196600,225000,    Y02078 00236602
*0000227000-228000,230000-231000,253000,255000-261000,264000-    Y02078 00236702
*0000266000,280000,286000,288000-289000,294000-296000,306000-    Y02078 00236802
*0000320000,326000-327000,443500                                 Y02078 00236902
*                                                                     * 00270018
*STATUS CHANGE LEVEL 003                                                00277021
*                                                                     * 00284018
*                                                                     * 00300018
*                                                                     * 00400018
* FUNCTION/OPERATION  THIS MODULE SUBTRACTS THE ENTRIES IN THE DADSM  * 00500021
*   TABLE FROM THE FREE SPACE IN THE FORMAT 5 DSCB(S). IT CREATES THE * 00600021
*   2ND...NTH FORMAT 5 DSCB'S AS NECESSARY.                           * 00700021
*                                                                     * 01100018
* ENTRY POINTS                                                        * 01200018
*   IGG0325R - FROM IGG0325P TO SUBTRACT NON SPLIT-CYLINDER DATA SET  * 01260021
*                            EXTENTS FROM MULTIPLE FORMAT 5 DSCB'S    * 01320021
*              FROM IGG0325W TO SUBTRACT FORMAT 6 EXTENTS FROM THE    * 01380021
*                            FREE SPACE IN THE FORMAT 5 DSCB(S)       * 01440021
*                                                                     * 01500018
* INPUT  FROM IGG0325P                                                * 01530002
*              REGISTER 13 POINTS TO THE ALLOCATE WORK AREA, WHICH    * 01560002
*              CONTAINS THE FORMAT 4 DSCB, THE LAST FORMAT 1 OR 3     * 01590002
*              DSCB READ, AND THE FIRST FORMAT 5 DSCB.  THE SEEK      * 01620002
*              ADDRESS IN THE IOB CONTAINS THE CCHHR OF THE DSCB      * 01650002
*              BEING PROCESSED.  'CCW12' CONTAINS A TWO WORD          * 01680002
*              PARAMETER LIST CONSISTING OF THE NUMBER OF EXTENTS     * 01710002
*              IN THE DADSMTBL TO BE SUBTRACTED AND THE ADDRESS       * 01740002
*              OF THE FIRST EXTENT TO BE SUBTRACTED.                  * 01770002
*                                                                     * 01830002
*        FROM IGG0325W                                                * 01860002
*              REGISTER 13 WILL POINT TO THE ALLOCATE WORK AREA,      * 01890002
*              WHICH WILL CONTAIN THE FORMAT 4 DSCB, THE FORMAT 6     * 01920002
*              DSCB BEING PROCESSED IN 'DSCBF1', AND THE FIRST FORMAT * 01950002
*              5 DSCB IN 'DSCBF5'.  'SEEKCYL' CONTAINS THE CCHHR OF   * 01980002
*              THE FORMAT 6 DSCB IN 'DSCBF1'.  'CCW12' WILL CONTAIN   * 02010002
*              A TWO WORD PARAMETER LIST CONSISTING OF THE NUMBER     * 02040002
*              OF EXTENTS IN THE DADSMTABLE TO BE SUBTRACTED AND      * 02070002
*              THE ADDRESS OF THE FIRST EXTENT TO BE SUBTRACTED.      * 02100002
*                                                                     * 02160002
* OUTPUT TO IGG0325P                                                  * 02190002
*              REGISTER 13 POINTS TO THE ALLOCATE WORK AREA, WHICH    * 02210002
*              CONTAINS THE FORMAT 4 DSCB, THE LAST FORMAT 1 OR 3     * 02230002
*              DSCB READ, AND THE FIRST FORMAT 5 DSCB IN THE CHAIN.   * 02250002
*              'COUNT' CONTAINS THE CCHHR OF THE NEXT DSCB TO BE READ.* 02270002
*              REGISTER 1 IS ZERO TO INDICATE REENTRY FROM IGG0325R.  * 02290002
*                                                                     * 02310002
*        TO IGG0325W                                                  * 02340002
*              REGISTER 13 WILL POINT TO THE ALLOCATE WORK AREA,      * 02360002
*              WHICH WILL CONTAIN THE FORMAT 4 DSCB, THE FORMAT 6     * 02380002
*              DSCB CURRENTLY BEING PROCESSED IN 'DSCBF1', AND THE    * 02400002
*              FIRST FORMAT 5 DSCB IN 'DSCBF5'.  REGISTER 1 WILL BE   * 02420002
*              ZERO TO INDICATE REENTRY FROM IGG0325R.                * 02440002
*                                                                     * 02460002
*                                                                     * 02700018
* EXTERNAL ROUTINES                                                   * 02800018
*          EXCP(0)                                                    * 02900018
*          WAIT(1)                                                    * 03100018
*          IECRES - TO GET AND FREE WORK AREA EXTENSIONS              * 03110002
*                                                                     * 03130002
* EXITS NORMAL BRANCH TO IGG0325P TO ADD MORE NON SPLIT CYLINDER      * 03160002
*                    DATA SET EXTENTS TO THE DADSM EXTENT TABLE       * 03190002
*              BRANCH TO IGG0325W TO ADD MORE F6 EXTENTS TO THE       * 03220002
*                    DADSM EXTENT TABLE                               * 03250002
*       ERROR  BRANCH TO IGG0325T                                     * 03270002
*                                                                     * 03290021
*       ERROR CODES ISSUED BY THIS MODULE -                           * 03310002
*                                                                     * 03340002
*       0C - PERMANENT I/O ERROR                                      * 03370002
*                                                                     * 03400002
*       94 - OVERLAPPING EXTENTS IN THE VTOC                          * 03430002
*                                                                     * 03440002
*       98 - OVERLAPPING DOS SPLIT CYLINDER EXTENTS IN THE VTOC       * 03450002
*                                                                     * 03460002
* TABLES/WORKAREAS - DADSM WORKAREA                                   * 03500018
*                                                                     * 03600018
* ATTRIBUTES  REENTRANT                                               * 03700002
*                                                                     * 03800018
REGZERO  EQU   0                        WORK REGISTER            A31333 03850020
REGONE   EQU   1                        WORK REGISTER            Y02078 03900002
REENTRY  EQU   1                       INDICATES RETURN TO SECOND LOAD  04000018
F5ADDR   EQU   2                       ADDR EXTENT IN F5                04100018
REGTWO   EQU   2                        EQUATE FOR REGISTER 2    Y02080 04150002
DADSMCTR EQU   3                       COUNTER OF EXTENTS IN DADSMTBL   04200018
RTNREG2  EQU   4                       BRANCH REGISTER                  04300018
REGFOUR  EQU   4                        WORK REGISTER            Y02078 04350002
ALLOCADR EQU   5                       ADDR EXTENT IN DADSMTBL          04400018
LSTF5CTR EQU   6                       CTR OF EXTENTS IN LAST F5 Y02080 04500002
F5EXTCTR EQU   7                       NO. OF EXTENT IN F5              04600018
REGEIGHT EQU   8                       WORK REGISTER                    04700018
RERRPASS EQU   8                        ERROR CODE REGISTER      A31534 04750020
REGNINE  EQU   9                       WORK REGISTER                    04800018
REGTEN   EQU   10                      WORK REGISTER                    04900018
RVTOCWKA EQU   11                       VTOC CONVERSION W/A PTR  Y02078 05000002
BASEREG  EQU   12                      BASE REGISTER                    05100018
RWKAREA  EQU   13                      WORK AREA BASE REGISTER          05200018
RETRNREG EQU   14                      RETURN REG                       05300018
REG14    EQU   14                       WORK REGISTER            Y02078 05320002
REG15    EQU   15                       WORK REGISTER            Y02078 05340002
*                                                                     * 05350021
* OTHER EQUATES                                                       * 05400021
*                                                                     * 05450021
ZERO     EQU   0                        VALUE ZERO                      05500018
ONE      EQU   1                        VALUE ONE                       05600018
TWO      EQU   2                        VALUE TWO                       05700018
THREE    EQU   3                        VALUE THREE                     05800018
K4       EQU   4                        CONSTANT OF 4            Y02080 05850002
FOUR     EQU   4                        VALUE FOUR                      05900018
FIVE     EQU   5                        VALUE FIVE                      06000018
SIX      EQU   6                        VALUE SIX                       06100018
SEVEN    EQU   7                        VALUE SEVEN                     06200018
EIGHT    EQU   8                        VALUE EIGHT                     06300018
TWELVE   EQU   12                       VALUE TWELVE             Y02078 06400002
DOSBIT   EQU   X'80'                    DOS BIT IN DS4VTOCI      Y02078 07000002
VTOCERR  EQU   X'94'                    OVERLAPPING XTENTS ERROR Y02078 07100002
DOSERR   EQU   X'98'                    DOS OVERLAPPING EXTENTS  Y02078 07200002
GOODIO   EQU   X'20'                    TEST VALUE FOR SUCCESSFUL I/O   07400018
ERRCD    EQU   X'0C'                    ERROR CODE FOR UNSUCCESSFUL I/O 07500018
C26      EQU   26                                                       07700018
C140     EQU   140                                                      07800018
C125     EQU   125                      VALUE 125                       07900018
C27      EQU   27                       VALUE 27                        08100018
READCOMD EQU   X'0E'                    READ COMMAND CODE               08200018
C25      EQU   25                       VALUE 25                        08300018
NOCC     EQU   X'00'                    NO COMMAND CHAINING      Y02080 08350002
SLI      EQU   X'20'                    SUPPRESS WRONG LENGTH    Y02080 08400002
CC       EQU   X'40'                    COMMAND CHAINING BIT     Y02080 08650002
*                                                                     * 09300021
          BALR  BASEREG,ZERO           INITIALIZE BASE REGISTER         09400018
         USING *,BASEREG                                                09500018
         USING ALLOCWKA,RWKAREA         WORK AREA ADDRESSABILITY Y02080 09600002
         USING VTOCWKA,RVTOCWKA         VTOC W/A ADDRESSABILITY  Y02078 09650002
*                                                                     * 09700018
* INITIALIZE REGISTERS                                                  09800018
*                                                                     * 09900018
         LH    DADSMCTR,CCW12+TWO       NBR EXTENTS TO SUBTRACT  Y02080 10100002
         L     ALLOCADR,CCW12+FOUR      GET PTR TO EXTENT        Y02080 10200002
         LH    LSTF5CTR,LSTF5CT         NBR EXTENTS IN LAST F5   Y02080 10300002
*                                                                     * 10400018
* SAVE ADDRESS OF FORMAT 5 CURRENTLY BEING PROCESSED AND PUT THIS     * 10500018
* ADDRESS IN WHERE TO WRITE 1ST F5 IN MERGE OR EXPAND ROUTINE           10600018
*                                                                     * 10700018
         BAL   RETRNREG,LOC1STF5        FIND ADDRESS OF 1ST F5   Y02078 10750002
         ST    RVTOCWKA,PREVF5AD        INIT. PREVIOUS F5 ADDR   Y02078 10800002
         ST    RVTOCWKA,FMTINAD         SAVE WHERE-TO-WRITE ADDR Y02078 10850002
         ST    RVTOCWKA,CURRF5AD        SAVE ADDRESS OF THE F5   Y02078 10900002
*                                       NOW BEING COMPARED       Y02078 10950002
STARTCOM LA    F5EXTCTR,ONE             INT. NO. F5 EXTENT BEING CMP    11100018
         LA    F5ADDR,DS5AVEXT          GET ADDR 1ST EXTENT IN F5       11200018
BEGNCOMP CLC   ZERO(TWO,ALLOCADR),ZERO(F5ADDR) COMPARE BEGIN OF EXTENTS 11300018
         BL    DSERROR                  BRANCH IF LOW            A31333 11400020
         BH    MORECK                   BRANCH IF ALLOCATED EXTENT HIGH 11500018
         CLC   TWO(TWO,ALLOCADR),TWO(F5ADDR) COMPARE ENDS OF     A31333 11550020
*                                       EXTENTS                  A31333 11600020
         BH    DSERROR                  ERROR IF EXTENT TO BE    A31333 11650020
*                                       SUBTRACTED IS GREATER           11700020
*                                       THAN FREE EXTENT                11750020
         BL    REPLACE                  BRANCH IF LOWER          A31333 11800020
*                                                                     * 11900018
* MOVE ALL EXTENTW IN CURRENT FORMAT 5 DSCB'S FOWARD TO WIPE OUT      * 12000018
* EXTENT JUST ALLOCATED AND UPDATE LSTF5CTR TO REFLECT ONE LESS       * 12100002
* EXTENT (MERGE ROUTINE)                                              * 12200018
*                                *                                    * 12300018
WIPEOUT  LA    REGEIGHT,C26             GET MAX. NO. EXTENTS IN F5      12400018
         SR    REGEIGHT,F5EXTCTR        CALCULATE LOOP CONTROL          12500018
         BZ    COMPLAST                BRANCH IF LAST EXTENT IN THIS    12600018
*                                      F5 TO BE WIPED OUT               12700018
         LR    REGNINE,F5ADDR           GET ADDR FREE EXTENT AFFECTED   12800018
MOVEFLD  MVC   ZERO(FIVE,REGNINE),FIVE(REGNINE) MOVE A FIELD            12900018
         LA    REGNINE,FIVE(REGNINE)   POINT TO NEXT EXTENT             13000018
         BCT   REGEIGHT,MOVEFLD         BRANCH IF MORE EXTENTS TO MOVE  13100018
COMPLAST EQU   *                        BRANCH LABEL             Y02080 13150002
         CLC   DS5PTRDS+ONE(FOUR),ZEROS  TEST IF LAST IN CHAIN   Y02078 13200002
         BNE   MERGERTN                 BRANCH IF NO                    13300018
         LA    REGEIGHT,C26                                             13400018
         CR    REGEIGHT,LSTF5CTR        26 EXTENTS IN LAST F5    Y02080 13500002
         BNE   NEXTCOMP                BRANCH IF LAST F5 NOT FULL       13600018
         MVC   F5EXT16(FIVE),F5EXT16+FIVE     ZERO LAST EXTENT          13700018
NEXTCOMP EQU   *                        BRANCH LABEL             Y02080 13750002
         BCT   LSTF5CTR,WRITENOW        BR IF LAST F5 NOT ZERO   Y02080 13800002
         L     REGTEN,FMTINAD           ADDR OF F5 TO BE ZEROED  Y02078 13900002
*                                      IN CHANNEL PROGRAM             * 14000018
         XC    ZERO(L'VTC1STF5+L'VTCBPTR1,REGTEN),ZERO(REGTEN)   Y02078 14020002
*                                       ZERO LAST FORMAT 5 AND   Y02078 14040002
*                                       ITS BACKWARD POINTER     Y02078 14060002
         LH    REGONE,F5BLDCT           LOAD COUNT OF BUILT F5'S Y02078 14080002
         BCTR  REGONE,ZERO              DECREMENT BY ONE         Y02078 14100002
         STH   REGONE,F5BLDCT           SAVE UPDATED COUNT       Y02078 14120002
         LTR   REGONE,REGONE            TEST IF NO REBUILT F5'S  Y02078 14140002
         BZ    UPDATPTR                 BRANCH IF YES            Y02078 14160002
         XR    REGZERO,REGZERO          ZERO REGISTER FOR DIVIDE Y02078 14180002
         D     REGZERO,FW3              3 F5 SLOTS PER WORK AREA Y02078 14200002
         LTR   REGZERO,REGZERO          TEST IF LAST WORK AREA   Y02078 14220002
*                                       HAS ANY REBUILT F5'S     Y02078 14240002
         BNZ   NEWLAST                  BRANCH IF YES            Y02078 14260002
         CLC   F5FNDCT,F5BLDCT          TEST IF WKAREA IS EMPTY  Y02078 14280002
         BH    NEWLAST                  BRANCH IF NOT            Y02078 14300002
         IECRES FREE,PREFIX=YES,A=(REGTEN),                      Y02078X14320002
               STM=(REGONE,RWKAREA,IECREGSV+TWELVE)  FREE THE    Y02078X14340002
                                        LAST WORK AREA EXTENSION Y02078X14360002
                                        IF IT IS TOTALLY EMPTY   Y02078 14380002
NEWLAST  EQU   *                        BRANCH LABEL             Y02078 14400002
         L     REGTEN,PREVF5AD          ADDRESS OF NEW LAST F5   Y02078 14420002
         ST    REGTEN,LASTF5AD          UPDATE ADDR OF LAST F5   Y02078 14440002
         MVC   DSCBF5,ZERO(REGTEN)      MOVE IN NEW LAST F5      Y02078 14460002
         MVI   DS5PTRDS,ZERO                                     Y02080 14500002
         MVC   DS5PTRDS+ONE(FOUR),DS5PTRDS  ZERO OUT F5 CHAIN    Y02080 14600002
*                                       ADDRESS IN NEW LAST F5   Y02080 14660002
         BAL   RTNREG2,WRITEF5          WRITE NEW LAST F5               14700018
         LA    LSTF5CTR,C26             26 EXTENTS IN LAST F5    Y02080 14800002
         B     READNOW5                 GO TO READ F5 NOW BEING CMP     15200018
WRITENOW EQU   *                        BRANCH LABEL             Y02078 15300002
         L     REGTEN,FMTINAD           WHERE-TO-WRITE ADDRESS   Y02078 15400002
         BAL   RTNREG2,WRITEF5          WRITE F5                        15500018
READNOW5 EQU   *                        BRANCH LABEL             Y02078 15600002
         L     REGTEN,CURRF5AD          ADDRESS OF F5 NOW BEING  Y02078 15650002
*                                       COMPARED                 Y02078 15700002
         ST    REGTEN,FMTINAD           INIT WHERE-TO-WRITE ADDR Y02078 15750002
         MVC   DSCBF5,ZERO(REGTEN)      MOVE IN F5 TO COMPARE    Y02078 15800002
         B     UPDATPTR                 GO TO SUBT NEXT EXTENT          15900018
MERGERTN EQU   *                        BRANCH LABEL             Y02080 15950002
         L     REGTEN,DS5PTRDS+ONE      LOAD CHAINING ADDRESS    Y02078 16100002
         MVC   DSCBF1,ZERO(REGTEN)      MOVE IN NEXT F5 IN CHAIN Y02078 16200002
         MVC   F5EXT16(FIVE),DSF3EXT1   MERGE EXTENT TO PREVIOUS F5     16300018
         L     REGTEN,FMTINAD           GET WHERE-TO-WRITE ADDR  Y02078 16400002
         MVC   FMTINAD(FOUR),DS5PTRDS+ONE  NEW WHERE-TO-WR ADDR  Y02078 16500002
         ST    REGTEN,PREVF5AD          NEW PREVIOUS F5 ADDRESS  Y02078 16600002
         BAL   RTNREG2,WRITEF5          WRITE PREVIOUS F5               16700018
         XC    DSCBF5(C140),DSCBF5      ZERO F5 AREA                    16800018
         MVC   DS5AVEXT(C125),DSF3EXT2  UPDATE NEXT F5 IN CHAIN         16900018
         MVC   DS5PTRDS,DS1PTRDS        SAVE CHAINING POINTER    Y02080 17000002
         B     COMPLAST                 GO TO CHECK FOR LAST F5         17100018
*                                                                     * 17200018
* THIS ROUTINE MODIFIES A FORMAT 5 EXTENT WHEN THE ALLOCATED EXTENT   * 17300021
* BEGINS AT THE BEGINNING OF THE FORMAT 5 EXTENT.                     * 17400021
*                                                                     * 17600018
REPLACE  MVC   ZERO(TWO,F5ADDR),TWO(ALLOCADR) UPDATE LOWER EXTENT BOUND 17700018
         B     WRITENOW                 GO TO WRITE F5                  17800018
UPDATPTR LA    ALLOCADR,FOUR(ALLOCADR)  UPDATE PTR TO EXTENT TO BE SUBT 17900018
         BCT   DADSMCTR,BEGNCOMP        BRANCH IF MORE EXTENTS TO SUBT  18000018
         STH   LSTF5CTR,LSTF5CT         SAVE LAST F5 EXTENT CTR  Y02080 18100002
         BAL   RETRNREG,LOC1STF5        FIND ADDRESS OF 1ST F5   Y02078 18200002
         MVC   DSCBF5,VTC1STF5          MOVE IN FIRST F5         Y02078 18300002
         CLI   CCW12,ZERO               ENTRY FROM IGG0325P      Y02080 18320002
         BNE   UNCHAIND                 BRANCH IF NO             A31333 18330020
         CLC   SEEKCYL(FOUR),DS4VTOC6   LAST TRACK IN VTOC       A31333 18340020
         BNE   NOTLAST                  BRANCH IF NOT            A31333 18350020
         CLC   SEEKREC(ONE),DS4DEVDT    LAST RECORD ON TRACK     A31333 18360020
         BNE   NOTLAST                  BRANCH IF NOT            Y02078 18365002
         MVI   CCW6+K4,NOCC             UNCHAIN READ FROM RD CNT Y02078 18370002
         B     UNCHAIND                 BRANCH TO REREAD DSCB    Y02078 18375002
NOTLAST  EQU   *                                                 A31333 18380020
         MVI   CCW6+K4,CC               CHAIN READ TO READ COUNT Y02080 18400002
UNCHAIND EQU   *                                                 A31333 18450020
         BAL   RETRNREG,READTOF1        READ LAST F1 OR F3 READ  Y02078 18700002
         SR    REENTRY,REENTRY          ZERO PARAMETER REG              18800018
         CLI   CCW12,ZERO               ENTRY FROM IGG0325P      Y02080 19130002
         BNE   LOAD325W                 BRANCH IF NO             A31333 19160020
         LA    REGTWO,F5LOAD            POINT TO ID OF IGG0325P  Y02080 19210002
         B     XCTLHERE                 GO XCTL                  A31333 19320020
LOAD325W EQU   *                                                 A31333 19340020
         LA    REGTWO,F6LOAD            POINT TO ID OF IGG0325W  Y02080 19390002
XCTLHERE EQU   *                        BRANCH LABEL             Y02080 19440002
        IECRES LOAD,EXTPR=(RWKAREA),MODID=(REGTWO),BRANCH=DIRECT Y02080 19490002
DSERROR  EQU   *                                                 A31333 19630020
         LA    RERRPASS,VTOCERR         OVERLAPPING EXTENTS ERR  Y02078 19640002
         CLI   CCW12,ZERO               ENTRY FROM IGG0325P      Y02078 19650002
         BE    ERREXIT                  BRANCH IF YES            Y02078 19660002
         TM    DS4VTOCI,DOSBIT          TEST IF DOS VOLUME       Y02078 19670002
         BNO   ERREXIT                  BRANCH IF NOT            Y02078 19680002
         LA    RERRPASS,DOSERR          DOS SPLIT/CYL EXTENT ERR Y02078 19690002
ERREXIT  EQU   *                        BRANCH LABEL             Y02080 19710002
         LA    REGTWO,LASTLOAD          POINT TO ID OF IGG0325T  Y02080 19760002
         B     XCTLHERE                 GO TO XCTL                      20000018
*                                                                     * 20700018
* THIS SECTION CHECKS TO SEE IF ALLOCATED EXTENT DIVIDES FREE EXTENT  * 20800018
* IN TWO PARTS,IF THE UPPER BOUNDRY OF THE FREE EXTENT MUST BE UPDATED* 20900018
* OR IF THE ALLOCATED EXTENT MUST BE COMPARED AGAINST THE NEXT FREE   * 21000018
* EXTENT                                                              * 21100018
*                                                                     * 21200018
MORECK   CLC   ZERO(TWO,ALLOCADR),TWO(F5ADDR) IS ALLOCATED EXT IN THIS  21300018
*                                       FREE EXTENT                   * 21400018
         BL    EXPANDCK                 BRANCH IF YES                   21500018
         LA    F5EXTCTR,ONE(F5EXTCTR)                                   21600018
         LA    REGEIGHT,C27                                             21700018
         CR    F5EXTCTR,REGEIGHT        HAS LAST EXTENT IN THIS F5      21800018
*                                       BEEN COMPARED                 * 21900018
         BE    READNXT                  BRANCH IF YES                   22000018
         LA    F5ADDR,FIVE(F5ADDR)      POINT TO NEXT EXTENT            22100018
         CLC   ZERO(FOUR,F5ADDR),ZEROS  IS THIS EXTENT ZERO      A53183 22200021
         BE    DSERROR                  ERROR IF EXTENT TO BE    A31333 22250020
*                                       SUBTRACTED IS NOT WITHIN        22300020
*                                       ANY FREE EXTENT                 22350020
         B     BEGNCOMP                 BRANCH TO BEGIN COMPARISON      22400018
READNXT  EQU   *                        BRANCH LABEL             Y02080 22450002
         CLC   DS5PTRDS+ONE(FOUR),ZEROS  IS THIS THE LAST F5     Y02078 22500002
         BE    DSERROR                  ERROR IF EXTENT TO BE    A31333 22550020
*                                       SUBTRACTED IS NOT WITHIN        22600020
*                                       ANY FREE EXTENT                 22650020
         L     REGTEN,DS5PTRDS+ONE      LOAD NEXT F5 ADDRESS     Y02078 22700002
         MVC   DSCBF5,ZERO(REGTEN)      MOVE IN NEXT F5          Y02078 22800002
         MVC   PREVF5AD,FMTINAD         SAVE PREVIOUS F5 ADDR    Y02080 22900002
         ST    REGTEN,FMTINAD           SAVE WHERE-TO-WRITE ADDR Y02078 23000002
UPDATNXT EQU   *                        BRANCH LABEL             Y02078 23100002
         ST    REGTEN,CURRF5AD          ADDR F5 BEING COMPARED   Y02078 23150002
         B     STARTCOM                 BRANCH TO BEGIN COMPARISON      23200018
EXPANDCK CLC   TWO(TWO,ALLOCADR),TWO(F5ADDR) ARE ENDS OF EXTENTS EQUAL  23300018
         BE    REPLACE2                 BRANCH IF YES                   23400018
         BH    DSERROR                  ERROR IF EXTENT TO BE    A31333 23420020
*                                       SUBTRACTED IS GREATER           23440020
*                                       THAN FREE EXTENT                23460020
         MVC   DSCBF1(FIVE),F5EXT16                                     23500018
         LA    REGNINE,C26              GET MAX.NO. EXTENTS IN F5       23600018
         CR    REGNINE,F5EXTCTR         IS LAST EXTENT IN F5 BEING      23700018
*                                       DIVIDED                       * 23800018
         BE    SETUP                    BRANCH IF YES                   23900018
         LA    REGNINE,FIVE                                             24000018
         LA    REGEIGHT,F5EXT15                                         24100018
MOVE     MVC   FIVE(FIVE,REGEIGHT),ZERO(REGEIGHT) MOVE A FIELD          24200018
         CR    REGEIGHT,F5ADDR          HAVE ALL FIELDS BEEN MOVED      24300018
         BE    CONT                     BRANCH IF YES                   24400018
         SR    REGEIGHT,REGNINE         UPDATE POINTER TO NEXT FIELD    24500018
         B     MOVE                     GO TO MOVE NEXT FIELD           24600018
SETUP    MVC   TWO(TWO,F5ADDR),ZERO(ALLOCADR) SET UP NEW BOUND TO EXT   24700018
         MVC   DSCBF1(TWO),TWO(ALLOCADR)                                24800018
         B     LASTF5CK                 GO TO SEE IF THIS IS LAST F5    24900018
CONT     MVC   SEVEN(TWO,F5ADDR),TWO(F5ADDR) SET UP                     25000018
         MVC   TWO(TWO,F5ADDR),ZERO(ALLOCADR)    NEW BOUNDS FOR         25100018
         MVC   FIVE(TWO,F5ADDR),TWO(ALLOCADR)               DIVIDED EXT 25200018
LASTF5CK EQU   *                        BRANCH LABEL             Y02078 25300002
         L     REGTEN,FMTINAD           GET WHERE-TO-WRITE ADDR  Y02078 25350002
         BAL   RTNREG2,WRITEF5          WRITE F5                        25400018
         CLC   DS5PTRDS+ONE(FOUR),ZEROS  IS THIS LAST F5 DSCB    Y02078 26100002
         BE    FINXPAND                 BRANCH IF YES                   26200018
         MVC   PREVF5AD,FMTINAD         SAVE PREVIOUS F5 ADDR    Y02080 26300002
         L     REGTEN,DS5PTRDS+ONE      GET NEXT F5 ADDRESS      Y02078 26400002
         ST    REGTEN,FMTINAD           SAVE WHERE-TO-WRITE ADDR Y02078 26500002
         MVC   DSCBF5,ZERO(REGTEN)      MOVE IN NEXT F5          Y02078 26600002
         MVC   DSF3SAVE(FIVE),F5EXT16   SAVE LAST EXTENT IN F5 JUST     26700018
*                                       READ                          * 26800018
         LA    REGZERO,FIVE             GET POINTER DECREMENT    A31333 26900020
         LA    REGEIGHT,C25             LOAD LOOP CONTROL               27000018
         LA    REGNINE,F5EXT15          POINT TO EXTENT TO BE    A31333 27080020
*                                       MOVED                    A31333 27160020
MOVE2    EQU   *                                                 A31333 27240020
         MVC   FIVE(FIVE,REGNINE),ZERO(REGNINE) MOVE A FIELD     A31333 27320020
         SR    REGNINE,REGZERO          DECREMENT PTR TO FIELD   A31333 27400020
         BCT   REGEIGHT,MOVE2           BRANCH IF MORE FIELDS TO MOVE   27500018
         MVC   DS5AVEXT(FIVE),DSCBF1    MOVE IN NEW FIRST EXTENT        27600018
         MVC   DSCBF1(FIVE),DSF3SAVE    POSITION EXTENT SAVED FROMF5    27700018
         B     LASTF5CK                 GO TO WRITE F5 JUST EXPANDED    27800018
REPLACE2 MVC   TWO(TWO,F5ADDR),ZERO(ALLOCADR) SET UP NEW UPPER BOUND    27900018
         L     REGTEN,FMTINAD           GET WHERE-TO-WRITE ADDR  Y02078 28000002
         BAL   RTNREG2,WRITEF5          WRITE F5                        28100018
         B     UPDATPTR                 GO TO SUBT NEXT EXTENT          28200018
FINXPAND LA    REGEIGHT,C26                                             28300018
         CR    LSTF5CTR,REGEIGHT        IS LAST F5 FULL          Y02080 28400002
         BL    INCRCTR                  BRANCH IF NO                    28500018
         XR    REGTEN,REGTEN            INDICATE NEED OF NEW F5  Y02078 28600002
*                                       SLOT IN A W/A EXTENSION  Y02078 28650002
         BAL   RTNREG2,WRITEF5          WRITE F5 JUST EXPANDED          28700018
*                                       REGTEN POINTS TO F5 SLOT Y02078 28800002
         XC    DSCBF5(C140),DSCBF5      CLEAR F5 AREA                   29000018
         MVC   DS5AVEXT(FIVE),DSCBF1    MOVE EXTENT TO NEW F5           29100018
         BAL   RTNREG2,WRITEF5          WRITE NEW F5                    29200018
         LA    LSTF5CTR,ONE             INITIALIZE LAST F5 CTR   Y02080 29300002
         B     READNOW5                 READ F5 BEING COMPARED          29700018
INCRCTR  EQU   *                        BRANCH LABEL             Y02080 29750002
         LA    LSTF5CTR,ONE(LSTF5CTR)   UPDATE CTR OF EXTENTS IN Y02080 29800002
*                                       LAST F5                  Y02080 29900002
         CR    REGEIGHT,F5EXTCTR        IS FREE EXTENT JUST DIVIDED     30000018
*                                       THE LAST EXTENT IN THAT F5      30100018
         BNH   READNOW5                 BRANCH IF YES                   30200018
PTRUPDAT LA    F5ADDR,FIVE(F5ADDR)      POINT TO NEXT FREE EXTENT       30300018
         LA    F5EXTCTR,ONE(F5EXTCTR)   UPDATE CTR OF FREE EXTENT       30400018
         B     READNOW5                 READ F5 NOW BEING COMPARED      30500018
*                                                                       30520002
* THIS ROUTINE LOCATES THE ADDRESS OF THE FIRST FORMAT 5 DSCB IN        30540002
* THE VTOC EXTENSION WORK AREA(S) AND RETURNS ITS ADDRESS IN            30560002
* REGISTER RVTOCWKA.                                                    30580002
*                                                                       30600002
LOC1STF5 EQU   *                        BRANCH LABEL             Y02078 30620002
         LA    REGEIGHT,ZERO(RWKAREA)   INITIAL WORK AREA ADDR   Y02078 30640002
         LA    REGONE,IECEXTPR-IECPREFX  LENGTH OF PREFIX        Y02078 30660002
         SR    REGEIGHT,REGONE          CALCULATE PREFIX ADDRESS Y02078 30680002
NXTPREFX EQU   *                        BRANCH LABEL             Y02078 30700002
         USING IECPREFX,REGEIGHT        PREFIX ADDRESSABILITY    Y02078 30720002
         L     REGEIGHT,IECCORP2        LOAD ADDR OF NEXT PREFIX Y02078 30740002
         CLC   IECCORID,VCWKAID         TEST IF VTOC WORK AREA   Y02078 30760002
         BNE   NXTPREFX                 BRANCH IF NOT            Y02078 30780002
         L     RVTOCWKA,IECCORAD        LOAD ADDR OF EXTENSION   Y02078 30800002
         BR    RETRNREG                 RETURN                   Y02078 30820002
         DROP  REGEIGHT                                          Y02078 30840002
*                                                                       30860002
* THIS ROUTINE MOVES A FORMAT 5 DSCB FROM 'DSCBF5' TO THE LOCATION      30880002
* POINTED TO BY REGISTER 10.  IF REGISTER 10 IS ZERO, THIS INDICATES    30900002
* THAT A FORMAT 5 DSCB IS BEING EXPANDED AND THAT A NEW FORMAT 5 SLOT   30920002
* MUST BE FOUND IN AN EXISTING WORK AREA EXTENSION OR THAT A NEW WORK   30940002
* AREA EXTENSION MUST BE OBTAINED.  THE ADDRESS OF THE NEW SLOT IS      30960002
* INSERTED INTO THE CHAINING FIELD OF THE FORMAT 5 IN 'DSCBF5' BEFORE   30980002
* IT IS WRITTEN TO THE LOCATION WHOSE ADDRESS IS IN 'FMTINAD'.  THEN    31000002
* THE ADDRESS OF THE NEW FORMAT 5 SLOT IN RETURNED IN REGISTER 10.      31020002
*                                                                       31040002
WRITEF5  EQU   *                        BRANCH LABEL             Y02078 31060002
         LTR   REGTEN,REGTEN            TEST IF A NEW F5 SLOT    Y02078 31080002
*                                       MUST BE FOUND            Y02078 31100002
         BZ    BLDNEWF5                 BRANCH IF YES            Y02078 31120002
         MVC   ZERO(L'DSCBF5,REGTEN),DSCBF5  MOVE OUT UPDATED F5 Y02078 31140002
         BR    RTNREG2                  RETURN                   Y02078 31160002
BLDNEWF5 EQU   *                        BRANCH LABEL             Y02078 31180002
         XR    REGEIGHT,REGEIGHT        PREPARE FOR DIVISION     Y02078 31200002
         LH    REGNINE,F5BLDCT          GET NBR OF REBUILT F5'S  Y02078 31220002
         D     REGEIGHT,FW3             3 F5'S PER WKA EXTENSION Y02078 31240002
         L     REGONE,FMTINAD           LOAD WHERE-TO-WRITE ADDR Y02078 31260002
         LTR   REGEIGHT,REGEIGHT        TEST IF NO FREE F5 SLOT  Y02078 31280002
         BNZ   FREESLOT                 BRANCH IF A FREE SLOT    Y02078 31300002
         CLC   F5BLDCT,F5FNDCT          TEST FOR AN EXTENSION    Y02078 31320002
*                                       WITHOUT ANY REBUILT F5'S Y02078 31340002
         BNL   NEWKAREA                 BRANCH IF NOT            Y02078 31360002
NEXTWKA  EQU   *                        BRANCH LABEL             Y02078 31380002
         LR    REG14,REGONE             LOAD WHERE-TO-WRITE ADDR Y02078 31400002
         LA    REG15,VTC3RDF5-VTC1STF5  OFFSET TO W/A BEGINNING  Y02078 31420002
         LA    REG15,IECEXTPR-IECPREFX(REG15)  PREFIX LENGTH     Y02078 31440002
         SR    REG14,REG15              POINT TO WKAREA PREFIX   Y02078 31460002
         USING IECPREFX,REG14           PREFIX ADDRESSABILITY    Y02078 31480002
         L     REG14,IECCORP2           LOAD ADDR OF NEXT PREFIX Y02078 31500002
         L     REGTEN,IECCORAD          LOAD ADDR OF EXTENSION   Y02078 31520002
*                                       WHICH IS FREE SLOT ADDR  Y02078 31540002
         DROP  REG14                                             Y02078 31560002
MOVEF5IN EQU   *                        BRANCH LABEL             Y02078 31580002
         ST    REGTEN,DS5PTRDS+ONE      INSERT CHAINING ADDRESS  Y02078 31600002
         MVC   ZERO(L'DSCBF5,REGONE),DSCBF5  MOVE OUT UPDATED F5 Y02078 31620002
         LH    REGNINE,F5BLDCT          GET NBR OF REBUILT F5'S  Y02078 31640002
         LA    REGNINE,ONE(REGNINE)     INCREMENT COUNT          Y02078 31660002
         STH   REGNINE,F5BLDCT          SAVE UPDATED COUNT       Y02078 31680002
         ST    REGTEN,LASTF5AD          UPDATED PTR TO LAST SLOT Y02078 31700002
         ST    REGONE,VTCBPTR(REGTEN)   INSERT BACKWARD POINTER  Y02078 31720002
         BR    RTNREG2                  RETURN                   Y02078 31740002
FREESLOT EQU   *                        BRANCH LABEL             Y02078 31760002
         LA    REGTEN,VTCNXTF5(REGONE)  POINT TO NEXT W/A SLOT   Y02078 31780002
         B     MOVEF5IN                 GO MOVE IN UPDATED F5    Y02078 31800002
NEWKAREA EQU   *                        BRANCH LABEL             Y02078 31820002
         LR    REG14,REGONE             SAVE WHERE-TO-WRITE ADDR Y02078 31840002
         IECRES GET,EXTPR=(RWKAREA),LV=VWALNGTH,ID=VCWA,         Y02078X31860002
               STM=(F5ADDR,REG14,IECREGSV+12)  OBTAIN NEXT WKA   Y02078 31880002
         LR    REGTEN,REGONE            ADDR OF NEW EXTENSION    Y02078 31900002
         LR    REGONE,REG14             RESTORE WHERE-TO-WR ADDR Y02078 31920002
         B     MOVEF5IN                 GO MOVE IN UPDATED F5    Y02078 31940002
*                                                                       31960002
* THIS ROUTINE REREADS THE FORMAT 1, 3, OR 6 DSCB BEING PROCESSED.      31980002
*                                                                       32000002
READTOF1 LA    REGEIGHT,DSCBF1          GET ADDR OF F1 AREA             32100018
FURTHER  ST    REGEIGHT,CCW6            STORE ADDR OF AREA RECEIVING F5 32200018
         LA    REGEIGHT,CCW4                                            32300018
         ST    REGEIGHT,CHNPGADR        SET CHANNEL PROGRAM TO READ     32400018
         MVI   CCW6,READCOMD            MOVE IN READ CODE               32500018
EXCHANPG MVI   ECB,ZERO                                                 32800018
         EXCP  IOB                                                      32900018
         WAIT  1,ECB=ECB                                                33000018
         TM    ECB,GOODIO                                               33100018
         BCR   ONE,RETRNREG        RETURN IF GOOD I/O            A36311 33200020
         LA    RERRPASS,ERRCD                                           33300018
         B     ERREXIT                  BRANCH IF ERROR                 33400018
*                                                                     * 33450021
* CONSTANTS                                                           * 33500021
*                                                                     * 33550021
VCWKAID  DC    C'VCWA'                  VTOC WORK AREA PREFIX ID Y02078 33560002
FW3      DC    F'3'                     3 F5'S PER WKA EXTENSION Y02078 33570002
*                                                                     * 33920021
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                       * 33940002
*                                                                     * 33960021
         XCTLTABL ID=(F5LOAD,5P,F6LOAD,5W,LASTLOAD,5T),          Y02080X34010002
               SVC=032,LENGTH=,BRT=YES                           Y02080 34060002
         EJECT                                                   Y02080 34110002
CVT      DSECT                          CVT DSECT                Y02080 34120002
         CVT                                                     Y02080 34130002
         EJECT                                                   Y02080 34210002
DSCBWKAR IECALLWA EP,F4,D1=(1),D2=(5)   ALLOCATE WORK AREA       Y02080 35100002
DS4VTOC6 EQU   DS4VTOCE+6                                               37700018
DSF3EXT1 EQU   DSCBF1+4                                                 40900018
DSF3EXT2 EQU   DSCBF1+9                                                 41000018
DSF3SAVE EQU   DSCBF1+5                                                 41100018
F5EXT15  EQU   DSCBF5+124               EXTENT 15 IN F5 DSCB            42200018
F5EXT16  EQU   DSCBF5+129               EXTENT 16 IN F5 DSCB            42300018
CHNPGADR EQU   IOB+16                   ADDR. CHANNEL PROGRAM IN IOB    43700018
SEEKCYL  EQU   SEEK+3                                                   43900018
SEEKREC  EQU   SEEK+7                                                   44000018
ZEROS    EQU   CCW2+4                   FULL WORD OF ZERO               44300018
CURRF5AD EQU   TTRLL                    CURRENT FORMAT 5 ADDRESS Y02078 44350002
         EJECT                                                   Y02078 44400002
VWKAREA  IECVTCWA                       VTOC CONVERSION WORKAREA Y02078 44450002
         END                                                            50700018
