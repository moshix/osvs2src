 TITLE 'IGG032I2 - ISAM ALLOCATE - FORMAT 5 SEARCH'                     00020000
IGG032I2 CSECT                                                          00030021
*                                                                       00040002
*MODULE NAME = IGG032I2                                                 00050002
*                                                                       00052002
*DESCRIPTIVE NAME = ISAM ALLOCATE - FORMAT 5 SEARCH                     00054002
*                                                                       00056002
*COPYRIGHT = NONE                                                       00058002
*                                                                       00058402
*CHANGE ACTIVITY = SEE BELOW                                            00058802
*                                                                       00060000
*          RELEASE 18 DELETIONS                                       * 00061018
*2272                                                             24988 00062018
*          RELEASE 19 DELETIONS                                       * 00063018
*1774089400                                                      A27089 00063219
*1774089400                                                      A27089 00063519
*          RELEASE 20 DELETIONS                                       * 00064018
*3537                                                            A36850 00064520
*          RELEASE 21 DELETIONS                                       * 00065018
*1203000400,017000,024500-024600,025456-025463,025477-025505,    S21016 00065321
*1203025528-025530,025624,040400,041600-041800,042800,048200     S21016 00065621
*1203003200,018000-018400,028800-029000,042000-042200,052800-    A38860 00065721
*1203053800,089800-090000,100800                                 A38860 00065821
*          RELEASE 22 DELETIONS                                       * 00066018
*          VS2 RELEASE 02 DELETIONS/CHANGES                           * 00067002
*0000000030-000150,000670-000710,002400,003200,005800,006600,    Y02080 00067102
*0000008600,017600,018000-018200,024060-024200,025200,025512,    Y02080 00067202
*0000027200,028400,040000,042200,052400,053000,053400-053600,    Y02080 00067302
*0000054400-054800,055400,060600,064800-065000,066400,069700,    Y02080 00067402
*0000070300,087400,089880-090400,090800,091200-103000            Y02080 00067502
*                                                                       00077002
*STATUS CHANGE LEVEL 006                                                00081021
*                                                                       00100000
*FUNCTION - THE REQUEST IS EXAMINED AND THE FORMAT 5 IS SEARCHED        00120000
*           ACCORDING TO ABSOLUTE TRACK, OR AVAILABLE CYLINDERS         00140000
*           DEPENDING UPON THIS REQUEST.  A DADSM TABLE IS BUILT        00160000
*           ACCORDING TO ASCENDING RTA'S.                               00180000
*                                                                       00200000
*ENTRIES - THE ONLY ENTRY POINT TO THIS MODULE IS IGG032I2. ENTRY IS    00220000
*          MADE FROM THE FIRST LOAD OF ISAM ALLOCATE VIA A BRANCH.      00240002
*                                                                       00260000
*                                                                       00280000
*INPUT - AT ENTRY TO THIS MODULE REGISTER 11 POINTS TO A JFCB, REGISTER 00300000
*        13 POINTS TO THE ALLOCATE WORK AREA WHICH CONTAINS THE ADDRESS 00320002
*        OF A FORMAT 1 IF ONE EXISTS, VTOCADR, AND DADSMADR.            00340000
*        REGISTER 9 CONTAINS THE QUANTITY TO BE ALLOCATED,  THE FIRST   00360000
*        FORMAT 5 IS IN THE WORK AREA.                                  00380000
*                                                                       00400000
*OUTPUT - UPON TRANSFERRING TO THE NEXT MODULE, IGG032I3, THE WORK AREA 00420000
*         WILL CONTAIN A SORTED DADSM TABLE, THE VTOCADR, AND DADSMADR. 00440000
*                                                                       00460000
*                                                                       00480000
*EXTERNAL ROUTINES - THE FOLLOWING ARE SUPERVISOR CALLS ISSUED IN THE   00500000
*   MACRO EXPANSIONS                                                    00520000
*   EXCP(0) READ FROM OR WRITE TO DIRECT ACCESS DEVICE                  00540000
*   WAIT(1) WAIT ON EVENT CONTROL BLOCK                                 00560000
*   OTHER MACROS ISSUED - IEFJFCBN - BUILDS JFCB                        00600000
*                         IECALLWA - ALLOCATE WORK AREA EXPANSION       00610002
*                         IECSDSL1 - BUILDS DSCBS                       00620000
*                         CVT - BUILD CVT                               00630002
*                                                                       00640000
*EXITS - NORMAL - BRANCH TO MODULE IGG032I3                             00660002
*      - ERROR - ERROR CODES RETURNED TO MODULE IGG032I7 IN REG 5       00680000
*                                                                       00700000
*              0C   PERMANENT I/O ERROR                                 00720000
*                                                                       00740000
*              10   ABSOLUTE TRACK NOT AVAILABLE                        00760000
*                                                                       00780000
*              14   SPACE REQUESTED NOT AVAILABLE                       00800000
*                                                                       00820000
*              28   SPACE MUST BE ON CYLINDER BOUNDARY                  00825021
*                                                                       00830021
*              6C   PRIMARY SPACE REQUEST IS ZERO                       00835021
*                                                                       00840000
*TABLES/WORK AREAS - DADSM WORK AREA DESCRIBED BY MACRO IECALLWA        00860002
*              ***************************************                  00880000
*              *             DADSM TABLE             *                  00900000
*              ***************************************                  00920000
*                                                                       00940000
*              ***************************************                  00960000
*              *        *         *                  *                  00980000
*              *  TYPE  *  NO OF  *     USED HOLE    *                  01000000
*              *  FLAG  * ENTRIES *      COUNTER     *                  01020000
*              *        *         *                  *                  01040000
*              ***************************************                  01060000
*              *                  *                  *                  01080000
*              *       RTA        *      RTA+1       *                  01100000
*              *                  *                  *                  01120000
*              ***************************************                  01140000
*              *                  *                  *                  01160000
*              *       RTA        *      RTA+1       *                  01180000
*              *                  *                  *                  01200000
*              ***************************************                  01220000
*              *                  *                  *                  01240000
*              *       RTA        *      RTA+1       *                  01260000
*              *                  *                  *                  01280000
*              ***************************************                  01300000
*              *                  *                  *                  01320000
*              *       RTA        *      RTA+1       *                  01340000
*              *                  *                  *                  01360000
*              ***************************************                  01380000
*              *                  *                  *                  01400000
*              *       RTA        *      RTA+1       *                  01420000
*              *                  *                  *                  01440000
*              ***************************************                  01460000
*                                                                       01480000
*                                                                       01500000
*              TYPE FLAG = 02 - BPAM DIRECTORIES REQUESTED.             01520000
*                                                                       01540000
*                        = 40 - USER LABELS REQUESTED                   01544021
*                                                                       01548021
*                        = 80 - SET MUST COMPLETE IS ACTIVE             01552021
*                                                                       01556021
*                                                                       01560000
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.    01580000
*                                                                       01600000
*                                                                       01620000
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.        01640000
*                                                                       01660000
*                                                                       01680000
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT. 01700021
*                                                                       01720000
*                                                                       01740000
*ATTRIBUTES - REENTRANT                                                 01760002
*                                                                       01780000
*STORAGE - PROGRAM CODE CSECT = LESS THAN 2048 BYTES                    01800002
*          WORK AREA = AS DEFINED IN THE IECALLWA MACRO                 01820002
*          RPS WORK AREA = AS DEFINED IN THE IECRPS MACRO               01830002
*                                                                       01840021
*                                                                       01860000
*REGISTER USAGE                                                         01880000
*              REGISTERS 0-9 WORK REGISTERS                             01900000
*              REGISTER 10 - TIOT SET UP TABLE POINTER                  01920000
*              REGISTER 11 - JFCB POINTER                               01940000
*              REGISTER 12 - BASE REGISTER                              01960000
*              REGISTER 13 - WORK AREA POINTER                          01980000
*              REGISTER 14 SUBROUTINE LINKAGE AND WORK REGISTER         02000000
*              REGISTER 15 WORK REGISTER                                02020000
*                                                                       02040000
***** REGISTER NAMES *****                                              02060000
RZERO    EQU   0                                                        02080000
RONE     EQU   1                                                        02100000
RTWO     EQU   2                                                        02120000
RTHREE   EQU   3                                                        02140000
RFOUR    EQU   4                                                        02160000
RFIVE    EQU   5                                                        02180000
RSIX     EQU   6                                                        02200000
RSEVEN   EQU   7                                                        02220000
REIGHT   EQU   8                                                        02240000
RNINE    EQU   9                                                        02260000
RTEN     EQU   10                                                       02280000
RJFCB    EQU   11                                                       02300000
RBASE    EQU   12                                                       02320000
RWORK    EQU   13                                                       02340000
RETURN   EQU   14                                                       02360000
RFTEN    EQU   15                                                       02380000
*                                                                       02386021
* OTHER EQUATES                                                         02392021
*                                                                       02400000
ZERO     EQU   0                   CONSTANT OF ZERO              Y02080 02402002
THREE    EQU   3                   CONSTANT OF THREE             Y02080 02404002
FIVE     EQU   5                   CONSTANT OF FIVE              Y02080 02406002
HELDQTY  EQU   X'FF'               HELD QUANTITY INDICATOR       Y02080 02408002
NODSCBS  EQU   X'08'               NO UNUSED DSCB'S AVAILABLE    S21016 02422021
IOERRCDE EQU   X'0C'               I/O ERROR CODE                S21016 02424021
NOTAVAIL EQU   X'10'               ABSOLUTE TRACK NOT AVAILABLE  S21016 02426021
NOTENUFF EQU   X'14'               SPACE REQUESTED NOT AVAILABLE S21016 02428021
BOUNDERR EQU   X'28'               BOUNDARY ERROR CODE           S21016 02430021
ZEROSPCE EQU   X'6C'               PRIMARY SPACE REQUEST IS ZERO S21016 02432021
*                                                                       02440000
         BALR  RBASE,0                                                  02480000
         USING ALPA,RBASE                                               02500000
         USING ALLOCWKA,RWORK           WORK AREA ADDRESSABILITY Y02080 02520002
         USING JFCBKEN,RJFCB                                            02540000
*                                                                       02540713
* THIS SECTION CHECKS FOR ENOUGH ROOM IN THE VTOC                       02541413
*                                                                       02542113
ALPA     LA    RTHREE,4                 COMPARE THE NUMBER OF HOLES     02542813
         CH    RTHREE,DS4DSREC             AVAILABLE WITH 4             02543513
         BNH   FINE                     BRANCH IF 4 OR MORE HOLES ARE   02544213
*                                       AVAILABLE                       02544913
         LA    RFIVE,NODSCBS            LOAD ERROR CODE          S21016 02545921
         B     FREEUP                                                   02547013
FINE     EQU   *                        BRANCH LABEL             Y02080 02549002
         XC    PDLIST,PDLIST            CLEAR PUSHDOWN LIST      Y02080 02551002
         XC    DADSMTBL,DADSMTBL        CLEAR DADSM EXTENT TABLE Y02080 02551202
         SR    REIGHT,REIGHT                                            02551913
         LH    RNINE,PRIQTY             PICK UP PRIMARY QUANTITY        02552613
         LTR   RNINE,RNINE              ZERO QUANTITY REQUEST?   S21016 02552721
         BP    GETINDEX                 BRANCH IF NOT            S21016 02552821
         LA    RFIVE,ZEROSPCE           LOAD ERROR CODE          S21016 02552921
         B     FREEUP                                            S21016 02553021
GETINDEX EQU   *                                                 S21016 02553121
         LR    RSIX,REIGHT                                              02553313
         LH    RSEVEN,DIRQTY            PICK UP EMBEDDED INDEX          02554013
         TM    JFCBCTRI,X'DF'           CHECK THE REQUEST TYPE FIELD    02554713
         BC    5,NOTHERE                BRANCH IF REQUEST FOR CYLINDERS 02555413
*                                                                       02556113
* THIS SECTION CHECKS FOR ABSOLUTE TRACK REQUEST BEING ONE OF AN        02556813
* INTEGRAL NUMBER OF CYLINDERS                                          02557513
*                                                                       02558213
         LH    RFIVE,DS4DEVSZ+2         DIVIDE THE PRIMARY QTY BY THE   02558913
         DR    REIGHT,RFIVE                NUMBER OF TRACKS/CYLINDERS   02559613
         LTR   REIGHT,REIGHT            TEST REMAINDER FOR ZERO         02560313
         BZ    NONEHERE                 BRANCH IF AN INTEGRAL NUMBER OF 02561013
*                                          CYLINDERS                    02561713
INVSPACE EQU   *                                                 S21016 02561921
         LA    RFIVE,BOUNDERR           NOT ON CYLINDER          S21016 02562121
*                                       BOUNDARIES               S21016 02562321
         B     FREEUP                                            S21016 02562521
NONEHERE LR    RTWO,RNINE                                               02563113
         LH    RNINE,ABSTR              TEST FOR CYLINDER ALLIGNMENT    02563813
         DR    REIGHT,RFIVE             DIVIDE ABSOLUTE TRACK REQUESTED 02564513
*                                          BY TRACKS/CYLINDER           02565213
         LTR   REIGHT,REIGHT            TEST REMAINDER FOR ZERO         02565913
         BC    7,INVSPACE               BRANCH IF NOT AN INTEGRAL       02566613
*                                          NUMBER OF CYLINDERS          02567313
         LR    RNINE,RTWO                                               02568013
         LTR   RSEVEN,RSEVEN            CHECK FOR PRESENCE OF EMBEDDED  02568713
*                                          INDEX QUANTITY               02569413
         BZ    NOTHERE                  BRANCH IF THERE IS NO EMBEDDED  02570113
*                                          INDEX QUANTITY               02570813
         DR    RSIX,RFIVE               DIVIDE EMBEDDED INDEX QUANTITY  02571513
*                                          BY TRACKS/CYLINDER           02572213
         LTR   RSIX,RSIX                CHECK REMAINDER FOR ZERO        02572913
         BC    7,INVSPACE               BRANCH IF NOT AN INTEGRAL       02573613
*                                          NUMBER OF CYLINDERS          02574313
NOTHERE  AR    RNINE,RSEVEN             ADD TO PRIMARY QUANTITY THE     02575013
*                                          EMBEDDED INDEX QUANTITY      02575713
         TM    DS4VTOCI,X'80'           THE FORMAT 4 IS CHECKED FOR AN  02576413
*                                          INDICATION THAT THE VTOC IS  02580000
*                                          NOT IN THE EXPECTED FORM.    02600000
*                                          (SUCH AS A VOLUME INITIAL-   02620000
*                                           IZED BY BOS)                02640000
         BC    1,GOODQTY                BRANCH IF VTOC NOT IN THE       02660000
*                                          EXPECTED CONDITION           02680000
*                                                                       02690002
* THIS SECTION RELOCATES THE CHANNEL PROGRAM TO READ IN THE F5          02700000
*                                                                       02710002
GOREAD   EQU   *                        BRANCH LABEL             Y02080 02720002
         MVC   COUNT,DADSMADR           MOVE IN FIRST F5 CCHHR   Y02080 02730002
         LM    RZERO,RFIVE,CHANPROG    PICK UP FIRST 3 CCW'S            02740000
         ALR   RZERO,RWORK                                              02760000
         ALR   RTWO,RWORK                                               02780000
         ALR   RFOUR,RWORK                                              02800000
         STM   RZERO,RFIVE,CCW1        STORE FIRST 3 CCW'S              02820000
         MVC   SEEK+THREE(FIVE),COUNT   MOVE CCHHR TO IOB SEEK   Y02080 02840002
         LA    RFOUR,CCW1               UPDATE IOB TO POINT TO THE      02860000
         ST    RFOUR,IOB+16             FIRST CCW TO BE EXECUTED A38860 02890021
* THIS SECTION SETS UP FOR THE SEARCH FOR AVAILABLE EXTENTS             02920000
SUCCIO   MVC   DS5FMTID(90),DS5FMTID+1  TAKE OUT 1 BYTE FORMAT ID       02940000
         LA    RONE,26                  SET UP ENTRY COUNTER            02960000
         LA    RTWO,DS5AVEXT            SET UP ENTRY POINTER            02980000
         XC    PDLIST(4),PDLIST                                         03000000
         TM    JFCBCTRI,X'DF'           TEST FOR ABSOLUTE TRACK OR      03020000
*                                          CYLINDER REQUEST             03040000
         BC    4,CYLREQ                 BRANCH IF REQUEST FOR CYLINDERS 03060000
COMPRTA  CLC   ABSTR(2),0(RTWO)         CHECK FOR AN RTA HIGHER THAN    03080000
*                                          SEARCH RTA                   03100000
         BNH   STOPHERE                 BRANCH IF THIS RTA IS HIGHER OR 03120000
*                                          EQUAL TO THE REQUEST         03140000
         OC    5(5,RTWO),5(RTWO)        CHECK FOR THE LAST ENTRY IN THE 03160000
*                                          FORMAT 5                     03180000
         BE    CHECKOUT                 BRANCH IF THIS THE LAST F5      03200000
*                                          ENTRY                        03220000
         BCTR  RONE,0                   DECREMENT ENTRY POINTER         03240000
         LTR   RONE,RONE                TEST THE ENTRY NUMBER FOR THE   03260000
*                                          LAST OF 26 F5 ENTRIES        03280000
         BZ    CHECKOUT                 BRANCH IF LAST FORMAT 5 ENTRY   03300000
         LA    RTWO,5(RTWO)             INCREMENT ENTRY POINTER         03320000
         B     COMPRTA                                                  03340000
* THIS SECTION CHECKS FOR THE LAST EXTENT BEING THE DESIRED ONE         03360000
CHECKOUT MVC   PDLIST(5),0(RTWO)        CHECK FOR END RTA GREATER THAN  03380000
         LH    RFIVE,PDLIST+2              RTA LOOKING FOR              03400000
         MH    RFIVE,DS4DEVSZ+2         MULTIPLY THE NUMBER OF          03420000
*                                          CYLINDERS BY TRACKS PER      03440000
*                                          CYLINDER                     03460000
         SR    RFOUR,RFOUR                                              03480000
         IC    RFOUR,PDLIST+4                                           03500000
         AR    RFOUR,RFIVE              ADD IN THE NUMBER OF EXCESS     03520000
*                                          TRACKS                       03540000
         LH    RFIVE,PDLIST                                             03560000
         AR    RFOUR,RFIVE                                              03580000
         CH    RFOUR,ABSTR              CHECK ENDING RTA                03600000
         BNH   GOCHECK                  BRANCH IF THIS RTA IS NOT       03620000
*                                          HIGHER THAN THE REQUEST      03640000
         SH    RFOUR,ABSTR              CALCULATE DIFFERENCE BETWEEN    03660000
         LR    RFIVE,RFOUR                 RTA'S IN CYLINDERS           03680000
         SR    RFOUR,RFOUR                                              03700000
         LH    RSIX,DS4DEVSZ+2                                          03720000
         DR    RFOUR,RSIX               DIVIDE DIFFERENCE BY NUMBER OF  03740000
*                                          TRACKS PER CYLINDER          03760000
         CR    RFIVE,RNINE              COMPARE AVAILABLE QUANTITY TO   03780000
*                                          THAT REQUESTED               03800000
         BNL   GOODQTY                  BRANCH IF QUANTITY AVAILABLE IS 03820000
*                                          SUFFICIENT                   03840000
         B     QTYNOTAV                 QUANTITY AVAILABLE IS NOT AS    03860000
*                                          NUCH AS IS NEEDED            03880000
GOCHECK  OC    DS5PTRDS(5),DS5PTRDS     CHECK THE CHAIN ADDRESS FIELD   03900000
*                                          OF THE FORMAT 5 DSCB         03920000
         BZ    RTANOT                   BRANCH IF THIS THE LAST F5      03940000
* THIS SECTION UPDATES THE SEARCH ADDRESS OF THE F5                     03960000
UPDATESK MVC   SEEK+3(5),DS5PTRDS       UPDATE SEEK ADDRESS             03980000
         MVC   COUNT,DS5PTRDS           UPDATE F5 SEARCH ADDRESS Y02080 04000002
* EXECUTE THE CHANNEL PROGRAM TO READ IN A DSCB FORMAT 5                04020000
         MVI   ECB,X'00'                ZERO FIRST BYTE OF ECB   S21016 04040021
         EXCP  IOB                                                      04060000
         WAIT  1,ECB=ECB                                                04080000
         TM    ECB,X'20'               CHECK THE ECB FOR SUCCESSFUL     04100000
*                                         COMPLETION                    04120000
         BC    1,SUCCIO                 BRANCH IF SUCCESSFUL COMPLETION 04140000
IOERROR  EQU   *                                                 S21016 04160021
         LA    RFIVE,IOERRCDE           SET I/O ERROR CODE       S21016 04180021
FREEUP   EQU   *                                                 A38860 04200021
         LA    RTWO,ERRORLD             POINT TO ID OF IGG032I7  Y02080 04220002
         B     XCTLSKIP                                                 04240000
* THIS SECTION SETS THE ERROR CODE FOR REQUESTED RTA NOT AVAILABLE      04260000
RTANOT   EQU   *                                                 S21016 04270021
         LA    RFIVE,NOTAVAIL           RTA NOT AVAILABLE ERROR  S21016 04280021
         B     FREEUP                                                   04300000
* THIS SECTION CHECKS FOR THIS EXTENT HAVING QUANTITY AND RTA DESIRED   04320000
STOPHERE BE    CHECKQTY                 BRANCH IF RTA IS EQUAL TO THE   04340000
*                                          REQUESTED RTA                04360000
         LA    RZERO,DS5AVEXT           PICK UP ADDRESS OF 1ST ENTRY    04380000
*                                          IN F5                        04400000
         CR    RZERO,RTWO               CHECK FOR FIRST F5 ENTRY        04420000
         BE    RTANOT                   BRANCH IF THIS THE FIRST F5     04440000
*                                          ENTRY - RTA NOT AVAILABLE    04460000
         LA    RTHREE,5                 BACK UP ONE ENTRY               04480000
         SR    RTWO,RTHREE                                              04500000
*    THIS IS THE FORMULA FOR THE FOLLOWING CALCULATIONS            1227 04520014
*                  YY - ( ABSTR - XX ) / DS4DEVSZ                  1227 04540014
         MVC   PDLIST(5),0(RTWO)   PICK UP NEXT ENTRY              1227 04560014
         LH    RFIVE,PDLIST        GET STARTING TT                 1227 04580014
         LH    RSEVEN,ABSTR        GET ABSTR REQUESTED             1227 04600014
         SR    RSEVEN,RFIVE        OBTAIN DIFFERENCE               1227 04620014
         SR    RSIX,RSIX           ZERO REGISTER                   1227 04640014
         LH    REIGHT,DS4DEVSZ+2   PICK UP = TRACKS/CYL            1227 04660014
         DR    RSIX,REIGHT                                         1227 04680014
         LH    RSIX,PDLIST+2                                            04700000
         SR    RSIX,RSEVEN                                              04720000
         LTR   RSIX,RSIX           TEST FOR RTA NOT AVAILABLE    A36850 04726020
         BNP   RTANOT              BRANCH IF RTA NOT AVAILABLE   A36850 04732020
         CR    RSIX,RNINE               CHECK FOR ENOUGH QUANTITY       04740000
         BNL   GOODQTY                  BRANCH IF QUANTITY AVAILABLE    04760000
*                                          IS SUFFICIENT                04780000
* THIS SECTION SETS THE ERROR CODE FOR QUANTITY REQUESTED NOT AVAILABLE 04800000
QTYNOTAV EQU   *                                                 S21016 04810021
         LA    RFIVE,NOTENUFF           QUANTITY NOT AVAILABLE   S21016 04820021
         B     FREEUP                                                   04840000
CHECKQTY MVC   PDLIST(5),0(RTWO)       CHECK FOR ENOUGH CYLINDERS       04860000
         LH    RFIVE,PDLIST+2                                           04880000
         CR    RNINE,RFIVE             COMPARE THE NUMBER OF CYLINDERS  04900000
*                                         REQUESTED TO THE NUMBER       04920000
*                                         AVAILABLE                     04940000
         BH    QTYNOTAV                BRANCH IF QUANTITY AVAILABLE IS  04960000
*                                         NOT SUFFICIENT                04980000
* THIS SECTION BUILDS A ONE ENTRY DADSM TABLE                           05000000
GOODQTY  LH    RTWO,ABSTR               USE RTA REQUESTED AS THE        05020000
         STH   RTWO,ENTRIES                BEGINNING RTA                05040000
         MH    RNINE,DS4DEVSZ+2         MULTIPLY THE NUMBER OF          05060000
*                                          CYLINDERS REQUESTED BY THE   05080000
*                                          NUMBER OF TRACKS PER         05100000
*                                          CYLINDER - -                 05120000
         AR    RTWO,RNINE               ADD TO BEGINNING RTA TO GET     05140000
         STH   RTWO,ENTRIES+2              ENDING RTA                   05160000
MOVEONE  MVI   ENTRYNUM,X'01'           SET NUMBER OF ENTRIES IN DADSM  05180000
*                                          TABLE                        05200000
         MVI   ENTRIES+4,X'00'                                          05220000
* THIS SECTION SETS UP THE WTG TABLE TO TRANSFER CONTROL TO ANOTHER     05240002
* LOAD MODULE                                                           05260000
XCTLHERE EQU   *                                                 A38860 05280021
         LA    RTWO,NEXTLOAD            POINT TO ID OF IGG032I3  Y02080 05300002
XCTLSKIP EQU   *                                                 A38860 05320021
         MVI   ASWITCH,ZERO             ZERO THE ALLOCATE SWITCH Y02080 05340002
         IECRES LOAD,EXTPR=(RWORK),MODID=(RTWO),BRANCH=DIRECT    Y02080 05360002
*                                                                       05400000
* FOR A CONTIGUOUS REQUEST, THIS SECTION FINDS THE SMALLEST             05410002
* FORMAT 5 EXTENT ON THE VOLUME THAT FILLS THE REQUEST.                 05412002
*                                                                       05420000
CHEKHELD EQU   *                        BRANCH LABEL             Y02080 05430002
         CLI   ASWITCH,HELDQTY          CHECK FOR HELD QUANTITY  Y02080 05440002
         BE    HAVEHELD                 BRANCH IF THERE IS A HELD       05500000
*                                          QUANTITY                     05520000
         MVI   ASWITCH,HELDQTY          SET ON HELD FLAG         Y02080 05540002
THERE    MVC   PDLIST+20(5),0(RTWO)     MOVE IN F5 ENTRY                05560000
MORENTS  BCTR  RONE,0                  CHECK FOR MORE EXTENTS IN F5     05580000
         LTR   RONE,RONE               CHECK IF AT 26TH F5 ENTRY        05600000
         BZ    CHECKIT                 BRANCH IF AT THE 26TH ENTRY      05620000
         LA    RTWO,5(RTWO)            UPDATE F5 ENTRY POINT            05640000
CYLREQ   MVC   ENTRIES(5),0(RTWO)                                       05660000
         TM    JFCBCTRI,X'08'          CHECK REQUEST TYPE FIELD         05680000
         BC    8,BLANK                 BRANCH IF NO OPTION CHOSEN       05700000
         CH    RNINE,ENTRIES+2         COMPARE QUANTITY REQUESTED TO    05720000
*                                         THAT AVAILABLE                05740000
         BH    MORENTS                 BRANDH IF QUANTITY TOO SMALL     05760000
CONTIG   BL     CHEKHELD               BRANCH IF QUANTITY BIGGER THAN   05780000
*                                         THAT REQUESTED                05800000
         MVC   PDLIST+20(5),ENTRIES    PICK UP F5 ENTRY IF EQUAL TO     05820000
*                                         REQUEST IN QUANTITY           05840000
         B     BUILDDAD                                                 05860000
* THIS SECTION CHECKS FOR NEW QUANTITY SMALLER THAN HELD QUANTITY       05880000
HAVEHELD CLC   PDLIST+22(2),ENTRIES+2   COMPARE NEW QUANTITY TO HELD    05900000
         BNH   MORENTS                  BRANCH IF NEW QUANTITY IS NOT   05920000
*                                          SMALLER THAN HELD QUANTITY   05940000
         B     THERE                                                    05960000
*                                                                       05980000
CHECKIT  OC    DS5PTRDS(5),DS5PTRDS     CHECK CHAIN ADDRESS FIELD FOR   06000000
*                                          ANOTHER F5                   06020000
         BC    7,UPDATESK               BRANCH IF ANOTHER F5 EXISTS     06040000
NONE     EQU   *                        BRANCH LABEL             Y02080 06050002
         CLI   ASWITCH,HELDQTY          CHECK FOR A HELD QTY- AN Y02080 06060002
*                                          ENTRY WITH QUANTITY GREATER  06080000
*                                          THAN REQUEST                 06100000
         BNE   BLAKCONT                 BRANCH IF NO HELD QUANTITY      06120000
*                                          EXISTS                       06140000
* THIS SECTION BUILDS A DADSM TABLE OF UP TO FIVE ENTRIES               06160000
BUILDDAD SR    RFOUR,RFOUR             CHECK TO SEE IF HELD QUANTITY    06180000
         LH    RFIVE,PDLIST+20             IS ON A CYLINDER BOUNDARY    06200000
         LH    RSIX,DS4DEVSZ+2             AND IF NOT ROUND UP TO THE   06220000
         DR    RFOUR,RSIX                  NEXT FULL CYLINDER           06240000
         LTR   RFOUR,RFOUR              CHECK REMAINDER- ON CYLINDER    06260000
*                                          BOUNDARY                     06280000
         BZ    NOUPDTE                  BRANCH IF ON CYLINDER BOUNDARY  06300000
         LA    RFIVE,1(RFIVE)           INCREMENT NUMBER OF CYLINDERS   06320000
NOUPDTE  MH    RFIVE,DS4DEVSZ+2         MULTIPLY NUMBER OF CYLINDERS BY 06340000
*                                          TRACKS PER CYLINDER          06360000
         STH   RFIVE,ENTRIES                                            06380000
         MH    RNINE,DS4DEVSZ+2         CONVERT THE REQUEST INTO RTA    06400000
         AR    RFIVE,RNINE                 AND RTA+1 AND BUILD A        06420000
         STH   RFIVE,ENTRIES+2             DADSM TABLE WITH ONLY ONE    06440000
*                                          ENTRY                        06460000
         MVI   ASWITCH,ZERO              INDICATE NO HELD QTY    Y02080 06480002
         B     MOVEONE                                                  06520000
* THIS SECTION IS FOR BLANK REQUESTS                                    06540000
BLANK    CH    RNINE,ENTRIES+2          CHECK QUANTITY AVAILABLE TO SEE 06560000
*                                          IF ENOUGH                    06580000
         BNH   CONTIG                   BRANCH IF QUANTITY AVAILABLE IS 06600000
*                                          SUFFICIENT                   06620000
         CLI   ASWITCH,HELDQTY          TEST FOR A HELD QUANTITY Y02080 06640002
         BE    MORENTS                 BRANCH IF THERE IS A HELD        06660000
*                                         QUANTITY                      06680000
* THIS SECTION BUILDS A SORTED PUSH DOWN LIST                           06700000
BUILDPDL CLC   PDLIST+2,ENTRIES+2       COMPARE THE NEW QUANTITY TO THE 06720000
*                                          SMALLEST IN THE PUSH DOWN    06740000
*                                          LIST                         06760000
         BNL   MORENTS                  BRANCH IF NEW QUANTITY IS NOT   06780000
*                                          LARGER                       06800000
         MVC   PDLIST(5),ENTRIES        MOVE IN NEW QUANTITY AND DO A   06820000
         LA    REIGHT,PDLIST+5             SORT OF THE PUSH DOWN LIST   06840000
         LA    RSEVEN,4                 SET UP PD LIST PTR AND CTR      06860000
         LA    RSIX,PDLIST                                              06880000
LOOPFOR  CLC   2(2,RSIX),2(REIGHT)      COMPARE TWO ENTRIES IN PUSH     06900000
*                                          DOWN LIST                    06920000
         BNH   ENDTEST                  BRANCH IF NO NEED TO            06940000
*                                         EXCHANGE THEM                 06960000
EXCHANGE EQU   *                        BRANCH LABEL             Y02080 06970002
         MVC   SAVEREGB+3(5),0(REIGHT)  EXCHANGE TWO PDLIST ENTRIES     06980013
         MVC   0(5,REIGHT),0(RSIX)                                      07000000
         MVC   0(5,RSIX),SAVEREGB+3                                     07020000
* CHECK FOR LAST ENTRY                                                  07040000
ENDTEST  BCTR  RSEVEN,0                 REDUCE ENTRY COUNTER            07060000
         LTR   RSEVEN,RSEVEN            TEST FOR THE LAST PUSH DOWN     07080000
*                                          LIST ENTRY                   07100000
         BZ    MORENTS                  BRANCH IF THIS IS THE LAST OF   07120000
*                                          THE PUSH DOWN LIST ENTRIES   07140000
         LA    RSIX,5(RSIX)             UPDATE PTRS TO PD LIST ENTRIES  07160000
         LA    REIGHT,5(REIGHT)                                         07180000
         B     LOOPFOR                                                  07200000
*                                                                       07220000
BLAKCONT TM    JFCBCTRI,X'08'          CHECK FOR TYPE OF CYLINDER       07240000
*                                          REQUEST                      07260000
         BC    1,QTYNOTAV               BRANCH IF THE CONTIGUOUS OPTION 07280000
*                                          - NOT SUFFICIENT SPACE       07300000
* THIS SECTION PICKS FROM PUSH DOWN LIST DESIRED QUANTITY IF AVAILABLE  07320000
PICKLIST SR    RZERO,RZERO              SET TOTAL REGISTER TO ZERO      07340000
         LA    RONE,PDLIST+20           SET UP PDLIST POINTER           07360000
         LA    RSEVEN,ENTRIES           SET UP DADSM TABLE POINTER      07380000
         LA    RTWO,5                   SET UP ADDRESS DECREMENT        07400000
         LR    RTHREE,RTWO              SET UP ENTRY COUNTER            07420000
MOVELOOP MVC   TTRLL(5),0(RONE)         MOVE ENTRY TO FULL WORD  BOUND  07440000
         LH    RFIVE,TTRLL              DETERMINE WHETHER OR NOT THE    07460000
         SR    RFOUR,RFOUR                 RTA IS ON A CYLINDER BOUND   07480000
         LH    RSIX,DS4DEVSZ+2             AND IF NOT ROUND UP TO A     07500000
         DR    RFOUR,RSIX                  CYLINDER BOUNDARY            07520000
         LTR   RFOUR,RFOUR              CHECK FOR INTEGRAL NUMBER OF    07540000
*                                          CYLINDERS                    07560000
         BZ    NOSTEPUP                 BRANCH IF ON A CYLINDER BOUND   07580000
         LA    RFIVE,1(RFIVE)           INCREMENT NUMBER OF CYLINDERS   07600000
NOSTEPUP MH    RFIVE,DS4DEVSZ+2                                         07620000
         STH   RFIVE,0(RSEVEN)          CALCULATE RTA AND RTA+1 FOR     07640000
         LH    RFOUR,TTRLL+2               DADSM TABLE ENTRY            07660000
         AR    RZERO,RFOUR                                              07680000
         MH    RFOUR,DS4DEVSZ+2                                         07700000
         CR    RZERO,RNINE              CHECK FOR QUANTITY AVAILABLE    07720000
*                                          BEING SUFFICIENT             07740000
         BNL   TAKEOUT                  BRANCH IF THE LAST PUSH DOWN    07760000
*                                          LIST ENTRY NEEDED            07780000
         AR    RFIVE,RFOUR              CALCULATE THE ENDIND RTA FOR    07800000
         STH   RFIVE,2(RSEVEN)             THIS ENTRY                   07820000
         BCT   RTHREE,UPPTRS            BRANCH IF NOT AT THE END OF THE 07840000
*                                          PUSH DOWN LIST               07860000
         B     QTYNOTAV                 QUANTITY NOT AVAILABLE          07880000
UPPTRS   SR    RONE,RTWO                UPDATE POINTERS                 07900000
         LA    RSEVEN,4(RSEVEN)                                         07920000
         B     MOVELOOP                                                 07940000
TAKEOUT  BNH   TAKE                    BRANCH IS ALL OF THE LAST ENTRY  07960000
*                                         OF THE PUSHDOWN LIST IS       07980000
*                                         NEEDED                        08000000
REDUCE   SR    RZERO,RNINE             REDUCE THE AMOUNT AVAILABLE TO   08020000
*                                         EQUAL THE AMOUNT REQUESTED    08040000
         MH    RZERO,DS4DEVSZ+2                                         08060000
         SR    RFOUR,RZERO             REDUCE AMOUNT AVAILABLE IN THE   08080000
*                                         ENTRY                         08100000
TAKE     AR    RFIVE,RFOUR              ADD IN ALL OF THE LAST ENTRY IN 08120000
*                                          THE PUSH DOWN LIST           08140000
         STH   RFIVE,2(RSEVEN)                                          08160000
         BCTR  RTHREE,0                                                 08180000
         SR    RTWO,RTHREE              SET UP NUMBER OF DADSM TABLE    08200000
         STC   RTWO,ENTRYNUM               ENTRIES                      08220000
* THIS SECTION SORTS THE DADSM TABLE                                    08240000
SORTDAD  SR    RFOUR,RFOUR                                              08260000
         IC    RFOUR,ENTRYNUM           PICK UP NUMBER OF ENTRIES       08280000
         BCTR  RFOUR,0                  REDUCE BY ONE                   08300000
SCANSTRT LR    RTHREE,RFOUR                                             08320000
         LA    RTWO,ENTRIES             SET UP POINTERS                 08340000
         LA    RFIVE,ENTRIES+4                                          08360000
COMPARE  CLC   2(2,RTWO),2(RFIVE)       CHECK FOR ENTRIES IN THE DADSM  08380000
*                                          TABLE FOR RTA SEQUENCE       08400000
         BH    CHANGTHM                 BRANCH IF ENTRIES ARE OUT OF    08420000
*                                          SEQUENCE                     08440000
REDUCT   BCT   RTHREE,UPTHEM            CHECK FOR END OF SCAN           08460000
         BCT   RFOUR,SCANSTRT           CHECK FOR END OF ENTIRE SORT    08480000
         B     XCTLHERE                                                 08500000
UPTHEM   LA    RTWO,4(RTWO)             UPDATE POINTERS                 08520000
         LA    RFIVE,4(RFIVE)                                           08540000
         B     COMPARE                                                  08560000
CHANGTHM L     RSEVEN,0(RTWO)           EXCHANGE THE ENTRIES IN THE     08580000
         MVC   0(4,RTWO),0(RFIVE)          DADSM TABLE                  08600000
         ST    RSEVEN,0(RFIVE)                                          08620000
         B     REDUCT                                                   08640000
*                                                                       08646021
* CHANNEL PROGRAM                                                       08652021
*                                                                       08660000
CHANPROG DS    0D                                                       08680000
*CCW1                                                                   08700000
         DC    X'31'                   SEARCH EQUAL ID FOR DSCB F5      08720000
         DC    AL3(0+COUNT-FIRST)       SID ON COUNT             Y02080 08740002
         DC    X'4000'                                                  08760000
         DC    H'5'                                                     08780000
*CCW2                                                                   08800000
         DC    X'08'                   TIC BACK TO SEARCH               08820000
         DC    AL3(0+CCW1-FIRST)                                        08840000
ZEROFLD  DC    F'0'                                                     08860000
*CCW3                                                                   08880000
         DC    X'0E'                                                    08900000
         DC    AL3(0+F5IN-FIRST)                                        08920000
         DC    X'0000'                                           A27089 08940019
         DC    H'140'                                                   08960000
*                                                                       08967021
* CONSTANTS                                                             08974021
*                                                                       08981021
*                                                                       08988002
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         08995002
*                                                                       08997002
         XCTLTABL ID=(NEXTLOAD,I3,ERRORLD,I7),SVC=032,LENGTH=,   Y02080X09002002
               BRT=YES                                           Y02080 09004002
         EJECT                                                   Y02080 09009002
JFCBKEN  DSECT                                                          09060000
         IEFJFCBN                                                       09100000
         EJECT                                                   Y02080 09120002
DSCBWKAR IECALLWA EP,F4,D2=(5)          ALLOCATE WORK AREA       Y02080 09140002
ENTRYNUM EQU   AENTRYNM                 EQUATE FOR AENTRYNM      Y02080 09160002
ENTRIES  EQU   AENTRIES                 EQUATE FOR AENTRIES      Y02080 09180002
SAVEREGB EQU   CCW12                    SAVE AREA                Y02080 09200002
         EJECT                                                   Y02080 09220002
CVT      DSECT                          CVT DSECT                Y02080 09240002
         CVT                                                     Y02080 09260002
         END                                                            10320000
