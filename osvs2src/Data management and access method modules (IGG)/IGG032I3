 TITLE 'IGG032I3 - ISAM ALLOCATE - BUILDS F1,F2,F3 DSCBS'               00020000
IGG032I3 CSECT                                                          00028000
*                                                                       00030002
*MODULE NAME = IGG032I3                                                 00032002
*                                                                       00034002
*DESCRIPTIVE NAME = ISAM ALLOCATE - BUILDS F1, F2, AND F3 DSCB'S        00034402
*                                                                       00034802
*COPYRIGHT = NONE                                                       00035202
*                                                                       00035602
*CHANGE ACTIVITY = SEE BELOW                                            00035702
*                                                                       00035802
*          RELEASE 16 DELETIONS                                         00036000
*1462098200                                                        AAAA 00040016
*1462029200,058200-058400                                         13559 00041016
*1462                                                             15708 00042016
*          RELEASE 17 DELETIONS                                         00044000
*          RELEASE 18 DELETIONS                                         00052000
*1662031200,031400,048200                                         23475 00056018
*          RELEASE 19 DELETIONS                                         00060000
*          RELEASE 20 DELETIONS                                         00068000
*1291033400,041700-041800,047200-047600,053200-055600            S20016 00072020
*          RELEASE 21 DELETIONS                                         00076000
*0000003400,017200,018200-018800,020800,026200-026400,           A38860 00077021
*0000026800-027000,034800-035000,037000-038400,038480,           A38860 00078021
*0000038600-039600,043220-043340,066600,069000-069200,           A38860 00079021
*0000070000-070600,070800,100600                                 A38860 00080021
*0000030800,031100-031800,034400-034600,036200,087700            M0184  00081021
*          RELEASE 22 DELETIONS                                         00084000
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00092002
*0000000030-000150,000920-001000,002800,003400,005600,006000,    Y02080 00092102
*0000017800,018300-018600,025600,029400,030200,040800,041650-    Y02080 00092202
*0000042800,043360,043600,045000,048000,056600,061200,061900,    Y02080 00092302
*0000064400,069400-069800,070700-070800,088100,088650-088800,    Y02080 00092402
*0000089200,089600-103600                                        Y02080 00092502
*0000005200,008400,024640,024710,038480,039320-041400,088000     Y02134 00092602
*0000                                                            Y02144 00092702
*0000                                                            Y02082 00092802
*0000006200,060800-062200,089720-088600,089500,097800-098000     YM3995 00093002
*                                                                     * 00093402
*          VS2 RELEASE 03.0 DELETIONS/CHANGES                         * 00095002
*0000087900                                                     ZA00704 00097002
*          VS2 RELEASE 03.7 CHANGES/SU8                                 00098008
*A038045-038051                                                @ZA15055 00099008
*                                                                       00100002
*STATUS CHANGE LEVEL 005                                                00110020
*FUNCTION - THIS MODULE CHECKS FOR EMBEDDED INDEX AND AN EXISTING DSCB  00120000
*           FORMAT1 AND MAKES THE APPROPRIATE TRANSFER OF CONTROL. IF   00140000
*           NEITHER IS THE CASE IT BUILDS A DSCB FORMAT1 AND IF NECES-  00160000
*           SARY A DSCB FORMAT2 AND/OR FORMAT 3. THE DSCB'S CREATED ARE 00180000
*           WRITTEN OUT AND A TRANSFER OF CONTROL TO THE MODULE         00200000
*           IGG032I6 IS MADE.                                           00220000
*                                                                       00240000
*ENTRIES - THE ONLY ENTRY POINT TO THIS MODULE IS IGG032I3. ENTRY IS    00260000
*           MADE FROM THE SECOND LOAD OF ISAM ALLOCATE VIA A BRANCH.    00280002
*                                                                       00300000
*INPUT - AT ENTRY TO THIS MODULE REG 11 POINTS TO A JFCB. REGISTER      00320000
*        13 POINTS TO THE ALLOCATE WORK AREA CONTAINING THE VTOCADR,    00340002
*        THE DADSMADR, AND A FORMAT 1 DSCB IF ONE EXISTS. A SORTED      00360000
*        DADSM TABLE WILL BE IN THE WORK AREA.                          00380000
*                                                                       00380721
*        IF MORE THAN ONE DD STATEMENT IS USED IN REQUESTING SPACE,     00381421
*        THE SEVEN LOW-ORDER BYTES OF THE DDNAME FIELD IN ALL BUT THE   00382121
*        FIRST ISAM DD ENTRY ARE USED TO CREATE THE FOLLOWING SPECIAL   00382821
*        ISAM ALLOCATE INTERFACE:                                       00383521
*                                                                       00384221
*              BYTE 1                                                   00384921
*                   BITS 0 AND 1   00 - ABSOLUTE TRACK REQUEST          00385621
*                                  01 - BLANK SPACE REQUEST             00386321
*                                  11 - CONTIGUOUS SPACE REQUEST        00387021
*                                                                       00387721
*                   BIT 2          THIS IS THE SECOND DD CARD.          00388421
*                                                                       00389121
*                   BIT 5          OVFLOW HAS BEEN ALLOCATED.           00389821
*                                                                       00390521
*                   BIT 6          PRIME HAS BEEN ALLOCATED.            00391221
*                                                                       00391921
*                   BIT 7          INDEX HAS BEEN ALLOCATED.            00392621
*                                                                       00393321
*              BYTES 2 - 3         CURRENT VOLUME SEQUENCE NUMBER       00394021
*                                  FOR SECOND OR THIRD DD ENTRY         00394721
*                                                                       00395421
*              BYTES 4 - 7         POINTER TO THE FIRST TIOT ENTRY      00396121
*                                  FOR THIS REQUEST                     00396821
*                                                                       00397521
*                                                                       00400000
*OUTPUT - UPON TRANSFERRING TO THE NEXT MODULE IGG032I6,THE  WORK AREA  00420000
*         WILL CONTAIN A SORTED DADSM TABLE, THE VTOCADR AND DADSMADR.  00440000
*                                                                       00460000
*EXTERNAL ROUTINES - THE FOLLOWING ARE SUPERVISOR CALLS ISSUED IN THE   00480000
*   MACRO EXPANSIONS                                                    00500000
*   EXCP(0) READ FROM OR WRITE TO DIRECT ACCESS DEVICE                  00520002
*   WAIT(1) WAIT ON EVENT CONTROL BLOCK                                 00540000
*                                                                       00570002
*   OTHER MACROS ISSUED - IEFJFCBN - BUILDS JFCB                        00580000
*                         IECALLWA - ALLOCATE WORK AREA EXPANSION       00590002
*                         IECSDSL1 - BUILDS DSCBS                       00600002
*                         IECDSECS - EXPANDS CVT, PSA, SCVT, UCB DSECTS 00620002
*                                                                       00640000
*                                                                       00660000
*EXITS - NORMAL - TO IGG032I4 WHEN F1,F2,F3 ALREADY EXIST               00680000
*               - TO IGG032I5 FOR EMBEDDED INDEX                        00700000
*               - TO IGG032I6 WHEN F1,F2,F3 ARE BUILT                   00720000
*      - ERROR - TO IGG032I7 WITH ERROR CODE IN REG5                    00740000
*                                                                       00760000
*              0C   PERMANENT I/O ERROR                                 00780000
*                                                                       00800000
*              1C - WRONG DSORG OR DISP                                 00806021
*                                                                       00812021
*                                                                       00820000
*TABLES/WORK AREAS - DADSM WORK AREA DESCRIBED BY MACRO IECALLWA        00840002
*                                                                       00860000
*                                                                       00880000
*              ***************************************                  00900000
*              *             DADSM TABLE             *                  00920000
*              ***************************************                  00940000
*                                                                       00960000
*              ***************************************                  00980000
*              *        *         *                  *                  01000000
*              *  TYPE  *  NO OF  *     USED HOLE    *                  01020000
*              *  FLAG  * ENTRIES *      COUNTER     *                  01040000
*              *        *         *                  *                  01060000
*              ***************************************                  01080000
*              *                  *                  *                  01100000
*              *       RTA        *      RTA+1       *                  01120000
*              *                  *                  *                  01140000
*              ***************************************                  01160000
*              *                  *                  *                  01180000
*              *       RTA        *      RTA+1       *                  01200000
*              *                  *                  *                  01220000
*              ***************************************                  01240000
*              *                  *                  *                  01260000
*              *       RTA        *      RTA+1       *                  01280000
*              *                  *                  *                  01300000
*              ***************************************                  01320000
*              *                  *                  *                  01340000
*              *       RTA        *      RTA+1       *                  01360000
*              *                  *                  *                  01380000
*              ***************************************                  01400000
*              *                  *                  *                  01420000
*              *       RTA        *      RTA+1       *                  01440000
*              *                  *                  *                  01460000
*              ***************************************                  01480000
*                                                                       01500000
*                                                                       01520000
*              TYPE FLAG = 02 - BPAM DIRECTORIES REQUESTED.             01540000
*                                                                       01560000
*                        = 40 - USER LABELS REQUESTED                   01564021
*                                                                       01568021
*                        = 80 - SET MUST COMPLETE IS ACTIVE             01572021
*                                                                       01576021
*                                                                       01580000
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.    01600000
*                                                                       01620000
*                                                                       01640000
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.        01660000
*                                                                       01680000
*                                                                       01700000
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT. 01720021
*                                                                       01740000
*                                                                       01760000
*ATTRIBUTES - REENTRANT                                                 01780002
*                                                                       01800000
*STORAGE - PROGRAM CODE CSECT = LESS THAN 2048 BYTES                    01830002
*          WORK AREA = AS DEFINED IN THE IECALLWA MACRO                 01860002
*          RPS WORK AREA = AS DEFINED IN THE IECRPS MACRO               01870002
*                                                                       01900000
*                                                                       01920000
*REGISTER USAGE                                                         01940000
*              REGISTERS 0-9 WORK REGISTERS                             01960000
*              REGISTER 10 - TIOT SET UP TABLE POINTER                  01980000
*              REGISTER 11 - JFCB POINTER                               02000000
*              REGISTER 12 - BASE REGISTER                              02020000
*              REGISTER 13 - WORK AREA POINTER                          02040000
*              REGISTER 14 SUBROUTINE LINKAGE AND WORK REGISTER         02060000
*              REGISTER 15 WORK REGISTER                                02080021
***** REGISTER NAMES *****                                              02100000
RZERO    EQU   0                                                        02120000
RONE     EQU   1                                                        02140000
RTWO     EQU   2                                                        02160000
RTHREE   EQU   3                                                        02180000
RFOUR    EQU   4                                                        02200000
RFIVE    EQU   5                                                        02220000
RSIX     EQU   6                                                        02240000
RSEVEN   EQU   7                                                        02260000
REIGHT   EQU   8                                                        02280000
RNINE    EQU   9                                                        02300000
DRBAK   EQU   9                                                         02320000
RTEN     EQU   10                                                       02340000
RJFCB    EQU   11                                                       02360000
RBASE    EQU   12                                                       02380000
RWORK    EQU   13                                                       02400000
RETURN   EQU   14                                                       02420000
RFTEN    EQU   15                                                       02440000
*                                                                       02460000
* OTHER EQUATES                                                         02461021
*                                                                       02462021
ZERO     EQU   0                        CONSTANT OF 0            Y02134 02462402
K1       EQU   1                        CONSTANT OF 1            Y02082 02462602
F1ID     EQU   C'1'                     FORMAT ONE IDENTIFIER    M0184  02463002
STEPMC   EQU   1                        STATUS STEP MC INDICATOR YM3995 02463402
K12      EQU   12                       CONSTANT OF 12           YM3995 02463802
TIOEVOLS EQU   2                        DISP TO NBR OF DEVICES   A38860 02465002
TIOEDDNM EQU   4                        OFFSET TO DDNAME         A38860 02466002
ISAMSTAT EQU   5                        DISP TO ALLOCAT'N STATUS A38860 02467002
VOLSQCTR EQU   6                        OFFSET TO DS1VOLSQ CTR   A38860 02468002
TIOTPTR  EQU   8                        PTR TO 1ST TIOT ENTRY    A38860 02469002
UCBENTRY EQU   16                       OFFSET TO 1ST UCB ENTRY  A38860 02470002
BLANK    EQU   X'40'                    EBCDIC BLANK             A38860 02472002
RDWOPSWD EQU   X'04'                    READ-W/O-PASSWORD SWITCH Y02080 02474002
TWO      EQU   2                        CONSTANT OF TWO          Y02080 02476002
FOUR     EQU   4                        CONSTANT OF FOUR         Y02134 02477002
FIVE     EQU   5                        CONSTANT OF FIVE         Y02080 02479002
RESBITS  EQU   X'13'                    DSORG RESERVE BITS       Y02080 02479402
DS1RACDF EQU   X'40'                    DS1DSIND-DATA SET IS   @Z40RSGD 02479508
*                                       RAC DEFINED            @Z40RSGD 02479608
F2NEEDED EQU   X'80'                    FORMAT 2 NOT WRITTEN   @Z40RSGD 02479708
RACERR   EQU   X'A4'                    RAC ERROR CODE BASE    @Z40RSGD 02479808
TIOEFSRT EQU   X'10'                    OFFSET TO UCB          @Z40RSGD 02479908
*                                                                       02480000
         BALR  RBASE,0                                                  02520000
         USING BETA,RBASE                                               02540000
         USING ALLOCWKA,RWORK           WORK AREA ADDRESSABILITY Y02080 02560002
         USING JFCBKEN,RJFCB                                            02580000
*                                                                       02600000
* THIS SECTION RELOCATES THE CHANNEL PROGRAM TO BE USED BY IGG032I3,    02610021
* IGG032I4, AND IGG032I5. THIS CHANNEL PROGRAM WILL BE USED TO SEARCH   02620021
* FOR HOLES IN THE VTOC AND TO WRITE OUT OR READ IN FORMAT 1, 2, AND 3  02630021
* DSCB'S.                                                               02640021
*                                                                       02650021
BETA     LM    RZERO,RNINE,CHANNPR      RELOCATE CHANNEL PROGRAM        02660000
         ALR   RZERO,RWORK                                              02720000
         ALR   RFOUR,RWORK                                              02740000
         ALR   RSIX,RWORK                                               02760000
         STM   RZERO,RNINE,CCW1                                         02780000
         LM    RZERO,RNINE,CHANNPR+40    PICK UP 5 CCW'S                02800000
         ALR   RTWO,RWORK                                               02820000
         ALR   REIGHT,RWORK                                             02840000
         STM   RZERO,RNINE,CCW6                                         02860000
         LM    RZERO,RONE,CHANNPR+80                                    02880000
         STM   RZERO,RONE,CCW11                                         02900000
FINE     CLI   DS1FMTID,X'F1'           CHECK FOR EXISTENCE OF LEGAL    02960000
*                                          DUPLICATE NAME FORMAT 1 DSCB 02980000
         BNE   FROMJFCB                 BRANCH IF THERE IS NO F 1       03000000
         LA    RTWO,MOD32I4             POINT TO ID OF IGG032I4  Y02080 03010002
         B     XCT                                                      03040000
* THIS SECTION BUILDS ALL BUT THE EXTENT FIELDS OF A FORMAT 1 DSCB      03060000
FROMJFCB EQU   *                                                 M0184  03070021
         XC    DS1FMTID(DS1END-DS1FMTID),DS1FMTID  CLEAR F1 DSCB M0184  03080021
*                                                              @Z40RSGD 03081108
*   SET RAC DEFINED BIT IN FORMAT 1 DSCB IF AUTOMATIC DATA SET @Z40RSGD 03082208
*   PROTECTION REQUESTED IN JFCB.                              @Z40RSGD 03083308
*                                                              @Z40RSGD 03084408
         USING CVT,RFTEN                                       @ZA15055 03084508
         L     RFTEN,CVTPTR             GET ADDRESS OF CVT     @ZA15055 03084608
         L     RFTEN,CVTRAC             LOAD ACCESS CNTL ADDR  @ZA15055 03084708
         LA    RFTEN,0(,RFTEN)          CLEAR HI-ORD           @ZA15055 03084808
         LTR   RFTEN,RFTEN              RAC ACTIVE?            @ZA15055 03084908
         DROP  RFTEN                                           @ZA15055 03085008
         BZ    NORACBIT                 NO-CONTINUE            @ZA15055 03085108
         TM    JFCFLGS1,JFCBADSP        AUTO DATA SET PROTECT  @Z40RSGD 03085508
         BZ    NORACBIT                 NO-CONTINUE            @Z40RSGD 03086608
         OI    DS1DSIND,DS1RACDF        YES-SET RAC PROTECTED  @Z40RSGD 03087708
*                                       INDICATOR              @Z40RSGD 03088808
NORACBIT EQU   *                                               @Z40RSGD 03089908
         MVI   DS1FMTID,F1ID            MOVE IN F1 IDENTIFIER    M0184  03090021
         MVC   DS1CREDT(6),JFCBCRDT     CREATION AND EXPIRATION DATES   03100000
         MVC   DS1SYSCD(13),SYSCODE     MOVE IN SYSTEM CODE      M0184  03150021
         MVC   DS1DSORG(8),JFCDSORG     SET UP DATA SET ORGANIZATION    03200000
*                                       RECORD FORMAT                   03220000
*                                       OPTION CODE                     03240000
*                                       BLOCK LENGTH                    03260000
*                                       RECORD LENGTH                   03280000
         NI    DS1DSORG+K1,X'FF'-RESBITS CLEAR THE RESERVED BITS Y02082 03285002
         MVC   DS1KEYL(1),JFCKEYLE      RELATIVE KEY FIELD              03300000
         MVC   DS1RKP(2),JFCRKP         FLAG FIELD AND SECONDARY QTY    03320000
         TM    JFCBIND2,JFCBSCTY        DOES JFCB SPEC SECURITY  S20016 03340020
         BZ    NOSECTY                  BRANCH IF NO                    03360000
         OI    DS1DSIND,X'10'           SET SECURITY BIT IN DSCB F1     03380000
         TM    JFCBIND2,JFCBRWPW        DOES JFCB SPEC RWPW OPTN S20016 03385020
         BNO   NOSECTY                  BRANCH IF NO             S20016 03390020
         OI    DS1DSIND,RDWOPSWD        IND SECTY IS FOR WR ONLY S20016 03395020
NOSECTY  MVC   DS1SCALO(4),JFCBCTRI     SET REQUEST TYPE AND SECONDARY  03400000
*                                          QUANTITY                     03420000
         CLI   TIOEDDNM(RTEN),BLANK     CHECK FOR DDNAME FOR     A38860 03450021
*                                       THIS ENTRY IN THE TIOT   A38860 03480021
         BE    NOTFIRST                 BRANCH IF THIS NOT THE FIRST    03520000
         MVC   DS1DSSN(6),JFCBVOLS      MOVE IN DATA SET VOL SEQ NUM    03540000
         IC    RSIX,CTR                 PICK UP NUMBER OF VOLUMES       03560000
         LA    RSIX,1(RSIX)                COUNTER                      03580000
         STC   RSIX,DS1VOLSQ+1          SET VOLUME SEQUENCE NUMBER      03600000
         B     FILLEXTS                                                 03640000
* THIS SECTION CALCULATES THE VOLUME SEQUENCE NUMBER AND PICKS UP THE   03660000
* DATA SET SERIAL NUMBER FOR THE SECOND OR THIRD DD ENTRY               03680000
NOTFIRST EQU   *                                                 A38860 03700021
         LH    RSIX,VOLSQCTR(,RTEN)     GET NUMBER OF DEVICES    A38860 03720021
         LA    RSIX,1(RSIX)             INCREMENT THIS NUMBER    A38860 03740021
         STH   RSIX,VOLSQCTR(,RTEN)                              A38860 03760021
         MVC   DS1VOLSQ(2),VOLSQCTR(RTEN)  MOVE IN VOL SEQ NBR   A38860 03780021
*                                                                 15708 03841016
*              NO DDNAME IMPLIES CONCATENATION WITH A             15708 03842016
*              PREVIOUS DD CARD.  A BLANK TIOT POINTER ENTRY      15708 03843016
*              INDICATES THAT AN INVALID CONDITION EXISTS,        15708 03844016
*              DSORG=IS WAS NOT SPECIFIED FOR THE PRECEEDING      15708 03845016
*              DD CARD.                                           15708 03846016
*                                                                 15708 03847016
         CLC   TIOTPTR(FOUR,RTEN),BLANKS  CHECK PTR FOR BLANKS   Y02134 03848002
         BC    7,CONTINUE         BRANCH IF NOT EQUAL TO BLANKS   15708 03849016
         LA    RFIVE,28           INVALID REQUEST                 15708 03850016
         B     ERRORXCT                                           15708 03851016
CONTINUE EQU   *                                                  15708 03852016
         L     RSIX,TIOTPTR(,RTEN)      PTR TO 1ST TIOT ENTRY    A38860 03892021
         L     RTWO,UCBENTRY(,RSIX)     GET 1ST UCB ADDRESS      Y02134 03980002
         LA    RTWO,ZERO(,RTWO)         CLEAR HIGH BYTE          Y02134 04000002
         USING UCB,RTWO                                                 04160000
         MVC   DS1DSSN(6),SRTEVOLI      PICK UP VOLUME SERIAL    S20016 04161020
*                                       NO.                      S20016 04162020
FILLEXTS EQU   *                        BRANCH LABEL             Y02080 04212002
         LA    RTWO,AENTRIES            PICK UP DADSMTBL POINTER Y02080 04280002
         LA    RTHREE,DS1EXT1           PICK UP F1 EXTENT POINTER       04300000
         LA    RFOUR,3                  SET UP EXTENT COUNTER           04320000
         MVC   DS1NOEPV,AENTRYNM        STORE NUMBER OF EXTENTS  Y02080 04336002
         SR    RNINE,RNINE                                              04340000
         IC    RNINE,AENTRYNM           LOAD THE NBR OF ENTRIES  Y02080 04360002
*                                          IN THE DADSM TABLE           04380000
*                                                                       04400000
TEST1    OC    DIRQTY(2),DIRQTY         CHECK FOR EMBEDDED INDEX        04420000
*                                          QUANTITY                     04440000
         BZ    GOOD                     BRANCH IF NO EMBEDDED INDEX     04460000
*                                          QUANTITY REQUESTED           04480000
         LA    RTWO,MOD32I5             POINT TO ID OF IGG032I5  Y02080 04490002
         B     XCT                                                      04520000
GOOD     SR    RFIVE,RFIVE              SET EXTENT SEQUENCE NUMBER      04540000
         XC    F5IN+135(5),F5IN+135     CLEAR CHAIN FIELD               04560000
* THIS SECTION FILLS IN THE EXTENT FIELDS OF THE FORMAT 1               04580000
LOOP1    BAL   RETURN,LOOP                                              04600000
         BCTR  RNINE,0                  REDUCE NUMBER OF ENTRIES        04620000
         LTR   RNINE,RNINE              CHECK FOR THE LAST ENTRY        04640000
         BZ    ENTERED                  BRANCH IF ON LAST ENTRY         04660000
         BCTR  RFOUR,0                  REDUCE NUMBER OF SPACES IN F1   04680000
         LTR   RFOUR,RFOUR              CHECK FOR THE LAST F1 ENTRY     04700000
         BNZ   LOOP1                    BRANCH IF F1 NOT FULL    S20016 04703020
         SPACE 1                                                 S20016 04706020
* THIS SECTION BUILDS A DSCB FORMAT 3                                   04709020
         SPACE 1                                                 S20016 04712020
         MVI   IECSDSL3,X'03'           BUILD A DSCB F3          S20016 04715020
         MVC   IECSDSL3+1(3),IECSDSL3                            S20016 04718020
         XC    IECSDSL3+4(131),IECSDSL3+4                        S20016 04721020
         MVI   DS3FMTID,X'F3'           MOVE IN FORMAT           S20016 04724020
*                                       IDENTIFIER               S20016 04727020
         LA    RTHREE,DS3EXTNT                                   S20016 04730020
         SPACE 1                                                 S20016 04733020
* THIS SECTION FILLS IN THE EXTENT FIELDS OF THE FORMAT 3               04736020
         SPACE 1                                                 S20016 04739020
LOOP2    EQU   *                                                 S20016 04742020
         BAL   RETURN,LOOP              CALCULATE F3 EXTENTS     S20016 04745020
         BCTR  RNINE,RZERO              DECREMENT ENTRY COUNT    S20016 04748020
         LTR   RNINE,RNINE              CHECK FOR LAST ENTRY     S20016 04751020
         BNZ   LOOP2                    BRANCH IF NOT LAST DADSM S20016 04754020
*                                       TABLE ENTRY                     04757020
         BAL   DRBAK,WRITEF3            WRITE OUT DSCB F3        S20016 04760020
         MVC   F5IN+135(5),SAVEADR+5    SET UP F3 ADDRESS               04780000
         MVC   DS1PTRDS,SAVEADR+FIVE                             Y02080 04800002
NOSPACE  EQU   *                                                  23475 04810018
ENTERED  EQU   *                                                  23475 04820018
         TM    F2,X'80'                 TEST F2 BYTE FOR NEED     23475 04830018
*                                          A FORMAT 2 DSCB              04840000
         BC    8,ONEONLY                BRANCH IF NO FORMAT 2 DSCB      04860000
*                                          NEEDED                       04880000
* THIS SECTION BUILDS A DSCB FORMAT 2.                                  04900000
BUILDF2  MVI   F5IN,X'02'               BUILD A DSCB FORMAT 2           04920000
         XC    F5IN+1(134),F5IN+1                                       04940000
         MVC   DS2NOTRK(1),JFCNTM       PICK UP NUMBER OF TRACKS FOR    04960000
*                                          HIGHEST LEVEL INDEX          04980000
         MVC   DS2CYLOV(1),JFCCYLOF     PICK UP NUMBER OF TRACKS FOR    05000000
*                                          CYLINDER OVERFLOW            05020000
         MVI   DS2FMTID,X'F2'           SET FORMAT IDENTIFIER           05040000
        BAL   DRBAK,WRITEF2            WRITE OUT DSCB F2                05060000
         MVC   DS1PTRDS(5),TTRLL        MOVE F2 POINTER INTO F1         05080000
ONEONLY  EQU   *                        NEXT DSCB              @Z40RSGD 05100008
*                                                              @Z40RSGD 05106208
*   DEFINE CURRENT VOLUME OF THIS DATA SET TO RAC IF DATA SET  @Z40RSGD 05112408
*   IS TO BE RAC PROTECTED.                                    @Z40RSGD 05118608
*                                                              @Z40RSGD 05119808
         TM    DS1DSIND,DS1RACDF        IS IT RAC DEFINED      @Z40RSGD 05119908
         BZ    RACDEFOK                 NO-CONTINUE            @Z40RSGD 05126108
         L     RTHREE,DEB+32            CURRENT UCB            @Z40RSGD 05128908
         MVC   RACDEF(LRACDEF),MRACDEF  SETUP RACDEF PARM LIST @Z40RSGD 05132208
*   CHECK FOR FIRST VOLUME                                     @Z40RSGD 05134808
         CLI   F2,F2NEEDED              FIRST                  @Z40RSGD 05136008
         BNE   RACNEXTD                 NO-PROCESS SUBSEQUENT  @Z40RSGD 05137208
         RACDEF TYPE=DEFINE,                                   @Z40RSGDX05137308
               ENTITY=JFCBDSNM,                                @Z40RSGDX05138208
               VOLSER=UCBVOLI-UCB(RTHREE),                     @Z40RSGDX05138408
               MF=(E,RACDEF)                                   @Z40RSGD 05138608
         B     RACCHKIT                 CHECK RESULTS          @Z40RSGD 05138808
RACNEXTD EQU   *                        PROCESS NON-FIRST VOL  @Z40RSGD 05139008
*   LOCATE FIRST UCB FOR FIRST DD                              @Z40RSGD 05144708
         L     RTWO,ADSABLST            DSAB LIST              @Z40RSGD 05145208
         L     RTWO,FIRSDSAB-DSABLIST(RTWO) FIRST DSAB         @Z40RSGD 05145308
         L     RTWO,DSABTIOT-DSAB(RTWO) TIOT ENTRY             @Z40RSGD 05146208
         L     RTWO,TIOEFSRT(RTWO)      UCB POINTER            @Z40RSGD 05147908
         RACDEF TYPE=ADDVOL,                                   @Z40RSGDX05148308
               ENTITY=JFCBDSNM,                                @Z40RSGDX05149208
               VOLSER=UCBVOLI-UCB(RTHREE),                     @Z40RSGDX05150108
               OLDVOL=UCBVOLI-UCB(RTWO),                       @Z40RSGDX05151008
               MF=(E,RACDEF)                                   @Z40RSGD 05151908
RACCHKIT LTR   RFTEN,RFTEN                                     @Z40RSGD 05152808
         BZ    RACDEFOK                                        @Z40RSGD 05153708
         LA    RFIVE,RACERR(RFTEN)      SET ERROR CODE         @Z40RSGD 05154608
         B     ERRORXCT                 GO TO ERROR EXIT 32I7  @Z40RSGD 05155508
RACDEFOK EQU   *                        RACDEF COMPLETE        @Z40RSGD 05156408
         BAL   DRBAK,WRITEF1            WRITE OUT DSCB F1      @Z40RSGD 05157308
         TM    DS4VTOCI,X'80'           CHECK FOR THE VTOC BEING IN AN  05158208
*                                          UNEXPECTED CONDITION         05159108
         BC    1,XCTLDADS               BRANCH IF VTOC NOT IN THE       05160000
*                                          EXPECTED CONDITION           05180000
         CLC   SAVEADR(5),DS4HPCHR      CHECK FOR NEED TO UPDATE THE    05200000
*                                          POINTER IN F4 TO THE LAST F1 05220000
         BNH   XCTLDADS                 BRANCH IF POINTER DOESN'T NEED  05240000
*                                          UPDATING                     05260000
         MVC   DS4HPCHR(5),SAVEADR      MOVE IN POINTER TO LAST FORMAT1 05280000
         B     XCTLDADS                                                 05300000
* THIS SECTION SETS UP THE CHANNEL PROGRAM FOR WRITING OUT DSCB FORMAT  05580000
* 1,2, AND 3.                                                           05600000
WRITEF1  LA    RFOUR,SAVEADR            PICK UP POINTER TO ADDRESS FOR  05620000
*                                          FORMAT 1                     05640000
         LA    RTHREE,DS1DSNAM          ADDRESS TO WRITE FROM    Y02080 05660002
         MVC   DS1DSNAM(44),JFCBDSNM   RESET DSNAME PORTION OF F1 AFTER 05680000
*                                         USING IT FOR THE CONVERT RTN  05700000
CHANGE2  LA    RTWO,CCW1                START PROGRAM TO SEARCH FOR A   05720000
*                                          HOLE IN THE VTOC             05740000
         IC    RONE,UHOLECTR+1          PICK UP NUMBER OF DSCB'S        05760000
         LA    RONE,1(RONE)                WRITTEN AND UPDATE IT        05780000
         STC   RONE,UHOLECTR+1                                          05800000
         ST    RTWO,IOB+16             SET ENTRY TO CHNL PGM      13559 05830016
         ST    RFOUR,CCW2              SET ADDR TO SEARCH ON IN   13559 05850016
*                                          THE FOLLOWING CCW'S          05880000
         MVI   CCW2,X'92'              RESTORE COMMAND CODE       13559 05900016
         MVC   CCW6+1(FOUR),CCW2+1                                13559 05920002
         MVC   CCW9+1(FOUR),CCW2+1                                13559 05940002
         ST    RTHREE,PDLIST                                            05960000
         MVC   CCW5+1(3),PDLIST+1      MOVE IN READ INTO AND WRITE OUT  05980000
         MVC   CCW8+1(3),PDLIST+1          OF AREA ADDRESS              06000000
         MVC   CCW11+1(3),PDLIST+1                                      06020000
         MVC   SEEK+3(4),VTOCADR       START SEARCH AT VTOC ADR   13559 06022016
         ST    DRBAK,CCW7+4            SAVE RETURN ADDRESS        13559 06024016
         BAL   DRBAK,CHKSMC            SEARCH FOR F0              13559 06026016
         L     DRBAK,CCW7+4            RESTORE RETURN ADDRESS     13559 06028016
         MVC   SEEK+3(4),0(RFOUR)      SEEK TO FOUND F0           13559 06030016
         LA    RZERO,CCW6              START CHANNEL PROGRAM ...  13559 06032016
         ST    RZERO,IOB+16                 AT   CCW6             13559 06034016
CHKSMC   EQU   *                                                  13559 06036016
         TM    TYPEFLG,SMCDONE          IS SET MUST COMPLETE ON         06040000
         BO    CLRECB                   BRANCH IF YES                   06060000
*                                                                       06065002
* LINK TO THE STATUS ROUTINE TO PERFORM A STEP MUST COMPLETE            06070002
*                                                                       06075002
         STM   RJFCB,RETURN,IECREGSV+K12  SAVE REGISTERS 11-14   YM3995 06080002
         LR    RTHREE,RWORK             SAVE WORK AREA ADDRESS   YM3995 06085002
GETLOCK  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  YM3995X06090002
               RELATED=(LOCAL,IGG032I3(RLSELOCK))  OBTAIN LOCK   YM3995 06095002
         LM    RJFCB,RETURN,IECREGSV+K12-ALLOCWKA(RTHREE)        YM3995 06100002
*                                                                       06105002
         USING CVT,RFTEN                CVT ADDRESSABILITY       YM3995 06110002
         L     RFTEN,CVTPTR             LOAD CVT ADDRESS         YM3995 06115002
         L     RFTEN,CVTABEND           LOAD SECONDARY CVT PTR   YM3995 06120002
         USING SCVTSECT,RFTEN           2NDRY CVT ADDRESSABILITY YM3995 06125002
         L     RFTEN,SCVTSTAT           LOAD STATUS EP ADDRESS   YM3995 06130002
         DROP  RFTEN                                             YM3995 06135002
         LA    RZERO,STEPMC             INDICATE STEP MC         YM3995 06140002
         XR    RONE,RONE                INDICATE STATUS SET      YM3995 06145002
*                                                                       06150002
         BALR  RETURN,RFTEN             LINK TO STATUS ROUTINE   YM3995 06155002
*                                                                       06160002
RLSELOCK EQU   *                        RELEASE THE LOCK         YM3395 06165002
         STM   RJFCB,RETURN,IECREGSV+K12  SAVE REGISTERS 11-14   YM3995 06170002
         LR    RTHREE,RWORK             SAVE WORK AREA ADDRESS   YM3995 06175002
         SETLOCK RELEASE,TYPE=LOCAL,                             YM3995X06180002
               RELATED=(LOCAL,IGG032I3(GETLOCK))  RELEASE LOCK   YM3995 06185002
         LM    RJFCB,RETURN,IECREGSV+K12-ALLOCWKA(RTHREE)        YM3995 06190002
*                                                                       06240000
         OI    DSMADTB2,DSMSMCE         SET ENQ'ED SMC SWITCH    Y02144 06250002
         OI    TYPEFLG,SMCDONE          TURN ON SMC INDICATOR           06260000
CLRECB   EQU   *                                                  15708 06280016
         EXCP  IOB                                                      06300000
         WAIT  1,ECB=ECB                                                06320000
         TM    ECB,X'20'                TEST FOR A PERMANENT I/O ERROR  06340000
        BCR   7,DRBAK                  BRANCH IF NO PERMANENT           06360000
*                                          ERROR                        06380000
         LA    RFIVE,12                 SET ERROR CODE FOR PERMANENT    06400000
*                                          I/O ERROR                    06420000
ERRORXCT EQU   *                                                  15708 06430016
         LA    RTWO,ERRORLD             POINT TO ID OF IGG032I7  Y02080 06440002
         B     XCT                                                      06460000
WRITEF2  LA    RFOUR,TTRLL              PICK UP POINTER TO ADDRESS FOR  06480000
*                                          FORMAT 2                     06500000
WRITE    LA    RTHREE,F5IN              PICK UP ADDRESS TO WRITE FROM   06520000
         B     CHANGE2                                                  06540000
WRITEF3  LA    RFOUR,SAVEADR+5          PICK UP POINTER TO ADDRESS FOR  06560000
*                                          FORMAT 3                     06580000
         B     WRITE                                                    06600000
*                                                                       06620000
* THIS SECTION RELOCATES THE CHANNEL PROGRAM FOR THE FORMAT 5 UPDATING  06640000
* OF IGG032I6.                                                          06650021
*                                                                       06660021
XCTLDADS LA    RTWO,TTRLL               PICK UP POINTER TO ADDRESS FOR  06680000
         ST    RTWO,PDLIST                 FORMAT 5                     06700000
         MVC   CCW1+1(3),PDLIST+1                                       06720000
         MVC   CCW2+1(3),PDLIST+1                                       06740000
         MVC   CCW6+1(3),PDLIST+1                                       06760000
         MVC   CCW9+1(3),PDLIST+1                                       06780000
         LA    RTWO,DS1DSNAM            PICK UP ADDRESS TO READ INTO    06800000
         ST    RTWO,PDLIST                                              06820000
         MVC   CCW5+1(3),PDLIST+1                                       06840000
         MVC   CCW8+1(3),PDLIST+1                                       06860000
         LA    RTWO,140(RTWO)           PICK UP ADDRESS TO WRITE FROM   06880000
         ST    RTWO,CCW11                                        A38860 06900021
         MVI   CCW11,X'0E'              RESTORE RD COMMAND CODE  A38860 06920021
*                                                                       06930002
* THIS SECTION BRANCHES TO ANOTHER MODULE.                              06940002
*                                                                       06960002
         LA    RTWO,F5LOAD              POINT TO ID OF IGG032I6  Y02080 07010002
XCT      EQU   *                                                 A38860 07020021
         IECRES LOAD,EXTPR=(RWORK),MODID=(RTWO),BRANCH=DIRECT    Y02080 07070002
*                                                                       07080002
*THIS SECTION SET UP AND BRANCHES TO CONVERT ROUTINE TO CONVERT FROM    07100000
*RTA TO CCHH                                                            07120000
LOOP     MVC   0(1,RTHREE),TYPE        SET EXTENT TYPE                  07140000
         STC   RFIVE,1(RTHREE)         SET EXTENT SEQUENCE NUMBER       07160000
         LA    RFIVE,1(RFIVE)                                           07180000
         L     RSIX,CVTPTR             PICK UP CVT POINTER              07200000
         USING CVT,RSIX                                                 07220000
         STM   RZERO,RTWO,DS1DSNAM      SAVE REGISTERS ZERO THRU TWO    07240000
         STM   RNINE,RETURN,DS1DSNAM+12   AND NINE THRU 15 BEFORE       07260000
*                                         BRANCHING TO THE CONVERT RTN  07280000
         L     RFTEN,CVTPCNVT          CONVERT ROUTINE ADDRESS          07300000
         LA    RONE,DEB                R1=DEB ADDRESS                   07320000
         LH    RZERO,0(RTWO)           R0=RTN TO BE CONVERTED           07340000
         SLL   RZERO,16                                                 07360000
         LA    RTWO,DS1DSNAM+36        R2=ADDRESS OF 8 BYTE RESULT AREA 07380000
         LR    REIGHT,RWORK            SAVE AREA ADDRESS                07400000
         BALR  RETURN,RFTEN                                             07420000
         MVC   2(4,RTHREE),39+DS1DSNAM-FIRST(REIGHT)                    07440000
         L     RSEVEN,8+DS1DSNAM-FIRST(REIGHT) CONVERT RTA+1 IN THE     07460000
         LH    RZERO,2(RSEVEN)            SAME MANNER AS RTA            07480000
         BCTR  RZERO,0                                                  07500000
         SLL   RZERO,16                                                 07520000
         L     RFTEN,CVTPCNVT           PICK UP CONVERT ROUTINE ADDRESS 07540000
         BALR  RETURN,RFTEN                                             07560000
         MVC   6(4,RTHREE),39+DS1DSNAM-FIRST(REIGHT)                    07580000
         LM    RZERO,RTWO,DS1DSNAM-FIRST(REIGHT)                        07600000
         LM    RNINE,RETURN,DS1DSNAM+12-FIRST(REIGHT)                   07620000
         LA    RTHREE,10(RTHREE)       UPDATE DSCB POINTER              07640000
         LA    RTWO,4(RTWO)            UPDATE EXTENT POINTER            07660000
         BR    RETURN                                                   07680000
         EJECT                                                 @Z40RSGD 07680508
*                                                              @Z40RSGD 07680808
*   MASTER RACDEF PARAMETER LIST                               @Z40RSGD 07681608
*                                                              @Z40RSGD 07682408
MRACDEF  RACDEF DSTYPE=N,                                      @Z40RSGDX07683208
               MF=L                                            @Z40RSGD 07684008
LRACDEF  EQU   *-MRACDEF                LENGTH RACDEF PARMLIST @Z40RSGD 07684808
*                                                                       07685021
* CHANNEL PROGRAM                                                       07690021
*                                                                       07695021
         DS    0D                                                       07700000
CHANNPR  EQU   *                                                        07720000
*CCW1                                                                   07740000
         DC    X'16'                   READ RECORD ZERO           13559 07760016
         DC    AL3(0+F5IN-FIRST)                                        07780000
         DC    X'7000'                                                  07800000
         DC    H'4'                                                     07820000
*CCW2                                                                   07840000
         DC    X'92'                    READ COUNT                      07860000
         DC    AL3(000000)                                              07880000
         DC    X'6000'                                                  07900000
         DC    H'5'                                                     07920000
*CCW3                                                                   07940000
         DC    X'A9'                    SEARCH EQUAL KEY                07960000
         DC    AL3(4+CCW4-FIRST)                                        07980000
         DC    X'6000'                                                  08000000
         DC    H'4'                                                     08020000
*CCW4                                                                   08040000
         DC    X'08'                    TIC                             08060000
         DC    AL3(0+CCW2-FIRST)                                        08080000
ZEROS    DC    F'0'                                                     08100000
*CCW5                                                                   08120000
         DC    X'06'                    READ DATA                       08140000
         DC    AL3(000000)                                              08160000
         DC    X'3000'                 BREAK CHANNEL PROGRAM HERE 13559 08180016
         DC    H'8'                                                     08200000
*CCW6                                                                   08220000
         DC    X'31'                    SEARCH EQUAL ID                 08240000
         DC    AL3(000000)                                              08260000
         DC    X'4000'                                                  08280000
         DC    H'5'                                                     08300000
*CCW7                                                                   08320000
         DC    X'08'                    TIC                             08340000
         DC    AL3(0+CCW6-FIRST)                                        08360000
         DC    F'0'                                                     08380000
*CCW8                                                                   08400000
         DC    X'0D'                    WRITE KEY AND DATA              08420000
         DC    AL3(000000)                                              08440000
         DC    X'4000'                                                  08460000
         DC    H'140'                                                   08480000
*CCW9                                                                   08500000
         DC    X'31'                    SEARCH EQUAL ID                 08520000
         DC    AL3(000000)                                              08540000
         DC    X'4000'                                                  08560000
         DC    H'5'                                                     08580000
*CCW10                                                                  08600000
         DC    X'08'                    TIC                             08620000
         DC    AL3(0+CCW9-FIRST)                                        08640000
         DC    F'0'                                                     08660000
*CCW11                                                                  08680000
         DC    X'0E'                    READ KEY AND DATA               08700000
         DC    AL3(000000)                                              08720000
         DC    X'1000'                                                  08740000
         DC    H'140'                                                   08760000
*                                                                       08768021
* CONSTANTS                                                             08776021
*                                                                       08784021
SYSCODE  DC    CL13'IBMOSVS2'           SYSTEM CODE             ZA00704 08790002
BLANKS   DC    CL4' '                   FOUR BLANKS              YM3995 08800002
*                                                                       08865002
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         08870002
*                                                                       08875002
         XCTLTABL ID=(MOD32I4,I4,MOD32I5,I5,F5LOAD,I6,           Y02080X08880002
               ERRORLD,I7),SVC=032,LENGTH=,BRT=YES               Y02080 08885002
DSABLIST DSECT ,                                               @Z40RSGD 08886608
CURRDSAB DS    A                        CURRENT DSAB           @Z40RSGD 08888208
FIRSDSAB DS    A                        FIRST DSAB             @Z40RSGD 08889808
         EJECT                                                   Y02080 08890002
JFCBKEN  DSECT                                                          08900000
         IEFJFCBN                                                       08940000
         SPACE 2                                                 Y02080 08945002
         IECDSECS CVT,PSA,SCVT,UCB,DSAB,EXPAND=YES             @Z40RSGD 08950008
DSCBWKAR IECALLWA EP,F4,D1=(1),D2=(2,3),ADT=YES  WORK AREA       Y02144 08960002
RACDEF   EQU   IECREGSV                 RACDEF PARM LIST       @Z40RSGD 08974208
         END                                                            10380000
