 TITLE 'IGG032I4 - ISAM ALLOCATE - UPDATES AND BUILDS F1,F2,F3'         00020000
IGG032I4 CSECT                                                          00030000
*                                                                       00032002
*MODULE NAME = IGG032I4                                                 00034002
*                                                                       00036002
*DESCRIPTIVE NAME = ISAM ALLOCATE - UPDATES AND BUILDS F1, F2, AND F3   00038002
*                                                                       00038402
*COPYRIGHT = NONE                                                       00038802
*                                                                       00039202
*CHANGE ACTIVITY = SEE BELOW                                            00039602
*                                                                       00039702
*          RELEASE 16 DELETIONS                                         00040000
*1492092800                                                        AAAA 00045016
*1492                                                             13559 00047016
*          RELEASE 17 DELETIONS                                         00050000
*          RELEASE 18 DELETIONS                                         00060000
*          RELEASE 19 DELETIONS                                         00070000
*          RELEASE 20 DELETIONS                                         00080000
*          RELEASE 21 DELETIONS                                         00090000
*1194042600-043000,043400-043600,044000-044200,046200-046400,    A42162 00092021
*1194047000,047400-047600,048000-048200,058800,061200-061400,    A42162 00094021
*1194071400-071600,081580-081600                                 A42162 00096021
*1194003600,004000,016600,017600-018200,034000-034600,041800-    A38860 00097021
*1194042000,062000,062600-063400,076400,077200-077600,081800-    A38860 00098021
*1194083000,095200                                               A38860 00099021
*          RELEASE 22 DELETIONS                                         00100000
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00110002
*0000000030-000150,001100-001200,002800,003600,006000,006600-    Y02080 00110102
*0000007000,008000,017200,017700-018000,024200-024320,025200,    Y02080 00110202
*0000025600,062000-062400,063000-063300,070200,074800,077300,    Y02080 00110302
*0000082520,083250-083400,083800,084200-097400,097800            Y02080 00110402
*0000                                                            Y02144 00110502
*0000006600,074400-075800,081920-083200,092400-092600,093200-    YM3995 00111002
*0000097800                                                      YM3995 00111502
*                                                                       00120002
*STATUS CHANGE LEVEL 005                                                00130021
*FUNCTION - THIS MODULE UPDATES AN EXISTING FORMAT 1 DSCB AND IF        00140000
*           NECESSARY UPDATES A FORMAT 2 DSCB AND BUILDS A DSCB FORMAT  00160000
*           3 OR UPDATES A FORMAT 3 DSCB. THE DSCB'S CREATED OR UPDATED 00180000
*           ARE WRITTEN OUT AND CONTROL IS TRANSFERED TO MODULE         00200000
*           IGG032I6.                                                   00220000
*                                                                       00240000
*ENTRIES - THE ONLY ENTRY POINT TO THIS MODULE IS IGG032I4. ENTRY IS    00260000
*          MADE FROM THE THIRD LOAD OF ISAM ALLOCATE VIA A BRANCH.      00280002
*                                                                       00300000
*                                                                       00320000
*INPUT - AT ENTRY TO THIS MODULE REG 11 POINTS TO A JFCB, REGISTER 13   00340000
*        POINTS TO THE ALLOCATE WORK AREA WHICH CONTAINS A PTR TO THE   00360002
*        ENTRY IN THE TIOT FOR THIS ALLOCATE AND THE ADDRESS OF THE     00380000
*        FORMAT 1 DSCB, THE VTOCADR, AND DADSMADR.                      00400021
*                                                                       00420000
*OUTPUT - UPON TRANSFERRING TO THE NEXT MODULE IGG032I6, THE WORK AREA  00440000
*         WILL CONTAIN A SORTED DADSM TABLE, THE VTOCADR AND DADSMADR   00460000
*                                                                       00480000
*                                                                       00500000
*EXTERNALLY REFERENCED ROUTINES - THE FOLLOWING ARE SUPERVISOR CALLS    00520000
*   ISSUED IN MACRO EXPANSIONS                                          00540000
*   EXCP(0) READ FROM OR WRITE TO DIRECT ACCESS DEVICE                  00560000
*   WAIT(1) WAIT ON EVENT CONTROL BLOCK                                 00580000
*   OTHER MACROS ISSUED - IEFJFCBN - BUILDS JFCB                        00620000
*                         IECALLWA - ALLOCATE WORK AREA EXPANSION       00630002
*                         IECSDSL1 - BUILDS DSCBS                       00640000
*                         IECDSECS - EXPANDS CVT, PSA, SCVT DSECTS      00660002
*                                                                       00670002
*EXITS - NORMAL - BRANCH TO IGG032I6                                    00680002
*        ERROR  - BRANCH TO IGG032I7 WITH ERROR CODE IN REGISTER 5      00700002
*                                                                       00720000
*              0C   PERMANENT I/O ERROR                                 00740000
*                                                                       00760000
*                                                                       00780000
*TABLES/WORK AREAS = DADSM WORK AREA DESCRIBED BY MACRO IECALLWA        00800002
*                                                                       00820000
*              ***************************************                  00840000
*              *             DADSM TABLE             *                  00860000
*              ***************************************                  00880000
*                                                                       00900000
*              ***************************************                  00920000
*              *        *         *                  *                  00940000
*              *  TYPE  *  NO OF  *     USED HOLE    *                  00960000
*              *  FLAG  * ENTRIES *      COUNTER     *                  00980000
*              *        *         *                  *                  01000000
*              ***************************************                  01020000
*              *                  *                  *                  01040000
*              *       RTA        *      RTA+1       *                  01060000
*              *                  *                  *                  01080000
*              ***************************************                  01100000
*              *                  *                  *                  01120000
*              *       RTA        *      RTA+1       *                  01140000
*              *                  *                  *                  01160000
*              ***************************************                  01180000
*              *                  *                  *                  01200000
*              *       RTA        *      RTA+1       *                  01220000
*              *                  *                  *                  01240000
*              ***************************************                  01260000
*              *                  *                  *                  01280000
*              *       RTA        *      RTA+1       *                  01300000
*              *                  *                  *                  01320000
*              ***************************************                  01340000
*              *                  *                  *                  01360000
*              *       RTA        *      RTA+1       *                  01380000
*              *                  *                  *                  01400000
*              ***************************************                  01420000
*                                                                       01440000
*                                                                       01460000
*              TYPE FLAG = 02 - BPAM DIRECTORIES REQUESTED.             01480000
*                                                                       01500000
*                        = 40 - USER LABELS REQUESTED                   01504021
*                                                                       01508021
*                        = 80 - SET MUST COMPLETE IS ACTIVE             01512021
*                                                                       01516021
*                                                                       01520000
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.    01540000
*                                                                       01560000
*                                                                       01580000
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.        01600000
*                                                                       01620000
*                                                                       01640000
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT. 01660021
*                                                                       01680000
*                                                                       01700000
*ATTRIBUTES - REENTRANT                                                 01720002
*                                                                       01740000
*STORAGE - PROGRAM CODE CSECT = LESS THAN 2048 BYTES                    01770002
*          WORK AREA = AS DEFINED IN THE IECALLWA MACRO                 01800002
*          RPS WORK AREA = AS DEFINED IN THE IECRPS MACRO               01810002
*                                                                       01840000
*                                                                       01860000
*REGISTER USAGE                                                         01880000
*              REGISTERS 0-9 WORK REGISTERS                             01900000
*              REGISTER 10 I TIOT SET UP TABLE POINTER                  01920000
*              REGISTER 11 - JFCB POINTER                               01940000
*              REGISTER 12 - BASE REGISTER                              01960000
*              REGISTER 13 - WORK AREA POINTER                          01980000
*              REGISTER 14 SUBROUTINE LINKAGE AND WORK REGISTER         02000000
*              REGISTER 15 WORK REGISTER                                02020000
***** REGISTER NAMES *****                                              02040000
RZERO    EQU   0                                                        02060000
RONE     EQU   1                                                        02080000
RTWO     EQU   2                                                        02100000
RTHREE   EQU   3                                                        02120000
RFOUR    EQU   4                                                        02140000
RFIVE    EQU   5                                                        02160000
RSIX     EQU   6                                                        02180000
RSEVEN   EQU   7                                                        02200000
REIGHT   EQU   8                                                        02220000
RNINE    EQU   9                                                        02240000
DRBAK   EQU   9                                                         02260000
RTEN     EQU   10                                                       02280000
RJFCB    EQU   11                                                       02300000
RBASE    EQU   12                                                       02320000
RWORK    EQU   13                                                       02340000
RETURN   EQU   14                                                       02360000
RFTEN    EQU   15                                                       02380000
*                                                                       02400000
* OTHER EQUATES                                                         02406021
*                                                                       02412021
TWO      EQU   2                        CONSTANT OF TWO          Y02080 02414002
STEPMC   EQU   1                        STATUS STEP MC INDICATOR YM3995 02416002
K12      EQU   12                       CONSTANT OF 12           YM3995 02418002
*                                                                       02440000
         BALR  RBASE,0                                                  02480000
         USING GAMMA,RBASE                                              02500000
         USING ALLOCWKA,RWORK           WORK AREA ADDRESSABILITY Y02080 02520002
         USING JFCBKEN,RJFCB                                            02540000
*                                                                       02550021
GAMMA    EQU   *                        BRANCH LABEL             Y02080 02552002
         MVC   DS1DSNAM,JFCBDSNM        MOVE IN DATA SET NAME    Y02080 02560002
* THIS SECTION DETERMINES THE NUMBER OF EXISTING EXTENTS                02580000
F1EXISTS SR    RTWO,RTWO                CHECK NUMBER OF EXISTING        02600000
         IC    RTWO,DS1NOEPV               EXTENTS IN DSCB FORMAT 1     02620000
         LA    RONE,3                                                   02640000
         LR    RFIVE,RTWO               DETERMINE THE NEXT EXTENT       02660000
*                                          SEQUENCE NUMBER TO BE USED   02680000
         CR    RTWO,RONE                CHECK NUMBER OF EXISTING        02700000
*                                          EXTENTS                      02720000
         BH    F3EXISTS                 BRANCH IF MORE THAN 3 EXTENTS - 02740000
*                                          DSCB FORMAT 3 EXISTS         02760000
         BE    F3BUILD                  BRANCH IF 3 EXTENTS - DSCB F 3  02780000
*                                          MUST BE BUILT                02800000
* THIS SECTION DETERMINES HOW MUCH ROOM EXISTS IN FORMAT.               02820000
DETPOSIT SR    RSIX,RSIX                ADD TO NUMBER OF ENTRIES THE    02840000
         IC    RSIX,ENTRYNUM               NUMBER OF NEW ENTRIES        02860000
         LR    RFOUR,RTWO                                               02880000
         LR    RONE,RSIX                                                02900000
         AR    RSIX,RTWO                                                02920000
         STC   RSIX,DS1NOEPV            UPDATE NUMBER OF EXTENTS        02940000
         LA    RTWO,ENTRIES             SET POINTER TO DADSM TABLE      02960000
         LA    RSIX,2                                                   02980000
         CR    RSIX,RFOUR               CHECK TO SEE IF ONE OR  MORE    03000000
*                                          EXTENTS EXIST IN F1          03020000
         BH    TWOSPACE                 BRANCH IF ROOM FOR TWO EXTENTS  03040000
         LA    RTHREE,DS1EXT3           SET POINTER TO LAST F1 EXTENT   03060000
         LA    RNINE,1                  SET UP EXTENT COUNTER           03080000
         B     STRTLOOP                                                 03100000
TWOSPACE LA    RTHREE,DS1EXT2           SET POINTER TO THE 2ND F1       03120000
*                                          EXTENT                       03140000
         LA    RNINE,2                  SET UP EXTENT COUNTER           03160000
* THIS SECTION FILLS IN THE EXTENTS IN THE FORMAT 1                     03180000
STRTLOOP BAL   RETURN,LOOP                                              03200000
         BCTR  RONE,0                  REDUCE NUMBER OF NEW EXTENTS     03220000
         LTR   RONE,RONE                CHECK FOR LAST DADSM TABLE      03240000
*                                          ENTRY                        03260000
         BZ    ENTER                    BRANCH IF LAST ENTRY            03280000
         BCTR  RNINE,0                  REDUCE NUMBER OF AVAILABLE      03300000
*                                          HOLES                        03320000
         LTR   RNINE,RNINE              CHECK FOR LAST F1 EXTENT        03340000
         BZ    LABEL                    BRANCH IF LAST F1 EXTENT        03360000
         B     STRTLOOP                                                 03380000
* THIS SECTION DETERMINES THE TYPE OF REQUEST                           03480000
F3BUILD  LA    RTWO,ENTRIES             SET UP POINTER TO DADSM TABLE   03500000
         SR    RONE,RONE                                                03520000
         LR    RNINE,RONE              ADD TO THE NUMBER OF EXISTING    03540000
         IC    RONE,ENTRYNUM              ENTRIES THE NUMBER OF NEW     03560000
         IC    RNINE,DS1NOEPV              EXTENTS                      03580000
         AR    RNINE,RONE                                               03600000
         STC   RNINE,DS1NOEPV           UPDATE NUMBER OF ENTRIES        03620000
LABEL    LA    RTHREE,DS3EXTNT         SET UP POINTER TO F3 EXTENT      03640000
         XC    SAVEADR+5(5),SAVEADR+5  ZERO OUT THE F3 POINTER AREA IF  03660000
*                                         NO F3 HAS PREVIOUSLY EXISTED  03680000
         XC    F5IN(140),F5IN           CLEAR OUT F3 AREA               03700000
* THIS SECTION FILLS IN THE FORMAT 3 EXTENTS                            03720000
BUILDF3  BAL   RETURN,LOOP                                              03740000
         BCTR  RONE,0                   REDUCE NUMBER OF NEW EXTENTS    03760000
         LTR   RONE,RONE                CHECK FOR LAST EXTENT           03780000
         BZ    DONE                     BRANCH IF LAST DADSM TABLE      03800000
*                                          ENTRY                        03820000
         LA    RSIX,DS3FMTID            PICK UP FORMAT IDENTIFIER       03840000
*                                          ADDRESS                      03860000
         CR    RSIX,RTHREE              CHECK FOR F3 POINTER AT FORMAT  03880000
*                                          IDENTIFIER                   03900000
         BNE   BUILDF3                  BRANCH IF NOT AT FORMAT IDEN-   03920000
*                                          TIFIER                       03940000
         LA    RTHREE,1(RTHREE)         HOP OVER FORMAT IDENTIFIER      03960000
         B     BUILDF3                                                  03980000
* THIS SECTION BUILDS A FORMAT 3                                        04000000
DONE     MVI   DS3FMTID,X'F3'           SET UP FORMAT IDENTIFIERS       04020000
         MVI   IECSDSL3,X'03'                                           04040000
         MVC   IECSDSL3+1(3),IECSDSL3                                   04060000
        BAL   DRBAK,WRITEF3            WRITE OUT DSCB F3                04080000
         OC    DS1PTRDS(5),DS1PTRDS     CHECK F1 CHAIN FIELD FOR        04100000
*                                          POINTER TO ANOTHER DSCB      04120000
         BC    7,UPDATF2               BRANCH IF THERE IS A FORMAT 2    04140000
         MVC   DS1PTRDS(5),SAVEADR+5    PUT POINTER TO F3 IN F1         04160000
ENTER    EQU   *                                                 A38860 04170021
         BAL   DRBAK,WRITEF1            WRITE OUT THE F1 DSCB    A38860 04180021
         B     XCTLDADS                 XCTL TO IGG032I6         A38860 04190021
* THIS SECTION READS IN A FORMAT 2 DSCB                                 04220000
UPDATF2  LA    RTWO,CCW9                                                04240000
         ST    RTWO,IOB+16              START CHANNEL PROGRAM AT A42162 04260021
*                                       CCW9                     A42162 04280021
         MVI   CCW11+4,X'00'                                     A42162 04300021
         LA    RTWO,DS1PTRDS            PICK UP POINTER TO ADDRESS OF   04320000
         ST    RTWO,CCW9                FORMAT 2 TO SEARCH ON    A42162 04340021
         MVI   CCW9,X'31'               RESTORE SID CODE         A42162 04360021
         LA    RTWO,F5IN                PICK UP ADDRESS OF AREA IN      04380000
         ST    RTWO,CCW11               WHICH F2 IS TO BE READ   A42162 04400021
         MVI   CCW11,X'0E'              READ COMMAND CODE        A42162 04420021
         MVC   SEEK+3(5),DS1PTRDS       UPDATE THE SEEK ADDRESS         04440000
        BAL   DRBAK,EXEC                                                04460000
         MVC   DS2PTRDS(5),SAVEADR+5    SET F2 CHAIN ADDRESS TO F3      04480000
*                                          ADDRESS                      04500000
         MVC   TTRLL(5),DS1PTRDS        SET UP F2 ADDRESS               04520000
        BAL   DRBAK,WRITEF2            WRITE OUT DSCB F2                04540000
         B     ENTER                                                    04560000
* THIS SECTION MODIFIES THE CHANNEL PROGRAM FOR A READ OF A F2 OR F3    04580000
F3EXISTS LA    RTWO,F5IN                PICK UP ADDRESS OF AREA TO BE   04600000
         ST    RTWO,CCW11               WRITTEN INTO             A42162 04610021
         MVI   CCW11,X'0E'              READ COMMAND CODE        A42162 04620021
         MVI   CCW11+4,X'00'                                     A42162 04630021
         MVC   SAVEADR+5(5),DS1PTRDS    PICK UP ADDRESS IN F1 CHAIN     04660000
         LA    RTWO,DS1PTRDS               FIELD                        04680000
MODCHAN  EQU   *                                                 A42162 04700021
         MVC   SEEK+3(5),0(RTWO)           MODIFY SEEK FIELD            04720000
         ST    RTWO,CCW9                SEARCH ADDR FOR F2 OR F3 A42162 04740021
         MVI   CCW9,X'31'               RESTORE SID CODE         A42162 04760021
         LA    RTWO,CCW9                                                04780000
         ST    RTWO,IOB+16              START CHANNEL PROGRAM AT A42162 04800021
*                                       CCW 9                    A42162 04820021
        BAL   DRBAK,EXEC                                                04840000
         CLI   DS2FMTID,X'F3'           CHECK FOR A DSCB FORMAT 3       04860000
         BE    ISAF3                    BRANCH IF THIS A FORMAT 3       04880000
         LA    RTWO,DS2PTRDS            PICK UP CHAIN ADDRESS FROM F2   04900000
         MVC   SAVEADR+5(5),DS2PTRDS    PICK UP NEW ADDRESS FOR SEEK    04920000
         B     MODCHAN                                                  04940000
* THIS SECTION LOCATES THE FIRST AVAILABLE F3 EXTENT                    04960000
ISAF3    SR    RSEVEN,RSEVEN                                            04980000
         LR    RSIX,RSEVEN                                              05000000
         IC    RSEVEN,DS1NOEPV          PICK UP NUMBER OF EXISTING      05020000
         BCTR  RSEVEN,0                    EXTENTS AND DETERMINE        05040000
*                                          POSITION IN F3               05060000
         BCTR  RSEVEN,0                 REDUCE BY 3 FOR THOSE EXTENTS   05080000
         BCTR  RSEVEN,0                    IN THE FORMAT 1              05100000
         LA    RONE,10                                                  05120000
         MR    RSIX,RONE                                                05140000
         LA    RTHREE,DS3EXTNT          LOCATE NEXT ENTRY IN DSCB       05160000
         AR    RTHREE,RSEVEN               FORMAT 3                     05180000
         CLI   DS1NOEPV,X'07'           CHECK FOR THE SEVENTH EXTENT -  05200000
*                                          AT FORMAT IDENTIFIER         05220000
         BL    OKAY                     NOT TO FORMAT IDENTIFIER YET    05240000
         LA    RTHREE,1(RTHREE)         INCREMENT TO ADJUST FOR FORMAT  05260000
*                                          IDENTIFIER                   05280000
*                                                                       05300000
OKAY     LA    RTWO,ENTRIES             SET UP DADSM TABLE POINTER      05320000
         SR    RFOUR,RFOUR                                              05340000
         IC    RFOUR,ENTRYNUM           PICK UP NUMBER OF NEW ENTRIES   05360000
* THIS SECTION FILLS IN F3 EXTENTS                                      05380000
ENTRLOOP BAL   RETURN,LOOP                                              05400000
         BCTR  RFOUR,0                  REDUCE NUMBER OF DADSM TABLE    05420000
*                                          ENTRIES                      05440000
         LTR   RFOUR,RFOUR              CHECK FOR LAST ENTRY            05460000
         BZ    THRU                     BRANCH IF LAST ENTRY            05480000
         LA    RSIX,DS3FMTID            PICK UP FORMAT IDENTIFIER       05500000
*                                          ADDRESS                      05520000
         CR    RTHREE,RSIX              CHECK FOR F3 POINTER AT FORMAT  05540000
*                                          IDENTIFIER                   05560000
         BNE   ENTRLOOP                 BRANCH IF NOT AT FORMAT IDEN-   05580000
         LA    RTHREE,1(RTHREE)         HOP OVER FORMAT IDENTIFIER      05600000
         B     ENTRLOOP                                                 05620000
*                                                                       05640000
THRU    BAL   DRBAK,WRITEF3            WRITE OUT DSCB F3                05660000
         SR    RFOUR,RFOUR              UPDATE F1 NUMBER OF EXTENTS     05680000
         LR    RFIVE,RFOUR                 FIELD                        05700000
         IC    RFOUR,ENTRYNUM           PICK UP NUMBER OF NEW EXTENTS   05720000
         IC    RFIVE,DS1NOEPV           PICK UP NUMBER OF OLD EXTENTS   05740000
         AR    RFIVE,RFOUR                                              05760000
         STC   RFIVE,DS1NOEPV           UPDATE NUMBER OF EXTENTS ON     05780000
*                                          THIS VOLUME                  05800000
        BAL   DRBAK,WRITEF1            WRITE OUT DSCB F1                05820000
*                                                                       05840000
* THIS SECTION RELOCATES THE CHANNEL PROGRAM FOR THE FORMAT 5 UPDATING  05860000
* OF IGG032I6.                                                          05870021
*                                                                       05880021
XCTLDADS LA    RTWO,TTRLL               PICK UP ADDRESS OF FIELD TO     05900000
         ST    RTWO,PDLIST                 SEARCH ON                    05920000
         MVC   CCW1+1(3),PDLIST+1                                       05940000
         MVC   CCW2+1(3),PDLIST+1                                       05960000
         MVC   CCW6+1(3),PDLIST+1                                       05980000
         MVC   CCW9+1(3),PDLIST+1                                       06000000
         LA    RTWO,DS1DSNAM            PICK UP ADDRESS OF AREA TO      06020000
         ST    RTWO,PDLIST                 WRITE INTO                   06040000
         MVC   CCW5+1(3),PDLIST+1                                       06060000
         MVC   CCW8+1(3),PDLIST+1                                       06080000
         LA    RTWO,140(RTWO)           PICK UP ADDRESS OF AREA  FROM   06100000
         ST    RTWO,CCW11               WHICH TO WRITE           A42162 06120021
         MVI   CCW11,X'0E'              READ COMMAND CODE        A42162 06140021
         MVC   SEEK+3(5),DADSMADR       UPDATE THE SEEK ADDRESS TO      06160000
*                                          POINT TO THE FIRST F5        06180000
         LA    RTWO,NEXTLOAD            BRANCH TO IGG032I6       Y02080 06200002
*                                                                       06210002
* THIS SECTION BRANCHES TO ANOTHER MODULE.                              06220002
*                                                                       06240002
XCT      EQU   *                                                 A38860 06270021
         IECRES LOAD,EXTPR=(RWORK),MODID=(RTWO),BRANCH=DIRECT    Y02080 06300002
*                                                                       06330002
*THIS SECTION SET UP AND BRANCHES TO CONVERT ROUTINE TO CONVERT FROM    06360000
*RTA TO CCHH                                                            06380000
LOOP     MVC   0(1,RTHREE),TYPE        SET EXTENT TYPE                  06400000
         STC   RFIVE,1(RTHREE)         SET EXTENT SEQUENCE NUMBER       06420000
         LA    RFIVE,1(RFIVE)                                           06440000
         L     RSIX,CVTPTR             PICK UP CVT POINTER              06460000
         USING CVT,RSIX                                                 06480000
         STM   RZERO,RTWO,DS1DSNAM      SAVE REGISTERS ZERO THRU TWO    06500000
         STM   RNINE,RETURN,DS1DSNAM+12   AND NINE THRU 15 BEFORE       06520000
*                                         BRANCHING TO THE CONVERT RTN  06540000
         L     RFTEN,CVTPCNVT          CONVERT ROUTINE ADDRESS          06560000
         LA    RONE,DEB                R1=DEB ADDRESS                   06580000
         LH    RZERO,0(RTWO)           R0=RTN TO BE CONVERTED           06600000
         SLL   RZERO,16                                                 06620000
         LA    RTWO,DS1DSNAM+36        R2=ADDRESS OF 8 BYTE RESULT AREA 06640000
         LR    REIGHT,RWORK            SAVE AREA ADDRESS                06660000
         BALR  RETURN,RFTEN                                             06680000
         MVC   2(4,RTHREE),39+DS1DSNAM-FIRST(REIGHT)                    06700000
         L     RSEVEN,8+DS1DSNAM-FIRST(REIGHT) CONVERT RTA+1 IN THE     06720000
         LH    RZERO,2(RSEVEN)            SAME MANNER AS RTA            06740000
         BCTR  RZERO,0                                                  06760000
         SLL   RZERO,16                                                 06780000
         L     RFTEN,CVTPCNVT           PICK UP CONVERT ROUTINE ADDRESS 06800000
         BALR  RETURN,RFTEN                                             06820000
         MVC   6(4,RTHREE),39+DS1DSNAM-FIRST(REIGHT)                    06840000
         LM    RZERO,RTWO,DS1DSNAM-FIRST(REIGHT)                        06860000
         LM    RNINE,RETURN,DS1DSNAM+12-FIRST(REIGHT)                   06880000
         LA    RTHREE,10(RTHREE)       UPDATE DSCB POINTER              06900000
         LA    RTWO,4(RTWO)            UPDATE EXTENT POINTER            06920000
         BR    RETURN                                                   06940000
* THIS SECTION SETS UP THE CHANNEL PROGRAM                              06960000
WRITEF1  LA    RFOUR,SAVEADR            PICK UP ADDRESS OF SEARCH       06980000
*                                          ADDRESS FOR FORMAT 1         07000000
         LA    RTHREE,DS1DSNAM          PICK UP ADDRESS OF F1    Y02080 07020002
         MVC   SEEK+3(5),SAVEADR       UPDATE THE SEEK ADDRESS          07040000
         MVC   DS1DSNAM(44),JFCBDSNM   RESET DSNAME PORTION OF F1 AFTER 07060000
*                                      USING IT FOR THE CONVERT RTN     07080000
GOTID1   LA    RTWO,CCW6                UPDATE STARTING ADDRESS OF      07100000
*                                          CHANNEL PROGRAM              07120000
         ST    RTWO,IOB+16              START OF CHANNEL PROGRAM A42162 07150021
         ST    RFOUR,PDLIST             STORE ADDRESS OF SEARCH ADDRESS 07180000
         MVC   CCW2+1(3),PDLIST+1                                       07200000
         MVC   CCW6+1(3),PDLIST+1                                       07220000
         MVC   CCW9+1(3),PDLIST+1                                       07240000
         ST    RTHREE,PDLIST            STORE ADDRESS OF AREA TO BE     07260000
*                                          WRITTEN FROM                 07280000
         MVC   CCW5+1(3),PDLIST+1                                       07300000
         MVC   CCW8+1(3),PDLIST+1                                       07320000
         MVC   CCW11+1(3),PDLIST+1                                      07340000
         MVI   CCW11+4,X'10'            SET SUPPRESS DATA XFER   A42162 07350021
* THIS SECTION INITIATES THE CHANNEL PROGRAM TO SEARCH FOR HOLES IN THE 07360000
* VTOC AND WRITE OUT THE DSCB'S                                         07380000
EXEC     TM    TYPEFLG,SMCDONE          IS SET MUST COMPLETE ON         07400000
         BO    CLRECB                   BRANCH IF YES                   07420000
*                                                                       07425002
* LINK TO THE STATUS ROUTINE TO PERFORM A STEP MUST COMPLETE            07430002
*                                                                       07435002
         STM   RJFCB,RETURN,IECREGSV+K12  SAVE REGISTERS 11-14   YM3995 07440002
         LR    RTWO,RWORK               SAVE WORK AREA ADDRESS   YM3995 07445002
GETLOCK  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  YM3995X07450002
               RELATED=(LOCAL,IGG032I4(RLSELOCK))  OBTAIN LOCK   YM3995 07455002
         LM    RJFCB,RETURN,IECREGSV+K12-ALLOCWKA(RTWO)          YM3995 07460002
*                                                                       07465002
         USING CVT,RFTEN                CVT ADDRESSABILITY       YM3995 07470002
         L     RFTEN,CVTPTR             LOAD CVT ADDRESS         YM3995 07475002
         L     RFTEN,CVTABEND           LOAD SECONDARY CVT PTR   YM3995 07480002
         USING SCVTSECT,RFTEN           2NDRY CVT ADDRESSABILITY YM3995 07485002
         L     RFTEN,SCVTSTAT           LOAD STATUS EP ADDRESS   YM3995 07490002
         DROP  RFTEN                                             YM3995 07495002
         LA    RZERO,STEPMC             INDICATE STEP MC         YM3995 07500002
         XR    RONE,RONE                INDICATE STATUS SET      YM3995 07505002
*                                                                       07510002
         BALR  RETURN,RFTEN             LINK TO STATUS ROUTINE   YM3995 07515002
*                                                                       07520002
RLSELOCK EQU   *                        RELEASE THE LOCK         YM3395 07525002
         STM   RJFCB,RETURN,IECREGSV+K12  SAVE REGISTERS 11-14   YM3995 07530002
         LR    RTWO,RWORK               SAVE WORK AREA ADDRESS   YM3995 07535002
         SETLOCK RELEASE,TYPE=LOCAL,                             YM3995X07540002
               RELATED=(LOCAL,IGG032I4(GETLOCK))  RELEASE LOCK   YM3995 07545002
         LM    RJFCB,RETURN,IECREGSV+K12-ALLOCWKA(RTWO)          YM3995 07550002
*                                                                       07600000
         OI    DSMADTB2,DSMSMCE         SET ENQ'ED SMC SWITCH    Y02144 07610002
         OI    TYPEFLG,SMCDONE          TURN ON SMC INDICATOR           07620000
CLRECB   EQU   *                                                 A38860 07630021
         MVI   ECB,X'00'                CLEAR ECB                A38860 07640021
         EXCP  IOB                                                      07660000
         WAIT  1,ECB=ECB                                                07680000
         TM    ECB,X'20'                TEST FOR A PERMANENT I/O ERROR  07700000
         BCR   7,DRBAK                  RETURN IF OK             A38860 07710021
         LA    RFIVE,12                                          A38860 07720021
         LA    RTWO,ERROR               BRANCH TO IGG032I7       Y02080 07730002
         B     XCT                                               A38860 07740021
*                                                                       07750021
* THIS SECTION SETS UP TO WRITE F2 AND F3 DSCB'S AND TO FIND F0 DSCB'S. 07760021
*                                                                       07770021
WRITEF2  LA    RFOUR,TTRLL              PICK UP ADDRESS OF SEARCH       07780000
*                                          ADDRESS FOR FORMAT 2         07800000
         LA    RTHREE,F5IN              PICK UP ADDRESS OF AREA FOR F2  07820000
         MVC   SEEK+3(5),TTRLL          UPDATE THE SEEK ADDRESS         07840000
         B     GOTID1                                                   07860000
WRITEF3  LA    RFOUR,SAVEADR+5          PICK UP ADDRESS OF SEARCH       07880000
*                                          ADDRESS FOR FORMAT 3         07900000
         LA    RTHREE,F5IN              PICK UP ADDRESS OF AREA FOR F3  07920000
         OC    SAVEADR+5(5),SAVEADR+5   CHECK FOR THE EXISTENCE OF A    07940000
*                                          DSCB FORMAT 3                07960000
         BZ    CHANGE2                  BRANCH IF THERE IS NO FORMAT 3  07980000
         MVC   SEEK+3(5),SAVEADR+5      UPDATE THE SEEK ADDRESS         08000000
         B     GOTID1                                                   08020000
CHANGE2  LA    RTWO,CCW1                PICK UP STARTING POINT FOR      08040000
*                                          CHANNEL PROGRAM              08060000
         IC    RONE,UHOLECTR+1                                          08080000
         LA    RONE,1(RONE)                                             08100000
         STC   RONE,UHOLECTR+1          UPDATE THE NUMBER OF DSCB'S     08120000
*                                          CREATED                      08140000
         MVC   SEEK+3(4),VTOCADR       SEEK TO START OF VTOC      13559 08142016
         ST    DRBAK,CCW7+4            SAVE RETURN ADDRESS        13559 08144016
         ST    RTWO,IOB+16             START SEARCH AT CCW1       13559 08146016
         ST    RFOUR,CCW2              SET UP SEARCH ADDRESS      13559 08148016
         MVI   CCW2,X'92'              RESTORE COMMAND CODE       13559 08150016
         BAL   DRBAK,EXEC              SEARCH FOR FORMAT 0        13559 08152016
         L     DRBAK,CCW7+4            RESTORE RETURN ADDRESS     13559 08154016
         MVC   SEEK+3(4),SAVEADR+5     SEEK TO FOUND FORMAT 0     13559 08156016
         B     GOTID1                   CHANNEL PROGRAM WILL     A42162 08164021
*                                       START AT CCW6            A42162 08172021
*                                                                       08325002
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         08330002
*                                                                       08335002
         XCTLTABL ID=(NEXTLOAD,I6,ERROR,I7),SVC=032,LENGTH=,     Y02080X08340002
               BRT=YES                                           Y02080 08345002
         SPACE 2                                                 Y02080 08350002
         IECDSECS CVT,PSA,SCVT,EXPAND=YES                        YM3995 08355002
JFCBKEN  DSECT                                                          08360000
         IEFJFCBN                                                       08400000
         EJECT                                                   Y02080 08420002
DSCBWKAR IECALLWA EP,F4,D1=(1),D2=(2,3),ADT=YES  WORK AREA       Y02144 08440002
ENTRYNUM EQU   AENTRYNM                 AENTRYNM EQUATE          Y02080 09280002
ENTRIES  EQU   AENTRIES                 AENTRIES EQUATE          Y02080 09300002
         END                                                            09800000
