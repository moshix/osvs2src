 TITLE 'IGG032I5 - ISAM ALLOCATE - EMBEDDED INDEX'                      00020000
IGG032I5 CSECT                                                          00030000
*                                                                       00032002
*MODULE NAME = IGG032I5                                                 00034002
*                                                                       00036002
*DESCRIPTIVE NAME = ISAM ALLOCATE - EMBEDDED INDEX                      00038002
*                                                                       00038402
*COPYRIGHT = NONE                                                       00038802
*                                                                       00039202
*CHANGE ACTIVITY = SEE BELOW                                            00039602
*                                                                       00039702
*          RELEASE 16 DELETIONS                                         00040000
*1463097800                                                        AAAA 00045016
*1463064600,065800,070800-071000,071400,072400                    13559 00047016
*          RELEASE 17 DELETIONS                                         00050000
*          RELEASE 18 DELETIONS                                         00060000
*          RELEASE 19 DELETIONS                                         00070000
*          RELEASE 20 DELETIONS                                         00080000
*1682027400-027600                                               M0227  00085020
*                                                                S20201 00087020
*          RELEASE 21 DELETIONS                                         00090000
*1194001400,003400,004000,016800,017800-018400,065600-066000,    A38860 00092021
*1194066400-067000,067400-068200,075400-075600,077000,087800-    A38860 00094021
*1194088000,100200                                               A38860 00096021
*          RELEASE 22 DELETIONS                                         00100000
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00110002
*0000000030-000150,001100-001200,002600,003400,006000,006600,    Y02080 00110102
*0000007000-007200,017400,017900-018200,021200,025330-025360,    Y02080 00110202
*0000025600,030200,066800-067200,067800-068100,069000,073800,    Y02080 00110302
*0000074500,077000,088000,088250-088400,088800,089200-102400,    Y02080 00110402
*0000102800                                                      Y02080 00110502
*0000                                                            Y02144 00110602
*0000006600,073400-074800,087700-088200,097400-102800            YM3995 00111002
*           VS2 RELEASE 037 CHANGES                                     00114008
*0000                                                          @ZA12697 00117008
*                                                                       00120002
*STATUS CHANGE LEVEL 004                                                00130020
*                                                                       00140021
*FUNCTION - THIS MODULE BUILDS FORMAT 1 AND FORMAT 2 DSCB'S AND IF      00150021
*           NECESSARY A FORMAT 3.  IT DIVIDES THE ENTRIES IN THE DADSM  00160000
*           TABLE INTO PRIME AND INDEX EXTENTS. THE INDEX EXTENTS ARE   00180000
*           THE FIRST TO BE PUT IN THE DSCB FORMAT 1.                   00200000
*           THE DATA SET WILL BE RAC DEFINED USING A RACDEF    @Z40RSGD 00205008
*           IF IGG032I3 SET THE RAC PROTECTED BIT IN THE       @Z40RSGD 00210008
*           FORMAT 1.                                          @Z40RSGD 00215008
*                                                                       00220000
*ENTRIES - THE ONLY ENTRY POINT TO THIS MODULE IS IGG032I5.  ENTRY IS   00240000
*          MADE FROM THE THIRD LOAD OF ISAM ALLOCATE VIA A BRANCH.      00260002
*                                                                       00280000
*                                                                       00300000
*INPUT - AT ENTRY TO THIS MODULE REGISTER 11 POINTS TO A JFCB.  REG 13  00320000
*        POINTS TO THE ALLOCATE WORK AREA WHICH CONTAINS A PTR TO THE   00340002
*        ENTRY IN THE TIOT FOR THIS ALLOCATE AND ALL BUT THE EXTENT     00360000
*        FIELDS OF THE FORMAT 1 DSCB, VTOCADR, AND DADSMADR.            00380000
*                                                                       00420000
*OUTPUT - UPON TRANSFERRING TO THE NEXT MODULE IGG032I6, THE WORK AREA  00440000
*         WILL CONTAIN A SORTED DADSM TABLE.                            00460000
*                                                                       00480000
*                                                                       00500000
*EXTERNAL ROUTINES - THE FOLLOWING ARE SUPERVISOR CALLS ISSUED IN THE   00520000
*   MACRO EXPANSIONS                                                    00540000
*   EXCP(0) READ FROM OR WRITE TO DIRECT ACCESS DEVICES                 00560000
*   WAIT(1) WAIT ON EVENT CONTROL BLOCK                                 00580000
*   RACDEF DEFINE DATA SET TO RAC.                             @Z40RSGD 00600008
*   OTHER MACROS USED - IEFJFCBN BUILDS JFCB                            00620000
*                       IECALLWA - ALLOCATE WORK AREA EXPANSION         00630002
*                       IECSDSL1 BUILDS DSCBS                           00640000
*                       IECDSECS - EXPANDS CVT, PSA,SCVT DSECTS         00660002
*                                                                       00680000
*EXITS NORMAL - BRANCH TO IGG032I6                                      00700002
*      ERROR - BRANCH TO IGG032I7 WITH ERROR CODE IN REGISTER 5         00720002
*                                                                       00740000
*              0C   PERMANENT I/O ERROR                                 00760000
*                                                                       00780000
*                                                                       00800000
*TABLES/WORK AREAS - DADSM WORK AREA DESCRIBED BY DSECT DSCBWKAR        00820000
*                                                                       00840000
*              ***************************************                  00860000
*              *             DADSM TABLE             *                  00880000
*              ***************************************                  00900000
*                                                                       00920000
*              ***************************************                  00940000
*              *        *         *                  *                  00960000
*              *  TYPE  *  NO OF  *     USED HOLE    *                  00980000
*              *  FLAG  * ENTRIES *      COUNTER     *                  01000000
*              *        *         *                  *                  01020000
*              ***************************************                  01040000
*              *                  *                  *                  01060000
*              *       RTA        *      RTA+1       *                  01080000
*              *                  *                  *                  01100000
*              ***************************************                  01120000
*              *                  *                  *                  01140000
*              *       RTA        *      RTA+1       *                  01160000
*              *                  *                  *                  01180000
*              ***************************************                  01200000
*              *                  *                  *                  01220000
*              *       RTA        *      RTA+1       *                  01240000
*              *                  *                  *                  01260000
*              ***************************************                  01280000
*              *                  *                  *                  01300000
*              *       RTA        *      RTA+1       *                  01320000
*              *                  *                  *                  01340000
*              ***************************************                  01360000
*              *                  *                  *                  01380000
*              *       RTA        *      RTA+1       *                  01400000
*              *                  *                  *                  01420000
*              ***************************************                  01440000
*                                                                       01460000
*                                                                       01480000
*              TYPE FLAG = 02 - BPAM DIRECTORIES REQUESTED.             01500000
*                                                                       01520000
*                        = 40 - USER LABELS REQUESTED                   01524021
*                                                                       01528021
*                        = 80 - SET MUST COMPLETE IS ACTIVE             01532021
*                                                                       01536021
*                                                                       01540000
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.    01560000
*                                                                       01580000
*                                                                       01600000
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.        01620000
*                                                                       01640000
*                                                                       01660000
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT. 01680021
*                                                                       01700000
*                                                                       01720000
*ATTRIBUTES - REENTRANT                                                 01740002
*                                                                       01760000
*STORAGE - PROGRAM CODE CSECT = LESS THAN 2048 BYTES                    01790002
*          WORK AREA = AS DEFINED IN THE IECALLWA MACRO                 01820002
*          RPS WORK AREA = AS DEFINED IN THE IECRPS MACRO               01830002
*                                                                       01860000
*                                                                       01880000
*REGISTER USAGE                                                         01900000
*              REGISTER 0-9 WORK REGISTERS                              01920000
*              REGISTER 10 - TIOT SET UP TABLE                          01940000
*              REGISTER 11 - JFCB POINTER                               01960000
*              REGISTER 12 - BASE REGISTER                              01980000
*              REGISTER 13 - WORK AREA POINTER                          02000000
*              REGISTER 14 SUBROUTINE LINKAGE AND WORK REGISTER         02020000
*              REGISTER 15 WORK REGISTER                                02040000
         BALR  RBASE,0                                                  02080000
         USING OMEGA,RBASE                                              02100000
         USING ALLOCWKA,RWORK           WORK AREA ADDRESSABILITY Y02080 02120002
         USING JFCBKEN,RJFCB                                            02140000
***** REGISTER NAMES *****                                              02160000
RZERO    EQU   0                                                        02180000
RONE     EQU   1                                                        02200000
RTWO     EQU   2                                                        02220000
RTHREE   EQU   3                                                        02240000
RFOUR    EQU   4                                                        02260000
RFIVE    EQU   5                                                        02280000
RSIX     EQU   6                                                        02300000
RSEVEN   EQU   7                                                        02320000
REIGHT   EQU   8                                                        02340000
RNINE    EQU   9                                                        02360000
DRBAK   EQU   9                                                         02380000
RTEN     EQU   10                                                       02400000
RJFCB    EQU   11                                                       02420000
RBASE    EQU   12                                                       02440000
RWORK    EQU   13                                                       02460000
RETURN   EQU   14                                                       02480000
REVEN    EQU   14                  EVEN REGISTER FOR DIVIDE      M0227  02490020
RFTEN    EQU   15                                                       02500000
*                                                                       02520000
* OTHER EQUATES                                                         02523021
*                                                                       02526021
TWO      EQU   2                        CONSTANT OF TWO          Y02080 02528002
DIVISOR  EQU   2                        DIVIDE BY 2              M0227  02530002
STEPMC   EQU   1                        STATUS STEP MC INDICATOR YM3995 02532002
K12      EQU   12                       CONSTANT OF 12           YM3995 02534002
DS1RACDF EQU   X'40'                    DS1DSIND-DATA SET IS   @Z40RSGD 02535508
*                                       RAC DEFINED            @Z40RSGD 02537008
RACERR   EQU   X'A4'                    CONSTANT FOR BUILDING  @Z40RSGD 02538508
*                                       RAC ERROR CODES        @Z40RSGD 02538808
*                                                                       02540000
OMEGA    EQU   *                        BRANCH LABEL             Y02080 02560002
         LH    RFTEN,PRIQTY             PICK UP PRIMARY QUANTITY        02580000
         LH    RONE,DIRQTY              PICK UP INDEX QUANTITY          02600000
         TM    JFCBCTRI,X'DF'           CHECK REQUEST TYPE FIELD        02620000
         BC    8,NEXTA                  BRANCH IF THIS IS AN ABSOLUTE   02640000
*                                          TRACK REQUEST                02660000
         MH    RONE,DS4DEVSZ+2          CONVERT CYLINDERS TO TRACKS     02680000
         MH    RFTEN,DS4DEVSZ+2                                         02700000
* THIS SECTION SETS UP POINTERS FOR SEARCHING THE DADSM TABLE           02720000
NEXTA    EQU   *                                                 M0227  02730020
         SR    REVEN,REVEN         CLEAR EVEN REG FOR DIVIDE     M0227  02740020
         LA    RTWO,DIVISOR        DIVISOR OF 2                  M0227  02750020
         DR    REVEN,RTWO          DIVIDE TRACKS BY 2            M0227  02760020
          SR   RZERO,RZERO              INITIALIZE TOTAL TRACKS TO      02780000
*                                          THIS POINT                   02800000
         LR    RSIX,RZERO                                               02820000
         LR    RSEVEN,RFTEN             SET UP EVEN ODD PAIR FOR DIVIDE 02840000
         LH    RFIVE,DS4DEVSZ+2        PICK UP NUMBER OF TRACKS PER     02860000
*                                      CYLINDER                         02880000
         DR    RSIX,RFIVE                                               02900000
         AR    RFTEN,RSIX               FORCE TO CYLINDER BOUNDARY      02920000
         AR    RFTEN,REVEN         ADD ANY REMAINDER FROM        M0227  02926020
*                                  FIRST DIVISION                       02932020
ZEROOUT  LR    RFIVE,RZERO             INITIALIZE PRIME EXTENT          02940000
*                                          COUNTER                      02960000
          LR   RSIX,RZERO               INITIALIZE INDEX EXTENT         02980000
*                                          COUNTER                      03000000
         LA    RTWO,AENTRIES            POINT TO DADSM TABLE     Y02080 03020002
         LA    RTHREE,PDLIST            SET UP LOCATION POINTERS FOR    03040000
         LA    RFOUR,DS3ADEXT+1        PRIME AND INDEX EXTENTS          03060000
* THIS SECTION CHECKS FOR MID WAY                                       03080000
HOOP     LH    RSEVEN,2(RTWO)           PICK UP RTA+1                   03100000
         SH    RSEVEN,0(RTWO)           SUBTRACT RTA FROM IT            03120000
         AR    RZERO,RSEVEN                                             03140000
         CR    RZERO,RFTEN              CHECK FOR MIDWAY                03160000
         BNL   HERETIS                  BRANCH IF AT OR BEYOND THE      03180000
*                                          MIDWAY POINT                 03200000
         MVC   0(4,RTHREE),0(RTWO)      MOVE IN PRIME EXTENT            03220000
         BAL   RETURN,UP235             UPDATE POINTERS AND COUNTERS    03240000
         B     HOOP                                                     03260000
*                                                                       03280000
HERETIS  BH    CHEEK                    BRANCH IF BEYOND THE HALF WAY   03300000
*                                          MARK                         03320000
         MVC   0(4,RTHREE),0(RTWO)      CONSIDER AS A PRIME EXTENT      03340000
         BAL   RETURN,UP235             UPDATE POINTERS AND COUNTERS    03360000
* THIS SECTION PICKS UP NEXT EXTENT AND CHECKS TO SEE HOW MUCH OF IT    03380000
* IS NEEDED FOR INDEX.                                                  03400000
ICK      LH    RSEVEN,2(RTWO)           NEED MORE EXTENTS FOR INDEX     03420000
         SH    RSEVEN,0(RTWO)                                           03440000
          CR   RSEVEN,RONE              CHECK FOR ENOUGH QUANTITY FOR   03460000
*                                          INDEX                        03480000
          BNL  THISIT                   BRANCH IF THERE IS ENOUGH       03500000
*                                          QUANTITY                     03520000
         MVC   0(4,RFOUR),0(RTWO)       STILL NEED ANOTHER EXTENT       03540000
          SR   RONE,RSEVEN              SUBTRACT AMOUNT AVAILABLE FROM  03560000
*                                          AMOUNT NEEDED                03580000
         BAL   RETURN,UP246             UPDATE POINTERS AND COUNTERS    03600000
         B     ICK                                                      03620000
* THIS SECTION CHECKS LAST EXTENT FOR INDEX TO SEE IF ANOTHER PRIME     03640000
* EXTENT IS LEFT                                                        03660000
THISIT    BH   REDUCE                   BRANCH IF AMOUNT AVAILABLE IS   03680000
*                                          LARGER THAN AMOUNT NEEDED    03700000
         MVC   0(4,RFOUR),0(RTWO)       JUST NEED THIS ENTIRE EXTENT TO 03720000
*                                          FULFILL REMAINING INDEX      03740000
*                                          REQUEST                      03760000
* THIS SECTION CONVERTS THE REST OF THE DADSM TABLE ENTRIES INTO        03780000
* PRIME EXTENTS                                                         03800000
GETTHEM  BAL   RETURN,UP246             UPDATE POINTERS AND COUNTERS    03820000
         LA    RNINE,PDLIST5           SET TO END OF TABLE     @ZA12697 03840008
GETTHEMM OC    0(4,RTWO),0(RTWO)       ANY MORE ENTRIES        @ZA12697 03848008
         BZ    OUTPULL                 NO GET OUT              @ZA12697 03856008
         CR    RTWO,RNINE              AT END OF THE TABLE     @ZA12697 03864008
         BZ    OUTPULL                GET OUT                  @ZA12697 03872008
         MVC   0(4,RTHREE),0(RTWO)        LIST OF PRIME EXTENTS         03880000
         BAL   RETURN,UP235             UPDATE POINTERS AND COUNTERS    03900000
         B     GETTHEMM                                                 03920000
* ONLY PART OF THE EXTENT IS NEEDED FOR INDEX                           03940000
REDUCE   MVC   0(2,RFOUR),0(RTWO)       ONLY NEED PART OF THIS EXTENT   03960000
         LH    RSEVEN,0(RTWO)                                           03980000
         AR    RSEVEN,RONE                                              04000000
          STH  RSEVEN,2(RFOUR)          CALCULATE LAST PART OF INDEX    04020000
*                                          EXTENT                       04040000
         MVC   0(2,RTHREE),2(RFOUR)     REST OF EXTENT WILL BE A PRIME  04060000
         MVC   2(2,RTHREE),2(RTWO)         EXTENT                       04080000
         B     UPTHEM                                                   04100000
* ONE EXTENT IS SPLIT INTO AT LEAST TWO PARTS THAT IS BOTH PRIME AND    04120000
* INDEX IN THE SAME EXTENT                                              04140000
CHEEK    LR    REIGHT,RZERO             MORE THAN ONE TRACK FOR INDEX   04160000
         SR    REIGHT,RFTEN                EXTISTS IN THIS EXTENT       04180000
         LH    RSEVEN,2(RTWO)                                           04200000
         SR    RSEVEN,REIGHT                                            04220000
          STH  RSEVEN,2(RTHREE)         BUILD LAST PART OF PRIME EXTENT 04240000
         STH   RSEVEN,0(RFOUR)          SET UP INDEX BEGINNING          04260000
         MVC   0(2,RTHREE),0(RTWO)                                      04280000
          CR   REIGHT,RONE              CHECK FOR AVAILABLE SPACE BEING 04300000
*                                          ENOUGH TO FULFILL REQUEST    04320000
          BL   MORETHAN                 BRANCH IF NOT ENOUGH QUANTITY   04340000
          BH   SPLIT                    BRANCH IF QUANTITY MORE THAN    04360000
*                                          THAT REQUESTED               04380000
          MVC  2(2,RFOUR),2(RTWO)       BUILD LAST PART OF INDEX EXTENT 04400000
*                                                                       04420000
UPTHEM   BAL   RETURN,UP35              UPDATE POINTERS AND COUNTERS    04440000
         B     GETTHEM                                                  04460000
* ONE EXTENT IS SPLIT INTO THREE EXTENTS PRIME,INDEX,PRIME              04480000
SPLIT    LH    RSEVEN,2(RTHREE)         NEED TO TAKE THE INDEX OUT OF   04500000
         AR    RSEVEN,RONE                 THE MIDDLE OF AN EXTENT      04520000
         STH   RSEVEN,2(RFOUR)                                          04540000
         BAL   RETURN,UP35              UPDATE POINTERS AND COUNTERS    04560000
          MVC  0(2,RTHREE),2(RFOUR)     BUILD THE BEGINNING AND ENDING  04580000
          MVC  2(2,RTHREE),2(RTWO)         RTA'S FOR THIS PRIME EXTENT  04600000
         B     UPTHEM                                                   04620000
* NEED MORE THAN JUST THE END OF AN EXTENT                              04640000
MORETHAN SR    RONE,REIGHT              NEED THE END OF THIS EXTENT AND 04660000
         MVC   2(2,RFOUR),2(RTWO)          MORE FOR THE INDEX           04680000
         BAL   RETURN,UP246             UPDATE POINTERS AND COUNTERS    04700000
         BAL   RETURN,UP35              UPDATE POINTERS AND COUNTERS    04720000
         B     ICK                                                      04740000
* THIS SECTION SETS UP POINTERS TO START BUILDING F1 WITH INDEX EXTENTS 04760000
OUTPULL  LA    RTWO,DS3ADEXT+1         GET INDEX ENTRIES SET UP TO BE   04780000
         LA    RTHREE,DS1EXT1              CONVERTED AND PLUGGED INTO   04800000
         LA    RFOUR,3                     THEIR PLACES IN THE FORMAT 1 04820000
         LR    RNINE,RSIX                                               04840000
         LR    RZERO,RFIVE                                              04860000
         AR    RSIX,RFIVE               COLLECT TOTAL NUMBER OF EXTENTS 04880000
         STC   RSIX,DS1NOEPV               AND PUT IN FORMAT 1 DSCB     04900000
         SR    RFIVE,RFIVE              INITIALIZE SEQUENCE NUMBER      04920000
         MVI   TYPE,X'04'               INITIALIZE EXTENT TYPE          04940000
* THIS SECTION CONVERTS INDEX ENTRIES FOR F1                            04960000
LIMP     BAL   RETURN,LOOP                                              04980000
         BCTR  RNINE,0                  REDUCE NUMBER OF INDEX EXTENTS  05000000
         LTR   RNINE,RNINE              CHECK FOR LAST EXTENT           05020000
         BZ    GETPRIME                 BRANCH IF LAST INDEX EXTENT     05040000
         BCTR  RFOUR,0                  REDUCE NUMBER OF EXTENTS IN     05060000
*                                          FORMAT 1 THAT ARE AVAILABLE  05080000
         LTR   RFOUR,RFOUR              CHECK FOR ROOM IN FORMAT 1      05100000
         BC    7,LIMP                  BRANCH IF MORE ROOM IN F1        05120000
NOROOM   BAL   RETURN,ROUTINE                                           05140000
* THIS SECTION CONVERTS INDEX EXTENTS FOR F3                            05160000
LIMPED   BAL   RETURN,LOOP                                              05180000
         BCTR  RNINE,0                  REDUCE NUMBER OF INDEX EXTENTS  05200000
         LTR   RNINE,RNINE              CHECK FOR THE LAST INDEX EXTENT 05220000
         BC    7,LIMPED                BRANCH IF NOT LAST INDEX EXTENT  05240000
PRIMEGET LA    RTWO,PDLIST             SET UP TO FINISH FILLING IN THE  05260000
         LR    RNINE,RZERO                DSCB FORMAT 3                 05280000
         MVI   TYPE,X'01'                                               05300000
LAMP     B     LUMPED                                                   05320000
*                                                                       05340000
* SET UP TO PLUG OUT PRIME ENTRIES FOR DSCB FORMAT 1                    05360000
GETPRIME LR    RNINE,RZERO                                              05380000
         LA    RTWO,PDLIST                                              05400000
         MVI   TYPE,X'01'              INITIALIZE ESTENT TYPE           05420000
         BCTR  RFOUR,0                  REDUCE NUMBER OF EXTENTS        05440000
*                                          AVAILABLE IN THE FORMAT 1    05460000
         LTR   RFOUR,RFOUR             BRANCH IF NO MORE ROOM IN F1     05480000
         BC    7,LUMP                                                   05500000
         B     ROOMNONE                                                 05520000
* THIS SECTION CONVERTS PRIME EXTENTS FOR F1                            05540000
LUMP     BAL   RETURN,LOOP                                              05560000
         XC    DS2PTRDS(5),DS2PTRDS                                     05580000
         BCTR  RNINE,0                  REDUCE NUMBER OF PRIME EXTENTS  05600000
         LTR   RNINE,RNINE              CHECK FOR END OF PRIME EXTENTS  05620000
         BZ    BUILDF2                  BRANCH IF LAST PRIME EXTENT -   05640000
*                                          GO TO BUILD A DSCB FORMAT 2  05660000
         BCTR  RFOUR,0                  REDUCE FORMAT 1 EXTENT COUNT    05680000
         LTR   RFOUR,RFOUR              CHECK FOR LAST AVAILABLE F1     05700000
*                                          EXTENT                       05720000
         BC    7,LUMP                  BRANCH IF FORMAT 1 IS NOT FULL   05740000
ROOMNONE BAL   RETURN,ROUTINE                                           05760000
* THIS SECTION CONVERTS PRIME FOR F3                                    05780000
LUMPED   BAL   RETURN,LOOP                                              05800000
         BCTR  RNINE,0                  REDUCE NUMBER OF PRIME EXTENTS  05820000
         LTR   RNINE,RNINE              CHECK FOR LAST PRIME EXTENT     05840000
         BC    7,LUMPED                BRANCH IF STILL MORE PRIME       05860000
*                                         EXTENTS                       05880000
ENT     BAL   DRBAK,WRITEF3            WRITE OUT DSCB F3                05900000
         MVC   DS2PTRDS(5),SAVEADR+5    PUT POINTER TO F3 IN F2         05920000
* THIS SECTION BUILDS A F2                                              05940000
BUILDF2  MVI   F5IN,X'02'               PUT INDICATOR IN KEY            05960000
         XC    F5IN+1(134),F5IN+1       CLEAR OUT FORMAT 2 AREA         05980000
         MVC   DS2NOTRK(1),JFCNTM       MOVE IN NUMBER OF TRACKS FOR    06000000
*                                          HIGHEST LEVEL INDEX          06020000
         MVC   DS2CYLOV(1),JFCCYLOF     MOVE IN NUMBER OF TRACKS FOR    06040000
*                                          CYLINDER OVERFLOW AREA       06060000
         MVI   DS2FMTID,X'F2'           PUT IN FORMAT IDENTIFIER        06080000
*                                                              @Z40RSGD 06081508
*   DEFINE DATA SET TO RAC IF REQUESTED.                       @Z40RSGD 06083008
*                                                              @Z40RSGD 06084508
         TM    DS1DSIND,DS1RACDF        IS A RACDEF NEEDED     @Z40RSGD 06086008
         BZ    RACDEFOK                 NO-CONTINUE            @Z40RSGD 06087508
         MVC   RACDEF(LRACDEF),MRACDEF  SETUP RACDEF PARM LIST @Z40RSGD 06089008
         RACDEF ENTITY=JFCBDSNM,        RAC DEFINE DATA SET    @Z40RSGDX06090508
               VOLSER=DS1DSSN,                                 @Z40RSGDX06092008
               MF=(E,RACDEF)                                   @Z40RSGD 06093508
         LTR   RFTEN,RFTEN              SUCCESSFUL             @Z40RSGD 06095008
         BZ    RACDEFOK                 YES-CONTINUE           @Z40RSGD 06096508
         LA    RFIVE,RACERR(RFTEN)      SET ERROR CODE         @Z40RSGD 06098008
         B     EXIT32I7                 ERROR EXIT             @Z40RSGD 06099508
RACDEFOK EQU   *                        RAC PROCESSING OK      @Z40RSGD 06099808
         BAL   DRBAK,WRITEF2            WRITE OUT DSCB F2               06100008
         MVC   DS1PTRDS(5),TTRLL        PUT POINTER TO F2 IN F1         06120000
* THIS SECTION WRITES OUT A F1                                          06140000
ONEONLY BAL   DRBAK,WRITEF1            WRITE OUT DSCB F1                06160000
         TM    DS4VTOCI,X'80'           CHECK THE CONDITION OF THE      06180000
*                                          VOLUME - BOS                 06200000
         BC    1,XCTLDADS               BRANCH IF VTOC NOT IN CONDITION 06220000
*                                          EXPECTED                     06240000
         CLC   SAVEADR(5),DS4HPCHR      CHECK FOR NEED TO UPDATE        06260000
*                                          POINTER IN F4 TO LAST F1     06280000
         BNH   XCTLDADS                 BRANCH IF POINTER DOESN'T NEED  06300000
*                                          TO BE CHANGED                06320000
         MVC   DS4HPCHR(5),SAVEADR      REPLACE POINTER IN F4 TO LAST   06340000
*                                          F1                           06360000
* THIS SECTION RELOCATES THE CHANNEL PROGRAM FOR FORMAT 5 UPDATING      06380000
* OF IGG032I5                                                           06400000
XCTLDADS LA    RTWO,TTRLL              PICK UP THE ADDRESS TO SEARCH ON 06420000
         ST    RTWO,PDLIST                                              06440000
         MVC   CCW2+1(3),PDLIST+1                                       06480000
         MVC   CCW6+1(3),PDLIST+1                                       06500000
         MVC   CCW9+1(3),PDLIST+1                                       06520000
         LA    RTWO,DS1DSNAM           PICK UP ADDRESS OF AREA TO READ  06540000
         ST    RTWO,CCW8                INTO                     A38860 06560021
         MVI   CCW8,X'0D'               RESTORE WR COMMAND CODE  A38860 06580021
         LA    RTWO,140(RTWO)          PICK UP ADDRESS OF AREA TO       06620000
         ST    RTWO,CCW11               WRITE FROM               A38860 06640021
         MVI   CCW11,X'0E'              RESTORE RD COMMAND CODE  A38860 06660021
         LA    RTWO,NEXTLOAD            BRANCH TO IGG032I6       Y02080 06680002
* THIS SECTION BRANCHES TO ANOTHER MODULE.                              06720002
XCT      EQU   *                                                 A38860 06750021
         IECRES LOAD,EXTPR=(RWORK),MODID=(RTWO),BRANCH=DIRECT    Y02080 06780002
*                                                                       06830002
* THIS SECTION RELOCATES THE CHANNEL PROGRAM FOR WRITING F1,F2,F3       06840000
WRITEF1  LA    RFOUR,SAVEADR            PICK UP ADDRESS OF ADDRESS TO   06860000
*                                          SEARCH ON                    06880000
         LA    RTHREE,DS1DSNAM          PICK UP ADDR OF AREA TO  Y02080 06900002
*                                          WRITE FROM                   06920000
         MVC   DS1DSNAM(44),JFCBDSNM   RESET DSNAME PORTION OF F1 AFTER 06940000
*                                      USING IT FOR THE CONVERT RTN     06960000
CHANGE2  LA    RTWO,CCW1                PICK UP ADDRESS OF FIRST CCW    06980000
*                                          TO BE EXECUTED               07000000
         IC    RONE,UHOLECTR+1          UPDATE NUMBER OF DSCB'S BUILT   07020000
         LA    RONE,1(RONE)                                             07040000
         STC   RONE,UHOLECTR+1                                          07060000
         ST    RTWO,IOB+16                                        13559 07090016
         ST    RFOUR,PDLIST            STORE ID AREA ADDRESS      13559 07120016
         MVC   CCW2+1(3),PDLIST+1                                       07160000
         MVC   CCW6+1(3),PDLIST+1                                       07180000
         MVC   CCW9+1(3),PDLIST+1                                       07200000
         ST    RTHREE,PDLIST            STORE ADDRESS OF WRITE OUT AREA 07220000
         MVC   CCW8+1(3),PDLIST+1                                       07260000
         MVC   CCW11+1(3),PDLIST+1                                      07280000
         MVC   SEEK+3(4),VTOCADR       START SEARCH AT VTOC ADDR  13559 07282016
         ST    DRBAK,CCW7+4            SAVE RETURN ADDRESS        13559 07284016
         BAL   DRBAK,SEARCHF0          SEARCH FOR FORMAT 0        13559 07286016
         L     DRBAK,CCW7+4            RESTORE RETURN ADDRESS     13559 07288016
         MVC   SEEK+3(4),0(RFOUR)      SEEK TO FOUND FORMAT 0     13559 07290016
         LA    RZERO,CCW6              START CHANNEL PROGRAM ...  13559 07292016
         ST    RZERO,IOB+16               AT CCW6                 13559 07294016
SEARCHF0 EQU   *                                                  13559 07296016
         TM    TYPEFLG,SMCDONE          IS SET MUST COMPLETE ON         07300000
         BO    CLRECB                   BRANCH IF YES                   07320000
*                                                                       07325002
* LINK TO THE STATUS ROUTINE TO PERFORM A STEP MUST COMPLETE            07330002
*                                                                       07335002
         STM   RJFCB,RETURN,IECREGSV+K12  SAVE REGISTERS 11-14   YM3995 07340002
         LR    RTHREE,RWORK             SAVE WORK AREA ADDRESS   YM3995 07345002
GETLOCK  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  YM3995X07350002
               RELATED=(LOCAL,IGG032I5(RLSELOCK))  OBTAIN LOCK   YM3995 07355002
         LM    RJFCB,RETURN,IECREGSV+K12-ALLOCWKA(RTHREE)        YM3995 07360002
*                                                                       07365002
         USING CVT,RFTEN                CVT ADDRESSABILITY       YM3995 07370002
         L     RFTEN,CVTPTR             LOAD CVT ADDRESS         YM3995 07375002
         L     RFTEN,CVTABEND           LOAD SECONDARY CVT PTR   YM3995 07380002
         USING SCVTSECT,RFTEN           2NDRY CVT ADDRESSABILITY YM3995 07385002
         L     RFTEN,SCVTSTAT           LOAD STATUS EP ADDRESS   YM3995 07390002
         DROP  RFTEN                                             YM3995 07395002
         LA    RZERO,STEPMC             INDICATE STEP MC         YM3995 07400002
         XR    RONE,RONE                INDICATE STATUS SET      YM3995 07405002
*                                                                       07410002
         BALR  RETURN,RFTEN             LINK TO STATUS ROUTINE   YM3995 07415002
*                                                                       07420002
RLSELOCK EQU   *                        RELEASE THE LOCK         YM3395 07425002
         STM   RJFCB,RETURN,IECREGSV+K12  SAVE REGISTERS 11-14   YM3995 07430002
         LR    RTHREE,RWORK             SAVE WORK AREA ADDRESS   YM3995 07435002
         SETLOCK RELEASE,TYPE=LOCAL,                             YM3995X07440002
               RELATED=(LOCAL,IGG032I5(GETLOCK))  RELEASE LOCK   YM3995 07445002
         LM    RJFCB,RETURN,IECREGSV+K12-ALLOCWKA(RTHREE)        YM3995 07450002
*                                                                       07500000
         OI    DSMADTB2,DSMSMCE         SET ENQ'ED SMC SWITCH    Y02144 07510002
         OI    TYPEFLG,SMCDONE          TURN ON SMC INDICATOR           07520000
*                                                                       07530021
* THIS SECTION EXECUTES THE CHANNEL PROGRAMS.                           07540021
*                                                                       07550021
CLRECB   EQU   *                                                 A38860 07560021
         MVI   ECB,X'00'                CLEAR THE ECB            A38860 07570021
         EXCP  IOB                                                      07580000
         WAIT  1,ECB=ECB                                                07600000
         TM    ECB,X'20'                TEST FOR A PERMANENT I/O ERROR  07620000
        BCR   7,DRBAK                  BRANCH IF NO PERMANENT I/O ERR   07640000
         LA    RFIVE,12                 SET ERROR CODE FOR PERMANENT    07660000
*                                          I/O ERROR                    07680000
EXIT32I7 EQU   *                        EXIT TO IGG032I7       @Z40RSGD 07688008
         LA    RTWO,ERROR               BRANCH TO IGG032I7       Y02080 07700002
         B     XCT                                                      07720000
*                                                                       07725021
* THIS SECTION SETS UP TO WRITE FORMAT 2 AND FORMAT 3 DSCB'S.           07730021
*                                                                       07735021
WRITEF2  LA    RFOUR,TTRLL              PICK UP ADDRESS FOR F2          07740000
WRITE    LA    RTHREE,F5IN              PICK UP ADDRESS TO WRITE FROM   07760000
         B     CHANGE2                                                  07780000
WRITEF3  LA    RFOUR,SAVEADR+5          PICK UP ADDRESS FOR F3          07800000
         XC    DS3ADEXT(95),DS3ADEXT                                    07820000
         B     WRITE                                                    07840000
*                                                                       07860000
*THIS SECTION SET UP AND BRANCHES TO CONVERT ROUTINE TO CONVERT FROM    07880000
*RTA TO CCHH                                                            07900000
LOOP     MVC   0(1,RTHREE),TYPE        SET EXTENT TYPE                  07920000
         STC   RFIVE,1(RTHREE)         SET EXTENT SEQUENCE NUMBER       07940000
         LA    RFIVE,1(RFIVE)                                           07960000
         L     RSIX,CVTPTR             PICK UP CVT POINTER              07980000
         USING CVT,RSIX                                                 08000000
         STM   RZERO,RTWO,DS1DSNAM      SAVE REGISTERS ZERO THRU TWO    08020000
         STM   RNINE,RETURN,DS1DSNAM+12   AND NINE THRU 15 BEFORE       08040000
*                                         BRANCHING TO THE CONVERT RTN  08060000
         L     RFTEN,CVTPCNVT          CONVERT ROUTINE ADDRESS          08080000
         LA    RONE,DEB                R1=DEB ADDRESS                   08100000
         LH    RZERO,0(RTWO)           R0=RTN TO BE CONVERTED           08120000
         SLL   RZERO,16                                                 08140000
         LA    RTWO,DS1DSNAM+36        R2=ADDRESS OF 8 BYTE RESULT AREA 08160000
         LR    REIGHT,RWORK            SAVE AREA ADDRESS                08180000
         BALR  RETURN,RFTEN                                             08200000
         MVC   2(4,RTHREE),39+DS1DSNAM-FIRST(REIGHT)                    08220000
         L     RSEVEN,8+DS1DSNAM-FIRST(REIGHT) CONVERT RTA+1 IN THE     08240000
         LH    RZERO,2(RSEVEN)            SAME MANNER AS RTA            08260000
         BCTR  RZERO,0                                                  08280000
         SLL   RZERO,16                                                 08300000
         L     RFTEN,CVTPCNVT           PICK UP CONVERT ROUTINE ADDRESS 08320000
         BALR  RETURN,RFTEN                                             08340000
         MVC   6(4,RTHREE),39+DS1DSNAM-FIRST(REIGHT)                    08360000
         LM    RZERO,RTWO,DS1DSNAM-FIRST(REIGHT)                        08380000
         LM    RNINE,RETURN,DS1DSNAM+12-FIRST(REIGHT)                   08400000
         LA    RTHREE,10(RTHREE)       UPDATE DSCB POINTER              08420000
         LA    RTWO,4(RTWO)            UPDATE EXTENT POINTER            08440000
         BR    RETURN                                                   08460000
* THIS SECTION BUILDS A FORMAT 3 DSCB                                   08480000
ROUTINE  LA    RTHREE,DS3EXTNT          SET UP TO FILL IN DSCB FORMAT3  08500000
         MVI   IECSDSL3,X'03'                                           08520000
         MVC   IECSDSL3+1(3),IECSDSL3                                   08540000
         XC    IECSDSL3+4(40),IECSDSL3+4   CLEAR OUT FORMAT 3 AREA      08560000
         MVI   DS3FMTID,X'F3'           SET FORMAT IDENTIFIER           08580000
         BR    RETURN                                                   08600000
*                                                                       08605021
* THIS SECTION UPDATES VARIOUS POINTERS.                                08610021
*                                                                       08615021
UP235    LA    RTWO,4(RTWO)             UPDATE DADSM TABLE POINTER      08620000
UP35     LA    RTHREE,4(RTHREE)         UPDATE PRIME EXTENT POINTER     08640000
         LA    RFIVE,1(RFIVE)           UPDATE PRIME EXTENT POINTER     08660000
         BR    RETURN                                                   08680000
UP246    LA    RTWO,4(RTWO)             UPDATE DADSM TABLE POINTER      08700000
         LA    RFOUR,4(RFOUR)           UPDATE INDEX EXTENT POINTER     08720000
         LA    RSIX,1(RSIX)             UPDATE INDEX EXTENT POINTER     08740000
         BR    RETURN                                                   08760000
*                                                              @Z40RSGD 08768008
*   MASTER RACDEF PARAMETER LIST.                              @Z40RSGD 08776008
*                                                              @Z40RSGD 08784008
MRACDEF  RACDEF TYPE=DEFINE,                                   @Z40RSGDX08792008
               DSTYPE=N,                                       @Z40RSGDX08800008
               MF=L                                            @Z40RSGD 08808008
LRACDEF  EQU   *-MRACDEF                LENGTH RACDEF          @Z40RSGD 08816008
*                                                                       08830002
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         08840002
*                                                                       08850002
         XCTLTABL ID=(NEXTLOAD,I6,ERROR,I7),SVC=032,LENGTH=,     Y02080X08852002
               BRT=YES                                           Y02080 08854002
         SPACE 2                                                 Y02080 08856002
         IECDSECS CVT,PSA,SCVT,EXPAND=YES                        YM3995 08858002
JFCBKEN  DSECT                                                          08860000
         IEFJFCBN                                                       08900000
         EJECT                                                   Y02080 08910002
DSCBWKAR IECALLWA EP,F4,D1=(1),D2=(2,3),ADT=YES  WORK AREA       Y02144 08920002
RACDEF   EQU   IECREGSV                 RACDEF PARAMETER LIST  @Z40RSGD 08921508
         END                                                            10300000
