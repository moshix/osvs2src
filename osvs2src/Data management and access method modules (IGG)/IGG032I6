 TITLE ' IGG032I6 - ISAM ALLOCATE - UPDATE DADSM'                       00020000
IGG032I6 CSECT                                                          00030021
*                                                                       00032002
*MODULE NAME = IGG032I6                                                 00034002
*                                                                       00034402
*DESCRIPTIVE NAME = ISAM ALLOCATE - UPDATE DADSM                        00034802
*                                                                       00034902
*COPYRIGHT = NONE                                                       00041102
*                                                                       00043102
*CHANGE ACTIVITY = SEE BELOW                                            00045102
*                                                                       00047102
*1231000800-001000,002800-003200,032800-033600,074800,076600     A38860 00047602
*                                                                       00053802
*          RELEASE 16 DELETIONS                                         00061000
*1463036400,038000,062600                                         16787 00061516
*          RELEASE 17 DELETIONS                                         00062000
*2136000740,036800                                                18916 00062500
*          RELEASE 18 DELETIONS                                         00063000
*3123024200,029800-030000,031400-031600,038200,043400             23214 00063518
*          RELEASE 19 DELETIONS                                         00064000
*          RELEASE 20 DELETIONS                                         00065000
*          RELEASE 21 DELETIONS                                         00066000
*1231000400,001400-001600,015400,022000,022400,023200            S21042 00066121
*1231000400,015400,022000,023800,028000,029000,029400,029800,    A42208 00066221
*1231030200,030800,031300,031660-031800,033800,034200,035000,    A42208 00066421
*1231036000,036600-038400,042600-043400,044400,047800,048200,    A42208 00066621
*1231048600,056200-056400,057200,062400-062700                   A42208 00066821
*          RELEASE 22 DELETIONS                                         00067000
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00068002
*0000000030-000150,000680-000690,002000,002700,004600,005000,    Y02080 00068102
*0000005600-005800,006450-006500,006800,016000,021880-022080,    Y02080 00068202
*0000022600,022806-022807,022809,022812,022817,022819,022840-    Y02080 00068302
*0000022920,023200-023600,024400,024800,030680,032000,032530,    Y02080 00068402
*0000032600-033100,034600,035400,047400,047680-047720,049000,    Y02080 00068502
*0000054400,054900,056300,057200,063600-063800,064800-065000,    Y02080 00068602
*0000066600-066760,067040-076740,076780                          Y02080 00068702
*0000022821,023000                                               Y02082 00068802
*0000006500-006520,032250-032510,050800                          XM2969 00070802
*                                                                       00073002
*STATUS CHANGE LEVEL 006                                                00074021
*                                                                       00120000
*FUNCTION - THIS MODULE REDUCES THE FORMAT 5 DSCB(S) BY THE SPACE THAT  00130021
*           WAS JUST ALLOCATED. IT ALSO CONVERTS THE CCHHR OF THE       00140021
*           FORMAT 1 DSCB (FOR THE FIRST VOLUME ONLY) TO A TTR AND      00150021
*           STORES IT IN THE JFCB.                                      00160021
*                                                                       00180000
*ENTRIES - ENTRY POINT IGG032I6 - ENTRY IS MADE VIA A BRANCH FROM       00200002
*          IGG032I3,IGG032I4, IGG032I5.                                 00220000
*                                                                       00240000
*                                                                       00260000
*INPUT - AT ENTRY TO THIS MODULE REGISTER 13 POINTS TO THE ALLOCATE     00270002
*        WORKAREA WHICH CONTAINS THE FORMAT 4 DSCB, THE VTOCADR,        00280021
*        THE DADSMADR, AND A SORTED DADSM TABLE CONTAINING THE          00290021
*        EXTENTS THAT WERE ACTUALLY ALLOCATED.                          00300021
*                                                                       00340000
*OUTPUT - UPDATED FORMAT 5 DSCB'S                                       00360000
*                                                                       00380000
*                                                                       00400000
*EXTERNAL ROUTINES                                                      00420000
*   SVCS  ISSUED IN MACRO EXPANSIONS                                    00440000
*   EXCP(0) READ FROM OR WRITE TO DIRECT ACCESS DEVICE                  00460002
*   WAIT(1) WAIT FOR EVENT CONTROL BLOCK                                00480000
*                                                                       00520000
*                                                                       00540000
*EXIT - NORMAL - BRANCH TO IGG032I7                                     00560002
*     - ERROR - BRANCH TO IGG032I7 WITH ERROR CODE IN REGISTER 5        00580002
*                                                                       00600000
*              0C   PERMANENT I/O ERROR                                 00620000
*                                                                       00640000
*STORAGE - PROGRAM CODE CSECT = LESS THAN 2048 BYTES                    00645002
*          WORK AREA = AS DEFINED IN THE IECALLWA MACRO          XM2969 00650002
*          RPS WORK AREA = AS DEFINED IN THE IECRPS MACRO        XM2969 00652002
*                                                                       00655021
*                                                                       00660000
*TABLES/WORK AREAS - DADSM WORK AREA DESCRIBED BY MACRO IECALLWA        00680002
*                                                                       00700000
*              ***************************************                  00720000
*              *             DADSM TABLE             *                  00740000
*              ***************************************                  00760000
*                                                                       00780000
*              ***************************************                  00800000
*              *        *         *                  *                  00820000
*              *  TYPE  *  NO OF  *     USED HOLE    *                  00840000
*              *  FLAG  * ENTRIES *      COUNTER     *                  00860000
*              *        *         *                  *                  00880000
*              ***************************************                  00900000
*              *                  *                  *                  00920000
*              *       RTA        *      RTA+1       *                  00940000
*              *                  *                  *                  00960000
*              ***************************************                  00980000
*              *                  *                  *                  01000000
*              *       RTA        *      RTA+1       *                  01020000
*              *                  *                  *                  01040000
*              ***************************************                  01060000
*              *                  *                  *                  01080000
*              *       RTA        *      RTA+1       *                  01100000
*              *                  *                  *                  01120000
*              ***************************************                  01140000
*              *                  *                  *                  01160000
*              *       RTA        *      RTA+1       *                  01180000
*              *                  *                  *                  01200000
*              ***************************************                  01220000
*              *                  *                  *                  01240000
*              *       RTA        *      RTA+1       *                  01260000
*              *                  *                  *                  01280000
*              ***************************************                  01300000
*                                                                       01320000
*                                                                       01340000
*              TYPE FLAG = 02 - BPAM DIRECTORIES REQUESTED.             01360000
*                                                                       01380000
*                        = 40 - USER LABELS REQUESTED                   01384021
*                                                                       01388021
*                        = 80 - SET MUST COMPLETE IS ACTIVE             01392021
*                                                                       01396021
*                                                                       01400000
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.    01420000
*                                                                       01440000
*                                                                       01460000
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.        01480000
*                                                                       01500000
*                                                                       01520000
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT. 01540021
*                                                                       01560000
*                                                                       01580000
*ATTRIBUTES - REENTRANT                                                 01600002
*                                                                       01620000
*                                                                       01640000
*REGISTER USAGE:                                                        01660000
R0       EQU   0                                                        01680000
R1       EQU   1                                                        01700000
R2       EQU   2                                                        01720000
R3       EQU   3                                                        01740000
R4       EQU   4                                                        01760000
R5       EQU   5                                                        01780000
R6       EQU   6                                                        01800000
R7       EQU   7                                                        01820000
R8       EQU   8                                                        01840000
ALTRWKA  EQU   8                  ALTERNATE WORKAREA PTR         S21042 01850021
R9       EQU   9                                                        01860000
RA       EQU   10                                                       01880000
RB       EQU   11                                                       01900000
RJFCB    EQU   11                 POINTER TO JFCB                S21042 01910021
RC       EQU   12                                                       01920000
RWKA     EQU   13                 WORK AREA POINTER.                    01940000
RBAK     EQU   14                 RETURN REGISTER                       01960000
RWRK     EQU   15                 WORK REGISTER                         01980000
RF       EQU   15                                                       02000000
RERR     EQU   15                 ERROR CODE REGISTER                   02020000
RCVT     EQU   15                 POINTER TO CVT                 S21042 02030021
RMSGL    EQU   11                 ERROR MESSAGE LENGTH REGISTER.        02040000
RMA      EQU   10                 ERROR MESSAGE ADDRESS REGISTER        02060000
RBASE    EQU   12                 BASE REGISTER.                        02080000
RCNT     EQU   1                  COUNT REGISTER                        02100000
RTAB     EQU   2                  DADSM ENTRY POINTER                   02120000
RIN      EQU   3                  INPUT EXTENT POINTER                  02140000
ROUT     EQU   4                  OUTPUT HOLE POINTER                   02160000
ROEND    EQU   5                  OUTPUT END POINTER                    02180000
*                                                                       02182021
* OTHER EQUATES                                                         02184021
*                                                                       02186021
FIVE     EQU   5                   CONSTANT OF FIVE              Y02080 02196002
K12      EQU   12                  CONSTANT OF TWELVE            Y02080 02206002
CHAINED  EQU   X'FF'               CHAINING POINTER MASK         A42208 02210021
*                                                                       02212002
         BALR  RBASE,0                                                  02220000
         USING CONVERT,RBASE                                     S21042 02230021
         USING CVT,RCVT                                          S21042 02240021
         USING JFCBKEN,RJFCB                                     S21042 02250021
         USING ALLOCWKA,RWKA            WORK AREA ADDRESSABILITY Y02080 02260002
*                                                                       02280000
CONVERT  EQU   *                                                 S21042 02280121
         CLI   CTR,X'00'                IS THIS THE FIRST VOLUME S21042 02280221
         BNE   DADSMSTR                 BRANCH IF NOT            S21042 02280321
         LA    R1,DEB                   POINTER TO DEB           S21042 02280421
         LA    R2,MBBCCHHR              POINTER TO MBBCCHHR      S21042 02280521
         XC    MBBCCHHR,MBBCCHHR        CLEAR CONVERT AREA       Y02080 02280602
         MVC   MBBCCHHR+3(5),SAVEADR    MOVE IN CCHHR OF F1      S21042 02280821
         STM   R8,RWKA,IECREGSV+K12     SAVE VOLATILE REGISTERS  Y02080 02280902
         LR    ALTRWKA,RWKA             GET POINTER TO WORKAREA  S21042 02281021
         DROP  RWKA                                              S21042 02281121
         USING ALLOCWKA,ALTRWKA         WORK AREA ADDRESSABILITY Y02080 02281202
         L     RCVT,CVTPTR              LOAD CVT BASE            S21042 02281321
         L     RCVT,CVTPRLTV            LOAD CONVERT ROUTINE     S21042 02281421
*                                       BASE                     S21042 02281521
         BALR  RBAK,RCVT                CONVERT CCHHR            S21042 02281621
         LM    R8,RWKA,IECREGSV+K12     RESTORE VOLATILE REGS    Y02080 02281702
         DROP  ALTRWKA                                           S21042 02281821
         USING ALLOCWKA,RWKA            WORK AREA ADDRESSABILITY Y02080 02281902
         ST    R0,PDLIST                                         S21042 02282021
         MVC   JFCBDSCB,PDLIST          MOVE TTR TO JFCB         Y02082 02282202
*                                                                       02282502
* THIS SECTION INITIALIZES THE FORMAT 5 DSCB OUTPUT RECORD,             02284002
* THE FORMAT 5 INPUT AND OUTPUT ADDRESSES, PLUS VARIOUS POINTERS        02288002
* AND SWITCHES.                                                         02292002
*                                                                       02296021
DADSMSTR EQU   *                        BRANCH LABEL             Y02082 02300002
         MODESET EXTKEY=DATAMGT         SWITCH TO DATAMGT KEY    Y02082 02310002
         MVC   DS1DSNAM(L'DS5KEYID),FIVES  MOVE IN F5 KEY ID     Y02082 02320002
         XC    CCHHRSAV,CCHHRSAV        CLEAR CCHHR AREA         Y02080 02360002
         MVI   SWITCH,OUTBYP+FRSTF5     SET THE FIRST F5 AND     A42208 02370021
*                                       READ/WRITE SWITCH        A42208 02380021
         SR    RCNT,RCNT                                                02400000
         IC    RCNT,AENTRYNM           NBR OF DADSMTBL ENTRIES   Y02080 02440002
         LA    ROEND,F5OUT+108    PICK END OF OUTPUT POINTER.           02460000
         LA    RTAB,AENTRIES           PTR TO FIRST ENTRY        Y02080 02480002
RESTOUT  LA    ROUT,F5OUT+4       GET POINTER TO START OF OUTPUT AREA   02500000
RESTORE  XC    IECSDSL1+4(136),IECSDSL1+4        CLEAR INDICATED BYTES  02520000
         MVC   TTRLL(5),DADSMADR   INSERT CCHHR FOR FIRST DADSM RECORD  02540000
         MVC   SAVEADR(5),TTRLL                                         02560000
         MVC   SAVEADR+5(5),TTRLL                                       02580000
FSTRD    BAL   RBAK,READF5                                              02600000
*                                                                       02604021
* THIS SECTION DETERMINES WHEN THE DADSM TABLE EXTENTS SHOULD BE        02608021
* MERGED INTO THE OUTPUT FORMAT 5 DSCB.                                 02612021
*                                                                       02616021
DUELOOP  CLR   ROEND,ROUT         IS OUTPUT AREA FULL.                  02620000
         BNH   TEST1                                                    02640000
COMZE    CLC   0(4,RIN),ZEROS                                           02660000
         BE    CHEND                                                    02680000
         LTR   RCNT,RCNT          IS TABLE EMPTY                        02700000
         BZ    MOVEOUT            YES MOVE INPUT TO OUTPUT              02720000
         CLC   2(2,RTAB),2(RIN)   IS THIS SPACE ALLOCATED.              02740000
         BL    ALTEREX            CHECK FOR MIDDLE OR FRONT ALL.IF LOW. 02760000
         BE    TOTALL             CHECK FOR TOTAL OR REAR  ALL. IF EQ.  02780000
*                                                                       02786021
* THIS SECTION MOVES FORMAT 5 DSCB EXTENTS TO THE OUTPUT AREA.          02792021
*                                                                       02798021
MOVEOUT  EQU   *                                                 A42208 02804021
         TM    SWITCH,DADBYP            IS A F5 WRITE PENDING?   A42208 02810021
         BO    CHEXTRTN                 BRANCH IF YES                   02820000
         MVC   0(4,ROUT),0(RIN)         INSERT INPUT INTO OUTPUT        02840000
INPUT    BCT   RWRK,UPDATEPT      UPDATE POINTER IF NOT EMPTY           02860000
         LA    ROUT,4(ROUT)                                             02880000
         OI    SWITCH,PRCNTL            SET PROCESS CNTRL SWITCH A42208 02890021
*                                                                       02900021
* THIS SECTION TESTS FOR MULTIPLE FORMAT 5 DSCB'S.                      02910021
*                                                                       02920000
CHECHAIN TM    DS5PTRDS+4,CHAINED       IS INPUT F5 CHAINED?     A42208 02940021
         BZ    CHECALT            NO-CHECK TO SEE IF RECORD WAS ALTERED 02960000
         MVC   ALLCCHHR,TTRLL           SAVE CCHHR OF F5         XM2969 02970002
         TM    SWITCH,RCDALT            WAS THE F5 ALTERED?      A42208 02980021
         BO    BRTORDF5                 IF YES, BRANCH            23214 03000018
         XI    SWITCH,OUTBYP            FLIP/FLOP RD/WR SWITCH   A42208 03005021
*                                                                       03010021
* THIS SECTION IS EXECUTED IF THE OUTPUT F5 IS THE SAME AS THE          03015021
* INPUT F5 RECORD. THE WRITING OF THE OUTPUT F5 IS BYPASSED, AND        03020021
* THE OUTPUT AREA IS CLEARED.                                           03025021
*                                                                       03030021
AROUND   EX    0,RESTORE                                                03040000
         LA    ROUT,F5OUT+4                                             03060000
         NI    SWITCH,X'FF'-PRCNTL      CLEAR PROCESS CONTROL    Y02080 03068002
*                                                                       03076021
* THIS SECTION LINKS TO READ THE NEXT FORMAT 5 DSCB.                    03084021
*                                                                       03092021
BRTORDF5 BAL   RBAK,SAVEID                                              03100000
         B     DUELOOP                                                  03120000
*                                                                       03122021
* THIS SECTION TESTS IF THE LAST FORMAT 5 OUTPUT RECORD WAS ALTERED.    03124021
* IF IT WAS ALTERED, THE FORMAT 5 IS WRITTEN. IF NOT, THE WRITING       03126021
* OF THE F5 IS BYPASSED.                                                03128021
*                                                                       03130021
CHECALT  EQU   *                                                 A42208 03132021
         TM    SWITCH,RCDALT            WAS THE F5 ALTERED?      A42208 03134021
         BZ    EXIT1                    IF NOT, BRANCH            23214 03140018
WRITEFNL EQU   *                                                 A42208 03160021
         OI    SWITCH,WRTFNL            SET WRITE LAST F5 SWITCH A42208 03180021
         XC    CCHHRSAV,CCHHRSAV        CLEAR CHAIN ADDR BEFORE  Y02080 03200002
         BAL   RBAK,WRITEF5            WRITING FINAL RECORD.            03220000
*                                                                       03252021
* THIS SECTION BRANCHES TO THE NEXT LOAD OF ISAM ALLOCATE.              03253002
*                                                                       03254021
EXIT1    EQU   *                        BRANCH LABEL             XM2969 03256002
         OI    ACNVSW,AI7CNTRL          SET BIT TO INDICATE      XM2969 03258002
*                                       NORMAL ENTRY TO IGG032I7 XM2969 03258402
*                                       FROM IGG032I6            XM2969 03258802
XCT      EQU   *                        BRANCH LABEL             Y02080 03260002
         MODESET EXTKEY=ZERO            RETURN TO KEY ZERO       Y02082 03280002
         IECRES LOAD,EXTPR=(RWKA),MODID=LASTLOAD,BRANCH=DIRECT   Y02080 03310002
*                                                                       03365021
* THIS SECTION TESTS IF ANY FORMAT 5 OTHER THAN THE FIRST HAS           03370021
* BEEN READ IN.                                                         03375021
*                                                                       03380021
TEST1    EQU   *                                                 A42208 03385021
         TM    SWITCH,PRCNTL            IS PROCESS CONTROL       A42208 03390021
*                                       SWITCH ON?               A42208 03395021
         BZ    TSTCH                                                    03400000
         TM    SWITCH,OUTBYP            IS THE NUMBER OF WRITES  A42208 03410021
*                                       EQUAL TO THE NBR OF RDS? A42208 03420021
         BZ    TSTCH                    BRANCH IF READ BEFORE WRITE     03440000
         MVC   CCHHRSAV,SAVEADR+FIVE    MOVE IN CHAIN ADDRESS    Y02080 03460002
         B     BRTOWR5                                                  03480000
*                                                                       03486021
* THIS SECTION TESTS IF THERE IS ANOTHER F5 IN THE CHAIN.               03492021
*                                                                       03498021
TSTCH    EQU   *                                                 A42208 03504021
         TM    DS5PTRDS+4,CHAINED       IS THE INPUT F5 CHAINED? A42208 03510021
         BZ    CHEXT              NO-CHECK TO SEE IF NEXT EXTENT ZERO.  03520000
WRITE1   EQU   *                        BRANCH LABEL             Y02080 03530002
         MVC   CCHHRSAV,DS5PTRDS        INSERT CHAIN ADDRESS     Y02080 03540002
BRTOWR5  BAL   RBAK,WRITEF5                                             03560000
         B     DUELOOP                                                  03580000
*                                                                       03585021
* THIS SECTION TESTS IF THERE HAVE BEEN MORE INPUT F5 DSCB'S THAN       03590021
* OUTPUT F5 DSCB'S. IF SO, IT SETS UP TO WRITE A FORMAT 0 DSCB          03595021
* OVER THE LAST INPUT F5.                                               03600021
*                                                                       03605021
CHEND    EQU   *                                                 A42208 03610021
         TM    SWITCH,FRSTF5            IS THE FIRST F5 IN CORE? A42208 03615021
         BO    WRITEFNL                                                 03620000
         TM    SWITCH,OUTBYP            IS THE NUMBER OF WRITES  A42208 03630021
*                                       EQUAL TO THE NBR OF RDS? A42208 03640021
         BO    WRITEZER                 BRANCH IF NO             A42208 03650021
LASTADDR EQU   *                                                 A42208 03660021
         MVC   TTRLL(5),SAVEADR+5       SET UP SEARCH ID ADDR    A42208 03670021
         B     WRITEFNL                 GO WRITE THE LAST F5     A42208 03680021
WRITEZER EQU   *                                                 A42208 03690021
         TM    SWITCH,NEWF5             TEST IF NEW F5 CREATED   A42208 03700021
         BO    LASTADDR                 BRANCH IF YES            A42208 03710021
         OI    SWITCH,WRZERO            SET WRITE F0 SWITCH      A42208 03720021
         B     WRITEFNL                 GO WRITE LAST F5         A42208 03730021
*                                                                       03740021
* THIS SECTION MERGES A DADSM TABLE ENTRY THAT IS ALLOCATED SPACE       03750021
* FROM THE BEGINNING OR THE MIDDLE OF THE INPUT F5 EXTENT.              03760021
*                                                                       03770021
ALTEREX  EQU   *                                                 A42208 03780021
         OI    SWITCH,RCDALT            SET F5 ALTERED SWITCH    A42208 03790021
         TM    SWITCH,DADBYP            IS THE F5 WRITE BYPASS   A42208 03800021
*                                       SWITCH ON?               A42208 03810021
         BO    CHEXTRTN                 BRANCH IF ON                    03860000
         CLC   0(2,RTAB),0(RIN)   TEST FOR MIDDLE OR FRONT ALLOCATION   03880000
         BNE   MIDDLE             LOW NOT EQUAL MIDDLE ALLOCATION       03900000
FRONT    MVC   0(2,ROUT),2(RTAB)  FRONT ALLOCATE INSERT NEW  LOW RTA    03920000
         MVC   2(2,ROUT),2(RIN)   KEEP OLD UPPER RTA                    03940000
DECRMNT  BCTR  RCNT,0             DECREMENT TABLE ENTRY COUNTER         03960000
         LA    RTAB,4(RTAB)       UPDATE POINTER TO NEXT TABLE ENTRY    03980000
         B     INPUT                                                    04000000
UPDATEPT LA    ROUT,4(ROUT)                                             04020000
UPDATIN  LA    RIN,4(RIN)                    UPDATE INPUT POINTER       04040000
         B     DUELOOP                                                  04060000
MIDDLE   MVC   0(2,ROUT),0(RIN)   MIDDLE ALLOCATE INSERT LOW OLD RTA    04080000
         MVC   2(2,ROUT),0(RTAB)  INSERT NEW UPPER RTA                  04100000
         LA    ROUT,4(ROUT)       UPDATE OUTPUT AREA POINTER            04120000
         CLR   ROEND,ROUT         IS OUTPUT AREA FULL                   04140000
         BH    FRONT              NO - INSERT NEXT EXTENT               04160000
         MVC   0(2,RIN),2(RTAB)                                         04180000
         LA    RTAB,4(RTAB)                                             04200000
         BCTR  RCNT,0                                                   04220000
         B     TEST1                                                    04240000
*                                                                       04250021
* THIS SECTION MERGES A DADSM TABLE ENTRY THAT IS ALLOCATED SPACE       04260021
* FROM THE ENTIRE INPUT F5 EXTENT OR FROM THE END OF THIS EXTENT.       04270021
*                                                                       04280021
TOTALL   EQU   *                                                 A42208 04290021
         OI    SWITCH,RCDALT            SET F5 ALTERED SWITCH    A42208 04300021
         CLC   0(2,RIN),0(RTAB)   IS ENTIRE EXTENT ALLOCATED.           04360000
         BNE   NOTALL              NO-GO ND INSERT LOW OLD RTA          04380000
         SH    ROUT,FOUR                                                04400000
         B     DECRMNT                                                  04420000
NOTALL   EQU   *                                                 A42208 04430021
         TM    SWITCH,DADBYP            IS A F5 WRITE PENDING?   A42208 04440021
         BO    CHEXTRTN                 BRANCH IF ON                    04460000
         MVC   0(2,ROUT),0(RIN)         INSERT LOW OLD RTA              04480000
         MVC   2(2,ROUT),0(RTAB)  INSERT NEW UPPER RTA                  04500000
         B     DECRMNT                                                  04520000
*                                                                       04525021
* THIS SECTION SEARCHES FOR A HOLE IN THE VTOC TO WRITE THE NEW F5.     04530021
*                                                                       04535021
CHEXT    CLC   0(4,RIN),ZEROS                                           04540000
         BE    WRITEFNL           WRITE LAST DADSM                      04560000
SEARCH   MVC   SAVEADR(5),TTRLL         SAVE PREVIOUS DADSM CCHHR       04580000
         MVC   TTRLL(5),VTOCADR                                         04600000
         LA    R0,CCW1                                                  04620000
         MVI   CCW5+4,X'30'                                             04640000
         BAL   RB,CHANNLGO        SEARCH FOR HOLE                       04660000
         LA    R0,1                                                     04680000
         AH    R0,UHOLECTR                                              04700000
         STH   R0,UHOLECTR        UPDATE USED HOLE COUNTER              04720000
         MVC   CCHHRSAV,TTRLL                                    Y02080 04740002
         MVC   TTRLL(5),SAVEADR        INSERT ID OF THIS DADSM          04760000
         BAL   RBAK,WRITEF5             WRITE THE NEW F5         A42208 04764021
         MVC   TTRLL,CCHHRSAV                                    Y02080 04768002
         MVC   SAVEADR+FIVE(FIVE),CCHHRSAV  INIT OUTPUT F5 ADDR  Y02080 04772002
         OI    SWITCH,NEWF5             SET NEW F5 CREATED BIT   A42208 04776021
         B     DUELOOP                                           A42208 04780021
*                                                                       04784021
* THIS SECTION CONVERTS DADSM ENTRIES FROM RTA/RTA+1 BACK TO XXYYZ      04788021
* BEFORE WRITING THE FORMAT 5 DSCB.                                     04792021
*                                                                       04796021
WRITEF5  LA    ROUT,F5OUT+4             LOAD POINTER TO OUTPUT AREA     04800000
         TM    SWITCH,WRTFNL            IS WRITE FINAL RECORD    A42208 04810021
*                                       SWITCH ON?               A42208 04820021
         BO    CHEXTRTN                 BRANCH IF YES                   04840000
         OI    SWITCH,DADBYP            SET DADSM WRITE PENDING  A42208 04860021
         B     DUELOOP                  GO PROCESS DADSM                04880000
CHEXTRTN EQU   *                        BRANCH LABEL             Y02080 04890002
         ST    R4,FULLWORD              SAVE OUTPUT POINTER      Y02080 04900002
         LA    R5,DS1DSNAM+5            LOAD POINTER TO CONVERTED AREA  04920000
         LA    RA,26                    SET TO MAXIMUN NBR OF EXTENTS   04940000
         LH    R0,DS4DEVSZ+2            GET NBR OF TRKS/CYL             04960000
NEXTEXT  SR    R6,R6                    CLEAR HIGH DIVIDEND REGISTERS   04980000
         SR    R8,R8                                                    05000000
         SR    R9,R9                    CLEAR FULL CYLINDER REGISTER    05020000
         LH    R7,0(ROUT)               GET EXTENT RTA                  05040000
         LTR   R7,R7                    IS THIS EXTENT ZERO             05060000
         BNZ   CVNT                     BRANCH, EXTENT NOT ZERO  XM2969 05070002
         CH    RA,H26                   IF R10 = 26, THEN ALL    XM2969 05080002
*                                       EXTENTS ARE ZERO         XM2969 05090002
         BNZ   STORE                    BRANCH IF NOT 26         XM2969 05092002
         OI    ACNVSW,AF5ZERO           SET BIT TO INDICATE F5   XM2969 05094002
*                                       WITH ALL ZERO EXTENTS    XM2969 05096002
         B     STORE                    CONTINUE                 XM2969 05098002
CVNT     EQU   *                        BRANCH LABEL             XM2969 05098402
         LH    R9,2(ROUT)               GET EXTENT RTA+1                05100000
         DR    R6,R0                    CONVERT RTA TO CYL/TRK          05120000
         DR    R8,R0                    CONVERT RTA+1 TO CYL/TRKS       05140000
         SR    R9,R7                    CALCULATE CYL DIFFERENCE        05160000
         SR    R8,R6                    CALCULATE TRK DIFFERENCE        05180000
         LTR   R9,R9                    IS CYL DIFFERENCE ZERO          05200000
         BZ    STORE                    BRANCH IF YES                   05220000
         LTR   R6,R6                    IS RTA TRK REMAINDER ZERO       05240000
         BZ    STORE                    BRANCH IF YES                   05260000
         AR    R8,R0                    ADD TRK CONSTANT TO TRK DIFF    05280000
         BCTR  R9,0                     DECREMENT NBR OF CYLS           05300000
STORE    STH   R9,2(ROUT)               STORE NBR OF FULL CYLINDERS     05320000
         MVC   0(4,R5),0(ROUT)          MOVE RTA AND CYLS TO OUTPUT     05340000
         STC   R8,4(R5)                 STORE NBR OF EXCESS TRKS        05360000
         LA    R5,5(R5)                 STEP CONVERTED AREA POINTER     05380000
         LA    ROUT,4(ROUT)             STEP OUTPUT POINTER             05400000
         BCT   RA,NEXTEXT               BRANCH IF MORE OUTPUT TO PROC   05420000
         MVC   DS1PTRDS,CCHHRSAV        INSERT CHAIN ADDRESS     Y02080 05440002
INSERTF5 MVC   DS1DSNAM+4(40),DS1DSNAM+5  OPEN F5 HOLE                  05460000
         MVI   DS1FMTID,X'F5'           INSERT FORMAT ID                05480000
         L     R4,FULLWORD              RESTORE OUTPUT POINTER   Y02080 05490002
         LA    ROEND,F5OUT+108          RELOAD END OF OUTPUT POINTER    05500013
SKIPF5   EQU   *                                                  16787 05510016
         MVI   CCW11+4,X'10'            SET SKIP FLAG FOR WRITE CHECK   05520000
         LA    R0,CCW6                  START CHANNEL PROG AT CCW6      05540000
         BAL   RB,CHANNLGO              GO WRITE THIS DADSM RECORD      05560000
         MVC   TTRLL(5),DS1PTRDS        SET UP NEXT OUTPUT DADSM ADR    05580000
         EX    0,RESTORE                CLEAR OUTPUT AREA               05600000
         XI    SWITCH,OUTBYP            FLIP/FLOP RD/WR SWITCH   A42208 05610021
WRTRTN   EQU   *                                                 A42208 05620021
         NI    SWITCH,X'FF'-DADBYP      CLEAR F5 WRITE PENDING   Y02080 05630002
         BR    RBAK                                                     05660000
*                                                                       05664021
* THIS SECTION READS IN A FORMAT 5 DSCB AND CONVERTS THE EXTENTS        05668021
* FROM XXYYZ TO RTA/RTA+1.                                              05672021
*                                                                       05676021
SAVEID   MVC   SAVEADR(5),TTRLL                                         05680000
         MVC   SAVEADR+5(5),DS5PTRDS                                    05700000
         NI    SWITCH,X'FF'-FRSTF5      CLEAR FIRST F5 SWITCH    Y02080 05720002
         MVC   TTRLL(5),DS5PTRDS                                        05740000
READF5   LA    RIN,DS5AVEXT       RESET INPUT POINTER.                  05760000
         LR    R8,RIN             SET UP POINTER FOR CONVERTED EXTENT.  05780000
         LA    RWRK,26            INSERT MAX NUMBER OF EXTENTE.         05800000
         LA    R0,CCW9                                                  05820000
         MVI   CCW11+4,X'00'                                            05840000
         BAL   RB,CHANNLGO        READ DADSM.                           05860000
         MVC   DS5KEYID+44(90),DS5KEYID+45   REMOVE ID                  05880000
         SR    R6,R6                                                    05900000
TEST0    CLC   0(2,RIN),ZEROS     EXTENT ZERO                           05920000
         BE    INCRIN             YES  INCREMENT REGISTER               05940000
         MVC   CCW12(5),0(RIN)     ALIGN EXTENT TO FULL WORD            05960000
         LH    R7,CCW12+2         LOAD NUMBER OF CYLINDERS              05980000
         MH    R7,DS4DEVSZ+2      MULTIPLY BY TRACK CONSTANT            06000000
         IC    R6,CCW12+4         ODD TRACKS.                           06020000
         AR    R7,R6              ADD ODD TRACKS FOR TOAL TRACKS        06040000
         AH    R7,CCW12           ADD RTA                               06060000
         STH   R7,2(R8)        STORE RTA+1 INTO INPUT CONVERTED AREA.   06080000
         MVC   0(2,R8),CCW12      MOVE RTA TO CONVERTED INPUT AREA.     06100000
         LA    R8,4(R8)           UPDATE POINTER TO NEXT SPACE.         06120000
INCRIN   LA    RIN,5(RIN)         INCREMENT INPUT POINTER               06140000
         BCT   RF,TEST0           PROCESS NEXT EXTENT                   06160000
         LA    RIN,DS5AVEXT       RESET INPUT POINTER.                  06180000
         XC    0(26,R8),0(R8)      CLEAR EXCESS BITS                    06200000
         LA    RWRK,26            RESET COUNT OF EXTENTS.               06220000
         XI    SWITCH,OUTBYP            FLIP/FLOP RD/WR SWITCH   A42208 06230021
         BZ    LABEL                    BRANCH IF NBR OF READS   A42208 06240021
*                                       EQUALS NBR OF WRITES     A42208 06250021
         MVC   TTRLL(5),SAVEADR                                         06280000
LABEL    BR    RBAK                     RETURN TO CALLING ROUTINE       06300000
*                                                                       06320000
* THIS SECTION EXECUTES A CHANNEL PROGRAM.                              06326021
*                                                                       06332021
CHANNLGO MVC   SEEK+3(5),TTRLL          INSERT SEEK ADDRESS FOR IOS     06340000
         STM   RF,R1,IECREGSV+K12       SAVE REGISTERS 15 - 0    Y02080 06360002
         ST    R0,IOB+16          STORE STARTING CCW INTO IOB.          06400000
         MVI   ECB,X'00'          CLEAR STATUS BYTE OF ECB.             06420000
         EXCP  IOB                EXECUTE CHHNNEL PROGRAM.              06440000
         WAIT  ECB=ECB                                                  06460000
         LM    RF,R1,IECREGSV+K12       RESTORE REGISTERS        Y02080 06480002
         TM    ECB,X'20'          TEST FOR PERM IO ERROR                06520000
         BCR   5,RB               NO - CONTINUE PROCESSING              06540000
         LA    ROEND,12                                                 06560000
         B     XCT                                                      06580000
*                                                                       06585021
* CONSTANTS                                                             06590021
*                                                                       06595021
ZEROS    DC    F'0'                                                     06600000
FIVES    DC    X'05050505'                                              06620000
FOUR     DC    H'4'                                                     06640000
H26      DC    H'26'                    CONSTANT OF 26           XM2969 06642002
*                                                                       06645002
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         06650002
*                                                                       06655002
         XCTLTABL ID=(LASTLOAD,I7),SVC=032,LENGTH=,BRT=YES       Y02080 06660002
         EJECT                                                   Y02080 06665002
JFCBKEN  DSECT                                                          06680000
         IEFJFCBN                                                       06700000
         EJECT                                                   Y02080 06710002
DSCBWKAR IECALLWA EP,F4,D1=(1),D2=(5)   ALLOCATE WORK AREA       Y02080 06720002
SWITCH   EQU   ASWITCH                  ALLOCATE SWITCH          Y02080 07590002
         EJECT                                                   Y02080 07600002
CVT      DSECT                                                          07676021
         CVT                            CVT DSECT                Y02080 07678002
         END                                                            07680000
