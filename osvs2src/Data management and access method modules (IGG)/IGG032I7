         TITLE 'IGG032I7 - F4 DSCB UPDATING AND ERROR HANDLING'  Y02080 00010002
IGG032I7 CSECT                                                          00030000
*                                                                       00032002
*MODULE NAME = IGG032I7                                                 00034002
*                                                                       00036002
*DESCRIPTIVE NAME = F4 DSCB UPDATING AND ERROR HANDLING                 00038002
*                                                                       00038402
*COPYRIGHT = NONE                                                       00038802
*                                                                       00039202
*CHANGE ACTIVITY = SEE BELOW                                            00039602
*                                                                       00039702
*          RELEASE 16 DELETIONS                                         00040000
*14630590000,060400,082600-082800                                  AAAA 00042016
*1463                                                             13145 00045016
*          RELEASE 17 DELETIONS                                         00050000
*          RELEASE 18 DELETIONS                                         00060000
*          RELEASE 19 DELETIONS                                         00070000
*0732027200-027400,028200,045800-046200                          O19117 00075019
*          RELEASE 20 DELETIONS                                         00080000
*3033039260-039320                                               A31595 00085020
*3033002200,061200                                               S20201 00087020
*          RELEASE 21 DELETIONS                                         00090000
*1231004800-005000,007800-008400,017600,018800-019400,031200-    A38860 00090621
*1231031400,032800,033200,035000-035200,043000-043200,044200,    A38860 00091221
*1231049200,049600,050000-050200,051200,051600,052000,052400-    A38860 00091821
*1231052600,053000,053600-054000,054600-054800,055000,055400,    A38860 00092421
*1231055800-056000,061820-061840,061880,061940,062020,062060,    A38860 00093021
*1231062120,062812-062816,062820,062824,062828,062832-062834,    A38860 00093621
*1231080400                                                      A38860 00094221
*1231025400                                                      A40449 00095021
*0000061200-061400                                              SA49351 00097021
*          RELEASE 22 DELETIONS                                         00100000
*0000000030-000200,001100-001200,001600-002200,002600-003200,    Y02080 00110102
*0000005600,006200-006600,007200-007400,007700,009000,018400,    Y02080 00110202
*0000018900-019200,025270,025600,026800,031800-032000,032600-    Y02080 00110302
*0000033000,037400-037600,038200-038400,040200,042200,042800-    Y02080 00110402
*0000043100,043600-044000,047000-047400,057600,058900,059100,    Y02080 00110502
*0000060300,060500,060800-060820,060844-060852,060854-060855,    Y02080 00110602
*0000060870-060900,061200-061800,061840-061860,069000,069320-    Y02080 00110702
*0000069380,069800-082200,082800-083400,083800                   Y02080 00110802
*0000007200,025204,025620,039280-039300,046600,048800-056800,    Y02134 00110902
*0000061804-062836,062883,069350,082700-083800                   Y02134 00111002
*0000039260                                                      Y02130 00111102
*0000063360                                                      Y02078 00111202
*0000060600                                                      Y02144 00111302
*0000025220-025230,025280,060840-060860,069300                   YM3048 00111502
*0000060630,060910-060920                                        YM3997 00111902
*0000019200-019300,069800                                        XM2969 00113502
*          VS2 RELEASE 03.0 DELETIONS/CHANGES                           00115502
*0000                                                           ZA00009 00117502
*0000048000                                                    @ZA02216 00118503
*                                                                       00120002
*STATUS CHANGE LEVEL 007                                                00130021
*FUNCTION - THIS MODULE UPDATES THE HOLE COUNT FOR AVAILABLE DSCB       00140000
*           RECORDS AND WRITES OUT THE FORMAT 4 DSCB. IT THEN FREES     00160002
*           ANY WORK AREAS AND RETURNS TO THE SCHEDULER.  FOR ERROR     00180002
*           CONDITIONS, IT LOADS THE ERROR CODE IN REGISTER 15 BEFORE   00200002
*           RETURNING.  FOR MULTI-VOLUME PRIME REQUESTS, THIS MODULE    00210002
*           CALCULATES THE SPACE TO BE ALLOCATED ON THE NEXT VOLUME.    00220002
*           IF AN I/O ERROR HAS OCCURRED IN AN ISAM ALLOCATE MODULE,    00225002
*           THIS MODULE ISSUES MESSAGE IEC603I WITH CODE=0.             00230002
*                                                                       00240000
*ENTRIES - THE ONLY ENTRY TO THIS MODULE IS IGG032I7.  ENTRY IS         00260002
*          NORMALLY FROM IGG032I6.  ENTRY IS ALSO MADE FROM ANY         00280002
*          ISAM ALLOCATE MODULE WHEN AN ERROR IS ENCOUNTERED.           00300002
*                                                                       00340000
*                                                                       00360000
*INPUT - THE WORK AREA CONTAINS THE VTOCADR AND THE DATA PORTION OF THE 00380000
*        FORMAT 4 DSCB.  IN CASE OF AN ERROR ENTRY REGISTER FIVE WILL   00400000
*        BE SET TO THE PROPER CODE.                                     00420000
*                                                                       00420721
*        IF MORE THAN ONE DD STATEMENT IS USED IN REQUESTING SPACE,     00421421
*        THE SEVEN LOW-ORDER BYTES OF THE DDNAME FIELD IN ALL BUT THE   00422121
*        FIRST ISAM DD ENTRY ARE USED TO CREATE THE FOLLOWING SPECIAL   00422821
*        ISAM ALLOCATE INTERFACE:                                       00423521
*                                                                       00424221
*              BYTE 1                                                   00424921
*                   BITS 0 AND 1   00 - ABSOLUTE TRACK REQUEST          00425621
*                                  01 - BLANK SPACE REQUEST             00426321
*                                  11 - CONTIGUOUS SPACE REQUEST        00427021
*                                                                       00427721
*                   BIT 2          THIS IS THE SECOND DD CARD.          00428421
*                                                                       00429121
*                   BIT 5          OVFLOW HAS BEEN ALLOCATED.           00429821
*                                                                       00430521
*                   BIT 6          PRIME HAS BEEN ALLOCATED.            00431221
*                                                                       00431921
*                   BIT 7          INDEX HAS BEEN ALLOCATED.            00432621
*                                                                       00433321
*              BYTES 2 - 3         CURRENT VOLUME SEQUENCE NUMBER       00434021
*                                  FOR SECOND OR THIRD DD CARD          00434721
*                                                                       00435421
*              BYTES 4 - 7         POINTER TO THE FIRST TIOT ENTRY      00436121
*                                  FOR THIS REQUEST                     00436821
*                                                                       00437521
*                                                                       00440000
*OUTPUT - THE UPDATED FORMAT 4 DSCB IS WRITTEN OUT.                     00460000
*                                                                       00520000
*                                                                       00540000
*EXTERNAL ROUTINES - SVC'S ISSUED IN MACRO EXPANSIONS                   00560002
*   EXCP(0) READ FROM OR WRITE TO DIRECT ACCESS DEVICE                  00580000
*   WAIT(1) WAIT ON EVENT CONTROL BLOCK                                 00600000
*   WTO(35) WRITE MESSAGE TO OPERATOR                                   00610002
*                                                                       00660002
*   OTHER MACROS ISSUED - IEFJFCBN - BUILDS JFCB                        00680000
*   IECSDSL1 - BUILDS DSCBS                                             00700000
*   IECDSECS - EXPANDS THE CVT AND DSAB DSECTS                          00720002
*   IECALLWA - ALLOCATE WORK AREA EXPANSION                             00740002
*                                                                       00760000
*EXITS - NORMAL - BRANCH TO IGG032I8 IF MULTIVOLUME PRIME ALLOCATION    00770002
*               - RETURN TO SCHEDULER IF NOT MULTIVOLUME                00780021
*      - ERROR  - RETURN TO SCHEDULER WITH ERROR CODE IN REGISTER 15    00790021
*                                                                       00800021
*                 ERROR CODES THAT CAN BE ISSUED BY THIS MODULE:        00810021
*                                                                       00820021
*                 0C - PERMANENT I/O ERROR                              00830021
*                                                                       00860000
*                                                                       00880000
*TABLES/WORK AREAS - DADSM WORK AREA DESCRIBED BY MACRO IECALLWA        00900002
*                                                                       00920000
*              ***************************************                  00940000
*              *             DADSM TABLE             *                  00960000
*              ***************************************                  00980000
*                                                                       01000000
*              ***************************************                  01020000
*              *        *         *                  *                  01040000
*              *  TYPE  *  NO OF  *     USED HOLE    *                  01060000
*              *  FLAG  * ENTRIES *      COUNTER     *                  01080000
*              *        *         *                  *                  01100000
*              ***************************************                  01120000
*              *                  *                  *                  01140000
*              *       RTA        *      RTA+1       *                  01160000
*              *                  *                  *                  01180000
*              ***************************************                  01200000
*              *                  *                  *                  01220000
*              *       RTA        *      RTA+1       *                  01240000
*              *                  *                  *                  01260000
*              ***************************************                  01280000
*              *                  *                  *                  01300000
*              *       RTA        *      RTA+1       *                  01320000
*              *                  *                  *                  01340000
*              ***************************************                  01360000
*              *                  *                  *                  01380000
*              *       RTA        *      RTA+1       *                  01400000
*              *                  *                  *                  01420000
*              ***************************************                  01440000
*              *                  *                  *                  01460000
*              *       RTA        *      RTA+1       *                  01480000
*              *                  *                  *                  01500000
*              ***************************************                  01520000
*                                                                       01540000
*                                                                       01560000
*              TYPE FLAG = 02 - BPAM DIRECTORIES REQUESTED.             01580000
*                                                                       01585002
*                          40 - USER LABELS REQUESTED                   01590002
*                                                                       01595002
*                          80 - ENQ SET-MUST-COMPLETE ISSUED            01596002
*                                                                       01600000
*                                                                       01620000
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.    01640000
*                                                                       01660000
*                                                                       01680000
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.        01700000
*                                                                       01720000
*                                                                       01740000
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT. 01760021
*                                                                       01780000
*                                                                       01800000
*                                                                       01820000
*ATTRIBUTES - REENTRANT                                                 01840002
*                                                                       01860000
*STORAGE - PROGRAM CODE CSECT = LESS THAN 1024 BYTES                    01890002
*          WORK AREA = AS DEFINED IN THE IECALLWA MACRO          XM2969 01920002
*          RPS WORK AREA = AS DEFINED IN THE IECRPS MACRO        XM2969 01930002
*                                                                       01960000
*                                                                       01980000
*REGISTER USAGE                                                         02000000
*              REGISTERS 0-9 WORK REGISTERS                             02020000
*              REGISTER 10 - TIOT SET UP TABLE POINTER                  02040000
*              REGISTER 11 - JFCB POINTER                               02060000
*              REGISTER 12 - BASE REGISTER                              02080000
*              REGISTER 13 - WORK AREA POINTER                          02100000
*              REGISTER 14 SUBROUTINE LINKAGE AND WORK REGISTER         02120000
*              REGISTER 15 WORK REGISTER AND ERROR CODE REGISTER        02140000
*                                                                       02160000
***** REGISTER NAMES *****                                              02180000
RZERO    EQU   0                                                        02200000
RONE     EQU   1                                                        02220000
RTWO     EQU   2                                                        02240000
RTHREE   EQU   3                                                        02260000
RFOUR    EQU   4                                                        02280000
RFIVE    EQU   5                                                        02300000
RSIX     EQU   6                                                        02320000
RSEVEN   EQU   7                                                        02340000
RUCB     EQU   7                        POINTER TO UCB           Y02078 02350002
REIGHT   EQU   8                                                        02360000
RNINE    EQU   9                                                        02380000
DRBAK    EQU   9                                                        02400000
RTEN     EQU   10                                                       02420000
RJFCB    EQU   11                                                       02440000
RBASE    EQU   12                                                       02460000
RWORK    EQU   13                                                       02480000
RETURN   EQU   14                                                       02500000
RFTEN    EQU   15                                                       02520000
*                                                                       02520121
* OTHER EQUATES                                                         02520221
*                                                                       02520321
BLANK    EQU   X'40'                    EBCDIC BLANK             A40449 02520521
TWO      EQU   2                        CONSTANT OF TWO          Y02080 02520902
FOURCH   EQU   4                        CONSTANT NUMBER 4        S20201 02521020
FOUR     EQU   4                        CONSTANT OF 4            Y02134 02521402
SEVEN    EQU   7                        CONSTANT OF 7            Y02134 02521802
APDIS    EQU   28                       DISP. TO AVT ADDR IN DEB S20201 02524020
AVTDS    EQU   120                      DISP. TO AVT PTR. IN     S20201 02525020
*                                       W.A.                     S20201 02526020
DIRFBIT  EQU   X'04'                    VTOC INTERRUPT BIT       O19117 02530019
TIOEVOLS EQU   2                        OFFSET TO NBR OF DEVICES A38860 02564021
TIOEDDNM EQU   4                        OFFSET TO DDNAME         A38860 02566021
ISAMSTAT EQU   5                        OFFSET TO ALLOCATION     A38860 02568021
*                                       STATUS                   A38860 02570021
VOLSQCTR EQU   6                        OFFSET TO DS1VOLSQ CTR   A38860 02572021
TIOTPTR  EQU   8                        OFFSET TO 1ST ENTRY PTR  A38860 02574021
UCBENTRY EQU   16                       OFFSET TO 1ST UCB ENTRY  A38860 02576021
CURRDSAB EQU   0                        OFFSET TO CURRENT DSAB   Y02134 02576202
*                                       POINTER IN DSAB LIST     Y02134 02576402
FRSTDSAB EQU   4                        OFFSET TO FIRST DSAB PTR Y02134 02576602
SCNDDSAB EQU   8                        OFFSET TO 2ND DSAB PTR   Y02134 02576802
THRDDSAB EQU   12                       OFFSET TO 3RD DSAB PTR   Y02134 02577002
ONE16    EQU   116                      116 CYLINDERS            Y02130 02577202
DA3340   EQU   X'0A'                    3340 DEVICE TYPE         Y02130 02577402
K1       EQU   1                        CONSTANT OF 1            XM2969 02577502
K3       EQU   3                        CONSTANT OF 3            XM2969 02577702
K4       EQU   4                        CONSTANT OF 4            XM2969 02577802
K5       EQU   5                        CONSTANT OF 5            XM2969 02577902
K12      EQU   12                       CONSTANT OF 12           Y02080 02578202
K16      EQU   16                       CONSTANT OF 16           XM2969 02578302
K140     EQU   140                      CONSTANT OF 140          XM2969 02578402
UCBADDR  EQU   32                       DISP. TO UCB ADDR IN DEB Y02078 02578902
UUU      EQU   37                       DISP. TO UUU IN MESSAGE  Y02078 02579002
VOLSER   EQU   41                       DISP. TO VOLSER IN MSG   Y02078 02579102
SECPASS  EQU   X'20'                    SECOND ENTRY SWITCH      Y02080 02579202
WRTCCW   EQU   X'0D'                    WRITE CCW CODE           XM2969 02579302
READCCW  EQU   X'0E'                    READ CCW CODE            XM2969 02579402
ZEROFLAG EQU   X'00'                    ZERO FLAG FOR READ       XM2969 02579802
SKIPFLAG EQU   X'10'                    SKIP FLAG                XM2969 02579902
*                                                                       02580000
         BALR  RBASE,0                                                  02640000
         USING DELTA,RBASE                                              02660000
         USING ALLOCWKA,RWORK           WORK AREA ADDRESSABILITY Y02080 02680002
         USING JFCBKEN,RJFCB                                            02700000
*                                                                       02704002
DELTA    EQU   *                                                 O19117 02706019
         TM    ACNVSW,AI7CNTRL          TEST IF ENTRY FROM       XM2969 02706502
*                                       IGG032I6 TO WRITE A F0   XM2969 02707002
         BNO   DELTA1                   BRANCH IF ENTRY NOT      XM2969 02707502
*                                       FROM 32I6 TO WRITE A F0  XM2969 02708002
         NI    ACNVSW,X'FF'-AI7CNTRL    RESET PATH INDICATOR    ZA00009 02708402
*                                                                XM2969 02708502
* THIS SECTION WRITES A FORMAT 0 DSCB IF NECESSARY               XM2969 02709002
*                                                                XM2969 02709502
EXIT1    EQU   *                        TEST TO WRITE AN F0      XM2969 02710002
         SR    RFIVE,RFIVE              CLEAR ERROR REG          XM2969 02710502
         TM    ACNVSW,AF5ZERO           DOES A F5 WITH ALL ZERO  XM2969 02711002
*                                       EXTENTS EXIST            XM2969 02711502
         BNO   TESTF0                   ZERO EXTENTS DOES NOT    XM2969 02711602
*                                       EXIST                    XM2969 02711702
         NI    ACNVSW,X'FF'-AF5ZERO     RESET PATH INDICATOR    ZA00009 02713202
         TM    ASWITCH,FRSTF5           IS F5 IN CORE IND SET    XM2969 02718502
         BO    TESTF0                   BRANCH IF IND IS SET     XM2969 02720002
         MVC   TTRLL(K5),ALLCCHHR       CCHHR OF F5 TO BE READ   XM2969 02721502
         MVI   CCW11+K4,ZEROFLAG        ZERO FLAG BYTES          XM2969 02723002
         MVC   SEEK+K3(K5),TTRLL        INSERT SEEK ADDR         XM2969 02724502
         LA    RZERO,CCW9               START OF CHANNEL PGM     XM2969 02726002
         ST    RZERO,IOB+K16            STORE STARTING CCW       XM2969 02727502
         BAL   RETURN,EXECUTET          BAL TO READ F5 DSCB      XM2969 02729002
         MVC   SAVEADR+K5(K5),DS5PTRDS  SAVE CCHHR OF F5         XM2969 02730502
         XC    DS5PTRDS(K5),DS5PTRDS    ZERO CHAIN POINTER       XM2969 02732002
         MVI   CCW11,WRTCCW             CHANGE READ CCW TO WRITE XM2969 02733502
         MVC   SEEK+K3(K5),TTRLL        INSERT SEEK ADDRESS      XM2969 02735002
         LA    RZERO,CCW9               START OF CHANNEL PGM     XM2969 02736502
         ST    RZERO,IOB+K16            STORE STARTING CCW       XM2969 02738002
         BAL   RETURN,EXECUTET          BAL TO WRITE F5          XM2969 02739502
         OI    ASWITCH,WRZERO           SET WRITE F0 BIT         XM2969 02741002
         MVI   CCW11,READCCW            RESTORE READ CCW         XM2969 02742502
TESTF0   EQU   *                        TEST TO WRITE AN F0      XM2969 02744002
         TM    ASWITCH,WRZERO           MUST A F0 BE WRITTEN?    XM2969 02745502
         BZ    DELTA1                   BRANCH IF NOT            XM2969 02747002
         MVC   TTRLL(K5),SAVEADR+K5     ADDRESS OF DSCB TO BE    XM2969 02748502
*                                       ZEROED                   XM2969 02750002
         XC    DS1DSNAM(K140),DS1DSNAM  ZERO BUFFER              XM2969 02751502
         LH    RTWO,DS4DSREC            GET HOLE COUNT           XM2969 02753002
         LA    RTWO,K1(RTWO)            INCREMENT BY ONE         XM2969 02754502
         STH   RTWO,DS4DSREC            REPLACE IT               XM2969 02756002
         MVI   CCW11+K4,SKIPFLAG        SET SKIP FLAG            XM2969 02757502
         MVC   SEEK+K3(K5),TTRLL        INSERT SEEK ADDRESS      XM2969 02759002
         LA    RZERO,CCW6               START CHAN PROG AT CCW6  XM2969 02760502
         ST    RZERO,IOB+K16            STORE STARTING CCW ADDR  XM2969 02762002
         BAL   RETURN,EXECUTET          GO WRITE A FORMAT 0      XM2969 02763502
DELTA1   EQU   *                        BRANCH LABEL             XM2969 02765002
         LTR   DRBAK,RFIVE              TEST/SAVE ERROR CODE     O19117 02766502
         BZ    NOERROR                  BR IF NO ERROR           O19117 02768002
         XI    DS4VTOCI,DIRFBIT         RESET/SET DIRF BIT       O19117 02769502
         TM    DS4VTOCI,DIRFBIT         TEST RESULTS             O19117 02771002
         BO    MISTAKE                  BR IF PREVIOUS INTERRUPT O19117 02772502
         CH    RFIVE,IOCODE             TEST ERROR CODE          O19117 02774002
         BE    MISTAKE                  BR IF I/O ERROR          O19117 02775502
         B     FORCEF4                  GO FORCE WRITE F4        O19117 02777002
*                                          DETECTED                     02778502
* THIS SECTION UPDATES THE DSCB FORMAT 4, RELOCATES A WRITE CHANNEL     02780000
* PROGRAM AND WRITES OUT THE UPDATED DSCB FORMAT 4.                     02800000
NOERROR  EQU   *                                                 O19117 02810019
         XI    DS4VTOCI,DIRFBIT         RESET DIRF BIT           O19117 02820019
         LH    RTWO,DS4DSREC            UPDATE THE NUMBER OF AVAILABLE  02840000
         SH    RTWO,UHOLECTR               DSCB RECORDS                 02860000
         STH   RTWO,DS4DSREC                                            02880000
FORCEF4  EQU   *                                                 O19117 02886019
         MVC   SEEK+3(5),DADSMADR       SETUP F4 ADDR            O19117 02892019
         LM    RTWO,RSEVEN,CHANNEL      RELOCATE CHANNEL PROGRAM TO     02900000
         ALR   RTWO,RWORK                 WRITE OUT FORMAT 4 DSCB       02920000
         ALR   RFOUR,RWORK                                              02940000
         ALR   RSIX,RWORK                                               02960000
         STM   RTWO,RSEVEN,CCW1                                         02980000
         LM    RTWO,RSEVEN,CHANNEL+24  RELOCATE LAST 3 CCW'S            03000000
         ALR   RTWO,RWORK                                               03020000
         ALR   RFOUR,RWORK                                              03040000
         ALR   RSIX,RWORK                                               03060000
         STM   RTWO,RSEVEN,CCW4                                         03080000
         LA    RTWO,CCW1                SET UP IOB TO POINT TO THE      03100000
         ST    RTWO,IOB+16              FIRST CCW                A38860 03130021
         BAL   RETURN,EXECUTET                                          03160000
         LTR   RFIVE,DRBAK              TEST/RESTORE ERROR CODE  O19117 03165019
         BNZ   MISTAKE                  BR IF THIS WAS A FORCE   O19117 03170019
*                                       WR                       O19117 03175019
         L     RJFCB,AJFCBPTR           PICK UP JFCB POINTER     Y02080 03200002
* A TEST IS MADE HERE TO DETERMINE WHETHER OR NOT THE REQUEST WAS MULTI 03220000
* VOLUME                                                                03240000
         L     RTEN,ATIOTPTR            LOAD PTR TO DD ENTRY     Y02080 03300002
         CLI   TIOEVOLS(RTEN),X'01'     MULTI-VOLUME REQUEST?    A38860 03320021
         BE    ALLOUT                   BRANCH IF NOT A MULTI- VOLUME   03340000
*                                          REQUEST                      03360000
         SR    RFIVE,RFIVE                                              03380000
         IC    RFIVE,CTR                PICK UP THE UCB COUNTER         03400000
         LA    RFIVE,1(RFIVE)           CHECK THE UCB COUNTER FOR AN    03420000
*                                          EQUAL COMPARE TO THE NUMBER  03440000
*                                          OF UCB'S TO BE ALLOCATED     03460000
         STC   RFIVE,CTR                UPDATE UCB POINTER              03480000
         CLC   CTR(1),TIOEVOLS(RTEN)    CHECK FOR COMPLETION OF  A38860 03500021
*                                       MULTI-VOLUME ALLOCATION  A38860 03520021
         BE    ALLOUT                   BRANCH IF MULTI-VOLUME ALLOCA-  03540000
*                                          TION IS COMPLETE             03560000
         MVI   F2,X'00'                 SET FOR NO FORMAT 2             03580000
         TM    JFCBCTRI,X'DF'           CHECK REQUEST TYPE FIELD FOR AN 03600000
*                                          ABSOLUTE TRACK REQUEST       03620000
         BC    4,MIXED                  BRANCH IF NOT AN ABSOLUTE TRACK 03640000
*                                          REQUEST                      03660000
* THIS SECTION SUBTRACTS THE NUMBER OF TRACKS JUST ALLOCATED FROM THE   03680000
* NUMBER TO BE ALLOCATED IN A MULTI-VOLUME PRIME CASE.  THE AMOUNTS ARE 03700000
* ALSO UPDATED FOR THE NEXT ALLOCATION                                  03720000
         L     RTWO,HOWMUCH             SUBTRACT THE AMOUNT JUST Y02080 03760002
*                                       ALLOCATED FROM THE       Y02080 03772002
*                                       QUANTITY DESIRED         Y02080 03774002
         LH    RTHREE,PRIQTY                                            03780000
         SR    RTWO,RTHREE                                              03800000
         ST    RTWO,HOWMUCH             SET UP THE AMOUNT STILL  Y02080 03820002
*                                       TO BE ALLOCATED          Y02080 03830002
         LH    RSIX,DS4DEVSZ           TEST FOR REQUEST STILL LARGER    03860000
         BCTR  RSIX,0                   ACCOUNT FOR THE VTOC            03890013
         MH    RSIX,DS4DEVSZ+2                                          03920000
         SR    RFIVE,RFIVE              CLEAR REGISTER           A31595 03922020
         L     RTHREE,DEB+32            FETCH UCB PTR            A31595 03924020
         USING UCB,RTHREE               UCB ADDRESSABILITY       Y02130 03924202
         CLI   UCBTBYT4,DA3340          TEST IF 3340             Y02130 03924402
         BNE   NOT3340                  BRANCH IF NOT            Y02130 03924602
         SR    RTWO,RTWO                CLEAR FOR DIVIDE         Y02130 03926002
         LH    RTHREE,DS4DEVSZ          NBR OF CYLS ON VOLUME    Y02130 03926202
         LA    RFOUR,ONE16              4 ALTERNATE TRACKS       Y02130 03926402
         DR    RTWO,RFOUR               FOR EVERY 116 CYLINDERS  Y02130 03926602
*                                       SO DIVIDE CYL BY 116,    Y02130 03926802
         SLL   RTHREE,TWO               MULTIPLY QUOTIENT BY 4   Y02130 03927002
*                                       EQUALS TOTAL ALTERNATES  Y02130 03927202
SUBTALT  EQU   *                        BRANCH LABEL             Y02130 03927402
         SR    RSIX,RTHREE              REDUCE TOTAL BY NUMBER   Y02130 03927602
*                                       OF ALTERNATE TRACKS      Y02130 03927802
         L     RTWO,HOWMUCH             RESTORE REGISTER TWO     Y02130 03928002
         B     CONT                     CONTINUE CALCULATION     Y02130 03928202
NOT3340  EQU   *                        BRANCH LABEL             Y02130 03928402
         IC    RFIVE,UCBTBYT4           FETCH UNIT TYPE          Y02130 03928602
         DROP  RTHREE                                            Y02130 03928802
         L     RTHREE,CVTPTR            FETCH CVT POINTER        Y02134 03929002
         L     RTHREE,CVTZDTAB-CVT(RTHREE) DEVICE TABLE POINTER  Y02134 03930002
         IC    RFIVE,0(RFIVE,RTHREE)    FETCH DEVICE ENTRY       A31595 03932020
*                                       OFFSET                   A31595 03934020
         SH    RSIX,12(RFIVE,RTHREE)    REDUCE TOTAL TRACKS BY   A31595 03936020
*                                       NUMBER OF ALTERNATE TRKS        03938020
CONT     EQU   *                        BRANCH LABEL             Y02130 03938402
         CR    RTWO,RSIX                COMPARE AMOUNT TO BE ALLOCATED  03940000
*                                          TO DEVICE SIZE               03960000
         BH    MORE                     BRANCH IF AMOUNT NEEDED IS      03980000
*                                          LARGER THAN DEVICE SIZE      04000000
         MVC   PRIQTY,HOWMUCH+TWO       AMOUNT TO BE ALLOCATED   Y02080 04020002
*                                          ON NEXT VOLUME               04040000
         B     SETABSTR                                                 04060000
MORE     STH   RSIX,PRIQTY              SET AMOUNT TO BE ALLOCATED ON   04080000
*                                          THE NEXT VOLUME TO DEVICE    04100000
*                                          SIZE                         04120000
SETABSTR MVC   ABSTR(2),DS4DEVSZ+2      SET ABSOLUTE TRACK ADDRESS TO   04140000
*                                         CYLINDER ONE TRACK ZERO       04160000
MIXED    BAL   DRBAK,FINAL1             GO DEQ THIS VOLUME              04180000
*                                                                       04200000
* BRANCH TO LAST LOAD TO PERFORM A DUPLICATE NAME SEARCH ON THE NEXT    04220002
* VOLUME.                                                               04240000
*                                                                       04260000
         IECRES LOAD,EXTPR=(RWORK),MODID=MVOLMOD,BRANCH=DIRECT   Y02080 04310002
*                                                                       04340000
* THIS SECTION EXECUTES A CHANNEL PROGRAM.                              04360002
*                                                                       04380002
EXECUTET EQU   *                                                 A38860 04410021
         MVI   ECB,X'00'                CLEAR ECB                A38860 04420021
         EXCP  IOB                                                      04440000
         WAIT  1,ECB=ECB                                                04460000
         TM    ECB,X'20'                CHECK FOR SUCCESSFUL COMPLETION 04480000
         BCR   7,RETURN                BRANCH IF COMPLETION SUCCESSFUL  04500000
         LA    RFIVE,12                SET ERROR CODE FOR PERMANENT     04520000
*                                         I/O ERROR                     04540000
         B     MISTAKE                                                  04560000
*                                                                       04630002
* THIS SECTION CLEANS UP AFTER LAST PASS FOR A MULTI-VOLUME REQUEST OR  04640000
* A MULTI-DD CARD REQUEST BY RESETTING THE LAST SEVEN BYTES OF THE      04650002
* DDNAME TO BLANKS.  IT UPDATES THE ISAM ALLOCATE INTERFACE IN THE      04660002
* TIOT IF THE CURRENT ALLOCATED DATA SET IS NOT THE LAST OF THE         04670002
* CONCATENATED DD CARDS.  RTEN POINTS TO THE CURRENT TIOT ENTRY.        04672002
*                                                                       04674002
ALLOUT   SR    RFIVE,RFIVE              SET RETURN CODE- SUCCESSFUL     04680000
         L     RTWO,HOWMUCH             TOTAL QTY TO ALLOCATE    Y02080 04720002
         LH    RTHREE,PRIQTY            PICK UP QUANTITY TO BE ALLOC-   04760000
         SR    RTWO,RTHREE                 ATED ON THIS VOLUME          04780000
         BNP   ALLOUTE                  BRANCH IF ALLOC DONE   @ZA02216 04800003
         LA    RFIVE,20                 SET ERROR CODE FOR QUANTITY NOT 04820000
*                                       AVAILABLE                       04840000
         B     MISTAKE                                                  04860000
ALLOUTE  EQU   *                        BRANCH LABEL             Y02134 04870002
         L     RTHREE,ADSABLST          GET DSAB LIST ADDRESS    Y02134 04880002
         L     RTWO,SCNDDSAB(,RTHREE)   RTWO HAS 2ND DSAB ADDR   Y02134 04890002
         LTR   RTWO,RTWO                IS THERE A SECOND DD     Y02134 04900002
         BZ    FINAL                    BRANCH IF CURRENT IS 1ST Y02134 04910002
*                                       AND ONLY DD CARD         Y02134 04920002
TWODD    EQU   *                        AT LEAST TWO DD CARDS    Y02134 04930002
         L     RTHREE,THRDDSAB(,RTHREE) RTHREE HAS 3RD DSAB ADDR Y02134 04940002
         USING DSAB,RTWO                                         Y02134 04950002
         L     RTWO,DSABTIOT            LOAD 2ND TIOT ENTRY ADDR Y02134 04960002
         DROP  RTWO                                              Y02134 04970002
         LTR   RTHREE,RTHREE            TEST FOR A 3RD DD CARD   Y02134 04980002
         BZ    ONLY2DDS                 BRANCH IF NO             Y02134 04990002
THREEDD  EQU   *                        THERE ARE 3 DD CARDS     Y02134 05000002
         USING DSAB,RTHREE                                       Y02134 05010002
         L     RTHREE,DSABTIOT          LOAD 3RD TIOT ENTRY ADDR Y02134 05020002
         DROP  RTHREE                                            Y02134 05030002
         CR    RTEN,RTHREE              TEST IF CURRENT IS 3RD   Y02134 05040002
         BE    THIRDOF3                 BRANCH IF YES            Y02134 05050002
         CR    RTEN,RTWO                TEST IF CURRENT IS 2ND   Y02134 05060002
         BNE   FIRSTOF3                 BRANCH IF NO             Y02134 05070002
*                                                                       05080002
* IF THE CURRENT TIOT ENTRY IS NOT THE LAST OF THE CONCATENATED         05090002
* DD CARDS, THIS SECTION UPDATES THE ISAM ALLOCATE INTERFACE IN         05100002
* THE TIOT FOR THE REMAINING CONCATENATED DD CARD(S).                   05110002
*                                                                       05120002
SCNDOF3  EQU   *                        THE CURRENT TIOT         Y02134 05130002
*                                       ENTRY IS THE 2ND OF 3    Y02134 05132002
         MVC   VOLSQCTR(TWO,RTHREE),VOLSQCTR(RTWO) MOVE THE VOL  Y02134 05140002
*                                       SEQ COUNT INTO 3RD TIOT  Y02134 05150002
         B     FINAL                    CONTINUE                 Y02134 05160002
FIRSTOF3 EQU   *                        THE CURRENT TIOT         Y02134 05170002
*                                       ENTRY IS THE 1ST OF 3    Y02134 05172002
         MVC   ISAMSTAT(SEVEN,RTHREE),ISAMSTAT(RTWO) MOVE THE    Y02134 05180002
*                                       STATUS FROM THE SECOND   Y02134 05190002
*                                       TIOT ENTRY TO THE 3RD    Y02134 05200002
         NI    ISAMSTAT(RTHREE),X'FF'-SECPASS RESET 2ND ENTRY SW Y02134 05210002
         B     FINAL                    CONTINUE                 Y02134 05220002
*                                                                       05230002
* THIS SECTION RESETS THE LAST SEVEN BYTES OF THE DDNAME TO BLANKS.     05240002
*                                                                       05250002
ONLY2DDS EQU   *                        THERE ARE ONLY 2 DD      Y02134 05260002
*                                       CARDS FOR THE DATASET    Y02134 05262002
         CR    RTEN,RTWO                TEST IF CURRENT IS 2ND   Y02134 05270002
         BNE   FINAL                    BRANCH IF NOT            Y02134 05280002
         B     SCNDOF2                  BLANK LAST DD ENTRY      Y02134 05290002
THIRDOF3 EQU   *                        THE CURRENT TIOT         Y02134 05300002
*                                       ENTRY IS THE LAST OF 3   Y02134 05302002
         MVC   ISAMSTAT(SEVEN,RTEN),BLANKS  RESTORE LAST DDNAME  Y02134 05310002
*                                       TO BLANKS                Y02134 05320002
SCNDOF2  EQU   *                        THE CURRENT TIOT ENTRY   Y02134 05330002
*                                       IS THE LAST OF 2 OR 3    Y02134 05332002
         MVC   ISAMSTAT(SEVEN,RTWO),BLANKS  RESTORE SECOND       Y02134 05340002
*                                       DDNAME TO BLANKS         Y02134 05350002
FINAL    LA    DRBAK,FINAL2             SET UP RETURN ADDRESS           05700000
FINAL1   MVC   MJELNAME(8),VTOCNAME     MOVE QUEUE NAME TO WORK AREA    05720000
         MVI   DEQAREA,X'FF'            SET LAST ENTRY CODE             05740000
         SR    RONE,RONE                ZERO REGISTER            Y02080 05750002
         STH   RONE,DEQAREA+TWO         CLEAR FOR DEQ MACRO      Y02080 05760002
         TM    TYPEFLG,SMCDONE          IS SET MUST COMPLETE ON         05780000
         BZ    NOSMC                    BRANCH IF NO                    05800000
*                                                                       05820000
* LINK TO DEQ ROUTINE TO RELEASE MUST COMPLETE AND DEQ THE VTOC         05840000
* ON LAST VOLUME ALLOCATED.                                             05860000
*                                                                       05880000
         DEQ   (MJELNAME,MIELNAME,6,SYSTEMS),RMC=STEP,MF=(E,DEQAREA)    05900016
*                                                                       05920000
         NI    DSMADTB2,X'FF'-DSMVTOCR-DSMSMCE  RESET ENQ'ED SWS Y02144 05930002
         NI    TYPEFLG,X'7F'            CLEAR SMC INDICATOR             05940000
         BR    DRBAK                                                    05960000
*                                                                       05980000
* LINK TO DEQ ROUTINE TO DEQ THE VTOC ON LAST VOLUME ALLOCATED.         06000000
*                                                                       06020000
NOSMC    DEQ   (MJELNAME,MIELNAME,6,SYSTEMS),MF=(E,DEQAREA)             06040016
*                                                                       06050002
         NI    DSMADTB2,X'FF'-DSMVTOCR  RESET VTOC ENQ'ED SWITCH Y02144 06060002
         BR    DRBAK                    RETURN                   Y02080 06061002
*                                                                       06062002
* IF AN I/O ERROR OCCURRED, THIS SECTION ISSUES MESSAGE IEC603I.        06063002
*                                                                       06064002
FINAL2   EQU   *                        TEST FOR I/O ERROR       Y02080 06065002
         CH    RFIVE,IOCODE             TEST FOR I/O ERROR       Y02078 06066002
         BNE   RPSTEST                  BRANCH IF NO I/O ERROR   Y02078 06067002
         MVC   DSCBF1(MSGEND-ERRMSG),ERRMSG  MOVE IN MESSAGE     Y02078 06068002
         L     RUCB,DEB+UCBADDR         LOAD UCB ADDRESS         Y02078 06069002
         USING UCB,RUCB                 UCB ADDRESSABILITY       Y02078 06070002
         MVC   DSCBF1+UUU(L'UCBNAME),UCBNAME  MOVE IN EBCDIC UCB Y02078 06071002
*                                       CHANNEL/UNIT ADDRESS     Y02078 06072002
         MVC   DSCBF1+VOLSER(L'SRTEVOLI),SRTEVOLI  MOVE IN VOLID Y02078 06073002
         WTO   MF=(E,DSCBF1)            ISSUE ERROR MESSAGE      Y02078 06074002
*                                                                       06075002
RPSTEST  EQU   *                        TEST FOR RPS             Y02078 06076002
         TM    DSMADTB1,DSMRPSAP        TEST IF RPS APPENDAGE    YM3048X06078002
                                        IGG019EK WAS LOADED      YM3048 06080002
         BNO   CONTINUE                 BRANCH IF NOT            YM3048 06082002
         L     RONE,DEB+APDIS           POINT TO APPENDAGE TABLE S20201 06083020
         MVC   DEB+APDIS(FOURCH),AVTDS(RONE)  RESTORE AVT PTR    Y02080 06088002
         NI    DSMADTB1,X'FF'-DSMRPSAP  RESET RPS APP LOADED SW  Y02144 06093002
*                                                                       06099002
* THIS SECTION FREES THE WORK AREA AND RETURNS CONTROL TO SCHEDULER     06100000
*                                                                       06101002
CONTINUE EQU   *                                                 S20201 06110020
         LR    REIGHT,RFIVE             SAVE THE RETURN CODE     Y02080 06112002
         IECRES FREE,PREFIX=FIRST,A=(RWORK)  FREE WORK AREAS     Y02080 06120002
         USING CVT,RFTEN                CVT ADDRESSABILITY       Y02080 06122002
         L     RFTEN,CVTPTR             LOAD CVT ADDRESS         Y02080 06130002
         L     RETURN,CVTEXPRO          LOAD EXIT PROLOGUE ADDR  Y02080 06140002
         LR    RFTEN,REIGHT             RETURN CODE IN REG 15    Y02080 06160002
         RETURN ,                                                Y02080 06180002
*                                                                       06184002
* FOR EACH DD CARD CONCATENATED TO THE FIRST ISAM DATA SET DD CARD,     06188002
* THIS SECTION RESETS THE LAST SEVEN BYTES OF THE DDNAME TO BLANKS.     06192002
*                                                                       06196002
MISTAKE  EQU   *                        RESET INDICATORS IN TIOT Y02134 06200002
         L     RTHREE,ADSABLST          GET DSAB LIST ADDRESS    Y02134 06204002
RESETIOT EQU   *                                                 A40449 06208002
         L     RTWO,SCNDDSAB(RTHREE)    GET SECOND/THIRD DSAB    Y02134 06212002
         LTR   RTWO,RTWO                IS THERE ONE             Y02134 06216002
         BZ    FINAL                    BRANCH IF NOT            Y02134 06220002
         USING DSAB,RTWO                                         Y02134 06224002
         L     RTWO,DSABTIOT            GET TIOT ENTRY ADDRESS   Y02134 06228002
         MVC   ISAMSTAT(SEVEN,RTWO),BLANKS  BLANK OUT DDNAME     Y02134 06232002
         LA    RTHREE,FOUR(,RTHREE)     INCREMENT DSAB LIST PTR  Y02134 06236002
         B     RESETIOT                 GET THIRD DSAB           Y02134 06240002
*                                                                       06284002
* CONSTANTS                                                             06288019
*                                                                       06326000
IOCODE   DC    H'12'                    I/O ERROR CODE           O19117 06327000
NOSPACE  DC    H'20'                    NO SPACE ERROR CODE      A40449 06328000
ERRMSG   WTO   'IEC603I VTOC ERRORS MAY EXIST ON UUU,VOLSER,0',  Y02078X06331002
               ROUTCDE=(4,10),DESC=4,MF=L                        Y02078 06332002
MSGEND   EQU   *                        MSG DELIMITER            Y02078 06333002
BLANKS   DC    CL7' '                   SEVEN BLANKS             Y02134 06334002
         DS    0F                       FULLWORD BOUNDARY        Y02078 06336002
CHANNEL  EQU   *                                                        06344000
*CCW1                                                                   06352000
         DC    X'31'                         SEARCH ID EQUAL            06360000
         DC    AL3(0+VTOCADR-FIRST)                                     06380000
         DC    X'4000'                                                  06400000
         DC    H'5'                                                     06420000
*CCW2                                                                   06440000
         DC    X'08'                         TIC TO SEARCH ID EQUAL     06460000
         DC    AL3(0+CCW1-FIRST)                                        06480000
         DC    F'0'                                                     06500000
*CCW3                                                                   06520000
         DC    X'05'                         WRITE DATA                 06540000
         DC    AL3(0+IECSDSF4-FIRST)                                    06560000
         DC    X'4000'                                                  06580000
         DC    H'96'                                                    06600000
*CCW4                                                                   06620000
         DC    X'31'                         SEARCH ID EQUAL            06640000
         DC    AL3(0+VTOCADR-FIRST)                                     06660000
         DC    X'4000'                                                  06680000
         DC    H'5'                                                     06700000
*CCW5                                                                   06720000
         DC    X'08'                         TIC TO SEARCH ID RQUAL     06740000
         DC    AL3(0+CCW4-FIRST)                                        06760000
         DC    F'0'                                                     06780000
*CCW6                                                                   06800000
         DC    X'06'                         READ DATA                  06820000
         DC    AL3(0+IECSDSF4-FIRST)                                    06840000
         DC    X'1000'                                                  06860000
         DC    H'96'                                                    06880000
VTOCNAME DC    CL8'SYSVTOC '            MAJOR QUEUE NAME                06920000
*                                                                       06931002
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         06932002
*                                                                       06933002
         XCTLTABL ID=(MVOLMOD,I8),SVC=032,LENGTH=,BRT=YES        Y02080 06934002
         SPACE 2                                                 Y02134 06935002
         IECDSECS CVT,DSAB,UCB,EXPAND=YES  CVT, UCB, DSAB DSECTS Y02134 06937002
JFCBKEN  DSECT                                                          06940000
         IEFJFCBN                                                       06960000
         EJECT                                                   Y02080 06970002
DSCBWKAR IECALLWA EP,F4,D1=(1),D2=(5),ADT=YES ALLOCATE WORK AREA XM2969 06980002
DEQAREA  EQU   DS4IDFMT                 DEQ TABLE AREA                  08240000
MJELNAME EQU   DS4IDFMT+16              MAJOR RESOURCE NAME        AAAA 08260016
         END                                                            08400000
