 TITLE 'IGG0553B - EXTEND - SPACE SEARCH ROUTINE'                       00020000
IGG0553B CSECT                                                          00022021
*                                                                       00022502
*MODULE NAME = IGG0553B                                                 00023002
*                                                                       00023502
*DESCRIPTIVE NAME = EXTEND - SPACE SEARCH ROUTINE                       00023602
*                                                                       00023702
*COPYRIGHT = NONE                                                       00023802
*                                                                       00023902
*CHANGE ACTIVITY = SEE BELOW                                            00024402
*                                                                       00024502
*          RELEASE 22 DELETIONS                                       * 00024902
*          RELEASE 21 DELETIONS                                       * 00026021
*1394075440-075560,095000                                        M0050  00030021
*1394000400,000600,001600-004200,012000,013800-015200,016000-    M0130  00032021
*1394016400,016800-018000,018400,018800,023600,033400,043200-    M0130  00034021
*1394043400,046800,049600-050200,051200-051600,076000,087600,    M0130  00036021
*1394088400-089400,090200-092800,093400-093800,096600            M0130  00038021
*0000032000-032200,038400                                        M2281  00040021
*0000034800                                                     SA54497 00042021
*          RELEASE 20 DELETIONS                                       * 00044021
*1463                                                            M6099  00050020
*        VS2 RELEASE 02 DELETIONS/CHANGES                             * 00051002
*0000000030-000150,002360,002460,003800-004934,013400,014200,    Y02080 00051102
*0000014800,015600,016700-018680,019000-023400,024520-029800,    Y02080 00051202
*0000030800,032000-033400,033800-034400,035800-036200,036600,    Y02080 00051302
*0000037000-038800,040200-041000,041400-042000,043000-044400,    Y02080 00051402
*0000045400-045800,046200,047200-048000,049000,050400,052000,    Y02080 00051502
*0000052400-052600,053000,054000-054200,056000,056400-056800,    Y02080 00051602
*0000057200-058000,058400-059400,059800-060000,061000,062200-    Y02080 00051702
*0000062800,064000-066200,066600-067400,067800-068000,068600-    Y02080 00051802
*0000069200,069600-072000,072400-073200,073600-074200,074600-    Y02080 00051902
*0000074800,075260,075600,076200-076400,077400,078400,079400,    Y02080 00052002
*0000080400,081200,082200,083200,084000,085000,086000,086800,    Y02080 00052102
*0000087400,087600-089800,091000,093400-756400                   Y02080 00052202
*                                                                     * 00054002
* STATUS CHANGE LEVEL  003                                              00055021
*                                                                     * 00061021
*FUNTION/OPERATION:                                                   * 00067021
*   THIS MODULE READS IN THE FIRST FORMAT 5 DSCB AND SEARCHES IT      * 00073021
*   FOR AVAILABLE EXTENTS THAT WILL FILL THE SECONDARY REQUEST. A     * 00080000
*   PUSH DOWN LIST OF UP TO FIVE ENTRIES IS BUILT UNTIL AN AVAILABLE  * 00100000
*   EXTENT IS FOUND THAT IS EQUAL OR GREATER THAN THE REQUEST. THE    * 00120000
*   EXTENT CLOSEST IN SIZE TO THE REQUEST IS HELD AND NEW EXTENTS ARE * 00140000
*   COMPARED AGAINST THIS EXTENT. WHEN THE PREFERRED EXTENT IS        * 00148021
*   ENCOUNTERED AND THERE IS SUFFICIENT SPACE TO FULFILL THE REQUEST, * 00156021
*   THE PREFERRED EXTENT IS ENTERED IN THE DADSM EXTENT TABLE. IF     * 00164021
*   ANOTHER FORMAT 5 DSCB EXISTS, IT IS ALSO SEARCHED FOR SPACE.      * 00172021
*   AFTER ALL AVAILABLE EXTENTS HAVE BEEN SEARCHED, THE DADSM TABLE   * 00180021
*   IS BUILT FROM THE HELD QUANTITY, IF ONE EXISTS. IF THERE IS NO    * 00188021
*   HELD QUANTITY, THE PUSHDOWN LIST IS EXAMINED TO SEE IF TWO OR     * 00196021
*   MORE EXTENTS CAN SATISFY THE REQUEST. THE EXTENT OR EXTENTS THAT  * 00204021
*   SATISFY THE REQUEST ARE ENTERED IN THE DADSM EXTENT TABLE.        * 00212021
*                                                                     * 00220021
*ENTRY POINT:                                                         * 00228021
*   IGG0553B - ENTRY IS MADE FROM IGG0553G VIA A BRANCH.              * 00236002
*                                                                     * 00244021
*INPUT:                                                               * 00252021
*   REGISTER 4 POINTS TO THE I/O SUPPORT WORK AREA.                   * 00260021
*   REGISTER 5 POINTS TO THE USER'S DEB.                              * 00264002
*   REGISTER 11 POINTS TO THE EXTEND WORK AREA.                       * 00268021
*   REGISTER 12 CONTAINS THE AMOUNT OF SPACE REQUESTED.               * 00276021
*   REGISTER 13 CONTAINS THE PREFERRED RTA.                           * 00284021
*   THE I/O SUPPORT WORK AREA IS LAID OUT AS FOLLOWS:                 * 00292021
*                                                                     * 00300021
*          BYTES          AREA                                        * 00308021
*         *******        ******                                       * 00316021
*          100            DSCB FIELD                                  * 00324021
*          176            JFCB                                        * 00332021
*            4            ECB                                         * 00340021
*           40            IOB                                         * 00348021
*           44            DEB                                         * 00356021
*            4            DCB                                         * 00364021
*           96            CCW'S                                       * 00372021
*                                                                     * 00376002
*OUTPUT:                                                              * 00380002
*   REGISTER 4 POINTS TO THE I/O SUPPORT WORK AREA.                   * 00400002
*   REGISTER 5 POINTS TO THE USER'S DEB.                              * 00420002
*   REGISTER 11 POINTS TO THE EXTEND WORK AREA, WHICH CONTAINS THE    * 00440002
*   DADSM EXTENT TABLE.                                               * 00460002
*                                                                     * 00480002
*              ***************************************                * 00500000
*              *             DADSM TABLE             *                * 00520000
*              ***************************************                * 00540000
*                                                                     * 00560000
*              ***************************************                * 00580000
*              *        *         *                  *                * 00600000
*              *  TYPE  *  NO OF  *     USED HOLE    *                * 00620000
*              *  FLAG  * ENTRIES *      COUNTER     *                * 00640000
*              *        *         *                  *                * 00660000
*              ***************************************                * 00680000
*              *                  *                  *                * 00700000
*              *       RTA        *      RTA+1       *                * 00720000
*              *                  *                  *                * 00740000
*              ***************************************                * 00760000
*              *                  *                  *                * 00780000
*              *       RTA        *      RTA+1       *                * 00800000
*              *                  *                  *                * 00820000
*              ***************************************                * 00840000
*              *                  *                  *                * 00860000
*              *       RTA        *      RTA+1       *                * 00880000
*              *                  *                  *                * 00900000
*              ***************************************                * 00920000
*              *                  *                  *                * 00940000
*              *       RTA        *      RTA+1       *                * 00960000
*              *                  *                  *                * 00980000
*              ***************************************                * 01000000
*              *                  *                  *                * 01020000
*              *       RTA        *      RTA+1       *                * 01040000
*              *                  *                  *                * 01060000
*              ***************************************                * 01080000
*                                                                     * 01100000
*              NO OF ENTRIES = NUMBER OF ENTRIES WITHIN DADSM TABLE.  * 01120000
*                                                                     * 01140000
*              RTA = THE STARTING TRACK OF THE ALLOCATED EXTENT.      * 01160000
*                                                                     * 01180000
*              RTA+1 = THE STARTING TRACK OF THE NEXT AVAILABLE EXTENT* 01200021
*                                                                     * 01220000
*                                                                     * 01240000
*                                                                     * 01260000
*EXTERNAL ROUTINES:                                                   * 01280000
*        EXCP(0) - READ OR WRITE DIRECT ACCESS DEVICE                 * 01300000
*        WAIT(1) - WAIT ON EVENT CONTROL BLOCK                        * 01320000
*        IECRES - BRANCH TO ANOTHER MODULE                            * 01340002
*                                                                     * 01360000
*EXITS:                                                               * 01390021
*   NORMAL - BRANCH TO IGG0553C                                       * 01420002
*                                                                     * 01450021
*   ERROR  - BRANCH TO IGG0553E WITH THE ENTRY CODE IN REGISTER 13    * 01480002
*   ERROR CONDITIONS ARE I/O ERROR OR QUANTITY NOT AVAILABLE.         * 01510021
*                                                                     * 01540000
*ATTRIBUTES: REENTRANT                                                * 01560002
*                                                                     * 01580000
*OTHER MACROS USED:                                                   * 01600021
*   IECDSECT - TO DEFINE THE I/O SUPPORT WORK AREA                    * 01620021
*   IECEXTWA - TO DEFINE THE EXTEND WORK AREA                         * 01630002
*   IECSDSL1 - TO SYMBOLICALLY ADDRESS DSCB'S                         * 01640021
*   CVT - TO DEFINE THE CVT                                           * 01650002
*                                                                     * 01660000
*STORAGE: PROGRAM CODE CSECT - LESS THAN 1024 BYTES                   * 01690002
*         EXTEND WORK AREA - AS DEFINED IN THE IECEXTWA MACRO         * 01720002
*         RPS WORK AREA - AS DEFINED IN THE IECRPS MACRO              * 01750002
*         I/O SUPPORT WORK AREA                                       * 01800002
*                                                                     * 01810002
         BALR  RBASE,K0                 CSECT ADDRESSABILITY     Y02080 01820002
         USING BEGIN,RBASE                                       Y02080 01840002
         USING EOVWKA,RCORE             EOV W/A ADDRESSABILITY   Y02080 01860002
         USING EXTNDWKA,EXWKA           WORK AREA ADDRESSABILITY Y02080 01868002
*                                                                       01876021
* REGISTER EQUATES                                                      01884021
*                                                                       01892021
REG0     EQU   0                        EQUATE FOR REGISTER 0    Y02080 01900002
RHH      EQU   0                        NUMBER OF EXTRA TRACKS   Y02080 01910002
REG1     EQU   1                        EQUATE FOR REGISTER 1    Y02080 01920002
RCC      EQU   1                        NUMBER OF CYLINDERS      Y02080 01930002
ALTWKA   EQU   1                        ALTERNATE EXTEND WKA PTR Y02080 01940002
RIN      EQU   2                        INPUT F5 POINTER         Y02080 01950002
RBASE    EQU   3                        BASE REGISTER            Y02080 01960002
RCORE    EQU   4                        EOV WORK AREA POINTER    Y02080 01980002
RDEB     EQU   5                        DEB POINTER              Y02080 02020002
RCTR     EQU   6                        COUNTER                  Y02080 02030002
RTA1     EQU   6                        EVEN REGISTER            Y02080 02040002
REG6     EQU   6                        EQUATE FOR REGISTER 6    Y02080 02050002
REG7     EQU   7                        EQUATE FOR REGISTER 7    Y02080 02060002
RTA      EQU   7                        ODD REGISTER             Y02080 02080002
REG8     EQU   8                        EQUATE FOR REGISTER 8    Y02080 02100002
ROUT     EQU   8                        CONVERTED F5 POINTER     Y02080 02120002
TBLPTR   EQU   8                        DADSMTBL ENTRY POINTER   Y02080 02140002
REG9     EQU   9                        EQUATE FOR REGISTER 9    Y02080 02160002
PDLPTR   EQU   9                        PUSHDOWN LIST POINTER    Y02080 02180002
RA       EQU   10                       EQUATE FOR REGISTER 10   Y02080 02200002
RTRK     EQU   10                       NUMBER OF TRKS/CYLINDER  Y02080 02220002
EXWKA    EQU   11                       EXTEND WORK AREA POINTER Y02080 02240002
RC       EQU   12                       EQUATE FOR REGISTER 12   Y02080 02250002
REQ      EQU   12                       SPACE REQUESTED          Y02080 02260002
REG13    EQU   13                       EQUATE FOR REGISTER 13   Y02080 02280002
RPREF    EQU   13                       PREFERRED RTA            Y02080 02300002
RE       EQU   14                       EQUATE FOR REGISTER 14   Y02080 02310002
RCNT     EQU   14                       COUNTER OF EXTENTS       Y02080 02320002
RF       EQU   15                       EQUATE FOR REGISTER 15   Y02080 02330002
RHOLD    EQU   15                       HELD QUANTITY INDICATOR  Y02080 02340002
*                                                                       02348021
* OTHER EQUATES                                                         02356021
*                                                                       02364021
ONEENTRY EQU   X'01'                    ONE ENTRY IN DADSM TABLE M0130  02372021
K0       EQU   0                        CONSTANT OF 0            Y02080 02372502
K1       EQU   1                        CONSTANT OF 1            Y02080 02373002
K2       EQU   2                        CONSTANT OF 2            Y02080 02374002
K3       EQU   3                        CONSTANT OF 3            Y02080 02375002
K4       EQU   4                        CONSTANT OF 4            Y02080 02376002
K5       EQU   5                        CONSTANT OF 5            Y02080 02377002
K24      EQU   24                       CONSTANT OF 24           Y02080 02377502
K26      EQU   26                       CONSTANT OF 26           Y02080 02378002
K27      EQU   27                       CONSTANT OF 27           Y02080 02378502
K48      EQU   48                       CONSTANT OF 48           Y02080 02379002
K72      EQU   72                       CONSTANT OF 72           Y02080 02379502
K108     EQU   108                      CONSTANT OF 108          Y02080 02379602
*                                                                       02380000
* THIS SECTION RELOCATES THE CHANNEL PROGRAM FOR                        02400000
* READING IN THE DSCB FORMAT 5.                                         02420000
*                                                                       02440000
BEGIN    EQU   *                        BRANCH LABEL             M0130  02446002
         SR    RHOLD,RHOLD              CLEAR HOLD SWITCH        Y02080 02452002
         MVC   DS5PTRDS,EDADSMAD        MOVE IN FIRST F5 ADDRESS Y02080 02460002
         LR    ALTWKA,EXWKA             SAVE BASE REGISTER       Y02080 02500002
         LM    REG6,EXWKA,CHANPRO       PICK UP FIRST 3 CCW'S    Y02080 02520002
         ALR   REG6,ALTWKA                                       Y02080 02540002
         ALR   REG8,ALTWKA                                       Y02080 02560002
         ALR   RA,RCORE                                          Y02080 02580002
         STM   REG6,EXWKA,DXCCW1        STORE FIRST 3 CCW'S      Y02080 02600002
         LM    REG6,EXWKA,CHANPRO+K24   PICK UP NEXT 3 CCW'S     Y02080 02620002
         ALR   REG6,RCORE                                        Y02080 02640002
         ALR   REG8,ALTWKA                                       Y02080 02660002
         ALR   RA,ALTWKA                                         Y02080 02680002
         STM   REG6,EXWKA,DXCCW4        STORE NEXT 3 CCW'S       Y02080 02700002
         LM    REG6,EXWKA,CHANPRO+K48   PICK UP NEXT 3 CCW'S     Y02080 02720002
         ALR   REG6,RCORE                                        Y02080 02740002
         ALR   REG8,ALTWKA                                       Y02080 02760002
         ALR   RA,RCORE                                          Y02080 02780002
         STM   REG6,EXWKA,DXCCW7        STORE NEXT 3 CCW'S       Y02080 02800002
         LM    REG6,REG9,CHANPRO+K72    PICK UP LAST 2 CCW'S     Y02080 02820002
         ALR   REG6,RCORE                                        Y02080 02840002
         ALR   REG8,ALTWKA                                       Y02080 02860002
         STM   REG6,REG9,DXCCW10        STORE LAST 2 CCW'S       Y02080 02880002
         LR    EXWKA,ALTWKA                                      Y02080 02900002
         LA    REG6,DXCCW9                                       Y02080 02920002
         ST    REG6,IOBSIOCC                                     Y02080 02940002
READF5   EQU   *                        BRANCH LABEL             Y02080 02950002
         MVC   DXDAADDR+K3(K5),DS5PTRDS  INSERT SEEK ADDRESS     Y02080 02960002
         LR    REG6,RHOLD               SAVE HOLD SWITCH         Y02080 02980002
         EXCP  DXIOB                                                    03000000
         WAIT  1,ECB=DXECB                                              03020000
         TM    DXECB,X'20'              TEST FOR PERMANENT I/O ERROR    03040000
         BC    8,UNSUCFUL                                               03060000
         LR    RHOLD,REG6               RESTORE HELD QTY SWITCH  Y02080 03080002
*                                                                       03100000
* THIS SECTION CONVERTS THE EXTENTS IN THE FORMAT 5 FROM XXYYZ TO       03120000
* RTA - NO. OF TRACKS                                                   03140000
*                                                                       03160000
SETUP    MVC   READIN+44(90),READIN+45 CLOSE UP EXTENTS OVER ID         03180000
         SR    RHH,RHH                  CLEAR NUMBER OF TRACKS   Y02080 03200002
         LA    RIN,READIN+K4            SET UP INPUT F5 POINTER  Y02080 03240002
         LR    ROUT,RIN                 POINTER TO CONVERTED F5  Y02080 03260002
         LA    RCNT,K26                 NUMBER OF INPUT EXTENTS  Y02080 03280002
TESTZERO EQU   *                        BRANCH LABEL             Y02080 03290002
         LH    RTRK,DS4DEVSZ+K2         NUMBER OF TRACKS/CYL     Y02080 03300002
         SR    RTA1,RTA1                INITIALIZE FOR DIVISION  Y02080 03320002
         CLC   0(K2,RIN),ZEROS          CHECK FOR A ZERO EXTENT  Y02080 03340002
         BE    INCRIN                   BRANCH IF ZERO TO UPDATE PTRS.  03360000
         MVC   ENEXTADR,0(RIN)          SET XXYYZ ON HALFWORD    Y02080 03380002
         LH    RCC,ENEXTADR+K2                                   Y02080 03400002
         MH    RCC,DS4DEVSZ+K2          MULTIPLY YY BY TRKS/CYL  Y02080 03420002
         LH    RTA,ENEXTADR                                      Y02080 03440002
         TM    JFCBCTRI,X'C0'           TEST FOR CYLINDER REQUEST       03460000
         BO    CYLRND                   BRANCH IF CYLINDER REQ  SA54497 03480021
         TM    JFCBCTRI,JFCBAVR+JFCROUND TEST FOR ROUND REQUEST SA54497 03490021
         BNO   ADD                      BRANCH IF NOT ROUND     SA54497 03492021
*                                                                       03500000
* IF REQUEST IS IN CYLINDERS MUST ROUND RTA UP TO CYLINDER BOUNDARY     03520000
* IF NECESSARY                                                          03540000
*                                                                       03560000
CYLRND   EQU   *                        BRANCH LABEL            SA54497 03570002
         DR    RTA1,RTRK                DIVIDE RTA BY TRKS/CYL   Y02080 03580002
         MH    RTA,DS4DEVSZ+K2          FIND NO. OF FULL CYLS    Y02080 03600002
         LTR   RTA1,RTA1                TEST IF ON CYL BOUNDARY  Y02080 03620002
         BZ    ADDA                     BRANCH IF YES                   03640000
         AR    RTA,RTRK                 ROUND UP TO NEXT CYL     Y02080 03660002
         B     ADDA                                                     03680000
ADD      EQU   *                        BRANCH LABEL             Y02080 03690002
         IC    RHH,ENEXTADR+K4          PICK UP SURPLUS TRACKS   Y02080 03700002
         AR    RCC,RHH                  ADD SURPLUS NO. OF TRKS  Y02080 03720002
ADDA     EQU   *                        BRANCH LABEL             Y02080 03730002
         STH   RCC,K2(ROUT)             STORE CONVERTED EXTENT   Y02080 03740002
         STH   RTA,0(ROUT)                                       Y02080 03760002
         LA    ROUT,K4(ROUT)            INCREMENT POINTERS       Y02080 03780002
INCRIN   EQU   *                        BRANCH LABEL             Y02080 03790002
         LA    RIN,K5(RIN)                                       Y02080 03800002
         BCT   RCNT,TESTZERO            GO CONVERT NEXT EXTENT   Y02080 03820002
         XC    0(K27,ROUT),0(ROUT)      CLEAR REST OF AREA       Y02080 03840002
         LA    RIN,DS5AVEXT             SET UP INPUT F5 POINTER  Y02080 03860002
         B     BEGINHRE                                                 03900000
*                                                                       03920000
* THIS SECTION CHECKS FOR INDEX POINTING TO THE 26 TH EXTENT OF A DSCB  03940000
* FORMAT 5. IF NOT THE INDEX IS UPDATED TO THE NEXT DADSM ENTRY AND     03960000
* THE SEARCH CONTINUES. IF AT THE END A TEST IS MADE TO SEE IF ANOTHER  03980000
* FORMAT 5 IS PRESENT. IF SO THE NEW FORMAT 5 IS READ IN AND THE SEARCH 04000000
* IS CONTINUED.                                                         04020002
*                                                                       04040002
TESTLOC  EQU   *                        BRANCH LABEL             Y02080 04060002
         LA    RA,READIN+K108           TEST FOR LAST EXTENT     Y02080 04080002
         CR    RA,RIN                                            Y02080 04100002
         BNE   BEGSURCH                 BRANCH IF MORE EXTENTS          04120000
         OC    DS5PTRDS,DS5PTRDS        TEST IF ANOTHER F5       Y02080 04160002
         BZ    FILLIT                   BRANCH IF NO MORE F5'S   Y02080 04200002
         B     READF5                   READ ANOTHER FORMAT 5           04220000
*                                                                       04240000
* I/O ERROR AND EXIT ROUTINES                                           04260000
*                                                                       04280000
UNSUCFUL EQU   *                        BRANCH LABEL             Y02080 04290002
         SR    REG13,REG13              ZERO REGISTER            Y02080 04300002
         IC    REG13,DXEXTSW            PICK UP CALLER CODE      Y02080 04320002
         LA    REG6,LASTLOAD            POINT TO ID OF IGG0553E  Y02080 04330002
XCTLHERE EQU   *                        BRANCH LABEL             Y02080 04360002
         IECRES LOAD,EXTPR=(EXWKA),MODID=(REG6),BRANCH=DIRECT    Y02080 04420002
*                                                                       04460000
* THIS SECTION BEGINS THE SEARCH BY TRYING TO FIND AN EXTENT ADJACENT   04480000
* TO THE DATA SET                                                       04500000
*                                                                       04520000
BEGSURCH EQU   *                        BRANCH LABEL             Y02080 04530002
         LA    RIN,K4(RIN)              UPDATE SEARCH POINTER    Y02080 04540002
BEGINHRE EQU   *                        COMPARE THE PREFERRED    Y02080 04560002
         CH    RPREF,0(RIN)             RTA TO THE F5 RTA        Y02080 04580002
         BNE   CHECKOUT                 BRANCH NOT EQUAL                04600000
         CH    REQ,K2(RIN)              TEST IF QTY AVAILABLE    Y02080 04620002
         BH    QTNOTAVL                 NOT AVAILABLE                   04640000
*                                                                       04660000
* WHEN THERE IS SUFFICIENT SPACE AT THE PREFERRED RTA TO FULFILL        04670021
* THE REQUEST, THE PREFERRED EXTENT IS ENTERED IN THE DADSM TABLE.      04680021
*                                                                       04700000
ONEDADSM EQU   *                        BRANCH LABEL             Y02080 04710002
         LH    REG6,0(RIN)              ADD REQUESTED QUANTITY   Y02080 04720002
         AR    REG6,REQ                 TO BEGINNING RTA         Y02080 04740002
         STH   REG6,K2(RIN)                                      Y02080 04760002
         MVC   ENTRIES(K4),0(RIN)       SET UP TABLE             Y02080 04780002
         MVI   ENTRYNUM,ONEENTRY        ONE DADSM ENTRY          Y02080 04800002
         B     BUILDONE                                                 04820000
*                                                                       04840000
* WHEN RTA IS NOT AVAILABLE THE QUANTITY IS CHECKED                     04860000
*                                                                       04880000
CHECKOUT EQU   *                        BRANCH LABEL             Y02080 04890002
         CH    REQ,K2(RIN)              TEST QUANTITY AVAILABLE  Y02080 04900002
         BH    QTNOTAVL                 QUANTITY TOO SMALL              04920000
         BL    COMPARE                  QUANTITY TOO LARGE              04940000
         CH    RPREF,0(RIN)             COMPARE RTA'S            Y02080 05040002
         BNH   ONEDADSM                 BRANCH IF RTA AVAILABLE IS NOT  05060000
*                                        LOWER THAN REQUESTED RTA       05080000
*                                                                       05100000
* THIS SECTION COMPARES THE NEW EXTENT WITH THE HELD EXTENT TO          05120021
* DETERMINE WHICH EXTENT IS THE CLOSEST IN SIZE TO THE ORIGINAL         05140021
* REQUEST.                                                              05160021
*                                                                       05180000
COMPARE  EQU   *                        BRANCH LABEL             Y02080 05190002
         LTR   RHOLD,RHOLD              TEST FOR QUANTITY HELD   Y02080 05200002
         BZ    NOHOLD                   BRANCH IF NOT HELD              05220000
         L     REG6,0(RIN)              COMPARE NEW QTY TO HELD  Y02080 05240002
         CLC   K2(K2,RIN),EPDLIST1+K2   IS NEW QUANTITY LOWER    Y02080 05260002
         BH    TESTLOC                  BRANCH IF NOT CLOSER TO REQUEST 05280000
         ST    REG6,EPDLIST1            IF CLOSER - NEW QUANTITY Y02080 05300002
         B     TESTLOC                   BECOMES HELD QUANTITY          05320000
*                                                                       05330021
* NO QUANTITY IS BEING HELD SO THIS ONE IS THE FIRST TO BE EQUAL OR     05340000
* GREATER THAN THE REQUEST AND BECOMES THE HELD QUANTITY                05360000
*                                                                       05380000
NOHOLD   EQU   *                        BRANCH LABEL             Y02080 05390002
         MVC   EPDLIST1,0(RIN)          SET UP THE HELD QUANTITY Y02080 05400002
         LA    RHOLD,K1(RHOLD)          SET HELD QUANTITY SWITCH Y02080 05420002
         B     TESTLOC                                                  05440000
*                                                                       05460000
* THIS SECTION IS ENTERED WHEN THE QUANTITY IS LESS THAN THE REQUEST    05480000
* FIRST A TEST IS MADE TO CHECK FOR A HELD QUANTITY. IF ONE EXISTS THE  05500000
* NEW EXTENT IS DISREGARDED AND A RETURN IS MADE TO EXAMINE THE NEXT    05520000
* EXTENT. IF THERE IS NO HELD QUANTITY THE PUSH DOWN LIST MUST BE       05540000
* EXAMINED.                                                             05560000
*                                                                       05580000
QTNOTAVL EQU   *                        BRANCH LABEL             Y02080 05590002
         LTR   RHOLD,RHOLD              TEST FOR HELD QUANTITY   Y02080 05600002
         BP    TESTLOC                  BRANCH IF QUANTITY HELD         05620000
CHEKLIST EQU   *                        BRANCH LABEL             Y02080 05630002
         L     REG9,0(RIN)              LOAD CONVERTED EXTENT    Y02080 05640002
         LH    REG0,K2(RIN)             LOAD NUMBER OF TRACKS    Y02080 05660002
         CH    REG0,EPDLIST5+K2         COMPARE PUSHDOWN ENTRY   Y02080 05680002
         BNH   TESTLOC                  BRANCH IF NEW QUANTITY LOW      05700000
FINDSLOT EQU   *                        BRANCH LABEL             Y02080 05710002
         MVC   EPDLIST5,0(RIN)          EXCHANGE NEW QTY WITH    Y02080 05720002
*                                       SMALLEST IN LIST         Y02080 05740002
         LA    REG6,K4                  SET INDEX DECREMENT      Y02080 05760002
         LA    REG7,EPDLIST4            SET LOCATION INDEX       Y02080 05780002
COMPTEST EQU   *                        BRANCH LABEL             Y02080 05790002
         CH    REG0,K2(REG7)            COMPARE NEXT ENTRY       Y02080 05800002
         BNH   TESTLOC                  BRANCH IF NEW QUANTITY LOW      05820000
EXCHANGE EQU   *                        BRANCH LABEL             Y02080 05830002
         LR    REG8,REG7                                         Y02080 05840002
         AR    REG8,REG6                                         Y02080 05860002
         MVC   0(K4,REG8),0(REG7)       EXCHANGE ENTRIES         Y02080 05880002
         ST    REG9,0(REG7)                                      Y02080 05900002
         LA    REG8,EPDLIST1            CHECK IF AT END OF THE   Y02080 05920002
         CR    REG8,REG7                PUSH DOWN LIST           Y02080 05940002
         BE    TESTLOC                  BRANCH IF END                   05960000
         SR    REG7,REG6                DECREMENT LOCATION INDEX Y02080 05980002
         B     COMPTEST                 GO COMPARE AGAIN         Y02080 06000002
*                                                                       06020000
* TESTS ARE MADE HERE TO DETERMINE IF WITH ONE OR MORE EXTENTS THE      06040000
* REQUEST CAN BE FILLED ON THIS VOLUME.                                 06060000
*                                                                       06080000
FILLIT   EQU   *                        BRANCH LABEL             Y02080 06090002
         LTR   RHOLD,RHOLD              TEST FOR HELD QUANTITY   Y02080 06100002
         BZ    PICKLIST                 BRANCH IF NO HELD QUANTITY      06120000
*                                                                       06140000
* AN EXTENT IS AVAILABLE THAT IS EQUAL TO OR GREATER THAN REQUEST.  THE 06160000
* QUANTITY REQUESTED IS ADDED TO STARTING RTA TO DETERMINE ENDING RTA+1 06180000
*                                                                       06200000
         AH    REQ,EPDLIST1             HELD QTY IS AVAILABLE    Y02080 06220002
         STH   REQ,ENTRIES+K2           BUILD DADSM EXTENT TABLE Y02080 06240002
         MVC   ENTRIES(K2),EPDLIST1     SET UP TABLE             Y02080 06260002
         MVI   ENTRYNUM,ONEENTRY        ONE DADSM ENTRY          Y02080 06280002
         B     BUILDONE                                                 06300000
*                                                                       06320000
* THE PUSH DOWN LIST IS EXAMINED FOR UP TO 5 EXTENTS WHICH TOGETHER CAN 06340000
* FILL THE REQUEST                                                      06360000
*                                                                       06380000
PICKLIST EQU   *                        BRANCH LABEL             Y02080 06390002
         MVC   ENTRIES(K4),EPDLIST1     MOVE IN RTA1/RTA2 OF     Y02080 06400002
*                                       THE LARGEST EXTENT       Y02080 06410002
         LH    REG6,ENTRIES             CONVERT FIRST ENTRY      Y02080 06420002
         AH    REG6,ENTRIES+K2                                   Y02080 06440002
         STH   REG6,ENTRIES+K2                                   Y02080 06460002
         SR    RCTR,RCTR                INITIALIZE COUNTER       Y02080 06480002
         LA    TBLPTR,ENTRIES+K4        POINT TO ADDRESS OF NEXT Y02080 06500002
         LA    PDLPTR,EPDLIST2          TABLE ENTRY & PUSH DOWN  Y02080 06520002
         LA    RF,K4                    INITIALIZE TO TEST CTR   Y02080 06540002
         LH    REG7,EPDLIST1+K2         PICK UP LARGEST QUANTITY Y02080 06560002
AGAIN    EQU   *                        BRANCH LABEL             Y02080 06570002
         AH    REG7,K2(PDLPTR)          ADD QUANTITY TO SUM      Y02080 06580002
         LA    RCTR,K1(RCTR)            INCREMENT COUNTER        Y02080 06600002
         CR    REG7,REQ                 COMPARE TO REQUEST       Y02080 06620002
         BNL   COMBINEX                 COMBINE WHEN SUFFICIENT         06640000
         LH    REG13,0(PDLPTR)          PICK UP RTA              Y02080 06660002
         AH    REG13,K2(PDLPTR)         ADD NUMBER OF TRACKS     Y02080 06680002
         STH   REG13,K2(PDLPTR)         CALCULATE ENDING RTA+1   Y02080 06700002
         MVC   0(K4,TBLPTR),0(PDLPTR)   MOVE EXTENT TO DADSMTBL  Y02080 06720002
         CR    RCTR,RF                  TEST CTR FOR 5TH EXTENT  Y02080 06740002
         BE    UNSUCFUL                 IF NOT SUFFICIENT - GET OUT     06760000
         LA    TBLPTR,K4(TBLPTR)        INCREMENT POINTERS       Y02080 06780002
         LA    PDLPTR,K4(PDLPTR)                                 Y02080 06800002
         B     AGAIN                    ENTER LOOP AGAIN                06820000
COMBINEX BH    SUBEXCES                 IF QUANTITY EXACT RTA'S OF LAST 06840000
         LH    REG13,0(PDLPTR)          EXTENT USED ARE MOVED TO Y02080 06860002
         AH    REG13,K2(PDLPTR)         THE DADSM EXTENT TABLE   Y02080 06880002
         STH   REG13,K2(PDLPTR)                                  Y02080 06900002
         MVC   0(K4,TBLPTR),0(PDLPTR)   MOVE EXTENT TO THE       Y02080 06920002
         B     SORTLIST                    DADSM TABLE                  06940000
SUBEXCES EQU   *                        BRANCH LABEL             Y02080 06950002
         SR    REG7,REQ                 IF QUANTITY IS IN EXCESS Y02080 06960002
         LH    REG13,K2(PDLPTR)         THEN MUST ADJUST         Y02080 06980002
         SR    REG13,REG7               ENDING RTA + 1           Y02080 07000002
         AH    REG13,0(PDLPTR)                                   Y02080 07020002
         STH   REG13,K2(PDLPTR)         MOVE EXTENT USED INTO    Y02080 07040002
         MVC   0(K4,TBLPTR),0(PDLPTR)   THE DADSM TABLE          Y02080 07060002
SORTLIST EQU   *                        BRANCH LABEL             Y02080 07070002
         LA    PDLPTR,ENTRIES           PTR TO DADSMTBL ENTRIES  Y02080 07080002
         LA    RCTR,K1(RCTR)            INCREMENT COUNTER        Y02080 07100002
         STC   RCTR,ENTRYNUM            NUMBER OF EXTENTS        Y02080 07120002
         BCTR  RCTR,K0                  DECREMENT EXT COUNT      Y02080 07140002
         LR    REG7,RCTR                NUMBER OF SCANS NEEDED   Y02080 07160002
INNERLP  EQU   *                        BRANCH LABEL             Y02080 07170002
         LH    REG8,0(PDLPTR)           COMPARE BEGINNING RTA'S  Y02080 07180002
         CH    REG8,K4(PDLPTR)          OF THE TWO EXTENTS       Y02080 07200002
         BNH   INORDER                  BRANCH IF IN ORDER              07220000
         L     REG8,0(PDLPTR)           IF SECOND LARGER MUST    Y02080 07240002
         MVC   0(K4,PDLPTR),K4(PDLPTR)  EXCHANGE EXTENTS         Y02080 07260002
         ST    REG8,K4(PDLPTR)                                   Y02080 07280002
INORDER  EQU   *                        BRANCH LABEL             Y02080 07290002
         BCTR  RCTR,K0                  DECREMENT EXT COUNT      Y02080 07300002
         LTR   RCTR,RCTR                TEST FOR END OF SCAN     Y02080 07320002
         BZ    SCANEND                  BRANCH IF SCAN COMPLETE         07340000
         LA    PDLPTR,K4(PDLPTR)        IF NOT, INCR LOCATION    Y02080 07360002
         B     INNERLP                     INDICATOR AND CONTINUE       07380000
SCANEND  EQU   *                        BRANCH LABEL             Y02080 07390002
         BCTR  REG7,K0                  DECREMENT EXT COUNT      Y02080 07400002
         LTR   REG7,REG7                TEST FOR END OF SORT     Y02080 07420002
         BZ    BUILDONE                 BRANCH IF SORT COMPLETE         07440000
         LA    PDLPTR,ENTRIES           IF NOT AT END OF SORT,   Y02080 07460002
*                                       THEN RESET THE LOCATION  Y02080 07470002
         LR    RCTR,REG7                INDICATOR AND COUNTER    Y02080 07480002
         B     INNERLP                  RE-ENTER LOOP                   07500000
*                                                                       07520000
* THIS SECTION PREPARES TO BRANCH TO THE NEXT LOAD.                     07526002
*                                                                       07532021
BUILDONE EQU   *                        BRANCH LABEL                    07540002
         LA    REG6,BUILDLD             POINT TO ID OF IGG0553C  Y02080 07550002
         B     XCTLHERE                                                 07580000
*                                                                       07590021
* CONSTANTS                                                             07600021
*                                                                       07610021
*                                                                       07645021
* CHANNEL PROGRAM                                                       07650021
*                                                                       07655021
         DS    0F                                                       07660000
CHANPRO  EQU   *                                                        07680000
*CCW1                                                                   07700000
         DC    X'16'                    READ R0                         07720000
         DC    AL3(COUNT2-EXTNDWKA)     BUFFER ADDR              Y02080 07740002
         DC    X'7000'                                                  07760000
         DC    H'4'                                                     07780000
*CCW2                                                                   07800000
         DC    X'92'                    READ COUNT - CCHHR              07820000
         DC    AL3(0+COUNT2-EXTNDWKA)   BUFFER ADDR              Y02080 07840002
         DC    X'6000'                                                  07860000
         DC    H'5'                                                     07880000
*CCW3                                                                   07900000
         DC    X'A9'                    SEARCH KEY EQUAL                07920000
         DC    AL3(DXCCW4+4-DXLBL)      SEARCH ARG ADDR          Y02080 07940002
         DC    X'6000'                                                  07960000
         DC    H'4'                                                     07980000
*CCW4                                                                   08000000
         DC    X'08'                    TIC BACK TO READ                08020000
         DC    AL3(0+DXCCW2-DXLBL)      TIC ADDR                 Y02080 08040002
ZEROS    DC    F'0'                                                     08060000
*CCW5                                                                   08080000
         DC    X'06'                    READ DATA                       08100000
         DC    AL3(F5DSCB-EXTNDWKA)     BUFFER ADDR              Y02080 08120002
         DC    X'7000'                                                  08140000
         DC    H'8'                                                     08160000
*CCW6                                                                   08180000
         DC    X'31'                    SEARCH EQUAL I.D.               08200000
         DC    AL3(0+COUNT2-EXTNDWKA)   SEARCH ARG ADDR          Y02080 08220002
         DC    X'4000'                                                  08240000
         DC    H'5'                                                     08260000
*CCW7                                                                   08280000
         DC    X'08'                    TIC BACK TO SEARCH              08300000
         DC    AL3(0+DXCCW6-DXLBL)      TIC ADDR                 Y02080 08320002
         DC    F'0'                                                     08340000
*CCW8                                                                   08360000
         DC    X'0D'                    WRITE KEY AND DATA              08380000
         DC    AL3(0+F5DSCB-EXTNDWKA)   BUFFER ADDR              Y02080 08400002
         DC    X'4000'                                                  08420000
         DC    H'140'                                                   08440000
*CCW9                                                                   08460000
         DC    X'31'                    SEARCH EQUAL I.D.               08480000
         DC    AL3(DXDAADDR+3-DXLBL)    SEARCH ARG ADDR          Y02080 08500002
         DC    X'4000'                                                  08520000
         DC    H'5'                                                     08540000
*CCW10                                                                  08560000
         DC    X'08'                    TIC BACK TO SEARCH              08580000
         DC    AL3(0+DXCCW9-DXLBL)      TIC ADDR                 Y02080 08600002
         DC    F'0'                                                     08620000
*CCW11                                                                  08640000
         DC    X'0E'                    READ KEY AND DATA               08660000
         DC    AL3(0+F5DSCB-EXTNDWKA)   BUFFER ADDR              Y02080 08680002
         DC    H'0'                                                     08700000
         DC    H'140'                                                   08720000
*                                                                       08730021
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         08740002
*                                                                       08750021
         XCTLTABL ID=(BUILDLD,3C,LASTLOAD,3E),SVC=055,           Y02080X08760002
               LENGTH=,BRT=YES                                   Y02080 08770002
         EJECT                                                   Y02080 08780002
WORKAREA IECEXTWA EP,D1=(5)             EXTEND WORK AREA         Y02080 08790002
READIN   EQU   F5DSCB                   EQUATE FOR F5DSCB AREA   Y02080 08800002
         EJECT                                                   Y02080 08860002
EOVWKA   DSECT                                                   Y02080 08960002
         IECDSECT                                                       09000000
         EJECT                                                   Y02144 09100002
         ORG   DXLBL                                                    09300000
         IECSDSL1 (4)                                                   09320000
         EJECT                                                   Y02080 72650002
CVT      DSECT                          CVT DSECT                Y02080 72660002
         CVT                                                     Y02080 72670002
         END                                                            78640021
