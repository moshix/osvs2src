 TITLE 'IGG0553C - EXTEND - F1,F3 DSCB ROUTINE'                         00020000
IGG0553C CSECT                                                          00022021
*                                                                       00022402
*MODULE NAME = IGG0553C                                                 00022802
*                                                                       00023202
*DESCRIPTIVE NAME = EXTEND - F1, F3 DSCB ROUTINE                        00023602
*                                                                       00023702
*COPYRIGHT = NONE                                                       00023802
*                                                                       00023902
*CHANGE ACTIVITY = SEE BELOW                                            00025002
*                                                                       00027002
*          RELEASE 16 DELETIONS                                         00030502
*0095038400,038800-039200,045600                                  13559 00031602
*          RELEASE 17 DELETIONS                                         00032702
*1708000640,028600-028800,031400,032000,034800-035000.             UL17 00033802
*1708002800,005000-005200,017400-017600,047400-047600             19682 00034902
*          RELEASE 18 DELETIONS                                         00036002
*3478                                                             MCS   00037102
*3478018400,018800-019200,064600,065000                           22833 00038202
*          RELEASE 19 DELETIONS                                         00039302
*          RELEASE 20 DELETIONS                                         00040402
*1023015200,042200                                               M6099  00041502
*1023017300,037000-037200,051600-051800,058600,064800            S20016 00042602
*          RELEASE 21 DELETIONS                                         00044000
*1395001400-001800,002600-003800,005600-007200,008000-009000,    M0130  00044802
*1395009600-010000,017144-017152,017176,017200-017800,019000-    M0130  00045902
*1395019400,028000,030600,031200,031420,032000-032200,034940,    M0130  00047002
*1395043200,044600,046600-047000,056000,061000,062800,063200,    M0130  00048102
*1395070000-071000,071400-072000,072800-075400,076000-076400     M0130  00049202
*1395039800-042600                                               M0050  00050302
*1395010800-012400,025200,026200-027400,034660,034700,034740,    A40437 00051402
*1395034800,048800-050800,065600-065800,066600,078800            A40437 00052502
*1395056600,065450                                               M0184  00053602
*          RELEASE 22 DELETIONS                                         00054702
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00055802
*0000000030-000150,000520-000600,002200,002420,002580-002640,    Y02080 00056902
*0000003360-003999,004229,004800,005800,006200,007600,008600,    Y02080 00058002
*0000009200,009500-010396,012600-017000,017128-017484,018000-    Y02080 00059102
*0000018600,018900,020400-020800,020860,020900,021000,022600-    Y02080 00060202
*0000022800,023200-023800,024200-024800,025210-025240,025300,    Y02080 00061302
*0000028600-029200,029600-029800,030200-031100,031250,031270-    Y02080 00062402
*0000031280,031330-031340,031360-031420,031440-031800,032200-    Y02080 00063502
*0000034200,034600,034630,034660,034700-034880,034940,034980-    Y02080 00064602
*0000035000,035400,036800,036860-036920,037400-037800,038200-    Y02080 00065702
*0000038250,038400,038500-038562,038580-038586,042800-043200,    Y02080 00066802
*0000044600-044800,045200,045800,046200,047200-048600,052800-    Y02080 00067902
*0000052840,052920-053000,053600-053800,054200,056000,056400,    Y02080 00069002
*0000059200-059400,060400-062000,062280,062300,062600-063000,    Y02080 00070102
*0000065200-065400,065600,065800-072400,073600,076000-078400,    Y02080 00071202
*0000088600-298600                                               Y02080 00072302
*0000                                                            Y02082 00073402
*0000                                                            Y02144 00074502
*0000                                                            Y02083 00075602
*0000065450                                                      YM3995 00076402
*                                                                       00076702
*          VS2 RELEASE 03.0 DELETIONS/CHANGES                         * 00077102
*0000065450                                                     ZA00704 00077502
*          SU32 DELETIONS                                      @G32DSFS 00077632
*                                                              @G32DSMI 00077932
*                                                                     * 00078232
*STATUS CHANGE LEVEL 005                                                00078532
*                                                                       00078902
*FUNCTION/OPERATION: THIS MODULE CHECKS FOR NEW VOLUME OR LAST VOLUME * 00080000
*   EXTENSION. IF ON A NEW VOLUME A DSCB FORMAT 1 IS CREATED AND IF   * 00100000
*   NECESSARY A FORMAT 3. IF ON THE LAST VOLUME OF A DATA SET THE     * 00120000
*   FORMAT 1 AND FORMAT 3 ARE UPDATED. IF NO FORMAT 3 EXISTS BUT      * 00140021
*   ONE IS NEEDED, IT IS CREATED. IF THE OLD VOLUME WAS        @Z40RSGD 00160004
*   DEFINED TO RAC, THE NEW VOLUME IS DEFINED TO RAC AND THE   @Z40RSGD 00172004
*   RAC DEFINED BIT IS SET IN THE NEW FORMAT 1.                @Z40RSGD 00174004
*                                                                     * 00180021
*ENTRY POINT:                                                         * 00200000
*        IGG0553C - ENTRY IS MADE FROM IGG0553B VIA A BRANCH.         * 00220002
*                                                                     * 00240000
*INPUT:                                                               * 00246021
*   REGISTER 4 POINTS TO THE I/O SUPPORT WORK AREA WHICH CONTAINS THE * 00252021
*   FORMAT 4 DSCB.                                                    * 00258002
*   REGISTER 5 POINTS TO THE USER'S DEB.                              * 00260002
*   REGISTER 11 POINTS TO THE EXTEND WORK AREA, WHICH CONTAINS THE    * 00264002
*   DADSM EXTENT TABLE.                                               * 00268002
*   THE I/O SUPPORT WORK AREA IS LAID OUT AS FOLLOWS:                 * 00270021
*                                                                     * 00276021
*          BYTES          AREA                                        * 00282021
*         *******        ******                                       * 00288021
*          100            DSCB FIELD                                  * 00294021
*          176            JFCB                                        * 00300021
*            4            ECB                                         * 00306021
*           40            IOB                                         * 00312021
*           44            DEB                                         * 00318021
*            4            DCB                                         * 00324021
*           96            CCW'S                                       * 00330021
*                                                                     * 00405600
*OUTPUT:                                                              * 00411500
*   THE FORMAT 1 AND FORMAT 3 DSCB'S ARE CREATED OR UPDATED. THE      * 00417200
*   DADSM EXTENT TABLE IN THE EXTEND WORK AREA IS BUILT.              * 00422902
*                                                                     * 00428600
*EXTERNAL ROUTINES:                                                   * 00434300
*        EXCP(0) - READ OR WRITE DIRECT ACCESS DEVICE                 * 00440000
*        WAIT(1) - WAIT ON EVENT CONTROL BLOCK                        * 00460000
*        IECRES  - TRANSFER CONTROL TO OTHER LOADS                    * 00480002
*        STATUS  - SET STEP MUST COMPLETE IN THE TCB                  * 00500002
*                                                                     * 00540000
*EXITS:                                                               * 00560021
*   NORMAL - BRANCH TO IGG0553D                                       * 00580002
*                                                                     * 00600021
*   ERROR  - BRANCH TO IGG0553E WITH THE ENTRY CODE IN REGISTER 13    * 00620002
*   ERROR CONDITIONS ARE I/O ERROR AND TOO MANY EXTENTS (GREATER      * 00640021
*   THAN 16) FOR THIS VOLUME AND UNABLE TO RAC DEFINE A NEW    @Z40RSGD 00660004
*   VOLUME WHEN THE OLD VOLUME WAS RAC DEFINED.                @Z40RSGD 00720004
*                                                                     * 00740000
*ATTRIBUTES: REENTRANT                                                * 00760002
*                                                                     * 00780000
*OTHER MACROS USED:                                                   * 00800021
*   IECEXTWA - TO DEFINE THE EXTEND WORK AREA                         * 00810002
*   IECDSECT - TO DEFINE THE I/O SUPPORT WORK AREA                    * 00820021
*   IECSDSL1 - TO SYMBOLICALLY ADDRESS DSCB'S                         * 00840021
*   IECDSECS - TO EXPAND THE CVT, DSAB, IEZDEB, PSA, SCVT, TCB DSECTS * 00860002
*                                                                     * 00940000
*STORAGE: PROGRAM CODE CSECT - LESS THAN 2048 BYTES                   * 00960002
*         EXTEND WORK AREA - AS DEFINED IN THE IECEXTWA MACRO         * 00980002
*         RPS WORK AREA - AS DEFINED IN THE IECRPS MACRO              * 00990002
*         I/O SUPPORT WORK AREA                                       * 01000002
*                                                                       01040000
*                                                                       01060000
* REGISTER EQUATES                                                      01120021
*                                                                       01180021
REG0     EQU   0                        EQUATE FOR REGISTER 0    Y02080 01260002
REG1     EQU   1                        EQUATE FOR REGISTER 1    Y02080 01280002
REG2     EQU   2                        EQUATE FOR REGISTER 2    Y02080 01300002
RBASE    EQU   3                        BASE REGISTER            Y02080 01320002
RCORE    EQU   4                        EOV WORK AREA POINTER    Y02080 01340002
REG5     EQU   5                        EQUATE FOR REGISTER 5    Y02080 01380002
RDEB     EQU   5                        DEB POINTER              Y02080 01400002
ALTWKA   EQU   6                        ALTERNATE WKA POINTER    Y02080 01410002
REG6     EQU   6                        EQUATE FOR REGISTER 6    Y02080 01420002
REG7     EQU   7                        EQUATE FOR REGISTER 7    Y02080 01440002
REG8     EQU   8                        EQUATE FOR REGISTER 8    Y02080 01480002
RTNREG2  EQU   8                        RETURN REGISTER          Y02080 01500002
REG9     EQU   9                        EQUATE FOR REGISTER 9    Y02080 01540002
RA       EQU   10                       EQUATE FOR REGISTER 10   Y02080 01560002
EXWKA    EQU   11                       EXTEND WORK AREA POINTER Y02080 01580002
RC       EQU   12                       EQUATE FOR REGISTER 12   Y02080 01600002
RD       EQU   13                       EQUATE FOR REGISTER 13   Y02080 01620002
RTNREG   EQU   14                       RETURN REGISTER          Y02080 01660002
RF       EQU   15                       EQUATE FOR REGISTER 15   Y02080 01680002
RCVT     EQU   15                       CVT POINTER              Y02080 01700002
*                                                                       01701021
* OTHER EQUATES                                                         01702021
*                                                                       01703021
DS1CKDS  EQU   X'01'                    DSCB1 CHKPT D/S FLAG     Y02083 01703402
RDWOPSWD EQU   X'04'                    READ WITHOUT PASSWORD    M0130  01704021
NEWVOL   EQU   X'04'                    EXTEND ON NEW VOLUME     M0130  01705021
TWO      EQU   2                                                   UL17 01706000
ZERO     EQU   0                        CONSTANT OF 0            Y02080 01707002
K0       EQU   0                        CONSTANT OF 0            Y02080 01707402
K1       EQU   1                        CONSTANT OF 1            Y02080 01708002
STEPMC   EQU   1                        STATUS STEP MC INDICATOR Y02080 01709002
K3       EQU   3                        CONSTANT OF THREE        Y02080 01711002
FOUR     EQU   4                                                   UL17 01712000
K6       EQU   6                        CONSTANT OF SIX          Y02080 01713002
K12      EQU   12                       CONSTANT OF TWELVE       Y02080 01714002
K16      EQU   16                       CONSTANT OF SIXTEEN      Y02080 01715002
TRKALIGN EQU   X'01'                    EXTENT IS TRACK ALIGNED  Y02080 01716002
CYLALIGN EQU   X'81'                    EXTENT IS CYLINDER ALIGN Y02080 01717002
USRLABEL EQU   X'40'                    USER LABEL TRACK EXTENT  Y02080 01718002
RESBITS  EQU   X'13'                    JFCB DSORG RESERVE BITS  Y02080 01718402
DS1RACDF EQU   X'40'                    DS1DSIND-DATA SET IS   @Z40RSGD 01718804
*                                       RAC DEFINED            @Z40RSGD 01719204
RACERROR EQU   X'40'                    RAC ERROR              @Z40RSGD 01719604
*                                                                       01720002
         USING EOVWKA,RCORE             EOV W/A ADDRESSABILITY   Y02080 01725002
         USING EXTNDWKA,EXWKA           WORK AREA ADDRESSABILITY Y02080 01730002
         BALR  RBASE,K0                 CSECT ADDRESSABILITY     Y02080 01735002
         USING BEGIN,RBASE                                       Y02080 01740002
*                                                                       01745002
* IF THE TASK IS NOT ALREADY STEP MUST COMPLETE, THIS SECTION LINKS     01750002
* TO THE STATUS ROUTINE TO SET THE TASK STEP MUST COMPLETE.             01755002
*                                                                       01760002
BEGIN    EQU   *                        BRANCH LABEL             Y02080 01765002
         XC    F5DSCB,F5DSCB            CLEAR WORK AREA          Y02080 01770002
         XC    F3DSCB,F3DSCB            CLEAR WORK AREA          Y02080 01775002
         MVI   DXCCW5+4,X'30'          BREAK CHANNEL PGM AT CCW5  13559 01790016
         LA    RC,ENTRIES               PTR TO DADSMTBL ENTRIES  Y02080 01792002
         SR    RD,RD                                             Y02080 01794002
         IC    RD,ENTRYNUM              NO. OF DADSMTBL ENTRIES  Y02080 01796002
*                                                                       01798002
         STM   EXWKA,RTNREG,IECREGSV+K12  SAVE REGISTERS 11-14   Y02080 01800002
         LR    ALTWKA,EXWKA             SAVE WORK AREA ADDRESS   Y02080 01802002
         MODESET EXTKEY=ZERO            SWITCH TO KEY ZERO       Y02082X01804002
                                        BEFORE THE SETLOCK       Y02082 01806002
GETLOCK  SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02080X01808002
               RELATED=(LOCAL,IGG0553C(RLSELOCK))  OBTAIN LOCK   Y02080 01810002
         LM    EXWKA,RTNREG,IECREGSV+K12-EXTNDWKA(ALTWKA)        Y02080 01812002
*                                                                       01814002
         USING DEBBASIC,RDEB            DEB ADDRESSABILITY       Y02080 01816002
         L     REG1,DEBTCBAD            LOAD TCB ADDR FROM DEB   Y02080 01818002
         USING TCB,REG1                 TCB ADDRESSABILITY       Y02080 01820002
         TM    TCBFLGS2,TCBFJMC         TEST IF ALREADY SMC      Y02080 01822002
         BO    RLSELOCK                 BRANCH IF USER SMC       Y02080 01824002
         DROP  REG1                                              Y02080 01826002
*                                                                       01828002
         USING CVT,RCVT                 CVT ADDRESSABILITY       Y02080 01830002
         L     RCVT,CVTPTR              LOAD CVT ADDRESS         Y02080 01832002
         L     RCVT,CVTABEND            LOAD SECONDARY CVT PTR   Y02080 01834002
         USING SCVTSECT,RCVT            2NDRY CVT ADDRESSABILITY Y02080 01836002
         L     RCVT,SCVTSTAT            LOAD STATUS EP ADDRESS   Y02080 01838002
         LA    REG0,STEPMC              INDICATE STEP MC         Y02080 01840002
         XR    REG1,REG1                INDICATE STATUS SET      Y02080 01842002
*                                                                       01844002
         BALR  RTNREG,RCVT              LINK TO STATUS ROUTINE   Y02080 01846002
*                                                                       01848002
         OI    ETYPEFLG,RSMC            SET RESET SMC FLAG       Y02080 01850002
         OI    DSMADTB2,DSMSMCE         SET VTOC ENQ'ED SMC BIT  Y02144 01852002
*                                                                       01854002
RLSELOCK EQU   *                        BRANCH LABEL             Y02080 01856002
         STM   EXWKA,RTNREG,IECREGSV+K12  SAVE REGISTERS 11-14   Y02080 01858002
         LR    ALTWKA,EXWKA             SAVE WORK AREA ADDRESS   Y02080 01860002
         SETLOCK RELEASE,TYPE=LOCAL,                             Y02080X01862002
               RELATED=(LOCAL,IGG0553C(GETLOCK))  RELEASE LOCK   Y02080 01864002
         MODESET EXTKEY=DATAMGT         RETURN TO DATAMGT KEY    Y02082 01866002
         LM    EXWKA,RTNREG,IECREGSV+K12-EXTNDWKA(ALTWKA)        Y02080 01868002
*                                                                       01870002
         USING CVT,RCVT                 CVT ADDRESSABILITY       Y02080 01872002
         TM    DXEXTSW,NEWVOL           TEST IF NEW VOLUME       Y02080 01890002
         BO    BUILDF1                  BRANCH IF NEW VOLUME     M0130  01920021
*                                                                       01960000
* MODIFY IOB AND CCW'S FOR READ OF FORMAT 1 DSCB                        01980000
*                                                                       02000000
READF1   MVC   SEEK+3(5),COUNT          SET UP SEEK ADDRESS IN IOB      02020000
         BAL   RTNREG2,EXEC             GO FOR FORMAT 1 READ     Y02080 02040002
NOERROR  EQU   *                        BRANCH LABEL             Y02080 02050002
         SR    REG6,REG6                                         Y02080 02060002
         IC    REG6,DS1NOEPV            NUMBER OF EXTENTS        Y02080 02080002
         CLI   DS1EXT1,X'40'    IS 1ST XTENT UL EXTENT            22833 02082018
         BNE   NVL              NO                                22833 02084018
         LA    REG6,K1(REG6)            MAKE COUNT+1 FOR INTERNL Y02080 02086002
*                                       USE                       22833 02088018
         STC   REG6,DS1NOEPV                                     Y02080 02090002
NVL      EQU   *                                                  22833 02092018
         AR    REG6,RD                  ADD NUMBER OF EXTENTS IN Y02080 02100002
*                                       THE DADSM EXTENT TABLE   Y02080 02110002
*                                                                       02120000
* AFTER THE FORMAT 1 DSCB FOR THIS DATA SET IS READ IN THE NUMBER OF    02140000
* EXTENTS FOR THE EXISTING DATA SET PLUS THE NUMBER OF NEW EXTENTS IS   02160000
* COMPARED TO SIXTEEN. IF THE TOTAL IS GREATER THAN SIXTEEN A RETURN    02180000
* IS MADE TO EOV SINCE THERE CAN BE ONLY A MAXIMUM OF SIXTEEN EXTENTS   02200000
* FOR A DATA SET PER VOLUME.                                            02220000
*                                                                       02240000
         STC   REG6,ESWITCH             SAVE NUMBER OF EXTENTS   Y02080 02260002
         CLI   ESWITCH,K16              CHECK HOW MANY           Y02080 02280002
         BH    RETURN                   BR IF TO MANY EXTENTS           02300000
         IC    REG6,DS1NOEPV            NO. OF CURRENT EXTENTS   Y02080 02320002
         LR    REG5,REG6                EXTENT NUMBER OF THE     Y02080 02340002
*                                       FIRST NEW EXTENT         Y02080 02350002
         LA    RA,DS3EXTNT              START OF FIRST F3 EXTENT Y02080 02360002
         SH    REG6,THREE               SUBTRACT 3 IN CASE OF F3 Y02080 02380002
         BC    10,NOTF1                 BR IF NO MORE ROOM IN F1        02400000
         LR    REG6,REG5                RESTORE NO. OF EXTENTS   Y02080 02420002
         LA    RA,DS1EXT1               START OF FIRST F1 EXTENT Y02080 02440002
NOTF1    EQU   *                        BRANCH LABEL             Y02080 02450002
         MH    REG6,TEN                 TIMES EXTENT SIZE        Y02080 02460002
         AR    RA,REG6                  POINT TO 1ST FREE EXTENT Y02080 02480002
         CLI   DS1NOEPV,3               CHECK FOR EXISTING F3 DSCB      02500000
         BNH   CHKEXT                   BRANCH IF NO F3 EXISTS   A40437 02503021
*                                                                       02506021
* MODIFY IOB AND CCW'S TO READ THE EXISTING FORMAT 3 DSCB               02509021
*                                                                       02512021
         MVC   SEEK+3(5),DS1PTRDS       SET UP SEEK IN IOB       A40437 02515021
         MVC   COUNT2(5),DS1PTRDS                                A40437 02518021
         LA    REG8,IECSDSL3            POINT TO INPUT AREA      Y02080 02521002
         ST    REG8,DXCCW11                                      Y02080 02524002
         MVI   DXCCW11,X'0E'            INSERT READ OP CODE      A40437 02527021
         BAL   RTNREG2,EXEC             GO READ THE F3 DSCB      Y02080 02530002
         MVC   DXCCW11+1(3),DXCCW5+1    RESTORE F1 AREA ADDRESS  A40437 02533021
CHKEXT   CLI   DS1NOEPV,7               CHECK NO. OF EXTENTS            02540000
         BNL   STBUMP                   BR IF POINTER IS PAST FMTID FLD 02560000
         B     STARTIT                  CONVERT AND MOVE EXTENTS        02580000
*                                                                       02600000
* CONVERT AND MOVE EXTENTS TO FORMAT1 AND FORMAT3 DSCB AREAS.           02760000
* CHECK FOR EXISTANCE OF FORMAT 3 DSCB AND WRITE IT IF NECESSARY.       02780000
* ENTRY TO THIS ROUTINE IS AT STARTIT                                   02820000
*                                                                       02840000
STLOOP   EQU   *                        BRANCH LABEL             Y02080 02850002
         LA    RC,FOUR(RC)              POINT TO NEXT ENTRY      Y02080 02860002
STLOOP2  EQU   *                        BRANCH LABEL             Y02080 02870002
         LA    REG5,K1(REG5)            INCREMENT EXTENT NUMBER  Y02080 02880002
         LA    RA,L'DS1EXT1(RA)         INCREMENT EXTENT POINTER Y02080 02900002
         CH    REG5,THREE               CHECK NEW EXTENT SEQ NO. Y02080 02920002
         BNE   STCHKBMP                 BR IF NOT AT START OF F3 DSCB   02940000
         LA    RA,DS3EXTNT              SET TO START OF F3       Y02080 02960002
STCHKBMP EQU   *                        BRANCH LABEL             Y02080 02970002
         CH    REG5,SEVEN               CHECK NEW EXTENT SEQ NO. Y02080 02980002
         BNE   STARTIT                  BR IF NOT AT F3 FMTID FIELD     03000000
STBUMP   EQU   *                        BRANCH LABEL             Y02080 03010002
         LA    RA,K1(RA)                BUMP PAST FORMAT ID      Y02080 03020002
STARTIT  EQU   *                        BRANCH LABEL             Y02080 03030002
         STC   REG5,K1(RA)              EXTENT SEQ NO. IN DSCB   Y02080 03040002
         LH    REG0,0(RC)               GET LOW RTA              Y02080 03080002
         BAL   RTNREG2,RTACONVT         LINK TO CALL CONVERSION  Y02080 03100002
         MVC   TWO(FOUR,RA),DXCCW12+K3  MOVE IN LOW CCHH         Y02080 03110002
         TM    JFCDSORG,X'20'           IS IT CREATE DIRECT D.S.   UL17 03121000
         BC    1,NOUSERLB               YES,NO USER LABELS         UL17 03122000
         TM    JFCBLTYP,X'08'           USER LABEL REQUEST         UL17 03123000
         BZ    NOUSERLB                 BRANCH IF NO               UL17 03124000
         LTR   REG5,REG5                SEE IF USER LABEL EXTENT Y02080 03125002
         BP    NOUSERLB                 BRANCH IF NOT              UL17 03126000
         MVC   EPDLIST2(TWO),0(RC)      SAVE RTA                 Y02080 03127002
         LH    REG2,0(RC)               PICK UP RTA              Y02080 03128002
         TM    JFCBCTRI,X'C0'           IS THIS A CYLINDER REQUEST UL17 03129000
         BO    CYLREQ                   BRANCH IF YES              UL17 03130000
         TM    JFCBCTRI,X'41'           IS THIS RECORD ROUNDED     UL17 03131000
         BO    CYLREQ                   BR IF YES                  UL17 03132000
         LA    REG2,K1(REG2)            INCREMENT RTA            Y02080 03133002
         STH   REG2,0(RC)               STORE IN DADSM TABLE     Y02080 03134002
         B     UPCCHH                   MOVE CCHH TO DSCB          UL17 03135000
CYLREQ   AH    REG2,DS4DEVSZ+TWO        ADD TRKS/CYL TO RTA      Y02080 03136002
         STH   REG2,0(RC)               UPDATE RTA IN DADSMTBL   Y02080 03137002
         BCTR  REG2,K0                  DECREMENT FOR U.L. RTA   Y02080 03138002
         LR    REG0,REG2                SET UP RTA IN REGISTER   Y02080 03139002
         STH   REG2,EPDLIST2            UPDATE SAVED RTA         Y02080 03140002
         BAL   RTNREG2,RTACONVT         LINK TO CALL CONVERSION  Y02080 03141002
         MVC   TWO(FOUR,RA),DXCCW12+K3  USER LABEL LOW CCHH      Y02080 03142002
         B     UPCCHH                   GO TO MOVE CCHH TO DSCB    UL17 03143000
NOUSERLB EQU   *                        BRANCH LABEL             Y02080 03144002
         LH    REG0,TWO(RC)             PICK UP RTA+1            Y02080 03145002
         BCTR  REG0,K0                  DECREMENT FOR HIGH RTA   Y02080 03160002
         BAL   RTNREG2,RTACONVT         LINK TO CALL CONVERSION  Y02080 03180002
UPCCHH   EQU   *                                                 M0130  03200021
         MVC   K6(FOUR,RA),DXCCW12+K3   MOVE IN UPPER CCHH       Y02080 03220002
         MVI   0(RA),TRKALIGN           INDICATE NOT CYL ALIGNED Y02080 03240002
         LH    REG8,DS4DEVSZ+TWO        PICK UP TRACKS/CYLINDER  Y02080 03260002
         SR    REG6,REG6                                         Y02080 03280002
         LH    REG7,0(RC)               LOAD RTA                 Y02080 03300002
         DR    REG6,REG8                CHECK FOR CYLINDER ALIGN Y02080 03320002
         LTR   REG6,REG6                IF ZERO - ALIGNED        Y02080 03340002
         BP    NOTCYL                   BRANCH IF NOT ALIGNED    Y02080 03360002
         LH    REG7,TWO(RC)             LOAD RTA+1               Y02080 03380002
         DR    REG6,REG8                CHECK FOR CYLINDER ALIGN Y02080 03400002
         LTR   REG6,REG6                                         Y02080 03420002
         BP    NOTCYL                   BR IF NOT ALIGNED               03440000
         MVI   0(RA),CYLALIGN           INDICATE CYL ALIGNED     Y02080 03460002
NOTCYL   EQU   *                                                   UL17 03462000
         LA    REG1,NOUSER              SET UP BRANCH REGISTER   Y02080 03463002
         TM    JFCDSORG,X'20'           IS IT CREATE DIRECT D.S.   UL17 03464000
         BCR   1,REG1                   YES, THEN NO USER LABELS Y02080 03466002
         TM    JFCBLTYP,X'08'           TEST FOR USR LBL REQUEST   UL17 03468000
         BCR   8,REG1                   BRANCH IF NO             Y02080 03470002
         LTR   REG5,REG5                WAS IT USER LABEL EXTENT Y02080 03472002
         BCR   2,REG1                   BRANCH IF NO             Y02080 03474002
         MVI   0(RA),USRLABEL           MOVE IN USER LABEL TYPE  Y02080 03476002
         CLC   0(TWO,RC),TWO(RC)        WAS THIS U.L. ONLY       Y02080 03478002
         BCR   8,REG1                   BRANCH IF YES            Y02080 03480002
         LA    RD,K1(RD)                UPDATE NUMBER OF EXTENTS Y02080 03482002
         STC   RD,ESWITCH                                        Y02080 03484002
         BCT   RD,STLOOP2               GET NEXT EXTENT          Y02080 03486002
NOUSER   EQU   *                        BRANCH LABEL             Y02080 03487002
         BCT   RD,STLOOP                BR IF ANOTHER EXTENT     Y02080 03488002
         CLI   DS1EXT1,X'40'            IS THIS A USER LABEL EXTENTUL17 03490000
         BNE   PREPWRT                  BRANCH IF NO               UL17 03492000
         TM    DXEXTSW,NEWVOL           TEST IF NEW VOLUME       Y02080 03494002
         BZ    PREPWRT                  BRANCH IF NO               UL17 03496000
         MVC   ENTRIES(TWO),EPDLIST2    RESTORE USER LABEL RTA   Y02080 03498002
PREPWRT  EQU   *                        BRANCH LABEL             Y02080 03499002
         LA    REG6,DXCCW6                                       Y02080 03500002
         MVI   DXCCW11+4,X'10'          SET ON WRITE CHECK FLAG         03520000
         CLI   ESWITCH,K3               CHECK ACTUAL NBR EXTENTS Y02080 03540002
         BH    WROUTF3                  BR IF F3 DSCB TO BE WRITTEN     03560000
*                                                                       03580000
* SEARCH FOR SPACE IF NEEDED AND WRITE FORMAT 1                         03600000
*                                                                       03620000
WRITEF1  EQU   *                                                  13559 03640016
         MVC   DS1PTRDS(5),COUNT2       CHAIN ADDRESS OF F3             03660000
         MVC   DS1NOEPV,ESWITCH         SET TOTAL NBR OF EXTENTS Y02080 03680002
         LA    REG6,COUNT                                        Y02080 03686002
         ST    REG6,LITTLE1             GET IDAREA ADDRESS       Y02080 03692002
         NC    COUNT+1(4),COUNT+1       CHK FOR EXISTING FORMAT  S20016 03701020
*                                       1                        S20016 03710020
         BNZ   GOTIDF1                  BRANCH IF FORMAT 1       S20016 03719020
*                                       EXISTS                   S20016 03728020
         LH    REG6,UHOLECTR            UPDATE USED HOLE COUNTER Y02080 03740002
         LA    REG6,K1(REG6)                                     Y02080 03760002
         STH   REG6,UHOLECTR                                     Y02080 03780002
         MVC   COUNT(5),VTOCADR         START SEARCH AT VTOC ADDRESS    03800000
         LA    REG6,DXCCW1                                       Y02080 03820002
         ST    REG6,IOBSIOCC            START SEARCH AT CCW1     Y02080 03825002
         MVC   DXCCW2+1(3),LITTLE1+1   IDAREA ADDRESS             13559 03830016
         MVC   SEEK+3(4),COUNT         IOB SEEK ADDRESS           13559 03835016
         BAL   RTNREG2,EXEC             SEARCH FOR FORMAT 0      Y02080 03840002
GOTIDF1  EQU   *                                                  13559 03845016
         LA    REG6,DXCCW6              START WRITE AT CCW6      Y02080 03850002
         ST    REG6,IOBSIOCC            STORE ENTRY POINT        Y02080 03855002
         SR    REG6,REG6                                         Y02080 03855602
         IC    REG6,DS1NOEPV            OBTAIN EXTENT COUNT      Y02080 03856202
         CLI   DS1EXT1,X'40'       IS 1ST XTENT UL EXTENT         22833 03856818
         BNE   MVL2                NO                             22833 03857418
         BCTR  REG6,K0                  REDUCE EXTENT COUNT BY 1 Y02080 03858002
         STC   REG6,DS1NOEPV                                     Y02080 03858602
MVL2     EQU   *                                                  22833 03859218
         MVC   SEEK+3(4),COUNT          INSERT SEEK ADDRESS IN IOB      03860000
         MVC   DXCCW6+1(3),LITTLE1+1                                    03940000
         MVC   DXCCW9+1(3),LITTLE1+1                                    03960000
         BAL   RTNREG2,EXEC             GO TO WRITE FORMAT 1     Y02080 04280002
         CLC   DS4HPCHR,COUNT           TEST IF NEW HIWATER MARK Y02080 04300002
         BNL   MODIFYCP                 BRANCH IF NOT            Y02080 04310002
         MVC   DS4HPCHR,COUNT           MOVE IN NEW HIWATER MARK Y02080 04320002
*                                                                       04340000
* THIS SECTION MAKES CHANGES IN THE CHANNEL PROGRAM FOR THE DADSM       04360000
* UPDATE LOADS.CCW1 THRU CCW5 WILL BE USED TO SEARCH FOR A DSCB HOLE.   04380000
* CCW6 THRU CCW 11 ARE USED FOR WRITING FORMAT 5 AND FORMAT 4.          04400000
* CCW9 THRU CCW 11 ARE USED TO READ FORMAT5 AND FORMAT4                 04420000
*                                                                       04440000
MODIFYCP EQU   *                        BRANCH LABEL             Y02080 04450002
         LA    REG6,IDAREA              POINT TO IDAREA          Y02080 04460002
         ST    REG6,DXCCW1                                       Y02080 04480002
         MVI   DXCCW1,X'16'             RESTORE READ R0 COMMAND         04500000
         ST    REG6,DXCCW2              CHANGE PTR IN CCW2       Y02080 04520002
         MVI   DXCCW2,X'92'             RESTORE READ COUNT COMMAND      04540000
         ST    REG6,DXCCW6              CHANGE PTR IN CCW6       Y02080 04580002
         MVI   DXCCW6,X'31'             RESTORE SEARCH EQUAL COMMAND    04600000
         ST    REG6,DXCCW9              CHANGE PTR IN CCW6       Y02080 04620002
         MVI   DXCCW9,X'31'             RESTORE SEARCH EQUAL COMMAND    04640000
         LA    REG6,F5LOAD              POINT TO IGG0553D        Y02080 04650002
RETRNEX  EQU   *                        BRANCH LABEL             Y02080 04720002
         LA    REG2,ENTRIES             PTR TO DADSMTBL ENTRIES  Y02080 04750002
XCTLHERE EQU   *                        BRANCH LABEL             Y02080 04780002
         MVI   ESWITCH,ZERO             ZERO ESWITCH             Y02080 04800002
         IECRES LOAD,EXTPR=(EXWKA),MODID=(REG6),BRANCH=DIRECT    Y02080 04820002
*                                                                       05100000
* SEARCH FOR HOLE FOR FORMAT 3 AND WRITE IT OR JUST WRITE THE FORMAT 3  05120000
*                                                                       05140000
WROUTF3  EQU   *                                                 S20016 05150020
         NC    COUNT2+1(4),COUNT2+1     CHK FOR EXISTING FORMAT  S20016 05160020
*                                       3                        S20016 05170020
         BNZ   GOTIDF3                  BRANCH IF FORMAT 3       S20016 05180020
*                                       EXISTS                   S20016 05190020
         MVC   IECSDSL3(4),HEX3         4 HEX 03'S TO KEY               05200000
         MVI   DS3FMTID,X'F3'           FORMAT IDENTIFIER               05220000
         MVI   UHOLECTR+1,X'01'         UPDATE USED HOLE COUNTER        05240000
         MVC   COUNT2(5),VTOCADR        START SEARCH AT VTOC            05260000
         LA    REG6,DXCCW1                                       Y02080 05280002
         ST    REG6,IOBSIOCC            START SEARCH AT CCW1     Y02080 05284002
         MVC   SEEK+3(4),COUNT2        IOB SEEK ADDRESS           13559 05288016
         BAL   RTNREG2,EXEC             SEARCH FOR FORMAT 0      Y02080 05292002
         LA    REG6,DXCCW6              START WRITE AT CCW6      Y02080 05296002
GOTIDF3  EQU   *                        BRANCH LABEL             Y02080 05300002
         ST    REG6,IOBSIOCC            CHAN PROG START ADDRESS  Y02080 05310002
         MVC   SEEK+3(4),COUNT2        INSERT SEEK ADDR INTO IOB.       05320000
         MVC   DXCCW9+1(3),DXCCW2+1     POINTER TO COUNT2 FOR CCW       05340000
         LA    REG6,IECSDSL3            SET CCW TO FORMAT 3 ADDR Y02080 05360002
         ST    REG6,DXCCW8                                       Y02080 05380002
         MVI   DXCCW8,X'0D'             RESTORE COMMAND FOR WRITE       05400000
         BAL   RTNREG2,EXEC             GO TO WRITE FORMAT 3     Y02080 05420002
         MVC   DXCCW8+1(3),DXCCW5+1          RESTORE F1 ADDRESS.        05440000
         B     WRITEF1                                                  05460000
*                                                                       05480000
* BUILD A FORMAT 1 FROM THE JFCB FOR A NEW VOLUME                       05500000
*                                                                       05520000
BUILDF1  MVC   DS1DSNAM(44),JFCBDSNM    DATA SET NAME                   05540000
         MVI   DS1FMTID,X'F1'           FORMAT ID                       05560000
         MVC   DS1DSSN(6),JFCBVOLS      VOLUME SERIAL NUMBER            05580000
         MVC   DS1VOLSQ,DXVOLSEQ        MOVE IN NEW VOLUME SEQ   Y02080 05600002
*                                       NUMBER SET UP BY EOV     Y02080 05610002
         MVC   DS1CREDT(6),JFCBCRDT     CREATION AND EXPIRATION DATES   05620000
         STC   RD,ESWITCH               NBR OF DADSMTBL ENTRIES  Y02080 05640002
         MVC   DS1SYSCD(13),SYSCODE     MOVE IN SYSTEM CODE      M0184  05660021
         MVC   DS1DSORG(8),JFCDSORG     SET UP DATA SET ORGANIZATION    05680000
*                                       RECORD FORMAT                   05700000
*                                       OPTION CODE                     05720000
*                                       BLOCK LENGTH                    05740000
*                                       RECORD LENGTH                   05760000
         NI    DS1DSORG+K1,X'FF'-RESBITS CLEAR THE RESERVED BITS Y02082 05765002
         MVC   DS1KEYL(1),JFCKEYLE                                      05780000
         MVC   DS1RKP(2),JFCRKP         RELATIVE KEY POSITION           05800000
         MVC   DS1SCALO(4),JFCBCTRI     FLAG FIELD AND SECONDARY QTY    05820000
         MVC   DS1LSTAR(5),TTRLL                                        05840000
         L     RA,DXDSAB                FETCH DSAB ADDRESS       Y02083 05842002
         USING DSAB,RA                  DSAB ADDRESSABILITY      Y02083 05844002
         TM    DSABFLG4,DSABCKDS        IS THIS A CHKPT D/S      Y02083 05846002
         DROP  RA                                                Y02083 05848002
         BZ    NOCHKPT                  IF NOT, BRANCH           Y02083 05850002
         OI    DS1DSIND,DS1CKDS         SET CHKPT D/S FLAG       Y02083 05852002
NOCHKPT  EQU   *                        BRANCH LABEL             Y02083 05854002
         TM    JFCBIND2,JFCBSCTY        DOES JFCB SPEC SECURITY  S20016 05860020
         BZ    NOSECUR                  BR IF NOT SECURITY              05880000
         OI    DS1DSIND,X'10'           SET SECURITY INDICATOR IN F1    05900000
         TM    JFCBIND2,JFCBRWPW        DOES JFCB SPEC RWPW OPTN S20016 05905020
         BNO   NOSECUR                  BRANCH IF NO             S20016 05910020
         OI    DS1DSIND,RDWOPSWD        IND SECTY IS FOR WR ONLY S20016 05915020
NOSECUR  EQU   *                        BRANCH LABEL             Y02080 05920002
*   DEFINE NEW VOLUME TO ONLY IF OLD VOLUME WAS                @Z40RSGD 05922004
*   DEFINED.                                                   @Z40RSGD 05924004
         LR    RA,RDEB                  DEB PREFIX             @Z40RSGD 05926004
         SH    RA,LENDEBPX                                     @Z40RSGD 05928004
         USING DEBPREFX,RA                                     @Z40RSGD 05928404
         L     RA,DEBXTNP               DEB EXTENSION          @Z40RSGD 05928804
         USING DEBXTN,RA                                       @Z40RSGD 05929204
         TM    DEBXFLG1,DEBXDSSI        IS IT PROTECTED        @Z40RSGD 05929604
         BZ    RACDONE                  NO-NOT RAC DEFINED     @Z40RSGD 05929704
*   DEFINE NEW VOLUME                                          @Z40RSGD 05929804
         MVC   RACDEF(LRACDEF),MRACDEF  RACDEF PARM LIST       @Z40RSGD 05933204
         L     RF,DXUCBADR              UCB ADDRESSABILITY     @Z40RSGD 05933604
         RACDEF ENTITY=DS1DSNAM,                               @Z40RSGDX05935204
               VOLSER=UCBVOLI-UCB(RF),                         @Z40RSGDX05935604
               OLDVOL=DXOLDVOL,                                @G32DSMIX05936032
               MF=(E,RACDEF)                                   @ZR0RSGD 05936404
         LTR   RF,RF                    RACDEF SUCCESSFUL      @Z40RSGD 05936504
         BZ    RACDEFOK                 YES-CONTINUE           @Z40RSGD 05936604
         OI    DXEXTSW,RACERROR         NO-INDICATE ERROR      @Z40RSGD 05942404
         B     RETURN                   EXIT                   @Z40RSGD 05944404
RACDEFOK OI    DS1DSIND,DS1RACDF        INDICATE DATA SET IS   @Z40RSGD 05946404
*                                       DEFINED                @Z40RSGD 05946804
RACDONE  EQU   *                        PROCESSING DONE        @Z40RSGD 05947204
*                                       SUCCESSFULLY           @Z40RSGD 05947604
         SR    REG5,REG5                1ST SEQ NUMBER IS ZERO   Y02080 05948404
         LA    RA,DS1EXT1               SET UP DSCB 1 ADDRESS    Y02080 05954204
         B     STARTIT                                                  05960000
*                                                                       05980000
* THIS ROUTINE LINKS TO THE RESIDENT CONVERT ROUTINE-RTA/CCHH           06000000
*                                                                       06020000
RTACONVT EQU   *                        BRANCH LABEL             Y02080 06040002
         STM   REG9,RD,IECREGSV+K12     SAVE REGISTERS           Y02080 06050002
         SLL   REG0,16                  SHIFT RTA                Y02080 06060002
         LA    REG1,DXDEB               LOAD DEB ADDRESS         Y02080 06080002
         LA    REG2,DXCCW12             POINT TO RESULT AREA     Y02080 06100002
         L     RCVT,CVTPTR              LOAD CVT ADDRESS         Y02080 06120002
         L     RCVT,CVTPCNVT            LOAD CONVERT RTN ADDR    Y02080 06140002
         LR    ALTWKA,EXWKA             SAVE EXTEND WKA ADDRESS  Y02080 06150002
         BALR  RTNREG,RCVT              LINK TO CONVERSION RTN   Y02080 06160002
         LM    REG9,RD,IECREGSV+K12-EXTNDWKA(ALTWKA)             Y02080 06180002
         BR    RTNREG2                  RETURN                   Y02080 06200002
*                                                                       06220000
* THIS SECTION EXECUTES A CHANNEL PROGRAM.                              06221021
*                                                                       06222021
EXEC     EQU   *                                                 A40437 06223021
         MVI   DXECB,X'00'              CLEAR ECB                A40437 06224021
         EXCP  DXIOB                                             A40437 06225021
         WAIT  1,ECB=DXECB                                       A40437 06226021
         TM    DXECB,X'20'              TEST FOR I/O ERROR       A40437 06227021
         BCR   1,RTNREG2                RETURN IF NO ERROR       Y02080 06228002
*                                                                       06229021
* THIS SECTION BRANCHES TO THE LAST LOAD.                               06230002
*                                                                       06240000
RETURN   EQU   *                        BRANCH LABEL             Y02080 06250002
         SR    RD,RD                                             Y02080 06260002
         IC    RD,DXEXTSW               PICK UP CALLER CODE      Y02080 06280002
         LA    REG6,LASTLOAD            POINT TO IGG0553E        Y02080 06300002
         B     XCTLHERE                 GO XCTL                  M0130  06320021
*                                                                       06340000
* CONSTANTS                                                             06360000
*                                                                       06370021
LENDEBPX DC    AL2(DEBBASIC-DEBPREFX)   LENGTH OF DEB PREFX    @Z40RSGD 06372004
THREE    DC    H'3'                                                     06380000
SEVEN    DC    H'7'                                                     06400000
TEN      DC    H'10'                                                    06420000
HEX3     DC    X'03030303'                                              06440000
MRACDEF  RACDEF TYPE=ADDVOL,            RACDEF MASTER          @Z40RSGDX06490004
               DSTYPE=N,                PARAMETER LIST         @Z40RSGDX06540004
               MF=L                                            @Z40RSGD 06542004
LRACDEF  EQU   *-MRACDEF                LENGTH PARM LIST       @Z40RSGD 06544004
SYSCODE  DC    CL13'IBMOSVS2'           SYSTEM CODE             ZA00704 06545002
*                                                                       06550021
* TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                         06560002
*                                                                       06570021
         XCTLTABL ID=(F5LOAD,3D,LASTLOAD,3E),SVC=055,            Y02080X06580002
               LENGTH=,BRT=YES                                   Y02080 06590002
         SPACE 2                                                 Y02080 06600002
         IECDSECS CVT,DSAB,IEZDEB,PSA,SCVT,UCB,TCB,EXPAND=YES  @Z40RSGD 06680004
WORKAREA IECEXTWA EP,D1=(1),D2=(3),ADT=YES  EXTEND WORK AREA     Y02080 07020002
RACDEF   EQU   IECREGSV                 RACDEF PARM LIST       @Z40RSGD 07030004
COUNT    EQU   ECOUNT                   EQUATE FOR ECOUNT        Y02080 07060002
UHOLECTR EQU   EHOLECTR                 EQUATE FOR EHOLECTR      Y02080 07080002
VTOCADR  EQU   EVTOCADR                 EQUATE FOR EVTOCADR      Y02080 07100002
LITTLE1  EQU   EPDLIST1                 EQUATE FOR EPDLIST1      Y02080 07120002
IDAREA   EQU   EIDAREA                  EQUATE FOR EIDAREA       Y02080 07140002
TTRLL    EQU   ETTRLL                   EQUATE FOR ETTRLL        Y02080 07160002
         EJECT                                                   Y02080 07180002
EOVWKA   DSECT                          EOV WORK AREA            Y02080 07220002
         IECDSECT                                                       07260000
         EJECT                                                   Y02080 07360002
         ORG   DXLBL                                                    07560000
         IECSDSL1 (4)                                                   07580000
*                                                                       07840002
SEEK     EQU   DXDAADDR                                                 07860000
         END   IGG0553C                                          A40437 47860021
