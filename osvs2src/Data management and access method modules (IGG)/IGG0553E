 TITLE 'IGG0553E - EXTEND - DADSM UPDATE LOAD 2'                        00020000
IGG0553E CSECT                                                          00026021
*                                                                       00028002
*MODULE NAME = IGG0553E                                                 00030002
*                                                                       00030102
*DESCRIPTIVE NAME = EXTEND - DADSM UPDATE LOAD 2                        00030202
*                                                                       00030302
*COPYRIGHT = NONE                                                       00034102
*                                                                       00044102
*CHANGE ACTIVITY = SEE BELOW                                            00044502
*                                                                       00044702
*          VS1 RELEASE 01 DELETIONS/CHANGES                             00045202
*0000                                                            YM0924 00048402
*          VS1 RELEASE 02 DELETIONS/CHANGES                             00052202
*0000001785,031000                                               X02989 00056002
*3478                                                             MCS   00059802
*3478029400-030000                                                25999 00063602
*          RELEASE 19 DELETIONS                                         00067402
*2580014400-014600,020000,020400-021800,022400,024000-024200,    O19117 00071202
*2580040216-040400                                               O19117 00075002
*2580038600                                                      A30538 00078802
*2580035600,038400                                               A29269 00082602
*          RELEASE 20 DELETIONS                                         00086402
*0930026100-026300,026800                                        A35385 00090202
*0930                                                            M3294  00094002
*0930000260-000320                                               S20201 00097802
*          RELEASE 21 DELETIONS                                         00101602
*1193000230,000600-006200,009800,010200,010800-011000,011600,    M0130  00105402
*1193012200,012400,013000-013200,014000,015000-015200,015600,    M0130  00109202
*1193018800-019000,024800-025200,026800,027600,028020-028300,    M0130  00113002
*1193028800,032000,032400-032600,033850-033900,035260,035507-    M0130  00116802
*1193035521,036400,038300-039200,040200,040580,041000,041800,    M0130  00120602
*1193045800,047400-049400,051000,051200-053150                   M0130  00124402
*1193005400,012350,028200,034200,038400-039000                   S21040 00128202
*0000027830-027860,040408-040560                                 M2281  00132002
*0000026040,026200,026280                                        A51505 00135802
*          RELEASE 21.7 DELETIONS                                       00139602
*0000026760,034880-034920,035528-035591,038600,041000-041760    SA53147 00143402
*          RELEASE 22 DELETIONS                                         00147202
*          VS2 RELEASE 02 DELETIONS/CHANGES                             00151002
*0000000261,000409,001398-001441,001914-002000,002086,002774-    Y02080 00154802
*0000003330,003805,004065-004130,004455,004940-005471,005690,    Y02080 00158602
*0000005743,006195-006730,007600-007800,009200,011200-012000,    Y02080 00162402
*0000012280,012320-012348,012352-012360,012420,012460-012500,    Y02080 00166202
*0000013800-014000,014214,014260-014410,014500,014600,014620-    Y02080 00170002
*0000014650,015800,018800-019000,019400-020200,020500-020700,    Y02080 00173802
*0000021000-021100,022200-024000,025000,025630-025730,025750,    Y02080 00177602
*0000026000-026240,026680,026840,027000-027800,028120,028240,    Y02080 00181402
*0000028800,029600,030200-030920,030984,032000,032300-036000,    Y02080 00185202
*0000038700-039380,039384-039800,040208,040348,040408,040456,    Y02080 00189002
*0000040528,040576-040588,040800,041000-041760,042200-042400,    Y02080 00192802
*0000045800-046000,046400-047200,050400-053020,053400-053600     Y02080 00196602
*0000000030-000150,004721,005592,026200,026320                   Y02078 00200402
*0000                                                            Y02072 00204202
*0000                                                            Y02144 00208002
*0000026750                                                      YM1089 00211802
*0000012240-012250,026730-026760,040264                          YM3048 00212802
*0000006575-006706,015800,051400                                 XM2969 00214802
*0000029700,032000                                               YM3047 00215202
*0000025900,025940                                               YM3995 00215402
*0000026700,026810-026812,030620                                 YM3997 00215502
*                                                                       00215602
*STATUS CHANGE LEVEL 009                                                00219402
*                                                                     * 00223202
*FUNCTION/OPERATION:                                                  * 00227002
*   THIS MODULE WRITES THE UPDATED FORMAT 4 DSCB IF NECESSARY. IT     * 00230802
*   ALSO TESTS AN INDICATOR IN THE I/O SUPPORT WORK AREA TO DETERMINE * 00234602
*   IF A FORMAT 0 DSCB MUST BE WRITTEN OVER A FORMER FORMAT 5 DSCB.   * 00238402
*   IT THEN DEQ'S THE VTOC, FREES THE CORE GOTTEN FOR THE EXTEND WORK * 00242202
*   AREA, AND RETURNS TO THE CALLER.                                  * 00246002
*   IF AN I/O ERROR HAS OCCURRED IN AN EXTEND MODULE OR DURING VTOC   * 00249802
*   CONVERSION, THIS MODULE ISSUES MESSAGE IEC603I WITH CODE=0.       * 00253602
*                                                                     * 00257402
*ENTRY POINT:                                                         * 00261202
*   IGG0553E - ENTRY IS MADE UNDER NORMAL CONDITIONS FROM IGG0553D.   * 00265002
*   ENTRY IS ALSO MADE FROM ALL LOADS OF EXTEND WHEN AN ERROR OCCURS. * 00268802
*                                                                     * 00272602
*INPUT:                                                               * 00276402
*   REGISTER 4 POINTS TO THE I/O SUPPORT WORK AREA.                   * 00280202
*   REGISTER 11 POINTS TO THE EXTEND WORD AREA.                       * 00284002
*   REGISTER 13 IS NON-ZERO IF AN ERROR HAS OCCURRED.                 * 00287802
*   THE I/O SUPPORT WORK AREA IS LAID OUT AS FOLLOWS:                 * 00291602
*                                                                     * 00295402
*          BYTES          AREA                                        * 00299202
*         *******        ******                                       * 00303002
*          100            DSCB FIELD                                  * 00306802
*          176            JFCB                                        * 00310602
*            4            ECB                                         * 00314402
*           40            IOB                                         * 00318202
*           44            DEB                                         * 00322002
*            4            DCB                                         * 00325802
*           96            CCW'S                                       * 00329602
*                                                                     * 00333400
*OUTPUT:                                                              * 00337100
*   IF NECESSARY, THE UPDATED FORMAT 4 DSCB IS WRITTEN TO THE VTOC.   * 00338900
*   A FORMAT 0 DSCB MAY BE WRITTEN OVER A FORMER FORMAT 5 DSCB.       * 00340700
*                                                                     * 00341500
*EXTERNAL ROUTINES:                                                   * 00348000
*        EXCP(0) - READ OR WRITE ON A DIRECT ACCESS DEVICE            * 00354500
*        WAIT(1) - WAIT ON EVENT CONTROL BLOCK                        * 00361000
*        XCTL(7) - TRANSFER CONTROL TO ANOTHER MODULE                 * 00367500
*        DEQ(48) - DEQ THE VTOC                                       * 00374000
*        IECRES  - FREE CORE FOR THE EXTEND WORK AREA                 * 00380502
*        WTO(35) - WRITE MESSAGE TO OPERATOR                          * 00381502
*                                                                     * 00387000
*EXITS:                                                               * 00393500
*   TO EOV -                                                          * 00400000
*   NORMAL - BRANCH TO IFG0554P WITH ONE OF THE FOLLOWING             * 00406502
*            CODES IN REGISTER 13:                                    * 00419500
*            1 - SUCCESSFUL SECONDARY ALLOCATION ON THE CURRENT VOLUME* 00426000
*            4 - SUCCESSFUL SECONDARY ALLOCATION ON A NEW VOLUME      * 00432500
*                                                                     * 00439000
*   ERROR  - BRANCH TO IFG0554P WITH ONE OF THE FOLLOWING             * 00445502
*            ERROR CODES IN REGISTER 13:                              * 00452000
*           -1 - ERROR IN SECONDARY ALLOCATION ON THE CURRENT VOLUME  * 00458500
*           -4 - ERROR IN SECONDARY ALLOCATION ON THE NEW VOLUME      * 00465000
*           -8 - UNABLE TO CONVERT THE VTOC BECAUSE OF ONE OF THE     * 00467002
*                FOLLOWING ERRORS:                                    * 00469002
*              - OVERLAPPING EXTENTS IN THE VTOC                      * 00471002
*              - OVERLAPPING DOS SPLIT CYLINDER EXTENTS IN THE VTOC   * 00473002
*              - IGG0325Z ZAPPED TO PREVENT VTOC CONVERSION WHEN THE  * 00475002
*                DIRF BIT IS SET IN THE FORMAT 4 DSCB.                * 00477002
*              - DOS STACKED PACK FORMAT                              * 00478002
*          -16 - PERMANENT I/O ERROR                                  * 00480002
*                                                                     * 00482002
*   TO OS CVOL CATALOG -                                              * 00484002
*   NORMAL - XCTL TO IGC0002H WITH THE FOLLOWING CODE IN REGISTER 13: * 00486002
*            2 - SUCCESSFUL SECONDARY ALLOCATION OF THE OS CATALOG    * 00488002
*                ON THE CURRENT VOLUME                                * 00490002
*                                                                     * 00492002
*   ERROR  - XCTL TO IGC0002H WITH ONE OF THE FOLLOWING ERROR CODES   * 00494002
*            IN REGISTER 13:                                          * 00496002
*           -2 - ERROR IN SECONDARY ALLOCATION OF THE OS CATALOG      * 00498002
*           -8 - UNABLE TO CONVERT THE VTOC BECAUSE OF ONE OF THE     * 00500002
*                FOLLOWING ERRORS:                                    * 00502002
*              - OVERLAPPING EXTENTS IN THE VTOC                      * 00504002
*              - OVERLAPPING DOS SPLIT CYLINDER EXTENTS IN THE VTOC   * 00506002
*              - IGG0325Z ZAPPED TO PREVENT VTOC CONVERSION WHEN THE  * 00508002
*                DIRF BIT IS SET IN THE FORMAT 4 DSCB.                * 00510002
*              - DOS STACKED PACK FORMAT                              * 00512002
*          -16 - PERMANENT I/O ERROR                                  * 00514002
*                                                                     * 00516002
*   TO VSAM CATALOG - IN ALL CASES, REGISTER 1 CONTAINS ZERO TO  X02989 00554802
*            INDICATE A RECURSIVE CALL AND REGISTER 14 IS SET    X02989 00555202
*            TO ZERO TO REFLECT THAT THE RETURN IS FROM DADSM    X02989 00555602
*            EXTEND.                                             X02989 00556002
*   NORMAL - XCTL TO IGG0CLA1 WITH THE FOLLOWING CODE IN         XO2989 00556402
*            REGISTER 13:                                        X02989 00556802
*          129 - SUCCESSFUL SECONDARY ALLOCATION OF THE VSAM     X02989 00557602
*                DATA SPACE ON THE CURRENT VOLUME                X02989 00558002
*                                                                X02989 00558202
*   ERROR  - XCTL TO IGG0CLA1 WITH ONE OF THE FOLLOWING ERROR    X02989 00558402
*            CODES IN REGISTER 13:                               X02989 00559102
*           -8 - UNABLE TO CONVERT THE VTOC BECAUSE OF ONE OF THE     * 00559302
*                FOLLOWING ERRORS:                                    * 00559502
*              - OVERLAPPING EXTENTS IN THE VTOC                      * 00559702
*              - OVERLAPPING DOS SPLIT CYLINDER EXTENTS IN THE VTOC   * 00559902
*              - IGG0325Z ZAPPED TO PREVENT VTOC CONVERSION WHEN THE  * 00560102
*                DIRF BIT IS SET IN THE FORMAT 4 DSCB.                * 00560302
*              - DOS STACKED PACK FORMAT                              * 00560702
*          -12 - UNABLE TO RAC DEFINE NEW VOLUME FOR A RAC     @Z40RSGD 00561104
*                DEFINED DATA SET.                             @Z40RSGD 00561204
*          -16 - PERMANENT I/O ERROR                             X02989 00561502
*         -129 - ERROR IN SECONDARY ALLOCATION OF THE VSAM DATA  X02989 00564702
*                SPACE                                           X02989 00566302
*                                                                     * 00572702
*ATTRIBUTES: REENTRANT                                                * 00574302
*                                                                     * 00577502
*OTHER MACROS USED:                                                   * 00583502
*   CVT - TO REFERENCE THE CVT                                        * 00589502
*   UCB - TO REFERENCE THE UCB                                        * 00595502
*   IECDSECT - TO DEFINE THE I/O SUPPORT WORK AREA                    * 00601502
*   IECSDSL1 - TO SYMBOLICALLY ADDRESS DSCB'S                         * 00607502
*   IECEXTWA - TO DEFINE THE EXTEND WORK AREA                         * 00608502
*                                                                     * 00613502
*STORAGE: PROGRAM CODE CSECT - LESS THAN 1024 BYTES                   * 00655502
*         EXTEND WORK AREA - AS DEFINED IN THE IECEXTWA MACRO    XM2969 00657502
*         RPS WORK AREA - LENGTH IS DEFINED IN THE IECRPS MACRO  XM2969 00670602
*         I/O SUPPORT WORK AREA                                       * 00673002
*                                                                       00673300
*REGISTER USAGE                                                         00680000
R0       EQU   0                                                        00700000
R1       EQU   1                                                        00720000
R2       EQU   2                                                        00740000
RBASE    EQU   3                        BASE REGISTER            Y02080 00760002
RCORE    EQU   4                        EOV WKA ADDRESSABILITY   Y02080 00780002
R5       EQU   5                                                        00800000
R6       EQU   6                                                        00820000
R7       EQU   7                                                        00840000
R8       EQU   8                                                        00860000
R9       EQU   9                                                        00880000
RA       EQU   10                                                       00900000
EXWKA    EQU   11                       EXTEND WORK AREA ADDRESS Y02080 00920002
RC       EQU   12                                                       00940000
RD       EQU   13                                                       00960000
RE       EQU   14                                                       01000000
RF       EQU   15                                                       01040000
RWRK     EQU   15                                                       01060000
*                                                                       01205021
* OTHER EQUATES                                                         01210021
*                                                                       01215021
K2       EQU   2                        CONSTANT OF 2            Y02080 01217002
K4       EQU   4                        CONSTANT OF 4            XM2969 01217502
K7       EQU   7                        CONSTANT OF 7            XM2969 01218002
K96      EQU   96                       CONSTANT OF 96           Y02080 01219002
C4       EQU   4                        FOUR CHARACTERS          S20201 01222020
CA       EQU   120                      DISP TO AVT PTR IN W.A.  S20201 01226020
DW       EQU   8                        EIGHT BYTES              Y02080 01228002
DIRFBIT  EQU   X'04'                    VTOC INTERRUPT BIT       O19117 01230019
CATALOG  EQU   X'02'                    EXTENDING AN OS CATALOG  YM3047 01232002
VSAMID   EQU   X'81'                    VSAM CATALOG ID          X02989 01234902
WRZERO   EQU   X'80'                    WRITE FORMAT 0 DSCB      M0130  01238021
X08      EQU   X'08'                    CONSTANT OF X'08'        S21040 01244021
X10      EQU   X'10'                    I/O ERROR                S21040 01252021
X20      EQU   X'20'                    EOV I/O ERROR TEST       Y02078 01253002
UUU      EQU   37                       DISP. TO UUU IN MESSAGE  Y02078 01254002
VOLSER   EQU   41                       DISP. TO VOLSER IN MSG   Y02078 01255002
FRSTF5   EQU   X'08'                    IST F5 IN CORE SW        XM2969 01255502
ZEROFLAG EQU   X'00'                    ZERO FLAGS FOR READ      XM2969 01256002
RDCOUNT  EQU   X'8C'                    READ COUNT               XM2969 01256502
WRTCCW   EQU   X'0D'                    WRITE CCW CODE           XM2969 01257002
READCCW  EQU   X'0E'                    READ CCW CODE            XM2969 01257502
RACERROR EQU   X'40'                    RACDEF FAILED          @Z40RSGD 01259504
RACCODE  EQU   12                       RACDEF FAILED          @Z40RSGD 01259904
*                                                                       01260000
         BALR  RBASE,0                                                  01340000
         USING CHKIOERR,RBASE                                           01360000
         USING EOVWKA,RCORE             EOV W/A ADDRESSABILITY   Y02080 01380002
         USING EXTNDWKA,EXWKA           WORK AREA ADDRESSABILITY Y02080 01400002
         USING CVT,RF                   CVT BASE                        01420000
*                                                                       01420721
* THIS SECTION DETERMINES IF THE FORMAT 4 DSCB MUST BE REWRITTEN.       01421402
*                                                                       01422121
CHKIOERR EQU   *                                                 O19117 01423019
         XI    DS4VTOCI,DIRFBIT         SET/RESET DIRF BIT       Y02080 01426002
         LTR   RD,RD                    TEST FOR NORMAL ENTRY    O19117 01444019
         BZ    START                    IF NORMAL, BR            O19117 01447019
         TM    DS4VTOCI,DIRFBIT         TEST IF DIRF BIT WAS     Y02080 01450002
*                                       PREVIOUSLY SET           Y02080 01451002
         BO    EXITHERE                 IF YES, BR               O19117 01453019
         TM    ECB,X'20'                Q - I/O ERROR            O19117 01456019
         BZ    EXITHERE                 IF YES, BR               O19117 01459019
         TM    DXEXTSW,X10              TEST FOR I/O ERROR       Y02080 01460002
         BO    EXITHERE                 BRANCH IF I/O ERROR      M0130  01461021
         TM    DXEXTSW,X08              TEST IF VTOC COULD NOT   Y02078 01462002
*                                       BE CONVERTED             Y02078 01463002
         BO    EXITHERE                 YES, DO NOT REWRITE F4   Y02078 01464002
         B     WRITEF4                                           O19117 01468019
*                                                                       01480000
* THIS SECTION DETERMINES IF A FORMAT 0 DSCB MUST BE WRITTEN.           01500021
* IF SO, IT WRITES IT.                                                  01520021
*                                                                       01540000
START    EQU   *                                                 M0130  01550021
         TM    SWITCH,WRZERO            MUST AN F0 BE WRITTEN?   M0130  01560021
         BNZ   WRITEF0                  BRANCH IF F0 MUST BE     XM2969 01560502
*                                       WRITTEN                  XM2969 01561002
         TM    ESWITCH2,EF5ZERO         DOES F5 WITH ALL ZERO    XM2969 01561502
*                                       EXTENTS EXIST            XM2969 01562002
         BNO   WRITEF4                  BR TO CHECK F4 UPDATE IF XM2969 01562502
*                                       A F5 WITH ALL ZERO       XM2969 01563002
*                                       EXTENTS DOES NOT EXIST   XM2969 01563602
         TM    SWITCH,FRSTF5            IS FIRST F5 IN CORE      XM2969 01564502
*                                       INDICATOR SET            XM2969 01565002
         BO    WRITEF4                  BRANCH IF INDICATOR SET  XM2969 01565502
         MVI   CCW11+K4,ZEROFLAG        ZERO FLAGS ON READ CCW   XM2969 01566002
         MVI   CCW11+K7,RDCOUNT         INSURE CORRECT COUNT     XM2969 01566502
         MVC   IDAREA,EXTCCHHR          MOVE CCHHR OF PREV F5    XM2969 01567002
         LA    R0,CCW9                  START OF CHANNEL PGM     XM2969 01567502
         BAL   R7,CHANNLGO              BAL TO READ PREVIOUS F5  XM2969 01568002
         MVC   COUNT,DS5PTRDS           SAVE CHAIN ADDR TO WRITE XM2969 01568502
         XC    DS5PTRDS,DS5PTRDS        ZERO CHAIN POINTER       XM2969 01569002
         MVI   CCW11,WRTCCW             CHANGE READ CCW TO WRITE XM2969 01569502
         LA    R0,CCW9                  START OF CHANNEL PGM     XM2969 01570002
         BAL   R7,CHANNLGO              BAL TO WRITE F5          XM2969 01570502
         MVI   CCW11,READCCW            RESTORE READ CCW         XM2969 01571002
WRITEF0  EQU   *                        WRITE AN F0 DSCB         XM2969 01571502
         MVC   IDAREA(5),FIVESP   MOVE IN SAVED ADDRESS                 01600000
         LA    R0,CCW4+4                PICK UP ZERO FIELD ADDR.        01620000
         ST    R0,CCW8             STORE IN SEARCH ID EQ CCW.           01640000
         MVI   CCW8,X'0D'         RESTORE THE OP CODE.                  01660000
         MVI   CCW8+7,X'01'       INSERT COUNT FIELD                    01680000
         MVI   CCW8+4,X'60'                                             01700000
         MVI   CCW11+4,X'10'      TURN ON SKIP FLAG.                    01720000
         MVI   CCW11+7,X'8C'      INSURE CORRECT COUNT FOR WRITE CHECK. 01740000
         LA    R0,CCW6            START SEARCH AT CCW6                  01760000
         BAL   R7,CHANNLGO        EXECUTE CHANNEL PROGRAM               01780000
         LH    RWRK,UHOLECTR                                            01800000
         BCTR  RWRK,0                                                   01820000
         STH   RWRK,UHOLECTR      UPDATE USED HOLES COUNTER.            01840000
*                                                                       01860000
* THIS SECTION UPDATES THE FORMAT 4 DSCB AND WRITES IT BACK.            01880002
*                                                                       01920000
WRITEF4  EQU   *                                                 O19117 02030019
         LH    RWRK,DS4DSREC            LOAD NUMBER OF F0 DSCB'S Y02080 02031002
         SH    RWRK,UHOLECTR            SUBTRACT USED F0 DSCB'S  Y02080 02032002
         STH   RWRK,DS4DSREC            STORE NEW NUMBER OF F0'S Y02080 02033002
         LM    R5,RA,CHANPROG           FETCH CCW'S 1 THRU 3     O19117 02040019
         ALR   R5,EXWKA                 RESOLVE                  Y02080 02050002
         ALR   R7,RCORE                   CORE                   Y02080 02060002
         ALR   R9,RCORE                     ADDRESSES            Y02080 02070002
         STM   R5,RA,CCW1               STORE CCW'S 1 THRU 3     O19117 02080019
         LM    R7,RA,CHANPROG+24        FETCH CCW'S 5 THRU 6     O19117 02090019
         ALR   R7,RCORE                 RESOLVE CORE             Y02080 02100002
         ALR   R9,RCORE                   ADDRESSES              Y02080 02110002
         STM   R5,RA,CCW4               STORE CCW'S 4 THRU 6     O19117 02120019
         MVC   IDAREA(5),VTOCADR        SEARCH ADDRESS FOR IOB          02200000
         LA    R0,CCW1                  START AT CCW1            O19117 02410019
         BAL   R7,CHANNLGO              GO TO WRITE FORMAT 4            02440000
*                                                                       02460000
* THIS SECTION DEQ'S THE VTOC.                                          02500002
*                                                                       02540000
EXITHERE MVC   MAJOR(8),VTOCNAME                                        02560000
         L     R7,DXDEBUCB             R7 = POINTER TO UCB         AAAA 02561016
         USING UCBOB,R7                                            AAAA 02562016
NOSUB    MVC   MINOR(6),SRTEVOLI       SAVE VOLUME SERIAL NUMBER   AAAA 02574016
         MVI   ENQAREA,X'FF'                                            02580000
         SR    R1,R1                    ZERO REGISTER            Y02080 02582002
         STH   R1,ENQAREA+K2            CLEAR FOR DEQ MACRO      Y02080 02584002
         TM    ETYPEFLG,RSMC            LEAVE SMC FOR USER       Y02080 02586002
         BNO   DEQVTOC                  BRANCH IF YES            Y02080 02588002
         DEQ   (MAJOR,MINOR,6,SYSTEMS),RMC=STEP,MF=(E,ENQAREA)   YM3995 02590002
*                                                                       02592002
         NI    DSMADTB2,X'FF'-DSMSMCE-DSMVTOCR  RESET VTOC       YM3995X02593002
                                        ENQ'ED SMC SWITCHES      YM3995 02594002
         B     TSTIOERR                 GO TEST FOR I/O ERROR    YM3995 02595002
*                                                                       02596002
DEQVTOC  EQU   *                        DEQ THE VTOC NON-SMC     Y02080 02598002
         DEQ   (MAJOR,MINOR,6,SYSTEMS),MF=(E,ENQAREA)  DEQ VTOC  Y02080 02600002
*                                                                       02602002
         NI    DSMADTB2,X'FF'-DSMVTOCR  RESET VTOC ENQ'ED SWITCH Y02144 02604002
*                                                                       02606002
* IF AN I/O ERROR HAS OCCURRED, THIS SECTION ISSUES MESSAGE IEC603I.    02608002
*                                                                       02610002
TSTIOERR EQU   *                        TEST FOR I/O ERROR       Y02078 02612002
         TM    ECB,X20                  TEST FOR EOV I/O ERROR   Y02078 02614002
         BZ    BUILDMSG                 BRANCH IF EOV I/O ERROR  Y02078 02616002
         TM    DXEXTSW,X10              TEST IF ALLOCATE I/O ERR Y02078 02618002
         BNO   RESTRIOB                 BRANCH IF NO I/O ERROR   Y02078 02620002
BUILDMSG EQU   *                        BUILD THE MESSAGE        Y02078 02622002
         MVC   F5DSCB(MSGEND-ERRMSG),ERRMSG  MOVE IN MESSAGE     Y02078 02624002
         MVC   F5DSCB+UUU(L'UCBNAME),UCBNAME  MOVE IN EBCDIC UCB Y02078 02626002
*                                       CHANNEL/UNIT ADDRESS     Y02078 02628002
         MVC   F5DSCB+VOLSER(L'SRTEVOLI),SRTEVOLI  MOVE IN VOLID Y02078 02630002
         WTO   MF=(E,F5DSCB)            ISSUE ERROR MESSAGE      Y02078 02632002
*                                                                       02634002
RESTRIOB EQU   *                        RESTORE CCW ADDR IN IOB  Y02078 02636002
         LA    R7,DXCCW                                                 02640000
         ST    R7,IOBSTART-1      RESTORE START ADDRESS FOR EOV         02660000
*                                                                       02669002
* THIS SECTION RESTORES THE DEB AVT POINTER IF AN RPS WORK AREA EXISTS. 02670002
*                                                                       02672002
         TM    DSMADTB1,DSMRPSAP        TEST IF RPS APPENDAGE    YM3048X02673002
                                        WAS LOADED               YM3048 02674002
         BNO   CONTINUE                 BRANCH IF NOT            YM3048 02675002
         L     R1,DXDEBAPP              GET PTR TO RPS WORK AREA YM3048 02676002
         MVC   DXDEBAPP(C4),CA(R1)      RESTORE DEB AVT POINTER SA53147 02677002
         NI    DSMADTB1,X'FF'-DSMRPSAP  RESET RPS APP LOADED BIT Y02144 02681402
*                                                                       02682002
* THIS SECTION PREPARES TO BRANCH TO EOV BY LOADING THE ENTRY           02684002
* POINT ADDRESS.                                                        02688002
*                                                                       02692021
CONTINUE EQU   *                                                SA53147 02694002
         TM    DXEXTSW,CATALOG          TEST FOR CVOL CATALOG    YM3047 02696002
         BO    LOADCODE                 BRANCH IF YES            YM3047 02698002
         TM    DXEXTSW,VSAMID           TEST FOR ENTRY FROM VSAM Y02080 02700002
         BO    LOADCODE                 BRANCH IF YES            Y02080 02720002
         IECRES LOAD,EXTPR=(EXWKA),MODNM=EOVLOAD,BRANCH=NO       Y02080 02740002
         L     RE,WTGMODEP              LOAD ENTRY POINT ADDRESS Y02080 02760002
*                                                                       02789021
* THIS SECTION LOADS THE PROPER EOV RETURN CODE.                        02792021
*                                                                       02795021
LOADCODE EQU   *                        LOAD ERROR CODE          Y02080 02796002
         TM    ECB,X'20'                TEST FOR EOV I/O ERROR          02800000
         BZ    EOVIOERR                 BRANCH IF AN I/O ERROR   M0130  02806021
         TM    DXEXTSW,X10              TEST IF ALLOCATE I/O ERR Y02080 02812002
         BO    EOVIOERR                 BRANCH IF YES            M0130  02818021
         TM    DXEXTSW,X08              TEST IF UNABLE TO        Y02080 02824002
*                                       CONVERT THE VTOC         Y02080 02825002
         BO    DOSVTOC                  BRANCH IF YES            M0130  02830021
         TM    DXEXTSW,RACERROR         RACDEF FAIL ON EXTEND  @Z40RSGD 02832004
         BZ    NORACERR                 NO-CONTINUE            @Z40RSGD 02834004
         LA    RD,RACCODE               YES-MARK RAC ERROR     @Z40RSGD 02836004
NORACERR EQU   *                        CONTINUE               @Z40RSGD 02838004
         LTR   RD,RD                    TEST FOR NORMAL EXIT            02840000
         BP    SETNEG                   BR IF NOT TO SET NEGATIVE CODE  02860000
         IC    RD,DXEXTSW               INSERT ENTRY CODE        Y02080 02880002
         B     TESTRTRN                 TEST RETURN                     02900000
EOVIOERR EQU   *                                                 M0130  02903021
         LA    RD,X10                   LOAD I/O ERROR CODE      M0130  02906021
         B     SETNEG                   GO NEGATE REGISTER 13    M0130  02909021
DOSVTOC  EQU   *                                                 M0130  02912021
         LA    RD,X08                   UNCONVERTIBLE VTOC ERROR M0130  02915021
SETNEG   LNR   RD,RD                    SET NEGATIVE CODE               02920000
*                                                                       02940021
* THIS SECTION FREES THE EXTEND WORK AREA(S), RESTORES REGISTERS,       02960002
* AND XCTL'S TO VSAM CATALOG OR OS CVOL CATALOG OR BRANCHES TO EOV.     02970002
*                                                                       02980021
TESTRTRN EQU   *                        DETERMINE RETURN MODULE  Y02080 03020002
         LR    R8,RCORE                 SAVE EOV WORK AREA ADDR  Y02080 03030002
         STM   RBASE,RE,DXLBL           SAVE REGISTERS 3-14      Y02080 03040002
         IECRES FREE,PREFIX=FIRST,A=(EXWKA)  FREE EXTEND WKAS    Y02080 03050002
         LM    RBASE,RE,DXLBL-DXLBL(R8)  RESTORE REGISTERS 3-14  Y02080 03060002
*                                                                       03064002
         XC    FIELD1(DW),FIELD1        PREPARE TO XCTL          Y02080 03066002
         LA    RF,FIELD1+DW             POINT TO XCTL NAME       Y02080 03068002
         ST    RF,FIELD1                                         Y02080 03070002
         TM    DXEXTSW,CATALOG          TEST FOR ENTRY FROM OS   YM3047X03072002
                                        CVOL CATALOG             YM3047 03074002
         BNO   VSAMTEST                 BRANCH IF NOT            YM3047 03076002
         MVC   FIELD1+DW(X08),CVOLMOD   SET UP TO XCTL TO CVOL   YM3047 03078002
         B     NOTVSAM                  GO RESTORE REGISTERS     YM3047 03080002
VSAMTEST EQU   *                        TEST IF ENTRY FROM VSAM  YM3047 03082002
         TM    DXEXTSW,VSAMID           TEST IF ENTRY FROM VSAM  Y02080 03084002
         BNO   NOTVSAM                  BRANCH IF NOT VSAM       X02989 03094002
         MVC   FIELD1+X08(X08),VSAMMOD  SET UP TO XCTL TO VSAM   X02989 03096002
         SR    R1,R1                    INDICATE RECURSIVE CALL  X02989 03096402
         SR    RE,RE                    RETURN FROM DADSM EXTEND X02989 03096802
NOTVSAM  EQU   *                        BRANCH POINT IF NOT VSAM X02989 03098002
         L     RF,CVTPTR                CVT POINTER              X02989 03100002
         L     RF,CVTTCBP               TCB ADDRESS                     03120000
         L     RF,4(RF)                 POINTER TO SVRB ADDRESS         03140000
         L     RF,0(RF)                                                 03160000
         TM    DXEXTSW,VSAMID           TEST IF ENTRY FROM VSAM  Y02080 03164002
         BO    VSAMRTRN                 BRANCH IF FROM VSAM      Y02080 03168002
         TM    DXEXTSW,CATALOG          TEST FOR CVOL CATALOG    YM3047 03170002
         BO    VSAMRTRN                 BRANCH IF ENTRY FROM     YM3047X03172002
                                        OS CVOL CATALOG          YM3047 03174002
*                                                                       03176002
         LM    R2,RC,96(RF)             RESTORE  REGISTERS FOR EOV      03180000
         IECRES BRANCH,EPA=(RE)         RETURN TO EOV            Y02080 03190002
*                                                                       03194002
VSAMRTRN EQU   *                        XCTL TO VSAM OR CATALOG  YM3047 03200002
         LM    R2,RC,K96(RF)            RESTORE REGS FOR VSAM    Y02080 03210002
         XCTL  MF=(E,(1)),SF=(E,FIELD1)                                 03220000
*                                                                       03620000
* THIS ROUTINE EXECUTES A CHANNEL PROGRAM.                              03640021
*                                                                       03660000
CHANNLGO MVI   ECB,X'00'                                                03680000
         MVC   SEEK+3(4),IDAREA        INSERT SEEK ADDR INTO IOB.       03700000
         ST    R0,IOB+16                                                03720000
         EXCP  IOB                                                      03740000
         WAIT  ECB=ECB                                                  03760000
         TM    ECB,X'20'                TEST FOR I/O ERROR              03780000
         BCR   1,R7                     BR IF NO ERROR                  03800000
         B     EXITHERE                 GO TO EXIT ROUTINE              03820000
*                                                                       03830021
* CONSTANTS                                                             03840021
*                                                                       03850021
ERRMSG   WTO   'IEC603I VTOC ERRORS MAY EXIST ON UUU,VOLSER,0',  Y02078X03851002
               ROUTCDE=(4,10),DESC=4,MF=L                        Y02078 03852002
MSGEND   EQU   *                        MSG DELIMITER            Y02078 03853002
CVOLMOD  DC    CL8'IGC0002H'            CATALOG RETURN MOD NAME  YM3047 03855002
VSAMMOD  DC    CL8'IGG0CLA1'            VSAM RETURN MODULE NAME  X02989 03938102
VTOCNAME DC    C'SYSVTOC '                                              04000000
*                                                                       04027602
* CHANNEL PROGRAMS                                                      04028802
*                                                                       04030002
CHANPROG DS    0F                                                O19117 04031202
*CCW1 - SEARCH ID                                                       04032402
         DC    X'31'                                             O19117 04033602
         DC    AL3(IDAREA-EXTNDWKA)     SID ON F4 CCHHR          Y02080 04034802
         DC    X'4000'                                           O19117 04036002
         DC    H'5'                                              O19117 04037202
*CCW2 - TIC                                                             04038402
         DC    X'08'                                             O19117 04039602
         DC    AL3(DXCCW1-DXLBL)        TIC TO CCW1              Y02080 04040802
         DC    F'0'                                              O19117 04042002
*CCW3 - WRITE DATA                                                      04043202
         DC    X'05'                                             O19117 04044402
         DC    AL3(IECSDSF4-DXLBL)      WRITE FORMAT 4 DSCB      Y02080 04045602
         DC    X'4000'                                           O19117 04046802
         DC    H'96'                                             O19117 04048002
*CCW4 - SEARCH ID (WILL BE DUPLICATED FROM CCW1)                        04049202
*CCW5 - TIC                                                             04050402
         DC    X'08'                                             O19117 04051602
         DC    AL3(DXCCW4-DXLBL)        TIC BACK TO CCW4         Y02080 04052802
         DC    F'0'                                              O19117 04054002
*CCW6 - READ DATA                                                       04055202
         DC    X'06'                                             O19117 04056402
         DC    AL3(IECSDSF4-DXLBL)      WRITE CHECK CCW          Y02080 04057602
         DC    X'1000'                  SUPPRESS DATA TRANSFER   Y02080 04058002
         DC    H'96'                    WRITE LENGTH             Y02080 04058802
*                                                                       04060000
* TABLE OF MODULE NAMES AND ENTRY POINT ADDRESSES                       04080002
*                                                                       04090021
         XCTLTABL ID=(EOVLOAD,IFG0554P),SVC=055,LENGTH=,BRT=YES  Y02080 04100002
         EJECT                                                   Y02080 04120002
*                                                                       04184021
* I/O SUPPORT WORK AREA                                                 04192021
*                                                                       04200000
EOVWKA   DSECT                          EOV WORK AREA            Y02080 04220002
         IECDSECT                                                       04260000
         EJECT                                                   Y02144 04270002
CCW1     EQU   DXCCW1                                                   04280000
CCW2     EQU   DXCCW2                                                   04300000
CCW3     EQU   DXCCW3                                                   04320000
CCW4     EQU   DXCCW4                                                   04340000
CCW5     EQU   DXCCW5                                                   04360000
CCW6     EQU   DXCCW6                                                   04380000
CCW7     EQU   DXCCW7                                                   04400000
CCW8     EQU   DXCCW8                                                   04420000
CCW9     EQU   DXCCW9                                                   04440000
CCW10    EQU   DXCCW10                                                  04460000
CCW11    EQU   DXCCW11                                                  04480000
CCW12    EQU   DXCCW12                                                  04500000
*                                                                       04510021
         ORG   DXLBL                                                    04520000
         IECSDSL1 (4)                                                   04540000
*                                                                       04560000
SEEK     EQU   DXDAADDR                                                 04620000
ECB      EQU   DXECB                                                    04960000
DEB      EQU   DXDEB                                                    04980000
IOB      EQU   DXIOB                                                    05000000
DCB      EQU   DXDCB                                                    05020000
FIELD1   EQU   DXLBL                    XCTL PARAMETER LIST      Y02080 05040002
ENQAREA  EQU   DXLBL                    DEQ PARAMETER LIST       Y02080 05060002
MAJOR    EQU   ENQAREA+16               DEQ MAJOR NAME           Y02080 05080002
MINOR    EQU   ENQAREA+24               DEQ MINOR NAME           Y02080 05100002
         EJECT                                                   Y02080 05120002
WORKAREA IECEXTWA EP,D1=(5),ADT=YES     EXTEND WORK AREA         XM2969 05140002
SWITCH   EQU   ESWITCH                  EQUATE FOR ESWITCH       Y02080 05160002
COUNT    EQU   ECOUNT                   EQUATE FOR ECOUNT        Y02080 05180002
VTOCADR  EQU   EVTOCADR                 EQUATE FOR EVTOCADR      Y02080 05200002
IDAREA   EQU   EIDAREA                  EQUATE FOR EIDAREA       Y02080 05220002
UHOLECTR EQU   EHOLECTR                 EQUATE FOR EHOLECTR      Y02080 05240002
FIVESP   EQU   COUNT2                   EQUATE FOR COUNT2        Y02080 05260002
         EJECT                                                   Y02080 05280002
CVT      DSECT                                                          05320000
         CVT                            CVT DSECT                Y02080 05340002
         EJECT                                                   Y02080 05360002
UCB      DSECT                                                     AAAA 05366016
         IEFUCBOB                                                  AAAA 05372016
         END   IGG0553E                                                 05380000
