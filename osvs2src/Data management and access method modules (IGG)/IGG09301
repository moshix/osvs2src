         TITLE 'IGG09301 - SECOND LOAD OF TPUT'                         00100020
IGG09301 CSECT                                                          00150002
*                                                                     * 00200020
*   VS2 3.0 SU                                                          00200403
*0000227500,305886,305843                                      @ZA08262 00200503
*0000522354                                                    @ZA03182 00200603
*0000680520                                                    @ZA03945 00200703
*0000535010-535120                                             @ZA02244 00200803
*                                                                       00200903
*                                                                       00201003
*    RELEASE VS2-3.0 ACTIVITY                                         * 00201103
*D001760                                                        ZA02097 00201203
*C227500,238900                                                 ZA02097 00201303
*                                                                     * 00201603
*    RELEASE VS/2-2 ACTIVITY                                          * 00202002
*                                       02/19/73                VS00022 00202102
*                                       03/24/73                YM01564 00208202
*                                       05/30/73                YM01246 00210202
*                                       07/03/73                YM01114 00212202
*                                       07/16/73                YM01176 00214202
*                                       10/11/73                YM03998 00214302
*                                       11/15/73                YM05387 00214402
*                                       04/11/74                YM08378 00214502
*                                                                     * 00214602
*D500000                                                         YM3028 00220702
*D272800-294000,299700-300000                                    YM0895 00226802
*1301                                                            M0126  00232902
*                                                                S21A12 00239002
*1301182000-185000,193000-208000,227300-227600,229000,234000-    M0094  00245102
*1301235000,257000,271500-275000,293000,326000,335000,346750-    M0094  00251202
*1301346800,348600-349200,353000,378000-384000,418000,422000,    M0094  00257302
*1301449000,462000-462500,496000,500000,509000-512000,521000,    M0094  00263402
*1301529000,538000,544200-544300,545300-546300,548000,571000,    M0094  00269502
*1301577000-578000,581000,582000,587000,590000,605000,631000,    M0094  00275602
*1301674000,676300,722000                                        M0094  00281702
*1301349000,546000,706000-707000                                 S21008 00287802
*                                                                M2152  00293902
*0000455100-456000,547800                                        M0019  00300020
*0000158100,158700,382200                                        TS1635 00400020
*                                                                M0661  00500020
*                                                                M3391  00550020
*                                                                 M3807 00570020
*                                                                 M3830 00580020
*                                                                M4395  00590020
*                                                                 M5113 00592020
*                                                                 M4415 00595020
*0000530000                                                      M3830  00597020
*                                                                M6024  00598020
*1301722620                                                      S22028 00618002
*                                                                       00628003
* STATUS -                                                            * 00648003
*           VS2    3.0  SU                                     @ZA02244 00698003
*                                                                     * 00700020
* FUNCTION -                                                          * 00830020
*                                                                     * 00900020
*   PUT OUTPUT FROM USER'S BUFFER INTO TSO BUFFERS FOR LATER          * 01000020
*   TRANSFERENCE, VIA TCAM, TO A TERMINAL.                            * 01100020
*                                                                     * 01200020
*   PROVIDE LIMITED EDITING OPTIONS                                   * 01300020
*                                                                     * 01400020
*                                                                     * 01500020
* ENTRY POINTS -                                                      * 01600002
*                                                                     * 01700020
*   IGG09301 - ENTRY FROM FIRST LOAD OF TERMINAL I/O SVC              * 01800020
*              ROUTINES (IGC0009C) VIA BRANCH                         * 01900002
*                                                                     * 02000020
* INPUT -                                                             * 02100002
*                                                                     * 02200020
*********************************************************************** 02300020
***                                                                 *** 02400020
***                 REGISTER CONTENTS UPON ENTRY                    *** 02500020
***      3 - CVT POINTER      8 - ASCB POINTER                      *** 02540002
***      4 - TCB POINTER      9 - TSB POINTER       12 - TJID       *** 02800020
***      5 - SVRB POINTER    10 - TIOCRPT POINTER                   *** 02900020
***                                                                 *** 03000020
***                                                                 *** 03200020
*********************************************************************** 03300020
         SPACE 2                                                        03400020
* OUTPUT -                                                            * 04800002
*                                                                     * 04900020
*   RETURN CODE IN REG15                                              * 05000020
*              00 - SUCCESSFUL                                        * 05100020
*              04 - NOWAIT SPECIFIED AND NO BFRS AVAILABLE            * 05200020
*              08 - ATTN OCCURED DURING SVC EXECUTION                 * 05300020
*              10   INVALID PARAMETERS SPECIFIED                      * 05400020
*              14 - USER HAS HUNG UP                                    05500020
*                                                                     * 05600020
* EXTERNAL REFERENCES -                                                 05700020
*                                                                     * 05800020
*         OPTIMIZER (VIA SYSEVENT MACRO)                              * 05820002
*         SETLOCK                                                     * 05830002
*         POST (VIA BRANCH ENTRY AT CVTOPT01)                         * 05840002
*                                                                     * 06200020
* EXITS,NORMAL -                                                      * 06300020
*                                                                     * 06400020
*    BR 14, WITH RETURN CODES AS ABOVE                                * 06440002
*                                                                     * 06560020
* EXITS,ERROR -                                                       * 06620020
*                                                                     * 06700020
*   THERE ARE NO ERROR EXITS FROM THIS ROUTINE.                       * 06800020
*                                                                     * 06900020
* TABLES/WORKAREAS -                                                  * 07000020
*                                                                     * 07100020
*   ALL TABLES AND WORK AREAS ARE DESCRIBED BY                        * 07200000
*   DSECTS AT THE END OF THE LISTING .                                * 11100020
*                                                                     * 11200020
* ATTRIBUTES -                                                        * 11300002
*                                                                     * 11400020
*   REENTRANT, ENABLED, PRIVILEGED, LOCAL LOCK IS HELD AT ENTRANCE,   * 11500002
*   CMS LOCK IS OBTAINED EXPLICITLY, KEY ZERO.                        * 11550002
*                                                                     * 11600020
* CHARACTER CODE DEPENDENCY -                                         * 11700020
*                                                                     * 11800020
*    THE OPERATION OF THIS MODULE DEPENDS UPON THE FOLLOWING          * 11900003
*    PROPERTIES OF THE INTERNAL REPRESENTATION OF THE EXTERNAL        * 12000003
*    CHARACTER SET- BACKSPACE EQUAL TO X'16', BLANK EQUAL TO          * 12100003
*    X'40', NEW LINE EQUAL X'15'.                                     * 12200020
*    THE SPECIFIC INSTRUCTIONS WHICH REQUIRE MODIFICATION IF          * 12300003
*    THESE PROPERTIES OF THE CHARACTER SET ARE CHANGED MAY BE         * 12400003
*    IDENTIFIED BY - BLANK, BKSPCHR, AND NEWLINE, RESPECTIVELY.       * 12500020
*                                                                     * 12600020
* NOTES -                                                             * 12700020
*                                                                     * 12800020
*    NONE                                                             * 12900020
*                                                                     * 13000020
*********************************************************************** 13100020
         EJECT                                                          13200020
*********************************************************************** 13400020
*****                                                             ***** 13500020
*****               REGISTER EQUATES                              ***** 13600020
*****                                                             ***** 13700020
*********************************************************************** 13800020
         SPACE                                                          13900020
R0       EQU   0                        USED TO SPEED ASSEMBLY          14000020
RSAVE    EQU   0                        WORK REGISTER                   14100020
RWRK2    EQU   1                        WORK REGISTER                   14200020
RBUF     EQU   2                        POINTER TO TS BUFFER            14300020
RCVT     EQU   3                        POINTER TO CVT                  14400020
RTCB     EQU   4                        POINTER TO TCB                  14500020
RSVRB    EQU   5                        POINTER TO SVRB                 14600020
RBASE    EQU   6                        BASE REGISTER                   14700020
RTCX     EQU   7                        TCX POINTER             YS02019 14720002
RASCB    EQU   8                        ASCB POINTER            YS02019 14730002
RTSB     EQU   9                        POINTER TO TSB                  15000020
RRPT     EQU   10                       POINTER TO TIOCRPT              15100020
RECB     EQU   11                       ADDR OF ECB TO BE POSTED        15300020
RTJID    EQU   12                       TJID                            15400020
RAVT     EQU   13                       POINTER TO AVT                  15500020
RETURN   EQU   14                       RETURN ADDRESS                  15600020
RWRK     EQU   14                       WORK REGISTER                   15700020
RWRK1    EQU   15                       WORK REGISTER                   15800020
RCODE    EQU   15                       RETURN CODE                     15900020
RGO      EQU   15                       BRANCH ADDRESS                  16000020
         SPACE 2                                                        16100020
***                                                                     16200020
***                 CONSTANTS                                           16300020
***                                                                     16400020
K0       EQU   0                        OFFSET                          16500020
K1       EQU   1                        OFFSET AND SIZE                 16600020
K2       EQU   2                        OFFSET AND SIZE                 16700020
K3       EQU   3                        OFFSET AND SIZE                 16800020
K4       EQU   4                        OFFSET AND SIZE                 16900020
K5       EQU   5                        OFFSET                          17000020
K8       EQU   8                        OFFSET                          17100020
K16      EQU   16                       SHIFT CONSTANT                  17200020
SDTCB    EQU   15                       ENTRY CODE FOR STATUS   YS02019 17250002
***                                                                     17300020
***                 RETURN CODES                                        17400020
***                                                                     17500020
RC04     EQU   X'04'                    NOWAIT AND NO BUFFERS           17600020
RC08     EQU   X'08'                    ATTENTION HIT                   17700020
RC10     EQU   X'10'                    INVALID PARAMETER               17750002
RC14     EQU   X'14'                    DISCONNECTED                    17800020
***                                                                     17900020
***                 MASKS                                               18000020
***                                                                     18100020
NDISPBIT EQU   X'400'                   MASK FOR 'STATUS'       YS02019 18550002
ECBWAIT  EQU   X'80'                    ECB WAITING                     18600020
BYPASS   EQU   X'24'                    BYPASS CHAR            @ZA02244 18650003
OFF      EQU   X'FF'                    TO TURN OFF SELECTED BIT        18700020
ON       EQU  1                         FOR BCR INSTRUCTIONS    YS02019 18750002
***                                                                     18800020
***                 OTHER EQUATES                                       18900020
***                                                                     19000020
BKSPCHAR EQU   X'16'                    BACKSPACE CHARACTER             19100020
BLANK    EQU   X'40'                    BLANK CHARACTER                 19200020
RGOTO    EQU   15                       ENTRY POINT                     21100020
MOVECODE EQU   19                       QTIP ENTRY CODE FOR MOVE        21200020
SEVEN    EQU   7                        MASK USED IN STCM        Y01018 21210002
STEPSD   EQU   8                        ENTRY CODE FOR 'STATUS' YS02019 21230002
         EJECT                                                          21400020
*                                                                       21410002
*********************************************************************** 21450002
*                                                                       21452002
*        THIS MODULE IS BRANCH ENTERED FROM IGC0009C HOLDING THE        21460002
*        LOCAL LOCK                                                     21470002
*                                                                       21480002
*********************************************************************** 21490002
*                                                                       21492002
         BALR  RBASE,R0                 SET BASE REGISTER               21500020
         USING *,RBASE                  ADDRESSABILITY          YS02019 21600002
         SPACE 2                                                        21700020
         USING CVT,RCVT                                                 21800020
         USING TCB,RTCB                                                 21900020
         USING ASCB,RASCB                                       YS02019 21920002
         USING TSB,RTSB                                         YS02019 21930002
         USING TIOCRPT,RRPT                                     YS02019 21940002
         USING RBSECT,RSVRB                                      M0094  22350021
         SPACE 3                                                        22400020
***                                                                     22500020
***                INITIALIZE                                           22600020
***                                                                     22700020
         MVC   XSAF,XSAFLAG             INIT FLAGS               M0094  22730021
         B     TPT0050                  BRANCH AROUND ID         Y01018 22740000
         DC    C'IGG09301'              MODULE IDENTIFIER        Y01018 22745000
         DC    X'6007'                  DATE - 01/07/76        @ZA08262 22750003
TPT0050  EQU   *                                                 Y01018 22755000
         STH   RTJID,XSATJID            SAVE CALLER'S TJID       M0094  22760021
         SR    RBUF,RBUF                                                22800020
         LR    RCODE,RBUF               SET RETURN CODE TO ZERO         22850002
         CH    RBUF,XSAPRMSZ            IS USER SIZE ZERO        M0094  23050021
         BE    TPT9750                  RETURN TO CALLER                23300020
         STH   RBUF,XSAPRMTJ            ZERO DESTINATION TJID    M0094  23400021
*                                       SO GP DOESN'T SET BUFF-         23500021
*                                       TJID                            23600021
         SPACE 2                                                        23800020
         LH    RWRK1,XSAPRMSZ           GET USER SPECD SIZE      M0094  23850000
         L     RWRK,XSAPRM1             GET PTR TO USER AREA     M0094  23860000
         LA    RWRK,0(,RWRK)            CLEAR HI-ORDER BYTE      M0094  23870000
         OI    XSAF,XSADMOVE+XSAAUTH    SHOW DATA MOVEMENT,     YM05387 23872002
*                                       TELL GP NOT TO ADD '+'  YM05387 23874002
         TM    XSAOPTNS,MCNTRL+MASIS    OTHER THAN EDIT          M0094  23880000
         BNZ   TPT0390                  IF ASIS OR CONTROL      ZA02097 23890003
         SPACE 2                                                        23892000
***                                                                     23894000
***                 REMOVE TRAILING BLANKS                              23896000
***                                                                     23898000
         AR    RWRK,RWRK1               PTR TO END OF BFR + ONE         23898400
         SPACE                                                          23898800
TPT0300  EQU   *                                                        23899200
         BCTR  RWRK,R0                  ADJUST BUFFER POINTER           23899600
         CLI   K0(RWRK),BLANK           IS CHARACTER A BLANK            23899700
         BNE   TPT0350                  IF NON-BLANK                    23899800
         BCT   RWRK1,TPT0300            SUBTRACT 1 FROM BUFFER  YS02019 23899902
*                                       SIZE, BRANCH IF NOT 0   YS02019 23909902
         B     TPT7500                  SIZE IS NOW 0, MSG MUST YS02019 23919902
*                                       HAVE BEEN ALL BALNKS    YS02019 23929902
         SPACE 2                                                        23963200
TPT0350  EQU   *                                                        23965200
         STH   RWRK1,XSAPRMSZ           STORE UPDATED SIZE       M0094  23965600
         SPACE 2                                                 Y01018 23966000
TPT0390  EQU   *                                                 Y01018 23966400
         STH   RWRK1,XSAUBFRS           STORE STARTING SIZE      Y01018 23966500
         L     RWRK1,XSAPRM1            GET STARTING ADDRESS    YS02019 23966602
         ST    RWRK1,XSAUBFRP           STORE IT                YS02019 23976602
         SPACE 2                                                        23977700
***                                                                     24000020
***                 CHECK FOR OWAIT IN PROGRESS                         24100020
***                                                                     24200020
*                                       SERIALIZE TSB CHANGES   YS02019 24216002
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                   YS02019*24224002
               RELATED=(TSB,IGG09301(TPT9700))                  YS02019 24274002
         SPACE 1                                                YM01176 24324002
TPT0100  EQU   *                                                YM01176 24374002
         BAL   RBUF,TPT8400             GO CHECK TERMINAL STATUS        24600020
         TM    TSBFLG1,TSBOWIP          IS OWAIT IN PROGRESS            25000020
         BZ    TPT0200                  IF NOT                          25100020
         SPACE 2                                                        25200020
*****                                                                   25300020
*****               SET UP FOR OWAIT SUBROUTINE                         25400020
*****                                                                   25500020
TPT0150  EQU   *                                                        25600020
         TM    XSAOPTNS,MWAIT           WAS WAIT SPECIFIED (0)   M0094  25700021
         BO    TPT8000                  IF NOT                          25800020
         OI    TSBFLG1,TSBWOWIP         WAITING ON OWAIT INDR           25900020
         BAL   RBUF,TPT6000             GO TO OWAIT SUBROUTINE          26000020
         SPACE 2                                                        26100020
***                                                                     26200020
***                 UPON RETURN FROM OWAIT SUBROUTINE                   26300020
***                                                                     26400020
         SPACE                                                          26500020
         B     TPT0100                  CHECK AGAIN                     26600020
         SPACE 2                                                        26700020
TPT0200  EQU   *                                                        26800020
         NI    TSBFLG1,OFF-TSBWOWIP     TURN OFF WAITING ON             26900020
*                                       OWAIT IN PROGRESS               27000020
         OI    TSBFLG1,TSBOWIP          INDICATE OWAIT                  27100020
         ST    RTCB,TSBCTCB             STORE CURRENT TCB ADDRESS       27120020
         OI    XSAF,OSW                 INDICATE WE SET TSBOWIP  M0094  27200021
***                                                                     29500020
***                 CHECK FOR BFR ELIGIBILITY AND AVAIALABILITY         29600020
***                                                                     29700020
TPT0400  EQU   *                                                        29800020
         TM    TSBFLG4,TSBHUNG          IS TERMINAL DISC'TED    YM01176 29802002
         BO    TPT0470                  YES GO ENTER OWAIT      YM01176 29802802
         BAL   RBUF,TPT8400             GO CHECK TERMINAL STAT  YS02019 29804002
         CLC   TIOCFBFL+K1(K3),KZERO    ARE THERE ANY FREE BFRS SA60002 30184202
         BE    TPT0425                  IF NO FREE BFRS AVAIL   SA60002 30194202
         SPACE 3                                                SA60002 30350002
***                                                                     30400002
*** FOR FULL-SCREEN OPTION, ENTIRE MESSAGE MUST GO THROUGH, WITH        30450002
***  NO OWAIT.  THEREFORE, CALCULATE HOW MANY BUFFERS MESSAGE WILL      30460002
***  REQUIRE, AND WAIT UNTIL THAT MANY ARE AVAILABLE.                   30470002
***                                                                     30480002
         TM    XSAOPTNS,MASIS+MCNTRL    FULL SCREEN OPTION      SA60002 30482002
         BNO   TPT0423                  NO, BYPASS CALCULATION  SA60002 30484002
         SR    RWRK,RWRK                CLEAR FOR DIVIDE        SA60002 30490002
         LH    RWRK1,XSAPRMSZ           GET LENGTH OF MSG       SA60002 30492002
         LA    RWRK1,BUFFHDLN-BUFFTRLN(,RWRK1) ADD EXTRA FOR    SA60002 30494002
*                                              HEADER PREFIX    SA60002 30496002
         LA    R0,BUFFTRLN              GET LENGTH OF TRLR PRF  SA60002 30498002
         SH    R0,TIOCBFSZ              WHAT'S LEFT OVER (COMP) SA60002 30498402
         LPR   R0,R0                    GET BUFSIZE-TRLR PREF   SA60002 30498802
***                                                                     30499202
*** R0 = AMOUNT OF ROOM IN EACH BUFFER FOR REAL DATA                    30499602
*** R15 AND R15 = AMOUNT OF DATA THAT MUST GO INTO BUFFERS              30499702
***                                                                     30499802
         DR    RWRK,R0                  GET NO OF BFRS REQD     SA60002 30499902
         LA    RWRK1,1(,RWRK1)          ADD 1 FOR POSSIBLE      SA60002 30533202
*                                       REMAINDER               SA60002 30543202
         SPACE 3                                                        30553202
***                                                                     30563202
*** RWRK1 NOW CONTAINS NUMBER OF BFRS MSG WILL REQUIRE.                 30565202
*** MESSAGE CAN PROCEED IF                                              30565602
***     1.  RWRK1 LTE TIOCNFBF, AND                                     30566002
***     2.  RWRK1+TSBNOBF LTE TIOCAOMX                                  30566402
***                                                                     30566502
         CH    RWRK1,TIOCNBF            IS IT POSSIBLE          SA60002 30587702
         BH    TPT6800                  NO, INV. PARMS          SA60002 30588102
         LH    RWRK2,TIOCAOMX           GET AOMX                SA60002 30588202
         CR    RWRK1,RWRK2              WILL IT EVER BE POSS.   SA60002 30588302
         BH    TPT6800                  NO, INV. PARMS          SA60002 30588402
         CH    RWRK1,TIOCNFBF           ENOUGH FREE BFRS        SA60002 30588502
         BH    TPT0450                  NO, MUST WAIT          @ZA08262 30588603
         SR    R0,R0                    CLEAR                   SA60002 30593302
         IC    R0,TSBNOBF               CURRENT NO. OUTPUT BUFF SA60002 30593702
         AR    RWRK1,R0                 ADD TO NUMBER NEEDED    SA60002 30594102
         CR    RWRK1,RWRK2              CAN WE PROCEED          SA60002 30594202
         BH    TPT0450                  NO, GO WAIT OR RETURN  @ZA08262 30594303
         SPACE 3                                                        30594402
***                                                                     30615402
*** SEE WHETHER ANY TPUT CAN PROCEED                                    30625402
***                                                                     30635402
TPT0423  EQU   *                                                SA60002 30646702
         CLC   TIOCAOMX+K1(K1),TSBNOBF  IS NO. ALLOWED GREATER          30657802
*                                       THAN NO. ALREADY ON Q           30678902
         BNH   TPT0450                  IF MAXIMUM ALREADY USED         30700020
TPT0425  EQU   *                                                        30750020
         SR    RWRK,RWRK                                        YS02019 30800002
         CH    RWRK,TIOCNFBF            ANY FREE BUFFERS?       YS02019 30850002
         BNE   TPT0500                  IF FREE BFRS AVAILABLE          30900020
         CLI   TSBNOBF,K0               ANY ON OUTPUT QUEUE?    YS02019 31000002
         BNE   TPT0450                  IF ANY                          31100020
         SPACE 2                                                        31200020
***                                                                     31300020
***                 INDICATE OWAIT ENTERED DUE TO NO FREE TS            31400020
***                 BUFFERS AND NO BFRS ON OUTPUT QUEUE SO              31500020
***                 THAT A 'BFR FREEING TASK WILL REMOVE OWAIT          31600020
***                                                                     31700020
         SPACE                                                          31800020
         OI    TIOCFLG,TIOCNOBF         SYSTEM INDICATOR                31900020
         OI    TSBSTAT,TSBNOBUF         TASK INDICATOR                  32000020
         SPACE 2                                                        32100020
TPT0450  EQU   *                                                        32200020
***                                                                     32300020
***                 PREPARE TO GO TO OWAIT SUBROUTINE                   32400020
***                                                                     32500020
         TM    XSAF,PSW                 DOES TCAM NEED TO BE     M0094  32600021
*                                       POSTED - IS PART OF             32700020
*                                       THIS MSG ON THE QUEUE           32800020
         BZ    TPT0470                  IF NOT                          32900020
         SPACE 2                                                        33000020
***                                                                     33100020
***                 CHECK NEXT CHAR TO BE SENT FOR BACKSPACE            33200020
***                                                                     33300020
         SPACE 2                                                        33400020
         L     RWRK,XSAUBFRP            PTR TO NEXT CHARACTER    M0094  33440021
*   NOTE THAT, SINCE PSW IS ON, IEDAYGP (OUTPUT MOVE PORTION) HAS BEEN  33480021
*   ENTERED AT LEAST ONCE.  THEREFORE,XSAUBFRP WILL, BY THIS TIME,      33520021
*   POINT TO SOMEWHERE WITHIN THE USER'S BUFFER.                        33560021
         CLI   K0(RWRK),BKSPCHAR        IS NEXT CHAR A BACKSPACE        33600020
         BNE   TPT0460                  IF NOT                          33700020
         OI    TSBFLG3,TSBNBKSP         INDR TO OUTPUT EDIT SO          33800020
*                                       IT WON'T SEND CR AT END         33900020
         SPACE 2                                                        34000020
TPT0460  EQU   *                                                        34100020
***                                                             YS02019 34120002
***                 GO TO TPOST SUBROUTINE                      YS02019 34130002
***                                                             YS02019 34140002
         BAL   RBUF,TPT9900             GO TO TPOSTER           YS02019 34150002
         NI    XSAF,OFF-PSW             INDICATE TCAM POSTED     M0126  34960021
         B     TPT0490                  GO TO TSIP CALL                 35000020
         SPACE 2                                                        35100020
TPT0470  EQU   *                                                        35200020
         TM    XSAOPTNS,MWAIT           WAS WAIT SPECIFIED (0)   M0094  35300021
         BO    TPT8000                  IF NOT, GO TO NOWAIT RETURN     35400020
         SPACE 2                                                        35500020
TPT0490  EQU   *                                                        35600020
         OI    TSBFLG4,TSBOWAIT         INDICATE REAL OWAIT     YS02019 35640002
         BAL   RBUF,TPT6000             GO TO OWAIT SUBROUTINE          35800020
         SPACE 2                                                        35900020
         B     TPT0400                  RECHECK BFR ELEGIBILITY         36000020
         SPACE 2                                                        36100020
TPT0500  EQU   *                                                        36200020
*********************************************************************** 36300020
***                                                                 *** 36400020
***            AT THIS POINT IT HAS BEEN DETERMINED THAT            *** 36500020
***            THIS TASK IS ELIGIBLE FOR AT LEAST ONE TS            *** 36600020
***            BUFFER AND THERE IS ONE FREE. IT IS NOW              *** 36700020
***            COMMITED TO PLACING THE ENTIRE MESSAGE               *** 36800020
***            ONTO THE OUTPUT QUEUE.                               *** 36900020
***                                                                 *** 37000020
*********************************************************************** 37100020
         NI    XSAOPTNS,OFF-MWAIT       FORCE WAIT OPTION        M0094  38200021
         SPACE 2                                                        38500020
*********************************************************************** 38600020
***                                                                   * 38700020
***            QTIP WILL NOW BE CALLED TO DO THE FOLLOWING            * 38800020
***                                                                   * 38900020
***                 1- FIND THE PROPER PLACE ON THE OUTPUT            * 39000020
***                    QUEUE TO PUT THE NEXT BFR.                     * 39100020
***                                                                   * 39200020
***                 2- PLACE FIRST FREE BUFFER ONTO OUTPUT QUEUE.     * 39300020
***                                                                   * 39400020
***                 3- UPDATE PTRS & CNTS OF FREE AND OUTPUT QUEUES.  * 39500020
***                                                                   * 39600020
***                 4- MOVE EITHER ALL REMAINING DATA, OR AS MUCH AS  * 39700020
***                           BUFFER WILL HOLD WHICHEVER IS LESS.     * 39800020
***                                                                   * 39900020
***                 5- UPDATE USER BUFFER SIZE AND POINTER IN SVRB    * 40000020
***                    EXTENDED SAVE AREA (XSABSZ AND XSABPTR)        * 40100020
***                                                                   * 40200020
*********************************************************************** 40300020
         SPACE 2                                                        40400020
TPT1000  EQU   *                                                        40500020
***                                                                     40600020
***                 GO TO QTIP TO GET A TS BFR AND MOVE DATA            40700020
***                                                                     40800020
         LA    RSAVE,MOVECODE           ENTRY CODE                      40900020
         L     RGOTO,TIOCQTIP           QTIP BRANCH ADDRESS     YS02019 40940002
         LA    RAVT,TIOCSAVE            GET SAVE AREA FOR GP    YS02019 41170002
         BALR  RETURN,RGOTO             GO TO QTIP                      41200020
         SPACE 2                                                        41300020
***                                                                     41400020
***                 UPON RETURN FROM QTIP                               41500020
***                                                                     41600020
         NI    XSAF,OFF-XSADMOVE        DATA MOVEMENT DONE      YS02019 41750002
         OI    XSAF,HSW+PSW             TURN ON TO INDICATE      M0094  41800021
*                                       THAT NEXT BFR IS TO BE          41900020
*                                       A TRLR AND TCAM NEEDS           42000020
*                                       TO BE POSTED                    42100020
         CLC   XSAUBFRS,KZERO           HAS ALL OF DATA BEEN     M0094  42200021
*                                       MOVED INTO TS BUFFERS           42300020
         BE    TPT9000                  IF SO PREPARE TO RETURN         42400020
         TM    XSAOPTNS,MASIS+MCNTRL    FULL SCREEN OPTION      SA60002 42410002
         BO    TPT1000                  YES, BYPASS RECHECKING  SA60002 42420002
         B     TPT0400                  GO TO GET NEXT BUFFER           43200020
         EJECT                                                          43300020
TPT6000  EQU   *                                                        43400020
*********************************************************************** 43500020
*****                                                             ***** 43600020
*****               COMMON OWAIT SUBROUTINE                       ***** 43700020
*****                                                             ***** 43800020
*********************************************************************** 43900020
         SPACE                                                          44000020
***                                                             YS02019 44004002
***           INFORM SYSTEM RESOURCE MANAGER OF WAIT            YS02019 44006002
***                                                             YS02019 44008002
         LH    RWRK2,TIOCNFBF           NO, FREE BFRS FOR       YS02019 44010002
*                                       SRM STATISTICS          YS02019 44012002
         O     RWRK2,TSIPSIGN           SIGN BIT ON MEANS OWAIT YS02019 44014002
         LA    RAVT,TIOCSAVE            GET SYSEVENT SAVE AREA  YS02019 44014402
         SYSEVENT TERMWAIT,ASIDL=XSATJID,ENTRY=BRANCH           YS02019 44016002
         SPACE 2                                                YS02019 44018002
***                                                                     44020002
***                 FREE CMS LOCK AND SET UP RESUME ENVIRONMENT.        44022002
***                 'STATUS' WILL FREE LOCAL LOCK                       44024002
***                                                                     44026002
         SETLOCK RELEASE,TYPE=CMS,RELATED=(TSB,IGG09301(TPT0100))       44028002
         STM   R0,RGOTO,TCBGRS          SAVE REGISTERS IN TCB - YS02019 44030002
*                                       DISPATCHER WILL RESTORE YS02019 44032002
         LA    RGOTO,TPT6500            GET RESUME ADDRESS      YS02019 44038002
         ST    RGOTO,RBOPSW+K4          STORE RESUME ADDRESS    YS02019 44040002
         SPACE 2                                                YS02019 44042002
***                                                             YS02019 44044002
***                 BRANCH TO 'STATUS' ROUTINE TO SET UP WAIT.  YS02019 44046002
***                 DISPATCHER WILL RETURN CONTROL TO TPT6500,  YS02019 44048002
***                 AFTER WHOEVER REMOVES OWAIT GOES TO         YS02019 44050002
***                 STATUS TO MAKE THIS TASK DISPATCHABLE.      YS02019 44052002
***                                                             YS02019 44054002
         L     RGOTO,CVTABEND           SECONDARY CVT POINTER   YS02019 44058002
         USING SCVTSECT,RGOTO                                   YS02019 44060002
         LA    R0,SDTCB                 SET ENTRY CODE          YS02019 44060102
         LA    RAVT,NDISPBIT            GET NONDISP MASK IN R13 YS02019 44060402
         L     RGOTO,SCVTSTAT           STATUS BRANCH ENTRY ADR YS02019 44062002
         DROP  RGOTO                                            YS02019 44064002
         LA    RWRK2,0(,RTCB)           TCB PTR FOR STATUS      YS02019 44064402
         BALR  RETURN,RGOTO             GO TO STATUS ROUTINE    YS02019 44066002
         SPACE 2                                                        47100020
TPT6500  EQU   *                                                        47200020
***                                                                     47300020
***                 UPON RETURN FROM OWAIT                              47400020
***                                                                     47500020
         SPACE 2                                                        47600020
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                 YS02019*47620002
               RELATED=(TSB,IGG09301(TPT9800))                  YS02019 47622002
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                   YS02019*47630002
               RELATED=(TSB,IGG09301(TPT9700))                  YS02019 47680002
         LH    RTJID,XSATJID            SETLOCK BLASTS RTJID    YS02019 47730002
         BR    RBUF                     RETURN TO MAINLINE              48500020
         EJECT                                                          48600020
***                                                                     48650002
***                    INVALID PARAMETER RETURN                         48660002
***                                                                     48670002
TPT6800  EQU   *                                                 Y06327 48680002
         LA    RCODE,RC10               SET INVALID RETURN CODE  YM0895 48690002
         B     TPT7250                  GO TO ERROR ROUTINE      YM0895 48692002
         SPACE 3                                                SA60002 48694402
TPT7000  EQU   *                                                        48700020
***                                                                     48800020
***                 ATTENTION RETURN                                    49000020
***                                                                     49200020
         LA    RCODE,RC08               SET RETURN CODE                 49400020
         SPACE 2                                                        49560000
TPT7250  EQU   *                                                 YM0895 49570000
***                                                                     49580000
***            COMMON ERROR RETURN                                      49590000
***                                                                     49592000
         STH   RCODE,XSARC              SAVE RETURN CODE        YS02019 49594402
         TM    XSAF,OSW                 DID THIS TPUT REALLY DO  M0094  49596000
*                                       ANYTHING                        49600021
         BZ    TPT9700                  NO, JUST RETURN                 49800020
         B     TPT9300                  REMOVE WAITS IF POSSIBLE        50200020
         SPACE 3                                                YS02019 50250002
TPT7500  EQU   *                                                        50400020
***                                                                     50500020
***                 NO DATA - JUST SEND NEW LINE CHARACTER              50600020
***                                                                     50700020
         LA    RWRK1,NEWLINE            POINT TO NL CHAR                50800020
         STCM  RWRK1,SEVEN,XSAPRM1+K1   STORE NEW BFR POINTER    Y01018 50840002
         OI    XSAOPTNS,MASIS           FORCE ASIS OPTION        M0094  51200021
         LA    RWRK1,K1                 INDICATE LENGTH OF 1            51300020
         B     TPT0350                  RETURN                          51400020
         SPACE 4                                                        51500020
TPT8000  EQU   *                                                        51600020
***                                                                     51700020
***                 NOWAIT RETURN                                       51800020
***                                                                     51900020
         LA    RCODE,RC04               NOWAIT RETURN CODE              52000020
         STH   RCODE,XSARC              SAVE RETURN CODE       YS02019  52100002
         B     TPT9600                  GO TO EXIT                      52200002
         SPACE                                                          52207020
TPT8400  EQU   *                                                        52214020
***                                                                     52221020
***                 SUBROUTINE TO CHECK TERMINAL STATUS                 52228020
***                                                                     52235020
         TM    TSBFLG4,TSBHUNG          ID USER HUNG           @ZA03182 52235403
         BO    TPT8500                  YES, ABORT THIS TPUT    YS02019 52235802
         L     RRPT,CVTAQAVT            GET TCX POINTER         YS02019 52245002
         LTR   RRPT,RRPT                IS TCAM UP              YM01564 52247002
         BNM   TPT8500                  NO, ABORT THIS TPUT     YM01564 52249402
         USING IEDQTCX,RRPT                                     YS02019 52249802
         L     RRPT,TCXRPT              GET RPT PTR FOR TEST    YM01564 52250202
         DROP  RRPT                     DROP TCX BASE           YM01564 52250602
         LTR   RRPT,RRPT                IS TS STILL UP          YM01564 52250702
         BZ    TPT8500                  NO, ABORT THIS TPUT     YM01564 52250802
         USING TIOCRPT,RRPT             RPT ADDRESSABLE         YM01564 52250902
         TM    TCBTSFLG,TCBTIOTG        HAS ATTENTION BEEN HIT          52251002
         BO    TPT7000                  YES, GO TO ATTN RETURN          52255002
         TM    TSBFLG3,TSBATTN          HAS ATTEN BEEN HIT, IGNORED     52271002
         BO    TPT7000                  YES, GO TO ATTN RETURN          52275002
         BR    RBUF                     ALL IS WELL, RETURN     YM01564 52291002
         SPACE 2                                                        52300020
TPT8500  EQU   *                                                        52400020
***                                                                     52500020
***                 USER HUNG UP RETURN                                 52600020
***                                                                     52700020
         LA    RCODE,RC14                                               52800020
         STH   RCODE,XSARC              SAVE RETURN CODE        YS02019 52900002
         B     TPT7250                  GO TO RETURN            YS02019 53000002
         EJECT                                                          53100020
TPT9000  EQU   *                                                        53200020
***                                                                     53300020
***                 RETURN TO USER ROUTINE                              53400020
***                                                                     53500020
*   TEST TO SEE IF LINE SHOULD BE MARKED FOR NO                @ZA02244 53507003
*   FLASHBACK                                                  @ZA02244 53514003
         TM    TSBSTAT,TSBDSPLY         DISPLAY SCREEN         @ZA02244 53521003
         BNO   NTDPSC                   NO                     @ZA02244 53528003
         NI    TSBFLG3,OFF-TSBNFLOP     TURN OFF FLAG          @ZA02244 53535003
         L     RWRK,XSAUBFRP            POINT TO BUFFER        @ZA02244 53542003
         BCTR  RWRK,R0                  DECEM BY 1             @ZA02244 53549003
         TM    0(RWRK),BYPASS           BYPASS CHAR            @ZA02244 53556003
         BNO   NTDPSC                   NO                     @ZA02244 53563003
         OI    TSBFLG3,TSBNFLOP         TURN ON BIT            @ZA02244 53570003
*                                                              @ZA02244 53577003
NTDPSC   EQU   *                                               @ZA02244 53584003
         SPACE                                                          53600020
         SR    RCODE,RCODE              SUCCESSFUL RETURN CODE          53700020
         STH   RCODE,XSARC              SAVE RETURN CODE        YS02019 53800002
         SPACE 2                                                        53900020
***                                                             YS02019 53920002
***                 GO TO SUBROUTINE TO TPOST TSB               YS02019 53930002
***                                                             YS02019 53940002
         BAL   RBUF,TPT9900             GO DO TPOST             YS02019 53950002
         SPACE 2                                                        54700020
***                                                                     54900020
***                 CHECK IF SMF IS UP                                  55000020
***                                                                     55100020
         L     RWRK,TCBTCT              TCT POINTER                     55200020
         LA    RWRK,K0(R0,RWRK)         CLEAR FIRST BYTE                55300020
         LTR   RWRK,RWRK                IS SMF UP                       55400020
         BZ    TPT9200                  IF NOT                          55500020
         SPACE 2                                                        55600020
***                                                                     55700020
***                 UPDATE LINE COUNT IF UP                             55800020
***                                                                     55900020
         USING SMFTCT,RWRK                                              56000020
         L     RWRK2,TCTLOUT            OLD COUNT                       56100020
         LA    RWRK2,K1(R0,RWRK2)       ADD ONE TO COUNT                56200020
         ST    RWRK2,TCTLOUT                                            56300020
         DROP  RWRK                                                     56400020
         SPACE 2                                                        56500020
TPT9200  EQU   *                                                        56600020
         SPACE 2                                                        56700020
***                                                                     56800020
***                 ENTER OWAIT FOR HOLD MESSAGE                        56900020
***                                                                     57000020
         TM    XSAOPTNS,MHOLD           DID USER SPECIFY HOLD    M0094  57100021
         BZ    TPT9250                  IF NOT                          57200020
         OI    TSBFLG4,TSBOWAIT+TSBHOLD INDICATE OWAIT          YS02019 57320002
         BAL   RBUF,TPT6000             GO TO OWAIT SUBROUTINE          57900020
*                   AFTER MESSAGE HAS BEEN PRINTED                      58000020
         BAL   RBUF,TPT8400             GO CHECK TERMINAL STATUS        58150020
         LH    RCODE,XSARC              RESTORE RETURN CODE     YS02019 58220002
TPT9250  EQU   *                                                        58300020
***                                                             YS02019 58304002
***        INFORM SYSTEM RESOURCE MANAGER OF SUCCESSFUL TPUT    YS02019 58306002
***                                                             YS02019 58308002
         LH    RWRK2,XSAPRMSZ           AMMOUNT OF DATA MOVED   YS02019 58310002
         O     RWRK2,TSIPSIGN           SIGN MEANS TPUT         YS02019 58312002
         LA    RAVT,TIOCSAVE            GET SYSEVENT SAVE AREA  YS02019 58312402
         SYSEVENT TGETTPUT,ASIDL=XSATJID,ENTRY=BRANCH           YS02019 58314002
         SPACE 2                                                YS02019 58316002
***                                                             YS02019 58318002
***                 POST TSBECB IF AN ASID TPUT IS WAITING      YS02019 58320002
***                                                             YS02019 58322002
TPT9300  EQU   *                                                YS02019 58324002
         TM    TSBFLG3,TSBAWOIP         ANYBODY WAITING         YS02019 58326002
         BNO   TPT9400                  NO, FORGET IT           YS02019 58328002
         NI    TSBFLG3,OFF-TSBAWOIP     SET WAIT INDICATOR OFF  YS02019 58328402
         SPACE 2                                                YS02019 58330002
***                                                             YS02019 58332002
***                 CROSS-MEMORY POST THE TSBECB                YS02019 58334002
***                                                             YS02019 58336002
         LA    RECB,TSBECB              ECB ADDRESS             YS02019 58340002
         LA    RTJID,CVTBRET            ERRET = NOP (BR 14)     YS02019 58342002
         LH    RAVT,TSBWTJID            ASID OF WAITING TASK    YS02019 58344002
         BCTR  RAVT,R0                  DECREMENT ASID BY 1     YS02019 58344402
         SLL   RAVT,K2                  ASID * 4                YS02019 58344802
         L     RRPT,CVTASVT             GET ASVT ADDR           YS02019 58345202
         DROP  RRPT                     NO LONGER HAS RPT ADDR  YS02019 58345302
         L     RAVT,ASVTENTY-ASVT(RAVT,RRPT) GET ASCB ADDR      YS02019 58345602
         SR    RRPT,RRPT                ZERO COMPLETION CODE    YS02019 58345702
         L     RGOTO,CVT0PT01           ENTRY POINT OF POST     YS02019 58346002
         O     RECB,TSIPSIGN            HI-ORDER BIT SIGNIFIES  YS02019 58348002
*                                       CORSS-MEMORY POST       YS02019 58350002
         SPACE 2                                                YS02019 58352002
***                                                             YS02019 58354002
***                 REGISTERS FOR POST -                        YS02019 58356002
***                                                             YS02019 58358002
***            10 (RRPT) = COMPLETION CODE                      YS02019 58360002
***            11 (RECB) = ECB ADDRESS, HI-ORDER BIT ON         YS02019 58362002
***            12 (RTJID) = 'ERRET' ADDRESS                     YS02019 58364002
***            13 (RAVT) = ASCB ADDRESS OF POSTED MEMORY        YS02019 58366002
***            14 (RETURN) = RETURN ADDRESS                     YS02019 58368002
***            15 (RGOTO) = ENTRY POINT OF POST                 YS02019 58370002
***                                                             YS02019 58372002
         BALR  RETURN,RGOTO             GO TO POST ROUTINE      YS02019 58374002
         SPACE 2                                                        63200020
TPT9400  EQU   *                                                        63300020
***                                                                     63400020
***                 CHECK FOR WAITING ON OWAIT TASKS                    63500020
***                                                                     63600020
         TM    TSBFLG1,TSBWOWIP         ANY TASKS WAITING               63700020
         BZ    TPT9600                  IF NOT                          63800020
         SPACE 2                                                        63900020
***                                                             YS02019 63906002
***                 GO TO STATUS TO RESET ALL TASKS THAT MIGHT  YS02019 63909002
***                 HAVE BEEN WAITING FOR THE TSB               YS02019 63912002
***                                                             YS02019 63915002
***                 REGISTERS FOR 'STATUS' -                    YS02019 63918002
***                                                             YS02019 63921002
***            0 (R0) - HIGH-ORDER = ASID, LOW = ENTRY CODE (8) YS02019 63924002
***            1 (RWRK2) - HIGH-ORDER BIT ON, REST = 0          YS02019 63927002
***            13 (RAVT) - MASK OF SECONDARY BITS TO BE RESET   YS02019 63930002
***            14,15 (RETURN,RGOTO) - CONVENTIONAL              YS02019 63933002
***                                                             YS02019 63936002
         LA    R0,STEPSD                ENTRY CODE TO RESET ALL YS02019 63939002
*                                       TASKS IN STEP           YS02019 63942002
         L     RWRK2,TSIPSIGN           MEANS 'RESET', NO TCB   YS02019 63945002
*                                       POINTER MEANS ALL STEP  YS02019 63948002
         ICM   R0,B'1100',XSATJID       ASID OF CALLER          YS02019 63951002
         L     RGOTO,CVTABEND           PTR TO 2NDARY CVT       YS02019 63954002
         LA    RAVT,NDISPBIT            USE SAME MASK AS BEFORE YS02019 63957002
         USING SCVTSECT,RGOTO                                   YS02019 63960002
         L     RGOTO,SCVTSTAT           ENTRYPOINT OF STATUS    YS02019 63963002
         DROP  RGOTO                                            YS02019 63966002
         BALR  RETURN,RGOTO             GO TO STATUS ROUTINE    YS02019 63969002
TPT9600  EQU   *                                                        66600020
         NI    TSBFLG1,OFF-(TSBOWIP+TSBWOWIP)                           66700020
*                                       OTHER TPUTS CAN NOW PROCEED     66800002
         SPACE 2                                                        66900020
TPT9700  EQU   *                                                        67000020
***                                                                     67100020
***                 TURN OFF TCB ATTN INDR AND RETURN                   67200020
***                                                                     67300020
         LH    RCODE,XSARC              RESTORE RETURN CODE     YS02019 67400002
         NI    TCBTSFLG,OFF-TCBTIOTG    ATTN HIT INDR                   67500020
         NI    TSBFLG3,OFF-TSBATTN      TURN OFF ATTN HIT INDR          67600020
*                                       ALL DONE WITH CMS LOCK  YS02019 67602002
         SETLOCK RELEASE,TYPE=CMS,RELATED=(TSB,IGG09301(TPT0100))       67603002
         SPACE 1                                                        67605020
TPT9750  EQU   *                                                        67610020
***                                                                     67615020
***                TURN OFF TCBFX IF OFF AT ENTRY                       67620020
***                                                                     67625020
         TM    XSAF,XSATCBFX            SHOULD WE TURN OFF TCBFX M0094  67635002
         BZ    TPT9800                  IF NOT,SKIP                     67660020
         NI    TCBFLGS1,OFF-TCBFX       ALLOW ASYNCHRONOUS EXITS        67700020
TPT9800  EQU   *                                                        67750020
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SVC SLIH')        YS02019 67760002
         L     RETURN,XSARETRG          GET SUPERVISOR RET ADDR YS02019 67766002
         BR    RETURN                   RETURN                  YS02019 67774002
         EJECT                                                          67900020
*********************************************************************** 67902002
***                                                                 *** 67903002
***                 SUBROUTINE TO TPOST TSB TO IEDAYP               *** 67904002
***                                                                 *** 67905002
*********************************************************************** 67906002
TPT9900  EQU   *                                                YS02019 67907002
         LM    R0,RWRK2,TSBTPOST        GET TPOSTING FIELD      YS02019 67914002
         ST    RBUF,XSAWD7              SAVE REGISTER 2         YM03998 67914402
TPT9907  EQU   *                                                        67915002
         STM   R0,RWRK2,XSAWD5          MOVE TO XSA TO SET BITS YS02019 67916002
         LA    RGO,XSAWD5               ADDRESSABILITY          YS02019 67917002
         USING TSBTPOST,RGO             NEXT REFERENCES TO TSB  YS02019 67918002
*                                       TPOST & BEYOND WILL     YS02019 67919002
*                                       REALLY BE TO XSA        YS02019 67920002
***                                                             YS02019 67921002
***                 IF ALL OUTPUT IS ON QUEUE, TURN OFF         YS02019 67922002
***                 QCBPARTO. ELSE, TURN IT ON                  YS02019 67923002
***                                                             YS02019 67924002
         SR    RWRK,RWRK                                        YS02019 67925002
         CH    RWRK,XSAUBFRS            REMAINING SIZE ZERO     YS02019 67926002
         BNE   TPT9910                  NO, TURN ON PARTO       YS02019 67927002
         TM    XSAF,XSAPARTO            HAS PARTO BEEN SET      YM01246 67927402
         BZ    TPT9915                  NO, NO NEED TO RESET    YM01246 67927802
         NI    TSBF1V,OFF-QCBPARTO      YES, TURN OFF PARTO     YS02019 67928002
         OI    TSBF1M,QCBPARTO          ACTION BIT FOR AYP      YM01246 67928402
         NI    XSAF,OFF-XSAPARTO        RESET PARTO FLAG        YM01246 67928802
         B     TPT9915                  SKIP                    YS02019 67929002
TPT9910  EQU   *                                                YS02019 67930002
         TM    XSAF,XSAPARTO            HAS PARTO BEEN SET      YM01246 67930402
         BO    TPT9915                  YES, NO NEED TO SET     YM01246 67930802
         OI    TSBF1M,QCBPARTO          ACTION BIT FOR AYP      YM01246 67930902
         OI    TSBF1V,QCBPARTO          TURN ON PARTO           YS02019 67934502
         OI    XSAF,XSAPARTO            SET PARTO FLAG IN WA    YM01246 67935402
TPT9915  EQU   *                                                YS02019 67935602
         SPACE 2                                                YS02019 67936702
***                                                             YS02019 67937802
***                 TURN ON QCBTPUT.  IF BREAKIN REQUEST, AND   YS02019 67938902
***                 BREAKIN IS ALLOWED, TURN ON QCBWRBRK.       YS02019 67940002
***                                                             YS02019 67941102
         TM    XSAOPTNS,MBREAK          BREAKIN REQUEST         YM01176 67941502
         BO    TPT9917                  YES, SKIP TSBTPUT TEST  YM01176 67941902
         TM    TSBFLG3,TSBTPUT          ALREADY DOING A TPUT    YM01246 67942102
         BZ    TPT9917                  NO, MUST TPOST          YM01246 67942402
         TM    TSBF1M,QCBPARTO          MUST PARTO BE SET       YM01246 67942802
         BZ    TPT9930                  NO NEED TO TPOST        YM08378 67942902
TPT9917  EQU   *                                                YM01246 67943102
         OI    TSBF1V,QCBTPUT           SET TPUT VALUE          YS02019 67943802
         OI    TSBF1M,QCBTPUT           ACTION BIT FOR AYP      YS02019 67944002
         TM    XSAOPTNS,MBREAK          BREAKIN REQUEST         YS02019 67945502
         BNO   TPT9920                  NO, SKIP                YS02019 67946602
         TM    TSBFLG3,TSBNOBRK         BREAKIN ALLOWED         YS02019 67947702
         BO    TPT9920                  NO, SKIP                YM01114 67948802
         OI    TSBF1V,QCBWRBRK          SET VALUE BIT           YS02019 67949902
         OI    TSBF1M,QCBWRBRK          SET ACTION BIT          YS02019 67951002
TPT9920  EQU   *                                                YS02019 67953002
         OI    TSBTPFLG,TSBPOSTO+TSBTPQCB TELL TYP TO TPOST QCB YS02019 67955002
*                                         SHOW TPOST OUTSTAND'G YS02019 67957002
         SPACE 2                                                YS02019 67958702
***                                                                     67959802
***                 SET BITS IN REAL TSB, USING CDS.  IF TSBPOSTO       67960902
***                 WAS ON DURING SWAP, NO NEED TO DO ACTUAL            67962002
***                 TPOST                                               67963102
***                                                                     67964202
         DROP  RGO                      USE REAL TSB NOW        YS02019 67965302
         LM    RBUF,RCVT,XSAWD5         GET NEW BITS            YS02019 67967502
         DROP  RCVT                                             YS02019 67968602
         CDS   R0,RBUF,TSBTPOST         TRY TO RESET BITS       YS02019 67969702
         BNE   TPT9907                  IF CHANGED, DO IT AGAIN YS02019 67970802
         OI    TSBFLG3,TSBTPUT          SET INDR FOR FUTURE     YS03998 67971202
         L     RCVT,CVTPTR                                      YS02019 67977102
         USING CVT,RCVT                                         YS02019 67978302
         L     RTCX,CVTAQAVT            GET TCX ADDRESS         YS02019 67979502
         USING IEDQTCX,RTCX                                     YS02019 67980702
         LTR   R0,R0                    TEST TSBPOSTO (THIS TST YS02019 67981902
*                                       NEEDS TSBPOSTO EQU 8)   YS02019 67983102
         BM    TPT9930                  IF ON, DON'T TPOST.     YS02019 67984302
*                                       IEDAYP WILL PICK UP     YS02019 67985502
*                                       THESE FLAGS ANYWAY      YS02019 67986702
         SPACE 2                                                YS02019 67987902
***                                                             YS02019 67989102
***                 TPOST THE TSB TO IEDAYP                             67990302
***                                                                     67991502
         L     RWRK,TCXTSI              GET TSINPUT QCB ADDRESS YS02019 67992702
         USING IEDQTSI,RWRK                                     YS02019 67993902
         LA    RWRK,TSITSAP-(QCBSTVTO-IEDQQCB)                  YS02019 67995102
*                                       ADDRESS OF IEDAYP'S     YS02019 67996302
*                                       'QCB'                   YS02019 67997502
         DROP  RWRK                                             YS02019 67998702
         ST    RWRK,TSBRQCB             QCB TO WHICH TSB WILL   YS02019 67999902
*                                       BE TPOSTED              YS02019 68001102
         L     RWRK,TCXREADY            GET CONTENTS OF READY Q YS02019 68002302
TPT9925  EQU   *                                                YS02019 68003502
         ST    RWRK,TSBLINKA            LINK TSB TO NEXT ELEM   YS02019 68004702
         MVI   TSBPRI,PRIDESTQ          SET PRIORITY            YS02019 68005902
         LA    RSAVE,TSBRCB             GET READY TO PUT ELEM   YS02019 68007102
*                                       ADDRESS INTO Q HEADER   YS02019 68008302
         CS    RWRK,RSAVE,TCXREADY      TRY TO ADD IT TO QUEUE  YS02019 68009502
         BNE   TPT9925                  NO GOOD, TRY AGAIN      YS02019 68010702
         SPACE 2                                                YS02019 68011902
***                                                             YS02019 68013102
***                 X-M POST TCAM                               YS02019 68014302
***                                                             YS02019 68015502
         SR    RRPT,RRPT                COMPLETION CODE         YS02019 68016702
         LR    RASCB,RTJID              SAVE TJID               YS02019 68017902
         LA    RTJID,CVTBRET            'ERRET' ADDRESS         YS02019 68019102
         L     RAVT,TCXASCB             LOAD ASCB OF TCAM       YS02019 68020302
         LR    R0,RTCX                  SAVE TCX POINTER        YS02019 68021502
         L     RTCX,TCXAVT              AVT POINTER             YS02019 68023502
         DROP  RTCX                                             YS02019 68023902
         USING IEDQAVTD,RTCX                                    YS02019 68025502
         LA    RECB,AVTOSECB            ECB POINTER ** NOTE     YS02019 68027502
*                                       THAT AVT IS NOT REALLY  YS02019 68029502
*                                       ADDRESSABLE             YS02019 68035402
         L     RGOTO,CVT0PT01           POST ROUTINE ADDRESS    YS02019 68039402
         O     RECB,TSIPSIGN            HI-ORDER BIT=XMPOST     YS02019 68039502
         BALR  RETURN,RGOTO             GO POST                 YS02019 68039802
         SPACE 2                                                YS02019 68040202
         LR    RTCX,R0                  RESTORE TCX PTR         YS02019 68040602
         USING IEDQTCX,RTCX                                     YS02019 68041002
         LR    RTJID,RASCB              RESTORE TJID            YS02019 68041102
         L     RASCB,TSBASCBA           RESTORE ASCB POINTER    YS02019 68041202
         L     RRPT,TCXRPT              RESTORE RPT POINTER     YS02019 68047102
         USING TIOCRPT,RRPT                                     YS02019 68049102
TPT9930  EQU   *                                                YS02019 68051102
         L     RCVT,CVTPTR              RESTORE CVTPTR         @ZA03945 68052003
         L     RBUF,XSAWD7              RESTORE REGISTER 2      YS02019 68053002
         BR    RBUF                     RETURN                  YS02019 68058902
         EJECT                                                  YS02019 68064802
*********************************************************************** 68082402
*****                                                             ***** 68100020
*****               CONSTANTS USED BY IGG09301                    ***** 68200020
*****                                                             ***** 68300020
*********************************************************************** 68400020
         SPACE                                                          68500020
NEWLINE  DC    X'15'                    NL CHAR TO SEND WHEN NO DATA    69000020
TPTPSW   DS    0F                       ALIGNMENT                       69010002
         DC    X'070C0000'              1ST WD OF RESUME PSW -   Y01018 69030000
*                                       TRANS, ENABLE, EC, M CK  Y01018 69040000
FOUR     DC    F'4'                     CONSTANT FOR COMPARISON  YM0895 69042000
KZERO    DC    F'0'                     ZERO COMPARATOR                 69100020
TSIPSIGN DC    X'80000000'              TPUT INDR FOR TSIP              69200020
PATCHREA DC    10F'0'                   PATCH AREA               Y01018 69220000
         EJECT                                                          70300020
         IHAASCB                                                YS02019 70610002
         EJECT                                                  YS02019 70620002
         IKJTIOCB                                               SA60002 70630002
         EJECT                                                  SA60002 70650102
         IHAASVT                                                YS02019 70700002
         EJECT                                                  YS02019 71100002
         TAVTD                                                  YS02019 71150002
         EJECT                                                  YS02019 71160002
CVT      DSECT                                                  YS02019 71200002
         CVT                                                    YS02019 71300002
         EJECT                                                  YS02019 71310002
         TPRIOR                                                 YS02019 71350002
         EJECT                                                  YS02019 71400002
         IHAPSA                                                 YS02019 71500002
         EJECT                                                  YS02019 71600002
         TQCBD                                                  YS02019 71700002
         EJECT                                                          72100020
         IKJRB                                                          72103021
***                                                                     72106021
***      EXTENDED SAVE AREA.  THSES STATEMENTS SHOULD FOLLOW            72109021
***      THE MACRO 'IKJRB.'                                             72112021
***                                                                     72115021
         ORG   RBEXSAVE                 START OF SAVE AREA       M0094  72118021
XSAPRM0  DS    0F                       REG 0 AT ENTRY           M0094  72121021
XSAPRMTJ DS    H                        TJID PASSED              M0094  72124021
XSAPRMSZ DS    H                        SIZE PASSED              M0094  72127021
XSAPRM1  DS    0F                       REG 1 AT ENTRY           M0094  72130021
XSAOPTNS DS    X                        USER OPTIONS             M0094  72133021
MASIS    EQU   X'01'                    ASIS OPTION SPECIFIED    M0094  72136021
MCNTRL   EQU   X'02'                    1 MEANS CONTROL          M0094  72139021
*                                                                       72142021
*   BOTH OF THE ABOVE BITS OFF MEANS EDIT OPTION                        72145021
*                                                                       72148021
MBREAK   EQU   X'04'                    BREAKIN SPECIFIED        M0094  72151021
MHOLD    EQU   X'08'                    1 MEANS HOLD             M0094  72154021
MTGET    EQU   X'80'                    1 MEANS TGET REQUESTED   M0094  72157021
MUSERP   EQU   X'40'                    REG 15 PTS TO USERID    YS02019 72160002
MLOWP    EQU   X'20'                    0 HIGHPRI, 1 LOWPRI      M0094  72163021
MWAIT    EQU   X'10'                    1 MEANS NOWAIT           M0094  72166021
         DS    AL3                      REST OF REGISTER ONE     M0094  72169021
XSAWD3   DS    0F                       FOR SAVING REGISTERS     M0094  72172021
XSAFLAG  DS    X                        FLAG PASSED BY 9C TO 01  M0094  72175021
*                                       AND 02                   M0094  72178021
XSATCBFX EQU   X'20'                    TURN OFF TCBFX AT EXIT   M0094  72181021
         DS    AL3                      REST OF WORD             M0094  72184021
         ORG   XSAWD3+2                 INPUT ED, OUTPUT MOVE    M0094  72187021
XSAUBFRS DS    H                        AMT DATA LEFT TO MOVE    M0094  72190021
XSAUBFRP DS    0F                       LOC DATA LEFT TO MOVE    M0094  72193021
XSAESTAL DS    CL16                     LIST FOR ESTAE MACRO    YS02019 72203002
         ORG   XSAUBFRP+4               USED FOR SAVE AREA WHEN YS02019 72220002
*                                       NOT NEEDED BY ESTAE     YS02019 72223002
XSAWD5   DS    F                        FOR SAVING REGISTERS     M0094  72226021
XSAWD6   DS    F                        FOR SAVING REGISTERS     M0094  72229021
         ORG   XSAWD5                   USE WORDS 5-6 FOR NAME   M0094  72232021
XSAENQNM DS    CL8                      ENQ NAME FOR TJID TPUT   M0094  72235021
XSAWD7   DS    F                        FOR SAVING REGISTERS     M0094  72238021
XSAWD8   DS    F                        FOR SAVING REGISTERS     M0094  72241021
         ORG   XSAWD7                   USE WDS 7-8 FOR ENQ PRMS M0094  72244021
XSAENQAD DS    2F                       WORK AREA FOR ENQ/DEQ    M0094  72247021
XSAUSERP DS    0F                       PTR TO USERID           YS02019 72249002
XSAWD9   DS    F                        FOR SAVING REGISTERS     M0094  72250021
XSARETRG DS    0F                       FOR SAVING RETURN ADDR  YS02019 72252002
XSAWD10  DS    F                        FOR SAVING REGISTERS     M0094  72253021
         DS    CL1                      RESERVED                YS02019 72255002
XSAUSERK DS    CL1                      KEY OF TGET CALLER      YS02019 72255402
XSARC    DS    H                        RETURN CODE SAVE AREA   YS02019 72256002
XSATJID  DS    H                        CALLER'S TJID            M0094  72259021
XSAFLAG2 DS    X                        FLAGS                   YM05387 72261002
XSAATR   EQU   X'80'                    NEXT CHAR IN TS BUFFER   S22028 72263202
*                                       IS A 3270 ATTRIBUTE BYTE        72263802
XSABFRAL EQU   X'40'                    TIOC BUFFER HAS BEEN    YM05387 72264202
*                                       ALLOCATED               YM05387 72264302
XSA15D   EQU   X'20'                    CHANGE COMPLETION CODE  YM05387 72266602
*                                       TO 15D                  YM05387 72268602
*                  NEXT 5 BITS UNUSED                           YM05387 72269002
XSAF     DS    X                        FLAGS USED BY TPUT. INI- M0094  72271302
*                                       TIALIZED FROM XSAFLAG.          72273602
HSW      EQU   X'80'                    HEADER BFR DONE          M0094  72275902
PSW      EQU   X'40'                    NEED TO TPOST QCB        M0094  72278202
*SATCBFX EQU   X'20'                    TURN OFF TCBFX AT EXIT          72280502
OSW      EQU   X'10'                    TSBOWIP TURNED ON BY US  M0094  72282802
XSADMOVE EQU   X'08'                    DATA MOVEMENT GOES ON   YS02019 72285102
XSAAUTH  EQU   X'04'                    USER IS AUTHORIZED      YS02019 72287402
*                                       (NOT SOME OTHER TPUT)   YS02019 72289702
XSAUDEBQ EQU   X'02'                    ASID TPUT ASID ENQUEUED YS02019 72292002
XSAPARTO EQU   X'01'                    QCBPARTO IS SET ON      YM01246 72302002
         EJECT                                                  YS02019 72312002
         IHASCVT                                                YS02019 72342002
         EJECT                                                  YS02019 72402002
         IKJTCB                                                 YS02019 72412002
         EJECT                                                  YS02019 72422002
         IEFTCT                                                 YS02019 72432002
         EJECT                                                  YS02019 72442002
         TTCXD                                                  YS02019 72462002
         EJECT                                                  YS02019 72472002
         IKJTIOCP                                               YS02019 72492002
         EJECT                                                  YS02019 72502002
         IKJTSB                                                 YS02019 72552002
         EJECT                                                  YS02019 72562002
         TTSID                                                  YS02019 72612002
         EJECT                                                  YS02019 72632002
         END   IGG09301                                                 72900020
