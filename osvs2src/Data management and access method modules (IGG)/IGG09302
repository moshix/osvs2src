         TITLE 'IGG09302 - SECOND LOAD OF TPUT WITH TJID'               00100002
IGG09302 CSECT                                                          00200002
         SPACE 3                                                YS02019 00240002
*                                                                       00241003
*         VS2   030   SU                                                00242003
*                                                                       00243003
*0000275510                                                    @ZA05569 00244003
*                                                                       00245003
*                                                                       00246003
*                   RELEASE 3, VS/2, CHANGES                          * 00250003
*D002200                                                        ZA00968 00252003
*C202700                                                        ZA00968 00254003
*                   RELEASE 2, VS/2, DELETIONS                        * 00260002
*                                       03/24/73                YM01564 00270002
*                                       05/30/73                YM01246 00272002
*                                       07/03/73                YM01114 00274002
*                                       07/16/73                YM01176 00276002
*                                       10/11/73                YM03998 00278002
*                                       11/15/73                YM05387 00278402
*                                       04/11/74                YM08378 00278802
*     THIS MODULE HAS BEEN COMPLETELY RESEQUENCED FOR VS2-2     YS02019 00280002
*                                                                     * 00300002
*                   RELEASE 1, VS/2, DELETIONS                        * 00320002
*                                                                     * 00400002
*580260-580740,217021                                            YM0895 00600002
*1301554000                                                      A44943 00800002
*1301612550                                                      S22028 00819002
*1301516000                                                      A45242 00900002
*1301                                                            M0126  01000002
*1301035000-046000,073000-112000,191000-192400,203000-209000,    M0094  01100002
*1301217010-217020,217080,217130-217140,217220,219200-219300,    M0094  01200002
*1301223000,238500,241000,284000,290000,292000,307000-310000,    M0094  01300002
*1301314000,343000,350000,361400-363200,401000,406000-409000,    M0094  01400002
*1301422000,428000,470400-475200,499000,503000,508000,577300,    M0094  01500002
*1301579540-579720                                               M0094  01600002
*                                                                M2152  01700002
*0000927000-944000                                               M0019  01800002
*0000246000,252000-255400,256000-297000,303000,339000,340000-    TS1634 01900002
*0000346000,356000,375000-412000,463000,478000-498000,504000,    TS1634 02000002
*0000546000,555000-579000,586500                                 TS1634 02100002
*                                                                M0661  02200002
*0000258000-259000,569000                                        TS0034 02300002
*                                                                 M2677 02400002
*                                                                M3391  02500002
*                                                                M4022  02600002
*                                                                M0048  02700002
*                                                                 M5113 02800002
*                                                                 M4415 02900002
*                                                                M4696  03000002
*                                                                M6024  03100002
*1301                                                            S21A12 03200002
*1301061500,361000,363000,471000,475000                          S21008 03300002
* STATUS -                                                            * 03400002
*    CHANGE LEVEL VS2  030  SU                                 @ZA05569 03450003
*                                                                     * 03500002
* FUNCTION -                                                          * 03600002
*                                                                     * 03700002
*    PUT OUTPUT FROM USER'S BUFFER INTO TSO BUFFERS FOR LATER         * 03800002
*    TRANSFERENCE, VIA TCAM, TO A TERMINAL NOT CONNECT TO THIS TASK.  * 03900002
*                                                                     * 04000002
*    PROVIDE LIMITED EDITING OPTIONS                                  * 04100002
*                                                                     * 04200002
* ENTRY POINTS -                                                      * 04300002
*                                                                     * 04400002
*    IGG09302 - ENTRY FROM FIRST LOAD OF TERMINAL I/O SVC             * 04500002
*    ROUTINES (IGC0009C).                                             * 04600002
*                                                                     * 04700002
* INPUT -                                                             * 04800002
*                                                                     * 04900002
*********************************************************************** 05000002
***                                                                 *** 05100002
***                 REGISTER CONTENTS UPON ENTRY                    *** 05200002
***                                                                 *** 05300002
***      3 - CVT POINTER      8 - ASCB OF CALLER  15 - USERID PTR   *** 05400002
***      4 - TCB POINTER      9 - TSB OF CALLER       (IF USERID    *** 05500002
***      5 - SVRB POINTER    10 - TIOCRPT POINTER      TPUT)        *** 05600002
***                                                                 *** 05700002
***                                                                 *** 05900002
*********************************************************************** 06000002
*                                                                     * 06100002
* OUTPUT                                                              * 06200002
*                                                                     * 06300002
*    RETURN CODE IN REG 15                                            * 06400002
*              00 - SUCCESSFUL                                        * 06500002
*              04 - NOWAIT SPECIFIED, AND TSB WAS IN USE              * 06600002
*              08 - ATTN OCCURED DURING SVC EXECUTION                 * 06700002
*              OC - NO INTER-TERMINAL COMMUNICATION ALLOWED           * 06800002
*              14 - CALLED TASK IS NO LONGER ACTIVE                   * 07300002
*                                                                     * 07400002
* EXTERNAL REFERENCES -                                               * 07500002
*                                                                     * 07600002
*              MODESET                                          YS02019 07700002
*              SETLOCK                                          YS02019 07750002
*              OPTIMIZER                                        YS02019 07800002
*              TESTAUTH                                         YS02019 07850002
*              QTIP                                                   * 07900002
*              ENQ/DEQ                                                * 08000002
*                                                                     * 08400002
* EXITS,NORMAL -                                                      * 08500002
*                                                                     * 08600002
*    RETURN TO SUPERVISOR VIA BR14 (RETURN ADDRESS IS SAVED IN        * 08700002
*    XSARETRG BY IGC0009C)                                            * 08750002
*                                                                     * 08800002
* EXITS,ERROR -                                                       * 08900002
*                                                                     * 09000002
*    THERE ARE NO ERROR EXITS FROM THIS ROUTINE.                      * 09100002
*                                                                     * 09200002
* TABLES/WORK AREAS -                                                 * 09300002
*                                                                     * 09400002
*    THE FORMAT AND CONTENTS OF THE TABLES USED ARE                   * 09500002
*    DESCRIBED BY THE DSECTS AT THE END OF THE LISTING                * 09600002
*                                                                     * 09700002
* ATTRIBUTES -                                                        * 09800002
*                                                                     * 09900002
*    REENTRANT, PRIVILEGED, REFRESHABLE                               * 10000002
*    HOLDS THE LOCAL LOCK AT ENTRY AND GETS CMS LOCK EXPLICITLY       * 10060002
*                                                                     * 10100002
* CHARACTER CODE DEPENDENCY -                                         * 10200002
*                                                                     * 10300002
*    THE OPERATION OF THIS MODULE DEPENDS UPON THE FOLLOWING          * 10400003
*    PROPERTIES OF THE INTERNAL REPRESENTATION OF THE EXTERNAL        * 10500003
*    CHARACTER SET- BACKSPACE EQUAL TO X'16', BLANK EQUAL TO          * 10600003
*    X'40', NEW LINE EQUAL TO X'15'.                                  * 10700002
*    THE SPECIFIC INSTRUCTIONS WHICH REQUIRE MODIFICATION IF          * 10800003
*    THESE PROPERTIES OF THE CHARACTER SET ARE CHANGED MAY BE         * 10900003
*    IDENTIFIED BY BLNKCHAR, BKSPCHAR, AND NEWLINE, RESPECTIVELY.     * 11000002
*                                                                     * 11100002
* NOTES -                                                             * 11200002
*                                                                     * 11300002
*    NONE                                                             * 11400002
*                                                                     * 11500002
*********************************************************************** 11600002
         EJECT                                                          11800002
*********************************************************************** 11900002
******                                                            ***** 12000002
******              REGISTER EQUATES                              ***** 12100002
******                                                            ***** 12200002
*********************************************************************** 12300002
       SPACE                                                            12400002
R0       EQU   0                        REG USED TO SPEED ASM           12500002
RP0      EQU   0                        FOR TPOST SUBROUTINE    YS02019 12550002
RSAVE    EQU   0                        WORK REGISTER                   12600002
RWRK2    EQU   1                        WORK REGISTER                   12700002
RP1      EQU   1                        FOR TPOSTING SUBROUTINE YS02019 12750002
RBUF     EQU   2                        POINTER TO TS BUFFER            12800002
RCVT     EQU   3                        POINTER TO CVT                  12900002
RTCB     EQU   4                        POINTER TO TCB                  13300002
RSVRB    EQU   5                        POINTER TO SVRB                 13400002
RBASE    EQU   6                        BASE REGISTER                   13500002
RSAVE2   EQU   7                        SAVE REGISTER FOR TJID          13600002
RASCB    EQU   8                        POINTER TO ASCB         YS02019 13700002
RTSB     EQU   9                        POINTER TO TSB                  13800002
RRPT     EQU   10                       POINTER TO TIOCRPT              13900002
RTCX     EQU   11                       POINTER TO TCAM CVT EXT YS02019 14000002
RTJID    EQU   12                       TJID                            14200002
RAVT     EQU   13                       POINTER TO AVT                  14300002
RETURN   EQU   14                       RETURN ADDRESS                  14400002
RWRK     EQU   14                       WORK REGISTER                   14500002
RWRK1    EQU   15                       WORK REGISTER                   14600002
RCODE    EQU   15                       RETURN CODE                     14700002
RGOTO    EQU   15                       BRANCH ADDRESS                  14800002
         SPACE 2                                                        14900002
***                                                                     15000002
***                 CONSTANTS                                           15100002
***                                                                     15200002
K0       EQU   0                        OFFSET                          15700002
K1       EQU   1                        OFFSET AND SIZE                 15800002
K3       EQU   3                        OFFSET AND SIZE                 16000002
K12      EQU   12                       SIZE OF QNAME FOR ENQ-DEQ       16200002
TIMES4   EQU   2                        SHIFT CONSTANT          YS02019 16300002
         SPACE 2                                                        16400002
***                                                                     16500002
***                 RETURN CODES                                        16600002
***                                                                     16700002
RCNOWT   EQU   X'04'                    NOWAIT SPEC'D AND TSB BUSY      16800002
RCNOIT   EQU   X'0C'                    NO INTER-TERM ALLOWED           16900002
RCGONE   EQU   X'14'                    CALLED TASK NO LONGER           17300002
*                                       ACTIVE                          17400002
         SPACE 2                                                        17500002
***                                                                     17600002
***                 MASKS                                               17700002
***                                                                     17800002
OFF      EQU   X'FF'                    USED TO TURN OFF BITS           17900002
NDISPBIT EQU   X'400'                   NONDISPATCHABILITY MASK YS02019 18000002
SEVEN    EQU   7                        MASK USED IN STMC        Y01018 18050002
STEPSD   EQU   8                        ENTRY CODE FOR STATUS   YS02019 18100002
         SPACE 2                                                        18300002
***                                                                     18400002
***                 OTHER EQUATES                                       18500002
***                                                                     18600002
MOVECODE EQU   19                       QTIP ENTRY CODE FOR MOVE        18800002
BKSPCHAR EQU   X'16'                    BACKSPACE                       19200002
BLNKCHAR EQU   X'40'                    BLANK                           19300002
         EJECT                                                  YS02019 19350002
*********************************************************************** 19350402
***                                                             YS02019 19350802
***            THIS MODULE IS BRANCH ENTERED FROM IGC0009C      YS02019 19352002
***            HOLDING THE LOCAL LOCK                           YS02019 19354002
***                                                             YS02019 19354102
*********************************************************************** 19354402
         SPACE 3                                                        19356002
***                                                                     19360002
***                ESTABLISH ADDRESSABILITY AND                         19362002
***                INITIALIZE EXTENDED SAVE AREA FIELDS                 19370002
***                                                                     19380002
         BALR  RBASE,R0                 SET ADDRESSABILITY              19400002
         USING *,RBASE                                                  19500002
         USING TCB,RTCB                                                 19700002
         USING TIOCRPT,RRPT                                             20000002
         USING RBSECT,RSVRB                                      M0094  20200002
         B     INIT                     AROUND I.D.             YS02019 20250002
         DC    C'IGG09302'              MODULE I.D.             YS02019 20260002
         DC    X'5237'                  DATE - 08/25/75        @ZA05569 20270003
INIT     DS    0H                       BRANCH TARGET           YS02019 20280002
         MVC   XSAF,XSAFLAG             INITIALIZE FLAGS         M0094  20300002
         MVC   XSAUBFRS,XSAPRMSZ        ASSUME NO TRAILING       Y01018 20500002
*                                       BLANKS                   Y01018 20600002
         MVC   XSAUBFRP+K1(K3),XSAPRM1+K1 SET UP USER BFR PTR    Y01018 20700002
         STH   RTJID,XSATJID            SAVE CALLER'S ASID      YS02019 20750002
         SPACE 3                                                YS02019 20801002
*********************************************************************** 20802002
*                                                                     * 20803002
*                   LOCATE DESTINATION TSB, ASCB, AND CSCB            * 20804002
*                                                                     * 20805002
*********************************************************************** 20806002
         SR    RBUF,RBUF                                        YS02019 20807002
         IC    RBUF,TIOCTSBS            INCREMENT AMOUNT=SIZE   YS02019 20808002
         LR    RWRK,RBUF                FOR MULTIPLICATION      YS02019 20809002
         LH    RWRK1,TIOCNTSB           GET NO. OF TSBS         YS02019 20810002
         BCTR  RWRK1,R0                 SUBTRACT ONE            YS02019 20811002
         MR    RWRK,RWRK                GET OFFSET OF LAST TSB  YS02019 20812002
         LR    RCVT,RWRK1               CHANGE REGS FOR BXLE    YS02019 20813002
         L     RTSB,TIOCTSB-K1          GET ORIGIN OF TABLE     YS02019 20814002
         LA    RTSB,K0(,RTSB)           CLEAR HIGH ORDER BYTE   YS02019 20814102
         USING TSB,RTSB                                         YS02019 20814402
         AR    RCVT,RTSB                ADD TO OFFSET           YS02019 20815002
         SPACE 2                                                YS02019 20816002
*********************************************************************** 20817002
*                                                                     * 20818002
*                   REGISTERS 2, 3, AND RTSB ARE SET FOR A BXLE LOOP  * 20819002
*                   TO SCAN THE TSB TABLE -                           * 20820002
*                    RBUF (2), INCREMENT, HAS THE TSB SIZE,           * 20821002
*                    RCVT (3), COMPARAND, POINTS TO THE LAST TSB IN   * 20822002
*                      THE TSB TABLE, AND                             * 20823002
*                    RTSB, INDEX, POINTS TO THE FIRST TSB IN THE TSB  * 20824002
*                      TABLE                                          * 20825002
*                                                                     * 20826002
*                   NOW, THE TSB'S, AND ASSOCIATED ASCB'S (AND CSCB'S)* 20827002
*                   WILL BE SCANNED FOR A MATCH ON THE ASID OR        * 20828002
*                   THE USERID.                                       * 20829002
*                                                                     * 20830002
*                  THE ASVT CANNOT BE USED, BECAUSE IT MUST BE        * 20830402
*                  STABILIZED WITH THE DISPATCHER LOCK, AND HOLDERS   * 20830802
*                  OF THIS LOCK MUST BE FIXED AND DISABLED.           * 20830902
*                                                                     * 20832002
*********************************************************************** 20834002
         SPACE 3                                                        20834402
***                                                                     20834802
***                NEED CMS LOCK FOR TSB                        YS02019 20836002
***                                                                     20838002
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                   YS02019-20840002
               RELATED=(TSB,IGG09302(TPT0100))                  YS02019 20840102
***                                                                     20840402
***                 MAKE SURE TIME SHARING IS STILL ACTIVE              20840502
***                                                                     20840602
         L     RRPT,CVTPTR              GET CVT POINTER         YS02019 20843102
         L     RRPT,CVTAQAVT-CVT(,RRPT) GET TCX POINTER         YS02019 20847502
         LTR   RRPT,RRPT                IS TCAM UP              YM01564 20849502
         BZ    TPT7500                  NO, ABORT THIS TPUT     YM01564 20849902
         L     RRPT,TCXRPT-IEDQTCX(,RRPT) GET RPT POINTER       YS02019 20850002
         LTR   RRPT,RRPT                CHECK FOR ZERO          YS02019 20852502
         BZ    TPT7500                  ZERO, ABORT THIS TPUT   YS02019 20855002
         SPACE 1                                                YS02019 20857502
         TM    XSAOPTNS,MUSERP          WAS USERID SPECIFIED    YS02019 20860002
         BO    TPT0020                  YES, GO LOOK FOR IT     YS02019 20862502
         SPACE 2                                                YS02019 20865002
***                                                             YS02019 20867502
***                 SCAN FOR ASID MATCH                         YS02019 20870002
***                                                             YS02019 20872502
         LH    RSAVE,XSAPRMTJ           GET SPECIFIED ASID      YS02019 20875002
TPT0010  EQU   *                                                YS02019 20877502
         L     RASCB,TSBASCBA           GET ASCB POINTER        YS02019 20880002
         LTR   RASCB,RASCB              IS THERE ONE            YS02019 20882502
         BZ    TPT0015                  NO, CONTINUE SCAN       YS02019 20885002
         USING ASCB,RASCB                                       YS02019 20887502
         CH    RSAVE,ASCBASID           CHECK ASID              YS02019 20890002
         BE    TPT0027                  IF SAME, THIS IS IT     YS02019 20892502
TPT0015  EQU   *                                                YS02019 20895002
         BXLE  RTSB,RBUF,TPT0010        CONTINUE SCAN           YS02019 20897502
         B     TPT7500                  GO GIVE 'NOT HERE' CODE YS02019 20900002
         SPACE 2                                                YS02019 20902502
***                                                             YS02019 20905002
***                 SCAN FOR USERID MATCH                       YS02019 20907502
***                                                             YS02019 20910002
TPT0020  EQU   *                                                YS02019 20912502
         L     RWRK1,XSAUSERP           GET PTR TO USER ID              20915002
TPT0021  EQU   *                                                YS02019 20917502
         L     RASCB,TSBASCBA           GET ASCB POINTER        YS02019 20920002
         LTR   RASCB,RASCB              IS THERE ONE            YS02019 20922502
         BZ    TPT0022                  NO, GET NEXT            YS02019 20925002
         L     RWRK,ASCBCSCB            GET CSCB POINTER        YS02019 20927502
         USING CSCB,RWRK                                        YS02019 20930002
         CLC   CHKEY,0(RWRK1)           CHECK USERID            YS02019 20932502
         BNE   TPT0022                  NOT THIS TSB            YS02019 20934502
***                                                                     20936502
***   WHEN A MATCHING USERID IS FOUND, SAVE ASID IN TPUT WORK AREA      20936902
***                                                                     20937302
         LH    RWRK1,ASCBASID           GET DESTINATION ASID    YS02019 20937402
         STH   RWRK1,XSAPRMTJ           SAVE IT IN WORK AREA    YS02019 20943202
         B     TPT0027                  GO TO PROCESS IT        YS02019 20945202
         SPACE 1                                                        20947202
TPT0022  EQU   *                                                YS02019 20949202
         BXLE  RTSB,RBUF,TPT0021        LOOK AT EACH TSB        YS02019 20955002
         B     TPT7500                  GO GIVE 'NOT HERE' CODE YS02019 20960802
*                                       AFTER ALL TSB'S CHECKED YS02019 20966602
         DROP  RWRK                                             YS02019 20972402
         SPACE 2                                                YS02019 20978202
TPT0027  EQU   *                                                YS02019 20984002
***                                                             YS02019 20989802
***   RTSB = DESTINATION TSB, RASCB = DESTINATION ASCB          YS02019 20995602
***                                                             YS02019 21001402
         SETLOCK RELEASE,TYPE=CMS,RELATED=('BEFORE SVC')        YS02019 21007202
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('BEFORE SVC')      YS02019 21013002
***                                                                     21018802
***                TEST AUTHORIZATION OF USER.  '+' SIGN AND CHECK FOR  21024602
***                'HIPRI' DEPEND ON THIS                               21030402
***                                                                     21036202
         TESTAUTH FCTN=1,KEY=YES,STATE=YES,RBLEVEL=2,BRANCH=YES YS02019 21042002
         L     RCVT,CVTPTR              RESTORE REG 3           YS02019 21047802
         USING CVT,RCVT                                         YS02019 21053602
         LTR   RCODE,RCODE              TEST RETURN CODE        YS02019 21059402
         BNZ   TPT0028                  SKIP BIT IF NOT ZERO    YS02019 21065202
         OI    XSAF,XSAAUTH             REMEMBER RETURN CODE    YS02019 21071002
         SPACE 2                                                YS02019 21076802
TPT0028  EQU   *                                                YS02019 21082602
*********************************************************************** 21088402
****                                                               **** 21094202
****                SEE IF NOWAIT OPTION CAN PROCEED               **** 21100002
****                                                               **** 21200002
*********************************************************************** 21300002
         TM    XSAOPTNS,MWAIT           NOWAIT SPECIFIED         M0094  21400002
         BNO   TPT0075                  NO, PROCEED WITH TPUT   YS02019 21500002
***                                                                     21600002
***                 TEST AVAILABILITY OF ENQUEUED RESOURCES             21700002
***                                                                     21800002
         MVC   XSAENQNM(K12),QNAME      INIT ENQ/DEQ PARMS       YM0895 21900002
         LA    RWRK2,XSAENQAD           GET PT TO ENQ WORK AREA  M0094  22000002
         ENQ   (XSAENQNM,ASCBASID,E,2,SYSTEM),RET=USE,MF=(E,(1))        22100002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                 YM03998*22150002
               RELATED=(TSB,IGG09302(TGT9600))                  YM03998 22160002
         LTR   RCODE,RCODE              WAS CONTROL ASSIGNED    YM03998 22200002
*                                       FROM ENQUEUE            YM03998 22250002
         BNZ   TPT0070                  IF NOT, RETURN                  22300002
         OI    XSAF,XSAIDENQ            INDICATE TO ESTAE EXIT  YS02019 22350002
*                                       ROUTINE ASID TPUT ENQ'D YS02019 22360002
***                                                                     22400002
***   CALCULATE NUMBER OF BUFFERS REQUIRED TO HOLD MESSAGE,             22500002
***   ASSUMING NO TRAILING BLANKS                                       22600002
***   NUMBER=(MSGLEN+(HDRSIZE-TRLSIZE))/(BUFSIZE-TRLRSIZE)              22700002
***                                                                     22800002
         SPACE 1                                                 Y01018 22900002
         SR    RWRK,RWRK                                         Y01018 23000002
         LH    RWRK1,XSAPRMSZ           GET LENGTH OF MSG        Y01018 23100002
         LA    RWRK1,BUFFHDLN-BUFFTRLN(,RWRK1) ADD EXTRA FOR     Y01018 23200002
*                                       HEADER PREFIX                   23300002
         LA    R0,BUFFTRLN              GET LENGTH OF TRLR PREF  Y01018 23400002
         SH    R0,TIOCBFSZ              WHAT'S LEFT OVER (COMP)  Y01018 23500002
         LPR   R0,R0                    GET BUFSIZE - TRLR PREF  Y01018 23600002
***   R0 = AMOUNT OF ROOM IN EACH BUFFER FOR REAL DATA                  23700002
***   R14 + 15 = AMOUNT OF DATA THAT MUST GO INTO BUFFERS               23800002
         DR    RWRK,R0                  GET NUMBER OF BUFFERS    Y01018 23900002
*                                       REQ                      Y01018 24000002
         LA    RWRK1,K1(,RWRK1)         ADD 1 FOR POSSIBLE       Y01018 24100002
*                                       REMAINDER                Y01018 24200002
         SPACE                                                          24300002
TPT0030  EQU    *                                                       24400002
***                                                                     24500002
***                 RWRK1 HAS NUMBER OF BUFFERS MESSAGE WILL NEED.      24600002
***                 TPUT NOWAIT CAN PROCEED IF                          24700002
***                    1.) RWRK1 LTE TIOCNFBF - TIOCUSLW, AND           24800002
***                    2.) RWRK1 + TSBNOBF LTE TIOCAOMX OR TIOCAOMX * 3 24900002
***                       IF THE MONITOR SUBCOMMAND IS ACTIVE           25000002
***                       (TSBGETBF NE 0).                              25100002
***                                                                     25200002
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                   YS02019*25400002
               RELATED=(TSB,IGG09302(TPT9700))                  YS02019 25450002
         TM    TSBFLG1,TSBOWIP          IS A TPUT IN PROGRESS           25600002
         BNZ   TPT0072                  YES, CAN'T DO IT        YM03998 25700002
         LH    RWRK2,TIOCNFBF           NO. FREE BFRS                   25800002
         SH    RWRK2,TIOCUSLW           MINUS THRESHOLD                 25900002
         CR    RWRK2,RWRK1              COMPARE WITH BFRS NEEDED        26000002
         BL    TPT0072                  NEEDED GT AVAILABLE     YM03998 26100002
*                                       = BRANCH                YM03998 26150002
***                                                                     26200002
***                 ADEQUATE BFRS AVAILABLE.  CHECK AOMX.               26300002
***                                                                     26400002
         LH    RWRK2,TIOCAOMX           GET MAX VALUE                   26500002
         TM    TSBFLG4,TSBGETBF         MONITOR SUBCMD ACTIVE   YS02019 26600002
         BZ    TPT0040                  NO, DON'T INCREASE AOMX         26700002
         AR    RWRK2,RWRK2              DOUBLE                   Y01018 26800002
         AH    RWRK2,TIOCAOMX           ADD 1 TO MAKE *3                26900002
TPT0040  EQU   *                                                        27000002
         SR    RBUF,RBUF                                                27100002
         IC    RBUF,TSBNOBF             GET NO. ALREADY ON OUTPUT QUEUE 27200002
         SR    RWRK2,RBUF               SUBTRACT FROM NUMBER ALLOWED    27300002
         CR    RWRK2,RWRK1              COMPARE NEEDED WITH ALLOWED     27400002
         BNL   TPT0080                  ALLOWED GTE NEEDED, SO  YS02019 27500002
*                                       PROCEED WITH TPUT       YS02019 27550002
         B     TPT0072                  RELEASE LOCKS          @ZA05569 27570003
         SPACE 1                                                        27600002
TPT0070  EQU   *                                                        27700002
***                                                                     27800002
***                 CAN'T PUT OUT MESSAGE WITHOUT WAITING.              27900002
***                 RETURN WITH CODE = 4.                               28000002
***                                                                     28100002
         LA    RCODE,RCNOWT             SET CODE                        28200002
         B     TPT9650                  CLEAN UP AND RETURN             28300002
         SPACE 1                                                YM03998 28350002
TPT0072  EQU   *                                                YM03998 28360002
         LA    RCODE,RCNOWT             SET RETURN CODE         YM03998 28370002
         B     TPT9625                  FREE LOCKS AND RETURN   YM03998 28380002
         SPACE 1                                                 Y01018 28400002
TPT0075  EQU   *                                                        29350002
         SPACE 2                                                 TS1634 29400002
*********************************************************************** 29500002
****                                                               **** 29600002
****                ENQ ON ASID, SINCE ONLY 1 TPUT AT A TIME       **** 29700002
****                CAN USE TSB                                    **** 29800002
****                                                               **** 29900002
*********************************************************************** 30000002
         SPACE                                                          30300002
         MVC   XSAENQNM(K12),QNAME      INIT ENQ/DEQ PARMS       YM0895 30400002
         LA    RWRK2,XSAENQAD           GET PT TO ENQ WORK AREA  M0094  30500002
         ENQ   (XSAENQNM,ASCBASID,E,2,SYSTEM),MF=(E,(1))        YS02019 30600002
         OI    XSAF,XSAIDENQ            INDICATE TO ESTAE EXIT  YS02019 30602002
*                                       ROUTINE ASID TPUT ENQ'D YS02019 30604002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                 YS02019*30610002
               RELATED=(TSB,IGG09302(TPT0100))                  YS02019 30620002
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                   YS02019*30630002
               RELATED=(TSB,IGG09302(TPT0100))                          30640002
TPT0080  EQU   *                                                YS02019 30650002
***                                                             YS02019 30660002
***                 INITIALIZATION                                      30670002
***                                                                     30680002
         SPACE 2                                                 TS1634 30700002
         BAL   RBUF,TPT6000             CHECK STATUS             TS0034 30800002
         LH    RTJID,XSATJID            GET ASID FROM WHERE 9C  YS02019 31050002
*                                       SAVED IT                YS02019 31060002
         SR    RSAVE2,RSAVE2                                            31100002
         LR    RCODE,RSAVE2             SET RETURN CODE TO 0            31200002
         CH    RSAVE2,XSAPRMSZ          IS MESSAGE LENGTH ZERO   M0094  31300002
         BE    TPT9625                  GET OUT                 YM03998 31400002
         SPACE 2                                                        31600002
         TM    TSBSTAT,TSBITOFF         IS INTER-TERMINAL               31700002
*                                       COMMUNICATION ALLOWED           31800002
         BZ    TPT0100                  IF ALLOWED                      31900002
         LA    RCODE,RCNOIT             RETURN CODE                     32000002
         TM    XSAF,XSAAUTH             IS CALLER AUTHORIZED    YS02019 32100002
         BNO   TPT9625                  NO, DON'T OVERRIDE      YM03998 32200002
         TM    XSAOPTNS,MLOWP           IF AUTHORIZED, CHECK PRTY M0094 32300002
*                                       LEVEL                    S21A12 32400002
         BO    TPT9625                  IF LOWP, ABORT TPUT     YM03998 32500002
         SPACE 2                                                        32600002
TPT0100  EQU   *                                                        32700002
         TM    TSBFLG1,TSBOWIP          IS NORMAL TPUT GOING     TS1634 32800002
         BNO   TPT0350                  GO AHEAD IF NOT          TS1634 32900002
***                                                                     33000002
***                 WAIT ON TSBECB FOR NORMAL TPUT TO COMPLETE          33100002
***                                                                     33200002
         MVI   TSBECB,K0                RESET WAIT+POST BITS     TS1634 33300002
         STH   RTJID,TSBWTJID           SHOW WHO'S WAITING       TS1634 33400002
         STCM  RTCB,SEVEN,TSBWTCB       STORE WAITING TCB ADDR   Y01018 33600002
         OI    TSBFLG3,TSBAWOIP         SHOW WE ARE WAITING     YS02019 33620002
         SETLOCK RELEASE,TYPE=CMS,RELATED=(TSB,IGG09302(TPT0100))       33640002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=(TSB,IGG09302(TPT0100))     33660002
         WAIT  ECB=TSBECB,LONG=YES                              YS02019 34300002
         SPACE 2                                                 TS1634 34400002
***                                                                     34500002
***                 AFTER POST, DISABLE AND CHECK AGAIN                 34600002
***                                                                     34700002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                 YS02019*34800002
               RELATED=(TSB,IGG09302(TPT9600))                  YS02019 34900002
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                   YS02019*35000002
               RELATED=(TSB,IGG09302(TPT9700))                          35100002
         LH    RTJID,TSBWTJID           RESTORE TJID            YS02019 35200002
         BAL   RBUF,TPT6000             CHECK USER'S STATUS      TS1634 35400002
         B     TPT0100                  CHECK OWIP AGAIN                35500002
         SPACE 2                                                        35600002
TPT0350  EQU   *                                                        35700002
***                                                                     35800002
***                 CHECK EDIT OPTION                                   35900002
***                                                                     36000002
         OI    TSBFLG1,TSBOWIP+TSBTJIP  SIEZE TSB                       36100002
         OI    XSAF,OSW                 INDICATE WE SET TSBOWIP  YM0895 36300002
         ST    RTCB,TSBCTCB             STORE CURRENT TCB ADDRESS       36500002
         STH   RTJID,TSBWTJID           STORE CURRENT TJID              36600002
         OI    XSAF,XSADMOVE            INDICATE DATA MOVEMENT  YM05387 36650002
         TM    XSAOPTNS,MCNTRL+MASIS    CONTROL OR ASIS OPTION   M0094  36700002
         BM    TPT0600                  IF EITHER SKIP EDIT             36800002
         BZ    TPT0475                  IF EDIT, GO REMOVE      SA61765 36850002
***                                                                     36860002
***      MUST BE AN ATTEMPT AT FULL-SCREEN TJID TPUT.  QUASH IT.        36870002
***                                                                     36880002
         NI    XSAOPTNS,OFF-MCNTRL      FORCE ASIS ONLY         SA61765 36890002
         B     TPT0600                  SKIP BLANK REMOVAL      SA61765 36892002
TPT0475  EQU   *                                                SA61765 36894002
         SPACE 2                                                        36900002
***                                                                     37000002
***                 REMOVE TRAILING BLANKS                              37100002
***                                                                     37200002
         L     RWRK,XSAPRM1             GET USER BUFFER POINTER  M0094  37300002
         LA    RWRK,K0(R0,RWRK)         CLEAR FIRST BYTE                37400002
         LH    RWRK1,XSAPRMSZ           USER BUFFER SIZE         M0094  37500002
         AR    RWRK,RWRK1               PTR TO USER BFR END+1           37600002
         SPACE 2                                                        37700002
TPT0400  EQU   *                                                        37800002
         BCTR  RWRK,R0                  DECREMENT POINTER               37900002
         CLI   K0(RWRK),BLNKCHAR        IS CHARACTER BLANK              38000002
         BNE   TPT0500                  IF NOT QUIT REMOVAL             38100002
         BCT   RWRK1,TPT0400            BR IF BFR SIZE NOT ZERO  Y01018 38200002
         SPACE 2                                                        38300002
***                                                                     38400002
***                 NO DATA LEFT AFTER REMOVING BLANKS - SEND NL ONLY   38500002
***                                                                     38600002
         LA    RWRK1,NEWLINE            POINT TO NL CHAR                38700002
         STCM  RWRK1,SEVEN,XSAPRM1+K1   POINT AT NL CHAR         Y01018 38900002
         OI    XSAOPTNS,MASIS           FORCE ASIS OPTION SO NL  M0094  39700002
*                                       CAN GET THROUGH                 39800002
         LA    RWRK1,K1                 INDICATE LENGTH OF 1            39900002
         SPACE 2                                                        40000002
TPT0500  EQU   *                                                        40100002
         STH   RWRK1,XSAPRMSZ           UPDATE USER BFR SIZE     M0094  40200002
         SPACE 2                                                        40300002
TPT0600  EQU   *                                                        40400002
***                                                                     40500002
***                 CHECK BUFFER AVAILABILITY                           40600002
***                                                                     40700002
         LH    RWRK,TIOCAOMX            GET NORMAL MAX                  40800002
         TM    TSBFLG4,TSBGETBF         MONITOR SUBCMD ACTIVE   YS02019 40840002
         BNO   TPT0625                  NO, DON'T INCREASE AOMX         41000002
         AR    RWRK,RWRK                DOUBLE IT                Y01018 41100002
         AH    RWRK,TIOCAOMX            ADD ONE TO GET 3                41200002
TPT0625  EQU   *                                                        41300002
         SR    RWRK2,RWRK2                                              41400002
         IC    RWRK2,TSBNOBF            NUMBER ALREADY ON OUT QUEUE     41500002
         CR    RWRK2,RWRK               SHOULD BE LESS THAN MAX         41600002
         BNL   TPT0700                  IF NOT, WAIT                    41700002
         SR    RWRK,RWRK                                         TS1634 41800002
         TM    TSBFLG4,TSBGETBF         MONITOR SUBCMD ACTIVE   YS02019 41840002
         BZ    TPT0650                  NO, DON'T RESTRICT              42000002
         LH    RWRK,TIOCUSLW            DON'T USE LAST BUFFERS          42100002
TPT0650  EQU   *                                                        42200002
         CH    RWRK,TIOCNFBF            ANY FREE BUFFERS         TS1634 42300002
         BL    TPT1000                  IF SO, GO PROCESS ONE    TS1634 42400002
***                                                                     42500002
***                 NO FREE BUFFERS - SET BITS IN RPT AND TSB           42600002
***                    AND WAIT                                         42700002
***                                                                     42800002
         OI    TSBFLG1,TSBTJBF          SHOW WHICH TASK WAITING  TS1634 42900002
         OI    TIOCFLG,TIOCTJBF         SET SYSTEM INDICATOR     TS1634 43000002
         B     TPT0800                  WAIT                     TS1634 43100002
TPT0700  EQU   *                                                 TS1634 43200002
         OI    TSBFLG1,TSBTJOW          INDICATE WHY WAITING     TS1634 43300002
TPT0800  EQU   *                                                        43400002
*********************************************************************** 43500002
*****                                                             ***** 43600002
*****               ROUTINE FOR WAITING ON ECB                    ***** 43700002
*****                                                             ***** 43800002
*********************************************************************** 43900002
         SPACE                                                          44000002
         TM    XSAF,PSW                 DOES TCAM NEED TO BE     M0094  44100002
*                                       POSTED FOR PARTIAL MSG          44200002
         BZ    TPT0900                  BRANCH IF ZEROES                44300002
         SPACE 2                                                        44400002
***                                                                     44500002
***                 CHECK IF NEXT CHAR TO BE SENT IS A BACKSPACE        44600002
***                                                                     44700002
         L     RWRK,XSAUBFRP            GET PTR TO NEXT CHAR     M0094  44800002
         CLI   K0(RWRK),BKSPCHAR        IS NEXT CHAR BACKSPACE          44900002
         BNE   TPT0830                  IF NOT                          45000002
         OI    TSBFLG3,TSBNBKSP         INDR FOR OUTPUT EDIT            45100002
         SPACE 2                                                        45200002
TPT0830  EQU   *                                                        45300002
***                                                             YS02019 45320002
***                 GO TO SUBROUTINE TO TPOST TSB AND POST TCAM YS02019 45330002
***                                                             YS02019 45340002
         BAL   RBUF,TPT9900             GO TO SUBROUTINE        YS02019 45350002
         SPACE 2                                                        48000002
TPT0900  EQU   *                                                        48100002
***                                                                     48200002
***                 WAIT ON ECB                                         48300002
***                                                                     48400002
         SR    RWRK,RWRK                                        YS02019 48500002
         ST    RWRK,TSBECB              CLEAR OUT ECB           YS02019 48550002
         IC    RWRK,TSBWTCB-K1          SAVE FLAGS                      48600002
         STCM  RTCB,SEVEN,TSBWTCB       STORE WAITING TCB ADDR   Y01018 48800002
         SETLOCK RELEASE,TYPE=CMS,RELATED=('BEFORE SVC')        YS02019 49340002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('BEFORE SVC')      YS02019 49360002
         WAIT  ECB=TSBECB,LONG=YES                              YS02019 49400002
         SPACE 2                                                        49500002
***                                                                     49600002
***                 UPON POST OF ECB                                    49700002
***                                                                     49800002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                 YS02019*49940002
               RELATED=(TSB,IGG09302(TPT9700))                  YS02019 49950002
         SETLOCK OBTAIN,TYPE=CMS,MODE=UNCOND,                   YS02019*50000002
               RELATED=(TSB,IGG09302(TPT9600))                  YS02019 50050002
         BAL   RBUF,TPT6000             CHECK USER'S STATUS      TS1634 50500002
         B     TPT0600                  RECHECK BFR AVAILABILITY        50600002
         SPACE 3                                                        50700002
TPT1000  EQU   *                                                        50800002
         SPACE 2                                                        50900002
*********************************************************************** 51000002
***                                                                   * 51100002
***            QTIP WILL NOW BE BRANCHED TO TO ACCOMPLISH             * 51200002
***                                                                   * 51300002
***                 1- FIND THE PROPER PLACE ON THE OUTPUT            * 51400002
***                    QUEUE TO PUT THE NEXT BFR.                     * 51500002
***                                                                   * 51600002
***                 2- PLACE FIRST FREE BUFFER ONTO OUTPUT QUEUE.     * 51700002
***                                                                   * 51800002
***                 3- UPDATE PTR AND COUNT OF OUTPUT QUEUE           * 51900002
***                                                                   * 52000002
***                 4- MOVE EITHER ALL REMAINING DATA, OR AS MUCH AS  * 52100002
***                    BUFFER WILL HOLD WHICHEVER IS LESS.            * 52200002
***                                                                   * 52300002
***                 5- UPDATE USER BUFFER SIZE AND POINTER IN SVRB    * 52400002
***                    EXTENDED SAVE AREA (XSUBFRS AND XSAUBFRP)      * 52500002
***                                                                   * 52600002
*********************************************************************** 52700002
         SPACE 2                                                        52800002
TPT1100  EQU   *                                                        53900002
         LA    RSAVE,MOVECODE           ENTRY CODE                      54000002
         L     RGOTO,TIOCQTIP           ENTRY POINT OF QTIP     YS02019 54040002
         LA    RAVT,TIOCSAVE            SAVE AREA FOR QTIP      YS02019 54200002
         BALR  RETURN,RGOTO             GO TO QTIP                      54300002
         SPACE 2                                                        54400002
***                                                                     54500002
***                 UPON RETURN FROM QTIP                               54600002
***                                                                     54700002
         SPACE                                                          54800002
         NI    XSAF,OFF-XSADMOVE        DATA MOVEMENT DONE      YS02019 54900002
         OI    XSAF,PSW+HSW             SHOW PART OF MSG ON Q    M0094  55000002
*                                       AND HEADER BFR DONE             55100002
         SPACE 2                                                        55300002
***                                                                     55400002
***                 CHECK FOR EOM                                       55500002
***                                                                     55600002
         SR    RBUF,RBUF                                         M0094  55700002
         CH    RBUF,XSAUBFRS            HAS ALL DATA BEEN MOVED  M0094  55800002
         BE    TPT9000                  DONE IF SO                      55900002
         LA    RBUF,TPT0600             SUBR WILL RETURN TO      Y01018 56800002
*                                       GET NEXT BUFFER                 56900002
         SPACE 4                                                        57000002
TPT6000  EQU   *                                                 TS1634 57100002
*********************************************************************** 57200002
****                                                                    57300002
****                SUBROUTINE TO CHECK USER'S STATUS                   57400002
****                                                                    57500002
*********************************************************************** 57600002
         LA    RWRK2,TPT7500            GET ABORT ADDR           Y01018 57700002
         TM    CVTTCMFG,CVTTCRDY        IS TCAM UP               TS0034 57800002
         L     RRPT,CVTAQAVT            TCX PTR FOR LATER TEST  YS02019 57850002
         BNOR  RWRK2                    ABORT IF TCAM NOT UP     Y01018 57900002
         TM    TSBSTAT,TSBINUSE         STILL ACTIVE            YS02019 58000002
         L     RRPT,TCXRPT-IEDQTCX(,RRPT) RPT PT FOR LATER TEST YS02019 58050002
         BNOR  RWRK2                    ABORT IF NOT ACTIVE      Y01018 58100002
         TM    TSBSTAT,TSBDISC          DISCONNECTING           YS02019 58110002
         BNZR  RWRK2                    YES, ABORT              YS02019 58120002
         LTR   RRPT,RRPT                TEST VALUE OF RPT PTR   YS02019 58130002
         BZR   RWRK2                    IF ZERO, TS DOWN        YS02019 58132002
         TM    TSBFLG4,TSBHUNG          USER HUNG UP            YS02019 58140002
         BNOR  RBUF                     NO, RETURN TO CALLER     Y01018 58500002
         SPACE 2                                                 TS1634 58600002
TPT7500  EQU   *                                                        58700002
***                                                                     58800002
***                 CALLED TASK NO LONGER ACTIVE RETURN                 58900002
***                                                                     59000002
         LA    RCODE,RCGONE             RETURN CODE                     59100002
         TM    XSAF,OSW                 SHOULD TSB BE RESET     YS02019 59150002
         BNO   TPT9625                  NO, DON'T RESET         YS02019 59170002
         B     TPT9600                  RETURN                          59200002
         SPACE 4                                                        59300002
TPT9000  EQU   *                                                        60900002
***                                                                     61000002
***                 SUCCESSFUL RETURN                                   61100002
***                                                                     61200002
         SR    RCODE,RCODE              INDICATE SUCCESS         YM0895 61400002
         STH   RCODE,XSARC              SAVE RETURN CODE        YS02019 61500002
         SPACE                                                          61800002
***                                                             YS02019 61820002
***                 GO TO TPOST SUBROUTINE                      YS02019 61830002
***                                                             YS02019 61840002
         BAL   RBUF,TPT9900             GO TO SUBROUTINE        YS02019 61850002
         SPACE 3                                                        63700002
TPT9100  EQU   *                                                        63800002
***                                                                     63900002
***                 CHECK TO SEE IF SMF IS UP                           64000002
***                                                                     64100002
         ICM   RWRK,B'0111',TCBTCTB     GET & TEST TCT ADDRESS  YS02019 64200002
         BZ    TPT9200                  IF NOT                          64500002
         SPACE 2                                                        64600002
***                                                                     64700002
***                 UPDATE LINE COUNT IF UP                             64800002
***                                                                     64900002
         USING SMFTCT,RWRK                                              65000002
         L     RWRK2,TCTLOUT            OLD COUNT                       65100002
         LA    RWRK2,K1(R0,RWRK2)       ADD ONE TO COUNT                65200002
         ST    RWRK2,TCTLOUT                                            65300002
         DROP  RWRK                                                     65400002
         SPACE 2                                                        65500002
TPT9200  EQU   *                                                        65600002
***                                                             YS02019 65618002
***        INFORM SYSTEM RESOURCE MANAGER OF SUCCESSFUL TPUT    YS02019 65627002
***                                                             YS02019 65636002
         LH    RWRK2,XSAPRMSZ           AMOUNT OF DATA SENT     YS02019 65645002
         LA    RAVT,TIOCSAVE            SAVE AREA PTR FOR SYSEV YS02019 65647002
         O     RWRK2,TSIPSIGN           HI BIT MEANS TPUT       YS02019 65654002
         SYSEVENT TGETTPUT,ASIDL=XSATJID,ENTRY=BRANCH           YS02019 65672002
         SPACE 2                                                        67200002
TPT9400  EQU   *                                                        67300002
***                                                                     67400002
***                 CHECK FOR WAITING ON OWAIT TASKS                    67500002
***                                                                     67600002
         TM    TSBFLG1,TSBWOWIP         ANY TASKS WAITING               67700002
         BZ    TPT9600                  IF NOT                          67800002
         SPACE 2                                                        67900002
***                                                                     67908002
***                 GO TO 'STATUS' TO REMOVE WAITING TASKS FROM OWAIT   67912002
***                                                                     67916002
***                 REGISTERS FOR STATUS -                              67920002
***                                                                     67924002
***                                                                     67928002
***            0 (R0) - HIGH HALF = ASID, LO HALF = ENTRY CODE (8)      67932002
***            1 (RWRK2) - HI BIT MUST BE ON, OTHERS OFF                67936002
***            13 (RAVT) - MASK OF SECONDARY BITS TO BE RESET           67940002
***            14,15 (RETURN, RGOTO) - CONVENTIONAL             YS02019 67944002
***                                                             YS02019 67948002
         LA    R0,STEPSD                ENTRY CODE TO RESET ALL YS02019 67952002
*                                       TASKS IN STEP           YS02019 67956002
         L     RGOTO,CVTABEND           PTR TO 2NDARY CVT       YS02019 67960002
         USING SCVTSECT,RGOTO                                   YS02019 67964002
         L     RWRK2,TSIPSIGN           HI BIT MEANS 'RESET'    YS02019 67968002
         ICM   R0,B'1100',XSAPRMTJ      ASID TO BE ACTIVATED    YS02019 67972002
         L     RGOTO,SCVTSTAT           ENTRY POINT OF STATUS   YS02019 67974002
         LA    RAVT,NDISPBIT            NONDISPATCHABILITY MASK YS02019 67976002
*                                       (TCBOWAIT, IN NDSP2)    YS02019 67980002
         BALR  RETURN,RGOTO             GO TO STATUS ROUTINE    YS02019 67988002
         SPACE 2                                                        72800002
TPT9600  EQU   *                                                        72900002
***                                                                     72910002
***                 CLEAN UP AND RETURN                                 72912002
***                                                                     72914002
         NI    TSBFLG1,OFF-(TSBOWIP+TSBTJIP) RELEASE TSB                72916002
         NI    TSBFLG3,OFF-TSBATTN      ATTN IGNORED INDR               72918002
         NI    TCBTSFLG,OFF-TCBTIOTG    ATTN HIT INDR                   72918102
         SPACE 2                                                YS02019 72918402
TPT9625  EQU   *                                                YS02019 72918802
***                                                             YS02019 72920002
***                 ALL DONE WITH CMS LOCK                      YS02019 72930002
***                                                             YS02019 72940002
         SETLOCK RELEASE,TYPE=CMS,RELATED=(TSB,IGG09302)        YS02019 72950002
         SPACE 1                                                        73600002
TPT9650  EQU   *                                                        73700002
***                                                                     73800002
***                TURN OFF TCBFX IF OFF AT ENTRY                       73900002
***                                                                     74000002
         TM    XSAF,XSATCBFX            SHOULD WE TURN OFF TCBFX M0094  74100002
         BZ    TPT9700                  SKIP IF NOT                     74200002
         NI    TCBFLGS1,OFF-TCBFX       ALLOW ASYNCHRONOUS EXITS        74300002
TPT9700  EQU   *                                                        74400002
***                                                             YS02019 74420002
***                 ALL DONE WITH LOCAL LOCK                    YS02019 74430002
***                                                             YS02019 74440002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=(TSB,IGG09302)      YS02019 74450002
         SPACE 2                                                        74500002
***                                                                     74600002
***                 DEQ FROM TJID TO RELEASE ENQUEUED TASKS             74700002
***                                                                     74800002
         SPACE                                                          74900002
         LR    RSAVE2,RCODE             SAVE RETURN CODE                75000002
         MVC   XSAENQNM(K12),QNAME      RESET ENQ/DEQ PARMS      M0094  75100002
         LA    RWRK2,XSAENQAD           GET ADDR OF ENQ WRK AREA M0094  75200002
         DEQ   (XSAENQNM,ASCBASID,2,SYSTEM),RET=HAVE,MF=(E,(1)) YS02019 75300002
         NI    XSAF,OFF-XSAIDENQ        RESET ASID ENQUEUE FLAG YS02019 75350002
         SPACE 2                                                        75400002
         LR    RCODE,RSAVE2             RESTORE RETURN CODE             75500002
         L     RETURN,XSARETRG          RESTORE RETURN ADDRESS  YS02019 75600002
         BR    RETURN                   RETURN TO SUPERVISOR    YS02019 75650002
         SPACE 5                                                YS02019 75800002
*********************************************************************** 75860002
***                                                                 *** 75920002
***                 SUBROUTINE TO TPOST TSB TO IEDAYP               *** 75980002
***                                                                 *** 76040002
*********************************************************************** 76100002
TPT9900  EQU   *                                                YS02019 76160002
         LM    RP0,RP1,TSBTPOST         GET TPOSTING FIELD      YS02019 76580002
         STM   RBUF,RCVT,XSAWD7         SAVE REGISTERS 2&3      YM03998 76630002
TPT9907  EQU   *                                                YS02019 76640002
         STM   RP0,RP1,XSAWD5           MOVE TO XSA TO SET BITS YS02019 76700002
         LA    RGOTO,XSAWD5             ADDRESSABILITY          YS02019 76760002
         USING TSBTPOST,RGOTO           NEXT REFERENCES TO TSB  YS02019 76820002
*                                       TPOST & BEYOND WILL     YS02019 76880002
*                                       REALLY BE TO XSA        YS02019 76940002
         SPACE 2                                                YS02019 77000002
***                                                             YS02019 77060002
***                 IF ALL OUTPUT IS ON QUEUE, TURN OFF         YS02019 77120002
***                 QCBPARTO. ELSE, TURN IT ON                  YS02019 77180002
***                                                             YS02019 77240002
         SR    RWRK,RWRK                ZERO WORK REGISTER      YM01246 77300002
         CH    RWRK,XSAUBFRS            REMAINING SIZE ZERO     YS02019 77360002
         BNE   TPT9910                  NO, TURN ON PARTO       YS02019 77420002
         TM    XSAF,XSAPARTO            HAS PARTO BEEN SET      YM01246 77470002
         BZ    TPT9915                  NO, NO NEED TO RESET    YM01246 77472002
         NI    TSBF1V,OFF-QCBPARTO      YES, TURN OFF PARTO     YS02019 77480002
         OI    TSBF1M,QCBPARTO          ACTION BIT FOR AYP      YM01246 77530002
         NI    XSAF,OFF-XSAPARTO        RESET PARTO FLAG        YM01246 77532002
         B     TPT9915                  SKIP                    YS02019 77540002
TPT9910  EQU   *                                                YS02019 77600002
         TM    XSAF,XSAPARTO            HAS PARTO BEEN SET      YM01246 77650002
         BO    TPT9915                  YES, NO NEED TO SET     YM01246 77652002
         OI    TSBF1V,QCBPARTO          TURN ON PARTO           YS02019 77660002
         OI    TSBF1M,QCBPARTO          ACTION BIT FOR AYP      YM01246 77710002
         OI    XSAF,XSAPARTO            SET PARTO FLAG IN WA    YM01246 77712002
         SPACE 2                                                YS02019 77780002
***                                                             YS02019 77840002
***                 TURN ON QCBTPUT.  IF BREAKIN REQUEST, AND   YS02019 77900002
***                 BREAKIN IS ALLOWED, TURN ON QCBWRBRK.       YS02019 77960002
***                                                             YS02019 78010002
TPT9915  EQU   *                                                YS02019 78060002
         TM    XSAOPTNS,MBREAK          BREAKIN REQUEST         YM01176 78062002
         BO    TPT9917                  YES, SKIP TSBTPUT TEST  YM01176 78064002
         TM    TSBFLG3,TSBTPUT          ALREADY DOING A TPUT    YM01246 78070002
         BZ    TPT9917                  NO, MUST TPOST          YM01246 78070402
         TM    TSBF1M,QCBPARTO          MUST PARTO BE SET       YM01246 78070802
         BZ    TPT9930                  NO, NO NEED TO TPOST    YM08378 78072002
TPT9917  EQU   *                                                YM01246 78074002
         OI    TSBF1V,QCBTPUT           SET TPUT VALUE          YS02019 78080002
         OI    TSBF1M,QCBTPUT           ACTION BIT FOR AYP      YM03998 78130002
         TM    XSAOPTNS,MBREAK          BREAKIN REQUEST         YS02019 78140002
         BNO   TPT9920                  NI, SKIP                YS02019 78200002
         TM    TSBFLG3,TSBNOBRK         BREAKIN ALLOWED         YS02019 78260002
         BO    TPT9920                  NO, SKIP                YM01114 78320002
         OI    TSBF1V,QCBWRBRK          SET VALUE BIT           YS02019 78380002
         OI    TSBF1M,QCBWRBRK          SET ACTION BIT          YS02019 78440002
TPT9920  EQU   *                                                YS02019 78500002
         OI    TSBTPFLG,TSBPOSTO+TSBTPQCB                       YS02019 78740002
*                                       TELL AYP TO TPOST QCB,  YS02019 78800002
*                                       SHOW A TPOST IS         YS02019 78860002
*                                       OUTSTANDING             YS02019 78920002
         SPACE 2                                                YS02019 78980002
***                                                                     79040002
***                 SET BITS IN REAL TSB, USING CDS.  IF TSBPOSTO       79100002
***                 WAS ON DURING SWAP, NO NEED TO DO ACTUAL            79160002
***                 TPOST                                               79220002
***                                                                     79280002
         LM    RBUF,RCVT,XSAWD5         GET NEW BITS            YS02019 79400002
         DROP  RGOTO                                            YS02019 79460002
         CDS   RP0,RBUF,TSBTPOST        TRY TO RESET BITS       YS02019 79520002
         BNE   TPT9907                  IF CHANGED, DO IT AGAIN YS02019 79580002
         OI    TSBFLG3,TSBTPUT          SET INDR FOR FUTURE     YS03998 79630002
         LTR   RP0,RP0                  TEST TSBPOSTO (THIS TST YS02019 79640002
*                                       DEPENDS UPON            YS02019 79700002
*                                       TSBPOSTO EQU X'80')     YS02019 79750002
         BM    TPT9930                  IF ON, DON'T TPOST.     YS02019 79760002
*                                       IEDAYP WILL PICK UP     YS02019 79820002
*                                       THESE FLAGS ANYWAY      YS02019 79880002
         SPACE 2                                                YS02019 79940002
***                                                                     80000002
***                TPOST THE TSB TO IEDAYP                              80060002
***                                                                     80120002
         L     RCVT,CVTPTR                                      YS02019 80180002
         L     RTCX,CVTAQAVT            GET TCX ADDRESS         YS02019 80240002
         USING IEDQTCX,RTCX                                     YS02019 80300002
         L     RWRK,TCXTSI              GET TSINPUT QCB ADDRESS YS02019 80360002
         USING IEDQTSI,RWRK                                     YS02019 80420002
         LA    RWRK,TSITSAP-(QCBSTVTO-IEDQQCB)                  YS02019 80480002
*                                       ADDRESS OF IEDAYP'S     YS02019 80540002
*                                       'QCB'                   YS02019 80600002
         ST    RWRK,TSBRQCB             QCB TO WHICH TSB WILL   YS02019 80660002
*                                       BE TPOSTED              YS02019 80720002
         L     RWRK,TCXREADY            GET CONTENTS OF READY Q YS02019 80780002
TPT9925  EQU   *                                                YS02019 80840002
         ST    RWRK,TSBLINKA            LINK TSB TO NEXT ELEM   YS02019 80900002
         MVI   TSBPRI,PRIDESTQ          SET PRIORITY            YS02019 80950002
         LA    RSAVE,TSBRCB             GET READY TO PUT ELEM   YS02019 80960002
*                                       ADDRESS INTO Q HEADER   YS02019 81020002
         CS    RWRK,RSAVE,TCXREADY      TRY TO ADD IT TO QUEUE  YS02019 81080002
         BNE   TPT9925                  NO GOOD, TRY AGAIN      YS02019 81140002
         SPACE 2                                           YS02019      81200002
***                                                                     81260002
***                CROSS-MEMORY POST TCAM'S ECB                         81320002
***                                                                     81380002
         SR    RRPT,RRPT                COMPLETION CODE         YS02019 81500002
         LA    RTJID,CVTBRET            'ERRET' ADDRESS         YS02019 81560002
         L     RAVT,TCXASCB             GET ASCB ADDRESS        YS02019 81620002
         LR    R0,RTCX                  SAVE TCX POINTER        YS02019 81860002
         L     RTCX,TCXAVT              GET AVT ADDRESS         YS02019 81920002
         DROP  RTCX                                             YS02019 81980002
         USING IEDQAVTD,RTCX                                    YS02019 82040002
         LA    RTCX,AVTOSECB            ECB POINTER FOR POST    YS02019 82100002
         DROP  RTCX                                             YS02019 82160002
         L     RGOTO,CVT0PT01           POST ROUTINE ADDRESS    YS02019 82280002
         O     RTCX,TSIPSIGN            HI-ORDER BIT = XMPOST   YS02019 82330002
         BALR  RETURN,RGOTO             GO TO POST ROUTINE      YS02019 82340002
         SPACE 2                                                YS02019 82400002
         LR    RTCX,R0                  RESTORE TCX POINTER     YS02019 82460002
         USING IEDQTCX,RTCX                                     YS02019 82520002
         LH    RTJID,TSBWTJID           RESTORE ASID OF CALLER  YS02019 82580002
         L     RRPT,TCXRPT              RESTORE RPT POINTER     YS02019 82640002
         SPACE 2                                                YS02019 82820002
***                                                             YS02019 82880002
***                 RETURN TO SUBROUTINE CALLER                 YS02019 82940002
***                                                             YS02019 83000002
TPT9930  EQU   *                                                YS02019 83060002
         LM    RBUF,RCVT,XSAWD7         RESTORE REGISTERS       YS02019 83120002
         BR    RBUF                     RETURN                  YS02019 83180002
         EJECT                                                  YS02019 83240002
*****                                                                   83600002
*****               CONSTANTS                                           83700002
*****                                                                   83800002
NEWLINE  DC    X'15'                    NEW LINE CHAR FOR BLANK LINE    85200002
TSIPSIGN DS    0F                       ALIGN ON FULLWORD BDY    Y01018 85300002
         DC    X'80000000'              TPUT SIGN FOR TSIP              85400002
QNAME    DC    C'SYSZIGGI'              ENQ DEQ QNAME           YS02019 85500002
         DC    X'FF000000'              DEQ/ENQ PARM LIST               85600002
PATCHREA DC    10F'0'                   PATCH AREA               Y01018 85700002
         EJECT                                                          87000002
*****                                                                   87100002
*****               THE FOLLOWING DSECTS ARE USED BY THIS MODULE        87200002
*****                                                                   87300002
         IHAASCB                                                YS02019 87340002
         EJECT                                                  YS02019 87360002
         IHAASVT                                                YS02019 87370002
         EJECT                                                  YS02019 87390002
         TAVTD                                                  YS02019 87392002
         EJECT                                                  YS02019 87394002
         IKJTIOCB                                                       87400002
         EJECT                                                          87500002
CSCB     DSECT                                                  YS02019 87520002
         IEECHAIN                                               YS02019 87530002
         EJECT                                                  YS02019 87540002
CVT      DSECT                                                          87600002
         CVT                                                            87700002
         EJECT                                                          87710002
         TPRIOR                                                 YS02019 87750002
         EJECT                                                  YS02019 87760002
         IHAPSA                                                 YS02019 87820002
         EJECT                                                  YS02019 87830002
         TQCBD                                                  YS02019 87840002
         EJECT                                                  YS02019 87850002
         IKJRB                                                          87900002
***                                                                     88000002
***      EXTENDED SAVE AREA.  THSES STATEMENTS SHOULD FOLLOW            88100002
***      THE MACRO 'IKJRB.'                                             88200002
***                                                                     88300002
         ORG   RBEXSAVE                 START OF SAVE AREA       M0094  88400002
XSAPRM0  DS    0F                       REG 0 AT ENTRY           M0094  88500002
XSAPRMTJ DS    H                        TJID PASSED              M0094  88600002
XSAPRMSZ DS    H                        SIZE PASSED              M0094  88700002
XSAPRM1  DS    0F                       REG 1 AT ENTRY           M0094  88800002
XSAOPTNS DS    X                        USER OPTIONS             M0094  88900002
MASIS    EQU   X'01'                    ASIS OPTION SPECIFIED    M0094  89000002
MCNTRL   EQU   X'02'                    1 MEANS CONTROL          M0094  89100002
*                                                                       89200002
*   BOTH OF THE ABOVE BITS OFF MEANS EDIT OPTION                        89300002
*                                                                       89400002
MBREAK   EQU   X'04'                    BREAKIN SPECIFIED        M0094  89500002
MHOLD    EQU   X'08'                    1 MEANS HOLD             M0094  89600002
MTGET    EQU   X'80'                    1 MEANS TGET REQUESTED   M0094  89700002
MUSERP   EQU   X'40'                    USERID SPECIFIED        YS02019 89800002
MLOWP    EQU   X'20'                    0 HIGHPRI, 1 LOWPRI      M0094  89900002
MWAIT    EQU   X'10'                    1 MEANS NOWAIT           M0094  90000002
         DS    AL3                      REST OF REGISTER ONE     M0094  90100002
XSAWD3   DS    0F                       FOR SAVING REGISTERS     M0094  90200002
XSAFLAG  DS    X                        FLAG PASSED BY 9C TO 01  M0094  90300002
*                                       AND 02                   M0094  90400002
XSATCBFX EQU   X'20'                    TURN OFF TCBFX AT EXIT   M0094  90500002
         DS    AL3                      REST OF WORD             M0094  90600002
         ORG   XSAWD3+2                 INPUT ED, OUTPUT MOVE    M0094  90700002
XSAUBFRS DS    H                        AMT DATA LEFT TO MOVE    M0094  90800002
XSAUBFRP DS    0F                       LOC DATA LEFT TO MOVE    M0094  90900002
XSAESTAL DS    CL16                     LIST FOR ESTAE MACRO    YS02019 90950002
         ORG   XSAUBFRP+4               USED FOR SAVE AREA WHEN YS02019 91800002
*                                       NOT NEEDED BY ESTAE     YS02019 91900002
XSAWD5   DS    F                        FOR SAVING REGISTERS     M0094  92000002
XSAWD6   DS    F                        FOR SAVING REGISTERS     M0094  92100002
         ORG   XSAWD5                   USE WORDS 5-6 FOR NAME   M0094  92200002
XSAENQNM DS    CL8                      ENQ NAME FOR TJID TPUT   M0094  92300002
XSAWD7   DS    F                        FOR SAVING REGISTERS     M0094  92400002
XSAWD8   DS    F                        FOR SAVING REGISTERS     M0094  92500002
         ORG   XSAWD7                   USE WDS 7-8 FOR ENQ PRMS M0094  92600002
XSAENQAD DS    2F                       WORK AREA FOR ENQ/DEQ    M0094  92700002
XSAUSERP DS    0F                       PTR TO USERID, IF PRES  YS02019 92750002
XSAWD9   DS    F                        FOR SAVING REGISTERS     M0094  92800002
XSARETRG DS    0F                       FOR SAVING RETURN ADDR  YS02019 92850002
XSAWD10  DS    F                        FOR SAVING REGISTERS     M0094  92900002
         DS    CL1                      RESERVED                YS02019 92950002
XSAUSERK DS    CL1                      SVC CALLER'S KEY        YS02019 92970002
XSARC    DS    H                        RETURN CODE SAVE AREA   YS02019 93000002
XSATJID  DS    H                        CALLER'S TJID            M0094  93100002
XSAFLAG2 DS    X                        FLAGS                   YM05387 93150002
XSAATR   EQU   X'80'                    NEXT CHAR IN TS BUFFER   S22028 93260002
*                                       IS A 3270 ATTRIBUTE BYTE        93270002
XSABFRAL EQU   X'40'                    TIOC BUFFER HASS BEEN   YM05387 93272002
*                                       ALLOCATED               YM05387 93274002
XSA15D   EQU   X'20'                    CHANGE COMPLETION CODE  YM05387 93276002
*                                       TO 15D                  YM05387 93278002
*                  NEXT 5 BITS UNUSED                           YM05387 93280002
XSAF     DS    X                        FLAGS USED BY TPUT. INI- M0094  93300002
*                                       TIALIZED FROM XSAFLAG.          93400002
HSW      EQU   X'80'                    HEADER BFR DONE          M0094  93500002
PSW      EQU   X'40'                    NEED TO TPOST QCB        M0094  93600002
*SATCBFX EQU   X'20'                    TURN OFF TCBFX AT EXIT          93700002
OSW      EQU   X'10'                    TSBOWIP TURNED ON BY US  M0094  93800002
XSADMOVE EQU   X'08'                    DATA BEING MOVED        YS02019 93970002
XSAAUTH  EQU   X'04'                    USER IS AUTHORIZED      YS02019 94040002
*                                       (NOT SOME OTHER TPUT)           94200002
XSAIDENQ EQU   X'02'                    ASID TPUT ASID ENQUEUED YS02019 94250002
XSAPARTO EQU   X'01'                    QCBPARTO IS SET ON      YM01246 94260002
         EJECT                                                          94300002
         IHASCVT                                                YS02019 94400002
         EJECT                                                  YS02019 94500002
         IKJTCB                                                         94700002
         EJECT                                                          94800002
         IEFTCT                                                         94900002
         EJECT                                                          95000002
         TTCXD                                                  YS02019 95200002
         EJECT                                                  YS02019 95300002
         IKJTIOCP                                                       96100002
         EJECT                                                          96200002
         IKJTSB                                                         96300002
         EJECT                                                          96400002
         TTSID                                                  YS02019 96600002
         END                                                            97100002
