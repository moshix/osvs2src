         TITLE 'IFFAFA04 -- STPOS/MVPOS MODULE'             D11         00100000
*                                                                       00200000
*        STPOS AND MVPOS ARE ENTERED FROM DIRECTOR PART 2 WITH THE      00300000
*        ADDRESS OF A WORK AREA IN REGISTER 1.  THE FIRST WORD OF THE   00400000
*        WORK AREA CONTAINS THE ADDRESS OF THE PARAMETER LIST BELOW.    00500000
*                                                                       00600000
*                             STPOS AND MVPOS                           00700000
*                                                                       00800000
*                             INPUT PARAMETER LIST                      00900000
*                                                                       01000000
*                             +0  A(GDSVAR)                             01100000
*                             +4  A(X-COORD)                            01200000
*                             +8  A(Y-COORD)                            01300000
*                             +12 A(CORVAL)                             01400000
*                             +16 A(KEY)                                01500000
*                             +20 A(GENCODE)                            01600000
*                                                                       01700000
*        EXTERNAL ROUTINES CALLED:                                      01800000
*                                                                       01900000
*        SCALE-IFFAHA06                                                 02000000
*        SCISSOR-IFFAHA07                                               02100000
*        KEY TABLE MANAGEMENT- IFFAHA03                                 02200000
*        DATA GENERATOR-IFFAHA04                                        02300000
*        UPDATE-IFFAHA13 AND IFFAHA14                                   02400000
*        EXTERNAL MACROS USED:                                          02500000
*                                                                       02600000
*        LINK                                                           02700000
*                                                                       02800000
         EJECT                                                          02900000
*        MVPOS AND STPOS WILL SPEND A GOOD PORTION OF ITS TIME          03000000
*        BUILDING A PARAMETER LIST WHICH IS USED AS THE INPUT           03100000
*        PARAMETER LIST TO SCALE, SCISSOR, DATA GENERATOR, AND          03200000
*        UPDATE.                                                        03300000
*                                                                       03400000
*        WORD 0 IS THE KEY WHICH IS RETURNED TO THE USER.  THE FIRST    03500000
*        HALFWORD CONTAINS THE LENGTH OF THE ELEMENT AND THE SECOND     03600000
*        HALFWORD CONTAINS THE LOGICAL START ADDRESS OF THE ELEMENT.    03700000
*                                                                       03800000
*        WORD 1 CONTAINS BIT SWITCHES.                                  03900000
*        BIT 0: 0=SINGLE ENTRY/1=MULTIPLE ENTRY                         04000000
*        BIT 1: INITIALIZED TO ZERO.  SET BY DATA GEN TO SHOW IF        04100000
*        FOR A SINGLE ENTRY IF THE DATA CONTAINS A SET MODE ORDER.      04200000
*        BITS 2,3,4:                                                    04300000
*        000 IS VECTOR INPUT                                            04400000
*        010 IS POINT INPUT                                             04500000
*        BIT 5: 0=OMIT/1=INCLUDE                                        04600000
*        BITS 6&7:                                                      04700000
*        00 IS ABSOLUTE OUTPUT                                          04800000
*        01 IS INCREMENTAL OUTPUT                                       04900000
*        11 IS OPTIMIZED OUTPUT                                         05000000
*        BITS 8-15: ARE RESERVED AND INITIALIZED TO ZERO. DATA          05100000
*        GEN WILL PLACE THE BYTE OF DATA CONTAINING THE BEAM BIT        05200000
*        HERE IF IT IS A SINGLE ENTRY WHICH IS KEYED OR CORRELATED.     05300000
*        BITS 16&17:                                                    05400000
*        00 IS FIRST PASS                                               05500000
*        01 IS NOT FIRST PASS, NOT LAST PASS                            05600000
*        11 IS LAST PASS                                                05700000
*        FOR SINGLE ELEMENTS THIS IS SET TO FIRST PASS.                 05800000
*        BIT 18: 0=DATA NOT KEYED/1=DATA KEYED                          05900000
*        BIT 19: 0=DATA NOT CORRELATED/1=DATA CORRELATED                06000000
*        BIT 20: 0=BEAM OFF/1=BEAM ON                                   06100000
*        BIT 21: 0=REPOSITION/1=NO REPOSITIONING                        06200000
*        BITS 22&23: RESERVED AND SET TO ZERO                           06300000
*        BIT 24: 0=NOT PART OF A SUBROUTINE/1:PART OF A SUBROUTINE      06400000
*        BIT 25: 0=NOT PART OF A SEQUENCE/1=PART OF A SEQUENCE          06500000
*        BITS26-31: RESERVED AND SET TO ZERO                            06600000
*                                                                       06700000
*                                                                       06800000
*                                                                       06900000
         EJECT                                                          07000000
*        WORD 2 CONTAINS THE CORVAL                                     07100000
*                                                                       07200000
*        WORD 3 CONTAINS THE ADDRESS OF THE KEY.                        07300000
*                                                                       07400000
*        WORD 4 CONTAINS THE ADDRESS OF THE GDSCB.                      07500000
*                                                                       07600000
*        WORDS5,6,7&8: ARE SET TO ZERO AND IF A POSITIONING             07700000
*        VECTOR IS REQUIRED BECAUSE OF PREVIOUS SCISSORING, SCISSOR     07800000
*        WILL FILL THE FIELDS IN WITH X ABSOLUTE, Y ABSOLUTE,           07900000
*        X INCREMENTAL, AND Y INCREMENTAL FOR THE POSITIONING           08000000
*        VECTOR.                                                        08100000
*                                                                       08200000
*        WORD 9 CONTAINS X ABSOLUTE.                                    08300000
*                                                                       08400000
*        WORD 10 CONTAINS Y ABSOLUTE.                                   08500000
*                                                                       08600000
*        WORD 11 CONTAINS X INCREMENTAL.                                08700000
*                                                                       08800000
*        WORD 12 CONTAINS Y INCREMENTAL.                                08900000
*                                                                       09000000
*        THE ABOVE WORDS WILL BE SET FROM THE INPUT PASSED AS EITHER    09100000
*        INCREMENTAL OR ABSOLUTE IN USERS UNITS.  SCALE WILL CONVERT    09200000
*        TO RASTER UNITS AND FILL IN THE FORM NOT PASSED.               09300000
*                                                                       09400000
*        WORD 13 CONTAINS THE TOTAL X INCREMENT THUS FAR.               09500000
*                                                                       09600000
*        WORD 14 CONTAINS THE TOTAL Y INCREMENT THUS FAR.               09700000
*                                                                       09800000
*        THE ABOVE WORDS ARE USED IF AN INCREMENTAL REPOSITIONING       09900000
*        VECTOR IS REQUIRED TO REPOSITION WHEN THE ELEMENT IS IN        10000000
*        OMIT STATUS.                                                   10100000
*                                                                       10200000
*        WORD 15 CONTAINS THE ELEMENT COUNT.  IT IS SET TO ZERO         10300000
*        ORIGINALLY AND INCREMENTED BY SCALE. IF THERE IS A             10400000
*        SCALING OR SCISSORING ERROR THE ELEMENT NUMBER IS PLACED       10500000
*        IN THE RETURN ARRAY.                                           10600000
*                                                                       10700000
*                                                                       10800000
         EJECT                                                          10900000
IFFAFA04 CSECT                     ENTRY FOR STPOS                      11000000
*0876,230000                                                            11100000
*0514,157000-159000                                                000A 11200000
*2101                                                              5489 11300000
*D308600,D311600                                                 YM1963 11400000
*C315000-317000,320000,325000-327000,330000,A497200-497400  D11 ZA15418 11500000
*A479100-479800,C480000,C483000                             E12 ZA28573 11550000
         ENTRY IFFAFA17                                                 11600000
         NOPR  0                                                        11700000
IFFAFA17 SAVE  (14,12)             ENTRY FOR MOVPOS                     11800000
         BALR  BASE,0                                                   11900000
         USING *,BASE                                                   12000000
         L     REGB,ENTRYADD                                            12100000
         LA    REGFIFTN,0(REGFIFTN)                                     12200000
         SR    REGB,REGFIFTN       REGB=0 ENTRY BY MOVPOS               12300000
*                                  REGB=2 ENTRY BY SETPOS               12400000
         LR    WORK,PARM           WORK CORE                            12500000
         USING WORKAREA,WORK                                            12600000
         L     ERRREG,WRKRTNCD                                          12700000
         XC    ZERO(20,ERRREG),ZERO(ERRREG) ZERO RTN ARRAY              12800000
         L     PARM,WRKPARM        PARAMETER LIST                       12900000
         ST    SAVE,WRKSAVE+4                                           13000000
         LA    REGA,WRKSAVE                                             13100000
         ST    REGA,EIGHT(SAVE)    CHAIN SAVE AREAS                     13200000
         LR    SAVE,REGA                                                13300000
         XC    WRKSPVSR(12),WRKSPVSR ZERO SUPERVISOR PARAMETER LIST     13400000
         L     GDSREG,GDSPARM(PARM)                                     13500000
         L     GDSREG,ZERO(GDSREG) REMOVE GDSCB ADDR FROM VARIABLE      13600000
         USING GDSCB,GDSREG                                             13700000
         CLI   GDSGDSID,GDSIDSW    GDSCB VALID                          13800000
         BNE   ERR1                                                     13900000
         ST    REGB,WRKSWTCH       ZERO SWITCH EXCEPT SET ENTRY TYPE    14000000
         MVC   WRKSWTCH+2(1),GDSDATMD SAVE DATA A MODE SWITCH           14100000
         SR    REGA,REGA                                                14200000
         EJECT                                                          14300000
*                                                                       14400000
*              FIRST OF ALL A COUNT OF THE PARAMETERS IS MADE.          14500000
*              THE PRESENCE OF THE REQUIRED PARAMETERS IS THEN          14600000
*              VERIFIED AND THEY ARE PLACED IN THE DATA ARRAY           14700000
*                                                                       14800000
POS00010 TM    ZERO(PARM),LSTPARM  LOOP TO COUNT PARMS EXCEPT GDS       14900000
         BO    POS00020                                                 15000000
         LA    REGA,ONE(REGA)      ADD TO COUNT                         15100000
         LA    PARM,FOUR(PARM)                                          15200000
         B     POS00010                                                 15300000
POS00020 C     REGA,REQCT          TOO FEW PARAMETERS                   15400000
         BL    ERR1A2              YES                                  15500000
         C     REGA,MAXCT          TOO MANY PARMS                       15600000
         BH    ERR1A2              YES                                  15700000
         L     PARM,WRKPARM        START OF PARM LIST                   15800000
         L     GTMREG,GDSGTMCB     GTMCB ADDR                           15900000
         USING GTMCB,GTMREG                                             16000000
         L     REGB,GTMGSPCB       GSPCB ADDR                           16100000
         USING GSPCB,REGB                                               16200000
         LA    REGB,GSPNULLV       NULL VARIABLE                        16300000
         DROP  REGB                                                     16400000
         LR    COUNT,REGA          CT OF PARMS                          16500000
         LA    REGA,ONE                                                 16600000
         CLC   1(3,REGB),UPARM+1(PARM) UVAL MISSISN                     16700000
         BE    ERR1A               YES                                  16800000
         CLC   1(3,REGB),VPARM+1(PARM) VVAL MISSISN                     16900000
         LA    REGA,ONE(REGA)      INCR CT                              17000000
         BE    ERR1A                                                    17100000
         S     COUNT,REQCT         NO OF ADDL PARMS                     17200000
         XC    WRKADDR(LISTLEN),WRKADDR ZERO OUT DATA LIST              17300000
         MVC   WRKRTN,WRKRTNCD     MOVE IN ADDR OF RTN ARRAY            17400000
         MVC   WRKBITS(FOUR),BITS  MOVE IN DEFAULT SETTINGS             17500000
         L     REGA,UPARM(PARM)    ADDR OF U PARM                       17600000
         TM    GDSFLAGS,SUBR       IS THIS PART OF A BUFFER SUBR        17700000
         BZ    POS00023            YES                                  17800000
         OI    WRKBITS+3,MEMSUB    SET FLAG IN KEY                      17900000
         B     POS00027                                                 18000000
         EJECT                                                          18100000
POS00023 TM    GDSFLAGS,SEQ        PART OF A SEQUENCE                   18200000
         BZ    POS00025            NO                                   18300000
         OI    WRKBITS+3,MEMSEQ    YES SET FLAG IN KEY                  18400000
POS00025 TM    WRKSWTCH+3,SET      SET POSITION                         18500000
         BO    POS00330                                                 18600000
         TM    GDSDATMD,INCRU      U INCR                               18700000
         BZ    POS00200            NO                                   18800000
POS00027 MVC   WRKXINCR(FOUR),ZERO(REGA) PLACE IN ARRAY                 18900000
POS00030 L     REGA,VPARM(PARM)    ADDR OF V PARM                       19000000
         TM    WRKBITS+3,MEMSUB    IS THIS A SUBROUTINE MEMBER          19100000
         BO    POS00035            INCREMENTAL IF YES                   19200000
         TM    GDSDATMD,INCRV      V INCR                               19300000
         BZ    POS00210            NO                                   19400000
POS00035 MVC   WRKYINCR(FOUR),ZERO(REGA) PLACE IN ARRAY                 19500000
         SPACE 3                                                        19600000
*                                                                       19700000
*              THE OPTIONAL PARAMETERS ARE CHECKED NEXT. CORVAL         19800000
*              AND KEY IF PRESENT ARE PLACED IN THE KEY.  THE           19900000
*              LEVEL 2 KEY IF PASSED WILL NOT SET A FLAG IN THE         20000000
*              INPUT PARM LIST BECAUSE THE INCLUDE OMIT STRUCTURE       20100000
*              IS NOT DESIRED.                                          20200000
*                                                                       20300000
POS00040 LTR   COUNT,COUNT         ANY OPTIONAL PARMS                   20400000
         BZ    POS00100            NO                                   20500000
         CLC   1(3,REGB),CORVAL+1(PARM) CORVAL PASSED                   20600000
         BE    POS00050            NO                                   20700000
         TM    GDSFLAGS,LEVEL2     LEVEL 2                              20800000
         BO    POS00050            CORVAL ON LEVEL 2 = IGNORD           20900000
         L     REGA,CORVAL(PARM)   ADDR OF CORVAL                       21000000
         MVC   WRKCORVL(FOUR),ZERO(REGA) MOVE IN CORVAL                 21100000
         OI    WRKBITS+2,CORV      SET CORVAL SW                        21200000
POS00050 BCTR  COUNT,0             REDUCE COUNT                         21300000
         LTR   COUNT,COUNT         ALL CHECKED                          21400000
         BZ    POS00070                                                 21500000
         CLC   1(3,REGB),KEY+1(PARM) KEY PASSED     D                   21600000
         BE    POS00060                                                 21700000
         MVC   WRKKEY(FOUR),KEY(PARM) MOVE IN KEY ADDR                  21800000
         TM    GDSFLAGS,LEVEL2     LEVEL 2 KEY                          21900000
         BO    POS00060                                                 22000000
         OI    WRKBITS+2,KEYSW     SET KEY PASSED SW                    22100000
         EJECT                                                          22200000
*                                                                       22300000
*              THE GENCODE IS CHECKED.  A KEY OR CORVAL IS REQUIRED     22400000
*              FOR CODES 2 AND 3. CODE 2, OMIT, IS NOT VALID FOR        22500000
*              A LEVEL 2 GDS.  FOR UPDATE  THE FOLLOWING CONDITIONS     22600000
*              ARE CHECKED. UPDATE CANNOT BE CALLED BETWEEN BEGIN       22700000
*              AND END SUBROUTINE BECAUSE OF THE INCREMENTAL INPUT/     22800000
*              OUTPUT REQUIREMENT. IF THE UPDATE IS OF AN ELEMENT       22900000
*              WHICH IS PART OF A SUBROUTINE, THE INPUT IS EXPECTED     23000000
*              TO BE INCREMENTAL AND THE OUTPUT WILL BE INCREMENTAL.    23100000
*                                                                       23200000
POS00060 BCTR  COUNT,0             REDUCE COUNT                         23300000
         LTR   COUNT,COUNT                                              23400000
         BZ    POS00070                                                 23500000
         CLC   1(3,REGB),GENCODE+1(PARM) GENCODE PASSED                 23600000
         BE    POS00070            NO                                   23700000
         L     REGA,GENCODE(PARM)  ADDR OF GENCODE                      23800000
         L     REGA,ZERO(REGA)     LOAD CODE                            23900000
         C     REGA,ZEROFLD        CODE VALID                           24000000
         BNH   ERR1D               NO                                   24100000
         C     REGA,FOURFLD        CODE VALID                           24200000
         BNL   ERR1D               NO                                   24300000
         C     REGA,ONEFLD         INCLUDE                              24400000
         BE    POS00070                                                 24500000
         CLC   WRKCORVL(8),ZEROFLD KEY OR CORVAL                        24600000
         BZ    ERR1D                                                    24700000
         C     REGA,TWOFLD         OMIT                                 24800000
         BNE   POS00080                                                 24900000
         TM    GDSFLAGS,LEVEL2     LEVEL2                               25000000
         BO    ERR1D               OMIT INVALID FOR LEVEL 2             25100000
         NI    WRKBITS,OMIT        TURN OFF INCLUDE SW                  25200000
POS00070 TM    WRKBITS+2,CORV      CORVAL                               25300000
         BZ    POS00100                                                 25400000
         CLC   WRKCORVL(FOUR),ZEROFLD CORVAL ZERO?                      25500000
         BE    ERR1C               INVALID CORVAL                       25600000
         B     POS00100                                                 25700000
POS00080 TM    GDSFLAGS,SUBR       SUBR GEN NOW                         25800000
         BO    ERR1A2              YES, THIS CALL IS ILLOGICAL          25900000
         TM    GDSFLAGS,LEVEL2     LEVEL 2                              26000000
         BO    POS00220                                                 26100000
         TM    WRKBITS+2,KEYSW                                          26200000
         BZ    POS00230                                                 26300000
         L     REGA,KEY(PARM)      LOAD KEY ADDR                        26400000
         EJECT                                                          26500000
*//                                                                     26600000
*//      SEARCH ON KEY IN KEY TABLE                                     26700000
*//                                                                     26800000
         ST    REGA,WRKKADDR       KEY IN PARM LIST                     26900000
         ST    GDSREG,WRKGDS1      GDSCB ADDR                           27000000
         LA    REGA,TWOFLD         CODE TO SEARCH ON KEY                27100000
         ST    REGA,WRKCODE                                             27200000
POS00085 LA    PARM,WRKGDS1                                             27300000
         L     REGA,GTMGSPCB       GET POINTER TO GSPCB            000A 27400000
         L     REGA,FE(REGA)       GET POINTER TO STATUS TABLE     000A 27500000
         L     REGFIFTN,ETE(REGA)  GET A&RS OF KEY TABLE MGMT      000A 27600000
         BALR  RETURN,REGFIFTN     BRANCH TO KEY TABLE MGMT        000A 27700000
         LTR   REGFIFTN,REGFIFTN   SUCCESS                              27800000
         BNE   ERR1A2              NO                                   27900000
POS00090 MVC   WRKADDR(FOUR),ZERO(PARM) MOVE IN LOG ADDR & LEN          28000000
         OC    WRKBITS+3(1),7(PARM) PICK UP SWITCH FOR PART OF SEQ OR S 28100000
         ST    PARM,WRKKEY         SAVE ADDR OF KEY IN KEY TALE         28200000
         TM    WRKBITS+3,MEMSUB    PART OF A SUBROUTINE                 28300000
         BZ    POS00095            NO CONTINUE ON                       28400000
         XC    WRKXABS(16),WRKXABS SSET DATA ARRAY TO ZERO TO REINIT    28500000
         L     PARM,WRKPARM        RESET REG1                           28600000
         L     REGB,UPARM(PARM)    LOAC ADDR OF U                       28700000
         MVC   WRKXINCR,0(REGB)    PLACE X IN LOC FOR INCREMENTAL       28800000
         L     REGB,VPARM(PARM)    LOAD ADDR OF V                       28900000
         MVC   WRKYINCR,0(REGB)    MOVE IN Y INCREMENT                  29000000
POS00095 MVI   WRKSWTCH,UPDATE     SET UPDATE SW                        29100000
         EJECT                                                          29200000
*                                                                       29300000
*              THE OUTPUT MODE IS NEXT SET.  THE SPECIAL CASES ARE      29400000
*              HANDLED SEPARATELY.  BUFFER SUBR- OUTPUT ALWAYS          29500000
*              INCREMENTAL.   STPOS (EXCEPT IN A BUFFER SUBR)           29600000
*              ALWAYS ABSOLUTE. MVPOS SET AS PER GDSGRMOD.              29700000
*                                                                       29800000
POS00100 TM    WRKBITS+3,MEMSUB    MEMBER OF A SUBROUTINE               29900000
         BO    POS00370            YES, CHANGE SW FOR MODE              30000000
         TM    GDSCURMD,ABS        OUTPUT ABS                           30100000
         BO    POS00120            YES-ALREADY SET                      30200000
         TM    WRKSWTCH+3,SET      SETPOS YES-ABS OUTPUT                30300000
         BO    POS00120                                                 30400000
         TM    GDSCURMD,OPT        OPTIMIZE                             30500000
         BZ    POS00110            NO                                   30600000
         OI    WRKBITS,OPTIHALF    SET HALF OF OPT SW                   30700000
POS00110 OI    WRKBITS,OPTINCR     SET OTHER HALF OR INCRE SW           30800000
         SPACE 3                                                        30900000
*                                                                       31000000
*              THE BEAM POSITIONS AND SCISSOR FLAGS ARE SAVED           31100000
*              IN CASE OF FAILURE. THEN THE DATA IS SCALED.             31200000
*              THE SCALE ROUTINE WILL COMPLETE THE DATA ARRAY           31300000
*              AND SET IT UP FOR SCISSOR.                               31400000
*                                                                       31500000
POS00120 ST    GDSREG,WRKGDS                                            31600000
         MVC   WRKXCURR,GDSXCURR   SAVE GDSCB FIELDS WHICH SCALE        31700000
         MVC   WRKYCURR,GDSYCURR   AND SCISSOR MAY CHANGE SO            31800000
         MVC   WRKXLAST,GDSXLAST   THAT IN CASE OF NO GENERATION        31900000
         MVC   WRKYLAST,GDSYLAST   THEY MAY BE RESET TO WHAT THEY       32000000
         MVC   WRKSWTCH+1(ONE),GDSSCISS WERE BEFORE THE CALL            32100000
*//                                                                     32200000
*//      CALL SCALE                                                     32300000
*//                                                                     32400000
         LA    PARM,WRKGDS         PARM LIST                            32500000
         L     REGFIFTN,STAT(ERRREG) STATUS TABLE                       32600000
         L     REGFIFTN,SCALE(REGFIFTN) ADDR OF SCALE                   32700000
         BALR  RETURN,REGFIFTN                                          32800000
         LTR   REGFIFTN,REGFIFTN   SUCCESS                              32900000
         BNE   POS00180                                                 33000000
         EJECT                                                          33100000
*              IF THE NO SCISSORING OPTION IS REQUESTED THE             33200000
*              GDSXLAST, YLAST, XCURR, AND YCURR OPTIONS                33300000
*              MUST BE UPDATED AND THE LAST ON SCREEN SWITCH            33400000
*              MUST BE SET. IF IT IS A BUFFER SUBROUTINE, NO            33500000
*              SCISSORING OR FIELD UPDATE WILL TAKE PLACE.              33600000
*              ALL OTHER CASES WILL GO TO THE SCISSOR ROUTINE.          33700000
*                                                                       33800000
POS00158 TM    GDSFLAGS,SUBR                                            33900000
         BO    POS00160            SUBR NO SCISS OR PTR UPDATING        34000000
         TM    GDSSCISS,NOSCISS                                         34100000
         BO    POS00240                                                 34200000
*//                                                                     34300000
*//      CALL SCISSOR                                                   34400000
*//                                                                     34500000
         LA    PARM,WRKGDS         ADDR OF PARM LIST                    34600000
         L     REGFIFTN,STAT(ERRREG)    STATUS TABLE                    34700000
         L     REGFIFTN,SCISS(REGFIFTN) ADDR OF SCISSOR                 34800000
         BALR  RETURN,REGFIFTN                                          34900000
         LTR   REGFIFTN,REGFIFTN                                        35000000
         BNE   ERR4BTAB(REGFIFTN)      USE BRANCH TABLE            9328 35100000
*                                                                       35200000
*              THE VECTOR THAT MAY HAVE BEEN GENERATED BY               35300000
*              SCISSORING AS A POSITIONING VECTOR IS ADDED              35400000
*              TO THE ACTUAL VECTOR BECAUSE BOTH ARE BLANKED.           35500000
*              THE DATA IS THEN GENERATED.                              35600000
*                                                                       35700000
         L     REGA,WRKXINCR                                            35800000
         A     REGA,WRKDATA3       ADD TO  POSITIONING                  35900000
         ST    REGA,WRKXINCR       NEW X INCR                           36000000
         L     REGA,WRKYINCR                                            36100000
         A     REGA,WRKDATA4       ADD TO POSITIONING                   36200000
         ST    REGA,WRKYINCR       NEW Y INCR                           36300000
         XC    WRKDATA1(16),WRKDATA1 ZERO POSITIONING VECT              36400000
         SPACE 3                                                        36500000
*                                                                       36600000
*              IF UPDATE, THE UPDATE MODULE IS CALLED TO SET            36700000
*              UP THE OUTPUT AREA FOR THE NEW DATA.                     36800000
*              IF NOT, THE LOGICAL START ADDRESS IS PLACED IN           36900000
*              THE KEY.                                                 37000000
*                                                                       37100000
POS00160 CLI   WRKSWTCH,UPDATE     UPDATE                               37200000
         BE    POS00280            YES, GO TO SET UP GDOAS              37300000
         L     REGA,GDSAOACB                                            37400000
         L     REGB,CURRLOG(REGA)  LOGICAL ADDR OF START OF ELEM        37500000
         STH   REGB,WRKADDR+2      STORE IN KEY                         37600000
         EJECT                                                          37700000
POS00170 LA    PARM,WRKADDR                                             37800000
*//                                                                     37900000
*//      CALL  DATA GENERATOR                                           38000000
*//                                                                     38100000
         L     REGFIFTN,STAT(ERRREG) STATUS TABLE                       38200000
         L     REGFIFTN,DGEN(REGFIFTN) DATA GEN                         38300000
         BALR  RETURN,REGFIFTN                                          38400000
         LTR   REGFIFTN,REGFIFTN   SUCCESS?                             38500000
         BNE   ERR2A               NO ERROR CODE IN RETURN ARRAY        38600000
*                                  ALREADY SET BY ROUTINE DETECTING     38700000
*                                  ERROR. GDSCB WILL BE RESET & RETURN  38800000
*                                                                       38900000
*              AFTER GENERATION IF UPDATE THE UPDATED ELEMENT           39000000
*              IS WRITTEN OUT. OTHERWISE THE LOGICAL LENGTH             39100000
*              IS COMPUTED AND THEN THE ROUTINE KEYS IF NECESSARY       39200000
*              AND EXITS.                                               39300000
*                                                                       39400000
         CLI   WRKSWTCH,UPDATE     UPDATE?                              39500000
         BE    POS00290            YES, WRITE OUT UPDATE                39600000
         L     REGA,GDSAOACB                                       5489 39700000
         LH    REGB,WRKADDR+2                                      5489 39800000
         L     REGA,CURRLOG(REGA)                                       39900000
         SR    REGA,REGB           LENGTH OF ELEMENT                    40000000
         STH   REGA,WRKADDR        IN KEY                               40100000
         L     REGA,WRKKEY                                              40200000
         LTR   REGA,REGA           KEY DESIRED                          40300000
         BZ    POS00175            NO                                   40400000
         MVC   ZERO(FOUR,REGA),WRKADDR MOVE IN LEVEL2 KEY IN VAR        40500000
POS00175 TM    WRKBITS+2,CORKEY    KEYED OR CORRELATED LEVEL ONE        40600000
         BNE   POS00300            YES                                  40700000
POS00180 L     SAVE,FOUR(SAVE)     RESET SAVE REG                       40800000
         MVC   GDSDATMD,WRKSWTCH+2 RESET DATA MODE SWITHC               40900000
POS00190 RETURN (14,12),T          RETURN                               41000000
         EJECT                                                          41100000
POS00200 MVC   WRKXABS(FOUR),ZERO(REGA) PLACE IN ARRAY                  41200000
         B     POS00030                                                 41300000
POS00210 MVC   WRKYABS(FOUR),ZERO(REGA) PLACE IN ARRAY                  41400000
         B     POS00040                                                 41500000
POS00220 L     REGA,KEY(PARM)      LOAD KEY ADDR                        41600000
         MVC   WRKADDR(FOUR),ZERO(REGA) MOVE IN KEY                     41700000
         B     POS00095                                                 41800000
         SPACE 3                                                        41900000
POS00230 CLC   WRKCORVL(FOUR),ZEROFLD WAS CORVAL ZERO                   42000000
         BE    ERR1C               YES, ERROR                           42100000
*/                                                                      42200000
*/       SEARCH ON CORVAL                                               42300000
*/       KEY ADDR RET IN REG1                                           42400000
         LA    REGA,WRKCORVL       ADDR OF CORVAL                       42500000
         ST    REGA,WRKKADDR       IN PARM LIST                         42600000
         LA    REGA,FIVEFLD        CODE.                                42700000
         ST    REGA,WRKCODE        SEARCH                               42800000
         ST    GDSREG,WRKGDS1      GDSCB                                42900000
         B     POS00085            GO TO LINK KEY TO TBC MGT            43000000
         EJECT                                                          43100000
POS00240 L     REGA,WRKXABS                                             43200000
         ST    REGA,GDSXLAST       UPDATE GDSCB                         43300000
         SH    REGA,GDSXCURR       COMPUTE ADJUSTED INCREMENT           43400000
         ST    REGA,WRKXINCR                                            43500000
         MVC   GDSXCURR,WRKXABS+2                                       43600000
         L     REGA,WRKYABS        NEW BEAM                             43700000
         ST    REGA,GDSYLAST       POSITION                             43800000
         SH    REGA,GDSYCURR       COMPUTE ADJ INCR                     43900000
         ST    REGA,WRKYINCR                                            44000000
         MVC   GDSYCURR,WRKYABS+2                                       44100000
         NI    GDSSCISS,LASTON     SET SCISSOR FLAGS TO LAST ON SCREEN  44200000
         B     POS00160                                                 44300000
         SPACE 3                                                        44400000
POS00280 LA    PARM,WRKADDR        PARM LIST                            44500000
         L     REGFIFTN,STAT(ERRREG) POINT TO STATUS TABLE  D11 ZA15418 44600000
         L     REGFIFTN,UPDH13(REGFIFTN) AND TO IFFAHA13    D11 ZA15418 44700000
         BALR  RETURN,REGFIFTN         GOTO IFFAHA13        D11 ZA15418 44800000
*//                                                                     44900000
*//      CALL UPDATE FOR UPDATE GDOAS                                   45000000
*//IFFAHA13 CALLED VIA GSP LOGIC TO MINIMIZE SYS OVRHD      D11 ZA15418 45100000
         LTR   REGFIFTN,REGFIFTN   SUCCESS                              45200000
         BNE   POS00180            NO                                   45300000
         B     POS00170                                                 45400000
         EJECT                                                          45500000
POS00290 LA    PARM,WRKADDR        PARM LIST                            45600000
         L     REGFIFTN,STAT(ERRREG) POINT TO STATUS TABLE  D11 ZA15418 45700000
         L     REGFIFTN,UPDH14(REGFIFTN) AND TO IFFAHA14    D11 ZA15418 45800000
         BALR  RETURN,REGFIFTN     GOTO IFFAHA14            D11 ZA15418 45900000
*//                                                                     46000000
*//      CALL UPDATE TO WRITE OUT UPDATED DATA                          46100000
*// IFFAHA14 IS CALLED VIA GSP LOGIC TO MINIMIZE SYS OVRHD  D11 ZA15418 46200000
         TM    GDSFLAGS,LEVEL2                                          46300000
         BO    POS00180                                                 46400000
         L     REGA,WRKKEY                                              46500000
         MVC   0(8,REGA),WRKADDR   REPLACE KEY                          46600000
         TM    WRKBITS+2,CORV      IS IT CORRELATED                     46700000
         BZ    POS00180            NO EXIT                              46800000
         L     REGA,WRKKEY         LOAD ADDR OF KEY IN KEY TBLE         46900000
         MVC   8(4,REGA),WRKCORVL  REPLACE VORVAL IN KEY BALE           47000000
         B     POS00180                                                 47100000
         SPACE 3                                                        47200000
POS00300 ST    GDSREG,WRKGDS1      GDSCB FOR KEY TABLE MGT              47300000
         LA    REGA,ONEFLD         CODE                                 47400000
         ST    REGA,WRKCODE                                             47500000
         LA    REGA,WRKADDR        KEY ADDR                             47600000
         ST    REGA,WRKKADDR       IN PARM LIST                         47700000
         LA    PARM,WRKGDS1                                             47800000
*//      CALL KEY TABLE TO ADD KEY                                      47900000
         L     REGFIFTN,GDSGTMCB  GET ADDR OF GTMCB         E12 ZA28573 47910000
         L     REGFIFTN,4(REGFIFTN) POINTER TO GSPCB        E12 ZA28573 47920000
         L     REGFIFTN,FE(REGFIFTN) STAT TBL ADDR          E12 ZA28573 47930000
         L     REGFIFTN,ETE(REGFIFTN) ADDR OF KEY TBL MGR   E12 ZA28573 47940000
         LTR   REGFIFTN,REGFIFTN  LOADED YET?               E12 ZA28573 47950000
         BZ    POSLINK            NO USE LINK               E12 ZA28573 47960000
         BALR  RETURN,REGFIFTN    BRANCH TO KEY TABLE MGR   E12 ZA28573 47970000
         B     POSRTN             CONTINUE AFTER LINK       E12 ZA28573 47980000
POSLINK  L     REGD,16             ADDR OF CVT              E12 ZA28573 48000000
         L     REGD,CVTLINK(REGD)  LINK LIBRARY DCB                     48100000
         LINK  EP=IFFAHA03,MF=(E,(1)),SF=(E,WRKSPVSR)                   48200000
POSRTN   LTR   REGFIFTN,REGFIFTN   SUCCESSFUL               E12 ZA28573 48300000
         BNE   ERR3                NO                                   48400000
         B     POS00180                                                 48500000
         EJECT                                                          48600000
POS00310 OI    GDSDATMD,XRELINC    SET SW X REAL INCREMENTAL            48700000
         B     POS00380                                                 48800000
POS00320 OI    GDSDATMD,YRELINC    SET SW Y REAL INCRE                  48900000
         B     POS00110                                                 49000000
         SPACE                                                          49100000
POS00330 NI    GDSDATMD,ZERO       ZERO SWITCH FOR RESET                49200000
         TM    WRKSWTCH+2,REALX    IS REAL THE X                        49300000
         BM    POS00350            YES                                  49400000
         OI    GDSDATMD,XINTABS    SET X INTEGER ABSOLUTE               49500000
POS00340 TM    WRKSWTCH+2,REALY    IS Y REAL                            49600000
         BM    POS00360            YES                                  49700000
         OI    GDSDATMD,YINTABS    SET Y INTEGER ABSOLUTE               49800000
         B     POS00200                                                 49900000
         SPACE                                                          50000000
POS00350 OI    GDSDATMD,XRELABS    SET X REAL ABSOLUTE                  50100000
         B     POS00340                                                 50200000
POS00360 OI    GDSDATMD,YRELABS    SET Y REAL ABSOLUTE                  50300000
         B     POS00200                                                 50400000
         SPACE                                                          50500000
POS00370 NI    GDSDATMD,ZERO       SET SW TO ZERO FOR TEMP RESET        50600000
         TM    WRKSWTCH+2,REALX    IS X REAL                            50700000
         BM    POS00310            YES                                  50800000
         OI    GDSDATMD,XINTINC    SET SW X INTEGER INCRE               50900000
POS00380 TM    WRKSWTCH+2,REALY    IS Y REAL                            51000000
         BM    POS00320            YES                                  51100000
         OI    GDSDATMD,YINTINC    SET SW Y INTEGER  INCREMENTAL        51200000
         B     POS00110                                                 51300000
         EJECT                                                          51400000
ERR1     MVI   PARMERR+3(ERRREG),BADGDS GDSCB ERROR                     51500000
         B     ERR1A2                                                   51600000
ERR1A    LA    REGA,ONE(REGA)      PARM BAD IN REGA ACTUALLY ONE LESS   51700000
ERR1A1   ST    REGA,PARMERR(ERRREG) STORE PARM ERROR                    51800000
ERR1A2   MVI   RTNCODE(ERRREG),PARMSW  SET ERROR SW                     51900000
         B     POS00180                                                 52000000
ERR1B    L     REGA,MAXCT          MAXCT - TOO MANY GO TO ADD ONE TO IT 52100000
         B     ERR1A                                                    52200000
ERR1C    LA    REGA,CORNO                                               52300000
         B     ERR1A1                                                   52400000
ERR1D    LA    REGA,GENNO                                               52500000
         B     ERR1A1                                                   52600000
         SPACE 3                                                        52700000
ERR2A    MVC   GDSXLAST,WRKXLAST        RESET GDSCB                     52800000
         MVC   GDSYLAST,WRKYLAST        TO CONDITION                    52900000
         MVC   GDSXCURR,WRKXCURR        BEFORE CALL                     53000000
         MVC   GDSYCURR,WRKYCURR                                        53100000
         MVC   GDSSCISS(ONE),WRKSWTCH+1                                 53200000
         TM    WRKSWTCH,UPDATE     UPDATE                               53300000
         BO    POS00180            YES NO RESET REQUIRED                53400000
*//                                                                     53500000
*//      RESET TO KEY                                                   53600000
*//                                                                     53700000
         MVC   WRKDATA2(20),0(ERRREG) SAVE RETURN ARRAY                 53800000
         LA    REGA,GDSGDSCB       VAR CONTAINING ADDR OF GDS           53900000
         ST    REGA,WRKGDS         IN PARAMETER LIST                    54000000
         L     REGA,NULL(ERRREG)   NULL FOR CORVAL                      54100000
         ST    REGA,WRKRTN         IN PARM LIST                         54200000
         LA    REGA,WRKADDR        ADDRESS OF KEY                       54300000
         ST    REGA,WRKDATA1       IN PARAMETER LIST                    54400000
         OI    WRKDATA1,LAST       LAST PARM SW                         54500000
         LA    REGA,WRKGDS         ADDR OF PARM LIST                    54600000
         ST    REGA,WRKGDS1        IN WORK AREA                         54700000
         ST    ERRREG,WRKCODE      ERROR CODE IN PARM LIST              54800000
         LA    PARM,WRKGDS1        ADDR OF WRK AREA IN R1               54900000
         LINK  EP=IFFAFA12,MF=(E,(1)),SF=(E,WRKSPVSR)                   55000000
*        LINK TO RESET ROUTINE                                          55100000
         MVC   0(20,ERRREG),WRKDATA2                                    55200000
*        RESET RETURN ARRAY                                             55300000
         B     POS00180                                                 55400000
         EJECT                                                          55500000
ERR3     OI    RTNCODE(ERRREG),STRG                                     55600000
         MVC   STOR(4,ERRREG),FOURFLD                                   55700000
ERR4BTAB B     ERR2A              STORAGE EXCEEDED                 9328 55800000
         B     POS00180      RC=4, NO ORDERS TO GEN, RETURN NORM   9328 55900000
         LH    REGA,WRKXCURR RC=8, STPOS SCISSORED. USE CURRENT    9328 56000000
         ST    REGA,WRKXABS        LOCATION TO ESTABLISH BEAM POS  9328 56100000
         LH    REGA,WRKYCURR       SO INCREMENTAL ORDERS HAVE A    9328 56200000
         ST    REGA,WRKYABS        VALID STARTING POINT.           9328 56300000
         B     POS00160      BACK TO MAINLINE FOR ORDER GEN        9328 56400000
         EJECT                                                          56500000
*        REGISTERS                                                      56600000
REGZERO  EQU   0                   ZERO                                 56700000
PARM     EQU   1                   PARAMETER                            56800000
REGA     EQU   2                   GEN                                  56900000
REGB     EQU   3                   GEN                                  57000000
COUNT    EQU   4                   PARM COUNT                           57100000
WORK     EQU   5                   WORK AREA                            57200000
ERRREG   EQU   6                                                        57300000
GTMREG   EQU   7                   GTMCB                                57400000
GDSREG   EQU   8                   GDSCB                                57500000
BASE     EQU   9                   BASE REG                             57600000
REGC     EQU   10                  GEN                                  57700000
REGD     EQU   11                  GEN                                  57800000
SAVE     EQU   13                  SAVE AREA                            57900000
RETURN   EQU   14                  RETURN                               58000000
REGFIFTN EQU   15                  RTN CODE                             58100000
         EJECT                                                          58200000
*        CONSTANTS                                                      58300000
ENTRYADD DC    A(IFFAFA17)                                              58400000
BITS     DC    B'00000100'         SINGLE,VECTOR,INCLUDE,ABSOLUTE       58500000
         DC    X'00'               RESERVED                             58600000
         DC    B'00000100'         FIRST PASS,NO KEY-CORVAL-UPDATE-REPO 58700000
         DC    X'00'               RESERVED                             58800000
ZEROFLD  DC    2F'0'                                                    58900000
ONEFLD   DC    F'1'                                                     59000000
TWOFLD   DC    F'2'                                                     59100000
FOURFLD  DC    F'4'                                                     59200000
FIVEFLD  DC    F'5'                                                     59300000
REQCT    DC    F'2'                                                     59400000
MAXCT    DC    F'5'                                                     59500000
PATCH    DC    64X'FF'             PATCH AREA               D11         59600000
         EJECT                                                          59700000
*        DISPLACEMENTS                                                  59800000
GDSPARM  EQU   0                   GDSCB PARM                           59900000
UPARM    EQU   4                   UVAL PARM                            60000000
VPARM    EQU   8                   VVAL PARM                            60100000
CORVAL   EQU   12                  CORVAL PARM                          60200000
KEY      EQU   16                  KEY PARM                             60300000
GENCODE  EQU   20                  GENCODE PARM                         60400000
ZERO     EQU   0                                                        60500000
GDSIDSW  EQU   3                   SETTING TO SAY GDSCB IS VALID        60600000
EIGHT    EQU   8                                                        60700000
LSTPARM  EQU   X'80'               SETTING ON LAST PARAMETER            60800000
ONE      EQU   1                                                        60900000
FOUR     EQU   4                                                        61000000
INCRU    EQU   X'50'               DATA MODE U INCR SW                  61100000
SET      EQU   2                   SETPOS SW                            61200000
INCRV    EQU   X'05'               DATA MODE V INCR SW                  61300000
LEVEL2   EQU   X'10'               LEVEL 2 IN GDSFLAGS                  61400000
CORV     EQU   X'10'               CORVAL SW IN KEY                     61500000
KEYSW    EQU   X'20'               KEY SW IN KEY                        61600000
CORKEY   EQU   X'30'               CORVAL OR KEY IN KEY                 61700000
OMIT     EQU   X'FB'               OMIT SW TO TURN OFF INCLUDE FLAG     61800000
ABS      EQU   X'02'               GRAPHIC MODE ABS                     61900000
OPT      EQU   X'04'               GRAPHIC MODE OPT                     62000000
OPTIHALF EQU   X'02'               HALF OF OPT SW IN KEY                62100000
OPTINCR  EQU   X'01'               OTHER HALF OR INCR SW                62200000
SCALERQD EQU   X'40'               SCALE RQD SW                         62300000
FLOATX   EQU   X'C0'               X INPUT FLOAT                        62400000
FLOATY   EQU   X'0C'               Y INPUT FLOAT                        62500000
NOSCISS  EQU   X'10'               NO SCISSOR                           62600000
UPDATE   EQU   X'FF'               UPDATE IN WORK FLAGS                 62700000
PARMERR  EQU   16                  PARM ERROR IN RET ARRAY              62800000
RTNCODE  EQU   0                   RETURN CODE IN ARRAY                 62900000
BADGDS   EQU   1                   GDS IN ERROR                         63000000
CORNO    EQU   4                   CORVAL PARM NUMBER                   63100000
GENNO    EQU   6                   GENCODE PARM NUMBER                  63200000
PARMSW   EQU   X'08'               SW TO SAY PARM ERROR RETURN CODE     63300000
LISTLEN  EQU   68                  LENGTH OF PARM LIST FOR DATA GEN     63400000
LASTON   EQU   X'1F'               TURNS OFF SCISSOR FLAGS TO SAY LAST  63500000
*                                  BEAM ON                              63600000
CURRLOG  EQU   52                                                       63700000
SUBR     EQU   X'02'                                                    63800000
STRG     EQU   X'10'                                                    63900000
STOR     EQU   12                                                       64000000
SEQ      EQU   X'04'                                                    64100000
MEMSUB   EQU   X'80'                                                    64200000
MEMSEQ   EQU   X'40'                                                    64300000
EVENFOUR EQU   X'FC'                                                    64400000
NULL     EQU   20                                                       64500000
STAT     EQU   24                                                       64600000
DGEN     EQU   840                                                      64700000
SCISS    EQU   876                                                      64800000
SCALE    EQU   864                                                      64900000
UPDH13   EQU   936                 STATAB DISPL IFFAHA13    D11 ZA15418 65000000
UPDH14   EQU   948                 STATAB DISPL IFFAHA14    D11 ZA15418 65100000
CVTLINK  EQU   8                                                        65200000
REALX    EQU   X'C0'                                                    65300000
REALY    EQU   X'0C'                                                    65400000
XINTINC  EQU   X'10'                                                    65500000
YINTINC  EQU   X'01'                                                    65600000
XRELINC  EQU   X'40'                                                    65700000
YRELINC  EQU   X'04'                                                    65800000
XINTABS  EQU   X'20'                                                    65900000
YINTABS  EQU   X'02'                                                    66000000
XRELABS  EQU   X'80'                                                    66100000
YRELABS  EQU   X'08'                                                    66200000
LAST     EQU   X'80'                                                    66300000
FE       EQU   48                                                  000A 66400000
ETE      EQU   828                                                 000A 66500000
         EJECT                                                          66600000
*        WORK AREA                                                      66700000
WORKAREA DSECT                                                          66800000
WRKPARM  DS    F                                                        66900000
WRKRTNCD DS    F                                                        67000000
WRKSWTCH DS    F                                                        67100000
WRKSPVSR DS    3F                                                       67200000
WRKSAVE  DS    18F                                                      67300000
WRKXCURR DS    H                                                        67400000
WRKYCURR DS    H                                                        67500000
WRKXLAST DS    F                                                        67600000
WRKYLAST DS    F                                                        67700000
WRKKEYAD DS    F                                                        67800000
WRKADDR  DS    F                                                        67900000
WRKBITS  DS    F                                                        68000000
WRKCORVL DS    F                                                        68100000
WRKKEY   DS    F                                                        68200000
WRKGDS   DS    F                                                        68300000
WRKRTN   DS    F                                                        68400000
WRKDATA1 DS    F                                                        68500000
WRKDATA2 DS    F                                                        68600000
WRKDATA3 DS    F                                                        68700000
WRKDATA4 DS    F                                                        68800000
WRKXABS  DS    F                                                        68900000
WRKYABS  DS    F                                                        69000000
WRKXINCR DS    F                                                        69100000
WRKYINCR DS    F                                                        69200000
WRKNTUSD DS    2F                                                       69300000
WRKENTCT DS    F                                                        69400000
WRKGDS1  DS    F                                                        69500000
WRKCODE  DS    F                                                        69600000
WRKKADDR DS    F                                                        69700000
         COPY  GSPCB                                                    69800000
         COPY  GTMCB                                                    69900000
         COPY  GDSCB                                                    70000000
         END                                                            70100000
