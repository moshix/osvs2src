         TITLE 'IFFAHA01 - FLOWCTL - FLOW CONTROL MANAGEMENT'      1720 00200021
*                                                                       00400021
*                        FLOW CONTROL MANAGEMENT                        00600021
*                                                                       00800021
*        FLOW CONTROL MANAGEMENT IS ENTERED FROM SEVERAL ROUTINES FOR   01000021
*        SEVERAL DIFFERENT PURPOSES.                                    01200021
*                                                                       01400021
*        CODE 1                                                         01600021
*        ENTRY AT CODE 1 IS MADE TO SET UP THE FLOW CONTROL TABLE       01800021
*        AND BUILD THE FLOW CONTROL STRUCTURE.  IT IS CALLED BY         02000021
*        INDEV-IFFAAA03.  REGISTER ONE CONTAINS THE ADDRESS OF A        02200021
*        WORK AREA.  THE FIRST WORD OF THE WORK AREA CONTAINS THE       02400021
*        ADDRESS OF THE PARAMETER LIST CONSISTING OF THE FOLLOWING:     02600021
*                                                                       02800021
*        +0   A(1)                                                      03000021
*        +4   A(GTMCB)                                                  03200021
*                                                                       03400021
*        CODE 2                                                         03600021
*        ENTRY AT CODE 2 IS MADE TO ADD A GDS TO THE FLOW CONTROL       03800021
*        STRUCTURE IN THE BUFFER.  IT IS CALLED BY DATA STORE-          04000021
*        IFFAHA05.  THE PARAMETER LIST IS LISTED BELOW:                 04200021
*                                                                       04400021
*        +0   A(2)                                                      04600021
*        +4   A(GDSCB)                                                  04800021
*        +8   A(BUFFER)                                                 05000021
*                                                                       05200021
*        CODE 3                                                         05400021
*        CODE 3 IS ENTERED FROM TMGDS-IFFAAA06 TO REMOVE A GDS          05600021
*        FROM THE FLOW CONTROL STRUCTURE.  THE PARAMETER LIST           05800021
*        IS AS FOLLOWS:                                                 06000021
*                                                                       06200021
*        +0   A(3)                                                      06400021
*        +4   A(GDSCB)                                                  06600021
*                                                                       06800021
*        CODE 4                                                         07000021
*        CODE 4 IS ENTERED FROM TMDEV-IFFAAA04 TO DELETE THE FLOW       07200021
*        CONTROL STRUCTURE AND THE FLOW CONTROL TABLE.  THE PARAMETER   07400021
*        LIST CONSISTS OF THE FOLLOWING:                                07600021
*                                                                       07800021
*        +4   A(4)                                                      08000021
*        +4   A(GTMCB)                                                  08200021
*                                                                       08400021
*        THE SYSTEM DECB IS SET UP WHEN THE FLOW CONTROL TABLE IS       08600021
*        INITIALIZED AND IS USED FOR THE FIRST TIME BY FLOW CONTROL     08800021
*        WHICH LEAVES THE LAST I/O PENDING.  WHEN FLOW CONTROL IS       09000021
*        CALLED TO TERMINATE THE LAST I/O IS WAITED ON BEFORE THE       09200021
*        DECB IS DESTROYED.                                             09400021
*                                                                       09600021
*        MACROS USED ARE:                                               09800021
*                                                                       10000021
*        ASGNBFR                                                        10200021
*        GETMAIN                                                        10400021
*        GWRITE                                                         10600021
*        WAIT                                                           10800021
*        GCNTRL                                                         11000021
*        FREEMAIN                                                       11200021
*        RLSEBFR                                                        11400021
*                                                                       11600021
*                                                                       11800021
*        THE FLOW CONTROL TABLE APPEARS AS FOLLOWS:                     12000021
*       *************************************                           12200021
*     +0*        A(FREE ENTRY)              *                           12400021
*     +4*          IN USE LENGTH 2 PER ENTRY*                           12600021
*     +8*A(BUFFER)       *  BUFFER+6        *  ENTRIES                  12800021
*    +12*   BUFFER+16    *  BUFFER+26       *                           13000021
*    +16*   BUFFER+36    *  BUFFER+46       *                           13200021
*    +20*   BUFFER+56    *  BUFFER+66       *                           13400021
*    +24*   BUFFER+76    *  BUFFER+86       *                           13600021
*    +28*   BUFFER+96    *  BUFFER+106      *                           13800021
*    +32*   BUFFER+116   *  BUFFER+126      *                           14000021
*    +36*   BUFFER+136   *  BUFFER+146      *                           14200021
*    +40*   BUFFER+156   *  BUFFER+166      *                           14400021
*    +44*   BUFFER+176   *  BUFFER+186      *                           14600021
*    +48*   BUFFER+196   *  BUFFER+206      *                           14800021
*    +52*   BUFFER+216   *  BUFFER+226      *                           15000021
*    +56*   BUFFER+236   *  BUFFER+246      *                           15200021
*       *************************************                           15400021
         EJECT                                                          15600021
IFFAHA01 CSECT                                                          15800021
*2412,562000-564000                                                5743 15900021
*2131,002000,790000                                                1720 15950021
*                                                                       16000021
*        REGARDLESS OF THE REASON OF THIS CALL THE CODES PERFORM THE    16200021
*        FOLLOWING: THE BASE REGISTER IS INITIALIZED AND THE WORK       16400021
*        AREA DSECT IS SET UP. THE SAVE AREAS ARE CHAINED. THE REASON   16600021
*        FOR ENTRY IS DETERMINED AND DEPENDING ON THE SERVICE DESIRED,  16800021
*        CONTROL IS TURNED OVER TO A SPECIFIC SECTION OF THE PROGRAM    17000021
FLOWCTL  SAVE  (14,12)                                                  17200021
         BALR  BASE,0                                                   17400021
         USING *,BASE                                                   17600021
LABEL    LR    WORK,PARM           ADDRESS OF WORK AREA                 17800021
         USING WORKAREA,WORK                                            18000021
         L     PARM,WRKPARM        PARAMETER LIST                       18200021
         ST    SAVE,WRKSAVE+4      SET UP SAVE AREA CHAIN               18400021
         LA    REGA,WRKSAVE                                             18600021
         ST    REGA,8(SAVE)                                             18800021
         LR    SAVE,REGA           PLACE MY SAVE AREA IN THE REGISTER   19000021
         CLI   CODE(PARM),X'01'    CODE 1                               19200021
         BE    FLC00010                                                 19400021
         CLI   CODE(PARM),X'02'    CODE 2                               19600021
         BE    FLC00040                                                 19800021
         CLI   CODE(PARM),X'03'    CODE 3                               20000021
         BE    FLC00050                                                 20200021
         CLI   CODE(PARM),X'04'    CODE 4                               20400021
         BE    FLC00100                                                 20600021
         B     FLC00030                                                 20900021
         EJECT                                                          21200021
**                                                                      21400021
**                                                                      21600021
**       CODE 1                                                         21800021
**       SET UP FLOW CONTROL STRUCTURE AT GTMCB OPEN TIME.              22000021
**                                                                      22200021
**                                                                      22400021
*                                                                       22600021
*        TO SET UP THE FLOW CONTROL STRUCTURE AND TABLE THE REQUIRED    22800021
*        BUFFER, 256 BYTES, IS REQUESTED, AND THE REQUIRED STORAGE      23000021
*        FOR THE TABLE IS OBTAINED.                                     23200021
*                                                                       23400021
FLC00010 L     GTMREG,4(PARM)      ADDR OF TERM CTL BLK                 23600021
         USING GTMCB,GTMREG                                             23800021
         LA    REGA,256            LENGTH REQD                          24000021
         STH   REGA,WRKSPACE+8                                          24200021
         L     REGA,GTMGRDCB                                            24400021
         SPACE 3                                                   1720 24500021
         ASGNBFR (REGA),WRKSPACE+8,MF=(E,WRKSPACE)  GET BUFFER          24600021
         LTR   15,15                                                    24800021
         BNE   ERR1                NO BUFFER AVAILABLE                  25000021
         SPACE 3                                                   1720 25100021
         GETMAIN EC,LV=FLCTLTBL,A=WRKSPACE+12,SP=0,MF=(E,WRKSPACE)      25200021
         LTR   15,15                                                    25400021
         EJECT                                                     1720 25500021
         BNE   ERR2                NO CORE AVAILABLE                    25600021
*                                                                       25800021
*        THE TABLE IS INITIALIZED WITH POINTERS TO THE FREE LIST        26000021
*        AND THE LENGTH OF THE INUSE LIST. THE INUSE LIST IS            26200021
*        INITIALLY TWO BECAUSE OF THE FIRST ENTRY BEING RESERVED        26400021
*        FOR THE SYSTEM GDS. THEN THE ADDRESSES IN THE BUFFER           26600021
*        OBTAINED WHICH WILL BE AVAILABLE FOR EACH ENTRY ARE            26800021
*        COMPUTED AND PLACED IN THE TABLE.                              27000021
*                                                                       27200021
         L     TABLE,WRKSPACE+12   ADDR OF CORE OBTAINED                27400021
         LA    REGA,12(TABLE)      FREE LIST STARTS TWELVE BEYOND       27600021
         ST    REGA,FREE(TABLE)    PTR SET                              27800021
         LA    REGA,2                                                   28000021
         ST    REGA,INUSE(TABLE)   LENGTH OF INUSE LIST                 28200021
         L     REGA,GTMGRDCB       ADDR OF DCB                          28400021
         LH    REGB,16(REGA)       ADDR OF BUFFER OBTAINED              28600021
         STH   REGB,BUFADR(TABLE)  IN TABLE                             28800021
         LA    REGA,TBLEND(TABLE)  DECB ADDR                            29000021
         ST    REGA,GTMDECB1       IN GTMCB                             29200021
         LA    REGB,6(REGB)        DUMMY ENTRY BUFFER ADDR              29400021
         STH   REGB,DUMMY(TABLE)   IN TABLE                             29600021
         LA    REGA,24             COUNT                                29800021
         LA    REGC,DUMMY+2        ADDR OF FREE ELEMENTS                30000021
FLC00020 LA    REGB,10(REGB)       EACH TEN BYTES BEYOND LAST           30200021
         STH   REGB,0(REGC,TABLE)  STORE BUFFER ADDR                    30400021
         LA    REGC,2(REGC)        NEXT IN TABLE                        30600021
         BCT   REGA,FLC00020       DO ALL 24 ENTRIES                    30800021
         EJECT                                                     1720 30900021
**                                                                      31000021
**       THE TABLE HAS BEEN INITIALIZED. THE BUFFER MUST NOW BE INIT.   31200021
**                                                                      31400021
*                                                                       31600021
*        THE SKELETON FOR THE FLOW CONTROL STRUCTURE ARE                31800021
*        PLACED IN THE WORK AREA AND THE ADDRESSES ARE RESOLVED.        32000021
         MVC   WRKSPACE(16),FIRSTORD MOVE SKELETON ORDERS IN WORK AREA  32200021
         LH    REGB,BUFADR(TABLE)                                       32400021
         STH   REGB,WRKSPACE+14    BUFFER ADDR IN LAST GTRU             32600021
         LA    REGB,6(REGB)        ADDRESS TO GO IN 1ST GTRU            32800021
         STH   REGB,WRKSPACE+4     PLACE IN WORK AREA                   33000021
         LA    REGB,6(REGB)        DUMMY THE SYS GDS                    33200021
         STH   REGB,WRKSPACE+10                                         33400021
         EJECT                                                          33600021
*                                                                       33800021
*        BUILD DECB BELOW FLOW CONTROL TABLE                            34000021
*                                                                       34200021
*                                                                       34400021
*        THE DECB IS BUILT BEYOND THE FLOW CONTROL TABLE. THIS          34600021
*        WILL SERVE AS THE SYSTEM DECB FOR THE DATA GENERATING          34800021
*        ROUTINES WHILE THIS 2250 IS OPEN. THE FLOW CONTROL             35000021
*        STRUCTURE IS WRITTEN TO THE BUFFER AND THE I/O IS NOT          35200021
*        WAITED UPON. THIS IS THE START OF THE I/O OVERLAP. FUTURE      35400021
*        ROUTINES THAT WILL DO I/O USING THIS DECB WILL FIRST WAIT      35600021
*        AND THEN ISSUE THEIR I/O. ADDRESS OF THE DECB AND              35800021
*        THE FOLOW CONTROL TABLE ARE PLACED IN THE GTMCB AND            36000021
*        CONTROL IS RETURNED TO THE CALLING PROGRAM.                    36200021
         XC    TBLEND(32,TABLE),TBLEND(TABLE) ZERO OUT DECB             36400021
         LA    REGB,TBLEND(TABLE)  DECB ADDR                            36600021
         L     REGA,GTMGRDCB       DCB ADDR                             36800021
         LA    REGC,BUFADR(TABLE)                                       37000021
         LR    PARM,REGB                                                37200021
         SPACE 3                                                   1720 37300021
         GWRITE (PARM),BUF,(REGA),16,WRKSPACE,(REGC),MF=E               37400021
         ST    TABLE,GTMFCTBL      SAVE ADDR OF FLOW CTL TABLE          37600021
FLC00030 L     SAVE,4(SAVE)                                             37800021
         RETURN (14,12),RC=0       RETURN                               38000021
         EJECT                                                          38200021
**                                                                      38400021
**                                                                      38600021
**       CODE 2                                                         38800021
**       ADD A GDS                                                      39000021
**                                                                      39200021
**                                                                      39400021
*                                                                       39600021
*        TO ADD A GDS TO THE FLOW CONTROL STRUCTURE THE GDSCB AND       39800021
*        GTMCB DSECTS ARE FIRST INITIALIZED. THE ADDRESS OF THE         40000021
*        FLOW CONTROL TABLE IS TAKEN FROM THE GTMCB AND ALSO            40200021
*        THE DCB ADDRESS AND THE DECB ADDRESS. A CHECK IS MADE          40400021
*        TO SEE IF THIS GDS IS THE SYSTEM GDS AND IF SO IT IS           40600021
*        ADDED TO THE TOP OF THE TABLE. OTHERWISE A CHECK IS            40800021
*        MADE TO SEE IF ALL THE FLOW CONTROL ENTRIES HAVE BEEN          41000021
*        USED.  IF YES THIS IS AN ERROR CONDITION AND CONTROL IS        41200021
*        RETURNED TO THE CALLING PROGRAM WITH A RETURN CODE.            41400021
FLC00040 L     GDSREG,GDS(PARM)    GDSCB ADDR                           41600021
         USING GDSCB,GDSREG                                             41800021
         L     GTMREG,GDSGTMCB     ADDRESS OF GTMCB                     42000021
         L     TABLE,GTMFCTBL      FLOW CTL TABLE                       42200021
         L     REGA,INUSE(TABLE)   COUNT OF INUSE ELEM                  42400021
         L     REGC,GTMDECB1       DECB                                 42600021
         L     REGE,GTMGRDCB       DCB ADDR                             42800021
         C     GDSREG,GTMSYGDS     SYS GDS                              43000021
         BE    FLC00045            YES                                  43200021
         C     REGA,INUSELEN       ALL USED                             43400021
         BE    ERR1                YES- ERROR                           43600021
         EJECT                                                     1720 43700021
*                                                                       43800021
*        IF THERE IS A FREE ELEMENT THE ADDRESS IS REMOVED FROM THE     44000021
*        TABLE AND THE ENTRY IS ADDED TO THE IN USE LIST AND A COUNT    44200021
*        OF TWO IS ADDED TO THE INUSE COUNT.  THE SKELETON ORDERS       44400021
*        FOR THE FLOW CONTROL ENTRY ARE MOVED INTO THE WORK AREA AND    44600021
*        THE ADDRESSES IN THE BUFFER ARE RESOLVED.  THE PREVIOUS        44800021
*        I/O CALL IS WAITED UPON AND THE FLOW CONTROL ENTRY IS          45000021
*        WRITTEN TO THE BUFFER.                                         45200021
         L     REGB,FREE(TABLE)    FREE ELEMENT ADDR                    45400021
         LA    REGA,2(REGA)                                             45600021
         ST    REGA,INUSE(TABLE)   UPDATE INUSE COUNT                   45800021
         LA    REGA,2(REGB)                                             46000021
         ST    REGA,FREE(TABLE)    FIX FREE PTR                         46200021
         LA    ENTRY,4                                                  46400021
         SR    REGA,ENTRY          POSITION TO PREV ENTRY               46600021
         MVC   WRKSPACE(10),ENTRYORD MOVE IN SKELETON ORDERS            46800021
         MVC   WRKSPACE+4(2),10(PARM) MOVE IN GDS BUFFER ADDR           47000021
         MVC   WRKSPACE+8(2),BUFADR(TABLE) MOVE IN RETURN TO F/C        47200021
         LR    PARM,REGC                                                47400021
         WAIT  ECB=(1)             WAIT ON I/O                          47600021
         CLI   0(REGC),X'7F'                                            47660021
         BNE   ERR3                                                     47720021
         XC    0(4,REGC),0(REGC)   ZERO ECB                             47800021
         LR    PARM,REGC                                                48000021
         GWRITE (PARM),BUF,(REGE),10,WRKSPACE,(REGB),MF=E               48200021
         EJECT                                                          48400021
*                                                                       48600021
*        THE RETURN ADDRESS TO THE FLOW CONTROL ENTRY FROM THE GDS      48800021
*        BUFFER IS COMPUTED AND PLACED IN THE GDSOVDAT FIELD OF THE     49000021
*        GDSCB AS IS THE START OF THE FLOW CONTROL ENTRY PLACED IN      49200021
*        THE GDSFCBUF FIELD.  THE PREVIOUS I/O IS WAITED ON AND THE     49400021
*        ADDRESS OF THIS ENTRY IS WRITTEN OUT TO THE PREVIOUS           49600021
*        ENTRY SO THAT IT IS ADDED TO THE FLOW.  IF THIS IS             49800021
*        SYSTEM GDS THIS IS NOT NECESSARY BECAUSE THE FLOW CONTROL      50000021
*        ENTRY FOR THE SYSTEM GDS ALREADY GOES TO THE NEXT ENTRY        50200021
*        IN THE STRUCTURE.                                              50400021
*                                                                       50600021
         LH    REGB,0(REGB)                                             50800021
FLC00042 STH   REGB,GDSFCBUF       ADDR OF FLOW CTL ENTRY               51000021
         STH   REGB,GDSFCBUF       ADDR OF FLOW CTL ENTRY               51200021
         LA    REGB,6(REGB)                                             51400021
         STH   REGB,GDSOVDAT+2     RETURN PT IN FLOW CTL ENTRY          51600021
         LR    PARM,REGC                                                51800021
         WAIT  ECB=(1)             WAIT ON I/O                          52000021
         CLI   0(REGC),X'7F'                                            52060021
         BNE   ERR3                                                     52120021
         XC    0(4,REGC),0(REGC)   ZERO ECB                             52200021
         C     GDSREG,GTMSYGDS                                          52400021
         BE    FLC00044                                                 52600021
         LH    REGB,0(REGA)        ADDR OF PREV ENTRY                   52800021
         LA    REGB,8(REGB)        ADDR OF TRANS LOC                    53000021
         LA    REGA,2(REGA)        ADDR OF DATA                         53200021
         STH   REGB,WRKSPACE                                            53400021
         LR    PARM,REGC                                                53600021
         GWRITE  (PARM),BUF,(REGE),2,(REGA),WRKSPACE,MF=E               53800021
         LR    PARM,REGC                                                54000021
         WAIT  ECB=(1)             WAIT ON I/O                          54200021
         CLI   0(REGC),X'7F'                                            54260021
         BNE   ERR3                                                     54320021
         XC    0(4,REGC),0(REGC)   ZERO ECB                             54400021
         EJECT                                                     1720 54500021
*                                                                       54600021
*        THE PREVIOUS I/O IS WAITED ON AND A GTRU BACK TO THE           54800021
*        FLOW CONTROL ENTRY IS WRITTEN OUT TO THE USER BUFFER           55000021
*        SO THAT THE CYCLE IS COMPLETE.  WITH THIS CALL REGENERATION    55200021
*        OF THE BUFFER IS STARTED.                                      55400021
*                                                                       55600021
FLC00044 LR    PARM,REGC                                                55800021
         L     REGB,WRKPARM                                        5743 55805021
         L     REGC,GDSAOACB       ADDR OF OACB                    5743 55810021
* PLACE ADDR OF BUFFER INTO OACB TO REFERENCE FOR THE WRITE        5743 55815021
         MVC   BUFSTART+2(2,REGC),10(REGB)                         5743 55820021
         LA    REGB,BUFSTART+2(REGC)                               5743 55825021
         LA    REGC,BUFADR(TABLE)                                       56000021
         GWRITE (PARM),STR,(REGE),4,GDSOVDAT,(REGB),(REGC),MF=E         56600021
         B     FLC00030                                                 56800021
*                                                                       57000021
         EJECT                                                     1720 57100021
*        FOR THE SYSTEM GDS THE FLOW CONTROL ENTRY ALREADY EXISTS.      57200021
*        THEREFORE, THE ADDRESS OF THE SYSTEM GDS BUFFER IS ALL THAT    57400021
*        IS NEEDED TO COMPLETE THE ENTRY AND THAT ADDRESS IS WRITTEN    57600021
*        TO THE BUFFER AFTER THE PREVIOUS I/O IS WAITED UPON.           57800021
FLC00045 LH    REGB,DUMMY(TABLE)   ADDR OF DUMMY FOR SYSGDS             58000021
         LA    REGF,4(REGB)        ADDR TO WRITE TO                     58200021
         STH   REGF,WRKSPACE+2                                          58400021
         MVC   WRKSPACE(2),10(PARM) BUFFER ADDR TO BE WRITTEN IN DUMMY  58600021
         LR    PARM,REGC                                                58800021
         WAIT  ECB=(1)             WAIT ON I/O                          59000021
         CLI   0(REGC),X'7F'                                            59060021
         BNE   ERR3                                                     59120021
         XC    0(4,REGC),0(REGC)   ZERO ECB                             59200021
         LR    PARM,REGC                                                59400021
         GWRITE (PARM),BUF,(REGE),2,WRKSPACE,WRKSPACE+2,MF=E            59600021
         B     FLC00042                                                 59800021
         EJECT                                                          60000021
**                                                                      60200021
**                                                                      60400021
**       CODE 3                                                         60600021
**       DELETE A GDS                                                   60800021
**                                                                      61000021
**                                                                      61200021
*                                                                       61400021
*        WHEN A CALL IS MADE TO DELETE THE GDS A CHECK IS FIRST MADE    61600021
*        TO SEE IF THE FLOW CONTROL STRUCTURE IS ALREADY DELETED.  THIS 61800021
*        MAY OCCUR WHEN THE GDS IS BEING TERMINATED BY TMDEV AND        62000021
*        TMDEV HAS ALREADY DELETED THE FLOW CONTROL STRUCTURE.          62200021
*        A CHECK IS MADE TO SEE IF A FLOW CONTROL ENTRY WAS ADDED       62400021
*        FOR THIS GDS.  TWO IS SUBTRACTED FROM THE INUSE COUNT AND THE  62600021
*        ELEMENT IS REMOVED FROM THE INUSE LIST.  THE ADDRESS OF THE    62800021
*        ENTRY BEFORE AND AFTER IS SAVED.  THE ADDRESS OF THE ENTRY     63000021
*        AFTER THIS ONE (OR THE START OF THE TABLE IF THIS IS THE       63200021
*        LAST ENTRY) IS WRITTEN IN THE ENTRY PRECEEDING THIS ONE.       63400021
*        THUS THIS ENTRY IS BYPASSED IN THE REGENERATION.               63600021
FLC00050 L     GDSREG,4(PARM)      ADDR OF GDSCB                        63800021
         L     GTMREG,GDSGTMCB     ADDR OF THE GTMCB                    64000021
         L     TABLE,GTMFCTBL      FLOW CONTROL TABLE                   64200021
         LTR   TABLE,TABLE         ALREADY CLOSED?                      64400021
         BE    FLC00030            YES, EXIT                            64600021
         LH    REGB,GDSFCBUF       ADDR OF FLOW CONTROL ENTRY           64800021
         LTR   REGB,REGB           WAS AN ENTRY MADE                    65000021
         BZ    FLC00030            NO, EXIT                             65200021
         LA    REGA,10             FIRST IN USE ELEMENT                 65400021
         L     REGE,INUSE(TABLE)   COUNT                                65600021
         S     REGE,TWO            LESS TWO                             65800021
         ST    REGE,INUSE(TABLE)   NEW COUNT                            66000021
FLC00060 CH    REGB,2(REGA,TABLE)  FOUND ? SKIP 1 ELEM - DUMMY NEVER DL 66200021
         BE    FLC00070                                                 66400021
         LA    REGA,2(REGA)        NEXT                                 66600021
         S     REGE,TWO                                                 66800021
         B     FLC00060                                                 67000021
FLC00070 LH    REGC,0(REGA,TABLE)  ONE BEFORE                           67200021
         LA    ENTRY,4(REGA,TABLE)                                      67400021
         C     ENTRY,FREE(TABLE)                                        67600021
         BE    FLC00090                                                 67800021
         LH    ENTRY,4(REGA,TABLE)      ONE AFTER                       68000021
FLC00080 AR    REGA,TABLE                                               68200021
         BCTR  REGE,0              SUBTRACT 1 FOR EX OF MOVE            68400021
         EX    REGE,MOVE           MOVE UP TABLE                        68600021
         L     REGE,FREE(TABLE)    ADDR OF FREE                         68800021
         S     REGE,TWO            ADD ONE ENTRY                        69000021
         STH   REGB,0(REGE)        ADD TO FREE LIST                     69200021
         ST    REGE,FREE(TABLE)    UPDATE ADDRESS                       69400021
         STH   ENTRY,WRKSPACE                                           69600021
         L     PARM,GTMDECB1                                            69800021
         WAIT  ECB=(1)             WAIT ON I/O                          70000021
         EJECT                                                          70200021
         LA    REGC,8(REGC)                                             70400021
         STH   REGC,WRKSPACE+4                                          70600021
         L     REGB,GTMGRDCB       LOAD DCB ADDR                        70800021
         LA    REGA,BUFADR(TABLE)  START ADDR                           71000021
         L     PARM,GTMDECB1                                            71200021
         CLI   0(PARM),X'7F'                                            71250021
         BNE   ERR3                                                     71300021
         NI    0(PARM),X'BF'                                            71350021
         GWRITE (PARM),BUF,(REGB),2,WRKSPACE,WRKSPACE+4,MF=E            71400021
         L     PARM,GTMDECB1                                            71600021
         WAIT  ECB=(1)                                                  71800021
         L     PARM,GTMDECB1                                            72000021
         CLI   0(PARM),X'7F'                                            72050021
         BNE   ERR3                                                     72100021
         NI    0(PARM),X'BF'                                            72150021
         GCNTRL (PARM),STR,(REGB),(REGA),MF=E                           72200021
*                                                                       72400021
         EJECT                                                     1720 72500021
*        THE GDSOVDAT AND GDSFCBUF FIELDS IN THE GDSCB ARE SET TO       72600021
*        ZERO TO INDICATE THAT THERE IS NO FLOW CONTROL ENTRY FOR       72800021
*        THIS GDS AND CONTROL IS RETURNED TO THE CALLING PROGRAM.       73000021
         XC    GDSOVDAT(4),GDSOVDAT ZERO GDSCB FIELDS                   73200021
         XC    GDSFCBUF(2),GDSFCBUF                                     73400021
         B     FLC00030            EXIT                                 73600021
FLC00090 LH    ENTRY,BUFADR(TABLE)                                      73800021
         B     FLC00080                                                 74000021
         EJECT                                                          74200021
**                                                                      74400021
**                                                                      74600021
**       CODE 4                                                         74800021
**       DELETE THE FLOW CONTROL STRUCTURE                              75000021
**                                                                      75200021
**                                                                      75400021
*                                                                       75600021
*        TO DELETE THE FLOW CONTROL STRUCTURE AND TABLE THE FOLLOWING   75800021
*        OCCURS.  FIRST OUTSTANDING I/O IS WAITED ON.  THEN THE         76000021
*        REGENERATION IN THE BUFFER IS HALTED.  THIS IS WAITED ON AND   76200021
*        THEN THE STORAGE OBTAINED FOR THE FLOW CONTROL TABLE AND THE   76400021
*        DECB IS FREED.                                                 76600021
*                                                                       76800021
FLC00100 L     GTMREG,4(PARM)      LOAD GTMCB                           77000021
         L     REGB,GTMDECB1       LOAD DECB                            77200021
         LR    PARM,REGB                                                77400021
         WAIT  ECB=(1)             WAIT ON PRIOR I/O                    77600021
         CLI   0(REGB),X'7F'                                            77660021
         BNE   ERR3                                                     77720021
         XC    0(4,REGB),0(REGB)   ZERO ECB                             77800021
         L     TABLE,GTMFCTBL      TABLE ADDR                           78000021
         LA    REGA,BUFADR(TABLE)  ADDRESS AT WHICH TO STOP             78200021
         L     REGC,GTMGRDCB       DCB ADDR                             78400021
         LR    PARM,REGB                                                78600021
         GCNTRL (PARM),HLT,(REGC),(REGA),MF=E HALT REGENERATION         78800021
         LR    PARM,REGB                                                79200021
         WAIT  ECB=(1)             WAIT ON I/O                          79400021
         CLI   0(REGB),X'7F'                                            79460021
         BNE   ERR3                                                     79520021
         LA    REGZERO,FLCTLTBL         LENGTH OF TABLE            1720 79560021
         LR    PARM,TABLE          ADDR OF TABLE                        79600021
         FREEMAIN R,LV=(0),A=(1)   FREE TABLE & DECB                    79800021
*                                                                       80000021
*        BUFFER IS NOT FREED BECAUSE BUFFER MANAGEMENT WILL             80200021
*        DO A RLSEALL WHEN TRMDEV CALLS IT.                             80400021
*                                                                       80600021
*                                                                       80800021
*        THE ADDRESS OF THE FLOW CONTROL TABLE AND THE DECB ARE SET     81000021
*        TO ZERO IN THE GDMCB AND CONTROL IS RETURNED TO THE CALLING    81200021
*        PROGRAM.                                                       81400021
*                                                                       81600021
         XC    GTMFCTBL(4),GTMFCTBL ZERO ADDR OF FLOW CTL TABLE         81800021
         XC    GTMDECB1(4),GTMDECB1 ZERO DECB ADDR                      82000021
         B     FLC00030            EXIT                                 82200021
         EJECT                                                          82400021
*                                                                       82600021
ERR1     L     REGA,WRKRTNCD                                            82800021
         MVC   STOREXCD(4,REGA),BUFFER SET BUFFER EXCEED                83000021
ERR1A    MVI   0(REGA),EXCEED      SET STORAGE EXCEEDED CODE            83200021
ERR1B    L     SAVE,4(SAVE)                                             83400021
         RETURN (14,12),RC=4                                            83600021
*                                                                       83800021
ERR2     L     REGA,GTMGRDCB                                            84000021
         MVC   WRKSPACE+8(2),16(REGA) MOVE IN BUFFER ADDR               84200021
         LA    REGB,WRKSPACE+8                                          84400021
         RLSEBFR (REGA),(REGB),MF=(E,WRKSPACE) RELEASE BUFFER           84600021
         L     REGA,WRKRTNCD                                            84800021
         MVC   STOREXCD(4,REGA),STORAGE                                 85000021
         B     ERR1A                                                    85200021
ERR3     L     REGA,WRKRTNCD                                            85250021
         OI    0(REGA),IO                                               85300021
         B     ERR1B                                                    85350021
         EJECT                                                          85400021
FLC00110 EQU   ERR2                                                     85600021
REGZERO  EQU   0                                                        85800021
PARM     EQU   1                                                        86000021
REGA     EQU   2                                                        86200021
REGB     EQU   3                                                        86400021
REGE     EQU   4                                                        86600021
WORK     EQU   5                                                        86800021
GSPREG   EQU   6                                                        87000021
REGF     EQU   6                   ONLY USED IN CODE 2                  87200021
GTMREG   EQU   7                                                        87400021
GDSREG   EQU   8                                                        87600021
BASE     EQU   9                                                        87800021
TABLE    EQU   10                                                       88000021
REGC     EQU   11                                                       88200021
SAVE     EQU   13                                                       88400021
RETURN   EQU   14                                                       88600021
ENTRY    EQU   15                                                       88800021
FREE     EQU   0                                                        89000021
INUSE    EQU   4                                                        89200021
BUFADR   EQU   8                                                        89400021
DUMMY    EQU   10                                                       89600021
TBLEND   EQU   60                                                       89800021
FLCTLTBL EQU   92                                                       90000021
GETMN    EQU   4                                                        90200021
ASGNBFR  EQU   71                                                       90400021
INUSELEN DC    F'50'                                                    90600021
IO       EQU   X'04'                                                    90800021
BUFSTART EQU   24                                                  5743 90850021
MOVE     MVC   2(1,REGA),4(REGA)   OVERLAY TABLE TO REMOVE ENTRY        91000021
         EJECT                                                          91200021
ORDER    GINIT                                                          91400021
FIRSTORD GSRT                                                           91600021
         GTRU  *+2                                                      91800021
         GESD                                                           92000021
         GTRU  *+2                                                      92200021
         GTRU  FIRSTORD                                                 92400021
ENTRYORD GDPD                                                           92600021
         GTRU  *+2                                                      92800021
         GTRU  FIRSTORD                                                 93000021
CODE     EQU   3                                                        93200021
GDS      EQU   4                                                        93400021
TWO      DC    F'2'                                                     93600021
STOREXCD EQU   12                                                       93800021
BUFFER   DC    F'3'                                                     94000021
EXCEED   EQU   X'10'                                                    94200021
STORAGE  DC    F'4'                                                     94400021
         EJECT                                                          94600021
WORKAREA DSECT                                                          94800021
WRKPARM  DS    F                                                        95000021
WRKRTNCD DS    F                                                        95200021
WRKSPACE DS    4F                                                       95400021
WRKSAVE  DS    18F                                                      95600021
         COPY  GSPCB                                                    95800021
         COPY  GTMCB                                                    96000021
         COPY  GDSCB                                                    96200021
         END                                                            96400021
