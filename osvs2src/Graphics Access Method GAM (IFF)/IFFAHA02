*                                                                       00100013
*        BUFFER MANAGEMENT IS ENTERED FROM SEVERAL ROUTINES FROM        00200013
*        SEVERAL DIFFERENT PURPOSES.  THE BUFFER CONTROL TABLE IS       00300013
*        INITIALIZED TO ZERO BY INDEV.                                  00400013
*                                                                       00500013
*        CODE 1                                                         00600013
*        ENTRY IS MADE FROM DATA STORE-IFFAHAO5 REQUESTING 128 BYTES    00700013
*        OF BUFFER.  THIS IS THE FIRST BUFFER REQUEST FOR THIS GDS.     00800013
*        REGISTER ONE CONTAINS THE ADDRESS OF A WORK AREA.  THE         00900013
*        FIRST WORD OF THIS WORK AREA CONTAINS THE ADDRESS OF           01000013
*        A PARAMETER LIST:                                              01100013
*                                                                       01200013
*        +0     A(1)                                                    01300013
*        +4     A(GDSCB)                                                01400013
*                                                                       01500013
*        CODE 2                                                         01600013
*        ENTRY IS MADE FROM DATA STORE-IFFAHAO5 REQUESTING BUFFER FOR   01700013
*        THE FIRST TIME FOR THIS GDS.  REGISTER ONE CONTAINS THE        01800013
*        ADDRESS OF A WORK AREA.  THE FIRST WORD OF THIS WORK AREA      01900013
*        CONTAINS THE ADDRESS OF A PARAMETER LIST:                      02000013
*                                                                       02100013
*        +0     A(2)                                                    02200013
*        +4     A(GDSCB)                                                02300013
*        +8     A(SIZE)                                                 02400013
*                                                                       02500013
*        CODE 3                                                         02600013
*        ENTRY IS MADE FROM DATA STORE-IFFAHAO5 REQUESTING ADDITIONAL   02700013
*        BUFFER FOR A GDS.  THE AMOUNT OF BUFFER REQUIRED WILL BE       02800013
*        TAKEN FROM THE GDSGDOAL FIELD IN THE GDSCB.  THE PARAMETER     02900013
*        LIST IS AS FOLLOWS:                                            03000013
*                                                                       03100013
*        +0     A(3)                                                    03200013
*        +4     A(GDSCB)                                                03300013
*                                                                       03400013
*        CODE 4                                                         03500013
*        ENTRY IS MADE FROM TMGDS-IFFAAAO6 REQUESTING THAT THE          03600013
*        128 BYTE SUBSEGMENT OBTAINED FOR THIS GDS BE FREED.            03700013
*        THE PARAMETER LIST IS AS FOLLOWS:                              03800013
*                                                                       03900013
*        +0     A(4)                                                    04000013
*        +4     A(GDSCB)                                                04100013
*                                                                       04200013
*        CODE 5                                                         04300013
*        ENTRY IS MADE FROM TMGDS-IFFAAAO6 REQUESTING THAT ALL          04400013
*        BUFFER ASSIGNED TO THIS GDS BE FREED.                          04500013
*        THE PARAMETER LIST IS AS FOLLOWS:                              04600013
*                                                                       04700013
*        +0     A(5)                                                    04800013
*        +4     A(GDSCB)                                                04900013
*                                                                       05000013
*        CODE 6                                                         05100013
*        ENTRY IS MADE FROM RESET-IFFAFA12 REQUESTING THAT ALL          05200013
*        BUFFER BEYOND THE ONE WHOSE DISPLACEMENT IS PASSED BE          05300013
*        FREED.  THE PARAMETER LIST CONTAINS THE DISPLACEMENT IN        05400013
*        THE BUFFER CONTROL TABLE FOR THE LAST BUFFER SEGMENT           05500013
*        TO BE RETAINED.  THE PARAMETER LIST IS AS FOLLOWS:             05600013
*                                                                       05700013
*        +0     A(6)                                                    05800013
*        +4     A(GDSCB)                                                05900013
*        +8     A(DISP)                                                 06000013
*                                                                       06100013
*        CODE 7                                                         06200013
*        ENTRY IS MADE FROM TMDEV-IFFAAAO4 TO RELEASE ALL BUFFER        06300013
*        ASSIGNED TO THIS 2250.  BUFFER MANAGEMENT WILL ISSUE A         06400013
*        RLSEBFR-ALL MACRO AND THIS WILL ALSO RELEASE THE BUFFER        06500013
*        FLOW CONTROL MANAGEMENT OBTAINED EVEN THOUGH BUFFER MANAGE-    06600013
*        MENT DOES NOT KEEP A RECORD OF THAT BUFFER.                    06700013
*        THE PARAMETER LIST IS AS FOLLOWS:                              06800013
*                                                                       06900013
*        +0     A(7)                                                    07000013
*        +4     A(GTMCB)                                                07100013
*                                                                       07200013
*        EXTERNAL MACROS USED ARE:                                      07300013
*                                                                       07400013
*        ASGNBFR                                                        07500013
*        RLSEBFR                                                        07600013
*                                                                       07700013
*                                                                       07800013
*        THE BUFFER CONTROL TABLE CONTAINS THREE BYTE ENTRIES WHICH     07900013
*        VARY DEPENDING ON HOW THE BUFFER IS ASSIGNED.  THE DIFFERENT   08000013
*        RECOGNIZEABLE CODES USED ARE AS FOLLOWS:                       08100013
*        00 IF ALL THREE TYPES CONTAIN ZERO THE SEGMENT IS NOT          08200013
*        ASSIGNED.                                                      08300013
*        01-7F IF THE FIRST BYTE CONTAINS ONE OF THESE CODES THE        08400013
*        SEGMENT IS ASSIGNED TO A GDS WHICH HAS A GDOA LENGTH WHICH     08500013
*        IS A MULTIPLE OF 256.                                          08600013
*        80 THIS IS THE CODE WHEN HALF OF A SEGMENT IS NOT ASSIGNED     08700013
*        AND THE OTHER HALF IS ASSIGNED TO A 128 GDS.  IT MAY           08800013
*        APPEAR IN THE FIRST OR SECOND BYTE OF THE ENTRY BUT IF         08900013
*        IT IS IN THE SECOND BYTE, THE FIRST BYTE WILL CONTAIN A        09000013
*        NUMBER BETWEEN 81 AND FF.                                      09100013
*        81-FF IF EITHER THE FIRST OR SECOND TYTE OF AN ENTRY           09200013
*        CONTAINS ONE OF THESE CODES HALF THE BUFFER IS ASSIGNED TO     09300013
*        THE GDS WHICH HAS THIS ID.  IF THE CODE IS IN THE FIRST        09400013
*        HALF THE FIRST HALF IS ASSIGNED, IF IN THE SECOND HALF,        09500013
*        THE SECOND HALF IS ASSIGNED.                                   09600013
*                                                                       09700013
*                                                                       09800013
*        EXAMPLES OF SUBSEGMENTS (128 BYTE GDOA)                        09900013
*        BYTE 1     BYTE2     BYTE3                                     10000013
*        X'80'      X'92'     X'00' FIRST UNASSIGNED, SECOND ASSIGNED   10100013
*        X'87'      X'80'     X'00' FIRST ASSIGNED, SECOND UNASSIGNED   10200013
*        X'83'      X'F2'     X'00' BOTH ASSIGNED.                      10300013
*                                                                       10400013
*        NOTE THAT BYTE3 IS ALWAYS ZERO. X'80' IN BYTES ONE AND TWO     10500013
*        CAN NEVER OCCUR BECAUSE IF BOTH ARE FREE THE SLOT IS SET TO    10600013
*        ZERO AND THE BUFFER IS RETURNED TO THE SYSTEM.                 10700013
*                                                                       10800013
*        EXAMPLES OF 256 SEGMENTS (256 BYTE GDOA)                       10900013
* DISP   BYTE1      BYTE2     BYTE3                                     11000013
* +0     X'02'      X'02'     X'00' FIRST ASSIGNED                      11100013
* +3     X'02'      X'01'     X'02' LAST ON CHAIN                       11200013
* +6     X'02'      X'01'     X'01' SECOND ASSIGNED                     11300013
*                                                                       11400013
*        THE FIRST ASSIGNED GETS THE UNIQUE CODE, X'02' THE COUNT (BYTE 11500013
*        3) IS ZERO TO SIGNIFY THIS IS THE FIRST ASSIGNED.  THE SECOND  11600013
*        BYTE POINTS TO THE NEXT ON THE CHAIN.  THE SECOND ASSIGNED HAS 11700013
*        A COUNT OF ONE AND POINTS TO THE THIRD.  THE THIRD HAS A COUNT 11800013
*        OF TWO AND POINTS TO ITSELF TO SIGNIFY LAST ON CHAIN.  THE     11900013
*        REASON FOR THE COUNT IS THAT THE LOGICAL ADDRESS DIVIDED BY    12000013
*        THE GDOA LENGTH WILL GIVE THE SEGMENT COUNT WHEN CONVERTING    12100013
*        FROM LOGICAL TO PHYSICAL BUFFER ADDRESSES                      12200013
*                                                                       12300013
*                                                                       12400013
*        EXAMPLE OF 768 SEGMENT (768 BYTE GDOA)                         12500013
* DISP   BYTE1      BYTE2     BYTE3                                     12600013
* +0                                                                    12700013
* +3     X'05'      X'04'     X'00' FIRST ASSIGNED                      12800013
* +6     X'05'      X'01'     X'FF'                                     12900013
* +9     X'05'      X'01'     X'FF'                                     13000013
* +12    X'05'      X'04'     X'01' SECOND ASSIGNED                     13100013
* +15    X'05'      X'04'     X'FF'                                     13200013
* +18    X'05'      X'04'     X'FF'                                     13300013
*                                                                       13400013
*        THE FIRST ASSIGNED HAS THE ID, PTR TO NEXT, AND COUNT IN       13500013
*        THE FIRST ENTRY.  FOR THE OTHER TWO WHICH ARE CONTINUOUS       13600013
*        WITH THE FIRST AND TOGETHER WITH THE FIRST FORM THE 768        13700013
*        BYTES, THE CODE ALSO IS SET.  THE POINTER FIELD POINTS         13800013
*        BACK TO THE FIRST SEGMENT AND THE COUNT FIELD IS SET TO        13900013
*        X'FF' TO SIGNIFY IT IS A PART OF A LARGER SEGMENT BUT          14000013
*        NOT THE TOP.                                                   14100013
*                                                                       14200013
         EJECT                                                          14300013
IFFAHA02 CSECT                                                          14400013
*2413,299000,300000                                                5858 14450016
*                                                                       14500013
*        ON ENTRY REGARDLESS OF THE REQUEST, BASE REGISTER IS           14600013
*        INITIALIZED, THE SAVE AREAS ARE CHAINED, THE FLAGS ARE         14700013
*        SET TO ZERO.  IF THE CODE IS NOT 7 (RELEASE ALL) THE           14800013
*        GDSCB IS INITIALIZED AND THE GTMCB IS INITIALIZED, AND         14900013
*        REGA CONTAINS THE ADDRESS OF THE BUFFER CONTROL TABLE.         15000013
*        THEN THE ENTRY REQUEST IS DETERMINED AND THE PROPER            15100013
*        LOCATION IN BUFFER MANAGEMENT RECEIVES CONTROL.                15200013
*                                                                       15300013
BUFMGT   SAVE  (14,12)                                                  15400013
         BALR  BASE,0                                                   15500013
         USING *,BASE                                                   15600013
         LR    WORK,PARM           LOAD INTO DSECT REGISTER             15700013
         USING WORKAREA,WORK                                            15800013
         L     PARM,WRKPARM        PICK UP PARAMETER LIST               15900013
         LA    REGA,WRKSAVE        SET UP SAVE AREA                     16000013
         ST    SAVE,WRKSAVE+4                                           16100013
         ST    REGA,8(SAVE)                                             16200013
         LR    SAVE,REGA                                                16300013
         XC    WRKFLAGS(4),WRKFLAGS CLEAR FLAGS                         16400013
         CLI   CODE(PARM),TRMCLS   CODE TO CLOSE TERM                   16500013
         BE    BUF00260                                                 16600013
         L     GDSREG,GDS(PARM)    PICK UP GDS ADDR                     16700013
         USING GDSCB,GDSREG                                             16800013
         L     GTMREG,GDSGTMCB     GTMCB ADDR                           16900013
         USING GTMCB,GTMREG                                             17000013
         L     REGA,GTMBCTBL       BCT TABLE ADDR                       17100013
         CLI   CODE(PARM),SEG128   CODE TO ALLOC 128                    17200013
         BE    BUF00005                                                 17300013
         CLI   CODE(PARM),SEG256   NEW 256 MULTIPLE                     17400013
         BE    BUF00080                                                 17500013
         CLI   CODE(PARM),MORE256  MORE 256 MULT                        17600013
         BE    BUF00130                                                 17700013
         CLI   CODE(PARM),GDSCL128 CLOSE 128                            17800013
         BE    BUF00160                                                 17900013
         CLI   CODE(PARM),GDSCL256 CLOSE MULT 256                       18000013
         BE    BUF00200                                                 18100013
         CLI   CODE(PARM),RESET    RESET                                18200013
         BE    BUF00250                                                 18300013
         WTO   'BUFMGT WRONG CODE'                                      18400013
         EJECT                                                          18500013
**                                                                      18600013
**                                                                      18700013
**       CODE 1                                                         18800013
**       ALLOCATE 128 BYTE BUFFER SEGMENT TO A GDS BEING OPENED         18900013
**                                                                      19000013
**                                                                      19100013
*                                                                       19200013
*        THE CODE 1 THE ENTIRE BUFFER CONTROL TABLE IS SEARCHED         19300013
*        FOR A FREE SUBSEGMENT.  IF ONE IS NOT FOUND, BUFFER IS         19400013
*        ASSIGNED AND THE SECOND HALF OF THE ENTRY FOR THE BUFFER       19500013
*        RECEIVED IS SET TO X'80' SIGNIFYING NOT IN USE AND THE         19600013
*        FIRST HALF IS USED.  A UNIQUE CODE IS OBTAINED BY ADDING       19700013
*        X'81' TO THE GTMBCTSM FIELD OF THE GTMCB OR BY USING           19800013
*        THE INTERNAL SUBROUTINE TO FIND A UNIQUE CODE NOT IN           19900013
*        USE.  THE UNIQUE CODE IS PLACED IN THE BUFFER CONTROL          20000013
*        TABLE AND IN THE GDSCB.  THE ADDRESS OF THE BUFFER             20100013
*        OBTAINED IS RETURNED IN REGISTER ONE AND CONTROL IS            20200013
*        RETURNED TO THE CALLING PROGRAM                                20300013
*                                                                       20400013
BUF00005 LR    REGD,REGA           ADDR OF BCT                          20500013
         LR    REGB,REGA           ADDR OF BCT                          20600013
         LA    REGC,3              ENTRY SIZE                           20700013
         LA    REGD,BCTLEN(REGD)   ADD LENGTH ( FOR LOOP )              20800013
BUF00010 CLI   0(REGB),X'80'       IS SEG DIV?                          20900013
         BNL   BUF00030            YES                                  21000013
BUF00020 BXLE  REGB,REGC,BUF00010  NO LOOK MORE                         21100013
         L     REGB,GTMGRDCB       ADDR OF DCB                          21200013
         LA    REGC,256            ASSIGN                               21300013
         STH   REGC,WRKSPACE+8     BUFFER                               21400013
         ASGNBFR (REGB),WRKSPACE+8,MF=(E,WRKSPACE) ASSIGN BUFFER        21500013
         LTR   15,15                                                    21600013
         BNE   ERR1                                                     21700013
         LH    REGD,16(REGB)       ADDR OF BUFFER                       21800013
         ST    REGD,WRKSPACE       SAVE ADDR OF BUFFER                  21900013
         SRA   REGD,8              DIVIDE BY 256                        22000013
         STH   REGD,GDSBCTEL        PLACE INDEX IN GDSCB                22100013
         M     REGC,=F'3'          MULTIPLY BY 3 FOR DISPLACEMENT       22200013
         AR    REGD,REGA                                                22300013
         MVI   1(REGD),X'80'       SET SECOND BYTE=NOT IN USE           22400013
         B     BUF00060                                                 22500013
BUF00030 CLI   0(REGB),X'80'       IS BYTE IN USE                       22600013
         BE    BUF00040            NO                                   22700013
         CLI   1(REGB),X'80'       YES, IS SECOND IN USE                22800013
         BNE   BUF00020            YES, LOOK SOME MORE                  22900013
         OI    WRKFLAGS,X'01'      SET SECOND BYTE FLAG                 23000013
BUF00040 LR    REGD,REGB           COMPUTE DISPLACEMENT                 23100013
         SR    REGD,REGA                                                23200013
         SR    REGC,REGC           FOR DIVIDE                           23300013
         D     REGC,=F'3'     BUFFER ADDRESS IN REGD                    23400013
         STH   REGD,GDSBCTEL       INDEX TO ELEMENT                     23500013
         SLA   REGD,8              MULTIPLY BY 256                      23600013
         CLI   WRKFLAGS,X'01'                                           23700013
         BNE   BUF00050                                                 23800013
         LA    REGD,128(REGD)                                           23900013
         ST    REGD,WRKSPACE  SAVE BUFFER ADDRESS                       24000013
         LA    REGB,1(REGB)   UPDATE TO SECOND BYTE                     24100013
BUF00050 LR    REGD,REGB      SET PTR IN REGD                           24200013
BUF00060 CLI   GTMBCTSM,X'7E' CAN ID BE OBTAINED EASILY                 24300013
         BH    BUF00075       LINK TO CODE FINE ROUTINE                 24400013
         IC    REGC,GTMBCTSM                                            24500013
         LA    REGB,X'81'     COMPUTE NEW ID                            24600013
         AR    REGB,REGC                                                24700013
         LA    REGC,1(REGC)                                             24800013
         STC   REGC,GTMBCTSM  UPDATE INDEX                              24900013
BUF00065 STC   REGB,GDSBCTID  PLACE IN GDSCB                            25000013
         STC   REGB,0(REGD)   PLACE CODE IN BCT                         25100013
BUF00067 LH    PARM,WRKSPACE+2     SET BUFFER ADDR IN REG 1             25200013
BUF00070 L     SAVE,4(SAVE)   RESET SAVE AREA                           25300013
         LM    14,0,12(SAVE)  RELOAD REGS                               25400013
         LM    2,12,28(SAVE)                                            25500013
         LA    15,0           SET RETURN = 0                            25600013
         BR    14             RETURN                                    25700013
BUF00075 LA    RETURN,BUF00065     RETURN ADDRESS                       25800013
         LA    REGB,X'81'          FIRST CODE                           25900013
         B     BUF00280            GO TO UNIQUE CODE FIND ROUTINE       26000013
         EJECT                                                          26100013
**                                                                      26200013
**                                                                      26300013
**       CODE 2                                                         26400013
**       ALLOCATE 256 BYTE SEGMENT(S) TO A GDS BEING OPENED             26500013
**                                                                      26600013
**                                                                      26700013
*                                                                       26800013
*        FOR CODE 2 BUFFER IS ASSIGNED FOR THE LENGTH DESIRED.          26900013
*        A UNIQUE CODE IS OBTAINED BY ADDING X'01' TO THE               27000013
*        GTMBCTLG FIELD IN THE GTMCB OR BY USING THE INTERNAL           27100013
*        SUBROUTINE TO FIND A UNIQUE CODE NOT IN USE.  THE              27200013
*        BUFFER CONTROL TABLE ENTRY IS SET UP AND THE UNIQUE            27300013
*        CODE, AND THE DISPLACEMENT IN THE BUFFER CONTROL               27400013
*        TABLE ARE PLACED IN THE GDSBCTID AND GDSBCTEL FIELDS           27500013
*        IN THE GDSCB.  THE ADDRESS OF THE BUFFER OBTAINED IS           27600013
*        RETURNED IN REGISTER ONE AND CONTROL IS RETURNED TO            27700013
*        THE CALLING PROGRAM.                                           27800013
*                                                                       27900013
BUF00080 L     REGB,8(PARM)        LENGTH OF BUFFER DESIRED             28000013
         STH   REGB,WRKSPACE+8                                          28100013
         L     REGB,GTMGRDCB       ADDR OF DCB                          28200013
         ASGNBFR (REGB),WRKSPACE+8,MF=(E,WRKSPACE) ASSIGN BUFFER        28300013
         LTR   15,15                                                    28400013
         BNE   ERR1                NO MORE BUFFER                       28500013
         LH    REGD,16(REGB)       ADDR OF BUFFER                       28600013
         ST    REGD,WRKSPACE       SAVE IT                              28700013
         SRA   REGD,8              DIVIDE BY 256                        28800013
         STH   REGD,GDSBCTEL       SAVE IN GDS                          28900013
         LR    REGF,REGD           BCT DISP                             29000013
         M     REGC,=F'3'                                               29100013
         LR    REGC,REGF                                           5858 29150016
         AR    REGD,REGA           DISP IN BCT                          29200013
         LH    REGA,18(REGB)       LENGTH                               29300013
         CLI   GTMBCTLG,X'7E'      HAVE ALL LARGE CODES BEEN USED       29400013
         BH    BUF00125            YES                                  29500013
         IC    REGB,GTMBCTLG       PICK UP CODE                         29600013
         LA    REGB,1(REGB)        TO GET ACTUAL CODE                   29700013
         STC   REGB,GTMBCTLG       FOR NEXT PASS                        29800013
BUF00090 STC   REGB,GDSBCTID       SAVE ID IN GDS                  5858 29870016
         LR    REGF,REGC                                           5858 29940016
         SR    REGC,REGC           INDEX                           5858 30010016
         SRA   REGA,8              DIVIDE BY 256 TO DET NO OF SEGMENTS  30100013
         LR    REGE,REGA           SAVE COUNT OF SEGMENTS               30200013
BUF00100 STC   REGB,0(REGC,REGD)   STORE CODE                           30300013
         LA    REGC,3(REGC)        TO NEXT SEGMENT                      30400013
         BCT   REGA,BUF00100       ALL DONE                             30500013
         LR    REGB,REGF           PTR TO SELF                          30600013
         SR    REGC,REGC           INDEX REG                            30700013
         LR    REGA,REGE           COUNT                                30800013
         STC   REGF,1(REGD)        LAST ON CHAIN INDICATOR              30900013
         B     BUF00115            BRANCH AROUND FIRST STORE            31000013
BUF00110 STC   REGB,1(REGC,REGD)   STORE PTR                            31100013
BUF00115 LA    REGC,3(REGC)        TO NEXT                              31200013
         BCT   REGA,BUF00110       ALL DONE                             31300013
*                                  COUNT IN FIRST SEGMENT IS ZERO THREE 31400013
*                                  FORE IT NEED NOT BE SET.             31500013
*                                  CODE 3 WILL SET COUNT FIRST          31600013
         BCTR  REGE,0              REDUCE CT BY ONE IF ONLY ONE         31700013
         LTR   REGE,REGE           ONLY ONE                             31800013
         BE    BUF00067                                                 31900013
         LA    REGB,X'FF'          CODE SAYING PART OF LARGE SEGMENT    32000013
BUF00120 LA    REGD,3(REGD)        UPDATE TO NEXT SEGMENT               32100013
         STC   REGB,2(REGD)        STORE CODE IN COUNT FIELD            32200013
         BCT   REGE,BUF00120       CONTINUE                             32300013
         B     BUF00067            EXIT                                 32400013
BUF00125 LA    RETURN,BUF00090     RETURN                               32500013
         LA    REGB,X'01'          FIRST CODE                           32600013
         B     BUF00280            ROUTINE TO FIND A CODE               32700013
         EJECT                                                          32800013
**                                                                      32900013
**                                                                      33000013
**       CODE 3                                                         33100013
**       ALLOCATE AN ADDITIONAL 256 OR MORE TO A GDS ALREADY OPEN       33200013
**                                                                      33300013
**                                                                      33400013
*                                                                       33500013
*        FOR CODE 3 A CHECK IS MADE TO SEE IF THE GDS IS NOT            33600013
*        A 128 SUBSEGMENT GDS AND IF NOT THE !UFFER IS ASSIGNED         33700013
*        FOR THE GDOA LENGTH IN THE GDSCB.  THE ENTRY IS BUILT          33800013
*        IN THE BUFFER CONTROL TABLE, THE ENTRY IS CHAINED TO           33900013
*        THE PREVIOUS ENTRY AND THE ADDRESS OF THE BUFFER OBTAINED      34000013
*        IS RETURNED IN REGISTER ONE.  THIS ENTRY USES PART OF          34100013
*        THE CODE FOR CODE 2 ENTRIES.                                   34200013
*                                                                       34300013
BUF00130 CLI   GDSBCTID,X'80'      WAS A SUBSEGMENT ASSIGNED            34400013
         BH    ERR2                YES, NO MORE BUFFER ALLOWED          34500013
         TM    GDSFLAGS,EQUIV        IS THIS AN EQUIV                   34600013
         BO    ERR2                YES NO MORE BUFFER ALLOWED           34700013
         L     REGB,GTMGRDCB       PICK UP DCB                          34800013
         ASGNBFR (REGB),GDSGDOAL,MF=(E,WRKSPACE)                        34900013
         LTR   15,15                                                    35000013
         BNE   ERR1                NO BUFFER                            35100013
         LH    REGD,16(REGB)       ADDR OF BUFFER                       35200013
         ST    REGD,WRKSPACE       SAVE ADDR                            35300013
         SRA   REGD,8              DIVIDE BY 256                        35400013
         LH    REGC,GDSBCTEL                                            35500013
         MH    REGC,THREE+2                                             35600013
         SR    REGE,REGE                                                35700013
         LA    REGF,1              REGF=1 FOR COUNT                     35800013
BUF00140 IC    REGE,1(REGC,REGA)   POINTER FIELD                        35900013
         MH    REGE,THREE+2        DISP IN TABLE                        36000013
         CR    REGE,REGC           LAST ONE                             36100013
         BE    BUF00150                                                 36200013
         LR    REGC,REGE           PTR TO NEXT                          36300013
         SR    REGE,REGE                                                36400013
         LA    REGF,1(REGF)        UPDATE COUNT                         36500013
         B     BUF00140            LOOK SOME MORE                       36600013
BUF00150 STC   REGD,1(REGC,REGA)   UPDATE PTR                           36700013
         LR    REGC,REGD           SAVE PTR                             36800013
         MH    REGD,THREE+2        DISP                                 36900013
         STC   REGF,2(REGD,REGA)   STORE COUNT                          37000013
         LR    REGF,REGC                                                37100013
         AR    REGD,REGA           DISP & TABLE START                   37200013
*                                  THE REMAINDER OF CODE 3 IS JUST LIKE 37300013
*                                  CODE 2 SO WE WILL USE THAT CODING.   37400013
         LH    REGA,18(REGB)       REGA HAS LENGTH                      37500013
*                                  REGD HAS TABLE LOC OF SEGMENT        37600013
         IC    REGB,GDSBCTID       REGB HAS ID CODE                     37700013
         B     BUF00090            GO TO CODE 2 CODE                    37800013
         EJECT                                                          37900013
**                                                                      38000013
**                                                                      38100013
**       CODE 4                                                         38200013
**       RELEASE 128 BYTES OF A SEGMENT BEING CLOSED                    38300013
**                                                                      38400013
**                                                                      38500013
*                                                                       38600013
*        FOR CODE 4 IT IS DETERMINED IF THE OTHER HALF OF THE           38700013
*        BUFFER SEGMENT IS ASSIGNED.  IF IT IS THE CODE FOR THIS        38800013
*        GDS IS REMOVED FROM THE GDSCB AND THE BUFFER CONTROL           38900013
*        TABLE ENTRY AND CONTROL IS RETURNED TO THE CALLING             39000013
*        PROGRAM.  IF BOTH SEGMENTS ARE FREE THE BUFFER IS              39100013
*        RELEASED AND THE ENTIRE BUFFER CONTROL ENTRY IS SET TO         39200013
*        ZERO.  THE ID IS ZEROED IN THE GDSCB AND CONTROL               39300013
*        IS RETURNED TO THE CALLING PROGRAM.                            39400013
BUF00160 L     REGB,THREE                                               39500013
         MH    REGB,GDSBCTEL       DISP IN TABLE                        39600013
         AR    REGA,REGB           PLUS TABLE ADDR                      39700013
         CLC   0(1,REGA),GDSBCTID  IS FIRST HALF ASSIGNED               39800013
         BE    BUF00180            YES                                  39900013
         MVI   1(REGA),X'80'       SET FREE SWITCH                      40000013
         CLI   0(REGA),X'80'       IS OTHER HALF FREE                   40100013
         BE    BUF00190                                                 40200013
BUF00170 XC    GDSBCTEL(2),GDSBCTEL ZERO INDEX                          40300013
         MVI   GDSBCTID,X'00'      ZERO ID                              40400013
         B     BUF00070            RETURN                               40500013
BUF00180 MVI   0(REGA),X'80'       SET FREE SWITCH                      40600013
         CLI   1(REGA),X'80'       SECOND FREE                          40700013
         BNE   BUF00170            NO                                   40800013
BUF00190 XC    0(3,REGA),0(REGA)   ZERO OUT SLOT                        40900013
         LH    REGB,GDSBCTEL       DISP IN TABLE                        41000013
         SLA   REGB,8              ADDR OF BUFFER                       41100013
         STH   REGB,WRKSPACE+8     STORE IN HALFWORD                    41200013
         LA    REGB,256            LENGTH                               41300013
         STH   REGB,WRKSPACE+10    IN OTHER HALFWORD                    41400013
         L     REGB,GTMGRDCB       DCB                                  41500013
         RLSEBFR (REGB),WRKSPACE+8,MF=(E,WRKSPACE) RELEASE BUFFER       41600013
         B     BUF00170                                                 41700013
         EJECT                                                          41800013
**                                                                      41900013
**                                                                      42000013
**       CODE 5                                                         42100013
**       RELEASE ALL 256 BYTE SEGMENTS ALLOCATED TO A GDS BEING CLOSED  42200013
**                                                                      42300013
**                                                                      42400013
*                                                                       42500013
*        FOR CODE 5 A CHECK IS MADE TO SEE IF ALL BUFFER WAS            42600013
*        RELEASED BY THE TMDEV ROUTINE PREVIOUSLY AND IF SO             42700013
*        RETURN IS MADE TO THE CALLING PROGRAM.  OTHERWISE THE          42800013
*        BUFFER CONTROL TABLE IS CHAINED THROUGH, THE BUFFER            42900013
*        IS FREED AND ALL ENTRIES ARE SET TO ZERO.  THE GDSBCTEL        43000013
*        AND GDSBCTID FIELDS OF THE GDSCB ARE SET TO ZERO.  WHEN        43100013
*        ALL BUFFER IS FREED, RETURN IS MADE TO THE CALLING PROGRAM.    43200013
*                                                                       43300013
BUF00200 CLI   GDSBCTID,X'00'      RELEASED BY TERMINAL                 43400013
         BE    BUF00070            RETURN                               43500013
         LH    REGB,GDSBCTEL       DISP                                 43600013
         MH    REGB,THREE+2        DISP IN TBL                          43700013
         XC    GDSBCTEL(2),GDSBCTEL ZERO OUT FIELD                      43800013
         MVI   GDSBCTID,X'00'      ZERO ID                              43900013
BUF00210 L     REGF,GTMGRDCB       LOAD DCB                             44000013
         MVC   WRKSPACE+10(2),GDSGDOAL LEN OF BUFFER                    44100013
BUF00215 LR    REGC,REGB           DISP                                 44200013
         SLA   REGC,8              TIMES BUFFER LEN OF 256 = BUF ADDR   44300013
         SRDA  REGC,32             SHIFT TO ODD REGISTER FOR DIVIDE     44400013
         D     REGC,THREE          DIVIDE BY THREE                      44500013
         STH   REGD,WRKSPACE+8                                          44600013
         RLSEBFR (REGF),WRKSPACE+8,MF=(E,WRKSPACE)                      44700013
         SR    REGD,REGD           ZERO REGISTER                        44800013
         IC    REGD,1(REGB,REGA)   PICK UP NEXT PTR                     44900013
         MH    REGD,THREE+2        DISP IN TBL                          45000013
         CR    REGD,REGB           ALL DONE                             45100013
         BE    BUF00240            YES                                  45200013
BUF00220 LH    REGE,GDSGDOAL       LENGTH DIV BY                        45300013
         SRA   REGE,8              256 = NO OF SEGMENTS                 45400013
         AR    REGB,REGA           DISP + BCT ADD                       45500013
BUF00230 XC    0(3,REGB),0(REGB)   ZERO SLOT                            45600013
         LA    REGB,3(REGB)        TO NEXT SLOT                         45700013
         BCT   REGE,BUF00230                                            45800013
         CLI   WRKFLAGS,X'FF'      ALL DONE                             45900013
         BE    BUF00070            YES, LEAVE                           46000013
         LR    REGB,REGD           UPDATE REGS                          46100013
         B     BUF00215            GO RELEASE REST                      46200013
BUF00240 MVI   WRKFLAGS,X'FF'      SET ALL DONE FLAGS                   46300013
         B     BUF00220            RETURN TO CLEAR SLOTS                46400013
         EJECT                                                          46500013
**                                                                      46600013
**                                                                      46700013
**       CODE 6                                                         46800013
**       RELEASE ONE OR MORE 256 BYTE SEGMENTS RECENTLY ALLOCATED TO A  46900013
**       GDS REMAINING OPEN.                                            47000013
**                                                                      47100013
*                                                                       47200013
*        FOR CODE 6 A CHECK IS MADE TO SEE IF THE DISPLACEMENT IN       47300013
*        THE BUFFER CONTROL TABLE THAT WAS PASSED POINTS TO THE         47400013
*        LAST ENTRY IN THE TABLE FOR THAT GDS.  IF SO CONTROL IS        47500013
*        RETURNED TO THE CALLING PROGRAM.  OTHERWISE POINTERS ARE       47600013
*        SET UP TO THE BUFFER THAT MUST BE RELEASED AND THE CODING      47700013
*        FOR CODE 5 IS USED TO FREE THE BUFFER AND ZERO THE BUFFER      47800013
*        CONTROL TABLE.  THEN RETURN IS MADE TO THE CALLING PROGRAM.    47900013
*                                                                       48000013
BUF00250 SR    REGB,REGB                                                48100013
         L     REGC,8(PARM)        LOAD BUFFER SEGMENT ADDR             48200013
         LR    REGD,REGC           PTR TO SELF                          48300013
         MH    REGC,THREE+2        DISP IN TBL                          48400013
         IC    REGB,1(REGC,REGA)   OBTAIN PTR                           48500013
         MH    REGB,THREE+2                                             48600013
         CR    REGB,REGC           IS THIS THE LAST SEGMENT             48700013
         BE    BUF00070            YES                                  48800013
         STC   REGD,1(REGC,REGA)   SET PTRS TO LAST ON CHAIN            48900013
         B     BUF00210            NO GO TO CODE 5 TO RELEASE BUFFER.   49000013
         EJECT                                                          49100013
**                                                                      49200013
**                                                                      49300013
**       CODE 7                                                         49400013
**       RELEASE ALL BUFFER SEGMENTS CURRENTLY ASSIGNED TO A TERM BEING 49500013
**       CLOSED                                                         49600013
**                                                                      49700013
*                                                                       49800013
*        FOR CODE 7 ALL BUFFER IS RELEASED USING THE ALL PARAMETER      49900013
*        IN THE RLSEBFR MACRO.  THE ENTIRE BUFFER CONTROL TABLE IS      50000013
*        SET TO ZERO.  ALL GDSS STILL OPEN HAVE THEIR ID BYTES AND      50100013
*        DISPLACEMENT FIELDS SET TO ZERO.  CONTROL IS THEN RETURNED     50200013
*        TO THE CALLING PROGRAM.                                        50300013
*                                                                       50400013
BUF00260 L     GTMREG,4(PARM)      LOAD ADDR OF GTMCB                   50500013
         L     REGB,GTMGRDCB            ADDR OF DCB                     50600013
         RLSEBFR (REGB),ALL,MF=(E,WRKSPACE) RELEASE ALL BUFFER          50700013
         L     REGA,GTMBCTBL       LOAD ADDR OF BCT                     50900013
         XC    0(256,REGA),0(REGA) ZERO BCT                             51000013
         XC    256(BCTACTLN-256,REGA),256(REGA)                         51100013
         L     GDSREG,GTMGDSCB     PICK UP GDS                          51200013
BUF00270 LTR   GDSREG,GDSREG       ANY THERE                            51300013
         BE    BUF00070            EXIT                                 51400013
         MVI   GDSBCTID,X'00'       ZERO ID                             51500013
         XC    GDSBCTEL(2),GDSBCTEL ZERO ELEM                           51600013
         L     GDSREG,GDSNXGDS     NEXT ON CHAIN                        51700013
         B     BUF00270                                                 51800013
         EJECT                                                          51900013
**                                                                      52000013
**                                                                      52100013
**       ROUTINE TO FIND A UNIQUE CODE. THERE MUST BE ONE AT LEAST      52200013
**       BECAUSE ONLY 24 SEPARATE GDS' ARE ALLOWED                      52300013
**       USES REGS E AND F RETURNS CODE IN REGB                         52400013
**                                                                      52500013
BUF00280 MVI   WRKFLAGS+1,X'00'    ZERO FLAGS TO SAY ONLY ONCE          52600013
BUF00290 STC   REGB,WRKSPACE       CODE                                 52700013
         L     REGF,GTMBCTBL       ADDR OF TABLE                        52800013
BUF00300 LA    REGE,BCTENTRS       LOOP CONTROL (INNER)                 52900013
BUF00310 CLC   0(1,REGF),WRKSPACE  IS IT USED                           53000013
         BE    BUF00320            YES                                  53100013
         LA    REGF,3(REGF)        NOT YET                              53200013
         BCT   REGE,BUF00310                                            53300013
         CLI   WRKSPACE,X'80'      IS IT A LARGE CODE                   53400013
         BCR   4,RETURN            YES, WE FOUND IT                     53500013
         CLI   WRKFLAGS+1,X'01'    NO, HAVE WE LOOPED TWICE             53600013
         BCR   8,RETURN            YES                                  53700013
         L     REGF,GTMBCTBL                                            53800013
         LA    REGF,1(REGF)        POSITION TO SECOND BYTE              53900013
         MVI   WRKFLAGS+1,X'01'    SET FLAG                             54000013
         B     BUF00300                                                 54100013
BUF00320 MVI   WRKFLAGS+1,X'00'    CLEAR FLAGS                          54200013
         LA    REGB,1(REGB)        UPDATE TO NEXT ID                    54300013
         B     BUF00290                                                 54400013
BUF00330 L     SAVE,4(SAVE)        RESET SAVE AREA                      54500013
         RETURN (14,12),RC=0       RETURN                               54600013
ERR1     L     REGB,WRKRTNCD                                            54700013
         MVI   0(REGB),X'10'       STORAGE EXCEEDED                     54800013
         MVI   15(REGB),X'03'      BUFFER EXCEEDED                      54900013
BUF00340 L     SAVE,4(SAVE)                                             55000013
         RETURN (14,12),T,RC=4                                          55100013
ERR2     L     REGB,WRKRTNCD                                            55200013
         MVI   0(REGB),X'10'       STORAGE EXCEEDED                     55300013
         MVI   15(REGB),X'02'      SELF IMPOSED LIMIT                   55400013
         B     BUF00340            RETURN                               55500013
         EJECT                                                          55600013
REGZERO  EQU   0                                                        55700013
PARM     EQU   1                                                        55800013
REGA     EQU   2                                                        55900013
REGB     EQU   3                                                        56000013
REGE     EQU   4                                                        56100013
WORK     EQU   5                                                        56200013
REGF     EQU   6                                                        56300013
GTMREG   EQU   7                                                        56400013
GDSREG   EQU   8                                                        56500013
BASE     EQU   9                                                        56600013
REGC     EQU   10                  EVEN/ODD PAIR                        56700013
REGD     EQU   11                  EVEN/ODD PAIR                        56800013
SAVE     EQU   13                                                       56900013
RETURN   EQU   14                                                       57000013
RLSEBFR  EQU   71                                                       57100013
ASGNBFR  EQU   71                                                       57200013
BCTLEN   EQU   381                 NOTE: THIS IS LENGTH LESS THREE      57300013
BCTACTLN EQU   384                                                      57400013
BCTENTRS EQU   128                                                      57500013
EQUIV    EQU   X'80'                                                    57600013
CODE     EQU   3                                                        57700013
GDS      EQU   4                                                        57800013
TRMCLS   EQU   7                                                        57900013
SEG128   EQU   1                                                        58000013
SEG256   EQU   2                                                        58100013
MORE256  EQU   3                                                        58200013
GDSCL128 EQU   4                                                        58300013
GDSCL256 EQU   5                                                        58400013
RESET    EQU   6                                                        58500013
THREE    DC    F'3'                                                     58600013
         EJECT                                                          58700013
WORKAREA DSECT                                                          58800013
WRKPARM  DS    F                                                        58900013
WRKRTNCD DS    F                                                        59000013
WRKFLAGS DS    F                                                        59100013
WRKSPACE DS    3F                                                       59200013
WRKSAVE  DS    18F                                                      59300013
         COPY  GSPCB                                                    59400013
         COPY  GTMCB                                                    59500013
         COPY  GDSCB                                                    59600013
         END                                                            59700013
