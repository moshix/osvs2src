         TITLE 'IFFAHA13-UPDATE ROUTINE'                                00100000
*                                                                       00200000
*        UPDATE IS ENTERED DIRECTLY FROM PLINE/PPOINT,PSEGMT,           00300000
*        MVPOS/STPOS, AND PTEXT. IT IS ALSO ENTERED BY ORGEN TO         00400000
*        SUPPLY WORK OACBS EVEN FOR A NON-UPDATE SITUATION.             00500000
*             THE UPDATE PARMLIST IS IDENTICAL TO THE DATAGEN           00600000
*        PARMLIST THESE ROUTINES USE.   REGISTER 1 WILL POINT TO        00700000
*        THE AREA DESCRIBED BELOW.                                      00800000
*                                                                       00900000
*                                                                       01000000
*                             +0   KEY                                  01100000
*                             +4   3F  IGNORED                          01200000
*                             +16  A(GDS)                               01300000
*                             +20  A(RTN ARRAY)                         01400000
*                             +24  11F IGNORED                          01500000
*                             +68  WORK AREA(30 WDS LONG)   D11         01600000
*                                                                       01700000
*                                                                       01800000
*        ENTRY POINTS:  IFFAHA13-TO OBTAIN THE GDOAS AND OACBS          01900000
*        FOR THE UPDATE.                                                02000000
*        IFFAHA14-TO WRITE OUT THE GDOAS ON A SUCCESSFUL UPDATE.        02100000
*        FOR AN UNSUCCESSFUL UPDATE, DATA STORE WILL FREE THE           02200000
*        STORAGE OBTAINED AND THIS ENTRY POINT WILL NEVER BE            02300000
*        CALLED.                                                        02400000
*                                                                       02500000
*        EXTERNAL MACROS:          EXTERNAL ROUTINES:                   02600000
*        GETMAIN                   DATASTORE (IFFAHA05)                 02700000
*        WAIT                                                           02800000
*        GWRITE                                                         02900000
*        GCNTRL                                                         03000000
*        FREEMAIN                                                       03100000
*                                                                       03200000
*        NOTE: ORGEN WILL USE THE UPDATE MODULE TO CREATE GDOAS         03300000
*        AND OACBS FOR ITS WORK AREA EVEN THUUGH ORGEN IS NOT BEING     03400000
*        UPDATED. IT WILL EXIT BEFORE ANY BUFFER ADDRESSES ARE          03500000
*        COMPUTED.                                                      03600000
*                                                                       03700000
         EJECT                                                          03800000
*                                                                       03900000
*        ON ENTRY THE REGISTERS ARE SAVED, THE BASE REGISTER IS         04000000
*        ESTABLISHED, THE WORK AREA DSECT IS ESTABLISHED, THE           04100000
*        GDSCB DSECT IS ESTABLISHED, AND THE GTMCB DSECT IS             04200000
*        ESTABLISHED, THE SAVE AREAS ARE CHAINED AND THE RETURN         04300000
*        ARRAY ADDRESS IS PLACED IN A REGISTER.                         04400000
*A806000                                                 1046,1557,1676 04500000
*A694000-696000                                                  A43072 04600000
*A152000-174000,816000                                       LD YA00808 04700000
*A474000                                                     LD YA00807 04800000
*A778000                                                    D11 ZA08043 04900000
*A726500-727000,742100-743960,818100-818400,926200-927000   D11 ZA11418 05000000
*A434600-435200,A454600-455200,C45600,45800,A480800-481600, D11 ZA10053 05100000
*C526000,A526600-527200,A85700                              D11 OZ10053 05200000
*A100010,A100030-100100,C102000,C580000-584000              D11 OZ15418 05300000
         EJECT                                              D11         05400000
IFFAHA13 CSECT                     EP FOR IFFAHA13                      05500000
         USING *,REGFIFTN                                   D11 ZA15418 05600000
         SAVE  (14,12)                                                  05700000
         B     STARTH13                                     D11 ZA15418 05800000
         DROP  REGFIFTN                                     D11 ZA15418 05900000
         ENTRY IFFAHA14                                     D11 ZA15418 06000000
IFFAHA14 DS    0H                  EP FOR IFFAHA14          D11 ZA15418 06100000
         USING *,REGFIFTN                                   D11 ZA15418 06200000
         SAVE  (14,12)                                      D11 ZA15418 06300000
         B     STARTH14                                     D11 ZA15418 06400000
         DROP  REGFIFTN                                     D11 ZA15418 06500000
STARTH13 BALR  BASE,0              STARTS HERE              D11 ZA15418 06600000
         USING *,BASE                                                   06700000
         LR    WORK,PARM                                                06800000
         USING WORKAREA,WORK       WORKAREA                             06900000
         L     GDSREG,WRKGDS                                            07000000
         USING GDSCB,GDSREG        GDSCB                                07100000
         L     GTMREG,GDSGTMCB     GTMCB                                07200000
         USING GTMCB,GTMREG                                             07300000
         LA    REGA,WRKSAVE        CHAIN SAVE AREAS                     07400000
         ST    REGA,8(SAVE)                                             07500000
         ST    SAVE,4(REGA)                                             07600000
         LR    SAVE,REGA                                                07700000
         L     ERRCD,WRKRTN        RETURN ARRAY                         07800000
         EJECT                                                          07900000
*                                                                       08000000
*        THE LENGTH OF THE GDOAS AND ASSOCIATED OACBS IS COMPUTED       08100000
*        AND STORAGE IS OBTAINED FOR THEM. IF STORAGE IS NOT            08200000
*        AVAILABLE, AN ERROR CODE IS PLACED IN THE RETURN ARRAY         08300000
*        AND CONTROL IS RETURNED TO THE CALLING PROGRAM.                08400000
         LH    REGC,WRKADDR        LOG LENGTH AND                       08500000
         LH    REGA,WRKADDR+2      LOG ADDR FROM KEYTAB                 08600000
         SRDA  REGA,32             IN ODD REG                           08700000
         LH    REGD,GDSGDOAL       GDOA LEN                             08800000
         S     REGD,SIX            GDOA LEN - 6                         08900000
         DR    REGA,REGD           CT IN REGB, REM IN REGA              09000000
         CLI   WAORFLGS(WORK),X'FC'     ORGEN CALL?          LD YA00808 09100000
         BNE   UPD00050            NO, BRANCH AROUND         LD YA00808 09200000
         LTR   REGA,REGA           ZERO REMAINDER?           LD YA00808 09300000
         BNZ   UPD00050            IF NO, PREVIOUS ELEMENT...LD YA00808 09400000
*                                  ...SIZE IS GIVEN BY...    LD YA00808 09500000
*                                  ...THE REMAINDER          LD YA00808 09600000
         LR    REGA,REGD           IF YES,GDOALEN-6......    LD YA00808 09700000
*                                  ...BECOMES PREVIOUS...    LD YA00808 09800000
*                                  ...ELEMENT SIZE           LD YA00808 09900000
         BCTR  REGB,0              DECREMENT COUNT           LD YA00808 10000000
* THE ADDITION OF (GDOALEN-6) IS BALANCED BY DECREMENTING   D11         10100000
* THE COUNT OF SECTIONS IN REGB.                            D11         10200000
UPD00050 EQU   *                                             LD YA00808 10300000
         ST    REGB,WRKSPACE       SAVE BCT COUNT            LD YA00808 10400000
         LA    REGE,ONE            ASSUME 1 GDOA IS ENOUGH              10500000
         LR    REGB,REGD           INIT.AVAIL LEN IN GDOA               10600000
         SR    REGB,REGA   - PREV ELEM LEN = CURR AVAIL LEN             10700000
         CR    REGC,REGB  THIS ELEM LEN LT CURR AVAIL LEN??             10800000
         BNH   UPD00200            YES,ONLY 1 GDOA NEEDED               10900000
         SR    REGC,REGB NO,SUB FROM THIS ELEMLEN 1GDOA  1046,1557,1676 11000000
UPD00100 LA    REGE,ONE(REGE)      ADD ONE GDOA TO RQMNT                11100000
         CR    REGC,REGD DOES REMNDR OF LOGLEN FIT IN THIS GDOA?        11200000
         BNH   UPD00200            YES,GO GET NUMBER OF GDOAS NEEDED    11300000
         SR    REGC,REGD  NO,DECR LOGLEN RMNDR BY A GDOALEN             11400000
         B     UPD00100            AND TRY AGAIN                        11500000
         EJECT                                                          11600000
UPD00200 LH    REGD,GDSGDOAL  LEN OF EACH GDOA                          11700000
         A     REGD,OACBLEN   + LENGTH OF ITS OACB=TOT LEN FOR EACH     11800000
         L     REGB,WRKSPACE SAVE BFR CONT TABLE COUNT ACROSS GETMN     11900000
         MR    REGC,REGE     LEN PER EACH * NUMBER NEEDED               12000000
         GETMAIN EC,LV=(REGD),A=WRKSPACE+12,SP=0,MF=(E,WRKSPACE)        12100000
         LTR   REGFIFTN,REGFIFTN   CORE AVAIL?                          12200000
         BNE   ERR1                NO,ERROR                             12300000
*                                                                       12400000
*        THE OACB SET UP IS ONE WORD LONGER THAN THE OACB FOR           12500000
*        REGULAR GENERATION. THE START OF THE GETMAIN AREA              12600000
*        AND ITS LENGTH REPLACE CPU1 AND BUF1 RESPECTIVELY OF           12700000
*        THE ORIGINAL OACB.  THIS IS POSSIBLE BECAUSE UPDATE            12800000
*        TAKES PLACE ON AN ELEMENT ONLY, NOT AN A SEQUENCE OR           12900000
*        SUBROUTINE AND THERE CAN BE ONLY ONE UNRESOLVED ADDRESS        13000000
*        AT ANY ONE TIME. THE ADDRESSES ARE RESOLVED ON A LAST          13100000
*        IN FIRST OUT METHOD AND THEY ARE PLACED IN THE OACB            13200000
*        IN THE ONE THAT IS SET TO ZERO. THEREFORE, WHEN                13300000
*        DATA STORE LOOKS AT THE CPU1, BUF1 LOCATIONS AND FINDS         13400000
*        THEM NON ZERO IT WILL PLACE THE UNRESOLVED ADDRESS AT          13500000
*        CPU2, BUF2 WHICH IS EQUAL TO ZERO. WEHN DATA STORE             13600000
*        IS READY TO RESOLVE THE ADDRESS IT WILL RESOLVE CPU2,          13700000
*        BUF2, FIRST.  THE STATUS IN THE OACB IS SET TO X'20'.          13800000
*                                                                       13900000
         ST    REGB,WRKSPACE       RESTORE BCT COUNT                    14000000
         L     REGC,WRKSPACE+12    ADDR OF AREA                         14100000
         USING OACBAREA,REGC                                            14200000
         ST    REGD,LENGTH         LENGTH OF GETMAIN                    14300000
         ST    REGC,FIRST          START OF GETMAIN                     14400000
         XC    CPU2(8),CPU2        CPU AND BUF UNRES=0                  14500000
         XC    STATUS,STATUS       STATUS=0                             14600000
         OI    STATUS,UPDT         SET UPDATE SW                        14700000
         EJECT                                                          14800000
*                                                                       14900000
*        THE ADDRESS OF THE ORIGINAL OACB IS PLACED IN THE UPDATE       15000000
*        OACB. THE CRSA AND OLP ARE POSITIONED IN THE GDOA TO WHERE     15100000
*        THE ELEMENT STARTS. THE BUFLEN FIELD OF THIS OACB IS SET       15200000
*        TO THE LENGTH LEFT IN THE GDOA LESS TWO OF THE SIX CONTROL     15300000
*        THE LENGTH LEFT (LENLEFT) IS SET TO THE LENGTH LEFT IN THE     15400000
*        GDOA LESS SIX CONTROL BYTES. IF THE LENGTH LEFT IS GREATER     15500000
*        THAN THE LENGTH REQUIRED FOR THE UPDATE, LENLEFT AND BUF-      15600000
*        LEN ARE MODIFIED TO THE ACTUAL LENGTH REQUIRED FOR THE         15700000
*        UPDATE.                                                        15800000
         MVC   ORIG,GDSAOACB       SAVE ADDR OF ORIG OACB               15900000
         LA    REGD,64(REGC)       ADDR OF GDOA (WHICH FOLLOWS OACB)    16000000
         ST    REGD,GDOA           SAVE IN OACB POINTER                 16100000
         AR    REGD,REGA           ADD PREVIOUS ELEMENT LENGTH          16200000
         LA    REGD,2(REGD)        AND 2 FOR INITIAL MODESET            16300000
         ST    REGD,CRSA           GIVING CURR RTN ST ADDR,             16400000
         ST    REGD,OLP            AND (INITIALLY) ORDER LOAD PT.       16500000
         LH    REGD,GDSGDOAL       GDOALEN FROM GDS                     16600000
         S     REGD,TWO            LESS TWO FOR INITIAL MODESET         16700000
         SR    REGD,REGA           LESS PREV ELEM LEN(LENLEFT IN GDOA)  16800000
         ST    REGD,BUFLEN         GIVES BUFFER LENGTH                  16900000
         S     REGD,FOUR           LESS 4 FOR OVFLOW BR(END OF GDOA)    17000000
*   GIVES BUFFER LENGTH (UNLESS LEN REQUIRED IS LESS).                  17100000
         CH    REGD,WRKADDR        IS LENGTH LEFT GR THAN LEN REQD      17200000
         BNL   UPD00400            YES,WILL NEED ONLY 1 OACB/GDOA       17300000
         ST    REGD,LENLEFT        ELSE SAVE ABOVE BUFLEN-4=LENLEFT     17400000
*                                                                       17500000
*  FOR THE ABOVE, PREVIOUS ELEMENT LENGTH IN REGA CAN BE EITHER A       17600000
*  TRUE PREV ELEM. LEN.; OR IF AN ELEMENT'S LOGSTART ADDR IS AN         17700000
*  EXACT MULTIPLE OF (GDOALEN-6), PREV ELEM LEN IS SET TO THE VALUE     17800000
*  OF (GDOALEN-1).(BFR CONTR TBL SECT NUM.IS ALSO DECRMNTD).            17900000
*                                                                       18000000
         LH    REGE,WRKADDR        NXT ROUTINE NEEDS LOGLEN  THIS ELEM. 18100000
         EJECT                                                          18200000
*                                                                       18300000
*        IF ANY MORE OACB/DGOAS ARE REQUIRED, THE FIRST IS DUPLICATED   18400000
*        INTO THE NEXT. THE GDOA, CRSA, AND OLP ARE SET UP TO POINT     18500000
*        TO THE GDOA ADDRESS.  THE GDOAS AND OACBS ARE CYCLED THROUGH   18600000
*        UNTIL THE LAST ONE IS REACHED. ON THE LAST ONE THE LENGTH      18700000
*        LEFT AND BUFFER LENGTH ARE MODIFIED SO THAT THEY WILL          18800000
*        REFLECT THE SHORTENED GDOA.                                    18900000
*                                                                       19000000
UPD00300 SR    REGE,REGD LOGLEN-LENLEFT(THIS ELEM)=LEN REMNG TO DO      19100000
         L     REGD,OACBLEN        OACBLEN PLUS                         19200000
         AH    REGD,GDSGDOAL       GDOALEN PLUS                         19300000
         AR    REGD,REGC           THIS OACB = NEXT OACB                19400000
         ST    REGD,OTHER          PUT NXTOACB ON CHAIN                 19500000
         MVC   0(64,REGD),0(REGC)  DUP OACB CONTENT (OLD TO NEW)        19600000
         LR    REGC,REGD           ADDR NEW OACB W USING REG            19700000
         LA    REGD,64(REGC)       POINT TO GDOA                        19800000
         ST    REGD,CRSA           INIT CRSA,                           19900000
         ST    REGD,GDOA           GDOA,                                20000000
         ST    REGD,OLP            AND OLP.                             20100000
         LH    REGD,GDSGDOAL       IS (GDOALENGTH                       20200000
         S     REGD,SIX            LESS 6) LESS THAN ELEM LENGTH?       20300000
         CR    REGD,REGE           IF SO,THERE IS ANOTHER BLOCK TO DO   20400000
         BNL   UPD00350            NO,LAST BLOCK (OACB/GDOA) FINISHED   20500000
         ST    REGD,BUFLEN         ELSE GDOALEN-6=BUFLEN                20600000
         ST    REGD,LENLEFT        AND LEN LEFT                         20700000
         B     UPD00300            AND GO DO NEXT BLOCK (OACB/GDOA).    20800000
UPD00350 ST    REGE,LENLEFT   LENLEFT (LASTOACB) = ELEM LEN             20900000
         LA    REGE,2(REGE)        RESET LENGTH TO GO IN BUFLEN         21000000
         B     UPD00500                                                 21100000
UPD00400 LH    REGE,WRKADDR        LENGTH                               21200000
         ST    REGE,LENLEFT        &LENLEFT                             21300000
         EJECT                                                          21400000
UPD00500 ST    REGE,BUFLEN         IN BUFLEN                            21500000
         MVC   OTHER,ZERO          ZERO OTHER IN LAST OACB              21600000
         L     REGC,WRKSPACE+12    START OF UPD OACB CHAIN              21700000
         ST    REGC,GDSAOACB       ADDRESS OF TEMP OACB IN GDSCB        21800000
         LH    REGD,WRKADDR+2      ELEMENT LOG START ADDRESS            21900000
         ST    REGD,LOGSTRT        IS LOG START                         22000000
         ST    REGD,LOGCURR        AND LOGCURR                          22100000
         L     REGB,ORIG           POINT BACK TO THE ORIGINAL OACB      22200000
*                                                                       22300000
*        AT THIS POINT THE PHYSICAL BUFFER ADDRESSES FOR THESE          22400000
*        OACBS AND GDOAS MUST BE COMPUTED. FIRST THE START OF           22500000
*        THE CHAIN OF OACBS IS PLACED IN THE GDSAOACB LOCATION          22600000
*        IN THE GDSCB. THE LOGICAL ADDRESS OF THE KEY IS                22700000
*        PLACED IN THE LOGICAL START AND LOGICAL CURRENT LOCATION       22800000
*        IN THE FIRST OACB. THE OTHER LOGICAL ADDRESSES FOR             22900000
*        THE SUCCEEDING GDOAS WILL BE PLACED THERE BY DATA STORE.       23000000
*        THE PHYSICAL BUFFER ADDRESSES ARE COMPUTED USING THE           23100000
*        LOGICAL START ADDRESS AND THE BUFFER CONTROL TABLE.            23200000
*        CONTROL IS THEN RETURNED TO THE CALLING PROGRAM.               23300000
         CLC   CURLOG+2(2,REGB),WRKADDR+2                               23400000
         BE    UPD00850            ORGEN ENTRY RETURN NOW               23500000
         L     REGB,GTMBCTBL       BFR CNTRL TABLE ADDRESS              23600000
         LH    REGD,GDSBCTEL       DISP FOR FIRST ENTRY                 23700000
         MH    REGD,F3+2           INDEX INTO TABLE                     23800000
         CLC   GDSGDOAL,SUBSEG     THIS A SUBSEGMENT ?                  23900000
         BE    UPD00700            YES,BRANCH                           24000000
         SR    REGE,REGE           CLEAR FOR IC                         24100000
UPD00600 IC    REGE,2(REGB,REGD)   GET ASSIGNMENT NUM OF THIS SECTION   24200000
         CLC   WRKSPACE,MINUS1     ORIG LOGSTRT=0?          D11 OZ10053 24300000
         BE    UPD01000            YES,FIRST SECTION GOOD   D11 OZ10053 24400000
         C     REGE,WRKSPACE       FIRST FOUND(ASSGN NUM=WRKSPACE)?     24500000
         BE    UPD01000            YES,BR                               24600000
         IC    REGE,1(REGB,REGD)   PICK UP PTR TO NEXT BCT ENTRY        24700000
         MH    REGE,F3+2           EACH ENTRY IS THREE LONG             24800000
         CR    REGE,REGD           ANY MORE ON CHAIN?                   24900000
         BE    ERR2                NO-BAD KEY                           25000000
         LR    REGD,REGE           NEW TABLE DISP                       25100000
         SR    REGE,REGE           CLEAR FOR IC                         25200000
         B     UPD00600            LOOK FOR NEXT                        25300000
UPD00700 CLC   WRKSPACE,ZERO       IF CT NOT ZERO THEN                  25400000
         BE    UPD00750            CAN BE ONLY ONE SUBSEG   D11 ZA10053 25500000
         CLC   WRKSPACE,MINUS1     BUT IT MAY BE LOGSTRT=0  D11 ZA10053 25600000
         BNE   ERR2                NO-BADKEY                            25700000
UPD00750 AR    REGB,REGD           POINT TO GOOD ENTRY      D11 ZA10053 25800000
         M     REGC,F256           CONVERT-LEAVING                      25900000
         D     REGC,F3             BUFFER ADDR IN REGD                  26000000
         CLC   0(1,REGB),GDSBCTID  IN FIRST HALF                        26100000
         BE    UPD00800            YES                                  26200000
         AH    REGD,SUBSEG         POSIT TO SECOND SUBSEG               26300000
         EJECT                                                          26400000
UPD00800 AR    REGD,REGA                                                26500000
         A     REGD,TWO                                      LD YA00807 26600000
         L     REGC,WRKSPACE+12    ADDR OF 1ST WORK OACB                26700000
         ST    REGD,BUFSTART       PLACE ADDR IN BUFFER START           26800000
         CLC   OTHER,ZERO          MORE THAN 1 GDOA                     26900000
         BE    UPD00825            NO,GO  STORE BLP         D11 ZA10053 27000000
         CLC   WRKSPACE,MINUS1     YES, MAY BE A LOGSTRT=0  D11 ZA10053 27100000
         BNE   ERR2                NO,BAD KEY                           27200000
UPD00825 ST    REGD,BLP            PLACE ADDR IN BLP                    27300000
UPD00850 SR    REGFIFTN,REGFIFTN   SET TO GOOD RETURN                   27400000
UPD00900 L     SAVE,4(SAVE)        COME HERE IF R15 SET                 27500000
         RETURN (14,12),T,RC=(15)                                       27600000
UPD01000 LR    REGE,REGD           SAVE DISP                            27700000
         M     REGC,F256           MX256                                27800000
         D     REGC,F3             D3                                   27900000
         AR    REGD,REGA           ADD DISP FROM TOP                    28000000
         A     REGD,TWO                                                 28100000
         L     REGA,WRKSPACE+12    ADDR OF 1ST WORK OACB                28200000
         DROP  REGC                                                     28300000
         USING OACBAREA,REGA       ADDRESS 1ST WORK OACB                28400000
UPD01100 ST    REGD,BUFSTART       SAVE BUFFER START                    28500000
         ST    REGD,BLP            BLP                                  28600000
         SR    REGD,REGD           ZERO REG                             28700000
         CLC   OTHER,ZERO          ANOTHER                              28800000
         BE    UPD00850            NO,DONE                              28900000
         L     REGA,OTHER          GO TO NEXT                           29000000
         IC    REGD,1(REGE,REGB)   DISP                                 29100000
         MH    REGD,F3+2           EACH BCT ENTRY IS 3 LONG             29200000
         CR    REGD,REGE           MORE SEGMENTS                        29300000
         BNE   UPD01125            YES,DO NEXT SECTION      D11 OZ10053 29400000
         CLC   WRKSPACE,MINUS1     WAS ELEMENT LOGSTRT=0?   D11 OZ10053 29500000
         BNE   ERR2                NO,TRUE LOGIC ERROR      D11 OZ10053 29600000
UPD01125 LR    REGE,REGD           SAVE                                 29700000
         M     REGC,F256           COMPUTE BUFFER ADDR                  29800000
         D     REGC,F3             EACH BCT ENTRY 3 LONG                29900000
         B     UPD01100                                                 30000000
         EJECT                                                          30100000
ERR1     MVI   CODE(ERRCD),NOCORE  INDICATE CORE EXHAUSTED              30200000
         MVC   STRG(4,ERRCD),FOUR                                       30300000
         L     REGFIFTN,FOUR                                            30400000
         B     UPD00900                                                 30500000
ERR2     MVI   CODE(ERRCD),PARMERR INVALID KEY/CORVAL OR BAD GENCODE    30600000
         MVC   PRM(4,ERRCD),ZERO                                        30700000
         L     REGFIFTN,FOUR                                            30800000
         L     REGA,GDSAOACB       GET TEMP AREA                        30900000
         MVC   GDSAOACB,ORIG       REPLACE ADDR OF ORIGINAL             31000000
         L     PARM,FIRST          ADDR OF GETMAIN                      31100000
         L     REGZERO,LENGTH      LENGTH FOR FREEMAIN                  31200000
         FREEMAIN R,LV=(0),A=(1)   FREE STORAGE                         31300000
         B     UPD00900                                                 31400000
         DC    C'ZAP PATCH AREA, 40 BYTES'                              31500000
         DS    0H                  LINEUP PATCH             D11         31600000
PATCH13  DC    40X'FF'             PATCH AREA FOR IFFAHA13  D11         31700000
         EJECT                                                          31800000
         DROP  REGA                                                     31900000
         DROP  BASE                                                     32000000
         EJECT                                                          32100000
*                                                                       32200000
*        ENTRY AT IFFAHA14 IS MADE TO WRITE OUT A SUCCESSFUL            32300000
*        UPDATE. THE STANDARD INITIALIZATION TAKES PLACE FIRST.         32400000
*                                                           D11 ZA15418 32500000
*                                                           D11 ZA15418 32600000
STARTH14 BALR  BASE,0              STARTS HERE              D11 ZA15418 32700000
         USING *,BASE                                                   32800000
         LR    WORK,PARM           WORK AREA                            32900000
         L     GDSREG,WRKGDS       GDSCB                                33000000
         LA    REGA,WRKSAVE        SAVE AREA CHAINING                   33100000
         ST    REGA,8(SAVE)                                             33200000
         ST    SAVE,4(REGA)                                             33300000
         LR    SAVE,REGA           SET UP MY SAVE AREA                  33400000
         L     GTMREG,GDSGTMCB     GTMCB                                33500000
         USING OACBAREA,REGC                                            33600000
         L     REGC,GDSAOACB       OACB FOR UPDATE                      33700000
*                                                                       33800000
*        THE LAST GDOA/OACB ON THE CHAIN IS LOCATED AND IF THE          33900000
*        UPDATE DID NOT COMPLETELY FILL THE PREVIOUS AREA A             34000000
*        FILL IN WILL TAKE PLACE. IF ONLY TWO BYTES ARE LEFT            34100000
*        A GNOP IS PLACED IN TNE TWO BYTES. OTHERWISE A GTRU            34200000
*        TO THE END OF THE SEGMENT IS PLACED IN THE GDPA WHERE          34300000
*        GENERATION COMPLETED.                                          34400000
         L     REGA,OLP            ORDER LOAD PT                        34500000
         L     REGB,LENLEFT        LENGTH LEFT                          34600000
         C     REGB,FOUR           GREATER THAN OR EQ 4?                34700000
         BL    UPD01300            NO                                   34800000
UPD01150 CLC   OTHER,ZERO          GO TO LAST OACB-FOUND                34900000
         BE    UPD01400            YES                                  35000000
         L     REGC,OTHER          GET NEXT                             35100000
         B     UPD01150                                                 35200000
UPD01160 L     REGC,FIRST          LOAD FIRST ONE                       35300000
         MVC   GDSAOACB,ORIG       RESET REGULAR OACB                   35400000
         TM    GDSFLAGS,EQUIV      IS THIS AN EQUIVALENCE GDS           35500000
         BO    UPD01600            YES MODIFY IN CORE COPY              35600000
         EJECT                                                          35700000
*                                                                       35800000
*        UPDATE I/O CANNOT BE OVERLAPPED SO ANOTHER DECB IS CREATED     35900000
*                                                                       36000000
*                                                                       36100000
*        THE FIRST OACB/GDOA IS LOCATED AND THEY ARE ALL WRITEEN        36200000
*        OUT TO THE BUFFER. AFTER THEY ARE WRITTEN, A GCNTRL            36300000
*        MACRO IS ISSUED TO RESTART REGENERATION.                       36400000
UPD01170 XC    WRKDECB(32),WRKDECB ZERO DECB                            36500000
         L     REGA,GTMGRDCB       DCB ADDR                             36600000
UPD01200 LA    PARM,WRKDECB                                             36700000
         L     REGB,CRSA           ROUTINE START ADDR                   36800000
         MVC   WRKDECB+20(4),BUFLEN LENGTH IN DECB                      36900000
         GWRITE (PARM),BUF,(REGA),,(REGB),BUFSTART+2,MF=E               37000000
         LA    PARM,WRKDECB                                             37100000
         WAIT  ECB=(1)             WAIT                                 37200000
         CLC   OTHER,ZERO        MORE TO WRITE                          37300000
         BE    UPD01250            NO                                   37400000
         L     REGC,OTHER          NEXT ONE                             37500000
         B     UPD01200            GO WRITE THE REST                    37600000
UPD01250 LA    PARM,WRKDECB        RESTART DISPLAY                      37700000
         CLI   0(PARM),X'7F'                                            37800000
         BNE   ERR3                                                     37900000
         NI    0(PARM),X'BF'                                            38000000
         GCNTRL (PARM),STR,(REGA),GDSFCBUF,MF=E                         38100000
         LA    PARM,WRKDECB                                      A43072 38200000
         WAIT  ECB=(1)                                           A43072 38300000
*                                                                       38400000
*        THE STORAGE OBTAINED FOR THE UPDATE IS FREED AND CONTROL       38500000
*        IS RETURNED TO THE CALLING PROGRAM.                            38600000
*                                                                       38700000
*                                                                       38800000
*                                                                       38900000
UPD01270 L     PARM,FIRST                                               39000000
         L     REGZERO,LENGTH                                           39100000
         FREEMAIN R,LV=(0),A=(1)   FREE CORE FROM UPDATE                39200000
         L     SAVE,4(SAVE)                                             39300000
         RETURN (14,12),T,RC=0                                          39400000
         EJECT                                                          39500000
UPD01300 C     REGB,TWO            TWO LEFT                             39600000
         BL    UPD01500            NO                                   39700000
         MVC   0(2,REGA),GNOP      MOVE IN NO-OP                        39800000
         A     REGA,TWO            BUMP PAST GNOP AND       D11 ZA11418 39900000
         ST    REGA,OLP            UPDATE OLP               D11 ZA11418 40000000
         B     UPD01500                                                 40100000
UPD01400 L     REGB,BUFSTART       BUFSTART                             40200000
         A     REGB,BUFLEN         + LEN IS START OF NEXT ELEM          40300000
         MVC   0(2,REGA),GTRU      MOVE IN GTRU                         40400000
         STH   REGB,2(REGA)        TO NEXT ELEM                         40500000
         B     UPD01160                                                 40600000
UPD01500 CLC   OTHER,ZERO          IS THERE ANOTHER                     40700000
         BE    UPD01160            NO                                   40800000
*                                                           D11 ZA11418 40900000
*   IF A REPOSITIONING VECTOR WAS JUST PUT OUT TO THE       D11 ZA11418 41000000
*   GDOA AND THERE IS NOT ENOUGH LENGTH REMAINING FOR THE   D11 ZA11418 41100000
*   TRANSFER ORDER,OVERFLOW MUST BE DONE AND THE TRANSFER   D11 ZA11418 41200000
*   VECTOR PUT IN THE NEXT GDOA. THIS CAN BE DONE BY        D11 ZA11418 41300000
*   CALLING DATASTORE WITH THE 'OVERFLOW ONLY' CODE.        D11 ZA11418 41400000
*                                                           D11 ZA11418 41500000
*                                                           D11 ZA11418 41600000
         CLI   GDSGRMOD,CNTRL      JUST DONE REPOS VECTOR?  D11 ZA11418 41700000
         BNE   UPD01550            NO,DONT DO OVERFLOW      D11 ZA11418 41800000
         LA    PARM,WRKGDS1        SETUP CALL TO DATASTOR   D11 ZA11418 41900000
         ST    GDSREG,WRKGDS1      GDS                      D11 ZA11418 42000000
         L     ERRCD,WRKRTN                                 D11 ZA11418 42100000
         ST    ERRCD,WRKRTN1       RTNARRAY PTR             D11 ZA11418 42200000
         XC    WRKFLGS1(4),WRKFLGS1 CLEAR FLAGS AND LENGTH  D11 ZA11418 42300000
         MVI   WRKFLGS1,OVERFLOW   INDICATE O'FLOW ONLY     D11 ZA11418 42400000
         L     REGFIFTN,STAT(,ERRCD) POINT TO STATABLE      D11 ZA11418 42500000
         L     REGFIFTN,DSTOR(,REGFIFTN) AND DATASTORE      D11 ZA11418 42600000
         BALR  RETURN,REGFIFTN     CALL HIM                 D11 ZA11418 42700000
         LTR   REGFIFTN,REGFIFTN   OVERFLOW OK?             D11 ZA11418 42800000
         BNZ   ERR4                OVERFLOW ERROR           D11 ZA11418 42900000
UPD01550 CLC   OTHER,ZERO          IS THERE ANOTHER OACB?   D11 ZA11418 43000000
         BE    UPD01160            NO                       D11 ZA11418 43100000
         L     REGC,OTHER          GET NEXT                             43200000
         L     REGA,OLP            GET ORDER LOAD POINT                 43300000
         B     UPD01150            GO BUILD TRANS ORDER                 43400000
UPD01600 L     REGA,BUFSTART       START ADDR IN BUFFER                 43500000
         L     REGB,CRSA           AND IN CORE FOR UPDATE               43600000
         LR    REGE,REGC           SAVE FIRST UPD OACB PTR              43700000
         L     REGD,BUFLEN             LENGTH OF UPDATE                 43800000
         L     REGC,GDSAOACB       STORAGE COPY IN REG OACB             43900000
         S     REGA,BUFSTART       DISP IN REG OACB OF UPDATE           44000000
         A     REGA,CRSA                                                44100000
         BCTR  REGD,0              LENGTH FOR MOVE                      44200000
         EX    REGD,MOVE           MOVE UPDATE IN                       44300000
         LR    REGC,REGE           RESTORE FIRST UPD OACB PTR           44400000
         TM    GDSFLAGS,INBUF      IS THIS EQUIV IN BUFFER              44500000
         BO    UPD01170            YES WRITE OUT UPDATE                 44600000
         B     UPD01270            NO FREE STORAGE AND EXIT             44700000
ERR3     L     ERRCD,WRKRTN                                             44800000
         OI    0(ERRCD),IO                                              44900000
ERR4     L     SAVE,4(,SAVE)       REPOINT TO CALLER SA     D11 ZA08043 45000000
         RETURN (14,12),RC=4                                            45100000
         EJECT                                                          45200000
REGZERO  EQU   0                                                        45300000
PARM     EQU   1                                                        45400000
REGA     EQU   2                                                        45500000
REGB     EQU   3                                                        45600000
REGE     EQU   4                                                        45700000
WORK     EQU   5                                                        45800000
ERRCD    EQU   6                                                        45900000
GTMREG   EQU   7                                                        46000000
GDSREG   EQU   8                                                        46100000
BASE     EQU   9                                                        46200000
REGC     EQU   10                                                       46300000
REGD     EQU   11                                                       46400000
SAVE     EQU   13                                                       46500000
RETURN   EQU   14                                                       46600000
REGFIFTN EQU   15                                                       46700000
         EJECT                                                          46800000
WAORFLGS EQU   44                  ORGEN CALL                LD YA00808 46900000
CNTRL    EQU   0                   CONTROL MODE             D11 ZA11418 47000000
OVERFLOW EQU   X'20'               CODE FOR DATASTORE       D11 ZA11418 47100000
STAT     EQU   24                  STATBL DSPLCMNT          D11 ZA11418 47200000
DSTOR    EQU   852                 DSTOR IN STATBL          D11 ZA11418 47300000
PRM      EQU   16                                                       47400000
IO       EQU   X'04'                                                    47500000
PARMERR  EQU   X'08'                                                    47600000
SUBSEG   DC    H'128'                                                   47700000
F256     DC    F'256'                                                   47800000
F3       DC    F'3'                                                     47900000
         DC    C'40 BYTE PATCH AREA FOLLOWS'                            48000000
         DS    0H     ITS NICE WHEN PATCH DOESNT GIVE 0C6!! D11         48100000
PATCH14  DC    40X'FF'             PATCH AREA FOR IFFAHA14  D11         48200000
CODE     EQU   0                                                        48300000
NOCORE   EQU   X'10'                                                    48400000
STRG     EQU   12                                                       48500000
OACBLEN  DC    F'64'                                                    48600000
UPDT     EQU   X'20'                                                    48700000
CURLOG   EQU   52                                                       48800000
ONE      EQU   1                                                        48900000
SIX      DC    F'6'                                                     49000000
FOUR     DC    F'4'                                                     49100000
ZERO     DC    F'0'                                                     49200000
TWO      DC    F'2'                                                     49300000
MINUS1   DC    F'-1'               TO CHECK LOGSTRT=0 COND. D11 ZA10053 49400000
EQUIV    EQU   X'08'                                                    49500000
INBUF    EQU   X'80'                                                    49600000
MOVE     MVC   0(1,REGA),0(REGB)                                        49700000
         EJECT                                                          49800000
         GINIT                                                          49900000
GNOP     GNOP2                                                          50000000
GTRU     GTRU  0                                                        50100000
         EJECT                                                          50200000
OACBAREA DSECT                                                          50300000
OTHER    DS    F                                                        50400000
GDOA     DS    F                                                        50500000
STATUS   DS    F                                                        50600000
CRSA     DS    F                                                        50700000
OLP      DS    F                                                        50800000
BLP      DS    F                                                        50900000
BUFSTART DS    F                                                        51000000
BUFLEN   DS    F                                                        51100000
FIRST    DS    F                                                        51200000
LENGTH   DS    F                                                        51300000
CPU2     DS    F                                                        51400000
BUF2     DS    F                                                        51500000
LOGSTRT  DS    F                                                        51600000
LOGCURR  DS    F                                                        51700000
LENLEFT  DS    F                                                        51800000
ORIG     DS    F                                                        51900000
         EJECT                                                          52000000
WORKAREA DSECT                     INP PARMLIST MAPPED HERE             52100000
WRKADDR  DS    F                   KEY                                  52200000
WRKSKIP1 DS    3F                  IGNORED                              52300000
WRKGDS   DS    F                   A(GDS)                               52400000
WRKRTN   DS    F                   A(RTN ARRAY)                         52500000
WRKSKIP2 DS    11F                 IGNORED                              52600000
WRKSPACE DS    4F                  WORKAREA                             52700000
WRKSAVE  DS    18F                                                      52800000
WRKDECB  DS    8F                                                       52900000
*        PARMLIST TO DATASTORE FOLLOWS                      D11 ZA11418 53000000
WRKGDS1  DS    F                   GDS                      D11 ZA11418 53100000
WRKRTN1  DS    F                   RTNARRAY PTR             D11 ZA11418 53200000
WRKFLGS1 DS    H                   FLAGS                    D11 ZA11418 53300000
WRKLEN1  DS    H                   LENGTH                   D11 ZA11418 53400000
         COPY  GDSCB                                                    53500000
         COPY  GTMCB                                                    53600000
         COPY  GSPCB                                                    53700000
         END                                                            53800000
