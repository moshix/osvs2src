   TITLE  'IFFCAN01    CANCEL KEY ROUTINE'                              00100002
**********************************************************************  00150002
*                                                                       00200002
* MODULE NAME:            IFFCAN01 (OS/VS2)                             00250002
*                                                                       00260002
* DESCRIPTIVE NAME:       CANCEL KEY ROUTINE                            00270002
*                                                                       00280002
* COPYRIGHT:              NONE                                          00290002
*                                                                       00292002
* STATUS:                 RELEASE 2.0                                   00294002
*                                                                       00296002
*                                                                       00298002
******************************CONTINUED* NEXT*PAGE********************  00298400
         EJECT                                                          00298802
*  FUNCTION :                                                           00300000
*         PROVIDE 2250 DISPLAY UNIT CANCEL KEY FUNCTIONS TO THE         00350000
*   TERMINAL USER.  THESE FUNCTIONS INCLUDE TERMINATING HIS PROGRAM,    00500002
*   TERMINATING HIS PROGRAM WITH A SYSTEM/360 CORE DUMP, RESUMING HIS   00600002
*   PROGRAM OR REQUESTING A 2250 BUFFER DUMP                            00700002
*   UPON BEING ENTERED, IFFCAN01 DETERMINES IF A CKCB ALREADY EXISTS.   00800002
*   IF NOT, A GETMAIN IS ISSUED AND THE CKCB INITIALIZED.  A GREADR     00900002
*   MACRO IS ISSUED TO DETERMINE IF THE 2250 BUFFER FOR THIS DEVICE IS  01000002
*   RUNNING.  IF SO, THE RESTART ADDRESS IS SAVED.  AN ASGNBFR IS       01100002
*   ISSUED TO ACQUIRE 2250 BUFFER FOR THE CANCEL KEY MAIN PANEL.  IF    01200002
*   NO BUFFER EXISTS, A GETMAIN IS ISSUED FOR MAIN STORAGE, AND A       01300002
*   PORTION OF THE USER'S BUFFER IS READ INTO THIS AREA WHILE IFFCAN01  01400002
*   IN TURN USES THE NOW AVAILABLE 2250 BUFFER.  A GWRITE IS ISSUED     01500002
*   TO STORE THE MAIN PANEL INTO THE BUFFER.  A SEARCH OF THE TIOT IS   01600002
*   THEN MADE TO DETERMINE IF A SYSBFDMP DD STATEMENT WAS SUPPLIED.  IF 01700002
*   NOT, THE 2250 BUFFER DUMP OPTION IS NOT MADE AVAILABLE TO THE       01800002
*   USER.  IF GJP HAD INITIATED THE PROBLEM PROGRAM, THE RESUME OPTION  01900002
*   IS NOT MADE AVAILABLE TO THE USER.  A GWRITE IS THEN ISSUED AND     02000002
*   BUFFER GENERATION IS STARTED.  IFFCAN01 THEN RETURNS TO ITS CALLER  02100002
*                                                                       02200002
*   IF IFFCAN01 DETERMINES THE CKCB VALID, A LIGHT PEN ATTENTION HAS    02300002
*   BEEN RECEIVED, AND IT SCANS THE UCB SENSE DATA TO DETERMINE WHICH   02400002
*   OPTION HAD BEEN SELECTED BY THE USER.  IF THE BUFFER DUMP OPTION    02500002
*   WAS SELECTED, IFFCAN01 LINKS TO IFFCAN03.  AT THIS TIME, IF THE     02600002
*   USER WAS TAKEN FROM THE BUFFER, HE IS REINSTATED.  A RLSEBUF IS     02700002
*   ISSUED FOR ANY ACQUIRED 2250 BUFFER.  IF THE RESUME OPTION WAS      02800002
*   SELECTED, IFFCAN01 RETURNS TO THE CALLING ROUTINE, RESTARTING THE   02900002
*   BUFFER GENERATION, IF NECESSARY.  ALSO, IF GJP IS IN CONTROL, A     03000002
*   RETURN IS AFFECTED.  IF THE USER REQUESTED TERMINATE, AN ABEND IS   03100002
*   ISSUED.  IF DUMP WAS SELECTED AN ABEND/DUMP IS ISSUED.  IN BOTH     03200002
*   CASES THE ABEND CODE IS 063.                                        03300002
*                                                                       03400002
*ENTRY POINTS ENTERED VIA LINK FROM IFFCAN03                            03500002
*                                                                       03600002
*INPUT REGISTER ONE POINTS TO CKQE                                      03700002
*                                                                       03800002
*EXIT,ERROR IF NO CORE AVAILABLE AFTER GETMAIN, RETURN TO CALLER, RC=4  03900002
*           IF I/O ERROR ON 2250, RETURN TO CALLER, RC=4                04000002
*           IF NO 2250 BUFFER AVAILABLE, RETURN TO CALLER, RC=4         04100002
*ATTRIBUTES TRANSIENT, REENTRANT, PRIVILIGED                            04200002
*INPUT                                                                  04300002
*                                                                       04400002
*OUTPUT DISPLAY ON 2250                                                 04500002
*                        * TERMINATE                                    04600002
*                        * DUMP                                         04700002
*                        * RESUME                                       04800002
*                        * BUFFER DUMP                                  04900002
*                                                                       05000002
         EJECT                                                          05050000
*EXTERNAL REFERENCES 1-GWRITE VIA BALR       7-BUFINQ VIA SVC 71        05100002
*                    2-GCNTRL VIA BALR       8-POST VIA SVC 2           05200002
*                    3-GETMAIN VIA SVC 4     9-FREEMAIN VIA SVC 10      05300002
*                    4-WAIT VIA SVC 1       10-RLSEBFR VIA SVC 71       05400002
*                    5-ASGNBFR VIA SVC 71   11-WTO VIA SVC 35           05500002
*                    6-IFFCAN02 VIA LINK                                05600002
*                                                                       05700002
*EXIT,NORMAL RETURN TO CALLER VIA REGISTER 14                           05800002
*                                                                       05900002
*                                                                       06000002
*TABLES/WORKAREAS CANCEL KEY QUEUE ELEMENT                              06100002
*                 CANCEL KEY CONTROL BLOCK                              06200002
*                                                                       06300002
*                                                                       06400002
*NOTES N/A                                                              06500002
*                                                                       06600002
IFFCAN01 CSECT                                                          06650002
*   SEE LABEL 'MODID' FOR LAST CHANGE DATE; FORMAT:  NAME.SYSREL.DATE   06652002
*C108000,111000,164000                                        LF YM4067 06652402
* SEQ NBRS MUST BE RESPECIFIED BECAUSE OF RESEQ FOR VS                  06654002
* 522300-522600                                                  A30600 06660002
*0831,132000,135000,363000,366000,369000,375000,543000             3112 06670002
* 128000,144000                                                  A25397 06680002
* 085000,216000-268400,328000,414000-421000,519000                M2878 06690002
* 271000,447000                                                   M2878 06692002
* THIS MODULE RE-WRITTEN FOR RELEASE 20                                 06694002
* C375000,C377000                                                A38916 06696002
* A376500,A376600                                                A38916 06698002
* 231000-236000,274000-275000,417000-418000,462000-467000     LB  AOS/1 06698402
* C291000                                                     LI  AOS/1 06698802
* A291500                                                     LI  AOS/1 06699202
* C383000                                                        A42796 06699602
* A157000,A443000-444000,A707000                                  M6619 06699702
* A384000-385000                                                 A44019 06699802
*D145000,D295000,D458000                                      LI A39419 06699902
*A144600-145200,A294600-295200,A383500-422910,A455500         LI A39419 06733202
*A457600-458200,A707200-707800                                LI A39419 06743202
*C147000,C423410                                              LI A39419 06753202
*A279500-279600,A284500-284920,A401500-401600,A405500-405920    OY01294 06763202
*A422370-422390,A422650-422699                                  OY01294 06765202
*D163000,A163500-163600,D190000,A190500-190600               LG Z30AALG 06765300
*D278000,A278500-278600,D242000,A342500-342600               LG Z30AALG 06765400
*D400000,A400500-400600,D422280,A422300-422320               LG Z30AALG 06765500
*D502000,A502500-502600                                      LG Z30AALG 06774100
*A270500,A110500,A157500,A310500,A394500,A454500             LG @ZM2360 06776100
*A476500,A517500,A536500,A536700,A540500,A536600             LG @ZM2360 06778100
*A489500-489997,A499500-499700                               LG @ZM2360 06780100
*C215000-216000                                             D11 ZA06390 06781100
*C002194,C422000,C445000,C510000                            E12 ZA24234 06781500
*C42900,C43700                                              E12 ZA26469 06781900
*A156050-156300,A157100-158060,A270010-271060,A310020-310300E12 ZA26368 06782300
*A394010-394180,A455000-455055,A477000-477065,D48950-489997 E12 ZA26368 06782800
*                                                                       06783800
*                                                                       06784800
*                                                                       06785800
         EJECT                                                          06791402
*                                                                       06800002
*        GENERAL REGISTERS                                              06900002
*                                                                       07000002
R0       EQU   0                                                        07100002
R1       EQU   1                                                        07200002
R2       EQU   2                                                        07300002
R3       EQU   3                                                        07400002
R4       EQU   4                                                        07500002
R5       EQU   5                                                        07600002
R6       EQU   6                                                        07700002
R7       EQU   7                                                        07800002
BASE     EQU   8                                                        07900002
R9       EQU   9                                                        08000002
R10      EQU   10                                                       08100002
R11      EQU   11                                                       08200002
R12      EQU   12                                                       08300002
R13      EQU   13                                                       08400002
R14      EQU   14                                                       08500002
R15      EQU   15                                                       08600002
*                                                                       08700000
*                                                                       08800002
*        EQUATES                                                        08900002
*                                                                       09000002
HEX04    EQU   X'04'                                                    09100002
HEX7F    EQU   X'7F'                                                    09200002
BUFRUN   EQU   X'02'                    SENSE BIT FOR BUFFER     A25397 09300002
*                                            RUNNING             A25397 09400002
ZERO     EQU   0                                                        09500002
WON      EQU   1                                                        09600002
TWO      EQU   2                                                        09700002
THREE    EQU   3                                                        09800002
FOUR     EQU   4                                                        09900002
FIVE     EQU   5                                                        10000002
EIGHT    EQU   8                                                        10100002
TCB      EQU   8                                                        10200002
TIOT     EQU   12                                                       10300002
TWELVE   EQU   12                                                       10400002
THIRTEEN EQU   13                                                       10500002
SIXTEEN  EQU   16                                                       10600002
TWOFOUR  EQU   24                                                       10700002
UCBSENSE EQU   34                                             LF YM4067 10800002
TEB      EQU   28                                                       10900002
RB       EQU   28                                                       11000002
GIOCR    EQU   33             DISP OF TEB GIOCR ADDRESS      LG @ZM2360 11050000
UCBRST   EQU   24                                             LF YM4067 11100002
FULLMASK EQU   X'FF'              FF MASK USED TO TURN FLAG BITS A34790 11200002
         EJECT                                                          11500002
*        ON ENTRY IT IS DETERMINED IF THIS IS THE FIRST ENTRY OR SECOND 11600000
*        FOR SECOND ENTRY THE TE WILL CONTAIN MY WORKAREA WITH AN       11700002
*        ID IN THE FIRST WORD.                                          11800002
*        ON FIRST ENTRY A GETMAIN IS DONE AND THE WORK AREA IS INITIAL- 11900002
*        IZED.  A GREADR XYP IS USED TO SEE IF THE BUFFER IS RUNNING    12000002
*        BECAUSE IT DOES NOT STOP THE BUFFER FIRST.  THEREFORE THE      12100002
*        SUCCESSFUL COMPLETION FLAG OF THE ECB WILL TELL IF THE BUFFER  12200002
*        IS RUNNING.  IF NOT SUCCESSFUL THE BUFFER IS.                  12300002
*                                                                       12400002
         SAVE  (14,12)                                                  13460002
         BALR  BASE,0                   ESTABLISH ADDRESSABILITY        13500002
         USING *,BASE                                                   13600002
         B     *+24                                                     13650002
MODID    DC    C'IFFCAN01.VS2R2.77275'          MODULE EYECATCHER ID    13660000
*                                                                       13700002
* REGISTER 1 CONTAINS POINTER TO CKQE                                   13800002
*                                                                       13900002
         TM    FIVE(R1),HEX04      TEST FLAG BITS OF CKQE TO DETERMINE  14000002
         BO    CAN040                   IF FIRST ENTRY. NO BRANCH M2878 14100002
         LA    R2,EIGHT(R1)        SET POINTER TO AREA ADDRESS          14200002
         LR    R11,R1              SET UP BASE FOR CKQE                 14300002
         USING CKQE,R11                                                 14400002
         LA    R1,16(R1)               PT TO LIST IN CKQE     LI A39419 14460002
         GETMAIN  EC,LV=CKBLGTH,A=(2),SP=250,MF=(E,(1))    E12 @ZA24234 14520000
         LTR   R15,R15                  ANY SPACE AVAILABLE        3112 14600002
         BNZ   CANERR1                 GO ISSUE ERROR MSG     LI A39419 14700002
         L     R9,ZERO(R2)                                              14800002
         USING CKCB,R9             SET UP ADDRESSABILITY                14900002
         XC    CKCB(CKBLGTH),CKCB  CLEAR GETMAIN AREA                   15000002
         LA    R6,CKCBSVAR        LOAD SAVEAREA ADDRESS          A34790 15100002
         ST    R6,8(R13)           CHAIN SAVE AREAS                     15200002
         ST    R13,4(R6)                                                15300002
         LR    R13,R6                                                   15400002
         OI    CKQEFLG1,CKFCKCB   SET CKCB INVALID FLAG          A34790 15500002
         L     R3,CKQEDCB         GET DCB ADDRESS                A34790 15600002
         SR    R15,R15                 CLR REGISTER         E12 ZA26368 15610000
         ICM   R15,THREE,CKQEUCB   GET UCB ADDRESS          E12 ZA26368 15620000
         L     R15,TEB(R15)   GET TEB ADDRESS               E12 ZA26368 15630000
         L     R1,CKQEDCB     GET DCB ADDR                  E12 ZA26368 15640000
         CLC   GIOCR(3,R15),49(R1)  ADDR IN DCB CORRECT     E12 ZA26368 15650000
         BNE   CANERR9        NO,ISSUE ERROR MSG            E12 ZA26368 15660000
         MVC   CKDCBSTR(4),SIXTEEN(R3)   SAVE DCB BFR START ADDR  M6619 15700002
         MVC   CKCBECB+1(3),GIOCR(R15)  ADDRESS OF GIOCR    E12 ZA26368 15720000
*        GREADR     CKCBDECB,SEN,(3),CKCBWRKA,MF=E          E12 ZA26368 15750000
         SR    15,15              CLEAR REGISTER            E12 ZA26368 15760000
         LA    1,CKCBDECB         PARAMETER LIST            E12 ZA26368 15770000
         ST    15,4(0,1)          CLEAR TYPE AREA IN DECB   E12 ZA26368 15780000
         MVI   4(1),X'18'         SENSE TYPE TO DECB        E12 ZA26368 15790000
         LA    15,0(3)            DCB ADDRESS               E12 ZA26368 15800000
         ST    15,8(0,1)          DCB ADDRESS IN DECB       E12 ZA26368 15810000
         LA    15,CKCBWRKA        AREA ADDRESS              E12 ZA26368 15820000
         ST    15,12(0,1)         AREA ADDRESS IN DECB      E12 ZA26368 15830000
         XC    0(4,1),0(1)        CLEAR ECB                 E12 ZA26368 15840000
         L     15,CKCBECB         GET SAFE GIOCR ADDRESS    E12 ZA26368 15850000
         DS    0H                                           E12 ZA26368 15860000
         BALR  14,15              BRANCH TO GIOCR           E12 ZA26368 15870000
         BAL   R12,CANIO          GO CHECK I/O                   A34790 15900002
         TM    CKCBWRKA,BUFRUN    IS BUFFER RUNNING              A34790 16000002
         BNO   CAN010                   IF NOT TAKE BRANCH       A25397 16100002
         OI    CKQEFLG1,CKFBFRUN  SET BUFFER RUNNING FLAG        A34790 16200002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 16350000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 16360000
         MVC   CKCBREST+TWO(TWO),UCBRST(R7)  RESTART IN CKCB  LF YM4067 16400002
*                                                                A34790 16500002
         EJECT                                                          16600002
*        BUFFER IS OBTAINED EITHER BY AN ASGNBFR OR A BUFFER INQ        16700002
*        FOLLOWED BY ROLLING OUT THE USER PICTURE.                      16800002
*        THE DISPLAY IS WRITTEN OUT.  IF THE CALL WAS FROM GJP THEN     16900002
*        THE RESUME OPTION IS BLANKED BY WRITING OVER THE SET MODE.     17000002
*        THEN IF NOT GJP THE PROBLEM PROGRAM IS SET INTO A WAIT         17100002
*        STATE AND THE ROUTINE EXITS.                                   17200002
*                                                                       17300002
CAN010   LA    R5,LEN                                                   17400002
         STH   R5,CKCBBFLG        SET UP BUFFER LENGTH           A34790 17500002
         ASGNBFR (R3),CKCBBFLG,MF=(E,CKCBWRKA)                   A34790 17600002
         LTR   R15,R15             AVAILABLE                            17700002
         BNE   CAN030              NO-GO ROLL OUT OF USER OWNED BUFFER  17800002
         LH    R5,SIXTEEN(R3)   GET BUFFER ADRESS                       17900002
         STH   R5,CKCBBFAD        SAVE IT                        A34790 18000002
CAN020   LA    R4,ODERLNTH    GET LENGTH                                18100002
         LA    R5,ORDERS      AREA ADDRESS                              18200002
         LA    R6,CKCBBFAD        BUFADR IN DECB                 A34790 18300002
         BAL   R7,CANWRITE    GO WRITE TO BUFFER                        18400002
         EJECT                                                          18500002
*                                                                       18600002
* CHECK TIOT TO DETERMINE IF SYSBFDMP DD CARD AVAILABLE. IF NOT, DO     18700002
* NOT ALLOW 2250 BUFFER DUMP OPTION.                                    18800002
*                                                                       18900002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 19050000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 19060000
         L     R7,TEB(R7)    CONTROL BLOCK SEARCHING TCB PTR            19100002
         L     R7,TCB(R7)      TCB POINTER                              19200002
         L     R7,TIOT(R7)     TIOT ADDRESS                             19300002
*                                                                       19400002
* REGISTER SEVEN POINTS TO TIOT. FIRST SIX WORDS ARE CONTROL INFOR-     19500002
* MATION. SET POINTER (R7) TO BYPASS THIS AND BEGIN SEARCH OF DD        19600002
* NAMES FOR SYSBFDMP.                                                   19700002
*                                                                       19800002
         LA    R7,TWOFOUR(R7)      BYPASS JOB AND STEP NAMES            19900002
CAN021D3 EQU   *                                                        20000002
         CLC   ZERO(FOUR,R7),ZEROS   IS THIS END OF TIOT                20100002
         BNE   CAN021               YES, SET NOP BLANK 2250 DUMP OPTION 20200002
*                                                                       20300002
* BUFFER DUMP DD CARD NOT FOUND. COMPUTE ADDRESS WHER NOP ORDER WILL    20400002
* BE STORED TO BLANK BUFFER DUMP OPTION.                                20500002
*                                                                       20600002
         LH    R7,CKCBBFAD        GET BUFFER ADDRESS             A34790 20700002
         LA    R7,D2250(R7)   ADD DISPLACEMENT                          20800002
         STH   R7,CKCBWRKA        SET UP FOR GWRITE              A34790 20900002
         LA    R4,TWO         GET LENGTH                                21000002
         LA    R5,GNOP        AREA ADDRESS                              21100002
         LA    R6,CKCBWRKA        ADDRESS ON DECB                A34790 21200002
         BAL   R7,CANWRITE    GO WRITE TO BUFFER                        21300002
         B     CAN021D5   BRANCH TO CHECK FOR RESUME OPTION             21400002
CAN021   SR    R6,R6               CLEAR FOR IC             D11 ZA06390 21500000
         IC    R6,0(R7)            GET NXTENTRY LEN         D11 ZA06390 21600000
         CLC   FOUR(EIGHT,R7),SYSBFDMP   CHECK FOR DD CARD              21700002
         BE    CAN021D5            IF FOUND, BRANCH                     21800002
         AR    R7,R6          SET POINTER TO NEXT ENTRY                 21900002
         B     CAN021D3       BRANCH TO CONTINUE SEARCH                 22000002
         EJECT                                                          22100002
*                                                                       22200002
* NOW DETERMINE IF RESUME OPTION IS TO BE DISPLAYED                     22300002
*                                                                       22400002
CAN021D5 LH    R6,CKCBBFAD        GET BUFFER ADDRESS             A34790 22500002
         N     R6,CLEAR           ZERO HIGH ORDER BYTES          A34790 22600002
         LA    R7,REP(R6)     COMPUTE AREA FOR NOP IN GR ORDERS         22700002
         STH   R7,CKCBWRKA                                       A34790 22800002
         LA    R6,LEN(R6)     COMPUTE STARTING ADDRESS                  22900002
         STH   R6,CKCBWRKA+TWO                                   A34790 23000002
*                                                                       23700002
* BLANK BUFFER DUMP IN PROGRESS MESSAGE                                 23800002
*                                                                       23900002
CAN022   LA    R4,TWO         GET LENGTH                                24000002
         LA    R5,GNOP        AREA ADDRESS                              24100002
         LH    R6,CKCBBFAD        GET BUFFER ADDRESS             A34790 24200002
         N     R6,CLEAR           ZERO HIGH ORDER BYTES          A34790 24300002
         LA    R6,BUFFGO(R6)  COMPUTE ADDRESS OF THIS MESSAGE           24400002
         STH   R6,CKCBWRKA        STORE IN AREA                  A34790 24500002
         LA    R6,CKCBWRKA        ADDRESS IN DECB                A34790 24600002
         BAL   R7,CANWRITE    GO WRITE TO BUFFER                        24700002
*                                                                       24800002
* CHECK IF BUFFER DUMP UNSUCCESSFUL SHOULD BE DISPLAYED                 24900002
*                                                                       25000002
         LH    R6,CKCBBFAD        GET BUFFER   ADDRESS           A34790 25100002
         N     R6,CLEAR           ZERO HIGH ORDER BYTES          A34790 25200002
         LA    R6,BUFFNOGO(R6) COMPUTE ADDRESS OF THIS MESSAGE          25300002
         STH   R6,CKCBWRKA        STORE IN AREA                  A34790 25400002
         LA    R6,CKCBWRKA        ADDRESS IN DECB                A34790 25500002
         TM    CKQEFLG2,CKFBDFAL  ERROR ON BUFFER DUMP           A34790 25600002
         BO    CAN0221            IF YES BRANCH AND DISP MSG     A34790 25700002
         BAL   R7,CANWRITE        GO TO WRITE BUFFER             A34790 25800002
         B     CAN023             BRANCH AROUND ERROR MSG        A34790 25900002
CAN0221  LA    R5,GECP            UNBLANK BUFF DUMP ERR MSG      A34790 26000002
         BAL   R7,CANWRITE     GO TO WRITE TO BUFFER                    26100002
         EJECT                                                          26200002
* THIS WRITE UPDATES THE GTRU BRANCH ADDRESS TO POINT TO THE START OF   26300002
* THE DISPLAY AND STARTS BUFFER GENERATION.                             26400002
CAN023   NI    CKQEFLG2,FULLMASK-CKFBDFAL  TURN ERR IND OFF      A34790 26500002
         XC    CKCBDECB(FOUR),CKCBDECB  CLEAR ECB                A34790 26600002
         LH    R2,CKCBBFAD        GRET BUFFER ADDRESS            A34790 26700002
         N     R2,CLEAR           ZERO HIGH ORDER BUTES          A34790 26800002
         LA    R2,RETURN-ORDERS+2(R2) GET ORDER PROG START ADDR  A34790 26900002
         STH   R2,CKCBWRKA+2      STORE GTRU LOC FOR RESTART     A34790 27000002
*        GWRITE CKCBDECB,STR,,2,CKCBBFAD,CKCBWRKA+TWO,CKCBBFAD,MF=E     27008000
         SR    15,15               CLEAR REGISTER           E12 ZA26368 27016000
         LA    1,CKCBDECB          PARAMETER LIST           E12 ZA26368 27024000
         MVI   4(1),X'A0'          BUF TYPE CODE IN DECB    E12 ZA26368 27032000
         MVI   5(1),X'6C'          STR TYPE CODE IN DECB    E12 ZA26368 27040000
         L     15,=A(2)                                     E12 ZA26368 27050000
         ST    15,20(0,1)          LENGTH IN DECB           E12 ZA26368 27100000
         LA    15,CKCBBFAD         AREA ADDRESS             E12 ZA26368 27109000
         ST    15,12(0,1)          AREA ADDRESS IN DECB     E12 ZA26368 27118000
         LA    15,CKCBWRKA+TWO     BUFFER ADDRESS           E12 ZA26368 27127000
         ST    15,28(0,1)          BUFFER ADDRESS IN DECB   E12 ZA26368 27136000
         LA    15,CKCBBFAD         START ADDRESS            E12 ZA26368 27145000
         ST    15,24(0,1)          START ADDRESS IN DECB    E12 ZA26368 27154000
         XC    0(4,1),0(1)         CLEAR ECB                E12 ZA26368 27163000
         L     15,CKCBECB          GET GIOCR ADDRESS        E12 ZA26368 27172000
         BALR  14,15               BRANCH TO ENTRY          E12 ZA26368 27181000
*                                                                A34790 27200002
         EJECT                                                          27250002
         BAL   R12,CANIO          GO CHECK I/O                          27300002
         TM    CKQEFLG2,CKFWTCNT  HAS WAIT CNT BEEN INCR BEFORE  A34790 27600002
         BO    CAN024             DO NOT INCR WAIT COUNT         A34790 27700002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 27850000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 27860000
         L     R7,TEB(R7)               GET TEB POINTER           M2878 27900002
         L     R6,TWOFOUR(R7)      GET GAR IRB ADDRESS          OY01294 27950002
         LA    R6,0(R6)            CLEAR HI-ORDER BYTE          OY01294 27960002
         L     R7,TCB(R7)               GET TCB POINTER           M2878 28000002
         L     R7,ZERO(R7)              GET ADDRESS OF OUR RB     M2878 28100002
         L     R7,RB(R7)                GET ADDRESS OF IFFCAN03'S M2878 28200002
*                                            RB                   M2878 28300002
         L     R7,RB(R7)                GET ADDRESS OF USER'S RB  M2878 28400002
         LA    R7,0(R7)            CLEAR HI-ORDER BYTE          OY01294 28450002
         CLR   R6,R7               IS THIS GAR'S IRB?           OY01294 28460002
         BNE   CAN0231             IF NO,INCREMENT...           OY01294 28470002
*                                  ...WAIT COUNT.               OY01294 28480002
         L     R7,RB(R7)           GET NEXT RB ADDRESS.         OY01294 28490002
CAN0231  EQU   *                                                OY01294 28492002
         SR    R6,R6                    CLEAR REGISTER            M2878 28500002
         IC    R6,RB(R7)                GET WAIT COUNT            M2878 28600002
         LA    R6,WON(R6)               INCREMENT BY ONE          M2878 28700002
         STC   R6,RB(R7)                RESTORE IN RB             M2878 28800002
         OI    CKQEFLG2,CKFWTCNT   SET WAIT CNT INCREMENTED FLAG A34790 28900002
CAN024   OI    CKQEFLG1,CKFATTWT  SET L.P. ATTN EXPECTED FLAG    A34790 29000002
         L     R13,CKCBSVAR+FOUR  RESTORE CALLERS SAVE AREA   LI  AOS/1 29060002
CAN025   EQU   *                                              LI  AOS/1 29120002
         RETURN (14,12),RC=0      RESTORE CALLERS SAVE AREA      A34790 29200002
         EJECT                                                          29300002
CAN030   LA    R7,CKCBROLL     SET PTR TO AREA ADDR FOR R/O      A34790 29400002
         LA    R1,CKCBWORK             PT TO LIST IN CKCB     LI A39419 29460002
         GETMAIN  EC,LV=256,A=(7),SP=0,MF=(E,(1))             LI A39419 29520002
         LTR   R15,R15                  ANY SPACE AVAILABLE        3112 29600002
         BNZ   CANERR1     NO, BRANCH FOR WTO                           29700002
         OI    CKQEFLG2,CKFROLBF  SET GETMAIN INDICATOR          A34790 29800002
         L     R7,CKCBROLL     GET BUFFER ADDRESS                A34790 29900002
         BUFINQ (R3),CKCBWRKA,8,MF=(E,(7))                       A34790 30000002
         C     R15,HEX20           SHORT LIST RETURN CODE               30100002
         BE    TSTENTRY            YES BRANCH AROUND ZERO TEST          30200002
         LTR   R15,R15                  RETURN CODE FROM BUFINQPTM 2320 30300002
*                                       ZERO FOR VALID REQUEST PTM 2320 30400002
         BNZ   CANERR3     IF NOT, BRANCH                               30500002
         EJECT                                                          30550002
TSTENTRY CLC   CKCBWRKA+FOUR(FOUR),FFS   IS THERE AN ENTRY       A34790 30600002
         BE    CANERR3     NO, WE'RE STUCK                              30700002
         LH    R6,CKCBWRKA+FOUR   FET BUFFER IN USE              A34790 30800002
         STH   R6,CKCBBFAD        SET AS OUR BUFFER ADDRESS      A34790 30900002
         XC    CKCBDECB(FOUR),CKCBDECB  CLEAR ECB                A34790 31000002
*        GREAD CKCBDECB,BUF,,256,(R7),CKCBBFAD,MF=E READ    E12 ZA26368 31003000
*                                        USER  FROM BUFFER  E12 ZA26368 31006000
         SR    15,15              CLEAR REGISTER            E12 ZA26368 31009000
         LA    1,CKCBDECB         PARAMETER LIST            E12 ZA26368 31012000
         ST    15,4(0,1)          CLEAR TYPE AREA IN DECB   E12 ZA26368 31015000
         MVI   4(1),X'80'           BUF TYPE CODE TO DECB   E12 ZA26368 31018000
         L     15,=A(256)         GET LENGTH                E12 ZA26368 31021000
         ST    15,20(0,1)         STORE LENGTH IN DECB      E12 ZA26368 31024000
         LA    15,0(R7)           GET AREA ADDRESS          E12 ZA26368 31027000
         ST    15,12(0,1)         STORE IN DECB             E12 ZA26368 31030000
         LA    15,CKCBBFAD        GET BUFFER ADDRESS        E12 ZA26368 31033000
         ST    15,28(0,1)         STORE IN DECB             E12 ZA26368 31036000
         XC    0(4,1),0(1)        CLEAR ECB                 E12 ZA26368 31039000
         L     15,CKCBECB         GET GIOCR ADDRESS         E12 ZA26368 31042000
         BALR  14,15              BRANCH TO ENTRY POINT     E12 ZA26368 31045000
         BAL   R12,CANIO          GO CHECK I/O                          31300002
         OI    CKQEFLG2,CKFROLUT  SET BUFFER R/O FLAG            A34790 31400002
         B     CAN020                   GO DO THE REST                  31500002
         EJECT                                                          31600002
*        SECOND ENTRY DETERMINES WHAT WAS DESIRED.                      31700002
*        IF TERMINATE OR DUMP THE BUFFER IS FREED AND                   31800002
*        IF TERMINATE THE BUFFER IS FREED OR ROLLED BACK OUT.           31900002
*        THEN THE RETURN CODE IS SET AND RETURN                         32000002
*        IF RESUME THE PICTURE IS RESTARTED, AND THE PROBLEM PROGRAM    32100002
*        IS TAKEN OUT OF THE WAIT STATE.                                32200002
CAN040   LR    R11,R1         SET UP ADDRESSABILITY FOR CKQE            32300002
         USING CKQE,R11                                                 32400002
         L     R9,CKQECKCB    SET UP ADDRESSABILITY FOR CKCB     A34790 32500002
         USING CKCB,R9                                                  32600002
         LA    R6,CKCBSVAR        CHAIN SAVEAREAS                A34790 32700002
         ST    R6,EIGHT(R13)  SAVE                                      32800002
         ST    R13,FOUR(R6)    AREAS                                    32900002
         LR    R13,R6                                                   33000002
         L     R3,CKQEDCB         GET DCB ADDRESS                A34790 33100002
*                                                                       33200002
* NOW DETERMINE WHICH OPTION WAS SELECTED BY THE USER.  ONE OF THE      33300002
* FOLLOWING ACTIONS IS TAKEN DEPENDENT UPON THE USER'S SELECTION:       33400002
*                   1-TERMINATE-ISSUE ABEND, CODE 063, NO DUMP          33500002
*                   2-DUMP-ISSUE ABEND, CODE 063, DUMP                  33600002
*                   3-RESUME-RESTART USER DISPLAY                       33700002
*                   4-BUFFER DUMP-LINK TO IFFCAN02; UPON RETURN         33800002
*                     REDISPLAY OUR MENU                                33900002
         NI    CKQEFLG1,FULLMASK-CKFATTWT  TURN OFF LIGHT PEN           34000002
*                                        EXPECTED FLAG           A34790 34100002
         SR    R10,R10                 CLEAR REGISTER        LG Z30AALG 34250000
         ICM   R10,THREE,CKQEUCB       GET UCB ADDRESS       LG Z30AALG 34260000
         LH    R6,CKCBBFAD        GET BUFFER ADDREESS            A34790 34300002
         N     R6,CLEAR           ZERO TWO LOW ORDER BYTES OF REGA34790 34400002
         LA    R7,D2250(R6)   COMPUTE MIN BFR LOC FOR BUFF DUMP         34500002
         MVC   CKCBBFDP(TWO),UCBSENSE(R10)  STORE SENSE IN CKCB  A34790 34600002
         CH    R7,CKCBBFDP        IS BUFF DUMP OPTION SELECTED   A34790 34700002
         BH    CAN044             NO,BRANCH TO CONTINUE SEARCH   A34790 34800002
         EJECT                                                          34900002
*                                                                       35000002
* BUFFER DUMP OPTION SELECTED.  PREARE MESSAGE AND GO TO IFFCAN02       35100002
*                                                                       35200002
         LA    R4,TWO          GET LENGTH                               35300002
         LA    R5,GECP          AREA ADDRESS                            35400002
         LH    R6,CKCBBFAD        GET BUFFER   ADDRESS           A34790 35500002
         N     R6,CLEAR           CLEAR HIGH ORDER BYTES         A34790 35600002
         LA    R6,BUFFGO(R6)   COMPUTE ADRESS OF THIS MESSAGE           35700002
         STH   R6,CKCBWRKA        STORE IN AREA                  A34790 35800002
         LA    R6,CKCBWRKA        ADDRESS IN DECB                A34790 35900002
         BAL   R7,CANWRITE     GO TO WRITE TO BUFFER                    36000002
         LA    R1,CANMSGS     GET POINTER TO ERROR MESSAGES             36100002
         ST    R1,CKCBERMT        PUT IN WORKAREA                A34790 36200002
         LR    R1,R11         PREPARE CKQE PTR                          36300002
         LINK  EP=IFFCAN02,MF=(E,(1))    GO TO DUMP PROGRAM             36400002
         LTR   R15,R15         IS RETURN CODE ZERO                      36500002
         BZ    CAN022             IF YES BRANCH                  A34790 36600002
         OI    CKQEFLG2,CKFBDFAL  ERROR ON BUFFER DUMP           A34790 36700002
         B     CAN022             BRANCH TO MSG ROUTINR          A34790 36800002
         EJECT                                                          36900002
CAN044   OI    CKQEFLG1,CKFEXIT    TURN ON EXIT IN PROCESS BIT   A34790 37000002
CAN045   TM    CKQEFLG2,CKFROLUT  CHECK IF BUFFER ROOLED OUT     A34790 37100002
         BO    CAN060         IF YES, BRANCH TO BRING IT BACK           37200002
         TM    CKQEFLG2,CKFROLBF  HAS BUFFER BEEN GOTTEN         A34790 37300002
         BO    CAN061             IF YES, GO FREE IT             A34790 37400002
         CLC   CKCBBFAD(FOUR),ZEROS   HAS BUFFER BEEN GOTTEN      CRB   37500002
         BE    CAN047                 NO DON'T RELEASE BUFFER     CRB   37600002
         EJECT                                                          37700002
*                                                                       37800002
* BUFFER HAS NOT BEEN ROLLED OUT.  RELEASE ANY ACQUIRED BUFFER BEFORE   37900002
* ANYTHING ELSE.                                                        38000002
*                                                                       38100002
         L     R3,CKQEDCB             GET DCB ADDRESS             CRB   38200002
         RLSEBFR  (R3),CKCBBFAD,MF=(E,CKCBWRKA)  FREE BUFFER     A42796 38300002
         MVC   CKCBBFAD(FOUR),ZEROS    CLEAR CKCBBFAD FIELD   LI A39419 38350002
         C     R15,HEX14                                         A44019 38400002
         BE    CAN047                   BRANCH IF GOOD RELEASE   A44019 38500002
         LTR   R15,R15                  RELEASE BUFFER GOOD      A38916 38600002
         BNZ   CANERR8                NO, BRANCH TO ERROR MSG     CRB   38700002
CAN047   LA    R7,REP(R6)    SET MIN BFR ADDRESS FOR RESUME       CRB   38800002
         CH    R7,CKCBBFDP        IS RESUME OPTION SELECTED      A34790 38900002
         BH    CAN048      IF NO, BRANCH                                39000002
         TM    CKQEFLG1,CKFBFRUN   WAS FBUFFER RUNNING           A34790 39100002
         BZ    CAN047D1       IF NOT, BRANCH                            39200002
         NI    CKQEFLG1,FULLMASK-CKFBFRUN   ZERO THIS BIT        A34790 39300002
         XC    CKCBDECB(FOUR),CKCBDECB   CLEAR ECB               A34790 39400002
*        GCNTRL  CKCBDECB,STR,,CKCBREST+TWO,MF=E RSTRT USER E12 ZA26368 39404000
         SR    15,15                 CLEAR REGISTER         E12 ZA26368 39408000
         LA    1,CKCBDECB             PARAMETER LIST        E12 ZA26368 39412000
         ST    15,4(0,1)             CLEAR TYPE IN DECB     E12 ZA26368 39416000
         MVI   4(1),X'6C'            STR TYPE CODE IN DECB  E12 ZA26368 39420000
         LA    15,CKCBREST+TWO       AREA ADDRESS           E12 ZA26368 39424000
         ST    15,24(0,1)            STORE IN DECB          E12 ZA26368 39428000
         XC    0(4,1),0(1)           CLEAR ECB              E12 ZA26368 39432000
         L     15,CKCBECB            GET GIOCR ADDRESS      E12 ZA26368 39436000
         BALR  14,15                 BRANCH TO ENTRY POINT  E12 ZA26368 39440000
         BAL   R12,CANIO          CHECK FOR GOOD I/O             A34790 39600002
         EJECT                                                          39650002
CAN047D1 TM    CKQEFLG2,CKFWTCNT   HAS WAIT COUNT BEEN MODIFIED  A34790 39700002
         BNO   CAN048D3           IF NO, DON'T DECREMENT         A34790 39800002
         NI    CKQEFLG2,FULLMASK-CKFWTCNT  TURN OFF FLAG         A34790 39900002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 40050000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 40060000
         L     R7,TEB(R7)               GET TEB ADDRESS           M2878 40100002
         L     R6,TWOFOUR(R7)      GET GAR'S IRB ADDRESS        OY01294 40150002
         LA    R6,0(R6)            CLEAR HI-ORDER BYTE          OY01294 40160002
         L     R7,TCB(R7)               GET TCB ADDRESS           M2878 40200002
         L     R7,ZERO(R7)              GET OUR RB ADDRESS        M2878 40300002
         L     R7,RB(R7)                GET IFFCAN03'S RB ADDRESS M2878 40400002
         L     R7,RB(R7)                GET USER'S RB ADDRESS     M2878 40500002
         LA    R7,0(R7)            CLEAR HI-ORDER BYTE          OY01294 40550002
         CLR   R6,R7               IS THIS GAR'S IRB?           OY01294 40560002
         BNE   CAN047D2            IF NO,DECREMENT IRB....      OY01294 40570002
*                                  ...WAIT COUNT.               OY01294 40580002
         L     R7,RB(R7)           GET NEXT RB ADDRESS.         OY01294 40590002
CAN047D2 EQU   *                                                OY01294 40592002
         SR    R6,R6                    CLEAR REGISTER            M2878 40600002
         IC    R6,RB(R7)                GET USERS WAIT COUNT      M2878 40700002
         BCTR  R6,0                     DECREMENT IT BY ONE       M2878 40800002
         STC   R6,RB(R7)          RESTORE USERS WAIT COUNT       A34790 40900002
         B     CAN048D3       BRANCH TO FREE STORAGE                    41000002
CAN048   TM    CKQEFLG1,CKFEXIT   OPTIN SELECTED                 A34790 41100002
         BNO   CANEXIT            NO, GO FREE CKCB               A34790 41200002
         LA    R7,DMP(R6)  COMP MIN BUFFER ADDRESS FOR DUMP OPT. A34790 41300002
         CH    R7,CKCBBFDP        IS TERM OPTION SELECTED        A34790 41400002
         BH    CAN048D1       NO, BRANCH                                41500002
         OI    CKQEFLG1,CKFABDMP  SET DUMP BIT                   A34790 41600002
CAN048D1 EQU   *                                              LB  AOS/1 41700002
         OI    CKQEFLG1,CKFDEQUE  SET DE-QUE BIT                 A34790 41900002
         NI    CKQEFLG1,FULLMASK-CKFCKCB TURN OFF CKCB VALID FLG A34790 42000002
         L     R13,FOUR(R13)  SET FREEMAIN AREA                         42100002
         FREEMAIN R,LV=CKBLGTH,A=(9),SP=250                E12 @ZA24234 42200000
         EJECT                                                          42202002
         TM    CKQEFLG2,CKFWTCNT       HAS WAIT COUNT UPED    LI A39419 42207002
         BNO   CAN048D4                IF NO DON'T DECREMENT  LI A39419 42214002
         NI    CKQEFLG2,FULLMASK-CKFWTCNT  TURN OFF FLAG      LI A39419 42221002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 42230000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 42232000
         L     R7,TEB(R7)              GET TEB ADDRESS        LI A39419 42235002
         L     R6,TWOFOUR(R7)      GET GAR'S IRB ADDRESS        OY01294 42237002
         LA    R6,0(R6)            CLEAR HI-ORDER BYTE          OY01294 42239002
         L     R7,TCB(R7)              GET TCB ADDRESS        LI A39419 42242002
         L     R7,ZERO(R7)             GET OUR RB ADDRESS     LI A39419 42249002
         L     R7,RB(R7)               GET IFFCAN03 RB ADDRESSLI A39419 42256002
         L     R7,RB(R7)               GET USER RB ADDRESS    LI A39419 42263002
         LA    R7,0(R7)            CLEAR HI-ORDER BYTE          OY01294 42265002
         CLR   R6,R7               IS THIS GAR'S IRB?           OY01294 42267002
         BNE   CAN048D5            IF NO,DECREMENT IRB...       OY01294 42269002
*                                  ... WAIT COUNT.              OY01294 42269402
         L     R7,RB(R7)           GET NEXT RB ADDRESS          OY01294 42269802
CAN048D5 EQU   *                                                OY01294 42269902
         SR    R6,R6                   CLEAR REGISTER         LI A39419 42270002
         IC    R6,RB(R7)               GET USER WAIT COUNT    LI A39419 42277002
         BCTR  R6,0                    DECREMENT BY 1         LI A39419 42284002
         STC   R6,RB(R7)               RESTORE USER WAIT COUNTLI A39419 42291002
CAN048D4 TM    CKQEFLG1,CKFABDMP       IS THIS DUMP           LI A39419 42341002
         BO    CAN048D2       IF YES, BRANCH                            42400002
         WTO   'IFF006I JOB WAS TERMINATED WITH CANCEL KEY TERMINATE OPX42650002
               TION',ROUTCDE=11,DESC=7                           S21016 42700002
         ABEND 099,,,SYSTEM   NO, SET UP ABEND WITHOUT DUMP E12 ZA26469 42900000
         EJECT                                                          42950002
CAN048D2 EQU   *                                                        43400002
         WTO   'IFF007I JOB WAS TERMINATED WITH CANCEL KEY DUMP OPTION'X43550002
               ,ROUTCDE=11,DESC=7                                S21016 43600002
         ABEND 099,DUMP,,SYSTEM        SET UP ABEND W/DUMP  E12 ZA26469 43700000
*                                                                       43800002
*                                                                       43900002
CAN048D3 NI    CKQEFLG1,FULLMASK-CKFCKCB  SET CKCB VALID BIT OFF A34790 44000002
         OI    CKQEFLG1,CKFDEQUE  SET DEQUE BIT AFTER RESUME     A34790 44100002
         L     R13,FOUR(R13)  RESET SAVE ADDRESS                        44200002
         L     R3,CKQEDCB          LOAD DCB ADDRESS               M6619 44300002
         MVC   SIXTEEN(4,R3),CKDCBSTR RESTORE DCB BFR STRT ADDR   M6619 44400000
         FREEMAIN  R,LV=CKBLGTH,A=(9),SP=250               E12 @ZA24234 44450000
         B     CAN025                   BRANCH TO RETURN          M2878 44600002
         EJECT                                                          44700002
*                                                                       44800002
* USER BUFFER WAS ROLLED OUT.  BRING HIS BUFFER BACK AND FREE AQUIRED   44900002
* STORAGE                                                               45000002
*                                                                       45100002
CAN060   NI    CKQEFLG2,FULLMASK-CKFROLUT  TURN OFF ROLLOUT FLG  A34790 45200002
         L     R7,CKCBROLL        GET PTR TO BUFFER              A34790 45300002
         XC    CKCBDECB(FOUR),CKCBDECB  CLEAR ECB                A34790 45400002
*        GWRITE  CKCBDECB,BUF,,256,(7),CKCBBFAD,MF=E        E12 ZA26368 45450000
         LA    1,CKCBDECB          PARAMETER LIST           E12 ZA26368 45457000
         SR    15,15             CLEAR REGISTER             E12 ZA26268 45464000
         MVI   4(1),X'A0'        BUF TYPE CODE TO DECB      E12 ZA26368 45471000
         L     15,=A(256)        GET LENGTH                 E12 ZA26368 45478000
         ST    15,20(0,1)        STORE IN DECB              E12 ZA26368 45485000
         LA    15,0(7)           GET AREA ADDRESS           E12 ZA26368 45492000
         ST    15,12(0,1)        STORE IN DECB              E12 ZA26368 45499000
         LA    15,CKCBBFAD       GOT BUFFER ADDRESS         E12 ZA26368 45506000
         ST    15,28(0,1)        STORE IN DECB              E12 ZA26368 45513000
         L     15,CKCBECB        GET GIOCR ADDRESS          E12 ZA26368 45520000
         BALR  14,15             BRANCH TO ENTRY POINT      E12 ZA26368 45527000
         MVC   CKCBBFAD(FOUR),ZEROS    CLEAR CKCBBFAD FIELD   LI A39419 45550002
         BAL   R12,CANIO          GO TO CHECK IO                 A34790 45600002
CAN061   LA    R7,CKCBROLL     SET ADDRESS OF AREA TO BR FREED   A34790 45700002
         LA    R1,CKCBWORK             PT TO LIST IN CKCB     LI A39419 45760002
         FREEMAIN  E,LV=256,A=(7),SP=0,MF=(E,(1))             LI A39419 45820002
         NI    CKQEFLG2,FULLMASK-CKFROLBF  TURN OFF R/O GETMN FLGA34790 45900002
         B     CAN047             BRANCH TO TEST SELECTIONS             46000002
         EJECT                                                          46800002
*                                                                       46900002
* THIS WRITE SUBROUTINE IS USED THROUGHOUT PROGRAM TO PUT DATA TO THE   47000000
* BUFFER WITHOUT STARTING GENERATION. INPUT IS AS FOLLOWS:              47100002
*  REGISTER 4: LENGTH OF DATA TO BE WRITTEN                             47200002
*    REGISTER 5; POINTER TO DATA TO BE WRITTEN                          47300002
*   REGISTER 6: BUFFER ADDRESS IN DECB                                  47400002
*                                                                       47500002
CANWRITE XC    CKCBDECB(FOUR),CKCBDECB   CLEAR DECB              A34790 47600002
*        GWRITE  CKCBDECB,BUF,,(4),(5),(6),MF=E  WRT TO BFR E12 ZA26368 47700000
         LA    1,CKCBDECB        PARAMETER LIST             E12 ZA26368 47707000
         SR    15,15             CLEAR REGISTER             E12 ZA26368 47714000
         ST    15,4(0,1)         CLEAR TYPE IN DECB         E12 ZA26368 47721000
         MVI   4(1),X'A0'        BUF TYPE CODE TO DECB      E12 ZA26368 47728000
         LA    15,0(4)           GET LENGTH                 E12 ZA26368 47735000
         ST    15,20(0,1)        STORE IN DECB              E12 ZA26368 47742000
         LA    15,0(5)           GET AREA ADDRESS           E12 ZA26368 47749000
         ST    15,12(0,1)        STORE IN DECB              E12 ZA26368 47756000
         LA    15,0(6)           GET BUFFER ADDRESS         E12 ZA26368 47763000
         ST    15,28(0,1)        STORE IN DECB              E12 ZA26368 47770000
         L     15,CKCBECB        GET GIOCR ADDRESS          E12 ZA26368 47777000
         BALR  14,15             BRANCH TO ENTRY POINT      E12 ZA26368 47784000
         LR    R12,R7      SET RETURN ADDRESS                           47800002
*                                                                       47900002
* CHECK ERROR CODE FROM GIOCR FOR I/O STARTED.  WAIT FOR I/O            48000002
* COMPLETION, CHECK POST CODE, BRANCH ON ERRORS OR RETURN TO CALLER     48100002
*                                                                       48200002
CANIO    LTR   R15,15        CHECK FOR ZERO RETURN CODE                 48300002
         BNZ   CANERR2         IF NOT, BRANCH                           48400002
         LA    R1,CKCBDECB        GET ECB POINTER                A34790 48500002
         WAIT  ECB=(1)       WAIT FOR I/O COMPLETION                    48600002
         CLI   CKCBDECB,HEX7F     I/O GOOD                       A34790 48700002
         BNE   CANERR2           NO, BRANCH                      A34790 48800002
         BR    R12           RETURN TO CALLER                           48900002
*                                                                       49100002
* ERROR HAS BEEN DETECTED.  PUT MESSAGE IN WORKAREA AND ISSUE WTO.      49200002
*                                                                       49300002
CANERR1  MVC   CKCBWRKA(CAN1LN),CANMSG1  PUT MSG IN WKAREA       A34790 49400002
         B     CANSVC               BRANCH TO MOVE UNIT ADDRESS         49500002
CANERR2  MVC   CKCBWRKA(CAN2LN),CANMSG2  PUT MSG IN WKAREA       A34790 49600002
         B     CANSVC               BRANCH TO MOVE UNIT ADDRESS         49700002
CANERR8  MVC   CKCBWRKA(CAN8LN),CANMSG8   PUT MSG IN WKAREA       CRB   49800002
         B     CANSVC               GO GET UNIT ADDRESS                 49900002
CANERR9  EQU   *                                             LG @ZM2360 49950000
         MVC   CKCBWRKA(CAN9LN),CANMSG9 MSG IN WRKAREA       LG @ZM2360 49960000
         B     CANSVC         BRANCH TO SET UNIT ADDRESS     LG @ZM2360 49970000
CANERR3  MVC   CKCBWRKA(CAN3LN),CANMSG3  PUT MSG IN WKAREA       A34790 50000002
CANSVC   LA    R1,CKCBWRKA        GET PARAMETER LIST             A34790 50100002
         SR    R7,R7                   CLEAR REGISTER        LG Z30AALG 50250000
         ICM   R7,THREE,CKQEUCB        GET UCB ADDRESS       LG Z30AALG 50260000
         MVC   TWELVE(THREE,R1),THIRTEEN(R7)  PUT UNIT INTO LIST        50300002
         SVC   35      ISSUE WTO                                        50400002
         B     CAN045             GO TO BUFFER R/O CHECK         A34790 50500002
CANEXIT  TM    CKQEFLG1,CKFCKCB   IS CKCB VALID                  A34790 50600002
         BZ    CANRTN              IF NOT, BRANCH TO RETURN             50700002
         NI    CKQEFLG1,FULLMASK-CKFCKCB  SET VALID CKCB FLAG    A34790 50800002
         L     R13,FOUR(R13)       GET SAVE AREA                        50900002
         FREEMAIN  R,LV=CKBLGTH,A=(R9),SP=250              E12 @ZA24234 51000000
CANRTN   OI    CKQEFLG1,CKFDEQUE   MARK CKQE TO BE FREED         A34790 51100002
         B     CAN025             GO TO RETURN TO USER           A34790 51200002
CANMSGS  DC    A(CANMSG1)                                               51300002
         DC    A(CANMSG2)                                               51400002
         DC    A(CANMSG3)                                               51500002
         DC    A(CANMSG4)                                               51600002
         DC    A(CANMSG5)                                               51700002
         DC    A(CANMSG9)                                    LG @ZM2360 51750000
         EJECT                                                          51800002
CANMSG1  WTO   'IFF001I XXX REQUEST IGNORED; LACK OF CORE',MF=L,       ,51900002
               ROUTCDE=(2,11),DESC=4                                    52000002
CANMSG1E EQU   *                                                        52100002
CANMSG2  WTO   '1FF002I XXX REQUEST IGNORED; PERMANENT I/O ERROR',     ,52200002
               MF=L,ROUTCDE=(2,11),DESC=4                               52300002
CANMSG2E EQU   *                                                        52400002
CANMSG3  WTO   'IFF003I XXX REQUEST IGNORED; NO 2250 BUFFER AVAILABLE',,52500002
               MF=L,ROUTCDE=(2,11),DESC=4                               52600002
CANMSG3E EQU   *                                                        52700002
CANMSG4  WTO   'IFF004I XXX REQUEST IGNORED; OPEN FAILURE ON SYSBFDMP',,52800002
               MF=L,ROUTCDE=(2,11),DESC=4                               52900002
CANMSG4E EQU   *                                                        53000002
         EJECT                                                          53050002
CANMSG5  WTO   'IFF005I                                              ',,53100002
               MF=L,ROUTCDE=(2,11),DESC=4                               53200002
CANMSG5E EQU   *                                                        53300002
CANMSG8  WTO   'IFF008I XXX RLSEBFR FAILED IN CANCEL KEY RTN',MF=L,    X53400002
               ROUTCDE=11,DESC=7                                        53500002
CANMSG8E EQU   *                                                        53600002
CANMSG9  WTO   'IFF0009I XXX REQUEST IGNORED;GIOCR ADDRESS NOT IN DCB',X53650000
               MF=L,ROUTCDE=11,DESC=7                        LG @ZM2360 53660000
CANMSG9E EQU   *                                             LG @ZM2360 53670000
CAN1LN   EQU   CANMSG1E-CANMSG1                                         53700002
CAN2LN   EQU   CANMSG2E-CANMSG2                                         53800002
CAN3LN   EQU   CANMSG3E-CANMSG3                                         53900002
CAN8LN   EQU   CANMSG8E-CANMSG8                                         54000002
CAN9LN   EQU   CANMSG9E-CANMSG9  LENGTH OF MESSAGE 9         LG @ZM2360 54050000
         EJECT                                                          54100002
         GINIT                                                          54200002
ORDERS   GSRT                                                           54300002
         GEVM                                                           54400002
         GDV   0,3900,B                                                 54500002
         GECP  L                                                        54600002
         GTXT  '* TERMINATE'                                            54700002
         GCNOP C                                                        54800002
         GEVM                                                           54900002
         GDV   0,3600,B                                                 55000002
DUMP     GECP  L                                                        55100002
         GTXT  '* DUMP'                                                 55200002
         GCNOP C                                                        55300002
         GEVM                                                           55400002
         GDV   0,3300,B                                                 55500002
REPRESS  GECP  L                                                        55600002
         GTXT  '* RESUME'                                               55700002
         GCNOP C                                                        55800002
         GEVM                                                           55900002
         GDV   0,3000,B                                                 56000002
DUMP2250 GECP  L                                                        56100002
         GTXT  '* BUFFER DUMP'                                          56200002
         GCNOP C                                                        56300002
         GEVM                                                           56400002
         GDV   0,2400,B                                                 56500002
DUMPGO   GECP  B                                                        56600002
         GTXT  'IFF101I BUFFER DUMP IN PROGRESS'                        56700002
         GCNOP C                                                        56800002
         GEVM                                                           56900002
         GDV   0,2400,B                                                 57000002
DUMPNOGO GECP  B                                                        57100002
         GTXT  'IFF105I BUFFER DUMP UNSUCCESSFUL'                       57200002
         GCNOP C                                                        57300002
RETURN   GTRU  0                                                        57400002
LEN      EQU   *-ORDERS-2                                               57500002
DMP      EQU   DUMP-ORDERS                                              57600002
REP      EQU   REPRESS-ORDERS                                           57700002
D2250    EQU   DUMP2250-ORDERS                                          57800002
BUFFGO   EQU   DUMPGO-ORDERS                                            57900002
BUFFNOGO EQU   DUMPNOGO-ORDERS                                          58000002
ORDERSE  EQU   *                                                        58100002
ODERLNTH EQU   ORDERSE-ORDERS                                           58200002
GECP     GECP  B                                                        58300002
GNOP     GNOP2                                                          58400002
         EJECT                                                          58500002
*                                                                 M2878 58600002
*                                                                 M2878 58700002
*                        STORAGE CONSTANTS                        M2878 58800002
*                                                                 M2878 58900002
*                                                                 M2878 59000002
         SPACE 2                                                  M2878 59100002
DISABLE  DC    X'00'                    SYSTEM MASK TO REJECT     M2878 59200002
*                                            INTERRUPTS           M2878 59300002
ENABLE   DC    X'FF'                    SYSTEM MASK TO EXCEPT     M2878 59400002
*                                            INTERRUPTS           M2878 59500002
SYSBFDMP DC    C'SYSBFDMP'                                              59600002
HEX14    DC    F'20'                                                    59700002
HEX20    DC    F'32'                                                    59800002
ZEROS    DC    F'0'                                                     59900002
ONE      DC    F'1'                                                     60000002
FFS      DC    X'FFFFFFFF'                                              60100002
CLEAR    DC    X'0000FFFF'        ZERO LOW ORDER BYTES OF REG    A34790 60200002
         LTORG                                                          60300002
          EJECT                                                         60400002
CKQE     DSECT         SYSTEM CANCEL KEY QUEUE ELEMENT                  60500002
         SPACE 2                                                        60600002
CKQECKQE DS    F                        POINTER TO NEXT CKQE ON         60700002
*                                            ACTIVE LIST                60800002
CKQEFLG1 DS    X                        FLAG FIELD BYTE ONE             60900002
CKFGJP   EQU   X'80'                    IS THIS CALL TO SYSTEM CANCEL   61000002
*                                            KEY ROUTINES FROM GJP      61100002
*                                            ABEND HOOK                 61200002
CKFABDMP EQU   X'40'                    A ABEND DUMP IS REQUESTED BY    61300002
*                                            THE 2250 OPERATOR          61400002
CKFATTWT EQU   X'20'                    SYSTEM CANCEL KEY ROUTINES      61500002
*                                            ARE EXPECTING AN ATTENTION 61600002
*                                            FROM DEVICE ASSOCIATED     61700002
*                                            WITH THIS CKQE             61800002
CKFCKCB  EQU   X'10'                    CANCEL KEY CONTROL BLOCK        61900002
*                                            POINTER IS VALID IN CKQE   62000002
CKFEXIT  EQU   X'08'                    EXIT IN PROCESS                 62100002
CKFECB   EQU   X'04'                    GJP ECB POINTER IS VALID IN     62200002
*                                            CKQE AND GJP IS WAITING    62300002
*                                            TO BE POSTED               62400002
CKFDEQUE EQU   X'02'                    SYSTEM CANCEL KEY ROUTINE HAS   62500002
*                                            PERFORMED ALL REQUESTS     62600002
*                                            FOR DEVICE ASSOCIATED      62700002
*                                            WITH THIS CKQE AND THE     62800002
*                                            CKQE SHOULD BE DEQUEUED    62900002
CKFBFRUN EQU   X'01'                    THE 2250 BUFFER WAS RUNNING     63000002
*                                            AT THE TIME THE SYSTEM     63100002
*                                            CANCEL KEY FUNCTION WAS    63200002
*                                            REQUESTED                  63300002
CKQEFLG2 DS    X                        SECOND BYTE OF FLAG FIELD       63400002
CKFROLBF EQU   X'80'                    GETMAIN HAS BEEN ISSUED TO      63500002
*                                            ROLL OUT THE USERS         63600002
*                                            BUFFER SECTION             63700002
CKFROLUT EQU   X'40'                    USERS BUFFER HAS BEEN ROLLED    63800002
*                                            OUT                        63900002
CKFINBUF EQU   X'20'                    GETMAIN FOR INPUT BUFFER FOR    64000002
*                                            BUFFER DUMP REQUEST HAS    64100002
*                                            BEEN ISSUED SUCCESSFULLY   64200002
CKFOPCB  EQU   X'10'                    GETMAIN FOR OUTPUT CONTROL      64300002
*                                            BLOCK HAS BEEN ISSUED      64400002
CKFOPEN  EQU   X'08'                    SYSBFDMP OUTPUT DCB IS OPEN     64500002
CKFLPATN EQU   X'04'                    THIS IS AN ENTRY SCHEDULED      64600002
*                                            BY GAR WITH A LIGHTPEN     64700002
*                                            ATTENTION.                 64800002
CKFWTCNT EQU   X'02'                    THE REQUESTOR OF A        M2878 64900002
*                                            SYSTEM CANCEL KEY    M2878 65000002
*                                            FUNCTION REQUEST     M2878 65100002
*                                            BLOCK'S WAIT COUNT   M2878 65200002
*                                            HAS BEEN INCREMENTED M2878 65300002
*                                            BY ONE               M2878 65400002
CKFBDFAL EQU   X'01'              SET TO ONE IF IFFCAN02 GAVE    A34790 65500002
*                                    A NONZERO RC TO IFFCAN01    A34790 65600002
*                                     INDICATING AN ERROR WHILE  A34790 65700002
*                                    DUMPING THE BUFFER          A34790 65800002
CKQEUCB  DS    H                        UNIT CONTROL BLOCK THAT IS NOW  65900002
*                                            UNDER CONTROL OF THE       66000002
*                                            SYSTEM CANCEL KEY ROUTINES 66100002
CKQECKCB DS    F                        POINTER TO CANCEL KEY CONTROL   66200002
*                                            BLOCK ASSOCIATED WITH THIS 66300002
*                                            CKQE                       66400002
CKQEDCB  DS    F                        POINTER TO THE OPEN DATA        66500002
*                                            CONTROL BLOCK FOR THE      66600002
*                                            DEVICE REQUESTING THE      66700002
*                                            SYSTEM CANCEL KEY FUNCTION 66800002
         EJECT                                                          66900002
CKCB     DSECT         SYSTEM CANCEL KEY CONTROL BLOCK                  67000002
         SPACE 2                                                        67100002
CKCBOPCB DS    F                        ADDRESS OF OUTPUT CONTROL BLOCK 67200002
*                                            ASSOCIATED WITH THIS CKCB  67300002
CKCBECB  DS    F                        ADDRESS OF GJP'S ECB TO BE      67400002
*                                            POSTED WHEN SYSTEM CANCEL  67500002
*                                            KEY FUNCTION REQUESTED BY  67600002
*                                            GJP IS COMPLETE            67700002
CKCBSVAR DS    18F                      SAVE AREA FOR IFFCAN01          67800002
CKCBBFAD DS    H                        BUFFER ADDRESS WHERE SYSTEM     67900002
*                                            CANCEL KEY 256 BYTE BUFFER 68000002
*                                            SECTION STARTS.  OPTION    68100002
*                                            PANEL WILL BE PLACED INTO  68200002
*                                            THIS SECTION               68300002
CKCBBFLG DS    H                        BUFFER LENGTH OF THE DATA       68400002
*                                            WRITTEN TO THE 2250 FOR    68500002
*                                            THE OPTIONS PANEL          68600002
CKCBWRKA DS    CL64                    WORK AREA FOR:                   68700002
*                                            READ MI INPUT              68800002
*                                            READ SENSE INPUT           68900002
*                                            BUFFER INQUIRY TABLE       69000002
*                                            WRITE TO OPERATOR MESSAGES 69100002
CKCBDECB DS    8F                       DATA EVENT CONTROL BLOCK        69200002
*                                            USED IN I/O OPERATIONS     69300002
*                                            TO THE 2250                69400002
CKCBREST DS    F                        ADDRESS OF 2250 RESTART         69500002
*                                            GNERATION OF THE USERS     69600002
*                                            BUFFER PROGRAM             69700002
CKCBROLL DS    F                        ADDRESS OF 256 BYTE AREA USED   69800002
*                                            TO ROLL OUT USERS BUFFER   69900002
*                                            IF NO OTHER BUFFER SPACE   70000002
*                                            AVAILABLE FOR THE DEVICE   70100002
CKCBERMT DS    F                        POINTER TO TABLE OF ERROR       70200002
*                                            MESSAGES TO BE SENT TO     70300002
*                                            THE SYSTEM OPERATOR UPON   70400002
*                                            ERROR CONDITION.           70500002
*                                                                       70600002
CKDCBSTR DS    F                  SAVE AREA FOR DCB BFR STRT ADDR M6619 70700002
CKCBWORK DS    F                       LENGTH FOR E GETMAIN   LI A39419 70720002
         DS    F                       ADDR OF ADDR LIST      LI A39419 70740002
         DS    C                       EC MODE                LI A39419 70760002
         DS    C                       SP VALUE               LI A39419 70780002
CKCBBFDP DS    H                  STOREAGE AREA FOR SENSE DATA   A34790 70800002
*                                    FROM THE UCB ON A LIGHT     A34790 70900002
*                                    PEN ATTENTION               A34790 71000002
CKCBE    EQU   *                                                        71100002
CKBLGTH  EQU   CKCBE-CKCB                                               71200002
         END                                                            71300002
UCBBUF   EQU   24                                                       71400002
UCBTE    EQU   28                  TE PTR IN UCB                        71700002
CAN      EQU   12                  CANCEL WORD IN TE                    72000002
UCBRST   EQU   32                  BUFFER RESTART ADDR IN UCB           72300002
RUN      EQU   X'01'               BUFFER RUN BIT IN SW                 72600002
ROLL     EQU   X'02'               ROLL OUT BIT IN SW                   72900002
IOERR    EQU   X'04'                                                    73200002
GJP      EQU   X'08'                                                    73500002
ENDKEY   EQU   X'20'               END KEY IN READ MIP                  73800002
RUNOFF   EQU   X'FE'               TURN OFF RUN SW                      74100002
RTNCDE   EQU   X'80'                                                    74400002
ABND     EQU   X'40'                                                    74700002
TETCB    EQU   8                                                        75000002
TCBRB    EQU   0                                                        75300002
RBLNK    EQU   28                                                       75600002
CONST    DC    C'CANC'                                                  75900002
FFS      DC    X'FFFFFFFF'                                              76200002
ONE      DC    F'1'                                                     76500002
F8       DC    F'8'                                                     76800002
COREADR  DC    F'0'                                                3112 76900002
COMCODE  DS    0F                                                       77100002
         DC    X'00000222'                                              77400002
WTOPARM  DC    H'43'                                                    77700002
         DC    H'0'                                                     78000002
WTOMSG   DC    C'PERMANENT ERROR ON    .  ATTENTION IGNORED.'           78300002
         EJECT                                                          78600002
         GINIT                                                          78900002
ORDERS   GSRT                                                           79200002
         GEVM                                                           79500002
         GDV   0,3900,B                                                 79800002
         GECP  L                                                        80100002
         GTXT  '* TERMINATE'                                            80400002
         GCNOP C                                                        80700002
         GEVM                                                           81000002
         GDV   0,3600,B                                                 81300002
DUMP     GECP  L                                                        81600002
         GTXT  '* DUMP'                                                 81900002
         GCNOP C                                                        82200002
         GEVM                                                           82500002
         GDV   0,3300,B                                                 82800002
REPRESS  GECP  L                                                        83100002
         GTXT  '* RESUME'                                               83400002
         GCNOP C                                                        83700002
RETURN   GTRU  0                                                        84000002
LEN      EQU   *-ORDERS-2                                               84300002
DMP      EQU   DUMP-ORDERS                                              84600002
REP      EQU   REPRESS-ORDERS                                           84900002
GNOP     GNOP2                                                          85200002
         EJECT                                                          85500002
STORAG   DSECT                                                          85800002
CONID    DS    F                                                        86100002
GJPWAIT  DS    F                                                        86400002
SAVE     DS    18F                                                      86700002
READIN   DS    3F                                                       87000002
BUFAD    DS    H                                                        87300002
BUFLEN   DS    H                                                        87600002
DECB1    DS    8F                                                       87900002
SW       DS    X                                                        88200002
WAIT     DS    X                                                        88500002
RESTRT   DS    F                                                        88800002
SAV256   DS    F                                                        89100002
DCBAD    DS    F                                                        89400002
         END                                                            89700002
