RTAM     TITLE 'HASP REMOTE SERVICES PROLOG'                            S0000500
*********************************************************************** S0001000
*                                                                     * S0001500
* MODULE NAME = HASJES20 (HASPRTAM CSECT)                             * S0002000
*                                                                     * S0002500
* DESCRIPTIVE NAME = HASPRTAM CSECT OF JES2 MAIN MODULE               * S0003000
*                                                                     * S0003500
* COPYRIGHT = NONE                                                    * S0004100
*                                                                     * S0004700
* STATUS = OS/VS2 MVS   --  SEE &VERSION (BELOW) FOR JES2 LEVEL       * S0005000
*                                                                     * S0005500
* FUNCTION = HASPRTAM CONSISTS OF RTAM SUBROUTINES AND TWO HASP       * S0006000
*            PROCESSORS (SEE ENTRY POINTS) WHICH PROVIDE ACCESS       * S0006500
*            TO ALL REMOTE TERMINALS.  THE HASP INPUT AND OUTPUT      * S0007000
*            PROCESSORS (SEE HASPRDR AND HASPPRPU MODULES) REQUEST    * S0007500
*            THIS ACCESS VIA THE RTAM SUBROUTINES AT THE LOGICAL      * S0008000
*            RECORD LEVEL AND NEED NOT BE AWARE OF ANY TERMINAL       * S0008500
*            OR TP DEVICE DEPENDENCIES, TRANSMISSION CODES,           * S0009000
*            TIMING REQUIREMENTS, ERROR RECOVERY, ETC.                * S0009500
*                                                                     * S0010000
* NOTES = SEE BELOW                                                   * S0010500
*                                                                     * S0011000
*    DEPENDENCIES = EXCP ACCESS METHOD, NO STANDARD ERROR RECOVERY    * S0011500
*                   VTAM/SNA INTERFACES AND CONTROL BLOCKS            * S0012000
*                                                                     * S0012500
*    RESTRICTIONS = NONE                                              * S0013000
*                                                                     * S0013500
*    REGISTER CONVENTIONS = SEE ENTRY POINTS                          * S0014000
*                                                                     * S0014500
*    PATCH LABEL = NONE                                               * S0015000
*                                                                     * S0015500
* MODULE TYPE = PROCEDURE, TABLE (CSECT TYPE)                         * S0016000
*                                                                     * S0016500
*    PROCESSOR = ASSEMBLER F                                          * S0017000
*                                                                     * S0017500
*    MODULE SIZE = SEE $DLENGTH MACRO EXPANSION(S) AT END OF ASSEMBLY * S0018000
*                                                                     * S0018500
*    ATTRIBUTES = READ ONLY, AFTER HASP INITIALIZATION, AND           * S0019000
*                 HASP REENTRANT                                      * S0019500
*                                                                     * S0020000
* ENTRY POINT = HASPEXTP - INVOKE TERMINAL I/O SERVICE                * S0020500
*                                                                     * S0021000
*    PURPOSE = CALLED BY PROCESSORS IN HASPRDR AND HASPPRPU,          * S0021500
*              BY THE LINE MANAGER PROCESSOR (SEE BELOW),             * S0022000
*              AND BY THE REMOTE CONSOLE PROCESSOR (SEE BELOW),       * S0022500
*              TO INVOKE ONE OF THE FOUR TERMINAL I/O SERVICES.       * S0023000
*                                                                     * S0023500
*    LINKAGE = R1, AND POSSIBLY R0, ARE USED AS DESCRIBED IN          * S0024000
*              THE 4 SERVICE ROUTINE PROLOGS AT RTAMIOPE,             * S0024500
*              RTAMIGET, RTAMIPUT, AND RTAMICLO.                      * S0025000
*                                                                     * S0025500
*              R14 = ADDRESS OF HALFWORD CONSTANT SHOWING WHICH       * S0026000
*              SERVICE IS DESIRED (GENERATED AUTOMATICALLY BY         * S0026500
*              THE $EXTP MACRO).  THE CONSTANT IS FOLLOWED BY         * S0027000
*              THE INSTRUCTION TO WHICH CONTROL IS TO BE RETURNED.    * S0027500
*                                                                     * S0028000
*              BASE1 = ADDRESS OF HASP CONTROL TABLE                  * S0028500
*              R13 = ADDRESS OF CALLER'S PCE                          * S0029000
*                                                                     * S0029500
*              HASPEXTP PERFORMS INITIAL ENTRY ACTIONS TO SAVE        * S0030000
*              THE CALLER'S REGISTERS AND BRANCH TO THE REQUESTED     * S0030500
*              SERVICE ROUTINE WITH THE FOLLOWING SET UP -            * S0031000
*              (NOTE VARIATIONS FOR BSC REMOTE VS. SNA REMOTE)        * S0031500
*                                                                     * S0032000
*              CALLERS'S REGISTERS LINK THRU BASE2 SAVED IN PCE       * S0032500
*              R1 = BSC LINE DCT ADDRESS                              * S0033000
*              MDCT = REMOTE DCT ADDRESS                              * S0033500
*              MBUF = TP BUFFER ADDRESS                               * S0034000
*              MICE = SNA INTERFACE CONTROL ELEMENT ADDRESS           * S0034500
*              MCODE = BSC CODE TABLE ADDRESS                         * S0035000
*              MBASE1 = RTAM SERVICE ROUTINE BASE REGISTER            * S0035500
*              MBASE2 = RTAM BSC/SNA SERVICE SUBROUTINES 1ST BASE     * S0036000
*              MBASE3 = RTAM BSC/SNA SERVICE SUBROUTINES 2ND BASE     * S0036100
*              BASE2 = HASP LINE MANAGER BASE REGISTER                * S0036500
*                                                                     * S0037000
*              EXIT RELOADS CALLER'S REGISTERS AND                    * S0037500
*              RETURNS TO ADDRESS IN LINK REGISTER                    * S0038000
*              WHICH HAS BEEN ADJUSTED TO SKIP HALFWORD CONSTANT      * S0038500
*                                                                     * S0039000
* ENTRY POINT = HASPMLLM - HASP LINE MANAGER PROCESSOR                * S0039500
*                                                                     * S0040000
*    PURPOSE = PROCESSES ALL CHANNEL ENDS FOR TP LINES,               * S0040500
*              READS SIGNON FROM REMOTES (VIA RTAM SUBROUTINES),      * S0041000
*              PERFORMS ERROR RECOVERY AND LOGGING WHEN NEEDED,       * S0041500
*              AND FOR MULTI-LEAVING TERMINALS PROVIDES LINE          * S0042000
*              SHARING FOR SEVERAL LOGICAL I/O DATA STREAMS           * S0042500
*                                                                     * S0043000
*    LINKAGE = STANDARD HASP PROCESSOR REGISTERS AND CPU TIME         * S0043500
*              ALLOCATION PROVIDED BY HASP DISPATCHER, MBASE1 AND     * S0044000
*              MBASE2 ALSO USED FOR RTAM SUBROUTINE ADDRESSABILITY    * S0044500
*                                                                     * S0045000
* ENTRY POINT = HASPMCON - HASP REMOTE CONSOLE PROCESSOR              * S0045500
*                                                                     * S0046000
*    PURPOSE = FOR MULTI-LEAVING TERMINALS WITH CONSOLES PROVIDES     * S0046500
*              IMMEDIATE INTERFACE (VIA RTAM SUBROUTINES) WITH        * S0047000
*              HASP COMMAND PROCESSOR AND HASP CONSOLE OUTPUT,        * S0047500
*              FOR ALL OTHER TERMINALS PROVIDES CONSOLE OUTPUT        * S0048000
*              SPOOLING TO BE LATER PROCESSED AS PRINTED OUTPUT       * S0048500
*                                                                     * S0049000
*    LINKAGE = STANDARD HASP PROCESSOR REGISTERS AND CPU TIME         * S0049500
*              ALLOCATION PROVIDED BY HASP DISPATCHER                 * S0050000
*                                                                     * S0050500
* INPUT = SEE ENTRY POINTS                                            * S0063000
*                                                                     * S0063500
* OUTPUT = SEE ENTRY POINTS                                           * S0064000
*                                                                     * S0064500
* EXIT-NORMAL = SEE ENTRY POINTS                                      * S0065000
*                                                                     * S0065500
* EXIT-ERROR = SEE ENTRY POINTS                                       * S0066000
*                                                                     * S0066500
* EXTERNAL REFERENCES = SEE BELOW                                     * S0067000
*                                                                     * S0067500
*    ROUTINES = $WAIT, $TTIMER, $GETBUF, $WTO, $GETSMFB, $FREEBUF,    * S0068000
*               $QUESMFB, $STIMER, $EXCP, $ERROR, $#GET, $IOERROR,    * S0068500
*               $GETUNIT, $EXTP, $FREUNIT, $FRECMB, $GETCMB, $QSUSE   * S0069000
*                                                                     * S0069500
*    DATA AREAS = SEE $HASPCB MACRO DEFINITION                        * S0070000
*                                                                     * S0070500
*    CONTROL BLOCKS = SEE $HASPCB MACRO DEFINITION                    * S0071000
*                                                                     * S0071500
* TABLES = SEE BELOW, BEGINNING AT LABEL MDISCCW                      * S0072000
*                                                                     * S0072500
* MACROS = SEE EXTERNAL REFERENCES, $CCW (DEFINED LOCALLY),           * S0073000
*          $HASPGEN, $ENTRY, $SYSPARM, NULL, $POST, $ACTIVE,          * S0073500
*          $DORMANT, $RESTORE (DEFINED LOCALLY)                       * S0074000
*                                                                     * S0074100
* CHANGE ACTIVITY                                                     * S0074200
*                                                                     * S0074300
*     RELEASE 4.0 = OZ03311,OZ04313,OZ04990,OZ05769,OZ06762,OZ07439,  * S0074500
*                   OZ08195,OZ09025,OZ09052,OZ09085                   * S0074600
*                                                                     * S0074700
*     RELEASE 4.1 = OZ10359,OZ10379,OZ10380,OZ10381,OZ10382,OZ10384,  * S0074800
*                   OZ10385,OZ11753,OZ11754,OZ11759,OZ11766,OZ11803,  * S0074900
*                   OZ11804,OZ11805,OZ11807,OZ11808,OZ11809,OZ11810,  * S0075000
*                   OZ12271,OZ12273,OZ12295,OZ12296,OZ12297,OZ13246,  * S0075100
*                   OZ14401,OZ14402,OZ14410,OZ14415,OZ14417,OZ14418,  * S0075200
*                   OZ14442,OZ14446,OZ15262,OZ15285,OZ15298,OZ15830,  * S0075300
*                   OZ15836,OZ15839,OZ15840,OZ15842,OZ15843,OZ16674,  * S0075400
*                   OZ16689,OZ18200,OZ18228,OZ18229,OZ18230,OZ18238   * S0075500
*                                                                     * S0076200
*********************************************************************** S0076500
         TITLE 'HASP CONTROL BLOCK GENERATION MACRO'                    S0077000
         SPACE 5                                                        S0077500
*                                                                       S0078000
*****    $HASPCB   *****           GENERATE HASP CONTROL BLOCKS         S0078500
*                                                                       S0079000
         SPACE 1                                                        S0079500
         MACRO                                                          S0080000
         $HASPCB &DOC=NO,&LIST=NO                                       S0080500
         GBLC  &PRINT,&GEN,&DATA                                        S0081000
         PUSH  PRINT                                                    S0081500
         PRINT &PRINT                                                   S0082000
         $ACB  DOC=&DOC            GENERATE OS ACB DSECT             R4 S0082500
         $CVT  DOC=&DOC            GENERATE OS CVT DSECT             R4 S0083000
         $DCB  DOC=&DOC            GENERATE OS DCB DSECT                S0083500
         $DEB  DOC=&DOC            GENERATE OS DEB DSECT                S0084000
         $PSA  DOC=&DOC            GENERATE OS PSA DSECT             R4 S0084500
         $RPL  DOC=&DOC            GENERATE OS RPL DSECT             R4 S0085000
         $UCB  DOC=&DOC            GENERATE OS UCB DSECT                S0085500
         $FMH  DOC=&DOC            GENERATE SNA FMH DSECT            R4 S0086500
         $BIND DOC=&DOC            GENERATE SNA BIND DSECT           R4 S0087000
         $NIB  DOC=&DOC            GENERATE VTAM NIB DSECT           R4 S0087500
         $TED  DOC=&DOC            GENERATE HASP TED DSECT              S0088000
         $SVT  DOC=&DOC            GENERATE HASP SSVT DSECT             S0090500
         $HCT  DOC=&DOC            GENERATE HASP HCT DSECT              S0091000
         $PCE  DOC=&DOC            GENERATE HASP PCE DSECT              S0091500
         $LRC  DOC=&DOC            GENERATE HASP LRC DSECT              S0092000
         $BUFFER DOC=&DOC          GENERATE HASP BUFFER DSECT           S0092500
         $ICE  DOC=&DOC            GENERATE HASP ICE DSECT           R4 S0093000
         $CPT  DOC=&DOC            GENERATE HASP CPT DSECT          R41 S0093200
         $CMB  DOC=&DOC            GENERATE HASP CMB DSECT              S0093500
         $SMF  DOC=&DOC            GENERATE HASP SMF DSECT              S0094000
         $JQE  DOC=&DOC            GENERATE HASP JQE DSECT              S0094500
         $QSE  DOC=&DOC            GENERATE HASP QSE DSECT              S0095000
         $RAT  DOC=&DOC            GENERATE HASP RAT DSECT              S0097500
         $DCT  DOC=&DOC            GENERATE HASP DCT DSECT              S0098000
         $TQE  DOC=&DOC            GENERATE HASP TQE DSECT              S0098500
         $MLMWORK DOC=&DOC         GENERATE HASP MLMWORK DSECT       R4 S0101500
         $RCPWORK DOC=&DOC         GENERATE HASP RCPWORK DSECT       R4 S0102000
         SPACE 1                                                        S0102500
         POP   PRINT                                                    S0103000
         PRINT &GEN,&DATA          SET ASSEMBLY PRINT OPTIONS           S0103500
         MEND                                                           S0104000
         TITLE 'HASP RJE CHANNEL COMMAND WORD GENERATION MACRO'         S0104500
         SPACE 5                                                        S0105000
*                                                                       S0105500
***** $CCW     *****               GENERATE RJE CCW SKELETON            S0106000
*                                                                       S0106500
*                                                                       S0107000
         MACRO                                                          S0107500
&NAME    $CCW  &OP,&AD,&FL,&LN,&CD                                      S0108000
&NAME    DC    AL1(&OP),AL3(&AD),AL1(&FL,&CD),AL2(&LN)                  S0108500
         MEND                                                           S0109000
         TITLE 'HASP RTAM REGISTER SETUP MACRO'                      R4 S0109500
         SPACE 5                                                     R4 S0110000
*                                                                    R4 S0110500
***** $RESTORE *****               RESTORE ACCESS METHOD REGISTERS   R4 S0111000
*                                                                    R4 S0111500
*                                                                    R4 S0112000
         MACRO -- $RESTORE -- RESTORE RTAM ACCESS METHOD REGISTERS   R4 S0112500
&NAME    $RESTORE &REENTER=NO                                        R4 S0113000
&NAME    L     LINK,$EXTP          GET REG SETUP CODE BASE ADDRESS   R4 S0113500
         AIF   ('&REENTER' EQ 'YES').A                               R4 S0114000
         BAL   R15,RTAMIRES-HASPEXTP(,LINK) GO SET UP RTAM REGISTERS R4 S0114500
         MEXIT                                                       R4 S0115000
.A       L     R15,PCESAVEA        GET SERVICE ROUT ENTRY ADDR       R4 S0115500
         B     RTAMIRES-HASPEXTP(,LINK)  GO SET UP RTAM REGISTERS    R4 S0116000
         MEND                                                        R4 S0116500
         TITLE 'HASP REMOTE TERMINAL ACCESS METHOD'                     S0117000
         SPACE 5                                                        S0117500
HASPRTAM START 0                   HASP REMOTE TERMINAL ACCESS METHOD   S0118000
         SPACE 5                                                        S0118500
         COPY  $HASPGEN            COPY HASPGEN PARAMETERS              S0119000
         TITLE 'HASP REMOTE TERMINAL ACCESS METHOD'                  R4 S0119500
         SPACE 5                                                     R4 S0120000
HASPRTAM $ENTRY CSECT=YES,BASE=,ENTRY=NO                             R4 S0120500
         SPACE 5                                                     R4 S0121000
*                                                                    R4 S0121500
*                             EXTERNAL REFERENCES                    R4 S0122000
*                                                                    R4 S0122500
         SPACE 3                                                     R4 S0123000
         ENTRY HASPEXTP            HASP RTAM SERVICE ROUTINES        R4 S0126000
         ENTRY MWRSPCCW            HASP RTAM BSC CCW SKELETON        R4 S0126500
         ENTRY HASPMLLM            HASP LINE MANAGER                 R4 S0127000
         ENTRY HASPMCON            HASP REMOTE CONSOLE PROCESSOR     R4 S0127500
         ENTRY HASPVTAM            HASP VTAM ACB OPEN/CLOSE SUBTASK  R4 S0128000
         SPACE 5                                                     R4 S0128500
*                                                                    R4 S0129000
*                             DOCUMENTATION OPTIONS FOR THIS ASSEMBLY   S0129500
*                                                                    R4 S0130000
         SPACE 3                                                     R4 S0130500
         $SYSPARM (OFF,GEN,NODATA,NO,NO)                             R4 S0131000
         EJECT                                                       R4 S0131500
*                                                                    R4 S0132000
*                             GENERATE HASP CONTROL BLOCKS           R4 S0132500
*                                                                    R4 S0133000
         SPACE 3                                                     R4 S0133500
        $HASPCB DOC=&DOC,LIST=&LIST  GENERATE HASP CONTROL BLOCKS    R4 S0134000
         TITLE 'HASP REMOTE TERMINAL ACCESS METHOD'                  R4 S0134500
         SPACE 5                                                        S0135000
*                                                                       S0135500
*                             COMMON REGISTER DEFINITIONS            R4 S0136000
*                                                                       S0136500
         SPACE 3                                                        S0137000
MDCT     EQU   WB                  ADDRESS OF DCT                       S0137500
MBUF     EQU   WC                  ADDRESS OF RJE BUFFER                S0138000
MCODE    EQU   WD                  ADDRESS OF CODE TABLE                S0138500
MICE     EQU   WD                  ADDRESS OF INTERFACE CTL ELEMENT  R4 S0139000
ML       EQU   WE                  INTERNAL LINK REGISTER               S0139500
MBASE1   EQU   WF                  ACCESS                           R41 S0140000
MBASE2   EQU   WG                   METHOD                          R41 S0140500
MBASE3   EQU   R10                   BASE REGSITERS                 R41 S0140600
MACB     EQU   R10                 ADDRESS OF VTAM ACB               R4 S0141000
         SPACE 5                                                        S0141500
*                                                                       S0142000
*                             BSC LINE ACTION REQUESTS               R4 S0142500
*                                                                       S0143000
         SPACE 3                                                        S0143500
MDCTIMER EQU   X'80'               TIMED ACTION REQUESTED               S0144000
MDCTPAWS EQU   X'40'               LINE PAUSE REQUESTED                 S0144500
MDCTJOB1 EQU   X'20'               JOB POST INDICATOR 1                 S0145000
MDCTJOB2 EQU   X'10'               JOB POST INDICATOR 2                 S0145500
MDCTJOB  EQU   MDCTJOB1+MDCTJOB2   JOB POST INDICATION                  S0146000
         SPACE 5                                                        S0146500
*                                                                       S0147000
*                             BSC RJE CCW SEQ TYPE DEFINITIONS       R4 S0147500
*                                                                       S0148000
         SPACE 3                                                        S0148500
MBSCSEQ  EQU   X'80'               BINARY SYNCHRONOUS SEQUENCE          S0149000
MPREPSEQ EQU   X'40'               PREPARE SEQUENCE                     S0149500
MWRITSEQ EQU   X'20'               WRITE SEQUENCE                       S0150000
MCPUSEQ  EQU   X'10'               PROGRAMMABLE INTERFACE SEQUENCE      S0150500
MSEQTYPE EQU   IOBCCW1+5           SEQUENCE TYPE BYTE                   S0151000
         EJECT                                                          S0151500
         SPACE 3                                                        S0152000
*                                                                       S0152500
*                             BSC CCW COMMAND TYPE DEFINITIONS       R4 S0153000
*                                                                       S0153500
         SPACE 3                                                        S0154000
MDISCMD  EQU   X'00'               DISABLE                              S0154500
MSETMCMD EQU   X'01'               SET MODE                             S0155000
MENBCMD  EQU   X'02'               ENABLE                               S0155500
MREADCMD EQU   X'04'               READ                                 S0156000
MRRSPCMD EQU   X'05'               READ RESPONSE (NORMAL)               S0156500
MRREQCMD EQU   X'06'               READ RESPONSE (TO ENQUIRY)           S0157000
MPREPCMD EQU   X'07'               PREPARE                              S0157500
MWRITCMD EQU   X'08'               WRITE                                S0158000
MWRSPCMD EQU   X'09'               WRITE RESPONSE                       S0158500
MWENQCMD EQU   X'0A'               SEND INQUIRY                         S0159000
         SPACE 5                                                        S0159500
*                                                                       S0160000
*                             EBCDIC BSC CONTROL CHARACTERS             S0160500
*                                                                       S0161000
         SPACE 3                                                        S0161500
MBCDSOH  EQU   X'01'               START OF HEADING                     S0162000
MBCDSTX  EQU   X'02'               START OF TEXT                        S0162500
MBCDETX  EQU   X'03'               END OF TEXT                          S0163000
MBCDHT   EQU   X'05'               HORIZONTAL TAB                       S0163500
MBCDDLE  EQU   X'10'               DATA LINK ESCAPE                     S0164000
MBCDDC1  EQU   X'11'               SELECT OUTPUT DEVICE 1               S0164500
MBCDDC2  EQU   X'12'               SELECT OUTPUT DEVICE 2               S0165000
MBCDDC3  EQU   X'13'               SELECT OUTPUT DEVICE 3               S0165500
MBCDNL   EQU   X'15'               NEW LINE                             S0166000
MBCDEM   EQU   X'19'               END OF MEDIUM                        S0166500
MBCDIGS  EQU   X'1D'               INTER-GROUP SEPARATOR                S0167000
MBCDIRS  EQU   X'1E'               INTER-RECORD SEPARATOR               S0167500
MBCDITB  EQU   X'1F'               INTERMEDIATE BLOCK CHECK             S0168000
MBCDETB  EQU   X'26'               END OF TRANSMISSION BLOCK            S0168500
MBCDESC  EQU   X'27'               ESCAPE                               S0169000
MBCDENQ  EQU   X'2D'               ENQUIRY                              S0169500
MBCDSYN  EQU   X'32'               SYNCHRONOUS IDLE                     S0170000
MBCDEOT  EQU   X'37'               END OF TRANSMISSION                  S0170500
MBCDNAK  EQU   X'3D'               NEGATIVE ACKNOWLEDGE                 S0171000
MBCDACK1 EQU   X'61'               POSITIVE ACKNOWLEDGE ODD             S0171500
MBCDACK0 EQU   X'70'               POSITIVE ACKNOWLEDGE EVEN            S0172000
         EJECT                                                       R4 S0172500
         SPACE 3                                                     R4 S0173000
*                                                                    R4 S0173500
*                             SNA CHARACTER STRING (SCS) DEFINITIONS R4 S0174000
*                                                                    R4 S0174500
         SPACE 3                                                     R4 S0175000
SCSSEL   EQU   X'04'               SELECT CHAN SKIP, SECURE STRG RDR R4 S0175500
SCSHT    EQU   X'05'               HORIZONTAL TAB                    R4 S0176000
SCSVT    EQU   X'0B'               VERTICAL TAB                      R4 S0176500
SCSFF    EQU   X'0C'               FORMS FEED                        R4 S0177000
SCSCR    EQU   X'0D'               CARRIAGE RETURN                   R4 S0177500
SCSENP   EQU   X'14'               ENABLE PRESENTATION               R4 S0178000
SCSNL    EQU   X'15'               NEW LINE                          R4 S0178500
SCSBS    EQU   X'16'               BACKSPACE                         R4 S0179000
SCSIRS   EQU   X'1E'               INTER-RECORD SEPARATOR            R4 S0179500
SCSINP   EQU   X'24'               INHIBIT PRESENTATION              R4 S0180000
SCSLF    EQU   X'25'               LINEFEED                          R4 S0180500
SCSTRN   EQU   X'35'               TRANSPARENCY                      R4 S0181000
SCSBLANK EQU   X'40'               BLANK                             R4 S0181500
         SPACE 5                                                     R4 S0182000
*                                                                    R4 S0182500
*                             SNA STRING CONTROL BYTE DEFINITIONS    R4 S0183000
*                                                                    R4 S0183500
         SPACE 1                                                     R4 S0184000
SCBNONCO EQU   B'00000000'         NONCOMPACTED, NONDUPLICATE        R4 S0184500
SCBCPACT EQU   B'01000000'         COMPACTED, NONDUPLICATE          R41 S0184700
SCBPRIME EQU   B'10000000'         DUPLICATE PRIME CHARACTERS        R4 S0185000
SCBDUPLC EQU   B'11000000'         DUPLICATE NONPRIME CHARACTERS     R4 S0185500
         SPACE 1                                                    R41 S0185600
SCB      EQU   1                   SCB ITSELF OCCUPIES 1 BYTE       R41 S0185700
SCBEMPTY EQU   0                   SCB COUNT WHEN EMPTY             R41 S0185800
SCBMAXCT EQU   63                  SCB COUNT WHEN FILLED TO MAXIMUM R41 S0185900
         EJECT                                                       R4 S0186000
         SPACE 3                                                     R4 S0186500
*                                                                    R4 S0187000
*                             SNA RJE SEQUENCE TYPE DEFINITIONS      R4 S0187500
*                                                                    R4 S0188000
         SPACE 1                                                     R4 S0188500
VSEQNORM EQU   X'00'               SESSION NORMAL I/O SEQUENCE       R4 S0189000
VSEQLOGN EQU   X'10'               SESSION INITIATION SEQUENCE       R4 S0189500
VSEQHOLD EQU   X'20'               SESSION HOLD   I/O SEQUENCE       R4 S0190000
VSEQCLOS EQU   X'30'               SESSION CLOSE DOWN SEQUENCE       R4 S0190500
VSEQTERM EQU   X'40'               SESSION ABN TERMIN SEQUENCE       R4 S0191000
VSEQRCVR EQU   X'50'               SESSION RECOVR I/O SEQUENCE       R4 S0191500
VSEQALOG EQU   X'60'               SESSION AUTO-LOGON SEQUENCE      R41 S0191600
VSEQSPEC EQU   X'F0'               SESSION SPEC  MODE SEQUENCE       R4 S0192000
         SPACE 1                                                     R4 S0192500
VSEQRECV EQU   VSEQNORM+X'00'      RECEIVE  REQUEST                  R4 S0193000
VSEQSEND EQU   VSEQNORM+X'01'      SEND     REQUEST                  R4 S0193500
VSEQRSET EQU   VSEQNORM+X'02'      RESETSR  REQUEST                  R4 S0194000
VSEQRSCS EQU   VSEQRSET+VSEQRECV   RESET CS REQUEST                  R4 S0194500
VSEQRSCA EQU   VSEQRSET+VSEQSEND   RESET CA REQUEST                  R4 S0195000
         SPACE 1                                                     R4 S0195500
VSEQLDEV EQU   X'01'               INQUIRE DEVCHAR  REQUEST         R41 S0196000
VSEQLPAR EQU   X'02'               INQUIRE SESSPARM REQUEST         R41 S0196500
VSEQLOPD EQU   X'03'               OPNDST  ACCEPT   REQUEST         R41 S0197000
         SPACE 1                                                     R4 S0197500
VSEQGIBB EQU   X'00'               NULL RU BEG/END BKT REQUEST       R4 S0198000
VSEQGIEB EQU   X'01'               NULL RU END BRACKET REQUEST       R4 S0198500
VSEQGICD EQU   X'02'               NULL RU CHG DIRECTN REQUEST       R4 S0199000
VSEQGCLS EQU   X'03'               DEFERRED CLSDST     REQUEST       R4 S0199500
         SPACE 1                                                     R4 S0200000
VSEQDLNE EQU   X'00'               DISCONNECT ICE FROM LINE  DCT     R4 S0200500
VSEQDLGN EQU   X'01'               DISCONNECT ICE FROM LOGON DCT     R4 S0201000
         SPACE 4                                                     R4 S0201500
*                                                                    R4 S0202000
*                             VTAM EXIT ROUTINE IDENT DEFINITION     R4 S0202500
*                                                                    R4 S0203000
         SPACE 2                                                     R4 S0203500
VXIDOPEN EQU   X'10'               DCT XID FOR OPEN   ACB  SUBTASK   R4 S0204000
VXIDTPND EQU   X'20'               DCT XID FOR TPEND  EXIT ROUTINE   R4 S0204500
VXIDCLOS EQU   X'30'               DCT XID FOR CLOSE  ACB  SUBTASK   R4 S0205000
         SPACE 1                                                     R4 S0205500
VXIDLOGN EQU   X'10'               ICE XID FOR LOGON  EXIT ROUTINE   R4 S0206000
VXIDALOG EQU   X'20'               ICE XID FOR AUTO-LOGON  ROUTINE  R41 S0206500
VXIDGBUF EQU   X'30'               ICE XID FOR DEFERRED GET BUFFER  R41 S0207000
VXIDRLRQ EQU   X'40'               ICE XID FOR RELREQ EXIT ROUTINE  R41 S0207500
VXIDSCIP EQU   X'50'               ICE XID FOR SCIP   EXIT ROUTINE  R41 S0208000
VXIDLOST EQU   X'60'               ICE XID FOR LSTTRM EXIT ROUTINE  R41 S0208500
VXIDISCN EQU   X'70'               ICE XID FOR DISCONNECT  ROUTINE  R41 S0208600
         TITLE 'HASP $EXTP SERVICE ENTRY ROUTINES'                   R4 S0209000
*********************************************************************** S0209500
*                                                                     * S0210000
*                    REMOTE JOB ENTRY OPEN ROUTINE                    * S0210500
*                                                                     * S0211000
*    ENTRY PARAMETER --                                               * S0211500
*              R1 = ADDRESS OF REMOTE DEVICE CONTROL TABLE.           * S0212000
*                                                                     * S0212500
*********************************************************************** S0213000
         SPACE 2                                                     R4 S0213500
RTAMIOPE DC    A(RTAMBOPE)         ADDRESS OF RTAM BSC OPEN ROUTINE  R4 S0214000
         DC    A(RTAMVOPE)         ADDRESS OF RTAM SNA OPEN ROUTINE  R4 S0214500
         SPACE 6                                                     R4 S0215000
*********************************************************************** S0215500
*                                                                     * S0216000
*                    REMOTE JOB ENTRY GET ROUTINE                     * S0216500
*                                                                     * S0217000
*    ENTRY PARAMETERS --                                              * S0217500
*              R1 = ADDRESS OF REMOTE DEVICE CONTROL TABLE.           * S0218000
*              R0 = ADDRESS OF A WORK AREA WHICH MAY BE USED TO       * S0218500
*                   RETURN ONE INPUT IMAGE TO THE CALLER.  THE        * S0219000
*                   LENGTH OF THE WORK AREA IS DEFINED IN THE         * S0219500
*                   MDCTRECL FIELD OF THE CALLER'S DCT.               * S0220000
*                                                                     * S0220500
*    EXIT RESULTS --                                                  * S0221000
*              R0 = ADDRESS OF 80-BYTE INPUT CARD RETURNED.           * S0221500
*                   R0 GT 0 AND CC=2 FOR NORMAL RETURN                * S0222000
*                   R0 LT 0 AND CC=4 FOR END OF FILE OR ABORT         * S0222500
*                   R0 EQ 0 AND CC=8 FOR ERROR RETURN RECEIVED        * S0223000
*                                                                     * S0223500
*********************************************************************** S0224000
         SPACE 2                                                     R4 S0224500
RTAMIGET DC    A(RTAMBGET)         ADDRESS OF RTAM BSC GET ROUTINE   R4 S0225000
         DC    A(RTAMVGET)         ADDRESS OF RTAM SNA GET ROUTINE   R4 S0225500
         EJECT                                                       R4 S0226000
*********************************************************************** S0226500
*                                                                     * S0227000
*                    REMOTE JOB ENTRY PUT ROUTINE                     * S0227500
*                                                                     * S0228000
*    ENTRY PARAMETERS --                                              * S0228500
*              R1 = ADDRESS OF REMOTE DEVICE CONTROL TABLE.           * S0229000
*              R0 = ADDRESS OF AN 8-BYTE CCW WHICH DESCRIBES          * S0229500
*                   CARRIAGE CONTROL (OR STACKER SELECT), ADDRESS,    * S0230000
*                   AND LENGTH FOR ONE OUTPUT LINE (OR CARD).         * S0230500
*                   NOTE -- THIS CCW MAY BE DESTROYED.                * S0231000
*                   CCW OP CODE X  'FE' PASSES PDDB/PDIR INFO (SNA)   * S0231400
*                   CCW OP CODE X'FF' FORCES WRITE TO TERMINAL.       * S0231500
*                   R0 HI-ORDER BIT ON MEANS END OF PAGE (VTAM/SNA).  * S0232000
*                                                                     * S0232500
*********************************************************************** S0233000
         SPACE 2                                                     R4 S0233500
RTAMIPUT DC    A(RTAMBPUT)         ADDRESS OF RTAM BSC PUT ROUTINE   R4 S0234000
         DC    A(RTAMVPUT)         ADDRESS OF RTAM SNA PUT ROUTINE   R4 S0234500
         SPACE 6                                                     R4 S0235000
*********************************************************************** S0235500
*                                                                     * S0236000
*                   REMOTE JOB ENTRY CLOSE ROUTINE                    * S0236500
*                                                                     * S0237000
*    ENTRY PARAMETER --                                               * S0237500
*              R1 = ADDRESS OF REMOTE DEVICE CONTROL TABLE.           * S0238000
*                                                                     * S0238500
*********************************************************************** S0239000
         SPACE 2                                                     R4 S0239500
RTAMICLO DC    A(RTAMBCLO)         ADDRESS OF RTAM BSC CLOSE ROUTINE R4 S0240000
         DC    X'80'               SNA CLOSE RUNS EVEN IF SOFT ABORT R4 S0240500
         DC    AL3(RTAMVCLO)       ADDRESS OF RTAM SNA CLOSE ROUTINE R4 S0241000
         SPACE 2                                                     R4 S0242000
RTAMINCL DC    A(RTAMBNCL)         ADDRESS OF RTAM BSC NCLOSE RTN   R41 S0242500
         DC    X'80'               SNA NCLOSE RUNS IF SOFT ABORT    R41 S0242600
         DC    AL3(RTAMVNCL)       ADDRESS OF RTAM SNA NCLOSE RTN   R41 S0243000
         EJECT                                                       R4 S0244000
*                                                                    R4 S0244500
*                             ACCESS METHOD REGISTER INITIALIZATION  R4 S0245000
*                                                                    R4 S0245500
         SPACE 3                                                     R4 S0246000
         USING DCTDSECT,R1         ESTABLISH  DCT ADDRESSABILITY     R4 S0246500
         USING HASPEXTP,LINK       ESTABLISH CODE ADDRESSABILITY     R4 S0247000
         SPACE 1                                                     R4 S0247500
HASPEXTP SH    R15,0(,LINK)        GET ADDR LIST FOR THIS $EXTP SERV R4 S0248000
         LA    LINK,2(,LINK)       ADJUST RETRN PAST $EXTP SERV CODE R4 S0248500
         STM   LINK,BASE2,PCELINK  SAVE CALLER'S REGISTERS           R4 S0249000
         L     LINK,$EXTP          GET BASE ADDRESS FOR SETUP        R4 S0249500
         TM    MDCTSTAT,DCTABORT   TEST REMOTE DCT STATUS            R4 S0250000
         BO    RTAMEXIT            BRANCH IF DCT IS ABORTING         R4 S0250500
         OI    DCTSTAT,DCTRTAM     SHOW RTAM PROCESSING ACTIVE       R4 S0251000
         TM    MDCTTYPE,DCTPSNA    TEST REMOTE DCT TYPE              R4 S0251500
         BZ    SKIP10              BRANCH IF NOT SNA REMOTE TERMINAL R4 S0252000
         LA    R15,4(,R15)         ADVANCE POINTER TO SNA ENTRY ADDR R4 S0252500
SKIP10   L     R15,0(,R15)         PICK UP RTAM ENTRY ADDR           R4 S0253000
         ST    R15,PCESAVEA        SAVE ENTRY ADDRESS IN PCESAVEA    R4 S0253500
         LR    MBASE1,R15          SET ADDR OF RTAM ROUTINE BASE     R4 S0254000
         B     RTAMBSET            BRANCH TO COMPLETE REGS SETUP     R4 S0254500
         SPACE 2                                                     R4 S0255000
*                             RESTORE REGISTERS AFTER $WAIT          R4 S0255500
         SPACE 1                                                     R4 S0256000
RTAMIRES TM    MDCTSTAT,DCTABORT   TEST REMOTE DCT STATUS            R4 S0256500
         BO    RTAMEXIT            BRANCH IF DCT IS ABORTING         R4 S0257000
         L     MBASE1,PCESAVEA     GET ADDR OF RTAM ROUTINE BASE     R4 S0257500
         SPACE 1                                                     R4 S0258000
RTAMBSET LR    MDCT,R1             GET ADDRESS OF REMOTE DCT         R4 S0258500
         L     MBUF,DCTBUFAD       GET ADDRESS OF BUFFER             R4 S0259000
         L     BASE2,=A(HASPMLLM)  GET ADDR OF LINE MANAGER BASE     R4 S0259500
         TM    MDCTTYPE,DCTPSNA    TEST REMOTE DCT TYPE              R4 S0260000
         BO    RTAMVSET            BRANCH TO SETUP FOR SNA DCT       R4 S0260500
         L     R1,DCTDCB           GET ADDRESS OF LINE DCT           R4 S0261000
         L     MCODE,MDCTCODE      GET ADDRESS OF CODE TABLE         R4 S0261500
         L     MBASE2,=A(RTAMBSUB) GET ADDRESSABILITY               R41 S0262000
         LA    MBASE3,2048(,MBASE2) OF COMMON BSC RTAM              R41 S0262100
         LA    MBASE3,2048(,MBASE3)  SUBROUTINES                    R41 S0262200
         BR    R15                 ENTER OR RETURN TO ROUTINE        R4 S0262500
         SPACE 1                                                     R4 S0263000
RTAMVSET L     MICE,MDCTICE        GET ADDRESS OF ASSOCIATED ICE     R4 S0263500
         L     MBASE2,=A(RTAMVSUB) GET ADDRESSABILITY               R41 S0264000
         LA    MBASE3,2048(,MBASE2) OF COMMON SNA RTAM              R41 S0264100
         LA    MBASE3,2048(,MBASE3)  SUBROUTINES                    R41 S0264200
         TM    MDCTSTAT,DCTFLUSH   TEST REMOTE DCT STATUS            R4 S0264500
         BZR   R15                 ENTER ROUTINE IF NO SOFT ABORT    R4 S0265000
         LTR   MBASE1,MBASE1       TEST HIGH-ORDER BIT OF ENTRY ADDR R4 S0265500
         BMR   R15                 GO IF ON, SOFT ABORT ALLOWS CLOSE R4 S0266000
         EJECT                                                       R4 S0266500
*                                                                    R4 S0267000
*                             RETURN ABNORMAL END TO CALLER          R4 S0267500
*                                                                    R4 S0268000
         SPACE 2                                                     R4 S0268500
RTAMABRT LM    WA,BASE2,PCEWA      RESTORE PCE'S REGISTERS           R4 S0269000
         SPACE 1                                                     R4 S0269500
RTAMEXIT L     LINK,PCELINK        RESTORE PCE RETURN ADDR           R4 S0270000
         NI    DCTSTAT,255-DCTRTAM SHOW RTAM PROCESSING COMPLETE     R4 S0270500
         SR    R0,R0               SET EOF CONDITION CODE            R4 S0271000
         BR    LINK                  AND RETURN TO CALLER            R4 S0271500
         SPACE 1                                                     R4 S0272000
         DROP  R1,LINK             RELEASE BASE REGISTERS            R4 S0272500
         SPACE 2                                                     R4 S0273000
         LTORG                                                       R4 S0273500
         TITLE 'HASP BSC REMOTE TERMINAL OPEN ROUTINE'               R4 S0274000
*                                  ADDRESSABILITY --                R41 S0274100
         USING DCTDSECT,MDCT             -- DCT                     R41 S0274500
         USING BUFDSECT,MBUF             -- BUFFER                  R41 S0275000
         USING MCODSECT,MCODE            -- CODE TABLE              R41 S0275500
         USING RTAMBSUB,MBASE2,MBASE3    -- COMMON BSC SUROUTINES   R41 S0276000
         USING HASPMLLM,BASE2            -- LINE MANAGER BASE       R41 S0276500
         SPACE 5                                                        S0277000
*                                                                       S0277500
*                             REMOTE TERMINAL OPEN ROUTINE              S0278000
*                                                                       S0278500
         SPACE 3                                                        S0279000
         USING RTAMBOPE,MBASE1     ESTABLISH OPEN ADDRESSABILITY     R4 S0279500
RTAMBOPE DS    0H                  ADDRESS OF RTAM BSC OPEN ROUTINE  R4 S0280000
         L     MBUF,DCTBUFAD-DCTDSECT(,R1)  GET LINE BUFFER ADDRESS  R4 S0280500
         TM    MSEQTYPE,MCPUSEQ    TEST SEQUENCE TYPE                   S0281000
         BZ    M27XOPEN            BRANCH IF NOT PROGRAMMABLE INTERFACE S0281500
         EJECT                                                          S0282000
*                                                                       S0282500
*                             BSC CPU OPEN ROUTINE                      S0283000
*                                                                       S0283500
         SPACE 3                                                        S0284000
         IC    R15,MDCTOPCT-DCTDSECT(R1)     INCREMENT                  S0284500
         LA    R15,1(R15)                     OPEN                      S0285000
         STC   R15,MDCTOPCT-DCTDSECT(R1)       COUNT                    S0285500
         SPACE 2                                                        S0286000
         CLI   DCTDEVTP,DCTRCON    TEST DEVICE TYPE                     S0286500
         BE    MBTAMXIT            EXIT IF REMOTE CONSOLE            R4 S0287000
         SPACE 2                                                        S0287500
         NI    MDCTSTAT,255-DCTERMNR  CLEAR RECEIVER TERMINATED BIT  R4 S0288000
         BAL   ML,MGETPBUF         GET AN OUTPUT BUFFER                 S0288500
         MVI   TPBUFST+5,X'90'          SET UP                          S0289000
         TM    DCTDEVTP,DCTPRPU          REQUEST FOR OUTPUT          R4 S0289500
         BO    SKIP20                     OR                         R4 S0290000
         MVI   TPBUFST+5,X'A0'             PERMISSION FOR INPUT         S0290500
SKIP20   MVC   TPBUFST+6(1),MDCTRCB     ADD RECORD CONTROL BYTE         S0291000
         XC    TPBUFST+7(2),TPBUFST+7   TERMINATE BUFFER                S0291500
         MVI   IOBCCW6+7,9              SET WRITE LENGTH                S0292000
         MVC   BUFDCT+1(3),DCTDCB+1     NOP WRITE POST                  S0292500
         BAL   ML,MBCWRITE         QUEUE BUFFER FOR OUTPUT              S0293000
        $WAIT  WORK,SAVE=NO        WAIT FOR RESPONSE                 R4 S0293500
        $RESTORE                   RESTORE ACCESS METHOD REGISTERS   R4 S0294000
         TM    MDCTSTAT,DCTERMNR   TEST FOR PERMISSION TO TRANSMIT   R4 S0294500
         BNZ   MBTAMXAB            BRANCH IF NOT               @OZ47347 S0295000
         CLI   DCTDEVTP,DCTRPR     TEST FOR REMOTE PRINTER     @OZ47347 S0295500
         BNE   MBTAMXIT            RETURN IF NOT               @OZ47347 S0295600
         OI    DCTPPSW,DCTPPSWC    FORCE FCB LOAD              @OZ47347 S0295700
         B     MBTAMXIT            RETURN                      @OZ47347 S0295800
         EJECT                                                          S0296000
*                                                                       S0296500
*                             2770/2780 OPEN ROUTINE                    S0297000
*                                                                       S0297500
         SPACE 3                                                        S0298000
M27XOPEN OI    MDCTSTAT-DCTDSECT(R1),DCTETX  SET ETX SWITCH             S0298500
         NI    MDCTATTN-DCTDSECT(R1),255-MDCTIMER-MDCTPAWS RESET PAUSE  S0299000
         CLI   DCTDEVTP,DCTRJR     TEST DEVICE TYPE                     S0299500
         BNE   MBPPOPEN            BRANCH IF NOT REMOTE READER          S0300000
         SPACE 2                                                        S0300500
         MVC   LCBACK,MBSCACK1     SET FIRST ACKNOWLEDGEMENT            S0301000
         LA    R0,IOBCCW2          INITIALIZE                           S0301500
         LA    R1,MBSCSEQ           CCW                                 S0302000
         BAL   ML,MCCWINIT           CHAIN                              S0302500
         BAL   ML,MEXCP            INITIATE READ OF FIRST BLOCK         S0303000
         B     MBTAMXIT             AND EXIT                         R4 S0303500
         SPACE 3                                                        S0304000
MBPPOPEN MVC   LCBACK,LCBRCB+1     SAVE ACKNOWLEDGEMENT                 S0304500
         N     MCODE,=F'-8'        FORCE NON-TRANSPARENCY               S0305000
         LA    R0,IOBCCW5          INITIALIZE                           S0305500
         LA    R1,MBSCSEQ+MWRITSEQ  CCW                                 S0306000
         BAL   ML,MCCWINIT           CHAIN                              S0306500
         SPACE 1                                                        S0307000
         MVI   TPBMXREC,2          SET NOMINAL MAXIMUM RECORD COUNT     S0307500
         TM    MDCTFEAT,DCTPMRF    TEST FOR MULT RECORD FEATURE         S0308000
         BZ    *+8                 BRANCH IF NOT                        S0308500
         MVI   TPBMXREC,7          YES, SET MAXIMUM RECORD COUNT TO     S0309000
         CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0309500
         BE    SKIP30              BRANCH IF 2780                    R4 S0310000
         MVI   TPBMXREC,255        RESET RECORD LIMIT IF NOT 2780       S0310500
SKIP30   TM    MDCTFMT,DCTPBLK     TEST RECORD FORMAT                   S0311000
         BO    *+8                 BRANCH IF BLOCKED                    S0311500
         MVI   TPBMXREC,1          UNBLOCKED, SET MAX RECORD COUNT TO 1 S0312000
         SPACE 1                                                        S0312500
         LA    R1,TPBUFST          GET START OF DATA AREA               S0313000
         LR    R0,R1               SAVE IN R0                           S0313500
         CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0314000
         BNL   MBN7OPN1            BRANCH IF NOT 2770                R4 S0314500
         TM    MDCTFMT,DCTPBLK     TEST RECORD FORMAT          @OZ50161 S0314600
         BZ    SKIP35              UNBLOCKED, LEAVE MXREC=1    @OZ50161 S0314700
         MVI   TPBMXREC,255        RESET RECORD LIMIT FOR 2770          S0315000
SKIP35   DS    0H                                              @OZ50161 S0315100
         MVI   TPBUFST,MBCDSTX     SET COMPONENT SELECT                 S0315500
         MVI   TPBUFST+1,MBCDDC1    FOR DEVICE 1 (PRINTER)              S0316000
         MVI   IOBCCW6+7,2         SET LENGTH OF COMPONENT SELECT       S0316500
         CLI   MDCTTYPE,DCTP3780   TEST TERMINAL TYPE                R4 S0317000
         BE    SKIP40              BRANCH IF 3780 WITHOUT 3781       R4 S0317500
         AL    R1,MB2770CD         INDICATE COMPONENT SELECT IN BUFFER  S0318000
SKIP40   BCTR  R0,0                DECREMENT FOR LATER USE              S0318500
         EJECT                                                       R4 S0319000
MBN7OPN1 ST    R1,TPBLCCAD         INITIALIZE ADDRESSES OF CARRIAGE     S0319500
         ST    R1,TPBFDATA          CONTROL AND FIRST DATA BYTE         S0320000
         CLI   DCTDEVTP,DCTRPU     TEST DEVICE TYPE                     S0320500
         BNE   MBPROPEN            BRANCH IF NOT REMOTE PUNCH           S0321000
         MVI   TPBUFST+1,MBCDDC2   SET DEVICE 2 COMPONENT SELECT        S0321500
         TM    MDCTLINE,DCTPTRSP   TEST FOR TRANSPARENCY                S0322000
         BZ    MBTAMXIT            BYPASS PUNCH SELECT IF NOT        R4 S0322500
         CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0323000
         BNL   MBN7OPN2            BRANCH IF NOT 2770                R4 S0323500
         MVI   TPBMXREC,1          PRESET RECORD COUNT TO 1    @OZ56955 S0323510
         TM    MDCTFMT,DCTPBLK     USER SPECIFY UNBLOCKED...   @OZ56955 S0323520
         BNO   MBTAMXIT            YES EXIT                    @OZ56955 S0323530
         MVI   TPBMXREC,6          PRESET RECORD LIMIT TO 6             S0324000
         TM    MDCTFEAT,DCTPABEX   IS 2770 BUFFER SIZE 512              S0324500
         BO    MBTAMXIT            EXIT IF YES                       R4 S0325000
         MVI   TPBMXREC,3          PRESET MAXIMUM RECORD COUNT TO 3     S0325500
         TM    MDCTFEAT,DCTPBEXP   IS 2770 BUFFER SIZE 256              S0326000
         BO    MBTAMXIT            EXIT IF YES                       R4 S0326500
         MVI   TPBMXREC,1          NO, SET MAXIMUM RECORD COUNT TO 1    S0327000
         B     MBTAMXIT            EXIT                              R4 S0327500
         SPACE 1                                                        S0328000
MBN7OPN2 CLI   TPBMXREC,4          TEST MAXIMUM RECORD COUNT            S0328500
         BL    *+8                 BRANCH IF LESS THAN 4                S0329000
         MVI   TPBMXREC,4          SET MAXIMUM RECORD COUNT TO 4        S0329500
         MVC   TPBUFST(3),MBPUNSEL      SET UP PUNCH SELECT             S0330000
         MVI   IOBCCW6+7,3         SET LENGTH OF PUNCH SELECT           S0330500
         MVI   TPBRECNT,4          FORCE WRITE OF PUNCH SELECT RECORD   S0331000
         B     MBTAMXIT            EXIT                              R4 S0331500
         SPACE 2                                                        S0332000
MBPROPEN TM    MDCTFEAT,DCTPTAB    TEST FOR HORIZ. FORMAT CONTROL    R4 S0332500
         BZ    MBTAMXIT            BYPASS TAB SETTING IF NOT         R4 S0333000
         MVI   TPBUFST,MBCDSTX     CONSTRUCT                            S0333500
         MVC   1(3,R1),MBHTREC      HORIZONTAL TAB                      S0334000
         MVC   4(143,R1),3(R1)       INITIALIZATION                     S0334500
         LA    R1,3(,R1)              RECORD                            S0335000
         LH    ML,$HTDIST          GET HORIZONTAL TAB SPACING        R4 S0335500
         LA    R15,143             COMPUTE                           R4 S0336000
         SLR   R14,R14              TABS                             R4 S0336500
         DR    R14,ML                PER LINE                        R4 S0337000
SKIP50   ALR   R1,ML               POINT TO NEXT TAB LOCATION        R4 S0337500
         MVI   0(R1),MBCDHT        SET HORIZONTAL TABS                  S0338000
         BCT   R15,SKIP50           EVERY '&HTDIST' COLUMNS          R4 S0338500
         MVI   TPBLCCC,X'FF'       PROHIBIT CARRIAGE CTL CONSOLIDATION  S0339000
         IC    R15,MDCTRECL        GET LENGTH OF PRINTER                S0339500
         AL    R15,TPBFDATA        UPDATE                               S0340000
         LA    R15,3(,R15)          DATA                                S0340500
         ST    R15,TPBFDATA          POINTER                            S0341000
         MVI   TPBRECNT,1          SET RECORD COUNT                     S0341500
         MVI   0(R15),MBCDNL       INSERT NL FOR 2770                   S0342000
         SLR   R15,R0              GENERATE BLOCK LENGTH                S0342500
         STH   R15,IOBCCW6+6       SET CCW COUNT                        S0343000
         B     MBTAMXIT             AND EXIT                         R4 S0343500
         TITLE 'HASP BSC REMOTE TERMINAL GET ROUTINE'                R4 S0344000
*                                                                       S0344500
*                             REMOTE TERMINAL GET ROUTINE               S0345000
*                                                                       S0345500
         SPACE 3                                                        S0346000
         USING RTAMBGET,MBASE1     ESTABLISH GET ADDRESSABILITY      R4 S0346500
RTAMBGET DS    0H                  ADDRESS OF RTAM BSC GET ROUTINE   R4 S0347000
         LR    R1,R0               MOVE SECOND PARAMETER TO R1          S0347500
         L     R15,TPBFDATA        GET ADDRESS OF NEXT LOGICAL RECORD   S0348000
         TM    MSEQTYPE,MBSCSEQ+MCPUSEQ      TEST SEQUENCE TYPE         S0348500
         BO    MBCPUGET            BRANCH IF BSC PROGRAMMABLE INTERFACE S0349000
         SPACE 3                                                     R4 S0349500
         TM    BUFECBCC,X'7F'      TEST I/O STATUS                      S0350000
         BO    M27X0GET            BRANCH IF NORMAL I/O COMPLETION   R4 S0350500
         BZ    *+12                SKIP IF I/O IS ACTIVE             R4 S0351000
         OI    MDCTSTAT,DCTEOF     INDICATE EOF DETECTED             R4 S0351500
         B     MBTAMXEX            GO TO RTAM EXCEPTION EXIT         R4 S0352000
         CLI   PCEID+1,PCEMLMID    LINE MANAGER...                  R41 S0352100
         BE    MBTAMXIT            YES, EXIT                        R41 S0352200
        $WAIT  WORK,SAVE=NO        WAIT FOR I/O TO COMPLETE          R4 S0352500
        $RESTORE REENTER=YES       SIMULATE RE-ENTRY                 R4 S0353000
         EJECT                                                          S0353500
*                                                                       S0354000
*                             BSC CPU GET ROUTINE                       S0354500
*                                                                       S0355000
         SPACE 2                                                        S0355500
MBCPUGET CLC   MDCTRCB,0(R15)      TEST RECORD CONTROL BYTE             S0356000
         BE    MBCGET1             BRANCH IF RCB MATCHES DEVICE RCB     S0356500
         SPACE 1                                                        S0357000
         LR    R1,R15              OTHERWISE, GO TO                     S0357500
         BAL   ML,MBCNEXTR          RCB ANALYSIS SUBROUTINE             S0358000
        $WAIT  WORK,SAVE=NO        WAIT FOR THE NEXT LOGICAL RECORD  R4 S0358500
        $RESTORE REENTER=YES       SIMULATE RE-ENTRY                 R4 S0359000
         SPACE 1                                                     R4 S0359500
MBCGET1  TM    2(R15),X'80'        TEST FIRST STRING CONTROL BYTE    R4 S0360000
         BZ    MBCGEOF             BR IF END OR TERMINATION OF FILE  R4 S0360500
         MVC   PCER15(1),1(R15)    RETURN SRCB TO CALLER             R4 S0361000
         SR    R0,R0               GET LENGTH                           S0361500
         IC    R0,MDCTRECL          OF INPUT AREA                       S0362000
SKIP60   LR    LINK,R0             BLANK                                S0365000
         SL    LINK,=F'2'           OUT                                 S0365500
         MVI   0(R1),C' '             INPUT                             S0366000
         EX    LINK,MBCGMOV1           AREA                          R4 S0366500
         SPACE 1                                                        S0367000
MBCGNEXT TM    2(R15),X'80'        TEST FOR END OF RECORD               S0367500
         BZ    MBCGEOR             BRANCH IF END OF RECORD              S0368000
         IC    LINK,2(R15)         PICK UP STRING CONTROL BYTE          S0368500
         TM    2(R15),X'40'        TEST FOR DUPLICATE FIELD             S0369000
         BO    MBCGNORM            BRANCH IF NOT DUPLICATE FIELD        S0369500
         N     LINK,MFCON31        ISOLATE COUNT                        S0370000
         SR    R0,LINK             DECREMENT CARD BYTE COUNTER          S0370500
         BM    MBCGERR             ERROR IF NEGATIVE                    S0371000
         TM    2(R15),X'20'        TEST FOR BLANK STRING                S0371500
         BO    MBCGDUP             BRANCH IF NON-BLANK STRING           S0372000
         AR    R1,LINK             ADVANCE TARGET ADDRESS               S0372500
         LA    R15,1(,R15)         STEP TO NEXT STRING CONTROL BYTE     S0373000
         B     MBCGNEXT            DECODE NEXT STRING                   S0373500
         SPACE 1                                                        S0374000
MBCGDUP  MVC   0(1,R1),3(R15)      SET FIRST DUPLICATE CHARACTER        S0374500
         S     LINK,=F'2'          GENERATE COUNT-2                     S0375000
         BM    MBCGET3             DONE IF NEGATIVE                     S0375500
         EX    LINK,MBCGMOV1       PROPAGATE DUPLICATE CHARACTERS    R4 S0376000
         SPACE 1                                                     R4 S0376500
MBCGET3  LA    R1,2(LINK,R1)       ADVANCE TARGET ADDRESS               S0377000
         LA    R15,2(,R15)         STEP TO NEXT STRING CONTROL BYTE     S0377500
         B     MBCGNEXT            DECODE NEXT STRING                   S0378000
         SPACE 1                                                     R4 S0378500
MBCGMOV1 MVC   1(*-*,R1),0(R1)     *** EXECUTE ONLY ***              R4 S0379000
         EJECT                                                       R4 S0379500
MBCGNORM N     LINK,MFCON63        ISOLATE COUNT                        S0380000
         BZ    MBCGERR             ERROR IF ZERO COUNT                  S0380500
         SR    R0,LINK             DECREMENT CARD BYTE COUNTER          S0381000
         BM    MBCGERR             ERROR IF NEGATIVE                    S0381500
         BCTR  LINK,0              GENERATE COUNT-1                     S0382000
         EX    LINK,MBCGMOV2       COPY NON-DUPLICATE STRING         R4 S0382500
         LA    R1,1(LINK,R1)       ADVANCE TARGET ADDRESS               S0383000
         LA    R15,2(LINK,R15)     STEP TO NEXT STRING CONTROL BYTE     S0383500
         B     MBCGNEXT            DECODE NEXT STRING                   S0384000
         SPACE 1                                                     R4 S0384500
MBCGMOV2 MVC   0(*-*,R1),3(R15)    *** EXECUTE ONLY ***              R4 S0385000
         SPACE 1                                                     R4 S0385500
MBCGEOR  STCM  R1,7,PCER15+1       RTRN ADDR LAST BYTE +1 TO CALLER  R4 S0386000
         CLI   DCTDEVTP,DCTRCON    TEST DEVICE TYPE                  R4 S0386500
         BE    MBCGEOF             BRANCH IF REMOTE CONSOLE             S0387000
         LA    R15,3(,R15)         STEP TO NEXT RECORD CONTROL BYTE     S0387500
         B     MGETEXIT            EXIT                                 S0388000
         SPACE 2                                                        S0388500
MBCGERR  OI    DCTFLAGS,DCTDELET   DELETE CURRENT JOB                   S0389000
         L     R1,DCTDCB           GET ADDRESS OF LINE DCT              S0389500
         OI    DCTFLAGS-DCTDSECT(R1),DCTRSTRT     FORCE LINE RESTART    S0390000
         LA    R15,TPBUFST+2       FORCE                                S0390500
         MVI   3(R15),0             END OF BUFFER                       S0391000
         SPACE 2                                                        S0391500
MBCGEOF  LA    R1,3(,R15)          STEP TO NEXT RECORD CONTROL BYTE     S0392000
         ST    R1,TPBFDATA         UPDATE DATA POINTER                  S0392500
         OI    MDCTSTAT,DCTEOF     INDICATE EOF DETECTED             R4 S0393000
         TM    2(R15),X'40'        TEST TYPE OF FILE ENDING          R4 S0393500
         BO    MBCGTERM            BR IF TERMINATED BY TRANSMITTER   R4 S0394000
         BAL   ML,MBCNEXTR         PROCESS THE NEXT RCB                 S0394500
         B     MBTAMXEX            GO TO RTAM EXCEPTION EXIT         R4 S0395000
         SPACE 1                                                     R4 S0395500
MBCGTERM BAL   ML,MBCNEXTR         PROCESS THE NEXT RCB              R4 S0396000
         B     MBTAMXAB            GO TO RTAM ABNORMAL EXIT          R4 S0396500
         EJECT                                                       R4 S0397000
*                                                                       S0397500
*                             2770/2780 GET ROUTINE                     S0398000
*                                                                       S0398500
         SPACE 2                                                     R4 S0399000
M27X0GET L     ML,DCTDCB           GET ADDRESS OF LINE DCT           R4 S0399500
         TM    MDCTLINE-DCTDSECT(ML),DCTPASCI  TEST CODE TYPE           S0400000
         BZ    MBHGNASC            BRANCH IF EBCDIC                     S0400500
         CL    R15,TPBLCCAD        TEST BUFFER STATUS                   S0401000
         BNE   MBHGNASC            BRANCH IF BUFFER HAS BEEN TRANSLATED S0401500
         LA    R14,TPBUFST         LOCATE START OF RJE BUFFER DATA   R4 S0402000
         LH    WA,$BFSZBSC         OBTAIN RJE BUFFER DATA LENGTH     R4 S0402500
         SPACE 1                                                     R4 S0403000
M27X0TR1 CH    WA,=H'256'          IF REMAINING LENGTH NOT GT 256,   R4 S0403500
         BNH   M27X0TR3             BR TO FINISH TRANSLATION         R4 S0404000
         TR    0(256,R14),MBGASCII   ELSE TRANSLATE 256 BYTES        R4 S0404500
         LA    R14,256(,R14)       THEN UPDATE BUFFER ADDRESS,       R4 S0405000
         SH    WA,=H'256'           REDUCE BUFFER LENGTH,            R4 S0405500
         B     M27X0TR1              AND BR TO CONTINUE TRANSLATION  R4 S0406000
         SPACE 1                                                     R4 S0406500
M27X0TR2 TR    0(*-*,R14),MBGASCII *** EXECUTE ONLY ***              R4 S0407000
         SPACE 1                                                     R4 S0407500
M27X0TR3 BCTR  WA,0                REDUCE LENGTH FOR EXECUTE         R4 S0408000
         EX    WA,M27X0TR2         TRANSLATE TO END OF BUFFER        R4 S0408500
         SPACE 1                                                     R4 S0409000
MBHGNASC CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0409500
         BNL   M2780GET            BRANCH IF NOT 2770                R4 S0410000
         CLI   TPBUFST,MBCDSTX     TEST HEADER CHARACTER                S0410500
         BE    MBHGNTRS            BRANCH IF NOT TRANSPARENT TEXT       S0411000
         CL    R15,TPBLCCAD        TEST DATA POINTER                    S0411500
         BNE   *+8                 BRANCH IF NOT AT START OF BLOCK      S0412000
         LA    R15,2(,R15)         SKIP OVER HEADER SEQUENCE            S0412500
         MVC   0(80,R1),0(R15)     MOVE RECORD TO CALLER'S AREA         S0413000
         LA    R15,80(,R15)        STEP TO START OF NEXT RECORD         S0413500
         B     MGSOTEST            EXIT                                 S0414000
         SPACE 1                                                     R4 S0414500
M2780GET CLC   MDLESTX-MCODSECT+MEBCDIC,0(R15)    TEST HEADER SEQUENCE  S0415000
         BE    MBHGTRSP            BRANCH IF TRANSPARENT TEXT           S0415500
         SPACE 1                                                     R4 S0416000
MBHGNTRS BCTR  R15,0               NO, BACK UP OVER MISSING DLE         S0416500
         CLI   1(R15),MBCDSTX      TEST HEADER CHARACTER                S0417000
         BE    *+6                 BRANCH IF NORMAL START OF TEXT       S0417500
         BCTR  R15,0               NO, BACK UP OVER MISSING STX         S0418000
         TM    $RJEOPTS,$BSVBOPT   TEST 2780 BLOCKING OPTION         R4 S0418500
         BO    SKIP70              BR IF SELECTED                    R4 S0419000
         CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0419500
         BNL   MBHGTRSP            BRANCH IF NOT 2770                R4 S0420000
SKIP70   LA    R0,5                SET TO SKIP FOUR CHARACTERS          S0420500
         CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0421000
         BNL   MBHGSRCH            SKIP IF NOT 2770                  R4 S0421500
         BCTR  R0,0                SET TO SKIP THREE CHARATCERS      R4 S0422000
         EJECT                                                       R4 S0422500
MBHGSRCH LR    ML,R1               SAVE ADDRESS OF CALLER'S AREA     R4 S0423000
         TRT   2(80,R15),M27X0TRT  SEARCH FOR TERMINATION CHARACTER  R4 S0423500
         BZ    MBHGTRSP            BRANCH IF NOT FOUND                  S0424000
         SPACE 1                                                        S0424500
         MVI   0(ML),C' '          BLANK OUT                            S0425000
         MVC   1(79,ML),0(ML)       CALLER'S AREA                       S0425500
         LR    R14,ML              SET START OF CALLER'S AREA           S0426000
         SPACE 1                                                        S0426500
MBHGNFLD LA    WA,3(,R15)          COMPUTE LENGTH                       S0427000
         LCR   WA,WA                OF NON-BLANK FIELD                  S0427500
         AR    WA,R1                 OR RECORD (-1)                     S0428000
         BM    *+8                 BRANCH IF LENGTH IS ZERO             S0428500
         EX    WA,MBHGMVC          MOVE FIELD TO CALLER'S AREA          S0429000
         CLI   0(R1),MBCDIGS       WERE COMPRESSED BLANKS FOUND         S0429500
         BNE   MBHGNREC            BRANCH IF NOT                        S0430000
         LA    R15,3(WA,R15)       STEP TO NEXT INPUT FIELD             S0430500
         LA    R14,1(WA,R14)       STEP TO START OF BLANK FIELD         S0431000
         L     WA,DCTDCB           GET ADDRESS OF LINE DCT              S0431500
         TM    MDCTLINE-DCTDSECT(WA),DCTPASCI  TEST CODE TYPE           S0432000
         IC    WA,1(,R1)           WA = COMPRESSED BLANK CNT   @OZ56512 S0432250
         BZ    MBHGASCN            BRANCH IF NOT ASCII         @OZ56512 S0432500
         TR    1(1,R1),MBPASCII    RE-TRANSLATE BLANK COUNT          R4 S0433000
         IC    WA,1(,R1)           WA = COMPRESSED BLANK COUNT       R4 S0433500
         TR    1(1,R1),MBGASCII    BLANK COUNT BACK TO EBCDIC  @OZ56512 S0433750
MBHGASCN N     WA,=F'63'           ACTUAL COUNT IS 6 LOW BITS  @OZ56512 S0434000
         AR    R14,WA              SKIP BLANKS IN CALLER'S AREA         S0434500
         LA    WA,79(,ML)          COMPUTE POTENTIAL MAXIMUM            S0435000
         SR    WA,R14               LENGTH REMAINING INPUT (-1)         S0435500
         BM    MBHGIREC            BR IF LGTH IS ZERO OR LESS           S0436000
         EX    WA,MBHGTRT          SEARCH FOR ENDING CHARACTER       R4 S0436500
         BNZ   MBHGNFLD            BRANCH IF FOUND                      S0437000
         EX    WA,MBHGMVC          MOVE LAST FIELD TO CALLER            S0437500
         SPACE 1                                                     R4 S0438000
MBHGIREC C     WA,=F'-1'           WAS BAD IGS DATA ENCOUNTERED         S0438500
         BL    *+6                 IF YES, AVOID DEBLOCK LOOP           S0439000
         SPACE 1                                                        S0439500
MBHGNREC AR    R15,WA              STEP                                 S0440000
         AR    R15,R0               TO NEXT RECORD                      S0440500
         LR    R1,ML               GET ADDRESS OF CALLER'S AREA         S0441000
         B     MGSOTEST            EXIT                                 S0441500
         SPACE 1                                                     R4 S0442000
MBHGMVC  MVC   0(*-*,R14),2(R15)   *** EXECUTE ONLY ***              R4 S0442500
MBHGTRT  TRT   2(*-*,R15),M27X0TRT *** EXECUTE ONLY ***              R4 S0443000
         SPACE 1                                                     R4 S0443500
MBHGTRSP MVC   0(80,R1),2(R15)     MOVE 80 BYTES TO CALLER'S AREA       S0444000
         LA    R15,83(,R15)        STEP TO START OF NEXT RECORD         S0444500
         EJECT                                                          S0445000
*                                                                       S0445500
*                             GET COMMON EXIT ROUTINES                  S0446000
*                                                                       S0446500
         SPACE 3                                                        S0447000
MGSOTEST CLC   MSONCODE,0(R1)      CHECK FOR SIGN-ON CARD               S0447500
         BNE   MGNXTREC            BRANCH IF NOT SIGN-ON                S0448000
         SPACE 1                                               @OZ32567 S0448100
         CLI   PCEID+1,PCEMLMID    IF LINE MANAGER,            @OZ32567 S0448200
         BE    MGSOTST1              BR TO PROCESS SIGNON      @OZ32567 S0448300
         SPACE 1                                                     R4 S0448500
MGQSUSE $QSUSE TYPE=TEST           MAY QUEUES BE USED...             R4 S0449000
         BZ    MGSOTST1            BR IF YES                         R4 S0449500
         LM    LINK,BASE2,PCELINK  RELOAD CALLER'S REGISTERS         R4 S0450000
         BAL   R15,$QSUSE          BR TO $QSUSE RTN (SAVE=NO ENTRY)  R4 S0450500
        $RESTORE                   RESTORE ACCESS METHOD REGISTERS   R4 S0451000
         LR    R1,R0               RELOAD SIGN-ON CARD ADDRESS          S0451500
         B     MGQSUSE             BR TO RETEST QUEUES               R4 S0452000
         SPACE 1                                                     R4 S0452500
MGSOTST1 BAL   ML,MSIGNON          PROCESS SIGN-ON                   R4 S0453000
         B     MGNXTBLK            READ NEXT DATA BLOCK                 S0453500
         SPACE 3                                                        S0454000
MGNXTREC CL    R15,BUFEWF          TEST FOR END OF DATA                 S0454500
         BL    MGETEXIT            BRANCH IF NOT TO NORMAL EXIT         S0455000
MGNXTBLK BAL   ML,MEXCP            INITIATE READ OF NEXT BLOCK          S0455500
         SPACE 3                                                        S0456000
MGETEXIT ST    R15,TPBFDATA        UPDATE DATA POINTER                  S0456500
         L     R1,PCER0            GET ADDRESS OF DATA CARD             S0457000
         CLC   MSOFCODE,0(R1)      CHECK FOR SIGN-OFF CARD              S0457500
         BNE   MBTAMXIT            EXIT IF NOT SIGN-OFF              R4 S0458000
         L     R1,PCER1            GET ADDRESS OF REMOTE DCT         R4 S0458500
         L     R0,PCER0            RELOAD CALLERS BUFFER ADDR       R41 S0458600
         L     R15,DCTDCB-DCTDSECT(R1)  GET ADDRESS OF LINE DCT         S0459000
         OI    MDCTSTAT-DCTDSECT(R15),DCTSOFF   SET SIGN-OFF FLAG       S0459500
        $RESTORE REENTER=YES       SIMULATE RE-ENTRY                 R4 S0460000
         TITLE 'HASP BSC REMOTE TERMINAL PUT ROUTINE'                R4 S0460500
*                                                                       S0461000
*                             REMOTE TERMINAL PUT ROUTINE               S0461500
*                                                                       S0462000
         SPACE 3                                                        S0462500
         USING RTAMBPUT,MBASE1     ESTABLISH PUT ADDRESSABILITY      R4 S0463000
RTAMBPUT DS    0H                  ADDRESS OF RTAM BSC PUT ROUTINE   R4 S0463500
         LR    R1,R0               MOVE SECOND PARAMETER TO R1          S0464000
         CLI   0(R1),X'03'         TEST CHANNEL COMMAND TYPE            S0464500
         BE    MBTAMXIT            RETURN IF NOP                     R4 S0465000
         CLI   0(R1),X'FF'         TEST CHANNEL COMMAND TYPE            S0465500
         BE    MPTRUNC             BRANCH IF BUFFER TRUNCATE            S0466000
         SPACE 1                                                        S0466500
         LTR   MBUF,MBUF           TEST BUFFER ADDRESS                  S0467000
         BNZ   MPUTBUF             BRANCH IF NOT ZERO                   S0467500
         BAL   ML,MGETPBUF         GET AN OUTPUT BUFFER                 S0468000
         MVI   IOBCCW6+7,6         INITIALIZE DATA LENGTH               S0468500
MPUTRTRY L     R1,PCER0            BRING BACK CCW ADDRESS            R4 S0469000
         SPACE 2                                                        S0469500
MPUTBUF  SLR   R0,R0               SET R0 TO                         R4 S0470000
         IC    R0,MDCTRECL          REMOTE DEVICE WIDTH                 S0470500
SKIP80   CLI   DCTDEVTP,DCTRPU     TEST DEVICE TYPE                     S0473500
         BE    MPUNCH              BRANCH IF REMOTE PUNCH               S0474000
         SPACE 1                                                        S0474500
         TM    0(R1),X'02'         TEST CURRENT COMMAND TYPE            S0475000
         BZ    MPNIMED             BRANCH IF NOT IMMEDIATE COMMAND      S0475500
         TM    0(R1),X'80'         TEST CURRENT COMMAND TYPE            S0476000
         BO    MPSKIP              BRANCH IF IMMEDIATE SKIP             S0476500
         CLI   TPBLCCC,X'01'       TEST PREVIOUS COMMAND TYPE           S0477000
         BE    MPSETCC             BRANCH IF WRITE/NO SPACE             S0477500
         B     MPDUMMY             NO, GENERATE DUMMY LINE              S0478000
         SPACE 1                                                        S0478500
MPSKIP   OI    TPBLCCC,X'02'       FORCE PREVIOUS COMMAND IMMEDIATE     S0479000
         CLC   TPBLCCC,0(R1)       COMPARE PREVIOUS COMMAND TO CURRENT  S0479500
         BE    MBTAMXIT            RETURN IF REDUNDANT SKIP          R4 S0480000
         TM    TPBLCCC,X'80'       TEST PREVIOUS COMMAND TYPE           S0480500
         BO    MPDUMMY             GENERATE DUMMY LINE IF SKIP          S0481000
         CLI   TPBLCCC,X'63'       PREVIOUS CMD = FCB LOAD...  @OZ46011 S0481100
         BE    MPDUMMY             YES,MAKE SKIP SEPERATE CMD  @OZ46011 S0481200
         CLI   TPBRECNT,0          TEST RECORD COUNT                    S0481500
         BNE   MPSETCC             BRANCH IF BUFFER IS NOT EMPTY        S0482000
         B     MPDUMMY             GENERATE DUMMY LINE                  S0482500
         EJECT                                                       R4 S0483000
MPUNCH   MVI   0(R1),X'79'         SET PUNCH CHANNEL COMMAND            S0483500
         SPACE 1                                                        S0484000
MPNIMED  LM    R1,WA,0(R1)         PICK UP CCW IN REGISTERS R1 & WA     S0484500
         LA    R1,0(,R1)           CLEAR                                S0485000
         LA    WA,0(,WA)            HIGH-ORDER BYTES                    S0485500
         CLR   R0,WA               COMPARE LENGTH WITH MAXIMUM          S0486000
         BNH   *+10                BRANCH IF LENGTH GREATER THAN MAX    S0486500
         LTR   R0,WA               R0 = ACTUAL LENGTH                   S0487000
         BZ    MPDUMMY             GENERATE DUMMY LINE IF ZERO LENGTH   S0487500
         SPACE 1                                                        S0488000
         LR    WA,R1               GENERATE ADDRESS                     S0488500
         AR    WA,R0                OF LAST BYTE                        S0489000
         BCTR  WA,0                SCAN BACKWARDS                       S0489500
         CLI   0(WA),C' '           ELIMINATING                         S0490000
         BNE   MPUT                  TRAILING                           S0490500
         BCT   R0,*-10                BLANKS                            S0491000
         SPACE 2                                                        S0491500
MPDUMMY  LA    R0,1                GENERATE ONE-BYTE                    S0492000
         LA    R1,=C' '             BLANK LINE                          S0492500
         SPACE 2                                                        S0493000
MPUT     DS    0H                                                    R4 S0493500
         TM    MSEQTYPE,MBSCSEQ+MCPUSEQ TEST SEQUENCE TYPE              S0494000
         BO    MBCPUPUT            BRANCH IF BSC PROGRAMMABLE INTERFACE S0494500
         SPACE 2                                                        S0495000
         CLC   TPBRECNT,TPBMXREC   TEST BUFFER RECORD COUNT          R4 S0495500
         BNL   MPFLUSH             BRANCH IF LIMIT HAS BEEN REACHED     S0496000
         B     M27X0PUT            BRANCH TO 2770/2780 PUT              S0496500
         EJECT                                                          S0497000
*                                                                       S0497500
*                             BSC CPU PUT ROUTINE                       S0498000
*                                                                       S0498500
         SPACE 3                                                        S0499000
MBCPUPUT L     R15,$MWORK          GET ADDRESS OF WORK AREA          R4 S0499500
         TM    MDCTLINE,DCTPTRSP   TEST FOR TRANSPARENCY                S0500000
         BO    MBCPCOMP            BYPASS TRANSLATE IF YES              S0500500
         TM    $PRTOPTS,$PRTRANS   TEST PRINT TRANSLATE OPTION       R4 S0501000
         BZ    SKIP90              BR IF NOT SELECTED                R4 S0501500
         SPACE 1                                                        S0502000
         CLI   DCTDEVTP,DCTRPR     TEST DEVICE TYPE                     S0502500
         BE    MBCPCOMP            BRANCH IF REMOTE PRINTER             S0503000
         SPACE 1                                                        S0503500
SKIP90   LR    WA,R0               GET LENGTH OF LINE/CARD              S0504000
         BCTR  WA,0                DECREMENT                            S0504500
         EX    WA,MBPUTRAN         TRAN ILLEGAL CHARS TO 40'S  @OZ56074 S0505000
         SPACE 2                                                        S0505500
MBCPCOMP LA    WA,63               GET MAXIMUM NORMAL STRING LENGTH     S0506000
         CLR   WA,R0               COMPARE WITH REMAINING LENGTH        S0506500
         BNH   *+6                 BRANCH IF MAXIMUM LENGTH IS LESS     S0507000
         LR    WA,R0               NO, USE REMAINING LENGTH AS MAXIMUM  S0507500
         LR    R14,R1              GET ADDRESS OF FIRST DATA BYTE       S0508000
         SPACE 2                                                        S0508500
MBCPLOOK CLC   1(1,R14),0(R14)     TEST NEXT TWO CHARACTERS             S0509000
         BNE   MBCPINCR            BRANCH IF NOT START OF DUP STRING    S0509500
         SPACE 1                                                        S0510000
         CLI   0(R14),C' '         TEST STRING TYPE                     S0510500
         BNE   *+12                BRANCH IF NOT START OF BLANK STRING  S0511000
         CL    R0,=F'1'            CHECK NUMBER                         S0511500
         B     MBCPENDT             OF CHARACTERS REMAINING             S0512000
         SPACE 1                                                        S0512500
         CLC   2(1,R14),0(R14)     TEST NEXT CHARACTER                  S0513000
         BNE   MBCPINCR            BRANCH IF NOT START OF DUP STRING    S0513500
         CL    R0,=F'2'            CHECK NUMBER OF CHARACTERS REMAINING S0514000
MBCPENDT BH    MBCPNEND            BRANCH IF ENOUGH CHARS FOR DUP FIELD S0514500
         SPACE 1                                                        S0515000
MBCPINCR LA    R14,1(,R14)         ADVANCE TO NEXT CHARACTER            S0515500
         BCTR  R0,0                DECREMENT REMAINING LENGTH           S0516000
         BCT   WA,MBCPLOOK         DECREMENT MAXIMUM LENGTH             S0516500
         SPACE 1                                                        S0517000
MBCPNEND SR    R14,R1              GENERATE NORMAL STRING LENGTH        S0517500
         BZ    MBCPDUP             BRANCH IF DUPLICATE STRING           S0518000
         STC   R14,0(R15)          SET LENGTH IN SCB                    S0518500
         OI    0(R15),X'C0'        INDICATE NORMAL STRING               S0519000
         EX    R14,MBCPMOV         MOVE CHARACTER STRING (+1)        R4 S0519500
         LA    R15,1(R14,R15)      ADVANCE OUTPUT STRING POINTER        S0520000
         B     MBCPDONE            ADVANCE INPUT STRING POINTER         S0520500
         SPACE 1                                                     R4 S0521000
MBCPMOV  MVC   1(*-*,R15),0(R1)    *** EXECUTE ONLY ***              R4 S0521500
         EJECT                                                       R4 S0522000
MBCPDUP  LA    WA,31               GET MAXIMUM DUPLICATE STRING LENGTH  S0522500
         CLR   WA,R0               COMPARE WITH REMAINING LENGTH        S0523000
         BNH   *+6                 BRANCH IF MAXIMUM LENGTH IS LESS     S0523500
         LR    WA,R0               NO, USE REMAINING LENGTH AS MAXIMUM  S0524000
         LA    R14,2(,R1)          ADVANCE TWO CHARACTERS               S0524500
         BCT   WA,MBCPSCAN         SCAN FOR END OF DUPLICATE FIELD      S0525000
         SPACE 1                                                        S0525500
MBCPCLI  CLC   0(1,R14),0(R1)      TEST NEXT CHARACTER               R4 S0526000
         BNE   *+12                BRANCH IF END OF DUPLICATE FIELD     S0526500
         LA    R14,1(,R14)         NO, ADVANCE TO NEXT CHARACTER        S0527000
MBCPSCAN BCT   WA,MBCPCLI          DECREMENT MAXIMUM LENGTH             S0527500
         SPACE 1                                                        S0528000
         SR    R14,R1              GENERATE DUPLICATE STRING LENGTH     S0528500
         STC   R14,0(R15)          SET LENGTH IN SCB                    S0529000
         OI    0(R15),X'80'        TURN ON HIGH-ORDER BIT               S0529500
         SR    R0,R14              GENERATE REMAINING LENGTH            S0530000
         CLI   0(R1),C' '          TEST STRING TYPE                     S0530500
         BNE   *+12                BRANCH IF NOT BLANK STRING           S0531000
         LA    R15,1(,R15)         ADVANCE OVER SCB                     S0531500
         B     MBCPDONE            ADVANCE INPUT STRING POINTER         S0532000
         SPACE 2                                                        S0532500
         OI    0(R15),X'20'        INDICATE DUPLICATE STRING            S0533000
         MVC   1(1,R15),0(R1)      SET BYTE TO BE DUPLICATED            S0533500
         LA    R15,2(,R15)         ADVANCE OUTPUT STRING POINTER        S0534000
         SPACE 2                                                        S0534500
MBCPDONE ALR   R1,R14              ADVANCE INPUT STRING POINTER         S0535000
         LTR   R0,R0               TEST REMAINING CHARACTER COUNT       S0535500
         BP    MBCPCOMP            BRANCH IF NOT DONE TO COMPRESS       S0536000
         SPACE 1                                                        S0536500
         MVI   0(R15),0            INSERT END OF RECORD SCB             S0537000
         LA    R15,1(,R15)          AND ADVANCE POINTER                 S0537500
         B     MCPFILL             ADD COMPRESSED RECORD TO BUFFER      S0538000
         EJECT                                                          S0538500
*                                                                       S0539000
*                             2770/2780 PUT ROUTINE                     S0539500
*                                                                       S0540000
         SPACE 3                                                        S0540500
M27X0PUT L     R15,TPBFDATA        GET ADDRESS OF NEXT DATA BYTE        S0541000
         SPACE 1                                                        S0541500
         CLI   DCTDEVTP,DCTRPU     TEST DEVICE TYPE                     S0542000
         BNE   MBHPRINT            BRANCH IF NOT REMOTE PUNCH           S0542500
         SPACE 2                                                        S0543000
         TM    MDCTLINE,DCTPTRSP   TEST FOR TRANSPARENCY                S0543500
         BO    MBHPUNCH            BRANCH IF TRANSPARENCY               S0544000
         SPACE 1                                                        S0544500
         LR    WA,R0               GET LENGTH OF CARD                   S0545000
         BCTR  WA,0                DECREMENT                            S0545500
         EX    WA,MBPUTRAN         TRAN ILLEGAL CHARS TO 40'S  @OZ56074 S0546000
         B     MBHPRNHT            PROCESS AS PRINT                     S0546500
         EJECT                                                          S0547000
*                                                                       S0547500
*                             2770/2780 PUNCH ROUTINE                   S0548000
*                                                                       S0548500
         SPACE 3                                                        S0549000
MBHPUNCH CLI   TPBRECNT,0          TEST BUFFER STATUS                   S0549500
         BNE   MBHPUNXT            BRANCH IF BUFFER IS NOT EMPTY        S0550000
         LA    R15,TPBUFST+36      INITIALIZE DATA POINTER              S0550500
         CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0551000
         BNL   SKIP100             BRANCH IF NOT 2770                R4 S0551500
         LA    R15,TPBUFST+12      INITIALIZE 2770 DATA POINTER         S0552000
SKIP100  CLI   IOBCCW6,X'08'       TEST FOR FIRST ENTRY                 S0552500
         BE    MBHPUNEW            BRANCH IF NOT FIRST ENTRY            S0553000
         SPACE 1                                                        S0553500
         LA    R0,IOBCCW5          INITIALIZE                           S0554000
         LA    R1,MBSCSEQ+MWRITSEQ  CCW                                 S0554500
         BAL   ML,MCCWINIT           CHAIN                              S0555000
         MVI   IOBCCW6,X'08'       CHANGE WRITE TO TIC                  S0555500
         B     MPUTRTRY            REENTER PUT PROCESSING            R4 S0556000
         SPACE 2                                                        S0556500
MBHPUNXT CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0557000
         BNL   MBHPUNEW            BRANCH IF NOT 2770                R4 S0557500
         SL    R15,=F'6'           BACK UP DATA POINTER                 S0558000
         L     WA,TPBUFST+4        INCREMENT                            S0558500
         LA    WA,80(,WA)           CCW                                 S0559000
         STH   WA,TPBUFST+6          BYTE COUNT                         S0559500
         B     MBHPUMOV            MOVE CARD INTO BUFFER                S0560000
         EJECT                                                       R4 S0560500
MBHPUNEW MVC   0(6,R15),MBHPUNCC   SET UP PUNCH CONTROL CHARACTERS      S0561000
MBHPUMOV MVI   7(R15),C' '         BLANK OUT                            S0561500
         MVC   8(78,R15),7(R15)     COLUMNS 2-80                        S0562000
         BCTR  R0,0                GENERATE LENGTH-1                    S0562500
         LR    WA,R0               MOVE CARD                         R4 S0563000
         EX    WA,MBHPMOV1          INTO BUFFER                      R4 S0563500
         SPACE 1                                                        S0564000
         CLI   TPBRECNT,0          TEST BUFFER STATUS                   S0564500
         BE    MBHPU1ST            BRANCH IF FIRST CARD IN BUFFER       S0565000
         LA    R0,86               GET NORMAL LENGTH                    S0565500
         CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0566000
         BL    MBHPUPDT            BRANCH IF 2770                    R4 S0566500
         B     *+12                MUST BE 2780                         S0567000
         SPACE 1                                                        S0567500
MBHPU1ST LA    R0,82               GET LENGTH OF FIRST CARD             S0568000
         LA    R15,4(,R15)         GET START OF FIRST CARD              S0568500
         SPACE 1                                                        S0569000
         L     WA,TPBLCCAD         GET ADDRESS OF CCW                   S0569500
         ST    R15,0(WA)           SET UP CCW DATA ADDRESS,             S0570000
         MVI   0(WA),X'01'          CHANNEL COMMAND,                    S0570500
         MVC   4(2,WA),IOBCCW6+4     FLAG BITS, CCW TYPE,               S0571000
         STH   R0,6(WA)               AND DATA LENGTH                   S0571500
         LA    WA,8(,WA)           STEP TO NEXT CCW                     S0572000
         LA    R1,IOBCCW7          GET ADDRESS OF WRITE ETB CCW         S0572500
         ST    R1,0(WA)            SET UP                               S0573000
         MVI   0(WA),X'08'          TIC TO WRITE ETB                    S0573500
         ST    WA,TPBLCCAD         SAVE ADDRESS OF CCW                  S0574000
         SPACE 1                                                        S0574500
MBHPUPDT ALR   R15,R0              ADVANCE TO START OF NEXT RECORD      S0575000
         IC    R1,TPBRECNT         GET RECORD COUNT                     S0575500
         ST    R15,TPBFDATA        UPDATE DATA ADDRESS                  S0576000
         LA    R1,1(,R1)           UPDATE                               S0576500
         STC   R1,TPBRECNT          RECORD COUNT                        S0577000
         B     MBTAMXIT            EXIT                              R4 S0577500
         SPACE 1                                                     R4 S0578000
MBHPMOV1 MVC   6(*-*,R15),0(R1)    *** EXECUTE ONLY ***              R4 S0578500
         EJECT                                                       R4 S0579000
*                                                                       S0579500
*                             2770/2780 PRINT ROUTINE                   S0580000
*                                                                       S0580500
         SPACE 3                                                        S0581000
MBHPRINT TM    $PRTOPTS,$PRTRANS   TEST PRINT TRANSLATE OPTION       R4 S0581500
         BO    SKIP110             BR IF SELECTED                    R4 S0582000
         LR    WA,R0               GET LENGTH OF LINE                   S0582500
         BCTR  WA,0                DECREMENT                            S0583000
         EX    WA,MBPUTRAN         TRAN ILLEGAL CHARS TO 40'S  @OZ56074 S0583500
         SPACE 1                                                        S0584000
SKIP110  TM    MDCTFEAT,DCTPTAB    TEST FOR HORIZ FORMAT CONTROL        S0584500
         BZ    MBHPRNHT            BYPASS COMPRESSION IF NOT            S0585000
         SPACE 2                                                        S0585500
         L     R14,$MWORK          POINT TO WORK AREA                R4 S0586000
         LR    ML,R0               MOVE PRINT LINE                   R4 S0586500
         BCTR  ML,0                FOR LINE LENGTH             @OZ19490 S0586800
         EX    ML,MBHCINIT          TO WORK AREA                     R4 S0587000
         LR    R1,R0               R1 = ORIGINAL LENGTH                 S0587500
         BCTR  R14,0               PREPARE TO SCAN                   R4 S0588000
         SPACE 1                                                        S0588500
MBHPRTGP SH    R0,$HTDIST          DECREMENT CHARACTER COUNT         R4 S0589000
         BNP   MBHPRDHT            DONE IF NO CHARACTERS LEFT           S0589500
         LH    WA,$HTDIST          PREPARE TO                        R4 S0590000
         ALR   R14,WA               SCAN NEXT TAB GROUP              R4 S0590500
         SPACE 1                                                        S0591000
MBHPRTBL CLI   0(R14),C' '         TEST NEXT CHARACTER                  S0591500
         BNE   MBHPRNBL            DONE IF NOT BLANK                    S0592000
         BCTR  R14,0               STEP TO                              S0592500
         BCT   WA,MBHPRTBL          NEXT CHARACTER                      S0593000
         SPACE 1                                                        S0593500
MBHPRNBL SH    WA,$HTDIST          GENERATE NUMBER OF BLANKS (MINUS) R4 S0594000
         BNM   MBHPRTGP            BR IF NO BLANKS TO COMPRESS       R4 S0594500
         LA    R14,1(,R14)         CORRECT CHARACTER POINTER            S0595000
         BE    MBHPRTGP            BRANCH IF ONLY ONE BLANK             S0595500
         SPACE 1                                                        S0596000
         LA    R1,1(WA,R1)         COMPUTE LENGTH OF COMPRESSED LINE    S0596500
         MVI   0(R14),MBCDHT       INSERT                               S0597000
         LCR   WA,WA                TAB                                 S0597500
         AR    WA,R14                CHARACTER                          S0598000
         LR    ML,R0               COMPRESS                          R4 S0598500
         EX    ML,MBHPMOV2          BLANKS                           R4 S0599000
         B     MBHPRTGP            SCAN NEXT TAB GROUP                  S0599500
         SPACE 1                                                     R4 S0600000
MBHPMOV2 MVC   1(*-*,R14),0(WA)    *** EXECUTE ONLY ***              R4 S0600500
         SPACE 1                                                        S0601000
MBHPRDHT LR    R0,R1               R0 = COMPRESSED LINE LENGTH          S0601500
         L     R1,$MWORK           R1 = ADDRESS OF COMPRESSED LINE   R4 S0602000
         B     MBHPRNC             GO TO PUT REC IN BUFFER              S0602500
         EJECT                                                       R4 S0603000
MBHPRNHT DS    0H                                                    R4 S0603500
         TM    MDCTFEAT,DCTPPRES   TEST FOR COMPRESS FEATURE            S0604000
         BZ    MBHPRNC             BRANCH IF NOT                        S0604500
         C     R0,=F'2'            IS LINE LONGER THAN TWO              S0605000
         BNH   MBHPRNC             BRANCH IF NOT                        S0605500
         L     R14,$MWORK          POINT TO WORK AREA                R4 S0606000
         LR    ML,R0               ML = LINE LENGTH                     S0606500
         BCTR  ML,0                ADJUST LENGTH FOR MOVE      @OZ19490 S0606800
         EX    ML,MBHCINIT         MOVE LINE TO WORK AREA               S0607000
         LR    ML,0                RESTORE LENGTH FOR COMPRES  @OZ19490 S0607200
         LR    R1,R14              R1 = ADDR OF COMPRESSED LINE      R4 S0607500
         LR    WA,R1               WA = ADDR OF UNCOMPRESSED LINE       S0608000
         SPACE 1                                                        S0608500
MBHCLOOK CLI   0(WA),C' '          LOOK FOR START OF BLANK FIELD        S0609000
         BNE   MBHCINCR            BRANCH IF NOT                        S0609500
         LA    R0,63               R0 = MAX BLANK FIELD LENGTH          S0610000
         LR    R14,WA              R14 = ADDR OF FIRST BLANK            S0610500
         B     *+12                GO TO SCAN FOR MORE BLANKS           S0611000
         SPACE 1                                                        S0611500
MBHCSCNB CLI   0(WA),C' '          DOES BLANK FIELD CONTINUE            S0612000
         BNE   MBHCENDB            BRANCH IF NOT                        S0612500
         LA    WA,1(,WA)           INCREMENT SCAN ADDR                  S0613000
         BCT   ML,*+10             BRANCH IF LINE NOT EXHAUSTED         S0613500
         LR    R0,R14              R0 = ADDR OF LINE END +1             S0614000
         B     MBHCLREC            GO COMPUTE COMPRESSED LENGTH         S0614500
         BCT   R0,MBHCSCNB         LOOP IF MAX FIELD NOT EXCEEDED       S0615000
         SPACE 1                                                        S0615500
MBHCENDB LR    R0,WA               R0 = ADDR OF FIELD END +1            S0616000
         SR    R0,R14              R0 = BLANK FIELD LENGTH              S0616500
         C     R0,=F'2'            IS FIELD LONGER THAN TWO             S0617000
         BNH   MBHCINCR            BRANCH IF NOT                        S0617500
         MVI   0(R14),MBCDIGS      USE IGS TO START FIELD               S0618000
         STC   R0,1(,R14)          FOLLOW WITH FIELD LENGTH             S0618500
         OI    1(R14),X'40'        LENGTH MUST BE X'42' - X'7F'         S0619000
         EX    ML,MBHCPRES         COMPRESS REMAINDER OF LINE           S0619500
         TM    MDCTLINE,DCTPASCI   TEST CODE TYPE                       S0620000
         BZ    *+10                BRANCH IF NOT ASCII                  S0620500
         TR    1(1,R14),MBGASCII   PRE-TRANSLATE BLANK COUNT         R4 S0621000
         LA    WA,2(,R14)          WA = ADDR OF LINE REMAINDER       R4 S0621500
         B     MBHCLOOK            GO LOOK FOR NEXT BLANK FIELD         S0622000
         SPACE 1                                                        S0622500
MBHCINIT MVC   0(*-*,R14),0(R1)    *** EXECUTE ONLY ***              R4 S0623000
MBHCPRES MVC   2(*-*,R14),0(WA)    *** EXECUTE ONLY ***              R4 S0623500
         EJECT                                                       R4 S0624000
MBHCINCR LA    WA,1(,WA)           INCREMENT SCAN ADDR                  S0624500
         BCT   ML,MBHCLOOK         LOOP IF LINE NOT EXHAUSTED           S0625000
         SPACE 1                                                        S0625500
         LR    R0,WA               R0 = ADDR OF LINE END +1             S0626000
MBHCLREC SR    R0,R1               R0 = COMPRESSED LINE LENGTH          S0626500
MBHPRNC  CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0627000
         BNL   MB2780PP            BRANCH IF NOT 2770                R4 S0627500
         LA    WA,1                SET UP 2770 INITIAL BYTE COUNT       S0628000
         LA    ML,511              SET FOR 512 MAXIMUM BLOCK            S0628500
         TM    MDCTFEAT,DCTPABEX   IS 2770 BUFFER SIZE 512              S0629000
         BO    MBHPNBAS            BRANCH IF YES                        S0629500
         LA    ML,255              SET FOR 256 MAXIMUM BLOCK            S0630000
         TM    MDCTFEAT,DCTPBEXP   IS 2770 BUFFER SIZE 256              S0630500
         BO    MBHPNBAS            BRANCH IF YES                        S0631000
         LA    ML,127              NO, RESET MAXIMUM BLOCK LENGTH       S0631500
         SPACE 1                                                     R4 S0632000
MBHPNBAS LR    R14,WA              PRESET 2770 PUNCH DISPLACEMENT    R4 S0632500
         CLI   DCTDEVTP,DCTRPU     TEST DEVICE TYPE                     S0633000
         BE    MB2770PU            BRANCH IF REMOTE PUNCH               S0633500
         B     MB2770PR            MUST BE REMOTE PRINTER            R4 S0634000
         SPACE 1                                                        S0634500
MB2780PP MVI   0(R15),MBCDITB      INSERT ITB AFTER PREVIOUS RECORD     S0635000
         SR    WA,WA               SET UP 2780 INITIAL BYTE COUNT       S0635500
         SR    ML,ML               SET UP 2780 MAXIMUM BLOCK            S0636000
         IC    ML,TPBRECNT          LENGTH AS 400 MINUS SPACE           S0636500
         LCR   ML,ML                 FOR ETB AND LRC'S FOR THIS         S0637000
         LA    ML,398(,ML)            RECORD AND PREVIOUS RECORDS       S0637500
         SPACE 1                                                        S0638000
MB2770PR LA    R14,3               PRESET 2780/2770-PRINT DISPLACEMENT  S0638500
         SPACE 1                                                        S0639000
MB2770PU ST    R14,$CSAVREG        SAVE DATA DISPLACEMENT            R4 S0639500
         CLI   TPBRECNT,0          TEST BUFFER STATUS                   S0640000
         BNE   MBHPRNXT            BRANCH IF NOT FIRST RECORD           S0640500
         MVI   0(R15),MBCDSTX      START FIRST RECORD WITH STX          S0641000
         STH   WA,IOBCCW6+6        RESET BYTE COUNT                     S0641500
         SPACE 1                                                        S0642000
MBHPRNXT LR    WA,R0               WA = RECORD LENGTH                   S0642500
         TM    MDCTFMT,DCTPVAR     TEST RECORD FORMAT                   S0643000
         BO    MBHPRVAR            BRANCH IF VARIABLE LENGTH RECORDS    S0643500
         CLI   DCTDEVTP,DCTRPU     TEST DEVICE TYPE                     S0644000
         BNE   *+12                BRANCH IF NOT PUNCH                  S0644500
         LA    WA,80               NO, USE PUNCH WIDTH                  S0645000
         B     MBHPRVAR             AS RECORD LENGTH                    S0645500
         TM    MDCTFEAT,DCTPTAB+DCTPPRES  TEST FOR TAB & COMPRESS       S0646000
         BNZ   MBHPRVAR            ASSUME VAR RECS IF EITHER            S0646500
         IC    WA,MDCTRECL         NO, USE REMOTE PRINTER WIDTH         S0647000
         EJECT                                                       R4 S0647500
MBHPRVAR ALR   R14,WA              COMPUTE ACTUAL RECORD LENGTH         S0648000
         AH    R14,IOBCCW6+6       COMPUTE BLOCK LENGTH                 S0648500
         CR    R14,ML              COMPARE WITH MAXIMUM                 S0649000
         BH    MPFLUSH             FLUSH BUFFER IF TOO LARGE            S0649500
         STH   R14,IOBCCW6+6       UPDATE BLOCK LENGTH                  S0650000
         SPACE 1                                                        S0650500
         CLR   WA,R0               COMPARE RECORD LENGTHS               S0651000
         BE    MBHPPVAR            BRANCH IF NO BLANK FILL              S0651500
         MVI   1(R15),C' '         BLANK                                S0652000
         EX    WA,MBHPRMOV          OUT IMAGE                        R4 S0652500
         SPACE 1                                               @OZ28102 S0652600
MBHPPVAR DS    0H                                              @OZ28102 S0653000
         BCTR  R0,0                GENERATE LENGTH-1           @OZ28102 S0653500
         LR    ML,R0               RELOAD LENGTH FOR EXECUTE   @OZ28102 S0654000
         ST    R15,TPBLCCAD        SAVE ADDRESS OF CARRIAGE CONTROL     S0654500
         AL    R15,$CSAVREG        GET RECORD LOCATION WITHIN BUFFER R4 S0655000
         EX    ML,MBHPPMOV         MOVE RECORD INTO BUFFER           R4 S0655500
         ALR   R15,WA              ADVANCE DATA POINTER              R4 S0656000
         IC    R1,TPBRECNT         GET RECORD COUNT                     S0656500
         ST    R15,TPBFDATA        UPDATE DATA ADDRESS                  S0657000
         LA    R1,1(,R1)           UPDATE                               S0657500
         STC   R1,TPBRECNT          RECORD COUNT                        S0658000
         MVI   0(R15),MBCDIRS      INSERT IRS CHARACTER AFTER RECORD    S0658500
         CLI   $CSAVREG+3,1        TEST FOR 2770 PUNCH               R4 S0659000
         BNE   MPSETCC             ADD CARRIAGE CONTROL IF NOT          S0659500
         B     MBTAMXIT            EXIT IF 2770 PUNCH                R4 S0660000
         SPACE 1                                                     R4 S0660500
MBHPRMOV MVC   2(*-*,R15),1(R15)   *** EXECUTE ONLY ***              R4 S0661000
MBHPPMOV MVC   0(*-*,R15),0(R1)    *** EXECUTE ONLY ***              R4 S0661500
         EJECT                                                          S0662000
*                                                                       S0662500
*                             CPU PUT FILL ROUTINE                      S0663000
*                                                                       S0663500
         SPACE 3                                                        S0664000
MCPFILL  SL    R15,$MWORK          GET LENGTH OF OUTPUT RECORD       R4 S0664500
         BCTR  R15,0                MINUS 1                          R4 S0665000
         LH    WA,IOBCCW6+6        PICK UP EXISTING LENGTH           R4 S0665500
         LA    WA,3(WA,R15)        INCREMENT                            S0666000
         CH    WA,MDCTBFSZ          COMPARE WITH MAXIMUM       @OZ50955 S0667000
*                                   THIS LINE DELETED BY APAR  @OZ50955 S0667500
*                                   THIS LINE DELETED BY APAR  @OZ50955 S0668000
         BH    MPFLUSH             FLUSH BUFFER IF TOO LARGE            S0670000
         STH   WA,IOBCCW6+6        UPDATE BLOCK LENGTH               R4 S0670500
         SPACE 2                                                        S0671000
         L     R1,TPBFDATA         GET ADDRESS OF NEXT DATA BYTE        S0671500
         L     WA,$MWORK           POINT TO WORK AREA                R4 S0672000
         SPACE 1                                                     R4 S0676000
MCPFILL1 EX    R15,MCPFILMV        MOVE RECORD INTO BUFFER           R4 S0676500
         SPACE 1                                                     R4 S0677000
MCPFILL2 DS    0H                                                    R4 S0677500
         ST    R1,TPBLCCAD         SAVE ADDRESS OF CARRIAGE CONTROL     S0678000
         LA    R1,3(R1,R15)        INCREMENT DATA ADDRESS               S0678500
         MVC   0(4,R1),MBCPEOB     ADD BUFFER TERMINATION            R4 S0679000
         ST    R1,TPBFDATA         UPDATE DATA ADDRESS                  S0679500
         MVI   TPBRECNT,X'0F'      INDICATE RECORDS IN BUFFER           S0680000
         B     MPSETCC             SET CARRIAGE CONTROL AND EXIT        S0680500
         SPACE 1                                                     R4 S0681000
MCPFILMV MVC   2(*-*,R1),0(WA)     *** EXECUTE ONLY ***              R4 S0681500
         EJECT                                                          S0683500
*                                                                       S0684000
*                             OUTPUT BUFFER FLUSH ROUTINE               S0684500
*                                                                       S0685000
         SPACE 3                                                        S0685500
MPTRUNC  LTR   MBUF,MBUF           TEST BUFFER ADDRESS                  S0686000
         BZ    MBTAMXIT            RETURN IF NO OUTPUT BUFFER        R4 S0686500
         CLI   TPBRECNT,0          TEST BUFFER STATUS                   S0687000
         BE    MBTAMXIT            RETURN IF BUFFER IS EMPTY         R4 S0687500
*              THIS LINE DELETED BY APAR NUMBER                @OZ48654 S0687600
*              THIS LINE DELETED BY APAR NUMBER                @OZ48654 S0687700
*              THIS LINE DELETED BY APAR NUMBER                @OZ48654 S0687800
*              THIS LINE DELETED BY APAR NUMBER                @OZ48654 S0687900
*              THIS LINE DELETED BY APAR NUMBER                @OZ48654 S0687950
         MVI   0(R1),X'03'         CHANGE CHANNEL COMMAND TO NOP        S0688000
         SPACE 2                                                        S0688500
MPFLUSH  DS    0H                  FLUSH OUTPUT BUFFER                  S0689000
         LA    R15,MEXCP           ASSUME NON-MULTI-LEAVING TERMINAL    S0689500
         TM    MSEQTYPE,MBSCSEQ+MCPUSEQ      TEST SEQUENCE TYPE         S0690000
         BNO   MPFLUSHW            BR IF NOT MULTI-LEAVING TERMINAL  R4 S0690500
         LA    R15,MBCWRITE        GET ADDR OF MULTI-LEAVING ROUTINE R4 S0691000
         TM    MDCTSTAT,DCTERMNR   TEST FOR TERMINATED BY RECEIVER   R4 S0691500
         BO    MBTAMXAB            IF YES, GO TO RTAM ABNORMAL EXIT  R4 S0692000
         SPACE 1                                                     R4 S0692500
MPFLUSHW BALR  ML,R15              INITIATE WRITE                    R4 S0693000
         CLI   DCTDEVTP,DCTRCON    TEST DEVICE TYPE                     S0693500
         L     R1,PCER1            R1 = DCT AD FOR POSSIBLE $RESTORE R4 S0694000
         L     R0,PCER0            RESTORE RCP CCW ADDRESS     @OZ37122 S0694100
         BE    MPFLRST             GO RE-ENTER IF REMOTE CONSOLE     R4 S0694500
        $WAIT  WORK,SAVE=NO        WAIT FOR WRITE TO BE ACKNOWLEDGED R4 S0695000
         SPACE 1                                                     R4 S0695500
MPFLRST $RESTORE REENTER=YES       SIMULATE RE-ENTRY                 R4 S0696000
         EJECT                                                          S0696500
*                                                                       S0697000
*                             PUT CARRIAGE CONTROL AND EXIT ROUTINES    S0697500
*                                                                       S0698000
         SPACE 3                                                        S0698500
MPSETCC  L     WA,PCER0            GET ADDRESS OF CHANNEL COMMAND       S0699000
         SR    R1,R1               CLEAR REGISTER                       S0699500
         IC    R1,0(WA)             AND INSERT CHANNEL COMMAND          S0700000
         L     WA,TPBLCCAD         GET ADDRESS OF RECORD BEGINNING   R4 S0700500
         STC   R1,TPBLCCC          SAVE CHANNEL COMMAND FOR NEXT ENTRY  S0703500
         SRL   R1,3                GENERATE INDEX                       S0704000
         TM    MSEQTYPE,MCPUSEQ    TEST SEQUENCE TYPE                   S0704500
         BZ    MPSETBH             BRANCH IF 2770 OR 2780               S0705000
         SPACE 1                                                        S0705500
MPSETRCB MVC   0(1,WA),MDCTRCB     SET UNIT RCB                      R4 S0706000
         STC   R1,1(,WA)            AND SRCB                            S0706500
         OI    1(WA),X'80'         ADD HIGH-ORDER BIT                   S0707000
         B     MBTAMXIT            EXIT                              R4 S0707500
         SPACE 1                                                        S0708000
MPSETBH  MVI   1(WA),MBCDESC       INSERT ESCAPE CHARACTER           R4 S0708500
         CLI   MDCTTYPE,DCTP2780   TEST TERMINAL TYPE                R4 S0709000
         BL    SKIP120             BRANCH IF 2770                    R4 S0709500
         LA    R1,32(,R1)          INCREMENT INDEX FOR 2780             S0710000
SKIP120  IC    R1,MP27X0CC(R1)     GET CARRIAGE CONTROL CHARACTER       S0710500
         STC   R1,2(,WA)           INSERT IN RECORD                     S0711000
         TM    MDCTLINE,DCTPASCI   TEST CODE TYPE                       S0711500
         BZ    MBTAMXIT            EXIT IF EBCDIC                    R4 S0712000
         XI    2(WA),X'80'         CONVERT CARRIAGE CONTROL TO USASCII  S0712500
         B     MBTAMXIT            EXIT                              R4 S0713000
         TITLE 'HASP BSC REMOTE TERMINAL CLOSE ROUTINE'              R4 S0713500
*                                                                       S0714000
*                             REMOTE TERMINAL CLOSE ROUTINE             S0714500
*                                                                       S0715000
         SPACE 3                                                     R4 S0715500
         USING RTAMBCLO,MBASE1     ESTABLISH CLOSE ADDRESSABILITY    R4 S0716000
RTAMBNCL DS    0H                  ADDRESS OF RTAM BSC NCLOSE RTN   R41 S0717000
         SPACE 3                                                     R4 S0725000
RTAMBCLO DS    0H                  ADDRESS OF RTAM BSC CLOSE ROUTINE R4 S0725500
         SLR   WA,WA               REMEMBER CLOSE                    R4 S0726000
         LTR   MBUF,MBUF           TEST BUFFER ADDRESS                  S0726500
         BZ    MCLOSE              IF ZERO, GO TO CPU CLOSE          R4 S0727000
         TM    MSEQTYPE,MCPUSEQ    TEST SEQUENCE TYPE                   S0727500
         BZ    M27X0CLO            BRANCH IF NOT PROGRAMMABLE INTERFACE S0728000
         EJECT                                                          S0728500
*                                                                       S0729000
*                             BSC CPU CLOSE ROUTINE                     S0729500
*                                                                       S0730000
         SPACE 3                                                        S0730500
MCLOSE   DS    0H                  *                                 R4 S0731000
         IC    R15,MDCTOPCT-DCTDSECT(R1)     DECREMENT                  S0731500
         BCTR  R15,0                          OPEN                      S0732000
         STC   R15,MDCTOPCT-DCTDSECT(R1)       COUNT                    S0732500
         SPACE 2                                                        S0733000
         CLI   DCTDEVTP,DCTRJR     TEST DEVICE TYPE                     S0733500
         BE    MBTAMXIT            EXIT IF REMOTE READER             R4 S0734000
         CLI   DCTDEVTP,DCTRCON    TEST DEVICE TYPE                  R4 S0734500
         BNE   MCLOPPN             BRANCH IF NOT REMOTE CONSOLE      R4 S0735000
         LTR   MBUF,MBUF           TEST BUFFER ADDRESS               R4 S0735500
         BZ    MBTAMXIT            IF ZERO, GO TO RTAM NORMAL EXIT   R4 S0736000
         B     MCONCLOS            ELSE GO WRITE LAST BUFFER         R4 S0736500
         SPACE 1                                                     R4 S0737000
MCLOPPN  TM    DCTDEVTP,DCTPRPU    TEST DEVICE TYPE                  R4 S0737500
         BZ    MCLOGBUF            BRANCH IF INPUT DEVICE            R4 S0738000
         SPACE 1                                                     R4 S0738500
         TM    MDCTSTAT,DCTERMNR   TEST DEVICE STATUS                R4 S0739000
         BZ    MCLOTBUF            BRANCH IF NO RECEIVER TERMINATED  R4 S0739500
         LTR   MBUF,MBUF           TEST BUFFER ADDRESS               R4 S0740000
         BZ    MBTAMXAB            IF ZERO, GO TO RTAM ABNORMAL EXIT R4 S0740500
        $FREEBUF (MBUF)            FREE THE BUFFER                   R4 S0741000
         NI    MDCTSTAT,255-DCTPBUF  INDICATE NO BUFFER              R4 S0741500
         B     MBTAMXAB            GO TO RTAM ABNORMAL EXIT          R4 S0742000
         SPACE 1                                                     R4 S0742500
MCLOTBUF LTR   MBUF,MBUF           TEST BUFFER ADDRESS               R4 S0743000
         BNZ   MCLOPPNT            BRANCH IF NOT ZERO                R4 S0743500
MCLOGBUF BAL   ML,MGETPBUF         GET AN OUTPUT BUFFER              R4 S0744000
         MVI   IOBCCW6+7,6         INITIALIZE DATA LENGTH            R4 S0744500
         MVC   TPBUFST+6(3),MBCPEOB+1  SET UP EOB                    R4 S0745000
         SPACE 1                                                     R4 S0745500
MCLOPPNT L     R1,TPBFDATA         GET ADDRESS OF EOB                R4 S0746000
         TM    DCTDEVTP,DCTPRPU    TEST DEVICE TYPE                  R4 S0746500
         BZ    MCLONR              BRANCH IF INPUT DEVICE            R4 S0747000
         MVC   0(1,R1),MDCTRCB     REPLACE EOB WITH DEVICE RCB       R4 S0747500
         STC   WA,2(,R1)           SET NORMAL OR TERMINATED EOF      R4 S0748000
         B     MCLOSEND            GO SEND BUFFER                    R4 S0748500
         SPACE 1                                                     R4 S0749000
MCLONR   MVI   0(R1),X'C0'         SET NORMAL RECEIVER RESPONSE      R4 S0749500
         TM    MDCTSTAT,DCTERMNR   TEST DEVICE STATUS                R4 S0750000
         BZ    SKIP130             SKIP IN NOT TERMINATED BY RCVR    R4 S0750500
         MVI   0(R1),X'B0'         SET RECEIVER TERMINATED RESPONSE  R4 S0751000
SKIP130  MVC   1(1,R1),MDCTRCB     SET SRCB FROM DEVICE RCB          R4 S0751500
         EJECT                                                       R4 S0752000
MCLOSEND LH    R1,IOBCCW6+6        INCREMENT                         R4 S0752500
         LA    R1,3(,R1)            DATA                                S0753000
         STH   R1,IOBCCW6+6          LENGTH                             S0753500
         SPACE 1                                                        S0754000
MCONCLOS MVC   BUFDCT+1(3),DCTDCB+1     NOP WRITE POST                  S0754500
         BAL   ML,MBCWRITE         QUEUE BUFFER FOR OUTPUT              S0755000
         SPACE 1                                                     R4 S0755500
         TM    DCTDEVTP,DCTRJE+DCTPRPU   TEST DEVICE TYPE      @OZ53297 S0756000
         BNO   MCLNOTPP            BR IF NOT RMT PRINT/PUNCH   @OZ53297 S0756500
         NI    MHASPECF+$EWBJOT,255-$EWFJOT  SHOW UNIT TO LM   @OZ53297 S0757000
*              THIS LINE DELETED BY APAR NUMBER                @OZ32567 S0757100
MCLNOTPP DS    0H                                              @OZ53297 S0757200
*              THIS LINE DELETED BY APAR NUMBER                @OZ32567 S0757300
*              THIS LINE DELETED BY APAR NUMBER                @OZ32567 S0757400
         B     MBTAMXIT            EXIT                              R4 S0758000
         EJECT                                                       R4 S0763500
*                                                                       S0764000
*                             2770/2780 CLOSE ROUTINE                   S0764500
*                                                                       S0765000
         SPACE 3                                                        S0765500
M27X0CLO CLI   DCTDEVTP,DCTRJR     TEST DEVICE TYPE                     S0766000
         BE    MBHCLOSE            BRANCH IF REMOTE READER              S0766500
         SPACE 3                                                        S0767000
         CLI   TPBRECNT,0          TEST BUFFER CONTENTS                 S0767500
         BNE   MBNECLOS            BRANCH IF NOT EMPTY         @OZ48654 S0768000
         LA    R0,IOBCCW5          GET START OF CCW CHAIN      @OZ48654 S0768050
         CLI   DCTDEVTP,DCTRPU     PUNCHES REQUIRE THE IOB TO  @OZ48654 S0768052
         BNE   MBHNULLC              BE REINITIALIZED          @OZ48654 S0768054
         LA    R1,MBSCSEQ+MWRITSEQ REBUILD WRITE CCW SEQUENCE  @OZ48654 S0768056
         BAL   ML,MCCWINIT                                     @OZ48654 S0768058
         LA    R0,IOBCCW5          REPAIR R0 FROM MCCWINIT     @OZ48654 S0768059
         TM    MDCTLINE,DCTPTRSP   TRANSPARENCY...             @OZ48654 S0768060
         BNO   MBHNULLC            NO, BUILD STXETX AS USUAL   @OZ48654 S0768062
         MVC   TPBUFST(2),MDLESTX  SET UP TRANSPARENT STX      @OZ48654 S0768064
         MVC   IOBCCW6+6(2),=XL2'0002' ADJUST WRITE LENGTH     @OZ48654 S0768066
         B     MBNECLOS                                        @OZ48654 S0768068
MBHNULLC DS    0H                  BUILD NULL BUFFER (STXETX)  @OZ48654 S0768070
         ST    R0,IOBSTART         STORE IT IN                 @OZ48654 S0768100
         ST    R0,IOBRESTR           THE IOB                   @OZ48654 S0768150
         MVI   TPBUFST,MBCDSTX     SET STX,ETX SEQUENCE        @OZ48654 S0768200
         XC    IOBCCW6+6(2),IOBCCW6+6  CLEAR COUNT FIELD       @OZ48654 S0768220
         MVI   IOBCCW6+7,1           IF LAST BUFFER SENT       @OZ48654 S0768250
MBNECLOS XI    IOBCCW7+3,METXSEQ-METBSEQ CONVERT ETB TO ETX    @OZ48654 S0768500
         BAL   ML,MEXCP            WRITE LAST BUFFER                    S0769000
        $WAIT  WORK,SAVE=NO        WAIT FOR THE NEXT LOGICAL RECORD  R4 S0769500
        $RESTORE                   RESTORE ACCESS METHOD REGISTERS   R4 S0770000
         SPACE 2                                                        S0770500
MBHCLOSE LA    R0,IOBCCW3          SET UP BSC                           S0771000
         LA    R1,MBSCSEQ+MPREPSEQ  PREPARE                             S0771500
         BAL   ML,MCCWINIT           CCW SEQUENCE                       S0772000
         CLI   DCTDEVTP,DCTRJR     TEST DEVICE TYPE                     S0772500
         BE    MBHCEXCP            BRANCH IF REMOTE READER              S0773000
         TM    $RJEOPTS,$ADDSYNS   TEST ADDITIONAL IDLES OPTION      R4 S0773500
         BZ    SKIP150             BR IF NOT SELECTED                R4 S0774000
         MVI   IOBCCW4,X'01'       ACTIVATE EOT WRITE                   S0774500
         MVI   IOBCCW4+4,X'A0'     SET DATA CHAINING                    S0775000
SKIP150  MVI   IOBCCW5,X'01'       ACTIVATE EOT WRITE                R4 S0775500
         XI    IOBCCW5+3,MBSCEOT-MBSCENQ     CONVERT ENQ TO EOT         S0776000
         SPACE 2                                                        S0776500
MBHCEXCP BAL   ML,MEXCP            INITIATE PREPARE SEQUENCE            S0777000
*                                  THIS LINE DELETED BY APAR   @OZ53297 S0777100
*                                  THIS LINE DELETED BY APAR   @OZ53297 S0777200
         NI    MHASPECF+$EWBJOT,255-$EWFJOT  SHOW UNIT TO LINE MGR      S0777500
         SPACE 2                                                     R4 S0852000
         DROP  MDCT                RELEASE DCT ADDRESSABILITY        R4 S0852500
         TITLE 'HASP BSC REMOTE TERMINAL ACCESS METHOD EXIT ROUTINE' R4 S0855500
         USING DCTDSECT,R1         ESTABLISH DCT ADDRESSABILITY      R4 S0856000
         SPACE 3                                                     R4 S0856500
RTAMBSUB DS    0H                  RTAM BSC SUBROUTINE BASE ADDRESS  R4 S0857000
         SPACE 3                                                     R4 S0857500
*                                                                    R4 S0858000
*                             BSC RTAM COMMON EXIT ROUTINE           R4 S0858500
*                                                                    R4 S0859000
         SPACE 3                                                     R4 S0859500
MBTAMXIT DS    0H                  BSC RTAM NORMAL EXIT              R4 S0860000
         LM    LINK,BASE2,PCELINK  RELOAD CALLER'S REGISTERS         R4 S0860500
         NI    DCTSTAT,255-DCTRTAM SHOW RTAM PROCESSING COMPLETE     R4 S0861000
         LPR   R0,R1               SET POSITIVE CONDITION CODE       R4 S0861500
         BR    LINK                 AND RETURN                       R4 S0862000
         SPACE 5                                                     R4 S0862500
MBTAMXEX DS    0H                  BSC RTAM EXCEPTION EXIT           R4 S0863000
         LM    LINK,BASE2,PCELINK  RELOAD CALLER'S REGISTERS         R4 S0863500
         NI    DCTSTAT,255-DCTRTAM SHOW RTAM PROCESSING COMPLETE     R4 S0864000
         LNR   R0,R1               SET NEGATIVE CONDITION CODE       R4 S0864500
         BR    LINK                 AND RETURN                       R4 S0865000
         SPACE 5                                                     R4 S0865500
MBTAMXAB DS    0H                  BSC RTAM ABNORMAL EXIT            R4 S0866000
         LM    LINK,BASE2,PCELINK  RELOAD CALLER'S REGISTERS         R4 S0866500
         NI    DCTSTAT,255-DCTRTAM SHOW RTAM PROCESSING COMPLETE     R4 S0867000
         SR    R0,R0               SET ZERO CONDITION CODE           R4 S0867500
         BR    LINK                 AND RETURN                       R4 S0868000
         SPACE 5                                                     R4 S0868500
MBTAMXOV DS    0H                  BSC RTAM OVERFLOW EXIT            R4 S0869000
         LM    LINK,BASE2,PCELINK  RELOAD CALLER'S REGISTERS         R4 S0869500
         NI    DCTSTAT,255-DCTRTAM SHOW RTAM PROCESSING COMPLETE     R4 S0870000
         TM    DCTSTAT,DCTINUSE    GET 'ONES' (OVERFLOW) COND. CODE  R4 S0870500
         BR    LINK                 AND RETURN                       R4 S0871000
         SPACE 2                                                     R4 S0871500
         DROP  R1                  RELEASE DCT ADDRESSABILITY        R4 S0872000
         TITLE 'HASP BSC REMOTE TERMINAL ACCESS METHOD SUBROUTINES'  R4 S0872500
         USING DCTDSECT,MDCT       ESTABLISH DCT ADDRESSABILITY      R4 S0873000
         SPACE 3                                                        S0873500
*                                                                       S0874000
*                             BSC CPU GET OUTPUT BUFFER SUBROUTINE      S0874500
*                                                                       S0875000
         SPACE 1                                                     R4 S0875500
MGETPBUF DS    0H                                                    R4 S0876000
        $GETBUF MBUFWAIT,TYPE=BSC  GET TP BUFFER FOR OUTPUT          R4 S0876500
         LR    MBUF,R1             SET UP BUFFER REGISTER               S0877000
         ST    MBUF,DCTBUFAD       SET BUFFER ADDRESS IN DCT            S0877500
         OI    MDCTSTAT,DCTPBUF    INDICATE BUFFER OWNERSHIP            S0878000
         MVC   TPBUFST(2),MSTXSEQ  SET UP STX SEQUENCE                  S0878500
         MVI   TPBUFST+2,0         INITIALIZE BCB                       S0879000
         LA    R1,TPBUFST+5        INITIALIZE ADDRESSES OF              S0879500
         ST    R1,TPBLCCAD          FIRST CARRIAGE CONTROL              S0880000
         ST    R1,TPBFDATA           AND FIRST DATA BYTE                S0880500
         ST    MDCT,BUFDCT         SET ADDRESS OF REMOTE DCT            S0881000
         MVI   BUFTYPE,BUFBSC      RESET BUFFER TYPE                 R4 S0881500
         LA    R1,MBSCSEQ+MCPUSEQ  SET UP                               S0882000
         B     MCCWINIT             CCW STRING                          S0882500
         SPACE 2                                                        S0883000
MBUFWAIT CLI   DCTDEVTP,DCTRCON    TEST DEVICE TYPE                     S0883500
         BE    MBTAMXIT            EXIT IF REMOTE CONSOLE            R4 S0884000
         ST    ML,DCTEWF           SAVE RETURN ADDRESS                  S0884500
        $WAIT  BUF,SAVE=NO         WAIT FOR A BUFFER                 R4 S0885000
        $RESTORE                   RESTORE ACCESS METHOD REGISTERS   R4 S0885500
         L     ML,DCTEWF           RELOAD RETURN ADDRESS                S0886000
         B     MGETPBUF            TRY AGAIN                            S0886500
         EJECT                                                          S0887000
*                                                                       S0887500
*                             BSC CPU WRITE SUBROUTINE                  S0888000
*                                                                       S0888500
         SPACE 3                                                        S0889000
MBCWRITE SR    R0,R0               CLEAR                                S0889500
         ST    R0,DCTBUFAD          BUFFER ADDRESS IN DCT               S0890000
         NI    MDCTSTAT,255-DCTPBUF     INDICATE BUFFER IS QUEUED       S0890500
         L     R1,DCTDCB           GET ADDRESS OF LINE DCT              S0891000
         L     R1,MDCTOBUF-DCTDSECT(R1) GET ADDRESS OF QUEUED BUFFER    S0891500
         LA    R1,0(,R1)           CLEAR HIGH-ORDER BYTE                S0892000
         LTR   R0,R1               TEST IF BUFFER IS QUEUED             S0892500
         BNZ   MBCWRCHN            BRANCH IF BUFFER IS QUEUED           S0893000
         SPACE 1                                                        S0893500
         STM   MDCT,ML,MTEMPSAV    SAVE REGISTERS                       S0894000
         L     MDCT,DCTDCB         GET ADDRESS OF LINE DCT              S0894500
         IC    R0,MDCTOPCT         SAVE OPEN COUNT                      S0895000
         ST    MBUF,MDCTOBUF       QUEUE BUFFER                         S0895500
         STC   R0,MDCTOPCT         RESTORE OPEN COUNT                   S0896000
         ST    R1,BUFCHAIN         TERMINATE CHAIN                      S0896500
         L     MBUF,DCTBUFAD       GET ADDRESS OF INPUT BUFFER          S0897000
         BAL   ML,MINITIO          INITIATE I/O                         S0897500
         LM    MDCT,ML,MTEMPSAV    RESTORE REGISTERS                    S0898000
         BR    ML                   AND RETURN                          S0898500
         SPACE 2                                                        S0899000
MBCWRCHN LR    R1,R0               GET NEXT BUFFER IN OUTPUT QUEUE      S0899500
         L     R0,BUFCHAIN-BUFDSECT(,R1)     GET CHAIN FIELD            S0900000
         LTR   R0,R0               TEST FOR LAST BUFFER IN QUEUE        S0900500
         BNZ   MBCWRCHN            BRANCH IF NOT LAST BUFFER            S0901000
         SPACE 1                                                        S0901500
         ST    MBUF,BUFCHAIN-BUFDSECT(,R1)   ADD BUFFER TO CHAIN        S0902000
         ST    R0,BUFCHAIN         TERMINATE CHAIN                      S0902500
         BR    ML                  RETURN                               S0903000
         EJECT                                                          S0903500
*                                                                       S0904000
*                             BSC CPU RCB ANALYSIS SUBROUTINE           S0904500
*                                                                       S0905000
         SPACE 3                                                        S0905500
MBCNEXTR ST    ML,MSAVE            SAVE LINK REGISTER                   S0906000
         TM    0(R1),X'0F'         TEST RCB CODE                        S0906500
         BZ    MBCNXCTL            BRANCH IF CONTROL RECORD             S0907000
         SPACE 1                                                        S0907500
         CLI   0(R1),X'92'         TEST RCB CODE                        S0908000
         BE    MBCNXOPC            BRANCH IF OPERATOR COMMAND           S0908500
         SPACE 1                                                        S0911000
         IC    R1,0(R1)            GET RCB                              S0911500
         BAL   ML,MFINDCT          FIND ASSOCIATED DCT                  S0912000
         BZ    MBCNXEND            IGNORE REST OF BLOCK IF NONE FOUND   S0912500
         TM    MDCTSTAT-DCTDSECT(R1),DCTERMNR  TEST DEVICE STATUS    R4 S0913000
         BO    MBCNXEND            IGNORE BLK IF TERMINATED BY RCVR  R4 S0913500
         L     ML,MSAVE            RESTORE LINK REGISTER                S0914000
         TM    DCTDEVTP-DCTDSECT(R1),DCTPRPU  TEST DEVICE TYPE       R4 S0914500
         BO    MBCNERR             RESTART IF NOT INPUT DEVICE       R4 S0915000
         ST    MBUF,DCTBUFAD-DCTDSECT(R1) STORE ADDRESS OF INPUT BUFFER S0915500
         TM    DCTSTAT-DCTDSECT(R1),DCTINUSE  TEST DEVICE STATUS     R4 S0916000
         BO    MBCNPOST            IF IN USE, GO POST                R4 S0916500
         B     MBCNERR             RESTART IF NOT IN USE             R4 S0917000
         SPACE 2                                                        S0917500
MBCNXCTL BAL   ML,MBCNTRLR         ANALYZE CONTROL RECORD               S0918000
         SPACE 1                                                        S0918500
MBCNXEND MVI   TPBRECNT,C'E'       INDICATE EMPTY INPUT BUFFER          S0919000
         L     ML,MSAVE            RESTORE LINK REGISTER                S0919500
         CLI   DCTDEVTP,DCTLNE     TEST DEVICE TYPE                     S0920000
         BCR   E,ML                RETURN IF LINE MANAGER               S0920500
         STM   MDCT,ML,MTEMPSAV    OTHERWISE, SAVE REGISTERS            S0921000
         L     MDCT,DCTDCB         GET ADDRESS OF LINE DCT              S0921500
         BAL   ML,MINITIO          INITIATE I/O                         S0922000
         LM    MDCT,ML,MTEMPSAV    RESTORE REGISTERS                    S0922500
         BR    ML                   AND RETURN                          S0923000
         EJECT                                                       R4 S0923500
MBCNXOPC CLI   DCTDEVTP,DCTLNE     CHECK DCT TYPE FOR 'LINE',       R41 S0924000
         BNE   MBCNXOPS              BRANCH AROUND IF NOT           R41 S0924100
         OC    MDCTDCT,MDCTDCT     IGNORE CONSOLE INPUT IF          R41 S0924200
         BZ    MBCNXEND              REMOTE NOT SIGNED ON           R41 S0924300
MBCNXOPS L     R0,$MCONPCE         GET ADDR OF RMT CONSOLE PCE      R41 S0924400
         LA    R15,$MCONMSG        PREPARE TO SCAN RMT CONSOLE QUEUE R4 S0924500
         B     MBCNXOP               TO ADD BUFFER AT END            R4 S0925000
MBCNXBUF LA    R15,TPBLCCAD-BUFDSECT(,R1)   ASSUME BSC BUFFER CHAIN  R4 S0925500
         TM    BUFTYPE-BUFDSECT(R1),BUFTP+BUFIOB TEST ASUMPTN       R41 S0926000
         BO    MBCNXOP             VALID, SKIP                      R41 S0926500
         LA    R15,RPLNEXT-RPLDSECT(,R1)    USE SNA BUFFER CHAIN     R4 S0927000
MBCNXOP  L     R1,0(,R15)          LOCATE NEXT BUFFER                R4 S0927500
         LTR   R1,R1               TEST FOR CHAIN END                R4 S0928000
         BNZ   MBCNXBUF            NO, CONTINUE SCANNING             R4 S0928500
         ST    MBUF,0(,R15)        ADD NEW BUFFER AFTER LAST         R4 S0929000
         ST    R1,TPBLCCAD         TERMINATE CHAIN                   R4 S0929500
         SPACE 1                                                     R4 S0930000
         LR    R15,R0              GET PCE TO POST                   R4 S0930500
        $POST  (R15),WORK          FIRE UP PROCESSOR                 R4 S0931000
         L     ML,MSAVE            RELOAD LINK REGISTER              R4 S0931500
         BR    ML                  RETURN                               S0932000
         EJECT                                                          S0932500
*                                                                       S0933000
*                             BSC CPU CONTROL RECORD ANALYSIS ROUTINE   S0933500
*                                                                       S0934000
         SPACE 3                                                        S0934500
MBCNTRLR CLI   0(R1),X'00'         TEST RCB CODE                        S0935000
         BCR   E,ML                RETURN IF END OF BLOCK               S0935500
         ST    ML,MSAVE+4          SAVE LINK REGISTER                R4 S0936000
         CLI   0(R1),X'90'         TEST RCB CODE                        S0936500
         BE    MBCNTREQ            BRANCH IF REQUEST FOR INPUT          S0937000
         CLI   0(R1),X'C0'         TEST RCB CODE                     R4 S0937500
         BNH   MBCNRRSP            BRANCH IF RESPONSE TO OUTPUT      R4 S0938000
         CLI   0(R1),X'F0'         TEST RCB CODE                        S0938500
         BNER  ML                  BRANCH IF NOT GENERAL CONTROL REC R4 S0939000
         SPACE 2                                                     R4 S0939500
         CLI   1(R1),C'B'          TEST FOR DISCONNECT RECORD        R4 S0943000
         BNE   SKIP190             SKIP IF NOT                       R4 S0943500
         OI    DCTFLAGS,DCTRSTRT   SET TO RESTART LINE               R4 S0944000
         BR    ML                  RETURN                            R4 S0944500
SKIP190  LA    R1,2(,R1)           STEP TO FIRST CHARACTER              S0945000
         SPACE 1                                               @OZ32567 S0945100
         CLI   PCEID+1,PCEMLMID    IF LINE MANAGER,            @OZ32567 S0945200
         BE    MSIGNON               BR TO PROCESS SIGNON      @OZ32567 S0945300
*              THIS LINE DELETED BY APAR NUMBER                @OZ32042 S0945500
         L     R1,$MWORK           POINT TO WORK AREA          @OZ32042 S0945700
         MVC   0(L'MSOILMSG,R1),MSOILMSG  MOVE MSG TO AREA     @OZ32042 S0945800
         LR    R0,MDCT             SAVE READER DCT ADDRESS     @OZ32042 S0945820
         L     MDCT,DCTDCB         GET LINE DCT ADDRESS        @OZ32042 S0945840
         OI    DCTFLAGS,DCTRSTRT   SET TO RESTART LINE         @OZ32042 S0945860
         MVC   6(3,R1),DCTDEVN+4   MOVE LINE NUMBER TO MSG     @OZ32042 S0945900
         LR    MDCT,R0             RESTORE READER DCT ADDRESS  @OZ32042 S0945950
        $WTO   (R1),L'MSOILMSG,JOB=NO,WAIT=NO,   ISSUE ERROR   @OZ32042CS0946000
               ROUTE=$LOG+$TP,CLASS=$NORMAL,PRI=$ST            @OZ32042 S0946100
         L     LINK,$EXTP          GET REG SETUP CODE BASE     @OZ32042 S0946200
*              THIS LINE DELETED BY APAR NUMBER                @OZ32042 S0946500
         BR    ML                  RETURN TO CALLER            @OZ32042 S0947000
         SPACE 2                                                     R4 S0947500
MBCNTREQ IC    R1,1(,R1)           LOCATE THE DCT                    R4 S0948000
         BAL   ML,MFINDCT           WHICH MATCHES THE SRCB           R4 S0948500
         L     ML,MSAVE+4          RELOAD LINK REGISTER              R4 S0949000
         BZR   ML                  RETURN IF MATCH NOT FOUND         R4 S0950000
         TM    MDCTSTAT-DCTDSECT(R1),DCTERMNR+DCTEOF  TEST STATUS    R4 S0952500
         BNZ   MBCNTREF            BRANCH IF EOF HAS BEEN READ       R4 S0953000
         TM    DCTSTAT-DCTDSECT(R1),DCTINUSE  TEST DEVICE STATUS     R4 S0953500
         BO    MBCNERR             RESTART IF IN USE                 R4 S0954000
MBCNTREF NI    DCTSTAT-DCTDSECT(R1),255-DCTHOLD  MAKE UNIT AVAILABLE R4 S0954500
         B     MBCNPOST            GO POST                           R4 S0955000
         EJECT                                                       R4 S0955500
MBCNRRSP SLR   R15,R15             ASSUME NORMAL RESPONSE            R4 S0960000
         CLI   0(R1),X'B0'         TEST RCB CODE                     R4 S0960500
         BNE   SKIP200             SKIP IF NORMAL RESPONSE           R4 S0961000
         LA    R15,DCTERMNR        SET FOR ABNORMAL RESPONSE         R4 S0961500
SKIP200  IC    R1,1(,R1)           LOCATE THE DCT                    R4 S0962000
         BAL   ML,MFINDCT           WHICH MATCHES THE SRCB           R4 S0962500
         L     ML,MSAVE+4          RELOAD LINK REGISTER              R4 S0963000
         BZR   ML                  RETURN IF MATCH NOT FOUND         R4 S0963500
         TM    DCTDEVTP-DCTDSECT(R1),DCTPRPU  TEST DEVICE TYPE       R4 S0964000
         BO    MBCNRFND            BRANCH IF OUTPUT DEVICE           R4 S0964500
         BAL   ML,MFNDLOOP         LOCATE NEXT DCT MATCHING SRCB     R4 S0965000
         L     ML,MSAVE+4          RELOAD LINK REGISTER              R4 S0965500
         BZR   ML                  RETURN IF MATCH NOT FOUND         R4 S0966000
MBCNRFND EX    R15,MBCNROI         SET RESPONSE TYPE                 R4 S0966500
         SPACE 2                                                     R4 S0967000
MBCNPOST L     R1,DCTPCE-DCTDSECT(,R1)  GET ADDRESS OF PCE           R4 S0967500
        $POST  (R1),WORK           POST PROCESSOR                       S0968000
         BR    ML                  RETURN                               S0968500
         SPACE 1                                                     R4 S0969000
MBCNERR  L     R1,DCTDCB-DCTDSECT(,R1)  GET ADDRESS OF LINE DCT         S0969500
         OI    DCTFLAGS-DCTDSECT(R1),DCTRSTRT   RESTART LINE            S0970000
         BR    ML                  RETURN                               S0970500
         SPACE 2                                                     R4 S0971000
MBCNROI  OI    MDCTSTAT-DCTDSECT(R1),*-*  *** EXECUTE ONLY ***       R4 S0971500
         EJECT                                                          S0972000
*                                                                       S0972500
*                             BSC CPU DCT LOOKUP SUBROUTINE             S0973000
*                                                                       S0973500
         SPACE 3                                                        S0974000
MFINDCT  STC   R1,$POSTSAV         STORE RCB FOR COMPARE             R4 S0974500
         LR    R1,MDCT             ASSUME MDCT IS A LINE DCT            S0975000
         CLI   DCTDEVTP,DCTLNE     TEST DCT TYPE                        S0975500
         BE    MFNDLOOP            BRANCH IF DCT IS LINE                S0976000
         L     R1,DCTDCB           NO, GET LINE DCT                     S0976500
         SPACE 2                                                        S0977000
MFNDLOOP L     R1,MDCTDCT-DCTDSECT(,R1) GET ADDRESS OF NEXT DCT         S0977500
         LTR   R1,R1               TEST FOR END OF CHAIN                S0978000
         BCR   Z,ML                RETURN IF MATCH IS NOT FOUND         S0978500
         CLC   MDCTRCB-DCTDSECT(,R1),$POSTSAV  COMPARE RCB CODES     R4 S0979000
         BNE   MFNDLOOP            KEEP LOOKING IF NOT EQUAL            S0979500
         LTR   R1,R1               SET CONDITION CODE                   S0980000
         BR    ML                   AND RETURN                          S0980500
         EJECT                                                          S0981000
*                                                                       S0981500
*                             SIGN-ON PROCESSOR                         S0982000
*                                                                       S0982500
         SPACE 3                                                        S0983000
MSIGNON  ST    MDCT,MSOSAVE1       SAVE ADDRESS OF DCT                  S0983500
         CLI   DCTDEVTP,DCTLNE     TEST DCT TYPE                        S0984000
         BE    *+8                 BRANCH IF LINE DCT                   S0984500
         L     MDCT,DCTDCB         NO GET ADDDRESS OF LINE DCT          S0985000
         SPACE 1                                                        S0985500
         TM    MDCTSTAT,DCTLEASE   TEST LINE DCT STATUS                 S0986000
         BZ    MSONCKPT            IF NOT LEASED, SIGNON       @OZ32567 S0988000
         TM    MDCTSTAT,DCTSHARE   TEST FOR SHARED LINE              R4 S0988500
         BZ    MSORETRN            NO, BR--IGNORE SIGN-ON IF LEASED  R4 S0989000
         SPACE 2                                                        S0990000
MSONCKPT CLI   PCEID+1,PCEMLMID    IF NOT LINE MANAGER,        @OZ32567 S0990100
         BNE   MSONSAVE              BR TO PROCESS SIGNON      @OZ32567 S0990200
         $QSUSE TYPE=TEST          TEST SHARED QUEUE STATUS    @OZ32567 S0990300
         BZ    MSONSAVE            QUEUES OWNED, CHK SIGNON    @OZ32567 S0990400
         TM    MSEQTYPE,MCPUSEQ    IF INTELLIGENT TERMINAL..   @OZ32567 S0990410
         BO    MREQBUF             GO REQUEUE BUFFER           @OZ32567 S0990420
         TM    MDCTLINE,DCTPASCI   CHECK FOR ASCII..           @OZ32567 S0990430
         BNO   MREQBUF             IF NOT ASCII, REQUEUE BFR   @OZ32567 S0990440
         TR    TPBUFST(83),MBPASCII TRANSLATE SIGNON TO ASCI   @OZ32567 S0990450
         B     MREQBUF                REQUEUE BUFFER           @OZ32567 S0990460
MSONSAVE ST    R1,MSOSAVE2         SAVE ADDR OF SIGN-ON CARD IMAGE   R4 S0990500
         ST    ML,MSOSAVE3         SAVE RETURN REGISTER                 S0991000
         BAL   ML,MABORT           ABORT ANY CURRENT ACTIVITY ON LINE   S0991500
         BAL   ML,MDISCON          DISCONN ANY REMOTES ON LINE          S0992000
         L     R1,MSOSAVE2         RESTORE ADDRESS OF SIGN-ON CARD      S0992500
         L     ML,MSOSAVE3         RESTORE RETURN REGISTER              S0993000
         SPACE 2                                                        S0993500
         LH    R0,$NUMRJE          R0 = MAX NUMBER OF REMOTES        R4 S0994000
         LR    R14,R0              R14 = MAX NUMBER OF REMOTES          S0994500
         L     WA,$RATABLE         GET ADDRESS OF RAT                R4 S0995000
         USING RATDSECT,WA                                              S0995500
         CLC   =C'REMOTE',15(R1)   REMOTE SPECIFIED?           @OZ25768 S0995600
         BE    MSOSERCH            BRANCH IF YES               @OZ25768 S0995700
         CLC   =C'RMT',15(R1)      RMT SPECIFIED?              @OZ25768 S0995800
         BE    MSOSERCT            BRANCH IF YES               @OZ25768 S0995900
         B     MSOILEGL            ILLEGAL SIGNON CARD         @OZ25768 S0995950
MSOSERCH CLC   RATNAME+3(3),21(R1) DOES RATNAME MATCH SIGN-ON CARD      S0996000
         BE    MSOFOUND            BRANCH IF YES                        S0996500
         LA    WA,RATTLE(,WA)      INCREMENT TO NEXT RAT ENTRY          S0997000
         BCT   R0,MSOSERCH         LOOP THROUGH ALL RAT ENTRIES         S0997500
         B     MSOILEGL            NO MATCH, SIGN-ON IS BAD             S0998000
MSOSERCT CLC   RATNAME+3(3),18(R1) ALTERNATE SIGN0N AREA GOOD  @OZ25768 S0998030
         BE    MSOFOUND            BRANCH IF YES               @OZ25768 S0998070
         SPACE 2                                                    R41 S0998100
         LA    WA,RATTLE(,WA)      INCREMENT TO NEXT RAT ENTRY @OZ25768 S0998110
         BCT   R0,MSOSERCT         LOOP THROUGH ALL RATS       @OZ25768 S0998150
         B     MSOILEGL            ILLEGAL SIGNON CARD         @OZ25768 S0998190
MSOFOUND TM    RATTYPE,DCTPSNA     TEST FOR SNA TERMINAL            R41 S0998200
         BO    MSOILEGL            BR IF YES, DISALLOW SIGNON       R41 S0998300
         EJECT                                                          S0998500
         TM    MDCTSTAT,DCTSHARE   TEST FOR SHARED SIGN ON           R4 S1000000
         BO    MSOSHARE            YES, BR - PROCESS SIGN-ON         R4 S1000500
         OC    RATLDCT,RATLDCT     CHECK FOR RMT ALREADY SIGNED ON   R4 S1001500
         BNZ   MSOILEGL            YES, BR -- SIGN-ON IS BAD         R4 S1002000
MSOSHARE SLR   R14,R0              R14 = REMOTE NUMBER - 1           R4 S1002500
         LR    R15,R14             MULTIPLY                             S1003000
         ALR   R15,R14              BY                                  S1003500
         ALR   R15,R14               THREE                              S1004000
         SLR   R14,R14             DIVIDE BY EIGHT GIVING OFFSETS       S1004500
         D     R14,=F'8'            TO BYTE (QUOT) AND BIT (REMAIN)     S1005000
         AL    R15,$RMTSON         R15 = BYTE ADDR OF SIGNON BITS    R4 S1005500
         L     R0,=A(QUEBUSY*X'2000')  GET BITS TO TEST BUSY            S1006000
         SRL   R0,0(R14)           SHIFT TO BIT OFFSET                  S1006500
         STH   R0,MSONWORK         STORE FOR TEST                       S1007000
         NC    MSONWORK,0(R15)     IS REMOTE SIGNED ON OTHER SYSTEM     S1007500
         BNZ   MSOILEGL            BRANCH IF YES, SIGN-ON IS BAD        S1008000
         SLR   R0,R0               GET BUSY BITS                        S1008500
         ICM   R0,4,$SIDBUSY        FOR THIS SYSTEM                     S1009000
         SRL   R0,3(R14)           SHIFT TO BIT OFFSET                  S1009500
         STH   R0,MSONWORK         STORE FOR SET                        S1010000
         TM    MDCTSTAT,DCTLEASE   TEST FOR LEASED-SIGN-ON (SHARED)  R4 S1011000
         BNO   MSONPSWD            NO, BR--PROCESS SIGN-ON           R4 S1011500
         CLM   MDCT,7,RATLDCT+1    TEST FOR VALID LINE USER          R4 S1012000
         BNE   MSOILEGL            NO, BR--SIGN-ON ILLEGAL           R4 S1012500
         SPACE 2                                                        S1013500
MSONPSWD CLI   MDCTPSWD,C' '       TEST LINE PASSWORD                R4 S1014000
         BE    *+14                BRANCH IF NONE                       S1014500
         CLC   MDCTPSWD,24(R1)     COMPARE WITH SIGN-ON CARD            S1015000
         BNE   MSOILPSW            BRANCH IF NOT EQUAL                  S1015500
         CLI   RATPSWD,C' '        TEST REMOTE PASSWORD                 S1016000
         BE    MSOPSWOK            BRANCH IF NONE                       S1016500
         CLC   RATPSWD,72(R1)      COMPARE WITH SIGN-ON CARD            S1017000
         BE    MSOPSWOK            BRANCH IF EQUAL                      S1017500
         MVC   24(8,R1),72(R1)     SAVE ILLEGAL PASSWORD                S1018000
MSOILPSW MVC   15(8,R1),RATNAME    SAVE STD FMT RMT NAME       @OZ53165 S1018500
         LR    WA,R1               SAVE SIGNON CARD ADDR       @OZ53165 S1018800
         L     R1,$MWORK           POINT TO WORK AREA                R4 S1019000
         MVC   0(L'MSOILPMS,R1),MSOILPMS  MOVE MSG TO WORK AREA      R4 S1019500
         MVC   6(3,R1),DCTDEVN+4   MOVE LINE NUMBER TO MESSAGE       R4 S1020000
        $WTO   (R1),L'MSOILPMS,JOB=NO,WAIT=NO,      ISSUE ERROR      R4CS1020500
               ROUTE=$LOG+$TP,CLASS=$NORMAL,PRI=$ST  MESSAGE            S1021000
         OI    DCTFLAGS,DCTRSTRT   FORCE LINE RESTART                   S1021500
         CLI   $NUMSMFB,2          CHECK SMF OPTIONS           @OZ27491 S1021600
         BL    MSORETRN            RETURN IF NO SMF REQUIRED   @OZ27491 S1021700
        $GETSMFB WAIT=NO           GET SMF BUFFER                       S1022000
         BZ    MSORETRN            BRANCH IF NONE AVAILABLE             S1022500
         USING SMFDSECT,R1                                              S1023000
         MVI   SMFHDRTY,SMFISETP   SET INTEGRITY RECORD TYPE            S1023500
         MVC   SMF49PSW,24(WA)     PUT ILLEGAL PASSWORD IN RECORD       S1024000
         MVC   SMF49RMT,15(WA)      AND REMOTE NAME            @OZ53165 S1024010
         B     MSOSMF              GO FINISH SMF RECORD                 S1024500
         EJECT                                                       R4 S1025000
MSOPSWOK OC    0(2,R15),MSONWORK   INDICATE REMOTE ON THIS SYSTEM       S1025500
         SPACE 2                                                        S1026000
         ST    MDCT,RATLDCT        STORE LINE DCT ADDRESS IN RAT        S1026500
         ST    WA,MDCTRAT          STORE RAT ADDRESS IN LINE DCT        S1027000
         LH    R15,RATBUFSZ        PICK UP BUFFER SIZE         @OZ50955 S1027500
         SH    R15,=H'5'           REDUCE TO FILL SIZE               R4 S1028000
         STH   R15,MDCTBFSZ        SET FILL AMOUNT                   R4 S1028500
         L     R15,RATRDCT         GET FIRST REMOTE DCT ADDRESS         S1029000
         ST    R15,MDCTDCT         STORE REMOTE ADDRESS IN LINE DCT     S1029500
         L     LINK,$MLLMPCE                  INITIALIZE             R4 S1030000
         MVC   MDCTIMOK,MCLOCK-PCEDSECT(LINK)  TRANSMISSION TIME     R4 S1030500
         OI    MDCTATTN,MDCTJOB    SIMULATE JOB POST                    S1031000
         SPACE 2                                                        S1031500
         MVC   $POSTSAV(1),MDCTLINE  GET LINE FEATURES               R4 S1032000
         TM    MDCTFEAT-DCTDSECT(R15),DCTPTRSP  TEST REMOTE TRSP        S1032500
         BO    *+8                      BRANCH IF REMOTE IS TRANSPARENT S1033000
         NI    $POSTSAV,255-DCTPTRSP  NO, RESET TRANSPARENCY         R4 S1033500
         NI    MDCTCODE+3,X'FB'    RESET TRANSPARENCY INDICATION        S1034000
         TM    $POSTSAV,DCTPTRSP   TEST REMOTE/LINE TRANSPARENCY     R4 S1034500
         BZ    *+8                 BRANCH IF BOTH ARE NOT TRANSPARENT   S1035000
         OI    MDCTCODE+3,X'04'    YES, SET TRANSPARENCY INDICATION     S1035500
         L     MCODE,MDCTCODE      GET ADDRESS OF CODE TABLE            S1036000
         SPACE 2                                                        S1036500
MSOLOOP  MVC   MDCTLINE-DCTDSECT(,R15),$POSTSAV  SET LINE FEATURES   R4 S1037000
         STCM  MDCT,7,DCTDCB+1-DCTDSECT(R15)  POINT RMT DCT TO LINE  R4 S1037500
         NI    MDCTSTAT-DCTDSECT(R15),DCTABORT    AND RESET             S1038000
         OI    MDCTSTAT-DCTDSECT(R15),DCTSINON  SET SIGN-ON FLAG        S1038500
         MVC   MDCTBFSZ-DCTDSECT(,R15),MDCTBFSZ COPY CPU FILL AMOUNT R4 S1039000
         L     R15,MDCTDCT-DCTDSECT(R15)     GET ADDRESS OF NEXT DCT    S1039500
         LTR   R15,R15             TEST FOR END OF CHAIN                S1040000
         BNZ   MSOLOOP             BRANCH IF NOT END OF CHAIN           S1040500
         SPACE 1                                                        S1041000
         LR    R0,R1               SAVE SIGN-ON CARD ADDRESS         R4 S1041500
         L     R1,$MWORK           POINT TO WORK AREA                R4 S1042000
         MVC   0(L'MSOMSG,R1),MSOMSG  MOVE MSG TO WORK AREA          R4 S1042500
         MVC   2(8,R1),RATNAME     PUT REMOTE ID AND LINE            R4 S1043000
         MVC   26(3,R1),DCTDEVN+4   NUMBERS INTO MESSAGE             R4 S1043500
         DROP WA                   KILL RAT ADDRESSABILITY           R4 S1044000
         LR    WA,R0               SAVE SIGN-ON CARD ADDRESS         R4 S1044500
        $WTO   (R1),L'MSOMSG,JOB=NO,WAIT=NO,  ISSUE SIGN-ON MESSAGE  R4CS1045000
               ROUTE=$LOG+$TP,CLASS=$NORMAL,PRI=$ST                     S1045500
         EJECT                                                          S1046000
         CLI   $NUMSMFB,2          CHECK SMF OPTIONS           @OZ27491 S1046100
         BL    MSONOSMF            RETURN IF NO SMF REQUIRED   @OZ27491 S1046200
        $GETSMFB WAIT=NO           GET SMF BUFFER                       S1046500
         BZ    MSONOSMF            BRANCH IF NONE AVAILABLE             S1047000
         MVI   SMFHDRTY,SMFSSETP   SET START EVENT RECORD TYPE          S1047500
MSOSMF   MVI   SMFRDW+1,SMF47END-SMFRDW  SET RECORD LENGTH              S1048000
         MVI   SMF47EVT+1,SMFRMTEV SET REMOTE EVENT TYPE                S1048500
         MVI   SMF47LN2+1,SMF47END-SMF47LN2  SET MESSAGE LENGTH         S1049000
         MVC   SMF47MSG,34(WA)     MESSAGE IS COLS 35-70 FROM CARD      S1049500
         BAL   WA,MSMF             GO FINISH SMF RECORD                 S1050000
         DROP  R1                                                       S1050500
         SPACE 2                                                        S1051000
MSONOSMF LA    WA,MSOEXIT          SET RETURN FROM TOTALING SUBRTN   R4 S1051500
MTOTLXCP SR    R1,R1               INDEX STARTS AT ZERO                 S1052000
         LA    LINK,4              INCREMENT OF 4                       S1052500
         LA    R15,MDCTSXCP-MDCTXCP-1  LOOP TERMINATION INDEX           S1053000
MTOTLOOP L     R0,MDCTXCP(R1)      GET LINE EXCP COUNT                  S1053500
         AL    R0,MDCTSXCP(R1)     ADD SESSION COUNT                    S1054000
         ST    R0,MDCTXCP(R1)      STORE NEW LINE COUNT                 S1054500
         BXLE  R1,LINK,MTOTLOOP    LOOP THROUGH ALL COUNTS              S1055000
         XC    MDCTSXCP(MDCTSREM-MDCTSXCP+L'MDCTSREM),MDCTSXCP       R4CS1055500
                                   ZERO ALL SESSION COUNTS           R4 S1056000
         BR    WA                  RETURN                            R4 S1056500
         SPACE 2                                                        S1057000
MSOEXIT  CLC   MDCTDCT+1(3),MSOSAVE1+1  COMPARE NEW & OLD DCTS       R4 S1057500
         L     MDCT,MSOSAVE1       RESTORE ADDRESS OF DCT               S1058000
         BNE   *+8                 BYPASS RESET IF DIFFERENT            S1058500
         NI    MDCTSTAT,255-DCTABORT  RESET ABORT INDICATION            S1059000
         LA    WA,IOBCCW1          SHOW NO CPU TEXT SENT                S1059500
         L     R0,IOBRESTR         SET UP                               S1060000
         IC    R1,MSEQTYPE          POSSIBLY NEW                        S1060500
         B     MCCWINIT              CCW SEQUENCE                       S1061000
         SPACE 2                                                        S1061500
MSOILEGL L     R1,$MWORK           POINT TO WORK AREA                R4 S1062000
         MVC   0(L'MSOILMSG,R1),MSOILMSG  MOVE MSG TO WORK AREA      R4 S1062500
         MVC   6(3,R1),DCTDEVN+4   MOVE LINE NUMBER TO MESSAGE       R4 S1063000
        $WTO   (R1),L'MSOILMSG,JOB=NO,WAIT=NO,  ISSUE ERROR MESSAGE  R4CS1063500
               ROUTE=$LOG+$TP,CLASS=$NORMAL,PRI=$ST                     S1064000
         SPACE 1                                                        S1064500
         OI    DCTFLAGS,DCTRSTRT   FORCE LINE RESTART                   S1065000
MSORETRN L     MDCT,MSOSAVE1       RESTORE ADDRESS OF DCT               S1065500
         LA    WA,IOBCCW1          SHOW NO CPU TEXT SENT                S1066000
         BR    ML                  RETURN                               S1066500
         EJECT                                                          S1067000
*                                                                       S1067500
*                             TRANSMISSION ABORT ROUTINE                S1068000
*                                                                       S1068500
         SPACE 1                                                        S1069000
MABORT   MVI   MDCTOPCT,0          RESET OPEN COUNT TO ZERO             S1069500
         MVI   MDCTCMCT,0          ZERO CONSOLE MESSAGE COUNT        R4 S1070000
         LA    R15,$MCONMSG        PREPARE TO SCAN MESSAGE QUEUE     R4 S1076000
MABCON   LR    R1,R15              SAVE ADDRESS OF PREVIOUS BUFFER   R4 S1076500
         L     R15,0(,R15)         GET ADDRESS OF NEXT BUFFER        R4 S1077000
         LTR   R0,R15              SAVE CURRENT BFR ADDRESS & TEST   R4 S1077500
         BZ    MABFREE             BRANCH IF BUFFER NOT FOUND        R4 S1078000
         TM    BUFTYPE-BUFDSECT(R15),BUFTP+BUFRPL  TEST BUFTYPE     R41 S1078500
         LA    R15,RPLNEXT-RPLDSECT(,R15)    ASSUME SNA CHAINING     R4 S1079000
         BO    MABCON              IF SNA -- TRY NEXT BUFFER        R41 S1079500
         SL    R15,=A((RPLNEXT-RPLDSECT)-(TPBLCCAD-BUFDSECT))          CS1080000
                                   ELSE USE BSC CHAINING             R4 S1080500
         CL    R0,DCTBUFAD         COMPARE WITH LINE BUFFER ADDRESS  R4 S1081000
         BNE   MABCON              CONTINUE SCAN IN NO MATCH         R4 S1081500
         L     R0,0(,R15)          DECHAIN BUFFER                    R4 S1082000
         ST    R0,0(,R1)             FROM CONSOLE MSG QUEUE          R4 S1082500
MABFREE  L     R1,MDCTOBUF         GET ADDRESS OF NEXT BUFFER QUEUED    S1083000
         LTR   R1,R1               TEST                                 S1083500
         BZ    MABFREED            BRANCH IF NO MORE BUFFERS ARE QUEUED S1084000
         TM    DCTSTAT,DCTDRAIN    OPERATOR DRAINING LINE            R4 S1084500
         BO    MABUDCHN            FREE BUFFERS IF YES               R4 S1085000
         TM    DCTFLAGS,DCTRSTRT   OPERATOR SAY RESTART              R4 S1085500
         BO    MABUDCHN            FREE BUFFERS IF YES               R4 S1086000
         OC    MDCTDCT,MDCTDCT     ANY REMOTES ATTACHED              R4 S1086500
         BZR   ML                  RETURN IF NOT                     R4 S1087000
MABUDCHN MVC   MDCTOBUF+1(3),BUFCHAIN+1-BUFDSECT(R1) DE-QUEUE BUFFER R4 S1087500
MABUFRE $FREEBUF (R1)              RETURN BUFFER TO POOL                S1088000
         B     MABFREE             GET NEXT BUFFER                      S1088500
         EJECT                                                       R4 S1089000
MABFREED NI    DCTFLAGS,255-DCTRSTRT INSURE RESTART BIT OFF          R4 S1089500
         LR    R1,MDCT             PREPARE TO SCAN REMOTE DCTS       R4 S1090000
MABPOST  L     R1,MDCTDCT-DCTDSECT(R1)  GET ADDRESS OF NEXT REMOTE DCT  S1090500
         LTR   R1,R1               TEST FOR END OF CHAIN                S1091000
         BCR   Z,ML                RETURN IF END OF CHAIN               S1091500
         TM    MDCTSTAT-DCTDSECT(R1),DCTPBUF  TEST FOR OUTPUT BUF       S1092000
         BZ    MABNOBUF            BRANCH IF NO OUTPUT BUFFER           S1092500
         NI    MDCTSTAT-DCTDSECT(R1),255-DCTPBUF  RESET STATUS          S1093000
         L     R1,DCTBUFAD-DCTDSECT(,R1)     GET ADDRESS OF BUFFER      S1093500
         B     MABUFRE             FREE BUFFER                          S1094000
         SPACE 1                                                        S1094500
MABNOBUF OI    DCTSTAT-DCTDSECT(R1),DCTHOLD  FORCE DCT UNAVAILABLE   R4 S1095000
         TM    DCTSTAT-DCTDSECT(R1),DCTINUSE TEST REMOTE DCT STATUS     S1095500
         BZ    MABPOST             BRANCH IF DCT IS NOT IN USE          S1096000
         MVI   MDCTSTAT-DCTDSECT(R1),DCTSINON+DCTABORT ABORT            S1096500
         OI    DCTFLAGS-DCTDSECT(R1),DCTRSTRT+DCTBKSP  RESTART JOB      S1097000
         NI    DCTFLAGS-DCTDSECT(R1),255-DCTSTOP  JUST IN CASE          S1097500
         L     R15,DCTPCE-DCTDSECT(R1)  GET ADDRESS OF ASSOCIATED PCE   S1098000
        $POST  (R15),(IO,WORK)     POST PROCESSOR FOR IO AND WORK       S1098500
         B     MABPOST             GET NEXT REMOTE DCT                  S1099000
         EJECT                                                          S1099500
*                                                                       S1100000
*                             REMOTE DISCONNECT ROUTINE                 S1100500
*                                                                       S1101000
         SPACE 2                                                    R41 S1101500
MDISCON  L     WA,MDCTDCT          GET ADDRESS OF REMOTE DCT            S1102000
         LTR   WA,WA               TEST                                 S1102500
         BCR   Z,ML                RETURN IF NOT SIGNED ON              S1103000
         SPACE 1                                                     R4 S1103500
MDSRESET OI    DCTSTAT-DCTDSECT(WA),DCTHOLD  SET REMOTE DCTHOLD      R4 S1104000
         TM    MDCTSTAT,DCTSHARE+DCTLEASE TEST LINE STATUS              S1105000
         BM    MDSNXRMT            IF LEASED, CHECK NEXT RMT DCT     R4 S1105500
         NI    MDCTSTAT-DCTDSECT(WA),255-DCTSINON  RESET SIGN-ON        S1108000
MDSNXRMT L     WA,MDCTDCT-DCTDSECT(,WA)  GET ADDR OF NEXT RMT DCT       S1108500
         LTR   WA,WA               TEST FOR END OF CHAIN                S1109000
         BNZ   MDSRESET            BRANCH IF NOT END OF CHAIN           S1109500
         TM    MDCTSTAT,DCTLEASE+DCTSHARE  TEST LINE DCT STATUS      R4 S1112000
         BMR   ML                  RETURN IF LEASED LINE             R4 S1112500
         CLI   PCEID+1,PCEMLMID    IF NOT LINE MANAGER,        @OZ32567 S1112600
         BNE   MDSCGO                 BR TO PROCESS DISCONNECT @OZ32567 S1112700
         OI    DCTFLAGS,DCTRSTRT   TURN ON RESTART IN CASE REQ @OZ32567 S1112800
         $QSUSE TYPE=TEST          TEST STATUS OF SHARED QUES  @OZ32567 S1112900
         BNZ   MREQBUF             IF NOT OWNED, REQUEUE BUFR  @OZ32567 S1113000
         NI    DCTFLAGS,255-DCTRSTRT  RESET RESTART IND        @OZ32567 S1113100
         SPACE 1                                                     R4 S1113500
MDSCGO   L     R1,MDCTDCT          SAVE RMT DCT ADDRESS        @OZ32567 S1114500
         XC    MDCTDCT,MDCTDCT     CLEAR ADDR OF RMT DCT IN LINE        S1115000
         L     WA,MDCTRAT          GET ADDRESS OF RAT                R4 S1116000
         L     R15,$MWORK          POINT TO WORK AREA                R4 S1116500
         MVC   0(L'MSFMSG,R15),MSFMSG MOVE MESSAGE TO WORK AREA      R4 S1117000
         MVC   2(8,R15),RATNAME-RATDSECT(WA) RMT ID TO MSG           R4 S1117500
         MVC   33(3,R15),DCTDEVN+4 INSERT LINE NUMBER INTO MESSAGE   R4 S1118000
         SPACE 1                                                    R41 S1125500
MDSRMT   DS    0H                                                    R4 S1126000
*              THIS LINE DELETED BY APAR NUMBER                @OZ32567 S1126500
         TM    MDCTSTAT,DCTSHARE   TEST FOR SHARED LINES             R4 S1127000
         BO    MDSRMTE             YES, SKIP CLEARING RAT LINE PTR   R4 S1127500
         XC    RATLDCT-RATDSECT(,WA),RATLDCT-RATDSECT(WA)  0 RATLDCT R4 S1128500
MDSRMTE  SL    WA,$RATABLE         WA = (RMT NUMBER - 1) * RATTLE    R4 S1129000
         LR    R15,WA              MULTIPLY                             S1129500
         ALR   R15,WA               BY                                  S1130000
         ALR   R15,WA                THREE                              S1130500
         SLR   R14,R14             DIVIDE BY 8*RATTLE GIVING OFFSET     S1131000
         D     R14,=A(RATTLE)       BY 8 GIVING OFFSET TO BIT        R4 S1131500
         D     R14,=A(8)             (REMAIN) AND BYTE (QUOT)        R4 S1132000
         AL    R15,$RMTSON         R15 = BYTE ADDR OF SIGNON BITS    R4 S1132500
         L     R0,=A(-QUEBUSY*X'2000'-1)  GET BITS TO CLEAR BUSY        S1133000
         SRL   R0,0(R14)           SHIFT TO BIT OFFSET                  S1133500
         STH   R0,MSONWORK         STORE FOR CLEAR                      S1134000
         NC    0(2,R15),MSONWORK   INDICATE REMOTE OFF SYSTEM           S1134500
         EJECT                                                       R4 S1135000
MDSWTO   L     R1,$MWORK           POINT TO WORK AREA                R4 S1135500
        $WTO   (R1),L'MSFMSG,JOB=NO,WAIT=NO,  ISSUE DISCONNECT       R4CS1136000
               ROUTE=$LOG+$TP,CLASS=$NORMAL,PRI=$ST  MESSAGE            S1136500
         CLI   $NUMSMFB,2          CHECK SMF OPTIONS           @OZ27491 S1138600
         BL    MDSNOSMF            RETURN IF NO SMF REQUIRED   @OZ27491 S1138700
        $GETSMFB WAIT=NO           GET SMF BUFFER                       S1139000
         BZ    MDSNOSMF            BRANCH IF NONE AVAILABLE             S1139500
         USING SMFDSECT,R1                                              S1140000
         MVI   SMF48EVT+1,SMFRMTEV SET REMOTE EVENT TYPE                S1140500
         LA    WA,MDSNOSMF         SET RETURN FROM SMF SUBROUTINE       S1141000
         SPACE 1                                                        S1141500
MSMF48   MVI   SMFRDW+1,SMF48END-SMFRDW  SET RECORD LENGTH              S1142000
         MVI   SMFHDRTY,SMFPSETP   SET STOP EVENT RECORD TYPE           S1142500
         MVC   SMF48CTR,MDCTCNTS   MOVE SESSION COUNT TO SMF RECORD  R4 S1143000
         L     R15,DCTDCB          GET LINE ADAPTER ADDRESS          R4 S1143500
         L     R15,DCBDEBAD-DCBDSECT(,R15)  FROM THE UCB             R4 S1144000
         L     R15,DEBSUCBA-DEBDSECT(,R15)   AND STORE IT IN         R4 S1144500
         MVC   SMF48ADP,UCBNAME-UCBDSECT(R15)  THE SMF RECORD        R4 S1145000
         B     SKIP210             SKIP                              R4 S1145500
         SPACE 1                                                     R4 S1146000
MSMF     MVI   SMF47LN1+1,SMF47LN2-SMF47LN1  SET ID SECTION LENGTH   R4 S1146500
SKIP210  MVI   SMFSSID+1,SMFHSPID  SET HASP SUBSYSTEM ID             R4 S1147000
         LH    R0,SMFRDW           COMPUTE AND STORE LENGTH OF          S1147500
         SH    R0,=Y(SMFSSTRT-SMFRDW)  THAT PORTION OF THE RECORD       S1148000
         STH   R0,SMFSSLEN          FOLLOWING THE SUBSYSTEM HDR         S1148500
         ICM   R15,15,MDCTRAT      ANYTHING CONNECTED                R4 S1149000
         BZ    *+10                SKIP IF NOT                          S1149500
         MVC   SMF48RMT,RATNAME-RATDSECT(R15) SET IDENTIFICATION     R4 S1150000
         MVC   SMF48LIN,DCTDEVN    SET LINE NAME IN RECORD              S1150500
         CLI   SMF48PSW,0          IS PASSWORD ALREADY SET              S1151000
         BNE   *+10                SKIP IF YES                          S1151500
         MVC   SMF48PSW,MDCTPSWD   SET PASSWORD FROM LINE               S1152000
        $QUESMFB                   QUEUE THE SMF RECORD FOR OUTPUT      S1152500
         DROP  R1                                                       S1153000
         BR    WA                  RETURN                               S1153500
MDSNOSMF XC    MDCTRAT,MDCTRAT     INDICATE NOTHING CONNECTED        R4 S1154000
*              THIS LINE DELETED BY APAR NUMBER                @OZ29941 S1154100
         BR    ML                  RETURN                               S1156000
         TITLE 'HASP BSC REMOTE TERMINAL CCW SETUP SUBROUTINE'       R4 S1156500
MCCWINIT DS    0H                  INITIALIZE CCW'S IN IOB              S1157000
         LA    MCODE,0(,MCODE)     CLEAR CONSOLE MSG COUNT          R41 S1157300
         ST    R0,IOBSTART         SET IOBSTART                         S1157500
         ST    R0,IOBRESTR          AND IOBRESTR                        S1158000
         XC    IOBCCW1,IOBCCW1     CLEAR FIRST CCW                      S1158500
         STC   R1,MSEQTYPE         STORE SEQUENCE TYPE                  S1159000
         NI    MSEQTYPE,X'F0'      CLEAR POSSIBLE COMMAND TYPE          S1159500
         MVC   IOBCCW2(7*8),IOBCCW1 PROPAGATE TO REST OF CCW'S          S1160000
         LA    R0,LCBMCB           R0 = ADDRESS OF MODE CONTROL BYTE    S1160500
         LA    R1,TPBUFST          R1 = ADDRESS OF FIRST DATA BYTE      S1161000
         TM    MSEQTYPE,MPREPSEQ   TEST SEQUENCE TYPE                   S1161500
         BZ    MCCWRDW             BRANCH IF NOT PREPARE SEQUENCE    R4 S1162000
         SPACE 3                                                     R4 S1162500
         TM    MDCTLINE,DCTPCTC    TEST LINE TYPE                    R4 S1163000
         BZ    MCCWBPRP            BRANCH IF NOT CTCA                R4 S1163500
         ST    R0,IOBCCW1          SET SENSE ADDRESS FOR CCW1        R4 S1164000
         LA    R0,MNAKSEQ          SET NAK                           R4 S1164500
         ST    R0,IOBCCW2           ADDRESS FOR CCW2                 R4 S1165000
         ST    R1,IOBCCW4          SET READ ADDRESS FOR CCW4         R4 S1165500
         OC    IOBCCW1(4*8),MCTCCCW  SETUP FOUR CCWS                 R4 S1166000
         MVI   IOBCCW1+4,X'20'     DECHAIN SENSE CCW1                R4 S1166500
         OI    IOBCCW2+5,MWENQCMD  INDICATE CCW2 POTENTIAL SOH-ENQ   R4 S1167000
         MVC   IOBCCW4+6(2),$BFSZBSC  SET READ LENGTH                R4 S1167500
         BR    ML                  RETURN                            R4 S1168000
         SPACE 2                                                     R4 S1168500
MCCWBPRP ST    R0,IOBCCW2          SET ADDRESS OF SET MODE CCW       R4 S1169000
         OC    IOBCCW1(3*8),MDISCCW SET UP FIRST THREE CCW'S            S1169500
         ST    MCODE,IOBCCW4       SET ADDRESS OF SYNCH CCW             S1170000
         LA    R0,MBSCENQ          R0 = ADDRESS OF ENQ CHARACTER        S1170500
         ST    R0,IOBCCW5          SET ADDRESS OF WRITE ENQUIRY CCW     S1171000
         OC    IOBCCW4(2*8),MWENQCCW    SET UP NEXT TWO CCW'S           S1171500
         MVI   IOBCCW5,X'03'       NOP ENQUIRY WRITE                 R4 S1172000
         ST    R1,IOBCCW6          SET ADDRESS OF READ CCW              S1172500
         OC    IOBCCW6,MREADCCW    SET UP LAST CCW                      S1173000
         MVC   IOBCCW6+6(2),$BFSZBSC  SET READ LENGTH                R4 S1173500
         BR    ML                  RETURN                               S1174000
         SPACE 2                                                     R4 S1174500
MCCWRDW  LA    R15,LCBRCB          R15 = ADDRESS OF RESPONSE FIELD   R4 S1175000
         TM    MDCTLINE,DCTPCTC    TEST LINE TYPE                    R4 S1175500
         BZ    MCCWBRDW            BRANCH IF NOT CTCA                R4 S1176000
         ST    R0,IOBCCW1          SET SENSE ADDRESS FOR CCW1        R4 S1176500
         ST    R15,IOBCCW2         SET RESPONSE ADDRESS FOR CCW2     R4 S1177000
         ST    R1,IOBCCW4          SET READ ADDRESS FOR CCW4         R4 S1177500
         OC    IOBCCW1(4*8),MCTCCCW  SETUP FIRST FOUR CCWS           R4 S1178000
         MVC   IOBCCW4+6(2),$BFSZBSC  SET READ LENGTH                R4 S1178500
         MVC   IOBCCW5(4*8),IOBCCW1  SETUP LAST FOUR CCWS            R4 S1179000
         OI    IOBCCW2+5,MWRSPCMD  INDICATE SENDING RESPONSE IN CCW2 R4 S1179500
         STCM  R1,7,IOBCCW6+1      SET WRITE ADDRESS IN CCW6         R4 S1180000
         OI    IOBCCW8+5,MWRITSEQ  INDICATE WRITE SEQUENCE IN CCW8   R4 S1180500
         BR    ML                  RETURN                            R4 S1181000
         EJECT                                                       R4 S1181500
MCCWBRDW OC    IOBCCW1,MENBCCW     SET UP FIRST CCW                     S1182000
         ST    MCODE,IOBCCW2       SET ADDRESS OF SYNCH CCW             S1182500
         TM    MSEQTYPE,MWRITSEQ   TEST SEQUENCE TYPE                   S1183000
         BZ    MCCWBSCR            BRANCH IF NOT WRITE                  S1183500
         SPACE 2                                                        S1184000
         LA    R0,MBSCENQ          R0 = ADDRESS OF ENQ CHARACTER        S1184500
         ST    R0,IOBCCW3          SET ADDRESS OF WRITE ENQUIRY CCW     S1185000
         ST    R15,IOBCCW4         SET ADDRESS OF READ RESPONSE CCW     S1185500
         B     MCCWBSCW            SET UP REST OF CCW'S                 S1186000
         SPACE 2                                                        S1186500
MCCWBSCR ST    R15,IOBCCW3         SET ADDRESS OF WRITE RESPONSE CCW    S1187000
         ST    R1,IOBCCW4          SET ADDRESS OF READ CCW              S1187500
         OC    IOBCCW2(3*8),MWRSPCCW SET UP NEXT THREE CCW'S            S1188000
         MVC   IOBCCW4+6(2),$BFSZBSC  SET READ LENGTH                R4 S1188500
         TM    $RJEOPTS,$ADDSYNS   TEST ADDITIONAL IDLES OPTION      R4 S1189000
         BZ    SKIP220             BR IF NOT SELECTED                R4 S1189500
         MVI   IOBCCW2,X'01'       ACTIVATE ENQUIRY WRITE            R4 S1190000
         MVI   IOBCCW2+4,X'A0'     SET DATA CHAINING                 R4 S1190500
SKIP220  TM    MSEQTYPE,MCPUSEQ    TEST SEQUENCE TYPE                   S1191000
         BCR   Z,ML                RETURN IF NOT PROGRAMMABLE INTERFACE S1191500
         SPACE 2                                                        S1192000
MCCWBSCW ST    MCODE,IOBCCW5       SET ADDRESS OF SYNCH CCW             S1192500
         ST    R1,IOBCCW6          SET ADDRESS OF WRITE CCW             S1193000
         MVC   IOBCCW6+4(1),MBSCCWCH SET CCW BYTE FOR PROPER CHAINING   S1193500
         LA    R0,METBSEQ          R0 = ADDRESS OF ETB SEQUENCE         S1194000
         ST    R0,IOBCCW7          SET ADDRESS OF WRITE ETB SEQUENCE    S1194500
         TM    MSEQTYPE,MCPUSEQ    TEST SEQUENCE TYPE                   S1195000
         BZ    MCCW27X0            BRANCH IF NOT PROGRAMMABLE INTERFACE S1195500
         SPACE 2                                                        S1196000
         OC    IOBCCW5(3*8),MWRITCCW SET UP NEXT THREE CCW'S            S1196500
         MVC   IOBCCW8,IOBCCW4     SET UP LAST CCW                      S1197000
         OI    IOBCCW8+5,MWRITSEQ  INDICATE WRITE TEXT SEQUENCE         S1197500
         TM    $RJEOPTS,$ADDSYNS   TEST ADDITIONAL IDLES OPTION      R4 S1198000
         BZR   ML                  RETURN IF NOT SELECTED            R4 S1198500
         MVI   IOBCCW5,X'01'       ACTIVATE ENQUIRY WRITE            R4 S1199000
         MVI   IOBCCW5+4,X'A0'     SET DATA CHAINING                 R4 S1199500
         BR    ML                  RETURN                               S1200000
         SPACE 2                                                        S1200500
MCCW27X0 DS    0H                  SET UP 2770/2780 WRITE CCW'S      R4 S1201000
         ST    R15,IOBCCW8         SET ADDRESS OF READ RESPONSE CCW  R4 S1201500
         OC    IOBCCW2(7*8),MWENQCCW SET UP LAST SEVEN CCW'S            S1202000
         TM    $RJEOPTS,$ADDSYNS   TEST ADDITIONAL IDLES OPTION      R4 S1202500
         BZR   ML                  RETURN IF NOT SELECTED            R4 S1203000
         MVI   IOBCCW2,X'01'       ACTIVATE ENQUIRY WRITE            R4 S1203500
         MVI   IOBCCW2+4,X'A0'     SET DATA CHAINING                 R4 S1204000
         MVI   IOBCCW5,X'01'       ACTIVATE ENQUIRY WRITE            R4 S1204500
         MVI   IOBCCW5+4,X'A0'     SET DATA CHAINING                 R4 S1205000
         BR    ML                  RETURN                               S1205500
         TITLE 'HASP BSC CPU INPUT/OUTPUT INTERFACE'                    S1206000
MINITIO  CLI   IOBECBCC,0          TEST INPUT BUFFER STATUS             S1206500
         BCR   NE,ML               RETURN IF INPUT BUFFER IS BUSY       S1207000
         SPACE 2                                                        S1207500
         TM    MDCTFCS,X'40'       TEST REMOTE FCS                      S1208000
         BO    MINITACK            BRANCH IF WAIT-A-BIT                 S1208500
         OC    MDCTOBUF+1(3),MDCTOBUF+1 TEST OUTPUT BUFFER CHAIN        S1209000
         BNZ   MINITWR             BRANCH IF BUFFER IS QUEUED           S1209500
         TM    MDCTSTAT,DCTPOST    MAY OUTPUT BE READY SOON             S1210000
         BZ    MINITDLY            BRANCH IF YES                     R4 S1210500
         SPACE 1                                                        S1211000
MINITACK CLI   TPBRECNT,C'E'       TEST INPUT BUFFER STATUS             S1211500
         BNE   MINITDLY            BRANCH IF INPUT BUFFER IS NOT EMPTY  S1212000
         MVC   LCBRCB,MACK0SEQ     SET UP                               S1212500
         LA    R1,IOBCCW2           ACK0 SEQUENCE                       S1213000
         TM    MDCTLINE,DCTPCTC    TEST LINE TYPE                    R4 S1213500
         BZ    MINITXCP            GO INITIATE I/O IF NOT CTCA       R4 S1214000
         LA    R1,IOBCCW1          START AT CCW1 FOR CTCA            R4 S1214500
         B     MINITXCP            INITIATE I/O                         S1215000
         SPACE 1                                                     R4 S1215500
MINITDLY MVC   LCBRCB,MACK0SEQ     SET UP ACK0 SEQUENCE                 S1216000
         LA    R1,IOBCCW2          SET UP ADDRESS OF                    S1216500
         TM    MDCTLINE,DCTPCTC     CCW2                             R4 S1217000
         BZ    SKIP230              OR, IF CTCA,                     R4 S1217500
MINITCDL LA    R1,IOBCCW1           CCW1 FOR                         R4 S1218000
SKIP230  ST    R1,IOBRESTR          RESTART CCW                         S1218500
         OI    MDCTATTN,MDCTIMER   INDICATE TIMED ACTION REQUESTED      S1219000
         L     R1,$MLLMPCE                    INDICATE $STIMER       R4 S1219500
         OI    MSTQE+IPOST-PCEDSECT(R1),X'20'  REQUESTED             R4 S1220000
         BR    ML                  RETURN                               S1220500
         SPACE 2                                                     R4 S1221000
MINITWR  L     R15,MDCTOBUF        GET ADDRESS OF OUTPUT BUFFER         S1221500
         MVC   IOBCCW6,IOBCCW6-BUFDSECT(R15) SET UP WRITE TEXT CCW      S1222000
         MVC   TPBUFST+3-BUFDSECT(2,R15),MBASEFCS PRESET FCS            S1222500
         LA    R1,IOBCCW5          SET FOR WRITE TEXT                   S1223000
         CLI   TPBRECNT,C'E'       TEST INPUT BUFFER STATUS             S1223500
         BE    MINITXCP            BRANCH IF INPUT BUFFER IS EMPTY      S1224000
         TM    MDCTLINE,DCTPCTC    TEST LINE TYPE                    R4 S1224500
         BO    MINITWTC            SET UP CTC WAIT-A-BIT             R4 S1225000
         SPACE 1                                                        S1225500
         MVC   IOBCCW2(4*8),IOBCCW5     MOVE CCW'S                      S1226000
         LA    R1,IOBCCW7          USE CCW AREA                         S1226500
         ST    R1,IOBCCW5          SET ADDRESS OF READ CCW              S1227000
         MVI   IOBCCW5,X'02'       SET READ CCW                         S1227500
         MVC   IOBCCW5+5(3),MWABTEXT    SET COMMAND TYPE AND BYTE COUNT S1228000
         OI    TPBUFST+3-BUFDSECT(R15),X'40' SET WAIT-A-BIT             S1228500
         LA    R1,IOBCCW2          SET FOR WRITE WABT TEXT              S1229000
         SPACE 2                                                        S1229500
MINITXCP ST    R1,IOBSTART         SET IOBSTART                         S1230000
         ST    R1,IOBRESTR          AND IOBRESTR                        S1230500
         B     MERREXCP            INITIATE I/O                         S1231000
         TITLE 'HASP BSC REMOTE TERMINAL INPUT/OUTPUT INTERFACE'     R4 S1231500
MINITWTC MVC   IOBCCW2(8),IOBCCW6  MOVE WRITE CCW                    R4 S1232000
         LA    R1,IOBCCW7          USE CCW FOR                       R4 S1232500
         ST    R1,IOBCCW4          SHORT READ                        R4 S1233000
         MVI   IOBCCW4,X'02'       SET READ OP-CODE                  R4 S1233500
         MVC   IOBCCW4+5(3),MWABTEXT SET CCW ID AND READ COUNT       R4 S1234000
         OI    TPBUFST+3-BUFDSECT(R15),X'40' SET WAIT-A-BIT          R4 S1234500
         LA    R1,IOBCCW1          SET START OF CCWS                 R4 S1235000
         B     MINITXCP            INITIATE I/O                      R4 S1235500
         SPACE 2                                                     R4 S1236000
MEXCP    DS    0H                                              @OZ28291 S1236500
         LR    R15,MDCT            SAVE DCT ADDR FOR ASCII     @OZ28291 S1236600
         L     MDCT,DCTDCB         GET ADDR OF LINE DCT        @OZ28291 S1236700
MEXCPNXT DS    0H                                                    R4 S1237000
         XC    LCBACK,MBSCACKX     INVERT ACK TO SEND OR EXPECT         S1237500
         MVC   LCBRCB(1),MBSCDLE   SET UP                               S1238000
         MVC   LCBRCB+1(1),LCBACK   RESPONSE                            S1238500
         SPACE 1                                                        S1239000
         TM    MDCTLINE,DCTPASCI   TEST CODE TYPE                       S1239500
         BZ    MEXCP1              BRANCH IF EBCDIC                     S1240000
         TM    MSEQTYPE,MWRITSEQ   TEST SEQUENCE TYPE                R4 S1240500
         BZ    MEXCP1              BRANCH IF NOT WRITE SEQUENCE      R4 S1241000
         SPACE 1                                                        S1241500
         LA    R14,TPBUFST         LOCATE START OF RJE BUFFER DATA   R4 S1242000
         LH    R1,$BFSZBSC         OBTAIN RJE BUFFER DATA LENGTH     R4 S1242500
         CLI   IOBCCW6,X'08'       TIC TO DATA AREA?           @OZ28291 S1242600
         BNE   MEXCPTR1            NO?,BRANCH                  @OZ28291 S1242650
         LA    R14,TPBUFST+36      INIT DATA ADDR FOR 2780     @OZ28291 S1242700
         CLI   MDCTTYPE-DCTDSECT(R15),DCTP2780 TEST TERM TYPE  @OZ28291 S1242750
         BNL   MEXCPTR1            BRANCH IF NOT 2770          @OZ28291 S1242800
         LA    R14,TPBUFST+12      INIT DATA ADDR FOR 2770     @OZ28291 S1242850
         SPACE 1                                                     R4 S1243000
MEXCPTR1 CH    R1,=H'256'          IF REMAINING LENGTH NOT GT 256,   R4 S1243500
         BNH   MEXCPTR3             BR TO FINISH TRANSLATION         R4 S1244000
         TR    0(256,R14),MBPASCII   ELSE TRANSLATE 256 BYTES        R4 S1244500
         LA    R14,256(,R14)       THEN UPDATE BUFFER ADDRESS,       R4 S1245000
         SH    R1,=H'256'           REDUCE BUFFER LENGTH,            R4 S1245500
         B     MEXCPTR1              AND BR TO CONTINUE TRANSLATION  R4 S1246000
         SPACE 1                                                     R4 S1246500
MEXCPTR2 TR    0(*-*,R14),MBPASCII *** EXECUTE ONLY ***              R4 S1247000
         SPACE 1                                                     R4 S1247500
MEXCPTR3 BCTR  R1,0                REDUCE LENGTH FOR EXECUTE         R4 S1248000
         EX    R1,MEXCPTR2         TRANSLATE TO END OF BUFFER        R4 S1248500
         SPACE 1                                                     R4 S1249000
MERREXCP TM    MSEQTYPE,MBSCSEQ+MCPUSEQ  TEST SEQUENCE TYPE          R4 S1249500
         BNO   MEXCP1              BRANCH IF NOT BSC CPU SEQUENCE       S1250000
         SPACE 1                                                        S1250500
         TM    MDCTLINE,DCTPWIDE   TEST LINE TYPE                       S1251000
         BZ    MBCEXCP             BRANCH IF NOT WIDE BAND              S1251500
         L     R1,MDCTDCT          GET ADDRESS OF REMOTE DCT            S1252000
         CLI   MDCTTYPE-DCTDSECT(R1),DCTP20S2 TEST TERMINAL TYPE     R4 S1252500
         BNE   MBCEXCP             BRANCH IF NOT 360/20 SUB-MODEL 2  R4 S1253000
         EJECT                                                       R4 S1253500
         L     R14,$MWORK          POINT TO WORK AREA                R4 S1254000
         STCK  0(R14)              GET                               R4 S1254500
         LM    R0,R1,0(R14)         TIME                             R4 S1255000
         AL    R1,$DELAYTM         ADD MODEL 20 DELAY TIME           R4 S1255500
         BC    12,*+8              BRANCH IF NO OVERFLOW                S1256000
         AL    R0,=F'1'            PROPAGATE OVERFLOW INTO R0           S1256500
         STM   R0,R1,0(R14)        SAVE UPDATED TIME                 R4 S1257000
         STCK  8(R14)              GET NEW TIME                      R4 S1257500
         CLC   0(8,R14),8(R14)     COMPARE WITH LIMIT                R4 S1258000
         BH    *-10                DELAY...                             S1258500
         SPACE 2                                                     R4 S1259000
MBCEXCP  L     R1,IOBSTART         GET ADDRESS OF FIRST CCW             S1259500
         TM    4(R1),X'C0'         LAST CCW OF CHAIN                R41 S1259700
         BZ    MEXCP1              BRANCH IF END OF CCWS            R41 S1259800
         CLI   13(R1),MBSCSEQ+MCPUSEQ+MWRITCMD  TEST COMMAND TYPE    R4 S1260000
         BNE   MEXCP1              BRANCH IF NOT BSC CPU WRITE TEXT     S1260500
         SPACE 1                                                        S1261000
         L     R1,8(R1)            GET ADDRESS OF TEXT                  S1261500
         TM    2(R1),X'B0'         TEST BLOCK CONTROL BYTE              S1262000
         BNZ   MEXCP1              BRANCH IF SET, IGNORE, OR RETRY      S1262500
         SPACE 1                                                        S1263000
         MVN   2(1,R1),MDCTTSEQ    SET TRANSMIT BLOCK SEQUENCE COUNT    S1263500
         OI    2(R1),X'80'         SET HIGH-ORDER BIT                   S1264000
         IC    R1,MDCTTSEQ         INCREMENT TRANSMIT                   S1264500
         LA    R1,1(R1)             BLOCK SEQUENCE                      S1265000
         STC   R1,MDCTTSEQ           COUNT                              S1265500
         SPACE 1                                                        S1266000
MEXCP1   CLI   DCTBUFCT,0          TEST ACTIVE I/O COUNT                S1266500
         BNE   M02                 ERROR IF NOT ZERO                    S1267000
         NI    MDCTATTN,255-MDCTIMER-MDCTPAWS     RESET TIMER REQUESTS  S1267500
         MVI   IOBXTENT,0          INSURE EXTENT BYTE IS CLEAR          S1268000
        $EXCP  (MDCT)              INITIATE I/O                         S1268500
         BR    ML                  RETURN                               S1269000
         SPACE 1                                                        S1269500
M02     $ERROR                     LINE I/O SYNCHRONIZATION ERROR       S1270000
         TITLE 'HASP BSC REMOTE TERMINAL CCW SKELETONS'              R4 S1270500
*********************************************************************** S1271000
*                                                                     * S1271500
*        HASP REMOTE TERMINAL CCW SKELETONS FOR BSC                   * S1272000
*                                                                     * S1272500
*********************************************************************** S1273000
         SPACE 3                                                     R4 S1273500
MDISCCW  $CCW  X'2F',0,X'60',1,MDISCMD       BSC DISABLE COMMAND     R4 S1274000
         $CCW  X'23',*-*,X'60',1,MSETMCMD    BSC SET MODE COMMAND    R4 S1274500
MENBCCW  $CCW  X'27',0,X'60',1,MENBCMD       BSC ENABLE COMMAND      R4 S1275000
         SPACE 2                                                     R4 S1275500
MWRSPCCW $CCW  X'03',*-*,X'60',4,MWRSPCMD  BSC SYNCH COMMAND         R4 S1276000
         $CCW  X'01',*-*,X'60',2,MWRSPCMD    BSC WRITE RESPONSE COMMAND S1276500
MREADCCW $CCW  X'02',*-*,X'20',*-*,MREADCMD  BSC READ TEXT COMMAND   R4 S1277000
         SPACE 2                                                     R4 S1277500
MWENQCCW $CCW  X'03',*-*,X'60',4,MWENQCMD  BSC SYNCH COMMAND         R4 S1278000
         $CCW  X'01',*-*,X'60',1,MWENQCMD    BSC WRITE ENQUIRY COMMAND  S1278500
         $CCW  X'02',*-*,X'20',2,MRREQCMD  BSC READ RESPONSE TO ENQUIRY S1279000
MWRITCCW $CCW  X'03',*-*,X'60',4,MWRITCMD  BSC SYNCH COMMAND         R4 S1279500
         $CCW  X'01',*-*,*-*,*-*,MWRITCMD    BSC WRITE TEXT COMMAND  R4 S1280000
         $CCW  X'01',*-*,X'60',2,MWRITCMD    BSC WRITE ETB COMMAND   R4 S1280500
         $CCW  X'02',*-*,X'20',2,MRRSPCMD    BSC READ RESPONSE TO TEXT  S1281000
         SPACE 2                                                     R4 S1281500
MCTCCCW  $CCW  X'14',*-*,X'60',1,MENBCMD  CTC SENSE ENDS OTHER CNTRL R4 S1282000
         $CCW  X'01',*-*,X'60',2,MWRITCMD  CTC WRITE COMMAND         R4 S1282500
         $CCW  X'07',0,X'60',1,MPREPCMD  CTC CONTROL WAITS FOR SENSE R4 S1283000
         $CCW  X'02',*-*,X'20',*-*,MREADCMD  CTC READ COMMAND        R4 S1283500
         TITLE 'HASP BSC REMOTE TERMINAL CODE TABLES'                R4 S1284000
MCODSECT DSECT                     DEFINE CODE TABLE DSECT           R4 S1284500
MBSCSYN  DS    2XL4                SYNCHRONOUS IDLE CHARACTERS       R4 S1285000
MBSCSOH  DS    0X                  START OF HEADER CHARACTER         R4 S1285500
MSOHSTX  DS    XL2                 NON-TRANSPARENT START OF TEXT SEQ R4 S1286000
MBSCDLE  DS    0X                  DATA LINK ESCAPE CHARACTER        R4 S1286500
MDLESTX  DS    XL2,XL4             TRANSPARENT START OF TEXT SEQUENCE   S1287000
MSOHENQ  DS    XL2                 MULTI-LEAVING SIGN-ON SEQUENCE    R4 S1287500
MSTXSEQ  DS    0XL2,X              START OF TEXT SEQUENCE            R4 S1288000
MBSCSTX  DS    X,XL4               START OF TEXT CHARACTER           R4 S1288500
METBSEQ  DS    0XL2,X              END OF TEXT BLOCK SEQUENCE        R4 S1289000
MBSCETB  DS    X                   END OF TEXT BLOCK CHARACTER       R4 S1289500
METXSEQ  DS    0XL2,X              END OF TEXT SEQUENCE              R4 S1290000
MBSCETX  DS    X,XL4               END OF TEXT CHARACTER             R4 S1290500
MACK0SEQ DS    0XL2,X              EVEN ACKNOWLEDGEMENT SEQUENCE     R4 S1291000
MBSCACK0 DS    X                   EVEN ACKNOWLEDGEMENT CHARACTER    R4 S1291500
MACK1SEQ DS    0XL2,X              ODD ACKNOWLEDGEMENT SEQUENCE      R4 S1292000
MBSCACK1 DS    X,XL4               ODD ACKNOWLEDGEMENT CHARACTER     R4 S1292500
MNAKSEQ  DS    0XL2,X              NEGATIVE ACKNOWLEDGEMENT SEQUENCE R4 S1293000
MBSCNAK  DS    X                   NEGATIVE ACKNOWLEDGEMENT CHARACTER   S1293500
MBSCACKX DS    X                   ACKNOWLEDGEMENT CONVERSION CHARACTER S1294000
MBSCCWCH DS    X,XL4               CCW CHAINING CHARACTER            R4 S1294500
MBSCENQ  DS    X                   ENQUIRY CHARACTER                 R4 S1295000
MDLEEOT  DS    0XL2,X              DISCONNECT SEQUENCE               R4 S1295500
MBSCEOT  DS    X                   END OF TRANSMISSION CHARACTER     R4 S1296000
MBSCWACK DS    X,XL4               WAIT BEFORE TRANSMIT              R4 S1296500
HASPRTAM CSECT                                                       R4 S1297000
         SPACE 3                                                     R4 S1297500
MEBCDIC  DS    0D                  EBCDIC CODE TABLE                 R4 S1298000
         DC    X'3232323232323232'                                   R4 S1298500
         DC    X'0102100201021002'                                   R4 S1299000
         DC    X'012D0102012D1002'                                   R4 S1299500
         DC    X'3226320310261003'                                   R4 S1300000
         DC    X'1070106110701061'                                   R4 S1300500
         DC    X'323D11A0323D1160'                                   R4 S1301000
         DC    X'2D10376B2D10376B'                                   R4 S1301500
         SPACE 3                                                     R4 S1302000
MUSASCII DS    0D                  USASCII CODE TABLE                R4 S1302500
         DC    X'1616161616161616'                                   R4 S1303000
         DC    X'0102100201021002'                                   R4 S1303500
         DC    X'0105010201051002'                                   R4 S1304000
         DC    X'1617160310171003'                                   R4 S1304500
         DC    X'1030103110301031'                                   R4 S1305000
         DC    X'161501A016150160'                                   R4 S1305500
         DC    X'0510043B0510043B'                                   R4 S1306000
         TITLE 'HASP BSC REMOTE TERMINAL CONSTANTS/MESSAGES'         R4 S1306500
MSAVE    EQU   $MSAVE              GENERAL REGISTER SAVE AREA        R4 S1307000
MSOSAVE1 EQU   MSAVE+8             SIGN-ON REGISTER SAVE AREA       R41 S1307500
MSOSAVE2 EQU   MSAVE+12            SIGN-ON REGISTER SAVE AREA       R41 S1308000
MSOSAVE3 EQU   MSAVE+16            SIGN-ON REGISTER SAVE AREA       R41 S1308500
MFCON31  DC    F'31'               COMPRESSION/DECOMPRESSION CONSTANT   S1309000
MFCON63  DC    F'63'               COMPRESSION/DECOMPRESSION CONSTANT   S1309500
MBCPEOB  DC    X'00800000'         BSC END OF OUTPUT BUFFER SEQUENCE R4 S1310000
MTEMPSAV EQU   $POSTSAV            TEMPORARY REGISTER SAVE AREA      R4 S1310500
MBASEFCS DC    X'8FCF'             BASIC FUNCTION CONTROL SEQUENCE   R4 S1311000
*                             WAIT-A-BIT WITH TEXT SEQUENCE          R4 S1311500
MWABTEXT DC    AL1(MBSCSEQ+MWRITSEQ+MCPUSEQ+MRRSPCMD,0,16)           R4 S1312000
*                             WAIT-A-BIT SEQUENCE                    R4 S1312500
MWABTSEQ DC    AL1(MBSCSEQ+MCPUSEQ+MRRSPCMD,0,16),X'000090CFCF00'    R4 S1313000
MBPUNSEL DC    AL1(MBCDSTX,MBCDESC,C'4')     2780 PUNCH SELECT       R4 S1313500
MBHTREC  DC    AL1(MBCDESC,MBCDHT,C' ') 2770/2780 TAB INITIALIZATION R4 S1314000
*                                  2780 PUNCH CONTROL CHARACTERS     R4 S1314500
MBHPUNCC DC    AL1(MBCDDLE,MBCDITB,MBCDSYN,MBCDSYN,MBCDDLE,MBCDSTX)  R4 S1315000
MB2770CD DC    0F'0',X'83000001'   2770 OUTPUT OPEN CONSTANT         R4 S1315500
*                                                                    R4 S1316000
MSONWORK EQU   $SONWORK            SIGN-ON WORK SPACE                R4 S1316500
MSONCODE DC    CL9'/*SIGNON'       SIGN-ON CODE                      R4 S1317000
MSOMSG   $MSG  200,'XXXXXXXX STARTED ON LINEMMM'  SIGN-ON MESSAGE    R4 S1317500
MSOFCODE DC    CL10'/*SIGNOFF'     SIGN-OFF CODE                     R4 S1318000
MSFMSG  $MSG   203,'XXXXXXXX DISCONNECTED FROM LINEMMM' DISC MSG     R4 S1318500
MSOILPMS $MSG  201,'LINEMMM -- INVALID PASSWORD'  BAD PASSWORD MSG   R4 S1319000
MSOILMSG $MSG  202,'LINEMMM -- INVALID SIGN-ON'  BAD SIGN-ON MSG     R4 S1319500
MCDISCON DC    0CL27' ',X'900000F0C2D3'  CPU DISCONNECT              R4 S1320000
         DC    C'REMOTE DISCONNECTED',X'0000'  MESSAGE               R4 S1320500
         EJECT                                                       R4 S1321000
         SPACE 5                                                     R4 S1321500
         LTORG                                                       R4 S1322000
         TITLE 'HASP BSC REMOTE TERMINAL TRANSLATE TABLES'           R4 S1322500
MBPUTRAN TR    0(*-*,R1),MBSCTRAN  BSC TRANSLATE INSTRUCTION         R4 S1323000
         SPACE 2                                                     R4 S1323500
MBSCTRAN DS    0D            ILLEGAL BSC TO X'40' TRANSLATE    @OZ56074 S1324000
*                                                                    R4 S1324500
*                X0X1X2X3X4X5X6X7X8X9XAXBXCXDXEXF                   R41 S1325000
*                                                                   R41 S1325100
         DC    X'404040404005064040090A0B0C404040'  0X         @OZ56074 S1325200
         DC    X'404040404040164040401A4040404040'  1X         @OZ56074 S1325300
         DC    X'404040234025404040402A404040402F'  2X         @OZ56074 S1325400
         DC    X'404040334040364038393A4040404040'  3X         @OZ56074 S1325500
         DC    192AL1(*-MBSCTRAN)                   4X-FX           R41 S1325600
         SPACE 5                                                     R4 S1325700
MBGASCII DS    0D             USASCII TO EBCDIC TRANSLATE TABLE      R4 S1326000
*                                                                    R4 S1326500
*                X0X1X2X3X4X5X6X7X8X9XAXBXCXDXEXF                    R4 S1327000
*                                                                    R4 S1327500
         DC    X'00010203372D2E2F1605150B0C0D0E0F'  0X               R4 S1328000
         DC    X'101112133C3D322618193F271C1D1E1F'  1X               R4 S1328500
         DC    X'405A7F7B5B6C507D4D5D5C4E6B604B61'  2X               R4 S1329000
         DC    X'F0F1F2F3F4F5F6F7F8F97A5E4C7E6E6F'  3X               R4 S1329500
         DC    X'7CC1C2C3C4C5C6C7C8C9D1D2D3D4D5D6'  4X               R4 S1330000
         DC    X'D7D8D9E2E3E4E5E6E7E8E9BBBCBDBE6D'  5X               R4 S1330500
         DC    X'E0818283848586878889919293949596'  6X               R4 S1331000
         DC    X'979899A2A3A4A5A6A7A8A9FB5FFDFE07'  7X               R4 S1331500
         SPACE 5                                                     R4 S1332000
MBPASCII DS    0D             EBCDIC TO USASCII TRANSLATE TABLE      R4 S1332500
*                                                                    R4 S1333000
*                X0X1X2X3X4X5X6X7X8X9XAXBXCXDXEXF                    R4 S1333500
*                                                                    R4 S1334000
         DC    X'000102030009007F0000000B0C0D0E0F'  0X               R4 S1334500
         DC    X'10111213000A0800181900001C1D1E1F'  1X               R4 S1335000
         DC    X'00000000000A171B0000000000050607'  2X               R4 S1335500
         DC    X'0000160000000004000000001415001A'  3X               R4 S1336000
         DC    X'20414243444546474849002E3C282B00'  4X               R4 S1336500
         DC    X'264A4B4C4D000000000021242A293B7C'  5X               R4 S1337000
         DC    X'2D2F5253000000000000002C255F3E3F'  6X               R4 S1337500
         DC    X'000000003400000000003A2340273D22'  7X               R4 S1338000
         DC    X'00616263646566676869000000000000'  8X               R4 S1338500
         DC    X'006A6B6C6D6E6F707172000000000000'  9X               R4 S1339000
         DC    X'0000737475767778797A000000000000'  AX               R4 S1339500
         DC    X'00000000000000000000005B5C5D5E00'  BX               R4 S1340000
         DC    X'00414243444546474849000000000000'  CX               R4 S1340500
         DC    X'004A4B4C4D4E4F505152000000000000'  DX               R4 S1341000
         DC    X'6051535455565758595A000000000000'  EX               R4 S1341500
         DC    X'30313233343536373839007B007D7E00'  FX               R4 S1342000
         TITLE 'HASP BSC REMOTE TERMINAL CARRIAGE CONTROL TABLES'    R4 S1342500
         SPACE 5                                                     R4 S1343000
MP27X0CC DS    0D             2770/2780 CARRIAGE CONTROL CHARACTERS  R4 S1343500
*                                                                    R4 S1344000
         DC    C'M/ST//////////A/'                                   R4 S1344500
         DC    C'/ABCDEFGHIJKL///'                                   R4 S1345000
         DC    C'//ST//////////A4'                                   R4 S1345500
         DC    C'/ABCDEFGH///////'                                   R4 S1346000
         SPACE 5                                                     R4 S1346500
M27X0TRT DC    XL256'00'      2770/2780 TERMINATOR SEARCH TABLE      R4 S1347000
         ORG   M27X0TRT+MBCDNL                                       R4 S1347500
         DC    AL1(MBCDNL)         NEW LINE CHARACTER                R4 S1348000
         ORG   M27X0TRT+MBCDIRS                                      R4 S1348500
         DC    AL1(MBCDIRS)        INTER-RECORD CHARACTER            R4 S1349000
         ORG   M27X0TRT+MBCDIGS                                      R4 S1349500
         DC    AL1(MBCDIGS)        IGS CHARACTER                     R4 S1350000
         ORG   M27X0TRT+MBCDEM                                       R4 S1350500
         DC    AL1(MBCDEM)         END-OF-MEDIUM CHARACTER           R4 S1351000
         ORG   M27X0TRT+256                                          R4 S1351500
         SPACE 2                                                     R4 S1352000
         DROP  MBASE1,MBASE2,MBASE3  DROP RTAM ADDRESSABILITY       R41 S1352500
         TITLE 'HASP SNA REMOTE TERMINAL OPEN ROUTINE'               R4 S1353000
*                                                                    R4 S1353500
*                             VTAM OPEN PROCESSING                   R4 S1354000
*                                                                    R4 S1354500
         SPACE 2                                                     R4 S1355000
*                                  ADDRESSABILITY --                R41 S1355100
         USING ICEDSECT,MICE             -- ICE                     R41 S1355500
         USING RPLDSECT,MBUF             -- RPL                     R41 S1356000
         USING RTAMVSUB,MBASE2,MBASE3    -- COMMON SNA SUBROUTINES  R41 S1356500
         SPACE 5                                                    R41 S1356600
         USING RTAMVOPE,MBASE1     ESTABLISH SNA OPEN ADDRESSABILITY R4 S1357000
RTAMVOPE DS    0H                  ENTRY POINT FOR RTAM SNA OPEN     R4 S1358000
         TM    MDCTSEL,DCTPOUTB    TEST DIRECTION BIT                R4 S1360500
         BZ    MVOINBND            IF INBOUND GO TO INBOUND OPEN     R4 S1361000
         SPACE 1                                                     R4 S1361500
*                             VTAM OPEN FOR OUTPUT                   R4 S1362000
         SPACE 1                                                     R4 S1362500
         TM    ICESTAT,ICEALLOC    TEST PRE-ALLOCATED ICE STATUS     R4 S1363000
         BZ    MVOOUTBD            TRY OPEN IF ICE STILL AVAILABLE  R41 S1363500
         CL    MDCT,ICERDCT        ELSE CHECK WHICH DCT ACTIVE      R41 S1363600
         BNE   MVTAMXAB            FAIL OPEN IF ANOTHER DCT HAS ICE R41 S1363700
         SPACE 1                                                    R41 S1363800
MVOOUTBD OI    DCTPPSW,DCTPPSWC    FORCE PRPU FCB LOAD         @OZ29556 S1364000
         BAL   ML,MVRPLGET         GET OUTPUT BUF FOR BDS      @OZ29556 S1364200
         OI    ICESNDST,ICEOCPND   SET END CHN TO FORCE FMH SEND NOW R4 S1364500
         BAL   ML,MVFMHBDS         BUILD, SEND, & GET +RSP TO BDS    R4 S1365000
         B     MVTAMXIT            RETURN TO CALLER                  R4 S1365500
         SPACE 3                                                     R4 S1366000
*                             VTAM OPEN FOR INPUT                    R4 S1366500
         SPACE 1                                                     R4 S1367000
MVOINBND LTR   MBUF,MBUF           TEST BUFFER ADDRESS               R4 S1367500
         BZ    MVTAMXAB            OPEN HAS TIMED OUT IF NONE--FAIL  R4 S1368000
         L     R1,RPLRLEN          GET LENGTH OF UNUSED PART OF R.U. R4 S1368500
         LA    ML,MVTAMXIT         POINT TO EXIT ROUTINE             R4 S1369000
         LTR   R1,R1               TEST R.U. LENGTH                  R4 S1369500
         BPR   ML                  RETURN IF NOT ZERO, LEAVE BUFFER    CS1370000
                                    FOR 'GET' TO PROCESS AND FREE    R4 S1370500
         B     MVRELBUF            OTHERWISE FREE BUFFER NOW & EXIT  R4 S1371000
         TITLE 'HASP SNA REMOTE TERMINAL GET ROUTINE'                R4 S1378500
*********************************************************************** S1379000
*                                                                     * S1379100
* SNA GET                                                             * S1379200
*                                                                     * S1379300
*                                                                     * S1379400
* REGISTER USAGE                                                      * S1379500
*                                                                     * S1379600
* RTC          R0                  TRANSPARENCY COUNT REMAINING       * S1379700
*              R1                  WORK REGISTER                      * S1379800
*              R2                  WORK REGISTER                      * S1379900
* RSC/MDCT     R3                  SCB COUNT REMAINING                * S1380000
* MBUF         R4                  RPL ADDRESS                        * S1380100
* RDP/MICE     R5                  DECOMPRESSED STRING POINTER        * S1380200
* RPC/ML       R6                  PROCESSOR BUFFER COUNT REMAINING   * S1380300
* MBASE1       R7                  SNA GET BASE ADDRESS               * S1380400
* MBASE2       R8                  SNA SUBROUTINES BASE ADDRESS       * S1380500
*              R9                   - NOT USED -                      * S1380600
* JCT          R10                 JCT ADDRESS                        * S1380700
* BASE1        R11                 HCT ADDRESS                        * S1380800
* RDC/BASE2    R12                 DECOMPRESSED STRING CNT REMAINING  * S1380900
* SAVE         R13                 PCE ADDRESS                        * S1381000
* LINK         R14                 RU SCAN ROUTINE RETURN ADDRESS     * S1381100
* RPP          R15                 PROCESSOR BUFFER POINTER           * S1381200
*                                                                     * S1381300
*                                                                     * S1381400
* SNA GET WORKAREA                                                    * S1381500
*                                                                     * S1381600
*              RPLSAVEA IS USED AS SNA GET WORK AREA BUT ONLY WHILE   * S1381700
*              IN A CHAIN OF RUS.  GET STATUS IS MOVED FROM ONE RPL   * S1381800
*              TO THE NEXT WHILE IN A CHAIN.                          * S1381900
*                                                                     * S1382000
* SGWFLAGS - NOT FIRST GET IN CHAIN SWITCH (SGWNFRST)                 * S1382100
*          - EXTRA EOR SWITCH (SGWXEOR)                               * S1382200
*          - DUPLICATE FIELD SWITCH (SGWDUP)                          * S1382300
*          - TRANSPARENCY SWITCH (SGWTRN)                             * S1382400
* SGWRSAVE - SAVES GET STATUS REGS 14-12 WHILE IN A CHAIN OF RUS      * S1382500
* SGWRUA   - POINTER TO NEXT BYTE OF RU TO BE SCANNED                 * S1382600
* SGWRUE   - POINTER TO END OF RU                              @OZ27441 S1382700
*                                                                     * S1382800
*********************************************************************** S1382900
         SPACE 3                                                    R41 S1383000
*                                                                   R41 S1383100
*                             SNA GET REGISTER DEFINITIONS          R41 S1383200
*                                                                   R41 S1383300
         SPACE 1                                                    R41 S1383400
RTC      EQU   R0                  TRANSPARENCY COUNT REMAINING     R41 S1383500
RSC      EQU   R3   *MDCT*         SCB COUNT REMAINING              R41 S1383600
RDP      EQU   R5   *MICE*         DECOMPRESSED STRING POINTER      R41 S1383700
RPC      EQU   R6   *ML*           PROCESSOR BUFFER COUNT REMAINING R41 S1383800
RDC      EQU   R12  *BASE2*        DECOMPRESS STRING COUNT REMAININGR41 S1383900
RPP      EQU   R15                 PROCESSOR BUFFER POINTER         R41 S1384000
         EJECT                                                      R41 S1384100
*********************************************************************** S1384200
*                                                                     * S1384300
* RTAMVGET  --  SNA GET INITIALIZATION                                * S1384400
*                                                                     * S1384500
* INITIALIZATION IS ENTERED EVERY TIME A $EXTPGET IS DONE.            * S1384600
* INITIALIZATION GETS AN RPL IF NECESSARY AND CALLS THE RU SCAN       * S1384700
* ROUTINE (MVGSCN) FOR THE FIRST RU IN A CHAIN.  ON SUBSEQUENT        * S1384800
* ENTRIES INITIALIZATION RESTORES SAVED STATUS AND CALLS THE MOVE     * S1384900
* SUBROUTINE (MVGMVE) TO BEGIN FILLING THE PROCESSOR BUFFER.          * S1385000
*                                                                     * S1385100
*********************************************************************** S1385200
         SPACE 1                                                    R41 S1385300
         USING RTAMVGET,MBASE1                                      R41 S1385400
         SPACE 1                                                    R41 S1385500
*                             DETERMINE IF FIRST GET OF RU CHAIN    R41 S1385600
         SPACE 1                                                    R41 S1385700
RTAMVGET LTR   MBUF,MBUF           IF THERE IS NO RPL BUFFER        R41 S1385800
         BZ    MVGNBUF              GO GET ONE                      R41 S1385900
         TM    SGWFLAGS,SGWNFRST   IF GET HAS NOT USED THIS RPL     R41 S1386000
         BNO   MVGFRST              GO INIT FOR START OF CHAIN      R41 S1386100
         SPACE 1                                                    R41 S1386200
*                             NOT THE FIRST GET OF THE CHAIN        R41 S1386300
         SPACE 1                                                    R41 S1386400
         MVC   SGWRPP(4),PCER0     SAVE PROCESSOR BUFFER ADDRESS    R41 S1386500
         MVC   SGWRPC+3(1),MDCTRECL SAVE PROCESSOR LRECL            R41 S1386600
         LM    R14,R12,SGWRSAVE    RESTORE GET STATUS REGISTERS     R41 S1386700
         B     MVGMVE              BEGIN FILLING PROCESSOR BUFFER   R41 S1386800
         SPACE 1                                                    R41 S1386900
*                             FIRST GET OF THE CHAIN, NO RPL BFR    R41 S1387000
         SPACE 1                                                    R41 S1387100
MVGNBUF  BAL   ML,MVREQBUF         GET NEXT RPL BUFFER              R41 S1387200
         LTR   MBUF,MBUF           IF NO BUFFER RETURNED            R41 S1387300
         BZ    MVGDUMMY             GO CREATE DUMMY RECORD          R41 S1387400
         SPACE 1                                                    R41 S1387500
*                             FIRST GET, GET HAS AN RPL BUFFER      R41 S1387600
         SPACE 1                                                    R41 S1387700
MVGFRST  OI    SGWFLAGS,SGWNFRST   SET NOT FIRST GET OF CHAIN       R41 S1387800
         L     RPP,PCER0           INIT PROCESSOR BUFFER ADDR       R41 S1387900
         XR    RPC,RPC             INIT PROCESSOR                   R41 S1388000
         IC    RPC,MDCTRECL         BUFFER COUNT                    R41 S1388100
         XR    RTC,RTC             INIT TRANSPARENCY COUNT          R41 S1388200
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1388300
         EJECT                                                      R41 S1388400
*********************************************************************** S1388500
*                                                                     * S1388600
* MVGSCN  --  RU SCAN ROUTINE                                         * S1388700
*                                                                     * S1388800
* THE RU SCAN ROUTINE DECODES THE SCB AND PERFORMS AN SCS SCAN ON     * S1388900
* THE STRING OF DATA BEFORE CALLING THE MOVE SUBROUTINE (MVGMVE) TO   * S1389000
* PLACE THE DATA IN THE PROCESSOR BUFFER.  NON-COMPRESSED DATA IS     * S1389100
* MADE TO APPEAR AS A NON-DUPLICATE STRING NO GREATER THAN 256        * S1389200
* BYTES.  WHEN ONE RU ENDS THE RU SCAN ROUTINE CALLS THE EMPTY RU     * S1389300
* SUBROUTINE (MVGEMTY) TO GET THE NEXT RU.                            * S1389400
*                                                                     * S1389500
*********************************************************************** S1389600
         SPACE 1                                                    R41 S1389700
MVGSCN   L     RDP,RPLAREA         POINT TO START OF RU             R41 S1389800
         ST    RDP,SGWRUA          SAVE START OF RU                 R41 S1389900
         L     R1,RPLRLEN          POINT TO                         R41 S1390000
         AR    RDP,R1               END OF RU                       R41 S1390100
         ST    RDP,SGWRUE          SAVE END OF RU                   R41 S1390200
         L     MDCT,PCER1          POINT TO DEVICE DCT              R41 S1390300
         TM    MDCTFMT,DCTPPRES    IF COMPRESSED                    R41 S1390400
         BO    MVGSCB               GO DECODE SCB                   R41 S1390500
         SPACE 1                                                    R41 S1390600
*                             NON-COMPRESSED RU                     R41 S1390700
         SPACE 1                                                    R41 S1390800
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1390900
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1391000
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1391100
MVGSCN1  LR    RSC,R1              GET RU LENGTH INTO RSC      @OZ27441 S1391200
         L     RDP,SGWRUA          SAVE NEW                    @OZ27441 S1391300
         LA    R1,0(RDP,RSC)        END OF RU                       R41 S1391400
         ST    R1,SGWRUE             POINTER                        R41 S1391500
         L     R1,PCER1            POINT TO DEVICE DCT              R41 S1391600
         TM    MDCTFMT-DCTDSECT(R1),DCTPALTC IF NOT ASCII           R41 S1391700
         BNO   MVGSNS1                        GO HANDLE AS NON-DUPL R41 S1391800
         SPACE 1                                                    R41 S1391900
         CH    RSC,=H'256'         CHECK RU LENGTH             @OZ27441 S1391910
         BH    MVGSCN2             BR IF EXTENDED LENGTH RU    @OZ27441 S1391920
         BCTR  RSC,0               TRANSLATE                        R41 S1392000
         EX    RSC,MVGSTR           STRING                          R41 S1392100
         LA    RSC,1(,RSC)           TO EBCDIC                      R41 S1392200
         B     MVGSNS1             GO HANDLE AS NON-DUPL STRING     R41 S1392300
         SPACE 1                                                    R41 S1392400
MVGSTR   TR    0(0,RDP),MVGASCII   EXECUTED TRANSLATE TO EBCDIC     R41 S1392500
         SPACE 1                                                    R41 S1392600
*        TRANSLATE NON-COMPRESSED EXTENDED LENGTH TO EBCDIC    @OZ27441 S1392610
         SPACE 1                                               @OZ27441 S1392620
MVGSCN2  TR    0(256,RDP),MVGASCII TRANSLATE FIRST 256 BYTES   @OZ27441 S1392630
         LA    RDP,256(,RDP)       UPDATE DATA POINTER         @OZ27441 S1392640
         SH    RSC,=H'257'         DECR RU LENGTH (1 FOR EX)   @OZ27441 S1392650
         EX    RSC,MVGSTR          TRANSLATE REST OF STRING    @OZ27441 S1392660
         LA    RSC,257(,RSC)       RESTORE EXTENDED RU LENGTH  @OZ27441 S1392670
         B     MVGSNS1             HANDLE AS NON-DUPL STRING   @OZ27441 S1392680
         SPACE 1                                               @OZ27441 S1392690
*                             END OF RU FOUND                       R41 S1392700
         SPACE 1                                                    R41 S1392800
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1392900
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1393000
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1393100
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1393200
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1393300
MVGSEND  BAL   LINK,MVGEMTY        GO GET NEXT RU              @OZ27441 S1393400
         B     MVGSCN              GO PROCESS NEXT RU               R41 S1393500
         SPACE 1                                                    R41 S1393600
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1393700
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1393800
*              THIS LINE DELETED BY APAR NUMBER                @OZ27441 S1393900
         SPACE 1                                                    R41 S1394000
*                             DECODE SCB                            R41 S1394100
         SPACE 1                                                    R41 S1394200
MVGSCB   L     RDP,SGWRUA          POINT TO NEXT SCB                R41 S1394300
         C     RDP,SGWRUE          IF ADDR SAME AS END OF RU   @OZ27441 S1394400
         BE    MVGSEND              GO TO HANDLE RU END        @OZ27441 S1394500
         SPACE 1                                                    R41 S1394600
         NI    SGWFLAGS,X'FF'-SGWDUP INIT AS NON-DUPLICATE          R41 S1394700
         SLR   R2,R2               CLEAR REGISTER              @OZ27441 S1394750
         IC    R2,0(,RDP)          GET SCB FROM RU                  R41 S1394800
         LR    RSC,R2              INITIALIZE                       R41 S1394900
         SLL   RSC,26               SCB                             R41 S1395000
         SRL   RSC,26                COUNT                          R41 S1395100
         SRL   R2,6                DECODE TYPE                      R41 S1395200
         SLL   R2,2                 OF SCB                          R41 S1395300
         LA    RDP,1(,RDP)         POINT PAST SCB                   R41 S1395400
         ST    RDP,SGWRUA           AND SAVE POINTER                R41 S1395500
         B     MVGSBR(R2)          CALL ROUTINE DEPENDING ON SCB    R41 S1395600
         SPACE 1                                                    R41 S1395700
MVGSBR   B     MVGSNS              NON-DUPLICATE SCB                R41 S1395800
         B     MVGSCS              COMPACTION SCB                   R41 S1395900
         B     MVGSPS              DUPLICATE PRIMES SCB             R41 S1396000
         B     MVGSDS              DUPLICATE NON-PRIMES SCB         R41 S1396100
         SPACE 1                                                    R41 S1396200
*                             NON-DUPLICATE SCB                     R41 S1396300
         SPACE 1                                                    R41 S1396400
MVGSNS   L     R1,SGWRUE           CALCULATE LENGTH                 R41 S1396500
         S     R1,SGWRUA            OF RU REMAINING                 R41 S1396600
         CR    RSC,R1              IF STRING IS WITHIN RU           R41 S1396700
         BNH   MVGSNS1              GO CHECK FOR END OF STRING      R41 S1396800
         LR    RSC,R1              IGNORE STRING EXTENDING PAST RU  R41 S1396900
         SPACE 1                                                    R41 S1397000
MVGSNS1  LTR   R1,RSC              IF NULL STRING OR END OF STRING  R41 S1397100
         BZ    MVGSCB               GO DECODE NEXT SCB              R41 S1397200
         SPACE 1                                                    R41 S1397300
         L     RDP,SGWRUA          POINT TO CURRENT STRING ADDRESS  R41 S1397400
         TM    SGWFLAGS,SGWTRN     IF WITHIN A TRANSPARENT STRING   R41 S1397500
         BO    MVGSNTR              GO HANDLE TRANSPARENT STRING    R41 S1397600
         SPACE 1                                                    R41 S1397700
MVGSNS2  SLR   R2,R2               CLEAR REGISTER              @OZ27441 S1397705
         CH    R1,=H'256'          TEST FOR EXTENDED LENGTH RU @OZ27441 S1397710
         BNH   MVGSNS3             BRANCH IF NOT EXTENDED RU   @OZ27441 S1397720
         TRT   0(256,RDP),MSCSTRAN SCAN FOR SCS                @OZ27441 S1397730
         BNZ   MVGSNBR             BRANCH IF SCS FOUND         @OZ27441 S1397740
         LA    RDP,256(,RDP)       ELSE UPDATE POINTER AND LEN @OZ27441 S1397750
         SH    R1,=H'256'            TO CONTINUE WITH RESIDUAL @OZ27441 S1397760
         SPACE 1                                               @OZ27441 S1397770
MVGSNS3  BCTR  R1,0                START SCS                   @OZ27441 S1397800
         EX    R1,MVGSNTRT          SCAN OF STRING                  R41 S1397900
         BZ    MVGSN10             NO SCS FOUND, GO HANDLE DATA     R41 S1398000
         SPACE 1                                                    R41 S1398100
MVGSNBR  B     MVGSNBR(R2)         CALL RTN DEPENDING ON SCS FOUND  R41 S1398200
         B     MVGSN20             NON-SCANNED SCS                  R41 S1398300
         B     MVGSN30             NL IRS FF                        R41 S1398400
         B     MVGSN40             TRN                              R41 S1398500
         B     MVGSN20             ESC (HANDLE AS NON-SCANNED SCS)  R41 S1398600
         SPACE 1                                                    R41 S1398700
MVGSNTRT TRT   0(0,RDP),MSCSTRAN   EXECUTED FOR SCS SCAN            R41 S1398800
         SPACE 1                                                    R41 S1398900
*                             STRING CONSISTS OF ALL DATA           R41 S1399000
         SPACE 1                                                    R41 S1399100
MVGSN10  LR    RDC,RSC             PASS STRING LENGTH               R41 S1399200
         L     RDP,SGWRUA          PASS START OF STRING             R41 S1399300
         LA    R1,0(RDP,RDC)       CALCULATE AND                    R41 S1399400
         ST    R1,SGWRUA            SAVE NEXT SCB ADDRESS           R41 S1399500
         BAL   LINK,MVGMVE         CALL MOVE SUBROUTINE             R41 S1399600
         B     MVGSCB              GO DECODE NEXT SCB               R41 S1399700
         SPACE 1                                                    R41 S1399800
*                             TRANSPARENT, NON-DUPLICATE STRING     R41 S1399900
         SPACE 1                                                    R41 S1400000
MVGSNTR  LTR   RTC,RTC             IF TRN COUNT HAS BEEN LOADED     R41 S1400100
         BNZ   MVGSNT1              GO CHECK LENGTH OF TRN STRING   R41 S1400200
         IC    RTC,0(,RDP)         PICK UP COUNT                    R41 S1400300
         LA    RDP,1(,RDP)         POINT PAST COUNT IN RU           R41 S1400400
         ST    RDP,SGWRUA          SAVE POINTER                     R41 S1400500
         BCTR  RSC,0               DECREMENT STRING COUNTER         R41 S1400600
         LTR   RTC,RTC             CHECK FOR ZERO COUNT        @OZ24292 S1400620
         BNZ   MVGSNS1             NOT ZERO, CHECK FOR END     @OZ24292 S1400640
         NI    SGWFLAGS,X'FF'-SGWTRN SET OUT OF TRANS STRING   @OZ24292 S1400660
         B     MVGSNS1             GO CHECK FOR END OF STRING       R41 S1400700
         SPACE 1                                                    R41 S1400800
MVGSNT1  CLR   RTC,RSC             IF TRN IS NOT LONGER THAN SCB    R41 S1400900
         BNH   MVGSNT2              GO POINT TO END OF TRN STRING   R41 S1401000
         SR    RTC,RSC             CALCULATE TRN STRING REMAINING   R41 S1401100
         B     MVGSN10             GO TREAT SCB STRING AS DATA      R41 S1401200
         SPACE 1                                                    R41 S1401300
MVGSNT2  AR    RDP,RTC             POINT TO END                     R41 S1401400
         LR    R1,RDP               OF TRN STRING                   R41 S1401500
         BCTR  R1,0                BACK UP ONE TO SIMULATE TRT      R41 S1401600
         NI    SGWFLAGS,X'FF'-SGWTRN INDICATE                       R41 S1401700
         XR    RTC,RTC                NOT IN TRN STRING             R41 S1401800
         SPACE 1                                                    R41 S1401900
*                             NON-SCANNED SCS                       R41 S1402000
         SPACE 1                                                    R41 S1402100
MVGSN20  LA    RDP,1(,R1)          POINT PAST CHAR THAT STOPPED SCANR41 S1402200
         L     R1,SGWRUA           POINT TO                         R41 S1402300
         AR    R1,RSC               END OF STRING                   R41 S1402400
         SR    R1,RDP              IF LAST CHAR OF STRING           R41 S1402500
         BZ    MVGSN10              GO GIVE STRING TO MOVER AS DATA R41 S1402600
         B     MVGSNS2             GO RESTART SCS SCAN              R41 S1402700
         SPACE 1                                                    R41 S1402800
*                             TRN FOUND                             R41 S1402900
         SPACE 1                                                    R41 S1403000
MVGSN40  OI    SGWFLAGS,SGWTRN     INDICATE IN TRANSPARENT STRING   R41 S1403100
         SPACE 1                                                    R41 S1403200
*                             TRN/EOR FOUND                         R41 S1403300
         SPACE 1                                                    R41 S1403400
MVGSN30  L     RDP,SGWRUA          PASS START OF STRING             R41 S1403500
         LR    RDC,R1              CALCULATE LENGTH OF              R41 S1403600
         SR    RDC,RDP              STRING PRECEDING EOR/TRN        R41 S1403700
         LA    R1,1(,R1)           POINT PAST EOR/TRN               R41 S1403800
         ST    R1,SGWRUA            AND SAVE POINTER                R41 S1403900
         SR    RSC,RDC             CALCULATE                        R41 S1404000
         BCTR  RSC,0                LENGTH OF SCB STRING REMAINING  R41 S1404100
         BAL   LINK,MVGMVE         CALL MOVE SUBROUTINE WITH DATA   R41 S1404200
         SPACE 1                                                    R41 S1404300
MVGSN35  TM    SGWFLAGS,SGWTRN     IF TRN WAS FOUND                 R41 S1404400
         BO    MVGSNS1             GO HANDLE REST OF SCB STRING     R41 S1404500
         BAL   LINK,MVGMEOR        CALL MOVE SUBROUTINE WITH EOR    R41 S1404600
         B     MVGSNS1             GO HANDLE REST OF SCB STRING     R41 S1404700
         SPACE 1                                                    R41 S1404800
*                             COMPACTION SCB                        R41 S1404900
         SPACE 1                                                    R41 S1405000
MVGSCS   B     MVGSNS              TREAT AS NON-DUPL SCB, FOR NOW   R41 S1405100
         SPACE 1                                                    R41 S1405200
*                             DUPLICATE PRIMES SCB                  R41 S1405300
         SPACE 1                                                    R41 S1405400
MVGSPS   BCTR  RDP,0               BACK UP POINTER AND STORE A BLANKR41 S1405500
         MVI   0(RDP),C' '          TO PRETEND DUPLICATE NON-PRIMES R41 S1405600
         SPACE 1                                                    R41 S1405700
*                             DUPLICATE NON-PRIMES SCB              R41 S1405800
         SPACE 1                                                    R41 S1405900
MVGSDS   LA    R1,1(,RDP)          POINT TO NEXT SCB                R41 S1406000
         ST    R1,SGWRUA            AND SAVE POINTER                R41 S1406100
         OI    SGWFLAGS,SGWDUP     INDICATE DUPLICATE FIELD         R41 S1406200
         SPACE 1                                                    R41 S1406300
MVGSDS1  LTR   RSC,RSC             IF NULL OR END OF SCB STRING     R41 S1406400
         BZ    MVGSCB               GO DECODE NEXT SCB              R41 S1406500
         TM    SGWFLAGS,SGWTRN     IF IN TRANSPARENT STRING         R41 S1406600
         BO    MVGSDTR              GO HANDLE AS TRANSPARENT STRING R41 S1406700
         SLR   R2,R2               CLEAR REGISTER              @OZ27441 S1406750
         IC    R2,0(,RDP)          PICK UP DUPLICATE CHARACTER      R41 S1406800
         IC    R2,MSCSTRAN(R2)     DO SCS SCAN ON ONE CHARACTER     R41 S1406900
         B     MVGSDBR(R2)         CALL RTN DEPENDING ON SCS CHAR   R41 S1407000
         SPACE 1                                                    R41 S1407100
MVGSDBR  B     MVGSD10             DATA                             R41 S1407200
         B     MVGSD10             NON-SCANNED SCS (HANDLE AS DATA) R41 S1407300
         B     MVGSD20             NL IRS FF (EOR)                  R41 S1407400
         B     MVGSD30             TRN                              R41 S1407500
         B     MVGSD10             ESC (HANDLE AS NON-SCANNED SCS)  R41 S1407600
         SPACE 1                                                    R41 S1407700
*                             IN TRANSPARENT STRING                 R41 S1407800
         SPACE 1                                                    R41 S1407900
MVGSDTR  LTR   RTC,RTC             IF TRN COUNT ALREADY LOADED      R41 S1408000
         BNZ   MVGSDT1              GO HANDLE TRANSPARENT STRING    R41 S1408100
         IC    RTC,0(,RDP)         PICK UP TRN COUNT                R41 S1408200
         BCTR  RSC,0               DECREMENT LENGTH OF DUPL STRING  R41 S1408300
         B     MVGSDS1             GO CHECK FOR END OF SCB STRING   R41 S1408400
         SPACE 1                                                    R41 S1408500
MVGSDT1  CLR   RTC,RSC             IF TRN STRING NOT LONGER THAN SCBR41 S1408600
         BNH   MVGSDT2              GO TREAT JUST TRN STRING AS DATAR41 S1408700
         SR    RTC,RSC             CALC NEW LENGTH OF TRN STRING    R41 S1408800
         B     MVGSD10             GO TREAT SCB STRING AS DATA      R41 S1408900
         SPACE 1                                                    R41 S1409000
MVGSDT2  LR    RDC,RTC             PASS FIELD LENGTH                R41 S1409100
         SR    RSC,RTC             CALCULATE SCB LENGTH REMAINING   R41 S1409200
         NI    SGWFLAGS,X'FF'-SGWTRN INDICATE                       R41 S1409300
         XR    RTC,RTC                OUT OF TRANSPARENT STRING     R41 S1409400
         BAL   LINK,MVGMVE         CALL MOVE SUBROUTINE WITH DATA   R41 S1409500
         B     MVGSDS1             GO CHECK FOR END OF SCB STRING   R41 S1409600
         SPACE 1                                                    R41 S1409700
*                             DUPLICATE DATA                        R41 S1409800
         SPACE 1                                                    R41 S1409900
MVGSD10  LR    RDC,RSC             PASS FIELD LENGTH                R41 S1410000
         BAL   LINK,MVGMVE         CALL MOVE SUBROUTINE WITH DATA   R41 S1410100
         B     MVGSCB              GO DECODE NEXT SCB               R41 S1410200
         SPACE 1                                                    R41 S1410300
*                             DUPLICATE EOR                         R41 S1410400
         SPACE 1                                                    R41 S1410500
MVGSD20  BAL   LINK,MVGMEOR        CALL MOVE SUBROUTINE WITH EOR    R41 S1410600
         BCT   RSC,MVGSD20         CALL AGAIN UNTIL SCB STRING ENDEDR41 S1410700
         B     MVGSCB              GO DECODE NEXT SCB               R41 S1410800
         SPACE 1                                                    R41 S1410900
*                             DUPLICATE TRN                         R41 S1411000
         SPACE 1                                                    R41 S1411100
MVGSD30  OI    SGWFLAGS,SGWTRN     INDICATE IN TRANSPARENT STRING   R41 S1411200
         BCTR  RSC,0               DECREMENT SCB STRING LENGTH      R41 S1411300
         B     MVGSDS1             GO CHECK FOR END OF SCB STRING   R41 S1411400
         EJECT                                                      R41 S1411500
*********************************************************************** S1411600
*                                                                     * S1411700
* MVGMVE  --  MOVE SUBROUTINE                                         * S1411800
*                                                                     * S1411900
* THE MOVE SUBROUTINE TAKES A SERIES OF VARIABLE LENGTH DATA FIELDS   * S1412000
* FROM THE RU SCAN ROUTINE AND USES THEM TO FILL THE PROCESSOR        * S1412100
* BUFFER.  WHEN THE PROCESSOR BUFFER IS FULL THE MOVE SUBROUTINE      * S1412200
* CALLS THE GET TERMINATION ROUTINE (MVGEXIT).  WHEN THE NEXT         * S1412300
* $EXTPGET IS DONE THE MOVE SUBROUTINE IS CALLED DIRECTLY BY THE      * S1412400
* GET INITIALIZATION ROUTINE (RTAMVGET).  WHEN THE MOVE ROUTINE       * S1412500
* NEEDS MORE DATA, IT RETURNS TO THE RU SCAN ROUTINE (MVGSCN).        * S1412600
*                                                                     * S1412700
*********************************************************************** S1412800
         SPACE 1                                                    R41 S1412900
*                             NOT EOR, MOVE DATA                    R41 S1413000
         SPACE 1                                                    R41 S1413100
MVGMVE   LTR   RDC,RDC             IF FIELD IS ENDED                R41 S1413200
         BZR   LINK                 RETURN                          R41 S1413300
         SPACE 1                                                    R41 S1413400
         NI    SGWFLAGS,X'FF'-SGWXEOR EXTRA EOR DID NOT OCCUR       R41 S1413500
         LR    R1,RDC              ASSUME MOVE OF FIELD LENGTH      R41 S1413600
         CR    RDC,RPC             IF FIELD NOT LARGER THAN PROC BFRR41 S1413700
         BNH   MVGM01               GO MOVE FIELD                   R41 S1413800
         LR    R1,RPC              MOVE TO END OF PROC BFR          R41 S1413900
         SPACE 1                                                    R41 S1414000
MVGM01   TM    SGWFLAGS,SGWDUP     IF DUPLICATE FIELD               R41 S1414100
         BO    MVGM02               GO MOVE DUPLICATE FIELD         R41 S1414200
         SPACE 1                                                    R41 S1414300
         CH    R1,=H'256'          TEST FOR EXTENDED LENGTH RU @OZ27441 S1414310
         BNH   MVGM01A             BRANCH IF NOT EXTENDED RU   @OZ27441 S1414320
         MVC   0(256,RPP),0(RDP)   MOVE FIRST 256 BYTES        @0Z27441 S1414330
         SH    R1,=H'257'          DECR RU LENGTH (1 FOR EX)   @OZ27441 S1414340
         EX    R1,MVGMVCXL         MOVE RESIDUAL DATA          @OZ27441 S1414350
         LA    R1,257(,R1)         RESTORE EXTENDED RU LENGTH  @OZ27441 S1414360
         B     MVGMBYPS            GO TO UPDATE FIELD POINTER  @OZ27441 S1414370
         SPACE 1                                               @OZ27441 S1414380
MVGM01A  BCTR  R1,0                DECREMENT LENGTH FOR EXECUTE@OZ27441 S1414400
         EX    R1,MVGMVC1          MOVE NON-DUPLICATE FIELD         R41 S1414500
         LA    R1,1(,R1)           INCREMENT LENGTH AFTER EXECUTE   R41 S1414600
MVGMBYPS LA    RDP,0(RDP,R1)       UPDATE FIELD POINTER        @OZ27441 S1414700
         B     MVGM03              GO UPDATE FIELD COUNT            R41 S1414800
         SPACE 3                                               @OZ27441 S1414900
MVGMVCXL MVC   256(*-*,RPP),256(RDP)  **** EXECUTED ONLY ****  @OZ27441 S1414910
         EJECT                                                 @OZ27441 S1414920
MVGM02   MVC   0(1,RPP),0(RDP)     MOVE IN FIRST BYTE               R41 S1415000
         BCT   R1,MVGM02A          GO DECREMENT AGAIN, IF NOT JUST 1R41 S1415100
         B     MVGM02B             GO INCREMENT FOR JUST 1 BYTE     R41 S1415200
MVGM02A  BCTR  R1,0                DECREMENT LENGTH FOR EXECUTE     R41 S1415300
         EX    R1,MVGMVC2          DUPLICATE FIELD                  R41 S1415400
         LA    R1,1(,R1)           INCREMENT LENGTH AFTER EXECUTE   R41 S1415500
MVGM02B  LA    R1,1(,R1)           INCREMENT FOR FIRST BYTE         R41 S1415600
         SPACE 1                                                    R41 S1415700
MVGM03   SR    RDC,R1              UPDATE FIELD COUNT               R41 S1415800
         AR    RPP,R1              UPDATE PROC BFR POINTER          R41 S1415900
         SR    RPC,R1              UPDATE PROC BFR COUNT            R41 S1416000
         BNZR  LINK                RETURN IF PROC BFR NOT FULL      R41 S1416100
         SPACE 1                                                    R41 S1416200
         OI    SGWFLAGS,SGWXEOR    INDICATE EXTRA EOR MAY OCCUR     R41 S1416300
         B     MVGEXIT             GO END GET PROCESSING            R41 S1416400
         SPACE 1                                                    R41 S1416500
*                             EOR, PROPAGATE BLANKS                 R41 S1416600
         SPACE 1                                                    R41 S1416700
MVGMEOR  TM    SGWFLAGS,SGWXEOR    IF NOT EXTRA EOR                 R41 S1416800
         BNO   MVGPROP              GO PROPAGATE BLANKS             R41 S1416900
         NI    SGWFLAGS,X'FF'-SGWXEOR EXTRA EOR FOUND               R41 S1417000
         BR    LINK                RETURN                           R41 S1417100
         SPACE 1                                                    R41 S1417200
MVGPROP  MVI   0(RPP),C' '         PROPAGATE BLANKS                 R41 S1417300
         BCT   RPC,MVGPROP1        GO DECREMENT AGAIN IF NOT JUST 1 R41 S1417400
         B     MVGPROP2            ONLY ONE BYTE, SKIP MOVE         R41 S1417500
MVGPROP1 BCTR  RPC,0               DECREMENT FOR EXECUTE            R41 S1417600
         EX    RPC,MVGMVC2           PROCESSOR BUFFER               R41 S1417700
         LA    RPC,1(,RPC)         INCREMENT LENGTH AFTER EXECUTE   R41 S1417800
         SPACE 1                                                    R41 S1417900
MVGPROP2 LA    RPP,1(RPP,RPC)      UPDATE PROC BFR POINTER          R41 S1418000
         XR    RDC,RDC             NO FIELD DATA                    R41 S1418100
         XR    RPC,RPC             PROCESSOR BUFFER FULL            R41 S1418200
         B     MVGEXIT             GO END GET PROCESSING            R41 S1418300
         SPACE 1                                                    R41 S1418400
MVGMVC1  MVC   0(0,RPP),0(RDP)     EXECUTED TO MOVE NON-DUPL DATA   R41 S1418500
MVGMVC2  MVC   1(0,RPP),0(RPP)     EXECUTED TO MOVE DUPL DATA       R41 S1418600
         EJECT                                                      R41 S1418700
*********************************************************************** S1418800
*                                                                     * S1418900
* MVGEMTY  --  EMPTY RU SUBROUTINE                                    * S1419000
*                                                                     * S1419100
* CALLED BY THE RU SCAN ROUTINE (MVGSCN) WHEN ANOTHER RU IS NEEDED.   * S1419200
* THE EMPTY RU SUBROUTINE GETS THE NEXT RU AND RETURNS TO THE RU      * S1419300
* SCAN ROUTINE (MVGSCN).  IF THE LAST RU IN THE CHAIN IS REACHED,     * S1419400
* THE EMPTY RU SUBROUTINE CALLS THE SNA GET TERMINATION ROUTINE       * S1419500
* (MVGEXIT).                                                          * S1419600
*                                                                     * S1419700
*********************************************************************** S1419800
         SPACE 1                                                    R41 S1419900
*                             DETERMINE IF LAST RU IN CHAIN         R41 S1420000
         SPACE 1                                                    R41 S1420100
MVGEMTY  L     MICE,RPLICE         POINT TO ICE                     R41 S1420200
         TM    ICERCVST,ICEINCHN   IF THE LAST RU IN CHAIN          R41 S1420300
         BZ    MVGEXIT              GO FORCE EXIT                   R41 S1420400
         SPACE 1                                                    R41 S1420500
*                             NOT LAST RU IN CHAIN, GET NEXT RU     R41 S1420600
         SPACE 1                                                    R41 S1420700
         STM   R14,R12,SGWRSAVE    SAVE GET REGISTERS IN RPL        R41 S1420800
         L     R1,SGWRUE           CALCULATE LENGTH                 R41 S1420900
         S     R1,SGWRUA            OF RU REMAINING                 R41 S1421000
         ST    R1,RPLRLEN          UPDATE RPL LENGTH REMAINING      R41 S1421100
         MVC   RPLAREA(4),SGWRUA   SAVE CURRENT RPL ADDRESS         R41 S1421200
         L     R1,PCER1            POINT TO DCT                     R41 S1421300
        $RESTORE                   RESTORE RTAM REGISTERS           R41 S1421400
         SPACE 1                                                    R41 S1421500
         BAL   ML,MVREQBUF         REQUEST NEXT RPL AND RU          R41 S1421600
         LTR   MBUF,MBUF           IF NO BUFFER RETURNED            R41 S1421700
         BZ    MVGDUMMY             GO RETURN DUMMY FOR JOB DELETE  R41 S1421800
         SPACE 1                                                    R41 S1421900
         L     ML,RPLNEXT          POINT TO NEW RPL                 R41 S1422000
         USING RPLDSECT,ML                                          R41 S1422100
         MVC   SGWSTRT(SGWEND-SGWSTRT),SGWSTRT-RPLDSECT(MBUF)       R41XS1422200
                                   MOVE GET STATUS TO NEXT RPL      R41 S1422300
         DROP  ML                                                   R41 S1422400
         SPACE 1                                                    R41 S1422500
         BAL   ML,MVRELBUF         RELEASE OLD RPL AND RU           R41 S1422600
         SPACE 1                                                    R41 S1422700
         L     MBUF,DCTBUFAD       RESTORE NEW BUFFER ADDRESS       R41 S1422800
         ST    MBUF,SGWMBUF        INITIALIZE SAVED BUFFER ADDRESS  R41 S1422900
         LM    R14,R12,SGWRSAVE    RESTORE GET STATUS               R41 S1423000
         BR    LINK                RETURN                           R41 S1423100
         SPACE 2                                                    R41 S1423200
*                                                                   R41 S1423300
*                             RETURN DUMMY TO CALLER ON JOB DELETE  R41 S1423400
*                                                                   R41 S1423500
         SPACE 1                                                    R41 S1423600
MVGDUMMY ICM   MBUF,15,DCTBUFAD    PURGE ANY                        R41 S1423700
         BZ    MVGDU1               BUFFER                          R41 S1423800
         BAL   ML,MVFREEIN           THE RDCT                       R41 S1423900
         ST    MBUF,DCTBUFAD          MAY OWN                       R41 S1424000
MVGDU1   L     R1,PCER0            RETRIEVE USER BUFFER ADDRESS     R41 S1424100
         MVI   0(R1),0             GUARANTEE NOT A VALID // JOB CARDR41 S1424200
         B     MVTAMXIT            RETURN TO PROCESSOR              R41 S1424300
         EJECT                                                      R41 S1424400
*********************************************************************** S1424500
*                                                                     * S1424600
* MVGEXIT  --  SNA GET TERMINATION ROUTINE                            * S1424700
*                                                                     * S1424800
* CALLED BY THE DATA MOVE SUBROUTINE (MVGMVE) OR, IF END OF CHAIN,    * S1424900
* BY THE EMPTY RU SUBROUTINE (MVGEMTY), SNA GET TERMINATION RETURNS   * S1425000
* TO THE PROCESSOR AND PASSES BACK EITHER A LOGICAL RECORD OR AN      * S1425100
* END OF FILE INDICATION.                                             * S1425200
*                                                                     * S1425300
*********************************************************************** S1425400
         SPACE 1                                                    R41 S1425500
*                             DETERMINE IF EOC CAUSED EXIT          R41 S1425600
         SPACE 1                                                    R41 S1425700
MVGEXIT  LTR   RPC,RPC             IF PROCESSOR BUFFER NOT FULL     R41 S1425800
         BNZ   MVGEOC               THEN EOC CAUSED EXIT            R41 S1425900
         SPACE 1                                                    R41 S1426000
*                             EOC DID NOT CAUSE EXIT                R41 S1426100
         SPACE 1                                                    R41 S1426200
MVGNEOC  STM   R14,R12,SGWRSAVE    SAVE GET STATUS                  R41 S1426300
         L     R1,SGWRUE           CALCULATE LENGTH                 R41 S1426400
         S     R1,SGWRUA            OF RU REMAINING                 R41 S1426500
         ST    R1,RPLRLEN          UPDATE RPL LENGTH REMAINING      R41 S1426600
         MVC   RPLAREA(4),SGWRUA   SAVE CURRENT RPL ADDRESS         R41 S1426700
         L     R1,PCER0            RETRIEVE USER BUFFER ADDRESS     R41 S1426800
         SPACE 1                                                    R41 S1426900
         CLC   =C'/*SIGNOFF',0(R1) IF UPPERCASE SIGNOFF             R41 S1427000
         BNE   MVTAMXIT                      GO RETURN NORMALLY     R41 S1427100
         SPACE 1                                                    R41 S1427200
         L     R1,PCER1            RELOAD POINTER TO REMOTE DCT     R41 S1427300
        $RESTORE                   RESTORE RTAM REGISTER ENVIRONMENTR41 S1427400
         L     R1,ICELDCT          GET ADDRESS OF LINE DCT          R41 S1427500
         OI    MDCTSTAT-DCTDSECT(R1),DCTSOFF MARK LINE FOR SIGNOFF  R41 S1427600
         B     RTAMVGET            RE-ENTER TO GET ANOTHER CARD     R41 S1427700
         SPACE 1                                                    R41 S1427800
*                             EOC CAUSED EXIT                       R41 S1427900
         SPACE 1                                                    R41 S1428000
MVGEOC   C     RPP,PCER0           IF PROC BFR NOT COMPLETELY EMPTY R41 S1428100
         BNE   MVGPROP              GO PROPAGATE BLANKS             R41 S1428200
         L     R1,PCER1            POINT TO DCT                     R41 S1428300
        $RESTORE                   RESTORE RTAM REGISTER ENVIRONMENTR41 S1428400
         BAL   ML,MVRELBUF         RELEASE THE RPL AND RU           R41 S1428500
         SPACE 1                                                    R41 S1428600
         TM    MDCTSTAT,DCTEOF     IF EOF                           R41 S1428700
         BO    MVTAMXEX            YES, EXIT WITH EOF               R41 S1428800
         SPACE 1                                                    R41 S1428900
         L     R0,PCER0            RESTORE CALLERS BFR ADDR         R41 S1429000
         B     RTAMVGET             AND RETRY GET ON NEXT CHAIN     R41 S1429100
         TITLE 'HASP SNA REMOTE TERMINAL GET TRANSLATE TABLE'        R4 S1570500
         SPACE 5                                                     R4 S1571000
MVGASCII DS    0D             ASCII TO EBCDIC TRANSLATE TABLE (SNA)  R4 S1571500
         SPACE 1                                                     R4 S1572000
*                X0X1X2X3X4X5X6X7X8X9XAXBXCXDXEXF                    R4 S1572500
         SPACE 1                                                     R4 S1573000
         DC    X'00010203372D2E2F1605250B0C0D0E0F'  0X               R4 S1573500
         DC    X'10142404153D322618193F271C1D1E1F'  1X               R4 S1574000
         DC    X'404F7F7B5B6C507D4D5D5C4E6B604B61'  2X               R4 S1574500
         DC    X'F0F1F2F3F4F5F6F7F8F97A5E4C7E6E6F'  3X               R4 S1575000
         DC    X'7CC1C2C3C4C5C6C7C8C9D1D2D3D4D5D6'  4X               R4 S1575500
         DC    X'D7D8D9E2E3E4E5E6E7E8E94AE05A5F6D'  5X               R4 S1576000
         DC    X'79818283848586878889919293949596'  6X               R4 S1576500
         DC    X'979899A2A3A4A5A6A7A8A9C06AD0A107'  7X               R4 S1577000
         TITLE 'HASP SNA REMOTE TERMINAL PUT ROUTINE'                R4 S1577500
         SPACE 3                                                     R4 S1578000
*                                                                    R4 S1578500
*                             SNA R.U. COMPOSER REGISTER DEFINITIONS R4 S1579000
*                                                                    R4 S1579500
         SPACE 3                                                     R4 S1580000
RBY1     EQU   R0                  CONSTANT OF 1, WORK REGISTER      R4 S1580500
REND     EQU   R1                  R.U. END ADDR, OR # UNUSED BYTES  R4 S1581000
RSINK    EQU   R2   *WA*           ADDRESS OF NEXT POSITION IN R.U.  R4 S1581500
RSCBL    EQU   R3   *MDCT*         NO. UNUSED BYTES IN CURRENT SCB  R41 S1582000
RCPZ     EQU   R3   *MDCT*         COMPACTION WORK REGISTER         R41 S1582400
RCPT     EQU   R5   *MICE*         ADDRESS OF COMPACTION TABLE      R41 S1582500
RFEED    EQU   R6   *ML*           FEEDER ROUTINES RETURN ADDRESS    R4 S1583000
RPLAN    EQU   R7   *MBASE1*       PLANNER ROUTINES CURRENT STATE   R41 S1583500
RBASE    EQU   R8   *MBASE2*       COMPRESS/COMPACT BASE REGISTER   R41 S1584000
RCPA     EQU   R10  *JCT*          COMPACTION WORK REGISTER         R41 S1584500
RNUM     EQU   R11  *BASE1*        CHARACTER DUPLICATION FACTOR     R41 S1585000
RCHAR    EQU   R12  *BASE2*        ADDRESS OF CHARACTER EMITTED      R4 S1585500
RLCHAR   EQU   R13  *PCE*          LENGTH FOR OFFSET COMPARE LONG    R4 S1586000
RGO      EQU   R13  *PCE*          WORK REG FOR WHERE-TO-GO TABLES  R41 S1586200
RSRCE    EQU   R14  *LINK*         ADDRESS OF NEXT SOURCE STRING     R4 S1586500
RLSRCE   EQU   R15                 LENGTH OF NEXT SOURCE STRING      R4 S1587000
         SPACE 5                                                     R4 S1587500
*                                                                    R4 S1588000
*                             ADD/SUBTRACT LOGICAL - CONDITION CODES R4 S1588500
*                                                                    R4 S1589000
         SPACE 1                                                     R4 S1589500
NOT      EQU   15                  ALLOW INVERSE CONDS. 'NOT-XXXX'   R4 S1590000
         SPACE 1                                                     R4 S1590500
*                                  LOGICAL OP.    SIGNS     COND.    R4 S1591000
*                                  ----------     -----     ----     R4 S1591500
         SPACE 1                                                     R4 S1592000
ALSM     EQU   1                        ADD       SAME      MINUS    R4 S1592500
ALDP     EQU   1                        ADD       DIFFER    PLUS     R4 S1593000
SLSP     EQU   1                        SUBTR     SAME      PLUS     R4 S1593500
SLDM     EQU   1                        SUBTR     DIFFER    MINUS    R4 S1594000
         SPACE 1                                                     R4 S1594500
ALDZ     EQU   2                        ADD       DIFFER    ZERO     R4 S1595000
SLSZ     EQU   2                        SUBTR     SAME      ZERO     R4 S1595500
         SPACE 1                                                     R4 S1596000
ALSP     EQU   4                        ADD       SAME      PLUS     R4 S1596500
ALDM     EQU   4                        ADD       DIFFER    MINUS    R4 S1597000
SLSM     EQU   4                        SUBTR     SAME      MINUS    R4 S1597500
SLDP     EQU   4                        SUBTR     DIFFER    PLUS     R4 S1598000
         SPACE 1                                                     R4 S1598500
ALSZ     EQU   8                        ADD       SAME      ZERO     R4 S1599000
         SPACE 1                                                     R4 S1599500
*                                  ASSUMING OVERFLOW DOES NOT OCCUR  R4 S1600000
         EJECT                                                       R4 S1600500
*                                                                    R4 S1601000
*                             VTAM PUT PROCESSING                    R4 S1601500
*                                                                    R4 S1602000
         SPACE 1                                                     R4 S1602500
         USING RTAMVPUT,MBASE1     ESTABLISH SNA PUT ADDRESSABILITY  R4 S1603000
         SPACE 1                                                     R4 S1603500
RTAMVPUT DS    0H                  ENTRY POINT FOR RTAM SNA PUT      R4 S1604000
         TM    ICESNDST,ICECNCEL+ICEWTRSP TEST SESSION STATUS  @OZ26937 S1609500
         BZ    MVPNWRSP            BR IF L.M. REQ NOT PENDING  @OZ26937 S1610000
         BAL   ML,MVREQRSP         GO WAIT FOR RESPONSE        @OZ26937 S1610500
MVPNWRSP TM    MDCTSTAT,DCTPSUSP   TEST DATA STREAM STATUS     @OZ26937 S1611000
         BZ    MVPNSUSP            BR IF NOT SUSP'D FOR CMDS   @OZ26937 S1611500
         BAL   ML,MVREQUME         GO WAIT FOR RESUME          @OZ26937 S1612000
MVPNSUSP TM    ICESNDST,ICEINSTR   TEST STREAM STATUS          @OZ26937 S1612500
         BO    MVPCPTST            BYPASS RESUME HDR IF IN STREAM   R41 S1613000
         BAL   ML,MVRPLGET         GET BUFFER FOR 'RESUME' FM HEADER R4 S1613500
         OI    ICESNDST,ICEOCPND   SET END CHN TO FORCE IMM FMH SEND R4 S1614000
         LA    R1,FMHRESUM         LOAD 'RESUME' DATA STREAM ACTION  R4 S1614500
         BAL   ML,MVFMHBLD         BUILD & SEND 'RESUME' FM HEADER   R4 S1615000
         SPACE 1                                                    R41 S1615100
MVPCPTST CLI   ICEACPTN,X'FF'      HAS A COMPACTION TABLE BEEN SENT R41 S1615200
         BNE   MVPCPACT            YES, CONTINUE PUT PROCESSING     R41 S1615300
         BAL   ML,MVPUTCP1         NO, GO SEND COMPACTION TABLE     R41 S1615400
MVPCPACT CLC   ICERCPTN,DCTACPTN   IF USING SAME COMPACTION TABLE   R41 S1615500
         BE    MVPINSTR             GO EXAMINE CHANNEL COMMAND CODE R41 S1615600
         BAL   ML,MVPUTCPA         ELSE CHANGE TABLE SPECIFICATION  R41 S1615700
         SPACE 1                                                     R4 S1615800
MVPINSTR L     R1,PCER0            RETRIEVE 2ND PARAMETER (CCW ADDR) R4 S1616000
         CLI   0(R1),X'03'         TEST CHANNEL COMMAND TYPE         R4 S1616500
         BE    MVPNOPCC            GO TEST FOR INTERRUPT IF NOP      R4 S1617000
         CLI   0(R1),X'FE'         TEST CHANNEL COMMAND TYPE        R41 S1617500
         BNL   MVPTRUNC            BR IF SEND PDIR OR BUFFER TRUNC  R41 S1618000
         LTR   MBUF,MBUF           TEST BUFFER ADDRESS               R4 S1618500
         BNZ   MVPUTBUF            BRANCH IF NOT ZERO                R4 S1619500
         SPACE 1                                                     R4 S1623000
MVPRPLGT BAL   ML,MVRPLGET         GET AN OUTPUT BUFFER              R4 S1623500
         MVI   SCWFLAGS,SCWTRNSP+SCWNSPAN  INITIALIZE COMPOSER FLAGS R4 S1624000
         NI    MDCTFMT,255-DCTPALTC  RESET STREAM ALTERN CODE FLAG   R4 S1624500
         TM    BINCMNP-ISTDBIND+ICEBIND,BINALT  TEST COMMON PROTOCOL R4 S1625000
         BZ    SKIP270             BRANCH IF ALT CODE NOT TO BE USED R4 S1625500
         OI    MDCTFMT,DCTPALTC    TURN ON STREAM ALTERNATE CODE BIT R4 S1626000
         MVI   SCWFLAGS,SCWNSPAN   PRECLUDE TRANSPARENCY CHECK       R4 S1626500
SKIP270  CLI   DCTDEVTP,DCTRPU     TEST DEVICE TYPE                  R4 S1627000
         BE    SKIP280             BRANCH IF REMOTE PUNCH            R4 S1627500
         MVI   SCWFLAGS,SCWTRNSP   TRANSP CHECK AND SPANNING   @OZ20661 S1628000
SKIP280  MVC   SCWCCWA,MSCSCC      INITIALIZE CARRIAGE CONTRL STRING R4 S1628500
         BAL   R14,MVPRPLAN        SET COMPOSER INITIAL STATE       R41 S1628800
         L     R1,PCER0            BRING BACK CCW ADDRESS            R4 S1629000
         CLI   0(R1),X'03'         IF NOP CCW                       R41 S1629100
         BE    MVPNMORE             GO CHECK FOR INTERRUPTS         R41 S1629200
         EJECT                                                      R41 S1629500
MVPUTBUF SLR   R0,R0               CLEAR REG FOR REMOTE DEVICE WIDTH R4 S1630000
         IC    R0,MDCTRECL         LOAD REMOTE DEVICE WIDTH          R4 S1630500
         CLI   DCTDEVTP,DCTRPU     TEST DEVICE TYPE                  R4 S1631000
         BE    MVPUNCH             BRANCH IF REMOTE PUNCH            R4 S1631500
         CLI   0(R1),X'61'         TEST CURRENT COMMAND TYPE         R4 S1632000
         BE    MVPUTFCB            BRANCH IF LOAD FCB                R4 S1632500
         TM    0(R1),X'02'         TEST CURRENT COMMAND TYPE         R4 S1633000
         BZ    MVPNIMED            BRANCH IF NOT IMMEDIATE COMMAND   R4 S1633500
         TM    0(R1),X'80'         TEST CURRENT COMMAND TYPE         R4 S1634000
         BZ    MVPUTCCI            BRANCH IF NOT SKIP                R4 S1634500
         OI    SCWLCCC,X'02'       FORCE PREVIOUS COMMAND IMMEDIATE  R4 S1635000
         CLC   SCWLCCC,0(R1)       COMPARE PREVIOUS CMD. TO CURRENT  R4 S1635500
         BE    MVPNMORE            EXIT IF REDUNDANT SKIP           R41 S1636000
         B     MVPUTCCI            REJOIN COMMON PROCESSING          R4 S1636500
         SPACE 3                                                    R41 S1637000
MVPUNCH  MVI   0(R1),X'79'         FORCE INTER-RECORD SEPARATOR      R4 S1637500
         SPACE 1                                                     R4 S1638000
MVPNIMED L     R14,0(,R1)          PICK UP DATA ADDRESS FROM CCW     R4 S1638500
         LH    R15,6(,R1)          PICK UP DATA LENGTH  FROM CCW     R4 S1639000
         LA    R14,0(,R14)         DISCARD OP CODE                   R4 S1639500
         CLR   R15,R0              COMPARE LENGTH WITH MAXIMUM       R4 S1640000
         BNH   MVPUT0              BR IF LENGTH NOT OVER MAX   @OZ29180 S1640500
         LR    R15,R0              REPLACE LENGTH WITH MAXIMUM       R4 S1641000
         EJECT                                                 @OZ29180 S1641050
MVPUT0   TM    MDCTFEAT,DCTPCCTL   TEST FOR CARRIAGE CNTRLS    @OZ29180 S1641100
         BO    MVPUTCCI            BRANCH IF YES               @OZ29180 S1641150
         LH    ML,ICERULEN         COMPUTE NUMBER OF AVAIL     @OZ29180 S1641200
         SL    ML,RPLRLEN             BYTES IN THE BUFFER      @OZ29180 S1641250
         CR    ML,R0               COMPARE DEVICE RECORD LEN   @OZ29180 S1641300
         BNL   MVPUT1              BRANCH IF ENOUGH ROOM       @OZ29180 S1641350
         BAL   ML,MVRPLSND         SEND BUFFER                 @OZ29180 S1641400
         B     MVPRPLGT            GET ANOTHER BUFFER          @OZ29180 S1641450
         SPACE 1                                               @OZ29180 S1641500
MVPUT1   L     RSINK,RPLAREA       COMPUTE ADDRESS OF NEXT     @OZ29180 S1641550
         AL    RSINK,RPLRLEN         AVAILABLE BYTE IN BUFFER  @OZ29180 S1641600
         LR    ML,RLSRCE           MOVE                        @OZ29180 S1641650
         BCTR  ML,0                  SOURCE STRING             @OZ29180 S1641700
         EX    ML,MVPUTMVC              TO BUFFER              @OZ29180 S1641750
         LR    ML,R0               GET DEVICE RECORD LENGTH    @OZ29180 S1641800
         SLR   ML,RLSRCE           TRAILING BLANKS REQUIRED    @OZ29180 S1641850
         BP    MVPUT2              BRANCH IF NOT               @OZ39661 S1641900
         AR    RSINK,RLSRCE        NEXT AVAIL BYTE IN BUFFER   @OZ29180 S1641950
         MVI   0(RSINK),C' '       PAD WITH AT LEAST 1 BLANK   @OZ29180 S1642000
         BCTR  ML,0                DECREMENT TRAILING BLNK CNT @OZ29180 S1642050
         LTR   ML,ML               IS THE BUFFER FULL          @OZ29180 S1642100
         BZ    MVPUT2              BRANCH IF YES               @OZ29180 S1642150
         BCTR  ML,0                PAD REST OF BUFFER          @OZ29180 S1642200
         EX    ML,MVPUTNCB           WITH BLANKS               @OZ29180 S1642250
         SPACE 1                                               @OZ29180 S1642300
MVPUT2   AL    R0,RPLRLEN          UPDATE THE RPL              @OZ29180 S1642350
         ST    R0,RPLRLEN            RECORD LENGTH COUNT       @OZ29180 S1642400
         B     MVPNMORE            LOOK FOR MORE DATA          @OZ29180 S1642450
         SPACE 1                                               @OZ29180 S1642500
MVPUTNCB MVC   1(*-*,RSINK),0(RSINK)    ***  EXECUTED  ***     @OZ29180 S1642550
         SPACE 2                                               @OZ29180 S1642600
MVPUTCCI MVC   SCWLCCC,0(R1)       MOVE COM. CODE TO WORKAREA  @OZ29180 S1642650
         SPACE 1                                               @OZ29180 S1642700
MVPUT    BAL   ML,MVKOMPOZ         INVOKE SNA R.U. COMPOSER    @OZ29180 S1642750
         TM    SCWFLAGS,SCWMORE    TEST COMPOSER FLAGS               R4 S1643000
         BZ    MVPNMORE            BRANCH IF NO MORE DATA TO COMPOSE R4 S1643500
         TM    SCWFLAGS,SCWNSPAN   TEST COMPOSER FLAGS               R4 S1644000
         LA    ML,MVPRPLGT         SEND RPL AND RE-ENTER AFTER CALL  R4 S1644500
         BO    MVRPLSND             IF CROSS-R.U. SPANNING FORBIDDEN R4 S1645000
         BAL   ML,MVRPLGET         ELSE GET ANOTHER OUTPUT BUFFER    R4 S1645500
         L     WA,RPLNEXT          GET ADDRESS OF NEW BUFFER         R4 S1646000
         MVC   SCWKOMSA-RPLDSECT(L'SCWKOMSA,WA),SCWKOMSA               CS1646500
                                   COPY WORK AREA TO NEW BUFFER      R4 S1647000
         BAL   ML,MVRPLSND         CALL SEND ROUTINE FOR OLD BUFFER R41 S1647500
         BAL   R14,MVPRPLAN        SET COMPOSER INITIAL STATE IN NEWR41 S1647800
         B     MVPUT               GO CONTINUE COMPOSING            R41 S1648000
         EJECT                                                      R41 S1648500
MVPNOPCC LTR   MBUF,MBUF           TEST BUFFER ADDRESS               R4 S1649000
         BZ    MVPRPLGT            GO GET BUF IN CASE CHAIN ENDING  R41 S1649500
         SPACE 1                                                    R41 S1651000
MVPNMORE TM    MDCTSEL,FMHMEDIA    TEST MEDIA TYPE                  R41 S1651100
         BZ    MVPNMFUL            BRANCH IF CONSOLE           @OZ19494 S1651200
         TM    ICEFLGS2,ICEBREAK   TEST FOR HIGH PRI INTERRUPT @OZ19494 S1651300
         BO    MVPENDCH            BR IF YES --  END CHAIN     @OZ19494 S1651400
         SPACE 1                                               @OZ19494 S1651500
         PRINT OFF                 THIS SECTION DELETED BY     @OZ19494 S1651600
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1651700
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1651800
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1651900
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1652000
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1652100
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1652200
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1652300
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1652400
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1652500
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1652600
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1652700
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1652800
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1652900
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1653000
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1653100
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1653200
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1653300
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1653350
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1653400
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1657000
*                                  THIS LINE DELETED BY APAR   @OZ19494 S1657500
         PRINT ON                  THIS SECTION DELETED BY     @OZ19494 S1658000
         SPACE 1                                                     R4 S1658500
MVPNMFUL TM    SCWFLAGS,SCWFULL    TEST COMPOSER FLAGS               R4 S1659000
         BZ    MVTAMXIT            RETURN TO PROCESSOR IF ROOM LEFT  R4 S1659500
         B     MVPUTRPL            ELSE R.U. IS FULL, GO SEND IT     R4 S1660000
         EJECT                                                      R41 S1660500
MVPUTCPR MVC   ICERCPTN,DCTACPTN   SHOW REQUEST PROCESSED           R41 S1660600
         LTR   MBUF,MBUF           TEST BUFFER ADDRESS              R41 S1660700
         BZR   ML                  RETURN TO HANDLE COMMAND IF NONE R41 S1660800
         CLC   ICERULEN,RPLRLEN+2  CHECK BUFFER LENGTH              R41 S1660900
         BNH   MVRPLSND            IF FULL, SEND RPL & RE-ENTER     R41 S1661000
         BAL   R14,MVPRPLAN        ELSE RESET COMPOSER STATE        R41 S1661100
         BR    ML                  RETURN TO HANDLE COMMAND         R41 S1661200
         SPACE 1                                                    R41 S1661300
MVPUTCP1 L     R14,$CPTPOOL        FIND FIRST COMPACTION TABLE      R41 S1661400
         MVC   DCTACPTN,CPTNUM-CPTDSECT(R14)  PREPARE TO SEND IT    R41 S1661500
MVPUTCPA CLI   ICERCPTN,X'FF'      TEST PREVIOUS REQUEST STATUS     R41 S1661600
         BNE   MVPUTCPB            BRANCH IF O.K.                   R41 S1661700
         MVC   ICERCPTN,ICEACPTN   ELSE EARLIER FMH TYPE 3          R41 S1661800
         BAL   R14,MVFMHCPA         FAILED--RESTORE ADDRESS         R41 S1661900
         LA    R1,0            +0    OF LAST COMPACTION TABLE       R41 S1662000
         ST    R1,ICECPT       +4     SUCCESSFULLY USED ON SESSION  R41 S1662100
MVPUTCPB TM    MDCTFMT,DCTPCPCT    TEST DATA STREAM FORMAT          R41 S1662200
         BO    MVPUTCPC            BRANCH IF COMPACTION ALLOWED     R41 S1662300
         MVI   DCTACPTN,0          ELSE FORCE A SUPPRESS REQUEST    R41 S1662400
MVPUTCPC CLI   DCTACPTN,0          TEST DESIRED COMPACTION TABLE #  R41 S1662500
         BE    MVPUTCPR            BRANCH IF SUPPRESS REQUEST       R41 S1662600
         CLC   ICEACPTN,DCTACPTN   COMPARE ACTIVE & DESIRED TABLES  R41 S1662700
         BE    MVPUTCPR            BRANCH IF REACTIVATE REQUEST     R41 S1662800
         SPACE 3                                                    R41 S1662900
MVPTRUNC LTR   MBUF,MBUF           TEST BUFFER ADDRESS               R4 S1663000
         BNZ   MVPENDCH            GO FORCE END CHAIN IF HAVE BUFFER R4 S1663100
         TM    ICESNDST,ICEINCHN   TEST SESSION SEND STATUS          R4 S1663200
         BZ    MVPUTFMH            BRANCH IF NOT IN CHAIN           R41 S1663300
         BAL   ML,MVRPLGET         ELSE GET BUFFER JUST TO END CHAIN R4 S1665500
         SPACE 2                                                    R41 S1666000
MVPENDCH TM    ICESNDST,ICEINCHN   TEST SEND STREAM STATUS          R41 S1667000
         BO    MVPUTEOC            GO SEND R.U. IF ALREADY IN CHAIN R41 S1667500
         L     R1,RPLRLEN          OTHERWISE TEST                    R4 S1668000
         LTR   R1,R1                R.U. LENGTH                      R4 S1668500
         LA    ML,MVPUTFMH         LOAD RETURN FOR BUFFER FREE RTNE R41 S1672500
         BZ    MVFREOUT            IF BUFFER EMPTY, DISCARD IT AND  R41CS1673000
                                    RETURN TO FM-HEADER CHECK BELOW R41 S1673500
MVPUTEOC OI    ICESNDST,ICEOCPND   SET 'END OF CHAIN PENDING' FLAG  R41 S1674000
         EJECT                                                      R41 S1674500
MVPUTRPL BAL   ML,MVRPLSND         CALL BUFFER SEND ROUTINE          R4 S1675000
         TM    ICESNDST,ICEINCHN   TEST RTAM CHAIN STATE             R4 S1675500
         BO    MVTAMXIT            RETURN TO PROCESSOR IF IN CHAIN   R4 S1676000
         SPACE 1                                                     R4 S1676500
MVPUTFMH DS    0H                  TEST FUNCTIONS NEEDING FM HEADER R41 S1676600
         CLC   ICERCPTN,DCTACPTN   IF PREV REQUEST & LATEST UNEQUAL R41 S1676700
         BNE   MVPUTCPT             GO SWITCH COMPACTION TABLES     R41 S1676800
         L     R1,PCER0            TEST CHANNEL                     R41 S1676900
         CLI   0(R1),X'FE'          COMMAND TYPE                    R41 S1677000
         BNE   MVPITRPT            BRANCH IF NOT SEND PDIR          R41 S1677100
         BAL   ML,MVRPLGET         GET A BUFFER FOR TYPE 2 FM HDR   R41 S1677200
         L     WA,RPLAREA          GET DATA ADDRESS IN BUFFER       R41 S1677300
         L     R1,PCER0            PICK UP TYPE 2                   R41 S1677400
         L     R14,0(,R1)           FM HDR ADDRESS &                R41 S1677500
         LH    R15,6(,R1)            LENGTH FROM CCW                R41 S1677600
         ST    R15,RPLRLEN         STORE R.U. LENGTH                R41 S1677700
         BCTR  R15,0               DECREASE BY 1 FOR MACHINE LTH    R41 S1677800
         EX    R15,MVPUTMVC        COPY FM HEADER INTO BUFFER       R41 S1677900
         OI    RPLOPT12,RPLFMHDR   SET FORMAT (FM HDR) INDICATOR    R41 S1678000
         OI    ICESNDST,ICEOCPND   SET END CHN TO FORCE IMM FMH SENDR41 S1678100
         BAL   ML,MVRPLSND         CALL BUFFER SEND ROUTINE         R41 S1678200
         SPACE 1                                                    R41 S1678300
MVPITRPT TM    MDCTSEL,FMHMEDIA    TEST MEDIA TYPE                  R41 S1678400
         BZ    MVTAMXIT            BR IF CONSOLE, IGNORE INTERRUPT  R41 S1678500
         SPACE 1                                                    R41 S1678600
         TM    ICEFLGS2,ICESIGNL+ICEBREAK TEST INTERRUPT FLAGS @OZ29180 S1678700
         BNZ   MVPSUSPD            GO SUSPEND WITH CHANGE DIRECTION R41CS1678800
                                    IF 'SIGNAL' HAS BEEN RECEIVED   R41 S1678900
         TM    ICEFLGS2,ICEOUTBK   ELSE TEST OUTBOUND TP INDICA@OZ29180 S1679000
         BZ    MVTAMXIT            RETURN IF NOT INTERRUPTING FOR   R41CS1679100
                                    HIGHER PRIORITY OUTBOUND STREAM R41 S1679200
         B     MVPSUSP1            GO SUSPEND WITHOUT CHG DIRECTION R41 S1679300
         SPACE 1                                                     R4 S1679400
MVPSUSPD OI    ICEFLAGS,ICECHDIR   SET 'CHGE DIRECTION PENDING' FLAG R4 S1679500
         NI    ICEFLGS2,255-ICESIGNL-ICEBREAK RESET INTR FLAGS @OZ29180 S1679600
MVPSUSP1 BAL   ML,MVRPLGET         GET A BUFFER FOR SUSPEND FM HDR  R41 S1679700
         OI    ICESNDST,ICEOCPND   SET END CHN TO FORCE IMM FMH SENDR41 S1680000
         LA    R1,FMHSUSPD         LOAD DATA STREAM 'SUSPEND' CODE   R4 S1680500
         BAL   ML,MVFMHBLD         BUILD & SEND FMH, WAIT FOR RESUME R4 S1681000
         BAL   ML,MVRPLGET         GET BUFFER FOR 'RESUME' FM HEADER R4 S1681500
         OI    ICESNDST,ICEOCPND   SET END CHN TO FORCE IMM FMH SEND R4 S1682000
         LA    R1,FMHRESUM         LOAD 'RESUME' DATA STREAM ACTION  R4 S1682500
         LA    ML,MVPITRPT         LOAD RETURN FOR SNA FM HDR RTNE  R41 S1683000
         B     MVFMHBLD            BUILD & SEND 'RESUME' FM HEADER   R4 S1683500
         SPACE 1                                                    R41 S1683700
MVPUTMVC MVC   0(*-*,WA),0(R14)    ** EXECUTE ONLY **               R41 S1683800
         EJECT                                                      R41 S1684000
*                                                                    R4 S1684500
*                        CHECK IF MUST LEAVE ALT CODE TO SEND 'SVF'  R4 S1685000
*                                                                    R4 S1685500
         SPACE 1                                                     R4 S1686000
MVPUTFCB TM    MDCTFMT,DCTPALTC    TEST STREAM FORMAT                R4 S1686500
         BZ    MVPUTFNA            BRANCH IF NOT ALTERNATE CODE      R4 S1687000
         L     R15,RPLRLEN         GET AND TEST                      R4 S1687500
         LTR   R15,R15              CURRENT R.U. LENGTH              R4 S1688000
         BZ    SKIP300             BRANCH IF R.U. EMPTY              R4 S1688500
         BAL   ML,MVRPLSND         CALL BUFFER SEND ROUTINE          R4 S1689000
         BAL   ML,MVRPLGET         GET ANOTHER OUTPUT BUFFER         R4 S1689500
         L     R1,PCER0            BRING BACK CCW ADDRESS            R4 S1690000
SKIP300  NI    MDCTFMT,255-DCTPALTC  CHG STREAM FORMAT TO EBCDIC     R4 S1690500
         OI    SCWFLAGS,SCWFULL    FORCE R.U. TO CONTAIN ONLY 'SVF'  R4 S1691000
         SPACE 1                                                     R4 S1691500
MVPUTFNA LA    R0,181              LOAD MAX ALLOWABLE FCB LENGTH     R4 S1692000
         OI    0(R1),X'02'         SET MISSING IMMEDIATE COMMAND BIT R4 S1692500
         B     MVPNIMED            REJOIN MAIN-LINE PROCESSING       R4 S1693000
         SPACE 3                                                    R41 S1693500
*                                                                   R41 S1694000
*                             SET COMPOSER PLANNER INITIAL STATE    R41 S1694500
*                                                                   R41 S1695000
         SPACE 1                                                    R41 S1695500
MVPRPLAN LH    R0,ICERULEN         INITIALIZE                       R41 S1696000
         AL    R0,RPLAREA           END OF R.U.                     R41 S1696500
         BCTR  R0,0                  ADDRESS IN                     R41 S1697000
         ST    R0,SCWRUEND            WORK AREA                     R41 S1697500
         TM    MDCTFMT,DCTPPRES+DCTPCPCT  TEST DATA STREAM FORMAT   R41 S1698000
         BZR   R14                 RETURN IF NO COMPRESSION DESIRED R41 S1698500
         BM    MVPRPLA1            BRANCH IF COMPRESSION ONLY       R41 S1699000
         TM    MDCTSEL,FMHMEDIA    TEST FOR CONSOLE                 R41 S1699100
         BZ    MVPRPLA1            SUPPRESS COMPACTION IF CONSOLE   R41 S1699200
         LA    R0,MVKQEY           POINT TO COMPACTION EMPTY STATE  R41 S1699500
         CLI   ICERCPTN,0          TEST ACTIVE COMPACTION TABLE NUM R41 S1700000
         BNE   MVPRPLA2            BRANCH IF COMPACT NOT SUPPRESSED R41 S1700500
MVPRPLA1 LA    R0,MVKPEY           POINT TO COMPRESSION EMPTY STATE R41 S1701000
MVPRPLA2 ST    R0,SCWPLAN          SET COMPOSER INITIAL STATE       R41 S1701500
         SLR   R0,R0               SET COMPOSER INITIAL             R41 S1702000
         ST    R0,SCWCPARS          COMPACTION RACING STATE         R41 S1702500
         BR    R14                 RETURN TO CALLER                 R41 S1703000
         EJECT                                                      R41 S1703500
*                                                                   R41 S1704000
*                             SEND COMPACTION TABLE FM HEADER       R41 S1704500
*                                                                   R41 S1705000
         SPACE 1                                                    R41 S1705500
MVPUTCPT BAL   ML,MVRPLGET         GET A BUFFER FOR TYPE 3 FM HDR   R41 S1706000
         BAL   R14,MVFMHCPA        LOOK UP COMPACTION TABLE NUMBER  R41 S1706500
         B     MVPIVCPN        +0  ERROR EXIT - GO DISPLAY MESSAGE  R41 S1707000
         ST    R1,ICECPT       +4  SAVE COMPACTION TABLE LOC IN ICE R41 S1707500
         MVI   ICERCPTN,X'FF'      SHOW TABLE SWITCH IN PROGRESS    R41 S1708000
         BAL   ML,MVFMHCPT         BUILD & SEND COMPACTION TABLE    R41 S1708500
         L     R1,ICECPT           LOAD NEW COMPACTION TABLE ADDR   R41 S1709000
         IC    R0,CPTNUM-CPTDSECT(,R1)  SHOW TABLE                  R41 S1709500
         STC   R0,ICEACPTN               SWITCH WAS                 R41 S1710000
         STC   R0,ICERCPTN                SUCCESSFUL                R41 S1710500
         B     MVPINSTR            RE-ENTER TO PROCESS COMMAND      R41 S1711000
         EJECT                                                      R41 S1711500
MVPIVCPW $WAIT  CMB,SAVE=NO        WAIT FOR A CMB                   R41 S1711600
         L      R1,PCER1           RELOAD CALLERS DCT ADDRESS       R41 S1711700
        $RESTORE                   RESTABLISH RTAM REGISTERS        R41 S1711800
         SPACE 1                                                    R41 S1711900
MVPIVCPN DS    0H                                                   R41 S1712000
        $GETCMB NUMCMB=1           GET A CMB FOR THE MESSAGE        R41 S1712100
         BZ    MVPIVCPW            BR IF NO CMB -- WAIT             R41 S1712200
         SPACE 1                                                    R41 S1712300
         LA    WA,CMBTEXT-CMB(,R1) POINT TO CMB MESSAGE AREA        R41 S1712400
         SLR   R0,R0               RELOAD INVALID COMAPACTION       R41 S1712500
         IC    R0,DCTACPTN         TABLE NUMBER                     R41 S1712600
         MVI   ICERCPTN,0          SUPPRESS TABLE                   R41 S1712700
         MVI   DCTACPTN,0           NUMBER REQUEST                  R41 S1712800
         MVC   0(L'MVPIVCM,WA),MVPIVCM  MOVE IN MESSAGE TEMPLATE... R41 S1712900
         MVC   MVPIVNM(L'DCTDEVN,WA),DCTDEVN ... ADD DEVICE NAME    R4  S1713000
         CVD   R0,SCWCCWA              PLACE INVALID                R41 S1713100
         ED    MVPIVCT(,WA),SCWCCWA+6    TABLE NUMBER IN MESSAGE    R41 S1713200
         L     JCT,PCEJCT          RELOAD CALLERS JCT ADDR FOR WTO  R41 S1713300
        $WTO   (R1),L'MVPIVCM,JOB=YES,CMB=YES,WAIT=NO,  ISSUE       R41CS1713400
               ROUTE=$LOG+$TP+$UR,CLASS=$ACTION,PRI=$ST  MESSAGE    R41 S1713500
         LM    R0,R1,PCER0         RELOAD R0, AND R1 ENTRY VALUES   R41 S1713600
        $RESTORE                   RELOAD ACCESS METHOD REGISTERS   R41 S1713700
         BAL   ML,MVFREOUT         DISCARD UNUSED BUFFER            R41 S1713800
         B     MVPINSTR            RE-ENTER TO PROCESS COMMAND      R41 S1713900
         SPACE 1                                                    R41 S1714000
MVPIVCM $MSG   211,'RNNN.PRN COMPACTION TABLE NNN NOT FOUND'        R41 S1714100
MVPIVNM  EQU   2,8                 OFFSET TO DEVICE NAME IN MESSAGE R41 S1714200
MVPIVCT  EQU   27,4                OFFSET TO EDIT PATERN IN MESSAGE R41 S1714300
         SPACE 1                                                    R41 S1714400
         ORG   MVPIVCM+MVPIVCT     PLACE TABLE NUMBER EDIT          R41 S1714500
         DC    X'40202120'          PATTERN IN MESSAGE TEMPLATE     R41 S1714600
         ORG   ,                                                    R41 S1714700
         CNOP  2,4                 REALIGN                          R41 S1714800
         EJECT                                                      R41 S1714900
*********************************************************************** S1753000
*                                                                     * S1753500
*                        SNA R.U. COMPOSER                            * S1754000
*                                                                     * S1754500
*           OBJECTIVE - ACCEPT A CHANNEL COMMAND CODE IN              * S1755000
*           WORK AREA LOC 'SCWLCCC' AND A DATA ADDRESS AND            * S1755500
*           LENGTH IN REGS 'RSRCE' AND 'RLSRCE'.  ACCORDING           * S1756000
*           TO WHETHER COMPRESSION, COMPACTION, OR NEITHER            * S1758500
*           IS SPECIFIED, CALL ONE OF THREE SETS OF ROUTINES          * S1759000
*           TO TRANSFER THE DATA TO THE R.U. BUFFER.  IF AN           * S1760000
*           R.U. BUFFER BECOMES FULL DURING THE OPERATION,            * S1760500
*           AND MORE DATA REMAINS TO BE PROCESSED, RETURN TO          * S1761000
*           CALLER WITH 'SCWMORE' FLAG SET.  CALLER SHOULD            * S1761500
*           OBTAIN A NEW BUFFER, COPY COMPOSER WORK AREA AND          * S1762000
*           SAVE AREA INTO IT, SEND THE FULL R.U., AND CALL           * S1762500
*           COMPOSER AGAIN TO PROCESS THE REMAINING DATA.             * S1763000
*                                                                     * S1763500
*           IF AN R.U. BUFFER BECOMES FULL ON THE LAST BYTE           * S1764000
*           OF THE OPERATION, RETURN TO CALLER WITH THE               * S1764500
*           'SCWFULL' FLAG SET.  CALLER SHOULD SEND THE OLD           * S1765000
*           BUFFER.  IF THE R.U. BUFFER IS NOT FULL AT THE            * S1765500
*           COMPLETION OF THE OPERATION, RETURN WITH NEITHER          * S1766000
*           'SCWMORE' NOR 'SCWFULL' SET.  THE CALLER MAY              * S1766500
*           STILL SEND THE R.U. ON THE BASIS OF EXTERNAL              * S1767000
*           REQUIREMENTS TO TRUNCATE OR END THE CHAIN, ETC.           * S1767500
*                                                                     * S1768000
*           CERTAIN VALUES MUST BE STORED IN THE COMPOSER             * S1768500
*           SAVE AREA BETWEEN CALLS.  IN A NEW BUFFER,                * S1769000
*           COMPOSER FLAG BYTE 'SCWFLAGS' IS ASSUMED ZERO.            * S1769500
*           THE CARRIAGE CONTROL STRING 'SCWCCWA' SHOULD BE           * S1770000
*           INITIALIZED.  OTHER DATA STORED IN THE SAVE AREA          * S1770500
*           WILL BE MANAGED BY THE COMPOSER.                          * S1771000
*                                                                     * S1772000
*           THE COMPOSER ROUTINES ARE LABELLED AS FOLLOWS -           * S1772500
*                MVKO - GENERAL ROUTINES                              * S1773000
*                MVKD - NONCOMPRESS/NONCOMPACT FEEDER ROUTINE         * S1778000
*                MVKE - COMPRESS/COMPACT EMITTER ROUTINE              * S1778500
*                MVKF - COMPRESS/COMPACT FEEDER ROUTINE               * S1779000
*                MVKP - COMPRESSION PLANNER ROUTINES                  * S1779500
*                MVKQ - COMPACTION PLANNER ROUTINES                   * S1780000
*                MVKU - NONCOMPRESS/NONCOMPACT MOVER ROUTINE          * S1780500
*                MVKV - COMPRESSION MOVER ROUTINES                    * S1781000
*                MVKW - COMPACTION MOVER ROUTINES                     * S1781500
*                MVKZ - COMPRESS/COMPACT R.U. SEND ROUTINE            * S1782000
*                                                                     * S1783000
*********************************************************************** S1783500
         SPACE 1                                                     R4 S1784000
MVKOMPOZ ST    ML,SCWRETRN         SAVE RETURN ADDRESS               R4 S1784500
         LA    RBY1,1              LOAD REGISTER CONSTANT OF 1       R4 S1785000
         L     RSINK,RPLAREA       CALCULATE CURRENT                 R4 S1785500
         AL    RSINK,RPLRLEN        R.U. POSITION                    R4 S1786000
         L     REND,SCWRUEND       GET END OF R.U. ADDRESS          R41 S1786500
         LA    RBASE,MVKOVSUB      GET COMPOSER SUBS ADDRESSABILITY R41 S1786800
         TM    MDCTFMT,DCTPPRES    TEST DATA STREAM FORMAT           R4 S1787000
         BO    MVKOMPRS            BRANCH IF COMPRESSION SPECIFIED   R4 S1787500
         EJECT                                                       R4 S1788000
*********************************************************************** S1788500
*                                                                     * S1789000
*                   NONCOMPRESS/COMPACT FEEDER ROUTINE                * S1791000
*                                                                     * S1792000
*           OBJECTIVE - FOR IMMEDIATE COMMANDS, GENERATE THE          * S1792500
*           SCS CONTROL STRING EQUIVALENT, FEED IT TO THE             * S1793000
*           BUFFER FILL ROUTINE (B.F.R.), AND RETURN.  FOR            * S1793500
*           NON-IMMEDIATE COMMANDS, GENERATE AND FEED TRANS-          * S1794000
*           PARENT FRAME SEQUENCE TO B.F.R. IF REQUIRED.              * S1794500
*           FEED DATA STRING TO B.F.R. (ADJUSTING LENGTH TO           * S1795000
*           SUPPRESS TRAILING BLANKS, UNLESS TRANSPARENCY             * S1795500
*           FRAME GENERATION ALREADY DID THIS). GENERATE AND          * S1796000
*           FEED CHANNEL COMMAND'S SCS CONTROL STRING EQUI-           * S1796500
*           LENT TO B.F.R., AND RETURN.                               * S1797000
*                                                                     * S1797500
*           IF THE B.F.R. DETECTS A FULL BUFFER DURING THE            * S1798000
*           MOVE OF ANY STRING, RETURN FROM THE COMPOSER IS           * S1798500
*           MADE WITH FLAG 'SCWMORE' SET.  AFTER CALLER HAS           * S1799000
*           GOTTEN A NEW BUFFER AND SENT THE R.U., THE                * S1799500
*           COMPOSER IS REINVOKED TO PROCESS THE EXCESS.              * S1800000
*                                                                     * S1800500
*           ON NORMAL RETURN FLAG 'SCWMORE' IS OFF. IN ADDI-          * S1801000
*           TION, IF THE CONTROL STRING WAS JUST LONG ENOUGH          * S1801500
*           TO FILL THE LAST BUFFER (INDICATED BY B.F.R.              * S1802000
*           COND.CODE), TURN ON 'SCWFULL' FLAG TO INSTRUCT            * S1802500
*           CALLER THAT R.U. IS READY TO SEND.                        * S1803000
*                                                                     * S1803500
*********************************************************************** S1804000
         SPACE 2                                                    R41 S1804500
         PUSH  USING               SAVE ACCESS METHOD REGISTER USE  R41 S1804600
         USING MVKOVSUB,RBASE      COMPOSER SEGMENT ADDRESSABILITY  R41 S1804700
         SPACE 2                                                    R41 S1804800
         SLR   REND,RSINK          CALC # OF UNUSED                 R41 S1805000
         ALR   REND,RBY1            BYTES IN THE R.U.               R41 S1805100
         SPACE 1                                                     R4 S1805500
         TM    SCWFLAGS,SCWMORE    TEST COMPOSER FLAGS               R4 S1806000
         BO    MVKUCNUE            BRANCH IF CONTINUING PREV. CALL   R4 S1806500
         SPACE 1                                                     R4 S1807000
         OI    SCWFLAGS,SCWMORE    INDICATE COMPOSING IN PROGRESS    R4 S1807500
         TM    SCWLCCC,X'02'       TEST CURRENT COMMAND TYPE         R4 S1808000
         BO    MVKDCTRL            BRANCH IF IMMEDIATE COMMAND       R4 S1808500
         BAL   RFEED,MVKOTPCY      CALL TRANSPARENCY CHECK ROUTINE   R4 S1809000
         BM    MVKDCTRL            BRANCH IF ZERO LENGTH IN CCW      R4 S1809500
         BZ    MVKDSCAN            BRANCH IF NO VALUES BELOW X'40'   R4 S1810000
         SPACE 1                                                     R4 S1810500
*                        FEED TRANSPARENT FRAME SEQUENCE             R4 S1811000
         SPACE 1                                                     R4 S1811500
         OI    SCWFLAGS,SCWCTRL    INDICATE SOURCE IS CONTROL STRING R4 S1812000
         BAL   RFEED,MVKUFILL      CALL BUFFER FILL ROUTINE          R4 S1812500
         L     RLSRCE,SCWLINPT     RESTORE LENGTH OF SOURCE STRING   R4 S1813000
         B     MVKDDATA            BYPASS SCAN FOR TRAILING BLANKS   R4 S1813500
         EJECT                                                       R4 S1814000
*                        ADJUST LENGTH TO SUPPRESS TRAILING BLANKS   R4 S1814500
         SPACE 1                                                     R4 S1815000
MVKDSCAN ST    RSRCE,SCWINPT       SAVE ADDRESS OF SOURCE STRING     R4 S1815500
         ALR   RSRCE,RLSRCE        GENERATE ADDRESS OF LAST BYTE + 1 R4 S1816000
         LA    RFEED,MVKDDATA      OPTIMIZE LOOP WITH ADDRESS IN REG R4 S1816500
SKIP310  BCTR  RSRCE,0             SCAN BACKWARDS                    R4 S1817000
         CLI   0(RSRCE),C' '        ELIMINATING                      R4 S1817500
         BNER  RFEED                 TRAILING                        R4 S1818000
         BCT   RLSRCE,SKIP310         BLANKS                         R4 S1818500
         B     MVKDCTRL            GO DO CARRIAGE CTRL IF ALL BLANK  R4 S1819000
         SPACE 1                                                     R4 S1819500
*                        FEED DATA STRING (TEXT POINTED TO BY CCW)   R4 S1820000
         SPACE 1                                                     R4 S1820500
MVKDDATA L     RSRCE,SCWINPT       RESTORE ADDRESS OF SOURCE STRING  R4 S1821000
         NI    SCWFLAGS,255-SCWCTRL  INDICATE SOURCE IS TEXT STRING  R4 S1821500
         BAL   RFEED,MVKUFILL      CALL BUFFER FILL ROUTINE          R4 S1822000
         SPACE 1                                                     R4 S1822500
*                        FEED SCS CARRIAGE CONTROL STRING            R4 S1823000
         SPACE 1                                                     R4 S1823500
MVKDCTRL TM    MDCTFEAT,DCTPCCTL   TEST FOR CARRIAGE CONTROLS  @OZ29180 S1823600
         BZ    MVKDNCTR            BRANCH IF NOT ALLOWED       @OZ29180 S1823700
         BAL   RFEED,MVKOCCDE      CALL CAR'GE CTL DCODE RTN   @OZ29180 S1824000
         BAL   RFEED,MVKUFILL      CALL BUFFER FILL ROUTINE          R4 S1824500
         BZ    MVKDTRNC            BRANCH IF R.U. FULL               R4 S1825000
MVKDNCTR NI    SCWFLAGS,255-SCWMORE  INDICATE COMPOSING CMPLTE @OZ29180 S1825500
         L     REND,RPLAREA        CALCULATE AND                     R4 S1826000
         SLR   RSINK,REND           STORE CURRENT                    R4 S1826500
         ST    RSINK,RPLRLEN         R.U. LENGTH                     R4 S1827000
         L     MBASE2,MVKOVSUB     RESTORE SNA SUBS BASE REGISTER   R41 S1827200
         L     ML,SCWRETRN         RETRIEVE COMPOSER RETURN ADDRESS  R4 S1827500
         BR    ML                  RETURN TO CALLER                 R41 S1828000
         SPACE 3                                                     R4 S1828500
*                        FORCE SCHEDULING OF FULL BUFFER             R4 S1829000
         SPACE 1                                                     R4 S1829500
MVKDTRNC NI    SCWFLAGS,255-SCWMORE  INDICATE COMPOSING COMPLETE     R4 S1830000
         OI    SCWFLAGS,SCWFULL    FORCE BUFFER TO BE SCHEDULED      R4 S1830500
         B     MVKUFLEN            BRANCH TO SET LENGTH AND RETURN   R4 S1831000
         EJECT                                                       R4 S1831500
*********************************************************************** S1832000
*                                                                     * S1832500
*           NONCOMPRESS/NONCOMPACT BUFFER FILL ROUTINE                * S1834500
*                                                                     * S1835500
*           OBJECTIVE - ENTER AT 'MVKUFILL' TO MOVE STRING            * S1836000
*           INTO CURRENT OUTPUT BUFFER (STRING ADDR & LENGTH          * S1836500
*           IN REGS RSRCE AND RLSRCE).  REGS RBY1, REND, AND          * S1837000
*           RSINK SHOULD BE PRE-LOADED WITH 1, NUMBER UNUSED          * S1837500
*           BYTES LEFT IN BUFFER, AND ADDR OF FIRST UNUSED            * S1838000
*           POSITION, RESPECTIVELY.                                   * S1838500
*                                                                     * S1839000
*           IF THE ENTIRE STRING CANNOT FIT IN THE BUFFER,            * S1839500
*           ADDR AND LENGTH OF THE EXCESS ARE CALCULATED AND          * S1840000
*           SAVED, THE COMPOSER EXITS TO CALLER WITH FLAG             * S1840500
*           'SCWMORE' SET, AND IT IS EXPECTED THAT CALLING            * S1841000
*           CODE WILL GET NEW BUFFER, SEND OLD BUFFER, AND            * S1841500
*           CALL COMPOSER AGAIN.  SINCE 'SCWMORE' FLAG STILL          * S1842000
*           IS SET 'MVKUCNUE' IS ENTERED TO HANDLE EXCESS.            * S1842500
*                                                                     * S1843000
*           CONDITION CODES ARE SET AT EXIT AS FOLLOWS -              * S1843500
*                4  (MINUS)  STRING FITS WITH ROOM TO SPARE           * S1844000
*                8  (ZERO)   STRING FILLS LAST BUFFER POSN.           * S1844500
*                                                                     * S1845000
*********************************************************************** S1845500
MVKUCNUE L     RSRCE,SCWSRCE       RELOAD ADDRESS AND LENGTH         R4 S1846500
         L     RLSRCE,SCWLSRCE      OF SOURCE STRING REMAINDER       R4 S1847000
         L     RFEED,SCWFEED       RELOAD FILL ROUTINE RETURN ADDR   R4 S1847500
         TM    SCWFLAGS,SCWCTRL    TEST COMPOSER FLAGS               R4 S1848000
         BZ    MVKUFILL            BRANCH IF NOT CONTROL STRING      R4 S1848500
         ALR   RSRCE,MBUF          CONVERT OFFSET TO ADDRESS         R4 S1849000
MVKUFILL SLR   REND,RLSRCE         CALC IF WHOLE STRING FITS IN R.U. R4 S1849500
         BC    NOT-SLSM,SKIP320    BRANCH IF IT DOES                 R4 S1850000
         ALR   RLSRCE,REND         CALC LENGTH OF PART THAT FITS     R4 S1850500
SKIP320  SLR   RLSRCE,RBY1         DECREASE BY 1 FOR MACHINE LENGTH  R4 S1851000
         BC    SLSM,SKIP330        BYPASS EXECUTE IF NOTHING TO MOVE R4 S1851500
         EX    RLSRCE,MVKUFMVC     MOVE STRING INTO R.U.             R4 S1852000
         LA    RSINK,1(RLSRCE,RSINK)  UPDATE R.U. CURRENT POSITION   R4 S1852500
         LA    RSRCE,1(RLSRCE,RSRCE)  AND SOURCE REMAINDER POINTERS  R4 S1853000
SKIP330  LCR   RLSRCE,REND         TEST LENGTH OF REMAINING SOURCE   R4 S1853500
         BNPR  RFEED               RETURN WITH COND CODE IF ALL USED R4 S1854000
         TM    SCWFLAGS,SCWNSPAN   TEST COMPOSER FLAGS               R4 S1854500
         BO    MVKUNSPA            BR IF SPANNED RECORDS FORBIDDEN   R4 S1855000
         TM    SCWFLAGS,SCWCTRL    OTHERWISE TEST COMPOSER FLAGS     R4 S1855500
         BZ    SKIP340             BRANCH IF NOT CONTROL STRING      R4 S1856000
         SLR   RSRCE,MBUF          CONVERT ADDRESS TO OFFSET         R4 S1856500
SKIP340  ST    RSRCE,SCWSRCE       SAVE ADDRESS AND LENGTH           R4 S1857000
         ST    RLSRCE,SCWLSRCE      OF SOURCE STRING REMAINDER       R4 S1857500
         ST    RFEED,SCWFEED       SAVE BUFFER FILL RTNE RETURN ADDR R4 S1858000
MVKUFLEN LH    REND,ICERULEN       SET FULL R.U.                     R4 S1858500
         ST    REND,RPLRLEN         LENGTH IN RPL                    R4 S1859000
MVKUNSPA L     ML,SCWRETRN         RETRIEVE COMPOSER RETURN ADDRESS  R4 S1859500
         L     MBASE2,MVKOVSUB     RESTORE SNA SUBS BASE REGISTER   R41 S1859800
         BR    ML                  RETURN TO CALLER WITH FULL R.U.   R4 S1860000
         SPACE 1                                                     R4 S1860500
MVKUFMVC MVC   0(*-*,RSINK),0(RSRCE)  ** EXECUTE ONLY **             R4 S1861000
         EJECT                                                       R4 S1861500
MVKOVSUB DC    A(RTAMVSUB)         SNA SUBS ADDR TO REFRESH MBASE2  R41 S1861600
         SPACE 1                                                    R41 S1861700
*********************************************************************** S1862000
*                                                                     * S1862500
*                        SNA TRANSPARENCY CHECK ROUTINE               * S1863000
*                                                                     * S1863500
*           OBJECTIVE - TEST FOR ZERO CCW LENGTH AND FOR              * S1864000
*           APPEARANCE OF CHARACTERS IN CONTROL QUADRANT              * S1864500
*           (BELOW X'40').  IF CONTROLS OCCUR SUPPRESS                * S1865000
*           TRAILING BLANKS NOW SINCE CORRECT COUNT MUST BE           * S1865500
*           STORED IN TRANSPARENCY FRAMING SEQUENCE.  CONDI-          * S1866000
*           TION CODE IS SET AT EXIT AS FOLLOWS -                     * S1866500
*                     4  (MINUS)  CCW LENGTH WAS ZERO                 * S1867000
*                     8  (ZERO)   NO CONTROLS OCCUR IN DATA,          * S1867500
*                                 OR TRANSPARENCY CHECK NOT           * S1868000
*                                 REQUESTED                           * S1868500
*                     2  (PLUS)   'TRN' AND COUNT GENERATED,          * S1869000
*                                 ADDR AND LENGTH OF 2 IN             * S1869500
*                                 REGS 'RSRCE' AND 'RLSRCE'.          * S1870000
*                                 DATA ADDR & LTH ARE SAVED.          * S1870500
*                                                                     * S1871000
*********************************************************************** S1871500
         SPACE 1                                                     R4 S1872000
MVKOTPCY SLR   RLSRCE,RBY1         DECREASE BY 1 FOR MACHINE LENGTH  R4 S1872500
         BCR   SLSM,RFEED          RETURN IF CCW LENGTH WAS ZERO       CS1873000
                                    (WITH COND CODE 'SLSM', 'MINUS') R4 S1873500
         TM    SCWFLAGS,SCWTRNSP   TEST COMPOSER FLAGS               R4 S1874000
         BZ    *+16                BYPASS EXECUTE IF TRANSPARENCY      CS1874500
                                    CHECK NOT REQUESTED              R4 S1875000
         ST    REND,SCWTEND   *R1* SAVE R1 IN CASE 'TRT' SPOILS IT   R4 S1875500
         ST    RSINK,SCWTSINK *R2* SAVE R2 IN CASE 'TRT' SPOILS IT   R4 S1876000
         EX    RLSRCE,MVKPUTRN     CHECK FOR VALUES BELOW X'40'      R4 S1876500
         LA    RLSRCE,1(,RLSRCE)   CHANGE MACHINE TO TRUE LENGTH     R4 S1877000
         BZR   RFEED               RETURN IF NO VALUES BELOW X'40'     CS1877500
                                    (WITH COND CODE 'ZERO')          R4 S1878000
         ALR   RLSRCE,RSRCE        COMPUTE ADDRESS OF LAST BYTE + 1 R41 S1879000
         BALR  R2,0                OPTIMIZE LOOP WITH ADDRESS IN REGR41 S1879500
         BCTR  RLSRCE,0            SCAN BACKWARDS                   R41 S1880000
         CLI   0(RLSRCE),SCSBLANK   ELIMINATING                     R41 S1880500
         BER   R2                    TRAILING BLANKS                R41 S1881000
         SLR   RLSRCE,RSRCE        COMPUTE LENGTH                   R41 S1881500
         ALR   RLSRCE,RBY1          OF REMAINING DATA               R41 S1882000
         ST    RSRCE,SCWINPT       SAVE ADDRESS OF SOURCE STRING    R41 S1882500
         STC   RLSRCE,SCWTRN+1     STORE TRANSPARENT DATA LENGTH     R4 S1883000
         ST    RLSRCE,SCWLINPT     SAVE LENGTH OF SOURCE STRING      R4 S1883500
         LA    RSRCE,SCWTRN        POINT TO TRANSPARENCY FRAME STRNG R4 S1884000
         L     RSINK,SCWTSINK *R2* RE-CREATE R1 AND R2 VALUES        R4 S1885500
         L     REND,SCWTEND   *R1*  DESTROYED BY NON-ZERO 'TRT'      R4 S1886000
         LR    RLSRCE,RBY1         SET LENGTH 2 FOR 'TRN' + COUNT   R41 S1886500
         AR    RLSRCE,RBY1          AND SET CONDITION CODE 'PLUS'   R41 S1886600
         BR    RFEED               RETURN                            R4 S1887000
         SPACE 1                                                     R4 S1887500
MVKPUTRN TRT   0(*-*,RSRCE),MSCSTRAN  ** EXECUTE ** DETECT SCS CTRLS R4 S1888000
         EJECT                                                       R4 S1888500
*********************************************************************** S1889000
*                                                                     * S1889500
*                        CARRIAGE CONTROL DECODE ROUTINE              * S1890000
*                                                                     * S1890500
*           OBJECTIVE - GENERATE ANY NECESSARY COUNT OR CODE          * S1891000
*           TO FORM THE SCS CONTROL STRING THAT MATCHES THE           * S1891500
*           CHANNEL COMMAND IN FUNCTION.  EXIT WITH ADDR OF           * S1892000
*           THE STRING IN REG 'RSRCE' AND LENGTH IN 'RLSRCE'          * S1892500
*                                                                     * S1893000
*********************************************************************** S1893500
         SPACE 2                                                     R4 S1894000
MVKOCCDE TM    SCWLCCC,X'80'       TEST CURRENT COMMAND TYPE         R4 S1894500
         BO    MVKOCSKP            BRANCH IF SKIP                    R4 S1895000
         CLI   SCWLCCC,X'63'       TEST CURRENT COMMAND TYPE         R4 S1895500
         BE    MVKOCFCB            BRANCH IF LOAD FCB                R4 S1896000
         NI    SCWFLAGS,255-SCWCTRL  SHOW STRING NOT IN BUFFER       R4 S1896500
         LA    RSRCE,MSCSNLS       POINT TO 14 SCS 'NL' CODES        R4 S1897000
         CLI   SCWLCCC,X'79'       TEST CURRENT COMMAND TYPE         R4 S1897500
         BE    MVKOCIRS            BRANCH IF SUBSTITUTE PUNCH CODE   R4 S1898000
         SLR   RLSRCE,RLSRCE       CLEAR REGISTER                    R4 S1898500
         IC    RLSRCE,SCWLCCC      PICK UP COMMAND CODE              R4 S1899000
         SRA   RLSRCE,3            EXTRACT NUMBER OF LINES TO SPACE  R4 S1899500
         BNZR  ML                  RETURN IF 1, 2, 3, OR 14          R4 S1900000
         LR    RLSRCE,RBY1         SET LENGTH OF 1 FOR 'CR'          R4 S1900500
         SLR   RSRCE,RBY1          SLIDE POINTER TO LEFT 2 BYTES     R4 S1901000
         BCTR  RSRCE,RFEED          TO POINT TO 'CR', AND RETURN     R4 S1901500
         SPACE 1                                                     R4 S1902000
MVKOCSKP OI    SCWFLAGS,SCWCTRL    SHOW CONTROL STRING IS IN BUFFER  R4 S1902500
         SLR   RLSRCE,RLSRCE       CLEAR REGISTER                    R4 S1903000
         IC    RLSRCE,SCWLCCC      PICK UP COMMAND CODE              R4 S1903500
         SRL   RLSRCE,3            SHIFT CODE TO GET CHANNEL NUMBER  R4 S1904000
         N     RLSRCE,MSCSMASK     MASK OFF ALL BUT LOW 4 BITS       R4 S1904500
         LA    RSRCE,SCWSEL        POINT TO 'SEL'/CODE/'CR' SEQUENCE R4 S1905000
         CLR   RLSRCE,RBY1         COMPARE CHANNEL NUMBER WITH 1     R4 S1905500
         BNE   SKIP350             GENERATE 'SEL' IF NOT CHANNEL 1   R4 S1906000
         MVI   SCWSEL-1,SCSFF      MOVE 'FORMS FEED' TO WORK AREA    R4 S1906500
         LR    RLSRCE,RBY1         SET LENGTH OF 1 FOR 'FF'          R4 S1907000
         BCTR  RSRCE,RFEED         SLIDE POINTER TO LEFT 1 BYTE        CS1907500
                                    TO POINT TO 'FF', AND RETURN     R4 S1908000
SKIP350  IC    RLSRCE,MSCSSELN-1(RLSRCE)  USE CHAN # AS TABLE INDEX  R4 S1908500
         LA    RSRCE,SCWSEL        POINT TO 'SEL'/CODE/'CR' SEQUENCE R4 S1909000
         STC   RLSRCE,SCWSEL+1     STORE CHANNEL CODE IN CTRL STRING R4 S1909500
         LA    RLSRCE,3            FOR SKIP AFTER WRITE INCLUDE 'CR' R4 S1910000
         TM    SCWLCCC,X'02'       TEST CURRENT COMMAND TYPE         R4 S1910500
         BZR   RFEED               RETURN IF NOT IMMEDIATE COMMAND   R4 S1911000
         BCTR  RLSRCE,RFEED        IF IMMED ADJ LENGTH TO 2, RETURN  R4 S1911500
         SPACE 1                                                     R4 S1912000
MVKOCIRS LR    RLSRCE,RBY1         SET LENGTH OF 1 FOR 'IRS'         R4 S1912500
         BCTR  RSRCE,RFEED         SLIDE POINTER TO LEFT 1 BYTE        CS1913000
                                    TO POINT TO 'IRS', AND RETURN    R4 S1913500
         EJECT                                                       R4 S1914000
*                                                                    R4 S1914500
*                             HANDLE FCB ON SNA REMOTE TERMINALS     R4 S1915000
*                                                                    R4 S1915500
         SPACE 2                                                     R4 S1916000
MVKOCFCB OI    SCWFLAGS,SCWCTRL    SHOW CONTROL STRING IS IN BUFFER  R4 S1916500
         MVC   SCWSVFWA,MSCSSVF    MOVE IN MODEL SVF STRING          R4 S1917000
         ST    REND,SCWTEND        FREE UP                           R4 S1917500
         ST    RSINK,SCWTSINK       REGISTERS                        R4 S1918000
         ST    RFEED,SCWFEED         FOR TEMP. USE                   R4 S1918500
         BCTR  RLSRCE,0            DECREASE LENGTH BY 1              R4 S1919000
         TM    0(RSRCE),X'C0'      TEST 1ST FCB BYTE FOR INDEXING    R4 S1919500
         LA    REND,0(RLSRCE,RSRCE)  CALCULATE ADDR OF END OF STRING R4 S1920000
         BNZ   SKIP360             IF INDEX BYTE PRESENT RSRCE IS OK R4 S1920500
         BCTR  RSRCE,0             OTHERWISE ADJUST FOR ABSENCE      R4 S1921000
SKIP360  LCR   RLSRCE,RSRCE        SAVE COMPLEMENT OF STRING ORIGIN  R4 S1921500
         SPACE 2                                                     R4 S1922000
MVKOCFNO IC    RSINK,1(,RSRCE)     PICK UP CHANNEL NUMBER            R4 S1922500
         N     RSINK,MSCSMASK      MASK OFF ALL BUT LOW 4 BITS       R4 S1923000
         BZ    MVKOCFLL            IF ZERO GO CHECK FOR LAST LINE    R4 S1923500
         LA    RSINK,SVFTABWK-1(RSINK)  POINT TO CHANNEL STOP ARRAY  R4 S1924000
         CLI   0(RSINK),0          TEST FOR A VALUE ALREADY SAVED    R4 S1924500
         BNE   MVKOCFLL            IF PRESENT IGNORE FURTHER STOPS   R4 S1925000
         LA    RFEED,1(RLSRCE,RSRCE)  CALC LINE NUMBER OF FIRST STOP R4 S1925500
         STC   RFEED,0(,RSINK)     SAVE IN CHANNEL STOP ARRAY        R4 S1926000
         SPACE 1                                                     R4 S1926500
MVKOCFLL TM    1(RSRCE),X'10'      TEST FOR LAST FLAG                R4 S1927000
         BO    MVKOCFFG            IF ON TEST IF TRULY LAST OR 8 L/I R4 S1927500
         SPACE 1                                                     R4 S1928000
MVKOCFIX BXLE  RSRCE,RBY1,MVKOCFNO IF OFF, INCREMENT BY 1 AND LOOP   R4 S1928500
         SPACE 1                                                     R4 S1929000
*                                  FCB WITH NO 'LAST' FLAG SET IS    R4 S1929500
*                                   INVALID BUT WILL BE ACCEPTED     R4 S1930000
         BCTR  RSRCE,0             PRETEND LAST BYTE HAD FLAG        R4 S1930500
         SPACE 2                                                     R4 S1931000
MVKOCFFG LR    RFEED,RLSRCE        GET COMPLEMENT OF STRING ORIGIN   R4 S1931500
         ALR   RFEED,RSRCE         SUBTRACT ORIGIN FROM CURRENT ADDR R4 S1932000
         BC    ALDZ,MVKOCFIX       IF 0, FLAG IS ON 1ST BYTE = 8 L/I R4 S1932500
         ALR   RFEED,RBY1          IF NOT 0 ADD 1 TO GET FCB DEPTH   R4 S1933000
         CLI   SVFTABWK,1          TEST FOR CHANNEL 1 AT LINE 1      R4 S1933500
         BNH   MVKOCFRN            IF YES OR NOT DEFINED, GO EXIT    R4 S1934000
         EJECT                                                       R4 S1934500
*                                                                    R4 S1935000
*                             FORCE CHANNEL 1 (TOP MARGIN) TO LINE 1 R4 S1935500
*                                                                    R4 S1936000
         SPACE 3                                                     R4 S1936500
         SLR   RLSRCE,RLSRCE       CLEAR                             R4 S1937000
         SLR   RSINK,RSINK          REGISTERS                        R4 S1937500
         IC    RLSRCE,SVFTABWK     PICK UP CHANNEL 1 VALUE           R4 S1938000
         BCTR  RLSRCE,0            LESS 1 TO GET ADJUSTMENT FACTOR   R4 S1938500
         LA    RSRCE,SVFTABWK      START WITH CHANNEL 1 VALUE        R4 S1939000
         LA    REND,SVFTABWK+11    END WITH CHANNEL 12 VALUE         R4 S1939500
         SPACE 2                                                     R4 S1940000
MVKOCFAJ IC    RSINK,0(,RSRCE)     GET CHANNEL STOP                  R4 S1940500
         LTR   RSINK,RSINK         TEST FOR UNDEFINED (ZERO)         R4 S1941000
         BZ    SKIP370             SKIP ADJUSTMENT IF UNDEFINED      R4 S1941500
         SLR   RSINK,RLSRCE        OTHERWISE ADJUST                  R4 S1942000
         BC    SLSP,SKIP380        SKIP WRAPAROUND IF PLUS           R4 S1942500
         ALR   RSINK,RFEED         ADD IN MAX VALUE TO WRAP AROUND   R4 S1943000
SKIP380  STC   RSINK,0(,RSRCE)     PUT BACK IN ARRAY                 R4 S1943500
SKIP370  BXLE  RSRCE,RBY1,MVKOCFAJ LOOP                              R4 S1944000
         SPACE 2                                                     R4 S1944500
MVKOCFRN STC   RFEED,SVFMAXPL      SET MAX PRINT LINE VALUE          R4 S1945000
         MVC   SVFTOPM,SVFTABWK    SET TOP MARGIN (CHANNEL 1)        R4 S1945500
         STC   RFEED,SVFBOTM       SET BOTTOM MARGIN                 R4 S1946000
         LA    RLSRCE,L'SCWSVFWA   SET SOURCE LENGTH                 R4 S1946500
         LA    RSRCE,SCWSVFWA      POINT TO CONTROL STRING WORK AREA R4 S1947000
         L     REND,SCWTEND        RESTORE                           R4 S1947500
         L     RSINK,SCWTSINK       TEMPORARY                        R4 S1948000
         L     RFEED,SCWFEED         WORK REGS                       R4 S1948500
         BR    RFEED               RETURN TO CALLER                  R4 S1949000
         SPACE 3                                                     R4 S2000000
*                                                                    R4 S2000500
*                             MODEL SCS CARRIAGE CONTROL STRINGS     R4 S2001000
*                                                                    R4 S2001500
         SPACE 2                                                     R4 S2002000
         DS    0D                                                    R4 S2002500
MSCSCC   DC    AL1(SCSTRN,0,SCSSEL,0,SCSCR)  THESE 3 CARDS MUST      R4 S2003000
         DC    AL1(SCSIRS)                    APPEAR TOGETHER IN     R4 S2003500
MSCSNLS  DC    14AL1(SCSNL)                    THE ORDER SHOWN       R4 S2004000
MSCSMASK DC    F'15'               MASK TO ISOLATE LOW-ORDER 4 BITS  R4 S2004500
MSCSSELN DC    X'8182838485868788897A7B7C'  SCS CHANNEL SELECT CODES R4 S2005000
MSCSSVF  DC    XL18'2BC20F000000000000000000000000000000'  MODEL SVF R4 S2005500
         TITLE 'HASP SNA REMOTE TERMINAL SCS SCAN TABLE'             R4 S2006000
         SPACE 5                                                     R4 S2006500
MSCSTRAN DS    0D             XLATE & TEST TABLE FOR ANY BELOW X'40' R4 S2007000
*                                                                    R4 S2007500
         DC    64X'04',192X'00'                                      R4 S2008000
         ORG   MSCSTRAN+SCSSEL                                       R4 S2008500
         DC    X'10'               1ST PART OF SECURE STRING READER  R4 S2009000
         ORG   MSCSTRAN+SCSFF                                        R4 S2009500
         DC    X'08'               FORM FEED - END OF INPUT RECORD   R4 S2010000
         ORG   MSCSTRAN+SCSNL                                        R4 S2010500
         DC    X'08'               NEW LINE - END OF INPUT RECORD    R4 S2011000
         ORG   MSCSTRAN+SCSIRS                                       R4 S2011500
         DC    X'08'               INTER-RECORD SEPARATOR            R4 S2012000
         ORG   MSCSTRAN+SCSTRN                                       R4 S2012500
         DC    X'0C'               TRANSPARENCY FRAME CHARACTER      R4 S2013000
         ORG   MSCSTRAN+256                                          R4 S2013500
         TITLE 'HASP SNA REMOTE TERMINAL COMPRESSION ROUTINES'       R4 S2014000
*********************************************************************** S2014500
*                                                                     * S2015000
*                  COMPRESS/COMPACT FEEDER ROUTINE                    * S2015500
*                                                                     * S2016000
*           OBJECTIVE - FOR IMMEDIATE COMMANDS, GENERATE THE          * S2016500
*           SCS CONTROL STRING EQUIVALENT, FEED IT TO THE             * S2017000
*           EMITTER/PLANNER/MOVER ROUTINES (E/P/M), AND               * S2017500
*           RETURN.  FOR NON-IMMEDIATE COMMANDS, GENERATE             * S2018000
*           AND FEED TRANSPARENT FRAME SEQUENCE TO E/P/M IF           * S2018500
*           REQUIRED. FEED DATA STRING TO E/P/M. GENERATE             * S2019000
*           AND FEED CHANNEL COMMAND'S EQUIVALENT SCS                 * S2019500
*           CONTROL STRING TO E/P/M, AND RETURN.                      * S2020000
*                                                                     * S2020500
*           IF THE E/P/M DETECTS A FULL BUFFER DURING THE             * S2021000
*           PROCESSING OF ANY STRING, RETURN FROM THE COM-            * S2021500
*           POSER IS MADE WITH FLAG 'SCWMORE' SET.  AFTER             * S2022000
*           CALLER HAS GOTTEN A NEW BUFFER & SENT THE R.U.,           * S2022500
*           THE COMPOSER IS REINVOKED TO PROCESS THE EXCESS.          * S2023000
*                                                                     * S2023500
*           ON NORMAL RETURN FLAG 'SCWMORE' IS OFF. IN ADDI-          * S2024000
*           TION, IF THE CONTROL STRING WAS JUST LONG ENOUGH          * S2024500
*           TO FILL THE LAST BUFFER (I.E., THE LAST EMISSION          * S2025000
*           CAUSES THE SEND ROUTINE TO BE ENTERED), TURN ON           * S2025500
*           'SCWFULL ' FLAG TO INSTRUCT CALLER THAT R.U. IS           * S2026000
*           READY TO SEND.                                            * S2026500
*                                                                     * S2027000
*           SEE PROLOGUE AT 'MVKEMITR' FOR OUTLINE OF THE             * S2027500
*           EMITTER/PLANNER/MOVER & DEFINITION OF 'EMISSION'          * S2028000
*                                                                     * S2028500
*********************************************************************** S2029000
         SPACE 1                                                     R4 S2029500
         DROP  RSCBL,RPLAN,RNUM,RCHAR,RLCHAR  REGS USED BY COMPOSER R41CS2030500
               MDCT,MBASE1,BASE1,BASE2,PCE  = STANDARD RTAM EQUATES R41 S2031000
         SPACE 1                                                     R4 S2031500
MVKOMPRS ST    R13,SCWSAV13        FREE UP REG FOR TEMPORARY USE    R41 S2033000
         SPACE 1                                                     R4 S2033500
         L     RPLAN,SCWPLAN       RELOAD PLANNER STATE             R41 S2034000
         SLR   RCPZ,RCPZ           CLEAR INDEX REG             @OZ27430 S2034500
         L     RCPA,SCWCPARS       RELOAD COMPACTION RACING STATE   R41 S2035000
         L     RCPT,ICECPT         ESTABLISH COMPACTION             R41 S2035500
         USING CPTDSECT,RCPT        TABLE ADDRESSABILITY            R41 S2036000
         SPACE 1                                                    R41 S2036500
         TM    SCWFLAGS,SCWMORE    TEST COMPOSER FLAGS              R41 S2037000
         BO    MVKZCNUE            BRANCH IF CONTINUING PREV. CALL  R41 S2037500
         SPACE 1                                                     R4 S2038000
         OI    SCWFLAGS,SCWMORE    INDICATE COMPOSING IN PROGRESS   R41 S2038300
         TM    SCWLCCC,X'02'       TEST CURRENT COMMAND TYPE        R41 S2038500
         BO    MVKFCTRL            BRANCH IF IMMEDIATE COMMAND       R4 S2039000
         BAL   RFEED,MVKOTPCY      CALL TRANSPARENCY CHECK ROUTINE   R4 S2039500
         BM    MVKFCTRL            BRANCH IF ZERO LENGTH IN CCW      R4 S2040000
         BZ    MVKFDATA            BRANCH IF NO VALUES BELOW X'40'   R4 S2040500
         EJECT                                                       R4 S2041000
*                        FEED TRANSPARENT FRAME SEQUENCE             R4 S2041500
         SPACE 1                                                     R4 S2042000
         OI    SCWFLAGS,SCWCTRL    INDICATE SOURCE IS CONTROL STRING R4 S2042500
         BAL   RFEED,MVKEMITR      CALL EMITTER ROUTINE              R4 S2043000
         BALR  RFEED,RPLAN         FORCE LAST EMISSION TO PLANNER    R4 S2043500
         L     RNUM,MVKFPEND       GET PLANNER-END ROUTINE OFFSET   R41 S2044000
         BAL   RFEED,0(RNUM,RPLAN) FORCE MOVE TO R.U. BUFFER        R41 S2044500
         L     RSRCE,SCWINPT       RETRIEVE ADDRESS AND              R4 S2045000
         L     RLSRCE,SCWLINPT      LENGTH OF INPUT TEXT             R4 S2045500
         SPACE 1                                                     R4 S2046000
*                        FEED DATA STRING (TEXT POINTED TO BY CCW)   R4 S2046500
         SPACE 1                                                     R4 S2047000
MVKFDATA NI    SCWFLAGS,255-SCWCTRL  INDICATE SOURCE IS TEXT STRING  R4 S2047500
         BAL   RFEED,MVKEMITR      CALL EMITTER ROUTINE              R4 S2048000
         CLI   0(RCHAR),C' '       TEST LAST EMISSION CHARACTER      R4 S2048500
         BE    MVKFDATB            SKIP EMISSION IF TRAILING BLANKS R41 S2049000
         BALR  RFEED,RPLAN         OTHERWISE FORCE LAST EMISSION     R4 S2049500
MVKFDATB L     RNUM,MVKFPEND       GET PLANNER-END ROUTINE OFFSET   R41 S2050000
         BAL   RFEED,0(RNUM,RPLAN) FORCE MOVE TO R.U. BUFFER        R41 S2050500
         SPACE 1                                                     R4 S2051000
*                        FEED SCS CARRIAGE CONTROL STRING            R4 S2051500
         SPACE 1                                                     R4 S2052000
MVKFCTRL BAL   RFEED,MVKOCCDE      CALL CARRIAGE CTL. DECODE ROUTINE R4 S2052500
         BAL   RFEED,MVKEMITR      CALL EMITTER ROUTINE              R4 S2053000
         OI    SCWFLAGS,SCWLAST    INDICATE LAST EMISSION FOR CCW    R4 S2053500
         BALR  RFEED,RPLAN         FORCE LAST EMISSION TO PLANNER    R4 S2054000
         L     RNUM,MVKFFEND       GET  FEEDER-END ROUTINE OFFSET   R41 S2054500
         BAL   RFEED,0(RNUM,RPLAN) FORCE R.U. TO SENDABLE FORM      R41 S2055000
         NI    SCWFLAGS,255-SCWLAST-SCWMORE  INDICATE COMPOSING DONE R4 S2055500
         TM    SCWFLAGS,SCWNSPAN   TEST COMPOSER FLAGS               R4 S2056000
         BO    MVKZFLEN            BR IF RECORD SPANNING FORBIDDEN   R4 S2056500
         ST    RPLAN,SCWPLAN       SAVE PLANNER STATE                R4 S2057000
         ST    RCPA,SCWCPARS       SAVE COMPACTION RACING STATE     R41 S2057500
         B     MVKZFLEN            GO SET LTH, RESTORE REGS & RETURN R4 S2058000
         SPACE 2                                                     R4 S2058500
MVKFPEND DC    F'-4'               OFFSET TO PLANNER-END EXIT INSTR R41 S2059000
MVKFFEND DC    F'-8'               OFFSET TO FEEDER-END  EXIT INSTR R41 S2059100
         EJECT                                                       R4 S2059500
*********************************************************************** S2060000
*                                                                     * S2060500
*                   COMPACT/COMPRESS EMITTER ROUTINE                  * S2062500
*                                                                     * S2063500
*           OBJECTIVE - TAKE A STRING SUPPLIED BY THE FEEDER          * S2064000
*           ROUTINES AND BREAK IT DOWN INTO 'EMISSIONS'.              * S2064500
*           AN EMISSION IS 1 OR MORE CONSECUTIVE OCCURRENCES          * S2065000
*           OF THE SAME CHARACTER.                                    * S2065500
*                                                                     * S2066000
*           THE EMITTER EXECUTES A COMPARE-LONG WHICH LEAVES          * S2066500
*           REG 'RCHAR' POINTING AT THE 'EMISSION CHARACTER'          * S2067000
*           AND REG 'RLSRCE' SET SUCH THAT THE SUBTRACTION            * S2067500
*           'RNUM'-'RLSRCE' GIVES THE NUMBER OF OCCURRENCES           * S2068000
*           OF THE CHARACTER LESS 1.  (NOTE THE 'SLR' AMONG           * S2068500
*           THE FIRST INSTRUCTIONS OF EVERY PLANNER ROUTINE.)         * S2069000
*                                                                     * S2069500
*           THE EMITTER EXITS BY BRANCHING TO THE PLANNER             * S2070000
*           ROUTINE WHOSE ADDRESS IS IN REG 'RPLAN'.  THESE           * S2070500
*           ROUTINES EMBODY THE STRATEGY USED TO PLAN WHAT            * S2071000
*           KIND OF SCB'S SHOULD BE FORMED AND WHERE, HENCE           * S2071500
*           THE TERM 'PLANNER ROUTINE'.  FOR COMPRESSION,             * S2072000
*           THE PLANNER HAS TWO 'STATES' (NO SCB CURRENTLY            * S2072500
*           IN EFFECT--THE 'EMPTY' STATE--AND A NONCOMPRESSED         * S2073000
*           SCB IN EFFECT) AND CONSEQUENTLY TWO DIFFERENT             * S2073500
*           ROUTINES WHICH CAN BE POINTED AT BY 'RPLAN'.              * S2074000
*                                                                     * S2074500
*           PLANNER CODE ENDS BY BRANCHING BACK TO THE                * S2075000
*           EMITTER (EXCEPT WHEN AN R.U. IS FULL AND A SEND           * S2075500
*           ROUTINE INTERVENES) WHICH ADJUSTS REGISTERS AND           * S2076000
*           CONTINUES THE COMPARE-LONG.  THE LAST EMISSION            * S2076500
*           OF A STRING (WHICH RESULTS IN AN EQUAL COMPARE)           * S2077000
*           IS NOT PASSED TO THE PLANNER. INSTEAD RETURN IS           * S2077500
*           MADE TO THE FEEDER ROUTINE WHICH MAY EMIT IT BY           * S2078000
*           BRANCHING DIRECTLY TO THE PLANNER OR DISCARD IT.          * S2078500
*           TRAILING BLANKS (THE LAST EMISSION OF THE TEXT            * S2079000
*           STRING) ARE DETECTED AND SUPPRESSED IN THIS WAY.          * S2079500
*                                                                     * S2080000
*           PLANNER ROUTINES DO NOT ACTUALLY TRANSFER DATA            * S2080500
*           FROM THE SOURCE STRING TO THE R.U. BUFFER.  THIS          * S2081000
*           IS PERFORMED BY THE 'MOVER' ROUTINES.  FOR COM-           * S2081500
*           PRESSION, THERE ARE 3 MOVER ROUTINES--THE 'PRIME          * S2082000
*           MOVER', THE 'DUPLICATE (NONPRIME) MOVER', AND             * S2082500
*           THE 'NONCOMPRESSED SCB MOVER'.                            * S2083000
*                                                                     * S2083500
*           DATA TRANSFER IS DONE IN MOVE ROUTINES RATHER             * S2084000
*           THAN BYTE BY BYTE FOR EFFICIENCY REASONS.  ANY            * S2084500
*           DEFERRED MOVE MUST BE FORCED BEFORE THE FEEDER            * S2085000
*           SWITCHES FROM ONE SOURCE STRING TO ANOTHER.               * S2085500
*           'PLANNER-END' AND 'FEEDER-END' ROUTINES ARE               * S2086000
*           ASSOCIATED WITH EACH PLANNER STATE FOR FORCING            * S2086500
*           DEFERRED MOVES (POINTED TO BY BRANCHES LOCATED            * S2087000
*           4 AND 8 BYTES BEFORE THE NORMAL ENTRY POINT),             * S2087500
*           AND ONE IS INVOKED AT THE END OF EACH STRING.             * S2088000
*                                                                     * S2088500
*********************************************************************** S2089000
         EJECT                                                       R4 S2089500
*                                                                    R4 S2090000
*           COMPACTION/COMPRESSION EMITTER ROUTINE                  R41 S2090500
*                                                                   R41 S2091000
         SPACE 1                                                    R41 S2091500
         CNOP  4,8                 MAIN LOOP BRANCH TARGET ON DBLWD R41 S2092000
MVKEMITZ LA    RPLAN,MVKQCA11      CHANGE TO ODD COMPACTION STATE   R41 S2092500
         SPACE 1                                                     R4 S2093500
MVKEMITR LR    RCHAR,RSRCE         SET OPERAND 1 LOC = OPERAND 2 LOCR41 S2094000
         ALR   RSRCE,RBY1          OFFSET OPERAND 2 TO RIGHT 1 BYTE R41 S2094500
         SLR   RLSRCE,RBY1         DECREASE OPERAND 2 LENGTH BY 1   R41 S2095000
         LR    RLCHAR,RLSRCE       SET OPERAND 1 LTH = OPERAND 2 LTH R4 S2095500
         LR    RNUM,RLSRCE         SAVE ORIGINAL OPERAND LENGTH     R41 S2096000
         BCR   NOT-SLSP,RFEED      RTRN TO FEEDER IF SOURCE USED UP R41 S2096500
         CLC   0(1,RCHAR),0(RSRCE) TEST FOR DUPLICATED CHARACTER    R41 S2096600
         BNER  RPLAN               ENTER PLANNER IF NONE            R41 S2096700
         CLCL  RCHAR,RSRCE         COMPARE FOR NUMBER OF OCCURRENCES R4 S2097000
         SPACE 1                                                     R4 S2097500
*                   'RNUM'-'RLSRCE' NOW GIVES THE NUMBER OF CONSECU- R4 S2098000
*                   TIVE OCCURRENCES OF THE SAME CHARACTER, LESS 1.  R4 S2098500
*                   'RCHAR' POINTS TO AN INSTANCE OF THE CHARACTER.  R4 S2099000
         SPACE 1                                                     R4 S2099500
         BNER  RPLAN               DRIVE PLANNER IF NOT LAST EMISS'N R4 S2100000
         BR    RFEED               OTHERWISE RETURN TO FEEDER        R4 S2100500
         SPACE 6                                                     R4 S2101000
*                                                                    R4 S2101500
*           COMPRESSION PLANNER - NONCOMPRESSED SCB STATE  (NORMAL)  R4 S2102000
*                                                                    R4 S2102500
         SPACE 1                                                     R4 S2103000
         CNOP  0,8                 MAIN LOOP BRANCH TARGET ON DBLWD R41 S2103300
         B     MVKVNCI         -8  BRANCH TO FEEDER-END  ROUTINE    R41 S2103400
         B     MVKVNCI         -4  BRANCH TO PLANNER-END ROUTINE    R41 S2103500
         SPACE 1                                                     R4 S2104000
MVKPNC   SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1   R4 S2104500
         BC    SLSP,MVKPNC2        BRANCH IF DUP FACTOR GRTR THAN 1  R4 S2105000
         SPACE 1                                                     R4 S2105500
MVKPNC1  BCT   RSCBL,MVKEMITR      ADV SCB COUNT & GET NEXT EMISSION R4 S2106000
         BCT   RNUM,MVKVNC         IF SCB FULL FORCE DUP FACTOR NEG.   CS2106500
               (ALWAYS BRANCHES)    & GO TO NONCOMPRESS SCB MOVER    R4 S2107000
         SPACE 1                                                     R4 S2107500
MVKPNC2  CLI   0(RCHAR),C' '       TEST SOURCE CHARACTER             R4 S2108000
         BE    MVKVNCAL            END NONCOMPRESS SCB IF PRIME      R4 S2108500
         CLR   RNUM,RSCBL          TEST IF EMISSION CAN FIT IN SCB   R4 S2109000
         BNL   MVKVNCAL            END SCB IF NOT                    R4 S2109500
         CLR   RNUM,RBY1           COMPARE (DUP FACTOR - 1) WITH 1   R4 S2110000
         BH    MVKVNCAL            END IF DUP FACTOR GREATER THAN 2  R4 S2110500
         SLR   RNUM,RBY1           DECREASE DUP FACTOR BY 1         R41 S2110800
         BCT   RSCBL,MVKPNC1       DECREASE REMAINING SPACE IN SCB     CS2111000
               (ALWAYS BRANCHES)    BY 1 & TREAT AS IF SINGLE CHAR.  R4 S2111500
         EJECT                                                       R4 S2112000
*                                                                    R4 S2112500
*           COMPRESSION PLANNER - EMPTY STATE  (NO CURRENT SCB)      R4 S2113000
*                                                                    R4 S2113500
         SPACE 1                                                     R4 S2114000
         CNOP  0,8                 MAIN LOOP BRANCH TARGET ON DBLWD R41 S2114300
         B     0(,RFEED)       -8  FEEDER-END AND PLANNER-          R41 S2114400
         BR    RFEED           -4   END ROUTINES ARE NO-OPS         R41 S2114500
         SPACE 1                                                     R4 S2115000
MVKPEYRR BALR  RPLAN,RPLAN    INSTRUCTION THAT RETURNS TO CALLER OF    CS2115500
                               SCB MOVE ROUTINE 'MVKVNC', CHANGING     CS2116000
                                TO EMPTY STATE AT THE SAME TIME.     R4 S2116500
         SPACE 1                                                     R4 S2117000
MVKPEY   SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1   R4 S2117500
         BC    SLSP,MVKPEYV        BRANCH IF MORE THAN SINGLE CHAR. R41 S2118000
         CLI   0(RCHAR),C' '       TEST CURRENT EMISSION             R4 S2118500
         BE    MVKVPR              IF PRIME GO STORE PRIME SCB       R4 S2119000
         SPACE 1                                                     R4 S2119500
MVKPEYN  LA    RSCBL,63(,RSINK)    CALC WHERE FULL CAPACITY SCB ENDS R4 S2120000
         CLR   RSCBL,REND          SEE IF ROOM FOR FULL CAPACITY SCB R4 S2120500
         BNH   SKIP410             BRANCH IF YES                     R4 S2121000
         LR    RSCBL,REND          SUBSTITUTE WHERE THE R.U. ENDS    R4 S2121500
SKIP410  ST    RCHAR,SCWSRCEB      SAVE BEGIN ADDR FOR MOVE ROUTINE  R4 S2122000
         SLR   RSCBL,RSINK         COMPUTE UNUSED SCB CAPACITY       R4 S2122500
         BC    SLSZ,MVKZOFLO       BRANCH IF NO ROOM FOR SCB + CHAR. R4 S2123000
         LA    RPLAN,MVKPNC        CHANGE TO NONCOMPRESSED STATE     R4 S2123500
         ST    RSCBL,SCWSCBNC      SAVE SCB STARTING CAPACITY       R41 S2123600
         MVI   0(RSINK),0          SET LENGTH ALREADY MOVED TO ZERO  R4 S2124000
         BCT   RSCBL,MVKEMITR      GET NEXT EMISSION                 R4 S2124500
         STC   RBY1,0(,RSINK)      IF SCB FULL ALREADY STORE COUNT=1 R4 S2125000
         MVC   1(1,RSINK),0(RCHAR) MOVE IN SINGLE CHARACTER          R4 S2125500
         LA    RSINK,2(,RSINK)     INCREASE PTR FOR 'RPLRLEN' CALC   R4 S2126000
         BCT   RNUM,MVKZFULL       FORCE DUP FACTOR NEGATIVE & SEND    CS2126500
               (ALWAYS BRANCHES)    SINCE SHORT SCB IMPLIES FULL RU  R4 S2127000
         SPACE 1                                                     R4 S2127500
MVKPEYV  CLI   0(RCHAR),SCSBLANK   TEST EMISSION CHARACTER          R41 S2128000
         BNE   MVKVDU              GO STORE DUP SCB IF NOT PRIME     R4 S2128500
         SPACE 1                                                    R41 S2129000
*                                                                    R4 S2129500
*           COMPRESSION MOVER - DUPLICATE PRIME SCB                  R4 S2130000
*                                                                    R4 S2130500
         SPACE 1                                                    R41 S2130700
MVKWPR0  SLR   RCPA,RCPA           SHOW COMPACTION NOT COMPETING    R41 S2130800
         SPACE 1                                                     R4 S2131000
MVKVPR   LA    RLCHAR,SCBPRIME+1(,RNUM)  GENERATE SCB (INVALID IF      CS2131500
                                         DUP FACTOR HIGHER THAN MAX) R4 S2132000
         SL    RNUM,MVKVMAX        TEST DUP FACTOR HIGHER THAN MAX   R4 S2132500
         STC   RLCHAR,0(,RSINK)    STORE SCB IN CASE VALID           R4 S2133000
         BC    NOT-SLSM,SKIP420    RE-DO IF DUP FACTOR OVER MAX      R4 S2133500
         BXLE  RSINK,RBY1,MVKEMITR OTHERWISE ADVANCE R.U. POINTER      CS2134000
                                    AND GET NEXT EMISSION            R4 S2134500
         B     MVKZFULL            GO SEND R.U. IF FULL              R4 S2135000
         SPACE 1                                                     R4 S2135500
SKIP420  MVI   0(RSINK),SCBPRIME+63  STORE SCB WITH MAX COUNT        R4 S2136000
         BXLE  RSINK,RBY1,MVKVPR   GENER. ANOTHER SCB FOR REMAINDER  R4 S2136500
         B     MVKZOFLO            IF R.U. FULL, GO SEND & RE-ENTER  R4 S2137000
         EJECT                                                       R4 S2138500
*                                                                    R4 S2139000
*           COMPRESSION MOVER - DUPLICATE NONPRIME SCB               R4 S2139500
*                                                                    R4 S2140000
         SPACE 1                                                     R4 S2140500
*                             LOOP POINT FOR DUP FACTOR MORE THAN 63 R4 S2141000
         SPACE 1                                                     R4 S2141500
MVKVDUL  MVI   0(RSINK),SCBDUPLC+63  STORE SCB WITH MAX COUNT        R4 S2142000
         LA    RSINK,1(,RSINK)     ADV R.U. PTR W/O CHGING COND CODE R4 S2142500
         BXH   RSINK,RBY1,MVKZOFLO IF R.U. FULL GO SEND & RE-ENTER  R41 S2143000
         LA    RNUM,0(RNUM,RLSRCE) BACK OUT DUP FACTOR CALCULATION. R41CS2143200
                                    CONDITION CODE STILL NOT CHANGED R4 S2143500
         BCR   SLSZ,RPLAN          IF ONLY 1 OCCURRENCE LEFT, GO    R41CS2144000
                                    RE-ENTER EMPTY STATE. ELSE JUST R41CS2144500
                                     GENERATE ANOTHER DUPLICATE SCB  R4 S2145000
         SLR   RNUM,RLSRCE         RECALCULATE DUP FACTOR LESS 1    R41 S2145100
         SPACE 1                                                    R41 S2145300
MVKWDU0  SLR   RCPA,RCPA           SHOW COMPACTION NOT COMPETING    R41 S2145400
         SPACE 1                                                     R4 S2145500
*                             MAIN ENTRY - DUP FACTOR LESS 1 IN RNUM R4 S2146000
         SPACE 1                                                     R4 S2146500
MVKVDU   CLR   RSINK,REND          COMPARE R.U. PTR WITH END OF R.U. R4 S2147000
         IC    RLCHAR,0(,RCHAR)    PICK UP SOURCE CHARACTER          R4 S2147500
         BNL   MVKZOFLO            GO END IF 1 BYTE AVAIL. (NEED 2)  R4 S2148000
         STC   RLCHAR,1(,RSINK)    STORE SOURCE CHARACTER IN R.U.    R4 S2148500
         LA    RLCHAR,SCBDUPLC+1(,RNUM)  GENERATE SCB (INVALID IF      CS2149000
                                         DUP FACTOR HIGHER THAN MAX) R4 S2149500
         SL    RNUM,MVKVMAX        TEST DUP FACTOR HIGHER THAN MAX   R4 S2150000
         STC   RLCHAR,0(,RSINK)    STORE SCB IN CASE VALID           R4 S2150500
         LA    RLCHAR,0            ZERO BRANCH REG FOR COMPCT  @OZ25416 S2150550
         BC    NOT-SLSM,MVKVDUL    RE-DO IF DUP FACTOR OVER MAX      R4 S2151000
         ALR   RSINK,RBY1          ADVANCE R.U. POINTER              R4 S2151500
         BXLE  RSINK,RBY1,MVKEMITR ADV R.U. PTR & GET NEXT EMISSION  R4 S2152000
         B     MVKZFULL            IF R.U. FULL GO SEND IT           R4 S2152500
         SPACE 3                                                    R41 S2152600
MVKVMAX  DC    F'63'               MAXIMUM COUNT VALUE IN AN SCB    R41 S2152700
         EJECT                                                       R4 S2153000
*********************************************************************** S2153500
*                                                                     * S2154000
*      COMPRESSION MOVER - NONCOMPRESSED SCB                          * S2154500
*                                                                     * S2155000
*   NOTATION USED IN FOLLOWING REMARKS HAS MEANING GIVEN.             * S2155500
*      EV.RXXXX  IS THE ENTRY VALUE OF REGISTER RXXXX.                * S2156000
*      IV.RXXXX  IS AN INTERMEDIATE VALUE OF REGISTER RXXXX.          * S2156500
*      NV.RXXXX  IS THE NEW (FINAL) VALUE OF REGISTER RXXXX.          * S2157000
*      C         REPRESENTS THE SCB COUNT.                            * S2157500
*      CA        REPRESENTS THE SCB CAPACITY (SEE BELOW).             * S2157700
*      P         REPRESENTS THE OLD SCB COUNT, THE NUMBER OF          * S2158000
*                BYTES ALREADY MOVED FROM PREVIOUS SOURCES.           * S2158500
*                                                                     * S2159000
*   SAVEWORD AND REGISTER CONTENTS AT ENTRY -                         * S2159500
*      EV.REND  = ADDRESS OF LAST BYTE IN R.U. BUFFER                 * S2160000
*      EV.RSINK = ADDRESS WHERE SCB IS TO BE STORED                   * S2160500
*      EV.RSCBL = NUMBER OF UNUSED BYTES IN THE SCB.                  * S2161000
*      SCWSCBNC = THE SCB STARTING CAPACITY.  THIS VALUE              * S2161500
*                 IS 63 IF THERE WAS ROOM IN THE R.U. FOR             * S2162000
*                 A FULL CAPACITY SCB, OTHERWISE IT IS THE            * S2162500
*                 NUMBER OF BYTES LEFT IN THE R.U. LESS 1             * S2163000
*                 = EV.REND-EV.RSINK.  RSCBL STARTS OUT               * S2163100
*                 WITH THIS VALUE AND COUNTS DOWN.                    * S2163200
*      THUS EV.RSCBL = MIN (63, EV.REND-EV.RSINK) - C                 * S2163500
*                   = VALUE SAVED IN 'SCWSCBNC'  - C                  * S2163700
*      EV.RLCHAR= ... (DON'T CARE)                                    * S2164000
*                                                                     * S2164500
*   DESIRED REGISTER CONTENTS AT EXIT -                               * S2165000
*      NV.REND  = EV.REND  (NO CHANGE)                                * S2165500
*      NV.RSINK = EV.RSINK + C + 1  (1 IS FOR SCB ITSELF)             * S2166000
*      NV.RSCBL = ... (DON'T CARE)                                    * S2166500
*      NV.RLCHAR= ... (DON'T CARE)                                    * S2167000
*                                                                     * S2167500
*   ENTRY POINTS -                                                    * S2168000
*      MVKVNC    NORMAL SCB TERMINATION ROUTINE. STORES SCB,          * S2168500
*                MOVES ANY PART OF DATA NOT MOVED PREVIOUSLY          * S2169000
*      MVKVNCAL  ENTRY POINT TO NORMAL SCB TERMINATION RTNE.          * S2169500
*                USED WHEN SCB ENDED BY PRIME/DUPLICATE SCB.          * S2170000
*      MVKVNCI   SCB INTERRUPT ROUTINE.  LIKE TERMINATION             * S2170500
*                ROUTINE, IT STORES SCB AND MOVES DATA. HOW-          * S2171000
*                EVER, IT ALSO PRESERVES REG CONTENTS NEEDED          * S2171500
*                TO ADD DATA FROM THE NEXT SOURCE STRING TO           * S2172000
*                THE SAME SCB. GETS CONTROL VIA PLANNER-END           * S2172500
*                BRANCH, RETURNS ON REG. 'RFEED'.                     * S2173000
*                                                                     * S2173500
*********************************************************************** S2174000
         EJECT                                                      R41 S2174500
MVKVNCI  ST    RSINK,SCWSCBA       SAVE ADDRESS OF INTERRUPTED SCB  R41 S2176000
         ST    RSCBL,SCWSCBL       SAVE NUMBR OF UNUSED BYTES IN SCB R4 S2176500
         SPACE 2                                                     R4 S2177000
MVKVNCAL LA    RPLAN,MVKPEYV       OTHER MOVE ROUTINE ENTERS HERE TOR41CS2177500
                                    TERMINATE NONCOMPRESS SCB.  RNUM   CS2178000
                                     (DUP FACTOR - 1) IS 0 OR PLUS.  R4 S2178500
         SPACE 5                                                    R41 S2179000
*                                                                    R4 S2179500
*           COMPRESSION MOVER - NONCOMP SCB TERMINATION ROUTINE     R41 S2180000
*                                                                    R4 S2180500
         SPACE 1                                                     R4 S2181000
MVKVNC   L     RLCHAR,SCWSCBNC     GET  CA           (SCB CAPACITY) R41 S2186500
         SLR   RLCHAR,RSCBL        GET  CA-(CA-C) = C   (SCB COUNT) R41 S2187000
         IC    RSCBL,0(,RSINK)     GET  P     (COUNT PREV'LY MOVED) R41 S2187500
         STC   RLCHAR,0(,RSINK)    STORE NEW SCB IN R.U.            R41 S2188000
         ALR   RSINK,RSCBL         POINT PAST DATA PREVIOUSLY MOVED R41 S2188500
         SLR   RLCHAR,RSCBL        DECREASE MOVE LENGTH BY  P       R41 S2189000
         BC    NOT-SLSP,MVKVNCB    SKIP EXECUTE IF NOTHING TO MOVE  R41 S2189500
         BCTR  RLCHAR,0            GET  C - P - 1  FOR MACHINE LTH  R41 S2190000
         L     RSCBL,SCWSRCEB      RETRIEVE SOURCE STRING START ADDRR41 S2190500
         EX    RLCHAR,MVKVNMVC     MOVE  C - P  CHARACTERS          R41 S2191000
         LA    RSINK,1(RLCHAR,RSINK)  POINT PAST STORED SCB STRING  R41CS2191500
                                    (IV.RSINK=EV+P+(C-P-1)+1 = EV+C)   CS2192000
                                     BXLE BELOW SETS NV.RSINK=EV+C+1 R4 S2192500
MVKVNCB  LTR   RNUM,RNUM           TEST IF CALL FROM OTHER MOVE RTNER41 S2193000
         BM    MVKVNCFS            BRANCH IF NOT                     R4 S2193500
         BXLE  RSINK,RBY1,MVKPEYRR GO CHGE TO EMPTY STATE & RE-ENTER R4 S2194000
         B     MVKZOFLO            IF R.U. FULL, GO SEND & RE-ENTER  R4 S2194500
         SPACE 1                                                     R4 S2195000
MVKVNMVC MVC   1(*-*,RSINK),0(RSCBL)  ** EXECUTE ONLY **            R41 S2195500
         SPACE 1                                                     R4 S2196000
MVKVNCFS BXH   RSINK,RBY1,MVKZFULL IF R.U. FULL GO SEND             R41 S2196500
         ALR   RNUM,RBY1           TEST TYPE OF MOVE ROUTINE CALL   R41 S2197000
         BC    ALDM,MVKPNCS        BRANCH IF SUSPEND-TYPE CALL      R41 S2197500
         LA    RPLAN,MVKPEY        ELSE FULL SCB CALL--CHANGE TO    R41 S2198000
         B     MVKEMITR             EMPTY STATE & GET NEXT EMISSION R41 S2198500
         EJECT                                                       R4 S2200500
*                                                                    R4 S2201000
*           COMPRESSION PLANNER - NONCOMPRESS SCB STATE  (SUSPEND)   R4 S2201500
*                                                                    R4 S2202000
         SPACE 1                                                    R41 S2202100
         BR    RFEED           -4  FEEDER-END ROUTINE DOESN'T EXIST,R41CS2202200
                                    PLANNER-END ROUTINE IS NO-OP    R41 S2202300
MVKPNCS  BALR  RPLAN,RFEED         CHGE TO NON-COMPRESS SUSPD STATE R41CS2202400
                                    & RETURN FROM PLANNER-END RTNE  R41 S2202500
         SPACE 1                                                    R41 S2202600
         SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1   R4 S2203000
         L     RSCBL,SCWSCBL       RELOAD OLD SCB REMAINING CAPACITY R4 S2203500
         BC    SLSP,MVKPNCS2       BRANCH IF DUP FACTOR GRTR THAN 1  R4 S2204000
         SPACE 1                                                     R4 S2204500
MVKPNCS1 L     RSINK,SCWSCBA       BACK UP TO OLD SUSPENDED SCB      R4 S2205000
         ST    RCHAR,SCWSRCEB      SAVE ADDR OF STRING TO BE ADDED   R4 S2205500
         LA    RPLAN,MVKPNC        CHNGE TO NORMAL NONCOMPRESS STATE R4 S2206000
         BCT   RSCBL,MVKEMITR      ADV SCB COUNT & GET NEXT EMISSION R4 S2206500
         LCR   RNUM,RBY1           IF SCB FULL SHOW NOTHING SAVED    R4 S2207000
         B     MVKVNC              BRANCH TO NONCOMPRESS SCB MOVER   R4 S2207500
         SPACE 1                                                     R4 S2208000
MVKPNCS2 LA    RPLAN,MVKPEY        ANTICIPATE CHANGE TO EMPTY STATE  R4 S2208500
         CLI   0(RCHAR),C' '       TEST SOURCE CHARACTER             R4 S2209000
         BE    MVKVPR              DON'T REVIVE NONCOMP SCB IF PRIME R4 S2209500
         CLR   RNUM,RSCBL          TEST IF EMISSION CAN FIT IN SCB   R4 S2210000
         BNL   MVKVDU              DON'T REVIVE SCB IF NOT           R4 S2210500
         CLR   RNUM,RBY1           COMPARE (DUP FACTOR - 1) WITH 1   R4 S2211000
         BH    MVKVDU              DON'T REVIVE IF DUP FACTOR GT 2   R4 S2211500
         BCTR  RCHAR,0             BACK UP TO 1ST OF PAIR OF CHARS   R4 S2212000
         BCT   RSCBL,MVKPNCS1      DECREASE REMAINING SPACE IN SCB     CS2212500
               (ALWAYS BRANCHES)    BY 1 & TREAT AS IF SINGLE CHAR.  R4 S2213000
         TITLE 'HASP SNA REMOTE TERMINAL COMPACTION ROUTINES'       R41 S2213500
*********************************************************************** S2214000
*                                                                     * S2214200
*               COMPACTION MOVER - NONCOMPRESSED SCB                  * S2214400
*                                                                     * S2214600
*   NOTATION - SEE 'MVKVNC' PROLOG                                    * S2214800
*                                                                     * S2215000
*   REGISTER CONTENTS AT ENTRY - SAME AS 'MVKVNC', PLUS               * S2215200
*      EV.RCPA  = (BITS 1-31) COMPACTION RACING STATUS                * S2215400
*                 A VALUE GREATER THAN 3 (BUT NEVER OVER 255)         * S2215600
*                 MEANS COMPACTION IS TO BEGIN AND CAUSES THIS        * S2215800
*                 ROUTINE TO EXIT DIRECTLY TO THE CONVERTER.          * S2216000
*                 (BIT 0) IF ON, RACING BEGAN WITHIN THIS NON-        * S2216200
*                 COMP SCB--SAVEWORDS 'SCWSCBNA' AND 'SCWSCBNS'       * S2216400
*                 CONTAIN THE NONCOMP SCB ADDRESS (= EV.RSINK)        * S2216600
*                 & THE SPACE LEFT IN SCB AT TIME RACE BEGAN.         * S2216800
*                                                                     * S2217000
*   DESIRED REGISTER CONTENTS AT EXIT - SAME AS 'MVKVNC', PLUS        * S2217200
*      NV.RCPA  = EV.RCPA                                             * S2217400
*                 EXCEPT IF SIGN BIT WAS ON, IT IS TURNED OFF.        * S2217600
*                 IF THIS OCCURS & THE RESULT IS NOT ZERO, SAVE-      * S2217800
*                 WORD 'SCWSCBCA' MUST BE SET FOR THE CONVERTER.      * S2218000
*      THE FOLLOWING IS REQUIRED ONLY IF NV.RCPA IS NOT ZERO.         * S2218200
*      NV.RSCBL = ADDRESS WHERE THE PRESENTLY RACING COMPACT          * S2218400
*                 SCB WOULD END IF FILLED TO MAXIMUM CAPACITY.        * S2218600
*                                                                     * S2218800
*   MAJOR ENTRY POINTS -                                              * S2219000
*      MVKWNC    AS FOR 'MVKVNC',                                     * S2219200
*      MVKWNCAL/X       'MVKVNCAL', AND                               * S2219400
*      MVKWNCI          'MVKVNCI'  IN PRECEDING ROUTINE.              * S2219600
*                                                                     * S2219800
*********************************************************************** S2220000
         SPACE 14                                                   R41 S2220200
MVKWNCI  ST    RSINK,SCWSCBA       SAVE ADDRESS OF INTERRUPTED SCB  R41 S2220400
         ST    RSCBL,SCWSCBL       SAVE NUMBER UNUSED BYTES IN SCB  R41 S2220600
         LR    RCHAR,RCPA          SAVE RACE STATE & SETUP FLAG     R41 S2220800
         SPACE 2                                                    R41 S2221000
MVKWNCAX SLR   RCPA,RCPA           SHOW COMPACTION NOT COMPETING    R41 S2221200
MVKWNCAL LA    RPLAN,MVKPEYV       OTHER MOVE ROUTINE ENTERS HERE TOR41CS2221400
                                    TERMINATE NONCOMPRESS SCB. RNUM R41CS2221600
                                     (DUP FACTOR - 1) IS 0 OR PLUS. R41 S2221800
         EJECT                                                      R41 S2222000
*                                                                   R41 S2222200
*           COMPACTION MOVER - NONCOMP SCB TERMINATION ROUTINE      R41 S2222400
*                                                                   R41 S2222600
         SPACE 1                                                    R41 S2222800
MVKWNC   L     RLCHAR,SCWSCBNC     GET  CA           (SCB CAPACITY) R41 S2223000
         SLR   RLCHAR,RSCBL        GET  CA-(CA-C) = C   (SCB COUNT) R41 S2223200
MVKWNC6  IC    RSCBL,0(,RSINK)     GET  P  (COUNT PREVIOUSLY MOVED) R41 S2223400
         STC   RLCHAR,0(,RSINK)    STORE NEW SCB IN R.U.            R41 S2223600
         ALR   RSINK,RSCBL         POINT PAST DATA PREVIOUSLY MOVED R41 S2223800
         SLR   RLCHAR,RSCBL        DECREASE MOVE LENGTH BY  P       R41 S2224000
         BC    NOT-SLSP,MVKWNCB    SKIP EXECUTE IF NOTHING TO MOVE  R41 S2224200
         BCTR  RLCHAR,0            GET  C - P - 1  FOR MACHINE LTH  R41 S2224400
         L     RSCBL,SCWSRCEB      RETRIEVE SOURCE STRING START ADDRR41 S2224600
         EX    RLCHAR,MVKVNMVC     MOVE  C - P  CHARACTERS          R41 S2224800
         LA    RSINK,1(RLCHAR,RSINK)  POINT PAST STORED SCB STRING  R41CS2225000
                                   (IV.RSINK=EV+P+(C-P-1)+1 = EV+C) R41CS2225200
                                    BXLE BELOW SETS NV.RSINK=EV+C+1 R41 S2225400
MVKWNCB  LTR   RCPA,RCPA           TEST IF RACE BEGAN IN THIS SCB   R41 S2225600
         BNP   MVKWNCR             BRANCH IF YES, OR NOT RACING     R41 S2225800
MVKWNCBA L     RSCBL,SCWSCBCE      RESTORE PLANNED COMPACT SCB END  R41CS2226000
                                    IN CASE RACING BEGAN ELSEWHERE  R41 S2226200
         CL    RCPA,MVKQXVA        TEST RACING STATE VALIDITY       R41 S2226400
         BNL   MVKWCA              ENTER COMPACTION IF INVALID      R41 S2226600
MVKWNCD  LTR   RNUM,RNUM           TEST IF CALL FROM OTHER MOVE RTNER41 S2226800
         BM    MVKWNCFS            BRANCH IF NOT                    R41 S2227000
         BXLE  RSINK,RBY1,MVKQEYRR GO CHGE TO EMPTY STATE & RE-ENTERR41 S2227200
         B     MVKZOFLO            IF R.U. FULL, GO SEND & RE-ENTER R41 S2227400
         SPACE 2                                                    R41 S2227600
MVKWNCFS BXH   RSINK,RBY1,MVKZFULL IF R.U. FULL GO SEND             R41 S2227800
         ALR   RNUM,RBY1           TEST TYPE OF MOVE ROUTINE CALL   R41 S2228000
         BC    ALDM,MVKQNCS        RETURN IF SUSPEND-TYPE CALL      R41 S2228200
         LA    RPLAN,MVKQEY        ELSE FULL SCB CALL--CHANGE TO    R41 S2228400
         B     MVKEMITR             EMPTY STATE & GET NEXT EMISSION R41 S2228600
         SPACE 2                                                    R41 S2228800
MVKWNCP  LA    RPLAN,MVKQEPM       CAUSE REPROCESS IN EMPTY STATE   R41 S2229000
MVKWNCQ  BCTR  RSINK,0             BACK UP TO END OF STORED NC SCB  R41 S2229200
         LTR   RCPA,RCPA           TEST RACING STATE                R41 S2229400
         BP    MVKWNCBA            BR IF DID NOT BEGIN IN THIS SCB  R41 S2229600
         SPACE 1                                                    R41 S2229800
MVKWNCR  BZ    MVKWNCD             BRANCH IF NOT RACING             R41 S2230000
         SL    RCPA,MVKQXINO       CLEAR RACE STATE OVERLAP FLAG    R41 S2230200
         BC    SLSZ,MVKWNCD        BRANCH IF RACE CALLED OFF        R41 S2230400
         L     RLCHAR,SCWSCBNC     GET NONCOMP SCB MAX CAPACITY     R41 S2230600
         SL    RLCHAR,SCWSCBNS     SUBTR SPACE LEFT WHEN RACE BEGAN R41 S2230800
         STC   RLCHAR,SCWSCBCA     SAVE NC LENGTH UP TO RACE START  R41 S2231000
         L     RSCBL,SCWSCBNA                   CALC END OF FULL    R41 S2231200
         LA    RSCBL,SCB+SCBMAXCT(RLCHAR,RSCBL)  CAPACITY COMP SCB  R41 S2231400
         CLR   RSCBL,REND          ATTEMPT TO FIT FULL CAPACITY SCB R41 S2231600
         BNH   MVKWNCRC            BRANCH IF CAN FIT                R41 S2231800
         LR    RSCBL,REND          ELSE SUBSTITUTE END OF R.U.      R41 S2232000
MVKWNCRC CL    RCPA,MVKQXVA        TEST RACE STATE VALIDITY         R41 S2232200
         BL    MVKWNCD             DON'T START COMPACT YET IF VALID R41 S2232400
         EJECT                                                      R41 S2232600
*********************************************************************** S2232800
*                                                                     * S2233000
*      COMPACTION CONVERTER - CONVERT ALREADY-MOVED STRING CONTAIN-   * S2233200
*                             ING OTHER SCB TYPES TO COMPACTED FORM   * S2233400
*   OBJECTIVE -                                                       * S2233600
*        CONVERT A STRING OF NONCOMP, DUP, & PRIME DUP SCBS TO        * S2233800
*        COMPACTED FORM.  THIS ROUTINE IS NOT GENERAL & HANDLES       * S2234000
*        ONLY STRINGS OF SCBS WHICH THE EMPTY & NONCOMP PLANNERS      * S2234200
*        CONSTRUCT DURING RACING.                                     * S2234400
*                                                                     * S2234600
*   SAVEWORD AND REGISTER CONTENTS AT ENTRY -                         * S2234800
*        SCWSCBCA = (BITS 0-7) ZERO (RACE BEGAN IN EMPTY STATE),      * S2235000
*                             OR 63 (ADDING TO EXISTING COMP SCB)     * S2235200
*                   (BITS 8-23) ADDRESS OF COMPACTION SCB             * S2235400
*                   OR                                                * S2235600
*                   (BITS 0-7) 1-62 (RACE BEGAN WITHIN NONCOMP        * S2235800
*                               SCB) VALUE IS NONCOMPACT LENGTH       * S2236000
*                               UP TO POINT WHERE COMPACT STARTS      * S2236200
*                   (BITS 8-23) ADDRESS OF NONCOMPACT SCB             * S2236400
*        EV.REND  = ... (DON'T CARE)                                  * S2236600
*        EV.RSINK = ADDRESS OF LAST BYTE TO BE CONVERTED.             * S2236800
*        EV.RSCBL = ADDRESS WHERE COMPACT SCB WILL END IF             * S2237000
*                   FILLED TO MAXIMUM CAPACITY                        * S2237200
*        EV.RPLAN = ... (DON'T CARE)                                  * S2237400
*        EV.RCPA  = (BITS 0-23) ZERO (BITS 24-31 = DON'T CARE)        * S2237600
*        EV.RCHAR = POINTER & DUP FACTOR FOR CURRENT EMISSION,        * S2237800
*         & RNUM    PASSED UNCHANGED TO COMPACTION PLANNER.           * S2238000
*        EV.RLCHAR= (BITS 0-23) ZERO (BITS 24-31 = DON'T CARE)        * S2238200
*                                                                     * S2238400
*   DESIRED SAVEWORD AND REGISTER CONTENTS AT EXIT -                  * S2238600
*        SCWSCBCA = ADDRESS OF COMPACTION SCB IN ALL CASES            * S2238800
*        NV.REND  = EV.RSCBL (LIMITS BXLE/BXH IN COMPACT STATE)       * S2239000
*        NV.RSINK = EV.RSINK     ON EXIT TO  ODD COMPACT STATE        * S2239200
*                 = EV.RSINK + 1 ON EXIT TO EVEN COMPACT STATE        * S2239400
*        NV.RSCBL = 0  CLEARED FOR USE AS WORK REGISTER 'RCPZ'        * S2239600
*        NV.RPLAN = ADDRESS OF EVEN OR ODD COMPACTION PLANNER         * S2239800
*        NV.RCPA  = (BITS 0-23) ZERO (BITS 24-31 = DON'T CARE)        * S2240000
*        NV.RLCHAR= (BITS 0-23) ZERO (BITS 24-31 = DON'T CARE)        * S2240200
*                                                                     * S2240400
*   =/ NOTE /= - IN COMPACTION CODE, ANY NUMBER APPEARING IN A        * S2240600
*        SYMBOLIC LABEL REFERS TO THE STATE BEING HANDLED AT          * S2240800
*        THAT POINT.  STATE NUMBERS ARE DESCRIBED IN PROLOG           * S2241000
*        PRECEDING COMPACTION EMPTY STATE PLANNER 'MVKQEY'.           * S2241200
*                                                                     * S2241400
*********************************************************************** S2241600
         EJECT                                                      R41 S2241800
MVKWCA   ALR   RNUM,RLSRCE         BACK OUT DUP FACTOR CALCULATION  R41 S2242000
         LR    REND,RSINK          SET UP LOOP CONTROL FOR          R41 S2242200
         L     RSINK,SCWSCBCA       RESCANNING STORED STRING        R41 S2242400
         TM    SCWSCBCA,SCBMAXCT   TEST FOR OVERLAP CONDITIONS      R41 S2242600
         BZ    MVKWC0              BR IF RACE BEGAN IN EMPTY STATE  R41 S2242800
         BO    MVKWC10             BR IF ADDING TO A COMPACTION SCB R41 S2243000
         IC    RCPA,SCWSCBCA       ELSE COMPACTION SCB BEGAN WITHIN R41 S2243200
         IC    RLCHAR,0(,RSINK)     NONCOMP SCB--PICK UP OLD LENGTH R41 S2243400
         STC   RCPA,0(,RSINK)      STORE NEW LTH SHORTENED BY OVLAP R41 S2243600
         LA    RSINK,SCB(RCPA,RSINK)  CALC COMPACTION               R41 S2243800
         ST    RSINK,SCWSCBCA          SCB START ADDRESS            R41 S2244000
         SLR   RLCHAR,RCPA         OLD LENGTH - NEW LENGTH = OVERLAPR41 S2244200
         BCT   RLCHAR,MVKWC6       BRANCH IF OVERLAP OF AT LEAST 2  R41 S2244400
         IC    RCPA,0(,RSINK)      FETCH MASTER FROM LAST BYTE OF   R41 S2244600
         IC    RCPA,CPTCTT(RCPA)    NC STRING & XLATE TO 8-BIT FORM R41 S2244800
         B     MVKWC1R             GO CONVERT FOLLOWING SCB         R41 S2245000
         SPACE 2                                                    R41 S2245200
MVKWC6   TR    0(2,RSINK),CPTCTT   TRANSLATE 2 MASTERS IN PLACE     R41 S2245400
         PACK  0(1,RSINK),0(1,RSINK)  GET 1ST MASTER IN LEFT NIBBLE R41 S2245600
         NC    1(1,RSINK),0(RSINK) FORM MASTER PAIR                 R41 S2245800
         ALR   RSINK,RBY1          ADJUST POINTERS & GO             R41 S2246000
         BCT   RLCHAR,MVKWC6D       SIMULATE NONCOMP SCB            R41 S2246200
         B     MVKWC2S             IF WERE EXACTLY 2, GET NEXT SCB  R41 S2246400
         SPACE 2                                                    R41 S2246600
MVKWC0   TM    0(RSINK),SCBDUPLC   TEST FIRST SCB TO BE CONVERTED   R41 S2246800
         BZ    MVKWC1C             BRANCH IF NONCOMP/NONDUP SCB     R41 S2247000
         IC    RCPA,CPTCTT+SCSBLANK  ANTICIPATE PRIME WITH COUNT 1  R41 S2247200
         BNO   MVKWC1R             BRANCH IF PRIME DUP              R41 S2247400
         IC    RCPA,1(,RSINK)      ELSE TRANSLATE MASTER            R41 S2247600
         IC    RCPA,CPTCTT(RCPA)    TO 8-BIT COMPACT FORM           R41 S2247800
         CLI   0(RSINK),SCBDUPLC+2 SET COND CODE FOR COUNT 2 OR 3   R41 S2248000
         BXLE  RSINK,RBY1,MVKWC0QA ADVANCE POINTER PAST SCB LOC &   R41CS2248200
               (ALWAYS BRANCHES)    HANDLE REMAINING 2 OR 3 MASTERS R41 S2248400
         SPACE 2                                                    R41 S2248600
MVKWC10  LR    RPLAN,RSINK         SAVE ADDR OF OLD COMPACT SCB     R41 S2248800
         NI    0(RSINK),SCBMAXCT   USE OLD COMPACT                  R41 S2249000
         IC    RCPA,0(,RSINK)       SCB COUNT TO FIND               R41 S2249200
         LA    RSINK,SCB(RCPA,RSINK) STRING TO BE CONVERTED         R41 S2249400
         TM    0(RSINK),SCBDUPLC-SCBPRIME+4  TEST 1ST SCB (MUST BE  R41CS2249600
                                             PRIME 3 OR DUP 3 OR 5) R41 S2249800
         BNM   MVKWC2U             FINISH HANDLING PRIME 3 OR DUP 5 R41 S2250000
         SPACE 1                                                    R41 S2250200
MVKWC10B MVI   SCBMAXCT(RPLAN),SCBDUPLC+5  MAKE DUP 3 LOOK LIKE 5   R41 S2250400
         MVI   0(RPLAN),SCBMAXCT   SHOW SCB NOW FULL                R41 S2250600
         LA    RSINK,SCB+SCBMAXCT(,RPLAN)  COMPUTE START ADDRESS    R41 S2250800
         ST    RSINK,SCWSCBCA               OF NEXT COMPACTION SCB  R41 S2251000
         BCT   RSINK,MVKWC2W       BACK UP TO 'DUP 5' SCB & CONVERT R41CS2251200
               (ALWAYS BRANCHES)    TO 2 PAIRS + ODD M--2ND COMPACT R41CS2251400
                                     SCB COVERS 1 PAIR GIVING 3 M'S R41 S2251600
         EJECT                                                      R41 S2251800
MVKWC1C  IC    RLCHAR,0(,RSINK)    GET LENGTH OF NONCOMP/NONDUP SCB R41 S2252000
         STC   RCPA,0(,RSINK)      REPLACE WITH ODD MASTER IF ANY   R41 S2252200
MVKWC6D  IC    RCPA,0(RLCHAR,RSINK)  SAVE COPY OF LAST BYTE IN REG  R41 S2252400
         SLR   RLCHAR,RBY1         DECREMENT FOR MACHINE LENGTH     R41 S2252600
         EX    RLCHAR,MVKWCATR     TRANSLATE TO 8-BIT COMPACTED     R41 S2252800
         LA    RSINK,1(RLCHAR,RSINK)  POINT TO END OF SCB STRING    R41 S2253000
         LA    RPLAN,CPTCAT(RCPA)  TEST ATTRIBUTE OF                R41 S2253200
         CLI   0(RPLAN),CPTMST      LAST BYTE IN STRING             R41 S2253400
         BL    MVKWC2S             BRANCH IF NOT A MASTER           R41 S2253600
         IC    RCPA,0(,RSINK)      SAVE 8-BIT TRANSLATED ODD MASTER R41 S2253800
MVKWC3E  CLR   RSINK,REND          CHGE TO ODD COMPACT STATE        R41 S2254000
         BNL   MVKWC11Z             IF STORED STRING EXHAUSTED      R41 S2254200
MVKWC3F  TM    1(RSINK),SCBDUPLC   TEST SCB TYPE (CANNOT BE NONDUP) R41 S2254400
         BO    MVKWC3H             BRANCH IF NON-PRIME DUP SCB      R41 S2254600
         CLI   CPTCAT+SCSBLANK,CPTPMST  TEST PRIME CHAR ATTRIBUTE   R41 S2254800
         BE    MVKWC3G             BRANCH IF PRIME IS A MASTER      R41 S2255000
         STC   RCPA,0(,RSINK)      ELSE STORE ODD MASTER AS 8 BITS  R41 S2255200
         IC    RCPA,CPTCTT+SCSBLANK  TRANSLATE PRIME TO             R41 S2255400
         STC   RCPA,1(,RSINK)         8-BIT EQUIV & STORE           R41 S2255600
         BXLE  RSINK,RBY1,MVKWC2S  ADVANCE POINTER OVER SCB LOC &   R41CS2255800
               (ALWAYS BRANCHES)    CONTINUE IN EVEN COMPACT STATE  R41 S2256000
         SPACE 1                                                    R41 S2256200
MVKWC3G  IC    RLCHAR,MVKQXMF(RCPA)  MOVE ODD MSTR INTO LEFT NIBBLE R41 S2256400
         IC    RCPA,CPTCTT+SCSBLANK  TRANSLATE PRIME TO 8-BIT EQUIV R41 S2256600
         NR    RLCHAR,RCPA         FORM & STORE                     R41 S2256800
         STC   RLCHAR,0(,RSINK)     MASTER PAIR                     R41 S2257000
         CLI   1(RSINK),SCBPRIME+3 SET C.C. FOR COUNT 2, 3, OR 4    R41 S2257200
         BXLE  RSINK,RBY1,MVKWC2Q  RESET PTR TO ORIGINAL SCB LOC &  R41CS2257400
               (ALWAYS BRANCHES)    HANDLE REMAINING 1 2 OR 3 MSTRS R41 S2257600
         SPACE 1                                                    R41 S2257800
MVKWC3H  CLI   1(RSINK),SCBDUPLC+2 TEST SCB COUNT (2, 4, 5, OR 6)   R41 S2258000
         BE    MVKWC3I             IF 2, HANDLE DOUBLE NON-MASTER   R41 S2258200
         IC    RLCHAR,MVKQXMF(RCPA)  MOVE ODD MSTR INTO LEFT NIBBLE R41 S2258400
         IC    RCPA,2(,RSINK)      TRANSLATE NON-PRIME DUP          R41 S2258600
         IC    RCPA,CPTCTT(RCPA)    TO 8-BIT COMPACT EQUIVALENT     R41 S2258800
         NR    RLCHAR,RCPA         FORM & STORE                     R41 S2259000
         STC   RLCHAR,0(,RSINK)     MASTER PAIR                     R41 S2259200
         CLI   1(RSINK),SCBDUPLC+5 SET C.C. FOR COUNT 4, 5, OR 6    R41 S2259400
         BXLE  RSINK,RBY1,MVKWC2W  ADVANCE POINTER OVER SCB LOC &   R41CS2259600
               (ALWAYS BRANCHES)    HANDLE REMAINING 3 4 OR 5 MSTRS R41 S2259800
         SPACE 1                                                    R41 S2260000
MVKWC3I  STC   RCPA,0(,RSINK)      STORE PENDING ODD MASTER         R41 S2260200
         ALR   RSINK,RBY1          ADVANCE POINTER OVER SCB LOC     R41 S2260400
         IC    RCPA,1(,RSINK)      TRANSLATE NON-PRIME DUP          R41 S2260600
         IC    RCPA,CPTCTT(RCPA)    TO 8-BIT COMPACT EQUIVALENT     R41 S2260800
MVKWC2J  STC   RCPA,0(,RSINK)      STORE 1ST OF 2 NON-MASTERS       R41 S2261000
         ALR   RSINK,RBY1          ADVANCE POINTER OVER DUP CHAR    R41 S2261200
MVKWC2K  STC   RCPA,0(,RSINK)      STORE TRANSLATED NON-MASTER      R41 S2261400
         BXLE  RSINK,RBY1,MVKWC2T  GO FETCH NEXT SCB IF MORE TO DO  R41 S2261600
MVKWC10M LR    REND,RSCBL          USE END OF SCB TO LIMIT LOOP     R41 S2261800
         SLR   RCPZ,RCPZ           CLEAR WORK REG FOR COMPACTION    R41 S2262000
         LA    RPLAN,MVKQCA10      CHANGE TO EVEN                   R41 S2262200
         BR    RPLAN                COMPACTION STATE                R41 S2262400
         EJECT                                                      R41 S2262600
MVKWC1N  IC    RCPA,1(,RSINK)      TRANSLATE NON-PRIME DUP          R41 S2262800
         IC    RCPA,CPTCTT(RCPA)    TO 8-BIT COMPACT EQUIVALENT     R41 S2263000
         NR    RLCHAR,RCPA         ODD MASTER & NEW CHAR FORM PAIR  R41 S2263200
         CLI   0(RSINK),SCBDUPLC+3 SET C.C. FOR COUNT = 2, 3 OR 4   R41 S2263400
         STC   RLCHAR,0(,RSINK)    STORE MASTER PAIR                R41 S2263600
         BXLE  RSINK,RBY1,MVKWC2Q  ADVANCE PTR TO DUP CHAR LOC &    R41CS2263800
               (ALWAYS BRANCHES)    HANDLE REMAINING 1 2 OR 3 MSTRS R41 S2264000
         SPACE 2                                                    R41 S2264200
MVKWC2P  IC    RCPA,CPTCTT+SCSBLANK  TRANSLATE PRIME TO 8-BIT EQUIV R41 S2264400
         CLI   CPTCAT+SCSBLANK,CPTPMST  TEST PRIME CHAR ATTRIBUTE   R41 S2264600
         BNE   MVKWC2K             IF PRIME NOT MSTR ASSUME COUNT=1 R41 S2264800
         CLI   0(RSINK),SCBPRIME+2 TEST REMAINING COUNT = 1, 2 OR 3 R41 S2265000
MVKWC2Q  BL    MVKWC3E             BRANCH IF REMAINING COUNT WAS 1  R41 S2265200
MVKWC0QA IC    RLCHAR,MVKQXMM(RCPA)  STORE 4-BIT                    R41 S2265400
MVKWC2QB STC   RLCHAR,0(,RSINK)       MASTER PAIR                   R41 S2265600
         BE    MVKWC2S             TRY FOR NEXT SCB IF COUNT WAS 2, R41CS2265800
                                    ELSE SHIFT TO ODD COMPACT STATE R41 S2266000
MVKWC1R  BXH   RSINK,RBY1,MVKWC11Z ENTER ODD COMPACT STATE IF DONE  R41 S2266200
         TM    0(RSINK),SCBDUPLC   TEST SCB TYPE                    R41 S2266400
         BZ    MVKWC1C             BRANCH IF NONCOMP/NONDUP SCB     R41 S2266600
         IC    RLCHAR,MVKQXMF(RCPA)  GET ODD MASTER IN LEFT NIBBLE  R41 S2266800
         BO    MVKWC1N             BRANCH IF NON-PRIME DUP SCB      R41 S2267000
         IC    RCPA,CPTCTT+SCSBLANK  FORM PAIR FROM ODD             R41 S2267200
         NR    RLCHAR,RCPA            MASTER & PRIME CHAR           R41 S2267400
         CLI   0(RSINK),SCBPRIME+1 SET C.C. FOR COUNT = 1 OR 2      R41 S2267600
         STC   RLCHAR,0(,RSINK)    STORE MASTER PAIR                R41 S2267800
         BH    MVKWC1R             IF ODD MSTR LEFT OVER, HANDLE IT R41 S2268000
MVKWC2S  BXH   RSINK,RBY1,MVKWC10M ENTER EVEN COMPACT STATE IF DONE R41 S2268200
MVKWC2T  TM    0(RSINK),SCBDUPLC   TEST SCB TYPE (CANNOT BE NONDUP) R41 S2268400
MVKWC2U  BNO   MVKWC2P             BRANCH IF PRIME DUP SCB          R41 S2268600
MVKWC2V  IC    RCPA,1(,RSINK)      TRANSLATE NON-PRIME DUP          R41 S2268800
         IC    RCPA,CPTCTT(RCPA)    TO 8-BIT COMPACT EQUIVALENT     R41 S2269000
         CLI   0(RSINK),SCBDUPLC+2 TEST SCB COUNT (2, 3, 4, OR 5)   R41 S2269200
         BE    MVKWC2J             IF 2, HANDLE DOUBLE NON-MASTER   R41 S2269400
         CLI   0(RSINK),SCBDUPLC+4 SET COND CODE FOR COUNT 3 4 OR 5 R41 S2269600
MVKWC2W  IC    RLCHAR,MVKQXMM(RCPA)  STORE 4-BIT MASTER             R41 S2269800
         STC   RLCHAR,0(,RSINK)       PAIR OVER SCB LOC             R41 S2270000
         LA    RSINK,1(,RSINK)     ADVANCE POINTER OVER DUP CHAR    R41 S2270200
         BNL   MVKWC2QB            IF 2 OR 3 LEFT GO STORE 2ND PAIR R41 S2270400
         CLR   RSINK,REND          TEST IF STORED STRING EXHAUSTED  R41 S2270600
         BL    MVKWC3F             GO FETCH NEXT SCB IF MORE TO DO  R41 S2270800
MVKWC11Z LR    REND,RSCBL          USE END OF SCB TO LIMIT LOOP     R41 S2271000
         SLR   RCPZ,RCPZ           CLEAR WORK REG FOR COMPACTION    R41 S2271200
         LA    RPLAN,MVKQCA11      ENTER ODD-MASTER                 R41 S2271400
         BR    RPLAN                COMPACTION STATE                R41 S2271600
         SPACE 3                                                    R41 S2271800
MVKWCATR TR    1(*-*,RSINK),CPTCTT XLATE TO 8-BIT COMPACT *EXECUTE* R41 S2272000
         EJECT                                                      R41 S2272200
*                                                                   R41 S2272400
*           COMPACTION PLANNER - NONCOMPRESS SCB STATE  (SUSPEND)   R41 S2272600
*                                                                   R41 S2272800
         SPACE 1                                                    R41 S2273000
MVKQNCS  LR    RCPA,RCHAR          RESTORE COMPACTION RACING STATE  R41 S2273200
         NOPR  0               -4  FEEDER-END ROUTINE DOESN'T EXIST,R41CS2273400
                                    PLANNER-END ROUTINE IS NO-OP    R41 S2273600
         BALR  RPLAN,RFEED         CHGE TO NON-COMPRESS SUSPD STATE R41CS2273800
                                    & RETURN FROM PLANNER END RTNE  R41 S2274000
         SPACE 1                                                    R41 S2274200
         L     RSCBL,SCWSCBL       RETRIEVE OLD SCB UNUSED CAPACITY R41 S2274400
         SPACE 1                                                    R41 S2274600
MVKQNCSA IC    RGO,0(,RCHAR)       PICK UP ATTRIBUTE OF EMITTED     R41 S2274800
         IC    RGO,CPTCAT(RGO)      CHARACTER FROM COMPACTION TABLE R41 S2275000
         L     RGO,MVKQNCST(RGO)   USE AS INDEX INTO ADDRESS TABLE  R41 S2275200
         SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1  R41 S2275400
         BR    RGO                 BRANCH WITH CONDITION CODE SET   R41 S2275600
         SPACE 2                                                    R41 S2275800
MVKQNCST DS    0F           *SUSP* NON-COMP STATE ATTRIBUTE HANDLERSR41 S2276000
         DC    A(MVKQNSX)          NONPRIME NOT IN COMPACTION TABLE R41 S2276200
         DC    A(MVKQNTX)          PRIME    NOT IN COMPACTION TABLE R41 S2276400
         DC    A(MVKQNSN)          NONPRIME COMPACTIBLE NON-MASTER  R41 S2276600
         DC    A(MVKQNTN)          PRIME    COMPACTIBLE NON-MASTER  R41 S2276800
         DC    A(MVKQNSM)          NONPRIME MASTER                  R41 S2277000
         DC    A(MVKQNTM)          PRIME    MASTER                  R41 S2277200
         SPACE 6                                                    R41 S2277400
MVKQNSXX BXH   RSINK,RBY1,MVKZOFLO SEND & RE-ENTER IF NO SPACE LEFT R41 S2277600
         L     RSCBL,SCWSCBL       RETRIEVE OLD SCB UNUSED CAPACITY R41 S2277800
         SPACE 1                                                    R41 S2278000
MVKQNSX  BC    SLSP,MVKQNSXD       BRANCH IF MORE THAN SINGLE .X.   R41 S2278200
MVKQNSXA SLR   RCPA,RCPA           SHOW COMPACTION NOT COMPETING    R41 S2278400
MVKQNSXB L     RSINK,SCWSCBA       RETRIEVE SUSPENDED SCB ADDRESS   R41 S2278600
MVKQNSXC ST    RCHAR,SCWSRCEB      SAVE STRING START ADDR FOR MOVER R41 S2278800
         LA    RPLAN,MVKQNC        CHANGE TO NORMAL NONCOMP STATE   R41 S2279000
         BCT   RSCBL,MVKEMITR      ADV SCB COUNT & GET NXT EMISSION R41 S2279200
         LCR   RNUM,RBY1           IF SCB FULL, KILL DUP FACTOR TO  R41 S2279400
         B     MVKWNC               SHOW EMISSION HANDLED & END SCB R41 S2279600
         SPACE 3                                                    R41 S2279800
MVKQNSXD LA    RPLAN,MVKQEY        ANTICIPATE CHANGE TO EMPTY STATE R41 S2280000
         CLR   RNUM,RBY1           IF 3 OR MORE OCCURRENCES         R41 S2280200
         BH    MVKWDU0              DON'T REVIVE SCB--GEN DUP       R41 S2280400
         CLR   RNUM,RSCBL          IF EMISSION WON'T FIT            R41 S2280600
         BNL   MVKWDU0              DON'T REVIVE SCB--GEN DUP       R41 S2280800
         BCTR  RCHAR,0             BACK UP TO 1ST OF PAIR OF CHARS  R41 S2281000
         BCT   RSCBL,MVKQNSXA      DECREASE REMAINING SPACE IN SCB  R41CS2281200
               (ALWAYS BRANCHES)    BY 1 & TREAT AS IF SINGLE CHAR. R41 S2281400
         EJECT                                                      R41 S2281600
MVKQNTXX BXH   RSINK,RBY1,MVKZOFLO SEND & RE-ENTER IF NO SPACE LEFT R41 S2281800
         L     RSCBL,SCWSCBL       RETRIEVE OLD SCB UNUSED CAPACITY R41 S2282000
MVKQNTX  BC    SLSZ,MVKQNSXA       REVIVE SCB IF ONLY 1 OCCURRENCE  R41 S2282200
MVKQNTXA LA    RPLAN,MVKQEY        ELSE CHANGE TO EMPTY STATE       R41 S2282400
         B     MVKWPR0             DON'T REVIVE SCB, GEN PRIME      R41 S2282600
         SPACE 3                                                    R41 S2282800
MVKQNSN  BC    SLSZ,MVKQNTNA       BRANCH IF HANDLING SINGLE .N.    R41 S2283000
         LA    RPLAN,MVKQEY        ANTICIPATE CHANGE TO EMPTY STATE R41 S2283200
         CLR   RNUM,RBY1           IF 3 OR MORE OCCURRENCES         R41 S2283400
         BH    MVKWDU0              DON'T REVIVE SCB--GEN DUP       R41 S2283600
         OR    RCPA,RBY1           FORCE NO-RACE STATE, EXCEPT      R41 S2283800
         SLR   RCPA,RBY1            SET STANDOFF STATE FOR CASES    R41CS2284000
                                     STANDOFF/.NN. OR AHEAD/.NN.    R41 S2284200
         LA    RPLAN,MVKVDU        ANTICIPATE NO FIT, EXIT FOR DUP  R41 S2284400
         CLR   RNUM,RSCBL          IF EMISSION WON'T FIT            R41 S2284600
         BNL   MVKWNCQ              REPROCESS IN EMPTY STATE        R41 S2284800
         BCTR  RCHAR,0             BACK UP TO 1ST OF PAIR OF CHARS  R41 S2285000
         BCT   RSCBL,MVKQNSXB      DECREASE REMAINING SPACE IN SCB  R41CS2285200
               (ALWAYS BRANCHES)    BY 1 & TREAT AS IF SINGLE CHAR. R41 S2285400
         SPACE 3                                                    R41 S2285600
MVKQNTN  BC    SLSP,MVKQNTXA       GEN PRIME SCB FOR MULTIPLE .P.   R41 S2285800
MVKQNTNA OR    RCPA,RBY1           FORCE NO-RACE STATE, EXCEPT      R41 S2286000
         SLR   RCPA,RBY1            SET STANDOFF STATE FOR CASES    R41 S2286200
         B     MVKQNSXB              STANDOFF/.N. OR AHEAD/.N.      R41 S2286400
         SPACE 3                                                    R41 S2286600
MVKQNTM  BC    SLSP,MVKWNCP        DON'T REVIVE SCB IF MULTIPLE .P. R41 S2286800
MVKQNTMA ST    RCHAR,SCWSRCEB      SAVE STRING START ADDR FOR MOVER R41 S2287000
         L     RSINK,SCWSCBA       RETRIEVE SUSPENDED SCB ADDRESS   R41 S2287200
         LA    RPLAN,MVKQNC        REVERT TO NORMAL NONCOMPACT STATER41 S2287400
         B     MVKQNOMA            GO HANDLE UNDER REVIVED NC SCB   R41 S2287600
         EJECT                                                      R41 S2287800
*********************************************************************** S2288000
*                                                                     * S2288200
*                 COMPACTION MOVERS - COMPACT SCB                     * S2288400
*                                                                     * S2288600
*   MAJOR ENTRY POINTS -                                              * S2288800
*      MVKWCT    NORMAL SCB TERMINATION ROUTINE.  STORES SCB.         * S2289000
*      MVKWCTAL  ENTRY POINTS TO NORMAL TERMINATION ROUTINE           * S2289200
*         & -ZL  USED WHEN SCB ENDED BY PRIME/DUPLICATE SCB.          * S2289400
*      MVKWCTI   SCB INTERRUPT ROUTINE FOR 'EVEN' COMPACT             * S2289600
*                STATE (NO UNPAIRED MASTER).  STORES SCB LIKE         * S2289800
*                TERMINATION ROUTINE, BUT ALSO PRESERVES REG          * S2290000
*                CONTENTS NEEDED TO ADD DATA TO THE SAME SCB          * S2290200
*                FROM NEXT SOURCE STRING.  GETS CONTROL VIA           * S2290400
*                FEEDER-END BRANCH, RETURNS ON REG 'RFEED'.           * S2290600
*      MVKWCTIZ  SCB INTERRUPT ROUTINE FOR 'ODD' COMPACT              * S2290800
*                STATE (UNPAIRED 'ODD' MASTER PRESENT).  LIKE         * S2291000
*                'MVKWCTI' EXCEPT THAT ODD MASTER IS STORED           * S2291200
*                IN 8-BIT FORM AND INCLUDED IN THE SCB COUNT.         * S2291400
*      MVKWCX    SCB TERMINATION AND INTERRUPT ROUTINE FOR            * S2291600
*                'ODD' COMPACT STATE IN 16-MASTER MODE.  LIKE         * S2291800
*                'MVKWCTIZ' EXCEPT THAT ODD MASTER IS USED TO         * S2292000
*                BEGIN A NONCOMP SCB & IS NOT INCLUDED IN THE         * S2292200
*                SCB COUNT.  WHEN NONCOMP SCB CAN'T BE BEGUN          * S2292400
*                BECAUSE ONLY 1 BYTE REMAINS IN R.U., THE ODD         * S2292600
*                MASTER IS SAVED (FOR REPROCESSING IN NEXT            * S2292800
*                R.U.) AND THE 'SCWODDMF' FLAG IS SET.                * S2293000
*                                                                     * S2293200
*********************************************************************** S2293400
         SPACE 2                                                    R41 S2293600
MVKWCTI  ST    REND,SCWSCBCE       SAVE LONGEST ALLOWED SCB END LOC R41 S2293800
         SPACE 1                                                    R41 S2294000
MVKWCTAL SLR   RSINK,RBY1          BACK UP TO END OF SCB STRING     R41 S2294200
MVKWCTZL LA    RPLAN,MVKPEYV       OTHER MOVE ROUTINE ENTERS HERE   R41CS2294400
                                    TO TERMINATE COMPACT SCB.  RNUM R41CS2294600
                                     (DUP FACTOR - 1) IS 0 OR PLUS. R41 S2294800
         SPACE 1                                                    R41 S2295000
MVKWCT   SLR   RCPA,RCPA           SHOW COMPACTION NOT COMPETING    R41 S2295200
MVKWCT01 L     REND,SCWSCBCA       GET LOC OF COMPACTION SCB        R41 S2295400
         LCR   RSCBL,REND                  CALCULATE                R41 S2295600
         LA    RSCBL,SCBCPACT(RSINK,RSCBL)  SCB LENGTH              R41 S2295800
         STC   RSCBL,0(,REND)                & STORE IT             R41 S2296000
         L     REND,SCWRUEND       RESTORE END OF R.U. ADDRESS      R41 S2296200
         LTR   RNUM,RNUM           TEST IF CALL FROM OTHER MOVE RTNER41 S2296400
         BM    MVKWCTFS            BRANCH IF NOT                    R41 S2296600
         BXLE  RSINK,RBY1,MVKQEYRR GO CHGE TO EMPTY STATE & RE-ENTERR41 S2296800
         B     MVKZOFLO            IF R.U. FULL, GO SEND & RE-ENTER R41 S2297000
         SPACE 1                                                    R41 S2297200
MVKWCTFS BXH   RSINK,RBY1,MVKZFULL IF R.U. FULL GO SEND             R41 S2297400
         ALR   RNUM,RBY1           TEST TYPE OF MOVE ROUTINE CALL   R41 S2297600
         BC    ALDM,MVKQCAS        RETURN IF SUSPEND-TYPE CALL      R41 S2297800
         LA    RPLAN,MVKQEY        ELSE FULL SCB CALL--CHANGE TO    R41 S2298000
         B     MVKEMITR             EMPTY STATE & GET NEXT EMISSION R41 S2298200
         EJECT                                                      R41 S2298400
*                                                                   R41 S2298600
*           COMPACTION PLANNER - COMPACTION SCB STATE  (SUSPEND)    R41 S2298800
*                                                                   R41 S2299000
         SPACE 1                                                    R41 S2299200
         NOPR  0               -4  FEEDER-END ROUTINE DOESN'T EXIST,R41CS2299400
                                    PLANNER-END ROUTINE IS NO-OP    R41 S2299600
         SPACE 1                                                    R41 S2299800
MVKQCAS  BALR  RPLAN,RFEED         CHANGE TO COMPACT SUSPEND STATE  R41CS2300000
                                    & RETURN FROM PLANNER-END RTNE  R41 S2300200
         SPACE 1                                                    R41 S2300400
         IC    RGO,0(,RCHAR)       PICK UP 8-BIT COMPACTION         R41 S2300600
         IC    RCPA,CPTCTT(RGO)     FORM OF EMITTED CHARACTER       R41 S2300800
         IC    RGO,CPTCAT(RGO)     PICK UP ATTRIBUTE OF EMITTED CHARR41 S2301000
         LA    RPLAN,MVKQEY        ANTICIPATE CHANGE TO EMPTY STATE R41 S2301200
         L     RGO,MVKQCAST(RGO)   USE AS INDEX INTO ADDRESS TABLE  R41 S2301400
         SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1  R41 S2301600
         BR    RGO                 BRANCH WITH CONDITION CODE SET   R41 S2301800
         SPACE 2                                                    R41 S2302000
MVKQCAST DS    0F      *EVEN,SUSP* COMPACT STATE ATTRIBUTE HANDLERS R41 S2302200
         DC    A(MVKQEOX)          NONPRIME NOT IN COMPACTION TABLE R41 S2302400
         DC    A(MVKWPR0)          PRIME    NOT IN COMPACTION TABLE R41 S2302600
         DC    A(MVKQCSN)          NONPRIME COMPACTIBLE NON-MASTER  R41 S2302800
         DC    X'80',AL3(MVKQCSN)  PRIME    COMPACTIBLE NON-MASTER  R41 S2303000
         DC    A(MVKQCSM)          NONPRIME MASTER                  R41 S2303200
         DC    A(MVKQCTM)          PRIME    MASTER                  R41 S2303400
         SPACE 6                                                    R41 S2303600
*                                                                   R41 S2303800
*           COMPACTION MOVER - COMPACT SCB (SUSPEND IN ODD STATE)   R41 S2304000
*                                                                   R41 S2304200
         SPACE 1                                                    R41 S2304400
MVKWCTIZ CLI   CPTNMAST,16         TEST FOR 16 MASTERS SPECIAL CASE R41 S2304600
         BNL   MVKWCX              BRANCH IF PRESENT                R41 S2304800
         STC   RCPA,0(,RSINK)      STORE ODD MASTER IN 8-BIT FORM   R41 S2305000
         L     REND,SCWSCBCA       GET LOC OF COMPACTION SCB        R41 S2305200
         LCR   RSCBL,REND                  CALCULATE                R41 S2305400
         LA    RSCBL,SCBCPACT(RSINK,RSCBL)  SCB LENGTH              R41 S2305600
         STC   RSCBL,0(,REND)                & STORE IT             R41 S2305800
         BXH   RSINK,RBY1,MVKZFULL IF R.U. FULL GO SEND        @OZ43017 S2306000
         EJECT                                                      R41 S2306200
*                                                                   R41 S2306400
*           COMPACTION PLANNER - COMPACT SCB STATE  (ODD SUSPEND)   R41 S2306600
*                                                                   R41 S2306800
         SPACE 1                                                    R41 S2307000
         NOPR  0               -4  FEEDER-END ROUTINE DOESN'T EXIST,R41CS2307200
                                    PLANNER-END ROUTINE IS NO-OP    R41 S2307400
MVKQCASZ BALR  RPLAN,RFEED         CHNGE TO ODD COMPACT SUSPD STATE R41CS2307600
                                    & RETURN FROM PLANNER-END RTNE  R41 S2307800
         SLR   RCPZ,RCPZ           CLEAR COMPACTION WORK REG        R41 S2308000
         IC    RGO,0(,RCHAR)       PICK UP 8-BIT COMPACTION         R41 S2308200
         IC    RCPZ,CPTCTT          FORM OF EMITTED CHARACTER       R41 S2308400
         IC    RGO,CPTCAT(RGO)     PICK UP ATTRIBUTE OF EMITTED CHARR41 S2308600
         LA    RPLAN,MVKQEY        ANTICIPATE CHANGE TO EMPTY STATE R41 S2308800
         L     RGO,MVKQCASU(RGO)   USE AS INDEX INTO ADDRESS TABLE  R41 S2309000
         SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1  R41 S2309200
         BCTR  RSINK,RGO           BACK UP TO 8-BIT ODD MASTER LOC  R41CS2309400
               (ALWAYS BRANCHES)    & BRANCH WITH CONDITION CODE SETR41 S2309600
         SPACE 2                                                    R41 S2309800
MVKQCASU DS    0F       *ODD,SUSP* COMPACT STATE ATTRIBUTE HANDLERS R41 S2310000
         DC    A(MVKQEOXZ)         NONPRIME NOT IN COMPACTION TABLE R41 S2310200
         DC    A(MVKQEPXZ)         PRIME    NOT IN COMPACTION TABLE R41 S2310400
         DC    A(MVKQCSNZ)         NONPRIME COMPACTIBLE NON-MASTER  R41 S2310600
         DC    X'80',AL3(MVKQCSNZ) PRIME    COMPACTIBLE NON-MASTER  R41 S2310800
         DC    A(MVKQCSMZ)         NONPRIME MASTER                  R41 S2311000
         DC    A(MVKQCTMZ)         PRIME    MASTER                  R41 S2311200
         SPACE 2                                                    R41 S2311400
MVKQCSNZ BXH   RSINK,RBY1,MVKZOFLO SEND & RE-ENTER IF NO SPACE LEFT R41 S2311600
         LR    RCPA,RCPZ           CHANGE WORK REGS FOR COMMON RTNE R41 S2311800
MVKQCSN  BC    SLSP,MVKQCSNA       ABANDON SCB FOR DUP IF MULTIPLE  R41 S2312000
         L     REND,SCWSCBCE       RESTORE COMPACT SCB ENDING LOC   R41 S2312200
         LA    RPLAN,MVKQCA10      RESUME EVEN COMPACT STATE        R41 S2312400
         B     MVKQCPMB            GO STORE SINGLE .N. & RESUME SCB R41 S2312600
         SPACE 1                                                    R41 S2312800
MVKQCSNA LTR   RGO,RGO             TEST ATTRIBUTE HANDLER ADDRESS   R41 S2313000
         BM    MVKWPR0             JUST GEN DUP IF FLAGGED FOR PRIMER41 S2313200
         CLR   RNUM,RBY1           IF 3 OR MORE OCCURRENCES         R41 S2313400
         BH    MVKWDU0              ABANDON COMPACT SCB FOR DUP     R41 S2313600
         L     REND,SCWSCBCE       RESTORE COMPACT SCB ENDING LOC   R41 S2313800
         LA    RPLAN,MVKQCA10      RESUME EVEN COMPACT STATE        R41 S2314000
         B     MVKQCONB            GO STORE DOUBLE .N. & RESUME SCB R41 S2314200
         EJECT                                                      R41 S2314400
*                   HANDLE NONCOMPACTIBLE NONPRIME CHAR             R41 S2314600
         SPACE 1                                                    R41 S2314800
MVKQCXXZ STC   RCPA,0(,RSINK)      STORE ODD MASTER IN 8-BIT FORM   R41 S2315000
         BC    SLSP,MVKQCOXZ       BRANCH IF MORE THAN 1 OCCURRENCE R41 S2315200
         CLI   CPTNMAST,16         TEST FOR 16 MASTERS SPECIAL CASE R41 S2315400
         BL    MVKQCOXA            END SCB FOR NONCOMP SCB IF NOT   R41 S2315600
         SPACE 2                                                    R41 S2315800
*                                                                   R41 S2316000
*           COMPACTION MOVER - COMPACT SCB (16-MASTER MODE)         R41 S2316200
*                                                                   R41 S2316400
         SPACE 1                                                    R41 S2316600
MVKWCX   L     REND,SCWSCBCA       GET LOC OF COMPACTION SCB        R41 S2316800
         LCR   RSCBL,REND                    CALCULATE              R41 S2317000
         LA    RSCBL,SCBCPACT-1(RSINK,RSCBL)  SCB LENGTH            R41 S2317200
         STC   RSCBL,0(,REND)                  & STORE IT           R41 S2317400
         L     REND,SCWRUEND       RESTORE END OF R.U. ADDRESS      R41 S2317600
         IC    RPLAN,CPTDTT(RCPA)  XLATE ODD MSTR BACK TO ORIGINAL  R41 S2317800
         CLR   RSINK,REND          IF ONLY 1 BYTE LEFT IN R.U.      R41 S2318000
         BNL   MVKWCXC              ODD MASTER MUST GO IN NEXT R.U. R41 S2318200
         MVI   0(RSINK),SCBNONCO+1 STORE NONCOMP SCB WITH COUNT 1   R41 S2318400
         STC   RPLAN,1(,RSINK)     STORE ODD MASTER UNTRANSLATED    R41 S2318600
         LA    RSCBL,SCBMAXCT(,RSINK)  GET END OF FULL CAPACITY SCB R41 S2318800
         CLR   RSCBL,REND          ATTEMPT TO FIT FULL CAPACITY SCB R41 S2319000
         BNH   MVKWCXA             BRANCH IF CAN FIT                R41 S2319200
         LR    RSCBL,REND          ELSE SUBSTITUTE END OF R.U.      R41 S2319400
MVKWCXA  SLR   RSCBL,RSINK         COMPUTE UNUSED SCB CAPACITY      R41 S2319600
         ST    RSCBL,SCWSCBNC      SAVE SCB STARTING CAPACITY       R41 S2319800
         BCT   RSCBL,MVKWCXB       SHOW 1 BYTE OF SCB USED & BRANCH R41 S2320000
         LA    RSINK,SCB+1(,RSINK) IF R.U. FULL, UPDATE POINTER FOR R41 S2320200
         B     MVKZOFLO             'RPLRLEN' CALCULATION & GO SEND R41 S2320400
         SPACE 3                                                    R41 S2320600
MVKWCXB  LTR   RNUM,RNUM           TEST IF CALL FROM OTHER MOVE RTNER41 S2320800
         BM    MVKWCXS             BRANCH IF NOT--MUST BE SUSPEND   R41 S2321000
         LA    RCPA,SCWCANOT       ELSE SHOW COMPACTION NOT RACING  R41 S2321200
         LA    RPLAN,MVKQNC        CHANGE TO NONCOMPACT SCB STATE   R41 S2321400
         BZ    MVKQEONE            BR IF SINGLE NONCOMPACTIBLE CHAR R41 S2321600
         LA    RPLAN,MVKQEY        ANTICIPATE CHANGING              R41 S2321800
         LA    RSINK,SCB+1(,RSINK)  BACK TO EMPTY STATE             R41 S2322000
         BR    RGO                 RETURN TO CALLER                 R41 S2322200
         EJECT                                                      R41 S2322400
MVKWCXC  LTR   RNUM,RNUM           IF EMISSION FOLLOWING ODD MASTER R41 S2322600
         BNM   MVKWCXD              ALREADY IN PLAY (CALL WAS FROM  R41CS2322800
                                     OTHER MOVE ROUTINE) GO HANDLE  R41 S2323000
         ALR   RLSRCE,RBY1         ELSE SIMULATE NORMAL R.U.        R41 S2323200
         SLR   RNUM,RNUM            OVERFLOW CONDITION WITH         R41 S2323400
         BCT   RSRCE,MVKZOFLO        EMISSION OF SINGLE MASTER      R41CS2323600
               (ALWAYS BRANCHES)   SEND & RE-ENTER FOR ODD MASTER   R41 S2323800
         SPACE 1                                                    R41 S2324000
MVKWCXD  STC   RPLAN,SCWODDM       SAVE ODD MASTER WHICH WON'T FIT  R41 S2324200
         OI    SCWFLAGS,SCWODDMF   INDICATE 2 EMISSIONS BACKED UP   R41 S2324400
         B     MVKZOFLO            SEND & RE-ENTER FOR ODD MASTER   R41 S2324600
         SPACE 3                                                    R41 S2324800
MVKWCXS  ST    RSINK,SCWSCBA       SAVE ADDRESS OF INTERRUPTED SCB  R41 S2325000
         LA    RSINK,SCB+1(,RSINK) UPDTE POINTER FOR 'RPLRLEN' CALC R41 S2325200
         ST    RSCBL,SCWSCBL       SAVE SCB UNUSED CAPACITY         R41 S2325400
         SPACE 3                                                    R41 S2325600
*                                                                   R41 S2325800
*           COMPACTION PLANNER - COMPACT SCB STATE  (ODD SUSP 16-M) R41 S2326000
*                                                                   R41 S2326200
         SPACE 1                                                    R41 S2326400
         NOPR  0               -4  FEEDER-END ROUTINE DOESN'T EXIST,R41CS2326600
                                    PLANNER-END ROUTINE IS NO-OP    R41 S2326800
         BALR  RPLAN,RFEED         CHG TO 16-MAST ODD COMPACT SUSPD R41CS2327000
                                    STATE, & EXIT FROM PLANNER-END  R41 S2327200
         SPACE 1                                                    R41 S2327400
         SLR   RCPZ,RCPZ           CLEAR COMPACTION WORK REG        R41 S2327600
         IC    RGO,0(,RCHAR)       PICK UP 8-BIT COMPACTION         R41 S2327800
         IC    RCPZ,CPTCTT          FORM OF EMITTED CHARACTER       R41 S2328000
         IC    RGO,CPTCAT(RGO)     PICK UP ATTRIBUTE OF EMITTED CHARR41 S2328200
         L     RGO,MVKQCXST(RGO)   USE AS INDEX INTO ADDRESS TABLE  R41 S2328400
         SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1  R41 S2328600
         BR    RGO                 BRANCH WITH CONDITION CODE SET   R41 S2328800
         SPACE 2                                                    R41 S2329000
MVKQCXST DS    0F   *ODD,SUSP,16M* COMPACT STATE ATTRIBUTE HANDLERS R41 S2329200
         DC    A(MVKQNSXX)         NONPRIME NOT IN COMPACTION TABLE R41 S2329400
         DC    A(MVKQNTXX)         PRIME    NOT IN COMPACTION TABLE R41 S2329600
         DC    A(0)                CAN NEVER OCCUR                  R41 S2329800
         DC    A(0)                CAN NEVER OCCUR                  R41 S2330000
         DC    A(MVKQCSMX)         NONPRIME MASTER                  R41 S2330200
         DC    A(MVKQCTMX)         PRIME    MASTER                  R41 S2330400
         EJECT                                                      R41 S2330600
*********************************************************************** S2330800
*                                                                     * S2331000
*           COMPACTION PLANNER ROUTINES - STRATEGY TABLE              * S2331200
*                                                                     * S2331400
*        COMPACTION PLANNER ROUTINES USE A FINITE-STATE MACHINE       * S2331600
*        STRATEGY TO FIND THE SHORTEST WAY TO REPRESENT SOURCE        * S2331800
*        DATA AS SCB STRINGS.  F.S.M. STATES ARE NUMBERED BY          * S2332000
*        MAJOR STATE (TYPE OF SCB CURRENTLY ACTIVE) AND RACING        * S2332200
*        STATE (MOMENTARY WASTE OR SAVINGS OF COMPACT FORM OVER       * S2332400
*        THE ALTERNATIVE) AS SHOWN IN THE FOLLOWING TABLE.            * S2332600
*                                                                     * S2332800
*              COMPACTION IS - NOT RACING   BEHIND    TIED    AHEAD   * S2333000
*        MAJOR STATE -         ----------   ------    ----    -----   * S2333200
*          EMPTY (NO SCB ACTIVE)     0        1        2        3     * S2333400
*          NONCOMPACT SCB ACTIVE     4        5        6        7     * S2333600
*          COMPACT SCB ACTIVE       N/A      N/A      10       11     * S2333800
*                                                                     * S2334000
*        EACH F.S.M. STATE IS ASSOCIATED WITH A MAJOR PLANNER         * S2334200
*        ROUTINE ADDRESS (IN REG 'RPLAN') AND A VALUE (IN BITS        * S2334400
*        1-31 OF 'RCPA') AS FOLLOWS -                                 * S2334600
*                                                                     * S2334800
*        IF FSM STATE IS     0-3       4-7       10        11         * S2335000
*        RPLAN HAS ADDR OF   MVKQEY    MVKQNC    MVKQCA10  MVKQCA11   * S2335200
*        AND RCPA CONTAINS   (A)       (A)       (B)       (C)        * S2335400
*                                                                     * S2335600
*        (A)  0  IF COMPACTION CANNOT COMPETE                         * S2335800
*             1  IF COMPACTION BEHIND BY 1/2 BYTE                     * S2336000
*             2  IF COMPACTION IN STANDOFF                            * S2336200
*             3  IF COMPACTION AHEAD  BY 1/2 BYTE                     * S2336400
*        (B)  (BITS  0-23) ZERO (BITS 24-31 = DON'T CARE)             * S2336600
*        (C)  (BITS  0-23) ZERO                                       * S2336800
*             (BITS 24-31) TRANSLATED ODD MASTER (X'F-')              * S2337000
*                                                                     * S2337200
*        INPUTS TO THE F.S.M. ARE 'EMISSIONS' (SEE EMITTER            * S2337400
*        PROLOG), DEFINED BY A POINTER (IN REG 'RCHAR') AND           * S2337600
*        A DUP FACTOR (IN REG 'RNUM').  EACH EMISSION HAS ONE         * S2337800
*        OF SIX DIFFERENT ATTRIBUTE COMBINATIONS -                    * S2338000
*                                                                     * S2338200
*        STRING    A T T R I B U T E S    CPTCAT  6TH AND 7TH CHAR    * S2338400
*        SYMBOL  MASTER  IN TABLE  PRIME  OFFSET  IN HANDLER LABEL    * S2338600
*        ------  ------  --------  -----  ------  (NORM)---(SUSPD)    * S2338800
*        .X.       NO       NO       NO     +0       OX      SX       * S2339000
*        .P(X).    NO       NO      YES     +4       PX      TX       * S2339200
*        .N.       NO      YES       NO     +8       ON      SN       * S2339400
*        .P(N).    NO      YES      YES    +12       PN      TN       * S2339600
*        .M.      YES    IMPLIED     NO    +16       OM      SM       * S2339800
*        .P(M).   YES    IMPLIED    YES    +20       PM      TM       * S2340000
*                                                                     * S2340200
*        THE COMPACTION ATTRIBUTE TABLE 'CPTCAT' CONTAINS THE         * S2340400
*        OFFSETS CORRESPONDING TO THE ATTRIBUTES OF EACH OF THE       * S2340600
*        256 EBCDIC CHARACTERS, TO FACILITATE A 6-WAY BRANCH,         * S2340800
*        AN INITIAL STEP IN ALL COMPACTION PLANNER ROUTINES.          * S2341000
*                                                                     * S2341200
*********************************************************************** S2341400
         EJECT                                                      R41 S2341600
*********************************************************************** S2341800
*                                                                     * S2342000
*           COMPACTION PLANNER - STRATEGY TABLE (CONTINUED)           * S2342200
*                                                                     * S2342400
*        PLANNER ROUTINES REACT TO THE ATTRIBUTE AND DUP FACTOR       * S2342600
*        OF EMISSIONS, SIMULATING INPUTS DRIVING AN F.S.M.            * S2342800
*        THROUGH STATE TRANSITIONS.  THE FOLLOWING TABLE SUM-         * S2343000
*        MARIZES F.S.M. STRATEGY EXCLUDING FULL-SCB OR FULL-R.U.      * S2343200
*        EXCEPTION HANDLING.  (STATES ARE SHOWN ACROSS, AND           * S2343400
*        INPUTS DOWN DUE TO SPACE LIMITATIONS.  TABLE ENTRIES         * S2343600
*        SHOW RESULTING NEW STATE.)                                   * S2343800
*                                                                     * S2344000
*                    ----------------CURRENT STATE----------------    * S2344200
*              DUP       E M P T Y         N O N C P        C P       * S2344400
*        ATTR  FACT    0   1   2   3     4   5   6   7    10  11      * S2344600
*        ==========  =============================================    * S2344800
*        .X.    1     &4   4   4   4    &4   4   4   4     4  #4      * S2345000
*               2     &0   0   0   0    &4   4   4   4     0  #0      * S2345200
*               3+    &0   0   0   0    &0   0   0   0     0  #0      * S2345400
*        ----------  ---------------------------------------------    * S2345600
*        .P(X). 1     &0   0   0   0    &4   4   4   4     0  #0      * S2345800
*               2+    &0   0   0   0    &0   0   0   0     0  #0      * S2346000
*        ----------  ---------------------------------------------    * S2346200
*        .N.    1     *6   6  10  10     4   4   6   6    10  10      * S2346400
*               2      0   0   2   2     4   4   6   6    10  10      * S2346600
*               3+     0   0   0   0     0   0   0   0     0   0      * S2346800
*        ----------  ---------------------------------------------    * S2347000
*        .P(N). 1      0   0   2   2     4   4   6   6    10  10      * S2347200
*               2+     0   0   0   0     0   0   0   0     0   0      * S2347400
*        ----------  ---------------------------------------------    * S2347600
*        .M.    1     *7  10  11  10    *5   6   7  10    11  10      * S2347800
*               2     *2   3  10  11    *6   7  10  11    10  11      * S2348000
*               3     *1   2   3  10    *1   2   3  10    11  10      * S2348200
*               4      0   1   2   3     0   1   2   3    10  11      * S2348400
*               5      0   0   1   2     0   0   1   2    *1  10      * S2348600
*               6      0   0   0   1     0   0   0   1     0  *1      * S2348800
*               7+     0   0   0   0     0   0   0   0     0   0      * S2349000
*        ----------  ---------------------------------------------    * S2349200
*        .P(M). 1     *1   2   3  10    *5   6   7  10    11  10      * S2349400
*               2      0   1   2   3     0   1   2   3    10  11      * S2349600
*               3      0   0   1   2     0   0   1   2    *1  10      * S2349800
*               4      0   0   0   1     0   0   0   1     0  *1      * S2350000
*               5+     0   0   0   0     0   0   0   0     0   0      * S2350200
*        =========================================================    * S2350400
*        &   ENTRY IS PART OF COMPRESSION-ONLY SUBSTRATEGY.           * S2350600
*        *   RACE BEGINS.  INFORMATION STORED FOR CONVERTER.          * S2350800
*        #   16-MASTER MODE REPROCESSES EMISSION IN STATE 4.          * S2351000
*                                                                     * S2351200
*********************************************************************** S2351400
         EJECT                                                      R41 S2351600
*                                                                   R41 S2351800
*           COMPACTION PLANNER - EMPTY STATE  (NO CURRENT SCB)      R41 S2352000
*                                                                   R41 S2352200
         SPACE 1                                                    R41 S2352400
         CNOP  0,8                 MAIN LOOP BRANCH TARGET ON DBLWD R41 S2352600
         B     0(,RFEED)       -8  FEEDER-END AND PLANNER-          R41 S2352800
         BR    RFEED           -4   END ROUTINES ARE NO-OPS         R41 S2353000
         SPACE 1                                                    R41 S2353200
MVKQEYRR BALR  RPLAN,RPLAN    INSTR THAT RETURNS TO CALLER OF SCB   R41CS2353400
                               MOVERS 'MVKWNC' & 'MVKWCT', CHANGING R41CS2353600
                                TO EMPTY STATE AT THE SAME TIME.    R41 S2353800
         SPACE 1                                                    R41 S2354000
MVKQEY   IC    RGO,0(,RCHAR)       PICK UP ATTRIBUTE OF EMITTED     R41 S2354200
         IC    RGO,CPTCAT(RGO)      CHARACTER FROM COMPACTION TABLE R41 S2354400
         L     RGO,MVKQEYAT(RGO)   USE AS INDEX INTO ADDRESS TABLE  R41 S2354600
         SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1  R41 S2354800
         BR    RGO                 BRANCH WITH CONDITION CODE SET   R41 S2355000
         SPACE 2                                                    R41 S2355200
MVKQEYAT DS    0F                  EMPTY STATE ATTRIBUTE HANDLERS   R41 S2355400
         DC    A(MVKQEOX)          NONPRIME NOT IN COMPACTION TABLE R41 S2355600
         DC    A(MVKWPR0)          PRIME    NOT IN COMPACTION TABLE R41 S2355800
         DC    A(MVKQEON)          NONPRIME COMPACTIBLE NON-MASTER  R41 S2356000
         DC    A(MVKQEPN)          PRIME    COMPACTIBLE NON-MASTER  R41 S2356200
         DC    A(MVKQEOM)          NONPRIME MASTER                  R41 S2356400
         DC    A(MVKQEPM)          PRIME    MASTER                  R41 S2356600
         SPACE 5                                                    R41 S2356800
MVKQEOXZ BXH   RSINK,RBY1,MVKZOFLO SEND & RE-ENTER IF NO SPACE LEFT R41 S2357000
MVKQEOX  BC    SLSP,MVKWDU0        GEN DUP SCB IF MULTIPLE .X.      R41 S2357200
         SLR   RCPA,RCPA           ELSE SHOW COMPACTION NOT RACING  R41 S2357400
         B     MVKQCOX4            GO START NONCOMP/NONDUP SCB      R41 S2357600
         SPACE 3                                                    R41 S2357800
MVKQEPXZ BXLE  RSINK,RBY1,MVKWPR0  GEN PRIME SCB IF ROOM IN R.U.    R41 S2358000
         B     MVKZOFLO            ELSE GO SEND & RE-ENTER          R41 S2358200
         EJECT                                                      R41 S2358400
MVKQEONR SLR   RSINK,RBY1          BACK UP TO END OF SCB STRING     R41 S2358600
         BAL   RPLAN,MVKWCT        GO STORE COUNT & CHK FOR RU END  R41 S2358800
         SLR   RNUM,RCPA           SET COND CODE ON # OCCURRENCES-1 R41 S2359000
         SPACE 1                                                    R41 S2359200
MVKQEON  BC    SLSP,MVKQEONG       BR IF MORE THAN SINGLE CHARACTER R41 S2359400
         CLR   RCPA,RBY1           TEST COMPACTION RACING STATUS    R41 S2359600
         BH    MVKQEONF            BRANCH IF RACING, STANDOFF/AHEAD R41 S2359800
         LA    RCPA,SCWSTAND       SHOW COMPACTION RACE IN STANDOFF R41 S2360000
         BE    MVKQCOX4            ELSE BR IF RACING, COMPACT BEHINDR41 S2360200
MVKQEONA LA    RPLAN,MVKQNC        CHANGE TO NONCOMP/NONDUP STATE   R41 S2360400
MVKQEONB ST    RSINK,SCWSCBCA      SAVE POSSIBLE COMPACT SCB LOC    R41 S2360600
         LA    RSCBL,SCBMAXCT(,RSINK)  GET END OF FULL CAPACITY SCB R41 S2360800
         CLR   RSCBL,REND          ATTEMPT TO FIT FULL CAPACITY SCB R41 S2361000
         BNH   MVKQEOND            BRANCH IF CAN FIT                R41 S2361200
         LR    RSCBL,REND          ELSE SUBSTITUTE END OF R.U.      R41 S2361400
MVKQEOND ST    RSCBL,SCWSCBCE      SAVE PLANNED COMPACT SCB END LOC R41 S2361600
MVKQEON4 SLR   RSCBL,RSINK         COMPUTE UNUSED SCB CAPACITY      R41 S2361800
         BC    SLSZ,MVKZOFLO       BRANCH IF NO ROOM FOR SCB + CHAR.R41 S2362000
         ST    RSCBL,SCWSCBNC      SAVE SCB STARTING CAPACITY       R41 S2362200
         MVI   0(RSINK),SCBNONCO+SCBEMPTY  SHOW NOTHING MOVED YET   R41 S2362400
MVKQEONE ST    RCHAR,SCWSRCEB      SAVE STRING START ADDR FOR MOVER R41 S2362600
         BCT   RSCBL,MVKEMITR      GET NEXT EMISSION                R41 S2362800
         L     RSCBL,SCWSCBNC      IF SCB ALREADY                   R41 S2363000
         STC   RSCBL,0(,RSINK)      FULL, STORE COUNT               R41 S2363200
         ALR   RSINK,RSCBL           AND MOVE IN LAST               R41 S2363400
         MVC   0(1,RSINK),0(RCHAR)    SINGLE CHARACTER              R41 S2363600
         ALR   RSINK,RBY1          UPDTE POINTER FOR 'RPLRLEN' CALC R41 S2363800
         BCT   RNUM,MVKZFULL       FORCE DUP FACTOR NEGATIVE & SEND R41CS2364000
               (ALWAYS BRANCHES)    SINCE SHORT SCB IMPLIES FULL RU R41 S2364200
         SPACE 1                                                    R41 S2364400
MVKQEONF SLR   RGO,RGO             ANTICIPATE COMPACT--CLEAR WK REG R41 S2364600
         SLR   RSINK,RBY1          COMPARE END OF STORED STRING WITHR41 S2364800
         CLR   RSINK,RSCBL          END OF HYPOTHETICAL COMPACT SCB R41 S2365000
         BL    MVKWCA              GO COMPACT IF COVERED BY 1 SCB   R41 S2365200
         LA    RCPA,SCWSTAND       SHOW COMPACTION RACE IN STANDOFF R41 S2365400
         BXLE  RSINK,RBY1,MVKQEONA ELSE RESET PTR TO ORIGINAL VALUE R41CS2365600
               (ALWAYS BRANCHES)    & HANDLE AS IF RACE JUST BEGUN  R41 S2365800
         SPACE 1                                                    R41 S2366000
MVKQEONG SRL   RCPA,0(RNUM)        FORCE NO-RACE STATE, EXCEPT      R41 S2366200
         ALR   RCPA,RCPA            SET STANDOFF STATE FOR CASES    R41CS2366400
                                     STANDOFF/.NN. OR AHEAD/.NN.    R41 S2366600
         B     MVKVDU              GO GEN DUP SCB VIA COMMON MOVER  R41 S2366800
         SPACE 3                                                    R41 S2367000
MVKQEPN  SRL   RCPA,1(RNUM)        FORCE NO-RACE STATE, EXCEPT      R41 S2367200
         ALR   RCPA,RCPA            SET STANDOFF STATE FOR CASES    R41CS2367400
                                     STANDOFF/.N. OR AHEAD/.N.      R41 S2367600
         B     MVKVPR              GO GEN PRIME SCB VIA COMMON MOVERR41 S2367800
         EJECT                                                      R41 S2368000
MVKQEOMR SLR   RCPA,RCPA           REPROC EMISSION IN NO-RACE STATE R41 S2368200
MVKQEOM  ALR   RCPA,RNUM           TEST DUP FACTOR & RACING STATE   R41 S2368400
         BC    ALSZ,MVKQEOMC       BRANCH IF 1 MASTER & NOT RACING  R41 S2368600
         SLR   RCPA,RNUM           TEST OLD RACING STATUS           R41 S2368800
         LA    RCPA,SCWNPCOS+1(,RCPA)  GET NEW RACING STATE, STEP 1 R41 S2369000
         BC    SLSP,MVKQEOMB       BRANCH IF RACING ALREADY BEGUN   R41 S2369200
         ST    RSINK,SCWSCBCA      ELSE SAVE PLANNED COMPACT SCB LOCR41 S2369400
         LA    RSCBL,SCBMAXCT(,RSINK)  GET END OF FULL CAPACITY SCB R41 S2369600
         CLR   RSCBL,REND          ATTEMPT TO FIT FULL CAPACITY SCB R41 S2369800
         BNH   MVKQEOMA            BRANCH IF CAN FIT                R41 S2370000
         LR    RSCBL,REND          ELSE SUBSTITUTE END OF R.U.      R41 S2370200
MVKQEOMA ST    RSCBL,SCWSCBCE      SAVE PLANNED COMPACT SCB END LOC R41 S2370400
MVKQEOMB SLR   RCPA,RNUM           COMPUTE NEW RACING STATE, STEP 2 R41 S2370600
         BC    NOT-SLSP,MVKWDU0    BRANCH IF UNAMBIGUOUS DUP CASE   R41 S2370800
         CL    RCPA,MVKQXVA        TEST RACING STATE VALIDITY       R41 S2371000
         BL    MVKVDU              GEN DUP & KEEP RACING IF VALID   R41 S2371200
         SLR   RGO,RGO             ANTICIPATE COMPACT--CLEAR WK REG R41 S2371400
         SLR   RSINK,RBY1          COMPARE END OF STORED STRING WITHR41 S2371600
         CLR   RSINK,RSCBL          END OF HYPOTHETICAL COMPACT SCB R41 S2371800
         BL    MVKWCA              GO COMPACT IF COVERED BY 1 SCB   R41 S2372000
         BXLE  RSINK,RBY1,MVKQEOMR ELSE RESET POINTER TO PROPER     R41CS2372200
               (ALWAYS BRANCHES)    VALUE & REDO IN NO-RACE STATE   R41 S2372400
         SPACE 1                                                    R41 S2372600
MVKQEOMC LA    RCPA,SCWAHEAD       SHOW COMPACTION AHEAD BY 1 MASTERR41 S2372800
         LA    RPLAN,MVKQNC        CHANGE TO NONCOMPACT SCB STATE   R41 S2373000
         B     MVKQEONB            GO START NONCOMP/NONDUP SCB      R41 S2373200
         SPACE 3                                                    R41 S2373400
MVKQEPMR SLR   RCPA,RCPA           REPROC EMISSION IN NO-RACE STATE R41 S2373600
MVKQEPM  ALR   RCPA,RBY1           COMPUTE NEW RACING STATE, STEP 1 R41 S2373800
         CLR   RCPA,RBY1           TEST OLD RACING STATUS           R41 S2374000
         BNE   MVKQEPMC            BRANCH IF RACING ALREADY BEGUN   R41 S2374200
MVKQEPMA ST    RSINK,SCWSCBCA      ELSE SAVE PLANNED COMPACT SCB LOCR41 S2374400
         LA    RSCBL,SCBMAXCT(,RSINK)  GET END OF FULL CAPACITY SCB R41 S2374600
         CLR   RSCBL,REND          ATTEMPT TO FIT FULL CAPACITY SCB R41 S2374800
         BNH   MVKQEPMB            BRANCH IF CAN FIT                R41 S2375000
         LR    RSCBL,REND          ELSE SUBSTITUTE END OF R.U.      R41 S2375200
MVKQEPMB ST    RSCBL,SCWSCBCE      SAVE PLANNED COMPACT SCB END LOC R41 S2375400
MVKQEPMC SLR   RCPA,RNUM           COMPUTE NEW RACING STATE, STEP 2 R41 S2375600
         BC    NOT-SLSP,MVKWPR0    BRANCH IF UNAMBIGUOUS DUP CASE   R41 S2375800
         CL    RCPA,MVKQXVA        TEST RACING STATE VALIDITY       R41 S2376000
         BL    MVKVPR              GEN DUP & KEEP RACING IF VALID   R41 S2376200
         SLR   RGO,RGO             ANTICIPATE COMPACT--CLEAR WK REG R41 S2376400
         SLR   RSINK,RBY1          COMPARE END OF STORED STRING WITHR41 S2376600
         CLR   RSINK,RSCBL          END OF HYPOTHETICAL COMPACT SCB R41 S2376800
         BNH   MVKWCA              GO COMPACT IF COVERED BY 1 SCB   R41 S2377000
         BXLE  RSINK,RBY1,MVKQEPMR ELSE RESET POINTER TO PROPER     R41CS2377200
               (ALWAYS BRANCHES)    VALUE & REDO IN NO-RACE STATE   R41 S2377400
         EJECT                                                      R41 S2377600
*                                                                   R41 S2377800
*           COMPACTION PLANNER - NONCOMPRESS SCB STATE (NORMAL)     R41 S2378000
*                                                                   R41 S2378200
         SPACE 1                                                    R41 S2378400
         CNOP  0,8                 MAIN LOOP BRANCH TARGET ON DBLWD R41 S2378600
         B     MVKWNCI         -8  BRANCH TO  FEEDER-END ROUTINE.   R41 S2378800
         B     MVKWNCI         -4  BRANCH TO PLANNER-END ROUTINE.   R41 S2379000
         SPACE 1                                                    R41 S2379200
MVKQNC   IC    RGO,0(,RCHAR)       PICK UP ATTRIBUTE OF EMITTED     R41 S2379400
         IC    RGO,CPTCAT(RGO)      CHARACTER FROM COMPACTION TABLE R41 S2379600
         L     RGO,MVKQNCAT(RGO)   USE AS INDEX INTO ADDRESS TABLE  R41 S2379800
         SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1  R41 S2380000
         BR    RGO                 BRANCH WITH CONDITION CODE SET   R41 S2380200
         SPACE 2                                                    R41 S2380400
MVKQNCAT DS    0F                  NON-COMP STATE ATTRIBUTE HANDLERSR41 S2380600
         DC    A(MVKQNOX)          NONPRIME NOT IN COMPACTION TABLE R41 S2380800
         DC    A(MVKQNPX)          PRIME    NOT IN COMPACTION TABLE R41 S2381000
         DC    A(MVKQNON)          NONPRIME COMPACTIBLE NON-MASTER  R41 S2381200
         DC    A(MVKQNPN)          PRIME    COMPACTIBLE NON-MASTER  R41 S2381400
         DC    A(MVKQNOM)          NONPRIME MASTER                  R41 S2381600
         DC    A(MVKQNPM)          PRIME    MASTER                  R41 S2381800
         SPACE 5                                                    R41 S2382000
MVKQNOX  BC    SLSP,MVKQNOXC       BRANCH IF MORE THAN SINGLE .X.   R41 S2382200
MVKQNOXA SLR   RCPA,RCPA           SHOW COMPACTION NOT COMPETING    R41 S2382400
MVKQNOXB BCT   RSCBL,MVKEMITR      LOOP BACK FOR NEXT EMISSION      R41 S2382600
         BCT   RNUM,MVKWNC         IF SCB FULL, KILL DUP FACTOR TO  R41CS2382800
               (ALWAYS BRANCHES)    SHOW EMISSION HANDLED & END SCB R41 S2383000
MVKQNOXC CLR   RNUM,RBY1           IF 3 OR MORE OCCURRENCES         R41 S2383200
         BH    MVKWNCAX             GO END SCB FOR DUPLICATE        R41 S2383400
         CLR   RNUM,RSCBL          IF 2 CHARACTERS WON'T FIT        R41 S2383600
         BNL   MVKWNCAX             GO END SCB FOR DUPLICATE        R41 S2383800
         SLR   RNUM,RBY1           DECREASE DUP FACTOR BY 1         R41 S2384000
         BCT   RSCBL,MVKQNOXA      DECREASE SPACE LEFT IN SCB BY 1  R41CS2384200
               (ALWAYS BRANCHES)    & GO HANDLE AS IF SINGLE CHAR   R41 S2384400
         SPACE 3                                                    R41 S2384600
MVKQNPX  BC    SLSZ,MVKQNOXA       BRANCH IF SINGLE CHARACTER       R41 S2384800
         B     MVKWNCAX            ELSE GO END SCB FOR PRIME DUP    R41 S2385000
         EJECT                                                      R41 S2385200
MVKQNON  BC    SLSP,MVKQNONC       BRANCH IF MORE THAN SINGLE .N.   R41 S2385400
MVKQNONA OR    RCPA,RBY1           CHANGE NO- OR BEHIND TO NO-RACE  R41 S2385600
         SLR   RCPA,RBY1            STATE, & EVEN OR AHEAD, TO EVEN R41 S2385800
MVKQNONB BCT   RSCBL,MVKEMITR      LOOP BACK FOR NEXT EMISSION      R41 S2386000
         BCT   RNUM,MVKWNC         IF SCB FULL, KILL DUP FACTOR TO  R41CS2386200
               (ALWAYS BRANCHES)    SHOW EMISSION HANDLED & END SCB R41 S2386400
MVKQNONC CLR   RNUM,RBY1           IF 3 OR MORE OCCURRENCES         R41 S2386600
         BH    MVKWNCAX             GO END SCB FOR DUPLICATE        R41 S2386800
         OR    RCPA,RBY1           CHANGE NO- OR BEHIND TO NO-RACE  R41 S2387000
         SLR   RCPA,RBY1            STATE, & EVEN OR AHEAD, TO EVEN R41 S2387200
MVKQNOND CLR   RNUM,RSCBL          IF 2 CHARACTERS WON'T FIT        R41 S2387400
         BNL   MVKWNCAL             GO END SCB FOR DUPLICATE        R41 S2387600
         SLR   RNUM,RBY1           DECREASE DUP FACTOR BY 1         R41 S2387800
         BCT   RSCBL,MVKQNONB      DECREASE SPACE LEFT IN SCB BY 1  R41CS2388000
               (ALWAYS BRANCHES)    & GO HANDLE AS IF SINGLE CHAR   R41 S2388200
         SPACE 3                                                    R41 S2388400
MVKQNPN  BC    SLSZ,MVKQNONA       BRANCH IF HANDLING SINGLE PRIME  R41 S2388600
         B     MVKWNCAX            ELSE GO END SCB FOR PRIME DUP    R41 S2388800
         SPACE 3                                                    R41 S2389000
MVKQNOM  BC    SLSP,MVKQNOMF       BRANCH IF MORE THAN 1 MASTER     R41 S2389200
MVKQNOMA IC    RNUM,MVKQNOMB(RCPA) SET UP BRANCH ON RACE=0, 1, 2, 3 R41 S2389400
         AR    RCPA,RBY1           IMPROVE RACE STATE BY 1          R41 S2389600
         B     MVKQN(RNUM)         TAKE 4-WAY BRANCH ON RACE STATE  R41 S2389800
         SPACE 1                                                    R41 S2390000
MVKQNOMB DS    0C                  NONCOMP/.M. RACE STATE HANDLERS  R41 S2390200
         DC    AL1(MVKQNOMD-MVKQN) IF NOT RACING, BEGIN RACING NOW  R41 S2390400
         DC    AL1(MVKQNOME-MVKQN) IF BEHIND, CONTINUE IN STANDOFF  R41 S2390600
         DC    AL1(MVKQNOME-MVKQN) IF BEHIND, CONTINUE IN STANDOFF  R41 S2390800
         DC    AL1(MVKQNOMC-MVKQN) IF AHEAD, GO COMPACT IF WILL FIT R41 S2391000
         SPACE 1                                                    R41 S2391200
MVKQN    DS    0H                  ORIGIN FOR BRANCH TABLE OFFSETS  R41 S2391400
         SPACE 1                                                    R41 S2391600
MVKQNOMC BM    MVKWNC              COMPACT IF RACE BEGAN IN THIS SCBR41 S2391800
         L     RLCHAR,SCWSCBNC     COMPUTE WHERE CURRENT            R41 S2392000
         SLR   RLCHAR,RSCBL         NONCOMPACT SCB WOULD END        R41 S2392200
         LA    RPLAN,0(RLCHAR,RSINK) IF IT WERE TERMINATED NOW      R41 S2392400
         CL    RPLAN,SCWSCBCE      TEST IF PLANNED COMPACT SCB      R41CS2392600
                                    WILL COVER THE NONCOMPACT SCB   R41 S2392800
         BNH   MVKWNC6             GO COMPACT IF IT WILL            R41 S2393000
         LA    RPLAN,MVKQNC        ELSE RELOAD NONCOMPACT STATE     R41 S2393200
         SPACE 1                                                    R41 S2393400
MVKQNOMD L     RCPA,MVKQXIBH       RACE STATE = BEHIND + FLAG SHOW- R41CS2393600
                                    ING RACE BEGAN INSIDE CURR SCB  R41 S2393800
         ST    RSINK,SCWSCBNA      SAVE SCB ADDR  FOR LATER CALC    R41 S2394000
         ST    RSCBL,SCWSCBNS      SAVE SCB SPACE FOR LATER CALC    R41 S2394200
MVKQNOME BCT   RSCBL,MVKEMITR      LOOP BACK FOR NEXT EMISSION      R41 S2394400
         LCR   RNUM,RBY1           IF R.U. FULL, KILL DUP FACTOR TO R41 S2394600
         B     MVKWNC              SHOW EMISSION HANDLED & END SCB  R41 S2394800
         EJECT                                                      R41 S2395000
MVKQNSM  BC    SLSZ,MVKQNTMA       GO REVIVE SCB IF SINGLE MASTER   R41 S2395200
         SLR   RCHAR,RNUM          ELSE BACK UP TO 1ST OCCURRENCE   R41 S2395400
         ST    RCHAR,SCWSRCEB      SAVE STRING START ADDR FOR MOVER R41 S2395600
         L     RSINK,SCWSCBA       RETRIEVE SUSPENDED SCB ADDRESS   R41 S2395800
         LA    RPLAN,MVKQNC        REVERT TO NORMAL NONCOMPACT STATER41 S2396000
         SPACE 1                                                    R41 S2396200
MVKQNOMF SLR   RGO,RGO             CLEAR REG FOR MULTI-WAY BRANCH   R41 S2396400
         CLR   RNUM,RBY1           TEST # OF OCCURRENCES LESS 1     R41 S2396600
         IC    RGO,MVKQNOMH(RCPA)  TAKE 4-WAY BRANCH ON RACE STATE  R41 S2396800
         BE    MVKQN(RGO)           IF EXACTLY 2 OCCURRENCES        R41 S2397000
MVKQNOMG LA    RPLAN,MVKQEOM       ELSE CAUSE REPROCESSING IN EMPTY R41 S2397200
         B     MVKWNC               STATE (RACE AS IS), & END SCB   R41 S2397400
         SPACE 1                                                    R41 S2397600
MVKQNOMH DS    0C                  NONCOMP/.MM. RACE STATE HANDLERS R41 S2397800
         DC    AL1(MVKQNOMI-MVKQN) IF NOT RACING, BEGIN RACING NOW  R41 S2398000
         DC    AL1(MVKQNOMK-MVKQN) IF BEHIND, CONTINUE AHEAD        R41 S2398200
         DC    AL1(MVKQNOML-MVKQN) IF STANDOFF OR AHEAD & 2 MASTERS R41 S2398400
         DC    AL1(MVKQNOML-MVKQN)  FIT IN PLANNED SCB, GO COMPACT  R41 S2398600
         SPACE 1                                                    R41 S2398800
MVKQNOMI CLR   RNUM,RSCBL          NOT RACING--IF 2 CHARS WON'T FIT R41 S2399000
         BNL   MVKQNOMG             GO REPROCESS IN EMPTY STATE     R41 S2399200
MVKQNOMJ L     RCPA,MVKQXIST       2 MASTERS START NEW RACE (TIED)  R41 S2399400
         ST    RSINK,SCWSCBNA      SAVE SCB ADDR  FOR LATER CALC    R41 S2399600
         ST    RSCBL,SCWSCBNS      SAVE SCB SPACE FOR LATER CALC    R41 S2399800
         BCT   RSCBL,MVKQNOME      DECREASE SPACE LEFT IN SCB BY 1  R41CS2400000
               (ALWAYS BRANCHES)    & GO CHECK REMAINING SCB SPACE  R41 S2400200
         SPACE 1                                                    R41 S2400400
MVKQNOMK AL    RCPA,MVKQXNPB       COMPUTE NEW RACING STATE         R41 S2400600
         CLR   RNUM,RSCBL          IF 2 CHARACTERS WON'T FIT        R41 S2400800
         BNL   MVKWNCAL             GO END SCB FOR DUPLICATE        R41 S2401000
         BCT   RSCBL,MVKQNOME      DECREASE SPACE LEFT IN SCB BY 1  R41CS2401200
               (ALWAYS BRANCHES)    & GO HANDLE AS FOR SINGLE CHAR  R41 S2401400
         SPACE 1                                                    R41 S2401600
MVKQNOML A     RCPA,MVKQXNPB       COMPUTE NEW RACING STATE         R41 S2401800
         BM    MVKWNC              GO COMPACT IF RACE STATE FLAGGED R41 S2402000
         L     RLCHAR,SCWSCBNC     COMPUTE WHERE CURRENT            R41 S2402200
         SLR   RLCHAR,RSCBL         NONCOMPACT SCB WOULD END        R41 S2402400
         LA    RPLAN,0(RLCHAR,RSINK) IF IT WERE TERMINATED NOW      R41 S2402600
         CL    RPLAN,SCWSCBCE      TEST IF PLANNED COMPACT SCB      R41CS2402800
                                    WILL COVER THE NC SCB & 2 CHARS R41 S2403000
         BL    MVKWNC6             GO COMPACT IF IT WILL            R41 S2403200
         SLR   RCPA,RCPA           ELSE SHOW COMPACTION NOT RACING  R41 S2403400
         CLR   RNUM,RSCBL          IF 2 CHARS WON'T FIT IN NONCOMP  R41 S2403600
         BNL   MVKQNOMG             SCB EITHER, GO TO EMPTY STATE   R41 S2403800
         LA    RPLAN,MVKQNC        ELSE RELOAD NONCOMPACT STATE     R41 S2404000
         B     MVKQNOMJ            ELSE USE .MM. TO BEGIN NEW RACE  R41 S2404200
         SPACE 3                                                    R41 S2404400
MVKQNPM  BC    SLSZ,MVKQNOMA       BRANCH IF ONLY 1 PRIME MASTER    R41 S2404600
         LA    RPLAN,MVKQEPM       ELSE CAUSE REPROCESSING IN EMPTY R41 S2404800
         B     MVKWNC               STATE (RACE AS IS), & END SCB   R41 S2405000
         EJECT                                                      R41 S2405200
*                                                                   R41 S2405400
*           COMPACTION PLANNER - COMPACT SCB STATE (NORMAL)         R41 S2405600
*                                                                   R41 S2405800
         SPACE 1                                                    R41 S2406000
         CNOP  0,8                 MAIN LOOP BRANCH TARGET ON DBLWD R41 S2406200
         B     MVKWCTI         -8  BRANCH TO FEEDER-END ROUTINE.    R41 S2406400
         B     0(,RFEED)       -4  PLANNER-END ROUTINE IS NO-OP     R41 S2406600
         SPACE 1                                                    R41 S2406800
MVKQCA10 IC    RGO,0(,RCHAR)       PICK UP 8-BIT COMPACTION         R41 S2407000
         IC    RCPA,CPTCTT(RGO)     FORM OF EMITTED CHARACTER       R41 S2407200
         IC    RGO,CPTCAT(RGO)     PICK UP ATTRIBUTE OF EMITTED CHARR41 S2407400
         L     RGO,MVKQCAAT(RGO)   USE AS INDEX INTO ADDRESS TABLE  R41 S2407600
         SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1  R41 S2407800
         BR    RGO                 BRANCH WITH CONDITION CODE SET   R41 S2408000
         SPACE 2                                                    R41 S2408200
MVKQCAAT DS    0F           *EVEN* COMPACT STATE ATTRIBUTE HANDLERS R41 S2408400
         DC    A(MVKQCOX)          NONPRIME NOT IN COMPACTION TABLE R41 S2408600
         DC    A(MVKWCTAL)         PRIME    NOT IN COMPACTION TABLE R41 S2408800
         DC    A(MVKQCON)          NONPRIME COMPACTIBLE NON-MASTER  R41 S2409000
         DC    A(MVKQCPN)          PRIME    COMPACTIBLE NON-MASTER  R41 S2409200
         DC    A(MVKQCOM)          NONPRIME MASTER                  R41 S2409400
         DC    A(MVKQCPM)          PRIME    MASTER                  R41 S2409600
         SPACE 5                                                    R41 S2409800
*                                                                   R41 S2410000
*           COMPACTION PLANNER - COMPACT SCB STATE (ODD, NORMAL)    R41 S2410200
*                                                                   R41 S2410400
         SPACE 1                                                    R41 S2410600
         CNOP  0,8                 MAIN LOOP BRANCH TARGET ON DBLWD R41 S2410800
         B     MVKWCTIZ        -8  BRANCH TO FEEDER-END ROUTINE.    R41 S2411000
         B     0(,RFEED)       -4  PLANNER-END ROUTINE IS NO-OP     R41 S2411200
         SPACE 1                                                    R41 S2411400
MVKQCA11 IC    RGO,0(,RCHAR)       PICK UP 8-BIT COMPACTION         R41 S2411600
         IC    RCPZ,CPTCTT(RGO)     FORM OF EMITTED CHARACTER       R41 S2411800
         IC    RGO,CPTCAT(RGO)     PICK UP ATTRIBUTE OF EMITTED CHARR41 S2412000
         L     RGO,MVKQCAZT(RGO)   USE AS INDEX INTO ADDRESS TABLE  R41 S2412200
         SLR   RNUM,RLSRCE         COMPUTE # OF OCCURRENCES LESS 1  R41 S2412400
         BR    RGO                 BRANCH WITH CONDITION CODE SET   R41 S2412600
         SPACE 2                                                    R41 S2412800
MVKQCAZT DS    0F            *ODD* COMPACT STATE ATTRIBUTE HANDLERS R41 S2413000
         DC    A(MVKQCXXZ)         NONPRIME NOT IN COMPACTION TABLE R41 S2413200
         DC    A(MVKQCPXZ)         PRIME    NOT IN COMPACTION TABLE R41 S2413400
         DC    A(MVKQCONZ)         NONPRIME COMPACTIBLE NON-MASTER  R41 S2413600
         DC    A(MVKQCPNZ)         PRIME    COMPACTIBLE NON-MASTER  R41 S2413800
         DC    A(MVKQCOMZ)         NONPRIME MASTER                  R41 S2414000
         DC    A(MVKQCPMZ)         PRIME    MASTER                  R41 S2414200
         EJECT                                                      R41 S2414400
MVKQCOX  BC    SLSP,MVKWCTAL       END SCB FOR DUP IF MULTIPLE .X.  R41 S2414600
         SLR   RSINK,RBY1          POINT TO LAST BYTE OF COMPACTED  R41 S2414800
MVKQCOXA BAL   RPLAN,MVKWCT         STRING & GO END THE COMPACT SCB R41 S2415000
MVKQCOX4 LA    RPLAN,MVKQNC        CHANGE TO NONCOMP/NONDUP STATE   R41 S2415200
         LA    RSCBL,SCBMAXCT(,RSINK)  GET END OF FULL CAPACITY SCB R41 S2415400
         CLR   RSCBL,REND          ATTEMPT TO FIT FULL CAPACITY SCB R41 S2415600
         BNH   MVKQEON4            BRANCH IF CAN FIT                R41 S2415800
         LR    RSCBL,REND          ELSE SUBSTITUTE END OF R.U.      R41 S2416000
         B     MVKQEON4            GO START NONCOMP/NONDUP SCB      R41 S2416200
         SPACE 3                                                    R41 S2416400
MVKQCON  BC    SLSZ,MVKQCPMB       BRANCH IF ONLY 1 OCCURRENCE      R41 S2416600
MVKQCONA CLR   RNUM,RBY1           TEST # OF OCCURRENCES LESS 1     R41 S2416800
         BH    MVKWCTAL            END SCB IF 3 OR MORE OCCURRENCES R41 S2417000
MVKQCONB STC   RCPA,0(,RSINK)      STORE 1ST COPY OF NON-MASTER     R41 S2417200
         BXLE  RSINK,RBY1,MVKQCPMB BRANCH IF 2ND COPY WILL FIT      R41 S2417400
         BCT   RSINK,MVKWCTAL      ELSE BACK UP PTR TO IGNORE COPY  R41CS2417600
               (ALWAYS BRANCHES)    ALREADY STORED, & END THE SCB   R41 S2417800
         SPACE 2                                                    R41 S2418000
MVKQCPN  BC    SLSZ,MVKQCPMB       BRANCH IF ONLY 1 OCCURRENCE      R41 S2418200
         BCT   RSINK,MVKWCTZL      ELSE BACK UP PTR TO STRING END   R41CS2418400
               (ALWAYS BRANCHES)    & GO END THE SCB FOR PRIME DUP  R41 S2418600
         SPACE 2                                                    R41 S2418800
MVKQCSM  LA    RPLAN,MVKQCA10      RESUME EVEN COMPACT STATE        R41 S2419000
         L     REND,SCWSCBCE       RESTORE COMPACT SCB ENDING LOC   R41 S2419200
MVKQCOM  BC    SLSZ,MVKEMITZ       ENTER ODD COMPACT STATE IF 1 .M. R41 S2419400
MVKQCOMA CL    RNUM,MVKQXOM        CHECK DUP FACTOR VS. LIMIT       R41 S2419600
         BNL   MVKQCOMF            BRANCH IF MUST LEAVE COMPACTION  R41 S2419800
         IC    RCPZ,MVKQXMM(RCPA)  STORE 4-BIT                      R41 S2420000
         STC   RCPZ,0(,RSINK)       MASTER PAIR                     R41 S2420200
         BCT   RNUM,MVKQCOMC       BR IF MORE THAN 2 OCCURRENCES    R41 S2420400
         BXLE  RSINK,RBY1,MVKEMITR ADVANCE RU PTR, GET NXT EMISSION R41 S2420600
         BCT   RNUM,MVKWCTAL       IF SCB FULL, KILL DUP FACTOR TO  R41CS2420800
               (ALWAYS BRANCHES)    SHOW EMISSION HANDLED & END SCB R41 S2421000
MVKQCOMC BCT   RNUM,MVKQCOMG       BRANCH IF EXACTLY 4 OCCURRENCES  R41 S2421200
         BXLE  RSINK,RBY1,MVKEMITZ ADVANCE RU PTR, GET NXT EMISSION R41 S2421400
         LA    RNUM,2              IF SCB FULL, RELOAD CORRECT DUP  R41 S2421600
         SLR   RSINK,RNUM           FACTOR AND RESET POINTER TO     R41CS2421800
                                     EXCLUDE PAIR ALREADY STORED    R41 S2422000
MVKQCOMD LA    RPLAN,MVKVDU        CAUSE EXIT TO NONPRIME DUP MOVER R41 S2422200
MVKQCOME MVI   SCWSCBCA,SCBMAXCT   SET FLAG FOR ADD TO EXISTING SCB R41 S2422400
         LR    RCPA,RBY1           SHOW COMPACTION BEHIND           R41 S2422600
         B     MVKWCT01            GO END CURRENT COMPACTION SCB    R41 S2422800
         SPACE 1                                                    R41 S2423000
MVKQCOMF BNE   MVKWCTAL            BR IF COMPACTION ENDS UNCOND'LY  R41 S2423200
         BCT   RSINK,MVKQCOMD      ELSE BACK UP PTR TO STRING END & R41CS2423400
               (ALWAYS BRANCHES)    END SCB FOR DUP IN BEHIND STATE R41 S2423600
         SPACE 1                                                    R41 S2423800
MVKQCOMG BXLE  RSINK,RBY1,MVKQCOMR ADVANCE R.U. POINTER & BRANCH    R41 S2424000
         LA    RNUM,3              IF SCB FULL, RELOAD CORRECT DUP  R41 S2424200
         BCT   RSINK,MVKWCTAL       FACTOR, SET PTR TO EXCLUDE PAIR R41CS2424400
               (ALWAYS BRANCHES)     ALREADY STORED, & END THE SCB  R41 S2424600
         EJECT                                                      R41 S2424800
MVKQCTM  LA    RPLAN,MVKQCA10      RESUME EVEN COMPACT STATE        R41 S2425000
         L     REND,SCWSCBCE       RESTORE COMPACT SCB ENDING LOC   R41 S2425200
         SPACE 1                                                    R41 S2425400
MVKQCPM  BC    SLSZ,MVKEMITZ       ENTER ODD COMPACT STATE IF 1 .M. R41 S2425600
MVKQCPMA CL    RNUM,MVKQXPM        CHECK DUP FACTOR VS. LIMIT       R41 S2425800
         BNL   MVKQCPMC            BRANCH IF MUST LEAVE COMPACTION  R41 S2426000
         IC    RCPA,MVKQXMM(RCPA)  STORE 4-BIT                      R41 S2426200
MVKQCPMB STC   RCPA,0(,RSINK)       MASTER PAIR                     R41 S2426400
         BXLE  RSINK,RBY1,MVKEMITR ADVANCE RU PTR, GET NXT EMISSION R41 S2426600
         LCR   RNUM,RBY1           IF SCB FULL, KILL DUP FACTOR TO  R41 S2426800
         BCT   RSINK,MVKWCT         SHOW EMISSION DONE, BACK UP PTR R41CS2427000
               (ALWAYS BRANCHES)     TO LAST BYTE, & GO END THE SCB R41 S2427200
         SPACE 1                                                    R41 S2427400
MVKQCPMC BNE   MVKWCTAL            BR IF COMPACTION ENDS UNCOND'LY  R41 S2427600
         LA    RPLAN,MVKVPR        CAUSE EXIT TO PRIME DUP MOVER    R41 S2427800
         BCT   RSINK,MVKQCOME      BACK UP POINTER TO STRING END &  R41CS2428000
               (ALWAYS BRANCHES)    END SCB FOR DUP IN BEHIND STATE R41 S2428200
         SPACE 2                                                    R41 S2428400
MVKQCOXZ CLI   CPTNMAST,16         TEST FOR 16 MASTERS SPECIAL CASE R41 S2428600
         BL    MVKWCTZL            GO END SCB FOR DUP IF NOT        R41 S2428800
         BAL   RGO,MVKWCX          ELSE END SCB VIA SPECIAL ROUTINE R41 S2429000
         CLR   RNUM,RBY1           IF 3 OR MORE OCCURRENCES,        R41 S2429200
         BH    MVKVDU               GO GENERATE DUPLICATE SCB       R41 S2429400
         CLR   RNUM,RSCBL          IF EMISSION WON'T FIT            R41 S2429600
         BNL   MVKZOFLO             R.U. IS FULL--GO SEND           R41 S2429800
         SLR   RCHAR,RBY1          BACK UP TO 1ST OF PAIR OF CHARS  R41 S2430000
         SLR   RSINK,RBY1          BACK UP TO ADDRESS               R41 S2430200
         SLR   RSINK,RBY1           OF NON-COMPACT SCB              R41 S2430400
         BCT   RSCBL,MVKQNSXC      DECREASE REMAINING SPACE IN SCB  R41CS2430600
               (ALWAYS BRANCHES)    BY 1 & TREAT AS IF SINGLE CHAR. R41 S2430800
         SPACE 2                                                    R41 S2431000
MVKQCPXZ STC   RCPA,0(,RSINK)      STORE ODD MASTER IN 8-BIT FORM   R41 S2431200
         CLI   CPTNMAST,16         TEST FOR 16 MASTERS SPECIAL CASE R41 S2431400
         BL    MVKWCTZL            END SCB FOR PRIME DUP IF NOT     R41 S2431600
         LA    RGO,MVKVPR          ELSE POINT TO PRIME DUP MOVER    R41 S2431800
         B     MVKWCX              GO END SCB VIA SPECIAL ROUTINE   R41 S2432000
         SPACE 3                                                    R41 S2432200
MVKQCONZ STC   RCPA,0(,RSINK)      STORE ODD MASTER IN 8-BIT FORM   R41 S2432400
         BXH   RSINK,RBY1,MVKQEONR REVERT TO EMPTY STATE IF RU FULL R41 S2432600
         BC    SLSZ,MVKQCOMQ       BRANCH IF SINGLE NON-MASTER      R41 S2432800
         CLR   RNUM,RBY1           TEST # OF OCCURRENCES LESS 1     R41 S2433000
         BH    MVKWCTAL            END SCB IF 3 OR MORE OCCURRENCES R41 S2433200
         STC   RCPZ,0(,RSINK)      STORE 1ST COPY OF NON-MASTER     R41 S2433400
         BXLE  RSINK,RBY1,MVKQCOMQ BRANCH IF 2ND COPY WILL FIT      R41 S2433600
         BCT   RSINK,MVKWCTAL      ELSE BACK UP PTR TO IGNORE COPY  R41CS2433800
               (ALWAYS BRANCHES)    ALREADY STORED, & END THE SCB   R41 S2434000
         EJECT                                                      R41 S2434200
MVKQCPNZ STC   RCPA,0(,RSINK)      STORE ODD MASTER IN 8-BIT FORM   R41 S2434400
         BC    SLSP,MVKWCTZL       END SCB BY PRIME DUP IF MULT .P. R41 S2434600
         BXLE  RSINK,RBY1,MVKQCOMQ ADVANCE R.U. POINTER & BRANCH    R41 S2434800
         BCT   RSINK,MVKWCTZL      IF SCB FULL, BACK UP PTR TO LAST R41CS2435000
               (ALWAYS BRANCHES)    BYTE STORED, AND GO END THE SCB R41 S2435200
         SPACE 2                                                    R41 S2435400
MVKQCSMX L     RSINK,SCWSCBA       RETRIEVE POINT OF INTERRUPTION   R41 S2435600
MVKQCSMZ LA    RPLAN,MVKQCA11      RESUME ODD COMPACT STATE         R41 S2435800
         L     REND,SCWSCBCE       RELOAD COMPACT SCB ENDING LOC    R41 S2436000
         SPACE 1                                                    R41 S2436200
MVKQCOMZ BC    SLSP,MVKQCOMS       BRANCH IF NOT SINGLE MASTER      R41 S2436400
MVKQCOMP IC    RCPA,MVKQXMF(RCPA)  FORM PAIR FROM ODD MASTER        R41 S2436600
         NR    RCPZ,RCPA            AND CURRENT EMISSION CHAR       R41 S2436800
MVKQCOMQ LA    RPLAN,MVKQCA10      CHANGE TO EVEN COMPACTION STATE  R41 S2437000
MVKQCOMR STC   RCPZ,0(,RSINK)      STORE GENERATED BYTE INTO R.U.   R41 S2437200
         BXLE  RSINK,RBY1,MVKEMITR ADVANCE RU PTR, GET NXT EMISSION R41 S2437400
         LCR   RNUM,RBY1           IF SCB FULL, KILL DUP FACTOR TO  R41 S2437600
         BCT   RSINK,MVKWCT         SHOW EMISSION DONE, BACK UP PTR R41CS2437800
               (ALWAYS BRANCHES)     TO LAST BYTE, & GO END THE SCB R41 S2438000
         SPACE 1                                                    R41 S2438200
MVKQCOMS IC    RGO,MVKQXMF(RCPA)   FORM PAIR FROM ODD               R41 S2438400
         LR    RCPA,RCPZ            MASTER AND CURRENT              R41 S2438600
         NR    RCPZ,RGO              EMISSION CHARACTER             R41 S2438800
         STC   RCPZ,0(,RSINK)         AND STORE IT IN R.U.          R41 S2439000
         BCT   RNUM,MVKQCOMT       BR IF 2 OR MORE COPIES REMAINING R41 S2439200
         BXLE  RSINK,RBY1,MVKEMITR ELSE ADVANCE, STAY IN ODD STATE  R41 S2439400
         LA    RPLAN,MVKQEOMC      HAVE REMAINING MSTR REPROCESSED  R41 S2439600
         BCT   RSINK,MVKWCT         IN EMPTY STATE. BACK UP TO LAST R41CS2439800
               (ALWAYS BRANCHES)     BYTE STORED, & GO END THE SCB  R41 S2440000
         SPACE 1                                                    R41 S2440200
MVKQCOMT LA    RPLAN,MVKQCA10      CHANGE TO EVEN COMPACT STATE     R41 S2440400
         BXLE  RSINK,RBY1,MVKQCOMA GO HANDLE REMAINING OCCURRENCES  R41 S2440600
         LA    RPLAN,MVKQEOM       IF SCB FULL, SET UP TO HANDLE    R41 S2440800
         BCT   RSINK,MVKWCT         REMAINDER IN EMPTY STATE. BACK  R41CS2441000
               (ALWAYS BRANCHES)     UP PTR TO LAST BYTE & END SCB  R41 S2441200
         SPACE 2                                                    R41 S2441400
MVKQCTMX L     RSINK,SCWSCBA       RETRIEVE POINT OF INTERRUPTION   R41 S2441600
MVKQCTMZ LA    RPLAN,MVKQCA11      RESUME ODD COMPACT STATE         R41 S2441800
         L     REND,SCWSCBCE       RELOAD COMPACT SCB ENDING LOC    R41 S2442000
         SPACE 1                                                    R41 S2442200
MVKQCPMZ BC    SLSZ,MVKQCOMP       BRANCH IF ONLY 1 OCCURRENCE      R41 S2442400
         IC    RGO,MVKQXMF(RCPA)   FORM PAIR FROM ODD               R41 S2442600
         LR    RCPA,RCPZ            MASTER AND CURRENT              R41 S2442800
         NR    RCPZ,RGO              EMISSION CHARACTER             R41 S2443000
         STC   RCPZ,0(,RSINK)         AND STORE IT IN R.U.          R41 S2443200
         BCT   RNUM,MVKQCPMP       BR IF 2 OR MORE COPIES REMAINING R41 S2443400
         BXLE  RSINK,RBY1,MVKEMITR ELSE ADVANCE, STAY IN ODD STATE  R41 S2443600
         LR    RCPA,RBY1           ELSE SHOW COMPACTION BEHIND      R41 S2443800
         LA    RPLAN,MVKQEPMA      HAVE REMAINING PRIME REPROCESSED R41 S2444000
         BCT   RSINK,MVKWCT01       IN EMPTY STATE. BACK UP TO LAST R41CS2444200
               (ALWAYS BRANCHES)     BYTE STORED, & GO END THE SCB  R41 S2444400
         EJECT                                                      R41 S2444600
MVKQCPMP LA    RPLAN,MVKQCA10      CHANGE TO EVEN COMPACT STATE     R41 S2444800
         BXLE  RSINK,RBY1,MVKQCPMA GO HANDLE REMAINING OCCURRENCES  R41 S2445000
         BCT   RSINK,MVKWCTZL      IF SCB FULL, BACK UP PTR TO LAST R41CS2445200
               (ALWAYS BRANCHES)     BYTE STORED, & SWITCH TO PRIME R41 S2445400
         SPACE 20                                                   R41 S2445600
*                                                                   R41 S2445800
*                        COMPACTION PLANNER - CONSTANTS             R41 S2446000
*                                                                   R41 S2446200
         SPACE 2                                                    R41 S2446400
MVKQXVA  DC    A(SCWAHEAD+1)       RACING STATE VALIDITY CONSTANT   R41 S2446600
         SPACE 1                                                    R41 S2446800
MVKQXINO DC    X'80',AL3(SCWCANOT) RACING STATE CONSTANTS           R41 S2447000
MVKQXIBH DC    X'80',AL3(SCWBHIND)  WITH FLAG TO SHOW THAT          R41 S2447200
MVKQXIST DC    X'80',AL3(SCWSTAND)   RACE BEGAN INSIDE NC SCB       R41 S2447400
         SPACE 1                                                    R41 S2447600
MVKQXNP  DC    A(SCWNPCOS+1)       RACE STATE CONSTANTS             R41 S2447800
MVKQXNPB DC    A(SCWNPCOS)          FOR NONPRIME STRATEGY           R41 S2448000
         SPACE 1                                                    R41 S2448200
MVKQXPM  DC    A(SCWSTAND)         RACE STATE CONSTANTS             R41 S2448400
MVKQXOM  DC    A(SCWNPCOS+SCWSTAND) FOR MASTER STRATEGY             R41 S2448600
         SPACE 3                                                    R41 S2448800
MVKQXMF  EQU   *-CPTMAST0          4-BIT MASTERS IN LEFT NIBBLE     R41 S2449000
         DC    X'0F1F2F3F4F5F6F7F8F9FAFBFCFDFEFFF'                  R41 S2449200
         SPACE 3                                                    R41 S2449400
MVKQXMM  EQU   *-CPTMAST0          4-BIT DOUBLE MASTERS             R41 S2449600
         DC    X'00112233445566778899AABBCCDDEEFF'                  R41 S2449800
         EJECT                                                      R41 S2450000
*********************************************************************** S2480000
*                                                                     * S2480500
*                   COMPRESS/COMPACT SEND ROUTINE                     * S2481000
*                                                                     * S2481500
*           OBJECTIVE - TO SET PROPER FLAGS AND RETURN TO             * S2482000
*           COMPOSER CALLER WHEN R.U. BUFFER FILLS.                   * S2482500
*                                                                     * S2483000
*           IF THERE IS MORE DATA TO BE PROCESSED (TRUE FOR           * S2483500
*           ENTRIES TO 'MVKZFULL' WITH 'SCWMORE' FLAG SET             * S2484000
*           AND FOR ALL ENTRIES TO 'MVKZOFLO'), ADDRESS AND           * S2484500
*           LENGTH OF THE EXCESS ARE SAVED, THE COMPOSER              * S2485000
*           EXITS TO CALLER WITH FLAG 'SCWMORE' SET, AND IT           * S2485500
*           IS EXPECTED THAT CALLING CODE WILL GET A NEW              * S2486000
*           BUFFER, SEND THE OLD BUFFER, AND CALL COMPOSER            * S2486500
*           AGAIN.  'SCWMORE' FLAG SET AT COMPOSER ENTRY              * S2487000
*           CAUSES BRANCH TO 'MVKZCNUE' TO HANDLE EXCESS.             * S2487500
*                                                                     * S2488000
*           IF FULL BUFFER HAPPENS TO COINCIDE WITH THE LAST          * S2488500
*           EMISSION FOR THIS CCW, COMPOSER RETURNS WITH              * S2489000
*           'SCWFULL ' FLAG SET INSTEAD OF 'SCWMORE'.  THE            * S2489500
*           CALLER JUST SENDS THE R.U. IN THIS CASE.                  * S2490000
*                                                                     * S2490500
*********************************************************************** S2491000
         SPACE 1                                                     R4 S2491500
MVKZCNUE L     RNUM,SCWNUM         RETRIEVE SAVED DUP FACTOR         R4 S2492000
         LCR   RCHAR,RBY1          LOAD -1 TO CALC EMISSION ADDRESS  R4 S2492500
         SPACE 1                                                     R4 S2493500
         L     RSRCE,SCWSRCE       RELOAD ADDRESS AND LENGTH         R4 S2494000
         L     RLSRCE,SCWLSRCE      OF SOURCE STRING REMAINDER       R4 S2494500
         L     RFEED,SCWFEED       RELOAD FEEDER ROUTINE RETURN ADDR R4 S2495000
         TM    SCWFLAGS,SCWCTRL    TEST COMPOSER FLAGS               R4 S2495500
         BZ    MVKZCNU1            BRANCH IF NOT CONTROL STRING     R41 S2496000
         ALR   RSRCE,MBUF          CONVERT OFFSET TO ADDRESS         R4 S2496500
MVKZCNU1 ALR   RCHAR,RSRCE         EMISSION CHARACTER ADDR = RSRCE-1R41 S2497000
         SPACE 1                                                     R4 S2497500
         LTR   RNUM,RNUM           TEST EMISSION DUP FACTOR          R4 S2498000
         BM    MVKEMITR            IF EXHAUSTED GO GET NEXT EMISSION R4 S2498500
         ALR   RNUM,RLSRCE         FIX UP REPEAT OF DUP FACTOR CALC. R4 S2499000
         SLR   RGO,RGO             CLEAR WORK REG FOR WHERE-TO-GO   R41 S2499500
         TM    SCWFLAGS,SCWODDMF   TEST COMPOSER FLAGS              R41 S2499600
         BZR   RPLAN               BRANCH TO EMPTY STATE PLANNER IF R41CS2499700
                                    NOT 16-MASTER ODD OVERFLOW CASE R41 S2499800
         MVI   0(RSINK),SCBNONCO+1 CREATE NONCOMP SCB WITH COUNT 1  R41 S2499900
         MVC   1(1,RSINK),SCWODDM  MOVE IN ODD MASTER               R41 S2500000
         LA    RSCBL,SCBMAXCT      SET ORIGINAL SCB                 R41 S2500100
         ST    RSCBL,SCWSCBNC       CAPACITY TO MAXIMUM             R41 S2500200
         ST    RSINK,SCWSCBA       SAVE INTERRUPTED SCB ADDRESS     R41 S2500300
         LA    RSINK,SCB+1(,RSINK) POINT PAST SCB AND SINGLE CHAR   R41 S2500400
         NI    SCWFLAGS,255-SCWODDMF  RESET ODD MASTER SPECIAL FLAG R41 S2500500
         BCT   RSCBL,MVKQNCSA      SHOW 1 BYTE OF SCB USED & GO     R41CS2500600
               (ALWAYS BRANCHES)    HANDLE BACKED-UP EMISSION IN    R41CS2500700
                                     SIMULATED NONCOMP SUSPND STATE R41 S2500800
         EJECT                                                      R41 S2500900
MVKZFULE OI    SCWFLAGS,SCWFULL    IF LAST FORCE CALLER TO SEND R.U.R41 S2501000
         NI    SCWFLAGS,255-SCWLAST-SCWMORE  INDICATE COMPOSING DONER41 S2501100
         B     MVKZFLEN            REJOIN COMMON RETURN LOGIC       R41 S2501200
         SPACE 2                                                    R41 S2501300
MVKZFULL DS    0H                  ENTRY USED IF RNUM ALREADY NEG.     CS2501400
                                    MEANING EMISSION TAKEN CARE OF   R4 S2501500
         TM    SCWFLAGS,SCWLAST    TEST COMPOSER FLAGS               R4 S2501600
         BO    MVKZFULE            BRANCH IF LAST EMISSION          R41 S2502000
         SPACE 1                                                    R41 S2504000
MVKZOFLO DS    0H                  ENTRY USED IF EMISSION MUST BE      CS2504500
                                    HANDLED ON RE-ENTRY W/NEW BUFFER R4 S2505000
         TM    SCWFLAGS,SCWNSPAN   TEST COMPOSER FLAGS               R4 S2505500
         BO    MVKZNSPA            BR IF SPANNED RECORDS FORBIDDEN   R4 S2506000
         ST    RNUM,SCWNUM         SAVE EMISSION DUP FACTOR          R4 S2506500
         TM    SCWFLAGS,SCWCTRL    TEST COMPOSER FLAGS               R4 S2507000
         BZ    SKIP460             BRANCH IF NOT CONTROL STRING      R4 S2507500
         SLR   RSRCE,MBUF          CONVERT ADDRESS TO OFFSET         R4 S2508000
SKIP460  ST    RSRCE,SCWSRCE       SAVE ADDRESS AND LENGTH           R4 S2508500
         ST    RLSRCE,SCWLSRCE      OF SOURCE STRING REMAINDER       R4 S2509000
         ST    RFEED,SCWFEED       SAVE FEEDER RETURN ADDRESS        R4 S2509500
         SPACE 1                                                     R4 S2510000
MVKZFLEN L     REND,RPLAREA        CALCULATE                         R4 S2510500
         SLR   RSINK,REND           R.U. LENGTH                      R4 S2511000
         ST    RSINK,RPLRLEN       SET R.U. LENGTH IN RPL            R4 S2511500
         SPACE 2                                                    R41 S2511600
         POP   USING               RESTORE ACCESS METHOD REG USAGE  R41 S2511700
         SPACE 2                                                    R41 S2511900
MVKZNSPA L     SAVE,SCWSAV13       RESTORE                          R41 S2512000
         L     R1,PCER1             REGISTER                        R41 S2512500
         L     BASE1,PCEBASE1        ENVIRONMENT                    R41 S2512700
        $RESTORE                   RESTORE ACCESS METHOD REGISTERS   R4 S2513000
         L     ML,SCWRETRN         LOAD COMPOSER RETURN ADDRESS      R4 S2513500
         BR    ML                  RETURN TO CALLER                  R4 S2514000
         TITLE 'HASP SNA REMOTE TERMINAL CLOSE ROUTINE'              R4 S2515500
*                                                                    R4 S2516000
*                             VTAM CLOSE PROCESSING                  R4 S2516500
*                                                                    R4 S2517000
         SPACE 3                                                     R4 S2517500
         USING RTAMVCLO,MBASE1     ESTABLISH SNA CLOSE ADDRESSAB'TY  R4 S2518000
RTAMVNCL DS    0H                  ADDRESS OF RTAM SNA NCLOSE RTN   R41 S2518500
         OI    MDCTSTAT,DCTADS     SHOW DATASET ABNORMAL TERMINATN  R41 S2518600
         LA    MBASE1,RTAMVCLO-RTAMVNCL(,MBASE1) ADJUST BASE ...    R41 S2518700
         ICM   MBASE1,8,=X'80'     SET CLOSE INDICATOR...      @OZ42454 S2518800
         ST    MBASE1,PCESAVEA      AND SAVE IN THE PCE        @OZ42454 S2518850
         SPACE 2                                                    R41 S2518900
RTAMVCLO DS    0H                  ENTRY POINT FOR RTAM SNA CLOSE    R4 S2519000
         TM    MDCTSEL,DCTPOUTB    TEST DIRECTION BIT                R4 S2519500
         BZ    MVCINBND            IF INBOUND GO TO INBOUND CLOSE    R4 S2520000
         TM    MDCTSTAT,DCTPSUSP   TEST STREAM STATUS                R4 S2522500
         BZ    SKIP470             BRANCH IF NOT SUSPENDED           R4 S2523000
         BAL   ML,MVREQUME         WAIT FOR RESUME IF SUSPENDED      R4 S2523500
SKIP470  TM    ICESNDST,ICEWTRSP+ICECNCEL  TEST SESSION SEND STATUS  R4 S2524000
         BZ    SKIP480             BR IF L.M.-SENT REQST NOT PENDING R4 S2524500
         BAL   ML,MVREQRSP         ELSE WAIT FOR L.M. TO ACCEPT RESP R4 S2525000
SKIP480  TM    ICESNDST,ICEINSTR   TEST STREAM SEND STATUS           R4 S2525500
         BO    MVCINSTR            BYPASS RESUME HDR IF IN STREAM    R4 S2526000
         BAL   ML,MVRPLGET         GET BUFFER FOR 'RESUME' FM HEADER R4 S2526500
         OI    ICESNDST,ICEOCPND   SET END CHN TO FORCE IMM FMH SEND R4 S2527000
         LA    R1,FMHRESUM         LOAD 'RESUME' DATA STREAM ACTION  R4 S2527500
         BAL   ML,MVFMHBLD         BUILD & SEND 'RESUME' FM HEADER   R4 S2528000
         SPACE 1                                                     R4 S2528500
MVCINSTR TM    MDCTSTAT,DCTFLUSH   TEST STREAM STATUS                R4 S2529000
         BZ    MVCTRUNC            BRANCH IF STREAM NOT ABORTING     R4 S2529500
         LTR   MBUF,MBUF           TEST RDCT-OWNED BUFFER ADDRESS    R4 S2530000
         BZ    MVCENDBF            IF NO BUFFER, GET ONE & SEND ADS  R4 S2530500
         L     R15,RPLNEXT         TEST RPL                          R4 S2531000
         LTR   R15,R15              CHAIN FIELD                      R4 S2531500
         BZ    MVCENDDS            GO BUILD ADS IF OWN ONLY 1 BUFFER R4 S2532000
         BAL   ML,MVFREOUT         ELSE FREE FIRST BUFFER            R4 S2532500
         L     MBUF,DCTBUFAD        AND GO BUILD ADS IN              R4 S2533000
         B     MVCENDDS              THE REMAINING BUFFER            R4 S2533500
         SPACE 1                                                     R4 S2534000
MVCTRUNC LTR   MBUF,MBUF           TEST BUFFER ADDRESS               R4 S2534500
         BNZ   MVCENDCH            GO TRY END CHAIN IF HAVE BUFFER   R4 S2535000
         BAL   ML,MVRPLGET         GET BUFFER FOR END CHAIN OR EDS   R4 S2535500
         TM    ICESNDST,ICEINCHN   TEST STREAM SENDING STATUS        R4 S2536000
         BZ    MVCENDDS            GO SEND EDS IF NOT IN CHAIN       R4 S2536500
         SPACE 1                                                     R4 S2537000
MVCENDCH TM    ICESNDST,ICEINCHN   TEST STREAM SENDING STATUS        R4 S2537500
         BO    SKIP490             SKIP ZERO LNGTH CHECK IF IN CHAIN R4 S2538000
         L     R1,RPLRLEN          TEST R.U.                         R4 S2538500
         LTR   R1,R1                LENGTH                           R4 S2539000
         BZ    MVCENDDS            IF ZERO DON'T BOTHER TO SEND      R4 S2539500
SKIP490  OI    ICESNDST,ICEOCPND   SET 'END OF CHAIN PENDING' FLAG   R4 S2540000
         BAL   ML,MVRPLSND         CALL BUFFER SEND ROUTINE          R4 S2540500
         EJECT                                                       R4 S2541000
*                             SEND 'END' OR 'ABORT DATA STREAM'      R4 S2541500
         SPACE 1                                                     R4 S2542000
MVCENDBF BAL   ML,MVRPLGET         GET ANOTHER BUFFER FOR EDS        R4 S2542500
MVCENDDS L     R15,ICESDCT         GET 1ST SUSPENDED REMOTE DCT      R4 S2543000
         LTR   R15,R15             TEST ADDRESS                      R4 S2543500
         BNZ   MVCNOTEB            BRANCH IF SUSPENDED RDCTS EXIST   R4 S2544000
         TM    BINPRIP-ISTDBIND+ICEBIND,BINPSEB  TEST PRIMARY PRTCOL R4 S2544500
         BZ    MVCHGDIR            BRANCH IF NOT ALLOWED TO SEND EB  R4 S2545000
         OI    ICEFLAGS,ICEEBPND   SET 'END BRACKET PENDING' FLAG    R4 S2545500
         B     MVCDSTRM            GO TO SEND FM HEADER              R4 S2546000
         SPACE 1                                                     R4 S2546500
         USING DCTDSECT,R15        USE TEMPORARY RDCT ADDRESSABILITY R4 S2547000
MVCNOTEB TM    MDCTSEL,DCTPOUTB    TEST DIRECTION BIT                R4 S2547500
         BO    MVCDSTRM            BRANCH IF SUSPENDED OUTBOUND      R4 S2548000
         L     R15,MDCTSDCT        GET NEXT SUSPENDED RDCT           R4 S2548500
         LTR   R15,R15             TEST ADDRESS                      R4 S2549000
         BNZ   MVCNOTEB            BRANCH IF REMOTE DCT PRESENT      R4 S2549500
         DROP  R15                 DISCARD TEMP RDCT ADDRESSABILITY  R4 S2550000
         SPACE 1                                                     R4 S2550500
MVCHGDIR OI    ICEFLAGS,ICECHDIR   SET 'CHGE DIRECTION PENDING' FLAG R4 S2551000
         SPACE 1                                                     R4 S2551500
MVCDSTRM LA    ML,MVTAMXIT         LOAD RETURN FOR HDR SERV ROUTINE  R4 S2552000
         LA    R1,FMHNMEND         SET 'END DATA STREAM' ACTION CODE R4 S2552500
         OI    ICESNDST,ICEOCPND   SET END CHN TO FORCE FMH SEND NOW R4 S2553000
         TM    MDCTSTAT,DCTADS     TEST FOR NCLOSE SPECIFIED        R41 S2553500
         BZ    MVFMHBLD            IF NOT GO BUILD 'EDS' FM HEADER  R41 S2554000
         LA    R1,FMHABEND         ELSE , BUILD 'ADS' FM HEADER     R41 S2554500
         B     MVFMHBLD            BUILD, SEND, & GET +RSP TO FM HDR   CS2555000
                                    TRY STARTING NEXT STREAM & RETRN R4 S2555500
         SPACE 2                                                     R4 S2556000
*                                                                    R4 S2556500
*                             INBOUND CLOSE PROCESSING               R4 S2557000
*                                                                    R4 S2557500
         SPACE 1                                                     R4 S2558000
MVCINBND LA    ML,MVTAMXIT         LOAD RETURN FOR NORMAL CASE       R4 S2558500
         B     MVRELBUF            ASSUME BUFFER CAUSING EDS IS        CS2559000
                                    ATTACHED. GO FREE IT & RETURN    R4 S2559500
         SPACE 1                                                     R4 S2565000
         DROP  MDCT                RELEASE DCT ADDRESSABILITY        R4 S2565500
         TITLE 'HASP SNA REMOTE TERMINAL ACCESS METHOD EXIT ROUTINE' R4 S2566000
         USING DCTDSECT,R1         ESTABLISH DCT ADDRESSABILITY      R4 S2566500
         SPACE 3                                                     R4 S2567000
RTAMVSUB DS    0H                  RTAM SNA SUBROUTINE BASE ADDRESS  R4 S2567500
         SPACE 3                                                     R4 S2568000
*                                                                    R4 S2568500
*                             SNA RTAM COMMON EXIT ROUTINE           R4 S2569000
*                                                                    R4 S2569500
         SPACE 3                                                     R4 S2570000
MVTAMXIT DS    0H                  SNA RTAM NORMAL EXIT              R4 S2570500
         LM    LINK,BASE2,PCELINK  RELOAD CALLER'S REGISTERS         R4 S2571000
         NI    DCTSTAT,255-DCTRTAM SHOW RTAM PROCESSING COMPLETE     R4 S2571500
         LPR   R0,R1               SET POSITIVE CONDITION CODE       R4 S2572000
         BR    LINK                 AND RETURN                       R4 S2572500
         SPACE 5                                                     R4 S2573000
MVTAMXEX DS    0H                  SNA RTAM EXCEPTION EXIT           R4 S2573500
         LM    LINK,BASE2,PCELINK  RELOAD CALLER'S REGISTERS         R4 S2574000
         NI    DCTSTAT,255-DCTRTAM SHOW RTAM PROCESSING COMPLETE     R4 S2574500
         LNR   R0,R1               SET NEGATIVE CONDITION CODE       R4 S2575000
         BR    LINK                 AND RETURN                       R4 S2575500
         SPACE 5                                                     R4 S2576000
MVTAMXAB DS    0H                  SNA RTAM ABNORMAL EXIT            R4 S2576500
         LM    LINK,BASE2,PCELINK  RELOAD CALLER'S REGISTERS         R4 S2577000
         NI    DCTSTAT,255-DCTRTAM SHOW RTAM PROCESSING COMPLETE     R4 S2577500
         SR    R0,R0               SET ZERO CONDITION CODE           R4 S2578000
         BR    LINK                 AND RETURN                       R4 S2578500
         SPACE 5                                                        S2579000
MVTAMXOV DS    0H                  SNA RTAM OVERFLOW EXIT            R4 S2579500
         LM    LINK,BASE2,PCELINK  RELOAD CALLER'S REGISTERS         R4 S2580000
         NI    DCTSTAT,255-DCTRTAM SHOW RTAM PROCESSING COMPLETE     R4 S2580500
         TM    DCTSTAT,DCTINUSE    SET 'ONES' (OVERFLOW) COND. CODE  R4 S2581000
         BR    LINK                 AND RETURN                       R4 S2581500
         SPACE 2                                                     R4 S2582000
         DROP  R1                  RELEASE DCT ADDRESSABILITY        R4 S2582500
         TITLE 'HASP SNA REMOTE TERMINAL ACCESS METHOD SUBROUTINES'  R4 S2583000
         USING DCTDSECT,MDCT       ESTABLISH DCT ADDRESSABILITY      R4 S2583500
         SPACE 3                                                     R4 S2584000
*                                                                    R4 S2584500
*                             RPL 'SEND' ROUTINE                     R4 S2585000
*                                                                    R4 S2585500
         SPACE 1                                                     R4 S2586000
MVRPLWTR OI    ICESNDST,ICEWTRSP   INDICATE PROC. AWAITING RESPONSE  R4 S2586500
         ST    MBUF,DCTBUFAD       DEFER BUF POP-UP TILL AFTER WAIT  R4 S2587000
         SPACE 1                                                     R4 S2587500
MVRPLWT  ST    ML,RPLBCHN          SAVE RETURN ADDRESS               R4 S2588000
        $WAIT  WORK,SAVE=NO        WAIT FOR CONDITION TO CLEAR       R4 S2588500
        $RESTORE                   RESTORE ACCESS METHOD REGISTERS   R4 S2589000
         L     ML,RPLBCHN          RELOAD RETURN ADDRESS             R4 S2589500
         TM    ICESNDST,ICECNCEL   TEST SESSION SEND STATUS          R4 S2590000
         BO    MVREQCAN            ABORT $EXTP CALL IF CHAIN CANCEL  R4 S2590500
         SPACE 1                                                     R4 S2591000
MVRPLSND DS    0H                  RPL SCHEDULER MAIN ENTRY POINT    R4 S2591500
         CLC   ICEOUTCT,ICEOUTLM   COMPARE OUTBD CIRCULATION & LIMIT R4 S2592000
         BNL   MVRPLWT             AT LIMIT, BR - WAIT AND RE-ENTER  R4 S2592500
         SPACE 1                                                     R4 S2593000
         MVC   DCTBUFAD,RPLNEXT    POP DCT BUFFER POINTER            R4 S2593500
         TM    ICESNDST,ICEINCHN   TEST SESSION SEND STATUS          R4 S2594000
         BO    MVRPLHDR            SKIP LIMIT CHECK IF IN SAME CHAIN R4 S2594500
         CLC   MDCTCHLM,ICERSPCT   TEST FOR LIMIT EXCESSION          R4 S2595000
         BL    MVRPLWTR            YES, BRANCH - WAIT AND RE-ENTER   R4 S2595500
         SPACE 1                                                     R4 S2596000
MVRPLOCH IC    R15,ICERSPCT        INCREMENT                         R4 S2596500
         LA    R15,1(,R15)          OVERLAPPING                      R4 S2597000
         STC   R15,ICERSPCT          CHAIN COUNT                     R4 S2597500
         SPACE 1                                                     R4 S2598000
MVRPLHDR LA    R15,4               SET TRANSITION # FOR IN CHN, -EOC R4 S2598500
         TM    ICESNDST,ICEINCHN   TEST SESSION STATUS               R4 S2599000
         BO    MVRPLNFC            BAR FI/BB/EB UNLESS 1ST IN CHAIN  R4 S2599500
         SLR   R15,R15             RESET TRANSITION NUMBER TO 0      R4 S2600000
MVRPLFC1 TM    ICESNDST,ICENOFMH   TEST STREAM SENDING STATUS        R4 S2606000
         BO    SKIP500             BRANCH IF NO FM HEADER PENDING    R4 S2606500
         OI    RPLOPT12,RPLFMHDR   SET FORMAT (FM HEADER) INDICATOR  R4 S2607000
SKIP500  TM    ICEFLAGS,ICEEBPND   TEST SESSION STATUS               R4 S2607500
         BZ    MVRPLFC2            BR IF END BRACKET NOT PENDING     R4 S2608000
         OI    RPLRH3,RPLEB        TURN ON END BRACKET BIT IN RH     R4 S2608500
MVRPLFC2 TM    ICEFLAGS,ICEINBRK   TEST SESSION STATUS               R4 S2609000
         BO    MVRPLNFC            BRANCH IF ALREADY IN BRACKET      R4 S2609500
         OI    ICEFLAGS,ICEBBPND   SET 'BEGIN BRACKET PENDING' FLAG  R4 S2610000
         OI    RPLRH3,RPLBB        TURN ON BEGIN BRACKET BIT IN RH   R4 S2610500
         OI    ICEFLAGS,ICEOUTBD   MARK STREAM AS OUTBOUND           R4 S2611000
         EJECT                                                       R4 S2611500
MVRPLNFC TM    ICESNDST,ICEOCPND   TEST SESSION STATUS               R4 S2612000
         BZ    MVRPLNEC            BRANCH IF NOT END OF CHN          R4 S2612500
         LA    R15,2(,R15)         ADD 2 TO TRANSITION NUMBER        R4 S2613000
         NI    RPLVTFL2,255-RPLNFME-RPLEX  SET 'REQ DEFINITE RESP'   R4 S2613500
         CLI   PCEID+1,PCEMLMID    IS THIS THE LINE MANAGER..  @OZ41311 S2614000
         BE    MVRPLNWT            DON'T WAIT NOW IF L.M.      @OZ26937 S2614500
         ST    ML,DCTEWF           SAVE 1ST LEVEL RETURN ADDRESS     R4 S2615000
         LA    ML,MVREQWT          CLOSE WAIT FOR RESPONSE     @OZ26937 S2615500
MVRPLNWT OI    ICESNDST,ICEWTRSP   INDICATE WAIT FOR RESPONSE  @OZ26937 S2616000
         TM    ICEFLAGS,ICECHDIR   TEST SESSION STATUS         @OZ26937 S2616500
         BZ    MVRPLNEC            BR IF CHANGE DIRECTION NOT PENDNG R4 S2617000
         OI    RPLRH3,RPLCMD       TURN ON CHGE DIRECTION BIT IN RH  R4 S2617500
         SPACE 1                                                     R4 S2618000
MVRPLNEC TM    MDCTFMT,DCTPALTC    TEST DATA STREAM FORMAT           R4 S2618500
         BZ    MVRPLCHN            SKIP XLATE IF ALT CODE FLAG OFF   R4 S2619000
         L     R14,RPLAREA         GET 1ST DATA BYTE ADDRESS         R4 S2619500
         L     R0,RPLRLEN          GET R.U. LENGTH                   R4 S2620000
         TM    RPLOPT12,RPLFMHDR   TEST FORMAT (FM HDR) INDICATOR    R4 S2620500
         BZ    MVRPLALT            BRANCH IF NO FM HEADERS           R4 S2621000
         SLR   R1,R1               CLIP FM HDR OFF FRONT             R4 S2621500
SKIP520  IC    R1,0(,R14)           OF R.U. BY SUBTRACTING           R4 S2622000
         SLR   R0,R1                 FMH LTH FROM R.U. LTH           R4 S2622500
         TM    FMHBYTE1-FMHDSECT(R14),FMHCNCAT TEST FMH CONCATENATED R4 S2623000
         LA    R14,0(R1,R14)       ADD FMH LENGTH TO R.U. ADDRESS    R4 S2623500
         BO    SKIP520             LOOP BACK IF MORE FM HEADERS      R4 S2624000
         SPACE 1                                                     R4 S2624500
*                                                                    R4 S2625000
*                             R.U. ALTERNATE CODE TRANSLATION        R4 S2625500
*                                                                    R4 S2626000
         SPACE 1                                                     R4 S2626500
MVRPLALT LTR   R0,R0               TEST LENGTH OF R.U. DATA          R4 S2627000
         BNP   MVRPLCHN            BYPASS TRANSLATE IF NO DATA       R4 S2627500
         OI    RPLRH3,RPLCSI       TURN ON ALTERNATE CODE BIT IN RH  R4 S2628000
         BCTR  R0,0                ADJUST TRUE LENGTH TO MACHINE LTH R4 S2628500
         LA    R1,255              LOAD MAX LTH FOR SINGLE EXECUTE   R4 S2629000
MVRPLAL1 CLR   R1,R0               SEE IF 1 EX WILL COVER ACTUAL LTH R4 S2629500
         BNH   SKIP530             BRANCH IF NOT OR IF JUST MAKES IT R4 S2630000
MVRPLAL2 LR    R1,R0               LOAD REMAINDER FOR LAST EXECUTE   R4 S2630500
SKIP530  EX    R1,MVRPLTRA         EXECUTE TRANSLATE TO SNA ALT CODE R4 S2631000
         BNL   MVRPLCHN            EXIT IF WHOLE BUFFER DONE         R4 S2631500
         LA    R14,256(,R14)       STEP TO NEXT POSITION IN BUFFER   R4 S2632000
         SLR   R0,R1               REDUCE LENGTH BY 256 (R1 = 255,   R4 S2632500
         BCT   R0,MVRPLAL1          +1 FOR BCT) & BRANCH IF PLUS     R4 S2633000
         B     MVRPLAL2            BRANCH TO TRANSLATE LAST BYTE     R4 S2633500
         SPACE 1                                                     R4 S2634000
MVRPLTRA TR    0(*-*,R14),MVPASCII ** EXECUTE ONLY **                R4 S2634500
         SPACE 1                                                     R4 S2635000
MVRPLCHX DC    AL1(RPLFIRST)  *0*  OUT & -EOC = FIRST IN CHAIN       R4 S2635500
         DC    AL1(ICEINCHN)                  = IN  & -EOC (EXCL.OR) R4 S2636000
         DC    AL1(RPLONLY)   *2*  OUT &  EOC = ONLY IN CHAIN        R4 S2636500
         DC    AL1(ICEOCPND)                  = OUT & -EOC (EXCL.OR) R4 S2637000
         DC    AL1(RPLMIDLE)  *4*  IN  & -EOC = MIDDLE IN CHAIN      R4 S2637500
         DC    AL1(0)                         = IN  & -EOC (EXCL.OR) R4 S2638000
         DC    AL1(RPLLAST)   *6*  IN  &  EOC = LAST IN CHAIN        R4 S2638500
         DC    AL1(ICEINCHN+ICEOCPND)         = OUT & -EOC (EXCL.OR) R4 S2639000
         EJECT                                                       R4 S2639500
*                                                                    R4 S2640000
*                             SET R.U. CHAIN POSITION, UPDATE STATE  R4 S2640500
*                                                                    R4 S2641000
         SPACE 2                                                     R4 S2641500
MVRPLCHN LA    R15,MVRPLCHX(R15)   USING OLD CHAIN STATE AS INDEX    R4 S2642000
         MVC   RPLCHN,0(R15)        INTO TRANSITION TABLE, SET R.U.  R4 S2642500
         XC    ICESNDST,1(R15)       CHAIN POSITION AND NEW STATE    R4 S2643000
         SPACE 1                                                     R4 S2643500
MVRPLOCR LH    R1,ICEOUTCT         INCREMENT                         R4 S2644000
         LA    R1,1(,R1)            OUTBOUND                         R4 S2644500
         STH   R1,ICEOUTCT           CIRCULATION                     R4 S2645000
         SPACE 1                                                     R4 S2645500
MVRPLRQN MVI   RPLSEQTP,VSEQSEND   SET 'SEND' CONTROL SEQUENCE       R4 S2646000
         MVI   RPLREQ,RPLSNDCD     SET RPL REQUEST TYPE TO 'SEND'    R4 S2646500
         SPACE 3                                                     R4 S2647000
*                                                                    R4 S2647500
*        ATTEMPT TO QUEUE RPL TO ICE OUTBOUND QUEUE                  R4 S2648000
*                                                                    R4 S2648500
         SPACE 2                                                     R4 S2649000
MVRPLQOB MVC   RPLDCT+1(3),ICELDCT+1  MOVE LINE DCT ADDRESS TO RPL   R4 S2649500
         ST    MICE,RPLICE         STORE ICE ADDRESS IN RPL          R4 S2650000
         L     R0,ICECID           GET SESSION COMMUNICATION ID      R4 S2650500
         ST    R0,RPLARG           STORE IN RPL ARG FIELD            R4 S2651000
         L     R15,ICEOUTBF        TEST OUTBOUND CIRCULATION         R4 S2651500
         O     R15,ICEOUTHD         FOR ANY CURRENT ACTIVITY         R4 S2652000
         BZ    MVRPLXIN            EXECUTE THIS REQUEST IF NONE      R4 S2652500
         LA    R1,0(,MBUF)         MOVE BUF ADDR TO 'NEW TAIL' REG.  R4 S2653000
         L     MBUF,RPLNEXT        GET NEXT BUFFER ADDRESS IN CHAIN  R4 S2653500
         SPACE 1                                                     R4 S2654000
MVRPLQHD LM    R14,R15,ICEOUTHD    PICK UP OUTBOUND QUEUE POINTERS   R4 S2654500
MVRPLQH1 LA    R0,ICEOUTHD         LOAD 'END OF QUEUE' SPECIAL VALUE R4 S2655000
         LTR   R14,R14             TEST OLD HEAD ELEMENT ADDRESS     R4 S2655500
         ST    R0,RPLNEXT-RPLDSECT(,R1)  STORE Q-END VALUE IN NEW BF R4 S2656000
         BZ    MVRPLQUP            BRANCH IF QUEUE WAS EMPTY         R4 S2656500
         USING RPLDSECT,R15        USE TEMPORARY RPL ADDRESSABILITY  R4 S2657000
         CS    R0,R1,RPLNEXT       CHAIN NEW BUF TO OLD TAIL ELEMENT R4 S2657500
         LR    R0,R14              NEW HEAD ELEM. = OLD HEAD ELEM.   R4 S2658000
         BE    MVRPLQU1            CONTINUE IF UPDATE SUCCESSFUL     R4 S2658500
         B     MVRPLQHD            ELSE START OVER FROM BEGINNING    R4 S2659000
         DROP  R15                 DISCARD TEMP RPL ADDRESSABILITY   R4 S2659500
         SPACE 1                                                     R4 S2660000
MVRPLQUP LR    R0,R1               IF QUE EMPTY, NEW HEAD = NEW TAIL R4 S2660500
MVRPLQU1 CDS   R14,R0,ICEOUTHD     UPDATE OUTBOUND QUEUE POINTERS    R4 S2661000
         BER   ML                  RETURN TO CALLER IF SUCCESSFUL    R4 S2661500
         LTR   R14,R14            QUEUE EMPTY..                @OZ46363 S2661600
         BZ    MVRPLQUP             YES, BRANCH ....           @OZ46363 S2661700
         LR    R0,R14              NO, POINT TO FIRST BUFFER   @OZ46363 S2661800
         B     MVRPLQU1             AND RETRY                  @OZ46363 S2662000
         EJECT                                                       R4 S2662500
*                                                                    R4 S2663000
*        EXECUTE THE RPL - PASS IT TO VTAM                           R4 S2663500
*                                                                    R4 S2664000
         SPACE 1                                                     R4 S2664500
MVRPLXIN TM    ICESTAT,ICEABORT    TEST SESSION STATUS               R4 S2665000
         BO    MVFREEOQ            DISCARD ALL BUFFERS IF ABORTING   R4 S2665500
         ST    MBUF,ICEOUTBF       SAVE ADDR OF CURRENT OUTB BUFF    R4 S2666000
         SPACE 1                                                     R4 S2666500
MVRPLXBR OI    RPLEXTDS,RPLBRANC   FORCE BRANCH ENTRY (FAST PATH)      CS2667000
                                    FOR SEND/RESETSR/RECEIVE-ANY     R4 S2667500
         SPACE 1                                                     R4 S2668000
MVRPLXEC L     R15,=A(VEXITRPL)    SET RPL EXIT                      R4 S2668500
         ST    R15,RPLECB           ROUTINE ADDRESS                  R4 S2669000
         OI    RPLEXTDS,RPLEXIT    SHOW EXIT IS PRESENT              R4 S2669500
         ST    SAVE,RPLPCE         SAVE PCE ADDRESS IN RPL           R4 S2670000
         OI    RPLFLAG2,RPLSREGS   INDICATE RPLSAVEA IN USE    @OZ57933 S2670100
         SLR   R0,R0               CLEAR REQ TYPE PARAMETER REG      R4 S2670500
         LR    R1,MBUF             PLACE BUFFER ADDR IN R1 FOR VTAM  R4 S2671000
         L     MBUF,RPLNEXT        GET NEXT BUFFER ADDRESS ON CHAIN  R4 S2671500
         DROP  MBUF                TEMPORARILY CHANGE BASE           R4 S2672000
         USING RPLDSECT,R1          FOR RPL ADDRESSABILITY           R4 S2672500
         MVI   RPLOPT1,RPLSEQ+RPLASY  INDICATE ASYNCHRONOUS REQUEST  R4 S2673000
         IC    R0,RPLREQ           PICK UP REQUEST TYPE FROM RPL     R4 S2673500
         L     R14,RPLDACB         GET ADDRESS OF ACB                R4 S2674000
         USING ACBDSECT,R14        USE TEMPORARY ACB ADDRESSABILITY  R4 S2674500
         LA    R13,RPLSAVEA        GET SAVEAREA ADDR FOR VTAM        R4 S2675000
         L     R15,ACBINRTN        GET ADDR OF INTERFACE ROUTINE     R4 S2675500
         BALR  R14,R15             LINK TO THE INTERFACE ROUTINE     R4 S2676000
         L     SAVE,RPLPCE         RESTORE PCE ADDRESS         @OZ57933 S2676100
         LA    SAVE,0(,SAVE)       CLEAR HI ORDER BYTE         @OZ57933 S2676500
         LTR   R15,R15             CHECK FOR SUCCESSFUL COMPLETION   R4 S2677000
         BZR   ML                  RETURN TO CALLER IF ACCEPTED      R4 S2677500
         EJECT                                                       R4 S2678000
*                                                                    R4 S2678500
*        QUEUE RETRIES TO THE LINE MANAGER                           R4 S2679000
*                                                                    R4 S2679500
         SPACE 1                                                     R4 S2680000
         CL    R15,=F'4'           TEST GENERAL RETURN CODE          R4 S2680500
         BE    MVRPLRTN            IF OK, CHECK RETURN CODE    @OZ52502 S2681000
MVRPLERR BAL   R8,R01              DISASTER XIT - ACB NOT OPN  @OZ52502 S2681300
MVRPLRTN DS    0H                                              @OZ52502 S2681400
         CL    R0,=A(USFLOGIC)     TEST RECOVERY ACTION RETURN CODE  R4 S2681500
         BNL   MVRPLERR            DISASTER XIT - LOGIC ERROR  @OZ52502 S2682000
         L     R0,$RJECHEQ         PICK UP LINE MANAGER BUFF QUEUE   R4 S2682500
SKIP540  ST    R0,RPLNEXT          ATTEMPT TO CHAIN                  R4 S2683000
         CS    R0,R1,$RJECHEQ       RETRY RPL TO QUEUE               R4 S2683500
         BNE   SKIP540             RETRY IF UNSUCCESSFUL             R4 S2684000
         SPACE 3                                                     R4 S2684500
*                                                                    R4 S2685000
*        POST THE LINE MANAGER FOR WORK                              R4 S2685500
*                                                                    R4 S2686000
         SPACE 1                                                     R4 S2686500
         L     R14,RPLDACB         RESTORE ACB ADDRESS               R4 S2687000
         L     R14,ACBLNDCT        GET ADDRESS OF LOGON DCT          R4 S2687500
         USING DCTDSECT,R14        TEMPORARY DCT ADDRESSABILITY      R4 S2688000
         L     R15,DCTPCE          GET LINE MANAGER PCE ADDRESS      R4 S2688500
         $POST (R15),WORK          POST THE LINE MANAGER FOR WORK    R4 S2689000
         BR    ML                  RETURN TO CALLER                  R4 S2689500
         DROP  R14                 DISCARD LOGON DCT ADDRESSABILITY  R4 S2690000
         DROP  R1                  RE-ESTABLISH NORMAL BASE          R4 S2690500
         USING RPLDSECT,MBUF        FOR RPL ADDRESSABILITY           R4 S2691000
         EJECT                                                       R4 S2691500
*                                                                    R4 S2692000
*                             CHECK IF OUTBOUND QE NEEDS RESTARTING  R4 S2692500
*                                                                    R4 S2693000
         SPACE 1                                                     R4 S2693500
MVRPLKOQ DS    0H                  ROUTINE EXPECTS R0 TO BE ZERO     R4 S2694000
         CL    R0,ICEOUTBF         COMPARE 0 & ADDR OF BUF IN VTAM   R4 S2694500
         BNER  ML                  EXEC-RPL NOT NEEDED IF ONE ACTIVE R4 S2695000
         CL    R0,ICEOUTHD         COMPARE 0 & 1ST ADDR ON OUTBD QUE R4 S2695500
         BER   ML                  RETURN IF OUTBD QUEUE EMPTY       R4 S2696000
         TM    ICESTAT,ICEABORT+ICECLOSE  TEST SESSION STATUS        R4 S2696500
         BNZ   MVFREEOQ            GO FREE OUTBD QUEUE IF ABORTING   R4 S2697000
         LR    R1,MBUF             SAVE CURRENT BUFFER POINTER       R4 S2697500
         L     MBUF,ICEOUTHD       GET ADDR OF 1ST BUF ON OUTBOUND Q R4 S2698000
         L     R14,RPLNEXT         GET NEXT BUFFER POINTER           R4 S2698500
         ST    R1,RPLNEXT          CHAIN CURR BUF SO XEC-RPL POPS IT R4 S2699000
         LA    R15,ICEOUTHD        LOAD SPECIAL VALUE TO CHECK Q END R4 S2699500
         ST    R14,ICEOUTHD        PROMOTE NEXT BUFFER TO HEAD OF Q  R4 S2700000
         CLR   R14,R15             COMPARE CHAIN PTR & SPECIAL VALUE R4 S2700500
         BNE   SKIP550             BRANCH IF THIS BUFFER NOT LAST    R4 S2701000
         XC    ICEOUTHD(8),ICEOUTHD  ELSE CLEAR OUTBD QUEUE POINTERS R4 S2701500
         B     MVRPLXIN            GO EXECUTE RPL                    R4 S2702000
         SPACE 1                                                     R4 S2702500
         USING RPLDSECT,R14        USE TEMPORARY RPL ADDRESSABILITY  R4 S2703000
SKIP550  C     R15,RPLNEXT         COMPARE SPEC. VALUE & 2ND CHN PTR R4 S2703500
         BNE   MVRPLXIN            GO EXEC RPL IF NEW HEAD NOT LAST  R4 S2704000
         ST    R14,ICEOUTTL        ELSE NEW HEAD IS ALSO NEW TAIL    R4 S2704500
         B     MVRPLXIN            GO EXEC RPL AND RETURN TO CALLER  R4 S2705000
         DROP  R14                 DISCARD TEMP. RPL ADDRESSABILITY  R4 S2705500
         EJECT                                                       R4 S2706000
*                                                                    R4 S2706500
*                             MVRPLGET - GET VTAM RPL BUFFER         R4 S2707000
*                                                                    R4 S2707500
         SPACE 1                                                     R4 S2708000
MVRPLNO  ST    ML,DCTEWF           SAVE RETURN ADDR ACROSS WAIT      R4 S2708500
        $WAIT  BUF,SAVE=NO,INHIBIT=NO  WAIT FOR AVAILABLE BUFFERS    R4 S2709000
        $RESTORE                   RESTORE ACCESS METHOD REGISTERS   R4 S2709500
         L     ML,DCTEWF           RESTORE RETURN ADDRESS            R4 S2710000
         TM    ICESNDST,ICECNCEL   TEST SESSION SEND STATUS          R4 S2710500
         BO    MVREQCAN            ABORT $EXTP CALL IF CHAIN CANCEL  R4 S2711000
         SPACE 1                                                     R4 S2711500
MVRPLGET $GETBUF MVRPLNO,TYPE=VTAM GET A VTAM RPL BUFFER             R4 S2712000
         MVI   RPLREQ-RPLDSECT(R1),RPLSNDCD  SET REQ TYPE TO 'SEND'  R4 S2712500
         MVI   RPLSRTYP-RPLDSECT(R1),RPLNFSYN STYPE = REQUEST  @OZ32746CS2712600
                                   RTYPE = NDFSYN,NDFASY,NRESP @OZ32746 S2712700
         L     R15,ICEADCT         GET LOGON DCT ADDRESS             R4 S2713000
         L     R15,DCTACB-DCTDSECT(,R15)  STORE ADDRESS              R4 S2713500
         ST    R15,RPLDACB-RPLDSECT(,R1)   OF ACB IN RPL             R4 S2714000
         LA    R15,RPLNEXT         POINT TO POSSIBLE BUF CHAIN FIELD R4 S2714500
         LTR   MBUF,MBUF           TEST CURRENT BUFFER ADDRESS       R4 S2715000
         BNZ   SKIP560             BRANCH IF BUFFER ALREADY PRESENT  R4 S2715500
         LR    MBUF,R1             ELSE NEW BUFFER IS CURRENT BUFFER R4 S2716000
         LA    R15,DCTBUFAD        POINT TO DCT BUF CHAIN ANCHOR     R4 S2716500
SKIP560  ST    R1,0(,R15)          STORE NEW BUFFER ADDRESS          R4 S2717000
         BR    ML                  RETURN TO CALLER                  R4 S2717500
         EJECT                                                       R4 S2718000
*                                                                    R4 S2718500
*                   PURGE SESSION'S RPLS ON REMOTE CONSOLE QUEUE     R4 S2719000
*                                                                    R4 S2719500
         SPACE 2                                                     R4 S2720000
         USING RPLDSECT,R15        USE TEMPORARY RPL ADDRESSABILITY  R4 S2720500
MVFREEIQ LA    R15,$MCONMSG-(TPBLCCAD-BUFDSECT)  SIMULATE BISYNC BUF R4 S2721000
         SPACE 1                                                     R4 S2721500
MVFREEC1 LA    R14,TPBLCCAD-BUFDSECT(,R15) POINT TO BISYNC CHAIN FLD R4 S2722000
         SPACE 1                                                     R4 S2722500
MVFREEC2 L     R15,0(,R14)         GET ADDR OF NEXT BUFFER ON QUE    R4 S2723000
         SPACE 1                                                     R4 S2723500
MVFREEC3 LTR   R0,R15              SAVE COPY, TEST BUFFER ADDRESS    R4 S2724000
         BZ    MVFREEC4            FREE INTERCEPTED RPLS IF AT Q END R4 S2724500
         TM    RPLTYPE,BUFTP+BUFRPL  TEST TP BUFFER TYPE            R41 S2725000
         BNO   MVFREEC1            GET NEXT BUFFER IF BSC           R41 S2725500
         LR    R1,R14              SAVE PTR TO PREDECESSOR CHAIN FLD R4 S2726000
         LA    R14,RPLNEXT         POINT TO SNA RPL CHAIN FIELD      R4 S2726500
         CL    MICE,RPLICE         CHECK ASSOCIATED SESSION          R4 S2727000
         BNE   MVFREEC2            GET NEXT BUFFER IF NOT THIS ICE   R4 S2727500
         L     R15,0(,R14)         REMOVE INTERCEPTED BUFFER         R4 S2728000
         ST    R15,0(,R1)           FROM REMOTE CONSOLE QUEUE        R4 S2728500
         ST    MBUF,0(,R14)        JOIN TO REST OF                   R4 S2729000
         LR    MBUF,R0              RPLS BEING FREED                 R4 S2729500
         B     MVFREEC3            LOOP BACK TO CHECK FOR QUE END    R4 S2730000
         SPACE 1                                                     R4 S2730500
MVFREEC4 LTR   R14,MBUF            TEST 1ST INTERCEPTED RPL ADDRESS  R4 S2731000
         BZ    MVFREEI1            GO FREE INBOUND QUE IF NONE       R4 S2731500
         L     R15,ICEINTL         ELSE LOAD AND TEST ADDRESS        R4 S2732000
         LTR   R15,R15              OF LAST RPL ON INBOUND QUE       R4 S2732500
         BZ    MVFREEI2            GO FREE INTERCEPTEDS IF QUE EMPTY R4 S2733000
         ST    MBUF,RPLNEXT        ELSE ADD INTERCEPTEDS TO INBD QUE R4 S2733500
         DROP  R15                 DISCARD TEMP RPL ADDRESSABILITY   R4 S2734000
         SPACE 2                                                     R4 S2734500
*                             FREE ICE INBOUND QUEUE                 R4 S2735000
         SPACE 1                                                     R4 S2735500
MVFREEI1 L     R14,ICEINHD         GET ADDR OF 1ST BUF ON INBND QUE  R4 S2736000
         USING RPLDSECT,R14        USE TEMPORARY RPL ADDRESSABILITY  R4 S2736500
         LTR   MBUF,R14            SAVE AND TEST BUFFER ADDRESS      R4 S2737000
         BZR   ML                  RETURN IF NOTHING TO FREE         R4 S2737500
         SLR   R15,R15             CLEAR R15 FOR NUMBER OF BUFFERS   R4 S2738000
         SPACE 1                                                     R4 S2738500
MVFREEI2 L     R14,RPLNEXT         GET ADDR OF NEXT BUFFER IF ANY    R4 S2739000
         BCTR  R15,0               COUNT A BUFFER                    R4 S2739500
         LTR   R14,R14             TEST IF ANOTHER PRESENT           R4 S2740000
         BNZ   MVFREEI2            LOOP UNTIL ALL EXHAUSTED          R4 S2740500
         L     R1,ICEINLM          UPDATE COUNT OF INBOUND           R4 S2741000
SKIP570  LA    R0,0(R15,R1)         DATA & SYNCH DFC'S ON ICE        R4 S2741500
         CS    R1,R0,ICEINLM         INBND QUE AND L.M. WORK QUE     R4 S2742000
         BNE   SKIP570             RETRY UNTIL SUCCESSFUL            R4 S2742500
         XC    ICEINHD(8),ICEINHD  CLEAR INBOUND QUEUE POINTERS      R4 S2743000
         B     MVFREPRG            FREE ALL UNHOOKED BUFS & RETURN   R4 S2743500
         DROP  R14                 DISCARD TEMP RPL ADDRESSABILITY   R4 S2744000
         EJECT                                                       R4 S2744500
*                                                                    R4 S2745000
*                             FREE ICE OUTBOUND QUEUE                R4 S2745500
*                                                                    R4 S2746000
         SPACE 1                                                     R4 S2746500
MVFREEOQ SLR   R0,R0               GET DOUBLE ZERO                   R4 S2747000
         SLR   R1,R1                FOR COMPARE & SWAP               R4 S2747500
         LM    R14,R15,ICEOUTHD    UNHOOK                            R4 S2748000
SKIP580  CDS   R14,R0,ICEOUTHD      OUTBOUND                         R4 S2748500
         BNE   SKIP580               QUEUE                           R4 S2749000
         LTR   MBUF,MBUF           TEST CURRENT BUFFER ADDRESS       R4 S2749500
         BZ    SKIP590             BRANCH IF NONE                    R4 S2750000
         ST    R14,RPLNEXT         MAKE CURRENT BUFFER APPEAR        R4 S2750500
         LR    R14,MBUF             TO BE 1ST ON OUTBOUND QUEUE      R4 S2751000
         LTR   R15,R15             MAKE CURRENT BUFFER APPEAR        R4 S2751500
         BNZ   SKIP590              TO BE LAST ON OUTBOUND QUE       R4 S2752000
         LR    R15,R14               IF REAL QUEUE WAS EMPTY         R4 S2752500
SKIP590  LTR   MBUF,R14            TEST 1ST UNHOOKED BUFFER ADDRESS  R4 S2753000
         LH    R1,ICEOUTCT         GET OUTBOUND CIRCULATION COUNT    R4 S2753500
         BNZ   SKIP592             GO FREE OUTBOUND QUEUE      @OZ44972 S2754000
         LTR   R1,R1               IS ICEOUTCT ZERO...         @OZ44972 S2754050
         BNZ   MVFREREQ            NO, REQUEUE ICEOUTBF        @OZ44972 S2754100
         BR    ML                  NO BUFFERS TO FREE, RETURN  @OZ44972 S2754150
SKIP592  DS    0H                                              @OZ44972 S2754400
         ST    R0,RPLNEXT-RPLDSECT(,R15)  CLEAR END-Q SPECIAL VALUE  R4 S2754500
         SPACE 1                                                     R4 S2755000
         USING RPLDSECT,R14        USE TEMPORARY RPL ADDRESSABILITY  R4 S2755500
MVFREEOT TM    RPLSRTYP,RPLSRESP   TEST SEND TYPE                    R4 S2756000
         BO    MVFRERSP            GO CHANGE INBOUND CT IF RESPONSE  R4 S2756500
         BCTR  R1,0                DECREMENT OUTBOUND CIRCULATION    R4 S2757000
         CLC   RPLCNTDF(3),MSNADATA  TEST R.U. TYPE                  R4 S2757500
         BNE   MVFREEOX            DON'T ADJUST COUNT IF SYNCH DFC   R4 S2758000
         TM    RPLCHN,RPLLAST+RPLONLY  TEST R.U. CHAIN POSITION      R4 S2758500
         BZ    MVFREEOX            NO ADJUST IF NOT END OF CHAIN     R4 S2759000
         IC    R0,ICERSPCT         DECREMENT                         R4 S2759500
         BCTR  R0,0                 OVERLAPPING                      R4 S2760000
         STC   R0,ICERSPCT           CHAIN COUNT                     R4 S2760500
         SPACE 1                                                     R4 S2761000
MVFREEOX ICM   R14,15,RPLNEXT      GET NEXT UNHOOKED BUFFER          R4 S2761500
         BNZ   MVFREEOT            LOOP BACK IF NOT END OF CHAIN     R4 S2762000
         STH   R1,ICEOUTCT         REPLACE OUTBD CIRCULATION COUNT   R4 S2762500
MVFREREQ DS    0H                                              @OZ44972 S2762900
         L     MDCT,ICEADCT        LOAD LOGON DCT ADDRESS      @OZ44972 S2763000
         TM    MDCTSTAT-DCTDSECT(MDCT),DCTABORT   ABORTING...  @OZ44972 S2763050
         BZ    MVFREPRG                      NO,FREE THE RPL   @OZ44972 S2763100
         LTR   R1,R1               IS OUTPUT COUNTER ZERO...   @OZ44972 S2763150
         BZ    MVFREPRG            YES, FREE ICEOUTHD QUEUE    @OZ44972 S2763200
         CLI   RPLACTIV,X'80'      RPL ON $RJECHEQ...          @OZ44972 S2763250
         BE    MVFREPRG            YES, DON'T REQUEUE          @OZ44972 S2763300
         L     R14,ICEOUTBF        GET CURRENT BUFFER ADDRESS  @OZ44972 S2763350
         MVI   RPLRTNCD,USFDAMGE   SIMULATE CANCELLED BY       @OZ44972 S2763400
         MVI   RPLFDB2,USFCLOCC      CLOSE RETURN CODE AND     @OZ44972 S2763450
         L     R1,$RJECHEQ             REQUE CURRENT           @OZ44972 S2763500
SKIP595  ST    R1,RPLNEXT                BUFFER ON             @OZ44972 S2763550
         CS    R1,R14,$RJECHEQ             $RJECHEQ            @OZ44972 S2763600
         BNE   SKIP595             RETRY UNTIL SWAPPED         @OZ44972 S2763650
         B     MVFREPRG            GO FREE ICEOUTHD QUEUE      @OZ44972 S2763700
MVFRERSP STH   R1,ICEOUTCT         FREE UP R1 FOR 'CS' USE           R4 S2764000
         L     R0,ICEINLM          DECREMENT                         R4 S2764500
SKIP600  LR    R1,R0                INBOUND DATA                     R4 S2765000
         BCTR  R1,0                  + SYNCH DFC                     R4 S2765500
         CS    R0,R1,ICEINLM          OUTSTANDING                    R4 S2766000
         BNE   SKIP600                 REQUEST COUNT                 R4 S2766500
         LH    R1,ICEOUTCT         RELOAD OUTBOUND COUNT             R4 S2767000
         B     MVFREEOX             AND RESUME LOOP                  R4 S2767500
         DROP  R14                 DISCARD TEMP. RPL ADDRESSABILITY  R4 S2768000
         EJECT                                                       R4 S2768500
         SPACE 3                                                     R4 S2769000
*                                                                    R4 S2769500
*                             FREE 1 BUFFER FROM INBOUND CYCLE       R4 S2770000
*                                                                    R4 S2770500
         SPACE 2                                                     R4 S2771000
MVFRELBF L     R15,RPLNEXT         GET ADDR OF NEXT BUF ON CHAIN     R4 S2771500
         SLR   R0,R0               GET ZERO                          R4 S2772000
         ST    R15,DCTBUFAD        POP NEXT BUF ADDR INTO DCT        R4 S2772500
         ST    R0,RPLNEXT          CLEAR BUFFER CHAIN FIELD          R4 S2773000
         SPACE 2                                                     R4 S2773500
MVFRESPD TM    RPLVTFL2,RPLEX      TEST TYPE OF RESPONSE REQUESTED   R4 S2774000
         BO    MVFREEIN            FREE IF EXCEPTION RESPONSES ONLY  R4 S2774500
         SPACE 1                                                     R4 S2775000
MVFRESPN MVI   RPLSRTYP,RPLSRESP+RPLNFSYN  SET STYPE = RESP &  @OZ32746CS2775500
                                   RTYPE = NDFSYN,NDFASY,NRESP @OZ32746 S2775600
         TM    RPLVTFL2,RPLNFME    TEST TYPE OF RESPONSE REQUESTED   R4 S2776000
         BZ    MVRPLRQN            GO SEND IF DEFINITE RESPONSE 1    R4 S2776500
         TM    RPLVTFL2,RPLRRN     TEST TYPE OF RESPONSE REQUESTED   R4 S2777000
         BO    MVRPLRQN            GO SEND IF DEFINITE RESPONSE 2    R4 S2777500
         SPACE 2                                                     R4 S2778000
MVFREEIN TM    RPLSRTYP,RPLDFASY   TEST TYPE OF R.U. BEING FREED     R4 S2778500
         BO    MVFREPRG            SKIP RESETSR CHECK IF NOT 'DFSYN' R4 S2779000
         SPACE 1                                                     R4 S2779500
         L     R0,ICEINLM          DECREMENT COUNT OF INBOUND,       R4 S2780000
SKIP610  LR    R1,R0                OUTSTANDING DATA OR SYNCHR.      R4 S2780500
         BCTR  R1,0                  DATA FLOW CONTROL RPLS, ON      R4 S2781000
         CS    R0,R1,ICEINLM          ICE INBND Q OR L.M. WORK Q     R4 S2781500
         BNE   SKIP610             RETRY IF UNSUCCESSFUL             R4 S2782000
         TM    ICESTAT,ICERCVSP    TEST SESSION STATUS               R4 S2782500
         BZ    MVFREPRG            SKIP RESETSR CHECK IF NOT CS MODE R4 S2783000
         SPACE 1                                                     R4 S2783500
         SRL   R0,17               HALVE INBOUND LIMIT VALUE        R41 S2784000
         N     R1,=X'0000FFFF'     TRIM CURRENT COUNT VALUE         R41 S2784200
         CLR   R1,R0               COMPARE 1/2 COUNT WITH LIMIT     R41 S2784500
         BH    MVFREPRG            IF CNT GT 1/2 OF LMT, STILL      R41CS2785000
                                    CONGESTED - DON'T 'RESETSR' YET  R4 S2785500
         SPACE 1                                                     R4 S2786000
         NI    ICESTAT,255-ICERCVSP  RESET 'CONTINUE SPECIFIC' FLAG R41 S2786100
         MVI   RPLREQ,RPLRSRCD     SET 'RESETSR' CODE IN RPL         R4 S2786500
         NI    RPLOPT5,255-RPLDLGIN  FORCE OPTCD = CA                R4 S2787000
         MVI   RPLSRTYP,0          SET RTYPE = (NDFASY,NRESP,DFSYN)  R4 S2787500
         MVI   RPLSEQTP,VSEQRSCA   PRESET LINE MANAGER SEQUENCE TYPE R4 S2788000
         MVC   RPLDCT+1(3),ICELDCT+1 MOVE LINE ADDR TO RPL     @OZ51016 S2788100
         ST    MICE,RPLICE         STORE ICE ADDR IN RPL       @OZ51016 S2788200
         L     R0,ICECID           GET SESSION COMMUN. ID      @OZ51016 S2788300
         ST    R0,RPLARG            STORE IT IN RPL            @OZ51016 S2788400
         B     MVRPLXBR            EXEC RPL AND RETURN         @OZ51016 S2788500
         EJECT                                                       R4 S2789000
         SPACE 3                                                     R4 S2789500
*                                                                    R4 S2790000
*                             CHECK RECEIVE-ANY LEVEL FROM LINE MGR  R4 S2790500
*                                                                    R4 S2791000
         SPACE 2                                                     R4 S2791500
MVFREELM LA    MBUF,0(,MBUF)       PURIFY AND TEST                   R4 S2792000
         LTR   MBUF,MBUF            BUFFER ADDRESS                   R4 S2792500
         BNZ   MVFREPR1            REJOIN COMMON LOGIC IF HAVE BUFF  R4 S2793000
         L     R15,ICEADCT         GET APPL LOGON DCT ADDRESS        R4 S2793500
         SPACE 1                                                     R4 S2794000
         USING DCTDSECT,R15        USE TEMP LOGON DCT ADDRESSABILITY R4 S2794500
MVFRECHK CLC   MDCTRALM,MDCTRACT   COMPARE ACTIVE LIMIT & ACTIVE CNT R4 S2795000
         BNHR  ML                  RETURN IF ENOUGH RECEIVE-ANY'S UP R4 S2795500
         TM    MDCTSTAT,DCTSINON+DCTSOFF  TEST LOGON DCT STATUS      R4 S2796000
         BNMR  ML                  LET RCV-ANY'S QUIESCE IF INACTIVE R4 S2796500
         TM    MDCTSTAT,DCTABORT   TEST FOR ABORT              @OZ38130 S2796600
         BOR   ML                  YES,RETURN                  @OZ38130 S2796700
         SPACE 1                                                     R4 S2797000
         L     WA,DCTACB           SAVE ACB ADDRESS ACROSS $GETBUF   R4 S2797500
         DROP  R15                 DISCARD LOGON DCT ADDRESSABILITY  R4 S2798000
         SPACE 1                                                     R4 S2798500
        $GETBUF TYPE=VTAM          TRY TO GET BUFFER FOR RECEIVE-ANY R4 S2799000
         BZR   ML                  IT'S OK IF CAN'T GET BUF - RETURN R4 S2799500
         LA    MBUF,0(,R1)         LOAD PURIFIED BUFFER ADDRESS      R4 S2800000
         ST    WA,RPLDACB          STORE ACB ADDRESS IN RPL          R4 S2800500
         L     R14,=X'01000000'    LOAD CONSTANT FOR Q COUNT UPDATES R4 S2801000
         L     R15,ACBLNDCT-ACBDSECT(,WA)  GET APPL LOGON DCT ADDR   R4 S2801500
         B     MVFRECQE            UPDATE ACTIVE CNT & EXEC RECV-ANY R4 S2802000
         SPACE 3                                                     R4 S2802500
*                                                                    R4 S2803000
*                             FREE 1 BUFFER FROM OUTBOUND CYCLE      R4 S2803500
*                                                                    R4 S2804000
         SPACE 1                                                     R4 S2804500
MVFREOUT L     R15,RPLNEXT         GET ADDR OF NEXT BUF ON CHAIN     R4 S2805000
         SLR   R0,R0               GET ZERO                          R4 S2805500
         ST    R15,DCTBUFAD        POP NEXT BUF ADDR INTO DCT        R4 S2806000
         ST    R0,RPLNEXT          CLEAR BUFFER CHAIN FIELD          R4 S2806500
         EJECT                                                       R4 S2807000
         SPACE 3                                                     R4 S2807500
*                                                                    R4 S2808000
*                                                                    R4 S2808500
*                             PURGE 0 OR MORE VTAM RPL BUFFERS       R4 S2809000
*                                                                    R4 S2809500
         SPACE 2                                                     R4 S2810000
MVFREPRG LA    MBUF,0(,MBUF)       PURIFY AND TEST                   R4 S2810500
MVFREPR0 LTR   MBUF,MBUF            BUFFER ADDRESS                   R4 S2811000
         BZR   ML                  RETURN IF NO MORE BUFFERS TO FREE R4 S2811500
         SPACE 1                                                     R4 S2812000
MVFREPR1 L     R15,RPLDACB         GO THROUGH                        R4 S2812500
         USING ACBDSECT,R15         ACB TO GET                       R4 S2813000
         L     R15,ACBLNDCT          APPL LOGON DCT                  R4 S2813500
         USING DCTDSECT,R15           ADDRESSABILITY                 R4 S2814000
         TM    MDCTSTAT,DCTSINON+DCTSOFF  TEST LOGON DCT STATUS      R4 S2814500
         BNM   MVFREPR2            BYPASS BUF RECYCLING IF INACTIVE  R4 S2815000
         TM    MDCTSTAT,DCTABORT   TEST FOR ABORT IN PROGRESS  @OZ38130 S2815100
         BO    MVFREPR2            YES,BYPASS BUFFER RECYCLIN  @OZ38130 S2815200
         L     R14,=X'01000000'    LOAD CONSTANT FOR Q COUNT UPDATES R4 S2815500
         CLC   MDCTRALM,MDCTRACT   COMPARE ACTIVE LIMIT & ACTIVE CNT R4 S2816000
         BH    MVFRECQE            BRANCH IF NEED ACTIVE RECEIVES    R4 S2816500
         CLC   MDCTRQLM,MDCTRQCT   COMPARE AHEAD QUE LIMIT VS. COUNT R4 S2817000
         BH    MVFRECQ0            BR IF AHEAD QUEUE NEEDS BUFFERS   R4 S2817500
         SPACE 1                                                     R4 S2818000
MVFREPR2 LR    R1,MBUF             COPY BUF ADDR TO R1 FOR $FREEBUF  R4 S2818500
         L     MBUF,RPLNEXT        GET NEXT BUF ON CHAIN BEING FREED R4 S2819000
        $FREEBUF (R1)              FREE THE RPL BUFFER               R4 S2819500
         B     MVFREPRG            LOOP UNTIL BUF CHAIN EXHAUSTED    R4 S2820000
         SPACE 2                                                     R4 S2820500
MVFRECQE OR    MBUF,R14            PREPARE TO INCREMENT ACTIVE COUNT R4 S2821000
MVFRECQ0 OI    RPLOPT5,RPLNODE     SET OPTCD = ANY (ALL TERMINALS)   R4 S2821500
         OI    RPLOPT7,RPLQOPT     SET OPTCD = Q (WAIT IF NO DATA)   R4 S2822000
         MVI   RPLSRTYP,RPLRRESP+RPLDFASY  RTYPE=(DFSYN,DFASY,RESP)  R4 S2822500
         LA    R0,RPLBUFST         GET ADDRESS OF DATA AREA          R4 S2823000
         ST    R0,RPLAREA          STORE IT IN RPL                   R4 S2823500
         LH    R1,$BFSZSNA         INSURE CORRECT              @OZ28434 S2823600
         ST    R1,RPLBUFL            SNA BUFFER SIZE           @OZ28434 S2823700
         MVI   RPLSEQTP,VSEQRECV   SET L.M. SEQUENCE TO NORMAL SEQ   R4 S2824000
         MVI   RPLREQ,RPLRCVCD     SET RPL REQUEST TYPE TO 'RECEIVE' R4 S2824500
         STCM  R15,7,RPLDCT+1      SAVE LOGON DCT ADDR IN RPL        R4 S2825000
         SLR   R0,R0               CLEAR                             R4 S2825500
         ST    R0,RPLICE            ICE POINTER,                     R4 S2826000
         ST    R0,RPLBCHN            RCV-ANY QE BACK-CHAIN ADDR,     R4 S2826500
         ST    R0,RPLRLEN             LENGTH, AND                    R4 S2827000
         STCM  R0,7,RPLCNTDF           R.U. TYPE INDICATORS          R4 S2827500
         L     R0,MDCTRABF         GET RECEIVE Q COUNT & 1ST BUF AD  R4 S2828000
         EJECT                                                       R4 S2828500
         SPACE 3                                                     R4 S2829000
MVFRECQ1 LTR   R1,R0               COPY DATA TO WORK REGISTER        R4 S2829500
         ST    R0,RPLFCHN          JOIN RECEIVE Q TO CURRENT BUFFER  R4 S2830000
         BZ    SKIP620             BYPASS BACK-CHN UPDATE IF 1ST BUF R4 S2830500
         ST    MBUF,RPLBCHN-RPLDSECT(,R1)  BACK-CHAIN Q TO CURR BUF  R4 S2831000
SKIP620  N     R1,=X'FF000000'     ISOLATE RECEIVE QUEUE COUNT       R4 S2831500
         ALR   R1,MBUF             SET NEW 1ST BUF & INCREMENT COUNT R4 S2832000
         CS    R0,R1,MDCTRABF      REPLACE QUEUE COUNT & 1ST BUF AD  R4 S2832500
         BNE   MVFRECQ1            RETRY IF RECEIVE Q UPDATE FAILED  R4 S2833000
         SPACE 1                                                     R4 S2833500
         CLR   MBUF,R14            TEST FOR ACTIVE COUNT INCREMENTED R4 S2834000
         BH    MVFRECVX            BRANCH TO EXEC RECEIVE-ANY IF YES R4 S2834500
         OR    MBUF,R14            PREPARE TO INCREMENT AHEAD COUNT  R4 S2835000
         L     R14,RPLNEXT         GET NEXT BUF OF CHAIN BEING FREED R4 S2835500
         L     R0,MDCTRQBF         GET AHEAD QUE COUNT & 1ST BUF AD  R4 S2836000
         SPACE 1                                                     R4 S2836500
MVFRECQ2 LR    R1,R0               COPY DATA TO WORK REGISTER        R4 S2837000
         ST    R0,RPLNEXT          JOIN AHEAD QUE TO CURRENT BUFFER  R4 S2837500
         N     R1,=X'FF000000'     ISOLATE AHEAD QUEUE COUNT         R4 S2838000
         ALR   R1,MBUF             SET NEW 1ST BUF & INCREMENT COUNT R4 S2838500
         CS    R0,R1,MDCTRQBF      REPLACE QUEUE COUNT & 1ST BUF AD  R4 S2839000
         BNE   MVFRECQ2            RETRY IF AHEAD QUE UPDATE FAILED  R4 S2839500
         SPACE 1                                                     R4 S2840000
         LA    MBUF,0(,R14)        PURIFY NEXT BUFFER ADDRESS        R4 S2840500
         B     MVFREPR0            LOOP TILL BUF CHAIN EXHAUSTED     R4 S2841000
         DROP  R15                 DISCARD LOGON DCT ADDRESSABILITY  R4 S2841500
         SPACE 3                                                     R4 S2842000
MVFRECVX CLM   R14,7,RPLNEXT+1     TEST IF MORE BUFFERS BEING FREED  R4 S2842500
         BE    MVRPLXBR            IF NONE, GO EXEC RCV-ANY & RETURN R4 S2843000
         L     R14,RPLNEXT         GET NEXT BUF ON CHAIN BEING FREED R4 S2843500
         USING RPLDSECT,R14        USE TEMP RPL ADDRESSABILITY       R4 S2844000
         ST    ML,RPLFCHN          SAVE 1ST LEVEL RETURN ADDRESS     R4 S2844500
         DROP  R14                 DISCARD TEMP RPL ADDRESSABILITY   R4 S2845000
         BAL   ML,MVRPLXBR         EXECUTE THE CURRENT RECEIVE-ANY   R4 S2845500
         L     ML,RPLFCHN          RELOAD 1ST LEVEL RETURN ADDRESS   R4 S2846000
         B     MVFREPRG            LOOP UNTIL BUF CHAIN EXHAUSTED    R4 S2846500
         EJECT                                                       R4 S2857500
*                                                                    R4 S2858000
*                             SNA FUNCTION MGMT HEADER BUILD ROUTINE R4 S2858500
*                                                                    R4 S2859000
         SPACE 2                                                     R4 S2859500
MVFMHBDS LA    R1,FMHBEGIN         SET FMH CODE TO 'BEGIN STREAM'    R4 S2860000
MVFMHOPN NI    MDCTFMT,255-DCTPPRES-DCTPCPCT  BAN COMPRESS, COMPACT  R4 S2861000
         LA    WA,ICEBIND          POINT TO BIND IMAGE               R4 S2863000
         USING ISTDBIND,WA         ESTABLISH BIND IMAGE ADDRESSAB'TY R4 S2863500
         OI    ICESTAT,ICEALLOC    MARK ICE ALLOCATED                R4 S2864000
         TM    BINCMNP,BINALT      TEST COMMON PROTOCOL              R4 S2864500
         BO    MVFMHBLD            BRANCH IF ALTERN CODE TO BE USED  R4 S2865000
         TM    BINPRIP,BINPCMP     TEST PRIMARY NAU PROTOCOL         R4 S2865500
         BZ    MVFMHBLD            BRANCH IF COMPRESSION NOT ALLOWED R4 S2866000
         TM    MDCTFEAT,DCTPPRES+DCTPCPCT  TEST RMT DEVICE FEATURES R41 S2867000
         BZ    MVFMHBLD            BR IF CAN'T SUPPORT COMPRESSION  R41 S2867500
         BM    MVFMHOPP            BR IF COMPRESSION W/O COMPACTION R41 S2868000
         TM    BINPFMB1,BINCMPCT   TEST PRIMARY NAU USAGE           R41 S2868500
         BZ    MVFMHOPP            BRANCH IF COMPACTION NOT ALLOWED R41 S2869000
         OI    MDCTFMT,DCTPCPCT    TURN ON COMPACT  FLAG            R41 S2869500
MVFMHOPP OI    MDCTFMT,DCTPPRES    TURN ON COMPRESS FLAG            R41 S2872000
         DROP  WA                  DISCARD BIND IMAGE ADDRESSABILITY R4 S2872500
         SPACE 1                                                     R4 S2873000
MVFMHBLD TM    BINCMNP-BINDSECT+ICEBIND,BINFMHD TEST COMMON PROTOCOL R4 S2873500
         BZ    MVFMHNOP            SKIP BUILDING IF FM HDRS NOT USED R4 S2874000
         L     WA,RPLAREA          GET ADDR WHERE FMH IS TO BE BUILT R4 S2874500
         USING FMHDSECT,WA         ESTABLISH FM HDR ADDRESSABILITY   R4 S2875000
         MVC   FMHDSECT(MFMHAL),MFMHA  GET PROTOTYPE TYPE 1          R4 S2875500
         STC   R1,FMHPROPS         SET DATA STREAM CODE              R4 S2876000
         NI    ICESNDST,255-ICEDSTRM  RESET STREAM SEND STATUS @OZ29180 S2876500
         SRL   R1,5                GET FMH TYPE CODE           @OZ29180 S2876600
         LA    R1,MVICEST(R1)      INDEX ICE STATE TABLE       @OZ29180 S2877000
         OC    ICESNDST,0(R1)      SET FMH PENDING STATE       @OZ29180 S2877100
         TM    MDCTFMT,DCTPPRES+DCTPCPCT  TEST DATA STREAM STATUS   R41 S2878000
         BZ    MVFMHBL2            BRANCH IF COMPRESSION NOT USED   R41 S2878500
         BM    MVFMHBL1            BRANCH IF COMPRESS W/O COMPACT   R41 S2879000
         OI    FMHPROPS,FMHCPACT   SET FMH PROPERTY = COMPACTION    R41 S2879500
MVFMHBL1 OI    FMHPROPS,FMHCPRSS   SET FMH PROPERTY = COMPRESSION   R41 S2882000
MVFMHBL2 IC    R0,MDCTSEL          PICK UP SELECT BYTE FROM RDCT    R41 S2882500
         STC   R0,FMHSEL           STORE IN FM HEADER                R4 S2883000
         NI    FMHSEL,255-DCTPOUTB MASK OUT STREAM DIRECTION BIT     R4 S2883500
         CLI   FMHSEL,FMHEXCH      TEST FOR EXCHANGE MEDIA     @OZ29180 S2883550
         BL    MVFMHBL3            BRANCH IF NOT EXCHANGE      @OZ29180 S2883600
         CLI   FMHSEL,FMHEXCH+FMHLDANY  TEST FOR EXCH MEDIA    @OZ29180 S2883650
         BNH   MVFMHBL4            BRANCH IF EXCHANGE          @OZ29180 S2883700
MVFMHBL3 CLI   FMHSEL,FMHCARD      TEST FOR CARD MEDIA         @OZ29180 S2883750
         BL    MVFMHBL6            BRANCH IF NOT CARD          @OZ29180 S2883800
         CLI   FMHSEL,FMHCARD+FMHLDANY  TEST FOR CARD MEDIA    @OZ29180 S2883850
         BH    MVFMHBL6            BRANCH IF NOT CARD          @OZ29180 S2883900
MVFMHBL4 CLI   0(R1),ICEBEGIN      TEST FOR BDS                @OZ29180 S2883950
         BE    MVFMHBL5            BRANCH IF BDS               @OZ29180 S2884000
         CLI   0(R1),ICECONT       TEST FOR CDS                @OZ29180 S2884050
         BNE   MVFMHBL6            BRANCH IF NOT CDS           @OZ29180 S2884100
MVFMHBL5 MVC   FMHERCL,MDCTRECL    SET RECORD LENGTH           @OZ29180 S2884150
         TM    MDCTFEAT,DCTPNDST   TEST FOR BASIC/EXCHANGE     @OZ29180 S2884200
         BO    MVFMHBL6            BR IF NOT BASIC EXCHANGE    @OZ29180 S2884250
         OI    FMHPROPS,FMHDSTBX   SET DST BIT ON              @OZ29180 S2884300
MVFMHBL6 LA    R0,MFMHAL           SET OUTPUT LENGTH           @OZ29180 S2884400
         ST    R0,RPLRLEN           TO FMH LENGTH                    R4 S2884500
         SPACE 1                                                     R4 S2885000
MVFMHNOP TM    ICESNDST,ICEOCPND   TEST STREAM SENDING STATUS        R4 S2885500
         BO    MVRPLSND            SEND FM HDR & WAIT IF END CHAIN   R4 S2886000
         BR    ML                  ELSE RETURN, USER MAY APPEND DATA R4 S2886500
         DROP  WA                  DISCARD FM HEADER ADDRESSABILITY  R4 S2887000
         SPACE 3                                                    R41 S2887100
MVFMHMVC MVC   0(*-*,R15),0(WA)    ** EXECUTE ONLY **               R41 S2887200
MVFMHN16 DC    F'-16'              CONSTANT FOR LOOP CONTROL        R41 S2887300
         EJECT                                                      R41 S2887400
*                                                                   R41 S2887500
*                             SNA FM HEADER BUILD - COMPACTION      R41 S2887600
*                                                                   R41 S2887700
         SPACE 1                                                    R41 S2887800
         USING CPTDSECT,R1         COMPACTION TABLE ADDRESSABILITY  R41 S2887900
MVFMHCPA SLR   R1,R1               LOAD TABLE NUMBER                R41 S2888000
         ICM   R1,1,DCTACPTN        AS INDEX TO CPT MAP             R41 S2888100
         BZR   R14                 TAKE ERROR EXIT IMMEDIATELY IF 0 R41 S2888200
         L     R15,$MLLMPCE                PICK UP QUICK LOCATOR    R41 S2888300
         IC    R1,MCPTMAP-PCEDSECT(R1,R15)  FROM COMPACT TABLE MAP  R41 S2888400
         LTR   R1,R1               TAKE ERROR EXIT IF               R41 S2888500
         BZR   R14                  TABLE DOES NOT EXIST            R41 S2888600
         BCTR  R1,0                ELSE MODIFY INDEX FOR ORIGIN 0   R41 S2888700
         MH    R1,MVFMHCPL         MULTIPLY BY COMPACT TABLE LENGTH R41 S2888800
         AL    R1,$CPTPOOL         ADD COMPACT TABLE POOL ORIGIN    R41 S2888900
         B     4(,R14)             RETURN WITH TABLE ADDRESS IN R1  R41 S2889000
         SPACE 1                                                    R41 S2889100
MVFMHCPL DC    Y(CPTEND-CPTDSECT)  LENGTH OF COMPACTION TABLE       R41 S2889200
         SPACE 2                                                    R41 S2889300
MVFMHCPT L     WA,RPLAREA          GET DATA AREA ADDRESS            R41 S2889400
         USING FMHDSECT,WA         SPORADIC FM HDR ADDRESSABILITY   R41 S2889500
         MVC   0(MFMHCL,WA),MFMHC  MOVE IN PROTOTYPE TYPE 3 HEADER  R41 S2889600
         SLR   R0,R0               PICK UP NUMBER                   R41 S2889700
         IC    R0,CPTNMAST          OF MASTERS (M)                  R41 S2889800
         STC   R0,FMHBYTE3           & STORE IN FMH                 R41 S2889900
         LA    R15,MFMHCL(,WA)     ADVANCE DESTINATION POINTER      R41 S2890000
         LA    WA,CPTDTT+CPTMAST0  LOAD ADDRESS OF 1ST ROW TO MOVE  R41 S2890100
         LR    R14,R0              COMPUTE ADDRESS OF LAST          R41 S2890200
         SLL   R14,4                COMPLETE ROW TO BE MOVED        R41 S2890300
         LA    R1,CPTDTT-1(R14)      LESS 1 FOR LOOP CONTROL        R41 S2890400
         LCR   R14,R0              SAVE (- M) FOR LATER             R41 S2890500
         L     R0,MVFMHN16         LOAD NEGATIVE 16 FOR LOOP CTRL   R41 S2890600
MVFMHCP1 MVC   0(16,R15),0(WA)     MOVE A COMPLETE ROW              R41 S2890700
         SLR   R15,R0              ADVANCE R.U. PTR BY -(-16) = +16 R41 S2890800
         BXH   WA,R0,MVFMHCP1      LOOP FOR NEXT FULL ROW IF ANY    R41 S2890900
         CLR   R14,R0              TEST FOR 16 MASTERS SPECIAL CASE R41 S2891000
         BNH   MVFMHCP3            BRANCH IF YES, FM HDR COMPLETE   R41 S2891100
         SLR   WA,R14              ADJUST  R.U. PTR BY  -(-M) = +M  R41CS2891200
                                    TO POINT TO FIRST PARTIAL ROW   R41 S2891300
         LA    R14,15(,R14)        GET MACHINE LENGTH OF PARTIAL    R41CS2891400
                                    ROW = (16 - M) - 1 = -M + 15    R41 S2891500
         L     R1,ICECPT           LOAD TABLE ORIGIN                R41 S2891600
         LA    R1,CPTDTT            FOR LOOP CONTROL                R41 S2891700
MVFMHCP2 EX    R14,MVFMHMVC        MOVE A PARTIAL ROW               R41 S2891800
         LA    R15,1(R14,R15)      ADVANCE R.U. PTR BY PART ROW LTH R41 S2891900
         BXH   WA,R0,MVFMHCP2      LOOP FOR NEXT PARTIAL ROW        R41 S2892000
MVFMHCP3 L     WA,RPLAREA          UPDATE                           R41 S2892100
         SLR   R15,WA               LENGTH                          R41 S2892200
         ST    R15,RPLRLEN           IN RPL                         R41 S2892300
         STC   R15,FMHLNGTH        SET FM HEADER LENGTH             R41 S2892400
         OI    RPLOPT12,RPLFMHDR   SET FORMAT (FM HDR) INDICATOR    R41 S2892500
         OI    ICESNDST,ICEOCPND   SET END CHN TO FORCE IMM FMH SENDR41 S2892600
         B     MVRPLSND            CALL BUFFER SEND ROUTINE, RETURN R41 S2892700
         DROP  R1,WA               DISCARD TEMPORARY ADDRESSABILITY R41 S2892800
         EJECT                                                       R4 S2892900
*                                                                    R4 S2893000
*                             WAIT FOR RESPONSE AND/OR CANCEL CHAIN  R4 S2893100
*                                                                    R4 S2893200
         SPACE 1                                                     R4 S2893300
MVREQRSP TM    ICESNDST,ICECNCEL   TEST STREAM SENDING STATUS        R4 S2893400
         BZ    MVREQRS1            BRANCH IF CHAIN NOT CANCELLING    R4 S2893500
         SPACE 1                                                     R4 S2893600
MVREQCAN LR    WA,ML               ELSE SAVE 1ST LEVEL RETURN ADDR   R4 S2893700
         BAL   ML,MVFREPRG         PURGE ANY BUFFERS RMT DCT MAY OWN R4 S2893800
         LR    ML,WA               RESTORE 1ST LEVEL RETURN ADDRESS  R4 S2893900
         ST    MBUF,DCTBUFAD       CLEAR REMOTE DCT BUFFER POINTER   R4 S2894000
         SPACE 1                                                     R4 S2894100
MVREQRS1 TM    ICESNDST,ICEWTRSP   TEST SESSION SEND STATUS          R4 S2894200
         BZ    MVRSTATO            RESCIND BAD CHAIN IF NOT WAITING  R4 S2894500
         ST    ML,DCTEWF           SAVE 1ST LEVEL RETURN ADDRESS     R4 S2895000
         SPACE 1                                                     R4 S2895500
MVREQWT  DS    0H                                              @OZ19494 S2896000
        $WAIT WORK,SAVE=NO         WAIT FOR +FME RESPONSE            R4 S2896500
        $RESTORE                   RESTORE ACCESS METHOD REGISTERS   R4 S2897000
         TM    ICESNDST,ICEWTRSP   TEST WAITING-FOR-RESPONSE BIT     R4 S2897500
         BO    MVREQWT             POST WASN'T FOR US IF STILL ON    R4 S2898000
         L     ML,DCTEWF           RESTORE 1ST LEVEL RETURN ADDRESS  R4 S2898500
         SPACE 1                                                     R4 S2899000
*                             OUTBOUND STATE-MACHINE DRIVER ROUTINE  R4 S2899500
         SPACE 1                                                     R4 S2900000
MVRSTATO LA    R1,ICESNDST         POINT TO SEND STATUS BYTE         R4 S2900500
         TM    0(R1),ICECNCEL      TEST TYPE OF CHAIN COMPLETION     R4 S2901000
         BO    MVRSTATC            IF BAD, GO TO BAD CHAIN S/MACHINE R4 S2901500
         TM    ICEFLAGS,ICEBBPND   TEST SESSION STATUS               R4 S2902000
         BZ    SKIP640             BR IF BRACKET NOT JUST BEGUN      R4 S2902500
         NI    ICESTAT,255-ICERTRPD  RESET 'RDY TO RCV PENDING' FLAG R4 S2903000
SKIP640  BAL   R14,MVRSTATE        GO DRIVE GOOD CHAIN STATE MACHINE R4 S2903500
         EJECT                                                 @OZ29180 S2904000
*                     STATE TABLE FOR GOOD CHAIN STATE MACHINE @OZ29180 S2904100
         SPACE 1                                               @OZ29180 S2904200
MVFMHGUD DC    AL1(ICEINSTR)       SUCCESSFUL RESUME = IN-STREAM     R4 S2904500
         DC    AL1(ICENOFMH)       SUCCESSFUL END DS = OUT-OF-STREAM R4 S2905000
         DC    AL1(ICEINSTR)       SUCCESSFUL BEGIN  = IN-STREAM     R4 S2905500
         DC    AL1(ICENOFMH)       SUCCESSFUL ONLY C = OUT-OF-STREAM R4 S2906000
         DC    AL1(ICENOFMH)       SUCCESSFUL SUSPND = OUT-OF-STREAM R4 S2906500
         DC    AL1(ICENOFMH)       SUCCESSFUL ABORT  = OUT-OF-STREAM R4 S2907000
         DC    AL1(ICEINSTR)       SUCCESSFUL CONT   = IN STRM @OZ29180 S2907100
         DC    AL1(0)              INVALID STATE               @OZ29180 S2907200
         DC    AL1(0)              INVALID STATE               @OZ29180 S2907300
         DC    AL1(0)              INVALID STATE               @OZ29180 S2907400
         DC    AL1(0)              INVALID STATE               @OZ29180 S2907500
         DC    AL1(0)              INVALID STATE               @OZ29180 S2907600
         DC    AL1(0)              INVALID STATE               @OZ29180 S2907700
         DC    AL1(0)              INVALID STATE               @OZ29180 S2907800
         DC    AL1(ICENOFMH)       NO FMH PEND+OUT=OUT-OF-STRM @OZ29180 S2907900
         DC    AL1(ICEINSTR)       NO FMH PEND & IN  = IN-STREAM     R4 S2908000
         SPACE 1                                               @OZ29180 S2908100
MVFMHSTL EQU   *-MVFMHGUD          STATE TABLE LENGTH          @OZ29180 S2908200
         SPACE 1                                                     R4 S2908500
         DC    AL1(MVRSTIST-MVRST) 'RESUME' - GO IN STREAM           R4 S2909000
         DC    AL1(MVRSTEND-MVRST) 'END (NORMAL)' - DEALLOCATE       R4 S2909500
         DC    AL1(MVRSTIST-MVRST) 'BEGIN' - GO IN STREAM            R4 S2910000
         DC    AL1(MVRSTEND-MVRST) 'ONLY CHAIN' - DEALLOCATE         R4 S2910500
         DC    AL1(MVRSTSDS-MVRST) 'SUSPEND' - SUSPEND & DEALLOCATE  R4 S2911000
         DC    AL1(MVRSTADS-MVRST) 'END (ABORTING)' - DEALLOCATE     R4 S2911500
         DC    AL1(MVRSTIST-MVRST) 'CONTINUE' - GO IN STREAM   @OZ29180 S2911600
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2911700
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2911800
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2911900
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2912000
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2912100
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2912200
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2912300
         DC    AL1(MVRSTNOP-MVRST) NO FM HDR - NO ALLOC CHANGE @OZ29180 S2912400
         DC    AL1(MVRSTIST-MVRST) IN STREAM - REMAIN IN STREAM      R4 S2912500
         EJECT                                                       R4 S2913000
*                             INBOUND STATE-MACHINE DRIVER ROUTINE   R4 S2913500
         SPACE 1                                                     R4 S2914000
MVRSTATI LR    WA,ML               SAVE 1ST LEVEL RETURN ADDRESS     R4 S2914500
         BALR  ML,R15              SEND +RSP AND FREE BUFFER         R4 S2915000
         LR    ML,WA               RESTORE 1ST LEVEL RETURN ADDRESS  R4 S2915500
         LA    R1,ICERCVST         POINT TO RECEIVE STATUS BYTE      R4 S2916000
         LA    R14,MVFMHGUD        POINT TO GOOD CHAIN TRANS. TABLE  R4 S2916500
         TM    0(R1),ICECNCEL      TEST TYPE OF CHAIN COMPLETION     R4 S2917000
         BZ    MVRSTATE            BRANCH IF GOOD COMPLETION         R4 S2917500
         TM    ICERCVST,ICEINCHN   TEST SESSION RECEIVE STATUS       R4 S2918000
         BO    MVREQBUF            IF STILL IN PURGING CHAIN STATE,    CS2918500
                                    GET NEXT BUFF FROM INBOUND QUEUE   CS2919000
                                     (Q SHD BE EMPTY IF CALLER=L.M.) R4 S2919500
MVRSTATC LA    R14,MVFMHBAD        POINT TO BAD CHAIN TRANS. TABLE   R4 S2920000
         SPACE 1                                                     R4 S2920500
*                             COMMON STATE-MACHINE DRIVER ROUTINE    R4 S2921000
         SPACE 1                                                     R4 S2921500
MVRSTATE SLR   R15,R15             TRANSLATE                         R4 S2922000
         IC    R15,0(,R1)           OLD FMH                          R4 S2922500
         SRL   R15,4                 PENDING                   @OZ29180 S2923000
         NI    0(R1),255-ICEDSTRM     STATE TO                 @OZ29180 S2923500
         LA    R14,0(R15,R14)          CORRECT                       R4 S2924000
         OC    0(1,R1),0(R14)           NEW STATE                    R4 S2924500
         IC    R15,MVFMHSTL(,R14)  FMH PEND STATE TO INDEX TBL @OZ29180 S2925000
         B     MVRST(R15)          BRANCH TO CORRECT ROUTINE         R4 S2925500
         EJECT                                                 @OZ29180 S2926000
*                             RESCIND BAD CHAIN, RECOVER ICE STATE   R4 S2926500
         SPACE 1                                                     R4 S2927000
MVFMHBAD DC    AL1(ICENOFMH)       FAILING RESUME = OUT-OF-STREAM    R4 S2927500
         DC    AL1(ICEINSTR)       FAILING END DS = IN-STREAM        R4 S2928000
         DC    AL1(ICENOFMH)       FAILING BEGIN  = OUT-OF-STREAM    R4 S2928500
         DC    AL1(ICENOFMH)       FAILING ONLY C = OUT-OF-STREAM    R4 S2929000
         DC    AL1(ICEINSTR)       FAILING SUSPND = IN-STREAM        R4 S2929500
         DC    AL1(ICEINSTR)       FAILING ABORT  = IN-STREAM        R4 S2930000
         DC    AL1(ICEINSTR)       FAILING CONT    = IN-STREAM @OZ29180 S2930100
         DC    AL1(0)              INVALID STATE               @OZ29180 S2930200
         DC    AL1(0)              INVALID STATE               @OZ29180 S2930300
         DC    AL1(0)              INVALID STATE               @OZ29180 S2930400
         DC    AL1(0)              INVALID STATE               @OZ29180 S2930500
         DC    AL1(0)              INVALID STATE               @OZ29180 S2930600
         DC    AL1(0)              INVALID STATE               @OZ29180 S2930700
         DC    AL1(0)              INVALID STATE               @OZ29180 S2930800
         DC    AL1(ICENOFMH)       FAIL DATA+OUT = OUT-OF-STRM @OZ29180 S2930900
         DC    AL1(ICEINSTR)       FAILING DATA & IN = IN-STREAM     R4 S2931000
         SPACE 1                                                     R4 S2931500
         DC    AL1(MVRSTSDS-MVRST) BAD 'RESUME' - RE-SUSPEND         R4 S2932000
         DC    AL1(MVRSTIST-MVRST) BAD 'END (NORM)' - STAY IN STREAM R4 S2932500
         DC    AL1(MVRSTPAB-MVRST) BAD 'BEGIN' - ABORT PROCESSOR     R4 S2933000
         DC    AL1(MVRSTPAB-MVRST) BAD 'ONLY CHN' - ABORT PROCESSOR  R4 S2933500
         DC    AL1(MVRSTIST-MVRST) BAD 'SUSPEND' - STAY IN STREAM    R4 S2934000
         DC    AL1(MVRSTIST-MVRST) BAD 'END(ABORT)' - STAY IN STREAM R4 S2934500
         DC    AL1(MVRSTIST-MVRST) BAD 'CONTINUE' -STAY INSTRM @OZ29180 S2934600
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2934700
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2934800
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2934900
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2935000
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2935100
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2935200
         DC    AL1(MVRSTER-MVRST)  INVALID STATE               @OZ29180 S2935300
         DC    AL1(MVRSTNOP-MVRST) OUT OF STREAM - NO CHANGE   @OZ29180 S2935400
         DC    AL1(MVRSTIST-MVRST) IN STREAM - STAY IN STREAM        R4 S2935500
         EJECT                                                      R41 S2936000
MVRST    EQU   *                   ORIGIN FOR BRANCH TABLE OFFSETS   R4 S2936500
         SPACE 1                                                     R4 S2937000
MVRSTER  BAL   R8,R01              INVALID STATE DETECTED      @OZ52502 S2937100
         SPACE 1                                               @OZ29180 S2937200
MVRSTPAB OI    MDCTSTAT,DCTABORT   HALT PROCESSOR RTAM FUNCTIONS     R4 S2937500
         L     MBUF,DCTBUFAD       PURGE ANY BUFFER                 R41 S2937600
         BAL   ML,MVFREPRG          THE REMOTE DCT MAY OWN          R41 S2937700
         LA    ML,MVTAMXAB         ABORT CURRENT $EXTP CALL         R41 S2937800
         OI    DCTFLAGS,DCTRSTRT   TELL PRCSR TO RESTART JOB   @OZ39875 S2937900
         SPACE 1                                                    R41 S2938000
MVRSTADS OI    DCTFLAGS,DCTDELET   TELL PRCSR TO DELETE  JOB   @OZ39875 S2938500
         B     MVRSTEND            BRANCH TO DEALLOCATE ROUTINE      R4 S2939000
         SPACE 1                                                    R41 S2939500
MVRSTIST TM    ICEFLAGS,ICEEBPND+ICECHDIR  TEST SESSION STATUS       R4 S2940000
         BZ    MVRSTNOP            BYPASS IMPLIED SUSPND IF NO EB/CD R4 S2940500
         XI    0(R1),ICEINSTR-ICENOFMH  SET NO FMH PEND, OUT OF STRM R4 S2943000
         SPACE 1                                                     R4 S2943500
MVRSTIMP LA    R0,ICESIMPL+ICESUSPD  LOAD IMPLIED SUSPEND CODE       R4 S2944000
         B     MVRSTSD1            JOIN COMMON SUSPEND CODE         R41 S2944500
         SPACE 1                                                     R4 S2945000
MVRSTSDS LA    R0,ICESUSPD         LOAD EXPLICIT SUSPEND CODE        R4 S2945500
         SPACE 1                                                    R41 S2945600
MVRSTSD1 LA    R14,ICESDCT-(MDCTSDCT-DCTDSECT)  PTR TO SUSP Q HEAD  R41 S2946000
         USING DCTDSECT,R14        GET TEMPORARY DCT ADDRESSABILITY R41 S2946100
         TM    ICEFLGS2,ICEOUTBK   TEST SESSION STATUS FLAGS   @OZ29180 S2946200
         BZ    MVRSTSD4            BR IF NOT OUTBD-OUTBD INTERRUPT  R41 S2946300
         TM    ICEFLAGS,ICEOUTBD+ICECHDIR  TEST SESSION STATUS      R41 S2946400
         BNO   MVRSTSD2            BR IF INBND INTERUPT NOT PENDNG  R41 S2946500
         SPACE 1                                                    R41 S2946600
         L     R15,ICESDCT         PICK UP OUTBD INTERRUPTING DCT   R41 S2946700
         USING DCTDSECT,R15        ESTABLISH TEMP. ADDRESSABILITY   R41 S2946800
         XC    MDCTICE,MDCTICE     CLEAR PRE-ALLOCATION POINTER     R41 S2946900
         MVC   ICESDCT,MDCTSDCT     AND REMOVE FROM SUSPEND QUEUE   R41 S2947000
         DROP  R15                 RELEASE TEMP. ADDRESSABILITY     R41 S2947100
         B     MVRSTSD3            REJOIN COMMON PROCESSING         R41 S2947200
         SPACE 1                                                    R41 S2947300
MVRSTSD2 L     R14,ICESDCT         USE INTERRUPTING DCT Q ANCHOR    R41 S2947400
         NI    DCTSTAT,255-DCTHOLD SHOW RDCT NO LONGER HELD         R41 S2947500
         OI    MDCTSTAT,DCTPOST    SHOW RDCT WILL BE POSTED BELOW   R41 S2947600
         SPACE 1                                                    R41 S2947700
MVRSTSD3 NI    ICEFLGS2,255-ICEOUTBK  CLEAR OUTBD-OUTBD FLAG   @OZ29180 S2947800
         SPACE 1                                                    R41 S2947900
MVRSTSD4 L     R15,MDCTSDCT        GET HEAD OF SUSPENDED DCT QUEUE  R41 S2948000
         ST    MDCT,MDCTSDCT       MAKE RDCT NEW SUSPEND QUEUE HEAD R41 S2948100
         STC   R0,MDCTSDCT         SAVE SUSPD OR IMPLIED SUSPD FLAG R41 S2948200
         DROP  R14                 DISCARD TEMP DCT ADDRESSABILITY  R41 S2948300
         OI    MDCTSTAT,DCTPSUSP   INDICATE REMOTE DCT IS SUSPENDED  R4 S2948400
         ST    R15,MDCTSDCT        CHAIN REST OF QUE TO CURRENT DCT R41 S2948500
         B     MVRSTEN1            JOIN COMMON DE-ALLOCATION LOGIC  R41 S2948600
         SPACE 1                                                     R4 S2949000
MVRSTEND XC    MDCTICE,MDCTICE     CLEAR RDCT POINTER TO ICE         R4 S2949500
MVRSTEN1 XC    ICERDCT,ICERDCT     CLEAR  ICE POINTER TO REMOTE DCT R41 S2950000
         NI    ICESTAT,255-ICEALLOC  MARK ICE UNALLOCATED            R4 S2951000
         TM    0(R1),ICENOFMH      TEST NEW STREAM STATUS            R4 S2951500
         BNO   MVDALLOC            IF FMH PENDING, BDS OR ODS CAUSED   CS2952000
                                    IMPLIED SUSPEND.  BRANCH TO COM-   CS2952500
                                     PLETE BDS OR ODS ALLOCATION     R4 S2953000
         SPACE 2                                               @OZ29180 S2953200
MVRSTNOP TM    ICEFLAGS,ICECHDIR   TEST SESSION STATUS               R4 S2953500
         BZ    SKIP670             BR IF CHG DIRECTION NOT PENDING   R4 S2954000
         XI    ICEFLAGS,ICEINBND+ICEOUTBD+ICEREVFL  CHANGE DIRECTION R4 S2954500
SKIP670  TM    ICEFLAGS,ICEBBPND+ICEEBPND  TEST SESSION STATUS       R4 S2955000
         BNM   SKIP680             BR IF NOT BB ALONE OR EB ALONE    R4 S2955500
         XI    ICEFLAGS,ICEINBRK   CHANGE BRACKET STATE              R4 S2956000
SKIP680  NI    ICEFLAGS,255-ICEBBPND-ICEEBPND-ICECHDIR  CLEAR PENDS. R4 S2956500
         TM    0(R1),ICECNCEL      TEST TYPE OF CHAIN COMPLETION     R4 S2957000
         BZ    MVRSTRM0            BRANCH IF NOT CANCELLING          R4 S2957500
         NI    0(R1),255-ICECNCEL  RESET CHAIN CANCEL INDICATOR      R4 S2958000
         LTR   MBASE1,MBASE1       TEST TYPE OF $EXTP CALL           R4 S2958500
         BM    MVRSTRMC            BR IF MAY NOT FLUSH (CLOSE OR LM) R4 S2959000
         TM    MDCTSEL,DCTPOUTB    TEST DIRECTION BIT                R4 S2959500
         BZ    MVRSTRMC            BRANCH IF NOT OUTBOUND (NOT PUT)  R4 S2960000
         LA    ML,MVTAMXAB         ELSE ABORT $EXTP CALL             R4 S2960500
         TM    ICEXRFBK,ICEXRCPY   TEST EXCEPTION RESPONSE FEEDBACK R41 S2960600
         BZ    MVRSTRMA            BR IF NOT COPIES FUNCTION REJECT R41 S2960700
         LA    ML,MVTAMXEX         ELSE SET $EXTP EXCEPTION RETURN  R41 S2960800
         NI    ICEXRFBK,255-ICEXRCPY   CLEAR COPIES FUNCTION REJECT R41 S2960900
         SPACE 1                                                    R41 S2961000
MVRSTRMA TM    ICEXRFBK,ICEXRDNA   TEST EXCEPTION RECOVERY ACTION   R41 S2961100
         BZ    MVRSTRMC            BR IF DEVICE STILL ACCEPTING DATAR41 S2961500
         OI    MDCTSTAT,DCTFLUSH   ELSE SET DATA STREAM SOFT ABORT   R4 S2962000
         NI    ICEXRFBK,255-ICEXRDNA TO BAR FURTHER SENDS TO DEVICE R41 S2962100
         SPACE 1                                                     R4 S2962500
MVRSTRMC TM    ICEFLAGS,ICEINBRK   TEST SESSION STATUS               R4 S2963000
         BO    MVRSTRM1            GO FIND A STREAM IF IN BRACKET    R4 S2963500
         TM    ICESTAT,ICEHOLD     TEST SESSION STATUS               R4 S2964000
         BNZ   MVRSTRM0            IF YEILDING TO CONTENTION,       R41CS2964500
                                                ABORT PROCESSOR     R41 S2965000
         LA    R0,VXIDGBUF+VSEQGIBB   ELSE, SETUP TO SEND           R41 S2965100
         L     WA,$MLLMPCE             NULL RU (BB+EB) UNDER        R41 S2965200
         B     MICEREQ2                 LINE MANAGER                R41 S2965300
MVRSTRM0 TM    ICEFLAGS,ICEINBRK   TEST SESSION STATUS               R4 S2965500
         BZ    MICEAEB             BRANCH IF NOW OUT OF BRACKET      R4 S2966000
MVRSTRM1 TM    0(R1),ICEINSTR      TEST NEW STREAM STATUS            R4 S2966500
         BOR   ML                  IF IN STREAM RETURN TO CALLER     R4 S2967000
*                                  ELSE GO TRY TO START NEXT STREAM  R4 S2967500
         EJECT                                                       R4 S2968000
*                                                                    R4 S2968500
*                             REQUEST NEXT DATA STREAM               R4 S2969000
*                                                                    R4 S2969500
         SPACE 1                                                     R4 S2970000
MVREQSTR TM    ICESTAT,ICEALLOC    TEST ICE STATUS                   R4 S2970500
         BO    MVREQRET            RETURN IF ICE ALREADY ALLOCATED   R4 S2971000
         TM    ICEFLAGS,ICEOUTBD+ICEINBRK  TEST SESSION STATUS       R4 S2971500
         BNZ   MVREQSPQ            IF IN BRACKET, TRY TO POP SUSP Q. R4 S2972000
         L     MDCT,ICELDCT        GET ADDRESS OF LINE DCT           R4 S2972500
         SPACE 1                                                     R4 S2973000
MVREQJOT OI    MDCTATTN,MDCTJOB1+MDCTJOB2 SHOW IDLE SESS. AND WORK  R41 S2973500
         BAL   WA,MICETIME         REQUEST SESSION DELAY INTERVAL    R4 S2974000
         L     R1,DCTPCE           GET LINE MANAGER PCE ADDRESS      R4 S2974500
        $POST  (R1),WORK           TAP LINE MANAGER ON SHOULDER      R4 S2975000
         B     MVREQBUF            GO ACCEPT INBOUND R.U. IF ANY     R4 S2975500
         SPACE 2                                                     R4 S2976000
MVREQSPQ LA    MDCT,ICESDCT-(MDCTSDCT-DCTDSECT)  FAKE ZERO SUSP RDCT R4 S2976500
         BM    MVREQSPI            CHECK SUSP INBND RDCT IF INBOUND  R4 S2977000
         SPACE 1                                                     R4 S2977500
*                             RESUME SUSPENDED OUTBOUND STREAM       R4 S2978000
         SPACE 1                                                     R4 S2978500
MVREQSPO LR    R15,MDCT            SAVE CURRENT REMOTE DCT ADDR      R4 S2979000
         L     MDCT,MDCTSDCT       GET NEXT SUSPENDED REMOTE DCT     R4 S2979500
         LTR   MDCT,MDCT           TEST ADDRESS                      R4 S2980000
         BZ    MICEGIEB            IF NO RDCTS, SEND IMMED END BRKT  R4 S2980500
         TM    MDCTSEL,DCTPOUTB    TEST DIRECTION BIT                R4 S2981000
         BZ    MVREQSPO            KEEP SEARCHING IF NOT OUTBOUND    R4 S2981500
         LTR   MDCT,MDCT           TEST IMPLIED SUSPEND/RESUME BIT   R4 S2982000
         BNM   MVDRSUMO            GO ALLOCATE & POST IF NOT IMPLIED R4 S2982500
         OI    ICESNDST,ICEINSTR   ELSE GO IN STREAM AUTOMATICALLY   R4 S2983000
         B     MVDRSUMO            GO ALLOCATE & POST                R4 S2983500
         SPACE 2                                                     R4 S2984000
*                             RESUME SUSPENDED INBOUND STREAM        R4 S2984500
         SPACE 1                                                     R4 S2985000
MVREQSPI LR    R15,MDCT            SAVE CURRENT RDCT ADDRESS         R4 S2985500
         L     MDCT,MDCTSDCT       GET ADDR OF NEXT SUSPENDED RDCT   R4 S2986000
         LTR   MDCT,MDCT           TEST                              R4 S2986500
         BZ    MVREQBUF            IF NO SUSPENDED RDCTS, ACCEPT ANY   CS2987000
                                    INBOUND RU (IF NONE DON'T WAIT)  R4 S2987500
         TM    MDCTSEL,DCTPOUTB    TEST DIRECTION BIT                R4 S2988000
         BO    MVREQSPI            KEEP SEARCHING IF NOT INBOUND     R4 S2988500
         LTR   MDCT,MDCT           TEST IMPLIED SUSPEND/RESUME BIT   R4 S2989000
         BM    MVDRSUMI            IF IMPLIED RESUME, GO REALLOCATE.   CS2989500
                                    IF NO IMPLIED RESUME, ACCEPT ANY   CS2990000
                                     INBOUND RU (IF NONE DON'T WAIT) R4 S2990500
         EJECT                                                       R4 S2991000
*********************************************************************** S2991500
*                                                                     * S2992000
*           MVREQBUF  -  REQUEST DATA BUFFER FOR APPLICATION INPUT    * S2992500
*                                                                     * S2993000
*           MVDECODE  -  DECODE SNA REQUEST & FUNCTION MGMT HEADERS   * S2993500
*                                                                     * S2994000
*********************************************************************** S2994500
         SPACE 1                                                     R4 S2995000
MVREQBUF L     MBUF,ICEINHD        GET 1ST ADDR ON INBOUND QUEUE     R4 S2995500
         LTR   MBUF,MBUF           TEST ADDRESS                      R4 S2996000
         BNZ   MVREQUEU            BRANCH IF QUEUE NOT EMPTY         R4 S2996500
         TM    ICESTAT,ICEALLOC    TEST SESSION STATUS               R4 S2997000
         BZ    MVREQRET            RETURN IF CALLER IS CLOSE OR L.M.   CS2997500
                                    OR WAIT IF CALLER IS SUSPENDING  R4 S2998000
         ST    ML,DCTEWF           SAVE 1ST LEVEL RETURN ADDRESS     R4 S2998500
        $WAIT  WORK,SAVE=NO        HAVE RTAM/GET WAIT FOR INPUT      R4 S2999000
        $RESTORE                   RESTORE ACCESS METHOD REGISTERS   R4 S2999500
         L     ML,DCTEWF           RELOAD 1ST LEVEL RETURN ADDRESS   R4 S3000000
         B     MVREQBUF            BRANCH TO TRY FOR BUFFER          R4 S3000500
         SPACE 2                                                     R4 S3001000
MVREQUEU L     R0,RPLNEXT          GET NEXT ADDR ON INBOUND QUEUE    R4 S3002000
         ST    R0,ICEINHD          MAKE NEXT ADDR NEW QUEUE HEAD     R4 S3005000
         LTR   R0,R0               TEST ADDRESS                      R4 S3005500
         BNZ   MVDECODE            BRANCH IF NOT ZERO                R4 S3006000
         ST    R0,ICEINTL          CLEAR TAIL ADDRESS IF QUEUE EMPTY R4 S3006500
         SPACE 1                                                     R4 S3007000
MVDECODE LA    R14,ICEBIND         POINT TO BIND IMAGE IN ICE        R4 S3007500
         USING ISTDBIND,R14        ESTABLISH BIND IMAGE ADDRESSAB'TY R4 S3008000
         L     R0,ICESTAT          COPY ICE STATE TO REGISTER        R4 S3008500
         SLR   R15,R15             CLEAR REG FOR TRANSITION NUMBER   R4 S3009000
         ST    R0,SHWICEWA         STORE ICE STATE COPY IN WORK AREA R4 S3009500
         ST    R15,RPLNEXT         CLEAR RPL CHAINING FIELD          R4 S3010000
         XC    SHWDCTWA,SHWDCTWA   CLEAR DCT FMT MASK & 'GET' FLAGS  R4 S3010500
         CLC   RPLCNTDF(3),MSNADATA  TEST R.U. TYPE                  R4 S3011000
         BNE   MVDFCTRL            BRANCH IF NOT DATA                R4 S3011500
         TM    SHWFLAGS,ICEOUTBD   TEST SESSION STATUS               R4 S3012000
         BO    MVDX2004            FAIL IF SESSION MARKED OUTBOUND   R4CS3012500
                                    (SENSE X'2004', DIRECTION ERROR) R4 S3013000
         CLI   RPLRTNCD,USFXORDC   TEST RPL COMPLETION CODE          R4 S3013500
         BE    MVDXRQST            ENTER PURGING CHAIN STATE         R4CS3014000
                                    IF AN EXCEPTION REQUEST          R4 S3014500
         EJECT                                                       R4 S3015000
*                             DRIVE CHAINING STATE-MACHINE           R4 S3015500
         SPACE 1                                                     R4 S3016000
         TM    SHWRCVST,ICEINCHN   TEST SESSION RECEIVE STATUS       R4 S3016500
         BO    SKIP690             BRANCH IF IN CHAIN                R4 S3017000
         LA    R15,4               ELSE SET TRANSITION NUMBER TO 4   R4 S3017500
SKIP690  TM    RPLCHN,RPLFIRST+RPLONLY TEST R.U. CHAIN POSITION      R4 S3018000
         BZ    SKIP700             BRANCH IF NOT FIRST OR ONLY       R4 S3018500
         LA    R15,2(,R15)         ADD 2 TO TRANSITION NUMBER        R4 S3019000
SKIP700  TM    SHWRCVST,ICECNCEL   TEST STREAM RECEIVE STATUS        R4 S3019500
         BZ    SKIP710             BR IF NOT IN PURGING CHAIN STATE  R4 S3020000
         LA    R15,8               RESET TRANSITION NUMBER TO 8      R4 S3021000
SKIP710  TM    RPLCHN,RPLLAST+RPLONLY   TEST R.U. CHAIN POSITION     R4 S3021500
         BZ    SKIP720             BRANCH IF NOT LAST OR ONLY        R4 S3022000
         LA    R15,1(,R15)         ELSE ADD 1 TO TRANSITION NUMBER   R4 S3022500
SKIP720  IC    R15,*+8(R15)        USE TRANS. NUMBER AS TABLE INDEX  R4 S3023000
         B     MVDCH(R15)          PERFORM TRANSITION                R4 S3023500
         SPACE 1                                                     R4 S3024000
         DC    AL1(MVDCHNOP-MVDCH) MIC INC  = INC  (NO CHANGE)       R4 S3024500
         DC    AL1(MVDCHOUT-MVDCH) LIC INC  = OUTC (SWITCH STATE)    R4 S3025000
         DC    AL1(MVDCHERR-MVDCH) FIC INC  = ERROR, SENSE X'2002'   R4 S3025500
         DC    AL1(MVDCHERR-MVDCH) OIC INC  = ERROR, SENSE X'2002'   R4 S3026000
         DC    AL1(MVDCHERR-MVDCH) MIC OUTC = ERROR, SENSE X'2002'   R4 S3026500
         DC    AL1(MVDCHERR-MVDCH) LIC OUTC = ERROR, SENSE X'2002'   R4 S3027000
         DC    AL1(MVDCHINC-MVDCH) FIC OUTC = INC  (SWITCH STATE)    R4 S3027500
         DC    AL1(MVDCHNOP-MVDCH) OIC OUTC = OUTC (NO CHANGE)       R4 S3028000
         DC    AL1(MVDCHPRG-MVDCH) MIC/FIC PURGEC = PURGEC (DISCARD) R4 S3028500
         DC    AL1(MVDCHLVP-MVDCH) LIC/OIC PURGEC = OUTC   (DISCARD) R4 S3029000
         SPACE 1                                                     R4 S3029500
MVDCH    EQU   *                   ORIGIN FOR BRANCH TABLE OFFSETS   R4 S3030000
         SPACE 1                                                     R4 S3030500
MVDCHLVP NI    ICERCVST,255-ICEINCHN  SHOW PURGED CHAIN HAS ENDED    R4 S3034000
         SPACE 1                                                     R4 S3034500
MVDCHPRG LA    R15,MVFREEIN        POINT TO INBND BUF PURGE ROUTINE R41 S3035000
         B     MVRSTATI            GO UPDATE RECEIVING STATE MACHINE R4 S3035500
         SPACE 1                                                     R4 S3036000
MVDCHINC TM    BINSECP,BINSCHN     TEST SECONDARY NAU PROTOCOLS      R4 S3036500
         BO    MVDCHOUT            ACCEPT IF BIND SUPPORTS CHAINING. R4 S3037000
         B     MVDX400B             FAIL IF NO MULTIPLE-R.U. CHAINS  R4CS3037500
                                     (SENSE X'400B', CHNS NOT SUPPD) R4 S3038000
MVDCHERR B     MVDX2002            GO ABORT ICE AND ANY STREAMS      R4 S3038500
         SPACE 1                                                     R4 S3039000
MVDCHOUT XI    SHWRCVST,ICEINCHN   INVERT CHAIN STATE                R4 S3039500
         SPACE 1                                                     R4 S3040000
MVDCHNOP EQU   *                   NO CHANGE                         R4 S3040500
         EJECT                                                       R4 S3041000
*                             DRIVE BRACKET STATE-MACHINE            R4 S3041500
         SPACE 1                                                     R4 S3042000
         SLR   R15,R15             CLEAR REG FOR TRANSITION NUMBER   R4 S3042500
         TM    SHWFLAGS,ICEINBRK   TEST SESSION STATUS               R4 S3043000
         BO    SKIP730             BRANCH IF IN BRACKET              R4 S3043500
         LA    R15,4               ADD 4 TO TRANSITION NUMBER        R4 S3044000
SKIP730  TM    RPLRH3,RPLEB        TEST REQUEST HEADER BYTE 3        R4 S3044500
         BZ    SKIP740             BRANCH IF NOT END BRACKET         R4 S3045000
         LA    R15,2(,R15)         ADD 2 TO TRANSITION NUMBER        R4 S3045500
         OI    SHWFLAGS,ICEEBPND   SET 'END BRACKET PENDING' FLAG    R4 S3046000
SKIP740  TM    RPLRH3,RPLBB        TEST REQUEST HEADER BYTE 3        R4 S3046500
         BZ    *+8                 BRANCH IF NOT BEGIN BRACKET      R41 S3047000
         LA    R15,1(,R15)         ADD 1 TO TRANSITION NUMBER        R4 S3047500
         IC    R15,*+8(R15)        USE TRANS. NUMBER AS TABLE INDEX  R4 S3048500
         B     MVDBK(R15)          PERFORM TRANSITION                R4 S3049000
         SPACE 1                                                     R4 S3049500
         DC    AL1(MVDBKNOP-MVDBK) -BB -EB  INB = INB (NO CHANGE)    R4 S3050000
         DC    AL1(MVDBKERR-MVDBK)  BB -EB  INB = ERROR, SNS X'2003' R4 S3050500
         DC    AL1(MVDBKEBP-MVDBK) -BB  EB  INB = INB AND EB PENDING R4 S3051000
         DC    AL1(MVDBKERR-MVDBK)  BB  EB  INB = ERROR, SNS X'2003' R4 S3051500
         DC    AL1(MVDBKNUS-MVDBK) -BB -EB OUTB = OK IF BKTS NOT USD R4 S3052000
         DC    AL1(MVDBKINB-MVDBK)  BB -EB OUTB = INB                R4 S3052500
         DC    AL1(MVDBKERR-MVDBK) -BB  EB OUTB = ERROR, SNS X'2003' R4 S3053000
         DC    AL1(MVDBKBBP-MVDBK)  BB  EB OUTB = BB/EB PENDING     R41 S3053500
         SPACE 1                                                     R4 S3054000
MVDBK    EQU   *                   ORIGIN FOR BRANCH TABLE OFFSETS   R4 S3054500
         SPACE 1                                                     R4 S3055000
MVDBKNUS TM    RPLCHN,RPLFIRST+RPLONLY  TEST R.U. CHAIN POSITION     R4 S3055500
         BZ    MVDBKNOP            BB NOT NEEDED IF NOT 1ST IN CHAIN R4 S3056000
         CLC   RPLCNTDF(3),MSNADATA  TEST R.U. TYPE                  R4 S3056500
         BNE   MVDBKNOP            BB NOT REQUIRED IF DATA FLOW CTRL R4 S3057000
         TM    BINCMNP,BINBRAK     TEST COMMON NAU PROTOCOLS         R4 S3057500
         BZ    MVDBKNOP            ALLOW CASE IF BRACKETS NOT USED     CS3058000
                                    ELSE (X'2003') BRACKET STATE ERR R4 S3058500
MVDBKERR B     MVDX2003            GO ABORT ICE AND ANY STREAMS      R4 S3059500
         SPACE 1                                                     R4 S3060000
MVDBKBBP OI    SHWFLAGS,ICEBBPND   SET 'BEGIN BRACKET PENDING'      R41 S3060100
         SPACE 1                                                    R41 S3060200
MVDBKEBP TM    BINSECP,BINSSEB     TEST SECONDARY NAU PROTOCOLS      R4 S3060500
         BO    MVDBKIN1            BR IF SECONDARY MAY SEND EB      R41 S3060600
         B     MVDX4004            FAIL IF SECNDRY CANT SEND EB     R41*S3061000
                                   (SENSE X'4004', EB NOT ALLOWED)   R4 S3061500
MVDBKINB OI    SHWFLAGS,ICEINBRK   BB/-EB, GO IN BRCKT IMMED.       R41 S3062100
         OI    ICEFLAGS,ICEINBRK   INDICATE IN BRACKET         @OZ34188 S3062150
         SPACE 1                                                    R41 S3062200
MVDBKIN1 TM    BINCMNP,BINBRAK     TEST COMMON NAU PROTOCOLS        R41 S3062500
         BZ    MVDX400C            FAIL IF BRACKETS NOT TO BE USED   R4CS3063000
                                    (SENSE X'400C' BRKTS NOT SUPPD)  R4 S3063500
         TM    RPLCHN,RPLFIRST+RPLONLY  TEST R.U. CHAIN POSITION     R4 S3064000
         BZ    MVDX400X            FAIL IF BB OR EB NOT 1ST IN CHAIN R4CS3064500
                                    (SENSE X'4003', BB NOT ALLOWED,    CS3065000
                                     OR X'4004', EB NOT ALLOWED)     R4 S3065500
         OI    SHWFLAGS,ICEINBND   MARK SESSION FOR INBOUND FLOW     R4 S3066000
         NI    SHWSTAT,255-ICEHOLD RELSE OUTBD ALLOC CONTENTION LOCK R4 S3066500
         SPACE 1                                                     R4 S3067000
MVDBKNOP EQU   *                   NO CHANGE                         R4 S3067500
         EJECT                                                       R4 S3068000
*                             TEST FOR CHANGE DIRECTION              R4 S3068500
         SPACE 1                                                     R4 S3069000
         TM    RPLRH3,RPLCMD       TEST REQUEST HEADER BYTE 3        R4 S3069500
         BZ    SKIP750             BRANCH IF CHANGE DIRECTION NOT ON R4 S3070000
         TM    RPLCHN,RPLLAST+RPLONLY  TEST R.U. CHAIN POSITION      R4 S3070500
         BZ    MVDX4009            FAIL IF NOT AT END OF CHAIN       R4CS3071000
                                    (SENSE X'4009', CD NOT ALLOWED)  R4 S3071500
         OI    SHWFLAGS,ICECHDIR   SET 'CHGE DIRECTION PENDING' FLAG R4 S3072000
SKIP750  CLI   SHWCNTRL,0          TEST INDEX COMPUTED FROM R.U.TYPE R4 S3072500
         BNE   MVDFCFIN            BRANCH IF DFC THAT ALLOWS EB/CD   R4 S3073000
         SPACE 3                                                     R4 S3073500
*                             TEST FOR ALTERNATE CODE                R4 S3074000
         SPACE 1                                                     R4 S3074500
         TM    RPLRH3,RPLCSI       TEST REQUEST HEADER BYTE 3        R4 S3075000
         BZ    MVDECFMH            BRANCH IF NOT ALTERNATE CODE      R4 S3075500
         TM    BINCMNP,BINALT      TEST COMMON NAU PROTOCOLS         R4 S3076000
         BZ    MVDX4010            BRANCH IF ALT CODE NOT ALLOWED    R4CS3076500
                                    (SENSE X'4010', ALT CD NOT SUPD) R4 S3077000
         OI    SHWTFMTM,DCTPALTC   SET 'ALT CODE' IN DCT FMT MASK    R4 S3077500
         EJECT                                                       R4 S3078000
*                                                                    R4 S3078500
*                             IDENTIFY FM HEADER TYPE AND LEVEL      R4 S3079000
*                                                                    R4 S3079500
         SPACE 1                                                     R4 S3080000
MVDECFMH L     R1,RPLRLEN          LEAVE R.U. LENGTH IN R1 AND R.U.  R4 S3080500
         L     WA,RPLAREA           ADDR IN WA, ON RETURN TO CALLER  R4 S3081000
         TM    RPLOPT12,RPLFMHDR   TEST FORMAT INDICATOR             R4 S3081500
         BZ    MVDNOFMH            BRANCH IF FM HEADER NOT PRESENT   R4 S3082000
         LTR   R1,R1               TEST REMAINING R.U. LENGTH        R4 S3082500
         BNP   MVDNOFMH            BRANCH IF R.U. ACTUALLY NULL      R4 S3083000
         TM    RPLCHN,RPLFIRST+RPLONLY  TEST R.U. CHAIN POSITION     R4 S3083500
         BZ    MVDX400F            FAIL IF FM HDR NOT ON 1ST OF CHN  R4 S3084000
         TM    BINCMNP,BINFMHD     TEST COMMON NAU PROTOCOLS         R4 S3084500
         BZ    MVDX400F            FAIL IF FM HDRS NOT TO BE USED    R4CS3087500
                                    (SENSE X'400F', FMH NOT ALLOWED) R4 S3088000
         SPACE 2                                                     R4 S3089000
         USING FMHDSECT,WA         ESTABLISH FM HDR ADDRESSABILITY   R4 S3089500
         SPACE 1                                                     R4 S3090000
MVDECLIP SLR   R0,R0               CLIP FM HDR                       R4 S3090500
         IC    R0,FMHLNGTH          OFF FRONT OF                     R4 S3091000
         SLR   R1,R0                 R.U. BY MAKING                  R4 S3091500
         ST    R1,RPLRLEN             LENGTH SHORTER                 R4 S3092000
         ALR   R0,WA                   AND INCREASING                R4 S3092500
         ST    R0,RPLAREA               ADDRESS POINTER              R4 S3093000
         TM    FMHBYTE1,FMHCNCAT   TEST FM HDR CONCATENATED BIT      R4 S3093500
         BO    SKIP760             BRANCH IF MORE FM HEADERS FOLLOW  R4 S3094000
         NI    RPLOPT12,255-RPLFMHDR  RESET FORMAT INDICATOR IF NOT  R4 S3094500
SKIP760  NI    FMHBYTE1,255-FMHCNCAT  FORCE CONCATENATED FMH BIT OFF R4 S3095000
         CLI   FMHBYTE1,FMHTYPE1      TEST FMH TYPE                  R4 S3095500
         BNE   MVDX1008            FAIL IF CANNOT RECOGNIZE FMH TYPE   CS3096000
                                    (SENSE X'1008', INVALID FM HDR)  R4 S3096500
         SPACE 1                                                     R4 S3097000
*                                                                    R4 S3097500
*                             FMH TYPE 1 - DATA STREAM HEADER        R4 S3098000
*                                                                    R4 S3098500
         SPACE 1                                                     R4 S3099000
MVDTYPE1 TM    SHWRCVST,ICENOFMH   TEST SESSION STATUS               R4 S3099500
         BNO   MVDX1008            FAIL IF TYPE 1 FMH ALREADY PENDG  R4CS3100000
                                    (SENSE X'1008', INVALID FM HDR)  R4 S3100500
         CLI   FMHLNGTH,MFMHAL     CHECK FM HEADER LENGTH            R4 S3101000
         BNE   MVDX1008            FAIL IF LTH BAD OR UNSUPPORTED      CS3101500
                                    (SENSE X'1008', INVALID FM HDR)  R4 S3102000
         SLR   R15,R15             CLEAR WORK REGISTER         @OZ29180 S3102100
         IC    R15,FMHPROPS        COPY PROPERTIES BYTE TO REGISTER  R4 S3102500
         NI    SHWRCVST,255-ICEDSTRM  MASK DATA STREAM         @OZ29180 S3103000
         SRL   R15,5               GET DATA STREAM ACTION CODE @OZ29180 S3103500
         LA    R1,MVICEST(R15)     POINT TO FMH STATE FLAGS    @OZ29180 S3104000
         OC    SHWRCVST,0(R1)      SET FMH PENDING STATE       @OZ29180 S3104500
*                                  THIS CARD DELETED BY APAR   @OZ29180 S3105000
         IC    R15,MVDDS(R15)      USE AS INDEX INTO OFFSET TABLE   R41 S3105500
         TM    FMHSEL,FMHMEDIA     TEST FMH DESTINATION             R41 S3105600
         BNZ   MVDDS(R15)          ENTER ROUTINE IF NOT CONSLE @OZ18406 S3105700
         TM    RPLCHN,RPLONLY      ELSE, TEST FOR ONLY IN CHAIN     R41 S3105800
         BO    MVDDS(R15)          BR IF YES, HANDLE CONSOLE        R41 S3105900
         B     MVDX0811            FAIL IF NOT OC (X'0811')         R41 S3106000
         SPACE 3                                               @OZ29180 S3106100
MVICEST  DC    AL1(ICERESUM)       RESUME DATA STREAM          @OZ29180 S3106200
         DC    AL1(ICENMEND)       END DATA STREAM             @OZ29180 S3106300
         DC    AL1(ICEBEGIN)       BEGIN DATA STREAM           @OZ29180 S3106400
         DC    AL1(ICEODS)         BEGIN/END DATA STREAM       @OZ29180 S3106500
         DC    AL1(ICESPEND)       SUSPEND DATA STREAM         @OZ29180 S3106600
         DC    AL1(ICEABEND)       ABORT DATA STREAM           @OZ29180 S3106700
         DC    AL1(ICECONT)        CONTINUE DATA STREAM        @OZ29180 S3106800
         DC    AL1(0)              RESERVED                    @OZ29180 S3106900
         SPACE 1                                               @OZ29180 S3107000
MVDDS    DC    AL1(MVDDSRES-MVDDS) 'RESUME DATA STREAM'        @OZ29180 S3107100
         DC    AL1(MVDDSEND-MVDDS) 'END DATA STREAM' (NORMAL)        R4 S3107500
         DC    AL1(MVDDSBGN-MVDDS) 'BEGIN DATA STREAM'               R4 S3108000
         DC    AL1(MVDDSONL-MVDDS) 'ONLY CHAIN IN DATA STREAM'       R4 S3108500
         DC    AL1(MVDDSEND-MVDDS) 'SUSPEND DATA STREAM'             R4 S3109000
         DC    AL1(MVDDSEND-MVDDS) 'END DATA STREAM' (ABORTING)      R4 S3109500
         DC    AL1(MVDDSCNT-MVDDS) 'CONTINUE DATA STREAM'      @OZ29180 S3110000
         DC    AL1(MVDDSERR-MVDDS) ERROR, SENSE X'1008' INVALID FMH  R4 S3110500
         EJECT                                                 @OZ29180 S3112000
MVDDSERR B     MVDX1008            FAIL, SNS X'1008' INVALID FM HDR  R4 S3112500
         SPACE 1                                                     R4 S3113000
MVDDSEND TM    SHWSTAT,ICEALLOC    TEST SESSION STATUS               R4 S3113500
         BO    MVDECFMH            IF ALLOCATED LOOP FOR NEXT FM HDR R4 S3114000
         B     MVDX1008            FAIL IF EDS/ADS AND NOT ALLOCATED R4CS3114500
                                    (SENSE X'1008', INVALID FM HDR)  R4 S3115000
         SPACE 1                                               @OZ29180 S3115100
MVDDSCNT TM    SHWSTAT,ICEALLOC    TEST SESSION STATUS         @OZ29180 S3115200
         BZ    MVDX1008            FAIL IF NOT ALLOCATED       @OZ29180 S3115300
         TM    FMHSEL,FMHMEDIA     TEST SELECTED MEDIUM        @OZ29180 S3115350
         BZ    MVDX1008            FAIL IF CONSOLE             @OZ29180 S3115375
         TM    DCTDEVTP,DCTRJR     TEST FOR REMOTE READER      @OZ29180 S3115400
         BZ    MVDX1008            FAIL IF NOT REMOTE READER   @OZ29180 S3115500
         TM    RPLCHN,RPLONLY      TEST FOR ONLY IN CHAIN      @OZ29180 S3115600
         BZ    MVDX0811            FAIL IF NOT OC              @OZ29180 S3115700
         B     SKIP770             TEST FOR COMPRESS/COMPACT   @OZ29180 S3115800
         SPACE 1                                               @OZ29180 S3115900
MVDDSRES TM    SHWSTAT,ICEALLOC    TEST SESSION STATUS               R4 S3116000
         BO    MVDX1008            FAIL IF RDS AND ALLOCATED         R4CS3116500
                                    (SENSE X'1008', INVALID FM HDR)  R4 S3117000
         SPACE 1                                                     R4 S3117500
MVDDSBGN TM    FMHSEL,FMHMEDIA     TEST SELECTED MEDIUM              R4 S3118000
         BZ    MVDX0811            FAIL IF CONSOLE & NOT 'END D.S.'  R4CS3118500
                                    (SENSE X'0811', BREAK)           R4 S3119000
         SPACE 1                                                     R4 S3119500
MVDDSONL TM    SHWSTAT,ICEALLOC    TEST SESSION STATUS               R4 S3120000
         BZ    SKIP770             BR IF NOT ALLOCD, ELSE IMPL SUSPD R4 S3120500
         TM    MDCTSEL,FMHMEDIA    TEST ACTIVE DATA STREAM MEDIUM    R4 S3121000
         BZ    MVDX1008            FAIL IF TRYING TO SUSPD CONSOLE   R4CS3121500
                                    (SENSE X'1008', INVALID FM HDR)  R4 S3122000
SKIP770  NI    SHWTFMTM,255-DCTPPRES-DCTPCPCT  ASSSUME NO      @OZ29180CS3122500
                                   COMPRESSION NO COMPACTION   @OZ29180 S3122600
         TM    FMHPROPS,FMHCPRSS   TEST DATA STREAM PROPERTIES @OZ29180 S3122700
         BZ    MVDDS01             BRANCH IF NO COMPRESSION    @OZ29180 S3122800
         TM    BINSECP,BINSCMP     TEST SEC NAU PROTOCOLS      @OZ29180 S3122900
         BZ    MVDX0826            FAIL IF COMPRESSION NOT     @OZ29180CS3123000
                                   SUPPORTED                   @OZ29180 S3123100
         OI    SHWTFMTM,DCTPPRES   SET COMPRESSION ON          @OZ29180 S3123200
         SPACE 1                                               @OZ29180 S3123300
MVDDS01  TM    FMHPROPS,FMHCPACT   TEST DATA STREAM PROPERTIES @OZ29180 S3123400
         BZ    MVDDS02             BRANCH IF NO COMPACTION     @OZ29180 S3123500
         TM    BINSFMB1,BINCMPCT   TEST SECONDARY PROTOCOLS    @OZ29180 S3123600
         BZ    MVDX0826            FAIL IF COMPACTION NOT      @OZ29180CS3123700
                                   SUPPORTED                   @OZ29180 S3123800
         OI    SHWTFMTM,DCTPCPCT   SET COMPACTION ON           @OZ29180 S3123900
         SPACE 1                                               @OZ29180 S3124000
MVDDS02  CLI   0(R1),ICECONT       TEST FOR CDS FMH            @OZ29180 S3124500
         BE    MVDDSLRC            BRANCH IF CDS               @OZ29180 S3125000
         TM    FMHSEL,FMHMEDIA     TEST SELECTED MEDIUM        @OZ29180 S3125500
         BZ    MVDECFMH            LOOP IF CONSOLE. LET RDCT ADR = 0 R4 S3126000
         NI    FMHBYTE3,255-FMHDMAND  FORCE DMAND SLCT BIT OFF @OZ29180 S3126500
         TM    FMHPROPS,FMHBEGIN   TEST DATA STREAM ACTION           R4 S3127000
         BNZ   MVDCTFND            SEEK AVAIL. RDCT IF NOT 'RESUME'  R4 S3127500
         EJECT                                                       R4 S3128000
*                                                                    R4 S3128500
*                             FIND REMOTE DCT IN SUSPENDED CHAIN     R4 S3129000
*                                                                    R4 S3129500
         SPACE 1                                                     R4 S3130000
         LA    MDCT,ICESDCT-(MDCTSDCT-DCTDSECT)  FAKE ZERO SUSP RDCT R4 S3130500
         SPACE 1                                                     R4 S3131000
MVDCTSSP LR    R15,MDCT            SAVE PREVIOUS RDCT ADDRESS        R4 S3131500
         L     MDCT,MDCTSDCT       GET NEXT SUSPENDED RDCT ADDRESS   R4 S3132000
         LTR   MDCT,MDCT           TEST                              R4 S3132500
         BZ    MVDX0825            BR IF NO MORE RDCT'S, CAN'T ALLOC   CS3133000
                                    (SENSE X'0825', CMPON NOT AVAIL) R4 S3133500
         CLC   FMHSEL,MDCTSEL      COMPARE SELECT BYTES              R4 S3134000
         BNE   MVDCTSSP            LOOP FOR NEXT RDCT IF NOT A MATCH R4 S3134500
         ST    R15,SHWRDCT         STORE PREV RDCT ADDR FOR REALLOC. R4 S3135000
         B     MVDECFMH            LOOP BACK FOR NEXT FM HEADER      R4 S3135500
         SPACE 3                                                     R4 S3136000
*                                                                    R4 S3136500
*                             FIND AN ELIGIBLE REMOTE DCT            R4 S3137000
*                                                                    R4 S3137500
         SPACE 1                                                     R4 S3138000
MVDCTFND CLI   FMHSEL,FMHEXCH+FMHLDANY  TEST INCOMING MEDIUM   @OZ29180 S3138500
         BH    SKIP790             BRANCH IF NOT 'EXCH'        @OZ29180 S3139000
         MVZ   FMHSEL,=AL1(FMHCARD)  ELSE CHNGE EXCH TO CARD   @OZ29180 S3139500
SKIP790  IC    R15,FMHSEL          GET DESIRED MEDIUM & LOGICAL DEV. R4 S3140000
         SLR   R0,R0               ASSUME ZERO MASK, SPECIFIC DEVICE R4 S3140500
         TM    FMHSEL,FMHLDANY     TEST FM HEADER LOGICAL DEVICE     R4 S3141000
         BNO   SKIP800             BRANCH IF NOT GENERAL REQUEST     R4 S3141500
         LA    R0,FMHLDANY         LOAD MASK FOR ANY AVAILABLE DEV.  R4 S3142000
SKIP800  SLR   R1,R1               CLEAR REG FOR RDCT SELECT BYTE    R4 S3142500
         L     MDCT,ICELDCT        GET ADDRESS OF LINE DCT           R4 S3143000
         SPACE 1                                                     R4 S3143500
MVDCTGET L     MDCT,MDCTDCT        GET RDCT ADDRESS                  R4 S3144000
         LTR   MDCT,MDCT           TEST RDCT ADDRESS                 R4 S3144500
         BZ    MVDX0825            BR IF NO MORE RDCT'S, CAN'T ALLOC   CS3145000
                                    (SENSE X'0825', CMPON NOT AVAIL) R4 S3145500
         IC    R1,MDCTSEL          GET REMOTE DCT SELECT BYTE        R4 S3146000
         OR    R1,R0               OVERLAY GEN. REQUEST CODE IF NEC. R4 S3146500
         CLR   R1,R15              COMPARE SELECT BYTES              R4 S3147000
         BNE   MVDCTGET            LOOP FOR NEXT RDCT IF NOT A MATCH R4 S3147500
         TM    DCTSTAT,DCTINUSE+DCTDRAIN  TEST RDCT STATUS           R4 S3148000
         BNZ   MVDCTGET            LOOP FOR NEXT RDCT IF UNAVAILABLE R4 S3148500
         ST    MDCT,SHWRDCT        STORE RDCT ADDRESS FOR ALLOCATION R4 S3149000
MVDDSLRC MVC   MDCTRECL,DCTLRECL   SET LRECL TO JES2 DEFAULT   @OZ29180 S3149100
         CLI   FMHERCL,0           LRECL SPECIFIED IN BDS      @OZ29180 S3149200
         BE    MVDECFMH            NO, LOOP FOR MORE FM HDRS   @OZ29180 S3149300
         MVC   MDCTRECL,FMHERCL    SET LRECL FROM BDS FMH      @OZ29180 S3149400
         B     MVDECFMH            LOOP BACK FOR MORE FM HEADERS     R4 S3149500
         EJECT                                                       R4 S3150000
*                                                                    R4 S3150500
*                        SET ERROR SENSE CODES FOR NEGATIVE RESPONSE R4 S3151000
*                                                                    R4 S3151500
         SPACE 1                                                     R4 S3152000
*                             C.P.M.(R.H.) ERRORS - MAJOR CODE X'40' R4 S3152500
         SPACE 1                                                     R4 S3153000
MVDX4003 DS    0H                  CLASSIFY                          R4 S3153500
MVDX4004 EQU   *                    'SHOULD                          R4 S3154000
MVDX4009 EQU   *                     NEVER                           R4 S3154500
MVDX400B EQU   *                      OCCUR'                         R4 S3155000
MVDX400C EQU   *                       C.P.M.                        R4 S3155500
MVDX400F EQU   *                        ERRORS                       R4 S3156000
MVDX4010 EQU   *                         TOGETHER                    R4 S3156500
MVDX400X BAL   R15,MVDXNRSP        SEND NEGATIVE RESPONSE & RETURN   R4 S3157000
         DC    AL1(RPLCPMO,0,0,0) DUMMY C.P.M. ERROR CODE            R4 S3157500
         SPACE 2                                                     R4 S3158000
*                             STATE ERRORS - MAJOR CODE X'20'        R4 S3158500
         SPACE 1                                                     R4 S3159000
MVDX2002 BAL   R15,MVDXNRSP        SEND NEGATIVE RESPONSE & RTN     R41 S3159500
         DC    AL1(RPLSTATO,X'02',0,0) 'CHAIN STATE ERROR' CODE     R41 S3159600
         SPACE 1                                                    R41 S3159700
MVDX2003 BAL   R15,MVDXNRSP        SEND NEGATIVE RESPONSE & RTN     R41 S3160000
         DC    AL1(RPLSTATO,X'03',0,0) 'BRACKET STATE ERR' CODE     R41 S3160100
         SPACE 1                                                    R41 S3160200
MVDX2004 BAL   R15,MVDXNRSP        SEND NEGATIVE RESPONSE & RTN     R41 S3160500
         DC    AL1(RPLSTATO,X'04',0,0) 'DIRECTION ERROR' CODE       R41 S3161500
         SPACE 2                                                     R4 S3162000
*                             FUNC INTRPTR ERRORS - MAJOR CODE X'10' R4 S3162500
         SPACE 1                                                     R4 S3163000
MVDX1003 BAL   R15,MVDXNRSP        SEND NEGATIVE RESPONSE & RETURN   R4 S3163500
         DC    AL1(RPLFIO,X'03',0,0) 'FUNCTION NOT SUPPORTED' CODE   R4 S3164000
         SPACE 1                                                     R4 S3164500
MVDX1008 BAL   R15,MVDXNRSP        SEND NEGATIVE RESPONSE & RETURN   R4 S3165000
         DC    AL1(RPLFIO,X'08',0,0) 'INVALID FM HEADER' CODE        R4 S3165500
         SPACE 2                                                     R4 S3166000
*                             REQUEST REJECT - MAJOR CODE X'08'      R4 S3166500
         SPACE 1                                                     R4 S3167000
MVDX0811 BAL   R15,MVDXNRSP        SEND NEGATIVE RESPONSE & RETURN   R4 S3167500
         DC    AL1(RPLRRO,X'11',0,0) 'BREAK, I DON'T LIKE IT' CODE   R4 S3168000
         SPACE 1                                                     R4 S3168500
MVDX0819 BAL   R15,MVDXNRSP        SEND NEGATIVE RESPONSE & RETURN   R4 S3169000
         DC    AL1(RPLRRO,X'19',0,0) 'RTR NOT REQUIRED' CODE         R4 S3169500
         SPACE 1                                                     R4 S3170000
MVDX0825 BAL   R15,MVDXNRSP        SEND NEGATIVE RESPONSE & RETURN   R4 S3170500
         DC    AL1(RPLRRO,X'25',0,0) 'COMPONENT NOT AVAILABLE' CODE  R4 S3171000
         SPACE 1                                                     R4 S3171500
MVDX0826 BAL   R15,MVDXNRSP        SEND NEGATIVE RESPONSE & RETURN   R4 S3172000
         DC    AL1(RPLRRO,X'26',0,0) 'FUNCTION NOT SUPPORTED' CODE   R4 S3172500
         EJECT                                                       R4 S3173000
*                             SEND -RSP AND RESTORE PRE-CHAIN STATE  R4 S3173500
         SPACE 1                                                     R4 S3174000
MVDXNRSP MVC   RPLFDBK2,0(R15)     SET INBOUND SENSE FOR MSG LOGGING R4 S3174500
         SPACE 1                                                     R4 S3175000
MVDXRQST MVC   RPLOSENS,RPLFDBK2   COPY INBOUND TO OUTBOUND SENSE    R4 S3175500
         OI    RPLVTFL2,RPLEX      TURN ON EXCEPTION RESPONSE BIT   R41 S3175600
         LA    R15,MVFRESPN        POINT TO EXCEPTION RESP ROUTINE  R41 S3175700
         CLC   RPLCNTDF(3),MSNADATA  TEST FAILING REQUEST TYPE       R4 S3176000
         BNER  R15                 BR IF SESSION OR DATA FLOW CNTRL R41 S3176500
         NI    ICEFLAGS,255-ICEBBPND-ICEEBPND-ICECHDIR  RESET PENDS. R4 S3177000
         TM    BINCMNP2,BINRCVR    TEST COMMON PROTOCAL        @OZ34188 S3177500
         BO    MVDXPRGE            IF SENDER TAKES CARE OF RECOVERY R41CS3178000
                                    DON'T CHGE DIRECTION, JUST PURGE R4 S3178500
         OI    ICEFLAGS,ICECHDIR   ELSE GO TO OUTBOUND AT NEXT EOC   R4 S3179000
         SPACE 1                                                    R41 S3179500
MVDXPRGE OI    ICERCVST,ICEINCHN+ICECNCEL  ENTER PURGING CHAIN STATER41 S3180000
         TM    RPLCHN,RPLLAST+RPLONLY  TEST R.U. CHAIN POSITION     R41 S3180500
         BZ    MVRSTATI            IF NOT EOC, STAY IN PURGE STATE  R41 S3181000
         NI    ICERCVST,255-ICEINCHN  SHOW PURGED CHAIN HAS ENDED   R41 S3181100
         B     MVRSTATI            GO UPDATE RECEIVING STATE MACHINER41 S3181200
         SPACE 1                                                     R4 S3181500
         DROP  R14                 DISCARD BIND IMAGE ADDRESSABILITY R4 S3182000
         EJECT                                                       R4 S3182500
*                                                                    R4 S3183000
*                        HANDLE SESSION & DATA FLOW CONTROL REQUESTS R4 S3183500
*                                                                    R4 S3184000
         SPACE 1                                                     R4 S3184500
MVDFCTRL LA    WA,MVDFCLST+MVDFCL  POINT AT LIST OF DFC & SC CODES   R4 S3185000
         LA    R1,MVDFCEND         POINT AT LAST ENTRY IN LIST       R4 S3185500
         LA    R0,MVDFCL           LOAD LENGTH OF ONE ENTRY          R4 S3186000
SKIP820  CLC   1(3,WA),RPLCNTDF    SEARCH FOR R.U. TYPE              R4 S3186500
         BE    SKIP810             BRANCH IF FOUND                   R4 S3187000
         BXLE  WA,R0,SKIP820       LOOP BACK UNTIL LIST EXHAUSTED    R4 S3187500
SKIP810  LA    R0,MVDFCLST         CALCULATE INDEX                   R4 S3188000
         SLR   WA,R0                IN DFC LIST OF                   R4 S3188500
         SRL   WA,2                  MATCHING ENTRY                  R4 S3189000
         STC   WA,SHWCNTRL         SAVE INDEX IN WORK AREA           R4 S3189500
         IC    R15,*+8(WA)         GET OFFSET TO HANDLING ROUTINE    R4 S3190000
         B     MVDFC(R15)          BRANCH TO CORRECT ROUTINE         R4 S3190500
         SPACE 1                                                     R4 S3191000
         DC    AL1(MVDFCR01-MVDFC)      DATA   NOT APPLICABLE        R4 S3191500
         DC    AL1(MVDFCNCL-MVDFC)    CANCEL   RESCIND PENDING STATE R4 S3192000
*        DC    AL1(MVDFC***-MVDFC)        QC   NOT SUPPORTED         R4 S3192500
*        DC    AL1(MVDFC***-MVDFC)       QEC   NOT SUPPORTED         R4 S3193000
*        DC    AL1(MVDFC***-MVDFC)     CHASE   NOT SUPPORTED         R4 S3193500
*        DC    AL1(MVDFC***-MVDFC)      RELQ   NOT SUPPORTED         R4 S3194000
         DC    AL1(MVDFCERR-MVDFC)       BID   NOT SUPPORTED INBOUND R4 S3194500
         DC    AL1(MVDFCRTR-MVDFC)       RTR   SEND 'RTR NOT NEEDED' R4 S3195000
         DC    AL1(MVDFCLUS-MVDFC)       LUS   ONLY INTV REQD SUPPTD R4 S3195500
         DC    AL1(MVDFCSIG-MVDFC)    SIGNAL   BREAK OUTBOUND STREAM R4 S3196000
*        DC    AL1(MVDFC***-MVDFC)       SDT   NOT SUPPORTED         R4 S3196500
*        DC    AL1(MVDFC***-MVDFC)     CLEAR   NOT SUPPORTED         R4 S3197000
*        DC    AL1(MVDFC***-MVDFC)      STSN   NOT SUPPORTED         R4 S3197500
*        DC    AL1(MVDFC***-MVDFC)     SHUTD   NOT SUPPORTED         R4 S3198000
*        DC    AL1(MVDFC***-MVDFC)     SHUTC   NOT SUPPORTED         R4 S3198500
*        DC    AL1(MVDFC***-MVDFC)       RQR   NOT SUPPORTED         R4 S3199000
         DC    AL1(MVDFCRSH-MVDFC)     RSHUT   DRAIN SESSION         R4 S3199500
         DC    AL1(MVDFCERR-MVDFC) ANY OTHER TYPE - NOT SUPPORTED    R4 S3200000
         EJECT                                                       R4 S3200500
MVDFCLST DS    0F                  DFC CODES IN RPLCNTDF/RPLCNTDC    R4 S3201000
MVDFCL   EQU   4                   TABLE ENTRY LENGTH                R4 S3201500
         DC    AL1(0)                   DATA   -                     R4 S3202000
MSNADATA DC    AL1(RPLDATA,0,0)    (RPLCNTDF)  DATA R.U.             R4 S3202500
         DC    AL1(0)                 CANCEL   -                     R4 S3203000
MSNACNCL DC    AL1(RPLCNCEL,0,0)   (RPLCNTDF) 'CANCEL'               R4 S3203500
*        DC    AL1(0)                     QC   -                     R4 S3204000
*SNAQC   DC    AL1(RPLQC,0,0)      (RPLCNTDF) 'QUIESCE COMPLETE'     R4 S3204500
*        DC    AL1(0)                    QEC   -                     R4 S3205000
*SNAQEC  DC    AL1(RPLQEC,0,0)     (RPLCNTDF) 'QUIESCE AT END OF CH' R4 S3205500
*        DC    AL1(0)                  CHASE   -                     R4 S3206000
*SNACHSE DC    AL1(RPLCHASE,0,0)   (RPLCNTDF) 'CHASE'                R4 S3206500
*        DC    AL1(0)                   RELQ   -                     R4 S3207000
*SNARELQ DC    AL1(RPLRELQ,0,0)    (RPLCNTDF) 'RELEASE QUIESCE'      R4 S3207500
         DC    AL1(0)                    BID   -                     R4 S3208000
MSNABID  DC    AL1(0,RPLBID,0)     (RPLCNTDC) 'BID'                  R4 S3208500
         DC    AL1(0)                    RTR   -                     R4 S3209000
MSNARTR  DC    AL1(0,RPLRTR,0)     (RPLCNTDC) 'READY TO RECEIVE'     R4 S3209500
         DC    AL1(0)                    LUS   -                     R4 S3210000
MSNALUS  DC    AL1(0,RPLLUS,0)     (RPLCNTDC) 'LOGICAL UNIT STATUS'  R4 S3210500
         DC    AL1(0)                 SIGNAL   -                     R4 S3211000
MSNASGNL DC    AL1(0,RPLSIGNL,0)   (RPLCNTDC) 'SIGNAL'               R4 S3211500
*        DC    AL1(0)                    SDT   -                     R4 S3212000
*SNASDT  DC    AL1(0,0,RPLSDT)     (RPLCNTSC) 'START DATA TRAFFIC'   R4 S3212500
*        DC    AL1(0)                  CLEAR   -                     R4 S3213000
*SNACLR  DC    AL1(0,0,RPLCLEAR)   (RPLCNTSC) 'CLEAR'                R4 S3213500
*        DC    AL1(0)                   STSN   -                     R4 S3214000
*SNASTSN DC    AL1(0,0,RPLSTSN)    (RPLCNTSC) 'SET & TEST SEQUENCE'  R4 S3214500
*        DC    AL1(0)                  SHUTD   -                     R4 S3215000
*SNASHTD DC    AL1(0,0,RPLSHUTD)   (RPLCNTSC) 'SHUTDOWN'             R4 S3215500
*        DC    AL1(0)                  SHUTC   -                     R4 S3216000
*SNASHTC DC    AL1(0,0,RPLSHUTC)   (RPLCNTSC) 'SHUTDOWN COMPLETE'    R4 S3216500
*        DC    AL1(0)                    RQR   -                     R4 S3217000
*SNARQR  DC    AL1(0,0,RPLRQR)     (RPLCNTSC) 'REQUEST RECOVERY'     R4 S3217500
         DC    AL1(0)                  RSHUT   -                     R4 S3218000
MSNARSHT DC    AL1(0,0,RPLRSHUT)   (RPLCNTSC) 'REQUEST SHUTDOWN'     R4 S3218500
MVDFCEND EQU   *-MVDFCL            LAST VALID ENTRY IN TABLE         R4 S3219000
         EJECT                                                       R4 S3219500
*                                                                    R4 S3220000
*                             FINISH HANDLING DFC'S THAT ALLOW EB/CD R4 S3220500
*                                                                    R4 S3221000
         SPACE 1                                                     R4 S3221500
MVDFCFIN L     R0,SHWSTAT          UPDATE                            R4 S3222000
         ST    R0,ICESTAT           ICE STATE                        R4 S3222500
         LR    WA,ML               SAVE 1ST LEVEL RETURN ADDR.      R41 S3223000
         ICM   WA,8,SHWCNTRL        WITH D.F.C. TYPE INDEX          R41 S3223500
         BAL   ML,MVFRESPD         SEND +RSP AND FREE BUFFER        R41 S3224000
         LR    ML,WA               RESTORE 1ST LVL RETURN ADDR.     R41 S3224500
         SRL   WA,24               ISOLATE D.F.C. TYPE INDEX        R41 S3225000
         IC    WA,*+8(WA)          BRANCH ON D.F.C.                  R4 S3225500
         B     MVDFC(WA)            TYPE USING TABLE                 R4 S3226000
         SPACE 2                                                     R4 S3226500
         DC    AL1(MVDFCR01-MVDFC) DATA - LOGIC ERROR                R4 S3227000
         DC    AL1(MVDFCNC2-MVDFC) 'CANCEL' - SET RDCT DELETE BITS   R4 S3227500
*        DC    AL1(MVDFC***-MVDFC) 'QUIESCE COMPLETE' NOT SUPPORTED  R4 S3228000
*        DC    AL1(MVDFC***-MVDFC) 'QUIESCE AT END CH' NOT SUPPORTED R4 S3228500
*        DC    AL1(MVDFC***-MVDFC) 'CHASE' NOT SUPPORTED             R4 S3229000
*        DC    AL1(MVDFC***-MVDFC) 'RELEASE QUIESCE' NOT SUPPORTED   R4 S3229500
         DC    AL1(MVDFCR01-MVDFC) 'BID' NOT SUPPORTED INBOUND       R4 S3230000
         DC    AL1(MVDFCR01-MVDFC) 'RDY TO RCV' - LOGIC ERROR        R4 S3230500
         DC    AL1(MVDFCLUT-MVDFC) 'LU STAT' RESET OUTB LOCK   @OZ27491 S3231000
         DC    AL1(MVDFCR01-MVDFC) 'SIGNAL' - LOGIC ERROR            R4 S3231500
*        DC    AL1(MVDFC***-MVDFC) 'STRT DATA TRAFFIC' NOT SUPPORTED R4 S3232000
*        DC    AL1(MVDFC***-MVDFC) 'CLEAR' NOT SUPPORTED             R4 S3232500
*        DC    AL1(MVDFC***-MVDFC) 'SET/TEST SEQ NBRS' NOT SUPPORTED R4 S3233000
*        DC    AL1(MVDFC***-MVDFC) 'SHUTDOWN' NOT SUPPORTED          R4 S3233500
*        DC    AL1(MVDFC***-MVDFC) 'SHUTDOWN COMPLETE' NOT SUPPORTED R4 S3234000
*        DC    AL1(MVDFC***-MVDFC) 'REQUEST RECOVERY'  NOT SUPPORTED R4 S3234500
         DC    AL1(MVDFCR01-MVDFC) 'REQUEST SHUTDOWN' - LOGIC ERROR  R4 S3235000
         DC    AL1(MVDFCR01-MVDFC) ANY OTHER TYPE - LOGIC ERROR      R4 S3235500
         SPACE 3                                                     R4 S3236000
MVDFC    DS    0H                  ORIGIN FOR BRANCH TABLE OFFSETS   R4 S3236500
         SPACE 1                                                     R4 S3237000
MVDFCR01 BAL   R8,R01              CATASTROPHIC ERR IN RPL     @OZ52502 S3237500
         SPACE 1                                                     R4 S3238000
MVDFCERR B     MVDX1003            FAIL, SNSE X'1003' FUNC NOT SUPPD R4 S3238500
         SPACE 1                                                     R4 S3239000
MVDFCRSH LR    WA,ML               SAVE 1ST LEVEL RETURN ADDRESS     R4 S3239500
         BAL   ML,MVFREPRG         DISPOSE OF BUFFER                 R4 S3240000
         LR    ML,WA               RESTORE 1ST LEVEL RETURN ADDRESS  R4 S3240500
         B     MICETRAP            TREAT AS SESSION DRAIN REQUEST    R4 S3241000
         EJECT                                                       R4 S3241500
MVDFCSIG CLC   RPLSIGDA,=X'00010000'  TEST SIGNAL CODE               R4 S3242000
         BNE   MVFREPRG            THROW AWAY SIGNAL IF NOT CD REQST R4 S3242500
         TM    ICEFLAGS,ICEOUTBD+ICEREVFL  TEST SESSION STATUS      R41 S3243000
         BZ    MVFREPRG            THROW AWAY SIGNAL IF NOT OUTBOUND R4 S3243500
         TM    ICEFLAGS,ICEOUTBD   TEST SESSION STATUS              R41 S3243600
         BZ    MVDFCSI2            SET FLAG IF STREAM IS SUSPENDED  R41 S3243700
         TM    ICESTAT,ICEALLOC    TEST SESSION STATUS               R4 S3244000
         BZ    MICEGICD            SEND CHANGE DIR IF NOT ALLOCATED  R4 S3244500
         TM    ICESNDST,ICEINCHN   TEST SESSION SEND STATUS          R4 S3245000
         BO    MVDFCSI1            JUST SET FLAG IF IN CHAIN         R4 S3245500
         ICM   R0,7,DCTBUFAD+1     CHECK DCT BUFFER ANCHOR           R4 S3246000
         BNZ   MVDFCSI1            SET FLAG IF HAVE 1ST BUF OF CHAIN R4 S3246500
         TM    DCTSTAT,DCTRTAM     TEST WHERE PROCESSOR IS WAITING   R4 S3247000
         BZ    MICEGICD            SEND CHANGE DIR IF NOT IN RTAM    R4 S3247500
         SPACE 1                                                     R4 S3248000
MVDFCSI1 TM    DCTDEVTP,DCTRPU     TEST REMOTE DEVICE TYPE           R4 S3248500
         BO    MVDFCHIP            FORCE HI-PRIORITY INTRPT IF PUNCH R4 S3249000
         TM    MDCTSEL,FMHMEDIA    TEST MEDIUM SELECTED              R4 S3249500
         BZ    MVDFCHIP            BR IF CONSOLE - FORCE HIGH PRIO  R41 S3250000
         L     MDCT,ICELDCT        GET ADDRESS OF LINE DCT           R4 S3250500
         L     R15,MDCTRAT         GET ADDRESS OF RAT ENTRY          R4 S3251000
         USING RATDSECT,R15        TEMPORARY RAT ADDRESSABILITY      R4 S3251500
         TM    RATCONF,RATCONFC+RATCONFO  TEST CONSOLE AVAILABITY    R4 S3252000
         BO    MVDFCHIP            ALWAYS HI-PRIO INTERRUPT IF AVAIL R4 S3252500
MVDFCSI2 XI    ICEFLGS2,ICESIGNL   INVERT 'SIGNAL-RECEIVED'    @OZ29180 S3253000
         TM    ICEFLGS2,ICESIGNL   TEST NEW FLAG VALUE         @OZ29180 S3253500
         BO    MVFREPRG            IF ON, PROCESSING DONE - GO PURGE R4 S3254000
         SPACE 1                                                     R4 S3254500
MVDFCHIP OI    ICEFLGS2,ICESIGNL+ICEBREAK  SHOW HI-PRTY INTRP  @OZ29180 S3255000
         B     MVFREPRG                    (2 CONSECUTIVE SIGNAL'S)  R4 S3255500
         DROP  R15                 DISCARD TEMP RAT ADDRESSABILITY   R4 S3256000
         SPACE 1                                                     R4 S3256500
MVDFCRTR NI    ICESTAT,255-ICERTRPD  RESET 'READY TO RECVE PENDING'  R4 S3257000
         B     MVDX0819            SEND SENSE X'0819', RTR NOT REQD  R4 S3257500
         SPACE 1                                                     R4 S3258000
MVDFCNCL NI    SHWRCVST,255-ICEINCHN  SHOW PURGED CHAIN ENDED        R4 S3258500
         NI    SHWFLAGS,255-ICEBBPND-ICEEBPND-ICECHDIR  CLEAR PENDS. R4 S3259000
         OI    SHWRCVST,ICECNCEL   SHOW CANCEL RECEIVED              R4 S3259500
MVDFCLUS B     MVDCHNOP            BRANCH TO BRACKET S.M. TO HANDLE    CS3260000
                                   BB/EB/CD ON 'CANCEL'/'LUS' REQST  R4 S3260500
MVDFCLUT L     R15,ICELUSTA        GET AND INCREMENT THE       @OZ27491 S3260600
         LA    R15,1(,R15)          COUNT OF LUSTAT'S RECEIVED @OZ27491 S3260700
         ST    R15,ICELUSTA          ON THIS SESSION           @OZ27491 S3260800
MVDFCLU2 CLC   RPLFDBK2(2),=X'0001'  TEST 'LUSTAT' SENSE CODE  @OZ24835 S3261000
         BNER  ML                  RETURN IF NOT 'COMPONENT AVAIL.'  R4 S3261500
         NI    ICESTAT,255-ICEHOLD ELSE ALLOW OUTBD ALLOC BANNED BY  R4 S3262000
         BR    ML                   YIELDING CONTENTION, AND RETURN  R4 S3262500
         SPACE 1                                                     R4 S3263000
MVDFCNC2 LA    R1,ICERCVST         POINT TO RECEIVE STATUS BYTE     R41 S3263500
         TM    ICESTAT,ICEALLOC    TEST FOR ALLOCATED SESSION       R41 S3263600
         BZ    MVRSTATC            BR IF NO, RESCIND PENDING FMH    R41 S3263700
         OI    DCTFLAGS,DCTDELET+DCTRSTRT  TELL PRCSR TO CANCEL JOB R41 S3264000
         B     MVRSTATC            GO RESCIND PENDING FMH IF ANY     R4 S3264500
         EJECT                                                       R4 S3265000
*                             FM HEADERS EXHAUSTED OR NONE PRESENT   R4 S3265500
         SPACE 1                                                     R4 S3266000
MVDNOFMH TM    SHWRCVST,ICEINSTR   TEST RECEIVE STATUS               R4 S3266500
         BO    MVDSTATE            GO UPDATE STATE IF IN STREAM      R4 S3267000
         TM    SHWRCVST,ICENOFMH   TEST RECEIVE STATUS AGAIN         R4 S3267500
         BNO   MVDSTATE            GO UPDATE STATE IF FMH PENDING    R4 S3268000
         TM    RPLCHN,RPLONLY      TEST R.U. CHAIN POSITION          R4 S3268500
         BZ    MVDX0811            FAIL IF CNSLE RU NOT ONLY IN CHN    CS3269000
                                    (SENSE X'0811', BREAK)           R4 S3269500
         LTR   R1,R1               TEST R.U. LENGTH                  R4 S3270000
         BZ    MVDSTATE            DON'T PASS TO R.C.P. IF NO DATA   R4 S3270500
         NI    SHWRCVST,255-ICEDSTRM  MASK OUT DATA STRM BITS  @OZ29180 S3271000
         OI    SHWRCVST,ICEODS     SIMUATE 'ODS' FMH PENDING   @OZ29180 S3271500
         SPACE 1                                                     R4 S3272000
*                             UPDATE ICE STATE FROM WORK AREA        R4 S3272500
         SPACE 1                                                     R4 S3273000
MVDSTATE L     R0,SHWSTAT          UPDATE                            R4 S3273500
         ST    R0,ICESTAT           ICE STATE                        R4 S3274000
         TM    RPLCHN,RPLFIRST+RPLONLY  TEST R.U. CHAIN POSITION     R4 S3274500
         BZ    MVDALNOP            HOLD FMH STATE IF NOT 1ST IN CHN  R4 S3275000
         SLR   R15,R15             CLEAR REG FOR INDEX               R4 S3275500
         IC    R15,ICERCVST        GET FMH PENDING BITS              R4 S3276000
         SRL   R15,4                FROM RECEIVE STATUS        @OZ29180 S3276500
         SLL   R15,1                 AND USE AS AN INDEX       @OZ47584 S3276600
         LH    R15,*+8(R15)           INTO OFFSET TABLE        @OZ47584 S3277000
         B     MVDAL(R15)          BRANCH INTO CORRECT ROUTINE       R4 S3277500
         SPACE 1                                                     R4 S3278000
         DC    AL2(MVDALRAL-MVDAL) 'RESUME' - REALLOCATE       @OZ47584 S3278500
         DC    AL2(MVDALNOP-MVDAL) 'END (NORMAL)' - NO ACTION  @OZ47584 S3279000
         DC    AL2(MVDALIMS-MVDAL) 'BEGIN' - ALLOCATE          @OZ47584 S3279500
         DC    AL2(MVDALIMS-MVDAL) 'ONLY CHAIN' - ALLOCATE     @OZ47584 S3280000
         DC    AL2(MVDALNOP-MVDAL) 'SUSPEND' - NO ACTION       @OZ47584 S3280500
         DC    AL2(MVDALABT-MVDAL) 'END (ABORT)' - CANCEL JOB  @OZ47584 S3281000
         DC    AL2(MVDALCDS-MVDAL) 'CONTINUE' - NO ACTION      @OZ47584 S3281100
         DC    AL2(MVDALER-MVDAL) INVALID STATE                @OZ47584 S3281200
         DC    AL2(MVDALER-MVDAL) INVALID STATE                @OZ47584 S3281300
         DC    AL2(MVDALER-MVDAL) INVALID STATE                @OZ47584 S3281400
         DC    AL2(MVDALER-MVDAL) INVALID STATE                @OZ47584 S3281500
         DC    AL2(MVDALER-MVDAL) INVALID STATE                @OZ47584 S3281600
         DC    AL2(MVDALER-MVDAL) INVALID STATE                @OZ47584 S3281700
         DC    AL2(MVDALER-MVDAL) INVALID STATE                @OZ47584 S3281800
         DC    AL2(MVDALRLS-MVDAL) OUT OF STRM, NO T1 FMH,     @OZ47584CS3281900
                                   OIC, DATA LEN 0 - RLSE BUF  @OZ47584 S3282000
         DC    AL2(MVDALNOP-MVDAL) IN STRM, NO T1 FMH-NO ACT   @OZ47584 S3282500
         EJECT                                                      R41 S3283000
MVDAL    DS    0H                  ORIGIN FOR BRANCH TABLE OFFSETS   R4 S3283500
         SPACE 1                                                     R4 S3284000
MVDALER  BAL   R8,R01              INVALID STATE DETECTED      @OZ52502 S3284100
         SPACE 1                                               @OZ29180 S3284150
MVDALCDS NI    MDCTFMT,255-DCTPPRES-DCTPCPCT  TURN COMPRESSION @OZ29180 S3284200
*                                  AND COMPACTION FLGS OFF     @OZ29180 S3284250
         B     MVDALNOP            LINK BUFFER TO RDCT         @OZ29180 S3284300
         SPACE 1                                               @OZ29180 S3284350
MVDALRLS LA    R15,MVFRESPD        LOAD ADDR OF BUF DISPOSAL ROUTINE R4 S3284500
         B     MVRSTATI            RELEASE RESPONSE & UPDATE STATE   R4 S3285000
         SPACE 1                                                     R4 S3285500
         USING DCTDSECT,R15        USE TEMPORARY RDCT ADDRESSABILITY R4 S3286000
MVDALRAL L     R15,SHWRDCT         RELOAD ADDRESS OF PRECEDING RDCT  R4 S3286500
         L     MDCT,MDCTSDCT       GET ADDRESS OF DESIRED RDCT       R4 S3287000
         DROP  R15                 DISCARD TEMP RDCT ADDRESSABILITY  R4 S3287500
         NI    MDCTFMT,255-DCTPPRES-DCTPCPCT  RESET COMPRESSION BITS R4 S3288000
         LTR   MDCT,MDCT           TEST REMOTE DCT IMPLIED SUSPD BIT R4 S3288500
         BNM   MVDRSUMO            LEAVE 'RDS PENDG' IF NOT IMPLIED  R4 S3289000
MVDRSUMI OI    ICERCVST,ICEINSTR   ELSE GO IN STREAM AUTOMATICALLY   R4 S3289500
         SPACE 1                                                     R4 S3290000
MVDRSUMO L     R0,MDCTSDCT                CHAIN REMAINDER OF SUSPEND R4 S3290500
         ST    R0,MDCTSDCT-DCTDSECT(,R15)  QUEUE TO PREVIOUS RDCT    R4 S3291000
         XC    MDCTSDCT,MDCTSDCT   CLEAR SUSPENDED DCT CHAIN POINTER R4 S3291500
         CLI   DCTDEVTP,DCTRCON    IF NOT CONSOLE DCT, GO      @OZ47584 S3291510
         BNE   MVDALRCN             RECONNECT ICE AND RDCT     @OZ47584 S3291520
         NI    DCTSTAT,255-DCTHOLD TURN HOLD OFF FOR RDCT      @OZ47584 S3291600
         ST    MICE,MDCTICE        SAVE ICE ADDRESS FOR OPEN   @OZ47584 S3291700
         B     MVDALRCN            GO RECONNECT ICE AND RDCT         R4 S3292000
         SPACE 3                                                    R41 S3292500
*                             PASS R.U. TO CONSOLE PROCESSOR         R4 S3293000
         SPACE 1                                                     R4 S3293500
MVDCNSLE OI    ICESTAT,ICEALLOC    MARK ICE ALLOCATED                R4 S3294000
         LA    R15,$MCONMSG        PREPARE TO SCAN CONSOLE QUEUE     R4 S3294500
         B     MVDCNSL2              TO ADD NEW BUFFER AT END        R4 S3295000
         SPACE 1                                                    R41 S3295200
MVDCNSL1 LA    R15,TPBLCCAD-BUFDSECT(,R1)   ASSUME BSC BUFFER CHAIN  R4 S3295500
         TM    BUFTYPE-BUFDSECT(R1),BUFTP+BUFIOB TEST ASSUMPTN      R41 S3296000
         BO    MVDCNSL2            VALID, SKIP NEXT                 R41 S3296500
         LA    R15,RPLNEXT-RPLDSECT(,R1)    USE SNA CHAIN FIELD      R4 S3297000
MVDCNSL2 L     R1,0(,R15)          LOCATE NEXT BUFFER                R4 S3297500
         LTR   R1,R1               TEST FOR CHAIN END                R4 S3298000
         BNZ   MVDCNSL1            NO, CONTINUE SCANNING             R4 S3298500
         ST    MBUF,0(,R15)        ADD NEW BUFFER AFTER LAST         R4 S3299000
         L     R15,$MCONPCE        GET ADDRESS OF REMOTE CONSOLE PCE R4 S3299500
         LR    MBUF,R1             MAKE BUFFER ADDRESS UNAVAILABLE   R4 S3300000
         B     MVDALPST            REJOIN COMMON ALLOCATION LOGIC    R4 S3300500
         EJECT                                                      R41 S3301000
*                             ALLOCATE REMOTE DCT AND ICE            R4 S3301500
         SPACE 1                                                     R4 S3302000
MVDALIMS TM    SHWSTAT,ICEALLOC    TEST SESSION STATUS               R4 S3302500
         BZ    SKIP830             BR IF (AS EXPECTED) NOT ALLOCATED R4 S3303000
         L     MDCT,PCER1          ELSE GET RDCT FOR IMPLIED SUSPEND R4 S3303500
         LA    R1,ICERCVST         POINT TO STREAM RECEIVE STATUS    R4 S3304000
         B     MVRSTIMP            GO SUSPND. RETRN = MVDALLOC BELOW R4 S3304500
         SPACE 1                                                    R41 S3304800
SKIP830  L     MDCT,ICERDCT        SEE IF PRE-ALLOCATED              R4 S3305000
         LTR   MDCT,MDCT            REMOTE DCT IS PRESENT            R4 S3305500
         BZ    MVDALLOC            BRANCH IF NOT                     R4 S3306000
         OI    MDCTSTAT,DCTABORT   ELSE CAUSE OUTBOUND OPEN FAILURE  R4 S3306500
         SLR   R0,R0               CLEAR PRE-                        R4 S3307000
         ST    R0,MDCTICE           ALLOCATION                       R4 S3307500
         ST    R0,ICERDCT            POINTERS                        R4 S3308000
         SPACE 1                                                     R4 S3308500
MVDALLOC L     MDCT,SHWRDCT        LOAD ADDR OF DESIRED RDCT         R4 S3309000
         LTR   MDCT,MDCT           TEST ADDR OF DESIRED RDCT         R4 S3309500
         BZ    MVDCNSLE            RDCT ADDR NOT AVAIL = RMT CONSOLE R4 S3310000
         NI    DCTSTAT,255-DCTHOLD SHOW RDCT NO LONGER HELD          R4 S3310500
         NI    MDCTFMT,255-DCTPPRES-DCTPCPCT  RESET COMPRESSION BITS R4 S3311500
         NI    MDCTFMT,255-DCTPPRES  RESET COMPRESSION BIT           R4 S3312500
         ST    MICE,MDCTICE        CONNECT ICE TO REMOTE DCT         R4 S3313500
         SPACE 1                                                     R4 S3314000
MVDALRCN LA    MDCT,0(,MDCT)       CLEAR SUSPEND FLAGS IF ANY        R4 S3314500
         ST    MDCT,ICERDCT        RECONNECT RDCT TO ICE             R4 S3315000
         OI    ICESTAT,ICEALLOC    MARK ICE ALLOCATED                R4 S3315500
*                                  THIS CARD DELETED BY APAR   @OZ19494 S3316000
         L     R15,DCTPCE          GET PCE ADDRESS TO POST           R4 S3316500
         NI    MDCTSTAT,255-DCTPSUSP-DCTEOF  RESET SUSP & EOF FLAGS  R4 S3317000
MVDALPST $POST (R15),WORK          FIRE BEGINNING/RESUMING PROCESSOR R4 S3317500
         LTR   MBUF,MBUF           TEST BUF AD TO TELL WHO CALLER IS R4 S3318000
         BZ    MVREQRET            NO BUF = MVREQSTR CALL, SO RETURN R4 S3318500
         B     MVDALNOP            QUEUE BUFFER FOR DCT        @OZ47584 S3318550
         EJECT                                                       R4 S3319000
*                             LINK REQUESTED BUFFER TO REMOTE DCT    R4 S3319500
         SPACE 1                                                     R4 S3320000
MVDALABT OI    DCTFLAGS,DCTDELET+DCTRSTRT  PCE TO CANCEL JOB   @OZ47584 S3322450
MVDALNOP NI    MDCTFMT,255-DCTPALTC  RESET ALTERNATE CODE FLAG       R4 S3322500
         OC    MDCTFMT,SHWTFMTM    MERGE DCT FMT MASK INTO MDCTFMT   R4 S3323500
         L     R15,DCTBUFAD        TEST IF BUFFER                    R4 S3324000
         LTR   R15,R15              ON REMOTE DCT                    R4 S3324500
         BZ    SKIP840             BRANCH IF NOT                     R4 S3325000
         ST    MBUF,RPLNEXT-RPLDSECT(,R15)  SET UP RPL CHAIN FOR     R4 S3325500
         LR    MBUF,R15                      'GET' 2-BUFFER CASE     R4 S3326000
SKIP840  ST    MBUF,DCTBUFAD       CONNECT BUFFER TO NEW REMOTE DCT  R4 S3326500
         SPACE 2                                                     R4 S3327000
*                                                                    R4 S3327500
*                             RETURN, OR WAIT IF SUSPEND IN PROGRESS R4 S3328000
*                                                                    R4 S3328500
         SPACE 1                                                     R4 S3329000
MVREQRET TM    ICESDCT,ICESUSPD    TEST SUSPEND IN PROGRESS FLAG     R4 S3329500
         BZR   ML                  RETURN IF NOT SUSPENDING          R4 S3330000
         NI    ICESDCT,255-ICESUSPD  RESET SUSPEND IN PROGR FLAG     R4 S3330500
         CLI   PCEID+1,PCEMLMID    IS THIS THE LINE MANAGER..  @OZ41311 S3331000
         BER   ML                  IF LINE MANAGER DON'T WAIT HERE   R4 S3331500
         L     MDCT,ICESDCT        RETRIEVE SUSPENDING RDCT ADDRESS  R4 S3332000
         SPACE 1                                                     R4 S3332500
MVREQUME ST    ML,DCTEWF           SAVE 1ST LEVEL RETURN ADDRESS     R4 S3333000
        $WAIT  WORK,SAVE=NO        WAIT ON RESUME POST FROM MVDALRCN R4 S3333500
        $WAIT  ABIT,SAVE=NO        GIVE COMMANDS CHANCE TO PERCOLATE R4 S3334000
        $RESTORE                   RESTORE ACCESS METHOD REGISTERS   R4 S3334500
         TM    MDCTSEL,DCTPOUTB    TEST DIRECTION BIT                R4 S3335000
         BZ    SKIP850             SKIP EARLY OP CMD CHECK IF INBND  R4 S3335500
         LTR   MBASE1,MBASE1       TEST TYPE OF $EXTP CALL           R4 S3336000
         BM    SKIP850             BR IF MAY NOT BE FLUSHED (CLOSE)  R4 S3336500
         TM    DCTFLAGS,DCTDELET+DCTRSTRT  $C OR $E OR $I ENTERED    R4 S3337000
         BNZ   MVTAMXAB            RETURN IMMED IF OPERATOR COMMAND  R4 S3337500
SKIP850  L     ML,DCTEWF           RETRIEVE 1ST LEVEL RETURN ADDRESS R4 S3338000
         TM    MDCTSTAT,DCTPSUSP   TEST IF POST WAS FROM RESUME      R4 S3338500
         BO    MVREQUME            REINSTATE $WAIT IF NOT            R4 S3339000
         TM    MDCTSEL,DCTPOUTB    TEST DIRECTION BIT AGAIN          R4 S3339500
         BOR   ML                  RETURN IF OUTBOUND - CALLER KNOWS   CS3340000
                                    IF 'RESUME D.S.' HEADER REQUIRED R4 S3340500
         TM    ICERCVST,ICENOFMH   TEST STREAM RECEIVE STATUS        R4 S3341000
         BO    MVREQBUF  IF NO FMH PENDING, MUST FINISH THE MVREQBUF   CS3341500
                          CALL THAT WAS INTERRUPTED BY IMPLIED SUSPD R4 S3342000
         BR    ML        TO REACH HERE MVRELBUF MUST BE CALLED WITH    CS3342500
                          'SDS' PENDING. IN THIS ONE CASE, MVRELBUF    CS3343000
                           RTRNS WITH DCTBUFAD NOT 0 (PTS TO 'RDS')  R4 S3343500
         EJECT                                                       R4 S3344000
*                                                                    R4 S3344500
*                             RELEASE BUFFER TO SNA HEADER SERVICES  R4 S3345000
*                                                                    R4 S3345500
         SPACE 1                                                     R4 S3346000
MVRELBUF LA    R15,MVFRELBF        LOAD ADDR OF BUF DISPOSAL ROUTINE R4 S3346500
         TM    ICERCVST,ICEINCHN   TEST RECEIVE STATUS               R4 S3347000
         BOR   R15                 JUST FREE BUFFER IF NOT CHAIN END R4 S3347500
         TM    ICERCVST,ICEINSTR   TEST RECEIVE STATUS               R4 S3348000
         BO    MVRSTATI            GO FREE BUFFER IF IN STREAM       R4 S3348500
         TM    ICERCVST,ICENMEND   TEST RECEIVE STATE FMH PEND @OZ29180 S3349000
         BZ    MVRSTATI            FREE BUFFER IF RDS/BDS/SDS/NO FMH R4 S3349500
         TM    MDCTSTAT,DCTEOF     IF EDS/ODS/ADS TEST END-OF-FILE   R4 S3350000
         BO    MVRSTATI            FREE IF END-OF-FILE ALREADY SET   R4 S3350500
         OI    MDCTSTAT,DCTEOF     SET END OF FILE FOR EDS/ODS/ADS   R4 S3351000
         BR    ML                  RETURN TO 'GET' WITHOUT FREEING   R4 S3351500
         SPACE 2                                                    R41 S3353000
         LTORG                                                       R4 S3355500
         SPACE 3                                                     R4 S3356000
         DROP  MBASE1,MBASE2,MBASE3  DROP RTAM ROUTINES...          R41 S3356500
         DROP  BASE2              ...AND LINE MANAGER ADDRESSABILTY R41 S3356600
         TITLE 'HASP SNA REMOTE TERMINAL R.U. COMPOSER WORK AREA'    R4 S3357000
IFGRPL   DSECT                                                       R4 S3357500
         ORG   RPLBCHN                                               R4 S3358000
         DS    0D                  ASSURE DBLE WRD BOUNDARY    @OZ25087 S3358200
SCWKOMSA DS    0CL(11*4)      COMPOSER SAVE AREA- MUST BE COPIED     R4 S3358500
SCWCCWA  DS    0CL5                SCS MODEL CARRIAGE CONTROL STRING R4 S3359000
SCWTRN   DS    CL2                 SCS TRANSPARENCY CODE AND COUNT   R4 S3359500
SCWSEL   DS    CL2                 SCS CHANNEL SKIP ('SEL') CODE     R4 S3360000
SCWCR    DS    CL1                 SCS CARRIAGE RETURN CODE          R4 S3360500
SCWODDM  DS    CL1                 SAVED ODD MASTER IN COMPACTION   R41CS3361000
                                    16-MASTER SPECIAL OVERFLOW CASE R41 S3361100
SCWFLAGS DS    BL1                 COMPOSER FLAGS                    R4 S3361500
SCWLCCC  DS    XL1                 LAST CHANNEL COMMAND CODE         R4 S3362000
SCWINPT  DS    F                   SAVEWORD, INPUT STRING ADDRESS    R4 S3362500
SCWLINPT DS    F                   SAVEWORD, INPUT STRING LENGTH     R4 S3363000
         ORG   SCWINPT                                               R4 S3363500
SCWSVFWA DS    0CL17               'SET VERTICAL FORMAT' WORK AREA   R4 S3364000
         DS    CL2                 'FMT B' SCS CODE                  R4 S3364500
SVFCOUNT DS    CL1                 # BYTES REMAINING INCL.THIS ONE   R4 S3365000
SVFMAXPL DS    CL1                 MAX PRINT LINE                    R4 S3365500
SVFTOPM  DS    CL1                 TOP MARGIN  (CHANNEL STOP 1)      R4 S3366000
SVFBOTM  DS    0CL1                BOTTOM MARGIN                     R4 S3366500
SVFTABWK DS    CL12                CHANNEL STOPS 1 THROUGH 12        R4 S3367000
         DS    CL3                 RESERVED                          R4 S3367500
         SPACE 1                                                     R4 S3368000
SCWTEND  DS    0F                  TEMPORARY SAVEWORD, 'REND' VALUE  R4 S3368500
SCWSRCEB DS    0F                  BEGIN ADDR, DATA TO MOVE INTO SCB R4 S3369000
SCWSRCE  DS    F                   SAVEWORD, CURRENT SOURCE STR ADDR R4 S3369500
SCWSCBA  DS    0F                  ADDRESS OF INTERRUPTED SCB        R4 S3370500
SCWLSRCE DS    F                   SAVEWORD, LENGTH OF SOURCE STRING R4 S3371000
SCWFEED  DS    F                   SAVEWORD, FEEDER ROUTINE RETURN   R4 S3371500
SCWTSINK DS    0F                  TEMPORARY SAVEWORD, 'RSINK'      R41 S3371800
SCWNUM   DS    F                   SAVEWORD, EMISSION DUPLIC. FACTOR R4 S3372000
*                             END OF PORTION WHICH MUST BE COPIED    R4 S3372500
SCWPLAN  DS    F                   SAVEWORD, PLANNER STATE ENTRY PT. R4 S3373000
SCWCPARS DS    F                   SAVEWORD, COMPACTION RACE STATE  R41 S3373100
SCWSCBL  DS    F                   SAVEWORD, UNUSED SCB CAPACITY     R4 S3373500
SCWSCBNC DS    F                   SAVEWORD, STARTING SCB CAPACITY  R41 S3373700
SCWRETRN DS    F                   SAVEWORD, COMPOSER RETURN ADDRESS R4 S3374000
SCWSCBNA DS    0F                  SAVEWORD, OVERLAP NC SCB ADDRESS R41 S3374100
SCWSCBCA DS    F                   SAVEWORD, COMPACTION SCB ADDRESS R41 S3374200
SCWSCBNS DS    0F                  SAVEWORD, NC SPACE AT RACE BEGIN R41 S3374400
SCWSCBCE DS    F                   SAVEWORD, FULL COMPACT SCB END   R41 S3374500
SCWSAV13 DS    F                   SAVEWORD, POINTER TO PCE          R4 S3375000
SCWRUEND DS    F                   SAVEWORD, ADDRESS OF R.U. END    R41 S3375100
         EJECT                                                      R41 S3375500
         SPACE 5                                                    R41 S3375600
*                                                                    R4 S3376000
*                             SCWFLAGS - SCB COMPOSER FLAGS          R4 S3376500
*                                                                    R4 S3377000
         SPACE 1                                                     R4 S3377500
SCWMORE  EQU   B'01000000'         MORE DATA REMAINS TO BE COMPOSED  R4 S3378500
SCWODDMF EQU   B'00100000'         EMITTER BACKED UP BY ODD MASTER  R41 S3378800
SCWTRNSP EQU   B'00010000'         TRANSPARENCY CHECK REQUIRED       R4 S3379000
SCWNSPAN EQU   B'00001000'         FORBID CROSS-R.U. RECORD SPANNING R4 S3379500
SCWCTRL  EQU   B'00000100'         CONTROL (NOT TEXT) SOURCE STRING  R4 S3380000
SCWFULL  EQU   B'00000010'         BUFFER READY TO SEND              R4 S3380500
SCWLAST  EQU   B'00000001'         LAST EMISSION PASSED TO PLANNER   R4 S3381000
         SPACE 5                                                    R41 S3381100
*                                                                   R41 S3381200
*                             EQUATES FOR COMPACTION RACING STATUS  R41 S3381300
*                                                                   R41 S3381400
         SPACE 1                                                    R41 S3381500
SCWCANOT EQU   0                   COMPACTION NOT COMPETING         R41 S3381600
SCWBHIND EQU   1                   COMPACTION BEHIND BY 1/2 BYTE    R41 S3381700
SCWSTAND EQU   2                   COMPACTION IN STANDOFF           R41 S3381800
SCWAHEAD EQU   3                   COMPACTION AHEAD  BY 1/2 BYTE    R41 S3381900
SCWNPCOS EQU   2                   NON-PRIME DUP COST = 2 HALF-BYTESR41CS3382000
                                    MORE THAN PRIME DUP COST        R41 S3382100
         TITLE 'RTAM     HASP SNA GET WORK AREA'                    R41 S3382200
         ORG   RPLBCHN                                              R41 S3382300
SGWSTRT  DS    0X                  START OF SNA GET WORK AREA       R41 S3382400
         DS    X                   INBND ALLOC SAVES MDCTFMT HERE   R41 S3382500
SGWFLAGS DS    BL1                 FLAGS FOR SNA GET                R41 S3382600
         DS    2X                  RESERVED                         R41 S3382700
         SPACE 1                                                    R41 S3382800
SGWRSAVE DS    0F                  STATUS REGISTER SAVE AREA        R41 S3382900
SGWLINK  DS    F                   R14  LINK                        R41 S3383000
SGWRPP   DS    F                   R15  RPP                         R41 S3383100
SGWRTC   DS    F                   R0   RTC                         R41 S3383200
         DS    F                   R1                               R41 S3383300
         DS    F                   R2                               R41 S3383400
SGWRSC   DS    F                   R3   RSC                         R41 S3383500
SGWMBUF  DS    F                   R4   MBUF                        R41 S3383600
SGWRDP   DS    F                   R5   RDP                         R41 S3383700
SGWRPC   DS    F                   R6   RPC                         R41 S3383800
         DS    F                   R7   MBASE1                      R41 S3383900
         DS    F                   R8   MBASE2                      R41 S3384000
         DS    F                   R9                               R41 S3384100
         DS    F                   R10  JCT                         R41 S3384200
         DS    F                   R11  BASE1                       R41 S3384300
SGWRDC   DS    F                   R12  RDC                         R41 S3384400
         SPACE 1                                                    R41 S3384500
SGWRUA   DS    F                   CURRENT POINTER IN RU            R41 S3384600
SGWRUE   DS    F                   END OF RU (OR PORTION OF RU)     R41 S3384700
SGWEND   DS    0X                  END OF SNA GET WORK AREA         R41 S3384800
         SPACE 1                                                    R41 S3384900
*                             SGWFLAGS  --  BIT DEFINITIONS         R41 S3385000
         SPACE 1                                                    R41 S3385100
SGWNFRST EQU   X'80'               NOT THE FIRST GET IN THIS CHAIN  R41 S3385200
SGWXEOR  EQU   X'40'               AN EXTRA EOR MAY OCCUR           R41 S3385300
SGWDUP   EQU   X'20'               RDP POINTS TO A DUPLICATE FIELD  R41 S3385400
SGWTRN   EQU   X'10'               SCS SCAN IS IN TRANSPARENT STRINGR41 S3385500
         TITLE 'RTAM     HASP SNA HEADER DECODE WORK AREA'          R41 S3385600
*                                                                    R4 S3396500
*                             SNA HEADER DECODE ROUTINE WORK AREA    R4 S3397000
*                                                                    R4 S3397500
         SPACE 1                                                     R4 S3398000
         ORG   RPLBCHN                                               R4 S3398500
SHWDCTWA DS    0D             GROUP NAME FOR NEXT 8 BYTES            R4 S3399000
SHWTFMTM DS    BL1                 ATTRIB MASK TO MERGE WITH MDCTFMT R4 S3399500
         DS    BL1                 RESERVED FOR 'GET' DECOMPR FLAGS  R4 S3400000
SHWCNTRL DS    BL1                 D.F.C. TYPE INDEX (0 = DATA)      R4 S3400500
         DS    BL1                 RESERVED                          R4 S3401000
SHWRDCT  DS    F                   REMOTE DCT ALLOCATION CANDIDATE   R4 S3401500
SHWICEWA DS    0F             GROUP NAME FOR NEXT 4 BYTES            R4 S3402000
SHWSTAT  DS    BL1                 COPY OF ICESTAT                   R4 S3402500
SHWFLAGS DS    BL1                 COPY OF ICEFLAGS                  R4 S3403000
SHWRCVST DS    BL1                 COPY OF ICERCVST                  R4 S3403500
         DS    BL1                 RESERVED                          R4 S3404000
         SPACE 3                                                     R4 S3404500
HASPRTAM CSECT                                                       R4 S3405000
         TITLE 'HASP SNA REMOTE TERMINAL CONSTANTS/TABLES'           R4 S3405500
*                                                                    R4 S3406000
*                             SNA FUNCTION MGMT HEADER PROTOTYPES    R4 S3406500
*                                                                    R4 S3407000
         SPACE 3                                                     R4 S3407500
MFMHA    DC    AL1(MFMHAL)         LENGTH                            R4 S3408000
         DC    AL1(FMHTYPE1)       TYPE                              R4 S3408500
         DC    AL1(*-*)            SELECT BYTE - SET FROM RDCT       R4 S3409000
         DC    AL1(0)              SRI, DEMAND SELECT, 4-7 RES @OZ29180 S3409500
         DC    AL1(*-*)            PROPERTIES - SET FROM REGISTER R1 R4 S3410000
         DC    AL1(0)              RECORD LENGTH               @OZ29180 S3410500
MFMHAL   EQU   *-MFMHA             DEFINE MODEL FMH LENGTH           R4 S3411000
         SPACE 2                                                    R41 S3411100
MFMHC    DC    AL1(*-*)            LENGTH - COMPUTED FROM # MASTERS R41 S3411200
         DC    AL1(FMHTYPE3)       TYPE                             R41 S3411300
         DC    AL1(FMHCPT)         CODE = DEFINE COMPACTION TABLE   R41 S3411400
         DC    AL1(*-*)            NUMBER OF MASTER CHARACTERS      R41 S3411500
MFMHCL   EQU   *-MFMHC             DEFINE MODEL FMH LENGTH          R41 S3411600
         SPACE 5                                                     R4 S3411700
MVPASCII DS    0D             EBCDIC TO ASCII TRANSLATE TABLE (SNA)  R4 S3412000
         SPACE 1                                                     R4 S3412500
*                X0X1X2X3X4X5X6X7X8X9XAXBXCXDXEXF                    R4 S3413000
         SPACE 1                                                     R4 S3413500
         DC    X'0001020313091A7F1A1A1A0B0C0D0E0F'  0X               R4 S3414000
         DC    X'101A1A1A1114081A18191A1A1C1D1E1F'  1X               R4 S3414500
         DC    X'1A1A1A1A120A171B1A1A1A1A1A050607'  2X               R4 S3415000
         DC    X'1A1A161A1A1A1A041A1A1A1A1A151A1A'  3X               R4 S3415500
         DC    X'201A1A1A1A1A1A1A1A1A5B2E3C282B21'  4X               R4 S3416000
         DC    X'261A1A1A1A1A1A1A1A1A5D242A293B5E'  5X               R4 S3416500
         DC    X'2D2F1A1A1A1A1A1A1A1A7C2C255F3E3F'  6X               R4 S3417000
         DC    X'1A1A1A1A1A1A1A1A1A603A2340273D22'  7X               R4 S3417500
         DC    X'1A6162636465666768691A1A1A1A1A1A'  8X               R4 S3418000
         DC    X'1A6A6B6C6D6E6F7071721A1A1A1A1A1A'  9X               R4 S3418500
         DC    X'1A7E737475767778797A1A1A1A1A1A1A'  AX               R4 S3419000
         DC    X'1A1A1A1A1A1A1A1A1A1A1A1A1A1A1A1A'  BX               R4 S3419500
         DC    X'7B4142434445464748491A1A1A1A1A1A'  CX               R4 S3420000
         DC    X'7D4A4B4C4D4E4F5051521A1A1A1A1A1A'  DX               R4 S3420500
         DC    X'5C1A535455565758595A1A1A1A1A1A1A'  EX               R4 S3421000
         DC    X'303132333435363738391A1A1A1A1A1A'  FX               R4 S3421500
         TITLE 'HASP LINE MANAGER -- GENERAL EVENT HANDLER'          R4 S3422000
         USING BUFDSECT,MBUF       ESTABLISH BUFFER ADDRESSABILITY   R4 S3422500
         SPACE 1                                                     R4 S3423000
HASPMLLM $ENTRY BASE=BASE2,ENTRY=NO HASP LINE MANAGER                R4 S3423500
         SPACE 2                                                    R41 S3423600
*                                                                   R41 S3423700
*        LINE MANAGER -- PROCESSOR INITIALIZATION                   R41 S3423800
*                                                                   R41 S3423900
         SPACE 1                                                    R41 S3424000
         ST    SAVE,MSTQE+IPOST    SET TQE POST ADDRESS             R41 S3424100
         LA    R14,MSCANTBL-MSCNTSIZ SETUP FOR                      R41 S3424200
         ST    R14,MSCANADR        LINE MANAGER SCANS               R41 S3424300
         MVI   MSCANREQ,MSCNUNIT+MSCNRAT REQUEST INITIAL SCANS      R41 S3424500
         EJECT                                                      R41 S3425100
*                                                                   R41 S3425200
*        LINE MANAGER -- SCAN / EVENT SETUP                         R41 S3425300
*                                                                   R41 S3425400
         SPACE 2                                                    R41 S3425500
*        SET SCAN INDICATORS                                        R41 S3425600
         SPACE 1                                                    R41 S3425700
MSEARCH  DS    0H                  SEARCH FOR REQUIRED ACTIONS      R41 S3425800
         L     R1,$SSVT            GET SUBSYSTEM VECTOR TABLE ADDR   R4 S3426000
         USING $SVDSECT,R1         TEMPORARY SSVT ADDRESSABILITY     R4 S3426500
         MVI   $SVMLLM,0           ALLOW $$POSTING                   R4 S3427000
         DROP  R1                  RELEASE TEMPORARY SSVT BASE       R4 S3427500
         NI    MHASPECF+$EWBPOST,255-$EWFPOST RESET IMMED POST REQ   R4 S3428000
         SPACE 1                                                     R4 S3428500
         MVC   MSCANIND(2),MSCANREQ GET REQ SCAN AND EVENT INDIC     R4 S3429000
         XC    MSCANREQ(2),MSCANREQ RESET REQUEST INDICATOR FIELDS   R4 S3429500
         SPACE 2                                                    R41 S3430000
*        INDICATE BASIC TIMER EVENT  ( 1 SECOND INTERVAL )          R41 S3430100
         SPACE 1                                                    R41 S3430200
         TM    MSTQE+IPOST,X'80'   CHECK FOR TIMER EXPIRED           R4 S3430500
         BZ    MNOTIME             BRANCH IF NO TIMER INTERRUPT     R41 S3431000
         MVI   MSTQE+IPOST,X'00'   RESET TIMER POST INDICATOR        R4 S3431500
         OI    MSCANIND,MSCNBACT+MSCNSLNE REQ BSC AND SNA DCT SCAN   R4 S3432000
         OI    MEVNTIND,MEVNTIME   INDICATE TIMER EVENT OCCURED      R4 S3432500
         SPACE 2                                                    R41 S3433000
*        INDICATE DISCONNECT INTERVAL EVENT ( 32 SECOND INTERVAL )  R41 S3433100
         SPACE 1                                                    R41 S3433200
MNOTIME  STCK  MCLOCK              GET TIME STAMP OF THIS DISPATCH  R41 S3433500
         CLC   MDISTIME,MCLOCK     CHECK DISCONNECT LOOK INTERVAL    R4 S3434000
         BH    MJOBSRCH            BRANCH IF INTERV NOT YET EXPIRED  R4 S3434500
         LA    R1,32               SET INTERVAL FOR NEXT             R4 S3435000
         AL    R1,MCLOCK            DISCONNECT LOOK IN               R4 S3435500
         ST    R1,MDISTIME           APPROXIMATELY 32 SECONDS        R4 S3436000
         OI    MSCANIND,MSCNBACT+MSCNSLNE+MSCNRAT  REQUIRED SCANS   R41 S3436500
         OI    MEVNTIND,MEVNDISC   INDICATE DISCONNECT EVENT         R4 S3437000
         SPACE 2                                                     R4 S3437500
*        INIDCATE JOB POST EVENT                                    R41 S3437600
         SPACE 1                                                    R41 S3437700
MJOBSRCH DS    0H                  CHECK JOB POST EVENTS             R4 S3438000
         TM    MHASPECF+$EWBJOT,$EWFJOT TEST MASTER EVENT CONTROL    R4 S3438500
         BO    MQSTEST             BRANCH IF NO JOB POST       @OZ32567 S3439000
         OI    MSCANIND,MSCNSLNE+MSCNBACT+MSCNRAT  NEEDED SCANS     R41 S3443000
         OI    MEVNTIND,MEVNPJOB   SHOW JOB POST EVENT OCCURED       R4 S3443500
         OI    MHASPECF+$EWBJOT,$EWFJOT SET MASTER EVENT CONTROL     R4 S3444000
         EJECT                                                 @OZ32567 S3444010
         SPACE 1                                               @OZ32567 S3444020
*        INDICATE SHARED QUEUE OWNED EVENT                     @OZ32567 S3444030
         SPACE 1                                               @OZ32567 S3444040
MQSTEST $QSUSE TYPE=TEST           TEST STATUS OF SHARED QUES  @OZ32567 S3444050
         BNZ   MSCANEXT            BR IF NOT OWNED             @OZ32567 S3444060
         OI    MEVNTIND,MEVNCKPT   ELSE INDICATE CHKPT OWNED   @OZ32567 S3444070
         EJECT                                                      R41 S3444500
*                                                                   R41 S3445100
*        LINE MANAGER MAIN SCAN DRIVER                              R41 S3445200
*                                                                   R41 S3445300
         SPACE 2                                                    R41 S3445400
MSCANEXT L     R14,MSCANADR        PICK UP CURRENT AND...           R41 S3445500
         LA    R15,MSCANEND        ...LAST SCAN TABLE ENTRIES       R41 S3445600
         USING MSCANTAB,R14        SHOW SCAN TABLE ADDRESSABLE      R41 S3445700
         SPACE 1                                                    R41 S3445800
MSCANXT1 LA    R14,MSCNEXT         BUMP TO NEXT SCAN TABLE ENTRY    R41 S3445900
         CLR   R14,R15             TEST FOR END OF TABLE            R41 S3446000
         BE    MSCANXIT            BRANCH IF YES, SCAN EXIT         R41 S3446100
         SPACE 1                                                    R41 S3446200
         SLR   R1,R1               GET SCAN CRITERIA FROM           R41 S3446300
         IC    R1,MSCNID            SCAN TABLE ENTRY                R41 S3446400
         LTR   R1,R1               TEST SCAN CRITERIA               R41 S3446500
         BZ    MSCANEVN            BRANCH IF NONE, TRY EVENT   @OZ32567 S3446600
         EX    R1,MSCANTM          TEST SCAN REQUIREMENTS           R41 S3446700
         BNO   MSCANXT1            BRANCH IF NOT REQUIRED, NXT SCAN R41 S3446800
         SPACE 1                                               @OZ32567 S3446810
MSCANEVN IC    R1,MEVNTID          GET EVENT CRITERIA          @OZ32567 S3446820
         LTR   R1,R1                FROM TABLE ENTRY           @OZ32567 S3446830
         BZ    MSCANTST              BRANCH IF NONE, DO SCAN   @OZ32567 S3446840
         EX    R1,MEVNTM           TEST EVENT REQUIREMENT      @OZ32567 S3446850
         BNO   MSCANXT1            BR IF NOT REQ TO NEXT SCAN  @OZ32567 S3446860
         SPACE 1                                               @OZ32567 S3446870
MSCANTST XC    MSCANIND,MSCNID     RESET SCAN INDICATOR        @OZ32567 S3446880
         EX    0,MSCNSET           SETUP FOR SCAN FOR WORK     @OZ32567 S3446900
         BZ    MSCANXT1            BRNCH IF NO WRK QUEUED, SKP SCAN R41 S3447000
         SPACE 1                                                    R41 S3447100
MSCAN    L     MBASE1,MSCNRTN      GET SCAN PROCESSING ROUTINE ADDR R41 S3447200
         L     MBASE2,MSCNBASE     SETUP                            R41 S3447300
         LA    MBASE3,2048(,MBASE2) COMMON SUBROUTINE               R41 S3447400
         LA    MBASE3,2048(,MBASE3)  ADDRESSABILITY (8K)            R41 S3447500
         ST    R14,MSCANADR         SAVE CURRENT SCAN TABLE ADDRESS R41 S3447600
         BR    MBASE1              ENTER SCAN ROUTINE               R41 S3447700
         SPACE 1                                                    R41 S3447800
MSCANTM  TM    MSCANIND,*-*        *** EXECUTED ***                 R41 S3447900
         SPACE 1                                               @OZ32567 S3447910
MEVNTM   TM    MEVNTIND,*-*        *** EXECUTED ***            @OZ32567 S3447920
         SPACE 2                                                    R41 S3448000
MSCANXIT LA    R14,MSCANTBL-MSCNTSIZ  RE-INITIALIZE FOR NEXT        R41 S3448100
         ST    R14,MSCANADR            LINE MANAGER DISPATCH        R41 S3448200
         OC    MSCANREQ,MSCANIND   SET SCANS REQUIRED ON NEXT  @OZ32567CS3448210
                                       LINE MANAGER DISPATCH   @OZ32567 S3448220
         EJECT                                                      R41 S3448300
*                                                                   R41 S3448400
*        LINE MANAGER -- BUFFER PROCESSING                          R41 S3448500
*                                                                   R41 S3448600
         SPACE 1                                                    R41 S3448700
MBUFSRCH DS    0H                  SEARCH READY BUFFER QUEUE         R4 S3454000
         L     MBUF,$RJECHEQ       GET TOP OF RJE BUFFER QUEUE       R4 S3454500
         LTR   MBUF,MBUF           CHECK FOR ANY BUFFER QUEUED       R4 S3455000
         BZ    MTIMSRCH            BRANCH IF QUEUE IS EMPTY         R41 S3455500
         SLR   R0,R0               GET EMPTY QUEUE INDICATOR        R41 S3456000
MBUFRTRY CS    MBUF,R0,$RJECHEQ    ATTEMPT TO CLEAR QUEUE           R41 S3456500
         BNE   MBUFRTRY            RETRY IF UNSUCCESSFUL            R41 S3457000
MBUFIFO  L     R1,BUFCHAIN         GET ADDR OF NEXT BUFFER          R41 S3457500
         LTR   R1,R1               IS ANY BUFFER CHAINED             R4 S3458000
         BZ    MBUFPROC            PROCESS BUFF IF END OF CHAIN      R4 S3458500
         ST    R0,BUFCHAIN         REORDER CHAINED BUFFERS           R4 S3459000
         LR    R0,MBUF              FROM LIFO QUEUEING               R4 S3459500
         LR    MBUF,R1               TO FIFO QUEUEING                R4 S3460000
         B     MBUFIFO             LOOP UNTIL END OF CHAIN          R41 S3460500
         SPACE 1                                                     R4 S3461000
MBUFNEXT L     MBUF,MBUFQUE        PICK UP NEXT BUFFER ADDRESS      R41 S3461600
         LTR   MBUF,MBUF           TEST FOR END OF CHAIN            R41 S3461700
         BZ    MTIMSRCH            BRANCH IF YES                    R41 S3461800
         L     R0,BUFCHAIN         PICK UP NEXT BUFFER ADDRESS      R41 S3461900
MBUFPROC ST    R0,MBUFQUE          SAVE BUFF ADDR ON WORK QUEUE     R41 S3462000
         SPACE 1                                                    R41 S3462100
         L     MBASE1,MBUFBSCP     ASSUME BSC PROCESSING ROUTINE    R41 S3462200
         L     MBASE2,=A(RTAMBSUB) PICK UP ADDRESSABILITY           R41 S3462300
         LA    MBASE3,2048(,MBASE2) ON BSC COMMON                   R41 S3462400
         LA    MBASE3,2048(,MBASE3)  SUBOUTINES                     R41 S3462500
         TM    BUFTYPE,BUFTP+BUFIOB  CHECK BUFFER TYPE              R41 S3462600
         BOR   MBASE1              PROCESS BSC BUFFER IF IOB        R41 S3462700
         SPACE 1                                                    R41 S3462800
         L     MBASE1,MBUFSNAP     GET ADDR OF SNA PROCESSING ROUTN R41 S3462900
         L     MBASE2,=A(RTAMVSUB) PICK UP ADDRESSABILITY           R41 S3463000
         LA    MBASE3,2048(,MBASE2) ON SNA COMMON                   R41 S3463100
         LA    MBASE3,2048(,MBASE3)  SUBROUTINES                    R41 S3463200
         BR    MBASE1               AND BRANCH TO HANDLE RPL        R41 S3463300
         SPACE 2                                                    R41 S3463400
         DS    0F                                                   R41 S3463500
MBUFBSCP DC    A(MBSCPROC)         ADDR OF BSC BUFR PROCESSING RTN  R41 S3463600
MBUFSNAP DC    AL1(X'80')          NO-FLUSH FLAG FOR SNA PROCESSING R41 S3463700
         DC    AL3(MSNAPROC)       ADDR OF SNA BUFR PROCESSING RTN  R41 S3463800
         EJECT                                                      R41 S3463900
*                                                                   R41 S3464000
*        LINE MANAGER -- POST SCAN PROCESSING AND WAIT              R41 S3464100
*                                                                   R41 S3464200
         SPACE 2                                                    R41 S3464300
*        REACTIVATE LINE MANAGER MASTER TIME INTERVAL (1 SECOND)    R41 S3464400
         SPACE 1                                                    R41 S3464500
MTIMSRCH CLI   MSTQE+IPOST,X'20'   CHECK FOR STIMER REQUESTED       R41 S3464600
         BE    MSINTVL             GO SET 1 SECOND INTERVAL         R41 S3464700
         CLI   MSTQE+IPOST,X'00'   TIME EXPIRED...             @OZ40259 S3464800
         BE    MSINTVL             YES,ISSUE STIMER            @OZ40259 S3464810
         TM    MSTQE+IPOST,X'80'   TIME EXPIRED WHEN WAITING?  @OZ40259 S3464820
         BO    MSEARCH             YES, GO SCAN FOR WORK       @OZ40259 S3464830
         B     MLLMWAIT            TIME NOT EXPIRED...GO WAIT  @OZ40259 S3464900
MSINTVL  LA    R1,1                GET 1 SECOND                     R41 S3465000
         ST    R1,MSTQE+ITIME       TIMER INTERVAL                  R41 S3465100
        $STIMER MSTQE              KICK OFF TIMER                    R4 S3465500
         MVI   MSTQE+IPOST,X'40'   INDICATE TIMER INTERVAL SET       R4 S3466000
         SPACE 3                                                    R41 S3466100
*        LINE MANAGER WAIT - FOR NEXT DISPATCH                      R41 S3466200
         SPACE 1                                                     R4 S3466500
MLLMWAIT DS    0H                  WAIT FOR MORE WORK TO DO          R4 S3467000
        $WAIT  WORK                WAIT FOR SOMETHING TO DO          R4 S3467500
         SPACE 1                                                     R4 S3468000
         B     MSEARCH             BRANCH TO SEARCH FOR WORK        R41 S3468600
         TITLE 'HASP LINE MANAGER --- MAIN SCAN DIRECTORY'          R41 S3468700
*********************************************************************** S3468800
*                                                                     * S3468900
*                  LINE MANAGER MAIN SCAN DIRECTORY                   * S3469000
*                                                                     * S3469100
*********************************************************************** S3469200
         SPACE 2                                                    R41 S3469300
MSCANTAB DSECT                                                      R41 S3469400
MSCNID   DS    0XL1                SCAN REQUEST FLAG                R41 S3469500
MSCNRTN  DS    A                   SCAN ROUTINE ADDRESS             R41 S3469600
MSCNSET  DS    A                   SCAN SETUP INSTRUCTION           R41CS3469700
                                     *** EXECUTED ***               R41 S3469800
MEVNTID  DS    0XL1                EVENT REQUEST FLAG          @OZ32567 S3469810
MSCNBASE DS    A                   SCAN COMMON SUBROUTINE BASE      R41 S3469900
MSCNEXT  EQU   *                   NEXT SCAN TABLE ENTRY            R41 S3470000
MSCNTSIZ EQU   *-MSCANTAB          SIZE OF SCAN TABLE ENTRY         R41 S3470100
         SPACE 1                                                    R41 S3470200
HASPRTAM CSECT                                                      R41 S3470300
         SPACE 2                                                    R41 S3470400
MSCANTBL DS    0F                                                   R41 S3470500
         SPACE 1                                                    R41 S3470600
         DC    AL1(MSCNBACT),AL3(MDCTSCAN)                          R41 S3470700
         ICM   MDCT,15,MBSCACT                   ACTIVE BSC LINE    R41 S3470800
         DC    AL1(0),AL3(RTAMBSUB)                  DCT SCAN  @OZ32567 S3470900
         SPACE 1                                                    R41 S3471000
         DC    AL1(MSCNSLOG),AL3(MSALGSCN)                          R41 S3471100
         ICM   MDCT,15,MSNALOG                   ACTIVE SNA LOGON   R41 S3471200
         DC    AL1(0),AL3(RTAMVSUB)                  DCT SCAN  @OZ32567 S3471300
         SPACE 1                                                    R41 S3471400
         DC    AL1(MSCNSLNE),AL3(MSLNESCN)                          R41 S3471500
         ICM   MDCT,15,MSNALNE                   ACTIVE SNA LINE    R41 S3471600
         DC    AL1(0),AL3(RTAMVSUB)                  DCT SCAN  @OZ32567 S3471700
         SPACE 1                                                    R41 S3471800
         DC    AL1(MSCNSIDL),AL3(MSIDLSCN)                          R41 S3471900
         ICM   MDCT,15,MSNAIDL                     IDLE SNA LINE    R41 S3472000
         DC    AL1(0),AL3(RTAMVSUB)                  DCT SCAN  @OZ32567 S3472100
         SPACE 1                                                    R41 S3472200
         DC    AL1(MSCNUNIT),AL3(MUNITSCN)                          R41 S3472300
         B     MSCAN                             STARTED ($S CMD)   R41 S3472400
         DC    AL1(0),AL3(RTAMBSUB)                 UNIT SCAN  @OZ32567 S3472500
         SPACE 1                                                    R41 S3472600
         DC    AL1(0),AL3(MLOGPROC)                                 R41 S3472700
         ICM   MDCT,15,MLOGQUE                   LOGON DCT EXIT &   R41 S3472800
         DC    AL1(0),AL3(RTAMVSUB)        ACB COMPLETION SCAN @OZ32567 S3472900
         SPACE 1                                                    R41 S3473000
         DC    AL1(0),AL3(MICEPROC)                                 R41 S3473100
         ICM   MICE,15,MICEQUE                   ICE EXIT SERVICE   R41 S3473200
         DC    AL1(0),AL3(RTAMVSUB)                    SCAN    @OZ32567 S3473300
         SPACE 1                                                    R41 S3473400
         DC    AL1(MSCNRAT),AL3(MRATPROC)                           R41 S3473500
         ICM   WA,15,MSNALOG                  REMOTE AUTOLOGON @OZ32567 S3473600
         DC    AL1(MEVNCKPT),AL3(RTAMVSUB)             SCAN    @OZ32567 S3473700
         SPACE 1                                                    R41 S3473800
MSCANEND DS    0H                                END OF SCAN TABLE  R41 S3473900
         TITLE 'HASP LINE MANAGER -- CATASTROPHIC ERROR EXITS'      R41 S3474000
*********************************************************************** S3474100
*                                                                     * S3474200
*        C A T A S T R O P H I C   E R R O R   E X I T S              * S3474300
*                                                                     * S3474400
*********************************************************************** S3474500
         SPACE 3                                                    R41 S3474600
M01     $ERROR                     NON-ZERO DCT RJE BUFFER COUNT    R41 S3474700
         SPACE 3                                                    R41 S3474800
M03A     STM   R0,R15,M03SAVE                                  @OZ49689 S3474890
M03     $ERROR                     CONTROL BLOCK SETUP LOGIC ERROR  R41 S3474900
M03SAVE  DC    16F'0'              M03 REG SAVE AREA           @OZ49689 S3474950
         SPACE 3                                                    R41 S3475000
R01     $ERROR                     JES2 ERROR IN RPL HANDLING       R41 S3475100
       TITLE 'HASP LINE MANAGER -- SUBROUTINE TO REQUEST SHARED QUEUES' S3475105
         SPACE 1                                               @OZ32567 S3475106
***************************************************************@OZ32567 S3475107
*                                                              @OZ32567 S3475108
*  LINE MANAGER -- ROUTINE TO QUEUE A BUFFER TO THE $RJECHEQ   @OZ32567 S3475109
*                  AND POST THE CHECKPOINT PROCESSOR.          @OZ32567 S3475110
*  ENTERED FROM MSIGNON, MDISCON AND MSNALPAR IF THE SHARED    @OZ32567 S3475111
*  QUEUES ARE NOT OWNED (MEVNCHKPT IS NOT ON).                 @OZ32567 S3475112
*  ON COMPLETION THE LINE MANAGER BRANCHES TO MBUFNEXT TO      @OZ32567 S3475113
*  PROCESS THE NEXT BUFFER ON ITS CHANNEL END QUEUE (MBUFQUE). @OZ32567 S3475114
*  MBUF CONTAINS THE ADDRESS OF THE BUFFER TO BE RE-QUEUED.    @OZ32567 S3475115
*                                                              @OZ32567 S3475116
***************************************************************@OZ32567 S3475117
         SPACE 1                                               @OZ32567 S3475120
MREQBUF  L     R0,$RJECHEQ         GET FIRST BUF ON $RJECHEQ   @OZ32567 S3475125
MQRETRY  ST    R0,BUFCHAIN         CHAIN QUEUE TO MBUF         @OZ32567 S3475130
         CS    R0,MBUF,$RJECHEQ    ATTEMPT TO QUEUE BUFFER     @OZ32567 S3475135
         BNE   MQRETRY             RETRY IF NOT SUCCESSFUL     @OZ32567 S3475140
         TM    BUFTYPE,BUFTP+BUFRPL  IF NOT SNA BUFFER         @OZ48702 S3475145
         BNO   MQRSTR                 ATTEMPT TO RSTR. CHKPT.  @OZ48702 S3475146
         MVI   RPLACTIV-RPLDSECT(MBUF),X'40' MARK RPL REQ.     @OZ48702 S3475147
         B     MQPOST              POST CHECKPOINT             @OZ48702 S3475150
MQRSTR   CLI   IOBECBCC,X'00'      NEED TO RESTORE...          @OZ48702 S3475151
         BNE   MQCOUNTS            NO, NOT ZERO, CONTINUE      @OZ32567 S3475152
         MVI   IOBECBCC,X'FF'      RESTORE COMPLETION CODE     @OZ32567 S3475153
MQCOUNTS DS    0H                  RESET COUNTS                @OZ32567 S3475154
         LH    R0,$EXCPCT          RETURN MASTER I/O COUNT     @OZ32567 S3475155
         A     R0,=F'1'              TO PREVIOUS VALUE         @OZ32567 S3475160
         STH   R0,$EXCPCT          STORE VALUE IN HCT          @OZ32567 S3475165
         NI    MDCTATTN,255-MDCTIMER  RESET TIMER REQUEST      @OZ32567 S3475168
         SLR   R0,R0               CLEAR R0                    @OZ32567 S3475170
         IC    R0,DCTBUFCT         RETURN DCT I/O COUNT        @OZ32567 S3475175
         A     R0,=F'1'              TO PREVIOUS VALUE         @OZ32567 S3475180
         STC   R0,DCTBUFCT         STORE IN LINE DCT           @OZ32567 S3475185
         L     R0,MDCTSXCP         RETURN SESSION EXCP         @OZ32567 S3475190
         SL    R0,=F'1'              COUNT TO PREVIOUS         @OZ32567 S3475195
         ST    R0,MDCTSXCP             VALUE IN DCT            @OZ32567 S3475200
         TM    MSEQTYPE,MCPUSEQ    CHECK FOR M/L BUFFER        @OZ46465 S3475201
         BNO   MQPOST              NOT M/L, SKIP SEQ UPDATE    @OZ46465 S3475203
         L     MCODE,MDCTCODE      GET ADDRESSABILITY TO       @OZ46465 S3475205
         USING MCODSECT,MCODE        CODE TABLE                @OZ46465 S3475207
         LA    R15,TPBUFST         GET POINTER TO DATA         @OZ46465 S3475209
         CLC   MSOHSTX,0(R15)      CHECK FOR TEXT              @OZ46465 S3475210
         BE    MQRCVSEQ            TEXT, CHECK FOR SEQ UPDATE  @OZ46465 S3475213
         CLC   MDLESTX,0(R15)      CHECK FOR TEXT              @OZ46465 S3475215
         BNE   MQPOST              NOT TEXT, SKIP SEQ UPDATE   @OZ46465 S3475217
MQRCVSEQ TM    2(R15),X'30'        CHECK FOR IGNORE OR RESET   @OZ46465 S3475219
         BNZ   MQPOST              DO NOT UPDATE RECEIVE SEQ   @OZ46465 S3475220
         IC    R15,MDCTRSEQ        RESET BLOCK                 @OZ46465 S3475223
         LA    R15,15(,R15)          SEQUENCE COUNT            @OZ46465 S3475225
         STC   R15,MDCTRSEQ            FOR MULTILEAVING        @OZ46465 S3475227
         NI    MDCTRSEQ,X'0F'              SIGNON              @OZ46465 S3475229
MQPOST   BAL   WA,MCKPOST          POST CHECKPOINT WRITER      @OZ46465 S3475230
         B     MBUFNEXT            PROCESS NEW WORK            @OZ46465 S3475232
         DROP  MCODE                                           @OZ46465 S3475234
         SPACE 2                                               @OZ32567 S3475235
*                                                              @OZ32567 S3475240
*        LINE MANAGER -- ROUTINE TO POST CHECKPOINT PROCESSOR  @OZ32567 S3475245
*                                                              @OZ32567 S3475250
         SPACE 1                                               @OZ32567 S3475255
MCKPOST  OI    MHASPECF+$EWBPOST,$EWFPOST  REQUEST IMMED POST  @OZ32567 S3475260
         TM    MHASPECF+$EWBCKPT,$EWFCKPT  TEST CHECKPOINT     @OZ32567 S3475265
         BOR   WA                  RETURN IF ALREADY POSTED    @OZ32567 S3475270
         OI    MHASPECF+$EWBCKPT,$EWFCKPT  REQUEST CKPT POST   @OZ32567 S3475275
        $POST $HASPECF,CKPW        POST CHECKPOINT PROCESSOR   @OZ32567 S3475280
         BR    WA                  RETURN TO CALLER            @OZ32567 S3475285
      TITLE 'HASP LINE MANAGER -- SESSION CONTROL SUBROUTINE'  @OZ32567 S3475290
         SPACE 1                                                    R41 S3475300
*                                  ADDRESSABILITY --                R41 S3475400
         USING ICEDSECT,MICE            -- ICE                      R41 S3475500
         USING RTAMVSUB,MBASE2,MBASE3   -- COMMON SNA SUBROUTINES   R41 S3475600
         SPACE 2                                                    R41 S3475700
*                                                                   R41 S3475800
*        SUBROUTINE TO QUEUE AN ICE TO THE LINE MANAGER             R41 S3475900
*                         ICE EXIT QUEUE                            R41 S3476000
*                                                                   R41 S3476100
         SPACE 1                                                    R41 S3476200
MICEREQU IC    R0,MCOMMAND         GET EXIT ROUTINE ACTION CODE     R41 S3476300
         SPACE 1                                                    R41 S3476400
MICEREQ1 LR    WA,SAVE             USE WA TO ADDRESS L.M. WORK AREA R41 S3476500
         SPACE 1                                                    R41 S3476600
MICEREQ2 OI    MHASPECF+$EWBBUF,$EWFBUF   SHOW LINE MANAGER REQ     R41 S3476700
         OI    MHASPECF+$EWBPOST,$EWFPOST  DISP ON NEXT BUFF POST   R41 S3476800
         SLL   R0,24               SHIFT ACTION CODE AND CLEAR REG  R41 S3476900
         L     R15,ICEXTCHN        GET ICE EXIT ROUT CHAIN FIELD    R41 S3477000
         SPACE 1                                                    R41 S3477100
MICECHCK LTR   R15,R15             CHECK IF ICE IS ALREADY QUEUED   R41 S3477200
         BNZ   MICEUPDT            TRY TO UPDATE ACTION CODE IF YES R41 S3477300
         L     R1,MICEQUE-PCEDSECT(,WA)  GET ICE QUEUE HEAD POINTER R41 S3477400
         SPACE 1                                                    R41 S3477500
MICERTRY LA    R14,0(,R1)          CLEAR HIGH ORDER BYTE AND        R41 S3477600
         ALR   R14,R0               ADD REQ ACTION CODE TO IT       R41 S3477700
         CS    R15,R14,ICEXTCHN    ATTEMPT TO STORE CHAIN ADDR      R41 S3477800
         BNE   MICEUPDT            BRANCH IF CHANGED MEANWHILE      R41 S3477900
         LR    R15,R14             RELOAD REG15 FOR RETRY CASE      R41 S3478000
         CS    R1,MICE,MICEQUE-PCEDSECT(WA)  TRY TO PUT ICE ON Q    R41 S3478100
         BER   ML                  PROCESS NEXT ICE IF CHAINED      R41 S3478200
         B     MICERTRY            RETRY IF UNSUCCESSFUL            R41 S3478300
         SPACE 1                                                    R41 S3478400
MICEUPDT LA    R14,0(,R15)         PURIFY CHAIN ADDRESS OF ICE      R41 S3478500
         ALR   R14,R0              ADD ACTION CODE TO CHAIN ADDR    R41 S3478600
         CLR   R14,R15             CHECK SEVERITY OF NEW REQ ACTION R41 S3478700
         BNHR  ML                  PROCESS NEXT ICE IF LOWER        R41 S3478800
         CS    R15,R14,ICEXTCHN    ATTEMPT TO UPDATE ACTION CODE    R41 S3478900
         BER   ML                  PROCESS NEXT ICE IF STORED       R41 S3479000
         B     MICECHCK            RETRY IF UNSUCCESSFUL            R41 S3479100
         EJECT                                                      R41 S3479200
*                                                                   R41 S3479300
*        SUBROUTINE TO FREE ICES                                    R41 S3479400
*                                                                   R41 S3479500
         SPACE 1                                                    R41 S3479600
MICEMELT DS    0H                                                   R41 S3479700
         LR    WA,ML               SAVE 1ST LEVEL RETURN ADDRESS    R41 S3479800
         BAL   ML,MVFREPRG         PURGE SPECIAL SEQ BUFFER IF ANY  R41 S3479900
         LR    ML,WA               RESTORE 1ST LEVEL RETURN ADDRESS R41 S3480000
         ST    MBUF,ICEBUFAD       CLEAR ICE SPECIAL SEQ BUFFER PTR R41 S3480100
         TM    ICESTAT,ICEDRAIN    TEST IF ICE FREE REQUIRED        R41 S3480200
         BZR   ML                  JUST RETURN IF NOT               R41 S3480300
         LA    R0,VXIDISCN+VSEQDLGN  PRELOAD ICE-FREE SEQUENCE TYPE R41 S3480400
         LH    R14,ICEOUTCT        TEST ICE OUTBOUND & INBOUND      R41 S3480500
         AH    R14,ICEINCT          OUTSTANDING REQUEST COUNTS      R41 S3480600
         BNZ   MICENDRY            REQUEUE ICE IF NOT ZERO     @OZ43332 S3480700
         CL    R14,ICEXTCHN        CHECK IF ICE IS QUEUED      @OZ43332 S3480750
         BE    MICEDRY             BRANCH IF NOT               @OZ43332 S3480800
MICENDRY OI    MSTQE+IPOST,X'20'   IND TIMER SERVICE REQUIRED  @OZ43332 S3480900
         B     MICEREQ1            ENTER COMMON ICE REQUEUE ROUTINE R41 S3481000
         SPACE 1                                                    R41 S3481100
MICEDRY  L     R15,ICEADCT         GET APPL LOGON DCT ADDR          R41 S3481200
         USING DCTDSECT,R15        ALLOW LOGON DCT ADDRESSABILITY   R41 S3481300
         LH    R0,MDCTSNCT         PICK UP LOGGED-ON SESSION COUNT  R41 S3481400
         BCT   R0,MICEFIND         DECREMENT CNT AND TEST FOR ZERO  R41 S3481500
         SPACE 1                                                    R41 S3481600
         STH   R0,MDCTSNCT         CLEAR LOGGED-ON SESSION COUNT    R41 S3481700
         ST    R0,MDCTICE          CLEAR ICE CHAIN                  R41 S3481800
         TM    DCTSTAT,DCTDRAIN    TEST LOGON DCT STATUS            R41 S3481900
         BO    MICELGNP            GO CLOSE ACB IF DRAINED          R41 S3482000
         TM    DCTFLAGS,DCTRSTRT   TEST LOGON DCT STATUS            R41 S3482100
         BZ    MICEFREE            GO FREE ICE IF NOT RESTARTING    R41 S3482200
MICELGNP LR    MDCT,R15            POINT TO LOGON CURRENT LOGON DCT R41 S3482300
         BAL   WA,MLOGSTOP          AND REQ CLOSE ACB SUBTASK POST  R41 S3482400
         SPACE 1                                                    R41 S3482500
MICEFREE L     R1,$ICETRAY         GET ADDR OF FIRST FREE ICE       R41 S3482600
MICEDEQ  ST    R1,ICEAPCHN         CONNECT ICE TO FREE CHAIN        R41 S3482700
         CS    R1,MICE,$ICETRAY    ATTEMPT TO UPDATE FREE CHAIN     R41 S3482800
         BNE   MICEDEQ             RETRY IF UNSUCCESSFUL            R41 S3482900
         SLR   MICE,MICE           SHOW ICE NO LONGER EXISTS        R41 S3483000
         OI    MSCANIND,MSCNRAT    INDICATE RAT SCAN NEEDED ON THIS R41 S3483100
         OI    MSCANREQ,MSCNRAT     OR NEXT LINE MANAGER DISPATCH   R41 S3483200
         BR    ML                  RETURN TO CALLER                 R41 S3483300
         SPACE 1                                                    R41 S3483400
MICEFIND STH   R0,MDCTSNCT         UPDATE LOGGED-ON  SESSION CNT    R41 S3483500
         L     R0,ICEAPCHN         SAVE ADDR OF NEXT CHAINED ICE    R41 S3483600
         LA    R15,MDCTICE-ICEAPCHN+ICEDSECT  GET PHONY ICE ADDR    R41 S3483700
         SPACE 1                                                    R41 S3483800
         USING ICEDSECT,R15        TEMPORARY ICE  ADDRESSABILITY    R41 S3483900
MICELOOP L     R1,ICEAPCHN         GET  ADDR OF NEXT CHAINED ICE    R41 S3484000
         CLR   R1,MICE             COMPARE  ICE POINTER TO OURS     R41 S3484100
         BE    MICEREM             BRANCH IF ICE POINTS TO OURS     R41 S3484200
         LTR   R15,R1              TEST FOR END OF CHAIN            R41 S3484300
         BNZ   MICELOOP            GO TEST NEXT ICE IF NOT          R41 S3484400
         BAL   R8,M03A             ERROR IF ICE NOT FOUND      @OZ49689 S3484500
MICEREM  ST    R0,ICEAPCHN         DISCONNECT OUR ICE FROM CHAIN    R41 S3484600
         B     MICEFREE            RETURN ICE TO FREE ICE TRAY      R41 S3484700
         DROP  R15                 RELEASE TEMPORARY ICE BASE       R41 S3484800
         EJECT                                                      R41 S3484900
*                                                                   R41 S3485000
*        DELAYED REQUEST SUBROUTINE                                 R41 S3485100
*                                                                   R41 S3485200
         SPACE 1                                                    R41 S3485300
MICEGIBB LA    R14,VSEQGIBB        SET BB+EB RU CODE IN CASE NO BUF R41 S3485400
         B     MICEGSND            REJOIN COMMON PROCESSING         R41 S3485500
         SPACE 1                                                    R41 S3485600
MICEGIEB LA    R14,VSEQGIEB        SET EB RU CODE IN CASE NO BUFFER R41 S3485700
         L     MDCT,ICELDCT        USE LINE DCT TO SEND EB     @OZ29815 S3485750
         B     MICEGSND            REJOIN COMMON PROCESSING         R41 S3485800
         SPACE 1                                                    R41 S3485900
MICEGICD TM    ICEFLAGS,ICECHDIR   TEST FOR CD ALREADY PENDING      R41 S3486000
         BO    MVFREPRG            BR IF YES-- FREE ANY BUFFER      R41 S3486100
         LA    R14,VSEQGICD        SET CD RU CODE IN ICE            R41 S3486200
         SPACE 1                                                    R41 S3486300
MICEGSND LTR   MBUF,MBUF           TEST BUFFER ADDRESS              R41 S3486400
         BNZ   MICEGHAV            BRANCH IF ALREADY HAVE BUFFER    R41 S3486500
         SPACE 1                                                    R41 S3486600
MICEGBUF LR    WA,R14              SAVE RU TYPE CODE AROUND $GETBUF R41 S3486700
        $GETBUF TYPE=VTAM          TRY TO GET BUFFER FOR NULL RU    R41 S3486800
         BNZ   MICEGTBF            BRANCH IF SUCCEEDED              R41 S3486900
         LA    R0,VXIDGBUF(,WA)    ELSE PUT NULL RU CODE IN R0      R41 S3487000
         L     WA,$MLLMPCE         POINT TO LINE MANAGER WORK AREA  R41 S3487100
         B     MICEREQ2             AND REQUEUE ICE TO LINE MANAGER R41 S3487200
MICEGTBF LR    R14,WA              RESTORE NULL RU TYPE CODE        R41 S3487300
         LR    MBUF,R1             MOVE NEW BUFFER TO RPL BASE REG  R41 S3487400
         USING RPLDSECT,MBUF        AND SHOW RPL ADDRESSABLE        R41 S3487500
         ST    MICE,RPLICE                INITIALIZE                R41 S3487600
         L     R1,ICEADCT                  ICE AND ACB              R41 S3487700
         MVC   RPLDACB,DCTACB-DCTDSECT(R1)  ADDRESSES               R41 S3487800
         CLM   R14,1,MICEGPND+VSEQGCLS  TEST DEFERRED BUF REQ TYPE  R41 S3487900
         BE    MICECBLD            BRANCH IF FOR 'CLSDST'           R41 S3488000
         SPACE 1                                                    R41 S3488100
MICEGHAV LA    R1,MICEGPND(R14)    POINT TO DESIRED SESSION FLAGS   R41 S3488200
         OC    ICEFLAGS,0(R1)      SET DESIRED FLAGS IN ICE         R41 S3488300
         MVC   RPLCNTDF(3),MSNADATA  CHANGE RU TYPE TO DATA         R41 S3488400
         OI    ICESNDST,ICEOCPND   FORCE 'ONLY IN CHAIN'            R41 S3488500
         XC    RPLRLEN,RPLRLEN     SET NULL R.U. LENGTH             R41 S3488600
         MVI   RPLSRTYP,RPLNFSYN   SET STYPE = REQUEST AND     @OZ32746CS3488700
                                   RTYPE = NDFSYN,NDFASY,NRESP @OZ32746 S3488720
         MVI   RPLVTFL2,RPLSCHED   SET POST=SCHED, DEFINITE RESP    R41 S3488800
         NI    RPLOPT12,255-RPLFMHDR  RESET FM HEADER INDICATOR     R41 S3488900
         B     MVRPLOCH            GO SEND CD OR EB UNDER L.M.      R41 S3489000
         SPACE 2                                                    R41 S3489100
MICEGPND DS    0C                  NULL R.U. PENDING ICE FLAGS      R41 S3489200
         DC    AL1(ICEBBPND+ICEEBPND)  BEG/END BRKT PENDING         R41 S3489300
         DC    AL1(ICEEBPND)       END BRACKET      PENDING         R41 S3489400
         DC    AL1(ICECHDIR)       CHANGE DIRECTION PENDING         R41 S3489500
         DC    AL1(VSEQGCLS)       CLSDST PENDING (NOT AN ICE FLAG) R41 S3489600
         SPACE 2                                                    R41 S3489700
         DROP  MBUF                RELEASE BUFFER ADDRESSABILITY    R41 S3489800
         EJECT                                                      R41 S3489900
*                                                                   R41 S3490000
*        SESSION TERMINATION SUBROUTINES                            R41 S3490100
*                                                                   R41 S3490200
         SPACE 2                                                    R41 S3490300
*                                                                   R41 S3490400
*        SESSION DRAIN ENTRY -- CLOSE AT NEXT END BRACKET           R41 S3490500
*                                                                   R41 S3490600
         SPACE 1                                                    R41 S3490700
MICETRAP OI    ICEFLGS2,ICEQUIES   CLOSE SESS. AFTER END BKT.  @OZ48863 S3490800
         TM    ICESTAT,ICEALLOC    TEST SESSION STATUS              R41 S3490900
         BOR   ML                  RETURN IF STILL ALLOCATED        R41 S3491000
         TM    ICEFLAGS,ICEBRCKT   TEST SESSION BRACKET STATUS      R41 S3491100
         BNZR  ML                  RETURN IF BRACKET STILL ACTIVE   R41 S3491200
         SPACE 3                                                    R41 S3491300
*                                                                   R41 S3491400
*        SESSION ABORT ENTRY -- CLOSE IMMEDIATELY                   R41 S3491500
*                                                                   R41 S3491600
         SPACE 1                                                    R41 S3491700
MICEABRT OI    ICESTAT,ICEDRAIN+ICECLOSE  REQ 'CLSDST' & FREE ICE   R41 S3491800
         L     R15,ICERDCT         GET ADDRESS OF REMOTE DCT IF ANY R41 S3491900
         USING DCTDSECT,R15        USE TEMP RMTE DCT ADDRESSABILITY R41 S3492000
         SPACE 2                                                    R41 S3492100
*        TRY TO LOCATE A SPECIAL SEQUENCE BUFFER                    R41 S3492200
         SPACE 1                                                    R41 S3492300
         SLR   MBUF,MBUF           CLEAR CURRENT BUFFER REGISTER    R41 S3492400
         L     R0,ICEBUFAD         TEST SPECIAL SEQUENCE            R41 S3492500
         LTR   R0,R0                BUFFER ADDRESS                  R41 S3492600
         BNZ   MICEABUF            IF HAVE ONE, FREE ALL DCT BUFRS  R41 S3492700
         L     R14,ICESDCT         GET 1ST SUSPENDED REMOTE DCT     R41 S3492800
         LTR   R15,R15             TEST REMOTE DCT ADDRESS          R41 S3492900
         BZ    MICEADCZ            GO ABORT SUSPENDS IF NONE        R41 S3493000
         ICM   MBUF,7,DCTBUFAD+1   TEST DCT BUFFER ADDRESS          R41 S3493100
         USING RPLDSECT,MBUF       SHOW BUFFER ADDRESSABLE          R41 S3493200
         BZ    MICEASPQ            GO ABORT SUSPS IF NONE           R41 S3493300
         ST    MBUF,ICEBUFAD       KEEP FIRST BUF FOR 'CLSDST' USE  R41 S3493400
         LR    WA,MBUF             SAVE BUFFER POINTER         @OZ48702 S3493450
         L     MBUF,RPLNEXT        GET NEXT DCT-OWNED BUFFER IF ANY R41 S3493500
         ST    R0,RPLNEXT-RPLDSECT(,WA) CLEAR NEXT-POINTER     @OZ48702 S3493550
         B     MICEABF0            GO ADJUST INBND CIRC IF NEEDED   R41 S3493600
         EJECT                                                      R41 S3493700
*                                                                   R41 S3493800
*        SESSION ABANDON ENTRY -- FREE WITHOUT CLOSING              R41 S3493900
*                                                                   R41 S3494000
         SPACE 1                                                    R41 S3494100
MICEABDN OI    ICESTAT,ICEABORT+ICEDRAIN  FREE ICE WITHOUT 'CLSDST' R41 S3494200
         SPACE 2                                                    R41 S3494300
*                                                                   R41 S3494400
*        SESSION HOLD ENTRY -- PURGE QUEUES AND RESTRICT USE        R41 S3494500
*                                                                   R41 S3494600
         SPACE 1                                                    R41 S3494700
MICEAHLD OI    ICESTAT,ICEHOLD     BLOCK ALLOCATION TO DATA STREAMS R41 S3494800
         L     R15,ICERDCT         GET REMOTE DCT ADDRESS IF ANY    R41 S3494900
         SPACE 2                                                    R41 S3495000
*        PURGE RESIDUAL BUFFERS                                     R41 S3495100
         SPACE 1                                                    R41 S3495200
MICEABUF LTR   R15,R15             TEST REMOTE DCT ADDRESS          R41 S3495300
         BZ    MICEABF2            BRANCH IF NONE                   R41 S3495400
         ICM   R0,7,DCTBUFAD+1     TEST 1ST DCT-OWNED BUFFER ADDR   R41 S3495500
         BZ    MICEABF2            BRANCH IF NONE                   R41 S3495600
         LA    MBUF,0(,MBUF)       PURIFY AND TEST                  R41 S3495700
         LTR   MBUF,MBUF            CURRENT BUFFER ADDRESS          R41 S3495800
         BNZ   MICEABFD            BRANCH IF HAVE A CURRENT BUFFER  R41 S3495900
         LR    MBUF,R0             ELSE GET ADDR OF DCT-OWNED BUFS  R41 S3496000
MICEABFD CLM   MBUF,7,DCTBUFAD+1   COMPARE CURRENT BUF & DCT ANCHOR R41 S3496100
         BE    MICEABF0            BRANCH IF SAME                   R41 S3496200
         MVC   RPLNEXT,DCTBUFAD    ELSE CHAIN RDCT'S BUFS TO CURRNT R41 S3496300
         SPACE 1                                                    R41 S3496400
MICEABF0 TM    MDCTSEL,DCTPOUTB    TEST DIRECTION BIT               R41 S3496500
         BO    MICEABF1            GO PURGE ANY 2ND BUF IF OUTBND   R41 S3496600
         L     R0,ICEINLM          ELSE UPDATE INBOUND              R41 S3496700
MICEABFR LR    R1,R0                CIRCULATION (NO. OF DATA        R41 S3496800
         BCTR  R1,0                  OR SYN DFC INBOUND RPLS ON     R41 S3496900
         CS    R0,R1,ICEINLM          RDCT, ICE, AND L.M. WORK Q)   R41 S3497000
         BNE   MICEABFR            RETRY UNTIL UPDATE SUCCESSFUL    R41 S3497100
         SPACE 1                                                    R41 S3497200
MICEABF1 XC    DCTBUFAD,DCTBUFAD   CLEAR DCT BUFFER ANCHOR          R41 S3497300
         SPACE 1                                                    R41 S3497400
MICEABF2 LR    WA,ML               SAVE 1ST LEVEL RETURN ADDRESS    R41 S3497500
         BAL   ML,MVFREPRG         PURGE CURRENT AND DCT-OWNED BUFS R41 S3497600
         LR    ML,WA               RESTORE 1ST LEVEL RETURN ADDRESS R41 S3497700
         SPACE 2                                                    R41 S3497800
         DROP  MBUF                RELEASE RPL BUFR ADDRESSABILITY  R41 S3497900
         EJECT                                                      R41 S3498000
*                                                                   R41 S3498100
*        ABORT SUSPENDED STREAMS   (ENTRY USED BY END BRACKET)      R41 S3498200
*                                                                   R41 S3498300
         SPACE 1                                                    R41 S3498400
MICEAEB  DS    0H                  END BRACKET ENTRY POINT          R41 S3498500
         SPACE 1                                                    R41 S3498600
         SLR   R0,R0               LOAD ZERO FOR FIELD CLEARING     R41 S3498700
         L     R14,ICESDCT         GET 1ST SUSPENDED REMOTE DCT     R41 S3498800
         L     R15,ICERDCT         TEST REMOTE                      R41 S3498900
         LTR   R15,R15              DCT ADDRESS                     R41 S3499000
         BZ    MICEADCZ            IF UNALLOCATED GO ABORT SUSPNDS  R41 S3499100
         SPACE 2                                                    R41 S3499600
*        ABORT CURRENT REMOTE DCT                                   R41 S3499700
         SPACE 1                                                    R41 S3499800
MICEASPQ ST    R14,MDCTSDCT        ADD CURRENT RDCT TO SUSP QUEUE   R41 S3499900
         ST    R0,ICERDCT          CLEAR CURRENT REMOTE DCT ADDRESS R41 S3500000
         SPACE 2                                                    R41 S3500100
*        ABORT SUSPENDED STREAMS                                    R41 S3500200
         SPACE 1                                                    R41 S3500300
MICEADCT OI    MDCTSTAT,DCTABORT   FORCE PROCESSOR ABORT            R41 S3500400
         OI    DCTFLAGS,DCTRSTRT+DCTBKSP  RESTART JOB               R41 S3500500
         NI    DCTFLAGS,255-DCTSTOP   RESET STOP BIT JUST IN CASE   R41 S3500600
         NI    MDCTSTAT,255-DCTPSUSP  RESET STREAM SUSPENDED INDIC  R41 S3500700
         ST    R0,MDCTICE          CLEAR DCT ICE POINTER            R41 S3500800
         L     R1,DCTPCE           GET ADDRESS OF ASSOCIATED PCE    R41 S3500900
         SPACE 1                                                    R41 S3501000
        $POST  (R1),(IO,WORK)      POST PROCESSOR FOR IO AND WORK   R41 S3501100
         SPACE 1                                                    R41 S3501200
         L     R14,MDCTSDCT        GET NEXT SUSPENDED RDCT          R41 S3501300
         ST    R0,MDCTSDCT         CLEAR SUSPENDED DCT CHAIN PTR    R41 S3501400
         SPACE 1                                                    R41 S3501500
MICEADCZ LTR   R15,R14             TEST ADDRESS                     R41 S3501600
         BNZ   MICEADCT            BRANCH TO ABORT IF RDCT EXISTS   R41 S3501700
         ST    R15,ICESDCT         SHOW SUSPEND QUEUE EMPTY         R41 S3501800
         SPACE 2                                                    R41 S3501900
*        RESET ICE STATUS                                           R41 S3502000
         SPACE 1                                                    R41 S3502100
         NI    ICESTAT,255-ICEALLOC  RESET                          R41 S3502200
         NI    ICEFLGS2,255-ICESIGNL-ICEOUTBK-ICEBREAK  ICE    @OZ29180 S3502250
         MVI   ICERCVST,ICENOFMH      STATUS                        R41 S3502300
         MVI   ICESNDST,ICENOFMH       BYTES                        R41 S3502400
MICEADED NI    ICEFLAGS,ICECNECT   RESET DIRECTION AND BRACKET FLGS R41 S3502500
         EJECT                                                      R41 S3502600
*        TEST FOR SESSION DRAIN REQUESTED                           R41 S3502700
         SPACE 1                                                    R41 S3502800
         L     R15,ICELDCT         GET LINE DCT ADDRESS             R41 S3502900
         LTR   R15,R15             TEST FOR  SESSION DISCONNECTED   R41 S3503000
         BZ    MICECLOS            BRANCH IF ALREADY DISCONNECTED   R41 S3503100
         TM    ICESTAT,ICEDRAIN+ICECLOSE+ICEABORT  TEST ICE STATUS  R41 S3503200
         BNZ   MICEAFRQ            GO CLEAR ICE QUEUES IF DRAINING  R41 S3503300
         TM    MDCTSTAT,DCTSOFF    TEST LINE DCT STATUS             R41 S3503400
         BO    MICEADRN            GO CLEAR ICE QUEUES IF DRAINING  R41 S3503500
         TM    ICEFLGS2,ICEQUIES   WAIT FOR SESSION QUIESCE    @OZ48863 S3503600
         BO    MICEADRN             GO CLEAR ICE FOR DRAIN     @OZ48863 S3503700
         LR    MDCT,R15            COPY LINE DCT ADDR TO MDCT       R41 S3504000
         B     MVREQJOT            GO SEARCH FOR NEXT STREAM        R41 S3504100
         DROP  R15                 DISCARD TEMP DCT ADDRESSABILITY  R41 S3504200
         SPACE 1                                                    R41 S3504300
MICEADRN OI    ICESTAT,ICEDRAIN+ICECLOSE  PROPAGATE DRAIN TO ICE    R41 S3504400
         SPACE 2                                                    R41 S3504500
*        CLEAR ICE INBOUND & OUTBOUND QUEUES                        R41 S3504600
         SPACE 1                                                    R41 S3504700
MICEAFRQ LR    WA,ML               SAVE 1ST LEVEL RETURN ADDRESS    R41 S3504800
         BAL   ML,MVFREEOQ         CLEAR OUTBOUND QUEUE             R41 S3504900
         BAL   ML,MVFREEIQ         CLEAR INBOUND  QUEUE, AFTER 1ST  R41CS3505000
                                    PURGING REMOTE CONSOLE REQUESTS R41 S3505100
         LR    ML,WA               RESTORE 1ST LEVEL RETURN ADDRESS R41 S3505200
         LA    R0,VXIDISCN+VSEQDLNE  PRE-LOAD DISCONNECT CODE       R41 S3505300
         L     WA,$MLLMPCE         GET POINTER TO L.M. WORK AREA    R41 S3505400
         CLI   PCEID+1,PCEMLMID    IS THIS THE LINE MANAGER..  @OZ41311 S3505500
         BNE   MICEREQ2            QUEUE TO L.M. FOR DISCONN IF NOT R41 S3505600
         EJECT                                                      R41 S3505700
*                                                                   R41 S3505800
*        SESSION DISCONNECT SUBROUTINE                              R41 S3505900
*                                                                   R41 S3506000
         SPACE 1                                                    R41 S3506100
MICEDISC DS    0H                                                   R41 S3506200
         SPACE 2                                                    R41 S3506300
         $QSUSE TYPE=TEST          TEST SHARED QUEUES STATUS   @OZ32567 S3506310
         BZ    MICERMSG              IF QUES OWNED, DISCONNECT @OZ32567 S3506320
         LA    R0,VXIDISCN+VSEQDLNE  PRE-LOAD DISC CODE        @OZ32567 S3506330
         BAL   WA,MCKPOST          ELSE POST CHKPT PROCESSOR   @OZ32567 S3506340
         B     MICEREQ1            REQUEUE ICE ON EXIT QUEUE   @OZ32567 S3506350
         SPACE 1                                                    R41 S3506400
*        WRITE SESSION DISCONNECT MESSAGE                           R41 S3506500
         SPACE 1                                                    R41 S3506600
MICERMSG L     R14,ICELDCT         PICK UP LINE DCT ADDRESS    @OZ32567 S3506700
         LTR   R14,R14             ICE ALLOC TO LINE...        @OZ29432 S3506710
         BZ    MICECLOS            NO, CLOSE SESSION           @OZ29432 S3506720
         USING DCTDSECT,R14        GET LINE DCT ADDRESSABILITY      R41 S3506800
         TM    ICEFLAGS,ICECNECT   TEST SESSION STATUS              R41 S3506900
         BZ    MICECLIX            BR IF NOT CONNECTED         @OZ29432 S3507000
         L     R1,$MWORK           GET AREA ADDRESS                 R41 S3507100
         MVC   0(L'MLGOFMSG,R1),MLGOFMSG  SETUP MSG TEXT            R41 S3507200
         USING MLGOFMSG,R1         ESTABLISH MSG ADDRESSABILITY     R41 S3507300
         MVC   MLGOFLNE,DCTDEVN    MOVE LINE NAME INTO MESSAGE      R41 S3507400
         MVC   MLGOFSYM,ICESYMB    MOVE LUNAME TO MESSAGE           R41 S3507500
         DROP  R1                  RELEASE MESSAGE BASE             R41 S3507600
         $WTO  (R1),L'MLGOFMSG,JOB=NO,WAIT=NO,         ISSUE        R41XS3507700
               ROUTE=$TP+$LOG,CLASS=$NORMAL,PRI=$HI    MESSAGE      R41 S3507800
         SPACE 2                                                    R41 S3507900
*        ADD SESSION TOTALS TO LINE COUNTERS                        R41 S3508000
         SPACE 1                                                    R41 S3508100
         L     R14,ICELDCT         RELOAD LINE DCT ADDRESS          R41 S3508200
         SLR   WA,WA               SET INITIAL INDEX TO ZERO        R41 S3508300
         LA    R0,4                SET INDEX INCREMENT TO 4         R41 S3508400
         LA    R1,L'MDCTOTAL-1     GET LOOP TERMINATION INDEX       R41 S3508500
MICELTOT L     R15,MDCTOTAL(WA)    GET LINE TOTAL EVENT COUNT       R41 S3508600
         AL    R15,ICETOTAL(WA)    ADD SESSION EVENT COUNT          R41 S3508700
         ST    R15,MDCTOTAL(WA)    STORE NEW TOTAL COUNT            R41 S3508800
         L     R15,MDCTSCNT(WA)    GET REMOTE TOTAL COUNT      @OZ27491 S3508820
         AL    R15,ICETOTAL(WA)    ADD SESSION EVENT TOTAL     @OZ27491 S3508840
         ST    R15,MDCTSCNT(WA)    STORE NEW EVENT COUNT       @OZ27491 S3508860
         BXLE  WA,R0,MICELTOT      LOOP UNTIL ALL COUNTS TOTALED    R41 S3508900
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3509000
         SPACE 1                                                    R41 S3509100
MICECLIX LH    R0,MDCTSNCT         GET LINE ALLOCATED ICE COUNT     R41 S3509200
         BCT   R0,MICEDFND         CHECK AND DECREMENT COUNT        R41 S3509300
         EJECT                                                      R41 S3509400
*        DISCONNECT REMOTE IF LAST SESSION DISCONNECT               R41 S3509500
         SPACE 1                                                    R41 S3509600
         STH   R0,MDCTSNCT         CLEAR ALLOCATED ICE COUNT AND    R41 S3509700
         ST    R0,MDCTICE           ZERO ALLOCATED ICE CHAIN        R41 S3509800
         L     R15,MDCTDCT         GET ADDR OF 1ST REMOTE DCT       R41 S3509900
         ST    R0,MDCTDCT          DISCONNECT REMOTE DCT CHAIN      R41 S3510000
         SPACE 3                                                    R41 S3510100
*        RESET REMOTE DCTS                                          R41 S3510200
         SPACE 1                                                    R41 S3510300
         USING DCTDSECT,R15        USE TEMP RMT DCT ADDRESSABILITY  R41 S3510400
MICERDSC ST    R0,DCTDCB           CLEAR LINE DCT PTR IN REMOTE DCT R41 S3510500
         NI    MDCTSTAT,255-DCTSINON-DCTSOFF  SHOW RMT SIGNED OFF   R41 S3510600
         L     R15,MDCTDCT         GET PTR TO NEXT REMOTE DCT       R41 S3510700
         LTR   R15,R15             TEST FOR END OF REMOTE CHAIN     R41 S3510800
         BNZ   MICERDSC            LOOP UNTIL NO MORE REMOTES       R41 S3510900
         DROP  R15                 DROP REMOTE DCT ADDRESSABILITY   R41 S3511000
         SPACE 3                                                    R41 S3511100
*        RESET RAT CONNECTIONS                                      R41 S3511200
         SPACE 1                                                    R41 S3511300
         USING RATDSECT,WA         USE TEMPORARY RAT ADDRESSABILITY R41 S3511400
         L     WA,MDCTRAT          SAVE ADDRESS OF RAT ENTRY        R41 S3511500
         TM    RATFLAGS,RATPILUN   LUNAME PERMANENT....        @OZ46756 S3511510
         BO    MICESYMB            YES, DO NOT CLEAR.          @OZ46756 S3511520
         MVI   RATSYMB,X'40'       CLEAR RAT LUNAME            @OZ46756 S3511530
         MVC   RATSYMB+1(7),RATSYMB   TO BLANKS.               @OZ46756 S3511540
MICESYMB DS    0H                                              @OZ46756 S3511550
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3511600
         TM    MDCTSTAT,DCTLEASE+DCTSHARE  TEST FOR SHARED LINE     R41 S3511700
         BO    MICELDED            DON'T CLEAR RAT LINE PTR IF YES  R41 S3511800
         XC    RATLDCT,RATLDCT     RESET RAT LINE DCT POINTER       R41 S3511900
         DROP  R14                 RELEASE LINE DCT ADDRESSABILITY  R41 S3512000
         SPACE 2                                                    R41 S3512100
*        INDICATE SIGN-OFF IN CHECKPOINT RECORD                     R41 S3512200
         SPACE 1                                                    R41 S3512300
*              THIS LINE DELETED BY APAR NUMBER                @OZ32567 S3512400
MICELDED LR    R1,WA               COPY RAT ADDRESS            @OZ32567 S3512500
         SL    R1,$RATABLE         WA = (RMT NUMBER -1) * RATTLE    R41 S3512600
         LR    R15,R1              MULTIPLY                         R41 S3512700
         ALR   R15,R1               BY                              R41 S3512800
         ALR   R15,R1                THREE                          R41 S3512900
         SLR   R14,R14             DIVIDE BY RATTLE                 R41 S3513000
         D     R14,=A(RATTLE)       AND BY 8 GIVING OFFSET TO       R41 S3513100
         D     R14,=A(8)             BYTE (QUOT) AND BIT (REMAIN)   R41 S3513200
         AL    R15,$RMTSON         R15 = BYTE ADDR OF SIGNON BITS   R41 S3513300
         L     R0,=A(-QUEBUSY*X'2000'-1)   GET BITS TO CLEAR BUSY   R41 S3513400
         SRL   R0,0(R14)           SHIFT TO BIT OFFSET              R41 S3513500
         STH   R0,MSONWORK         STORE FOR CLEAR                  R41 S3513600
         NC    0(2,R15),MSONWORK   INDICATE REMOTE OFF SYSTEM       R41 S3513700
         EJECT                                                      R41 S3513800
         L     R1,MCLOCK           GET CURRENT TIME                 R41 S3513900
         TM    RATFLAGS,RATSRMT+RATALM TEST FOR AUTOLOGON MODES     R41 S3514000
         BZ    MICEDTIM            NO, BRANCH USE CURRENT TIME      R41 S3514100
         AH    R1,=H'58'           ELSE, DELAY AUTOLOG RETRY 1 MIN. R41 S3514200
MICEDTIM ST    R1,RATIMER          STORE TIME OFF VALUE             R41 S3514300
         L     MDCT,ICELDCT        GET LINE DCT ADDRESS        @OZ27491 S3514320
         LR    WA,ML               SAVE 1ST LEVEL RETURN ADDR  @OZ27491 S3514340
         BAL   ML,MSMFDISC         GO DO SMF PROCESSING        @OZ27491 S3514360
         LR    ML,WA               RESTORE RETURN ADDRESS      @OZ27491 S3514380
         SPACE 2                                                    R41 S3514400
*        WRITE REMOTE SIGN-OFF MESSAGE                              R41 S3514500
         SPACE 1                                                    R41 S3514600
         L     R14,ICELDCT         RE-LOAD LINE DCT POINTER         R41 S3514700
         USING DCTDSECT,R14        RE-ESTABLISH DCT ADDRESSABILITY  R41 S3514800
         L     WA,MDCTRAT          RESTORE ADDRESS OF RAT      @OZ27491 S3514820
         XC    MDCTRAT,MDCTRAT     SHOW REMOTE DISCONNECTED    @OZ27491 S3514840
         TM    MDCTSTAT,DCTSINON   TEST FOR CONNECTED REMOTE        R41 S3514900
         BZ    MICELDSC            BR IF NO, SKIP MESSAGE           R41 S3515000
         L     R1,$MWORK           GET MESSAGE WORK AREA ADDR       R41 S3515100
         MVC   0(L'MDSCMSG,R1),MDSCMSG  MOVE MSG TO WORK AREA       R41 S3515200
         MVC   MDSCRMT-MDSCMSG(L'MDSCRMT,R1),RATNAME AND RMTID      R41 S3515300
         $WTO  (R1),L'MDSCMSG,JOB=NO,WAIT=NO,  ISSUE DISCONNECT,,,  R41CS3515400
               ROUTE=$LOG+$ERR+$TP,CLASS=$ALWAYS,PRI=$HI ..MESSAGE  R41 S3515500
         EJECT                                                      R41 S3515600
*        REMOVE LINE FROM ACTIVE QUEUE                              R41 S3515700
         SPACE 1                                                    R41 S3515800
MICELDSC L     R14,ICELDCT         RE-LOAD LINE DCT ADDRESS         R41 S3515900
         L     R1,MDCTADCT         GET POINTER TO NEXT ACTIVE LNE   R41 S3516000
         LA    R15,MSNALNE-MDCTADCT+DCTDSECT  GET PHONY DCT POINTER R41 S3516100
         USING DCTDSECT,R15        GET TEMP LINE DCT ADDRESSABILITY R41 S3516200
MICELDSL L     R0,MDCTADCT         GET ALLOCATED LINE CHAIN POINTER R41 S3516300
         CLR   R0,R14              COMPARE WITH OUR LINE            R41 S3516400
         BE    MICELDEQ            BRANCH IF LINE POINTS TO OURS    R41 S3516500
         LTR   R15,R0              TEST FOR END OF ALLOC LINE CHAIN R41 S3516600
         BNZ   MICELDSL            BRANCH TO TEST NEXT LINE IF NOT  R41 S3516700
         BAL   R8,M03A             ERROR IF LINE NOT FOUND     @OZ49689 S3516800
MICELDEQ ST    R1,MDCTADCT         DISCONNECT LINE FROM CHAIN       R41 S3516900
         DROP  R15                 RELEASE TEMP DCT ADDRESSABILITY  R41 S3517000
         NI    MDCTSTAT,255-DCTSINON-DCTSOFF  SHOW RMT SIGNED OFF   R41 S3517100
         SLR   WA,WA               DISCONNECT...                    R41 S3517200
         ST    WA,ICELDCT          ...LINE DCT FORM ICE             R41 S3517300
         SPACE 2                                                    R41 S3517400
*        RELEASE LINE DCT IF DRAINED                                R41 S3517500
         SPACE 1                                                    R41 S3517600
         TM    DCTSTAT,DCTDRAIN    TEST FOR DRAIN STATUS PENDING    R41 S3517700
         BZ    MICEDOFF            SHOW LINE IS OFF SYSTEM IF NOT   R41 S3517800
         DROP  WA                  RELEASE RAT ADDRESSABILITY       R41 S3517900
         SPACE 1                                                    R41 S3518000
        $FREUNIT (R14)             FREE THE LINE DCT                R41 S3518100
         LR    R14,R1              RELOAD LINE DCT ADDRESS          R41 S3518200
         $QSUSE TYPE=TEST          TEST SHARED QUEUES STATUS   @OZ32567 S3518220
         BZ    MICEDORM            QUES STILL OWNED, PROCEED   @OZ32567 S3518240
         NI    MEVNTIND,255-MEVNCKPT QUES NOT OWNED, RESET IND @OZ32567 S3518260
         SPACE 1                                                    R41 S3518300
MICEDORM $DORMANT                  INDICATE DORMANT FUNCTION   @OZ32567 S3518400
         B     MICECLOS            AND SIGN OFF REMOTE              R41 S3518500
         SPACE 2                                                    R41 S3518600
*        PLACE LINE ON IDLE LINE QUEUE                              R41 S3518700
         SPACE 1                                                    R41 S3518800
MICEDOFF L     R1,MSNAIDL          GET IDLE SNA LINE CHAIN PTR      R41 S3518900
         ST    R1,MDCTADCT         CONNECT IDLE LINES TO OUR LINE   R41 S3519000
         ST    R14,MSNAIDL         UPDATE LINE MANAGER IDLE CHAIN   R41 S3519100
         OI    MSCANIND,MSCNRAT    INDICATE RAT SCAN NEEDED         R41 S3519200
         B     MICECLOS            BRANCH TO INITIATE CLSDST SEQ    R41 S3519300
         EJECT                                                      R41 S3519400
MDSCMSG $MSG   203,'RMTXXXXX DISCONNECTED'  SNA REMOTE DISCONN MSG  R41 S3519500
MDSCRMT  EQU   MDSCMSG+2,8         REMOTE NAME                      R41 S3519600
         SPACE 2                                                    R41 S3519700
MLGOFMSG $MSG  210,'SESSION XXXXXXXX LOGGED OFF LINEYYYY'           R41 S3519800
MLGOFSYM EQU   MLGOFMSG+10,8       LUNAME                           R41 S3519900
MLGOFLNE EQU   MLGOFMSG+30,8       LINE NAME                        R41 S3520000
         SPACE 1                                                    R41 S3520100
MALMSG1  $MSG  207,'RMTXXXXX -- AUTOLOGON FAILED'                   R41 S3520200
MALMSGR  EQU   MALMSG1+2,L'RATNAME     REMOTE NAME                  R41 S3520300
         EJECT                                                      R41 S3520400
*        REMOVE ICE FROM LINE DCT CHAIN                             R41 S3520500
         SPACE 1                                                    R41 S3520600
MICEDFND STH   R0,MDCTSNCT         UPDATE ALLOCATED ICE COUNT       R41 S3520700
         L     R0,ICEALCHN         SAVE ADDRESS OF NEXT CHAINED ICE R41 S3520800
         LA    R15,MDCTICE-ICEALCHN+ICEDSECT  GET PHONY ICE ADDRESS R41 S3520900
         SPACE 1                                                    R41 S3521000
         USING ICEDSECT,R15        PROVIDE TEMP ICE ADDRESSABILITY  R41 S3521100
MICEDEAL L     R1,ICEALCHN         GET ADDRESS OF NEXT CHAINED ICE  R41 S3521200
         CLR   R1,MICE             COMPARE WITH OUR ICE             R41 S3521300
         BE    MICEDREM            BRANCH IF ICE POINTS TO OURS     R41 S3521400
         LTR   R15,R1              CHECK FOR END OF CHAIN           R41 S3521500
         BNZ   MICEDEAL            BRANCH TO TEST NEXT ICE          R41 S3521600
         BAL   R8,M03A             ERROR IF ICE NOT FOUND      @OZ49689 S3521700
MICEDREM ST    R0,ICEALCHN         DISCONNECT ICE FROM CHAIN        R41 S3521800
         DROP  R14,R15             DROP TEMP ICE/LINE DCT BASE      R41 S3521900
         SPACE 1                                                    R41 S3522000
         XC    ICEALCHN,ICEALCHN   CLEAR ICE CHAIN POINTER          R41 S3522100
         XC    ICELDCT,ICELDCT     CLEAR ICE LINE DCT POINTER       R41 S3522200
         EJECT                                                      R41 S3522300
*                                                                   R41 S3522400
*        SESSION CLSDST SUBROUTINE                                  R41 S3522500
*                                                                   R41 S3522600
         SPACE 1                                                    R41 S3522700
MICECLOS L     MBUF,ICEBUFAD       GET SPECIAL SEQ BUFFER ADDRESS   R41 S3522800
         TM    ICESTAT,ICECLOSE    TEST IF CLSDST IS REQUIRED       R41 S3522900
         BZ    MICEMELT            SKIP CLSDST ATTEMPT IF NOT       R41 S3523000
         NI    ICEFLAGS,255-ICECNECT RESET SESSION CONNECT     @OZ29432 S3523100
         TM    ICEINDEX,VSEQSPEC   IS ICE IN SPECIAL SEQUENCE STATE R41 S3523200
         MVI   ICEINDEX,VSEQCLOS   INDICATE CLSDST SEQUENCE REQ     R41 S3523300
         BZ    MICECLS0            NO, DON'T WAIT              @OZ45040 S3523400
         L     R15,ICEADCT         YES, GET LOGON DCT AND      @OZ45040 S3523410
         TM    MDCTSTAT-DCTDSECT(R15),DCTABORT TEST FOR ABORT  @OZ45040 S3523420
         BNOR  ML                  WAIT FOR SEQ TO COMPLETE    @OZ45040 S3523430
         LTR   MBUF,MBUF           IS THERE A BUFFER...        @OZ45040 S3523440
         BZ    MICEMELT            NO, DON'T WAIT              @OZ45040 S3523450
         CLI   RPLACTIV-RPLDSECT(R4),X'80' IS IT ON $RJECHEQ.  @OZ45040 S3523460
         BNE   MICEMELT            NO, GO FREE IT              @OZ45040 S3523470
         BR    ML                  YES-WAIT FOR COMPLETION     @OZ45040 S3523480
MICECLS0 DS    0H                                              @OZ45040 S3523490
         TM    ICESTAT,ICEABORT    TEST SESSION STATUS              R41 S3523500
         BO    MICEMELT            SKIP CLSDST SEQ IF ABORTING      R41 S3523600
         L     R15,ICEADCT         GET APPL LOGON DCT ADDR          R41 S3523700
         TM    MDCTSTAT-DCTDSECT(R15),DCTABORT  TEST APPLIC STATUS  R41 S3523800
         BO    MICEMELT            SKIP CLSDST SEQ IF ABORTING      R41 S3523900
         LTR   MBUF,MBUF           TEST SPECIAL SEQ BUFFER ADDRESS  R41 S3524000
         LA    R14,VSEQGCLS        SET CLSDST CODE IN CASE NO BUF   R41 S3524100
         BZ    MICEGBUF            BRANCH IF NEED TO GET A BUFFER   R41 S3524200
         SPACE 1                                                    R41 S3524300
         USING RPLDSECT,MBUF       ALLOW RPL ADDRESSABILITY         R41 S3524400
MICECBLD ST    MBUF,ICEBUFAD       STORE SPECIAL SEQ BUF ADDRESS    R41 S3524500
         OI    ICESTAT,ICEABORT    PREVENT FURTHER CLSDST ATTEMPTS  R41 S3524600
         MVC   RPLDCT+1(3),ICEADCT+1  MOVE LOGON DCT ADDR TO ICE    R41 S3524700
         ST    MICE,RPLICE         STORE ICE ADDRESS IN RPL         R41 S3524800
         MVI   RPLSEQTP,VSEQCLOS   INDICATE CLSDST SEQUENCE         R41 S3524900
         MVI   RPLREQ,RPLCLOSE     SHOW RPL CLSDST REQUEST TYPE     R41 S3525000
         MVC   RPLARG,ICECID       MOVE VTAM CID TO RPL             R41 S3525100
         MVI   RPLEXTDS,0          SHOW NOT A BRANCH ENTRY REQ      R41 S3525200
         B     MVRPLXEC            PASS REQUEST TO VTAM             R41 S3525300
         SPACE 2                                                    R41 S3525400
         DROP  MBUF                RELEASE RPL ADDRESSABILITY       R41 S3525500
         EJECT                                                      R41 S3525600
*                                                                   R41 S3525700
*        SUBROUTINE TO REQUEST SESSION DELAY INTERVAL               R41 S3525800
*                                                                   R41 S3525900
         SPACE 1                                                    R41 S3526000
MICETIME L     R1,MDCTRAT          GET TERMINAL RAT ENTRY ADDR      R41 S3526100
         LH    R1,RATWTIME-RATDSECT(,R1)  GET TERMINAL WAIT TIME    R41 S3526200
         LTR   R1,R1               WAIT TIME INTERVAL SPECIFIED     R41 S3526300
         BNZ   MICEDLAY            USE TERMINAL VALUE IF YES        R41 S3526400
         LH    R1,$WAITIME         GET INSTALLATION DEFAULT VALUE   R41 S3526500
         SPACE 1                                                    R41 S3526600
MICEDLAY AL    R1,MDCTIMOK         COMPUTE INTERVAL EXPIRATION TIME R41 S3526700
         ST    R1,ICEWTIME         STORE IN ICE                     R41 S3526800
         OI    ICESTAT,ICETIMER    SHOW ICE REQS WAIT TIME CHECK    R41 S3526900
         BR    WA                  RETURN TO CALLER                 R41 S3527000
         SPACE 2                                                    R41 S3527100
         DROP  MICE                RELEASE ICE ADDRESSABILITY       R41 S3527200
         TITLE 'HASP LINE MANAGER -- SMF RECORDING SUBROUTINES'     R41 S3527300
*                                                                   R41 S3527400
*        WRITE LINE START SMF RECORD SUBROUTINE                     R41 S3527500
*                                                                   R41 S3527600
         SPACE 1                                                    R41 S3527700
MSMFSTRT DS    0H                  LINE START EVENT SMF RECORD      R41 S3527800
         CLI   $NUMSMFB,2          CHECK SMF OPTIONS                R41 S3527900
         BLR   ML                  RETURN IF NO SMF REQ             R41 S3528000
        $GETSMFB WAIT=NO           TRY TO GET SMF BUFFER            R41 S3528100
         BZR   ML                  RETURN IF FAILED TO GET BUFFER   R41 S3528200
         USING SMFDSECT,R1         ESTABLISH SMF BUFFER ADDRESS     R41 S3528300
         TM    MDCTTYPE,DCTPSNA    CHECK LINE TYPE             @OZ27491 S3528320
         BO    MSMFSNA1            BRANCH IF SNA LINE          @OZ27491 S3528340
         MVI   SMFRDW+1,SMF47LN2-SMFRDW  SET RECORD LENGTH          R41 S3528400
         MVI   SMFHDRTY,SMFSSETP   SET START EVENT RECORD TYPE      R41 S3528500
         MVI   SMF47EVT+1,SMFLINEV SET LINE EVENT TYPE              R41 S3528600
         MVI   SMF47LN1+1,SMF47LN2-SMF47LN1  SET ID SECTION LENGTH  R41 S3528700
         B     MSMFWRIT            BRANCH TO QUEUE SMF RECORD       R41 S3528800
         SPACE 1                                               @OZ27491 S3528900
*                                                                   R41 S3529000
*        WRITE REMOTE DISCONNECT RECORD SUBROUTINE                  R41 S3529100
*                                                                   R41 S3529200
         SPACE 1                                                    R41 S3529300
MSMFDISC DS    0H                  REMOTE DISCONN EVENT SMF RECORD  R41 S3529400
         CLI   $NUMSMFB,2          CHECK SMF OPTIONS           @OZ27491 S3529420
         BLR   ML                  RETURN IF NO SMF REQUIRED   @OZ27491 S3529440
        $GETSMFB WAIT=NO           TRY TO GET SMF BUFFER            R41 S3529500
         BZR   ML                  RETURN IF FAILED TO GET BUFFER   R41 S3529600
         MVI   SMFSUBID+1,SMFLOGOF INDICATE LOGOFF EVENT       @OZ27491 S3529650
         MVC   SMF53CTR,MDCTSCNT   MOVE REMOTE TOTAL COUNTS    @OZ27491 S3529700
MSMFSNA2 MVI   SMFHDRTY,SMF53      SET SMF RECORD TYPE         @OZ27491 S3529750
         MVC   SMF53ADP,=C'SNA'    SET LINE IDENTIFIER         @OZ27491 S3529800
         MVI   SMFIDLEN+1,SMF53END-SMFIDSEC  ID SEC LENGTH     @OZ27491 S3529850
         MVI   SMFRDW+1,SMF53END-SMFRDW  RECORD LENGTH         @OZ27491 S3529900
         B     MSMFSNA5            GO FINISH RECORD            @OZ27491 S3529950
         SPACE 1                                               @OZ27491 S3530000
*                                                                   R41 S3530100
*        WRITE LINE STOP RECORD SUBROUTINE                          R41 S3530200
*                                                                   R41 S3530300
         SPACE 1                                                    R41 S3530400
MSMFSTOP DS    0H                  LINE DRAIN EVENT SMF RECORD      R41 S3530500
         CLI   $NUMSMFB,2          CHECK SMF OPTIONS                R41 S3530600
         BLR   ML                  RETURN IF NO SMF REQ             R41 S3530700
        $GETSMFB WAIT=NO           TRY TO GET SMF BUFFER            R41 S3530800
         BZR   ML                  RETURN IF FAILED TO GET BUFF     R41 S3530900
         TM    MDCTTYPE,DCTPSNA    CHECK LINE TYPE             @OZ27491 S3530920
         BO    MSMFSNA4            BRANCH IF SNA LINE          @OZ27491 S3530940
         MVI   SMF48EVT+1,SMFLINEV SET LINE EVENT TYPE              R41 S3531000
         MVC   SMF48CTR,MDCTOTAL   MOVE LINE EVENT COUNTS           R41 S3531100
         EJECT                                                      R41 S3531200
*                                                                   R41 S3531300
*        LINE STOP SMF RECORD CODE                             @OZ27491 S3531400
*                                                                   R41 S3531500
         SPACE 1                                                    R41 S3531600
MSMFTERM MVI   SMFRDW+1,SMF48END-SMFRDW  SET RECORD LENGTH          R41 S3531700
         MVI   SMFHDRTY,SMFPSETP   SET STOP EVENT RECORD TYPE       R41 S3531800
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3531900
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3532000
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3532100
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3532200
MSMFNSNA L     R15,DCTDCB          GET LINE ADAPTER ADDRESS         R41 S3532300
         L     R15,DCBDEBAD-DCBDSECT(,R15)  FROM THE UCB            R41 S3532400
         L     R15,DEBSUCBA-DEBDSECT(,R15)   AND STORE IT IN        R41 S3532500
         MVC   SMF48ADP,UCBNAME-UCBDSECT(R15)  THE SMF RECORD       R41 S3532600
         SPACE 3                                                    R41 S3532700
*                                                                   R41 S3532800
*        COMMON SMF RECORD WRITE ROUTINE                            R41 S3532900
*                                                                   R41 S3533000
         SPACE 1                                                    R41 S3533100
MSMFWRIT MVI   SMFSSID+1,SMFHSPID  SET HASP SUBSYSTEM ID            R41 S3533200
         LH    R0,SMFRDW           COMPUTE AND STORE LENGTH OF      R41 S3533300
         SH    R0,=Y(SMFSSTRT-SMFRDW)  THAT PORTION OF THE RECORD   R41 S3533400
         STH   R0,SMFSSLEN          FOLLOWING THE SUBSYSTEM HDR     R41 S3533500
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3533600
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3533700
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3533800
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3533900
         ICM   R15,15,MDCTRAT      ANYTHING CONNECTED          @OZ27491 S3534000
         BZ    MSMFNCON            SKIP IF NOT                 @OZ27491 S3534100
         MVC   SMF48RMT,RATNAME-RATDSECT(R15) SET IDENTIFICATION    R41 S3534200
MSMFNCON MVC   SMF48LIN,DCTDEVN    SET LINE NAME IN RECORD     @OZ27491 S3534300
         MVC   SMF48PSW,MDCTPSWD   SET PASSWORD FROM LINE           R41 S3534400
MSMFQBF $QUESMFB                   QUEUE THE SMF RECORD        @OZ27491 S3534500
         BR    ML                  RETURN                      @OZ27491 S3534510
         EJECT                                                 @OZ27491 S3534520
MSMFSNA1 MVI   SMFSUBID+1,SMFSLINE INDICATE LINE EVENT         @OZ27491 S3534530
         MVI   SMFRDW+1,SMF52END-SMFRDW  LENGTH OF RECORD      @OZ27491 S3534540
         MVI   SMFHDRTY,SMF52      RECORD TYPE                 @OZ27491 S3534550
         MVI   SMFIDLEN+1,SMF52END-SMFIDSEC  ID SEC LENGTH     @OZ27491 S3534560
MSMFSNA5 ICM   R15,15,MDCTRAT      ANYTHING CONNECTED          @OZ27491 S3534570
         BZ    MSMFSNA3            NO, SKIP NEXT               @OZ27491 S3534580
         MVC   SMF52RMT,RATNAME-RATDSECT(R15)  REMOTE NAME     @OZ27491 S3534590
MSMFSNA3 MVC   SMF52LIN,DCTDEVN    LINE NAME                   @OZ27491 S3534600
         MVC   SMF52PSW,MDCTPSWD   LINE PASSWORD               @OZ27491 S3534610
         MVI   SMFPROFF+1,SMFSUBID-SMFJMR  OFFSET TO PROD SECT @OZ27491 S3534620
         MVI   SMFPRLEN+1,SMFIDSEC-SMFSUBID  PROD SEC LENGTH   @OZ27491 S3534630
         MVI   SMFPRNUM+1,1        PRODUCT SECTION NUMBER      @OZ27491 S3534640
         MVI   SMFIDOFF+1,SMFIDSEC-SMFJMR  OFFSET TO ID SECT   @OZ27491 S3534650
         MVI   SMFIDNUM+1,1        ID SECTION NUMBER           @OZ27491 S3534660
         MVC   SMFVERNO,=C'01'     VERSION NUMBER              @OZ27491 S3534670
         MVC   SMFSYSNM,=C'JES2'   SUBSYSTEM NAME              @OZ27491 S3534680
         B     MSMFQBF             GO QUEUE RECORD FOR OUTPUT  @OZ27491 S3534690
MSMFSNA4 MVI   SMFSUBID+1,SMFPLINE INDICATE LINE EVENT         @OZ27491 S3534700
         MVC   SMF53CTR,MDCTOTAL   MOVE LINE COUNTERS          @OZ27491 S3534710
         B     MSMFSNA2            GO CONTINUE RECORD          @OZ27491 S3534720
         DROP  R1                  RELEASE SMF ADDRESSABILITY  @OZ27491 S3534730
         TITLE 'HASP LINE MANAGER -- LOGON/LINE DCT INITIATION/TERMINATCS3534800
               ION SUBROUTINES'                                     R41 S3534900
*                                                                   R41 S3535000
*        LINE/LOGON DCT BSC/SNA COMMON ALLOCATION SUBROUTINE        R41 S3535100
*                                                                   R41 S3535200
         SPACE 1                                                    R41 S3535300
MLDCTGET DS    0H                                                   R41 S3535400
        $GETUNIT (MDCT)            TRY TO ACQUIRE LOGON/LINE DCT    R41 S3535500
         BZR   WA                  RETURN IF FAILED TO GET DCT      R41 S3535600
         SPACE 1                                                    R41 S3535700
        $ACTIVE                    INDICATE NEW ACTIVE FUNCTION     R41 S3535800
         SPACE 1                                                    R41 S3535900
         XC    MDCTOTAL,MDCTOTAL   CLEAR ALL EVENT COUNTERS         R41 S3536000
         SPACE 1                                                    R41 S3536100
         CLI   DCTDEVTP,DCTLOG     CHECK FOR LOGON DCT              R41 S3536200
         BE    MLOGSTRT            INITIALIZE LOGON DCT IF YES      R41 S3536300
         TM    MDCTTYPE,DCTPSNA    CHECK LINE DCT TYPE              R41 S3536400
         BO    MSNASTRT            BRANCH IF SNA INTERFACE LINE     R41 S3536500
         B     MBSCSTRT            BRANCH TO INIT BSC LINE DCT      R41 S3536600
         SPACE 2                                                    R41 S3536700
*                                                                   R41 S3536800
*        LOGON/LINE DCT BSC/SNA COMMON DE-ALLOCATION SUBROUTINE     R41 S3536900
*                                                                   R41 S3537000
         SPACE 1                                                    R41 S3537100
MLDCTREL OI    MSCANREQ,MSCNUNIT   REQ UNIT SCAN ON NEXT DISP       R41 S3537200
         OI    MHASPECF+$EWBBUF,$EWFBUF   SHOW LINE MANAGER REQ     R41 S3537300
         OI    MHASPECF+$EWBPOST,$EWFPOST  DISP ON NEXT BUFF POST   R41 S3537400
         SPACE 1                                                    R41 S3537500
MLDCTFRE DS    0H                                                   R41 S3537600
         MVI   DCTBUFCT,0          FORCE OUTST BUFF COUNT ZERO      R41 S3537700
        $FREUNIT (MDCT)            FREE THE LOGON/LINE DCT          R41 S3537800
         $QSUSE TYPE=TEST          TEST SHARED QUEUES STATUS   @OZ32567 S3537820
         BZ    MLDCTDRM            QUES STILL OWNED, PROCEED   @OZ32567 S3537840
         NI    MEVNTIND,255-MEVNCKPT QUES NOT OWNED, RESET IND @OZ32567 S3537860
         SPACE 1                                                    R41 S3537900
MLDCTDRM $DORMANT                  INDICATE DORMANT FUNCTION   @OZ32567 S3538000
         SPACE 1                                                    R41 S3538100
         BR    WA                  RETURN TO CALLER                 R41 S3538200
         EJECT                                                      R41 S3538300
*                                                                   R41 S3538400
*        SNA LOGON DCT INITIALIZATION AND ACB OPEN SUBROUTINE       R41 S3538500
*                                                                   R41 S3538600
         SPACE 1                                                    R41 S3538700
MLOGSTRT DS    0H                  INITIALIZE SNA LOGON DCT         R41 S3538800
        $GETBUF TYPE=VTAM          ACQUIRE AND INIT VTAM BUFFER     R41 S3538900
         BZ    MLDCTREL            BRANCH IF FAILED FOR BUFFER      R41 S3539000
         ST    R1,DCTBUFAD         STORE BUFFER ADDRESS IN DCT      R41 S3539100
         SPACE 1                                                    R41 S3539200
         NI    DCTFLAGS,DCTLOGAL   RESET FLAGS -EXCEPT LOGGING      R41 S3539300
         MVI   MDCTSTAT,0          RESET LOGON DCT STATUS FLAGS     R41 S3539400
         MVI   MDCTRALM,1          SET MAX ACT RCV ANY BUF CN  @OZ39964 S3539500
         MVI   MDCTRQLM,5          SHOW MAX PRE-FORMATTED RCVS CNT  R41 S3539600
*                                   AND GO POST ACB OPEN/CLOSE TASK R41 S3539700
         SPACE 2                                                    R41 S3539800
*                                                                   R41 S3539900
*        VTAM ACB OPEN/CLOSE SUBTASK INTERFACE SUBROUTINE           R41 S3540000
*                                                                   R41 S3540100
         SPACE 1                                                    R41 S3540200
MLOGPOST DS    0H                                                   R41 S3540300
         L     R1,$VLOGQUE         GET POINTER OF LOGON DCT QUEUE   R41 S3540400
MLOGPLOP ST    R1,MDCTADCT         CHAIN THIS LOGON DCT TO QUEUE    R41 S3540500
         CS    R1,MDCT,$VLOGQUE    ATTEMPT TO UPDATE QUEUE POINTER  R41 S3540600
         BNE   MLOGPLOP            RETRY IF UNSUCCESSFUL            R41 S3540700
         SPACE 1                                                    R41 S3540800
         LA    R1,$SNAECB          GET ADDR OF OPEN/CLOSE ACB       R41 S3540900
         POST  (1)                  SUBTASK ECB AND POST FOR WORK   R41 S3541000
         BR    WA                  RETURN TO CALLER                 R41 S3541100
         EJECT                                                      R41 S3541200
*                                                                   R41 S3541300
*        SNA LOGON DCT TERMINATION AND ACB CLOSE SUBROUTINE         R41 S3541400
*                                                                   R41 S3541500
         SPACE 1                                                    R41 S3541600
MLOGSTOP DS    0H                  TERMINATE SNA LOGON DCTS         R41 S3541700
         TM    MDCTSTAT,DCTABORT   TEST FOR ABORT IN PROGRESS  @OZ38130 S3541720
         BO    MLOGSPRA            YES, PROCESS RABF AND RQBF  @OZ38130 S3541740
         L     R14,MDCTRQBF        CHECK RECEIVE-AHEAD         @OZ38130 S3541800
         LTR   R14,R14              BUFFER QUEUE ANCHOR        @OZ38130 S3541900
         BZ    MLOGSTP1            BRANCH IF NOTHING TO PURGE       R41 S3542000
         LA    R1,0(R14)           PURIFY ADDR OF 1ST RPL      @OZ38130 S3542100
MLOGSPRC LR    R15,R14             CURRENT RPL ADDR = NEXT RPL ADDR R41 S3542200
         USING RPLDSECT,R15        USE TEMPORARY RPL ADDRESSABILITY R41 S3542300
         MVI   RPLRTNCD,USFDAMGE   SIMULATE RETURN CODES FOR        R41 S3542400
         MVI   RPLFDB2,USFCLOCC     REQUEST CANCELLED BY CLOSE      R41 S3542500
         ICM   R14,15,RPLNEXT      MORE RPL'S TO PURGE...      @OZ38130 S3542600
*              THIS LINE DELETED BY APAR NUMBER                @OZ38130 S3542650
         BNZ   MLOGSPRC            LOOP TILL RECEIVE-AHEAD Q EMPTY  R41 S3542700
         B     MLOGSQCE                                        @OZ38130 S3542710
MLOGSPRA SR    R14,R14             SET TEST REG ZERO           @OZ38130 S3542720
         ICM   R14,7,MDCTRABF+1    CHECK FOR REC. ANY BUFFERS  @OZ38130 S3542730
         BZ    MLOGSTP1            BR IF NOTHING TO PURGE      @OZ38130 S3542740
         LR    R1,R14              SAVE RABF POINTER           @OZ38130 S3542750
MLOGSPRQ LR    R15,R14             GET NEXT RPL ADDR           @OZ38130 S3542760
         USING RPLDSECT,R15        TEMP. RPL ADDRESSABILITY    @OZ38130 S3542770
         MVI   RPLRTNCD,USFDAMGE   SIMULATE RETURN CODES FOR   @OZ38130 S3542780
         MVI   RPLFDB2,USFCLOCC     REQUEST CANCELLED BY CLOSE @OZ38130 S3542790
         MVC   RPLNEXT+1(3),RPLFCHN+1  REBUILD RPLNEXT CHAIN   @OZ38130 S3542800
         ICM   R14,7,RPLFCHN+1          FOR QUEING ON RJECHEQ  @OZ38130 S3542810
         BNZ   MLOGSPRQ            LOOP THRU ALL RECEIVE ANY'S @OZ38130 S3542820
         ST    R14,MDCTRABF        CLEAR REC. ANY QUE POINTER  @OZ38130 S3542830
MLOGSQCE L     R0,$RJECHEQ         GET LM WORK QUEUE POINTER   @OZ38130 S3542840
MLOGSLOP ST    R0,RPLNEXT          ADD RPLS TO I/O COMPLETION QUEUE R41 S3542900
         CS    R0,R1,$RJECHEQ      ATTEMPT TO UPDATE  QUEUE POINTER R41 S3543000
         BNE   MLOGSLOP            RETRY IF UNSUCCESSFUL            R41 S3543100
         ST    R14,MDCTRQBF        CLEAR RECEIVE-AHEAD QUE POINTER  R41 S3543200
         OI    MSCANREQ,MSCNSLOG   SET SCAN REQ ON NEXT DSP    @OZ50378 S3543225
         LR    R14,R1              SAVE RPL ADDRESS            @OZ50378 S3543250
         B     MLOGSOFF            BYPASS DCT DISCONNECT       @OZ50378 S3543275
         DROP  R15                 DISCARD TEMP RPL ADDRESSABILITY  R41 S3543300
         SPACE 1                                                    R41 S3543400
MLOGSTP1 L     R0,MDCTADCT         SAVE ADDR OF NEXT CHAINED DCT    R41 S3543500
         LA    R15,MSNALOG-MDCTADCT+DCTDSECT SET UP PHONY LOGON DCT R41 S3543600
         SPACE 1                                                    R41 S3543700
         USING DCTDSECT,R15        TEMPORARY DCT ADDRESSABILITY     R41 S3543800
MLOGSFND L     R1,MDCTADCT         GET ADDR OF NEXT LOGON DCT       R41 S3543900
         CLR   R1,MDCT             IS THIS DCT POINTING TO OUR DCT  R41 S3544000
         BE    MLOGSDEQ            BRANCH IF THIS IS PRECEDING DCT  R41 S3544100
         LTR   R15,R1              CHECK FOR END OF CHAIN           R41 S3544200
         BNZ   MLOGSFND            BRANCH TO TEST NEXT LOGON DCT    R41 S3544300
         BAL   R8,M03A             ERROR IF DCT NOT FOUND      @OZ49689 S3544400
MLOGSDEQ ST    R0,MDCTADCT         DISCONNECT DCT FROM CHAIN        R41 S3544500
         DROP  R15                 RELEASE TEMPORARY DCT BASE       R41 S3544600
         SPACE 1                                                    R41 S3544700
MLOGSOFF OI    MDCTSTAT,DCTSOFF    IND CLOSE ACB REQUESTED     @OZ50378 S3544800
         LTR   R14,R14             IF NO RPLS WERE PURGED...   @OZ50378 S3544850
         BZ    MLOGPOST             THEN POST SUBTASK          @OZ50378 S3544900
         BR    WA                  ELSE, WAIT FOR NEXT DSP     @OZ50378 S3544950
         EJECT                                                      R41 S3545000
*                                                                   R41 S3545100
*        SNA LINE DCT INITIALIZATION SUBROUTINE                     R41 S3545200
*                                                                   R41 S3545300
         SPACE 1                                                    R41 S3545400
MSNASTRT DS    0H                  INITIALIZE SNA LINE DCTS         R41 S3545500
         L     R1,MSNAIDL          GET IDLE SNA LINE DCT PNTR       R41 S3545600
         ST    R1,MDCTADCT         CHAIN IDLE LINES TO DCT          R41 S3545700
         ST    MDCT,MSNAIDL        UPDATE LINE MANAGER DCT PNTR     R41 S3545800
         OI    MSCANIND,MSCNRAT    FORCE RAT AUTOLOGON SCAN         R41 S3545900
         XC    MDCTOTAL,MDCTOTAL   CLEAR LINE COUNTS           @OZ27491 S3545950
         BAL   ML,MSMFSTRT         WRITE LINE START SMF RECORD      R41 S3546000
         BR    WA                  RETURN TO CALLER                 R41 S3546100
         SPACE 3                                                    R41 S3546200
*                                                                   R41 S3546300
*        SNA LINE DCT TERMINATION SUBROUTINE                        R41 S3546400
*                                                                   R41 S3546500
         SPACE 1                                                    R41 S3546600
MSNASTOP DS    0H                  TERMINATE SNA LINE DCTS          R41 S3546700
         BAL   ML,MSMFSTOP         WRITE TERMINATION SMF RECORD     R41 S3546800
         L     R0,MDCTADCT         SAVE ADDR OF NEXT CHAINED DCT    R41 S3546900
         LA    R15,MSNAIDL-MDCTADCT+DCTDSECT SET UP PHONY LINE DCT  R41 S3547000
         SPACE 1                                                    R41 S3547100
         USING DCTDSECT,R15        TEMPORARY DCT ADDRESSABILITY     R41 S3547200
MSNASNXT L     R1,MDCTADCT         GET ADDR OF NEXT LINE DCT        R41 S3547300
         CLR   R1,MDCT             IS THIS DCT POINTING TO OUR DCT  R41 S3547400
         BE    MSNASDSC            BRANCH IF THIS IS PRECEDING DCT  R41 S3547500
         LTR   R15,R1              CHECK FOR END OF CHAIN           R41 S3547600
         BNZ   MSNASNXT            BRANCH TO TEST NEXT LOGON DCT    R41 S3547700
         BAL   R8,M03A             ERROR IF DCT NOT FOUND      @OZ49689 S3547800
MSNASDSC ST    R0,MDCTADCT         DISCONNECT DCT FROM CHAIN        R41 S3547900
         DROP  R15                 RELEASE TEMPORARY DCT BASE       R41 S3548000
         SPACE 1                                                    R41 S3548100
         XC    MDCTADCT,MDCTADCT   CLEAR LINE DCT CHAIN POINTER     R41 S3548200
         B     MLDCTFRE            BRANCH TO FREE LINE DCT          R41 S3548300
         EJECT                                                      R41 S3548400
*                                  ADDRESSABILITY --                R41 S3548500
         USING RTAMBSUB,MBASE2,MBASE3    -- COMMON BSC SUBROUTINES  R41 S3548600
*                                                                   R41 S3548700
*        BSC LINE DCT INITIALIZATION ROUTINE                        R41 S3548800
*                                                                   R41 S3548900
         SPACE 1                                                    R41 S3549000
MBSCSTRT DS    0H                  INITIALIZE BSC LINE DCTS         R41 S3549100
        $GETBUF TYPE=BSC,FIX=YES   ACQUIRE AND INIT BSC BUFFER      R41 S3549200
         BZ    MLDCTREL            BRANCH IF FAILED FOR BUFFER      R41 S3549300
         LR    MBUF,R1             SET UP BUFFER REGISTER           R41 S3549400
         ST    MBUF,DCTBUFAD       STORE BUFFER ADDRESS IN DCT      R41 S3549500
         USING BUFDSECT,MBUF       SHOW BUFFER ADDRESSABLE          R41 S3549600
         SPACE 1                                                    R41 S3549700
         L     R1,MBSCACT          GET ACTIVE BSC LINE DCT PNTR     R41 S3549800
         ST    R1,MDCTADCT         CHAIN ACTIVE LINES TO OUR DCT    R41 S3549900
         ST    MDCT,MBSCACT        UPDATE LINE MANAGER DCT PNTR     R41 S3550000
         SPACE 1                                                    R41 S3550100
         XC    MDCTCNTS,MDCTCNTS   CLEAR SESSION EVENT COUNTERS     R41 S3550200
         BAL   ML,MSMFSTRT         WRITE LINE START SMF RECORD      R41 S3550300
         SPACE 1                                                    R41 S3550400
MBSCINIT MVI   MSEQTYPE,0          RESET SEQUENCE TYPE FIELD        R41 S3550500
         MVI   MDCTERCT,8          RESET ERROR COUNT IN LINE        R41 S3550600
         NI    DCTFLAGS,DCTLOGAL   RESET FLAGS -EXCEPT LOGGING      R41 S3550700
         MVI   MDCTIMOK,255        SHOW MODEM ON HOOK               R41 S3550800
         MVC   LCBMCB,MDCTMODE     SET UP SDA MODE BYTE             R41 S3550900
         SPACE 1                                                    R41 S3551000
         LA    MCODE,MEBCDIC       ASSUME EBCDIC CODE               R41 S3551100
         TM    MDCTLINE,DCTPASCI   TEST CODE TYPE                   R41 S3551200
         BZ    MBSCNASC            BRANCH IF EBCDIC                 R41 S3551300
         LA    MCODE,MUSASCII      LOAD USASCII CODE                R41 S3551400
         SPACE 1                                                    R41 S3551500
MBSCNASC LR    R15,MDCT            ASSUME NOT LEASED LINE           R41 S3551600
         TM    MDCTSTAT,DCTLEASE   TEST LINE STATUS                 R41 S3551700
         BZ    MBSCNLSD            SKIP IF NOT LEASED LINE          R41 S3551800
         L     R15,MDCTDCT         GET ADDRESS OF REMOTE DCT        R41 S3551900
MBSCNLSD TM    MDCTLINE-DCTDSECT(R15),DCTPTRSP  TEST TRANSPARENCY   R41 S3552000
         BZ    MBSCNXPR            BRANCH IF NO TRANSPARENCY        R41 S3552100
         LA    MCODE,4(MCODE)      STEP TO TRANSPARENT 1/2 OF TABLE R41 S3552200
MBSCNXPR ST    MCODE,MDCTCODE      SET CODE TABLE ADDRESS           R41 S3552300
         SPACE 1                                                    R41 S3552400
         MVI   TPBRECNT,C'E'       INDICATE EMPTY INPUT BUFFER      R41 S3552500
         LA    R0,IOBCCW1          GET ADDRESS OF FIRST CCW         R41 S3552600
         SPACE 1                                                    R41 S3552700
         LA    R1,MBSCSEQ+MPREPSEQ REQ BSC PREPARE SEQUENCE         R41 S3552800
         BAL   ML,MCCWINIT         INITIALIZE CCW'S                 R41 S3552900
         BAL   ML,MERREXCP         INITIALIZE LINE I/O              R41 S3553000
         SPACE 1                                                    R41 S3553100
         BR    WA                  RETURN TO CALLER                 R41 S3553200
         SPACE 1                                                    R41 S3553300
         DROP  MBUF                RELEASE BUFFER ADDRESSABILITY    R41 S3553400
         EJECT                                                      R41 S3553500
*                                                                   R41 S3553600
*        BSC LINE DCT TERMINATION SUBROUTINE                        R41 S3553700
*                                                                   R41 S3553800
         SPACE 1                                                    R41 S3553900
MBSCSTOP DS    0H                  TERMINATE BSC LINE DCTS          R41 S3554000
         SR    R1,R1               SET INITIAL INDEX TO ZERO        R41 S3554100
         LA    R14,4               SET INDEX INCREMENT TO 4         R41 S3554200
         LA    R15,L'MDCTOTAL-1    GET LOOP TERMINATION INDEX       R41 S3554300
MBSCTOTL L     R0,MDCTOTAL(R1)     GET LINE TOTAL EVENT COUNT       R41 S3554400
         AL    R0,MDCTCNTS(R1)     ADD SESSION EVENT COUNT          R41 S3554500
         ST    R0,MDCTOTAL(R1)     STORE NEW TOTAL COUNT            R41 S3554600
         BXLE  R1,R14,MBSCTOTL     LOOP UNTIL ALL COUNTS TOTALED    R41 S3554700
         XC    MDCTCNTS,MDCTCNTS   RESET ALL SESSION COUNTS         R41 S3554800
         SPACE 1                                                    R41 S3554900
         BAL   ML,MSMFSTOP         WRITE TERMINATION SMF RECORD     R41 S3555000
         SPACE 1                                                    R41 S3555100
         L     R1,DCTBUFAD         LOAD BUFFER ADDR IN R1           R41 S3555200
         LTR   R1,R1               TEST BUFFER ADDRESS              R41 S3555300
         BZ    MBSCSDEQ            ZERO - GO TO ABNORMAL EXIT       R41 S3555400
        $FREEBUF (R1)              FREE THE BUFFER                  R41 S3555500
         SPACE 1                                                    R41 S3555600
MBSCSDEQ L     R0,MDCTADCT         SAVE ADDR OF NEXT CHAINED LINE   R41 S3555700
         LA    R15,MBSCACT-MDCTADCT+DCTDSECT  SET UP PHONY LINE DCT R41 S3555800
         SPACE 1                                                    R41 S3555900
         USING DCTDSECT,R15        TEMPORARY DCT ADDRESSABILITY     R41 S3556000
MBSCSNXT L     R1,MDCTADCT         GET ADDR OF NEXT LINE DCT        R41 S3556100
         CLR   R1,MDCT             IS THIS LINE POINTING TO OUR DCT R41 S3556200
         BE    MBSCSDSC            BRANCH IF THIS IS PRECEDING DCT  R41 S3556300
         LTR   R15,R1              CHECK FOR END OF CHAIN           R41 S3556400
         BNZ   MBSCSNXT            BRANCH TO TEST NEXT LINE DCT     R41 S3556500
         BAL   R8,M03A             ERROR IF DCT NOT FOUND      @OZ49689 S3556600
MBSCSDSC ST    R0,MDCTADCT         DISCONNECT OUR DCT FROM CHAIN    R41 S3556700
         DROP  R15                 RELEASE TEMPORARY DCT BASE       R41 S3556800
         SPACE 1                                                    R41 S3556900
         XC    MDCTADCT,MDCTADCT   CLEAR LINE DCT CHAIN POINTER     R41 S3557000
         B     MLDCTFRE             DCT AND BRANCH TO FREE LINE     R41 S3557100
         SPACE 2                                                    R41 S3557200
         DROP  MBASE2,MBASE3       RELEASE SUBROUTINE ADDRESSABILTY R41 S3557300
         SPACE 2                                                    R41 S3557400
         LTORG                                                      R41 S3557500
         TITLE 'HASP LINE MANAGER -- ACTIVE BSC LINE DCT WORK SCAN' R41 S3557600
*********************************************************************** S3557700
*                                                                     * S3557800
*        LINE MANAGER - ACTIVE BSC LINE DCT SCAN ROUTINE              * S3557900
*                                                                     * S3558000
*********************************************************************** S3558100
         SPACE 1                                                    R41 S3558200
*                                  ADDRESSABILITY --                R41 S3558300
         USING DCTDSECT,MDCT           -- LINE DCT                  R41 S3558400
         USING RTAMBSUB,MBASE2,MBASE3  -- COMMON SNA SUBROUTINES    R41 S3558500
         USING MDCTSCAN,MBASE1         -- LOCAL ROUTINE BASE        R41 S3558600
         SPACE 1                                                    R41 S3558700
MDCTSCAN DS    0H                                                   R41 S3558800
         SPACE 2                                                    R41 S3558900
*                                                                   R41 S3559000
*        PROPAGATE JOB POST EVENT                                   R41 S3559100
*                                                                   R41 S3559200
         SPACE 1                                                    R41 S3559300
         TM    MEVNTIND,MEVNPJOB   TEST FOR JOB POST EVENT          R41 S3559400
         BNO   MBACTIME            BRANCH IF NOT                    R41 S3559500
         OI    MDCTATTN,MDCTJOB    SHOW THIS POSTED FOR JOB         R41 S3559600
         EJECT                                                      R41 S3559700
*                                                                   R41 S3559800
*        BSC LINE DCT TIMER SERVICE SCAN                            R41 S3559900
*                                                                   R41 S3560000
         SPACE 1                                                    R41 S3560100
MBACTIME TM    MEVNTIND,MEVNTIME   CHECK FOR TIMER INTERV EXPIRED   R41 S3560200
         BZ    MBACTDSC            BRANCH IF NO TIMER SERVICE REQ   R41 S3560300
         TM    MDCTATTN,MDCTIMER   DOES THIS DCT REQ TIMER SERVICE  R41 S3560400
         BZ    MBACTDSC            CHECK FOR DISC INTERVAL IF NOT   R41 S3560500
         SPACE 1                                                    R41 S3560600
         L     MBUF,DCTBUFAD       GET ADDRESS OF BUFFER AND        R41 S3560700
         USING BUFDSECT,MBUF        SHOW ADDRESSABILITY             R41 S3560800
         L     MCODE,MDCTCODE      GET ADDRRESS OF CODE TABLE AND   R41 S3560900
         USING MCODSECT,MCODE       SHOW ADDRESSABILITY             R41 S3561000
         SPACE 1                                                    R41 S3561100
         LA    ML,MBACTXCP         GET ADDR OF TIMED EXCP ROUTINE   R41 S3561200
         TM    MSEQTYPE,MBSCSEQ+MCPUSEQ CHECK CCW SEQUENCE TYPE     R41 S3561300
         BNO   MABORT              ABORT AND RESTART HARDWARE TERM  R41 S3561400
         CLI   TPBRECNT,C'E'       TEST INPUT BUFFER STATUS         R41 S3561500
         BE    MBACTXCP            BRANCH IF INPUT BUFFER IS EMPTY  R41 S3561600
         TM    MDCTLINE,DCTPCTC    TEST FOR CTCA                    R41 S3561700
         BZ    MTIMEWAB            SET BSC WAIT-A-BIT               R41 S3561800
         SPACE 1                                                    R41 S3561900
         MVC   IOBCCW2(8),IOBCCW6  MOVE WRITE CCW                   R41 S3562000
         LA    R1,IOBCCW5          SET                              R41 S3562100
         ST    R1,IOBCCW2           UP                              R41 S3562200
         MVI   IOBCCW2,X'01'         A                              R41 S3562300
         LA    R1,6                   NULL                          R41 S3562400
         STH   R1,IOBCCW2+6            WAIT-                        R41 S3562500
         LA    R1,IOBCCW7               A-                          R41 S3562600
         ST    R1,IOBCCW4                BIT                        R41 S3562700
         MVI   IOBCCW4,X'02'              SEQUENCE                  R41 S3562800
         MVC   IOBCCW4+5(9),MWABTSEQ       FOR                      R41 S3562900
         MVC   IOBCCW5(2),MSTXSEQ           CTC                     R41 S3563000
         B     MBACTXCP                      RESPONSE               R41 S3563100
         SPACE 1                                                    R41 S3563200
MTIMEWAB MVC   IOBCCW2(4*8),IOBCCW5   NO,                           R41 S3563300
         LA    R1,IOBCCW6            A NULL                         R41 S3563400
         ST    R1,IOBCCW3             WAIT-A-BIT                    R41 S3563500
         MVI   IOBCCW3,X'01'           SEQUENCE                     R41 S3563600
         LA    R1,6                     FOR                         R41 S3563700
         STH   R1,IOBCCW3+6              RESPONSE                   R41 S3563800
         LA    R1,IOBCCW7                 TO                        R41 S3563900
         ST    R1,IOBCCW5                  MULTI-                   R41 S3564000
         MVI   IOBCCW5,X'02'                LEAVING                 R41 S3564100
         MVC   IOBCCW5+5(9),MWABTSEQ         RJE                    R41 S3564200
         MVC   IOBCCW6(2),MSTXSEQ             TERMINAL              R41 S3564300
         SPACE 1                                                    R41 S3564400
MBACTXCP MVC   IOBSTART,IOBRESTR   SET UP ADDRESS OF 1ST CCW        R41 S3564500
         BAL   ML,MERREXCP         INITIATE CCW PROGRAM             R41 S3564600
         B     MBACTNXT            BRANCH TO SCAN NEXT LINE DCT     R41 S3564700
         EJECT                                                      R41 S3564800
*                                                                   R41 S3564900
*        BSC DISCONNECT INTERVAL SCAN                               R41 S3565000
*                                                                   R41 S3565100
         SPACE 1                                                    R41 S3565200
MBACTDSC DS    0H                                                   R41 S3565300
         TM    MEVNTIND,MEVNDISC   CHECK FOR DISC INTERV EXPIRED    R41 S3565400
         BZ    MBACTNXT            BRANCH IF NO DISC SEARCH REQ     R41 S3565500
         TM    DCTSTAT,DCTDRAIN    ALREADY DRAINING...         @OZ38682 S3565600
         BO    MBACTNXT            YES, DON'T CHECK DISC INTV  @OZ38682 S3565700
         SPACE 2                                                    R41 S3566000
         L     WA,MDCTRAT          GET ADDR OF REMOTES RAT ENTRY    R41 S3566100
         USING RATDSECT,WA         TEMPORARY RAT ADDRESSABILITY     R41 S3566200
         SPACE 1                                                    R41 S3566300
         LA    R1,2                ASSUME 64 SECOND DISC INTERVAL   R41 S3566400
         LTR   WA,WA               IS A REMOTE CONNECTED TO LINE    R41 S3566500
         BZ    MBACTNON            SKIP IF NO REMOTE SIGNED ON      R41 S3566600
         IC    R1,RATDINTV         GET DISCONN INTERVAL FROM RAT    R41 S3566700
         SPACE 1                                                    R41 S3566800
MBACTNON SLA   R1,5                MULTIPLY BY 32 TO GET MINUTES    R41 S3566900
         BZ    MBACTNXT            BRANCH IF INTERVAL IS ZERO       R41 S3567000
         AL    R1,MDCTIMOK         ADD LAST TEXT TRANSMISSION TIME  R41 S3567100
         CL    R1,MCLOCK           COMPARE WITH CURRENT TIME STAMP  R41 S3567200
         BH    MBACTNXT            BRANCH IF INTERVAL NOT EXPIRED   R41 S3567300
         SPACE 1                                                    R41 S3567400
         OI    MDCTSTAT,DCTSOFF    FORCE REMOTE SIGNOFF ACTION      R41 S3567500
         OI    DCTFLAGS,DCTRSTRT   REQUEST LINE RESTART ACTION      R41 S3567600
         SPACE 1                                                    R41 S3567700
         DROP  WA                  RELEASE TEMPORARY RAT BASE       R41 S3567800
         SPACE 2                                                    R41 S3567900
MBACTNXT L     MDCT,MDCTADCT       GET ADDR OF NEXT LINE DCT        R41 S3568000
         LTR   MDCT,MDCT           CHECK FOR END OF CHAIN           R41 S3568100
         BNZ   MDCTSCAN            BRANCH TO PROC LINE IF NOT END   R41 S3568200
         B     MSCANEXT             ELSE DO NEXT SCAN               R41 S3568300
         SPACE 2                                                    R41 S3568400
         DROP  MBASE1,MBASE2,MBASE3  RELEASE ROUTINE AND            R41 S3568500
         DROP  MCODE,MDCT             DATA AREA ADDRESSABILITY      R41 S3568600
         TITLE 'HASP LINE MANAGER -- ACTIVE SNA LOGON DCT SCAN'     R41 S3568700
*********************************************************************** S3568800
*                                                                     * S3568900
*                 ACTIVE SNA LOGON DCT SCAN ROUTINE                   * S3569000
*                                                                     * S3569100
*********************************************************************** S3569200
         SPACE 1                                                    R41 S3569300
*                                  ADDRESSABILITY --                R41 S3569400
         USING DCTDSECT,MDCT            -- LOGON DCT                R41 S3569500
         USING RTAMVSUB,MBASE2,MBASE3   -- COMMON SNA SUBROUTINES   R41 S3569600
         USING MSALGSCN,MBASE1          -- LOCAL ROUTINE BASE       R41 S3569700
         SPACE 2                                                    R41 S3569800
MSALGSCN DS    0H                  SCAN SNA LOGON/LINE DCTS         R41 S3569900
         SPACE 1                                                    R41 S3570000
*                                                                   R41 S3570100
*        $P / $E LOGON COMMAND SCAN ROUTINE                         R41 S3570200
*                                                                   R41 S3570300
         SPACE 1                                                    R41 S3570400
MSLOGCMD MVC   MWORKQUE,MDCTADCT   SAVE ADDR OF NEXT LOGON DCT      R41 S3570500
         L     MICE,MDCTICE        GET ADDR OF 1ST LOGGED ON ICE    R41 S3570600
         LTR   MICE,MICE           CHECK FOR ANY ICE LOGGED ON      R41 S3570700
         USING ICEDSECT,MICE       ESTABLISH ICE ADDRESSABILITY     R41 S3570800
         BNZ   MSLOGRST            BRANCH TO TEST FOR RSTRT IF YES  R41 S3570900
         TM    DCTSTAT,DCTDRAIN    CHECK FOR DRAIN STATUS PENDING   R41 S3571000
         BO    MSLGNDRN            BRANCH TO CLOSE ACB IF DRAINING  R41 S3571100
         TM    DCTFLAGS,DCTRSTRT   CHECK FOR RESTART PENDING        R41 S3571200
         BZ    MSLOGNXT            BRANCH TO SCAN NEXT DCT IF NOT   R41 S3571300
MSLGNDRN BAL   WA,MLOGSTOP         ENTER TERMINATION SUBROUTINE     R41 S3571400
         B     MSLOGNXT            BRANCH TO PROCESS NEXT DCT       R41 S3571500
         SPACE 1                                                    R41 S3571600
MSLOGRST TM    DCTFLAGS,DCTRSTRT   CHECK FOR RESTART PENDING        R41 S3571700
         BZ    MSLOGNXT            BRANCH TO SCAN NEXT DCT IF NOT   R41 S3571800
MSLGKICE MVC   MBUFQUE,ICEAPCHN    SAVE ADDR OF NEXT LOGGED-ON ICE  R41 S3571900
         BAL   ML,MICEABRT         CALL SESSION ABORT SUBROUTINE    R41 S3572000
         L     MICE,MBUFQUE        GET  ADDR OF NEXT LOGGED-ON ICE  R41 S3572100
         LTR   MICE,MICE           TEST FOR END OF CHAIN            R41 S3572200
         BNZ   MSLGKICE            BRANCH TO ABORT ICE IF NOT       R41 S3572300
         SPACE 1                                                    R41 S3572400
         DROP  MICE                RELEASE ICE ADDRESSABILTY        R41 S3572500
         SPACE 2                                                    R41 S3572600
MSLOGNXT L     MDCT,MWORKQUE       GET ADDRESS OF NEXT LOGON DCT    R41 S3572700
         LTR   MDCT,MDCT           CHECK FOR END OF CHAIN           R41 S3572800
         BNZ   MSLOGCMD            PROCESS LOGON DCT IF NOT         R41 S3572900
         B     MSCANEXT             ELSE, DO NEXT SCAN              R41 S3573000
         SPACE 2                                                    R41 S3573100
         DROP  MBASE1,MBASE2,MBASE3  RELEASE ROUTINE AND            R41 S3573200
         DROP  MDCT                   LOGON DCT ADDRESSABILITY      R41 S3573300
         TITLE 'HASP LINE MANAGER -- ACTIVE SNA LINE DCT SCAN'      R41 S3573400
*********************************************************************** S3573500
*                                                                     * S3573600
*                   SNA ACTIVE LINE DCT SCAN ROUTINE                  * S3573700
*                                                                     * S3573800
*********************************************************************** S3573900
         SPACE 1                                                    R41 S3574000
*                                  ADDRESSABILITY --                R41 S3574100
         USING DCTDSECT,MDCT            -- LINE DCT                 R41 S3574200
         USING RTAMVSUB,MBASE2,MBASE3   -- COMMON SNA SUBROUTINES   R41 S3574300
         USING MSLNESCN,MBASE1          -- LOCAL ROUTINE BASE       R41 S3574400
         SPACE 2                                                    R41 S3574500
MSLNESCN DS    0H                  SCAN ALLOCATED SNA LINES         R41 S3574600
         SPACE 1                                                    R41 S3574700
MSLNECMD MVC   MWORKQUE,MDCTADCT   SAVE NEXT ACTIVE LINE DCT ADDR   R41 S3574800
         L     MICE,MDCTICE        GET ADDR OF 1ST ALLOCATED ICE    R41 S3574900
         USING ICEDSECT,MICE       SHOW ICE ADDRESSABLE             R41 S3575000
         SPACE 2                                                    R41 S3575100
*                                                                   R41 S3575200
*        SNA ACTIVE LINE DCT - $E COMMAND AND DISCONNECT INTERVAL   R41 S3575300
*                                         SCAN ROUTINE              R41 S3575400
*                                                                   R41 S3575500
         SPACE 1                                                    R41 S3575600
         TM    DCTFLAGS,DCTRSTRT   CHECK FOR RESTART PENDING        R41 S3575700
         BO    MSLNERST            ABORT ALL ACTIVITY IF YES        R41 S3575800
         TM    MEVNTIND,MEVNDISC   CHECK FOR DISC INTERVAL EXPIRED  R41 S3575900
         BZ    MSLNEJOT            GO TEST IF OUTPUT PRESENT IF NOT R41 S3576000
         SPACE 1                                                    R41 S3576100
         L     R1,MDCTRAT          GET ADDR OF REMOTES RAT ENTRY    R41 S3576200
         SLR   R0,R0                      CLEAR REGISTER AND GET    R41 S3576300
         IC    R0,RATDINTV-RATDSECT(,R1)   REMOTES DISC INTERVAL    R41 S3576400
         SLA   R0,5                MULTIPLY BY 32 TO GET MINUTES    R41 S3576500
         BZ    MSLNEJOT            BRANCH IF DISC CHECK DISABLED    R41 S3576600
         AL    R0,MDCTIMOK         ADD LAST DATASET TRANSMISSION    R41 S3576700
         CL    R0,MCLOCK            TIME AND CHECK AGAINST INTERVAL R41 S3576800
         BH    MSLNEJOT            BRANCH IF INTERVAL NOT EXPIRED   R41 S3576900
         SPACE 2                                                    R41 S3577000
MSLNERST MVC   MBUFQUE,ICEALCHN    SAVE ADDR OF NEXT ALLOCATED ICE  R41 S3577100
         BAL   ML,MICEABRT         CALL SESSION ABORT SUBROUTINE    R41 S3577200
         L     MICE,MBUFQUE        GET  ADDR OF NEXT ALLOCATED ICE  R41 S3577300
         LTR   MICE,MICE           TEST FOR END OF CHAIN            R41 S3577400
         BNZ   MSLNERST            BRANCH TO ABORT ICE IF NOT       R41 S3577500
         B     MSLNENXT            BRANCH TO PROCESS NEXT LINE      R41 S3577600
         EJECT                                                      R41 S3577700
*                                                                   R41 S3577800
*        SNA ACTIVE LINE DCT SCAN - SESSION OUTBOUND ALLOCATION,    R41 S3577900
*            SESSION SUB-SCAN       ACTIVATE RMT DEVICES WHEN WORK  R41 S3578000
*                                   AND SESSION AVAILABLE           R41 S3578100
         SPACE 1                                                    R41 S3578200
MSLNEJOT TM    MEVNTIND,MEVNPJOB   TEST FOR JOB POST EVENT          R41 S3578300
         BZ    MSLNETIM            CHECK FOR TIMER EVENT IF NOT     R41 S3578400
         OI    MDCTATTN,MDCTJOB2   SET OUTPUT POST REQUEST INDIC    R41 S3578500
         SPACE 2                                                    R41 S3578600
*        LOCATE AVAILABLE SESSIONS                                  R41 S3578700
         SPACE 1                                                    R41 S3578800
MSLNETIM TM    MEVNTIND,MEVNTIME   TEST FOR TIMER INTERV EXPIRED    R41 S3578900
         BZ    MSLNENXT            SCAN NEXT LINE DCT IF NOT        R41 S3579000
         OI    MSTQE+IPOST,X'20'   REQUEST NEXT TIMER INTERVAL      R41 S3579100
         SPACE 2                                                    R41 S3579200
         LR    ML,MDCT             LOAD PHONY REMOTE DCT ADDRESS    R41 S3579300
         NI    MDCTATTN,255-MDCTJOB1 RESET ANY SESSION IDLE INDIC   R41 S3579400
         SPACE 1                                                    R41 S3579500
MSLNTWTM TM    ICESTAT,ICETIMER    TEST FOR SESSION WAIT TIME REQ   R41 S3579600
         BZ    MSLNTUSE            BRANCH TO CHECK USAGE IF NOT     R41 S3579700
         SPACE 1                                                    R41 S3579800
         L     R1,ICEWTIME         GET INTERVAL EXPIRATION TIME     R41 S3579900
         CL    R1,MCLOCK           IS WAIT TIME INTERVAL ELAPSED    R41 S3580000
         BH    MSLNTICE            WAIT FOR NEXT TIMER POP IF NOT   R41 S3580100
         NI    ICESTAT,255-ICETIMER  RESET WAIT TIME INDICATOR      R41 S3580200
         SPACE 2                                                    R41 S3580300
MSLNTUSE TM    ICESTAT,ICEAVAIL    CHECK ICE ALLOCATION STATUS      R41 S3580400
         BNZ   MSLNTICE            BRANCH IF ICE NOT AVAILABLE      R41 S3580500
         ICM   R1,7,ICERDCT+1      TEST PREALLOCATION STATUS   @OZ29412 S3580520
         BNZ   MSLNTICE            BRANCH IF PREALLOCATED      @OZ29412 S3580540
         TM    ICEFLAGS,ICEOUTBD+ICEINBRK CHECK SESSION USAGE       R41 S3580600
         BM    MSLNTICE            BRANCH IF ANY PATH IN USE        R41 S3580700
         TM    DCTSTAT,DCTDRAIN    IS DRAIN STATUS PENDING     @OZ38048 S3580710
         BO    MSLNTDRN            BRANCH IF YES               @OZ38048 S3580720
         SPACE 1                                                    R41 S3580800
         TM    MDCTSTAT,DCTSOFF    TEST FOR RMT SIGNING OFF         R41 S3580900
         BZ    MSLNTCHK            NO, KEEP LOOKING FOR WORK        R41 S3581000
MSLNTDRN MVC   MBUFQUE,ICEALCHN    SAVE ADDRESS OF NEXT ICE    @OZ38048 S3581100
         BAL   ML,MICEABRT         AND REMOVE IDLE SESSION          R41 S3581200
         L     MICE,MBUFQUE        RELOAD ADDRESS OF NEXT ICE       R41 S3581300
         B     MSLNNICE            GO PROCESS NEXT ICE              R41 S3581400
         SPACE 1                                                    R41 S3581500
MSLNTCHK TM    MDCTATTN,MDCTJOB2   TEST FOR ANY OUTPUT QUEUED       R41 S3581600
         BZ    MSLNTIDL            SHOW IDLE SESSION IF NOT         R41 S3581700
         EJECT                                                      R41 S3581800
*        SCAN FOR QUEUED OUTPUT -- SESSION AVAILALBLE               R41 S3581900
         SPACE 1                                                    R41 S3582000
         USING DCTDSECT,ML         TEMP REMOTE DCT ADDRESSABILITY   R41 S3582100
MSLNTDCT L     ML,MDCTDCT          GET ADDR OF NEXT REMOTE DCT      R41 S3582200
         LTR   ML,ML               CHECK FOR END OF DCT CHAIN       R41 S3582300
         BZ    MSLNTNOT            BRANCH IF YES                    R41 S3582400
         SPACE 1                                                    R41 S3582500
         TM    MDCTSTAT,DCTPOST    CHECK IF THIS DCT ALREADY POSTED R41 S3582600
         BO    MSLNTDCT            YES, BRANCH TO TRY NEXT DCT      R41 S3582700
         TM    DCTSTAT,DCTDRAIN+DCTINUSE TEST DEVICE AVAILABILITY   R41 S3582800
         BNZ   MSLNTDCT            SCAN NEXT DCT IF NOT AVAILABLE   R41 S3582900
         SPACE 1                                                    R41 S3583000
         CLI   DCTDEVTP,DCTPRPU    TEST FOR OUTPUT OR CNSLE         R41 S3583100
         BL    MSLNTDCT            BRANCH IF NOT, TRY NEXT DEVICE   R41 S3583200
         CLI   DCTDEVTP,DCTRPU     TEST FOR REMOTE PUNCH            R41 S3583300
         BE    MSLNJGET            BRANCH IF YES, GO LOOK FOR WORK  R41 S3583400
         CLI   DCTDEVTP,DCTRCON    IF NOT REMOTE CONSOLE DCT        R41 S3583500
         BNE   MSLNTDC1             GO TEST FOR SEPARATOR PAGE      R41 S3583600
         SPACE 1                                                    R41 S3583700
         L     R15,MDCTICE         IF REMOTE CONSOLE                R41 S3583800
         LTR   R15,R15              NOT PREALLOCATED                R41 S3583900
         BZ    MSLNMSG1              GO TEST FOR MESSAGES           R41 S3584000
         USING ICEDSECT,R15        GET TEMPORARY ICE ADDRESSABILITY R41 S3584100
         TM    ICESNDST,ICEINSTR  ICE PREALLOCATED AND NOT IN  @OZ49163 S3584120
         BNO   MSLNTICE             STREAM, LEAVE ON SUSP QUE  @OZ49163 S3584140
         NI    ICEFLGS2,255-ICEOUTBK  RESET OUTBD-OUTBD INTRP  @OZ29180 S3584200
         MVC   ICESDCT,MDCTSDCT    REMOVE FROM OTHER ICE'S SUSP QUE R41 S3584300
         DROP  R15                 DISCARD TEMP ICE ADDRESSABILITY  R41 S3584400
         SLR   R15,R15             CLEAR POINTERS TO                R41 S3584500
         ST    R15,MDCTICE          PREALLOCATED ICE                R41 S3584600
         ST    R15,MDCTSDCT          AND SUSPEND QUEUE              R41 S3584700
         B     MSLNMSG1            GO SEE IF MESSAGES STILL THERE   R41 S3584800
         SPACE 1                                                    R41 S3584900
MSLNTDC1 TM    DCTPPSW,DCTPPSWS    IF SEPARATOR PAGE SUPPRESSED     R41 S3585000
         BO    MSLNJGET             GO TEST FOR JOB OUTPUT          R41 S3585100
         L     R1,MDCTRAT-DCTDSECT(,MDCT) POINT TO RAT              R41 S3585200
         TM    RATCONF-RATDSECT(R1),RATCONFC  TEST FOR CONSOLE      R41 S3585300
         BO    MSLNJGET            BRANCH IF SUPPORTED              R41 S3585400
         SPACE 1                                                    R41 S3585500
MSLNMSGS SLR   R15,R15                     CLEAR R15           @OZ45379 S3585600
MSLNMSG1 L     R1,MDCTRAT-DCTDSECT(,MDCT)   POINT TO RAT       @OZ45379 S3585700
         IC    R15,RATCONRT+1-RATDSECT(,R1)  MULTIPLY RMT NUM  @OZ45379 S3585710
         LA    R1,0(R15,R15)         BY THREE TO                    R41 S3585800
         ALR   R1,R15                 GET ADDRESS OF                R41 S3585900
         AL    R1,$MSPOOLQ             MSG QUEUE ENTRY              R41 S3586000
         CLC   1(1,R1),0(R1)       CHECK FOR SPOOLED OUTPUT         R41 S3586100
         BNE   MSLNSDEV            YES, BRANCH - START DEVICE       R41 S3586200
         SPACE 1                                                    R41 S3586300
         CLI   DCTDEVTP,DCTRCON    TEST FOR REMOTE CONSOLE          R41 S3586400
         BE    MSLNTDCT            BR IF YES, IGNORE PRINTER WORK   R41 S3586500
         SPACE 1                                                    R41 S3586600
MSLNJGET $#GET DCT=(ML),HAVE=NO    TEST FOR QUEUED OUTPUT           R41 S3586700
         BZ    MSLNTDCT            NO - TRY NEXT REMOTE DCT         R41 S3586800
         EJECT                                                      R41 S3586900
*        IF QUEUED OUTPUT AND AVAILABLE SESSION -- START DEVICE     R41 S3587000
         SPACE 1                                                    R41 S3587100
MSLNSDEV NI    DCTSTAT,255-DCTHOLD MARK DCT AVAILABLE               R41 S3587200
         OI    MDCTSTAT,DCTPOST    SHOW DCT POSTED                  R41 S3587300
         ST    MICE,MDCTICE        SAVE ICE ADDR FOR OPEN           R41 S3587400
         ST    ML,ICERDCT          SAVE PRE-ALLOCATED DCT IN ICE    R41 S3587500
         L     R1,DCTPCE           GET ADDR OF PCE                  R41 S3587600
        $POST  (R1),WORK           POST PCE FOR WORK                R41 S3587700
         B     MSLNTIDL            BRANCH TO INDIC IDLE SESSION     R41 S3587800
         DROP  ML                  DROP REMOTE DCT ADDRESSABILITY   R41 S3587900
         EJECT                                                      R41 S3588000
MSLNTNOT NI    MDCTATTN,255-MDCTJOB2  RESET OUTPUT QUEUED SWITCH    R41 S3588100
         SPACE 1                                                    R41 S3588200
MSLNTIDL OI    MDCTATTN,MDCTJOB1   SET ANY SESSION IDLE INDICATOR   R41 S3588300
         SPACE 1                                                    R41 S3588400
*                                                                   R41 S3588500
*        SNA ACTIVE LINE DCT SCAN  - INTERRUPT OUTBOUND SESSION     R41 S3588600
*        CONSOLE PRE-EMPT SUB-SCAN       FOR CONSOLE OUTPUT         R41 S3588700
*                                                                   R41 S3588800
         SPACE 1                                                    R41 S3588900
MSLNTICE L     MICE,ICEALCHN       GET ADDR OF NEXT ALLOC ICE       R41 S3589000
MSLNNICE LTR   MICE,MICE           CHECK FOR END OF ICE CHAIN       R41 S3589100
         BNZ   MSLNTWTM            BRANCH TO CHECK NEW ICE          R41 S3589200
         SPACE 1                                                    R41 S3589300
         L     ML,MDCTDCT          POINT TO FIRST REMOTE DCT        R41 S3589400
         USING DCTDSECT,ML         TEMPORARY DCT ADDRESSABILITY     R41 S3589500
         CLI   DCTDEVTP,DCTRCON    TEST DEVICE TYPE                 R41 S3589600
         BNE   MSLNENXT            BRANCH IF NO CONSOLE, NEXT LINE  R41 S3589700
         TM    MDCTSTAT,DCTPOST    IF CONSOLE ALREADY POSTED        R41 S3589800
         BO    MSLNENXT             GO TEST NEXT LINE               R41 S3589900
         CL    MICE,MDCTICE        IF CONSOLE ALREADY PREALLOCATED  R41 S3590000
         BNE   MSLNENXT             GO TEST NEXT LINE               R41 S3590100
         SPACE 1                                                    R41 S3590200
         SLR   R15,R15                     CLEAR R15           @OZ45379 S3590300
         L     R1,MDCTRAT-DCTDSECT(,MDCT)   POINT TO RAT       @OZ45379 S3590400
         IC    R15,RATCONRT+1-RATDSECT(,R1)  MULTIPLY RMT NUM  @OZ45379 S3590410
         LA    R1,0(R15,R15)         BY THREE TO                    R41 S3590500
         ALR   R1,R15                 GET ADDRESS OF                R41 S3590600
         AL    R1,$MSPOOLQ             MSG QUEUE ENTRY              R41 S3590700
         CLC   1(1,R1),0(R1)       CHECK FOR SPOOLED OUTPUT         R41 S3590800
         BE    MSLNENXT            IF NONE GO TEST NEXT LINE        R41 S3590900
         DROP  ML                  DISCARD TEMP DCT ADDRESSABILITY  R41 S3591000
         L     MICE,MDCTICE        POINT TO FIRST ICE               R41 S3591100
         L     R1,MDCTRAT          GET RAT ADDRESS             @OZ45379 S3591120
         SLR   R15,R15             CLEAR R15                   @OZ45379 S3591140
         IC    R15,RATCONRT+1-RATDSECT(,R1) GET CON RMT NUM    @OZ45379 S3591160
         BCTR  R15,0               LESS 1 FOR OFFSET           @OZ45379 S3591180
         MH    R15,=Y(RATTLE)      CALCULATE RAT DISPLACEMENT  @OZ45379 S3591200
         A     R15,$RATABLE        GET ADDR OF RAT ENTRY       @OZ45379 S3591220
         CLR   R15,R1              IF CONSOLE AND PRINTER NOT  @OZ45379 S3591240
         BNE   MSLNENXT             SAME RMT, TEST NEXT LINE   @OZ45379 S3591260
         SPACE 1                                               @OZ45379 S3591280
MSLNTIC1 TM    ICESTAT,ICEAVAIL-ICEALLOC  IF ICE NOT AVAILABLE      R41 S3591300
         BNZ   MSLNICE                     GO TEST NEXT ICE         R41 S3591400
         TM    ICEFLAGS,ICEOUTBD   IF ICE NOT ALLOCATED OUTBOUND    R41 S3591500
         BNO   MSLNICE              GO TEST NEXT ICE                R41 S3591600
         USING DCTDSECT,ML         RE-APPLY TEMP DCT ADDRESSABILITY R41 S3591700
         ST    MICE,MDCTICE        SAVE ICE ADDRESS FOR OPEN        R41 S3591800
         MVC   MDCTSDCT,ICESDCT    PLACE CONSOLE DCT ON             R41 S3591900
         ST    ML,ICESDCT           FRONT OF SUSPEND QUEUE          R41 S3592000
         OI    ICEFLGS2,ICEOUTBK   FLAG OUTBD-OUTBD INTERRUPT  @OZ29180 S3592100
         DROP  ML                  DISCARD TEMP DCT ADDRESSABILITY  R41 S3592200
         B     MSLNENXT            GO TEST NEXT LINE                R41 S3592300
         SPACE 1                                                    R41 S3592400
MSLNICE  L     MICE,ICEALCHN       GET NEXT ICE ADDRESS             R41 S3592500
         LTR   MICE,MICE           TEST FOR END OF CHAIN            R41 S3592600
         BNZ   MSLNTIC1            BRANCH IF NOT                    R41 S3592700
         DROP  MICE                RELEASE ICE ADDRESSABILITY       R41 S3592800
         SPACE 1                                                    R41 S3592900
MSLNENXT L     MDCT,MWORKQUE       GET ADDR OF NEXT LINE DCT        R41 S3593000
         LTR   MDCT,MDCT           CHECK FOR END OF CHAIN           R41 S3593100
         BNZ   MSLNECMD            PROCESS LINE DCT IF NOT          R41 S3593200
         B     MSCANEXT             ELESE GO DO NEXT SCAN           R41 S3593300
         SPACE 2                                                    R41 S3593400
         DROP  MBASE1,MBASE2,MBASE3  RELEASE ROUTINE                R41 S3593500
         DROP  MDCT                   AND DCT ADDRESSABILITY        R41 S3593600
         TITLE 'HASP LINE MANAGER -- IDLE SNA LINE DCT SCAN'        R41 S3593700
*********************************************************************** S3593800
*                                                                     * S3593900
*                       SNA IDLE LINE DCT SCAN                        * S3594000
*                                                                     * S3594100
*********************************************************************** S3594200
         SPACE 1                                                    R41 S3594300
*                                  ADDRESSABILITY --                R41 S3594400
         USING DCTDSECT,MDCT            -- LINE DCT                 R41 S3594500
         USING RTAMVSUB,MBASE2,MBASE3   -- COMMON SNA SUBROUTINES   R41 S3594600
         USING MSIDLSCN,MBASE1          -- LOCAL ROUTINE BASE       R41 S3594700
         SPACE 2                                                    R41 S3594800
MSIDLSCN DS    0H                  SCAN IDLE SNA LINE DCTS          R41 S3594900
         SPACE 2                                                    R41 S3595000
*                                                                   R41 S3595100
*        CHECK FOR $P LNE COMMAND                                   R41 S3595200
*                                                                   R41 S3595300
         SPACE 1                                                    R41 S3595400
MSIDLCMD MVC   MWORKQUE,MDCTADCT   SAVE NEXT IDLE LINE DCT ADDR     R41 S3595500
         TM    DCTSTAT,DCTDRAIN    CHECK FOR DRAIN STATUS PENDING   R41 S3595600
         BZ    MSIDLNDR            SKIP IF NO DRAIN REQ OUTSTANDING R41 S3595700
         BAL   WA,MSNASTOP         ENTER TERMINATION SUBROUTINE     R41 S3595800
         SPACE 1                                                    R41 S3595900
MSIDLNDR L     MDCT,MWORKQUE       GET ADDR OF NEXT IDLE LINE       R41 S3596000
         LTR   MDCT,MDCT           CHECK FOR END OF CHAIN           R41 S3596100
         BNZ   MSIDLCMD            PROCESS LINE DCT IF NOT          R41 S3596200
         B     MSCANEXT             ELSE, GO DO NEXT SCAN           R41 S3596300
         SPACE 2                                                    R41 S3596400
         DROP  MBASE1,MBASE2,MBASE3  RELEASE ROUTINE AND            R41 S3596500
         DROP  MDCT                     DCT ADDRESSABILITY          R41 S3596600
         TITLE 'HASP LINE MANAGER -- INACTIVE DCT SCAN'             R41 S3596700
*********************************************************************** S3597100
*                                                                     * S3597200
*             INACTIVE DCT (BSC/SNA - LNE/LGN) SCAN                   * S3597300
*                                                                     * S3597400
*                      ($S COMMAND PROCESSING)                        * S3597500
*                                                                     * S3597600
*********************************************************************** S3597700
         SPACE 1                                                    R41 S3597800
*                                  ADDRESSABILITY --                R41 S3597900
         USING RTAMBSUB,MBASE2,MBASE3    -- COMMON BSC SUBROUTINES  R41 S3598000
         USING MUNITSCN,MBASE1           -- LOCAL ROUTINE BASE      R41 S3598100
         SPACE 2                                                    R41 S3598200
MUNITSCN DS    0H                                                   R41 S3598300
         SPACE 2                                                    R41 S3598400
*                                                                   R41 S3598500
*        SCAN FOR STARTED LOGON DCTS                                R41 S3598600
*                                                                   R41 S3598700
         SPACE 1                                                    R41 S3598800
         L     MDCT,$LOGNDCT       GET ADDR OF FIRST LOGON DCT      R41 S3598900
         USING DCTDSECT,MDCT        AND SHOW ADDRESSABLE            R41 S3599000
         LTR   MDCT,MDCT           CHECK FOR ANY LOGON DCT THERE    R41 S3599100
         BZ    MUNITNLG            BRANCH IF NOT GENERATED           R4 S3599500
         SPACE 1                                                     R4 S3600000
MUNITLOG BAL   WA,MLDCTGET         TRY TO GET AND INIT LOGON DCT     R4 S3600500
         L     MDCT,DCTCHAIN       GET ADDRESS OF NEXT LOGON DCT     R4 S3601000
         LA    MDCT,0(,MDCT)       PURIFY DCT ADDRESS               R41 S3601100
         LTR   MDCT,MDCT           CHECK FOR END OF DCT CHAIN        R4 S3601500
         BZ    MUNITNLG            BRANCH IF NO MORE LOGON DCTS      R4 S3602000
         CLI   DCTDEVTP,DCTLOG     IS THIS STILL A LOGON DCT         R4 S3602500
         BE    MUNITLOG            BRANCH TO GET DCT IF YES          R4 S3603000
         SPACE 2                                                     R4 S3603500
*                                                                   R41 S3604100
*        SCAN FOR STARTED LINE DCTS                                 R41 S3604200
*                                                                   R41 S3604300
         SPACE 1                                                    R41 S3604400
MUNITNLG L     MDCT,$LNEDCT        GET ADDRESS OF FIRST LINE DCT    R41 S3604500
MUNITLNE BAL   WA,MLDCTGET         TRY TO GET AND INIT LINE DCT     R41 S3604600
         L     MDCT,DCTCHAIN       GET ADDRESS OF NEXT DCT           R4 S3605000
         LA    MDCT,0(,MDCT)       PURIFY DCT ADDRESS               R41 S3605100
         LTR   MDCT,MDCT           CHECK FOR END OF DCT CHAIN       R41 S3605600
         BZ    MSCANEXT            BRANCH IF YES, GO DO NEXT SCAN   R41 S3605700
         CLI   DCTDEVTP,DCTLNE     IS THIS STILL A LINE DCT         R41 S3605800
         BE    MUNITLNE            BRANCH TO GET LINE DCT IF YES    R41 S3605900
         SPACE 2                                                     R4 S3607500
         B     MSCANEXT            ELSE, GO DO NEXT SCAN            R41 S3608000
         SPACE 1                                                    R41 S3618500
         DROP  MBASE1,MBASE2,MBASE3  RELEASE CODE ADDRESSABILITY    R41 S3628500
         TITLE 'HASP LINE MANAGER -- LOGON DCT EXIT AND ACB SUBTASK COMCS3698500
               PLETION SCAN'                                        R41 S3699000
*********************************************************************** S3699100
*                                                                     * S3699200
*        LOGON DCT EXIT SERVICE AND ACB SUBTASK COMPLETION SCAN       * S3699300
*                                                                     * S3699400
*********************************************************************** S3699500
         SPACE 1                                                    R41 S3699600
*                                  ADDRESSABILITY -                 R41 S3699700
         USING DCTDSECT,MDCT             LOGON DCT                  R41 S3699800
         USING RTAMVSUB,MBASE2,MBASE3    COMMON SNA SUBROUTINES     R41 S3699900
         USING MLOGPROC,MBASE1           LOCAL ROUTINE BASE         R41 S3700000
         SPACE 2                                                    R41 S3700100
MLOGPROC DS    0H                                                   R41 S3700200
         SLR   R0,R0               GET ZERO FOR CLEARING            R41 S3700300
MLOGPDEQ CS    MDCT,R0,MLOGQUE     ATTEMPT TO ACQUIRE               R41 S3700400
         BNE   MLOGPDEQ            BR IF NO, RETRY                  R41 S3700500
         ST    MDCT,MWORKQUE        ELSE, STORE IN WORK QUEUE PTR   R41 S3700600
MLOGNEXT L     MDCT,MWORKQUE       GET ADDR OF NEXT QUEUED DCT      R41 S3700700
         LTR   MDCT,MDCT           CHECK FOR ANY LOGON DCT THERE    R41 S3700800
         BZ    MSCANEXT            BRANCH IF END OF CHAIN           R41 S3700900
         USING DCTDSECT,MDCT       PICK UP DCT ADDRESSABILITY       R41 S3701000
         SLR   R0,R0               GET ZERO VALUE FOR RESET         R41 S3701100
         SPACE 1                                                     R4 S3701500
         NI    MFLAGS,255-MLOGGED  CLEAR MESSAGE-LOGGED FLAG        R41 S3702000
         L     R15,MDCTEXIT        GET EXIT CODE AND NEXT DCT ADDR   R4 S3702500
MLOGPDXT CS    R15,R0,MDCTEXIT     ATTEMPT TO RESET DCT CHAIN FIELD R41 S3703000
         BNE   MLOGPDXT            RETRY IF UNSUCCESSFUL            R41 S3703500
         LR    R14,R0              CLEAR R14 FOR EXIT CODE           R4 S3704000
         SLDL  R14,8               ISOLATE EXIT ROUTINE CODE         R4 S3704500
         SRL   R15,8               GET ADDR OF NEXT CHAINED DCT      R4 S3705000
         ST    R15,MWORKQUE        SAVE DCT ADDR ON WORK QUEUE       R4 S3705500
         LA    R15,X'F0'           GET MASK AND ISOLATE EXIT         R4 S3706000
         NR    R15,R14              ROUTINE IDENTIFIER CODE          R4 S3706500
         XR    R14,R15             GET EXIT ROUTINE COMPL CODE       R4 S3707000
         SLL   R14,2               ADJUST RET CODE FOR TABLE SCAN    R4 S3707500
         SRL   R15,2               ADJUST EXIT ID  FOR TABLE SCAN    R4 S3708000
         L     ML,MLOGBTAB-4(R15)  GET APPROPRIATE TABLE ENTRY       R4 S3708500
         TM    DCTFLAGS,DCTLOGAL   TEST FOR DIAGNOSTIC LOGGING       R4 S3709000
         BZR   ML                  SKIP IF LOGGING NOT REQUESTED     R4 S3709500
         B     MAPIEMSG            ELSE LOG APPL-RELATED ACTION      R4 S3710000
         SPACE 1                                                     R4 S3710500
MLOGBTAB DS    0F                  EXIT ROUTINE BRANCH TABLE         R4 S3711000
         DC    A(MLOGOPEN)         OPEN  ACB  SUBTASK EVENT          R4 S3711500
         DC    A(MLOGTPND)         TPEND EXIT ROUTINE EVENT          R4 S3712000
         DC    A(MLOGCLOS)         CLOSE ACB  SUBTASK EVENT          R4 S3712500
         EJECT                                                      R41 S3713000
*                                                                   R41 S3713100
*        OPEN ACB COMPLETION AND ERROR RECOVERY ROUTINE             R41 S3713200
*                                                                   R41 S3713300
         SPACE 1                                                    R41 S3713400
MLOGOPEN DS    0H                  OPEN ACB SUBTASK COMPLETE EVENT  R41 S3713500
         L     MBUF,DCTBUFAD       GET ADDR OF SETLOGON RPL          R4 S3714000
         ST    R0,DCTBUFAD         INDICATE NO ACTIVE BUFFER         R4 S3714500
         TM    MDCTSTAT,DCTABORT   CHECK FOR ANY ERROR IN SUBTASK    R4 S3715000
         BZ    MLOGOPOK            BRANCH IF SUCCESSFUL COMPLETION   R4 S3715500
         SPACE 2                                               @OZ18395 S3715600
         OI    DCTSTAT,DCTDRAIN    SET LOGON DCT DRAIN STATUS  @OZ18395 S3715700
         SPACE 1                                                     R4 S3716000
         TM    MDCTSTAT,DCTSINON   TEST IF ACB HAS BEEN OPENED       R4 S3716500
         BZ    MLOGOPER            BRANCH IF OPEN ACB FAILED         R4 S3717000
         SPACE 2                                               @OZ18395 S3717100
        $IOERROR (MBUF)            ISSUE I/O ERROR MESSAGE           R4 S3717500
         OI    MDCTSTAT,DCTSOFF    INDICATE CLOSE ACB REQUEST  @OZ18395 S3717600
         BAL   WA,MLOGPOST         CLOSE ACB                   @OZ18395 S3717700
         B     MLOGOFRE             AND RELEASE BUFFER         @OZ18395 S3718000
         SPACE 2                                               @OZ18395 S3718100
MLOGOPER BAL   ML,MAPIEMSG         ISSUE OPEN ACB FAILED MSG         R4 S3718500
*              THIS LINE DELETED BY APAR NUMBER                @OZ18395 S3719000
         BAL   WA,MLDCTFRE         DISPOSE OF LOGON DCT              R4 S3719500
         B     MLOGOFRE            BRANCH TO FREE BUFFER             R4 S3720000
         SPACE 1                                                     R4 S3720500
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3721000
MLOGOPOK L     R1,MSNALOG          GET ACTIVE LOGON DCT PTR    @OZ27491 S3721500
         ST    R1,MDCTADCT         CHAIN ACTIVE LOGON DCTS TO OURS   R4 S3722000
         ST    MDCT,MSNALOG        UPDATE LINE MANAGER DCT POINTER   R4 S3722500
         OI    MSCANIND,MSCNRAT    FORCE RAT AUTOLOGON SCAN         R41 S3722600
         SPACE 1                                                     R4 S3723000
MLOGOFRE DS    0H                  FREE SETLOGON START BUFFER        R4 S3723500
        $FREEBUF (MBUF)            RETURN BUFFER TO FREE POOL        R4 S3724000
         B     MLOGNEXT            GO SEARCH FOR MORE WORK           R4 S3724500
         EJECT                                                       R4 S3725000
*                                                                   R41 S3725600
*        TPEND PORCESSING ROUTINE                                   R41 S3725700
*                                                                   R41 S3725800
         SPACE 1                                                     R4 S3726500
MLOGTPND DS    0H                  TPEND EXIT SCHEDULED EVENT        R4 S3727000
         SRL   R14,2               ADJUST RET CODE FOR BRANCH  @OZ38908 S3727500
         LA    R1,2                CHECK FOR VTAM              @OZ46552 S3727550
         CLR   R14,R1               INITIATED ABEND            @OZ46552 S3727600
         BNE   MLOGNABD            NO, CHECK ACTIVE SESSIONS   @OZ46552 S3727650
         OI    MDCTSTAT,DCTABORT   SHOW APPL ABORTING          @OZ46552 S3727700
MLOGNABD OI    DCTSTAT,DCTDRAIN    SHOW APPL DRAINING          @OZ46552 S3727750
         L     MICE,MDCTICE        GET ADDR OF 1ST  LOGGED-ON ICE    R4 S3728000
         LTR   MICE,MICE           TEST IF ANY SESSIONS              R4 S3728500
         LA    WA,MLOGNEXT         LOAD RETURN FOR ACB CLOSE ROUT    R4 S3729000
         BZ    MLOGSTOP            GO CLOSE ACB IF NO SESSIONS       R4 S3729500
         USING ICEDSECT,MICE       SHOW ICE ADDRESSABILITY          R41 S3729600
*                                  THIS LINE DELETED BY APAR   @OZ46552 S3730000
         LA    R1,MLOGTLIM         GET HIGHEST ALLOWED RETURN CODE   R4 S3730500
         CLR   R14,R1              COMPARE RETURN CODE WITH LIMIT    R4 S3731000
         BNL   MLOGTRAP            ABORT IF INVALID RET CODE   @OZ38908 S3731500
         IC    R1,MLOGTTAB(R14)    PICK UP RETURN CODE ENTRY         R4 S3732000
         B     MLOGT(R1)            AND BRANCH TO PROC ROUTINE       R4 S3732500
         SPACE 1                                                     R4 S3733000
MLOGTTAB DS    0C                  TPEND EXIT ERROR ACTION TABLE     R4 S3733500
         DC    AL1(MLOGTDRN-MLOGT) ORDERLY SHUTDOWN   REQ  -DRAIN    R4 S3734000
         DC    AL1(MLOGTRAP-MLOGT) QUICK   SHUTDOWN   REQ  -TERMIN   R4 S3734500
         DC    AL1(MLOGTRAP-MLOGT) VTAM INIT ABEND             @OZ46552 S3735000
MLOGTLIM EQU   *-MLOGTTAB          HIGHEST ALLOWED ERROR CODE        R4 S3735500
         SPACE 2                                                     R4 S3736000
MLOGT    DS    0H                  ORIGIN FOR TPEND PROC ROUTINES    R4 S3736500
         SPACE 2                                                    R41 S3736600
*        DRAIN ALL APPLICATION SESSIONS                             R41 S3736700
         SPACE 1                                                     R4 S3737000
MLOGTDRN MVC   MBUFQUE,ICEAPCHN    SAVE ADDR OF NEXT LOGGED-ON ICE   R4 S3737500
         BAL   ML,MICETRAP         MARK ICE DRAINING, CLOSE IF IDLE  R4 S3738000
         L     MICE,MBUFQUE        RESTORE NEXT ICE ADDRESS          R4 S3738500
         LTR   MICE,MICE           CHECK FOR END OF CHAIN            R4 S3739000
         BNZ   MLOGTDRN            PROCESS THIS ICE IF NOT           R4 S3739500
         B     MLOGNEXT            GO SEARCH FOR MORE WORK           R4 S3740000
         SPACE 2                                                    R41 S3740100
*        ABORT ALL APPLICATION SESSIONS                             R41 S3740200
         SPACE 1                                                     R4 S3740500
*                                  THIS LINE DELETED BY APAR   @OZ46552 S3741000
         SPACE 1                                                     R4 S3741500
MLOGTRAP MVC   MBUFQUE,ICEAPCHN    SAVE ADDR OF NEXT LOGGED-ON ICE   R4 S3742000
         BAL   ML,MICEABRT         CALL SESSION ABORT SUBROUTINE     R4 S3742500
         L     MICE,MBUFQUE        GET  ADDR OF NEXT LOGGED-ON ICE   R4 S3743000
         LTR   MICE,MICE           TEST FOR END OF CHAIN             R4 S3743500
         BNZ   MLOGTRAP            GO PROCESS NEXT ICE IF NOT        R4 S3744000
         B     MLOGNEXT            SEARCH FOR MORE WORK              R4 S3744500
         SPACE 2                                                     R4 S3745000
         DROP  MICE                DROP ICE ADDRESSABILITY          R41 S3745500
         EJECT                                                       R4 S3746000
*                                                                   R41 S3746100
*        ACB CLOSE COMPLETION PROCESSING ROUTINE                    R41 S3746200
*                                                                   R41 S3746300
         SPACE 1                                                    R41 S3746400
MLOGCLOS DS    0H                  CLOSE ACB SUBTASK COMPLETE EVENT R41 S3746500
         TM    MDCTSTAT,DCTABORT   HAS CLOSE ACB BEEN SUCCESSFUL     R4 S3747000
         BZ    MLOGCLER            BRANCH IF NO ERRORS INDICATED    R41 S3747500
         BAL   ML,MAPIEMSG         ISSUE CLOSE ACB FAILED MSG        R4 S3748000
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S3748500
MLOGCLER TM    DCTSTAT,DCTDRAIN    CHECK DCT DRAIN STATUS      @OZ27491 S3749000
         LA    WA,MLOGNEXT         LOAD RETURN FOR ACB OPEN ROUTINE  R4 S3749500
         BZ    MLOGSTRT            RESTART LOGON DCT IF NO DRAIN     R4 S3750000
         B     MLDCTFRE            ELSE BRANCH TO FREE LOGON DCT     R4 S3750500
         EJECT                                                      R41 S3751000
*                                                                   R41 S3751100
*        VTAM INTERFACE (API) ERROR MESSAGE SUBROUTINE              R41 S3751200
*                                                                   R41 S3751300
         SPACE 1                                                    R41 S3751400
MAPIEMSG DS    0H                  ISSUE JES2/VTAM API ERROR MSG    R41 S3751500
         TM    MFLAGS,MLOGGED      TEST CONTROL-BLOCK HANDLING FLAGS R4 S3752000
         BOR   ML                  RETURN IF EVENT ALREADY LOGGED    R4 S3752500
         L     R1,$MWORK           GET MESSAGE WORKAREA ADDRESS      R4 S3753000
         MVC   0(L'MAPIMSG,R1),MAPIMSG  MOVE MSG TARGET TO WORKAREA  R4 S3753500
         USING MAPIMSG,R1          PROVIDE MSG ADDRESSABILITY        R4 S3754000
         STC   R14,MAPIWORK        SAVE RETURN CODE IN MSG           R4 S3754500
         MVC   MAPINAME,DCTDEVN    MOVE LOGON DCT NAME TO MSG        R4 S3755000
         UNPK  MAPISTAT(3),MAPIWORK(2)   SET UP RETURN  CODE INFO    R4 S3755500
         UNPK  MAPISTAT+2(3),MDCTXERR(2) SET UP ACB FEEDBACK INFO    R4 S3756000
         TR    MAPISTAT,$HEXTRAN         TRANSLATE INFO TO EBCDIC    R4 S3756500
         LA    R15,MAPIRTAB-4(R15) POINT TO REQUEST ENTRY            R4 S3757000
         MVC   MAPIREQC,0(R15)     MOVE REQUEST ID TO MSG            R4 S3757500
         LR    WA,R14              SAVE R14 AROUND $WTO              R4 S3758000
        $WTO   (R1),L'MAPIMSG,JOB=NO,WAIT=NO,  ISSUE ERROR MESSAGE     CS3758500
               ROUTE=$LOG+$ERR+$TP,CLASS=$ALWAYS,PRI=$HI             R4 S3759000
         OI    MFLAGS,MLOGGED      SHOW MESSAGE HAS BEEN LOGGED      R4 S3759500
         LR    R14,WA              RESTORE R14 INDEX VALUE           R4 S3760000
         BR    ML                  RETURN TO CALLER                  R4 S3760500
         DROP  R1                  RELEASE MSG ADDRESSABILITY        R4 S3761000
         SPACE 1                                                     R4 S3761500
MAPIRTAB DC    C'OPEN',C'TPND',C'CLOS'  REQUEST TYPE TABLE           R4 S3762000
*              THIS LINE DELETED BY APAR NUMBER              * @OZ32566 S3762500
*              THIS LINE DELETED BY APAR NUMBER              * @OZ32566 S3763000
         SPACE 1                                                     R4 S3763500
MAPIMSG $MSG   092,'API ERROR ON LOGONXXX ACB,RRRR,VTAM,SSSS'        R4 S3764000
MAPINAME EQU   MAPIMSG+15,8        LOGON DCT NAME                    R4 S3764500
MAPIREQC EQU   MAPIMSG+28,4        REQUEST IDENTIFIER                R4 S3765000
MAPIWORK EQU   MAPIMSG+30,1        WORK FIELD FOR UNPK               R4 S3765500
MAPISTAT EQU   MAPIMSG+38,8        STATUS INFORMATION                R4 S3766000
         SPACE 2                                                    R41 S3766100
         DROP  MBASE1,MBASE2,MBASE3   RELEASE ROUTINES              R41 S3766200
         DROP  MDCT                     AND DCT ADDRESSABILITY      R41 S3766300
         TITLE 'HASP LINE MANAGER -- ICE EXIT ROUTINE PROCESSING SCAN'  S3766500
*********************************************************************** S3767100
*                                                                     * S3767200
*                 ICE EXIT ROUTINE PROCESSING SCAN                    * S3767300
*                                                                     * S3767400
*********************************************************************** S3767500
         SPACE 1                                                     R4 S3768500
*                                  ADDRESSABILITY -                 R41 S3769100
         USING ICEDSECT,MICE             ICE                        R41 S3769200
         USING RTAMVSUB,MBASE2,MBASE3    COMMON SNA SUBROUTINES     R41 S3769300
         USING MICEPROC,MBASE1           LOCAL ROUTINE BASE         R41 S3769400
         SPACE 2                                                    R41 S3769500
MICEPROC DS    0H                                                   R41 S3769600
         SLR   R0,R0               GET EMPTY QUEUE INDICATOR        R41 S3769700
MICEPROQ CS    MICE,R0,MICEQUE     ATTEMPT TO CLEAR QUEUE           R41 S3769800
         BNE   MICEPROQ            RETRY IF UNSUCCESSFUL            R41 S3769900
         SPACE 1                                                    R41 S3770000
         ST    MICE,MWORKQUE                                        R41 S3770100
MICENEXT L     MICE,MWORKQUE       GET ADDR OF NEXT QUEUED ICE      R41 S3770200
         LTR   MICE,MICE           CHECK FOR ANY MORE ICE           R41 S3770300
         BZ    MSCANEXT            BRANCH IF END OF CHAIN           R41 S3770400
         SLR   R0,R0               GET ZERO VALUE FOR RESET         R41 S3770500
         SPACE 1                                                    R41 S3770600
         L     R15,ICEXTCHN        GET EXIT CODE AND NEXT ICE ADDR   R4 S3772000
MICEPDEX CS    R15,R0,ICEXTCHN     ATTEMPT TO RESET ICE CHAIN FIELD R41 S3772500
         BNE   MICEPDEX            RETRY IF UNSUCCESSFUL            R41 S3773000
         LR    R14,R0              CLEAR R14 FOR EXIT CODE           R4 S3773500
         SLDL  R14,8               ISOLATE EXIT ROUTINE CODE         R4 S3774000
         SRL   R15,8               GET ADDR OF NEXT CHAINED ICE      R4 S3774500
         STC   R14,MCOMMAND        SAVE ACTION CODE FOR REQUEUE      R4 S3775000
         ST    R15,MWORKQUE        SAVE ICE ADDR ON WORK QUEUE       R4 S3775500
         LA    R15,X'F0'           GET MASK AND ISOLATE EXIT         R4 S3776000
         NR    R15,R14              ROUTINE IDENTIFIER CODE          R4 S3776500
         XR    R14,R15             GET EXIT ROUTINE COMPL CODE       R4 S3777000
         SRL   R15,2               ADJUST EXIT ID  FOR TABLE SCAN   R41 S3777500
         L     MDCT,ICEADCT        SET UP LOGON DCT ADDRESS          R4 S3778000
         USING DCTDSECT,MDCT       SHOW LOGON DCT ADDRESSABLE       R41 S3778100
         SLR   MBUF,MBUF           INDICATE NO CURRENT BUFFER        R4 S3778500
         LA    ML,MICENEXT         SET UP COMMON RETURN ADDRESS      R4 S3779000
         L     R1,MICEBTAB-4(R15)  GET APPROPRIATE TABLE ENTRY      R41 S3779500
         BR    R1                  BRANCH TO PROCESSING ROUTINE     R41 S3780000
         SPACE 3                                                    R41 S3794500
MICEBTAB DS    0F                  EXIT ROUTINE BRANCH TABLE        R41 S3795000
         DC    A(MICELOGN)         LOGON  EXIT SCHEDULED EVENT      R41 S3795500
         DC    A(MICELOGN)         SIMULATED LOGON (AUTOLOGON)      R41 S3795600
         DC    A(MICEGBUF)         DEFERRED BUFFER GET ATTEMPT      R41 S3796000
         DC    A(MICETRAP)         RELREQ EXIT SCHEDULED EVENT      R41 S3796500
         DC    A(MICEABRT)         SCIP   EXIT SCHEDULED EVENT      R41 S3797000
         DC    A(MICELOST)         LSTTRM EXIT SCHEDULED EVENT      R41 S3797500
         DC    A(MICETHAW)         DISCONNECT  ROUTINE              R41 S3798000
         EJECT                                                      R41 S3798500
*                                                                   R41 S3800000
*        LOGON EXIT PROCESSING                                      R41 S3800100
*                                                                   R41 S3800200
         SPACE 1                                                    R41 S3800300
MICELOGN DS    0H                  LOGON EXIT SCHEDULED EVENT       R41 S3800400
        $GETBUF TYPE=VTAM          ACQUIRE AND INIT VTAM BUFFER     R41 S3800500
         BZ    MICEREQU            REQUEUE THIS REQUEST IF FAILED   R41 S3800600
         USING RPLDSECT,MBUF       SHOW RPL ADDRESSABILITY          R41 S3800700
         LR    MBUF,R1             PROVIDE BUFFER ADDRESSABILITY    R41 S3800800
         ST    MBUF,ICEBUFAD       SAVE BUFFER ADDRESS IN ICE       R41 S3800900
         SPACE 1                                                    R41 S3801000
         LA    R15,RPLBUFST        POINT TO NIB AREA                R41 S3801100
         USING NIBDSECT,R15        ESTABLISH NIB ADDRESSABILITY     R41 S3801200
         XC    NIBDSECT(NIBSIZE),NIBDSECT CLEAR NIB AREA            R41 S3801300
         SPACE 1                                                    R41 S3801400
         OI    ICESTAT,ICEHOLD     ICE NOT ELIGIBLE FOR ALLOC       R41 S3801500
         MVI   ICEINDEX,VSEQLOGN+VSEQLDEV SET ICE LOGON STATUS      R41 S3801600
         ST    MICE,RPLICE         SAVE ICE ADDR IN BUFFER          R41 S3801700
         STCM  MDCT,7,RPLDCT+1     SAVE DCT ADDR IN BUFFER          R41 S3801800
         MVC   RPLDACB,DCTACB      MOVE ACB ADDRESS TO RPL          R41 S3801900
         MVI   RPLREQ,RPLINQIR     SHOW INQUIRE REQUEST TYPE        R41 S3802000
         MVI   RPLOPT8,RPLODACP    SHOW OPNDST WILL BE ACCEPT       R41 S3802100
         MVI   RPLOPT9,RPLDEVCH    SHOW INQUIRE DEVCHAR REQ         R41 S3802200
         LA    R0,L'ISTDVCHR       GET REQUESTED DATA LENGTH        R41 S3802300
         ST    R0,RPLBUFL           AND STORE IN RPL FOR INQUIRE    R41 S3802400
         SPACE 1                                                    R41 S3802500
         MVI   NIBID,NIBIDD        INIT NIB IDENT  FIELD            R41 S3802600
         MVI   NIBLEN,NIBLNIB      INIT NIB LENGTH FIELD            R41 S3802700
         ST    MICE,NIBUSER        INIT NIB USER   FIELD            R41 S3802800
         MVC   NIBSYM,ICESYMB      SHOW TERMINAL NAME IN NIB        R41 S3802900
         MVC   NIBMODE,=CL8'RECORD' INDIC RECORD MODE IN NIB        R41 S3803000
         MVI   NIBPROCD,PRORPLC    SHOW RPLC PROC OPT IN NIB        R41 S3803100
         ST    R15,RPLARG          STORE NIB ADDRESS  IN RPL        R41 S3803200
         MVI   RPLEXTDS,RPLNIB     SHOW RPLARG POINTS TO NIB        R41 S3803300
         LA    R1,NIBDEVCH         GET ADDR OF NIBDEVCH FIELD       R41 S3803400
         ST    R1,RPLAREA           AND STORE IN RPL FOR INQUIRE    R41 S3803500
         SPACE 1                                                    R41 S3803600
         CLI   MCOMMAND,VXIDALOG   TEST FOR SIMULATED LOGON         R41 S3803700
         BNE   MICELOG             BRANCH IF NOT                    R41 S3803800
         L     R1,ICELDCT          PICK UP PRE-ALLOCATED LINE DCT   R41 S3803900
         LTR   R1,R1               TEST LINE DCT ADDRESS            R41 S3804000
         BNZ   MICELGN1            LINE AVAILABLE, CONTINUE    @OZ47992 S3804100
         MVI   ICEINDEX,X'00'      ZERO SPEC SEQ FOR MICECLOS  @OZ47992 S3804120
         B     MICEABDN            ABANDON OPNDST ATTEMPT      @OZ47992 S3804140
MICELGN1 DS    0H                                              @OZ47992 S3804160
         L     R1,MDCTRAT-DCTDSECT(,R1)  LOCATE LOGON RAT ENTRY     R41 S3804200
         ST    R1,NIBRAT           STORE RAT ADDRESS IN NIB         R41 S3804300
         SPACE 1                                                    R41 S3804400
         MVI   ICEINDEX,VSEQALOG+VSEQLDEV  SET ICE AUTOLOG STATUS   R41 S3804500
         MVI   RPLOPT8,RPLODACQ    SHOW OPNDST WILL BE ACQUIRE      R41 S3804600
         MVI   NIBLMODE,C' '        AND SET TO USE...               R41 S3804700
         MVC   NIBLMODE+1(L'NIBLMODE-1),NIBLMODE ..DEFAULT LOGMODE  R41 S3804800
         MVC   RPLSEQTP,ICEINDEX   SET RPL SPECIAL SEQUENCE TYPE    R41 S3804900
         B     MVRPLXEC            PASS REQUEST TO VTAM AND RETURN  R41 S3805000
         EJECT                                                      R41 S3805100
MICELOG  L     R1,MDCTICE          GET LOGGED  ON ICE CHAIN         R41 S3805200
         ST    R1,ICEAPCHN         CONNECT ICE TO OLD CHAIN         R41 S3805300
         ST    MICE,MDCTICE         AND STORE NEW ICE CHAIN         R41 S3805400
         LH    R1,MDCTSNCT         GET LOGGED  ON ICE COUNT         R41 S3805500
         LA    R1,1(0,R1)          INCREMENT COUNTER BY ONE         R41 S3805600
         STH   R1,MDCTSNCT          AND RESTORE COUNT VALUE         R41 S3805700
         SPACE 1                                                    R41 S3805800
         MVC   RPLSEQTP,ICEINDEX   SET RPL SPECIAL SEQUENCE TYPE    R41 S3805900
         B     MVRPLXEC            PASS REQUEST TO VTAM AND RETURN  R41 S3806000
         DROP  MBUF,R15            DROP RPL AND NIB ADDRESSABILITY  R41 S3806100
         EJECT                                                      R41 S3812400
*                                                                   R41 S3812500
*        LOSTERM PROCESSING ROUTINE                                 R41 S3812600
*                                                                   R41 S3812700
         SPACE 1                                                    R41 S3812800
MICELOST DS    0H                  LOSTERM EXIT SCHEDULED EVENT     R41 S3812900
         LA    R1,MICELIMT         GET HIGHEST ALLOWED RETURN CODE  R41 S3813000
         SLL   R14,2               MULTIPLY INDEX BY 4              R41 S3813100
         CLR   R14,R1              COMPARE RETURN CODE WITH LIMIT   R41 S3813200
         BNL   MICEABRT            FORCE SESSION ABORT IF NOT LOW   R41 S3813300
         L     R1,MICELTAB(R14)    PICK UP COMPL CODE ENTRY         R41 S3813400
         BR    R1                   AND BRANCH TO PROC ROUTINE      R41 S3813500
         SPACE 2                                                    R41 S3813600
MICELTAB DS    0F                  LOSTERM EXIT ERROR ACTION TABLE  R41 S3813700
         DC    A(MICELRET)         ** NOT APPLICABLE **   - ERROR   R41 S3813800
         DC    A(MICELRET)         ** NOT APPLICABLE **   - ERROR   R41 S3813900
         DC    A(MICELRET)         ** NOT APPLICABLE **   - ERROR   R41 S3814000
         DC    A(MICEABRT)         LU RESTART FAILED      - CLSDST  R41 S3814100
         DC    A(MICEABRT)         LU RESTART SUCCESSFUL  - CLSDST  R41 S3814200
         DC    A(MICEABRT)         LU LOGOFF UNCONDITIONAL- CLSDST  R41 S3814300
         DC    A(MICEAHLD)         LU RESTART IN PROCESS  - PURGE   R41 S3814400
         DC    A(MICELRET)         ** NOT APPLICABLE **   - ERROR   R41 S3814500
         DC    A(MICETRAP)         LU LOGOFF CONDITIONAL  - DRAIN   R41 S3814600
         DC    A(MICEABRT)         LU BUFF LIMIT EXCEEDED - CLSDST  R41 S3814700
MICELIMT EQU   *-MICELTAB          HIGHEST ALLOWED ERROR CODE       R41 S3814800
         SPACE 1                                                    R41 S3814900
MICELRET BR    ML                  BRANCH TO PROCESS NEXT ICE       R41 S3815000
         EJECT                                                      R41 S3815100
MICETHAW LTR   R14,R14             TEST DISCONNECT SUBSEQUENCE      R41 S3815200
         BZ    MICEDISC            BR IF ONLY DISCONNECT FROM LINE  R41 S3815300
         B     MICEMELT             ELSE, FREE ICE                  R41 S3816000
         SPACE 3                                                    R41 S3825000
         DROP  MBASE1,MBASE2,MBASE3  RELEASE ROUTINES AND           R41 S3835000
         DROP  MICE,MDCT               DATA AREA ADDRESSABILITY     R41 S3845000
         SPACE 1                                                     R4 S4053500
         LTORG                                                       R4 S4059500
         TITLE 'HASP LINE MANAGER -- RAT SCAN FOR AUTOLOGON'        R41 S4059600
*********************************************************************** S4059700
*                                                                     * S4059800
*                      RAT SCAN FOR AUTOLOGON                         * S4059900
*                                                                     * S4060000
*********************************************************************** S4060100
         SPACE 1                                                    R41 S4060200
*                                  ADDRESSABILITY --                R41 S4060300
         USING RATDSECT,WA               -- RAT                     R41 S4060400
         USING RTAMVSUB,MBASE2,MBASE3    -- COMMON SNA SUBROUTINES  R41 S4060500
         USING MRATPROC,MBASE1           -- LOCAL ROUTINE BASE      R41 S4060600
         SPACE 2                                                    R41 S4060700
MRATPROC DS    0H                                                   R41 S4060800
         L     WA,$RATABLE         GET RAT ADDRESS             @OZ32567 S4060850
         LH    WC,$NUMRJE          PICK UP NUMBER OF RAT ENTRIES    R41 S4060900
*              THIS LINE DELETED BY APAR NUMBER                @OZ32567 S4061000
         SPACE 1                                                    R41 S4061100
*                                                                   R41 S4061200
*        LOCATE REMOTES IN AUTOLOGON (OR $S) MODE                   R41 S4061300
*                                                                   R41 S4061400
         SPACE 1                                                    R41 S4061500
MRATEST  TM    RATTYPE,DCTPSNA     TEST FOR SNA TYPE REMOTES        R41 S4061600
         BZ    MRATNXT             BR IF NOT, DO NEXT REMOTE        R41 S4061700
         TM    RATFLAGS,RATALM+RATSRMT  IF RMT NOT IN AUTOLOG MODE  R41 S4061800
         BZ    MRATNXT             GO TRY NEXT RAT ENTRY            R41 S4061900
         OI    MEVNTREQ,MEVNALM    SHOW REMOTE IN AUTOLOGON MODE    R41 S4062000
         TM    MEVNTREQ,MEVNTIME   CHECK FOR TIME INTERVAL EXPIRED  R41 S4062100
         BZ    MRATCHEK            BRANCH IF NO, GO CHECK RAT       R41 S4062200
         OI    MSTQE+IPOST,X'20'   REQUEST NEXT TIME INTERVAL       R41 S4062300
MRATCHEK L     R15,RATLDCT         PICK UP LINE DCT                 R41 S4062400
         USING DCTDSECT,R15        TEMP. LINE DCT ADDRESSABILITY    R41 S4062500
         LTR   R15,R15             TEST FOR REMOTE SIGNED ON        R41 S4062600
         BZ    MRATCHK1            BR IF NO, GO CHECK TIMER         R41 S4062700
         CL    WA,MDCTRAT          TEST FOR CONNECTED REMOTE        R41 S4062800
         BE    MRATNXT             BR IF NO, TRY NEXT REMOTE        R41 S4062900
         DROP  R15                                                  R41 S4063000
         SPACE 2                                                    R41 S4063100
MRATCHK1 L     R1,MCLOCK           COMPARE CURRENT TIME             R41 S4063200
         CL    R1,RATIMER           TO REMOTE SIGNOFF TIME          R41 S4063300
         BL    MRATNXT             SKIP AUTOLOGON IF STILL DELAYING R41 S4063400
         EJECT                                                      R41 S4063500
*                                                                   R41 S4063600
*        IF REMOTE IN AUTOLOGON MODE - LOOK FOR OUTPUT (OR MSGS)    R41 S4063700
*                                                                   R41 S4063800
MRATWTST DS    0H                                                   R41 S4063900
         TM    RATFLAGS,RATSRMT    TEST FOR START RMT COMMAND       R41 S4064000
         BO    MALOGON             BRANCH IF YES, SKIP WORK TEST    R41 S4064100
         L     MDCT,RATRDCT        FIRST REMOTE DCT ADDRESS         R41 S4064200
         USING DCTDSECT,MDCT       REMOTE DCT ADDRESSABILTY         R41 S4064300
         SLR   R14,R14             MULTIPLY                         R41 S4064400
         IC    R14,DCTNO+1          REMOTE NUMBER                   R41 S4064500
         LA    R1,0(R14,R14)         BY THREE TO                    R41 S4064600
         ALR   R1,R14                 GET ADDR OF                   R41 S4064700
         AL    R1,$MSPOOLQ             MSG QUEUE ENTRY              R41 S4064800
         CLC   1(1,R1),0(R1)       IF MSG ON QUEUE                  R41 S4064900
         BNE   MALOGON              GO DO AUTOLOGON                 R41 S4065000
         SPACE 1                                                    R41 S4065100
MRATPP   TM    DCTDEVTP,DCTPRPU    IF NOT A PRINT OR PUNCH DCT      R41 S4065200
         BNO   MRATNDCT             GO GET NEXT REMOTE DCT          R41 S4065300
         SPACE 1                                                    R41 S4065400
        $#GET  DCT=(MDCT),HAVE=NO  IF DEVICE HAS QUEUED OUTPUT      R41 S4065500
         SPACE 1                                                    R41 S4065600
         BNZ   MALOGON              GO DO AUTOLOGON                 R41 S4065700
         SPACE 1                                                    R41 S4065800
MRATNDCT L     MDCT,MDCTDCT        FIND NEXT REMOTE DCT             R41 S4065900
         LTR   MDCT,MDCT           TEST FOR END OF REMOTE CHAIN     R41 S4066000
         BNZ   MRATPP              LOOP, CHECK FOR WORK             R41 S4066100
         DROP  MDCT                RELEASE RMT DCT ADDRESSABILITY   R41 S4066200
         SPACE 1                                                    R41 S4066300
         B     MRATNXT             TRY NEXT REMOTE                  R41 S4066400
         EJECT                                                      R41 S4066500
*                                                                   R41 S4066600
*        ATTEMPT TO AUTOLOGON                                       R41 S4066700
*                                                                   R41 S4066800
         SPACE 1                                                    R41 S4066900
MALOGON  TM    RATFLAGS,RATPILUN   TEST FOR LUNAME DEFINED          R41 S4067000
         BNO   MALMSG              BR NOT DEFINED, ISSUE MESSAGE    R41 S4067100
         SPACE 2                                                    R41 S4067200
*        LOCATE ACTIVE APPLICATION (LOGON DCT)                      R41 S4067300
         SPACE 1                                                    R41 S4067400
         LA    R15,$LOGNDCT-(DCTCHAIN-DCTDSECT) POINT TO 1ST LGN    R41 S4067500
         USING DCTDSECT,R15        TEMP LOGON DCT ADDRESSABILITY    R41 S4067600
MALOGSCN L     R15,DCTCHAIN        CHAIN TO NEXT DCT                R41 S4067700
         LTR   R15,R15             TEST FOR CHAIN END               R41 S4067800
         BZ    MSCANEXT            NO DCT AVAILABLE, EXIT RAT SCAN  R41 S4067900
         CLI   DCTDEVTP,DCTLOG     TEST DCT TYPE                    R41 S4068000
         BNE   MSCANEXT            BRANCH IF NOT LOGON, END SCAN    R41 S4068100
         TM    MDCTSTAT,DCTSINON+DCTSOFF    TEST DCT  AVAILABILTY   R41 S4068200
         BNM   MALOGSCN            NOT AVAILABLE CHECK OTHERS       R41 S4068300
         DROP  R15                 RELEASE TEMP LOGON DCT BASE      R41 S4068400
         SPACE 2                                                    R41 S4068500
*        LOCATE AVAILABLE LINE DCT                                  R41 S4068600
         SPACE 1                                                    R41 S4068700
         L     MDCT,RATLDCT        PICK UP LINE DCT ADDRESS         R41 S4068800
         USING DCTDSECT,MDCT       SHOW LINE DCT ADDRESSABLE        R41 S4068900
         LTR   MDCT,MDCT           TEST FOR LINE DCT                R41 S4069000
         BZ    MALGDLNE            BRANCH IF DCT NOT PRESENT   @OZ32443 S4069100
         LR    R1,MDCT             SAVE LINE DCT FOR SEARCH    @OZ32443 S4069110
         LA    MDCT,MSNAIDL-(MDCTADCT-DCTDSECT) SEARCH IDLE    @OZ32443 S4069120
MALGLLNE L     MDCT,MDCTADCT         LINE DCTS                 @OZ32443 S4069130
         LTR   MDCT,MDCT           TEST FOR END OF CHAIN       @OZ32443 S4069140
         BZ    MRATNXT             BRANCH IF YES, NO LINE      @OZ32443 S4069150
         CLR   MDCT,R1             CHECK FOR CORRECT LINE DCT  @OZ32443 S4069160
         BNE   MALGLLNE            BRANCH IF NOT RIGHT LINE    @OZ32443 S4069170
         B     MALGLNED            BRANCH IF LINE DCT FOUND    @OZ32443 S4069180
MALGDLNE DS    0H                                              @OZ32443 S4069190
         LA    MDCT,MSNAIDL-(MDCTADCT-DCTDSECT) LOCATE IDLE DCTS    R41 S4069200
MALGLNES L     MDCT,MDCTADCT       FIND NEXT IDLE DCT               R41 S4069300
         LTR   MDCT,MDCT           TEST FOR END OF CHAIN            R41 S4069400
         BZ    MRATNXT             BRANCH IF YES, NO LINE FOUND     R41 S4069500
         TM    MDCTSTAT,DCTLEASE+DCTSHARE  TEST LINE STATUS         R41 S4069600
         BNZ   MALGLNES            BRANCH IF LEASED OR SHARED, SKIP R41 S4069700
         CLI   MDCTPSWD,C' '       TEST LINE PASSWORD               R41 S4069800
         BNE   MALGLNES            USE ONLY LINES WITHOUT PASSWORDS R41 S4069900
         L     R1,MDCTRAT          PICK UP ASSOCIATED RAT ADDRESS   R41 S4070000
         LTR   R1,R1               TEST FOR UN-OWNED LINE           R41 S4070100
         BNZ   MALGLNES            BRANCH IF NOT, TRY NEXT LINE     R41 S4070200
         EJECT                                                      R41 S4070300
*        TEST FOR REMOTE ALREADY CONNECTED TO OTHER SYSTEM          R41 S4070400
         SPACE 1                                                    R41 S4070500
MALGLNED LR    R0,WA               COPY RAT OFFSET                  R41 S4070600
         SL    R0,$RATABLE         R0 = (RMT NO -1) * RATTLE        R41 S4070700
         LR    R1,R0               MULTIPLY                         R41 S4070800
         ALR   R1,R0                BY                              R41 S4070900
         ALR   R1,R0                 THREE                          R41 S4071000
         SLR   R0,R0               DIVIDE BY EIGHT AND              R41 S4071100
         D     R0,=A(RATTLE)        RATTLE GIVING OFFSET TO         R41 S4071200
         D     R0,=A(8)              BYTE (QUOT) AND BIT (REMAIN)   R41 S4071300
         AL    R1,$RMTSON          R1 = BYTE ADDR OF SIGNON BITS    R41 S4071400
         LR    R14,R0              MOVE BIT OFFSET                  R41 S4071500
         L     R0,=A(QUEBUSY*X'2000')  GET BIT TO TEST BUSY         R41 S4071600
         SRL   R0,0(R14)           SHIFT TO BIT OFFSET              R41 S4071700
         STH   R0,MSONWORK         STORE IN WORK AREA FOR TEST      R41 S4071800
         NC    MSONWORK,0(R1)      TEST FOR RMT ON ANY OTHER SYSTEM R41 S4071900
         BNZ   MRATNXT             BRANCH IF YES, TRY NEXT REMOTE   R41 S4072000
         SLR   R0,R0               GET BUSY BITS                    R41 S4072100
         ICM   R0,4,$SIDBUSY         FOR THIS SYSTEM                R41 S4072200
         SRL   R0,3(R14)           SHIFT TO BIT OFFSET              R41 S4072300
         STH   R0,MSONWORK         STORE IN WORK AREA FOR SET       R41 S4072400
         SPACE 2                                                    R41 S4072500
*        ALLOCATE AVAILABLE ICE                                     R41 S4072600
         SPACE 1                                                    R41 S4072700
         L     MICE,$ICETRAY       GET FREE ICE ADDRESS             R41 S4072800
         USING ICEDSECT,MICE       ESTABLISH ICE ADDRESSABILITY     R41 S4072900
MALGICER LTR   MICE,MICE           TEST ICE AVAILABILTY             R41 S4073000
         BZ    MSCANEXT            BRANCH IF NONE, ABANDON SCAN     R41 S4073100
         L     R14,ICEAPCHN        LOCATE NEXT ICE ON CHAIN         R41 S4073200
         CS    MICE,R14,$ICETRAY   TRY TO REMOVE ICE FROM TRAY      R41 S4073300
         BNE   MALGICER            BRANCH IF FAILED, RE-TRY         R41 S4073400
         XC    ICEDSECT(ICESIZE),ICEDSECT  CLEAR ICE                R41 S4073500
         SPACE 2                                                    R41 S4073600
*        SHOW RMT ON THIS SYSTEM                                    R41 S4073700
         SPACE 1                                                    R41 S4073800
         OC    0(2,R1),MSONWORK    SET BITS -- SHOW RMT ON SYSTEM   R41 S4073900
         EJECT                                                      R41 S4074000
*        PRE-ALLOCATE (AND PRE-CONNECT) LINE-REMOTE-ICE             R41 S4074100
         SPACE 1                                                    R41 S4074200
MALGTBUF MVC   ICESYMB,RATSYMB     MOVE LUNAME INTO ICE             R41 S4074300
         ST    R15,ICEADCT         STORE LOGON DCT ADDRESS IN ICE   R41 S4074400
         ST    MDCT,ICELDCT        STORE LINE DCT ADDRESS IN        R41 S4074500
         ST    MDCT,RATLDCT         ICE AND RAT ENTRY               R41 S4074600
         ST    WA,MDCTRAT          STORE RAT ADDRESS IN LINE DCT    R41 S4074700
         NI    DCTFLAGS,DCTLOGAL   RESET FLAGS ---EXCEPT LOGGING    R41 S4074800
         L     R1,RATRDCT          PICK UP FIRST REMOTE DCT ADDRESS R41 S4074900
         ST    R1,MDCTDCT          STORE REMOTE ADDRESS IN LNE DCT  R41 S4075000
MALGRMT  ST    MDCT,DCTDCB-DCTDSECT(,R1)  STORE LNE DCT ADDR IN RMT R41 S4075100
         L     R1,MDCTDCT-DCTDSECT(,R1)  PICK UP ADDR OF NEXT DCT   R41 S4075200
         LTR   R1,R1               TEST FOR END OF REMOTE CHAIN     R41 S4075300
         BNZ   MALGRMT             BRANCH IF NO, DO THIS REMOTE     R41 S4075400
         SPACE 2                                                    R41 S4075500
*        REMOVE LINE DCT FROM IDLE AND ADD TO ACTIVE QUEUE          R41 S4075600
         SPACE 1                                                    R41 S4075700
         L     R1,MDCTADCT         GET ADDRESS OF NEXT IDLE DCT     R41 S4075800
         LA    R14,MSNAIDL-(MDCTADCT-DCTDSECT)  PICK UP IDLE QUEUE  R41 S4075900
         USING DCTDSECT,R14        PICK UP TEMP. DCT ADDRESSABILTY  R41 S4076000
MALGLDSC L     R0,MDCTADCT         LOCATE NEXT IDLE DCT             R41 S4076100
         CLR   MDCT,R0             COMPARE TO ALLOCATED LINE DCT    R41 S4076200
         BE    MALGLDEQ            BR IF EQUAL, GO RE-QUEUE LINE    R41 S4076300
         LTR   R14,R0              ELSE, BUMP TO NEXT IDLE DCT      R41 S4076400
         BNZ   MALGLDSC            BR IF NOT END OF CHAIN, LOOP     R41 S4076500
         BAL   R8,M03A             ERROR-LINE NOT ON IDLE QUE  @OZ49689 S4076600
         SPACE 1                                                    R41 S4076700
MALGLDEQ ST    R1,MDCTADCT         REMOVE LINE DCT FROM IDLE QUEUE  R41 S4076800
         DROP  R14                 RELEASE TEMP. DCT ADDRESSABILTY  R41 S4076900
         L     R14,MSNALNE         PICK UP ACTIVE LINE DCT QUEUE    R41 S4077000
         ST    R14,MDCTADCT        PLACE ALLOCATED LINE             R41 S4077100
         ST    MDCT,MSNALNE         AT TOP OF ACTIVE LINE QUEUE     R41 S4077200
         L     R1,MDCTICE          PICK UP LINE DCT ICE CHAIN       R41 S4077300
         ST    R1,ICEALCHN         ADD AUTOLOGON SESSION            R41 S4077400
         ST    MICE,MDCTICE         TO ALLOCATED ICE CHAIN          R41 S4077500
         LH    R1,MDCTSNCT         PICK UP LINE SESSION COUNT       R41 S4077600
         LA    R1,1(,R1)            INCREMENT                       R41 S4077700
         STH   R1,MDCTSNCT           STORE UPDATED COUNT            R41 S4077800
         SPACE 2                                                    R41 S4077900
*        PLACE THE ICE OF THE LOGON DCT CHAIN                       R41 S4078000
         SPACE 1                                                    R41 S4078100
         USING DCTDSECT,R15        PICK UP LOGON DCT ADDRESSABILITY R41 S4078200
         L     R1,MDCTICE          PICK UP LOGON DCT CHAIN          R41 S4078300
         ST    R1,ICEAPCHN         PLACE ICE AT TOP                 R41 S4078400
         ST    MICE,MDCTICE        REPLACE LOGON DCT ICE CHAIN      R41 S4078500
         LH    R1,MDCTSNCT         INCREMENT                        R41 S4078600
         LA    R1,1(,R1)            APPLICATION                     R41 S4078700
         STH   R1,MDCTSNCT           SESSION COUNT                  R41 S4078800
         DROP  R15                 RELEASE LOGON DCT ADDRESSABILITY R41 S4078900
         EJECT                                                      R41 S4079000
*        SCHEDULE THE LOGON REQUEST (SIMULATE A LOGON)              R41 S4079100
         SPACE 1                                                    R41 S4079200
         OI    ICESTAT,ICEABORT+ICEHOLD  PREVENT CLSDST OR ALLOC    R41 S4079300
         SPACE 1                                                    R41 S4080000
         LR    MDCT,WA             SAVE RAT ENTRY ADDRESS           R41 S4080100
         LA    R0,VXIDALOG         SETUP ICE EXIT CODE              R41 S4080200
         BAL   ML,MICEREQ1         QUEUE ICE TO THE LINE MANAGER    R41 S4080300
         LR    WA,MDCT             RELOAD RAT ENTRY ADDRESS         R41 S4080400
         SPACE 2                                                    R41 S4080500
*                                                                   R41 S4080600
*        CONTINUE SCAN -- CHECK NEXT REMOTE                         R41 S4080700
*                                                                   R41 S4080800
         SPACE 1                                                    R41 S4080900
MRATNXT  LA    WA,RATTLE(,WA)      POINT TO NEXT RAT ENTRY          R41 S4081000
         BCT   WC,MRATEST           GO CHECK NEXT RAT ENTRY         R41 S4081100
         B     MSCANEXT            GO DO NEXT SCAN                  R41 S4081200
         SPACE 3                                                    R41 S4081300
*                                                                   R41 S4081400
*        AUTOLOGON FAILED -- LUNAME NOT SPECIFIED                   R41 S4082000
*                                                                   R41 S4082100
         SPACE 1                                                    R41 S4082200
MALMSG   NI    RATFLAGS,255-RATALM-RATSRMT  RESET AUTOLOGON FLAGS   R41 S4082300
         L     R1,$MWORK           PICK UP WORK AREA ADDRESS        R41 S4082400
         MVC   0(L'MALMSG1,R1),MALMSG1   MOVE MSG TO WORK AREA      R41 S4082500
         USING MALMSG1,R1          TEMPORARY MESSAGE ADDRESSABILTY  R41 S4082600
         MVC   MALMSGR,RATNAME     MOVE REMOTE NAME TO MESSAGE      R41 S4082700
         $WTO  (R1),L'MALMSG1,WAIT=NO,JOB=NO,       ISSUE MESSAGE   R41CS4082800
               ROUTE=$LOG+$TP+$ERR,CLASS=$ALWAYS,PRI=$HI            R41 S4082900
         DROP  R1                  RELEASE MESSAGE ADDRESSABILITY   R41 S4083000
         SPACE 1                                                    R41 S4083100
         B     MRATNXT             GO TRY NEXT REMOTE               R41 S4083200
         SPACE 1                                                    R41 S4083300
         SPACE 3                                                    R41 S4083600
         LTORG                                                      R41 S4083700
         SPACE 3                                                    R41 S4083800
         DROP  MBASE1,MBASE2,MBASE3    RELEASE ROUTINES,            R41 S4083900
         DROP  WA,MDCT                  RAT AND DCT ADDRESSABILITY  R41 S4084000
         TITLE 'HASP LINE MANAGER -- BSC CHANNEL END PROCESSOR'     R41 S4084100
*********************************************************************** S4084200
*                                                                     * S4084300
*                  BSC BUFFER PROCESSING ROUTINE                      * S4084400
*                                                                     * S4084500
*********************************************************************** S4084600
         SPACE 1                                                    R41 S4084700
*                                  ADDRESSABILITY --                R41 S4084800
         USING BUFDSECT,MBUF            -- BUFFER                   R41 S4084900
         USING RTAMBSUB,MBASE2,MBASE3   -- COMMON BSC SUBROUTINES   R41 S4085000
         USING MBSCPROC,MBASE1          -- LOCAL ROUTINE BASE       R41 S4085100
         SPACE 3                                                    R41 S4085200
MBSCPROC DS     0H                                                  R41 S4085300
         SPACE 1                                                    R41 S4085400
         LH    R0,$EXCPCT          DECREMENT                        R41 S4085500
         S     R0,=F'1'             MASTER I/O COUNT                R41 S4085600
         BM    M01                 ERROR IF NEGATIVE                R41 S4085700
         STH   R0,$EXCPCT          UPDATE MASTER I/O COUNT          R41 S4085800
         SPACE 1                                                    R41 S4085900
         L     MDCT,BUFDCT         GET ASSOCIATED DCT ADDRESS       R41 S4086000
         LA    MDCT,0(,MDCT)        PURIFY LINE DCT ADDRESS         R41 S4086100
         USING DCTDSECT,MDCT         SHOW DCT ADDRESSABILITY        R41 S4086200
         L     MCODE,MDCTCODE      GET ADDRESS OF CODE TABLE        R41 S4086300
         USING MCODSECT,MCODE       SHOW CODE TABLE ADDRESSABILITY  R41 S4086400
         SPACE 1                                                    R41 S4086500
         SR    R1,R1               DECREMENT                        R41 S4086600
         IC    R1,DCTBUFCT          ACTIVE                          R41 S4086700
         S     R1,=F'1'              BUFFER COUNT                   R41 S4086800
         BNZ   M01                 ERROR IF NOT ZERO                R41 S4086900
         STC   R1,DCTBUFCT         STORE DECREMENTED BUFFER COUNT   R41 S4087000
         SPACE 1                                                    R41 S4087100
         L     R0,MDCTSXCP         INCREMENT                        R41 S4087200
         AL    R0,=F'1'             SESSION                         R41 S4087300
         ST    R0,MDCTSXCP           EXCP COUNT                     R41 S4087400
         SPACE 1                                                    R41 S4087500
         L     WA,IOBCSW-1         GET COMMAND ADDRESS FROM CSW     R41 S4087600
         LA    WA,0(,WA)           CLEAR HIGH-ORDER BYTE            R41 S4087700
         LTR   WA,WA               TEST                             R41 S4087800
         BZ    MDRAINLN            MACHINE ERROR IF ZERO            R41 S4087900
         SL    WA,=F'8'            GET LAST EXECUTED CSW            R41 S4088000
         TM    IOBSIOCC,X'30'      TEST SIO CONDITION CODE          R41 S4088100
         BZ    MBSCTST             BRANCH IF SUCCESSFUL SIO    @OZ46118 S4088200
         L     WA,IOBSTART         COMPENSATE FOR UNPREDICTABLE CSW R41 S4088300
         BO    MDRAINLN            BRANCH IF LINE IS NOT AVAILABLE  R41 S4088400
MBSCTST  DS    0H                                              @OZ46118 S4088450
         CLI   IOBECBCC,X'41'      IS IT A VALID CSW...        @OZ46118 S4088500
         BE    MBSCPRC              YES, CONTINUE              @OZ46118 S4088550
         TM    IOBECBCC,X'7F'      IS CSW VALID...             @OZ46118 S4088600
         BO    MBSCPRC             YES, CONTINUE               @OZ46118 S4088650
         L     WA,IOBSTART         COMP FOR UNPREDICTABLE CSW  @OZ46118 S4088675
         B     MDRAINLN            BRANCH IF CSW INVALID       @OZ46118 S4088700
MBSCPRC  DS    0H                                              @OZ46118 S4088750
         TM    DCTFLAGS,DCTLOGAL   TEST FOR DIAGNOSTIC LOGGING      R41 S4088800
         BZ    *+8                 BRANCH IF NO DIAGNOSTIC LOGGING  R41 S4088900
         BAL   ML,MCELOG           LOG CHANNEL END                  R41 S4089000
         SPACE 1                                                    R41 S4089100
         TM    IOBCSW+4,X'BF'      TEST FOR DISASTROUS ERRORS       R41 S4089200
         BNZ   MFORCERL            BR IF ANY TO FORCE ERROR AND LOG R41 S4089300
         MVC   MCOMMAND,5(WA)      COPY TP SEQ TYPE FIELD      @OZ42144 S4089330
         NI    MCOMMAND,X'0F'      EXTRACT CCW TYPE INDICATOR  @OZ42144 S4089360
         TM    IOBSENS0,X'90'      TEST SENSE BYTE             @OZ41880 S4089400
         BNZ   MCOMMREJ            BR IF CMD REJ OR EQC        @OZ41880 S4089500
         SPACE 1                                                    R41 S4089600
         TM    DCTFLAGS,DCTRSTRT   TEST FOR LINE RESTART            R41 S4089700
         BZ    MBSCPREP            SKIP IF NOT                      R41 S4089800
         TM    MDCTSTAT,DCTSOFF    SHOULD DISCONNECT SEQ BE SENT    R41 S4089900
         BO    MDRAINED            BRANCH IF YES                    R41 S4090000
         B     MRSTLINE            ELSE GO ABORT AND DISCONNECT     R41 S4090100
         EJECT                                                      R41 S4090200
*                                                                   R41 S4090300
*                             BSC PREPARE SEQUENCE PROCESSING       R41 S4090400
*                                                                   R41 S4090500
         SPACE 3                                                    R41 S4090600
MBSCPREP TM    IOBCSW+3,X'03'      TEST CHANNEL END STATUS          R41 S4090700
         BNZ   MBSCCE              BR IF UNIT CHECK OR UNIT EXCEPTN R41 S4090800
         CLC   IOBCSW+5(2),6(WA)   CHECK RESIDUAL BYTE COUNT        R41 S4090900
         BNE   MBSCCE              BRANCH IF NOT SAME AS INITIAL    R41 S4091000
         CLI   0(WA),X'02'         CHECK FOR READ CCW               R41 S4091100
         BNE   MBSCCE              BRANCH IF NOT READ                   S4091200
         OI    IOBSENS0,X'02'      THIS IMPOSSIBLE CONDITION CAN ONLY   S4091500
         OI    IOBCSW+3,X'02'       HAPPEN ON A 2703 -- SIMULATE ERROR  S4092000
         SPACE 2                                                        S4092500
MBSCCE   TM    5(WA),MPREPSEQ      TEST SEQUENCE TYPE                   S4093000
         BZ    MBCERDWR            BRANCH IF NOT PREPARE                S4093500
         SPACE 2                                                     R4 S4094000
         CLI   0(WA),X'14'         TEST FOR CTCA SENSE COMMAND       R4 S4094500
         BNE   MBSCPTOF            BRANCH IF NOT                     R4 S4095000
         MVI   4(WA),X'60'         RE-CHAIN CTCA SENSE COMMAND       R4 S4095500
         LA    R1,IOBCCW4          R1=ADDR OF READ COMMAND     @OZ38139 S4095600
         CLI   LCBMCB,X'01'        OTHER SYSTEM ISSUE WRITE... @OZ38139 S4095700
         BE    MNEWSTRT            YES, ISSUE READ             @OZ38139 S4095800
         LA    R1,IOBCCW2          R1 = ADDRESS OF WRITE COMMAND     R4 S4096000
         CLI   LCBMCB,0            OTHER SYS ISSUE RD OR CNTL..@OZ38139 S4096500
         BNE   MNEWSTRT            BRANCH IF YES                     R4 S4097000
         LA    R1,IOBCCW3          R1 = ADDRESS OF CONTROL COMMAND   R4 S4097500
         B     MNEWSTRT            GO START CTCA                     R4 S4098000
         SPACE 2                                                     R4 S4098500
MBSCPTOF BAL   ML,MSIGNOFF         CHECK FOR DRAIN OR SIGN-OFF       R4 S4099000
         SPACE 2                                                     R4 S4099500
         TM    IOBCSW+3,X'01'      TEST CHANNEL END STATUS              S4100000
         BO    MBSCPRUE            BRANCH IF UNIT EXCEPTION             S4100500
         TM    MDCTLINE,DCTPCTC    TEST LINE TYPE                    R4 S4101000
         BO    MBSCPTUC            BRANCH IF CTCA                    R4 S4101500
         SPACE 1                                                     R4 S4102000
         CLI   MCOMMAND,MENBCMD    TEST COMMAND TYPE                    S4102500
         BL    MRETRY              BRANCH IF DISABLE OR SET MODE        S4103000
         BE    MBSCPNAN            BRANCH IF ENABLE COMMAND             S4103500
         CLI   MDCTIMOK,255        WAS MODEM ON HOOK                    S4104000
         BNE   MBSCPNAN            BRANCH IF NOT                        S4104500
         MVC   MDCTIMOK,MCLOCK     SET TIME MODEM FIRST READY           S4105000
MBSCPNAN LA    R1,IOBCCW3          RESET RESTART ADDRESS                S4105500
         ST    R1,IOBRESTR          TO BYPASS DISABLE AND SET MODE      S4106000
         EJECT                                                       R4 S4106500
MBSCPTUC TM    IOBCSW+3,X'02'      TEST CHANNEL END STATUS           R4 S4107000
         BO    MBSCPRUC            BRANCH IF UNIT CHECK                 S4107500
         MVI   IOBCCW3,X'27'       RESET CCW3 TO ENABLE              R4 S4108000
         MVI   MDCTERCT,8          RESET ERROR COUNT                    S4108500
         SPACE 2                                                        S4109000
         LA    R1,TPBUFST-2        COMPUTE                              S4109500
         AH    R1,6(,WA)            ADDRESS OF                          S4110000
         SH    R1,IOBCSW+5           LAST TWO BYTES                     S4110500
         MVC   LCBRCB,0(R1)        SAVE LAST TWO BYTES                  S4111000
         SPACE 2                                                     R4 S4111500
         CLC   MSOHENQ,LCBRCB      TEST RESPONSE                        S4112000
         BE    MBSCPUST            BRANCH IF SOH-ENQ SEQUENCE           S4112500
         TM    MSEQTYPE,MCPUSEQ    WAS SOH-ENQ SENT                  R4 S4113000
         BNO   SKIP1320            SKIP IF NOT                       R4 S4113500
         CLC   MACK0SEQ,LCBRCB     TEST RESPONSE                     R4 S4114000
         BE    MBSCPUSA            BRANCH IF ACK0                    R4 S4114500
SKIP1320 TM    MDCTLINE,DCTPCTC    TEST LINE TYPE                    R4 S4115000
         BZ    MBSCPTNC            SKIP IF NOT CTCA                  R4 S4115500
         OC    MDCTOBUF+1(3),MDCTOBUF+1 SIGNON TO BE SENT            R4 S4116000
         BZ    SKIP1330            SKIP IF NOT                       R4 S4116500
         OI    MSEQTYPE,MCPUSEQ    SET SENDING SOH-ENQ               R4 S4117000
         LA    R1,MSOHENQ          POINY TO SOH-ENQ                  R4 S4117500
         STCM  R1,7,IOBCCW2+1      SET WRITE CCW                     R4 S4118000
SKIP1330 BAL   ML,MINITCDL         SETUP A DELAY                     R4 S4118500
         B     MBUFNEXT            SEARCH FOR OTHER WORK             R4 S4119000
         SPACE 2                                                     R4 S4119500
MBSCPTNC CLC   MBSCENQ,LCBRCB+1    TEST RESPONSE                     R4 S4120000
         BE    MSTARTRD            IF ENQ, START READER                 S4120500
         CLC   MACK0SEQ,LCBRCB     IF ACK0,                             S4121000
         BE    MSTARTPP             START PRINTER OR PUNCH              S4121500
         CLC   MACK1SEQ,LCBRCB     IF ACK1,                             S4122000
         BE    MSTARTPP             START PRINTER OR PUNCH              S4122500
         CLC   MBSCNAK,LCBRCB+1    TEST RESPONSE FOR NAK             R4 S4123000
         BE    MBSCPTST            BRANCH IF NAK                        S4123500
         CLC   MBSCWACK,LCBRCB+1   IF WACK RESPONSE,           @OZ49730 S4123600
         BE    MRETRY               RETRY I/O                  @OZ49730 S4123700
         B     MRETRYL             OTHERWISE, LOG AND RETRY             S4124000
         SPACE 2                                                        S4124500
MBSCPRUE DS    0H                  BSC PREPARE UNIT EXCEPTION           S4125000
         CLI   0(WA),X'01'         CHECK FOR WRITE COMMAND              S4125500
         BE    MRESTART            GO CLEAR LOST DATA IF WRITE          S4126000
         B     MRETRYL             OTHERWISE, LOG AND RETRY             S4126500
         EJECT                                                          S4127000
MBSCPRUC DS    0H                  BSC PREPARE UNIT CHECK               S4127500
         CLI   0(WA),X'29'         TEST FOR UNSUCCESSFUL DIAL        R4 S4128000
         BE    MFORCERL            IF YES, LOG AND RESTART LINE      R4 S4128500
         MVI   IOBCCW3,X'27'       RESET CCW3 TO ENABLE              R4 S4129000
         TM    IOBSENS0,X'02'      TEST FOR LOST DATA                   S4129500
         BO    MRETRY              BRANCH IF LOST DATA                  S4130000
         TM    IOBSENS0,X'41'      TEST FOR INT REQ OR TIMEOUT          S4130500
         BZ    MRETRYL             BRANCH IF NEITHER TO LOG AND RETRY   S4131000
         TM    IOBSENS0,X'40'      TEST FOR INTERVENTION REQUIRED       S4131500
         BZ    MBSCPNAD            BRANCH IF NO                         S4132000
         TM    MDCTLINE,DCTPNADS   SHOULD REMOTE BE DISCONNECTED        S4132500
         BZ    MFORCERL            IF YES, LOG AND RESTART LINE         S4133000
         BAL   ML,MCERRLOG         ELSE, LOG INT REQ           @OZ29621 S4133200
         SPACE 1                                                     R4 S4133500
MBSCPNAD CLI   MDCTIMOK,255        IF MODEM IS OFF HOOK              R4 S4134000
         BE    MBSCPTD             TEST DIAL                         R4 S4134500
         OC    MDCTOBUF+1(3),MDCTOBUF+1 SIGNON TO BE SENT            R4 S4135000
         BZ    MBSCPNDI            BRANCH IF NOT                     R4 S4135500
         OI    MSEQTYPE,MCPUSEQ    SET SENDING SOH-ENQ               R4 S4136000
         LA    R1,MSOHENQ          POINT TO SOH-ENQ                  R4 S4136500
         ST    R1,IOBCCW5          SET WRITE CCW ADDRESS             R4 S4137000
         MVI   IOBCCW5,X'01'       SET WRITE OP-CODE                 R4 S4137500
         MVI   IOBCCW5+7,2         SET COUNT                         R4 S4138000
         B     MRETRY              RETRY I/O                         R4 S4138500
         SPACE 1                                                     R4 S4139000
MBSCPTD  CLI   IOBCCW7,0           NEED TO DIAL                      R4 S4139500
         BZ    MRETRY              SKIP DIAL SETTING IF NOT          R4 S4140000
         LA    R1,IOBCCW7+1        GET ADDRESS OF DIAL DIGITS        R4 S4140500
         ST    R1,IOBCCW3          STORE IN CCW3                     R4 S4141000
         MVI   IOBCCW3,X'29'       SET CCW3 TO DIAL                  R4 S4141500
         MVC   IOBCCW3+7(1),IOBCCW7  SET COUNT OF DIAL DIGITS        R4 S4142000
         MVI   IOBCCW7,0           RESET DIAL REQUEST                R4 S4142500
         LA    R1,IOBCCW1          START AT DISABLE COMMAND          R4 S4143000
         B     MNEWSTRT            GO TRY DIAL                       R4 S4143500
         SPACE 1                                                     R4 S4144000
MBSCPNDI CLI   MCOMMAND,MREADCMD   TEST COMMAND TYPE                 R4 S4144500
         BNE   MRETRY              RETRY IF NOT READ                    S4145000
         SPACE 1                                                     R4 S4145500
MBSCPTST L     WA,MDCTDCT          GET ADDR OF FIRST REMOTE DCT         S4146000
         LTR   WA,WA               TEST                                 S4146500
         BZ    MRETRY              BRANCH IF NOT SIGNED ON              S4147000
         TM    MDCTFMT-DCTDSECT(WA),DCTPROG  TEST FORMAT TYPE           S4147500
         BNZ   MRETRY              BR IF PROGRAMMABLE INTERFACE         S4148000
         SPACE 1                                                     R4 S4148500
         CLI   IOBCCW5,X'01'       IS ENQ/EOT BEING SENT                S4149000
         BNE   MBSCPNOP            BRANCH IF NO                         S4149500
         XI    IOBCCW5+3,MBSCEOT-MBSCENQ     ALTERNATE ENQ AND EOT      S4150000
         TM    IOBCCW5+3,MBSCEOT-MBSCENQ     IS EOT TO BE SENT          S4150500
         BO    MRETRY              YES, SEND IT                         S4151000
         EJECT                                                       R4 S4151500
MBSCPNOP TM    MDCTATTN,MDCTJOB    TEST IF JOB HAS BEEN POSTED       R4 S4152000
         BZ    MBSCPRNE            SET UP READ COMMAND IF NOT        R4 S4152500
         BM    MRETRY              RETRY POLLING IF OUTPUT QUEUED    R4 S4153000
         SPACE 1                                                     R4 S4153500
         L     R1,MDCTRAT          GET TERMINAL RAT ENTRY ADDR       R4 S4154000
         LH    R1,RATWTIME-RATDSECT(,R1) GET TERMINAL WAIT TIME      R4 S4154500
         LTR   R1,R1               WAIT TIME INTERVAL SPECIFIED      R4 S4155000
         BNZ   SKIP1340            USE TERMINAL VALUE IF YES         R4 S4155500
         LH    R1,$WAITIME         GET INSTALLATION DEFAULT VALUE    R4 S4156000
SKIP1340 AL    R1,MDCTIMOK         GET TIME INTERVAL EXPIRED AND     R4 S4156500
         CL    R1,MCLOCK            CHECK AGAINST WAIT TIME VALUE    R4 S4157000
         BH    MBSCPRNF            RETRY IF NOT YET EXPIRED    @OZ29391 S4157500
         SPACE 1                                                     R4 S4158000
         NI    MDCTATTN,255-MDCTJOB2    RESET QUEUE TO TEST INDIC.   R4 S4158500
         L     WA,MDCTDCT-DCTDSECT(,WA) GET ADDR OF PRINTER DCT         S4159000
         TM    DCTSTAT-DCTDSECT(WA),DCTDRAIN TEST STATUS                S4159500
         BNZ   MBSCPRPU            BRANCH IF PRINTER IS DRAINED         S4160000
         TM    DCTPPSW-DCTDSECT(WA),DCTPPSWS  TEST STATUS      @OZ20001 S4160200
         BO    MBSCPRNC            BRANCH IF SEP PAGE SUPRESS  @OZ20001 S4160300
         SLR   R15,R15                     CLEAR R15           @OZ45379 S4160500
         L     R1,MDCTRAT                   POINT TO RAT       @OZ45379 S4161000
         IC    R15,RATCONRT+1-RATDSECT(,R1)  MULTIPLY RMT NUM  @OZ45379 S4161100
         LA    R1,0(R15,R15)               BY                        R4 S4161500
         ALR   R1,R15                       THREE                    R4 S4162000
         AL    R1,$MSPOOLQ         ADD ADDRESS OF REMOTE MSG QUEUES  R4 S4162500
         CLC   1(1,R1),0(R1)       COMPARE RECORD NUMBERS               S4163000
         BNE   MBSCPREQ            REMOTE MESSAGES QUEUED IF NOT EQUAL  S4163500
         SPACE 1                                                     R4 S4164000
MBSCPRNC DS    0H                                              @OZ20001 S4164300
        $#GET  DCT=(WA),HAVE=NO    TEST FOR JOB TO PRINT                S4164500
         BNZ   MBSCPREQ            BRANCH IF JOB AWAITING PRINT         S4165000
         EJECT                                                       R4 S4165500
MBSCPRPU DS    0H                                                    R4 S4166000
         L     WA,MDCTDCT-DCTDSECT(,WA) GET ADDRESS OF PUNCH DCT        S4166500
         LTR   WA,WA               IS THERE A PUNCH DCT                 S4167000
         BZ    MBSCPRNE            BRANCH IF NO                         S4167500
         TM    DCTSTAT-DCTDSECT(WA),DCTDRAIN TEST STATUS                S4168000
         BNZ   MBSCPRNE            BRANCH IF PUNCH IS DRAINED           S4168500
        $#GET  DCT=(WA),HAVE=NO    TEST FOR JOB TO PUNCH                S4169000
         BNZ   MBSCPREQ            BRANCH IF JOB AWAITING PUNCH         S4169500
         SPACE 1                                                     R4 S4170000
MBSCPRNE NI    MDCTATTN,255-MDCTJOB1    RESET OUTPUT QUEUED INDIC.   R4 S4170500
         SPACE 1                                               @OZ29391 S4170900
MBSCPRNF MVI   IOBCCW5,X'03'       NOP ENQUIRY WRITE           @OZ29391 S4171000
         TM    $RJEOPTS,$ADDSYNS   TEST ADDITIONAL IDLES OPTION      R4 S4171500
         BZ    MRETRY              BR TO RETRY IF NOT SELECTED       R4 S4172000
         MVI   IOBCCW4,X'03'       NOP ADD SYN WRITE                 R4 S4172500
         MVI   IOBCCW4+4,X'60'     SET COMMAND CHAINING                 S4173000
         B     MRETRY              RETRY READ COMMAND                R4 S4173500
         SPACE 1                                                     R4 S4174000
MBSCPREQ MVI   IOBCCW5,X'01'       ACTIVATE ENQUIRY WRITE            R4 S4174500
         TM    $RJEOPTS,$ADDSYNS   TEST ADDITIONAL IDLES OPTION      R4 S4175000
         BZ    MRETRY              RETRY IF NOT SET                  R4 S4175500
         MVI   IOBCCW4,X'01'       ACTIVATE ADD SYN WRITE            R4 S4176000
         MVI   IOBCCW4+4,X'A0'     SET DATA CHAINING                    S4176500
         B     MRETRY              GO TO SEND ENQUIRY                R4 S4177000
         EJECT                                                          S4177500
*                                                                       S4178000
*                             BSC READ/WRITE SEQUENCE PROCESSING        S4178500
*                                                                       S4179000
         SPACE 2                                                        S4179500
MBCERDWR TM    5(WA),MCPUSEQ       TEST SEQUENCE TYPE                R4 S4180000
         BZ    MBCENSF             BRANCH IF NOT PROGRAMMABLE INTERFACE S4180500
         OC    MDCTOBUF,MDCTOBUF   TEST OPEN AND OUTPUT STATUS       R4 S4181000
         BNZ   MBCENSF             BRANCH IF REMOTE IS NOT IDLE         S4181500
         BAL   ML,MSIGNOFF         CHECK FOR DRAIN OR SIGN-OFF          S4182000
         SPACE 1                                                        S4182500
MBCENSF  TM    IOBCSW+3,X'02'      TEST CHANNEL END STATUS     @OZ41611 S4183000
         BO    MBSCRWUC            BRANCH IF UNIT CHECK        @OZ41611 S4183500
         TM    IOBCSW+3,X'01'      TEST CHANNEL END STATUS     @OZ41611 S4184000
         BO    MBSCRWUE            BRANCH IF UNIT EXCEPTION    @OZ41611 S4184500
         MVI   MDCTERCT,8          RESET ERROR COUNT                    S4185000
         SPACE 1                                                        S4185500
         TM    5(WA),MCPUSEQ       TEST SEQUENCE TYPE                   S4186000
         BZ    MBCE27X0            BRANCH IF NOT PROGRAMMABLE INTERFACE S4186500
         SPACE 1                                                        S4187000
         MVI   IOBECBCC,0          RESET BUFFER BUSY STATUS          R4 S4187500
         OI    MDCTSTAT,DCTPBUF    INDICATE OUTPUT NOT POSTED        R4 S4188000
         NI    MDCTSTAT,255-DCTPOST INDICATE NO OUTPUT SENT          R4 S4188500
         CLI   0(WA),X'02'         IS THIS A READ CCW               R41 S4188600
         BNE   MFORCERL            IF NOT--FORCE ERROR & RESTART    R41 S4188700
         L     R1,0(WA)            R1 = ADDRESS OF RESPONSE             S4189000
         CLC   MSOHSTX,0(R1)       TEST RESPONSE                        S4189500
         BE    MBCETEXT            BRANCH IF TEXT                       S4190000
         CLC   MDLESTX,0(R1)       TEST RESPONSE                        S4190500
         BE    MBCETEXT            BRANCH IF TRANSPARENT TEXT           S4191000
         CLC   MACK0SEQ,0(R1)      TEST RESPONSE                        S4191500
         BNE   MBCENAK0            BRANCH IF NOT ACK0                   S4192000
         NI    MDCTFCS,X'BF'       TURN OFF WAIT-A-BIT INDICATION       S4192500
         B     MBCEACK0            PROCESS ACK0                         S4193000
         SPACE 1                                                        S4193500
MBCENAK0 CLC   MSOHENQ,0(R1)       TEST RESPONSE                        S4194000
         BE    MBSCPUST            BRANCH IF SOH-ENQ SEQUENCE           S4194500
         CLC   MNAKSEQ,0(R1)       TEST FOR CTCA NAK                 R4 S4195000
         BE    MFORCERL            LOG AND RESTART LINE IF NAK       R4 S4195500
         CLC   MBSCNAK,0(R1)       TEST FIRST CHARACTER                 S4196000
         BNE   MCWRNAKL            BRANCH IF INVALID RESPONSE           S4196500
         BAL   ML,MCERRLOG         LOG NAK                              S4197000
         CLI   MCOMMAND,MRRSPCMD   TEST LAST WRITE TYPE                 S4197500
         BE    MBCENAK             BRANCH IF LAST WRITE WAS WAIT-A-BIT  S4198000
         TM    5(WA),MWRITSEQ      TEST LAST WRITE TYPE                 S4198500
         BO    MRETRY              BRANCH IF LAST WRITE WAS TEXT        S4199000
         CLC   MACK0SEQ,LCBRCB     TEST LAST RESPONSE SENT              S4199500
         BE    MBCENAK             BRANCH IF ACK0                       S4200000
         TM    MDCTLINE,DCTPHASP   TEST LINE USAGE                      S4200500
         BZ    MRETRY              BRANCH IF REMOTE WORKSTATION         S4201000
         B     MBCENAK             AVOID NAK-NAK IF HASP                S4201500
         EJECT                                                          S4202000
MBCETEXT TM    MDCTLINE,DCTPCTC    TEST LINE TYPE                    R4 S4202500
         BO    MBCETETB            BRANCH IF CTCA                    R4 S4203000
         LR    R15,R1              COMPUTE                           R4 S4203500
         AH    R15,6(WA)            ADDRESS                             S4204000
         SH    R15,IOBCSW+5          OF                                 S4204500
         BCTR  R15,0                  LAST BYTE                         S4205000
         CLC   MBSCETB,0(R15)      TEST LAST BYTE                       S4205500
         BE    MBCETETB            BRANCH IF LAST BYTE IS ETB           S4206000
         MVC   IOBSENS0,0(R15)     SAVE LAST BYTE IN SENSE INFORMATION  S4206500
         B     MCWRNAKL            WRITE NAK AND LOG                    S4207000
MBCETETB MVC   MDCTFCS,3(R1)       SAVE FUNCTION CONTROL SEQUENCE       S4207500
         SPACE 2                                                        S4208000
         TM    2(R1),X'20'         TEST FOR RESET BLOCK SEQUENCE COUNT  S4208500
         BZ    *+10                BRANCH IF NOT                        S4209000
         MVN   MDCTRSEQ(1),2(R1)   YES, RESET COUNT                     S4209500
         SPACE 1                                                        S4210000
         TM    2(R1),X'30'         TEST FOR IGNORE BLOCK SEQUENCE COUNT S4210500
         BNZ   MBCENSEQ            BRANCH IF IGNORE OR RESET            S4211000
         SPACE 1                                                        S4211500
         MVN   MSEQWORK+1(1),2(R1) ISOLATE RECEIVED BLOCK COUNT         S4212000
         SR    R15,R15             CLEAR REGISTER                       S4212500
         IC    R15,MDCTRSEQ        PICK UP EXPECTED COUNT               S4213000
         SH    R15,MSEQWORK        GENERATE ERROR                       S4213500
         BZ    MBCEUSEQ            BRANCH IF NO ERROR                   S4214000
         BP    *+8                 BRANCH IF NO DIGIT OVERFLOW          S4214500
         LA    R15,16(R15)         CORRECT DIGIT OVERFLOW               S4215000
         C     R15,=F'2'           COMPARE WITH MAXIMUM ERROR           S4215500
         BNH   MBCEACK0            BRANCH IF DUPLICATE RECORD           S4216000
         SPACE 1                                                        S4216500
         MVI   IOBCSW+3,0          CLEAR CHANNEL END STATUS             S4217000
         MVC   IOBSENS0,MSEQWORK+1 SET UP RECEIVED BLOCK SEQUENCE COUNT S4217500
         MVC   LCBACK,MDCTRSEQ     SET UP EXPECTED COUNT                S4218000
         BAL   ML,MCERRLOG         LOG SEQUENCE ERROR                   S4218500
         BAL   ML,MRSTRD           DELETE ALL INPUT PROCESSORS          S4219000
         L     R1,0(WA)            RE-LOAD ADDRESS OF TEXT              S4219500
         MVI   5(R1),0             NULLIFY TEXT                         S4220000
         SPACE 1                                                        S4220500
MBCEUSEQ LH    R15,MSEQWORK        INCREMENT RECEIVE                    S4221000
         LA    R15,1(R15)           BLOCK SEQUENCE                      S4221500
         STC   R15,MDCTRSEQ          COUNT                              S4222000
         NI    MDCTRSEQ,X'0F'      TAKE MODULO SIXTEEN                  S4222500
         EJECT                                                       R4 S4223000
MBCENSEQ CLI   5(R1),X'E0'         TEST FOR REMOTE SEQUENCE ERROR       S4223500
         BNE   MBCENSCK            BRANCH IF NOT                        S4224000
         MVC   IOBCSW+3(2),=X'FFFF' INDICATE REMOTE SEQUENCE ERROR      S4224500
         MVN   IOBSENS0,2(R1)      SET UP RECEIVED BLOCK SEQUENCE COUNT S4225000
         MVC   LCBACK,6(R1)        SET UP EXPECTED COUNT                S4225500
         NI    LCBACK,X'0F'        ISOLATE SEQUENCE COUNT               S4226000
         MVC   MDCTTSEQ(1),6(R1)   SAVE EXPECTED COUNT                  S4226500
         L     R0,MDCTSREM         INCREMENT                            S4227000
         AL    R0,=F'1'             NON-SPECIFIC                        S4227500
         ST    R0,MDCTSREM           ERROR COUNT                        S4228000
         BAL   ML,MCELOG           LOG SEQUENCE ERROR                   S4228500
         L     R1,MDCTOBUF         IF OUTPUT BUFFER CONTAINS   @OZ39776 S4228600
         CLI   TPBUFST+5-BUFDSECT(R1),X'A0' PERMISS. GRANTED   @OZ39776 S4228700
         BE    MRETRY              THEN RESEND PERMISSION      @OZ39776 S4228800
         BAL   ML,MRSTPP           RESTART ALL OUTPUT PROCESSORS        S4229000
         L     R1,0(WA)            RE-LOAD ADDRESS OF TEXT              S4229500
         SPACE 2                                                     R4 S4230000
MBCENSCK LA    R1,5(R1)            GET ADDRESS OF FIRST RCB             S4230500
         CLI   MCOMMAND,MRRSPCMD   TEST LAST WRITE TYPE                 S4231000
         BNE   MBCEDATA            BRANCH IF NOT WAIT-A-BIT             S4231500
         BAL   ML,MBCNTRLR         ANALYZE CONTROL RECORD               S4232000
         B     MBCEDISC            CONTINUE PROCESSING               R4 S4232500
         SPACE 1                                                        S4233000
MBCEDATA ST    R1,TPBFDATA         INITIALIZE DATA POINTER              S4233500
         BAL   ML,MBCNEXTR         PROCESS TEXT BUFFER                  S4234000
         CLI   TPBRECNT,C'E'       IS INPUT BUFFER EMPTY                S4234500
         BE    *+8                 SKIP IF YES                          S4235000
         BAL   ML,MINITDLY         SETUP DELAY                          S4235500
         MVC   MDCTIMOK,MCLOCK     SET TIME OF TEXT TRANSMISSION        S4236000
MBCEDISC TM    DCTFLAGS,DCTRSTRT   WAS DISCONNECT RECORD RECEIVED    R4 S4236500
         BO    MRSTLINE            BRANCH IF YES                     R4 S4237000
         SPACE 2                                                     R4 S4237500
MBCEACK0 TM    5(WA),MWRITSEQ      TEST LAST WRITE TYPE                 S4238000
         BZ    MBCENTXT            BRANCH IF LAST WRITE WAS NOT TEXT    S4238500
         MVC   MDCTIMOK,MCLOCK     SET TIME OF TEXT TRANSMISSION        S4239000
         L     R1,MDCTOBUF         GET ADDRESS OF OUTPUT BUFFER         S4239500
         MVC   MDCTOBUF+1(3),BUFCHAIN+1-BUFDSECT(R1)   DECHAIN BUFFER   S4240000
         OI    MDCTSTAT,DCTPOST    INDICATE OUTPUT SENT              R4 S4240500
         L     R15,BUFDCT-BUFDSECT(,R1) GET ADDRESS OF ASSOCIATED DCT   S4241000
         OI    MDCTSTAT-DCTDSECT(R15),DCTPOST  SHOW I/O COMPLETE        S4241500
         CLI   TPBUFST+5-BUFDSECT(R1),X'91'  TEST OUTPUT RCB            S4242000
         BE    MBCONRCB            BRANCH IF CONSOLE           @OZ42466 S4242200
         CLC   MDCTCMCT-DCTDSECT(,R3),$MAXCMCT  LIMIT REACHED  @OZ42466 S4242300
         BNE   MBCEOUT             BRANCH IF NOT CONSOLE                S4242500
MBCONRCB DS    0H                                              @OZ42466 S4242900
         LR    R15,R1              R15 IS 1ST OUTPUT BUFFER ADDR        S4243000
MBCERC1  L     R15,BUFCHAIN-BUFDSECT(,R15)  GET ADDR NEXT BUFFER        S4243500
         LTR   R15,R15             TEST BUFFER ADDRESS                  S4244000
         BNZ   MBCERC2             BRANCH IF NOT END OF CHAIN           S4244500
         MVI   MDCTCMCT,0          ZERO CONSOLE MESSAGE COUNT        R4 S4245000
         B     MBCEOUT             GO FREE 1ST BUFFER                   S4245500
MBCERC2  CLI   TPBUFST+5-BUFDSECT(R15),X'91'  TEST OUTPUT RCB           S4246000
         BNE   MBCERC1             LOOP IF NOT CONSOLE                  S4246500
MBCEOUT $FREEBUF (R1)              FREE OUTPUT BUFFER                   S4247000
         EJECT                                                       R4 S4247500
MBCENTXT TM    MDCTFCS,X'40'       TEST REMOTE FCS                      S4248000
         BO    MBCENAK             BRANCH IF WAIT-A-BIT                 S4248500
         LR    R1,MDCT             PREPARE TO POST OUTPUT PROCESSORS    S4249000
         SPACE 3                                                        S4249500
MBCENDCT L     R1,MDCTDCT-DCTDSECT(R1)  GET ADDRESS OF NEXT REMOTE DCT  S4250000
         LTR   R1,R1               TEST FOR END OF CHAIN                S4250500
         BZ    MBCENAK             BRANCH IF NO MORE REMOTE DCT'S       S4251000
         SPACE 1                                                        S4251500
         TM    MDCTSTAT-DCTDSECT(R1),DCTPOST      TEST DCT STATUS       S4252000
         BZ    MBCENDCT            BRANCH IF I/O IS NOT COMPLETE        S4252500
         SPACE 1                                                        S4253000
         MVC   MFCSWORK,MDCTFCS-DCTDSECT(R1) GET UNIT FCS               S4253500
         NC    MFCSWORK,MDCTFCS    APPLY REMOTE FCS                     S4254000
         BZ    MBCENDCT            BRANCH IF UNIT WAS NOT POSTED        S4254500
         SPACE 1                                                        S4255000
         NI    MDCTSTAT,255-DCTPBUF-DCTPOST INDICATE OUTPUT POST     R4 S4255500
         NI    MDCTSTAT-DCTDSECT(R1),255-DCTPOST  RESET I/O POST        S4256000
         L     R15,DCTPCE-DCTDSECT(R1)  GET ADDRESS OF ASSOCIATED PCE   S4256500
        $POST  (R15),WORK          POST PROCESSOR                       S4257000
         B     MBCENDCT            GET NEXT DCT                         S4257500
         SPACE 3                                                        S4258000
MBCENAK  CLI   MCOMMAND,MREADCMD   TEST LAST WRITE TYPE                 S4258500
         BE    MBCENWAB            BRANCH IF NOT WAIT-A-BIT             S4259000
         LA    R1,MBSCSEQ+MCPUSEQ  RECONSTRUCT                          S4259500
         BAL   ML,MCCWINIT          CCW CHAIN                           S4260000
         EJECT                                                          S4260500
MBCENWAB TM    MDCTATTN,MDCTIMER   WAS A DELAY SETUP                    S4261000
         BO    *+8                 SKIP IF YES                          S4261500
         BAL   ML,MINITIO          SETUP NEXT I/O OPERATION             S4262000
         TM    MDCTSTAT,DCTPBUF    WAS OUTPUT POSTED                 R4 S4262500
         BZ    SKIP1350            SKIP IF YES                       R4 S4263000
         OI    MDCTSTAT,DCTPOST    INDICATE OUTPUT NOT POSTED        R4 S4263500
SKIP1350 TM    MDCTATTN,MDCTJOB    TEST IF JOB HAS BEEN POSTED          S4264000
         BZ    MBUFNEXT            BRANCH IF NO JOB POST             R4 S4264500
         NI    MDCTATTN,255-MDCTJOB     RESET JOB POST INDICATION       S4265000
         TM    DCTSTAT,DCTDRAIN    TEST LINE DCT STATUS                 S4267500
         BO    MBUFNEXT            BRANCH IF DRAINING                R4 S4268000
         TM    MDCTSTAT,DCTSOFF    TEST LINE DCT REMOTE STATUS          S4268500
         BO    MBUFNEXT            BRANCH IF SIGNING OFF             R4 S4269000
         SPACE 1                                                     R4 S4269500
MBCENEXT L     MDCT,MDCTDCT        GET ADDRESS OF NEXT REMOTE DCT       S4270000
         LTR   MDCT,MDCT           TEST FOR END OF CHAIN                S4270500
         BZ    MBUFNEXT            BRANCH IF END OF CHAIN            R4 S4271000
         CLI   DCTDEVTP,DCTRJR     TEST DEVICE TYPE                     S4271500
         BE    MBCENEXT            BRANCH IF REMOTE READER              S4272000
         TM    DCTSTAT,DCTINUSE+DCTDRAIN  TEST DEVICE STATUS            S4272500
         BNZ   MBCENEXT            BRANCH IF IN USE OR DRAINED          S4273000
         NI    DCTSTAT,255-DCTHOLD RESET HOLD BIT                       S4273500
         L     R1,DCTPCE           INDICATE UNIT                     R4 S4274000
        $POST  (R1),WORK            IS AVAILABLE                     R4 S4274500
         B     MBCENEXT            GET NEXT DCT                         S4275000
         SPACE 3                                                     R4 S4275500
MRSTRD   LA    R15,16*O            SET MASK FOR INPUT DELETE         R4 S4276000
         B     *+8                 ENTER COMMON CODE                    S4276500
         SPACE 1                                                     R4 S4277000
MRSTPP   LA    R15,16*Z            SET MASK FOR OUTPUT RESTART       R4 S4277500
         LR    R1,MDCT             PREPARE TO SCAN REMOTE DCT'S         S4278000
         SPACE 1                                                        S4278500
MRSTNEXT L     R1,MDCTDCT-DCTDSECT(R1)  GET ADDRESS OF NEXT REMOTE DCT  S4279000
         LTR   R1,R1               TEST FOR END OF CHAIN                S4279500
         BCR   Z,ML                RETURN IF END OF CHAIN               S4280000
         TM    DCTDEVTP-DCTDSECT(R1),DCTPRPU  TEST DEVICE TYPE       R4 S4280500
         EX    R15,MRSTBC          BRANCH IF NOT SELECTED TYPE       R4 S4281000
         OI    DCTFLAGS-DCTDSECT(R1),DCTRSTRT+DCTBKSP  RESTART JOB      S4281500
         B     MRSTNEXT            GET NEXT DCT                         S4282000
         SPACE 1                                                     R4 S4282500
MRSTBC   BC    *-*,MRSTNEXT        *** EXECUTE ONLY ***              R4 S4283000
         EJECT                                                          S4283500
MBCE27X0 L     R1,0(,WA)           GET DATA ADDRESS                     S4284000
         CLC   MSOHENQ,0(R1)       TEST FOR SOH-ENQ SEQUENCE            S4284500
         BE    MFORCERL            RESTART LINE IF SOH-ENQ              S4285000
         TM    5(WA),MWRITSEQ      TEST SEQUENCE TYPE                   S4285500
         BO    MBCEHDWR            BRANCH IF WRITE SEQUENCE             S4286000
         CLC   MBSCSTX,TPBUFST     TEST FIRST DATA BYTE                 S4286500
         BE    MBCEHDRD            BRANCH IF STX                        S4287000
         CLC   MDLESTX,TPBUFST     TEST FIRST TWO DATA BYTES            S4287500
         BE    MBCEHDRD            BRANCH IF DLE-STX                    S4288000
         CLC   MBSCENQ,TPBUFST     TEST FIRST DATA BYTE                 S4288500
         BE    MRETRY              BRANCH IF ENQ                        S4289000
         CLC   MBSCSOH,TPBUFST     TEST FIRST DATA BYTE                 S4289500
         BE    MBCENULL            BRANCH IF SOH                        S4290000
         B     MWRNAKL             INVALID DATA RECEIVED                S4290500
         SPACE 1                                                        S4291000
MBCEHDRD LA    R1,TPBUFST-1        COMPUTE                              S4291500
         AH    R1,6(,WA)            ADDRESS OF                          S4292000
         SH    R1,IOBCSW+5           LAST BYTE                          S4292500
         CLC   MBSCENQ,0(R1)       TEST LAST BYTE                       S4293000
         BE    MWRNAK              BRANCH IF ENQ                        S4293500
         ST    R1,BUFEWF           SAVE ADDRESS OF LAST DATA BYTE       S4294000
         NI    MDCTSTAT,255-DCTETX RESET ETX SWITCH                     S4294500
         CLC   MBSCETX,0(R1)       TEST TERMINATION BYTE                S4295000
         BNE   *+8                 BRANCH IF NOT ETX                    S4295500
         OI    MDCTSTAT,DCTETX     SET ETX SWITCH, NEXT EOT IS EOF      S4296000
         LH    R1,$BFSZBSC         GET                               R4 S4296500
         BCTR  R1,0                 MAXIMUM                          R4 S4297000
         BCTR  R1,0                  DATA LENGTH                     R4 S4297500
         CLC   MBSCDLE,TPBUFST     TEST FIRST DATA BYTE                 S4298000
         BNE   *+6                 BRANCH IF NOT DLE                    S4298500
         BCTR  R1,0                REDUCE MAXIMUM DATA LENGTH           S4299000
         CH    R1,IOBCSW+5         COMPARE WITH RESIDUAL LENGTH         S4299500
         BH    MNORMAL             BRANCH IF DATA PRESENT               S4300000
         SPACE 1                                                        S4300500
MBCENULL L     R1,IOBRESTR         SET UP                               S4301000
         ST    R1,IOBSTART          ADDRESS OF RESTART CCW              S4301500
         BAL   ML,MEXCPNXT         READ NEXT BLOCK                      S4302000
         B     MBUFNEXT            SEARCH FOR OTHER WORK             R4 S4302500
         EJECT                                                       R4 S4303000
MBCEHDWR CLC   MBSCDLE,LCBRCB      TEST FIRST CHARACTER OF RESPONSE     S4303500
         BNE   MBSCHNAK            BRANCH IF NOT DLE                    S4304000
         CLC   LCBACK,LCBRCB+1     TEST SECOND CHARACTER                S4304500
         BE    MNORMAL             BRANCH IF ACK WAS THE ONE EXPECTED   S4305000
         CLC   MBSCWACK,LCBRCB+1   TEST SECOND CHARACTER                S4305500
         BE    MWRENQ              BRANCH IF WACK                       S4306000
         CLI   MCOMMAND,MRREQCMD   TEST COMMAND TYPE                    S4306500
         BNE   MWRENQL             WRITE ENQUIRY IF NOT ALREADY WRITTEN S4307000
         IC    ML,LCBRCB+1         GET                               R4 S4307500
         X     ML,MBSCACKX-3-MCODSECT(,MCODE)  INVERTED ACK          R4 S4308000
         EX    ML,MBCEHTST         COMPARE INVERTED ACK              R4 S4308500
         BE    MRETRYL             BRANCH IF COUNT CHECK TO RETRY & LOG S4309000
         B     MWRENQL             INVALID RESPONSE, WRITE ENQ & LOG    S4309500
         SPACE 1                                                        S4310000
MBSCHNAK CLC   MBSCNAK,LCBRCB      TEST FOR NAK                         S4310500
         BNE   MBCEHENQ            BRANCH IF NOT NAK                    S4311000
         CLC   MBSCEOT,LCBRCB+1    TEST FOR PREVIOUS EOT                S4311500
         BE    MWRENQ              BRANCH IF YES                        S4312000
         CLI   MCOMMAND,MRREQCMD   TEST COMMAND TYPE                    S4312500
         BE    MRETRY              BRANCH IF RESPONSE TO ENQ            S4313000
         B     MRETRYL             OTHERWISE, LOG AND RETRY             S4313500
         SPACE 1                                                        S4314000
MBCEHENQ CLI   MCOMMAND,MRREQCMD   TEST COMMAND TYPE                    S4314500
         BE    MWRENQ              BRANCH IF RESPONSE TO ENQ            S4315000
         B     MWRENQL             OTHEWISE, WRITE ENQUIRY AND LOG      S4315500
         SPACE 1                                                     R4 S4316000
MBCEHTST CLI   LCBACK,*-*          *** EXECUTE ONLY ***              R4 S4316500
         EJECT                                                          S4317000
MBSCRWUE DS    0H                  PROCESS BSC UNIT EXCEPTION           S4317500
         CLI   0(WA),X'01'         TEST COMMAND TYPE                    S4318000
         BE    MRESTART            BRANCH IF WRITE COMMAND              S4318500
         SPACE 2                                                        S4319000
         TM    5(WA),MCPUSEQ       TEST SEQUENCE TYPE                   S4319500
         BNZ   MCWRNAKL            BRANCH IF PROGRAMMABLE INTERFACE  R4 S4320000
         SPACE 2                                                        S4320500
         CLC   MBSCEOT,LCBRCB+1    TEST FOR PREVIOUS EOT                S4321000
         BE    MRDTEST             BRANCH IF YES                        S4321500
         MVC   LCBACK,MBSCACK0     SET ACK0 RESPONSE                    S4322000
         CLC   MBSCWACK,LCBRCB+1   TEST LAST RESPONSE                   S4322500
         BE    *+10                BRANCH IF WACK                       S4323000
         MVC   LCBACK,MBSCACK1     SET ACK1 RESPONSE TO FORCE RETRY     S4323500
         MVC   LCBRCB+1(1),MBSCEOT INDICATE EOT RECEIVED                S4324000
MRDTEST  CLI   MCOMMAND,MRREQCMD   TEST COMMAND TYPE                    S4324500
         BE    MPPSUSPD            BRANCH IF READ RESPONSE TO ENQ       S4325000
         CLI   MCOMMAND,MRRSPCMD   TEST COMMAND TYPE                    S4325500
         BNE   METXTEST            BRANCH IF NOT READ RESPONSE          S4326000
MPPSUSPD DS    0H                  SUSPEND REMOTE OUTPUT DEVICES        S4326500
         LR    R1,MDCT             SEARCH REMOTE DCTS                   S4327000
         SPACE 1                                                        S4327500
MPPSRCH  L     R1,MDCTDCT-DCTDSECT(,R1)  GET ADDR OF NEXT RMT DCT       S4328000
         LTR   R1,R1               TEST FOR END OF CHAIN                S4328500
         BZ    MWRENQL             BRANCH IF END OF CHAIN               S4329000
         TM    DCTSTAT-DCTDSECT(R1),DCTINUSE  TEST DEVICE STATUS        S4329500
         BZ    MPPSRCH             BRANCH IF NOT IN USE                 S4330000
         TM    DCTPPFL-DCTDSECT(R1),DCTSUSPD  IS SUSPEND ALLOWED        S4330500
         BZ    MWRENQL             BRANCH IF NO                         S4331000
         OI    DCTFLAGS-DCTDSECT(R1),DCTRSTRT+DCTBKSP  SUSPEND          S4331500
         B     MWRENQL             GO LOG AND WRITE ENQ                 S4332000
         SPACE 2                                                        S4332500
METXTEST TM    MDCTSTAT,DCTETX     TEST FOR ETX                         S4333000
         BO    MREADEOT            BRANCH IF ETX, EOT IS REAL           S4333500
         SPACE 2                                                        S4334000
         MVC   LCBACK,MBSCACK0     SET RESPONSE                         S4334500
         MVC   LCBRCB,MACK0SEQ      TO ACK0                             S4335000
         B     MRDTXT                AND READ FOR ENQ                   S4335500
         EJECT                                                          S4336000
MBSCRWUC DS    0H                  PROCESS BSC UNIT CHECK               S4336500
         TM    IOBSENS0,X'40'      TEST SENSE BYTE                      S4337000
         BZ    MBUCNADS            BRANCH IF NOT INTV REQD              S4337500
         TM    MDCTLINE,DCTPNADS   SHOULD REMOTE BE DISCONNECTED        S4338000
         BZ    MFORCERL            IF YES, LOG AND RESTART LINE         S4338500
         B     MBINTREQ            ELSE PROCESS INTV REQD               S4339000
MBUCNADS DS    0H                  *                                    S4339500
         CLI   MCOMMAND,MENBCMD    TEST COMMAND TYPE                    S4340000
         BE    MBINTREQ            BRANCH IF ENABLE                     S4340500
         SPACE 2                                                     R4 S4341000
         TM    5(WA),MCPUSEQ       TEST SEQUENCE TYPE                   S4341500
         BZ    MBUCHDWR            BRANCH IF NOT PROGRAMMABLE INTERFACE S4342000
         SPACE 3                                                        S4342500
MCWRNAKL BAL   ML,MCERRLOG         LOG ERROR                            S4343000
         TM    MDCTLINE,DCTPCTC    THIS FOR CTCA                     R4 S4343500
         BO    MRSTLINE            RESTART LINE IF YES               R4 S4344000
         LA    R0,IOBCCW2          RECONSTRUCT                          S4344500
         LA    R1,MBSCSEQ+MCPUSEQ   CCW                                 S4345000
         BAL   ML,MCCWINIT           CHAIN                              S4345500
         CLI   TPBRECNT,C'E'       TEST INPUT BUFFER STATUS             S4346000
         BE    MWRNAK              BR IF INPUT BUFFER IS EMPTY          S4346500
         SPACE 2                                                        S4347000
         LA    R1,IOBCCW7          NO, USE CCW AREA                     S4347500
         ST    R1,IOBCCW4          SET ADDRESS OF READ CCW              S4348000
         MVI   IOBCCW4,X'02'       SET READ CCW                         S4348500
         MVC   IOBCCW4+5(3),MWABTSEQ    SET COMMAND TYPE AND BYTE COUNT S4349000
         B     MWRNAK              WRITE NAK                            S4349500
         SPACE 3                                                        S4350000
MBUCHDWR LA    R1,MBUCTAB-4        PREPARE TO SCAN UNIT CHECK TABLE  R4 S4350500
         SPACE 3                                                        S4351000
MBUCSRCH LA    R1,4(,R1)           ADVANCE TO NEXT ENTRY                S4351500
         CLC   0(1,R1),MCOMMAND    TEST COMMAND TYPE                 R4 S4352000
         BL    MBUCSRCH            BRANCH IF TABLE ENTRY IS LOW         S4352500
         BNE   MFORCERL            BRANCH IF CONDITION IS NOT IN TABLE  S4353000
         SPACE 2                                                     R4 S4353500
         IC    ML,1(,R1)           GET SENSE MASK                    R4 S4354000
         EX    ML,MBUCSENS         TEST SENSE BITS                   R4 S4354500
         BZ    MBUCSRCH            BRANCH IF ALL SELECTED BITS ARE OFF  S4355000
         SPACE 2                                                     R4 S4355500
         LH    R1,2(R1)            LOAD ERROR SEQUENCE DISPLACEMENT     S4356000
         B     0(R1,MBASE1)        BRANCH TO ERROR SEQUENCE          R4 S4356500
         SPACE 1                                                     R4 S4357000
MBUCSENS TM    IOBSENS0,*-*        *** EXECUTE ONLY ***              R4 S4357500
         EJECT                                                       R4 S4358000
MBUCTAB  DS    0H             BSC UNIT CHECK ERROR SEQUENCE TABLE       S4358500
*                                  READ           LD/TO                 S4359000
         DC    AL1(MREADCMD),X'03',Y(MRDTXT-MBSCPROC)                R4 S4359500
*                                  READ           BO/DC/OR              S4360000
         DC    AL1(MREADCMD),X'2C',Y(MWRNAKL-MBSCPROC)               R4 S4360500
*                                  READ RESPONSE  BO/DC/OR/LD/TO        S4361000
         DC    AL1(MRRSPCMD),X'2F',Y(MWRENQL-MBSCPROC)               R4 S4361500
*                                  RD RSP TO ENQ  BO/DC/OR/LD/TO        S4362000
         DC    AL1(MRREQCMD),X'2F',Y(MWRENQL-MBSCPROC)               R4 S4362500
*                                  WRITE          BO                    S4363000
         DC    AL1(MWRITCMD),X'20',Y(MWRENQL-MBSCPROC)               R4 S4363500
*                                  WRITE RESPONSE BO                    S4364000
         DC    AL1(MWRSPCMD),X'20',Y(MRESTART-MBSCPROC)              R4 S4364500
*                                  WRITE ENQUIRY  BO                    S4365000
         DC    AL1(MWENQCMD),X'20',Y(MWRENQL-MBSCPROC)               R4 S4365500
         DC    X'FF'          END OF TABLE                              S4366000
         SPACE 10                                                       S4366500
MWRENQL  BAL   ML,MCERRLOG         LOG ERROR                            S4367000
         B     MWRENQ              WRITE ENQUIRY                        S4367500
         SPACE 5                                                        S4368000
MRDTXT   BAL   ML,MCERRLOG         LOG ERROR                            S4368500
         LA    R1,IOBCCW4          GET ADDRESS OF READ TEXT             S4369000
         B     MNEWSTRT            INITIATE I/O                         S4369500
         EJECT                                                          S4370000
MBSCPUST DS    0H                                                    R4 S4370500
         OI    DCTFLAGS,DCTRSTRT   ABORT ANY SIGNON ATTEMPT          R4 S4371000
         BAL   ML,MABORT           ABORT ACTIVE FUNCTIONS            R4 S4371500
MBSCPUSA XC    MDCTRSEQ(2),MDCTRSEQ  INIT BLOCK SEQUENCE COUNTS      R4 S4372000
         MVC   MDCTFCS(2),MBASEFCS    AND FUNCTION CONTROL SEQUENCE  R4 S4372500
         MVC   LCBRCB,MACK0SEQ     SET UP ACK0 RESPONSE                 S4373000
         LA    R0,IOBCCW2          SET UP                               S4373500
         TM    MDCTLINE,DCTPCTC     BEGINNING AT CCW2                R4 S4374000
         BZ    SKIP1360             OR, IF CTCA,                     R4 S4374500
         LA    R0,IOBCCW1           CCW1 THE                         R4 S4375000
SKIP1360 LA    R1,MBSCSEQ+MCPUSEQ   BSC CPU                             S4375500
         BAL   ML,MCCWINIT           CCW STRING                         S4376000
         B     MRETRY              READ SIGN-ON RECORD                  S4376500
         SPACE 3                                                        S4377000
MRESTART LR    R1,WA               RESTART CCW STRING WITH READ CCW     S4377500
         SPACE 1                                                        S4378000
MRSTLOOP LA    R1,8(,R1)           GET NEXT CCW                         S4378500
         CLI   0(R1),X'08'         TEST COMMAND CODE                    S4379000
         BNE   *+8                 BRANCH IF NOT TIC                    S4379500
         L     R1,0(,R1)           SIMULATE TIC                         S4380000
         CLI   0(R1),X'02'         TEST COMMAND CODE                    S4380500
         BE    MNEWSTRT            BRANCH IF READ                       S4381000
         B     MRSTLOOP            GET NEXT CCW                         S4381500
         SPACE 3                                                        S4382000
MWRNAKL  BAL   ML,MCERRLOG         LOG ERROR                            S4382500
         SPACE 1                                                        S4383000
MWRNAK   MVC   LCBRCB,MNAKSEQ      SET UP NAK RESPONSE                  S4383500
         SPACE 1                                                        S4384000
MWRENQ   LA    R1,IOBCCW2          GET ADDRESS OF WRITE RESP/ENQ CCW    S4384500
         TM    MDCTLINE,DCTPCTC    TEST LINE TYPE                    R4 S4385000
         BZ    MNEWSTRT            GO WRITE NAK/ENQ IF NOT CTCA      R4 S4385500
         LA    R1,IOBCCW1          START AT CCW1 FOR CTCA            R4 S4386000
         B     MNEWSTRT            WRITE NAK RESPONSE                   S4386500
         SPACE 3                                                        S4387000
MBINTREQ BAL   ML,MCERRLOG         LOG INTERVENTION REQUIRED            S4387500
         MVC   LCBRCB,MNAKSEQ      SET UP NAK RESPONSE                  S4388000
         LA    R1,IOBCCW1          GET ADDRESS OF ENABLE                S4388500
         B     MNEWSTRT            RESTART WITH ENABLE                  S4389000
         SPACE 3                                                     R4 S4389500
MSTARTRD L     WA,MDCTDCT          GET ADDRESS OF FIRST REMOTE DCT      S4390000
         LTR   WA,WA               TEST                                 S4390500
         BZ    MSONOPEN            BRANCH IF REMOTE HAS NOT SIGNED ON   S4391000
         MVI   IOBCCW5,X'01'              SET WRITE COMMAND          R4 S4391500
         OI    IOBCCW5+3,MBSCEOT-MBSCENQ  FORCE WRITE EOT            R4 S4392000
         BAL   ML,MSTUNIT                 ATTEMPT TO START RDR       R4 S4392500
         B     MRETRY                     SEND EOT IF FAILED         R4 S4393000
         EJECT                                                       R4 S4393500
MSTARTPP CLI   IOBCCW5,X'01'       TEST COMMAND TYPE                    S4394000
         BNE   *+8                 BRANCH IF NOT WRITE                  S4394500
         OI    IOBCCW5+3,MBSCEOT-MBSCENQ     FORCE WRITE EOT            S4395000
         TM    MDCTATTN,MDCTJOB    TEST FOR JOB POST                 R4 S4395500
         BZ    MRETRY              RETRY COMMAND IF NOT              R4 S4396000
         SPACE 1                                                     R4 S4396500
         L     WA,MDCTDCT          GET ADDRESS OF FIRST REMOTE DCT      S4397000
         LTR   WA,WA               TEST                                 S4397500
         BZ    MSTARTNO            BRANCH IF REMOTE NOT SIGNED ON    R4 S4398000
         TM    MDCTFMT-DCTDSECT(WA),DCTPROG  PROG-INTERFACE..  @OZ44902 S4398010
         BO    MFORCERL             YES-LOG ERROR & RESTART    @OZ44902 S4398020
         SPACE 2                                                     R4 S4398500
         L     WA,MDCTDCT-DCTDSECT(,WA) GET ADDRESS OF PRINTER DCT      S4399000
         TM    DCTPPSW-DCTDSECT(WA),DCTPPSWS      TEST STATUS           S4399500
         BO    MSTARTPU            BRANCH IF SEPARATOR PAGE SUPPRESSED  S4400000
         SPACE 1                                                     R4 S4400500
         SLR   R15,R15                     CLEAR R15           @OZ45379 S4401000
         L     R1,MDCTRAT                   POINT TO RAT       @OZ45379 S4401500
         IC    R15,RATCONRT+1-RATDSECT(,R1)  MULTIPLY RMT NUM  @OZ45379 S4401600
         LA    R1,0(R15,R15)               BY                        R4 S4402000
         ALR   R1,R15                       THREE                    R4 S4402500
         AL    R1,$MSPOOLQ         ADD ADDRESS OF REMOTE MSG QUEUES  R4 S4403000
         CLC   1(1,R1),0(R1)       COMPARE RECORD NUMBERS               S4403500
         BE    MSTARTPU            NO MESSAGES QUEUED IF EQUAL          S4404000
         BAL   ML,MSTUNIT          ATTEMPT TO START REMOTE PRINTER      S4404500
         SPACE 1                                                        S4405000
MSTARTPU L     WA,MDCTDCT-DCTDSECT(,WA)  GET ADDRESS OF PUNCH DCT    R4 S4405500
         LTR   WA,WA               IS THERE A PUNCH DCT                 S4406000
         BZ    MSTARTPR            BRANCH IF NO                         S4406500
        $#GET  DCT=(WA),HAVE=NO    TEST FOR JOB TO PUNCH                S4407000
         BZ    *+8                 BRANCH IF NO JOB QUEUED FOR PUNCH    S4407500
         BAL   ML,MSTUNIT          ATTEMPT TO START REMOTE PUNCH        S4408000
         SPACE 1                                                     R4 S4408500
MSTARTPR L     WA,MDCTDCT          GET ADDRESS OF FIRST REMOTE DCT      S4409000
         L     WA,MDCTDCT-DCTDSECT(,WA) GET ADDRESS OF PRINTER DCT      S4409500
        $#GET  DCT=(WA),HAVE=NO    TEST FOR JOB TO PRINT                S4410000
         BZ    *+8                 BRANCH IF NO JOB QUEUED FOR PRINT    S4410500
         BAL   ML,MSTUNIT          ATTEMPT TO START REMOTE PRINTER      S4411000
         SPACE 1                                                     R4 S4411500
MSTARTNO NI    MDCTATTN,255-MDCTJOB     RESET JOB POST INDICATOR     R4 S4412000
         B     MRETRY                    AND RETRY COMMAND           R4 S4412500
         EJECT                                                       R4 S4413000
MSTUNIT  TM    DCTSTAT-DCTDSECT(WA),DCTINUSE+DCTDRAIN  TEST STATUS      S4413500
         BCR   NZ,ML               RETURN IF DEVICE IS DRAINED          S4414000
         ST    MBUF,DCTBUFAD-DCTDSECT(,WA)   SET BUFFER ADDRESS         S4414500
         NI    DCTSTAT-DCTDSECT(WA),255-DCTHOLD  MAKE DEVICE AVAILABLE  S4415000
         L     R1,DCTPCE-DCTDSECT(,WA)  INDICATE UNIT                R4 S4415500
        $POST  (R1),WORK                 IS AVAILABLE                R4 S4416000
         OI    MDCTATTN,MDCTIMER   INDICATE LINE PAUSE               R4 S4416500
         OI    MSTQE+IPOST,X'20'    AND TIMER ACTION REQ             R4 S4417000
         B     MBUFNEXT            SEARCH FOR OTHER WORK             R4 S4417500
         SPACE 1                                                     R4 S4418000
MNORMAL  LA    R1,TPBUFST          INITIALIZE ADDRESSES OF              S4418500
         STCM  R1,7,TPBLCCAD+1      FIRST CARRIAGE CONTROL     @OZ42674 S4419000
         ST    R1,TPBFDATA           AND FIRST DATA BYTE                S4419500
         MVC   MDCTIMOK,MCLOCK     SET TIME OF TEXT TRANSMISSION        S4420000
         SPACE 1                                                        S4420500
MREADEOT MVC   BUFECBCC,IOBECBCC   SET COMPLETION CODE                  S4421000
         MVC   IOBSTART,IOBRESTR   RESET ADDRESS OF FIRST CCW           S4421500
         SLR   ML,ML               INITIALIZE $POST SWITCH           R4 S4422000
         LR    R1,MDCT             PREPARE TO SEARCH REMOTE DCT'S       S4422500
         SPACE 1                                                        S4423000
MPOST    L     R1,MDCTDCT-DCTDSECT(R1)  GET NEXT REMOTE DCT             S4423500
         LTR   R1,R1               TEST FOR END OF CHAIN                S4424000
         BNZ   MPOSTACT            BR IF NO                          R4 S4424500
         LTR   ML,ML                ELSE TEST $POST SWITCH           R4 S4425000
         BZ    MSONGET             BRANCH IF REMOTE IS NOT SIGNED ON    S4425500
         B     MBUFNEXT            BRANCH IF REMOTE IS SIGNED ON     R4 S4426000
         SPACE 1                                                     R4 S4426500
MPOSTACT TM    DCTSTAT-DCTDSECT(R1),DCTINUSE  TEST DCT STATUS        R4 S4427000
         BZ    MPOST               BRANCH IF DCT IS NOT IN USE          S4427500
         L     ML,DCTPCE-DCTDSECT(,R1)  GET PCE ADDR, SET $POST SW   R4 S4428000
        $POST  (ML),WORK           FIRE UP PROCESSOR                 R4 S4428500
         B     MPOST               PROCESS REST OF DCT CHAIN            S4429000
         EJECT                                                       R4 S4429500
MRETRYL  BAL   ML,MCERRLOG         LOG ERROR                            S4430000
         SPACE 1                                                        S4430500
MRETRY   L     R1,IOBRESTR         SET UP REGISTER FOR RETRY            S4431000
         SPACE 1                                                        S4431500
MNEWSTRT ST    R1,IOBSTART         SET ADDRESS OF RESTART CCW           S4432000
         BAL   ML,MERREXCP         INITIATE I/O                         S4432500
         B     MBUFNEXT            SEARCH FOR OTHER WORK             R4 S4433000
         SPACE 2                                                        S4433500
MCOMMREJ CLI   MCOMMAND,MDISCMD    TEST COMMAND TYPE                    S4434000
         BNE   MFORCERL            BRANCH IF NOT DISABLE COMMAND        S4434500
         SPACE 1                                                        S4435000
MDRAINLN CLI   IOBECBCC,X'48'      WAS I/O PURGED                       S4435500
         BE    MRSTLINE            RESTART LINE IF YES              R41 S4436000
         CLI   IOBECBCC,X'44'      TEST FOR INTERCEPT          @OZ50711 S4436100
         BNE   MNOTCTC             BRANCH IF NOT               @OZ50711 S4436110
         TM    MDCTLINE,DCTPCTC    TEST FOR CTC                @OZ50711 S4436120
         BZ    MRSTLINE            BRANCH IF NOT               @OZ50711 S4436130
         TM    IOBCSW+3,X'90'      TEST FOR BUSY/ATTENTION     @OZ50711 S4436140
         BNO   MRSTLINE            BRANCH IF NOT               @OZ50711 S4436150
         NI    IOBSIOCC,X'30'      ISOLATE SIO CONDITION CODE  @OZ50711 S4436160
         CLI   IOBSIOCC,X'10'      TEST FOR CONDITON CODE = 1  @OZ50711 S4436170
         BNE   MRSTLINE            BRANCH IF NOT               @OZ50711 S4436180
         CLI   0(WA),X'14'         TEST FOR SENSE CMD          @OZ50711 S4436190
         BNE   MRSTLINE            BRANCH IF NOT               @OZ50711 S4436200
         B     MRETRY              ELSE, RETRY I/O             @OZ50711 S4436210
         SPACE 1                                               @OZ50711 S4436220
MNOTCTC  OI    DCTSTAT,DCTDRAIN    SET DRAIN FLAG              @OZ50711 S4436500
         SPACE 1                                                        S4437000
MFORCERL $QSUSE TYPE=TEST          TEST STATUS OF SHARED QUES  @OZ41592 S4437500
         BNZ   MREQBUF             IF NOT OWNED, REQUE BUFFER  @OZ41592 S4437600
         BAL   ML,MCERRLOG         LOG DISASTEROUS LINE ERROR  @OZ41592 S4437700
         B     MRSTABOR            GO ABORT ACTIVE FUNCTIONS   @OZ41592 S4437800
         SPACE 1                                                        S4438000
MRSTLINE $QSUSE TYPE=TEST          TEST STATUS OF SHARED QUES  @OZ32567 S4438500
         BNZ   MREQBUF             IF NOT OWNED, REQUEUE BFR   @OZ32567 S4438600
MRSTABOR BAL   ML,MABORT           ABORT ALL ACTIVE FUNCTIONS  @OZ41592 S4438700
         B     MSFORCE             FORCE SIGN-OFF                       S4439000
         EJECT                                                          S4439500
*                                                                       S4440000
*                             CHANNEL END LOGGING SUBROUTINE            S4440500
*                                                                       S4441000
         SPACE 3                                                        S4441500
MCERRLOG LA    R1,MDCTSREM         SET FOR NON-SPECIFIC COUNT           S4442000
         CLI   0(WA),X'02'         WAS LAST COMMAND A READ              S4442500
         BNE   MCERRINC            BRANCH IF NO                         S4443000
         TM    IOBCSW+3,X'02'      TEST UNIT STATUS                     S4443500
         BO    MCERRUC             BRANCH IF UNIT CHECK                 S4444000
         TM    5(WA),MWRITSEQ      DID WE WRITE TEXT                    S4444500
         BZ    MCERRINC            BRANCH IF NO                         S4445000
         L     R15,0(,WA)          GET READ DATA ADDRESS                S4445500
         CLC   MBSCNAK,0(R15)      WAS RESPONSE A NAK                   S4446000
         BE    SKIP1370            SKIP IF YES                       R4 S4446500
         CLC   MNAKSEQ,0(R15)      WAS RESPONSE A CTCA NAK           R4 S4447000
         BNE   MCERRINC            BRANCH IF NO                         S4447500
SKIP1370 LA    R1,MDCTSNAK         SET FOR NAK COUNT                    S4448000
         B     MCERRINC            GO COUNT ERROR                       S4448500
MCERRUC  CLI   MCOMMAND,MREADCMD   DID WE READ TEXT                     S4449000
         BNE   MCERRINC            BRANCH IF NO                         S4449500
         TM    IOBSENS0,X'08'      DATA CHECK SENSE                     S4450000
         BZ    *+8                 SKIP IF NO                           S4450500
         LA    R1,MDCTSDCK         SET FOR DATA CHECK COUNT             S4451000
         TM    IOBSENS0,X'01'      TIMEOUT SENSE                        S4451500
         BZ    MCERRINC            BRANCH IF NO                         S4452000
         LA    R1,MDCTSTO          SET FOR TIMEOUT COUNT                S4452500
MCERRINC L     R0,0(,R1)           INCREMENT                            S4453000
         AL    R0,=F'1'             APPROPRIATE                         S4453500
         ST    R0,0(,R1)             ERROR COUNT                        S4454000
         SPACE 2                                                        S4454500
         TM    IOBCSW+3,X'02'      TEST UNIT STATUS                     S4455000
         BZ    MCELOG              BRANCH IF NO UNIT CHECK              S4455500
         TM    IOBSENS0,X'41'      TEST FIRST SENSE BYTE                S4456000
         BZ    MCELOG              BRANCH IF NOT TIMEOUT OR INT REQ     S4456500
         IC    R1,MDCTERCT         INCREMENT                            S4457000
         LA    R1,1(R1)             ERROR                               S4457500
         STC   R1,MDCTERCT           COUNT                              S4458000
         CLI   MDCTERCT,10         COMPARE ERROR COUNT WITH MAXIMUM     S4458500
         BCR   L,ML                DO NOT LOG UNTIL MAXIMUM COUNT       S4459000
         SPACE 2                                                        S4459500
MCELOG   MVI   MDCTERCT,0          RESET ERROR COUNT                    S4460000
         CLI   0(WA),X'02'         TEST COMMAND CODE                    S4460500
         BNE   MCEGOLOG            BRANCH IF NOT READ                   S4461000
         SPACE 1                                                        S4461500
         L     R1,0(WA)            GET ADDRESS OF READ AREA             S4462000
         MVC   IOBSENS1,1(R1)      MOVE RESPONSE TO SECOND SENSE BYTE   S4462500
         CLC   MBSCDLE,0(R1)       TEST RESPONSE LENGTH                 S4463000
         BE    MCEGOLOG            BRANCH IF TWO BYTE RESPONSE          S4463500
         MVC   IOBSENS1,0(R1)      MOVE RESPONSE TO SECOND SENSE BYTE   S4464000
         EJECT                                                       R4 S4464500
MCEGOLOG DS    0H                                                    R4 S4465000
        $IOERROR (MBUF)            LOG CHANNEL END                      S4465500
         BR    ML                  RETURN                               S4466000
         TITLE 'HASP LINE MANAGER -- SIGN-ON PROCESSING'             R4 S4467500
MSONOPEN DS    0H                                                    R4 S4468000
         TM    MSEQTYPE,MCPUSEQ    IS THIS MULTILEAVING        @OZ56977 S4468100
         BNZ   MFORCERL             YES,  ERROR CONDITION      @OZ56977 S4468300
         OI    DCTFLAGS,DCTRSTRT   ABORT ANY SIGNON ATTEMPT          R4 S4468500
         BAL   ML,MABORT           ABORT ACTIVE FUNCTIONS            R4 S4469000
         ST    MBUF,MSONDCTB       SET BUFFER ADDRESS,               R4 S4469500
         LA    MDCT,0(,MDCT)        LINE DCT ADDRESS,                R4 S4470000
         ST    MDCT,MSONDCTD         AND REMOTE READER DEVICE TYPE   R4 S4470500
         MVI   MSONDCTV,DCTRJR        IN DUMMY REMOTE DCT            R4 S4471000
         LA    R1,MSONDCT          GET ADDRESS OF DUMMY DCT          R4 S4471500
        $EXTP  OPEN,(R1)           INITIATE READ OF SIGN-ON CARD     R4 S4472000
         B     MBUFNEXT            SEARCH FOR OTHER WORK             R4 S4472500
         SPACE 3                                                     R4 S4473000
MSONGET  ST    MBUF,MSONDCTB       SET BUFFER ADDRESS,               R4 S4473500
         LA    MDCT,0(,MDCT)        LINE DCT ADDRESS,                R4 S4474000
         ST    MDCT,MSONDCTD         REMOTE READER DEVICE TYPE,      R4 S4474500
         MVI   MSONDCTV,DCTRJR        AND BASIC TERMINAL CODE        R4 S4475000
         MVI   MSONDCTT,DCTP2770       IN DUMMY REMOTE DCT           R4 S4475500
         ST    MBUF,BUFEWF         FORCE EMPTY BUFFER AFTER ONE CARD R4 S4476000
         LA    R1,MSONDCT          GET ADDRESS OF DUMMY DCT          R4 S4476500
        $EXTP  GET,(R1),MSONCARD   GET FIRST CARD IN BUFFER          R4 S4477000
         BNP   MSONCLOS            CLOSE IF END OF FILE              R4 S4477500
         SPACE 2                                                     R4 S4478000
         CLC   MSONCODE,MSONCARD   TEST FOR /*SIGNON CARD            R4 S4478500
         BE    MBUFNEXT            BRANCH IF /*SIGNON CARD           R4 S4479000
         BAL   ML,MSOILEGL         NO, ISSUE ERROR MESSAGE           R4 S4479500
         B     MBUFNEXT            SEARCH FOR OTHER WORK             R4 S4480000
         SPACE 3                                                     R4 S4480500
MSONCLOS LA    R1,MSONDCT          GET ADDRESS OF DUMMY DCT          R4 S4481000
        $EXTP  CLOSE,(R1)          SET UP PREPARE SEQUENCE           R4 S4481500
         B     MBUFNEXT            SEARCH FOR OTHER WORK             R4 S4482000
         TITLE 'HASP LINE MANAGER -- DRAIN/SIGN-OFF PROCESSING'      R4 S4485500
MSIGNOFF TM    DCTSTAT,DCTDRAIN    TEST LINE DCT STATUS              R4 S4486000
         BO    MDRAINED            BRANCH IF DRAINED                 R4 S4486500
         TM    MDCTSTAT,DCTSOFF    TEST LINE DCT REMOTE STATUS       R4 S4487000
         BCR   Z,ML                RETURN IF NOT SIGN-OFF            R4 S4487500
         SPACE 2                                                     R4 S4488000
MDRAINED OI    DCTFLAGS,DCTRSTRT   SET LINE RESTART AFTER NEXT CE    R4 S4488500
         NI    MDCTSTAT,255-DCTSOFF  RESET SIGNOFF BIT               R4 S4489000
         TM    5(WA),MCPUSEQ       IS IT A MULTI-LEAVING TERMINAL    R4 S4489500
         BO    MDISCPU             BRANCH IF YES                     R4 S4490000
         TM    5(WA),MPREPSEQ      ARE PREPARE CCWS SETUP            R4 S4490500
         BZ    MRSTLINE            IF NOT, GO ABORT AND DISCONNECT   R4 S4491000
         TM    MDCTLINE,DCTPCTC    TEST LINE TYPE                    R4 S4491500
         BO    MSFORCE             FORCE DISCONNECT IF CTC           R4 S4492000
         LA    R0,MDLEEOT          POINT IOBCCW5 TO THE              R4 S4492500
         ST    R0,IOBCCW5           DISCONNECT SEQUENCE, DLE EOT     R4 S4493000
         MVI   IOBCCW5,X'01'       FORCE A WRITE                     R4 S4493500
         MVI   IOBCCW5+7,2         SET LENGTH OF TWO                 R4 S4494000
         MVI   IOBCCW6,X'2F'       CHANGE IOBCCW6 TO DISABLE         R4 S4494500
         LA    R0,IOBCCW4          START WITH IOBCCW4                R4 S4495000
         CLI   MDCTIMOK,255        WAS MODEM ON HOOK                R41 S4495100
         BNE   MDISEXCP            NO, GO WRITE EOT AND DISABLE     R41 S4495200
         LA    R0,IOBCCW6          YES, JUST DISABLE                R41 S4495300
         B     MDISEXCP            GO SET STARTING CCW               R4 S4495500
         SPACE 1                                                     R4 S4496000
MDISCPU  LA    R0,IOBCCW5          RECONSTRUCT                       R4 S4496500
         LA    R1,MBSCSEQ+MCPUSEQ   CCW                              R4 S4497000
         BAL   ML,MCCWINIT           CHAIN                           R4 S4497500
         LA    R0,TPBUFST          POINT TO IOBCCW6                  R4 S4498000
         STCM  R0,7,IOBCCW6+1       TO TPBUFST                       R4 S4498500
         LA    R0,L'MCDISCON+2     SET LENGTH OF                     R4 S4499000
         STH   R0,IOBCCW6+6         DISCONNECT MESSAGE PLUS TWO      R4 S4499500
         MVC   TPBUFST(2),MSTXSEQ  START BUFFER WITH STX SEQUENCE    R4 S4500000
         MVC   TPBUFST+2(L'MCDISCON),MCDISCON  ADD DISCON MESSAGE    R4 S4500500
         MVI   IOBCCW8,X'2F'       CHANGE IOBCCW8 TO DISABLE         R4 S4501000
         TM    MDCTLINE,DCTPCTC    TEST LINE TYPE                    R4 S4501500
         BZ    SKIP1380            SKIP IF NOT CTCA                  R4 S4502000
         MVI   IOBCCW8,X'02'       SET TO READ RESPONSE              R4 S4502500
SKIP1380 LA    R0,IOBCCW5          START WITH IOBCCW5                R4 S4503000
MDISEXCP ST    R0,IOBSTART         STORE CCW ADDRESS IN IOBSTART     R4 S4503500
         BAL   ML,MEXCP1           GO DO EXCP                        R4 S4504000
         B     MBUFNEXT            SEARCH FOR OTHER WORK             R4 S4504500
         SPACE 2                                                     R4 S4505000
MSFORCE  BAL   ML,MDISCON          DISCONNECT REMOTE                 R4 S4505500
         NI    MDCTSTAT,255-DCTSOFF RESET SIGN-OFF INDICATION        R4 S4506000
         LA    WA,MBUFNEXT         SET UP RETURN ADDRESS             R4 S4506500
         TM    DCTSTAT,DCTDRAIN    TEST LINE DCT STATUS              R4 S4507000
         BZ    MBSCINIT            REINITIALIZE IF NOT DRAINED       R4 S4507500
         B     MBSCSTOP            BRANCH TO DRAIN LINE DCT          R4 S4508000
         SPACE 2                                                    R41 S4508100
         DROP  MDCT,MCODE          RELEASE DCT AND CODE TABLE BASES R41 S4508200
         SPACE 2                                                    R41 S4508500
         DROP  MBASE1,MBASE2,MBASE3  RELEASE ROUTINES               R41 S4509000
         DROP  MBUF                   AND BUFFER ADDRESSABILITY     R41 S4509100
         SPACE 2                                                     R4 S4509500
         LTORG                                                       R4 S4510000
         TITLE 'HASP LINE MANAGER -- VTAM INTERFACE/REQ END PROCESSOR'  S4510500
*********************************************************************** S4510600
*                                                                     * S4510700
*                  SNA BUFFER PROCESSING ROUTINE                      * S4510800
*                                                                     * S4510900
*********************************************************************** S4511000
         SPACE 1                                                    R41 S4511100
*                                  ADDRESSABILITY -                 R41 S4511200
         USING ICEDSECT,MICE             ICE                        R41 S4511300
         USING RPLDSECT,MBUF             BUFFER (RPL)               R41 S4511400
         USING RTAMVSUB,MBASE2,MBASE3    COMMON SNA SUBROUTINE      R41 S4512000
         USING MSNAPROC,MBASE1           LOCAL ROUTINE BASE         R41 S4512500
         SPACE 2                                                    R41 S4513000
MSNAPROC DS    0H                                                   R41 S4513100
         L     MDCT,RPLDCT         GET LINE OR LOGON DCT ADDRESS     R4 S4514000
         USING DCTDSECT,MDCT        SHOW DCT ADDRESSABLE            R41 S4514100
         NI    MFLAGS,255-MLOGGED-MWRKFLG1  CLEAR BUF HANDLING FLAGS R4 S4514500
         TM    RPLSEQTP,255-VSEQRSET  TEST FOR RECEIVE ANY REQUEST   R4 S4515000
         BNZ   MSNAPNRA               SKIP CHAIN MAINTENANCE IF NOT  R4 S4515500
         LR    R15,MDCT            R15=LOGON DCT FOR MVFRECHK LATER  R4 S4516000
         L     MICE,RPLICE         LOAD ICE ADDRESS            @OZ48702 S4516050
         CLI   RPLACTIV,X'40'      HAS RPL BEEN REQUEUED...    @OZ48702 S4516100
         BNE   SKIP1385            NOT REQUEUE, CONTINUE       @OZ48702 S4516200
         LTR   MICE,MICE           CHECK FOR AN ICE ADDRESS    @OZ48702 S4516210
         BZ    MSNAPLT3            NO ICE, CONTINUE            @OZ48702 S4516220
         L     R14,ICELDCT         CHECK FOR LINE DCT PTR      @OZ48702 S4516230
         LTR   R14,R14                                         @OZ48702 S4516240
         BZ    MSNAPLT3            NO LINE, CONTINUE           @OZ48702 S4516250
         LR    MDCT,R14            SAVE LINE DCT POINTER       @OZ48702 S4516260
         STCM  MDCT,7,RPLDCT+1       FOR RPL'S OWNER           @OZ48702 S4516270
         B     MSNAPLT3                                        @OZ48702 S4516280
SKIP1385 DS    0H                                              @OZ48702 S4516290
         CLI   RPLRTNCD,USFRESSU   TEST COMPLETION RETURN CODE       R4 S4516500
         BNE   SKIP1390            IF NOT RETRYING, TAKE OFF R-A QUE R4 S4517000
         CLI   RPLERROR,254        TEST RETRY COUNT VS. LIMIT        R4 S4517500
*                                  THIS LINE DELETED BY APAR   @OZ48702 S4517978
         BL    MSNAPLT2            LEAVE ON R-A QUE IF REQUEST RETRY R4 S4518000
SKIP1390 L     ML,RPLBCHN          GET RCV-ANY BACKWRD-CHAIN POINTER R4 S4518500
         L     WA,RPLFCHN          GET RCV-ANY FORWARD-CHAIN POINTER R4 S4519000
         LTR   ML,ML               TEST BACKWARD-CHAIN POINTER       R4 S4519500
         BNZ   MSNAPRA1            SKIP LOGON DCT UPDATE IF NOT ZERO R4 S4520000
         L     R0,MDCTRABF         GET RCVE-ANY QE HEAD & ACTIVE CNT R4 S4520500
SKIP1400 LR    R1,R0               COPY DATA TO WORK REG             R4 S4521000
         ICM   R1,7,RPLFCHN+1      SET NEW QE HEAD, DON'T CHGE COUNT R4 S4521500
         CS    R0,R1,MDCTRABF      UPDATE RCVE-ANY QE HEAD           R4 S4522000
         BE    MSNAPRA2            CONTINUE IF UPDATE SUCCESSFUL     R4 S4522500
         B     SKIP1400            ELSE RETRY WITH NEW ACTIVE COUNT  R4 S4523000
         SPACE 1                                                     R4 S4523500
MSNAPRA1 ST    WA,RPLFCHN-RPLDSECT(,ML)  TAKE BUF OFF FORWARD CHAIN  R4 S4524000
MSNAPRA2 LTR   WA,WA               TEST FORWARD-CHAIN POINTER        R4 S4524500
         BZ    SKIP1410            SKIP BACK-CHN UPDATE IF AT Q END  R4 S4525000
         ST    ML,RPLBCHN-RPLDSECT(,WA)  TAKE BUF OFF BACKWARD CHAIN R4 S4525500
SKIP1410 LR    MICE,MBUF           SAVE CURRENT BUFFER ADDRESS       R4 S4526000
         BAL   ML,MVFRECHK         ISSUE NEW RECEIVE-ANY IF NEEDED   R4 S4526500
         LR    MBUF,MICE           BRING BACK BUFFER ADDRESS         R4 S4527000
         TM    MDCTSTAT,DCTSINON+DCTSOFF IS ACB AVAILABLE...   @OZ46523 S4527050
         BM    SKIP1415            BRANCH IF YES               @OZ46523 S4527100
         XC    RPLNEXT,RPLNEXT     ZERO CHAIN POINTER          @OZ46523 S4527150
         LA    ML,MBUFNEXT         SET RETURN ADDRESS          @OZ46523 S4527200
         B     MVFREPR2            GO PURGE THIS BUFFER        @OZ46523 S4527250
SKIP1415 L     MICE,RPLICE         LOAD ICE ADDRESS            @OZ46523 S4527500
         LR    R15,MDCT            R15=LOGON DCT IN CASE DESTROYED   R4 S4528000
         LTR   MICE,MICE           TEST ICE ADDRESS                  R4 S4528500
         BZ    MSNAPLT2            BRANCH IF ICE ADDR NOT AVAILABLE  R4 S4529000
         L     R14,ICELDCT         TEST FOR LINE                     R4 S4529500
         LTR   R14,R14              DCT ADDRESS                      R4 S4530000
         BZ    MSNAPLT1            BRANCH IF DISCONNECTED            R4 S4530500
         LR    MDCT,R14            ELSE GET LINE DCT ADDR IN MDCT    R4 S4531000
         STCM  MDCT,7,RPLDCT+1     REPLACE LOGON DCT PTR WITH LINE   R4 S4531500
         B     MSNAPLT1            REJOIN COMMON PROCESSING          R4 S4532000
         EJECT                                                       R4 S4532500
MSNAPNRA L     MICE,RPLICE         LOAD ICE ADDR (FROM RPL USER FLD) R4 S4533000
         LTR   MICE,MICE           TEST FOR ICE ADDRESS PRESENT     R41 S4533100
         BZ    MSNAPLT3            BR IF NO, SKIP INCREMENT         R41 S4533200
         L     R15,ICEADCT         PLACE LOGON DCT ADDRESS IN R15    R4 S4533500
         SPACE 1                                                     R4 S4534000
MSNAPLT1 L     R14,ICETOTAL        INCREMENT ICE                     R4 S4534500
         LA    R14,1(,R14)          SEND/RECEIVE                     R4 S4535000
         ST    R14,ICETOTAL          TOTAL COUNT                     R4 S4535500
         SPACE 1                                                     R4 S4536000
         USING DCTDSECT,R15        USE TEMP LOGON DCT ADDRESSABILITY R4 S4536500
MSNAPLT2 TM    DCTFLAGS,DCTLOGAL   TEST LOGON DCT STATUS             R4 S4537000
         BO    MSNAPLOG            BRANCH IF DIAGNOSTIC LOGGING      R4 S4537500
         DROP  R15                 DISCARD LOGON DCT ADDRESSABILITY  R4 S4538000
         SPACE 1                                                     R4 S4538500
MSNAPLT3 TM    DCTFLAGS,DCTLOGAL   TEST DCT STATUS                  R41 S4539000
         BZ    MSNAPNOL            BRANCH IF NO DIAGNOSTIC LOGGING   R4 S4539500
         SPACE 1                                                     R4 S4540000
MSNAPLOG OI    MFLAGS,MLOGGED      SHOW DIAGNOSTIC LOGGING DONE      R4 S4540500
        $IOERROR (MBUF)            LOG RPL REQUEST COMPLETION        R4 S4541000
         SPACE 1                                                     R4 S4541500
MSNAPNOL LA    ML,MBUFNEXT         LOAD COMMON RETURN FOR SNA SERVCE R4 S4542000
         LA    WA,MVFREELM         POINT TO L.M. BUF DISPOSAL ROUTNE R4 S4542500
         SLR   R0,R0               LOAD ZERO                         R4 S4543000
         ST    R0,RPLNEXT          CLEAR BUFFER CHAIN FIELD          R4 S4543500
         MVI   RPLACTIV,0          CLEAR RPL ACTIVE INDICATOR SINCE    CS4544000
                                    JES2 NEVER ISSUES 'CHECK' MACRO  R4 S4544500
         LR    R15,R0              BRANCH ON                         R4 S4546000
         IC    R15,RPLRTNCD         RECOVERY                         R4 S4546500
         L     R15,MSNAPTAB(R15)     ACTION CODE                    R41 S4547000
         CLI   RPLRTNCD,MSNAIBAD      IF IT IS LESS                 R41 S4547500
         BLR   R15                     THAN ERROR LIMIT             R41 S4547600
         B     MSNAPBAD            ELSE GO HANDLE ERROR RETURN CODE R41 S4547700
         SPACE 1                                                     R4 S4548000
MSNAPTAB DS    0F                  RECOVERY ACTION BRANCH TABLE      R4 S4548500
         DC    A(MSNAPAOK)         VTAM REQUEST O.K.              +0 R4 S4549000
         DC    A(MSNAXRSP)         EXCEPTION REQUEST/RESPONSE     +4 R4 S4549500
         DC    A(MSNAXTMP)         TEMPORARY COND - EXECUTE RETRY +8 R4 S4550000
MSNAIBAD EQU   *-MSNAPTAB          ERROR DIRECTORY ADDRESSES FOLLOW R41 S4550400
         DC    A(MSNAPDMG)         DATA INTEGRITY DAMAGE         +12R41 S4550500
         DC    A(MSNAPENV)         ENVIRONMENT ERROR             +16R41 S4551000
         DC    A(MSNAPBUG)         LOGIC OR TIMING ERROR  +20       R41 S4551200
MSNAINVL EQU   *-MSNAPTAB          HIGHER = LOGIC ERROR             R41 S4551500
         EJECT                                                       R4 S4552000
*                                                                    R4 S4552500
*                             HANDLE NORMAL (DATA) CONTROL SEQUENCE  R4 S4553000
*                                                                    R4 S4553500
         SPACE 1                                                     R4 S4554000
MSNAPAOK MVI   RPLERROR,0          CLEAR ERROR RETRY COUNTER         R4 S4554500
         CLI   RPLFDB2,USFAOOK     TEST RPL FEEDBACK CODE            R4 S4555000
         BNE   MSNAPNOK            PROBABLE LOGIC ERROR IF NOT O.K.  R4 S4555500
         TM    RPLSEQTP,VSEQSPEC   TEST L.M. CONTROL SEQ TYPE        R4 S4556000
         BNZ   MSNAPSPC            BRANCH IF IN SPECIAL SEQUENCE     R4 S4556500
         TM    ICEINDEX,VSEQSPEC   TEST ICE L.M. CONTROL SEQ TYPE    R4 S4557000
         BZ    MSNAPAK1            BR IF NOT SPECIAL SEQUENCE  @OZ37682 S4557500
         CLI   ICEINDEX,VSEQLOGN+VSEQLOPD  ICE LOGON STATUS    @OZ41154 S4557600
         BNE   MSNAPFLX                    HANDLE SPECIAL SEQ  @OZ41154 S4557700
         MVC   RPLDCT+1(3),ICEADCT+1       GET LOGON DCT ADDR  @OZ41154 S4557750
         B     MREQBUF                     GO REQUEUE BUFFER   @OZ41154 S4557800
MSNAPAK1 MVC   MDCTIMOK,MCLOCK     SET LINE XMISSION TIME      @OZ37682 S4558000
         TM    ICESTAT,ICECLOSE+ICEABORT IS SESSION CLOSING..  @OZ45236 S4558020
         BNZ   MSNAPFLX            YES, FREE THE RPL           @OZ45236 S4558040
         LR    R15,R0              BRANCH ON                         R4 S4558500
         IC    R15,RPLSEQTP         SUBSEQUENCE                      R4 S4559000
         IC    R15,*+8-VSEQNORM(R15) CODE USING                      R4 S4559500
         B     MSNAP(R15)             OFFSET TABLE                   R4 S4560000
         SPACE 1                                                     R4 S4560500
         DC    AL1(MSNAPRCV-MSNAP) RECEIVE COMPLETE                  R4 S4561000
         DC    AL1(MSNAPSND-MSNAP) SEND COMPLETE                     R4 S4561500
         DC    AL1(MSNAPRCS-MSNAP) RECEIVE COMPLETE & CONT-SPECIFIC  R4 S4562000
         DC    AL1(MSNAPSCA-MSNAP) SESS. RESET COMPLETE (TO RCV-ANY) R4 S4562500
         SPACE 1                                                     R4 S4563000
MSNAPNOK CLI   RPLREQ,RPLINQIR     TEST VTAM REQUEST TYPE            R4 S4563500
         BNE   MSNAPNK1            BRANCH IF NO, TEST FOR OPNDST    R41 S4564000
         L     R15,=A(MSNALINV)    POINT TO ERROR ROUTINE      @OZ41884 S4564300
         L     MBASE1,MSNALTAB     SET LOGON SEQUENCE BASE     @OZ41884 S4564600
         CLI   RPLFDB2,USFATSFI    TEST RPL FEEDBACK CODE            R4 S4565000
         BER   R15                 ABORT IF AREA TOO SMALL     @OZ41884 S4565500
         BAL   R8,R01              ELSE FAIL WITH LOGIC ERROR  @OZ52502 S4566000
         SPACE 1                                                    R41 S4566100
MSNAPNK1 CLI   RPLREQ,RPLOPNDS     TEST VTAM REQUEST TYPE           R41 S4566200
         BE    MSNAPNK3            IF OPNDST - CONTINUE        @OZ52502 S4566250
         BAL   R8,R01               ELSE LOGIC ERROR - FAIL    @OZ52502 S4566300
MSNAPNK3 DS    0H                                              @OZ52502 S4566350
         CLI   RPLFDB2,USFDSTIU    SEE IF TERMINAL IN USE...        R41 S4566400
         BE    MSNAPNK2            IF YES, ABANDON LOGON TRY   @OZ37080 S4566410
         CLI   RPLFDB2,USFNLGFA    SEE IF LOGON MATCH FOUND    @OZ37080 S4566420
         BE    MSNAPNK2            IF YES, ABANDON LOGON TRY   @OZ52502 S4566500
         BAL   R8,R01              NO -- LOGIC ERROR           @OZ52502 S4566550
MSNAPNK2 ST    R0,ICEBUFAD         CLR SPECIAL SEQ BUFF ADDR   @OZ37080 S4566600
         B     MSNAXVT3            ABANDON LOGON ATTEMPT...         R41CS4566700
                                   ...WILL BE RETRIED LATER         R41 S4566800
         EJECT                                                      R41 S4566900
*                                                                    R4 S4567000
*                             SPECIAL SEQUENCES NON-ERROR PROCESSING R4 S4567500
*                                                                    R4 S4568000
         SPACE 1                                                     R4 S4568500
MSNAPSPC CLI   RPLSEQTP,MINVVSEQ   COMPARE SEQ TYPE WITH INVALID LIM R4 S4569000
         BH    MSNAPSP1            BR IF INVALID               @OZ52502 S4569500
         LR    R14,R0              LOAD ZERO                         R4 S4570000
         LA    R15,X'F0'           BRANCH                            R4 S4570500
         IC    R14,RPLSEQTP         ON LINE                          R4 S4571000
         NR    R15,R14               MANAGER                         R4 S4571500
         XR    R14,R15                MAJOR                          R4 S4572000
         SRL   R15,2                   CONTROL                       R4 S4572500
         L     R15,MSNAPSEQ-4(R15)      SEQUENCE                     R4 S4573000
         BR    R15                       TYPE                        R4 S4573500
         SPACE 1                                               @OZ52502 S4573600
MSNAPSP1 BAL   R8,R01              ABENDR01 -- UNDEFINED SEQ   @OZ52502 S4573700
         SPACE 1                                               @OZ52502 S4573800
         SPACE 1                                                     R4 S4574000
MSNAPSEQ DS    0F                  NON-ERROR CONTRL SEQ BRANCH TABLE R4 S4574500
         DC    A(MSNALOGN)         SESSION INITIATION SEQUENCE       R4 S4575000
         DC    A(MSNAHOLD)         SESSION HOLD   I/O SEQUENCE       R4 S4575500
         DC    A(MSNACLOS)         SESSION CLOSE DOWN SEQUENCE       R4 S4576000
         DC    A(MSNATERM)         SESSION ABN TERMIN SEQUENCE       R4 S4576500
         DC    A(MSNARCVR)         SESSION RECOVR I/O SEQUENCE       R4 S4577000
         DC    A(MSNALOGN)         SESSION AUTO-LOGON SEQUENCE      R41 S4577100
MINVVSEQ EQU   (*-MSNAPSEQ)*4+15   HIGHER SEQUENCES ARE INVALID     R41 S4577500
         EJECT                                                       R4 S4578000
MSNAP    DS    0H                  ORIGIN FOR NORMAL SUBSEQ OFFSETS  R4 S4578500
         SPACE 1                                                     R4 S4580500
MSNAPSND BAL   ML,MVRPLKOQ         CHECK IF NEED EXEC FROM OUTBD QUE R4 S4581000
         LA    ML,MBUFNEXT         RELOAD 1ST LEVEL RETURN ADDRESS   R4 S4581500
         SPACE 1                                                     R4 S4582000
MSNAPSN1 TM    RPLSRTYP,RPLSRESP   TEST SENT R.U. TYPE               R4 S4582500
         BO    MVFREEIN            IF RESPONSE, USE INBND FREE RTNE  R4 S4583000
         SPACE 1                                                     R4 S4583500
MSNAPSN2 LH    R14,ICEOUTCT        DECREMENT                         R4 S4584000
         BCTR  R14,0                ICE OUTBOUND                     R4 S4584500
         STH   R14,ICEOUTCT          CIRCULATION                     R4 S4585000
         CLI   RPLRTNCD,USFDAMGE   TEST RPL RETURN CODE              R4 S4585500
         BNLR  WA                  JUST PURGE IF REQUEST CANCELLED   R4 S4586000
         L     MDCT,ICERDCT        LOAD REMOTE DCT ADDRESS IF ANY    R4 S4586500
         CLC   RPLCNTDF(3),MSNADATA  TEST SENT R.U. TYPE             R4 S4587000
         BNE   MSNAPDFC            BRANCH IF DATA FLOW CONTROL       R4 S4587500
         TM    RPLCHN,RPLLAST+RPLONLY  TEST R.U. CHAIN POSITION      R4 S4588000
         BNZ   SKIP1420            BRANCH IF END OF CHAIN      @OZ42454 S4588500
         TM    ICESNDST,ICECNCEL   ELSE TEST IF CHAIN WAS CANCELLED  R4 S4589000
         BO    MSNAXRS2            IF SO, GO HANDLE DEFERRED -RSP    R4 S4589500
SKIP1420 ALR   R14,R14             DOUBLE CURRENT COUNT              R4 S4590000
         CH    R14,ICEOUTLM        COMPARE 2*COUNT WTH SESSION LIMIT R4 S4590500
         BHR   WA                  IF COUNT .GT. 1/2 OF LIMIT, DON'T   CS4591000
                                    POST YET, JUST PURGE BUFFER      R4 S4591500
         TM    ICESNDST,ICEWTRSP   TEST SESSION SEND STATUS          R4 S4592000
         BZ    MSNAPOST            GO POST IF NOT WAITING FOR RESP   R4 S4592500
         BR    WA                  ELSE JUST DISPOSE OF BUFFER       R4 S4593000
         SPACE 1                                                    R41 S4593100
MSNAPSCA BR    WA                  DISPOSE OF BUFFER                R41 S4593200
         SPACE 1                                                     R4 S4593500
MSNAPRCS OI    ICESTAT,ICERCVSP    SET ICE 'RECEIVE SPECIFIC' FLAG   R4 S4594000
         SPACE 1                                                     R4 S4594500
MSNAPRCV TM    RPLSRTYP,RPLRRESP   TEST TYPE OF UNIT RECEIVED        R4 S4595000
         BO    MSNAPRSP            BRANCH IF RESPONSE                R4 S4595500
         SPACE 1                                                     R4 S4596000
MSNAPRC1 TM    ICESTAT,ICEALLOC    TEST SESSION STATUS               R4 S4596500
         BZ    MVDECODE            DECODE UNDER L.M.IF NOT ALLOCATED R4 S4597000
         L     MDCT,ICERDCT        LOAD ADDRESS OF REMOTE DCT        R4 S4597500
         TM    RPLSRTYP,RPLDFASY   TEST R.U. TYPE                    R4 S4598000
         BO    MVDECODE            DECODE UNDER L.M.IF EXPEDITED FLO R4 S4598500
         TM    RPLCNTDC,RPLLUS     TEST R.U. TYPE                    R4 S4599000
         BO    MVDECODE            DECODE UNDER L.M. IF 'L.U. STAT'  R4 S4599500
         LR    R1,MBUF             HIDE BUFFER ADDRESS               R4 S4600000
         SLR   MBUF,MBUF            FROM 'MVFREELM' RTNE             R4 S4600500
         L     R15,ICEINTL         PLACE BUFFER ON BACK              R4 S4601000
         ST    R1,ICEINTL           OF ICE INBOUND QUEUE             R4 S4601500
         LTR   R15,R15             TEST FORMER TAIL ADDRESS          R4 S4602000
         BZ    MSNAPOSR            IF QUE EMPTY, GO POST FOR INPUT  R41 S4602500
         ST    R1,RPLNEXT-RPLDSECT(,R15)  CHAIN BUF TO OLD QUE TAIL R41 S4604000
         BR    WA                  GO CHECK IF NEED ISSUE RCV-ANY    R4 S4604500
         EJECT                                                       R4 S4605000
*                                                                    R4 S4605500
*                             HANDLE DATA FLOW CONTROL, POST=RESP    R4 S4606000
*                                                                    R4 S4606500
         SPACE 1                                                     R4 S4607000
MSNAPDFC NI    ICESNDST,255-ICEWTRSP  RESET WAITING-FOR-RESPONSE BIT R4 S4607500
         CLI   RPLRTNCD,USFAOK     TEST DFC RPL COMPLETION CODE      R4 S4608000
         BNE   MSNAPDFN            BRANCH IF EXCEPTION RESP TO DFC   R4 S4608500
         CLC   RPLCNTDF(3),MSNABID   TEST SUCCESSFUL DFC TYPE        R4 S4609000
         BNE   MSNAPRS2            GO HANDLE IF NOT +RSP(BID)        R4 S4609500
         OI    ICEFLAGS,ICEBBPND+ICEOUTBD  MARK OUTB FLOW, BBP STATE R4 S4610000
         B     MSNAPOST            GO POST PROCESSOR WAITING ON BID  R4 S4610500
         SPACE 2                                                     R4 S4611000
MSNAPDFN ST    R0,ICEOUTBF         CLEAR ACTIVE (IN VTAM) BUF ADDR   R4 S4611500
         TM    MFLAGS,MLOGGED      TEST FOR DIAGNOSTIC LOGGING       R4 S4612000
         BO    MSNAPDF1            SKIP MSG IF BUF ALREADY LOGGED    R4 S4612500
        $IOERROR (MBUF)            ISSUE I/O ERROR MESSAGE           R4 S4613000
         OI    MFLAGS,MLOGGED      SHOW MESSAGE ALREADY LOGGED      R41 S4613200
         SPACE 1                                                     R4 S4613500
MSNAPDF1 CLC   RPLCNTDF(3),MSNABID  TEST RESPONSE TYPE               R4 S4614000
         BNER  WA                  CAN'T HANDLE -RSP(DFC) IF NOT BID R4 S4614500
         CLC   RPLSSNSI,=AL1(RPLRRI,X'13')  TEST TYPE OF -RSP(BID)   R4 S4615000
         BE    MSNAPDF2            HANDLE IF BID REJECT WITHOUT RTR R41 S4615500
         CLC   RPLSSNSI,=AL1(RPLRRI,X'14')  TEST TYPE OF -RSP(BID)   R4 S4616000
         BNER  WA                  IF NOT RTR PENDING, DON'T HANDLE  R4 S4616500
         OI    ICESTAT,ICERTRPD    ELSE SET 'RTR PENDING' FLAG       R4 S4617000
MSNAPDF2 L     R14,ICEBDREJ        INCREMENT                        R41 S4617500
         LA    R14,1(,R14)          BID REJECT                       R4 S4618000
         ST    R14,ICEBDREJ          COUNTER                         R4 S4618500
         B     MSNAPOST            GO POST WAITING PROCESSOR         R4 S4619000
         EJECT                                                       R4 S4619500
*                                                                    R4 S4620000
*                             SNA POSITIVE RESPONSE HANDLING ROUTINE R4 S4620500
*                                                                    R4 S4621000
         SPACE 1                                                     R4 S4621500
MSNAPRSP CLC   RPLCNTDF(3),MSNADATA  TEST RESPONSE TYPE              R4 S4622000
         BE    MSNAPRSA            IF EQUAL - CONTINUE         @OZ52502 S4622500
         BAL   R8,R01              FAIL IF OTHER THAN DATA     @OZ52502 S4622600
MSNAPRSA DS    0H                                              @OZ52502 S4622700
         IC    R14,ICERSPCT        DECREMENT                         R4 S4623000
         BCTR  R14,0                OUTSTANDING                      R4 S4623500
         STC   R14,ICERSPCT          RESPONSE COUNT                  R4 S4624000
         SPACE 1                                                     R4 S4624500
MSNAPRS0 L     MDCT,ICERDCT        LOAD REMOTE DCT ADDRESS IF ANY    R4 S4625000
         SPACE 1                                                     R4 S4625500
MSNAPRS1 NI    ICESNDST,255-ICEWTRSP  RESET WAITING-FOR-RESPONSE BIT R4 S4626000
         SPACE 1                                                     R4 S4626500
MSNAPRS2 TM    ICESTAT,ICEALLOC    TEST SESSION STATUS               R4 S4627000
         BZ    SKIP1440            ACCEPT RESP UNDER L.M. IF UNALLOC R4 S4627500
         TM    DCTSTAT,DCTRTAM     TEST PROCESSOR CURRENT STATUS     R4 S4628000
         BO    MSNAPOST            GO POST IF WAITING IN RTAM        R4 S4628500
SKIP1440 BALR  ML,WA               ELSE DISPOSE OF RESP BUFFER AND   R4 S4629000
         LA    ML,MBUFNEXT          DO STATE CHANGE UNDER L.M. FOR   R4 S4629500
         B     MVRSTATO              PROCESSOR WAITING ON FORM MOUNT R4 S4630000
         SPACE 5                                                    R41 S4630100
*                                                                   R41 S4630200
*                             POST WAITING PROCESSOR                R41 S4630300
*                                                                   R41 S4630400
         SPACE 1                                                    R41 S4630500
MSNAPOSR ST    R1,ICEINHD          SET QUEUE HEAD = TAIL = THIS RPL R41 S4630600
         SPACE 1                                                    R41 S4630700
MSNAPOST LTR   MDCT,MDCT           TEST ADDR OF SENDING REMOTE DCT   R4 S4631000
         BZR   WA                  JUST PURGE BUFFER IF NO DCT       R4 S4631500
         L     R1,DCTPCE           GET ADDRESS OF PCE TO POST        R4 S4632000
        $POST  (R1),WORK           FIRE UP PROCESSOR                 R4 S4632500
         BR    WA                  DISPOSE OF BUF AS NEEDED & RETURN R4 S4633000
         EJECT                                                       R4 S4633500
*                                                                    R4 S4634000
*                             EXCEPTION REQUESTS & RESPONSES         R4 S4634500
*                                                                    R4 S4635000
         SPACE 1                                                     R4 S4635500
MSNAXRSP MVI   RPLERROR,0          CLEAR ERROR RETRY COUNTER         R4 S4636000
         CLI   RPLFDB2,USFEXRS     TEST RPL FEEDBACK CODE            R4 S4636500
         BNE   MSNAXREQ            BRANCH IF NOT EXCEPTION RESPONSE  R4 S4637000
         TM    RPLSEQTP,255-VSEQRSET  TEST L.M. CONTROL SEQUENCE     R4 S4637500
         BNZ   MSNAPSN2            ASSUME POST=RESP DFC IF NOT RECVE R4 S4638000
         L     R14,ICEXRESP        INCREMENT ICE                     R4 S4638500
         LA    R14,1(,R14)          EXCEPTION RE-                    R4 S4639000
         ST    R14,ICEXRESP          SPONSE COUNT                    R4 S4639500
         CLC   RPLCNTDF(3),MSNADATA  TEST RESPONSE TYPE              R4 S4640000
         BNE   MSNAXCLS            GO ABORT IF NOT DATA        @OZ37680 S4640500
         CLI   RPLSSEI,RPLRRI      TEST MAJOR SYSTEM SENSE CODE      R4 S4641000
         BNE   MSNAXRSQ            CHECK FURTHER IF NOT REQUEST REJ R41 S4641500
         L     MDCT,ICERDCT        LOAD REMOTE DCT ADDRESS IF ANY    R4 S4642000
         CNOP  0,4                 ALIGN TABLE ON FULLWORD BOUNDARY  R4 S4642500
         LA    R14,RPLSSMI         POINT TO MINOR SYSTEM SENSE CODE  R4 S4643000
         BAL   R15,MSNAPDIR        LOOK UP IN MINOR CODE DIRECTORY   R4 S4643500
         SPACE 1                                                     R4 S4644000
*                             CODES MUST APPEAR IN ASCENDING ORDER   R4 S4644500
         SPACE 1                                                     R4 S4645000
         DC    X'01',AL3(MSNAXCLS)                       - ABORT     R4 S4645500
         DC    X'02',AL3(MSNAXITV) INTERVENTION REQUIRED - HOLD ICE  R4 S4646000
         DC    X'10',AL3(MSNAXCLS)                       - ABORT     R4 S4646500
         DC    X'11',AL3(MSNAXBRK) BREAK (REVERSE CANCL) - CAUSE $C  R4 S4647000
         DC    X'12',AL3(MSNAXPRM) INSUFFICIENT RESOURCE - HOLD ICE R41 S4647500
         DC    X'13',AL3(MSNAXYLD) BEGIN BRACKET REJECT  - YIELD     R4 S4648000
         DC    X'14',AL3(MSNAXRTR) BEGIN BR REJECT, RTR  - SET RTRP  R4 S4648500
         DC    X'1A',AL3(MSNAXCLS)                       - ABORT     R4 S4649000
         DC    X'1B',AL3(MSNAXYLD) RECEIVER IN XMIT MODE - YIELD     R4 S4649100
         DC    X'1C',AL3(MSNAXPRM) PERMANENT ERROR       - HOLD ICE R41 S4649200
         DC    X'23',AL3(MSNAXCLS)                       - ABORT     R4 S4649300
         DC    X'25',AL3(MSNAXNAV) COMPONENT NOT AVAIL   - PURGE CHN R4 S4649400
         DC    X'FF',AL3(MSNAXCLS) ANY OTHER SENSE CODES - ABORT     R4 S4649500
         SPACE 3                                                    R41 S4649600
MSNAXRSQ CLC   RPLFDBK2(3),=AL1(RPLFII,X'08',X'08')  TEST SENSE INFOR41 S4649700
         BNE   MSNAXCLS            GO ABORT IF NOT FUNCTION REJECT  R41 S4649800
         L     MDCT,ICERDCT        LOAD REMOTE DCT ADDRESS IF ANY   R41 S4649900
         CNOP  0,4                 ALIGN TABLE ON FULLWORD BOUNDARY R41 S4650000
         LA    R14,RPLUSNSI+1      POINT TO MINOR APPLIC SENSE CODE R41 S4650100
         BAL   R15,MSNAPDIR        LOOK UP IN FUNCTION ERR DIRECTORYR41 S4650200
         SPACE 1                                                    R41 S4650300
*                             CODES MUST APPEAR IN ASCENDING ORDER  R41 S4650400
         SPACE 1                                                    R41 S4650500
         DC    X'03',AL3(MSNAXCLS)                       - ABORT    R41 S4650600
         DC    X'05',AL3(MSNAXCPY) CANNOT ACCEPT COPIES  - CHG PDIR R41 S4650700
         DC    X'FF',AL3(MSNAXCLS) ANY OTHER SENSE CODES - ABORT    R41 S4650800
         EJECT                                                      R41 S4650900
         SPACE 3                                                    R41 S4651000
*                                                                    R4 S4652000
*                             HANDLE RECOVERABLE NEGATIVE RESPONSES  R4 S4652500
*                                                                    R4 S4653000
         SPACE 1                                                     R4 S4653500
MSNAXCPY OI    ICEXRFBK,ICEXRCPY   SET COPIES FUNCTION REJECTED BIT R41 S4653600
         B     MSNAXERR            GO ISSUE I/O ERROR MESSAGE       R41 S4653700
         SPACE 1                                                    R41 S4653800
MSNAXPRM SLR   R15,R15             SHOW PERMANENT ERROR CONDITION   R41 S4653900
MSNAXITV LTR   MDCT,MDCT           TEST REMOTE DCT ADDRESS           R4 S4654000
         BZ    MSNAXERR            BRANCH IF NOT ALLOCATED           R4 S4654500
         TM    ICESNDST,ICENOFMH   TEST SESSION SEND STATUS          R4 S4655000
         BNO   MSNAXERR            DO NOT HALT IF FM HDR PENDING     R4 S4655500
         LTR   R15,R15             TEST FOR TEMP OR PERM ERR   @OZ36060 S4656000
         BZ    MSNAXPR2            DONT SET STOP FOR PERM ERR  @OZ36060 S4656300
         OI    DCTFLAGS,DCTSTOP    HALT PROCCESOR TO ALLOW CMD @OZ36060 S4656400
         B     MSNAXERR            ELSE GO ISSUE I/O ERROR MESSAGE  R41 S4656500
         SPACE 1                                               @OZ36060 S4656550
MSNAXPR2 OI    DCTFLAGS,DCTRSTRT   RESTART DATA SET            @OZ36060 S4656600
         CLI   DCTDEVTP,DCTRCON    CHECK FOR REMOTE CONSOLE    @OZ52133 S4656610
         BE    MSNAXER2            IF CONSOLE, DON'T DRAIN     @OZ52133 S4656620
         B     MSNAXERP            GO DRAIN THE DEVICE         @OZ36060 S4656650
         SPACE 1                                                     R4 S4657000
MSNAXRTR OI    ICESTAT,ICERTRPD    SET READY TO RECEIVE PENDING BIT  R4 S4657500
MSNAXYLD OI    ICESTAT,ICEHOLD     PREVENT OUTBD ALLOCATION UNTIL    R4CS4658000
                                    'LUS' OR INBND STREAM COMPLETED  R4 S4658500
         B     MSNAXRS1            TREAT AS ORDINARY CHAIN FAILURE   R4 S4659000
         SPACE 1                                                     R4 S4659500
MSNAXBRK LTR   MDCT,MDCT           TEST REMOTE DCT ADDRESS           R4 S4660000
         BZ    MSNAXRS1            BRANCH IF NOT ALLOCATED           R4 S4660500
         OI    DCTFLAGS,DCTDELET   DELETE DATA SET             @OZ27835 S4661000
         OI    ICEXRFBK,ICEXRDNA   SHOW DEVICE NOT ACCEPTING DATA   R41 S4661200
         B     MSNAXRS1            REJOIN COMMON -RSP PROCESSING     R4 S4661500
         SPACE 1                                                     R4 S4662000
MSNAXNAV LTR   MDCT,MDCT           TEST REMOTE DCT ADDRESS           R4 S4662500
         BZ    MSNAXERR            BRANCH IF NOT ALLOCATED           R4 S4663000
         OI    DCTFLAGS,DCTBKSP+DCTRSTRT INTERRUPT THE OUTPUT  @OZ36060 S4663500
         CLI   DCTDEVTP,DCTRCON    CHECK FOR REMOTE CONSOLE    @OZ52133 S4663600
         BE    MSNAXER2            IF CONSOLE, DON'T DRAIN     @OZ52133 S4663700
MSNAXERP OI    DCTSTAT,DCTDRAIN    SHOW DEVICE NOT AVAILABLE   @OZ36060 S4664000
MSNAXER2 DS    0H                                              @OZ52133 S4664100
         OI    ICEXRFBK,ICEXRDNA   SHOW DEVICE NOT TAKING DATA @OZ36060 S4664200
         SPACE 1                                                     R4 S4664500
MSNAXERR TM    MFLAGS,MLOGGED      TEST FOR DIAGNOSTIC LOGGING       R4 S4665000
         BO    MSNAXRS1            GO CANCEL CHAIN IF ALREADY LOGGED R4 S4665500
        $IOERROR (MBUF)            ELSE LOG EXCEPTION RESPONSE       R4 S4666000
         OI    MFLAGS,MLOGGED      SHOW MESSAGE ALREADY LOGGED      R41 S4666200
         SPACE 1                                                     R4 S4666500
MSNAXRS1 ICM   R14,1,ICERSPCT       DECREMENT                        R4 S4667000
         BZ    SKIP1450              OUTSTANDING                     R4 S4667500
         BCTR  R14,0                  RESPONSE COUNT                 R4 S4668000
         STC   R14,ICERSPCT            (IF NOT NEGATIVE)             R4 S4668500
SKIP1450 OI    ICESNDST,ICECNCEL   SHOW CHAIN IS CANCELLED     @OZ37145 S4669000
         NI    ICEFLAGS,255-ICEBBPND-ICEEBPND-ICECHDIR  RESET PENDS. R4 S4669500
         EJECT                                                      R41 S4670000
MSNAXRS2 ICM   R0,3,ICEOUTCT       CHECK OUTBOUND CIRCULATION        R4 S4670500
         BNZR  WA                  IF NOT ZERO, WAIT FOR QUIESCE OR  R4CS4671000
                                    'CANC BY PRIOR EX RESPONSE' RPL  R4 S4671500
         TM    ICESNDST,ICEINCHN   TEST SESSION SEND STATUS          R4 S4672000
         BZ    MSNAPRS1            LET RTAM HANDLE IF OUT OF CHAIN   R4 S4672500
         SPACE 1                                                     R4 S4673000
MSNAXRS3 NI    ICESNDST,255-ICEINCHN-ICEOCPND  FORCE RTAM OUT OF CHN R4 S4673500
         MVC   RPLCNTDF(3),MSNACNCL  CHANGE                          R4 S4674000
         MVI   RPLSRTYP,RPLNFSYN      INTERCEPTED              @OZ32746 S4674500
         MVI   RPLVTFL2,RPLSCHED       RPL INTO                      R4 S4675000
         MVI   RPLCHN,RPLONLY           'CANCEL' REQ                 R4 S4675500
         OI    ICESNDST,ICEWTRSP   SHOW L.M.-SENT REQST EXPECTS RESP R4 S4676000
         B     MVRPLOCR            SEND 'CANCEL' AND RETURN          R4 S4676500
         SPACE 5                                                    R41 S4677000
*                                                                    R4 S4677500
*                             HANDLE EXCEPTION REQUESTS              R4 S4678000
*                                                                    R4 S4678500
         SPACE 1                                                     R4 S4679000
MSNAXREQ CLI   RPLFDB2,USFEXRQ     TEST RPL FEEDBACK CODE            R4 S4679500
         BE    MSNAXRQ2            CONTINUE IF EQUAL           @OZ52502 S4680000
         BAL   R8,R01              TRAP LOGIC ERROR IF NOT     @OZ52502 S4680100
MSNAXRQ2 DS    0H                                              @OZ52502 S4680200
         OI    ICERCVST,ICECNCEL   SHOW CHAIN IS BEING CANCELLED     R4 S4680500
         TM    MFLAGS,MLOGGED      TEST FOR DIAGNOSTIC LOGGING       R4 S4681000
         BO    MSNAXRQ1            PASS IF BUFFER LOGGED       @OZ28435 S4681500
        $IOERROR (MBUF)            ELSE LOG EXCEPTION REQUEST        R4 S4682000
         OI    MFLAGS,MLOGGED      SHOW MESSAGE ALREADY LOGGED      R41 S4682200
MSNAXRQ1 BAL   ML,MVFREEIN         PURGE BUFFER, SAVE COUNTS   @OZ28435 S4682500
         LA    ML,MBUFNEXT         RESTORE RETURN ADDRESS      @OZ28435 S4682600
         B     MICEABRT            GO CLOSE DOWN SESSION       @OZ28435 S4682700
         SPACE 3                                                     R4 S4683000
*                                                                    R4 S4683500
*                             RE-EXECUTE RPLS TEMPORARILY REJECTED   R4 S4684000
*                                                                    R4 S4684500
         SPACE 1                                                     R4 S4685000
MSNAXTMP L     MICE,RPLICE         LOAD ICE ADDR FROM RPL      @OZ38145 S4685500
         LTR   MICE,MICE           TEST ICE ADDR               @OZ38145 S4685550
         BZ    MSNAXTP2            BRANCH IF NOT AVAILABLE     @OZ38145 S4685575
         L     R14,ICETEMP         INCREMENT                   @OZ38145 S4685600
         LA    R14,1(,R14)          TEMPORARY                        R4 S4686000
         ST    R14,ICETEMP           ERROR COUNT                     R4 S4686500
MSNAXTP2 IC    R14,RPLERROR        INCREMENT                   @OZ38145 S4687000
         LA    R14,1(,R14)           RPL RETRY                       R4 S4687500
         STC   R14,RPLERROR           COUNT                          R4 S4688000
         CLI   RPLFDB2,USFSTALF    TEST RPL FEEDBACK CODE            R4 S4688500
         BE    MSNAXTP1            CONTINUE IF EQUAL           @OZ52502 S4688600
         BAL   R8,R01              IF UNEQUAL ABEND- LOG ERR   @OZ52502XS4689000
                                    IF NOT TEMPORARY NO-STORAGE COND R4 S4689500
MSNAXTP1 DS    0H                                              @OZ52502 S4689600
         CLI   RPLERROR,255        TEST RPL RETRY COUNT              R4 S4690000
         BL    MVRPLXEC            RETRY IF LESS THAN MAX            R4 S4690500
         MVI   RPLERROR,0          CLEAR RPL RETRY COUNT       @OZ38145 S4691000
         LTR   MICE,MICE           TEST ICE ADDRESS            @OZ38145 S4691050
         BZ    MSNAXCLS            GO FORCE DOWN SESSION       @OZ38145 S4691100
         MVI   ICEINDEX,0          SHOW ANY SPECIAL SEQ ENDED  @OZ38145 S4691500
         B     MSNAXCLS            GO FORCE DOWN SESSION             R4 S4692000
         EJECT                                                       R4 S4692500
*                                                                    R4 S4693000
*                             HANDLE 'SEND' CANCELLED BY PRIOR -RSP  R4 S4693500
*                                                                    R4 S4694000
         SPACE 1                                                     R4 S4694500
         SPACE 1                                                     R4 S4695000
MSNAPIXR L     R0,ICEOUTHD         GET ADDR OF 1ST BUF ON OUTBD QUE  R4 S4695500
         LH    R1,ICEOUTCT         GET OUTBOUND CIRCULATION COUNT    R4 S4696000
         LTR   R0,R0               TEST 1ST OUTBD Q BUFFER ADDRESS   R4 S4696500
         BZ    MSNAPIX5            GO CHECK FOR END CHAIN IF Q EMPTY R4 S4697000
         LA    R15,ICEOUTHD-RPLNEXT+RPLDSECT  GET PHONY RPL ADDRESS  R4 S4697500
         SPACE 1                                                     R4 S4698000
         USING RPLDSECT,R15        USE TEMPORARY RPL ADDRESSABILITY  R4 S4698500
         SPACE 1                                                     R4 S4699000
MSNAPIX1 LR    R14,R15             SET PRECEDING BUF ADDR = CURRENT  R4 S4699500
         SPACE 1                                                     R4 S4700000
MSNAPIX2 CL    R15,ICEOUTTL        COMPARE BUF ADDR WITH QUE TAIL    R4 S4700500
         LR    R15,R0              ADVANCE TO NEXT BUFFER IF ANY     R4 S4701000
         BE    MSNAPIX4            REPLACE WHAT REMAINS IF QUE END   R4 S4701500
         SPACE 1                                                     R4 S4702000
MSNAPIX3 L     R0,RPLNEXT          LOAD ADDR OF NEXT BUFFER IF ANY   R4 S4702500
         TM    RPLSRTYP,RPLSRESP   TEST SEND TYPE                    R4 S4703000
         BO    MSNAPIX1            LEAVE BUFFER ON QE IF A RESPONSE  R4 S4703500
         CLC   RPLCNTDF(3),MSNADATA  TEST R.U. TYPE                  R4 S4704000
         BNE   MSNAPIX1            LEAVE BUFFER ON QE IF (SYNC) DFC  R4 S4704500
         BCTR  R1,0                DECREMENT OUTBOUND CIRCULATION    R4 S4705000
         MVC   RPLNEXT,RPLNEXT-RPLDSECT(MBUF)  PLACE BEHIND ORIGINAL R4 S4705500
         ST    R15,RPLNEXT-RPLDSECT(,MBUF)      X'0C0D' BUF FOR FREE R4 S4706000
         ST    R0,RPLNEXT-RPLDSECT(,R14)  REMOVE FROM OUTBD QUE      R4 S4706500
         TM    RPLCHN,RPLLAST+RPLONLY  TEST R.U. CHAIN POSITION      R4 S4707000
         BZ    MSNAPIX2            KEEP LOOKING IF NOT END OF CHAIN  R4 S4707500
         DROP  R15                 DISCARD TEMP RPL ADDRESSABILITY   R4 S4708000
         SPACE 1                                                     R4 S4708500
MSNAPIX4 ST    R14,ICEOUTTL        STORE ADDR OF NEW LAST BUFFER     R4 S4709000
         LA    R15,ICEOUTHD-RPLNEXT+RPLDSECT  GET PHONY RPL ADDRESS  R4 S4709500
         CLR   R14,R15             COMPARE TAIL PTR & PHONY VALUE    R4 S4710000
         BNE   MSNAPIX5            BRANCH IF QUE STILL HAS BUFFERS   R4 S4710500
         XC    ICEOUTHD(8),ICEOUTHD  ELSE CLEAR OUTBD QUE POINTERS   R4 S4711000
         SPACE 1                                                     R4 S4711500
MSNAPIX5 BCTR  R1,0                COUNT ORIGINAL X'0C0D' BUFFER     R4 S4712000
         STH   R1,ICEOUTCT         UPDATE OUTBOUND CIRCULATION       R4 S4712500
         TM    RPLCHN,RPLLAST+RPLONLY  TEST R.U. CHAIN POSITION      R4 S4713000
         BNZ   MSNAPRS0            LET RTAM HANDLE IF CHAIN ENDED    R4 S4713500
         BAL   ML,MSNAXRS3         SEND 1ST INTERCEPTED RPL = CANCEL R4 S4714000
         LA    ML,MBUFNEXT         RESTORE 1ST LEVEL RETURN ADDRESS  R4 S4714500
         B     MVFREPRG            PURGE ANY REMAINING BUFFERS       R4 S4715000
         EJECT                                                       R4 S4715500
*                                                                    R4 S4716000
*                             HANDLE RPL BAD RETURN CODES            R4 S4716500
*                                                                    R4 S4717000
         SPACE 1                                                     R4 S4717500
MSNAPBAD MVI   RPLERROR,0          CLEAR ERROR RETRY COUNTER         R4 S4718000
         LTR   MICE,MICE           TEST ICE ADDRESS                  R4 S4718500
         BZ    MSNAPBA1            DON'T REFER TO ICE IF NOT AVAIL   R4 S4719000
         LA    R14,ICEOUTBF        ASSUME REGULAR OUTBOUND BUFFER   R41 S4719500
         CL    MBUF,ICEBUFAD       CHK CURRENT BUF VS. SPECIAL SEQ  R41 S4720000
         BNE   MSNAPBA0            BRANCH IF REGULAR OUTBOUND BUFR  R41 S4720500
         MVI   ICEINDEX,0          ELSE CLEAR SPECIAL SEQ. INDEX    R41 S4721000
         LA    R14,ICEBUFAD        POINT TO SPECIAL SEQ BUFFER ADDR R41 S4721500
MSNAPBA0 ST    R0,0(,R14)          CLEAR APPROPRIATE BUFFER POINTER R41 S4722000
         SPACE 1                                                    R41 S4722500
MSNAPBA1 LA    R14,RPLFDB2         POINT TO RPL FEEDBACK CODE       R41 S4723000
         CLI   RPLRTNCD,MSNAINVL   COMPARE RTNCD WITH LIMIT         R41 S4723500
         BL    MSNAPDIR            IF OK LOOK UP FDBK2 IN DIRECTORY R41 S4723600
         BAL   R8,R01              ELSE FAIL CATASTROPHICALLY  @OZ52502 S4723700
         EJECT                                                      R41 S4723800
*                                                                   R41 S4723900
*                            LOGIC ERRORS DIRECTORY                 R41 S4724000
*                                                                   R41 S4724100
         SPACE 1                                                    R41 S4724200
MSNAPBUG DS    0F                  ALIGN TABLE ON FULLWORD BOUNDARY R41 S4724300
         SPACE 1                                                    R41 S4724600
*                            CODES MUST APPEAR IN SEQUENCE          R41 S4724700
         SPACE 1                                                    R41 S4724800
         DC    AL1(USFSINVC),AL3(R01-1) ALL LOWER ARE ERRORS        R41 S4724900
         DC    AL1(USFSDFR),AL3(MSNAPFLX-1) NO SDT   - FLUSH        R41 S4725000
         DC    AL1(USFIICBE),AL3(MSNAXVTM-1) TERM NOT AVAIL    @OZ34615 S4725010
         DC    AL1(USFINVNB),AL3(R01-1) INVLD CNTRL BLK - LOGIC ERR R41 S4725100
         DC    AL1(USFNOPAU),AL3(MSNAXVTM-1) ACQ NOT AUTH - ABORT   R41 S4725200
         DC    AL1(USFRSCNO),AL3(R01-1) RESOURCE NOT OWNED     @OZ41693 S4725210
         DC    AL1(USFRSCNC),AL3(MSNAXVTM-1) RES. UNCLOSEABLE  @OZ41693 S4725220
         DC    XL1'FF',AL3(R01-1)  OTHER CODES ARE LOGIC ERRORS     R41 S4725300
         EJECT                                                       R4 S4726000
*                                                                    R4 S4726500
*                             ENVIRONMENT ERRORS DIRECTORY           R4 S4727000
*                                                                    R4 S4727500
         SPACE 1                                                     R4 S4728000
MSNAPENV DS    0F                  ALIGN TABLE ON FULLWORD BOUNDARY R41 S4728500
         SPACE 1                                                     R4 S4730000
*                             CODES MUST APPEAR IN ASCENDING ORDER   R4 S4730500
         SPACE 1                                                     R4 S4731000
         DC    AL1(USFSBFAL),AL3(MSNAXVTM-1) TERM UNAVAIL/BIN       R41CS4731500
                                   (OPNDST)         LOGON SEQ FAILS  R4 S4732000
         DC    AL1(USFTAPUA),AL3(R01-1) APPL PASSD LGN REJECT       R41CS4732500
                                   (CLSDST)         LOGIC ERROR      R4 S4733000
         DC    AL1(USFVTHAL),AL3(MSNAXVTM-1) Z NET,QUICK CMND       R41CS4733500
                                   (OPNDST)         ABANDON CONTACT  R4 S4734000
         DC    AL1(USFILRS),AL3(R01-1) INCOMPAT VTAM/NCP DEFN       R41CS4734500
                                   (BASIC MODE)     LOGIC ERROR      R4 S4735000
         DC    AL1(USFPCF),AL3(MSNAXCLS-1) PERM CHNL/LINK FAIL      R41CS4735500
                                   (OPNDST, RECEIVE, SEND, RESETSR,    CS4736000
                                    SESSIONC)       ISSUE CLSDST     R4 S4736500
         DC    AL1(USFANS),AL3(MSNAXVTM-1) AUTO NCP SHUTDOWN        R41CS4737000
                                   (OPNDST)         LOGON SEQ FAILED R4 S4737500
         DC    AL1(USFVOFOC),AL3(MSNAXCLS) CANCLD BY VARY DISC      R41CS4737700
                                      (OPNDST, SEND, RESETSR,       R41CS4737800
                                      SESSIONC) - ISSUE CLSDST      R41 S4737900
         DC    AL1(USFDISCO),AL3(R01-1) CNCLD BY VARY/DIAL DISC     R41CS4738000
                                   (BASIC MODE)     LOGIC ERROR      R4 S4738500
         DC    AL1(USFUTSCR),AL3(MSNAXCLS-1) UNCOND TERMINATE       R41CS4739000
                                   (OPNDST, RECEIVE, SEND, RESETSR,    CS4739500
                                    SESSIONC)       ISSUE CLSDST     R4 S4740000
         DC    AL1(USFSYERR),AL3(MSNAXVTM-1) VTAM LOGIC ERROR       R41CS4740500
                                   (OPNDST, CLSDST, INQUIRE)           CS4741000
                                                    ABANDON CONTACT  R4 S4741500
         DC    AL1(USFDIDOL),AL3(MSNAXVTM-1) DIAL OUT DISC     @OZ34189*S4741700
                                   (BASIC MODE)     ABANDON CONTACT     S4741800
         DC    AL1(USFDIDIL),AL3(MSNAXVTM-1) DIAL IN/OUT DISC       R41CS4742000
                                   (BASIC MODE)     LOGIC ERROR      R4 S4742500
         DC    AL1(USFVTMNA),AL3(MSNAXVTM-1) VTAM INACT TO JES2     R41CS4743000
                                   (ANY MACRO)      ABANDON CONTACT  R4 S4743500
         DC    AL1(USFABNDO),AL3(R01-1) VTAM TCB ABEND         @OZ34189*S4743550
                                   (ANY MACRO) LOGIC ERROR     @OZ34189 S4743560
         DC    AL1(X'0F'),AL3(MSNAXVTM-1) NO VTAM BUFFERS      @OZ34189*S4743580
                                  (ANY MACRO) ABANDON CONTACT  @OZ34189 S4743590
         DC    AL1(X'10'),AL3(R01-1)      COND. TERM SELF      @OZ34189*S4743600
                                   (OPNDST)           LOGIC ERROR       S4743700
         DC    AL1(X'11'),AL3(MSNAXVTM-1) SDT FAILED           @OZ34189*S4743800
                                   (OPNDST)       LOGON SEQ FAILS       S4743900
         DC    XL1'FF',AL3(R01-1) OTHER CODES ARE LOGIC ERRORS      R41 S4744000
         EJECT                                                       R4 S4744500
*                                                                    R4 S4745000
*                             DATA INTEGRITY DAMAGE DIRECTORY        R4 S4745500
*                                                                    R4 S4746000
         SPACE 1                                                     R4 S4746500
MSNAPDMG DS    0F                  ALIGN TABLE ON FULLWORD BOUNDARY R41 S4747000
         SPACE 1                                                     R4 S4748500
*                             CODES MUST APPEAR IN ASCENDING ORDER   R4 S4749000
         SPACE 1                                                     R4 S4749500
         DC    AL1(USFLIORP),AL3(R01-1)  VARIOUS I/O ERRORS          R4CS4750000
                                   (BASIC MODE)     LOGIC ERROR      R4 S4750500
         DC    AL1(USFRTRAF),AL3(MSNAPURG-1)  CONN RECOV/TRM RESTART R4CS4751000
                                   (RECEIVE, SEND,RESETSR, SESSIONC)   CS4751500
                                                    LET LOSTERM RUN  R4 S4752000
         DC    AL1(USFQOPDC),AL3(R01-1)  UNASSIGNED                  R4CS4752500
                                   (NONE)           LOGIC ERROR      R4 S4753000
         DC    AL1(USFCLRED),AL3(MSNACANC)  REQUEST CANCELLED  @OZ41873CS4753500
                                   (RECEIVE,SEND, RESETSR, SESSIONC)   CS4754000
                                                    PRGE BUF & CTNUE R4 S4754500
         DC    AL1(USFPREXC),AL3(MSNAPIXR)  CANC BY PRIOR EXCPTN RSP   CS4755000
                                   (SEND)           RESTART OUTBD QE R4 S4755500
         DC    X'FF',AL3(R01-1)    ALL HIGHER CODES ARE LOGIC ERRORS R4 S4756000
         EJECT                                                      R41 S4756500
SKIP1470 LA    R15,4(,R15)         LOOK UP CODE                      R4 S4757000
MSNAPDIR CLC   0(1,R14),0(R15)      IN TABLE FOR                     R4 S4757500
         BH    SKIP1470              THIS LEVEL                      R4 S4758000
         TM    3(R15),X'01'        TEST BRANCH ADDR LOW-ORDER BIT    R4 S4758500
         L     R15,0(,R15)         LOAD INDICATED BRANCH ADDRESS     R4 S4759000
         BZR   R15                 GO TO ERROR ROUTINE IF NOT ODD    R4 S4759500
         TM    MFLAGS,MLOGGED      TEST FOR DIAGNOSTIC LOGGING       R4 S4760000
         BO    1(,R15)             GO TO ERR RTNE IF ALREADY LOGGED  R4 S4760500
         LA    ML,1(,R15)          SAVE BRANCH ADDR ACROSS $IOERROR  R4 S4761000
        $IOERROR (MBUF)            ISSUE I/O ERROR MESSAGE           R4 S4761500
         OI    MFLAGS,MLOGGED      SHOW MESSAGE ALREADY LOGGED      R41 S4761700
         LR    R15,ML              RESTORE ROUTINE BRANCH ADDRESS    R4 S4762000
         LA    ML,MBUFNEXT         RESTORE 1ST LEVEL RETURN ADDRESS  R4 S4762500
         BR    R15                 GO TO ERROR ROUTINE               R4 S4763000
         SPACE 1                                                     R4 S4763500
*                                                                    R4 S4764000
*                             FLUSH CANCELLED REQUESTS               R4 S4764500
*                                                                    R4 S4765000
         SPACE 1                                                     R4 S4765500
MSNACANC TM    RPLSEQTP,VSEQSPEC   TEST FOR SPECIAL SEQUENCE   @OZ41873 S4765550
         BZ    MSNAPURG            BRANCH IF NOT               @OZ41873 S4765600
         CLI   RPLSEQTP,VSEQCLOS   IF CANCELLED REQUEST WAS    @OZ41873 S4765650
         BE    MSNACLOS             CLSDST THEN FREE THE ICE   @OZ41873 S4765700
         B     MSNAXVTM            ELSE TERMINATE THE SESSION  @OZ41873 S4765750
MSNAPFLX MVI   RPLRTNCD,USFDAMGE   SIMULATE RPL                      R4 S4766000
         MVI   RPLFDB2,USFCLOCC     CANCELLED CODE                   R4 S4766500
         CLI   RPLSEQTP,VSEQRECV   TEST IF RPL TYPE IS RECEIVE       R4 S4767000
         BNE   MSNAPURG            SKIP INBND COUNT ADJUST IF NOT    R4 S4767500
         TM    RPLSRTYP,RPLRRESP   CHECK TYPE OF RECEIVE             R4 S4768000
         BZ    MVFREEIN            IF REQUEST, GO FIX INBOUND COUNT  R4 S4768500
         SPACE 1                                                     R4 S4769000
         CNOP  0,4                 ALIGN TABLE ON FULLWORD BOUNDARY  R4 S4769500
MSNAPURG LA    R14,RPLSEQTP        POINT TO RPL SEQUENCE TYPE        R4 S4770000
         BAL   R15,MSNAPDIR        LOOK UP IN FREE ROUTINE DIRECTORY R4 S4770500
         SPACE 1                                                     R4 S4771000
*                             CODES MUST APPEAR IN ASCENDING ORDER   R4 S4771500
         SPACE 1                                                     R4 S4772000
         DC    AL1(VSEQRECV),AL3(MVFREPRG)  RECEIVE - PURGE          R4 S4772500
         DC    AL1(VSEQSEND),AL3(MSNAPSN1)  SEND - MAINTAIN COUNTS   R4 S4773000
         DC    AL1(VSEQRSET),AL3(MVFREEIN)  RESET CS - MAINTAIN CTS  R4 S4773500
         DC    AL1(VSEQRSCA),AL3(MVFREPRG)  RESET CA - PURGE         R4 S4774000
         DC    X'FF',AL3(R01)      ALL OTHER CODES ARE LOGIC ERRORS  R4 S4774500
         EJECT                                                       R4 S4775000
*                                                                    R4 S4775500
*                        HANDLE PERMANENT OR ENVIRONMENTAL ERRORS    R4 S4776000
*                                                                    R4 S4776500
         SPACE 1                                                     R4 S4777000
MSNAXCLS TM    MFLAGS,MLOGGED      TEST FOR ERROR ALREADY LOGGED     R4 S4777500
         BO    MSNAXCL1            JUST ABORT IF RPL ALREADY LOGGED  R4 S4778000
        $IOERROR (MBUF)            ISSUE I/O ERROR MESSAGE           R4 S4778500
         OI    MFLAGS,MLOGGED      SHOW RPL HAS ALREADY BEEN LOGGED  R4 S4779000
         SPACE 1                                                     R4 S4779500
MSNAXCL1 LTR   MICE,MICE           TEST ICE ADDRESS                  R4 S4780000
         BZ    MVFREPRG            JUST FREE BUFFER IF ICE NOT AVAIL R4 S4780500
         TM    RPLSEQTP,VSEQSPEC   TEST L.M. CONTROL SEQ TYPE        R4 S4781000
         BNZ   MICEABRT            BRANCH IF IN SPECIAL SEQUENCE     R4 S4781500
         BAL   ML,MSNAPURG         ELSE DISPOSE OF BUFFER            R4 S4782000
         LA    ML,MBUFNEXT         RESTORE 1ST LEVEL RETURN ADDRESS  R4 S4782500
         B     MICEABRT            GO CLOSE DOWN SESSION             R4 S4783000
         SPACE 2                                                     R4 S4783500
MSNAXVTM TM    MFLAGS,MLOGGED      TEST FOR ERROR ALREADY LOGGED     R4 S4784000
         BO    MSNAXVT1            YES -- SKIP DUPLICATE MESSAGE     R4 S4784500
        $IOERROR (MBUF)            ISSUE I/O ERROR MESSAGE           R4 S4785000
         OI    MFLAGS,MLOGGED      SHOW MESSAGE ALREADY LOGGED       R4 S4785500
         SPACE 2                                                     R4 S4786000
MSNAXVT1 LTR   MICE,MICE           TEST ICE ADDRESS                  R4 S4786500
         BZ    MVFREPRG            JUST FREE BUFFER IF ICE NOT AVAIL R4 S4787000
         SPACE 1                                                    R41 S4787100
         CLI   RPLSEQTP,VSEQALOG   TEST FOR AUTOLOGON SEQUENCE TYPE R41 S4787200
         BL    MSNAXVT3            BR IF NO, SKIP RAT RESET         R41 S4787300
         CLI   RPLSEQTP,VSEQALOG+15 TEST FOR AUTLOGON SEQUENCE TYPE R41 S4787400
         BH    MSNAXVT3            BR IF NO, SKIP RAT RESET         R41 S4787500
         L     R15,ICELDCT         PICK UP ASSOCIATED LINE DCT ADDR R41 S4787600
         LTR   R15,R15             TEST FOR LINE DCT PRESENT        R41 S4787700
         BZ    MSNAXVT3            GONE, SKIP RAT RESET             R41 S4787800
         L     R15,MDCTRAT-DCTDSECT(,R15)  LOAD RAT ADDRESS         R41 S4787900
         NI    RATFLAGS-RATDSECT(R15),255-RATSRMT-RATALM RESET FLGS R41 S4788000
         SPACE 1                                                    R41 S4788100
         L     R1,$MWORK           PICK UP WORK AREA ADDRESS        R41 S4788200
         MVC   0(L'MALMSG1,R1),MALMSG1    MOVE IN MESSAGE TEXT      R41 S4788300
         USING MALMSG1,R1          TEMPORARY MESSAGE ADDRESSABILITY R41 S4788400
         MVC   MALMSGR,RATNAME-RATDSECT(R15)  MOVE IN RMT NAME      R41 S4788500
         DROP  R1                  RELEASE MSG ADDRESSABILITY       R41 S4788600
         SPACE 1                                                    R41 S4788700
         $WTO  (R1),L'MALMSG1,WAIT=NO,JOB=NO,    ISSUE MESSAGE      R41CS4788800
               ROUTE=$LOG+$TP+$ERR,CLASS=$ALWAYS,PRI=$HI            R41 S4788900
         EJECT                                                      R41 S4789000
MSNAXVT3 TM    RPLSEQTP,VSEQSPEC   TEST L.M. CONTROL SEQ TYPE       R41 S4789100
         BNZ   MICEABDN            BRANCH IF IN SPECIAL SEQUENCE    R41 S4789200
         BAL   ML,MSNAPURG          ELSE DISPOSE OF BUFFER          R41 S4789300
         LA    ML,MBUFNEXT         RESTORE 1ST LEVEL RETURN ADDRESS R41 S4789400
         B     MICEABDN            ABANDON SESSION WITHOUT CLOSING   R4 S4789500
         EJECT                                                       R4 S4790000
MSNALOGN DS    0H                  PROCESS SNA LOGON SEQUENCE        R4 S4790500
         SLL   R14,2               ADJUST RPL SUBSEQ FOR SCAN        R4 S4791000
         L     R1,MSNALTAB-4(R14)  GET ADDR OF SUBSEQ ROUTINE       R41 S4791500
         L     MBASE1,MSNALTAB     SET LOGON SEQUENCE BASE     @OZ41884 S4791750
         BR    R1                  ENTER PROCESSING ROUTINE          R4 S4792000
         SPACE 1                                                     R4 S4792500
MSNALTAB DS    0F                  LOGON SEQUENCE BRANCH TABLE       R4 S4793000
         DC    AL1(X'80'),AL3(MSNALDEV)  INQ DEVCHAR COMPLETE  @OZ41884 S4794000
         DC    A(MSNALPAR)         INQUIRE SESSPARM COMPLETE         R4 S4794500
         DC    A(MSNALOPD)         OPNDST  ACCEPT   COMPLETE         R4 S4795000
         SPACE 1                                               @OZ41884 S4795325
         LTORG                                                 @OZ41884 S4795350
         DROP  MBASE1                                          @OZ41884 S4795375
         SPACE 2                                                     R4 S4795500
         EJECT                                                       R4 S4815000
         USING NIBDSECT,R15        ESTABLISH NIB  ADDRESSABILITY     R4 S4815500
         USING MSNALDEV,MBASE1     SET LGN SEQ ADDRESSABILITY  @OZ41884 S4815750
MSNALDEV L     R15,RPLARG          GET ADDRESS OF NIB FROM RPL       R4 S4816000
         CLI   DEVTCODE,DEVLU      CHECK FOR LU TYPE TERMINAL        R4 S4816500
         BNE   MSNALINV            REJECT LOGON REQUEST IF NOT      R41 S4817000
         LA    R14,RPLBUFST+NIBSIZE GET AREA ADDR FOR SESSPARM       R4 S4817500
         ST    R14,RPLAREA         STORE AREA ADDRESS IN RPL         R4 S4818000
         ST    R14,NIBNDAR         STORE AREA ADDRESS IN NIB         R4 S4818500
         LH    R1,$BFSZSNA         GET LENGTH OF SNA BUFFER          R4 S4819000
         LA    R1,RPLBUFST(R1)     CALCULATE END OF BUFFER ADDR      R4 S4819500
         SR    R1,R14               AND REMAINING DATA AREA LEFT     R4 S4820000
         ST    R1,RPLBUFL          STORE IN RPL FOR INQUIRE          R4 S4820500
         MVI   RPLOPT9,0           CLEAR INQUIRE DEVCHAR INDICATOR   R4 S4821000
         MVI   RPLOPT10,RPLSPARM   SHOW INQUIRE SESSPARM REQUEST     R4 S4821500
         NI    RPLSEQTP,X'F0'      SHOW RPL INQUIRE SESSION         R41 S4821600
         OI    RPLSEQTP,VSEQLPAR    PARAMTERS SPECIAL SEQUENCE      R41 S4822000
         NI    ICEINDEX,X'F0'      INDICATE SESSION IN              R41 S4822100
         OI    ICEINDEX,VSEQLPAR    INQUIRE SESSPARM STATUS         R41 S4822500
         B     MVRPLXEC            GO TO PASS REQUEST TO VTAM        R4 S4823000
         DROP  R15                 RELEASE NIB ADDRESSABILITY        R4 S4823500
         EJECT                                                 @OZ32567 S4824000
         USING BINDSECT,R14        ESTABLISH BIND ADDRESSABILITY     R4 S4824500
         USING NIBDSECT,R15        ESTABLISH NIB  ADDRESSABILITY     R4 S4825000
MSNALPAR L     R14,RPLAREA         GET ADDR OF BIND IMAGE            R4 S4825500
         L     R15,RPLARG          GET ADDR OF NIB                   R4 S4826000
         IC    R0,BINUSEL          GET LENGTH  OF USER DATA          R4 S4826500
         LA    R1,BINUSE           GET ADDRESS OF USER DATA          R4 S4827000
         NC    BINDSECT(L'MBNDMASK),MBNDMASK ISOLATE VARIABLE PARMS  R4 S4827500
         MVC   ICEBIND,MSNABIND    MOVE DEFAULT BIND IMAGE TO ICE    R4 S4828000
         OC    ICEBIND(L'MBNDMASK),BINDSECT MERGE FIXED & VAR PARMS  R4 S4828500
         LA    R14,ICEBIND         GET  DEFAULT BIND IMAGE ADDR      R4 S4829000
         ST    R14,NIBNDAR         SET NIB POINTER TO BIND IMAGE     R4 S4829500
         L     WA,NIBRAT           PICK UP PRE-CONNECT RAT          R41 S4829600
         L     MDCT,ICELDCT         AND LINE DCT ADDRESSES          R41 S4829700
         DROP  R14,R15             DROP BIND/NIB ADDRESSABILITY      R4 S4830000
         SPACE 1                                                    R41 S4830100
         LTR   WA,WA               RAT ADDRESS PRESENT...           R41 S4830200
         BNZ   MSNALACQ            BR IF YES, GO DO OPNDST AQUIRE   R41 S4830300
         SPACE 1                                                    R41 S4830500
         $QSUSE TYPE=TEST          TEST STATUS OF SHARED QUES  @OZ32567 S4830600
         BNZ   MREQBUF             IF NOT OWNED, REQUEUE BUFR  @OZ32567 S4830700
         SPACE 1                                               @OZ32567 S4830800
         MVI   MSLGNWRK,C' '       MOVE BLANK TO LOGON WORKAREA      R4 S4831000
         MVC   MSLGNWRK+1(MSLGNLEN-1),MSLGNWRK   CLEAR THE AREA      R4 S4831500
         BAL   R14,MDELSCAN        SCAN FOR REMOTE NAME              R4 S4832000
         B     MSNALINV            REJECT LOGON IF BAD NAME          R4 S4832500
         EX    R15,MSNALRMT        MOVE NAME TO WORKAREA             R4 S4833000
         BAL   R14,MDELSCAN        SCAN FOR LINE PASSWORD            R4 S4833500
         B     MSNALINV            REJECT LOGON IF BAD PSWD          R4 S4834000
         EX    R15,MSNALNPW        MOVE LINE PASSWORD                R4 S4834500
         BAL   R14,MDELSCAN        SCAN FOR REMOTE PASSWORD          R4 S4835000
         B     MSNALINV            REJECT LOGON IF BAD PSWD          R4 S4835500
         EX    R15,MSNALRPW        MOVE LINE PASSWORD                R4 S4836000
         BAL   R14,MDELSCAN        SCAN FOR LOGON MODE               R4 S4836500
         B     MSNALINV            REJECT LOGON IF BAD MODE          R4 S4837000
         EX    R15,MSNALMOD        MOVE LOGON MODE                   R4 S4837500
         EJECT                                                       R4 S4838000
         USING RATDSECT,WA         PROVIDE RAT ADDRESSABILITY        R4 S4838500
         LH    R0,$NUMRJE          GET NUMBER OF REMOTES             R4 S4839000
         L     WA,$RATABLE         GET ADDRESS OF RAT                R4 S4839500
         LA    R14,ICESYMB         GET ADDR OF SESSION  SYMB NAME    R4 S4840000
         LA    R1,RATSYMB-RATDSECT GET DISP OF REMOTE   SYMB NAME    R4 S4840500
         CLI   MSLGNAME,C' '       HAS REMOTE NAME BEEN SPECIFIED    R4 S4841000
         BE    MSNALOCA            SEARCH REMOTE USING  SYMB NAME    R4 S4841500
         LA    R14,MSLGNAME        GET ADDR OF LOGON RMTE NAME       R4 S4842000
         LA    R1,RATNAME-RATDSECT GET DISP OF TERMINAL RMTE NAME    R4 S4842500
         CLC   =C'RMT',MSLGNAME    CHECK IF SHORT RMTE NAME GIVEN    R4 S4843000
         BE    MSNALOCA            BRANCH TO LOCATE OUR REMOTE       R4 S4843500
         CLC   =C'REMOTE',MSLGNAME CHECK FOR CORRECT LONG FORM       R4 S4844000
         BNE   MSNALINV            REJECT LOGON IF IN ERROR          R4 S4844500
         MVC   MSLGNRMT(3),=C'RMT' MOVE SHORT FORM TO WORKAREA       R4 S4845000
         MVC   MSLGNRMT+3(2),MSLGNAME+6 COPY REMOTE NUMBER     @OZ49222 S4845500
         LA    R14,MSLGNRMT        POINT TO SHORT REMOTE NAME        R4 S4846000
         SPACE 1                                                     R4 S4846500
MSNALOCA LA    R15,RATDSECT(R1)    GET ADDR OF RAT ENTRY FIELD       R4 S4847000
         CLC   0(8,R14),0(R15)     CHECK IF THIS IS OUR REMOTE       R4 S4847500
         BE    MSNALFND            BRANCH IF CORRECT ENTRY FOUND     R4 S4848000
         LA    WA,RATTLE(,WA)      STEP TO NEXT RAT ENTRY            R4 S4848500
         BCT   R0,MSNALOCA         CHECK FOR END OF RAT              R4 S4849000
         B     MSNALINV            GO ISSUE LOGON FAILED MSG   @OZ27491 S4849020
         EJECT                                                 @OZ27491 S4849040
MSNASMF  CLI   $NUMSMFB,2          CHECK SMF OPTIONS           @OZ27491 S4849060
         BL    MSNALINV            BRANCH IF NO SMF REQUIRED   @OZ27491 S4849080
        $GETSMFB WAIT=NO           GET AN SMF BUFFER           @OZ27491 S4849100
         BZ    MSNALINV            BRANCH IF NO SMF BUFFER     @OZ27491 S4849120
         USING SMFDSECT,R1         SMF ADDRESSABILITY          @OZ27491 S4849140
         MVI   SMFRDW+1,SMF54END-SMFRDW  SET RECORD LENGTH     @OZ27491 S4849160
         MVI   SMFHDRTY,SMF54      SET SMF RECORD TYPE         @OZ27491 S4849180
         MVI   SMFPROFF+1,SMFSUBID-SMFJMR  OFFSET TO PROD SECT @OZ27491 S4849190
         MVI   SMFPRLEN+1,SMFIDSEC-SMFSUBID  PROD SEC LENGTH   @OZ27491 S4849200
         MVI   SMFPRNUM+1,1        PRODUCT SECTION NUMBER      @OZ27491 S4849210
         MVI   SMFIDOFF+1,SMFIDSEC-SMFJMR  OFFSET TO ID SECT   @OZ27491 S4849220
         MVI   SMFIDNUM+1,1        ID SECTION NUMBER           @OZ27491 S4849230
         MVC   SMFVERNO,=C'01'     VERSION NUMBER              @OZ27491 S4849240
         MVC   SMFSYSNM,=C'JES2'   SUBSYSTEM NAME              @OZ27491 S4849250
         MVI   SMFSUBID+1,SMFLOGON INDICATE LOGON EVENT        @OZ27491 S4849280
         MVI   SMFIDLEN+1,SMF54END-SMFIDSEC  ID SEC LENGTH     @OZ27491 S4849300
         MVC   SMF54RPW,MSLGNRPW   REMOTE PASSWORD             @OZ27491 S4849340
         MVC   SMF54PSW,MSLGNLPW   LINE PASSWORD               @OZ27491 S4849360
         MVC   SMF54RMT,RATNAME    REMOTE NAME                 @OZ27491 S4849380
        $QUESMFB                   QUEUE THE SMF RECORD        @OZ27491 S4849400
         DROP  R1                  RELEASE SMF ADDRESSABILITY  @OZ27491 S4849420
         SPACE 1                                                     R4 S4849500
MSNALINV L     MDCT,ICEADCT        RELOAD LOGON DCT ADDRESS         R41 S4849600
         L     R1,MDCTINVL         GET LOGON FAILED FOR PARM COUNT  R41 S4850000
         LA    R1,1(,R1)           INCREMENT LOGON FAILED COUNT      R4 S4850500
         ST    R1,MDCTINVL         STORE UPDATED COUNTER VALUE       R4 S4851000
*              THIS LINE DELETED BY APAR NUMBER                @OZ27491 S4851500
         L     R1,$MWORK           GET MESSAGE WORKAREA ADDR         R4 S4852000
         MVC   0(L'MLGIMSG,R1),MLGIMSG MSG TARGET TO WORKAREA        R4 S4852500
         USING MLGIMSG,R1          PROVIDE MSG ADDRESSABILITY        R4 S4853000
         MVC   MLGILOG,DCTDEVN     MOVE LOGON DCT NAME TO MSG        R4 S4853500
         MVC   MLGISYM,ICESYMB     MOVE SESSION SYMB NAME TO MSG     R4 S4854000
         LA    R0,L'MLGIMSG        GET MESSAGE LENGTH FOR $WTO       R4 S4854500
         B     MSNALREJ            BRANCH TO REJECT THIS LOGON       R4 S4855000
         DROP  R1                  RELEASE MSG ADDRESSABILITY        R4 S4855500
         EJECT                                                      R41 S4855600
MDELSCAN DS    0H                  DELIMITER SCAN SUBROUTINE        R41 S4855700
         LTR   R15,R0              CHECK AND SAVE FIELD LENGTH      R41 S4855800
         BMR   R14                 ERROR RETURN IF INVALID LENGTH   R41 S4855900
         BZ    8(0,R14)            NOP RETURN IF EMPTY FIELD LENGTH R41 S4856000
         LR    WA,R1               SAVE FIELD START POINTER VALUE   R41 S4856100
         CLI   0(R1),C'('          CHECK FOR OPEN PARENTHESIS       R41 S4856200
         BNE   MDELCHCK            BRANCH IF NOT PRESENT            R41 S4856300
         LA    WA,1(0,R1)          STEP PAST OPEN PARENTHESIS       R41 S4856400
         BCT   R15,MDELINCR        DECREASE & CHECK FIELD LENGTH    R41 S4856500
         BR    R14                 ERROR RETURN IF INVALID SYNTAX   R41 S4856600
         SPACE 1                                                    R41 S4856700
MDELCHCK CLI   0(R1),C' '          CHECK FOR BLANK CHARACTER        R41 S4856800
         BE    MDELBLNK            BRANCH IF END OF STRING          R41 S4856900
         CLI   0(R1),C','          CHECK FOR COMMA AS DELIMITER     R41 S4857000
         BE    MDELCOMA            BRANCH IF END OF SUBSTRING       R41 S4857100
         CLI   0(R1),C')'          CHECK FOR CLOSE PARENTHESIS      R41 S4857200
         BE    MDELBLNK            HANDLE AS BLANK DELIMITER        R41 S4857300
         SPACE 1                                                    R41 S4857400
MDELINCR LA    R1,1(0,R1)          ADVANCE STRING POINTER           R41 S4857500
         BCT   R0,MDELCHCK         CHECK FOR END OF FIELD           R41 S4857600
         B     MDELBLNK            BRANCH IF END OF FIELD REACHED   R41 S4857700
         SPACE 1                                                    R41 S4857800
MDELCOMA LA    R1,1(0,R1)          STEP POINTER OVER COMMA          R41 S4857900
         BCTR  R0,0                UPDATE FIELD LENGTH VALUE        R41 S4858000
         BCTR  R15,0               ADJUST OLD TARGET LENGTH VALUE   R41 S4858100
         SPACE 1                                                    R41 S4858200
MDELBLNK BCTR  R15,0               DECREMENT FOR MACHINE LENGTH     R41 S4858300
         SR    R15,R0              CALCULATE SUBSTRING LENGTH - 1   R41 S4858400
         BM    8(0,R14)            NOP RETURN IF EMPTY SUBSTRING    R41 S4858500
         CH    R15,=H'8'           CHECK FOR MAXIMUM STRING LENGTH  R41 S4858600
         BL    4(0,R14)            RETURN WITH OPERAND IF GOOD      R41 S4858700
         BR    R14                 ERROR RETURN IF TOO LONG         R41 S4858800
         EJECT                                                       R4 S4858900
MSNALFND CLC   RATPSWD,MSLGNRPW    DO REMOTE PASSWORDS MATCH         R4 S4859000
         BNE   MSNASMF             RECORD SMF,THEN FAIL LOGON  @OZ27491 S4859100
         TM    RATTYPE,DCTPSNA     CHECK REMOTE TYPE                 R4 S4859200
         BNO   MSNALINV            INVALID IF NOT SNA                R4 S4859300
         SPACE 2                                                     R4 S4859400
         L     MDCT,RATLDCT        GET ADDRES OF LINE (OR ZERO)     R41 S4859500
*              THIS LINE DELETED BY APAR NUMBER                @OZ32567 S4859600
         LA    R15,MSNAIDL-MDCTADCT+DCTDSECT  SET UP PHONY LINE DCT R41 S4860100
         LTR   MDCT,MDCT           TRY TO GET A LINE IF NOT          R4 S4860500
         BZ    MSNALGET            TRY TO GET A LINE IF NOT          R4 S4861000
         DROP  MDCT                DROP LOGON DCT ADDRESSABILITY     R4 S4861500
         EJECT                                                       R4 S4862000
         USING DCTDSECT,MDCT       SET LINE ADDRESSABILITY           R4 S4862500
         OC    MDCTDCT,MDCTDCT     TEST FOR RMT ALREADY CONNECTED   R41 S4863000
         BZ    MSNALREM            REMOVE LINE FROM IDLE CHAIN       R4 S4863500
         SPACE 1                                                    R41 S4863600
         SPACE 1                                                     R4 S4864000
         CLC   RATRDCT,MDCTDCT     IS OUR REMOTE ACTIVE ON LINE      R4 S4864500
         BNE   MSNALNOT            REJECT LOGON IF NOT               R4 S4865000
*              THIS LINE DELETED BY APAR NUMBER                @OZ41377 S4865500
*              THIS LINE DELETED BY APAR NUMBER                @OZ41377 S4866000
         CLC   MSLGNLPW,MDCTPSWD   DO LINE PASSWORDS MATCH           R4 S4866500
         BNE   MSNASMF             RECORD SMF,THEN FAIL LOGON  @OZ27491 S4867000
         B     MSNALACC            BRANCH TO ACCEPT MULTIPLE LOGON   R4 S4867500
         SPACE 1                                                     R4 S4868000
MSNALGET L     MDCT,MDCTADCT-DCTDSECT(,R15)  GET NEXT IDLE LINE DCT  R4 S4868500
         LTR   MDCT,MDCT           CHECK FOR ANY MORE LINES          R4 S4869000
         BZ    MSNALNOT            REJECT LOGON IF NO IDLE LINE      R4 S4869500
         TM    MDCTSTAT,DCTLEASE   CHECK FOR LEASED LINE DCT         R4 S4870000
         BO    MSNALGNX            SKIP THIS LINE DCT IF LEASED     R41 S4870500
         OC    MDCTRAT,MDCTRAT     CHECK FOR PRE-CONNECTED LINE     R41 S4870600
         BNZ   MSNALGNX            BR IF YES, SKIP LINE             R41 S4870700
         CLC   MDCTPSWD,MSLGNLPW   COMPARE LINE PASSWORDS            R4 S4871000
         BE    MSNALDSC            ALLOC THIS LINE IF PSWD MATCH     R4 S4871500
MSNALGNX LR    R15,MDCT            SAVE PRECEEDING LNE DCT ADDRESS  R41 S4872000
         B     MSNALGET            GO TO CHECK NEXT LINE DCT         R4 S4872500
         SPACE 1                                                     R4 S4873000
MSNALREM L     R1,MDCTADCT-DCTDSECT(,R15) GET ADDR OF NEXT LINE DCT  R4 S4873500
         CLR   R1,MDCT             IS THIS DCT POINTING TO OURS      R4 S4874000
         BE    MSNALDSC            BRANCH TO DISC OUR DCT IF YES     R4 S4874500
         LTR   R15,R1              CHECK FOR END OF CHAIN            R4 S4875000
         BNZ   MSNALREM            BRANCH TO TEST NEXT LINE DCT      R4 S4875500
         B     MSNALNOT            REJECT LOGON IF DCT NOT ACTIVE    R4 S4876000
         SPACE 2                                                    R41 S4876100
MSNALDSC DS    0H                                                   R41 S4876200
         TM    RATFLAGS,RATPILUN   TEST FOR LUNAME SPECIFIED        R41 S4876300
         BO    MSNALMVE            YES, BYPASS MOVE            @OZ41377 S4876400
*              THIS LINE DELETED BY APAR NUMBER                @OZ41377 S4876500
*              THIS LINE DELETED BY APAR NUMBER                @OZ41377 S4876600
         MVC   RATSYMB(8),ICESYMB  MOVE IN LUNAME              @OZ41377 S4876700
MSNALMVE LR    R0,WA               COPY RAT OFFSET             @OZ41377 S4877000
         SL    R0,$RATABLE         R0 = (RMT NO -1) * RATTLE         R4 S4877500
         LR    R1,R0               MULTIPLY                          R4 S4878000
         ALR   R1,R0                BY                               R4 S4878500
         ALR   R1,R0                 THREE                           R4 S4879000
         SLR   R0,R0               DIVIDE BY EIGHT AND               R4 S4879500
         D     R0,=A(RATTLE)        RATTLE GIVING OFFSET TO          R4 S4880000
         D     R0,=A(8)              BYTE (QUOT) AND BIT (REMAIN)    R4 S4880500
         AL    R1,$RMTSON          R1 = BYTE ADDR OF SIGNON BITS     R4 S4881000
         LR    R14,R0              MOVE BIT OFFSET                   R4 S4881500
         L     R0,=A(QUEBUSY*X'2000')  GET BIT TO TEST BUSY          R4 S4882000
         SRL   R0,0(R14)           SHIFT TO BIT OFFSET               R4 S4882500
         STH   R0,MSONWORK         STORE IN WORK AREA FOR TEST       R4 S4883000
         NC    MSONWORK,0(R1)      TEST FOR RMT ON ANY OTHER SYSTEM  R4 S4883500
         BNZ   MSNALNOX            BRANCH IF YES, --INVALID SIGNON  R41 S4884000
         SLR   R0,R0               GET BUSY BITS                     R4 S4884500
         ICM   R0,4,$SIDBUSY         FOR THIS SYSTEM                 R4 S4885000
         SRL   R0,3(R14)           SHIFT TO BIT OFFSET               R4 S4885500
         STH   R0,MSONWORK         STORE IN WORK AREA FOR SET        R4 S4886000
         OC    0(2,R1),MSONWORK    SET BITS -- SHOW RMT ON SYSTEM    R4 S4886500
         SPACE 2                                                     R4 S4887000
         L     R0,MDCTADCT         PICK UP NEXT LINE DCT ADDRESS     R4 S4887500
         ST    R0,MDCTADCT-DCTDSECT(,R15) REMOVE LINE DCT FROM CHAIN R4 S4888000
         SPACE 1                                                     R4 S4888500
         L     R1,MSNALNE          GET ADDR OF 1ST ALLOCATED LINE    R4 S4889000
         ST    R1,MDCTADCT         CHAIN ALLOC LINES TO OUR LINE     R4 S4889500
         ST    MDCT,MSNALNE        UPDATE LINE MGR ALLOC CHAIN       R4 S4890000
         ST    MDCT,RATLDCT        STORE LINE DCT IN RAT             R4 S4890500
         NI    DCTFLAGS,DCTLOGAL   RESET FLAGS -EXCEPT LOGGING      R41 S4891500
         L     R1,RPLDCT           PICK UP LOGON DCT ADDRESS        R41 S4891600
         ST    R1,DCTDCB           STORE LOGON DCT ADDRESS IN LINE  R41 S4892000
         ST    WA,MDCTRAT          STORE RAT ADDRESS IN LINE DCT     R4 S4892500
         L     R15,RATRDCT         GET ADDR OF FIRST REMOTE DCT      R4 S4893000
         ST    R15,MDCTDCT         STORE REMOTE DCT CHAIN IN LINE    R4 S4893500
         DROP  MDCT                DROP LINE DCT ADDRESSABILT        R4 S4895000
         EJECT                                                       R4 S4899500
         USING DCTDSECT,MDCT       GET LINE DCT ADDRESSABILITY       R4 S4900000
         USING BINDSECT,R15        GET BIND ADDRESSABILITY     @OZ41377 S4900100
MSNALACC LA    R15,ICEBIND         LOAD BIND IMAGE ADDRESS     @OZ41377 S4900200
         ST    MDCT,ICELDCT        STORE LINE DCT IN ICE       @OZ41377 S4900300
         LR    R0,R2               SAVE REG2                   @OZ41377 S4900400
         LA    R14,MDCTICE-(ICEALCHN-ICEDSECT) ALCHN OFFSET    @OZ41377 S4900500
MSNALACD LR    R2,R14              BACKUP PREVIOUS ICE PTR     @OZ41377 S4900600
         L     R14,ICEALCHN-ICEDSECT(,R14) GET NEXT ICE PTR    @OZ41377 S4900700
         LTR   R14,R14             IS THERE ONE...             @OZ41377 S4900800
         BZ    MSNALACE            NO, FINISH CHAINING         @OZ41377 S4900900
         LA    R1,ICEBIND-ICEDSECT(,R14) POINT TO BIND IMAGE   @OZ41377 S4901000
         CLC   BINRPACE-BINDSECT(,R1),BINRPACE PREV PACE HIGH  @OZ41377 S4901100
         BH    MSNALACD            YES, CHECK NEXT ICE PACE    @OZ41377 S4901200
         ST    R14,ICEALCHN        NEW PACE HIGHER, CHAIN ICE  @OZ41377 S4901500
MSNALACE ST    MICE,ICEALCHN-ICEDSECT(,R2)  NEW ICE IN CHAIN   @OZ41377 S4902000
         LR    R2,R0               RESTORE REG2                @OZ41377 S4902500
         LH    R1,MDCTSNCT         GET LOGGED ON ICE COUNT           R4 S4903000
         LA    R1,1(,R1)           INCREMENT COUNT BY ONE            R4 S4903500
         STH   R1,MDCTSNCT         STORE UPDATED ICE COUNTER         R4 S4904000
         CH    R1,=H'0001'         FIRST SESSION....           @OZ44410 S4904010
         BNE   MSNALACQ            IF NOT, CONTINUE            @OZ44410 S4904020
         OI    ICEFLGS2,ICE1STLU   SET SMF REQUIRED FLAG.      @OZ44410 S4904030
         SPACE 1                                                     R4 S4904500
MSNALACQ LTR   MDCT,MDCT           TEST FOR LINE DCT PRESENT        R41 S4904600
         BZ    MSNALABN            GONE, GO ABANDON LOGON ATTEMPT   R41 S4904700
         STCM  MDCT,7,RPLDCT+1     STORE LINE DCT ADDREES IN RPL    R41 S4904800
         LH    R1,RATBUFSZ         OBTAIN TERMINAL BUFFER SIZE       R4 S4905000
         STH   R1,ICERULEN         SET MAXIMUM R.U. LENGTH          R41 S4905200
         BAL   R14,MSNALGTH        CONVERT TO BIND-STYLE FLOATING PT R4 S4905500
         MVC   MDCTIMOK,MCLOCK     SET TIME FOR DISCONNECT CHECK    R41 S4905600
         OI    MSTQE+IPOST,X'20'   KICK OFF TIMER PULSES            R41 S4905700
         SPACE 1                                                     R4 S4906000
         USING BINDSECT,R15        ESTABLISH BIND ADDRESSABILITY     R4 S4906500
         LA    R15,ICEBIND         GET ADDR OF SESSION BIND IMAGE    R4 S4907000
         TM    RATFLAGS,RATEXCH    TEST FOR EXCHANGE MEDIA     @OZ29180 S4907050
         BZ    MSNALNEX            BRANCH IF NOT EXCHANGE      @OZ29180 S4907100
         OI    19(R15),X'20'       ALLOW SENDING EXCHANGE      @OZ29180 S4907150
MSNALNEX TM    RATFLAGS,RATCARD    TEST FOR CARD MEDIA         @OZ29180 S4907200
         BZ    MSNALPUN            NO, DO NOT BIND FOR CARDS   @OZ29180 S4907250
         OI    19(R15),X'40'       INDICATE CARD FORMAT ALLOWED     R41 S4907300
MSNALPUN TM    RATFEAT,DCTPPRES    COMPRESSION OPTION SELECTED      R41 S4907500
         BZ    MSNALLTH            SKIP IF NOT SELECTED             R41 S4908000
         OI    BINPRIP,BINPCMP     SHOW PRIMARY WILL SEND COMPRESSED R4 S4908500
MSNALLTH STC   R1,BINSRUSZ         SET MAXIMUM INBOUND RU SIZE      R41 S4909000
         STC   R1,BINPRUSZ         SET MAXIMUM OUTBOUND RU SIZE     R41 S4909500
         MVC   BINPRIM(8),ICESYMB  MOVE PRIMARY LU NAME TO BIND      R4 S4910000
         TM    RATFEAT,DCTPSHDR    PDIR OPTION SELECTED             R41 S4910300
         BNO   MSNALHDR            NO, DO NOT BIND FOR PDIR         R41 S4910400
         OI    15(R15),X'20'       YES, BIND FOR PDIR               R41 S4910500
MSNALHDR TM    RATFEAT,DCTPCPCT    COMPACTION OPTION SELECTED       R41 S4910600
         BNO   MSNALCPT            NO, DO NOT BIND FOR COMPACTION   R41 S4910700
         OI    15(R15),X'40'       YES, BIND FOR COMPACTION         R41 S4910800
         MVI   ICEACPTN,X'FF'      FORCE COMPACTION TABLE SEND      R41 S4910900
MSNALCPT MVC   BINPRIM(8),ICESYMB  MOVE PRIMARY LUNAME TO BIND      R41 S4911000
         TM    BINCMNP,BINALT      ALTERNATE CODE SPECIFIED    @OZ34412 S4911020
         BZ    MSNANALT            NO, SKIP NEXT               @OZ34412 S4911040
         NI    BINSECP,255-BINSCMP YES, SUPPRESS COMPRESSION   @OZ34412 S4911060
MSNANALT NI    ICEINDEX,X'F0'      SHOW SESSION IN             @OZ34412 S4911100
         OI    ICEINDEX,VSEQLOPD    OPNDST SPECIAL SEQUENCE         R41 S4911200
         NI    RPLSEQTP,X'F0'      INDICATE RPL IS                  R41 S4911300
         OI    RPLSEQTP,VSEQLOPD    OPNDST REQUEST TYPE             R41 S4911500
         MVI   RPLREQ,RPLOPNDS     SET REQUEST TYPE TO OPNDST       R41 S4911600
         NI    RPLOPT5,255-RPLDLGIN-RPLNODE SHOW SPEC AND CA OPT     R4 S4912000
         NI    RPLOPT7,255-RPLQOPT RESET RPL QUEUEING OPTION         R4 S4912500
         MVI   ICEINLM+1,6         SET SESSION INBOUND LIMIT   @OZ27423 S4913000
         MVI   ICEOUTLM+1,3        SET SESSION OUTBOUND LIMIT  @OZ27423 S4913500
         B     MVRPLXEC            BRANCH TO PASS REQ TO VTAM        R4 S4914500
         EJECT                                                      R41 S4915000
MSNALNOT L     MDCT,ICEADCT        RELOAD LOGON DCT ADDRESS          R4 S4915500
         L     R1,MDCTNLNE         GET LOGON FAILED FOR LINE CNTR    R4 S4916000
         LA    R1,1(,R1)           INCREMT LOGON FAILED COUNTER      R4 S4916500
         ST    R1,MDCTNLNE         STORE UPDATED COUNTER VALUE       R4 S4917000
MSNALNOX CLI   RPLSEQTP,VSEQALOG+VSEQLPAR  TEST RPL SEQUENCE TYPE   R41 S4917100
         BE    MSNALABN            BRANCH IF AUTOLOGON, ABANDON     R41 S4917200
         L     R1,$MWORK           GET MESSAGE WORKAREA ADDRESS     R41 S4917500
         MVC   0(L'MLGFMSG,R1),MLGFMSG MSG TARGET TO WORKAREA        R4 S4918000
         USING MLGFMSG,R1          PROVIDE MSG ADDRESSABILITY        R4 S4918500
         MVC   MLGFRMT,RATNAME     MOVE REMOTE NAME TO MESSAGE       R4 S4919000
         MVC   MLGFSYM,ICESYMB     MOVE SESSION SYMB NAME TO MSG     R4 S4919500
         LA    R0,L'MLGFMSG        GET LENGTH OF ERROR MESSAGE       R4 S4920000
         DROP  R1                  RELEASE MSG ADDRESSABILITY        R4 S4920500
         SPACE 1                                                     R4 S4921000
MSNALREJ DS    0H                  REJECT LOGON REQUEST IN ERROR     R4 S4921500
        $WTO   (R1),(R0),JOB=NO,WAIT=NO, ISSUE ERROR MESSAGE           CS4922000
               ROUTE=$LOG+$ERR+$TP,CLASS=$ALWAYS,PRI=$HI             R4 S4922500
         LH    R14,$BFSZSNA        RESET LENGTH SHORTENED FOR NIB    R4 S4923000
         ST    R14,RPLBUFL          BACK TO FULL SNA BUFFER SIZE     R4 S4923500
         MVI   RPLSEQTP,VSEQCLOS   SHOW SESSION CLSDST SEQ IN RPL    R4 S4924000
         MVI   ICEINDEX,VSEQCLOS   INDICATE SESSION CLSDST STATUS    R4 S4924500
         MVI   RPLREQ,RPLCLOSE     SHOW RPL CLSDST REQUEST TYPE      R4 S4925000
         OI    ICESTAT,ICEDRAIN    SHOW ICE TO BE FREED AFTER CLSDST R4 S4925500
         B     MVRPLXEC            BRANCH TO PASS REQ TO VTAM        R4 S4926000
         DROP  WA                  RELEASE RAT ADDRESSABILITY        R4 S4926500
         SPACE 2                                                    R41 S4926600
MSNALABN MVI   ICEINDEX,0          CLEAR ICE INDEX FOR ABANDON      R41 S4926700
         B     MICEABRT            ABORT SESSION ATTEMPT TO LOGON   R41 S4926800
         EJECT                                                       R4 S4927000
MSNALOPD LH    R14,$BFSZSNA        RESET LENGTH SHORTENED FOR NIB   R41 S4927500
         ST    R14,RPLBUFL          BACK TO FULL SNA BUFFER SIZE    R41 S4927600
         SPACE 1                                                    R41 S4927700
         NI    ICESTAT,255-ICEHOLD-ICEABORT ALLOW ICE ALLOCATION    R41 S4927800
         MVI   ICEINDEX,VSEQNORM   SHOW SESSION  IN NORMAL  STATUS  R41 S4927900
         MVI   ICERCVST,ICENOFMH   SHOW RECV OUT OF STREAM  STATUS  R41 S4928000
         MVI   ICESNDST,ICENOFMH   SHOW SEND OUT OF STREAM  STATUS  R41 S4928100
         NI    ICEFLGS2,255-ICESIGNL-ICEOUTBK-ICEBREAK         @OZ29180 S4928150
         LA    R15,RPLBUFST        POINT TO NIB                @OZ41884 S4928200
         USING NIBDSECT,R15        SET NIB ADDRESSABILITY      @OZ41884 S4928250
         TM    NIBFLG1,NIBCON      TEST IF SESSION CONNECTED   @OZ41884 S4928300
         BO    MSNALCON            BRANCH IF CONNECTED         @OZ41884 S4928350
         DROP  R15                 SUSPEND NIB ADDRESSABILITY  @OZ41884 S4928400
         ST    R0,ICEBUFAD         CLEAR SPEC SEQ BUF ADDR     @OZ41884 S4928425
         L     R15,=A(MSNAXVTM)    POINT TO TERMINATION RTN    @OZ41884 S4928450
         L     MBASE1,MBUFSNAP     SET MSNAPROC BASE           @OZ41884 S4928475
         BR    R15                 TERMINATE THE SESSION       @OZ41884 S4928500
         SPACE 1                                               @OZ41884 S4928550
MSNALCON MVC   ICECID,RPLARG       MOVE CID OF SESSION TO ICE  @OZ41884 S4928600
         L     MDCT,ICELDCT        RELOAD ICE ADDRESS               R41 S4928700
         LTR   MDCT,MDCT           TEST FOR LINE DCT PRESENT        R41 S4928800
         BZ    MICEABRT            GONE, SESSION ABORTED            R41 S4928900
         ST    R0,ICEBUFAD         CLEAR SPEC SEQ BUF ADDR     @OZ41884 S4929000
         MVI   ICEFLAGS,ICECNECT   SHOW SESSION CONNECTED           R41 S4929100
         SPACE 1                                                    R41 S4929200
         L     R15,MDCTRAT         GET RAT  ENTRY ADDRESS           R41 S4929300
         USING RATDSECT,R15        ESTABLISH RAT ADDRESSABILITY     R41 S4929400
         OI    MDCTSTAT,DCTSINON   SHOW REMOTE SIGNED ON LINE       R41 S4929500
         L     R14,MDCTDCT         PICK UP FIRST REMOTE DCT ADDRESS R41 S4929600
         USING DCTDSECT,R14        GET REMOTE DCT ADDRESSABILITY    R41 S4929700
MSNALSON OI    MDCTSTAT,DCTSINON   SHOW REMOTE IS SIGNED ON         R41 S4929800
         ST    MDCT,DCTDCB         STORE LINE DCT ADDRESS IN REMOTE R41 S4929900
         L     R14,MDCTDCT         GET ADDRESS OF NEXT REMOTE DCT   R41 S4930000
         LTR   R14,R14             CHECK FOR END OF REMOTE DCT CHN  R41 S4930100
         BNZ   MSNALSON            BRANCH TO PROCESS NEXT DCT       R41 S4930200
         DROP  R14                 RELEASE REMOTE DCT ADDRESSABILTY R41 S4930300
         SPACE 1                                                    R41 S4930400
         NI    RATFLAGS,255-RATSRMT  FORCE $S RMT FLAG OFF          R41 S4930500
         EJECT                                                      R41 S4934400
         L     R1,$MWORK           GET MESSAGE WORKAREA ADDR         R4 S4934500
*              THIS LINE DELETED BY APAR OZ44410               @OZ44410 S4934600
         TM    ICEFLGS2,ICE1STLU   SMF RECORD REQUIRED...      @OZ44410 S4934700
         BNO   MSNALOPS            BRANCH IF NOT.              @OZ44410 S4934800
         MVC   0(L'MLGNMSG,R1),MLGNMSG MSG TARGET TO WORKAREA        R4 S4935000
         USING MLGNMSG,R1          PROVIDE MSG ADDRESSABILITY        R4 S4935500
         MVC   MLGNRMT,RATNAME     MOVE REMOTE NAME TO MESSAGE       R4 S4936000
         MVC   MLGNLNE,DCTDEVN     MOVE LINE DCT NAME TO MESSAGE     R4 S4936500
         MVC   MLGNSYM,ICESYMB     MOVE SESSION SYMB NAME TO MSG     R4 S4937000
         DROP  R1                  RELEASE MESSAGE ADDRESSABILITY   R41 S4937100
        $WTO   (R1),L'MLGNMSG,JOB=NO,WAIT=NO,  ISSUE LOGON MESSAGE     CS4937500
               ROUTE=$LOG+$ERR+$TP,CLASS=$ALWAYS,PRI=$HI             R4 S4938000
         SPACE 1                                                     R4 S4938500
         OI    MDCTATTN,MDCTJOB1+MDCTJOB2  SHOW IDLE SESSION AND       CS4939000
                                            REQUEST SEARCH FOR WORK  R4 S4939500
         XC    MDCTSCNT(20),MDCTSCNT  CLEAR REMOTE COUNTS      @OZ27491 S4939520
         CLI   $NUMSMFB,2          CHECK SMF OPTIONS           @OZ27491 S4939540
         BL    MICETIME            BRANCH IF NO SMF REQUIRED   @OZ27491 S4939560
        $GETSMFB WAIT=NO           GET AN SMF BUFFER           @OZ27491 S4939580
         BZ    MICETIME            BRANCH IF NO SMF BUFFER     @OZ27491 S4939600
         USING SMFDSECT,R1         SMF ADDRESSABILITY          @OZ27491 S4939620
         MVI   SMFRDW+1,SMF52END-SMFRDW  SET RECORD LENGTH     @OZ27491 S4939640
         MVI   SMFHDRTY,SMF52      SET SMF RECORD TYPE         @OZ27491 S4939660
         MVI   SMFPROFF+1,SMFSUBID-SMFJMR  OFFSET TO PROD SECT @OZ27491 S4939670
         MVI   SMFPRLEN+1,SMFIDSEC-SMFSUBID  PROD SEC LENGTH   @OZ27491 S4939680
         MVI   SMFPRNUM+1,1        PRODUCT SECTION NUMBER      @OZ27491 S4939690
         MVI   SMFIDOFF+1,SMFIDSEC-SMFJMR  OFFSET TO ID SECT   @OZ27491 S4939700
         MVI   SMFIDNUM+1,1        ID SECTION NUMBER           @OZ27491 S4939710
         MVC   SMFVERNO,=C'01'     VERSION NUMBER              @OZ27491 S4939720
         MVC   SMFSYSNM,=C'JES2'   SUBSYSTEM NAME              @OZ27491 S4939730
         MVI   SMFSUBID+1,SMFLOGON INDICATE LOGON EVENT        @OZ27491 S4939760
         MVI   SMFIDLEN+1,SMF52END-SMFIDSEC  ID SEC LENGTH     @OZ27491 S4939780
         MVC   SMF52LIN,DCTDEVN    LINE NAME                   @OZ27491 S4939800
         MVC   SMF52PSW,MDCTPSWD   LINE PASSWORD               @OZ27491 S4939820
         L     R15,MDCTRAT         RESTORE RAT ADDRESS         @OZ27491 S4939830
         MVC   SMF52RMT,RATNAME    REMOTE NAME                 @OZ27491 S4939840
        $QUESMFB                   QUEUE THE SMF RECORD        @OZ27491 S4939860
         DROP  R1                  RELEASE SMF ADDRESSABILITY  @OZ27491 S4939880
         B     MICETIME            REQST TIME DELAY, FREE BUF & RTRN R4 S4940000
         EJECT                                                 @OZ27491 S4940100
MSNALOPS MVC  0(L'MLGNMSG2,R1),MLGNMSG2  INITIALIZE MESSAGE         R41 S4940200
         USING MLGNMSG2,R1         PICK UP MSG ADDRESSABILITY       R41 S4940300
         MVC   MLGNSYM2,ICESYMB    MOVE LUNAME INTO MESSAGE         R41 S4940400
         MVC   MLGNLNE2,DCTDEVN    MOVE LINE NAME INTO MESSAGE      R41 S4940500
         $WTO  (R1),L'MLGNMSG2,JOB=NO,WAIT=NO,   ISSUE              R41XS4940600
               ROUTE=$LOG+$TP,CLASS=$NORMAL,PRI=$HI   MESSAGE       R41 S4940700
         SPACE 2                                                    R41 S4940800
         OI    MDCTATTN,MDCTJOB1+MDCTJOB2     SHOW SESSION IDLE     R41 S4940900
         B     MICETIME            GO REQUEST $WAITIME INTERVAL     R41 S4941000
         SPACE 1                                                    R41 S4941100
         DROP  R1,R15              DROP MSG AND RAT ADDRESSABILITY  R41 S4941200
         EJECT                                                       R4 S4941500
*                                                                    R4 S4942000
*                CONVERT R.U. LENGTHS TO BIND FLOATING-POINT FORM    R4 S4942500
*                                                                    R4 S4943000
         SPACE 2                                                     R4 S4943500
MSNALGTH LR    R0,R1               COPY LENGTH TO WORK REG           R4 S4944000
         SLL   R1,4                SHIFT LENGTH INTO HI-ORDER NIBBLE R4 S4944500
         SRA   R0,4                TEST VALUE                        R4 S4945000
         BZR   R14                 DONE IF LESS THAN 16              R4 S4945500
         SLR   R15,R15             CLEAR REG FOR CHARACTERISTIC      R4 S4946000
SKIP1500 LA    R15,1(,R15)         INCREASE CHARACTERISTIC BY 1      R4 S4946500
         SRA   R0,1                SHIFT OUT RIGHT-HAND BIT          R4 S4947000
         BNZ   SKIP1500            LOOP UNTIL LAST BIT SHIFTED OUT   R4 S4947500
         SRL   R1,4(R15)           FORM 4-BIT MANTISSA              R41 S4948000
         SLL   R1,4                SHIFT INTO HI-ORDER NIBBLE        R4 S4948500
         ALR   R1,R15              MERGE MANTISSA & CHARACTERISTIC   R4 S4949000
         BR    R14                 RETURN TO CALLER, RESULT IN R1    R4 S4949500
         EJECT                                                       R4 S4950000
MSNACLOS EQU   MICEMELT            PROCESS SNA CLSDST COMPLETE RPL   R4 S4950500
         SPACE 1                                                     R4 S4951000
MSNAHOLD EQU   MBUFNEXT                                              R4 S4951500
MSNATERM EQU   MBUFNEXT                                              R4 S4952000
MSNARCVR EQU   MBUFNEXT                                              R4 S4952500
         SPACE 2                                                     R4 S4953000
MSNALRMT MVC   MSLGNAME(*-*),0(WA)  MOVE RMTE NAME *** EXECUTED ***  R4 S4953500
MSNALNPW MVC   MSLGNLPW(*-*),0(WA)  MOVE LINE PSWD *** EXECUTED ***  R4 S4954000
MSNALRPW MVC   MSLGNRPW(*-*),0(WA)  MOVE RMTE PSWD *** EXECUTED ***  R4 S4954500
MSNALMOD MVC   MSLGNMOD(*-*),0(WA)  MOVE LOGN MODE *** EXECUTED ***  R4 S4955000
         SPACE 2                                                     R4 S4955500
MLGFMSG $MSG   204,'RMTXXXXX -- LOGON  FAILED -- SESSION ZZZZZZZZ'   R4 S4956000
MLGFRMT  EQU   MLGFMSG+2,8         REMOTE  NAME                      R4 S4956500
MLGFSYM  EQU   MLGFMSG+39,8        SESSION NAME                      R4 S4957000
         SPACE 2                                                     R4 S4957500
MLGIMSG $MSG   205,'LOGONXXX -- INVALID LOGON -- SESSION ZZZZZZZZ'   R4 S4958000
MLGILOG  EQU   MLGIMSG+2,8         LOGON DCT NAME                    R4 S4958500
MLGISYM  EQU   MLGIMSG+39,8        SESSION   NAME                    R4 S4959000
         SPACE 2                                                     R4 S4959500
MLGNMSG $MSG   200,'RMTXXXXX STARTED ON LINEYYYY SESSION ZZZZZZZZ'   R4 S4960000
MLGNRMT  EQU   MLGNMSG+2,8         REMOTE   NAME                     R4 S4960500
MLGNLNE  EQU   MLGNMSG+22,8        LINE DCT NAME                     R4 S4961000
MLGNSYM  EQU   MLGNMSG+39,8        SESSION  NAME                     R4 S4961500
         SPACE 2                                                    R41 S4961600
MLGNMSG2 $MSG  209,'SESSION XXXXXXXX STARTED ON LINEYYYY'           R41 S4961700
MLGNSYM2 EQU   MLGNMSG2+10,8       LUNAME                           R41 S4961800
MLGNLNE2 EQU   MLGNMSG2+30,8       LINE NAME                        R41 S4961900
         EJECT                                                      R41 S4962000
         DROP  MDCT                                                 R41 S4962100
         DROP  MBASE1,MBASE2,MBASE3   RELEASE ROUTINE               R41 S4962500
         DROP  MBUF,MICE           BUFFER AND ICE ADDRESSABILTY     R41 S4962600
         SPACE 2                                                     R4 S4963000
         DROP  BASE2              RELEASE LINE MANAGER BASE         R41 S4963100
         LTORG                                                       R4 S4963500
         EJECT                                                       R4 S4964000
MSNABIND DS    0CL36          DEFAULT SNA BATCH BIND IMAGE           R4 S4964500
         DC    X'01'               COLD BIND REQUEST                 R4 S4965000
         SPACE 1                                                     R4 S4965500
*                             FM PROFILE AND TS PROFILE              R4 S4966000
         SPACE 1                                                     R4 S4966500
         DC    B'00000011'         FM HEADERS WILL BE USED           R4 S4967000
         DC    B'00000011'         STSN   WILL NOT BE USED           R4 S4967500
         SPACE 1                                                     R4 S4968000
*                             SESSION PROTOCOLS                      R4 S4968500
         SPACE 1                                                     R4 S4969000
         DC    B'10110001'         PRIMARY   PROTOCOLS               R4 S4969500
         DC    B'10100011'         SECONDARY PROTOCOLS               R4 S4970000
         DC    B'01110000'         COMMON    PROTOCOLS               R4 S4970500
         DC    B'10000000'         COMMON    PROTOCOLS               R4 S4971000
         SPACE 1                                                     R4 S4971500
*                             TRANSMISSION SERVICE USAGE             R4 S4972000
         SPACE 1                                                     R4 S4972500
         DC    AL1(0)              SLU SEND PACING COUNT            R41 S4973000
         DC    AL1(0)              SLU RCVE PACING COUNT       @OZ41377 S4973500
         DC    AL1(*-*)            MAX. INBOUND  RU SIZE             R4 S4974000
         DC    AL1(*-*)            MAX. OUTBOUND RU SIZE             R4 S4974500
         DC    XL2'00'             RESERVED                          R4 S4975000
         DC    B'00000001'         LU PROFILE                        R4 S4975500
         DC    B'00010000'         FMH SUBSET                          CS4976000
                                   CARDS MAY NOT SPAN RUS            R4 S4976500
         SPACE 1                                                     R4 S4977000
*                             PRIMARY LU USAGE                       R4 S4977500
         SPACE 1                                                     R4 S4978000
         DC    B'00000000'         INTERRUPT LEVEL 2                   CS4978500
                                   NO COMPACTION                       CS4979000
                                   NO PDIR SETUP                     R4 S4979500
         DC    X'00'               RESERVED                          R4 S4980000
         DC    B'10010001'         SCS CHARACTER SET USE               CS4980500
                                   BS/CR/INP/ENP/LF/SVF/               CS4981000
                                   SEL/TRN   MAY BE SENT             R4 S4981500
         DC    X'00'               RESERVED                          R4 S4982000
         DC    B'10000000'         DOCUMENT FORMAT ONLY             R41 S4982500
         SPACE 1                                                     R4 S4983000
*                             SECONDARY LU USAGE                     R4 S4983500
         SPACE 1                                                     R4 S4984000
         DC    B'00000000'         INTERRUPT LEVEL 2                   CS4984500
                                   NO COMPACTION                       CS4985000
                                   NO PDIR SETUP                     R4 S4985500
         DC    X'00'               RESERVED                          R4 S4986000
         DC    B'00000001'         SCS CHARACTER SET USE               CS4986500
                                   TRN   MAY BE SENT                 R4 S4987000
         DC    X'00'               RESERVED                          R4 S4987500
         DC    B'01000000'         CARDS MAY BE SENT                 R4 S4988000
         SPACE 1                                                     R4 S4988500
*                             ADDITIONAL INFORMATION                 R4 S4989000
         SPACE 1                                                     R4 S4989500
         DC    X'00'               NO CRYPTO                         R4 S4990000
         DC    AL1(8)              PLU NAME LENGTH                   R4 S4990500
         DC    CL8' '              PRIMARY LU NAME                   R4 S4991000
         DC    AL1(0)              NO USER DATA                      R4 S4991500
         EJECT                                                       R4 S4992000
MBNDMASK DS    0CL26          VARIABLE BIND PARMS SELECT MASK        R4 S4992500
         DC    X'00'               BIND REQUEST TYPE FIXED           R4 S4993000
         SPACE 1                                                     R4 S4993500
*                             FM PROFILE AND TS PROFILE              R4 S4994000
         SPACE 1                                                     R4 S4994500
         DC    B'00000000'         FM PROFILE FIXED                  R4 S4995000
         DC    B'00000000'         TS PROFILE FIXED                  R4 S4995500
         SPACE 1                                                     R4 S4996000
*                             SESSION PROTOCOLS                      R4 S4996500
         SPACE 1                                                     R4 S4997000
         DC    B'00000010'         PRIMARY   COMPR  VARIABLE         R4 S4997500
         DC    B'00000010'         SECONDARY COMPR  VARIABLE         R4 S4998000
         DC    B'00001000'         ALTERNATE CODE   VARIABLE         R4 S4998500
         DC    B'00000000'         COMMON PROTOCOLS FIXED            R4 S4999000
         SPACE 1                                                     R4 S4999500
*                             TRANSMISSION SERVICE USAGE             R4 S5000000
         SPACE 1                                                     R4 S5000500
         DC    AL1(1)              SLU SEND PACING FIXED            R41 S5001000
         DC    X'FF'               SLU RCVE PACING MASK        @OZ41377 S5001500
         DC    B'11111111'         MAX INBND RU SIZE VARIABLE        R4 S5002000
         DC    B'11111111'         MAX OUTBD RU SIZE VARIABLE        R4 S5002500
         DC    XL2'00'             RESERVED                          R4 S5003000
         DC    B'00000000'         LU PROFILE FIXED                  R4 S5003500
         DC    B'00000000'         FMH SUBSET FIXED                  R4 S5004000
         SPACE 1                                                     R4 S5004500
*                             PRIMARY LU USAGE                       R4 S5005000
         SPACE 1                                                     R4 S5005500
         DC    B'00000000'         DS  PROTOCOLS  FIXED              R4 S5006000
         DC    X'00'               RESERVED                          R4 S5006500
         DC    B'00000000'         SCS CHAR USAGE FIXED              R4 S5007000
         DC    X'00'               RESERVED                          R4 S5007500
         DC    B'00000000'         MEDIA  SELECT  FIXED              R4 S5008000
         SPACE 1                                                     R4 S5008500
*                             SECONDARY LU USAGE                     R4 S5009000
         SPACE 1                                                     R4 S5009500
         DC    B'00000000'         DS  PROTOCOLS  FIXED              R4 S5010000
         DC    X'00'               RESERVED                          R4 S5010500
         DC    B'00000000'         SCS CHAR USAGE FIXED              R4 S5011000
         DC    X'00'               RESERVED                          R4 S5011500
         DC    B'00000000'         MEDIA  SELECT  FIXED              R4 S5012000
         SPACE 1                                                     R4 S5012500
*                             ADDITIONAL INFORMATION                 R4 S5013000
         SPACE 1                                                     R4 S5013500
         DC    X'00'               NO  CRYPTO  FIXED                 R4 S5014000
         TITLE 'HASP REMOTE CONSOLE PROCESSOR - INITIALIZATION'      R4 S5015900
HASPRTAM CSECT                                                       R4 S5025000
HASPMCON $ENTRY BASE=BASE2,ENTRY=NO REMOTE CONSOLE PROCESSOR         R4 S5025500
         LA    WG,4096/2           SET                               R4 S5026000
         LA    WG,4096/2(WG,BASE2) SECOND BASE                       R4 S5026500
         USING HASPMCON+4096,WG                                      R4 S5027000
         SPACE 10                                                       S5027100
*********************************************************************** S5027200
*                                                                     * S5027300
*        HASPMCON -- REMOTE CONSOLE PROCESSOR (RCP) ENTRY POINT       * S5027400
*                                                                     * S5027500
*********************************************************************** S5027600
         LH    R1,$BUFSIZE                    COMPUTE AND            R4 S5042000
         LA    R1,BUFSTART+2047-BUFDSECT(,R1)  SAVE BUFFER           R4 S5042500
         SRL   R1,11                            SIZE                 R4 S5043000
         SLL   R1,11                             ROUNDED TO          R4 S5043500
         STH   R1,RCPBFSZ                         NEXT 2K            R4 S5044000
         EJECT                                                          S5044100
*********************************************************************** S5044200
*                                                                     * S5044300
*        GET BUFFER FOR MESSAGE SPOOLING                              * S5044400
*                                                                     * S5044500
*********************************************************************** S5044600
         CLI   $SPOLMSG,0          IF NO MSG SPOOL BUFFERS,          R4 S5044700
         BE    MCDCT                DON'T GET STORAGE                R4 S5045000
         MVC   RCPBFRS+1(1),$SPOLMSG  SET MSG SPOOL BUFFER COUNT     R4 S5046000
         GETMAIN EU,LV=3*4096,A=RCPMSB1,MF=(E,RCPGM),BNDRY=PAGE      R4 S5046500
*********************************************************************** S5047000
*                                                                     * S5047500
*        FILL OUT STATIC PORTIONS OF REMOTE CONSOLE DCT               * S5048000
*                                                                     * S5048500
*********************************************************************** S5049000
MCDCT    ST    SAVE,RCPPCE         POINT TO PCE                      R4 S5049500
         MVI   RCPPCE,DCTINUSE     SET IN USE FLAG                   R4 S5050000
         MVI   RCPDCTT,DCTRCON     REMOTE CONSOLE DEVICE TYPE        R4 S5050500
         MVC   RCPFCS,=X'0040'     SET FUNCTION CONTROL SEQUENCE     R4 S5051000
         MVC   RCPDEVNM,=CL8'CONSOLE' SET NAME                       R4 S5051500
         EJECT                                                          S5051900
*********************************************************************** S5052000
*                                                                     * S5052500
*        MISCELLANEOUS PCE INITIALIZATION                             * S5053000
*                                                                     * S5053500
*********************************************************************** S5054000
         MVI   RCPIN+(CMBFLAG-CMB),X'FF' INDICATE AREA EMPTY         R4 S5054500
         MVC   RCPDMXCN,MCSDMXCN   SET INITIAL CONCURRENT EXITS      R4 S5055000
         TITLE 'HASP REMOTE CONSOLE PROCESSOR - SCAN FOR OUTPUT'     R4 S5069900
*********************************************************************** S5070000
*                                                                     * S5070100
*        MAIN LOOP                                                    * S5070200
*                                                                     * S5070300
*********************************************************************** S5070400
MCL      DS    0H                                                    R4 S5070500
         STCK  RCPBASET            SET BASE TIME OF THIS SCAN        R4 S5070600
         BAL   LINK,MCASYNC        CLEAR READY CONCURRENT FUNCTIONS  R4 S5070700
         TM    $MCONPCE,$MCONACT   ANY NEW OUTPUT ACTIVITY           R4 S5075500
         BZ    MCIN                SKIP OUTPUT SCAN                  R4 S5076000
*********************************************************************** S5090500
*                                                                     * S5091000
*        HANDLE OUTPUT CMB TRAFFIC                                    * S5091500
*                                                                     * S5092000
*********************************************************************** S5092500
MCS      DS    0H                                                    R4 S5093000
         LA    WC,$BUSYRQ-(CMBCMB-CMB) POINT TO CMB ZERO             R4 S5093500
         USING CMBDSECT,WC                                           R4 S5094000
MCSN     LR    WB,WC               SAVE CURRENT POINTER              R4 S5094500
         L     WC,CMBCMB           POINT TO NEXT CMB                 R4 S5095000
         LTR   WC,WC               ANY THERE                         R4 S5095500
         BZ    MCIN                DO INPUT IF NO MORE OUTPUT        R4 S5096000
         TITLE 'HASP REMOTE CONSOLE PROCESSOR - WORKSTATION OUTPUT'  R4 S5099500
*********************************************************************** S5100000
*                                                                     * S5100500
*        HANDLE OUTPUT TO REMOTES - DEQUEUE AND SET ROUTINGS          * S5101000
*                                                                     * S5101500
*********************************************************************** S5102000
         MVC   RCPROUT+1(1),CMBRMT SET REMOTE NUMBER                 R4 S5112500
         LH    WA,RCPROUT          PICK UP ROUTE CODE                R4 S5113000
         LTR   WA,WA               REMOTE ROUTE ZERO?          @OZ26056 S5113100
         BZ    MCSRFCMB            THROW AWAY MESSAGE          @OZ26056 S5113200
         CH    WA,$NUMRJE          COMPARE WITH MAXIMUM ROUTING      R4 S5113500
         BH    MCSRFCMB            IGNORE MESSAGE                    R4 S5114000
         BCTR  WA,0                DOWN ONE                          R4 S5114500
         MH    WA,=Y(RATTLE)       MULTIPLY BY RATTLE                R4 S5115000
         AL    WA,$RATABLE         POINT TO RAT ELEMENT              R4 S5115500
         USING RATDSECT,WA                                           R4 S5116000
         L     WF,RATRDCT          POINT TO REMOTE DCT (READER)      R4 S5116500
         USING DCTDSECT,WF                                           R4 S5117000
         EJECT                                                       R4 S5117500
*********************************************************************** S5118000
*                                                                     * S5118500
*        DETECT NEED TO DO MESSAGE SPOOLING                           * S5119000
*          1) IF REMOTE NOT SIGNED ON                                 * S5119100
*          2) IF REMOTE CONSOLE NON-OPERATIONAL OR NON-EXISTENT       * S5119200
*          3) IF NON-MULTI-LEAVING REMOTE                             * S5119300
*          4) IF LINE DCT MSG COUNT AT MAXIMUM                        * S5119400
*          5) IF LINE DCT INACTIVE                                    * S5119500
*          6) IF LINE DCT BUFFER NOT BSC (E.G., SNA BUFFER)           * S5119600
*                                                                     * S5119700
*********************************************************************** S5120000
         L     WE,RATLDCT          POINT TO LINE DCT                 R4 S5120500
         LTR   WE,WE               IS RMT SIGNED ON                  R4 S5121000
         BZ    MCOSPOOL            GO SPOOL IF NOT                   R4 S5121500
         CLM   WF,7,MDCTDCT+1-DCTDSECT(WE) LINE'S ACTIVE RMT   @OZ31398 S5121600
         BNE   MCOSPOOL            NO,SPOOL                    @OZ31398 S5121700
         TM    RATCONF,RATCONFC+RATCONFO TEST CONSOLE FLAGS          R4 S5122000
         BNO   MCOSPOOL            GO SPOOL IF NOT                   R4 S5122500
         TM    MDCTFMT,DCTPROG     TEST DATA FORMAT                  R4 S5123000
         BZ    MCOSPOOL            GO SPOOL IF NOT MULTI-LEAVING     R4 S5123500
         CLC   MDCTCMCT-DCTDSECT(,WE),$MAXCMCT TEST MESSAGE COUNT    R4 S5124000
         BNL   MCOSPOOL            GO SPOOL IF AT LIMIT              R4 S5124500
         TM    DCTSTAT-DCTDSECT(WE),DCTINUSE IS LINE DCT ACTIVE      R4 S5125000
         BZ    MCOSPOOL            GO IF NOT                         R4 S5125500
*              THIS LINE DELETED BY APAR NUMBER                @OZ32567 S5125600
*              THIS LINE DELETED BY APAR NUMBER                @OZ32567 S5125650
         TM    DCTFLAGS-DCTDSECT(WE),DCTRSTRT LINE RESTART...  @OZ32567 S5125700
         BO    MCOSPOOL            YES, GO SPOOL               @OZ32567 S5125750
         TM    MDCTSTAT-DCTDSECT(WE),DCTSOFF SIGNING OFF...    @OZ32567 S5125800
         BO    MCOSPOOL            YES, GO SPOOL               @OZ32567 S5125850
         L     R1,DCTBUFAD-DCTDSECT(,WE) POINT TO LINE BUFFER        R4 S5126000
         TM    MSEQTYPE-BUFDSECT(R1),MBSCSEQ+MCPUSEQ IS REMOTE ACTIVER4 S5126500
         BNO   MCOSPOOL            GO SPOOL IF NOT                   R4 S5127000
*********************************************************************** S5127500
*                                                                     * S5128000
*        HANDLE DIRECT TRANSMISSIONS TO REMOTE WORKSTATION - OPEN     * S5128500
*                                                                     * S5129000
*********************************************************************** S5129500
         BAL   LINK,MCSORC         PREPARE CONSOLE FOR OUTPUT        R4 S5132000
         DROP  WF                                                    R4 S5132500
         USING DCTDSECT,WD         LAST DCT FOR REMOTE               R4 S5133000
         MVI   RCPRCB,X'91'        SET FOR REMOTE OUTPUT             R4 S5133500
         MVI   RCPMAXLR,120        INDICATE MAXIMUM RECORD 120       R4 S5134000
         $EXTP OPEN,(R1)           OPEN CONSOLE                      R4 S5134500
         EJECT                                                       R4 S5135000
*********************************************************************** S5135500
*                                                                     * S5136000
*        PUT MESSAGES TO REMOTE CONSOLE                               * S5136500
*                                                                     * S5137000
*********************************************************************** S5137500
MCSTRL   LA    WF,CMBTIME          POINT TO TIME STAMP               R4 S5138000
         SLR   R0,R0               SET                               R4 S5138500
         IC    R0,CMBML            MESSAGE LENGTH ASSUMING TS REQ'D  R4 S5139000
         TM    RATCONF,RATCONFT    DISPLAY TS                        R4 S5139500
         BO    MCSTRT              SKIP NEXT IF YES                  R4 S5140000
         LA    R1,CMBJOBID-CMBTIME GET DELTA                         R4 S5140500
         ALR   WF,R1               ADJUST ORIGIN                     R4 S5141000
         SLR   R0,R1               AND LENGTH TO DISPLAY JOB ID      R4 S5141500
         TM    RATCONF,RATCONFJ    DISPLAY JOB ID                    R4 S5142000
         BO    MCSTRT              SKIP NEXT IF YES                  R4 S5142500
         LA    R1,CMBMID-CMBJOBID  GET DELTA                         R4 S5143000
         ALR   WF,R1               ADJUST ORIGIN                     R4 S5143500
         SLR   R0,R1               AND LENGTH TO DISPLAY JOB ID      R4 S5144000
MCSTRT   ST    WF,RCPCCW           SET MESSAGE ADDRESS IN PARM LIST  R4 S5144500
         ST    R0,RCPCCW+4         SET LENGTH IN LIST                R4 S5145000
         LA    R1,RCPDCT           POINT TO DCT                      R4 S5145500
         $EXTP PUT,(R1),RCPCCW     WRITE TO REMOTE CONSOLE           R4 S5146000
         TM    RCPTSTAT,DCTPBUF    DID WRITE GO                      R4 S5146500
         BZ    MCSTRTE             EXIT IF NOT                       R4 S5147000
         MVC   CMBCMB-CMB(,WB),CMBCMB  REMOVE FROM CHAIN             R4 S5147500
         $FRECMB CMB=(WC)          FREE CMB                          R4 S5148000
         SLR   R1,R1               ZERO R1                           R4 S5148500
         IC    R1,MDCTCMCT-DCTDSECT(,WE) INCREMENT                   R4 S5149000
         LA    R1,1(,R1)           LINE DCT CONSOLE MESSAGE          R4 S5149500
         STC   R1,MDCTCMCT-DCTDSECT(,WE) COUNT                       R4 S5150000
         CLC   MDCTCMCT-DCTDSECT(,WE),$MAXCMCT  TEST LIMIT           R4 S5150500
         BNL   MCSTRC              CLOSE THE CONSOLE IF NOT BELOW    R4 S5151000
         EJECT                                                       R4 S5151500
*********************************************************************** S5152000
*                                                                     * S5152500
*        SCAN FOR CMBS FOR THIS REMOTE                                * S5153000
*                                                                     * S5153500
*********************************************************************** S5154000
         BAL   LINK,MCCMBSUB       CALL CMB SCAN SUBROUTINE         R41 S5161100
         LTR   WC,WC               WAS ANOTHER QUALIFYING CMB FOUND R41 S5161200
         BNZ   MCSTRL              BRANCH IF YES TO PUT MSG         R41 S5161300
*********************************************************************** S5161500
*                                                                     * S5162000
*        CLOSE FOR NORMAL END OF CMBS FOR A GIVEN REMOTE              * S5162500
*                                                                     * S5163000
*********************************************************************** S5163500
MCSTRC   LA    R1,RCPDCT           POINT TO DCT                      R4 S5164000
         $EXTP CLOSE,(R1)          CLOSE CONSOLE                     R4 S5164500
         XC    MDCTDCT+1(3),MDCTDCT+1 BREAK AWAY FROM REMOTE DCTS    R4 S5165000
         B     MCS                 LOOK FOR WORK                     R4 S5165500
*********************************************************************** S5166000
*                                                                     * S5166500
*        CLOSE FOR TOO MANY MESSAGES FOR REMOTE                       * S5167000
*                                                                     * S5167500
*********************************************************************** S5168000
MCSTRTE  MVC   MDCTCMCT-DCTDSECT(,WE),$MAXCMCT  SET COUNT TO LIMIT   R4 S5168500
         LA    R1,RCPDCT           POINT TO DCT                      R4 S5169000
         $EXTP CLOSE,(R1)          CLOSE CONSOLE                     R4 S5169500
         XC    MDCTDCT+1(3),MDCTDCT+1 BREAK AWAY FROM REMOTE DCTS    R4 S5170000
         DROP  WA                                                    R4 S5170500
         DROP  WD                                                    R4 S5171000
*********************************************************************** S5171100
*                                                                     * S5171200
*        FALL THROUGH TO MESSAGE SPOOLING ROUTINE                     * S5171300
*                                                                     * S5171400
*********************************************************************** S5171500
         TITLE 'HASP REMOTE CONSOLE PROCESSOR - MESSAGE SPOOLING'    R4 S5171600
*********************************************************************** S5172000
*                                                                     * S5172500
*        REMOTE CONSOLE MESSAGE SPOOLING ROUTINE                      * S5173000
*                                                                     * S5173500
* REGISTERS UPON ENTRY                                                * S5174000
*                                                                     * S5174500
*        WC    = ADDRESS OF CONSOLE MESSAGE BUFFER                    * S5175000
*        WB    = ADDRESS OF PREVIOUS CMB ON QUEUE                     * S5175500
*        WA    = RAT ELEMENT ADDRESS                                  * S5176000
*                                                                     * S5176100
*                                                                     * S5176200
*        NOTE -- $MSPOOLQ CONTAINS THE ADDRESS OF A TABLE WITH A      * S5176300
*        3-BYTE ENTRY FOR EACH REMOTE.                                * S5176400
*              BYTE 0 - LAST BLOCK* PRINTED                           * S5176500
*              BYTE 1 - LAST BLOCK WRITTEN                            * S5176600
*              BYTE 2 - LAST BLOCK ALLOCATED                          * S5176700
*                                                                     * S5176800
*              * BLOCK - RELATIVE BLOCK NUMBER (FOR THIS REMOTE)      * S5176900
*                        TO BE ADDED TO REMOTE NO. TIMES NO. OF       * S5177000
*                        BLOCKS PER REMOTE ($SPOLMSG) TO COME UP      * S5177100
*                        WITH RELATIVE MSG SPOOL BLOCK NO.            * S5177200
*                                                                     * S5177300
*              BYTE 0 (LAST PRINTED) IS UPDATED BY HASPPRPU WHEN      * S5177400
*                   OUTPUTTING SPOOLED MESSAGES TO REMOTE.  ALSO      * S5177500
*                   UPDATED BY RCP WHEN NEXT TO BE ALLOCATED          * S5177600
*                   CATCHES UP WITH LAST PRINTED (IN WHICH CASE       * S5177700
*                   THE OLDEST BLOCK IN THE WRAP-AROUND FILE          * S5177800
*                   WILL BE OVERWRITTEN.)                             * S5177900
*                                                                     * S5178000
*              BYTE 1 (LAST WRITTEN) IS UPDATED BY RCP WHEN THE       * S5178100
*                   WRITE EXCP FOR THE BLOCK COMPLETES.               * S5178200
*                                                                     * S5178300
*              BYTE 2 (LAST ALLOCATED) IS UPDATED BY RCP WHEN A       * S5178400
*                   NEW BUFFER TO HOLD MESSAGES FOR THIS REMOTE       * S5178500
*                   BECOMES NECESSARY.                                * S5178600
*                                                                     * S5178700
*********************************************************************** S5178800
         EJECT                                                          S5178900
         USING RATDSECT,WA         ADDRESSABILITY                       S5179000
MCOSPOOL DS    0H                  *                                    S5179100
         CLI   $SPOLMSG,0          IF NO MSG SPOOL BUFFERS,          R4 S5179200
         BE    MCSRFCMB             BR TO THROW AWAY MSG             R4 S5179300
*********************************************************************** S5179400
*                                                                     * S5179500
*        INVOKE MSG SPOOLING EXIT ROUTINE TO SEE IF FUNCTION          * S5179600
*        AVAILABLE -- +0 RETURN IF FUNCTION UNAVAILABLE (DOES         * S5179700
*        NOT POINT TO DUMMY EXIT) OR UNABLE TO GET EXCLUSIVE          * S5179800
*        CONTROL OF QUEUE.                                            * S5179900
*                                                                     * S5180000
*********************************************************************** S5180100
         L     R15,RCPMSXIT        POINT TO WORK ROUTINE             R4 S5180200
         BALR  R10,R15             ENTER MESSAGE SPOOLING            R4 S5180300
         B     MCSN                EXIT IF BUSY             + 0      R4 S5180500
         ST    WB,RCPMSHDR         SAVE CMB HEADER ADDRESS  + 4      R4 S5181000
         SLR   WF,WF               ZERO REGISTER                     R4 S5181500
         IC    WF,RCPROUT+1        GET REMOTE OFFSET           @OZ45379 S5182000
         LR    JCT,WF              MULTIPLY IT                          S5182500
         ALR   JCT,WF               BY                                  S5183000
         ALR   JCT,WF                THREE TO GENERATE                  S5183500
         AL    JCT,$MSPOOLQ           ADDR OF THIS RMT'S MSG QUEUE   R4 S5184000
         MH    WF,RCPBFRS          THIS RMT'S REC0 = ROUTE*&SPOLMSG  R4 S5184500
         ST    WA,RCPREGSV+32      SAVE ADDRESS OF RAT         @OZ46955 S5184600
*              THIS LINE DELETED BY APAR NUMBER                @OZ46955 S5184700
         DROP  WA                                                       S5185000
         L     WB,RCPMSB1          POINT TO FIRST BUFFER             R4 S5185500
         ST    WB,RCPMSCB          SAVE FOR I/O COMPLETION CHECKING  R4 S5186000
         USING BUFDSECT,WB                                           R4 S5186500
         SLR   WA,WA               GET LAST ALLOCATED                   S5187000
         IC    WA,2(,JCT)           RECORD NUMBER                       S5187500
MCOSNBUF DS    0H                  INITIALIZE FOR NEW SPOOL BUFFER      S5188000
         ST    WB,PCEBUFAD         STORE BUFFER ADDR IN DA DCT          S5188500
         LA    WA,1(,WA)           ALLOCATE RECORD                      S5189000
         CH    WA,RCPBFRS          IS IT MORE THAN MAX FOR THIS RMT  R4 S5189500
         BL    *+6                 SKIP IF NOT                          S5190000
         SLR   WA,WA               ALLOCATE RECORD ZERO                 S5190500
         STC   WA,2(,JCT)          UPDATE LAST ALLOCATED NUMBER         S5191000
         CLM   WA,1,0(JCT)         LAST ALLOCATED EQUAL LAST PRINTED    S5191500
         BNE   MCOS0TTR            BRANCH IF NOT                        S5192000
         LA    R0,1(,WA)           INCREASE                             S5192500
         CH    R0,RCPBFRS           LAST                             R4 S5193000
         BL    *+6                   PRINTED                            S5193500
         SLR   R0,R0                  BY                                S5194000
         STC   R0,0(,JCT)              ONE                              S5194500
         CLM   WA,1,1(JCT)         LAST ALLOCATED EQUAL LAST WRITTEN    S5195000
         BNE   MCOS0TTR            BRANCH IF NOT                        S5195500
         STC   R0,1(,JCT)          INCREASE LAST WRITTEN BY ONE         S5196000
         EJECT                                                          S5196400
*********************************************************************** S5196500
*                                                                     * S5196600
*        COMPUTE DISK ADDRESS OF ALLOCATED BLOCK                      * S5196700
*                                                                     * S5196800
*********************************************************************** S5196900
MCOS0TTR LA    R15,0(WA,WF)        ADD REC0 NUMBER FOR THIS REMOTE      S5197000
         SLR   R14,R14             ZERO FOR DIVIDE                      S5197100
         L     WE,$TEDADDR         GET NUMBER OF RECORDS/TRACK       R4 S5197500
         LH    WE,TNRT-TEDDSECT(,WE) FROM FIRST TED                  R4 S5198000
         DR    R14,WE              DIVIDE BY RECORDS/TRACK           R4 S5198500
         L     R1,$DACKPT          ADD BASE TT                       R4 S5199000
         AH    R15,2(,R1)           TO QUOTIENT                      R4 S5199500
         SLL   R15,8               POSITION AS 0TT0                     S5200000
         LA    R14,1(R15,R14)      ADD REMAINDER +1 GIVING 0TTR         S5200500
         ST    R14,PCESEEK         STORE 0TTR IN DA DCT                 S5201000
        $BFRBLD (WB)               INITIALIZE BUFFER IOB AND CCWS       S5201500
         MVC   HDBKEY,=C'MSPOOL'   SET DATA KEY TO 'MSPOOL'             S5202000
         LA    WD,HDBSTART         ADDRESSABILITY FOR                   S5202500
         USING LRCDSECT,WD          LRC MESSAGE HEADERS                 S5203000
         LH    WE,$BUFSIZE              MAXIMUM                      R4 S5203500
         SH    WE,=Y(HDBSTART-BUFSTART)  DATA SPACE                  R4 S5204000
MCOSPUTM DS    0H                  ATTEMPT TO PUT MESSAGE IN BUFFER R41 S5204400
         USING RATDSECT,R14        RAT ADDRESSABILITY          @OZ46955 S5204403
         L     LINK,RCPREGSV+32    RESTORE ADDR OF RAT         @OZ46955 S5204405
         TM    RATCONF,RATCONFT    BRANCH IF TIME              @OZ42857 S5204410
         BO    MCOSMVCX              STAMP IS DESIRED          @OZ42857 S5204415
         LA    R15,CMBTIME         POINT TO TIME STAMP         @OZ42857 S5204420
         SLR   R1,R1               FETCH ORIGINAL              @OZ42857 S5204425
         IC    R1,CMBML              TEXT LENGTH               @OZ42857 S5204430
         LA    R0,CMBJOBID-CMBTIME DELTA ASSUMING JOB ID       @OZ42857 S5204435
         TM    RATCONF,RATCONFJ    BRANCH IF JOB ID            @OZ42857 S5204440
         BO    *+8                   IS DESIRED                @OZ42857 S5204445
         LA    R0,CMBMID-CMBTIME   DELTA IF NO JOB ID          @OZ42857 S5204450
         ALR   R15,R0              ADJUST ORIGIN               @OZ42857 S5204455
         SLR   R1,R0                 AND LENGTH OF MESSAGE     @OZ42857 S5204460
         STC   R1,CMBML            SET NEW TEXT LENGTH         @OZ42857 S5204465
         BCTR  R1,0                MACHINE LENGTH              @OZ42857 S5204470
         EX    R1,MCOSMVCZ         SHIFT TEXT LEFT             @OZ42857 S5204475
         DROP  R14                 KILL RAT ADDRESSABILITY     @OZ42857 S5204480
MCOSMVCX DS    0H                                              @OZ42857 S5204485
         L     R1,RCPMSHDR         POINT TO CMB HEADER               R4 S5204500
         SLR   R15,R15             GET CMB'S                            S5205500
         IC    R15,CMBML           MESSAGE LENGTH                    R4 S5206000
         LA    R0,LRCTEXT-LRCDSECT(,R15) ADD LENGTH OF LRC HEADER    R4 S5206500
         SR    WE,R0               ALLOCATE SPACE                    R4 S5207000
         BNP   MCOSWBUF            BR IF NO ROOM FOR THIS MESSAGE       S5207500
         STC   R15,LRCTLENG        STORE TEXT LENGTH IN LRC             S5208000
         BCTR  R15,0               DECREMENT BY 1 FOR MOVE     @OZ44971 S5208100
         EX    R15,MCOSMVC         MOVE TEXT INTO BUFFER       @OZ44971 S5208500
         MVI   LRCFLAG1,0          ZERO FLAGS IN LRC                    S5209000
         ALR   WD,R0               POINT TO NEXT LRC                 R4 S5209500
         MVI   LRCTLENG,X'FF'      SET BUFFER TERMINATOR                S5210000
         MVC   CMBCMB-CMB(,R1),CMBCMB REMOVE FROM QUEUE              R4 S5210500
        $FRECMB CMB=(WC)           FREE THE CMB                         S5211000
         LR    R15,WB              SAVE BUFFER ADDRESS              R41 S5218100
         L     WB,RCPMSHDR         LOAD CMB HEADER ADDRESS          R41 S5218200
         BAL   LINK,MCCMBSUB       CALL CMB SCAN SUBROUTINE         R41 S5218300
         ST    WB,RCPMSHDR         SAVE CMB HEADER ADDRESS          R41 S5218400
         LR    WB,R15              RESET BUFFER ADDRESS             R41 S5218500
         LTR   WC,WC               WAS ANOTHER QUALIFYING CMB FOUND R41 S5218600
         BNZ   MCOSPUTM            YES--GO TO PUT MSG IN BUFFER     R41 S5218700
         EJECT                                                          S5219300
*********************************************************************** S5219400
*                                                                     * S5219500
*        WRITE BUFFER TO MESSAGE SPOOL FILE - UP TO THREE 4096        * S5219600
*        BYTE BLOCKS MAY BE FILLED AND WRITTEN (ASSUMING THERE        * S5219700
*        ARE THAT MANY MESSAGES QUEUED UP FOR THAT REMOTE) AT         * S5219800
*        A TIME.  BEFORE RETURNING TO MAINLINE CODE, THE MSG          * S5219900
*        SPOOLING EXIT ROUTINE ADDRESS (RCPMSXIT) IS SET UP TO        * S5220000
*        POINT TO ROUTINE WHICH CHECKS FOR MESSAGE SPOOLING           * S5220100
*        WRITE COMPLETIONS (WHEN ENTERED BY 'MCASYNC' AT BEGIN-       * S5220200
*        ING OF MAIN LOOP -- WHEN CALLED AT BEGINNING OF MSG          * S5220300
*        SPOOLING ROUTINE, IT MAKES +0 RETURN (BUSY)).                * S5220400
*                                                                     * S5220500
*********************************************************************** S5220600
MCOSWBUF DS    0H                  WRITE BUFFER TO SPOOL SPACE          S5220700
         MVI   PCEDEVTP,PCEDAWR    SET TO WRITE                      R4 S5220800
         LA    R1,PCEDADCT         POINT TO DA DCT                      S5220900
        $EXCP  (R1)                START WRITE TO DISK                  S5221000
         AH    WB,RCPBFSZ          POINT TO NEXT BUFFER              R4 S5221500
         LR    R0,WB               COMPUTE AMOUNT OF                    S5222000
         SL    R0,RCPMSB1           TOTAL BUFFER SPACE USED          R4 S5222500
         CH    R0,=Y(3*4096)       COMPARE WITH MAX BUFFER SPACE        S5223000
         BNL   MCOSTIOC            BRANCH IF ALL BUFFERS USED           S5223500
         LTR   WC,WC               HAVE CMBS BEEN EXHAUSTED             S5224000
         BNZ   MCOSNBUF            BRANCH IF NOT TO USE NEW BUFFER      S5224500
MCOSTIOC ST    WB,RCPMSLBW         SAVE ADDRESS BEYOND LAST WRITTEN  R4 S5225500
         LA    R15,MCOSXIT2        POINT TO EXIT ROUTINE             R4 S5226000
         ST    R15,RCPMSXIT        SET EXIT ADDRESS                  R4 S5226500
         ST    JCT,RCPMSCTL        SAVE LOCATION OF QUEUE CONTROL    R4 S5227000
         STC   WA,RCPMSRN          SAVE LAST WRITTEN/ALLOCATED RECNO R4 S5227500
         B     MCS                 CONTINUE PROCESSING               R4 S5228000
         SPACE 10                                                   R41 S5228200
MCOSMVC  MVC   LRCTEXT(*-*),CMBMSG *** EXECUTE ONLY ***             R41 S5228300
MCOSMVCZ MVC   CMBMSG(*-*),0(R15)  *** EXECUTE ONLY ***        @OZ42857 S5228350
         DROP  WD                                                   R41 S5228400
         EJECT                                                      R41 S5228500
*********************************************************************** S5228600
*                                                                     * S5228700
*        MCCMBSUB - CMB SCAN SUBROUTINE                               * S5228800
*                                                                     * S5228900
*                   THIS IS AN INTERNAL SUBROUTINE CALLED TO SCAN     * S5229000
*              THE REMAINING CMBS, LOOKING FOR ANOTHER CMB DESTINED   * S5229100
*              FOR THE SAME REMOTE.  IT SKIPS OVER NON-QUALIFYING     * S5229200
*              CMBS RETURNING TO CALLER WITH A HIT OR AT END OF       * S5229300
*              CMB CHAIN.                                             * S5229400
*                                                                     * S5229500
*        INPUT REGS:                                                  * S5229600
*              WB - ADDRESS OF CMB HEADER                             * S5229700
*                                                                     * S5229800
*        OUTPUT REGS:                                                 * S5229900
*              WB - UPDATED ADDRESS OF CMB HEADER                     * S5230000
*              WC - ADDRESS OF QUALIFYING CMB (IF ANY)                * S5230100
*                 - ZERO (IF NO QUALIFYING CMB)                       * S5230200
*                                                                     * S5230300
*        REGS SAVED: R14 THRU WD (WB AND WC MAY BE CHANGED)           * S5230400
*                                                                     * S5230500
*********************************************************************** S5230600
MCCMBSUB STM   LINK,WD,RCPREGSV    SAVE REGS                        R41 S5230700
         LR    WC,WB               POINT TO CMB HEADER              R41 S5230800
MCCLOOP  LR    WD,WC               UPDATE PREVIOUS CMB POINTER      R41 S5230900
         L     WC,CMBCMB           POINT TO NEXT CMB                R41 S5231000
         LTR   WC,WC               END OF CMB CHAIN                 R41 S5231100
         BZ    MCCRTN              YES--RETURN                      R41 S5231200
         IC    R2,CMBRMT           PICK UP REMOTE NUMBER            R41 S5232100
         CLM   R2,1,RCPROUT+1      DO CMB REMOTE NUMBERS MATCH      R41 S5233600
         BNE   MCCLOOP             BYPASS IF NOT                    R41 S5233700
MCCRTN   LR    WB,WD               SET WB = CMB HEADER ADDRESS      R41 S5233800
         STM   WB,WC,RCPREGSV+20   UPDATE WB AND WC IN SAVE AREA    R41 S5233900
         LM    LINK,WD,RCPREGSV    RESTORE REGS                     R41 S5234000
         BR    LINK                RETURN TO CALLER                 R41 S5234100
         EJECT                                                       R4 S5235000
*********************************************************************** S5235100
*                                                                     * S5235200
*        CHECK MSG SPOOLING WRITE COMPLETION(S) EXIT ROUTINE          * S5235300
*                                                                     * S5235400
*              THIS EXIT ROUTINE WILL BE ENTERED REPEATEDLY           * S5235500
*        VIA 'MCASYNC' AT BEGINNING OF RCP MAIN LOOP UNTIL            * S5235600
*        ALL OUTSTANDING MESSAGE SPOOLING WRITES ARE COM-             * S5235700
*        PLETE (UP TO THREE MAY BE OUTSTANDING AT ONCE).  AT          * S5235800
*        THAT TIME, A PAGE RELEASE ON THE BUFFER SPACE USED           * S5235900
*        WILL BE DONE, THE EXIT ROUTINE ADDRESS (RCPMSXIT)            * S5236000
*        WILL BE CHANGED TO POINT TO THE NEXT EXIT AND AN             * S5236100
*        IMMEDIATE BRANCH INTO THAT EXIT+4 IS TAKEN.                  * S5236200
*                                                                     * S5236300
*********************************************************************** S5236400
MCOSXIT2 B     0(,R10)             PREVENT NEW USE OF FUNCTION       R4 S5236500
         L     WB,RCPMSCB          POINT TO BUFFER TO CHECK          R4 S5236600
MCSMSCK  TM    BUFECBCC,X'7F'      I/O COMPLETE                      R4 S5236700
         BZR   R10                 RETURN TO EXIT REQUESTOR          R4 S5236800
MCOSTNXT AH    WB,RCPBFSZ          POINT TO NEXT BUFFER              R4 S5237300
         ST    WB,RCPMSCB          SAVE IN CASE NOT COMPLETE         R4 S5237400
         C     WB,RCPMSLBW         HAVE ALL BUFFERS BEEN TESTED      R4 S5237500
         BL    MCSMSCK             PREPARE TO CHECK MORE             R4 S5237600
         LA    R0,2048(,WB)        INCREASE BUFFER POINTER              S5237700
         N     R0,=F'-4096'         TO NEXT PAGE BOUNDARY               S5238000
         L     R1,RCPMSB1          POINT TO START OF BUFFER SPACE    R4 S5238500
         SLR   R0,R1               COMPUTE LENGTH OF PAGES USED         S5239000
        $PGSRVC RLSE,(R1),(R0)     RELEASE USED BUFFER PAGES         R4 S5239500
         LA    R15,MCOSXIT3        POINT TO EXIT                     R4 S5240000
         ST    R15,RCPMSXIT        SET EXIT                          R4 S5240500
         B     MCOSXT3A            SKIP NSI                          R4 S5241000
         EJECT                                                       R4 S5241500
*********************************************************************** S5242000
*                                                                     * S5242500
*        UPDATE MESSAGE SPOOL QUEUES (EXIT)                           * S5243000
*                                                                     * S5243100
*              THIS EXIT ROUTINE IS ENTERED DIRECTLY FROM             * S5243200
*        'MCOSXIT2' AND THEN (ONLY IF UNABLE TO GET CONTROL           * S5243300
*        OF JOB QUEUE) REPEATEDLY VIA 'MCASYNC' UNTIL ABLE            * S5243400
*        TO GET CONTROL OF JOB QUEUE.  IT UPDATES BYTE 1              * S5243500
*        (LAST BLOCK WRITTEN) OF THE APPROPRIATE 3-BYTE               * S5243600
*        REMOTE ENTRY IN THE $MSPOOLQ TABLE TO AGREE WITH             * S5243700
*        BYTE 2 (LAST BLOCK ALLOCATED).  THE LOGIC IS COMPLI-         * S5243800
*        CATED BECAUSE OF SHARED SPOOL -- NOTE THAT BYTE 1            * S5243900
*        MIGHT ALREADY HAVE BEEN UPDATED BY ANOTHER MEMBER            * S5244000
*        OF THE SHARED SPOOL WHICH IS ALSO WRITING TO THE             * S5244100
*        MESSAGE SPOOLING FILE.  UPON COMPLETION OF THIS              * S5244200
*        EXIT ROUTINE THE ADDRESS OF THE DUMMY MESSAGE                * S5244300
*        SPOOLING EXIT ROUTINE (MCOSXIT1) IS STORED IN                * S5244400
*        RCPMSXIT TO ENABLE USE OF THE MESSAGE SPOOLING               * S5244500
*        FUNCTION.                                                    * S5244600
*                                                                     * S5244700
*********************************************************************** S5244800
MCOSXIT3 B     0(,R10)             REJECT NEW USE OF FUNCTION        R4 S5244900
MCOSXT3A OI    RCPWF,RCPWFQX       ASSUME WE MUST WAIT               R4 S5245000
         $QSUSE TYPE=TEST          DO WE HAVE JOB QUEUE              R4 S5245500
         BNZR  R10                 RETURN                            R4 S5246000
         NI    RCPWF,255-RCPWFQX   INDICATE NO NEED TO WAIT          R4 S5246500
         L     WB,RCPMSCTL         POINT TO REMOTES QUEUE CONTROL    R4 S5247000
         IC    WA,RCPMSRN          PICK UP LAST RECORD NUMBER FOR SYSR4 S5247500
         CLC   1(1,WB),2(WB)       COMPARE LAST WRITTEN - ALLOCATED  R4 S5248000
         BE    MCOSACMB            BRANCH IF EQUAL - NO POST            S5248500
         BL    MCOSAND             BRANCH IF LAST WRITTEN IS LOW        S5249000
         CLM   WA,1,1(WB)          IS NEW WRITTEN GREATER THAN OLD   R4 S5249500
         BH    MCOSPOST            BRANCH IF YES - POST                 S5250000
         B     MCOSOR              GO TEST AGAINST LAST ALLOCATED       S5250500
MCOSAND  CLM   WA,1,1(WB)          IS NEW WRITTEN GREATER THAN OLD   R4 S5251000
         BNH   MCOSACMB            BRANCH IF NOT - NO POST              S5251500
MCOSOR   CLM   WA,1,2(WB)          IS NEW WRITTEN LE LAST ALLOCATED  R4 S5252000
         BH    MCOSACMB            BRANCH IF NOT - NO POST              S5252500
MCOSPOST STC   WA,1(,WB)           QUEUE COMPLETED WRITES FOR PRINT  R4 S5253000
         NI    MHASPECF+$EWBJOT,255-$EWFJOT  TELL LINE MANAGER          S5253500
         OI    $AQSE,QSEPMLM       INDICATE CROSS-SYSTEM $POST          S5254000
MCOSACMB LA    R15,MCOSXIT1        POINT TO FIRST EXIT               R4 S5254500
         ST    R15,RCPMSXIT        SET EXIT                          R4 S5255000
         OI    $MCONPCE,$MCONACT   SHOW OUTPUT ACTIVITY REQUIRED     R4 S5255500
         BR    R10                 EXIT                              R4 S5256000
         EJECT                                                          S5256400
*********************************************************************** S5256500
*                                                                     * S5257000
*        DUMMY EXIT ROUTINE -- USED FOR BOTH MESSAGE SPOOLING         * S5257500
*                              AND SPOOL OUTPUT FUNCTIONS             * S5257600
*                                                                     * S5257700
*              THIS ROUTINE WHEN ENTERED VIA 'MCASYNC' (AT            * S5257800
*        MCOSXIT1+4) RETURNS IMMEDIATELY.  WHEN ENTERED FROM          * S5257900
*        BEGINNING OF MESSAGE SPOOLING ROUTINE (MCOSPOOL) OR          * S5258000
*        SPOOL OUTPUT ROUTINE (MCSSOA), IT MAKES A +4 RETURN          * S5258100
*        (UNLESS UNABLE TO OBTAIN EXCLUSIVE CONTROL OF THE JOB        * S5258200
*        QUEUE) INDICATING THAT THE MESSAGE SPOOLING FUNC-            * S5258300
*        TION (OR SPOOL OUTPUT FUNCTION) IS AVAILABLE FOR USE.        * S5258400
*                                                                     * S5258500
*********************************************************************** S5258600
MCOSXIT1 B     SKIP1510            SKIP NEXT                         R4 S5259000
         BR    R10                 RETURN TO ASYNRHRONOUS EXIT TESTERR4 S5259500
SKIP1510 OI    RCPWF,RCPWFQO       ASSUME WE MUST WAIT               R4 S5260000
         $QSUSE TYPE=TEST          WE HAVE JOB QUEUE                 R4 S5260500
         BNZR  R10                 ERROR EXIT IF NOT                 R4 S5261000
         NI    RCPWF,255-RCPWFQO   INDICATE NO NEED TO WAIT          R4 S5261500
         B     4(,R10)             OK EXIT IF YES                    R4 S5262000
         DROP  WB                                                    R4 S5262500
         EJECT                                                       R4 S5469000
*********************************************************************** S5469500
*                                                                     * S5470000
*        FREE CMB                                                     * S5470500
*                                                                     * S5471000
*********************************************************************** S5471500
MCSRFCMB MVC   CMBCMB-CMB(,WB),CMBCMB REMOVE CMB FROM QUEUE          R4 S5474000
MCSFCMB  $FRECMB CMB=(WC)          FREE CMB                          R4 S5474500
         LR    WC,WB               BACK UP TO PREVIOUS CMB           R4 S5475000
         B     MCSN                LOOK AT NEXT CMB                  R4 S5475500
         SPACE 10                                                       S5476000
*********************************************************************** S5476100
*                                                                     * S5476200
*        REMOTE CONSOLE PROCESSOR INPUT PROCESSING ROUTINES           * S5476300
*                                                                     * S5476400
*********************************************************************** S5476500
MCIN     DS    0H                                                    R4 S5476600
         NI    $MCONPCE,255-($MCONACT+$MCONWAT) RESET STATUS FLAGS   R4 S5477000
         TITLE 'HASP REMOTE CONSOLE PROCESSOR - RECEIVE TRANSMISSIONS'  S5737400
*********************************************************************** S5737500
*                                                                     * S5738000
*        HANDLE COMMAND AND MESSAGE INPUT FROM LINES                  * S5738500
*                                                                     * S5739000
*********************************************************************** S5739500
         USING BUFDSECT,WA                                           R4 S5740000
         USING DCTDSECT,WE                                           R4 S5740500
MCINL    LA    WC,RCPIN            POINT TO FAKE CMB                 R4 S5741000
         CLI   CMBFLAG,X'FF'       IS THERE A CURRENT RECORD         R4 S5743000
         BNE   MCINP               PUT MESSAGE INTO PROPER PLACE     R4 S5743500
         L     WA,$MCONMSG         POINT TO FIRST INPUT BUFFER       R4 S5744000
         LTR   WA,WA               EMPTY                             R4 S5744500
         BZ    MCINN               NO MORE INPUT                     R4 S5745300
         LA    WB,$MCONMSG         POINT TO QUEUE HEAD               R4 S5745500
MCIL     L     WE,BUFDCT           POINT TO LINE DCT                 R4 S5746000
         LA    WE,0(,WE)           PURIFY ADDRESS                    R4 S5746500
         LA    R1,TPBLCCAD         POINT TO BSC CHAIN FIELD          R4 S5747000
         TM    MDCTTYPE,DCTPSNA    TEST FOR SNA RPL                  R4 S5747500
         BZ    MCIL1               BR IF NOT                        R41 S5748000
         USING RPLDSECT,WA         USE TEMPORARY RPL ADDRESSABILITY  R4 S5748500
         LA    R1,RPLNEXT          USE RPL CHAIN FIELD               R4 S5749000
MCIL1    DS    0H                                                   R41 S5749200
         EJECT                                                      R41 S5764900
*********************************************************************** S5765000
*                                                                     * S5765500
*        INITIALIZE REMOTE CONSOLE DCT FOR INPUT                      * S5766000
*                                                                     * S5767000
*********************************************************************** S5767100
MCIR     MVC   0(4,WB),0(R1)       REMOVE FROM QUEUE                 R4 S5769000
         LA    R1,RCPDCT           GET ADDR OF CONSOLE DCT     @OZ47992 S5770500
         TM    DCTFLAGS,DCTRSTRT   IS THIS LINE TO GO DOWN           R4 S5771000
         BNO   MCIRML              LINE AVAILABLE, CONTINUE    @OZ47992 S5771500
         TM    MDCTTYPE,DCTPSNA    CHECK FOR SNA LINE          @OZ47992 S5771550
         BNO   MCITRM              M/L LINE, DISCARD MESSAGE   @OZ47992 S5771600
         $EXTP CLOSE,(R1)          RETURN BUFFER TO ICE        @OZ47992 S5771700
         B     MCITRM              CLEAN UP                    @OZ47992 S5771750
MCIRML   DS    0H                                              @OZ47992 S5772000
         ST    WE,RCPDCTL          SET LINE DCT ADDRESS ...         R41 S5772200
         ST    WA,RCPDCTBF          BUFFER ADDRESS AND ...          R41 S5772300
         MVI   RCPTSTAT,0            AND STATUS FLAGS               R41 S5772400
         TM    MDCTTYPE,DCTPSNA    IS THIS A VTAM LINE DCT           R4 S5772500
         BNO   MCIML               CHECK FOR MULTI-LEAVING IF NOT    R4 S5773000
         NI    RCPFMT,255-DCTPALTC-DCTPPRES RESET FLAGS        @OZ34411 S5773100
         OC    RCPFMT(1),RPLFMTSV  RETRIEVE COMPRESSION INDICATOR    R4 S5773500
         MVI   RCPTTYPE,DCTPLU1    MARK SNA TYPE CONSOLE DCT         R4 S5774000
         MVI   RCPTSEL,FMHCNSLE    SET MEDIUM TO INBOUND CONSLE     R41 S5774200
         L     R15,RPLICE          GET ADDRESS OF ICE                R4 S5774500
         USING ICEDSECT,R15        TEMPORARY ICE ADDRESSABILITY      R4 S5775000
         ST    R15,RCPICE          CHAIN ICE TO DCT                  R4 S5775500
         ST    R1,ICERDCT           AND  DCT TO ICE                  R4 S5776000
         DROP  R15,WA              RELEASE TEMPORARY BASE REGS       R4 S5776500
         USING BUFDSECT,WA         ESTABLISH BUFFER ADDRESSABILITY   R4 S5777000
         B     MCICO               CONTINUE OPEN ON COMMON FIELDS    R4 S5777500
MCIML    TM    MSEQTYPE,MBSCSEQ+MCPUSEQ MULTI-LEAVING SEQUENCE       R4 S5778000
         BNO   MCITRM              DISCARD IF NOT                    R4 S5778500
         MVI   RCPTTYPE,DCTPCPU    BSC CPU TYPE CONSOLE DCT          R4 S5779000
         MVI   RCPRCB,X'92'        SET REMOTE CONSOLE INPUT RCB      R4 S5779500
         DROP  WA                                                    R4 S5783500
         EJECT                                                      R41 S5783900
*********************************************************************** S5784000
*                                                                     * S5784500
*        READ RECORD FROM REMOTE WORKSTATION                          * S5785000
*                                                                     * S5785100
*              THIS LOGIC IS COMPLICATED BY THE FACT THAT IF          * S5785200
*        THIS IS A BSC BUFFER RTAM AUTOMATICALLY GIVES US AN          * S5785300
*        EOF RETURN AND IF THIS RECORD IS IMMEDIATELY FOLLOWED        * S5785400
*        IN THE BUFFER BY ANOTHER RCP RECORD IT ALSO REQUEUES         * S5785500
*        THE BUFFER ON THE $MCONMSG QUEUE.  THIS IS NOT DONE BY       * S5785600
*        THE RTAM SNA GET ROUTINE.  NOTE THAT IN THE EOF ROU-         * S5785700
*        TINE (MCINCLOS) FOR A BSC LINE WE IMMEDIATELY BRANCH         * S5785800
*        BACK TO 'MCINBEOF' (AND EVENTUALLY TO 'MCINP') TO PRO-       * S5785900
*        CESS THE RECORD.  NOTE ALSO THAT IF AN SNA LINE, BE-         * S5786000
*        FORE BRANCHING TO 'MCINP' TO PROCESS THE RECORD, WE          * S5786100
*        EITHER REQUEUE THE BUFFER ON THE $MCONMSG QUEUE (IF          * S5786200
*        THIS RECORD FOLLOWED BY ANOTHER) OR ISSUE A $EXTP            * S5786300
*        CLOSE (IF LAST RECORD IN THE BUFFER).                        * S5786400
*                                                                     * S5786500
*********************************************************************** S5786600
MCICO    MVI   RCPMAXLR,L'CMBMSG   SET TO READ MAX CMD LENGTH       R41 S5786700
MCINGET  LA    R1,RCPDCT           INSURE DCT ADDRESSABILITY        R41 S5786800
         LA    WC,RCPIN            RELOAD PHONY CMB POINT           R41 S5787000
         LA    R0,CMBMSG           POINT TO INPUT AREA               R4 S5787500
         MVI   CMBMSG,C' '         MOVE BLANK TO CMBMSG        @OZ27001 S5787600
         MVC   CMBMSG+1(L'CMBMSG-1),CMBMSG PROPAGATE BLKS      @OZ27001 S5787700
         $EXTP GET,(R1),(R0)       READ COMMAND                      R4 S5788000
         BM    MCINCLOS            CLOSE IF EOF                     R41 S5788500
MCINBEOF LA    R1,CMBMSG+L'CMBMSG-1 POINT OT LAST CHARACTER         R41 S5789000
         LA    R0,L'CMBMSG         GET MAX LENGTH                    R4 S5789500
MCINTB   CLI   0(R1),C' '          BLANK                             R4 S5790000
         BNE   MCINEB              EXIT IF NOT                       R4 S5790500
         BCTR  R1,0                BACK UP ONE                       R4 S5791000
         BCT   R0,MCINTB           TEST FOR BLANK                    R4 S5791500
         TM    MDCTTYPE,DCTPSNA    CHECK DEVICE TYPE                R41 S5792000
         BO    MCINGET             BR IF SNA, TRY ANOTHER GET       R41 S5792100
         B     MCIN                GO TRY NEXT BUFFER               R41 S5792200
MCINEB   MVC   CMBFLAG(L'CMBFLAG+L'CMBLEVEL+L'CMBTYPE),MCINWIC SET HDR  S5792500
         STC   R0,CMBML            SET LENGTH OF MESSAGE             R4 S5793000
         MVC   CMBMSG(1),$RCOMCHR  SET COMMAND ID CHARACTER          R4 S5793500
         MVC   CMBTO,$SYSID        SET OUR SYSTEM IDENTIFICATION     R4 S5794000
         MVC   CMBFM,CMBTO         MAKE TO AND FROM THE SAME         R4 S5794500
         L     R1,MDCTRAT          POINT TO RAT                      R4 S5795000
         MVC   CMBRMT,RATCONRT+1-RATDSECT(R1) SET REMOTE NUMBER      R4 S5795500
         XC    CMBOUT+1(L'CMBOUT-1),CMBOUT+1 ZERO REST               R4 S5796000
         TM    MDCTTYPE,DCTPSNA    TEST DEVICE TYPE                 R41 S5796500
         BNO   MCINP               BR IF NOT SNA -PROCESS CMB       R41 S5797500
         L     R1,RPLRLEN-RPLDSECT(,WA)   GET RPL DATA LENGTH       R41 S5798000
         LTR   R1,R1               CHECK FOR ADDITIONAL DATA        R41 S5798500
         BNZ   MCISNREQ            BR IF MORE TO REQUEUE RPL        R41 S5799000
         OI    RCPTSTAT,DCTEOF     SHOW CLOSE EOF WAS REACHED       R41 S5799500
         EJECT                                                          S5801900
*********************************************************************** S5802000
*                                                                     * S5802500
*        CLOSE REMOTE CONSOLE AND QUEUE MESSAGE                       * S5803000
*                                                                     * S5803500
*********************************************************************** S5804000
         LA    R1,RCPDCT           RELOAD CONSOLE DCT ADDRESS       R41 S5804100
         $EXTP CLOSE,(R1)         CLOSE CONSOLE                     R41 S5804200
         B     MCINP               PROCESS CURRENT CMB              R41 S5804300
         SPACE 5                                                        S5804400
*********************************************************************** S5804500
*                                                                     * S5804600
*        CLOSE REMOTE CONSOLE - GET NEXT QUEUED BUFFER                * S5804700
*                                                                     * S5804800
*********************************************************************** S5804900
MCINCLOS TM    MDCTTYPE,DCTPSNA    TEST DEVICE TYPE                 R41 S5805000
         BZ    MCINBEOF            IGNORE EOF IF NOT SNA            R41 S5805500
         $EXTP CLOSE,(R1)          CLOSE REMOTE CONSOLE             R41 S5805700
         B     MCIN                GO PROCESS MORE INPUT            R41 S5806000
         SPACE 5                                                        S5806100
*********************************************************************** S5806200
*                                                                     * S5806300
*        RE-QUEUE INCOMPLETE SNA BUFFERS                              * S5806400
*                                                                     * S5806500
*********************************************************************** S5806600
MCISNREQ MVC   RPLNEXT-RPLDSECT(4,WA),0(WB)  RE-QUEUE ...           R41 S5806700
         ST    WA,0(,WB)                      INCOMPLETE RPL        R41 S5806800
         DROP  WE                  RELEASE DCT ADDRESSABILTY        R41 S5806900
*********************************************************************** S5807500
*                                                                     * S5808000
*        QUEUE TO COMMAND PROCESSOR                                   * S5808500
*                                                                     * S5809000
*********************************************************************** S5809500
MCINP    LA    WC,RCPINA           POINT TO FLAGS OF DUMMY CMB       R4 S5810000
         BAL   R10,MCIPC           PUT COMMAND ON QUEUE              R4 S5810500
         B     MCTEMW              WAIT IF NO GO            + 0      R4 S5811000
MCITRM   MVI   CMBFLAG-CMB+RCPIN,X'FF' FREE AREA            + 4      R4 S5811500
         B     MCIN                GET MORE INPUT                   R41 S5812000
MCINWIC  DC    AL1(CMBFLAGC+CMBFLAGW+CMBFLAGR,$ALWAYS+$HI,0)         R4 S5812500
MCINN    DS    0H                                                    R4 S5813000
         EJECT                                                       R4 S5962000
*********************************************************************** S5962500
*                                                                     * S5963000
*        CHECK FOR OUTPUT ACTIVITY                                    * S5963500
*                                                                     * S5963600
*              $MCONACT FLAG IS TURNED ON WHEN OUTPUT IS QUEUED       * S5963700
*        TO RCP VIA $BUSYRQ OR WHEN ONE OF THE RCP OUTPUT FUNC-       * S5963800
*        TIONS PREVIOUSLY UNAVAILABLE BECOMES AVAILABLE.  IF ON       * S5963900
*        NOW, BRANCH TO BEGINNING OF MAIN LOOP (MCL).                 * S5964000
*                                                                     * S5964100
*********************************************************************** S5964500
MCTEMW   DS    0H                  CHECK FOR OUTPUT ACTIVITY         R4 S5964600
         TM    $MCONPCE,$MCONACT   IS THERE ANY ACTIVITY             R4 S5965000
         BO    MCL                 LOOP IF YES                       R4 S5965500
         TM    RCPWF,RCPWFQX+RCPWFQO NEED JOB QUEUE                  R4 S5966500
         BNZ   MCWCKPTW            WAIT ON CHECKPOINT PROCESSOR      R4 S5967000
         TM    RCPWF,RCPWFCMB      DO WE NEED CMB                    R4 S5967500
         BZ    MCWWORK             WAIT ON WORK IF NOT               R4 S5968000
         $WAIT CMB,INHIBIT=NO      WAIT ON CMB                       R4 S5968500
         B     MCWTEST             TEST CONDITIONS                   R4 S5969000
MCWCKPTW MVI   $MCONPCE,$MCONWAT   SET TO HURRY CHECKPOINT UP        R4 S5969500
MCWWORK  $WAIT WORK,INHIBIT=NO     WAIT FOR WORK                     R4 S5970000
MCWTEST  DS    0H                                                    R4 S5970500
MCWTJQ   TM    RCPWF,RCPWFQO       OUTPUT WAITING ON JOB QUEUE       R4 S5994500
         BZ    MCL                 LOOP                              R4 S5995000
         $QSUSE TYPE=TEST          WE HAVE QUEUE NOW                 R4 S5995500
         BNZ   MCL                 LOOP                              R4 S5996000
         OI    $MCONPCE,$MCONACT   SHOW OUTPUT ACTIVITY              R4 S5996500
         B     MCL                 LOOP                              R4 S5997000
         EJECT                                                       R4 S6045000
*********************************************************************** S6045500
*                                                                     * S6046000
*        SUBROUTINE TO QUEUE COMMANDS TO COMMAND PROCESSOR            * S6046500
*                                                                     * S6047000
*        R0    = WORK                                                 * S6047500
*        R1    = WORK                                                 * S6048000
*        R2    = WORK                                                 * S6048200
*        WB    = WORK                                                 * S6048500
*        WC    = CMBFLAGS BYTE OF INPUT RECORD, WORK                  * S6049000
*        R10   = LINK                                                 * S6049500
*        LINK  = WORK                                                 * S6050000
*        R15   = WORK                                                 * S6050500
*                                                                     * S6054800
*********************************************************************** S6054900
MCIPC    OC    CMBTYPE-(CMBFLAG-CMB)(L'CMBTYPE+L'CMBML),CMBTYPE-(CMBFLACS6055000
               G-CMB)              VALIDATE LENGTH                   R4 S6055500
         BZ    4(,R10)             RETURN IF ERROR                   R4 S6056000
         OI    RCPWF,RCPWFCMB      ASSUME WAIT ON CMB                R4 S6056500
         $GETCMB NUMCMB=2,COUNT=1  GET TWO CMBS                      R4 S6057000
         BZR   R10                 RETURN IF NO CMBS                 R4 S6057500
         NI    RCPWF,255-RCPWFCMB  INDICATE NO NEED TO WAIT          R4 S6058000
         SLR   R15,R15             ZERO WORK                         R4 S6058500
         IC    R15,CMBML-(CMBFLAG-CMB) PICK UP LENGTH OF TEXT        R4 S6059000
         LA    R15,CMBMSG-CMBFLAG-1(,R15) MACHINE LENGTH OF CMB      R4 S6059500
         MVC   CMBMSG+1-CMB(8,R1),=CL8' ' INSURE 9 TEXT CHARACTERS   R4 S6060000
         EX    R15,MCIPDMVX        MOVE HEADER AND TEXT              R4 S6060500
         LR    WC,R1               POINT TO CMB 1                    R4 S6061000
         L     WB,CMBCMB           POINT TO CMB 2                    R4 S6061500
         CLI   CMBTYPE,0           THIS FORMATTED CMB                R4 S6062000
         BNZ   MCIPDSI             SKIP REPEAT                       R4 S6062500
MCMSG    EQU   CMBJOBN-CMB         DEFINE START OF REPEAT MESSAGE    R4 S6063000
         MVC   MCMSG(2,WB),MCMID   SET MESSAGE ID                    R4 S6063500
         MVC   MCMSG+2(5,WB),=C'R    ' SET REMOTE ID MASK            R4 S6064000
         IC    R15,CMBRMT          PICK UP REMOTE NUMBER (RESPONSE)  R4 S6064500
MCIPDC   CVD   R15,RCPCCW          CONVERT TO                        R4 S6068000
         UNPK  MCMSG+3(3,WB),RCPCCW+6(2) EBCDIC                      R4 S6068500
         OI    MCMSG+5(WB),C'0'    FORCE SIGN                        R4 S6069000
MCIPDS   CLI   MCMSG+3(WB),C'0'    FIRST CHARACTER ZERO              R4 S6069500
         BNE   MCIPDM              MOVE TEXT PART                    R4 S6070000
         MVC   MCMSG+3(3,WB),MCMSG+4(WB) SHIFT                       R4 S6070500
         B     MCIPDS              LOOP                              R4 S6071000
MCIPDM   IC    R15,CMBML           PICK UP LENGTH OF MESSAGE         R4 S6074000
         BCTR  R15,0               GET MACHINE LENGTH                R4 S6074500
         LA    R0,CMBL-(MCMSG+7)-1 GET MAX MACHINE LENGTH            R4 S6075000
         CR    R15,R0              TOO BIG                           R4 S6075500
         BNH   SKIP1660            SKIP                              R4 S6076000
         LR    R15,R0              SET MAX                           R4 S6076500
SKIP1660 EX    R15,MCIPDMVC        MOVE TEXT                         R4 S6077000
         LA    R0,8(,R15)          UP TO FULL MESSAGE LENGTH         R4 S6077500
         $WTO  (WB),(R0),JOB=NO,CMB=YES, DISPLAY COMMAND             R4CS6078000
               ROUTE=$LOG+$TP,CLASS=$NORMAL,PRI=$HI                  R4 S6078500
MCIPDQ   L     R15,$SSVT           POINT TO SSVT                     R4 S6095000
         USING SSVT,R15                                              R4 S6096000
         L     R0,$SVCOMMQ         PICK UP QUEUE HEAD                R4 S6096500
MCIPDQA  ST    R0,CMBCMB           PUT OLD BEHIND                    R4 S6097000
         CS    R0,WC,$SVCOMMQ      QUEUE THE COMMAND                 R4 S6097500
         BNZ   MCIPDQA             LOOP IF NOT QUEUED                R4 S6098000
         DROP  R15                                                   R4 S6098500
         L     R1,$COMMPCE         POINT TO COMMAND PROCESSOR PCE    R4 S6099000
         $POST (R1),WORK           POST IT                           R4 S6099500
         B     4(,R10)             RETURN                            R4 S6100000
MCIPDMVC MVC   MCMSG+7(*-*,WB),CMBMSG *** EXECUTED INSTRUCTION ***   R4 S6100500
MCIPDMVX MVC   CMBFLAG-CMB(*-*,R1),CMBFLAG-(CMBFLAG-CMB) * EXECUTED  R4 S6101000
MCMID    $MSG  249                 REMOTE COMMAND MESSAGE IDENTIFIER R4 S6103000
MCIPDSI  $FRECMB CMB=(WB)          FREE SECOND CMB                   R4 S6103500
         B     MCIPDQ              QUEUE COMMAND                     R4 S6106000
         EJECT                                                       R4 S6143500
*********************************************************************** S6144000
*                                                                     * S6144500
*        MCSORC - REMOTE CONSOLE DCT BUILDER                          * S6145000
*                                                                     * S6145500
*              THIS SUBROUTINE IS CALLED BY THE REMOTE CONSOLE        * S6146000
*        PROCESSOR, BEFORE TRANSMITTING OVER A LINE, TO BUILD         * S6146500
*        A REMOTE CONSOLE DCT IN THE RCP PCE WORK AREA.  ON           * S6147000
*        ENTRY, R7(WF) POINTS TO THE FIRST REMOTE DCT CHAINED         * S6147100
*        OFF THE LINE DCT.  ON EXIT, R7 IS ZERO AND R5(WD)            * S6147200
*        POINTS TO THE LAST REMOTE DCT CHAINED OFF OF THE LINE        * S6147300
*        DCT WHICH NOW POINTS TO THE NEWLY-BUILT REMOTE CONSOLE       * S6147400
*        DCT (ALSO POINTED TO BY R1).  R14(LINK) IS USED FOR          * S6147500
*        LINKAGE.                                                     * S6147600
*                                                                     * S6147700
*********************************************************************** S6148000
MCSORC   DS    0H                                                    R4 S6148500
         USING DCTDSECT,WF                                           R4 S6149000
         XC    RCPDCTBF,RCPDCTBF   ZERO OUT BUFFER POINTER           R4 S6149500
MCSORCL  LR    WD,WF               COPY DCT ADDRESS                  R4 S6150000
         L     WF,MDCTDCT          POINT TO NEXT DCT                 R4 S6150500
         LTR   WF,WF               END OF CHAIN                      R4 S6151000
         BNZ   MCSORCL             LOOP                              R4 S6151500
         DROP  WF                                                    R4 S6152000
         USING DCTDSECT,WD                                           R4 S6152500
         LA    R1,RCPDCT           POINT TO OUR DCT                  R4 S6153000
         ST    R1,MDCTDCT          QUEUE TO END                      R4 S6153500
         MVC   RCPDCTL,DCTDCB      DUPLICATE DCTDCB                  R4 S6154000
         MVC   RCPTSTAT,MDCTSTAT     AND MDCTSTAT                    R4 S6154500
         NI    RCPTSTAT,255-(DCTABORT+DCTPBUF)  RESET SOME FLAGS     R4 S6155000
         MVC   RCPTTYPE,MDCTTYPE   DUPLICATE MDCTTYPE                R4 S6155500
         MVC   RCPTLINE,MDCTLINE   DUPLICATE MDCTLINE                R4 S6156000
         MVC   RCPTBFSZ,MDCTBFSZ   DUPLICATE MDCTBFSZ          @OZ50955 S6156020
         BR    LINK                RETURN                            R4 S6158000
         DROP  WD                                                    R4 S6158500
         EJECT                                                          S6241900
*********************************************************************** S6242000
*                                                                     * S6242500
*        MCASYNC - ACTIVATE CONCURRENT COMPLETION CHECKS              * S6243000
*                                                                     * S6243100
*              THIS SUBROUTINE IS CALLED FROM THE BEGINNING OF        * S6243200
*        THE REMOTE CONSOLE PROCESSOR MAIN LOOP (MCL).  IT IN         * S6243300
*        TURN ENTERS EACH OF THE FOUR EXIT ROUTINES--                 * S6243400
*              1) RCPMSXIT--MESSAGE SPOOLING                          * S6243500
*              2) RCPSOXIT--OUTPUT SPOOLING                           * S6243600
*              3) RCPSIXIT--INPUT SPOOLING                            * S6243700
*              4) RCPIOXIT--'SPECIAL INPUT' OUTPUT SPOOLING           * S6243800
*        (AT ENTRY POINT +4) TO FINISH ANY WORK IN PROGRESS.          * S6243900
*        IF NO WORK IS CURRENTLY IN PROGRESS FOR A GIVEN FUNC-        * S6244000
*        TION, THE EXIT ROUTINE ADDRESS POINTS TO DUMMY EXIT          * S6244100
*        ROUTINE WHICH WHEN ENTERED AT ENTRY+4, RETURNS IMMED-        * S6244200
*        IATELY.                                                      * S6244300
*                                                                     * S6244400
*********************************************************************** S6244500
MCASYNC  ST    LINK,RCPXSAV        SAVE LINK REGISTER                R4 S6244600
         LA    R1,RCPXIT           POINT TO FIRST                    R4 S6245000
         LA    R0,L'RCPDMXCN/4     SET COUNT                         R4 S6245500
MCASYNCL STM   R0,R1,RCPXSAV+4     SAVE                              R4 S6246000
         L     R15,0(,R1)          POINT TO ROUTINE                  R4 S6246500
         BAL   R10,4(,R15)         ENTER AS ASYNCHRONOUS ROUTINE     R4 S6247000
         LM    R0,R1,RCPXSAV+4     RESTORE                           R4 S6247500
         LA    R1,4(,R1)           UP TO NEXT                        R4 S6248000
         BCT   R0,MCASYNCL         LOOP                              R4 S6248500
         L     LINK,RCPXSAV        PICK UP RETURN                    R4 S6249000
         BR    LINK                RETURN                            R4 S6249500
         DROP  WC                                                    R4 S6250000
         DROP  WG                                                    R4 S6250500
         DROP  BASE2                                                 R4 S6251000
         SPACE 2                                                        S6251500
*********************************************************************** S6252000
*                                                                     * S6252500
*        INITIAL EXITS TO CONCURRENT OPERATION FUNCTIONS              * S6253000
*                                                                     * S6253500
*********************************************************************** S6254000
MCSDMXCN DS    0F                                                    R4 S6254500
         DC    A(MCOSXIT1)         INITIAL VALUE FOR RCPMSXIT        R4 S6255000
         EJECT                                                          S6258400
         LTORG                                                       R4 S6258500
         SPACE 2                                                     R4 S6259000
         DROP  ,                   FORGET ALL ADDRESSABILITY         R4 S6259500
         TITLE 'HASP VTAM API -- ACB OPEN / CLOSE SUBTASK'           R4 S6260000
         SPACE 3                                                     R4 S6260500
HASPVTAM $ENTRY BASE=R15,ENTRY=NO  ACB OPEN/CLOSE SUBTASK ENTRY      R4 S6261000
         STM   R14,R12,12(R13)     SAVE CALLERS REGISTERS            R4 S6261500
         LR    MBASE2,R15          ENTRY ADDRESS INTO BASE REG       R4 S6262000
         USING HASPVTAM,MBASE2     SHOW SUBTASK ADDRESSABILITY       R4 S6262500
         DROP  R15                 RELEASE TEMPORARY BASE REG        R4 S6263000
         SPACE 1                                                     R4 S6263500
         LA    R0,18*4             GET LENGTH VALUE OF SAVEAREA      R4 S6264000
         GETMAIN R,LV=(0)          GETMAIN SAVE AREA                 R4 S6264500
         SPACE 1                                                     R4 S6265000
         ST    R13,4(,R1)          SAVE OLD SAVE AREA POINTER        R4 S6265500
         ST    R1,8(,R13)          SAVE NEW SAVE AREA POINTER        R4 S6266000
         LR    R13,R1              POINT TO NEW SAVE AREA            R4 S6266500
         L     BASE1,=V(HASPNUC)   PROVIDE HCT ADDRESSABILITY        R4 S6267000
         USING HCTDSECT,BASE1      SHOW HCT ADDRESSABILITY           R4 S6267500
         SPACE 1                                                     R4 S6268000
         SLR   R1,R1               ZERO SUBTASK                      R4 S6268500
         ST    R1,$SNAECB           WORK ECB                         R4 S6269000
         SPACE 1                                                     R4 S6269500
         POST  $PSNAECB            VTAM SUBTASK IS AWAKE             R4 S6270000
         SPACE 1                                                     R4 S6270500
VACBWAIT DS    0H                                                    R4 S6271000
         WAIT  1,ECB=$SNAECB       WAIT FOR WORK                     R4 S6271500
         TM    $STATUS,$SYSEXIT    IS HASP TERMINATION REQUESTED     R4 S6272000
         BZ    VACBWORK            BRANCH IF THIS IS WORK POST       R4 S6272500
         EJECT                                                       R4 S6273000
*                                                                    R4 S6273500
*              SUBTASK EXIT HAS BEEN REQUESTED                       R4 S6274000
*                                                                    R4 S6274500
         SPACE 1                                                     R4 S6275000
         LA    R0,18*4             GET LENGTH VALUE OF SAVEAREA      R4 S6275500
         LR    R1,R13              HOLD CURRENT SAVE AREA POINTER    R4 S6276000
         L     R13,4(R13)          RESTORE OLD SAVE AREA ADDRESS     R4 S6276500
         SPACE 1                                                     R4 S6277000
         FREEMAIN R,A=(1),LV=(0)   FREE SAVE AREA                    R4 S6277500
         SPACE 1                                                     R4 S6278000
         LM    R14,R12,12(R13)     RESTORE CALLERS REGISTERS         R4 S6278500
         BR    R14                 RETURN TO CALLER                  R4 S6279000
         SPACE 3                                                     R4 S6279500
*                                                                    R4 S6280000
*              CLEAR ECB AND GET LOGON DCT CHAIN                     R4 S6280500
*                                                                    R4 S6281000
         SPACE 1                                                     R4 S6281500
VACBWORK SLR   R1,R1               GET ZERO VALUE FOR CLEARING       R4 S6282000
         ST    R1,$SNAECB          CLEAR SUBTASK WORK ECB            R4 S6282500
         L     MDCT,$VLOGQUE       GET ADDR OF QUEUED LOGON DCT      R4 S6283000
         USING DCTDSECT,MDCT       SHOW DCT ADDRESSABILITY           R4 S6283500
         LTR   MDCT,MDCT           CHECK FOR ANY LOGON DCT THERE     R4 S6284000
         BZ    VACBWAIT            IGNORE THIS POST IF NONE          R4 S6284500
SKIP1720 CS    MDCT,R1,$VLOGQUE    TRY TO CLEAR WORK QUEUE           R4 S6285000
         BNE   SKIP1720            KEEP TRYING UNTIL CLEARED         R4 S6285500
         EJECT                                                       R4 S6286000
*                                                                    R4 S6286500
*              CHECK FOR OPEN OR CLOSE REQUEST                       R4 S6287000
*                                                                    R4 S6287500
         SPACE 1                                                     R4 S6288000
VACBPROC TM    MDCTSTAT,DCTSINON   HAS ACB ALREADY BEEN OPENED       R4 S6288500
         BO    VACBCLOS            BRANCH FOR CLOSE PROC IF YES      R4 S6289000
         LA    R2,VXIDOPEN         GET OPEN ACB EVENT EXIT CODE      R4 S6289500
         SPACE 1                                                     R4 S6290000
*                                                                    R4 S6290500
*              GETMAIN AREA AND BUILD ACB                            R4 S6291000
*                                                                    R4 S6291500
         SPACE 1                                                     R4 S6292000
         LA    R0,ACBSIZE          GET LENGTH VALUE OF ACB           R4 S6292500
         GETMAIN R,LV=(0)          GET AREA FOR ACB                  R4 S6293000
         SPACE 1                                                     R4 S6293500
         LR    MACB,R1             SAVE ACB ADDRESS AND              R4 S6294000
         USING ACBDSECT,MACB         SHOW ACB ADDRESSABILITY         R4 S6294500
         ST    MACB,DCTACB         STORE ACB ADDRESS IN DCT          R4 S6295000
         MVI   DCTACB,X'80'        SHOW PARM LIST END INDIC          R4 S6295500
         XC    ACBDSECT(ACBSIZE),ACBDSECT CLEAR ACB AREA             R4 S6296000
         MVI   ACBID,ACBIDVAL      SET ACB  IDENT  FIELD             R4 S6296500
         MVI   ACBSTYP,ACBSVTAM    SET ACB SUBTYPE FIELD             R4 S6297000
         LA    R0,ACBSIZE          GET CONTROL BLOCK LENGTH          R4 S6297500
         STH   R0,ACBLENG           AND STORE IN ACB                 R4 S6298000
         LA    R0,VACBINVL         GET ADDR OF INVALID ACB EXIT      R4 S6298500
         ST    R0,ACBINRTN          AND STORE INTO ACB FOR VTAM      R4 S6299000
         MVI   ACBDSOR2,ACBDORGA   SHOW DSORG ACB                    R4 S6299500
         CLI   MDCTPSWD,C' '       CHECK LOGON DCT PASSWORD          R4 S6300000
         BE    SKIP1730            BRANCH IF NONE SPECIFIED          R4 S6300500
         LA    R0,MDCTPWDL         GET ADDR OF PASSWORD              R4 S6301000
         ST    R0,ACBPASSW          AND STORE IN ACB                 R4 S6301500
SKIP1730 LA    R0,VACBXLST         GET ADDR OF EXIT LIST             R4 S6302000
         ST    R0,ACBEXLST          AND STORE IN ACB                 R4 S6302500
         MVI   ACBDDNM,X'FF'       SHOW ACCESS METHOD VTAM           R4 S6303000
         MVI   ACBOFLGS,ACBEXFG    INIT USER EXIT FLAG               R4 S6303500
         LA    R0,MDCTAPNL         GET ADDR OF APPL NAME             R4 S6304000
         ST    R0,ACBAPID           AND STORE IN ACB                 R4 S6304500
         ST    MDCT,ACBLNDCT       STORE DCT ADDRESS IN ACB          R4 S6305000
         EJECT                                                       R4 S6305500
*                                                                    R4 S6306000
*              OPEN ACB PROCESSING                                   R4 S6306500
*                                                                    R4 S6307000
         SPACE 1                                                     R4 S6307500
         LA    R1,DCTACB           GET PARM LIST ADDR FOR OPEN       R4 S6308000
         OPEN  MF=(E,(1))          ATTEMPT TO OPEN THE ACB           R4 S6308500
         SPACE 1                                                     R4 S6309000
         TM    ACBOFLGS,ACBOPEN    CHECK ACB OPEN FLAGS              R4 S6309500
         BZ    VACBFAIL            BRANCH IF OPEN FAILED             R4 S6310000
         OI    MDCTSTAT,DCTSINON   SHOW ACB HAS BEEN OPENED          R4 S6310500
         SPACE 2                                                     R4 S6311000
*                                                                    R4 S6311500
*              ENABLE LOGON PROCESSING                               R4 S6312000
*                                                                    R4 S6312500
         SPACE 1                                                     R4 S6313000
         L     R1,DCTBUFAD         GET RPL ADDR FROM DCT             R4 S6313500
         USING RPLDSECT,R1         SHOW RPL ADDRESSABILITY           R4 S6314000
         ST    MACB,RPLDACB        STORE ACB ADDR IN RPL             R4 S6314500
         STCM  MDCT,7,RPLDCT+1     STORE DCT ADDR IN RPL             R4 S6315000
         NI    RPLEXTDS,255-RPLBRANC SET NON BRANCH ENTRY REQUEST    R4 S6315500
         MVI   RPLOPT1,RPLSEQ      INDICATE  SYNCHRONOUS  REQUEST    R4 S6316000
         SPACE 1                                                     R4 S6316500
VACBSETL LA    R0,RPLQUISE         INDICATE SETLOGON REQUEST CODE    R4 S6317000
         STC   R0,RPLREQ             AND STORE IT IN RPL       @OZ18395 S6317100
         L     R15,ACBINRTN        GET ADDR OF INTERFACE ROUTINE     R4 S6317500
         BALR  R14,R15             LINK TO THE INTERFACE ROUTINE     R4 S6318000
         SPACE 1                                                     R4 S6318500
         SRA   R15,2               ADJUST SETLOGON COMPLETION CODE   R4 S6319000
         BZ    VACBPOST            POST LINE MANAGER IF SUCCESSFUL   R4 S6319500
         CLI   RPLRTNCD,USFRESSU   IS REQUEST RETRYABLE              R4 S6320000
         BE    VACBSETL            RETRY REQUEST IF YES              R4 S6320500
         OI    MDCTSTAT,DCTABORT   INDICATE SETLOGON REQ FAILED      R4 S6321000
         ALR   R2,R15              GET SETLOGON EVENT COMPL CODE     R4 S6321500
         B     VACBPOST            BRANCH TO POST LINE MANAGER       R4 S6322000
         SPACE 2                                                     R4 S6322500
*                                                                    R4 S6323000
*              OPEN ACB FAILED EXIT FOR VTAM                         R4 S6323500
*                                                                    R4 S6324000
         SPACE 1                                                     R4 S6324500
VACBINVL LA    R15,32              SET OPEN FAILED RETURN CODE       R4 S6325000
         BR    R14                 RETURN TO CALLER                  R4 S6325500
         EJECT                                                       R4 S6326000
*                                                                    R4 S6326500
*              CLOSE ACB PROCESSING                                  R4 S6327000
*                                                                    R4 S6327500
         SPACE 1                                                     R4 S6328000
VACBCLOS TM    MDCTSTAT,DCTSOFF    IS ACB CLOSE REQUESTED            R4 S6328500
         BNO   VACBNEXT            SEARCH FOR MORE WORK IF NOT       R4 S6329000
         L     MACB,DCTACB         PICK UP ACB ADDRESS               R4 S6329500
         LA    R2,VXIDCLOS         GET CLOSE ACB EVENT EXIT CODE     R4 S6330000
         SPACE 1                                                     R4 S6330500
         LA    R1,DCTACB           GET PARM LIST ADDR FOR CLOSE      R4 S6331000
         CLOSE MF=(E,(1))          ATTEMPT TO CLOSE THE ACB          R4 S6331500
         NI    MDCTSTAT,255-DCTSOFF-DCTSINON SHOW ACB CLOSED        R41 S6331600
         SPACE 1                                                     R4 S6332000
         SRL   R15,2               ADJUST CLOSE ACB COMPL CODE       R4 S6332500
         TM    ACBOFLGS,ACBOPEN    TEST ACB OPEN FLAGS               R4 S6333000
         BZ    VACBFREE            FREE ACB AREA IF SUCCESSFUL       R4 S6333500
         SPACE 1                                                     R4 S6334000
VACBFAIL SRL   R15,2               ADJUST OPEN/CLOSE RETURN CODE     R4 S6334500
         ALR   R2,R15              GET OPEN/CLOSE ACB EVENT CODE     R4 S6335000
         MVC   MDCTXERR,ACBERFLG   COPY ACB ERROR CODE TO DCT        R4 S6335500
         OI    MDCTSTAT,DCTABORT   INDICATE ACB REQUEST FAILED       R4 S6336000
         SPACE 2                                                     R4 S6336500
*                                                                    R4 S6337000
*              FREEMAIN ACB AREA                                     R4 S6337500
*                                                                    R4 S6338000
         SPACE 1                                                     R4 S6338500
VACBFREE LA    R0,ACBSIZE          GET LENGTH OF ACB AREA            R4 S6339000
         FREEMAIN R,A=(MACB),LV=(0) FREE THE ACB AREA                R4 S6339500
         XC    DCTACB,DCTACB       INDICATE NO MORE ACB PRESENT      R4 S6340000
         SPACE 3                                                     R4 S6340500
*                                                                    R4 S6341000
*              POST THE LINE MANAGER AND SEARCH FOR WORK             R4 S6341500
*                                                                    R4 S6342000
         SPACE 1                                                     R4 S6342500
VACBPOST LR    WF,R13              SAVE REGISTER 13 ACROSS POST      R4 S6343000
         BAL   ML,VDCTPOST         ENTER LINE MANAGER POST ROUTINE   R4 S6343500
         LR    R13,WF              RESTORE SAVE AREA ADDRESS         R4 S6344000
         SPACE 1                                                     R4 S6344500
VACBNEXT L     MDCT,MDCTADCT       GET ADDR OF NEXT LOGON DCT        R4 S6345000
         LA    MDCT,0(,MDCT)       PURIFY ADDRESS                    R4 S6345500
         LTR   MDCT,MDCT           TEST FOR END OF DCT CHAIN         R4 S6346000
         BNZ   VACBPROC            PROCESS IF MORE WORK QUEUED       R4 S6346500
         SPACE 1                                                     R4 S6347000
         B     VACBWAIT            GO TO WAIT FOR NEXT POST          R4 S6347500
         SPACE 2                                                     R4 S6348000
         DROP  ,                   FORGET ALL ADDRESSABILITY         R4 S6348500
         TITLE 'HASP VTAM API -- ACB EXIT LIST DEFINITION'           R4 S6349000
*********************************************************************** S6349500
*                                                                     * S6350000
*              COMMON VTAM ACB EXIT LIST DEFINITION                   * S6350500
*                                                                     * S6351000
*********************************************************************** S6351500
         SPACE 2                                                     R4 S6352000
VACBXLST EXLST AM=VTAM,            COMMON ACB EXIT LIST DEFINITION     CS6352500
               LOGON=VEXITLGN,LOSTERM=VEXITLST,TPEND=VEXITTND,         CS6353000
               RELREQ=VEXITRLR,SCIP=VEXITSCP                         R4 S6353500
         TITLE 'HASP VTAM API -- LOGON EXIT ROUTINE'                 R4 S6354000
*********************************************************************** S6354500
*                                                                     * S6355000
*   VEXITLGN - VTAM API LOGON EXIT ROUTINE                            * S6355500
*                                                                     * S6356000
*                                                                     * S6356500
*   REGISTERS AT ENTRY                                                * S6357000
*                                                                     * S6357500
*        R1 =  ADDRESS OF PARAMETER LIST                              * S6358000
*              1ST WORD - ADDRESS OF ACB                              * S6358500
*              2ND WORD - ADDRESS OF TERMINALS SYMBOLIC NAME          * S6359000
*              3RD WORD - UNUSED                                      * S6359500
*              4TH WORD - LENGTH OF LOGON MESSAGE TEXT                * S6360000
*                                                                     * S6360500
*********************************************************************** S6361000
         SPACE 2                                                     R4 S6361500
         USING VEXITLGN,R15        EXIT ROUTINE INITIAL BASE         R4 S6362000
VEXITLGN L     MBASE2,=A(HASPVTAM) GET COMMON BASE ADDRESS           R4 S6362500
         L     BASE1,=V(HASPNUC)   PICK UP HCT ADDRESS               R4 S6363000
         USING HASPVTAM,MBASE2     SHOW PERMANENT ADDRESSABILITY     R4 S6363500
         USING HCTDSECT,BASE1      SHOW HCT ADDRESSABILITY           R4 S6364000
         DROP  R15                 RELEASE TEMPORARY BASE REG        R4 S6364500
         L     MACB,0(,R1)         GET ADDRESS OF ACB                R4 S6365000
         USING ACBDSECT,MACB         AND SHOW ADDRESSABLE            R4 S6365500
         L     MDCT,ACBLNDCT       GET LOGON DCT ADDRESS             R4 S6366000
         USING DCTDSECT,MDCT         AND SHOW ADDRESSABLE            R4 S6366500
         SPACE 1                                                     R4 S6367000
         TM    MDCTSTAT,DCTSINON+DCTSOFF CHECK FOR ACB AVAILABLE     R4 S6367500
         BNMR  R14                 LET CLOSE REJECT LOGON IF NOT     R4 S6368000
         TM    DCTSTAT,DCTDRAIN    TEST LOGON DCT STATUS             R4 S6368500
         BOR   R14                 REJECT LOGON IF DRAINING          R4 S6369000
         SPACE 1                                                     R4 S6369500
         L     R2,MDCTLOGN         GET LOGON COUNT FROM DCT          R4 S6370000
         LA    R2,1(,R2)           INCREMENT COUNT OF LOGONS         R4 S6370500
         ST    R2,MDCTLOGN         STORE UPDATED COUNT IN DCT        R4 S6371000
         SPACE 1                                                     R4 S6371500
         LR    ML,R14              SAVE RETURN ADDRESS               R4 S6372000
         L     R2,4(,R1)           SAVE ADDR OF SYMBOLIC NAME        R4 S6372500
         SPACE 1                                                     R4 S6373000
         L     MICE,$ICETRAY       GET NEXT AVAILABLE ICE            R4 S6373500
         USING ICEDSECT,MICE       SHOW ICE ADDRESSABILITY           R4 S6374000
VEXITLIC LTR   MICE,MICE           CHECK FOR EMPTY ICE TRAY         R41 S6374500
         BZ    VLOGFAIL            REJECT LOGON IF EMPTY             R4 S6375000
         L     R0,ICEAPCHN         ATTEMPT TO REMOVE                R41 S6375500
         CS    MICE,R0,$ICETRAY     ICE FROM TRAY                    R4 S6376000
         BNE   VEXITLIC            RETRY IF FAILED                  R41 S6376500
         SPACE 1                                                     R4 S6377000
         XC    ICEDSECT(ICESIZE),ICEDSECT CLEAR ALL FIELDS IN ICE    R4 S6377500
         SPACE 1                                                     R4 S6378000
         ST    MDCT,ICEADCT        SAVE LOGON DCT ADDR IN ICE        R4 S6378500
         MVC   ICESYMB,0(R2)       MOVE SYMBOLIC NAME TO ICE         R4 S6379000
         L     R2,12(,R1)          GET LENGTH OF LOGON MSG           R4 S6379500
         STH   R2,ICERULEN          AND STORE IN ICE                 R4 S6380000
         SPACE 1                                                     R4 S6380500
         LA    R2,VXIDLOGN         GET LOGON EXIT ROUT INDICATOR     R4 S6381000
         B     VICEPOST            GO TO QUEUE ICE AND POST MLLM     R4 S6381500
         EJECT                                                       R4 S6382000
*                                                                    R4 S6382500
*              NO ICE AVAILABLE - REJECT LOGON REQUEST               R4 S6383000
*                                                                    R4 S6383500
         SPACE 2                                                     R4 S6384000
VLOGFAIL L     R1,MDCTNICE         GET LOGON FAILED FOR ICE COUNTER  R4 S6384500
         LA    R1,1(,R1)           INCREMENT COUNTER                 R4 S6385000
         ST    R1,MDCTNICE          AND STORE UPDATED VALUE          R4 S6385500
         SPACE 1                                                     R4 S6386000
         LA    R0,RPLSIZE+NIBSIZE  GET LENGTH OF REQ RPL             R4 S6386500
         GETMAIN R,LV=(0)          GET AREA FOR CLOSE DEST RPL       R4 S6387000
         LR    MBUF,R1             ALLOW RPL ADDRESSABILITY          R4 S6387500
         USING RPLDSECT,MBUF       SHOW RPL ADDRESSABILITY           R4 S6388000
         SPACE 1                                                     R4 S6388500
         $BFRBLD (R1),TYPE=VTAM    INITIALIZE AREA AS VTAM BUF       R4 S6389000
         SPACE 1                                                     R4 S6389500
         ST    MACB,RPLDACB        STORE ACB ADDRESS IN RPL          R4 S6390000
         MVI   RPLREQ,RPLCLOSE     SHOW CLSDST REQUEST TYPE         R41 S6390500
         LA    R15,RPLBUFST        ESTABLISH ADDRESS OF NIB          R4 S6391000
         USING NIBDSECT,R15        SHOW NIB ADDRESSABILITY           R4 S6391500
         ST    R15,RPLARG          PUT NIB POINTER INTO RPL          R4 S6392000
         MVI   RPLEXTDS,RPLNIB     INDICATE NIB POINTER SET         R41 S6392500
         MVI   RPLOPT1,RPLSEQ      SHOW SYNCHRONOUS REQUEST          R4 S6393000
         LA    R13,RPLSAVEA        ESTABLISH SAVEAREA POINTER        R4 S6393500
         SPACE 1                                                     R4 S6394000
         XC    NIBDSECT(NIBSIZE),NIBDSECT CLEAR NIB AREA             R4 S6394500
         MVI   NIBID,NIBIDD        INITIALIZE NIB ID FIELD          R41 S6394600
         MVI   NIBLEN,NIBLNIB      INITIALIZE NIB LENGTH FIELD      R41 S6394700
         MVC   NIBMODE(8),=CL8'RECORD'  SHOW RECORD MODE IN NIB     R41 S6394800
         MVI   NIBPROCD,PRORPLC    SHOW RPL PROC OPTION             R41 S6394900
         MVC   NIBSYM,0(R2)        MOVE SYMBOLIC NAME TO NIB         R4 S6395000
         SPACE 1                                                     R4 S6395500
         DROP  R15                 RELEASE NIB ADDRESSABILITY        R4 S6396000
         EJECT                                                       R4 S6396500
VLOGCLOS LA    R0,RPLCLOSE         GET CLSDST REQUEST CODE           R4 S6397000
         L     R15,ACBINRTN        GET ADDR OF INTERFACE ROUT        R4 S6397500
         BALR  R14,R15             LINK TO THE INTERFACE ROUT        R4 S6398000
         SPACE 1                                                     R4 S6398500
         LTR   R15,R15             WAS REQUEST SUCCESSFUL            R4 S6399000
         BZ    VLOGFREE            BRANCH TO FREE RPL IF YES         R4 S6399500
         CLI   RPLRTNCD,USFRESSU   IS REQUEST RETRYABLE              R4 S6400000
         BE    VLOGCLOS            BRANCH TO RETRY REQUEST IF YES    R4 S6400500
         SPACE 3                                                     R4 S6401000
VLOGFREE DS    0H                                                   R41 S6401500
         LR    R2,R1               SAVE R1 ACROSS $$WTO             R41 S6402000
         MVC   0(MXSSMSGL,R1),MXSSMSG MOVE MESSAGE TO WORK AREA     R41 S6402100
         $$WTO (R1)                ISSUE 'MAX SESS EXCEEDED' MSG    R41 S6402200
         SPACE 1                                                    R41 S6402300
         LR    R1,R2               RESTORE R1 FOR FREEMAIN          R41 S6402400
         LA    R0,RPLSIZE+NIBSIZE  GET LENGTH OF RPL/NIB/MSG AREA   R41 S6402500
         FREEMAIN R,A=(1),LV=(0)   FREE THE AREA                    R41 S6402600
         SPACE 1                                                    R41 S6402700
         B     VMLMPOST            GO POST THE LINE MANAGER         R41 S6402800
         BR    ML                  RETURN TO VTAM                   R41 S6402900
         SPACE 2                                                    R41 S6403000
         $MID  206                 MESSAGE 206 ID                   R41 S6403600
MXSSMSG  WTO   '&MID.LOGON FAILED -- MAXSESS EXCEEDED',MF=L         R41 S6403700
MXSSMSGL EQU   *-MXSSMSG           LENGTH OF MASS SESS MSG          R41 S6403800
         SPACE 3                                                    R41 S6403900
         DROP  ,                   FORGET ALL ADDRESSABILITY         R4 S6404000
         TITLE 'HASP VTAM API -- LOSTERM EXIT ROUTINE'               R4 S6404500
*********************************************************************** S6405000
*                                                                     * S6405500
*   VEXITLST - VTAM API LOSTERM EXIT ROUTINE                          * S6406000
*                                                                     * S6406500
*                                                                     * S6407000
*        R1 =  ADDRESS OF PARAMETER LIST                              * S6407500
*                                                                     * S6408000
*              1ST WORD - ADDRESS OF ACB                              * S6408500
*              2ND WORD - CID OF TERMINAL                             * S6409000
*              3RD WORD - USERFLD/ICE ADDR                            * S6409500
*              4TH WORD - REASON CODE                                 * S6410000
*                          0 NOT APPLICABLE                           * S6410500
*                          4 NOT APPLICABLE                           * S6411000
*                          8 RESERVED                                 * S6411500
*                         12 LU RESTART FAILED                        * S6412000
*                         16 LU RESTART SUCCESSFUL                    * S6412500
*                         20 LU UNCOND TERMINATE SELF                 * S6413000
*                         24 LU RESTART IN PROCESS                    * S6413500
*                         28 RESERVED                                 * S6414000
*                         32 LU CONDIT TERMINATE SELF                 * S6414500
*                         36 LU BUFFER LIMIT EXCEEDED                 * S6415000
*                                                                     * S6415500
*********************************************************************** S6416000
         SPACE 2                                                     R4 S6416500
         USING VEXITLST,R15        EXIT ROUTINE INITIAL BASE         R4 S6417000
VEXITLST L     MBASE2,=A(HASPVTAM) GET COMMON BASE ADDRESS           R4 S6417500
         L     BASE1,=V(HASPNUC)   GET HCT ADDRESS                   R4 S6418000
         USING HASPVTAM,MBASE2     SHOW PERMANENT ADDRESSABILITY     R4 S6418500
         USING HCTDSECT,BASE1      SHOW HCT ADDRESSABILITY           R4 S6419000
         DROP  R15                 RELEASE TEMPORARY BASE REG        R4 S6419500
         L     MACB,0(,R1)         GET ADDRESS OF ACB                R4 S6420000
         USING ACBDSECT,MACB         AND SHOW ADDRESSABLE            R4 S6420500
         L     MDCT,ACBLNDCT       GET LOGON DCT ADDRESS             R4 S6421000
         USING DCTDSECT,MDCT         AND SHOW ADDRESSABLE            R4 S6421500
         TM    MDCTSTAT,DCTSINON+DCTSOFF CHECK FOR ACB AVAILABLE     R4 S6422000
         BNMR  R14                 LET CLOSE HANDLE IT IF NOT        R4 S6422500
         LR    ML,R14              SAVE RETURN ADDRESS               R4 S6423000
         L     MICE,8(,R1)         GET ADDRESS OF ICE                R4 S6423500
         USING ICEDSECT,MICE       SHOW ICE ADDRESSABILITY           R4 S6424000
         L     R2,12(,R1)          GET LOSTERM REASON CODE           R4 S6424500
         SRL   R2,2                 DIVIDE BY 4 TO GET INDEX        R41 S6424600
         LA    R2,VXIDLOST(,R2)      ADD LOSTERM EXIT ROUTINE IDENT R41 S6425500
         B     VICEPOST               AND POST ACTION TO LINE MGR   R41 S6426000
         SPACE 2                                                     R4 S6426500
         DROP  ,                   FORGET ALL ADDRESSABILITY         R4 S6427000
         TITLE 'HASP VTAM API -- TPEND EXIT ROUTINE'                 R4 S6427500
*********************************************************************** S6428000
*                                                                     * S6428500
*   VEXITTND - VTAM API TPEND EXIT ROUTINE                            * S6429000
*                                                                     * S6429500
*                                                                     * S6430000
*        R1 =  ADDRESS OF PARAMETER LIST                              * S6430500
*                                                                     * S6431000
*              1ST WORD - ADDRESS OF ACB                              * S6431500
*              2ND WORD - REASON CODE                                 * S6432000
*                         0 ORDERLY SHUTDOWN - OPER COMMAND           * S6432500
*                         4 QUICK   SHUTDOWN - OPER COMMAND           * S6433000
*                         8 VTAM IS ABNORMALLY TERMINATING            * S6433500
*                                                                     * S6434000
*********************************************************************** S6434500
         SPACE 2                                                     R4 S6435000
         USING VEXITTND,R15        EXIT ROUTINE INITIAL BASE         R4 S6435500
VEXITTND L     MBASE2,=A(HASPVTAM) GET COMMON BASE ADDRESS           R4 S6436000
         L     BASE1,=V(HASPNUC)   GET HCT ADDRESS                   R4 S6436500
         USING HASPVTAM,MBASE2     SHOW PERMANENT ADDRESSABILITY     R4 S6437000
         USING HCTDSECT,BASE1      SHOW HCT ADDRESSABILITY           R4 S6437500
         DROP  R15                 RELEASE TEMPORARY BASE REG        R4 S6438000
         L     MACB,0(,R1)         GET ADDRESS OF ACB                R4 S6438500
         USING ACBDSECT,MACB         AND SHOW ADDRESSABLE            R4 S6439000
         L     MDCT,ACBLNDCT       GET LOGON DCT ADDRESS             R4 S6439500
         USING DCTDSECT,MDCT         AND SHOW ADDRESSABLE            R4 S6440000
         TM    MDCTSTAT,DCTSINON+DCTSOFF CHECK FOR ACB AVAILABLE     R4 S6440500
         BNMR  R14                 LET CLOSE HANDLE IT IF NOT        R4 S6441000
         LR    ML,R14              SAVE RETURN ADDRESS               R4 S6441500
         L     R2,4(,R1)           GET TPEND REASON CODE             R4 S6442000
         SRL   R2,2                ADJUST REASON CODE FOR EXIT IDENT R4 S6442500
         LA    R2,VXIDTPND(,R2)    ADD TPEND EXIT ROUTINE IDENTIFIER R4 S6443000
         B     VDCTPOST             AND POST ACTION TO LINE MANAGER  R4 S6443500
         SPACE 2                                                     R4 S6444000
         DROP  ,                   FORGET ALL ADDRESSABILITY         R4 S6444500
         TITLE 'HASP VTAM API -- SCIP EXIT ROUTINE'                  R4 S6445000
*********************************************************************** S6445500
*                                                                     * S6446000
*   VEXITSCP - VTAM API SCIP EXIT ROUTINE                             * S6446500
*                                                                     * S6447000
*                                                                     * S6447500
*        R1 =  ADDRESS OF PARAMETER LIST                              * S6448000
*                                                                     * S6448500
*              1ST WORD - ADDRESS OF ACB                              * S6449000
*              2ND WORD - CID OF TERMINAL                             * S6449500
*              3RD WORD - USERFLD/ICE ADDR                            * S6450000
*              4TH WORD - RESERVED                                    * S6450500
*              5TH WORD - ADDRESS OF R/0 RPL                          * S6451000
*                                                                     * S6451500
*********************************************************************** S6452000
         SPACE 2                                                     R4 S6452500
         USING VEXITSCP,R15        EXIT ROUTINE INITIAL BASE         R4 S6453000
VEXITSCP L     MBASE2,=A(HASPVTAM) GET COMMON BASE ADDRESS           R4 S6453500
         L     BASE1,=V(HASPNUC)   GET HCT ADDRESS                   R4 S6454000
         USING HASPVTAM,MBASE2     SHOW PERMANENT ADDRESSABILITY     R4 S6454500
         USING HCTDSECT,BASE1      SHOW HCT ADDRESSABILITY           R4 S6455000
         DROP  R15                 RELEASE TEMPORARY BASE REG        R4 S6455500
         L     MACB,0(,R1)         GET ADDRESS OF ACB                R4 S6456000
         USING ACBDSECT,MACB         AND SHOW ADDRESSABLE            R4 S6456500
         L     MDCT,ACBLNDCT       GET LOGON DCT ADDRESS             R4 S6457000
         USING DCTDSECT,MDCT         AND SHOW ADDRESSABLE            R4 S6457500
         TM    MDCTSTAT,DCTSINON+DCTSOFF CHECK FOR ACB AVAILABLE     R4 S6458000
         BNMR  R14                 LET CLOSE HANDLE IT IF NOT        R4 S6458500
         L     MICE,8(,R1)         GET ADDRESS OF ICE FOR POST       R4 S6459000
         L     MBUF,16(,R1)        GET ADDRESS OF R/O RPL            R4 S6459500
         USING RPLDSECT,MBUF       SHOW RPL ADDRESSABILITY           R4 S6460000
         TM    RPLCNTSC,RPLRQR     CHECK FOR RQR RECEIVED            R4 S6460500
         BNOR  R14                 IGNORE REQUEST IF NOT RQR         R4 S6461000
         LR    ML,R14              SAVE RETURN ADDRESS               R4 S6461500
         LA    R2,VXIDSCIP         GET SCIP EXIT ROUTINE IDENTIFIER  R4 S6462000
         B     VICEPOST             AND POST ACTION TO LINE MANAGER  R4 S6462500
         SPACE 2                                                     R4 S6463000
         DROP  ,                   FORGET ALL ADDRESSABILITY         R4 S6463500
         TITLE 'HASP VTAM API -- RELREQ EXIT ROUTINE'                R4 S6464000
*********************************************************************** S6464500
*                                                                     * S6465000
*   VEXITRLR - VTAM API RELREQ EXIT ROUTINE                           * S6465500
*                                                                     * S6466000
*                                                                     * S6466500
*        R1 =  ADDRESS OF PARAMETER LIST                              * S6467000
*                                                                     * S6467500
*              1ST WORD - ADDRESS OF ACB                              * S6468000
*              2ND WORD - ADDRESS OF TERMINALS SYMBOLIC NAME          * S6468500
*                                                                     * S6469000
*********************************************************************** S6469500
         SPACE 2                                                     R4 S6470000
         USING VEXITRLR,R15        EXIT ROUTINE INITIAL BASE         R4 S6470500
VEXITRLR L     MBASE2,=A(HASPVTAM) GET COMMON BASE ADDRESS           R4 S6471000
         L     BASE1,=V(HASPNUC)   GET HCT ADDRESS                   R4 S6471500
         USING HASPVTAM,MBASE2     SHOW PERMANENT ADDRESSABILITY     R4 S6472000
         USING HCTDSECT,BASE1      SHOW HCT ADDRESSABILITY           R4 S6472500
         DROP  R15                 RELEASE TEMPORARY BASE REG        R4 S6473000
         L     MACB,0(,R1)         GET ADDRESS OF ACB                R4 S6473500
         USING ACBDSECT,MACB         AND SHOW ADDRESSABLE            R4 S6474000
         L     MDCT,ACBLNDCT       GET LOGON DCT ADDRESS             R4 S6474500
         USING DCTDSECT,MDCT         AND SHOW ADDRESSABLE            R4 S6475000
         TM    MDCTSTAT,DCTSINON+DCTSOFF CHECK FOR ACB AVAILABLE     R4 S6475500
         BNMR  R14                 LET CLOSE HANDLE IT IF NOT        R4 S6476000
         L     R2,4(,R1)           GET ADDRESS OF SYMBOLIC NAME      R4 S6476500
         L     MICE,MDCTICE        GET ADDR OF FIRST LOGGED ON ICE   R4 S6477000
         USING ICEDSECT,MICE       SHOW ICE ADDRESSABILITY           R4 S6477500
         SPACE 1                                                     R4 S6478000
VRLRSRCH CLC   ICESYMB,0(R2)       CHECK FOR SYMBOLIC NAME MATCH     R4 S6478500
         BNE   SKIP1750            BRANCH IF NOT REQ ICE FOUND       R4 S6479000
         LA    R2,VXIDRLRQ         GET RELREQ EXIT ROUTINE IDENT     R4 S6479500
         LR    ML,R14              SET UP RETURN ADDRESS             R4 S6480000
         B     VICEPOST            POST ACTION TO LINE MANAGER       R4 S6480500
SKIP1750 L     MICE,ICEAPCHN       GET ADDR OF NEXT LOGGED ON ICE    R4 S6481000
         LTR   MICE,MICE           CHECK FOR ANY MORE ICE THERE      R4 S6481500
         BNZ   VRLRSRCH            EXAMINE NEXT ICE IF PRESENT       R4 S6482000
         BR    R14                 ELSE RETURN TO VTAM               R4 S6482500
         SPACE 2                                                     R4 S6483000
         DROP  ,                   FORGET ALL ADDRESSABILITY         R4 S6483500
         TITLE 'HASP VTAM API -- RPL REQUEST COMPLETION EXIT ROUTINE'   S6484000
*********************************************************************** S6484500
*                                                                     * S6485000
*   VEXITRPL - VTAM API REQUEST COMPLETION EXIT ROUTINE               * S6485500
*                                                                     * S6486000
*                                                                     * S6486500
*        R1 =  ADDRESS OF RPL                                         * S6487000
*                                                                     * S6487500
*********************************************************************** S6488000
         SPACE 2                                                     R4 S6488500
         USING RPLDSECT,R1         GET BUFFER ADDRESSABILITY         R4 S6489000
         USING VEXITRPL,R15        EXIT ROUTINE INITIAL BASE         R4 S6489500
         SPACE 1                                                     R4 S6490000
VEXITRPL DS    0H                  RPL REQUEST COMPLETE EXIT ROUTINE R4 S6490500
         L     MBASE2,=A(HASPVTAM) GET COMMON BASE ADDRESS           R4 S6491000
         DROP  R15                 RELEASE TEMPORARY BASE REG        R4 S6491500
         USING HASPVTAM,MBASE2     SHOW PERMANENT ADDRESSABILITY     R4 S6492000
         L     BASE1,=V(HASPNUC)   GET HCT ADDRESS                   R4 S6492500
         USING HCTDSECT,BASE1      SHOW HCT ADDRESSABILITY           R4 S6493000
         LR    WF,R14              SAVE RETURN ADDRESS               R4 S6493500
         LR    ML,R14              SET  RETURN ADDRESS FOR VBUFPOST  R4 S6494000
         SPACE 1                                                     R4 S6494500
         TM    RPLSEQTP,VSEQSPEC   CHECK RPL SEQUENCE TYPE           R4 S6495000
         BNZ   VBUFPOST            BRANCH IF SPECIAL SEQUENCE        R4 S6495500
         TM    RPLSEQTP,VSEQSEND   CHECK RPL NORMAL SEQUENCE TYPE    R4 S6496000
         BO    VRPLSEND            BRANCH IF SEND OR RESETSR-CA SEQ  R4 S6496500
         L     MDCT,RPLDCT         GET ADDRESS OF LOGON DCT          R4 S6497000
         TM    MDCTSTAT-DCTDSECT(MDCT),DCTABORT   ABORTING...  @OZ38130 S6497100
         BOR   WF                  IF SO, RETURN TO VTAM       @OZ38130 S6497200
         CLI   RPLRTNCD,USFXORDC   CHECK RECEIVE COMPLETION          R4 S6497500
         BH    VRPLRQUE            BRANCH IF COMPLETED WITH ERROR    R4 S6498000
         EJECT                                                       R4 S6498500
*                                                                    R4 S6499000
*              RECEIVE REQUEST COMPLETION HANDLING                   R4 S6499500
*                                                                    R4 S6500000
         SPACE 1                                                     R4 S6500500
VRPLRAOK TM    RPLSRTYP,RPLRRESP   CHECK TYPE OF RECEIVE             R4 S6501000
         BO    VRPLRANY            DON'T COUNT INBOUND RESPONSES     R4 S6501500
         TM    RPLSRTYP,RPLDFASY   CHECK TYPE OF  RECEIVE REQUEST    R4 S6502000
         BO    VRPLRANY            BRANCH IF EXPEDITED REQUEST @OZ57933 S6502500
         SPACE 1                                                     R4 S6503000
         USING ICEDSECT,MICE       ESTABLISH ICE ADDRESSABILITY      R4 S6503500
         L     MICE,RPLICE         GET ADDRESS OF ICE                R4 S6504000
         L     WA,ICEINLM          GET INBOUND QUEUE COUNT & LIMIT   R4 S6504500
SKIP1760 LA    R14,1               SET UP COUNTER INCREMENT          R4 S6505000
         ALR   R14,WA              UPDATE QUEUE COUNTER VALUE        R4 S6505500
         CS    WA,R14,ICEINLM      ATTEMPT TO STORE NEW VALUE        R4 S6506000
         BNE   SKIP1760            RETRY IF UNSUCCESSFUL             R4 S6506500
         SPACE 1                                               @OZ57933 S6506505
         TM    RPLFLAG2,RPLSREGS   IS RPLSAVEA BEING USED...   @OZ57933 S6506510
         BZ    VRESETSR            NO, BRANCH TO CONTINUE      @OZ57933 S6506520
         NI    RPLFLAG2,FF-RPLSREGS RESET RPLSAVEA IN USE      @OZ57933 S6506530
         B     VRPLRANY            SKIP RESETSR                @OZ57933 S6506540
         SPACE 1                                               @OZ57933 S6506550
VRESETSR SRDL  R14,16              ISOLATE QUEUE LIMIT         @OZ57933 S6507000
         SRL   R15,16               AND QUEUE COUNTER                R4 S6507500
         CLR   R14,R15             CHECK FOR HIGHWATER MARK          R4 S6508000
         BH    VRPLRANY            BRANCH IF NOT YET REACHED         R4 S6508500
*              THIS LINE DELETED BY APAR OZ57933               @OZ57933 S6508600
*              THIS LINE DELETED BY APAR OZ57933               @OZ57933 S6508700
         SPACE 1                                                     R4 S6509000
         MVI   RPLACTIV,0          RESET RPL BUSY INDICATOR          R4 S6509500
         MVI   RPLSEQTP,VSEQRSCS   SHOW RESET CS REQUEST TYPE        R4 S6510000
         MVI   RPLOPT1,RPLSEQ      SHOW SYNCHRONOUS REQUEST          R4 S6510500
         OI    RPLOPT5,RPLDLGIN    REQUEST RESETSR CS MODE           R4 S6511000
         NI    RPLSRTYP,255-(RPLNFSYN+RPLDFASY+RPLRRESP) SYNC DFL    R4 S6511500
         LA    R0,RPLRSRCD         SHOW RESETSR REQUEST CODE         R4 S6512000
         LA    R13,RPLSAVEA        PROVIDE SAVE AREA FOR VTAM       R41 S6512200
         L     R15,RPLDACB                 GET ADDRESS OF ACB        R4 S6512500
         L     R15,ACBINRTN-ACBDSECT(,R15)  INTERFACE ROUTINE        R4 S6513000
         BALR  R14,R15             LINK TO THE INTERFACE ROUTINE     R4 S6513500
         NI    RPLOPT5,255-RPLDLGIN  RESET CS OPTION           @OZ20662 S6513600
         LTR   R15,R15             CHECK REQUEST COMPLETION          R4 S6514000
         BNZ   VRPLRQUE            POST LINE MANAGER IF ERROR        R4 S6514500
         SPACE 1                                                     R4 S6515000
         USING DCTDSECT,MDCT       PROVIDE DCT ADDRESSABILITY        R4 S6515500
VRPLRANY L     MBUF,MDCTRQBF       GET NEXT RECEIVE ANY BUFFER       R4 S6516000
SKIP1770 LTR   MBUF,MBUF           CHECK FOR ANY RPL QUEUED          R4 S6516500
         BZ    VRPLRQUE            BRANCH IF QUEUE IS EMPTY          R4 S6517000
         L     R0,RPLNEXT-RPLDSECT(,MBUF) GET ADDR OF NEXT BUF       R4 S6517500
         CS    MBUF,R0,MDCTRQBF    ATTEMPT TO UPDATE QUEUE           R4 S6518000
         BNE   SKIP1770            RETRY IF UNSUCCESSFUL             R4 S6518500
         STCM  MBUF,8,RPLFLAGS     SAVE RCV AHEAD QUEUE COUNT        R4 S6519000
         BAL   ML,VBUFPOST         QUEUE BUFFER TO LINE MANAGER      R4 S6519500
         SPACE 1                                                     R4 S6520000
         LR    R1,MBUF             GET RCV ANY RPL ADDRESSABILITY    R4 S6520500
         MVI   RPLOPT1,RPLSEQ      SHOW SYNCHRONOUS REQUEST          R4 S6521000
         LA    R0,RPLRCVCD         SHOW RECEIVE REQUEST CODE         R4 S6521500
         LA    R13,RPLSAVEA        PROVIDE A SAVEAREA FOR VTAM       R4 S6522000
         L     R15,RPLDACB                 GET ADDRESS OF ACB        R4 S6522500
         L     R15,ACBINRTN-ACBDSECT(,R15)  INTERFACE ROUTINE        R4 S6523000
         BALR  R14,R15             LINK TO THE INTERFACE ROUTINE     R4 S6523500
         LTR   R15,R15             CHECK REQUEST COMPLETION          R4 S6524000
         BZ    VRPLRAOK            BRANCH IF SUCCESSFUL RCV          R4 S6524500
         CLI   RPLRTNCD,USFXORDC   CHECK RECEIVE COMPLETION          R4 S6525000
         BNH   VRPLRAOK            BRANCH IF EXCEPTION RCV           R4 S6525500
         SPACE 1                                                     R4 S6526000
VRPLRQUE MVI   RPLFLAGS,0          INDICATE NO RCV ANY ISSUED        R4 S6526500
         BAL   ML,VBUFPOST         QUEUE BUFFER TO LINE MANAGER      R4 S6527000
         DROP  R1                  RELEASE RPL ADDRESSABILITY        R4 S6527500
         SPACE 1                                                     R4 S6528000
VRPLRXIT L     R1,MDCTRABF         GET COUNT OF ACTIVE               R4 S6528500
SKIP1780 L     R0,=A(-X'01000000')  RECEIVE ANY REQUESTS             R4 S6529000
         ALR   R0,R1                 AND DECREMENT BY ONE            R4 S6529500
         CS    R1,R0,MDCTRABF      ATTEMPT TO UPDATE COUNT           R4 S6530000
         BER   WF                  RETURN TO VTAM IF STORED          R4 S6530500
         B     SKIP1780            RETRY IF UNSUCCESSFUL             R4 S6531000
         DROP  MDCT                RELEASE DCT ADDRESSABILITY        R4 S6531500
         EJECT                                                       R4 S6532000
*                                                                    R4 S6532500
*              SEND REQUEST COMPLETION HANDLING                      R4 S6533000
*                                                                    R4 S6533500
         SPACE 1                                                     R4 S6534000
         USING RPLDSECT,R1         PROVIDE RPL ADDRESSABILITY        R4 S6534500
VRPLSEND CLI   RPLRTNCD,USFXORDC   CHECK REQUEST COMPLETION          R4 S6535000
         BH    VBUFPOST            BRANCH IF COMPLETED WITH ERROR    R4 S6535500
         CLI   RPLSEQTP,VSEQRSCA   IF RESETSR CA               @OZ51016 S6535600
         BE    VBUFPOST             Q BUFFER TO LM AND POST    @OZ51016 S6535800
         L     MICE,RPLICE         GET ADDRESS OF ICE                R4 S6536000
         SPACE 1                                                     R4 S6536500
VRPLSAOK BAL   ML,VBUFPOST         QUEUE BUFFER TO L.M. AND POST     R4 S6537000
         LM    R14,R15,ICEOUTHD    GET OUTBOUND QUEUE POINTERS       R4 S6537500
         SPACE 1                                                     R4 S6538000
         USING RPLDSECT,MBUF       PROVIDE RPL ADDRESSABILITY        R4 S6538500
VRPLSDEQ LTR   MBUF,R14            CHECK FOR ANY BUFFER QUEUED       R4 S6539000
         ST    MBUF,ICEOUTBF       SET UP ACTIVE OUTB RPL ADDR       R4 S6539500
         BZR   WF                  RETURN TO VTAM IF OUTB QUE EMPTY  R4 S6540000
         CLR   R14,R15             TEST FOR LAST BUFFER ON QUEUE     R4 S6540500
         BE    VRPLSNGL            BRANCH IF ONE BUFFER ONLY         R4 S6541000
         L     R0,RPLNEXT          GET ADDR OF NEXT BUFFER           R4 S6541500
         LR    R1,R15              GET ADDR OF LAST BUFFER           R4 S6542000
         CDS   R14,R0,ICEOUTHD     ATTEMPT TO UPDATE QUEUE PNTRS     R4 S6542500
         BNE   VRPLSDEQ            RETRY IF UNSUCCESSFUL             R4 S6543000
         SLR   R1,R1               CLEAR TAIL BUFFER POINTER         R4 S6543500
         B     VRPLSRST            BRANCH TO RESET CHAIN FIELD       R4 S6544000
         SPACE 1                                                     R4 S6544500
VRPLSNGL SLR   R0,R0               CLEAR HEAD BUFFER POINTER         R4 S6545000
         SLR   R1,R1               CLEAR TAIL BUFFER POINTER         R4 S6545500
         CDS   R14,R0,ICEOUTHD     ATTEMPT TO RESET QUEUE            R4 S6546000
         BNE   VRPLSDEQ            RETRY IF UNSUCCESSFUL             R4 S6546500
         LA    R0,ICEOUTHD         GET LAST BUFFER CHAIN INDIC       R4 S6547000
         SPACE 1                                                     R4 S6547500
VRPLSRST CS    R0,R1,RPLNEXT       ATTEMPT TO RESET CHAIN FIELD      R4 S6548000
         BNE   VRPLSRST            LOOP UNTIL SUCCESSFUL             R4 S6548500
         MVI   RPLOPT1,RPLSEQ      SHOW SYNCHRONOUS REQUEST          R4 S6549000
         SLR   R0,R0               CLEAR REQUEST PARAMETER REG       R4 S6549500
         IC    R0,RPLREQ           GET   REQUEST TYPE FROM RPL       R4 S6550000
         LR    R1,MBUF             LOAD RPL ADDRESS                  R4 S6550500
         LA    R13,RPLSAVEA        PROVIDE SAVEAREA FOR VTAM         R4 S6551000
         L     R15,RPLDACB                 GET ADDRESS OF ACB        R4 S6551500
         L     R15,ACBINRTN-ACBDSECT(,R15)  INTERFACE ROUTINE        R4 S6552000
         BALR  R14,R15             LINK TO THE INTERFACE ROUTINE     R4 S6552500
         LTR   R15,R15             CHECK FOR SUCCESSFUL COMPLETION   R4 S6553000
         BZ    VRPLSAOK            BRANCH IF ERROR FREE COMPLETION   R4 S6553500
         LR    ML,WF               RESTORE VTAM EXIT RETURN ADDRESS  R4 S6554000
         B     VBUFPOST            QUE BUF TO L.M. & RETURN TO VTAM  R4 S6554500
         DROP  ,                   FORGET ALL ADDRESSABILITY         R4 S6555000
         TITLE 'HASP VTAM API -- SUBROUTINES'                        R4 S6555500
*********************************************************************** S6556000
*                                                                     * S6556500
*        SUBROUTINE TO QUEUE AN ICE TO THE LINE MANAGER               * S6557000
*                                                                     * S6557500
*********************************************************************** S6558000
         SPACE 2                                                     R4 S6558500
         USING HASPVTAM,MBASE2     SHOW COMMON ADDRESSABILITY        R4 S6559000
         USING HCTDSECT,BASE1      SHOW HCT ADDRESSABILITY           R4 S6559500
         USING DCTDSECT,MDCT       SHOW DCT ADDRESSABILITY           R4 S6560000
         USING ICEDSECT,MICE       SHOW ICE ADDRESSABILITY           R4 S6560500
         SPACE 2                                                     R4 S6561000
VICEPOST DS    0H                  QUEUE THE ICE TO LINE MANAGER     R4 S6561500
         L     R1,DCTPCE           GET PCE ADDRESS FROM LOGON DCT    R4 S6562000
         USING PCEDSECT,R1         SHOW PCE ADDRESSABILITY           R4 S6562500
         SLL   R2,24               SHIFT REQ ACTION CODE TO LEFT     R4 S6563000
         L     R15,ICEXTCHN        GET ICE EXIT ROUT CHAIN FIELD     R4 S6563500
VICECHCK LTR   R15,R15             CHECK IF ICE IS ALREADY QUEUED    R4 S6564000
         BNZ   VICEUPDT            UPDATE ACTION CODE IF YES         R4 S6564500
         L     R0,MICEQUE          GET ICE QUEUE HEAD POINTER        R4 S6565000
         SPACE 1                                                     R4 S6565500
VICERTRY LR    R14,R0              COPY ICE QUEUE HEAD POINTER       R4 S6566000
         LA    R14,0(,R14)           PURIFY ADDRESS                  R4 S6566500
         ALR   R14,R2                 ADD REQ ACTION CODE TO IT      R4 S6567000
         CS    R15,R14,ICEXTCHN    ATTEMPT TO STORE CHAIN ADDR       R4 S6567500
         BNE   VICEUPDT            BRANCH IF CHANGED MEANWHILE       R4 S6568000
         LR    R15,R14             RELOAD REG15 FOR RETRY CASE       R4 S6568500
         CS    R0,MICE,MICEQUE     ATTEMPT TO CHAIN ICE TO QUEUE     R4 S6569000
         BE    VMLMPOST            POST LINE MANAGER IF QUEUED       R4 S6569500
         B     VICERTRY            RETRY IF UNSUCCESSFUL             R4 S6570000
         SPACE 1                                                     R4 S6570500
VICEUPDT LA    R14,0(,R15)         PURIFY CHAIN ADDRESS OF ICE       R4 S6571000
         ALR   R14,R2              ADD ACTION CODE TO CHAIN ADDR     R4 S6571500
         CLR   R14,R15             CHECK SEVERITY OF NEW REQ ACTION  R4 S6572000
         BH    VICEUDTE            IF HIGH, UPDATE EXIT CODE   @OZ44753 S6572500
         CLM   R14,8,=X'64'        IF THIS IS 2ND ENTRY OF     @OZ44753 S6572550
         BE    VICEUPD1             LOSTERM AND FIRST ENTRY    @OZ44753 S6572600
         CLM   R14,8,=X'63'          IS STILL SCHEDULED,       @OZ44753 S6572650
         BNER  ML                     QUEUE THE ICE FOR        @OZ44753 S6572700
VICEUPD1 CLM   R15,8,=X'66'            SECOND ENTRY OF         @OZ44753 S6572750
         BNER  ML                       LOSTERM ANYWAY         @OZ44753 S6572800
VICEUDTE CS    R15,R14,ICEXTCHN    ATTEMPT UPDATE ACTION CODE  @OZ44753 S6573000
         BER   ML                  RETURN TO CALLER IF STORED        R4 S6573500
         B     VICECHCK            RETRY IF UNSUCCESSFUL             R4 S6574000
         SPACE 2                                                     R4 S6574500
         DROP  R1                  RELEASE PCE ADDRESSABILITY        R4 S6575000
         EJECT                                                       R4 S6575500
*********************************************************************** S6576000
*                                                                     * S6576500
*        SUBROUTINE TO QUEUE A LOGON DCT TO LINE MANAGER              * S6577000
*                                                                     * S6577500
*********************************************************************** S6578000
         SPACE 2                                                     R4 S6578500
VDCTPOST DS    0H                  QUEUE LOGON DCT TO LINE MANAGER   R4 S6579000
         L     R1,DCTPCE           PICK UP PCE ADDRESS FROM PCE      R4 S6579500
         USING PCEDSECT,R1         SHOW PCE ADDRESSABILITY           R4 S6580000
         SLL   R2,24               SHIFT REQ ACTION CODE TO LEFT     R4 S6580500
         L     R15,MDCTEXIT        GET DCT EXIT ROUT CHAIN FIELD     R4 S6581000
VDCTCHCK LTR   R15,R15             CHECK IF DCT IS ALREADY QUEUED    R4 S6581500
         BNZ   VDCTUPDT            UPDATE ACTION CODE IF YES         R4 S6582000
         L     R0,MLOGQUE          GET DCT QUEUE HEAD POINTER        R4 S6582500
VDCTRTRY LR    R14,R0              COPY DCT QUEUE HEAD POINTER       R4 S6583000
         LA    R14,0(,R14)           PURIFY ADDRESS                  R4 S6583500
         ALR   R14,R2                 ADD REQ ACTION CODE TO IT      R4 S6584000
         CS    R15,R14,MDCTEXIT    ATTEMPT TO STORE CHAIN ADDR       R4 S6584500
         BNE   VDCTUPDT            BRANCH IF CHANGED MEANWHILE       R4 S6585000
         LR    R15,R14             RELOAD REG15 FOR RETRY CASE       R4 S6585500
         CS    R0,MDCT,MLOGQUE     ATTEMPT TO CHAIN DCT TO QUEUE     R4 S6586000
         BE    VMLMPOST            POST LINE MANAGER IF CHAINED      R4 S6586500
         B     VDCTRTRY            RETRY IF UNSUCCESSFUL             R4 S6587000
         SPACE 1                                                     R4 S6587500
VDCTUPDT LA    R14,0(,R15)         PURIFY CHAIN ADDRESS OF DCT       R4 S6588000
         ALR   R14,R2              ADD ACTION CODE TO CHAIN ADDR     R4 S6588500
         CLR   R14,R15             CHECK SEVERITY OF NEW REQ ACTION  R4 S6589000
         BNHR  ML                  RETURN TO CALLER IF NOT HIGHER    R4 S6589500
         CS    R15,R14,MDCTEXIT    ATTEMPT TO UPDATE ACTION CODE     R4 S6590000
         BER   ML                  RETURN TO CALLER IF STORED        R4 S6590500
         B     VDCTCHCK             RETRY IF UNSUCCESSFUL            R4 S6591000
         SPACE 2                                                     R4 S6591500
         DROP  R1                  RELEASE PCE ADDRESSABILITY        R4 S6592000
         EJECT                                                       R4 S6592500
*********************************************************************** S6593000
*                                                                     * S6593500
*        SUBROUTINE TO QUEUE A BUFFER TO THE LINE MANAGER             * S6594000
*                                                                     * S6594500
*********************************************************************** S6595000
         SPACE 2                                                     R4 S6595500
         USING RPLDSECT,R1         PROVIDE RPL ADDRESSABILITY        R4 S6596000
         SPACE 1                                                     R4 S6596500
VBUFPOST DS    0H                  QUEUE BUFFER TO LINE MANAGER      R4 S6597000
         LA    R1,0(,R1)           CLEAR HIGH ORDER BYTE RPL   @OZ20651 S6597200
         L     R0,$RJECHEQ         GET BUFFER QUEUE HEAD POINTER     R4 S6597500
SKIP1790 ST    R0,RPLNEXT          ADD BUFFER TO RJE REQ END QUEUE   R4 S6598000
         CS    R0,R1,$RJECHEQ      ATTEMPT TO UPDATE QUEUE POINTER   R4 S6598500
         BNE   SKIP1790            RETRY IF UNSUCCESSFUL             R4 S6599000
         MVI   RPLACTIV,X'80'      SHOW RPL ON $RJECHEQ        @OZ44972 S6599100
         DROP  R1                  RELEASE RPL ADDRESSABILITY        R4 S6599500
         SPACE 3                                                     R4 S6600000
*********************************************************************** S6600500
*                                                                     * S6601000
*        SUBROUTINE TO POST THE LINE MANAGER (QUICK POST ATTEMPT)     * S6601500
*                                                                     * S6602000
*********************************************************************** S6602500
         SPACE 2                                                     R4 S6603000
VMLMPOST DS    0H                  POST THE LINE MANAGER AND JES     R4 S6603500
         L     R10,=X'40000000'    GET POST COMPLETION CODE          R4 S6604000
         L     R15,$SSVT           GET ADDRESS OF SSVT               R4 S6604500
         USING $SVDSECT,R15        TEMPORARY SSVT ADDRESSABILITY     R4 S6605000
         MVI   $SVMLLM,X'FF'       SET MLLM $POST REQUESTED          R4 S6605500
         DROP  R15                 RELEASE SSVT TEMP. ADDRESSABILITY R4 S6606000
         L     R15,$HASPECB        GET HASP ECB ADDRESS              R4 S6606500
         MVI   $SVPOSTW(R15),X'FF' SET HASP DISPATCHER POST          R4 S6607000
         SPACE 1                                                     R4 S6607500
         L     R1,0(,R15)          CHECK THE ECB FOR                 R4 S6608000
SKIP1800 LTR   R1,R1                HASP TASK WAITING                R4 S6608500
         BM    VPOSTIT             DO LONG POST IF YES               R4 S6609000
         CS    R1,R10,0(R15)       ATTEMPT TO QUICK POST             R4 S6609500
         BNE   SKIP1800            RETRY IF UNSUCCESSFUL             R4 S6610000
         BR    ML                  RETURN TO CALLER                  R4 S6610500
         EJECT                                                       R4 S6611000
*********************************************************************** S6611500
*                                                                     * S6612000
*        SUBROUTINE TO POST THE LINE MANAGER (VIA BRANCH ENTRY)       * S6612500
*              (REGS R0-R2,R10-R15 VOLATILE ACROSS ROUTINE)           * S6613000
*                                                                     * S6613500
*********************************************************************** S6614000
         SPACE 2                                                     R4 S6614500
VPOSTIT  DS    0H                  ZERO KEY AND LOCAL LOCK FOR POST  R4 S6615000
         SLR   R2,R2               ASSUME ZERO PROTECTION KEY        R4 S6615500
         L     R1,PSATOLD-PSADSECT  PICK UP OLD TCB ADDRESS         R41 S6616000
         LTR   R1,R1               TEST FOR NO TCB ADDR PRESENT     R41 S6616500
         BZ    VPOSTLCK            SKIP MODESETS IF IN SRB MODE     R41 S6617000
         SPACE 1                                                     R4 S6617500
         MODESET MODE=SUP          ENTER SUPERVISOR STATE            R4 S6618000
         SPACE 1                                                     R4 S6618500
         MODESET EXTKEY=ZERO,SAVEKEY=(2) GET PROPER PSW KEY          R4 S6619000
         SPACE 2                                                     R4 S6619500
VPOSTLCK DS    0H                  GET LOCAL LOCK                    R4 S6620000
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=VPOSTREL      R4 S6620500
         SPACE 1                                                     R4 S6621000
         L     BASE1,=V(HASPNUC)   RELOAD HCT ADDRESS                R4 S6621500
         L     R11,$HASPECB        RELOAD HASP ECB ADDRESS           R4 S6622000
         DROP  BASE1               SHOW HCT ADDRESSABILITY KILLED    R4 S6622500
         L     R1,CVTPTR           GET CVT ADDRESS                   R4 S6623000
         USING CVTDSECT,R1         TEMPORARY CVT ADDRESSABILITY      R4 S6623500
         L     R15,CVT0PT02        GET POST BRANCH ENTRY             R4 S6624000
         BALR  R14,R15             ENTER POST ROUTINE                R4 S6624500
         DROP  R1                  RELEASE TEMPORARY CVT BASE        R4 S6625000
         EJECT                                                       R4 S6625500
VPOSTREL DS    0H                  RELEASE LOCAL LOCK                R4 S6626000
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=VPOSTLCK                 R4 S6626500
         SPACE 1                                                     R4 S6627000
         L     BASE1,=V(HASPNUC)   RELOAD HCT ADDRESS                R4 S6627500
         LTR   R2,R2               CHECK OLD PROTECTION KEY          R4 S6628000
         BZR   ML                  RETURN TO CALLER IF IT WAS ZERO   R4 S6628500
         SPACE 1                                                     R4 S6629000
         MODESET EXTKEY=HASP       RETURN TO OLD PROTECT KEY         R4 S6629500
         BR    ML                  RETURN TO CALLER                  R4 S6630000
         SPACE 2                                                     R4 S6630500
         DROP  ,                                                     R4 S6631000
         SPACE 2                                                     R4 S6631500
         LTORG                                                       R4 S6632000
         SPACE 2                                                     R4 S6632500
$DLENGTH $DLENGTH                  DISPLAY LENGTH OF ASSEMBLY        R4 S6633000
APARNUM  DC    CL5'57933'          APAR NUMBER                          S6633498
         END   ,                                                     R4 S6633500
