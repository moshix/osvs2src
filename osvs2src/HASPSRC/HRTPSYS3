         TITLE 'HASP SYSTEM/3 REMOTE JOB ENTRY WORKSTATION'             X0002000
*********************************************************************** X0004000
*                                                                     * X0006000
* MODULE NAME = HRTPSYS3                                              * X0008000
*                                                                     * X0010000
* DESCRIPTIVE NAME = SYSTEM/3 WORK STATION PROGRAM                    * X0012000
*                                                                     * X0014000
* COPYRIGHT = NONE                                                    * X0016000
*                                                                     * X0018000
* STATUS = OS/VS2 RELEASE 2, LEVEL 0                                  * X0020000
*                                                                     * X0022000
* FUNCTION = TO PROVIDE THE SYSTEM/3 WORK STATION COMPONENT FOR RJE   * X0024000
*            IMPLEMENTATION USING THE MULTI-LEAVING DISCIPLINE OF     * X0026000
*            RTAM.  THIS PROGRAM EXTENDS TO THE REMOTE LOCATION THE   * X0028000
*            FACILITIES OF LOCAL DEVICES SUCH AS OPERATOR CONSOLE     * X0030000
*            TYPEWRITER, CARD READER(S), CARD PUNCH(ES), HIGH SPEED   * X0032000
*            LINE PRINTER.  THE MODULE OPERATES IN A STAND-ALONE      * X0034000
*            ENVIRONMENT AND REQUIRES NO EXTERNAL SUPPORT PROGRAM.    * X0036000
*            THE SOURCE CODE IS ASSEMBLED USING THE OS/VS2 ASSEMBLER  * X0038000
*            F PROGRAM IN ORDER TO SHARE THE GENERATION PARAMETERS    * X0040000
*            USED TO QUALIFY THE HOST SYSTEM.  FOR AN EXPLANATION OF  * X0042000
*            THE INTERNAL PROGRAM OPERATION SEE OS/VS2 JES2 LOGIC.    * X0044000
*                                                                     * X0046000
* NOTES = SEE BELOW                                                   * X0048000
*                                                                     * X0050000
*    DEPENDENCIES = RTAM MULTI-LEAVING PROTOCOL                       * X0052000
*                                                                     * X0054000
*    RESTRICTIONS = NONE                                              * X0056000
*                                                                     * X0058000
*    REGISTER CONVENTIONS = SEE SYMBOLIC REGISTERS UNDER GENERAL      * X0060000
*                           EQUATES                                   * X0062000
*                                                                     * X0064000
*    PATCH LABEL = NONE                                               * X0066000
*                                                                     * X0068000
* MODULE TYPE = STAND-ALONE PROGRAM                                   * X0070000
*                                                                     * X0072000
*    PROCESSOR = ASSEMBLER F                                          * X0074000
*                                                                     * X0076000
*    MODULE SIZE = AS SPECIFIED BY RMTGEN PARAMETER &MACHSIZ          * X0078000
*                                                                     * X0080000
*    ATTRIBUTES = STAND-ALONE                                         * X0082000
*                                                                     * X0084000
* ENTRY POINT = $INIT                                                 * X0086000
*                                                                     * X0088000
*    PURPOSE = SEE FUNCTION                                           * X0090000
*                                                                     * X0092000
*    LINKAGE = ENTERED FROM SYSTEM/3 LOAD PROGRAM VIA END CARD LABEL  * X0094000
*                                                                     * X0096000
* INPUT = (1) OS/VS2 JOBSTREAM VIA 96 OR 80 COL. CARD READER          * X0098000
*         (2) OPERATOR COMMANDS VIA TYPEWRITER KEYBOARD OR CARD READE * X0100000
*         (3) MULTI-LEAVING BLOCKS VIA T/P LINE FROM HOST PROCESSOR   * X0102000
*                                                                     * X0104000
* OUTPUT = (1) SYSTEM DIRECTED OUTPUT FROM HOST PROCESSOR VIA HIGH    * X0106000
*              SPEED LINE PRINTER, 80, OR 96 COL. CARD PUNCH          * X0108000
*          (2) RESPONSES TO OPERATOR COMMANDS VIA TYPEWRITER PRINTER  * X0110000
*              OR HIGH SPEED LINE PRINTER                             * X0112000
*          (3) MULTI-LEAVING BLOCKS VIA T/P LINE TO HOST PROCESSOR    * X0114000
*          (4) LOCALLY GENERATED OPERATOR MESSAGES                    * X0116000
*                                                                     * X0118000
* EXIT-NORMAL = NONE                                                  * X0120000
*                                                                     * X0122000
* EXIT-ERROR = NONE                                                   * X0124000
*                                                                     * X0126000
* EXTERNAL REFERENCES = NONE                                          * X0128000
*                                                                     * X0130000
*    ROUTINES = NONE                                                  * X0132000
*                                                                     * X0134000
*    DATA AREAS = NONE                                                * X0136000
*                                                                     * X0138000
*    CONTROL AREAS = NONE                                             * X0140000
*                                                                     * X0142000
* TABLES = (1) FUNCTION BLOCK - SEE LABEL FBD                         * X0144000
*          (2) HOPPER CONTROL AREA - SEE LABEL HCD                    * X0146000
*                                                                     * X0148000
* MACROS = ALL MACROS ARE LOCAL TO THE ASSEMBLY                       * X0150000
*                                                                     * X0152000
* CHANGE ACTIVITY                                                     * X0154000
*                                                                     * X0154100
*     RELEASE 4.0 = NONE                                              * X0154200
*                                                                     * X0154300
*     RELEASE 4.1 = OZ13263                                           * X0154400
*                                                                     * X0156000
*********************************************************************** X0158000
         PRINT OFF                                                      X0160000
         TITLE 'SYSTEM/3 MACROES'                                       X0162000
         MACRO                                                          X0164000
&N       $X1   &A,&B,&L,&OP                                             X0166000
         GBLC  &BASE                                                    X0168000
         LCLB  &O1,&O2,&OX,&OY,&LX                                      X0170000
         LCLC  &BA,&BB                                                  X0172000
         LCLC  &XA,&XB,&XC,&YA,&YB,&YC                                  X0174000
         LCLC  &Z                                                       X0176000
.*                                                                      X0178000
.*                                                                      X0180000
.*                                                                      X0182000
         AIF   (T'&L NE 'O').AST                                        X0184000
&Z       SETC  '0'                                                      X0186000
         AGO   .SETLX                                                   X0188000
.AST     AIF   ('&L' NE '*-*').NUM                                      X0190000
&Z       SETC  '0'                                                      X0192000
         AGO   .SETLX                                                   X0194000
.NUM     AIF   (&OP NE 8).ZRO                                           X0196000
&Z       SETC  '&L'                                                     X0198000
         AGO   .SETLX                                                   X0200000
.ZRO     AIF   (T'&L NE 'N').NOTLX                                      X0202000
         AIF   (&L NE 0).NOTLX                                          X0204000
.SETLX   ANOP                                                           X0206000
&LX      SETB  1                                                        X0208000
.NOTLX   ANOP                                                           X0210000
&O1      SETB  (N'&A EQ 2)                                              X0212000
&O2      SETB  (N'&B EQ 2)                                              X0214000
&OX      SETB  (N'&A EQ 1)                                              X0216000
&OY      SETB  (N'&B EQ 1)                                              X0218000
.*                                                                      X0220000
.*                                                                      X0222000
.*                                                                      X0224000
         AIF   (&O1 OR &OX).OK1                                         X0226000
         MNOTE 8,'ILLEGAL FIRST OPERAND - &A'                           X0228000
         AGO   .ERROR                                                   X0230000
.OK1     AIF   (&O2 OR &OY).OK2                                         X0232000
         MNOTE 8,'ILLEGAL SECOND OPERAND - &B'                          X0234000
         AGO   .ERROR                                                   X0236000
.*                                                                      X0238000
.*                                                                      X0240000
.*                                                                      X0242000
.OK2     AIF   (&OX).B                 BR IF NO BASE IN OP 1            X0244000
         $BASE &A(2)                   SEE IF THERE'S A 'USING'         X0246000
         AIF   ('&BASE' EQ '0').B      BR IF NO CORRESPOINDNG 'USING'   X0248000
&XA      SETC  '-('                                                     X0250000
&XB      SETC  '&BASE'                                                  X0252000
&XC      SETC  ')'                                                      X0254000
.*                                                                      X0256000
.*                                                                      X0258000
.*                                                                      X0260000
.B       AIF   (&OY).C                 BR IF NO BASE IN OP 2            X0262000
         $BASE &B(2)                   SEE IF THERE'S A 'USING'         X0264000
         AIF   ('&BASE' EQ '0').C      NOPE - BRANCH.                   X0266000
&YA      SETC  '-('                                                     X0268000
&YB      SETC  '&BASE'                                                  X0270000
&YC      SETC  ')'                                                      X0272000
.*                                                                      X0274000
.*                                                                      X0276000
.*                                                                      X0278000
.C       AIF   (&O1 AND &O2).BOTH                                       X0280000
         AIF   (&O1).FIRST                                              X0282000
         AIF   (&O2).SECOND                                             X0284000
.*                                                                      X0286000
.*                                                                      X0288000
.*                                                                      X0290000
         AIF   (&LX).NONE0                                              X0292000
&N       DC    YL1(&OP,&L-1),YL2(&A,&B)                                 X0294000
         MEXIT                                                          X0296000
.NONE0   ANOP                                                           X0298000
&N       DC    YL1(&OP,&Z),YL2(&A,&B)                                   X0300000
         MEXIT                                                          X0302000
.*                                                                      X0304000
.*                                                                      X0306000
.*                                                                      X0308000
.BOTH    AIF   (&LX).BOTH0                                              X0310000
&N       DC    YL.2(&A(2),&B(2)),YL.4(&OP),YL1(&L-1,&A(1)&XA&XB&XC,&B(1CX0312000
               )&YA&YB&YC)                                              X0314000
         MEXIT                                                          X0316000
.BOTH0   ANOP                                                           X0318000
&N       DC    YL.2(&A(2),&B(2)),YL.4(&OP),YL1(&Z,&A(1)&XA&XB&XC,&B(1)&CX0320000
               YA&YB&YC)                                                X0322000
         MEXIT                                                          X0324000
.*                                                                      X0326000
.*                                                                      X0328000
.*                                                                      X0330000
.FIRST   AIF   (&LX).FIRST0                                             X0332000
&N       DC    YL.2(&A(2),0),YL.4(&OP),YL1(&L-1,&A(1)&XA&XB&XC),YL2(&B) X0334000
         MEXIT                                                          X0336000
.FIRST0  ANOP                                                           X0338000
&N       DC    YL.2(&A(2),0),YL.4(&OP),YL1(&Z,&A(1)&XA&XB&XC),YL2(&B)   X0340000
         MEXIT                                                          X0342000
.*                                                                      X0344000
.*                                                                      X0346000
.*                                                                      X0348000
.SECOND  AIF   (&LX).SECOND0                                            X0350000
&N       DC    YL.2(0,&B(2)),YL.4(&OP),YL1(&L-1),YL2(&A),YL1(&B(1)&YA&YCX0352000
               B&YC)                                                    X0354000
         MEXIT                                                          X0356000
.SECOND0 ANOP                                                           X0358000
&N       DC    YL.2(0,&B(2)),YL.4(&OP),YL1(&Z),YL2(&A),YL1(&B(1)&YA&YB&CX0360000
               YC)                                                      X0362000
         MEXIT                                                          X0364000
.ERROR   ANOP                                                           X0366000
&N       DC    XL6'0'              *****  E R R O R  *****              X0368000
         MEND                                                           X0370000
         MACRO                                                          X0372000
&N       $Y    &A,&B,&OP                                                X0374000
         GBLC  &BASE                                                    X0376000
         LCLC  &XA,&XB,&XC                                              X0378000
         AIF   (N'&A EQ 1).ONE     NO BASE SPECIFIED                    X0380000
         AIF   (N'&A EQ 2).TWO     BSE IS SPECIFIED.                    X0382000
         MNOTE 8,'ILLEGAL FIRST OPERAND - &A'                           X0384000
&N       DC    AL4(0)              *****  E R R O R  *****              X0386000
         MEXIT                                                          X0388000
.ONE     ANOP                                                           X0390000
&N       DC    YL.4(3,&OP),YL1(&B),YL2(&A)                              X0392000
         MEXIT                                                          X0394000
.TWO     $BASE &A(2)                                                    X0396000
         AIF   ('&BASE' EQ '0').DOIT                                    X0398000
&XA      SETC  '-('                                                     X0400000
&XB      SETC  '&BASE'                                                  X0402000
&XC      SETC  ')'                                                      X0404000
.DOIT    ANOP                                                           X0406000
&N       DC    YL.4(3+&A(2)*4,&OP),YL1(&B,&A(1)&XA&XB&XC)               X0408000
         MEND                                                           X0410000
         MACRO                                                          X0412000
&N       $Z    &A,&B,&OP                                                X0414000
         GBLC  &BASE                                                    X0416000
         LCLC  &XA,&XB,&XC                                              X0418000
         AIF   (N'&A EQ 1).ONE     NO BASE SPECIFIED.                   X0420000
         AIF   (N'&A EQ 2).TWO     BASE IS SPECIFIED.                   X0422000
         MNOTE 8,'ILLEGAL FIRST OPERAND - &A'                           X0424000
&N       DC    AL4(0)              *****  E R R O R  *****              X0426000
         MEXIT                                                          X0428000
.ONE     ANOP                                                           X0430000
&N       DC    YL.4(12,&OP),YL1(&B),YL2(&A)                             X0432000
         MEXIT                                                          X0434000
.TWO     $BASE &A(2)                                                    X0436000
         AIF   ('&BASE' EQ '0').DOIT                                    X0438000
&XA      SETC  '-('                                                     X0440000
&XB      SETC  '&BASE'                                                  X0442000
&XC      SETC  ')'                                                      X0444000
.DOIT    ANOP                                                           X0446000
&N       DC    YL.4(12+&A(2),&OP),YL1(&B,&A(1)&XA&XB&XC)                X0448000
         MEND                                                           X0450000
         MACRO                                                          X0452000
         $USING &A,&B                                                   X0454000
         GBLC  &X(2),&Y(2)                                              X0456000
         LCLA  &N                                                       X0458000
         LCLC  &W                                                       X0460000
         AIF   ('&Y(1)' NE '&B' AND '&Y(2)' NE '&B').OK                 X0462000
&N       SETA  1                                                        X0464000
         AIF   ('&Y(1)' EQ '&B').SET                                    X0466000
&N       SETA  2                                                        X0468000
         AGO   .SET                                                     X0470000
.OK      ANOP                                                           X0472000
&N       SETA  &N+1                                                     X0474000
         AIF   (&N GT 2).ERR                                            X0476000
         AIF   ('&X(&N)' NE '').OK                                      X0478000
&Y(&N)   SETC  '&B'                                                     X0480000
.SET     AIF   ('&A'(1,1) NE '*').NA                                    X0482000
&W       SETC  '&A'(2,K'&A-1)                                           X0484000
$&SYSNDX EQU   *&W                                                      X0486000
&X(&N)   SETC  '$&SYSNDX'                                               X0488000
         MEXIT                                                          X0490000
.ERR     MNOTE 8,'MORE THAN 2 CHARACTERS IN ''&B''.  ''$USING'' IGNOREDCX0492000
               .'                                                       X0494000
         MEXIT                                                          X0496000
.NA      AIF   (K'&A LE 8 AND K'&A GT 0).DO                             X0498000
         MNOTE 8,'MORE THAN 8 CHARACTERS IN ''&A''.  ''$USING'' IGNOREDCX0500000
               .'                                                       X0502000
         MEXIT                                                          X0504000
.DO      ANOP                                                           X0506000
&X(&N)   SETC  '&A'                                                     X0508000
         MEND                                                           X0510000
         MACRO                                                          X0512000
         $DROP &A,&B                                                    X0514000
         GBLC  &X(2),&Y(2)                                              X0516000
         LCLA  &M,&N                                                    X0518000
         LCLC  &S(2)                                                    X0520000
         LCLC  &C(2)                                                    X0522000
&C(1)    SETC  '&A'                                                     X0524000
&C(2)    SETC  '&B'                                                     X0526000
&M       SETA  1                                                        X0528000
.GO      ANOP                                                           X0530000
&N       SETA  &N+1                                                     X0532000
         AIF   (&N GT 2).ERR                                            X0534000
         AIF   ('&C(&M)' NE '&Y(&N)').GO                                X0536000
&X(&N)   SETC  ''                                                       X0538000
&Y(&N)   SETC  ''                                                       X0540000
         AGO   .NXT                                                     X0542000
.ERR     MNOTE 4,'SYMBOL ''&C(&M)'' IS NOT A BASE SYMBOL'               X0544000
.NXT     AIF   (&M EQ 2).END                                            X0546000
&M       SETA  2                                                        X0548000
&N       SETA  0                                                        X0550000
         AGO   .GO                                                      X0552000
.END     MEND                                                           X0554000
         MACRO                                                          X0556000
         $BASE &A                                                       X0558000
         GBLC  &BASE,&X(2),&Y(2)                                        X0560000
&BASE    SETC  '0'                                                      X0562000
         AIF   ('&Y(1)' EQ '&A').ONE                                    X0564000
         AIF   ('&Y(2)' EQ '&A').TWO                                    X0566000
         MEXIT                                                          X0568000
.ONE     ANOP                                                           X0570000
&BASE    SETC  '&X(1)'                                                  X0572000
         MEXIT                                                          X0574000
.TWO     ANOP                                                           X0576000
&BASE    SETC  '&X(2)'                                                  X0578000
         MEND                                                           X0580000
         MACRO                                                          X0582000
         $QBYTE &DA,&M,&N                                               X0584000
         GBLA  &S3BSCA                                                  X0586000
         GBLC  &QBYTE                                                   X0588000
         LCLA  &A                                                       X0590000
&QBYTE   SETC  '(&DA)*16+(&M)*8+(&N)'                                   X0592000
         AIF   (T'&DA NE 'N' OR T'&M NE 'N' OR T'&N NE 'N').END         X0594000
&A       SETA  &DA*16+&M*8+&N                                           X0596000
&QBYTE   SETC  '&A'                                                     X0598000
         AIF   (&DA NE 8).END                                           X0600000
&A       SETA  &DA*16+(&S3BSCA-1)*8+&N                                  X0602000
&QBYTE   SETC  '&A'                                                     X0604000
.END     MEND                                                           X0606000
         MACRO                                                          X0608000
&N       $ALC  &A,&B,&L                $ALC   - ADD LOGICAL CHARACTERS  X0610000
&N       $X1   &A,&B,&L,14                                              X0612000
         MEND                                                           X0614000
         MACRO                                                          X0616000
&N       $SLC  &A,&B,&L                $SLC   - SUBTRACT LOGICAL CHARAC X0618000
&N       $X1   &A,&B,&L,15                                              X0620000
         MEND                                                           X0622000
         MACRO                                                          X0624000
&N       $MVX  &A,&B,&Q                $MVX   - MOVE HEX CHARACTERS     X0626000
&N       $X1   &A,&B,&Q,8                                               X0628000
         MEND                                                           X0630000
         MACRO                                                          X0632000
&N       $MVC  &A,&B,&L                $MVC   - MOVE CHARACTERS         X0634000
&N       $X1   &A,&B,&L,12                                              X0636000
         MEND                                                           X0638000
         MACRO                                                          X0640000
&N       $ED   &A,&B,&L1               $ED    - EDIT                    X0642000
&N       $X1   &A,&B,&L1,10                                             X0644000
         MEND                                                           X0646000
         MACRO                                                          X0648000
&N       $ITC  &A,&B,&L1               $ITC   - INSERT & TEST CHARS     X0650000
&N       $X1   &A,&B,&L1,11                                             X0652000
         MEND                                                           X0654000
         MACRO                                                          X0656000
&N       $CLC  &A,&B,&L                $CLC   - COMPARE LOGICAL CHARS   X0658000
&N       $X1   &A,&B,&L,13                                              X0660000
         MEND                                                           X0662000
         MACRO                                                          X0664000
&N       $J    &A                      $J     - JUMP UNCONDITIONAL      X0666000
&N       $JC   &A,0                                                     X0668000
         MEND                                                           X0670000
         MACRO                                                          X0672000
&N       $JH   &A                      $JH    - JUMP IF HIGH            X0674000
&N       $JC   &A,132                                                   X0676000
         MEND                                                           X0678000
         MACRO                                                          X0680000
&N       $JL   &A                      $JL    - JUMP IF LOW             X0682000
&N       $JC   &A,130                                                   X0684000
         MEND                                                           X0686000
         MACRO                                                          X0688000
&N       $JE   &A                      $JE    - JUMP IF EQUAL           X0690000
&N       $JC   &A,129                                                   X0692000
         MEND                                                           X0694000
         MACRO                                                          X0696000
&N       $JNH  &A                      $JNH   - JUMP IF NOT HIGH        X0698000
&N       $JC   &A,4                                                     X0700000
         MEND                                                           X0702000
         MACRO                                                          X0704000
&N       $JNL  &A                      $JNL   - JUMP IF NOT LOW         X0706000
&N       $JC   &A,2                                                     X0708000
         MEND                                                           X0710000
         MACRO                                                          X0712000
&N       $JNE  &A                      $JNE   - JUMP IF NOT EQUAL       X0714000
&N       $JC   &A,1                                                     X0716000
         MEND                                                           X0718000
         MACRO                                                          X0720000
&N       $JOZ  &A                      $JOZ   - JUMP IF OVERFLOW ZONED  X0722000
&N       $JC   &A,136                                                   X0724000
         MEND                                                           X0726000
         MACRO                                                          X0728000
&N       $JOL  &A                      $JOL   - JUMP IF OVFLOW LOGICAL  X0730000
&N       $JC   &A,160                                                   X0732000
         MEND                                                           X0734000
         MACRO                                                          X0736000
&N       $JNOZ &A                      $JNOZ  - JUMP NOT OVERFLOW ZONED X0738000
&N       $JC   &A,8                                                     X0740000
         MEND                                                           X0742000
         MACRO                                                          X0744000
&N       $JNOL &A                      $JNOL  - JUMP NOT OVFLOW LOGICAL X0746000
&N       $JC   &A,32                                                    X0748000
         MEND                                                           X0750000
         MACRO                                                          X0752000
&N       $JT   &A                      $JT    - JUMP IF TRUE            X0754000
&N       $JC   &A,16                                                    X0756000
         MEND                                                           X0758000
         MACRO                                                          X0760000
&N       $JF   &A                      $JF    - JUMP IF FALSE           X0762000
&N       $JC   &A,144                                                   X0764000
         MEND                                                           X0766000
         MACRO                                                          X0768000
&N       $JP   &A                      $JP    - JUMP IF PLUS            X0770000
&N       $JC   &A,132                                                   X0772000
         MEND                                                           X0774000
         MACRO                                                          X0776000
&N       $JM   &A                      $JM    - JUMP IF MINUS           X0778000
&N       $JC   &A,130                                                   X0780000
         MEND                                                           X0782000
         MACRO                                                          X0784000
&N       $JZ   &A                      $JZ    - JUMP IF ZERO            X0786000
&N       $JC   &A,129                                                   X0788000
         MEND                                                           X0790000
         MACRO                                                          X0792000
&N       $JNP  &A                      $JNP   - JUMP IF NOT PLUS        X0794000
&N       $JC   &A,4                                                     X0796000
         MEND                                                           X0798000
         MACRO                                                          X0800000
&N       $JNM  &A                      $JNM   - JUMP IF NOT MINUS       X0802000
&N       $JC   &A,2                                                     X0804000
         MEND                                                           X0806000
         MACRO                                                          X0808000
&N       $JNZ  &A                      $JNZ   - JUMP IF NOT ZERO        X0810000
&N       $JC   &A,1                                                     X0812000
         MEND                                                           X0814000
         MACRO                                                          X0816000
&N       $NOPJ &A                      $NOPJ  - NEVER JUMP              X0818000
&N       $JC   &A,128                                                   X0820000
         MEND                                                           X0822000
         MACRO                                                          X0824000
&N       $A    &R,&A                   $A     - ADD TO REGISTER         X0826000
&N       $Y    &A,&R,6                                                  X0828000
         MEND                                                           X0830000
         MACRO                                                          X0832000
&N       $MVI  &A,&I                   $MVI   - MOVE LOGICAL IMMEDIATE  X0834000
&N       $Y    &A,&I,12                                                 X0836000
         MEND                                                           X0838000
         MACRO                                                          X0840000
&N       $SBN  &A,&M                   $SBN   - SET BITS ON             X0842000
&N       $Y    &A,&M,10                                                 X0844000
         MEND                                                           X0846000
         MACRO                                                          X0848000
&N       $SBF  &A,&M                   $SBF   - SET BITS OFF            X0850000
&N       $Y    &A,&M,11                                                 X0852000
         MEND                                                           X0854000
         MACRO                                                          X0856000
&N       $ST   &R,&A                   $ST    - STORE REGISTER          X0858000
&N       $Y    &A,&R,4                                                  X0860000
         MEND                                                           X0862000
         MACRO                                                          X0864000
&N       $L    &R,&A                   $L     - LOAD REGISTER           X0866000
&N       $Y    &A,&R,5                                                  X0868000
         MEND                                                           X0870000
         MACRO                                                          X0872000
&N       $LA   &R,&A                   $LA    - LOAD ADDRESS            X0874000
&N       $Z    &A,&R,2                                                  X0876000
         MEND                                                           X0878000
         MACRO                                                          X0880000
&N       $CLI  &A,&I                   $CLI   - COMPARE LOGICAL IMMED   X0882000
&N       $Y    &A,&I,13                                                 X0884000
         MEND                                                           X0886000
         MACRO                                                          X0888000
&N       $TBN  &A,&M                   $TBN   - TEST BITS ON            X0890000
&N       $Y    &A,&M,8                                                  X0892000
         MEND                                                           X0894000
         MACRO                                                          X0896000
&N       $TBF  &A,&M                   $TBF   - TEST BITS OFF           X0898000
&N       $Y    &A,&M,9                                                  X0900000
         MEND                                                           X0902000
         MACRO                                                          X0904000
&NA      $SNS  &DA,&M,&N,&A            $SNS   - SENSE INPUT/OUTPUT      X0906000
         GBLC  &QBYTE                                                   X0908000
         $QBYTE &DA,&M,&N                                               X0910000
&NA      $Y    &A,&QBYTE,0                                              X0912000
         MEND                                                           X0914000
         MACRO                                                          X0916000
&NA      $LIO  &DA,&M,&N,&A            $LIO   - LOAD INPUT/OUTPUT       X0918000
         GBLC  &QBYTE                                                   X0920000
         $QBYTE &DA,&M,&N                                               X0922000
&NA      $Y    &A,&QBYTE,1                                              X0924000
         MEND                                                           X0926000
         MACRO                                                          X0928000
&NA      $TIO  &DA,&M,&N,&A            $TIO   - TEST INPUT/OUTPUT       X0930000
         GBLC  &QBYTE                                                   X0932000
         $QBYTE &DA,&M,&N                                               X0934000
&NA      $Z    &A,&QBYTE,1                                              X0936000
         MEND                                                           X0938000
         MACRO                                                          X0940000
&N       $JC   &A,&Q                   $JC    - JUMP ON CONDITION       X0942000
&N       DC    AL1(242,&Q,&A-*-1)                                       X0944000
         MEND                                                           X0946000
         MACRO                                                          X0948000
&N       $BC   &A,&Q                   $BC    - BRANCH ON CONDITION     X0950000
&N       $Z    &A,&Q,0                                                  X0952000
         MEND                                                           X0954000
         MACRO                                                          X0956000
&NA      $SIO  &DA,&M,&N,&CC           $SIO   - START INPUT/OUTPUT      X0958000
         GBLC  &QBYTE                                                   X0960000
         $QBYTE &DA,&M,&N                                               X0962000
&NA      DC    AL1(243,&QBYTE,&CC)                                      X0964000
         MEND                                                           X0966000
         MACRO                                                          X0968000
&NA      $APL  &DA,&M,&N               $APL   - ADVANCE PROGRAM LEVEL   X0970000
&NA      DC    X'F1',AL.4(&DA),AL.1(&M),AL.3(&N),X'0'                   X0972000
         MEND                                                           X0974000
         MACRO                                                          X0976000
&N       $B    &A                      $B     - BRANCH UNCONDITIONAL    X0978000
&N       $BC   &A,0                                                     X0980000
         MEND                                                           X0982000
         MACRO                                                          X0984000
&N       $BH   &A                      $BH    - BRANCH IF HIGH          X0986000
&N       $BC   &A,132                                                   X0988000
         MEND                                                           X0990000
         MACRO                                                          X0992000
&N       $BL   &A                      $BL    - BRANCH IF LOW           X0994000
&N       $BC   &A,130                                                   X0996000
         MEND                                                           X0998000
         MACRO                                                          X1000000
&N       $BE   &A                      $BE    - BRANCH IF EQUAL         X1002000
&N       $BC   &A,129                                                   X1004000
         MEND                                                           X1006000
         MACRO                                                          X1008000
&N       $BNH  &A                      $BNH   - BRANCH IF NOT HIGH      X1010000
&N       $BC   &A,4                                                     X1012000
         MEND                                                           X1014000
         MACRO                                                          X1016000
&N       $BNL  &A                      $BNL   - BRANCH IF NOT LOW       X1018000
&N       $BC   &A,2                                                     X1020000
         MEND                                                           X1022000
         MACRO                                                          X1024000
&N       $BNE  &A                      $BNE   - BRANCH IF NOT EQUAL     X1026000
&N       $BC   &A,1                                                     X1028000
         MEND                                                           X1030000
         MACRO                                                          X1032000
&N       $BOZ  &A                      $BOZ   - BRANCH OVERFLOW ZONED   X1034000
&N       $BC   &A,136                                                   X1036000
         MEND                                                           X1038000
         MACRO                                                          X1040000
&N       $BOL  &A                      $BOL   - BRANCH OVERFLOW LOGICAL X1042000
&N       $BC   &A,160                                                   X1044000
         MEND                                                           X1046000
         MACRO                                                          X1048000
&N       $BNOZ &A                      $BNOZ  - BRANCH NOT OVFLOW ZONED X1050000
&N       $BC   &A,8                                                     X1052000
         MEND                                                           X1054000
         MACRO                                                          X1056000
&N       $BNOL &A                      $BNOL  - BRANCH NOT OFLO LOGICAL X1058000
&N       $BC   &A,32                                                    X1060000
         MEND                                                           X1062000
         MACRO                                                          X1064000
&N       $BT   &A                      $BT    - BRANCH IF TRUE          X1066000
&N       $BC   &A,16                                                    X1068000
         MEND                                                           X1070000
         MACRO                                                          X1072000
&N       $BF   &A                      $BF    - BRANCH IF FALSE         X1074000
&N       $BC   &A,144                                                   X1076000
         MEND                                                           X1078000
         MACRO                                                          X1080000
&N       $BP   &A                      $BP    - BRANCH IF PLUS          X1082000
&N       $BC   &A,132                                                   X1084000
         MEND                                                           X1086000
         MACRO                                                          X1088000
&N       $BM   &A                      $BM    - BRANCH IF MINUS         X1090000
&N       $BC   &A,130                                                   X1092000
         MEND                                                           X1094000
         MACRO                                                          X1096000
&N       $BZ   &A                      $BZ    - BRANCH IF ZERO          X1098000
&N       $BC   &A,129                                                   X1100000
         MEND                                                           X1102000
         MACRO                                                          X1104000
&N       $BNP  &A                      $BNP   - BRANCH IF NOT PLUS      X1106000
&N       $BC   &A,4                                                     X1108000
         MEND                                                           X1110000
         MACRO                                                          X1112000
&N       $BNM  &A                      $BNM   - BRANCH IF NOT MINUS     X1114000
&N       $BC   &A,2                                                     X1116000
         MEND                                                           X1118000
         MACRO                                                          X1120000
&N       $BNZ  &A                      $BNZ   - BRANCH IF NOT ZERO      X1122000
&N       $BC   &A,1                                                     X1124000
         MEND                                                           X1126000
         MACRO                                                          X1128000
&N       $NOPB &A                      $NOPB  - NEVER BRANCH            X1130000
&N       $BC   &A,128                                                   X1132000
         MEND                                                           X1134000
         MACRO                                                          X1136000
&N       $MZZ  &A,&B                   $MZZ   - MOVE TO ZONE FROM ZONE  X1138000
&N       $X1   &A,&B,0,8                                                X1140000
         MEND                                                           X1142000
         MACRO                                                          X1144000
&N       $MNZ  &A,&B                   $MNZ   - MOVE TO NUM FROM ZONE   X1146000
&N       $X1   &A,&B,2,8                                                X1148000
         MEND                                                           X1150000
         MACRO                                                          X1152000
&N       $MZN  &A,&B                   $MZN   - MOVE TO ZONE FROM NUM   X1154000
&N       $X1   &A,&B,1,8                                                X1156000
         MEND                                                           X1158000
         MACRO                                                          X1160000
&N       $MNN  &A,&B                   $MNN   - MOVE TO NUM FROM NUM    X1162000
&N       $X1   &A,&B,3,8                                                X1164000
         MEND                                                           X1166000
         MACRO                                                          X1168000
&L       $WAIT &EVENT                                                   X1170000
&L       $SBN  (FBEWF,FBR),EWF&EVENT                                    X1172000
         $B    $COMRET                                                  X1174000
         MEND                                                           X1176000
         MACRO                                                          X1178000
&L       $DC                                                            X1180000
         LCLA  &N                                                       X1182000
.GO      ANOP                                                           X1184000
&N       SETA  &N+1                                                     X1186000
         DC    &SYSLIST(&N)                                             X1188000
         AIF   (N'&SYSLIST GT &N).GO                                    X1190000
         AIF   ('&L' EQ '').END                                         X1192000
&L       EQU   *-1                                                      X1194000
.END     MEND                                                           X1196000
         MACRO                                                          X1198000
&L       $DS                                                            X1200000
         LCLA  &N                                                       X1202000
.GO      ANOP                                                           X1204000
&N       SETA  &N+1                                                     X1206000
         DS    &SYSLIST(&N)                                             X1208000
         AIF   (N'&SYSLIST GT &N).GO                                    X1210000
         AIF   ('&L' EQ '').END                                         X1212000
&L       EQU   *-1                                                      X1214000
.END     MEND                                                           X1216000
         MACRO                                                          X1218000
&L       $POST &FB,&EVENT                                               X1220000
         AIF   ('&FB' EQ '*').ASTER                                     X1222000
&L       $SBF  FBEWF+&FB-FBD,EWF&EVENT                                  X1224000
         MEXIT                                                          X1226000
.ASTER   ANOP                                                           X1228000
&L       $SBF  (FBEWF,FBR),EWF&EVENT                                    X1230000
         MEND                                                           X1232000
         MACRO                                                          X1234000
&L       $HPL  &A                                                       X1236000
         LCLC  &C(22),&D(22),&X                                         X1238000
         LCLA  &N                                                       X1240000
&C(01)   SETC  '1'                                                      X1242000
&C(02)   SETC  '2'                                                      X1244000
&C(03)   SETC  '3'                                                      X1246000
&C(04)   SETC  '4'                                                      X1248000
&C(05)   SETC  '5'                                                      X1250000
&C(06)   SETC  '6'                                                      X1252000
&C(07)   SETC  '7'                                                      X1254000
&C(08)   SETC  '8'                                                      X1256000
&C(09)   SETC  '9'                                                      X1258000
&C(10)   SETC  '0'                                                      X1260000
&C(11)   SETC  'A'                                                      X1262000
&C(12)   SETC  'B'                                                      X1264000
&C(13)   SETC  'C'                                                      X1266000
&C(14)   SETC  'D'                                                      X1268000
&C(15)   SETC  'E'                                                      X1270000
&C(16)   SETC  'F'                                                      X1272000
&C(17)   SETC  'H'                                                      X1274000
&C(18)   SETC  'J'                                                      X1276000
&C(19)   SETC  'L'                                                      X1278000
&C(20)   SETC  'P'                                                      X1280000
&C(21)   SETC  'U'                                                      X1282000
&C(22)   SETC  '*'                                                      X1284000
&D(01)   SETC  '28'                                                     X1286000
&D(02)   SETC  '76'                                                     X1288000
&D(03)   SETC  '57'                                                     X1290000
&D(04)   SETC  '1B'                                                     X1292000
&D(5)    SETC  '5D'                                                     X1294000
&D(06)   SETC  '7D'                                                     X1296000
&D(07)   SETC  '07'                                                     X1298000
&D(08)   SETC  '7F'                                                     X1300000
&D(09)   SETC  '5F'                                                     X1302000
&D(10)   SETC  '6F'                                                     X1304000
&D(11)   SETC  '3F'                                                     X1306000
&D(12)   SETC  '78'                                                     X1308000
&D(13)   SETC  '6C'                                                     X1310000
&D(14)   SETC  '73'                                                     X1312000
&D(15)   SETC  '7C'                                                     X1314000
&D(16)   SETC  '3C'                                                     X1316000
&D(17)   SETC  '3B'                                                     X1318000
&D(18)   SETC  '63'                                                     X1320000
&D(19)   SETC  '68'                                                     X1322000
&D(20)   SETC  '3E'                                                     X1324000
&D(21)   SETC  '6B'                                                     X1326000
&D(22)   SETC  '00'                                                     X1328000
.*                                                                      X1330000
.*                                                                      X1332000
.*                                                                      X1334000
         AIF   (K'&A EQ 2 AND N'&SYSLIST EQ 1).ONE                      X1336000
         MNOTE 8,'*** INVALID $HPL ARGUMENT ***'                        X1338000
         MEXIT                                                          X1340000
.ONE     ANOP                                                           X1342000
&N       SETA  &N+1                                                     X1344000
         AIF   ('&A'(1,1) EQ '&C(&N)').ONE1                             X1346000
         AIF   (&N LT 22).ONE                                           X1348000
.ERR     MNOTE 8,'*** INVALID $HPL CODE ***'                            X1350000
&L       DC    X'F07373'                                                X1352000
         MEXIT                                                          X1354000
.ONE1    ANOP                                                           X1356000
&X       SETC  '&D(&N)'                                                 X1358000
&N       SETA  0                                                        X1360000
.TWO     ANOP                                                           X1362000
&N       SETA  &N+1                                                     X1364000
         AIF   ('&A'(2,1) EQ '&C(&N)').TWO1                             X1366000
         AIF   (&N LT 22).TWO                                           X1368000
         AGO   .ERR                                                     X1370000
.TWO1    ANOP                                                           X1372000
&L       DC    X'F0&X&D(&N)'                                            X1374000
         MEND                                                           X1376000
         MACRO                                                          X1378000
&NAME    $FB   &ENT=,&R1=0,&EWF=0,&SHORT=NO,&FLG=0,&BUF=0,&BMX=1,      CX1380000
               &FCS=0,&RCB=0,&WORK=0                                    X1382000
         GBLA  &FBNR,&FBN                                               X1384000
&FBNR    SETA  &FBNR+1                                                  X1386000
&FBN     SETA  &FBNR+1                                                  X1388000
         SPACE 5                                                        X1390000
$FB&FBNR EQU   *                                                        X1392000
         AIF   ('&NAME' EQ '').FB                                       X1394000
$FB&NAME EQU   *                                                        X1396000
         MNOTE *,'* * *  FUNCTION BLOCK FOR &NAME  * * *'               X1398000
         SPACE 2                                                        X1400000
.FB      DC    YL2($FB&FBN)        POINTER TO NEXT FUNCTION BLOCK.      X1402000
         DC    YL2(&ENT)           ENTRY ADDRESS FOR THIS FUNCTION.     X1404000
         DC    YL2(&R1)            SAVE AREA FOR REGISTER 1.            X1406000
         DC    YL1(&EWF)           EVENT WAIT FIELD.                    X1408000
         AIF   ('&SHORT' NE 'NO').END                                   X1410000
         DC    YL1(&FLG)           FUNCTION FLAGS BYTE.                 X1412000
         DC    YL2(0)              SUBROUTINE RETURN ADDRESS SAVE.      X1414000
         DC    YL2(&BUF)           BUFFER QUEUEING POINTER.             X1416000
         DC    YL1(0)              CURRENT COUNT OF BUFFERS.            X1418000
         DC    YL1(&BMX)           MAXIMUM COUNT OF BUFFERS.            X1420000
         DC    YL2(&FCS)           FUNCTION CONTROL SEQUENCE BIT.       X1422000
         DC    YL1(&RCB)           RECORD CONTROL BYTE.                 X1424000
         DC    (&WORK)X'0'         OPTIONAL WORK AREA.                  X1426000
.END     MEND                                                           X1428000
         MACRO                                                          X1430000
&L       $HCA  &DEV=,&RDB=,&PUB=,&FLG=0,&LOG=,&RDS=,&PUS=,&TIO=,       CX1432000
               &LOG1=,&LOG2=                                            X1434000
&L       EQU   *                                                        X1436000
         DC    YL2(0)              HCFBP - POINTER TO LOGICAL DEVICE FB X1438000
         DC    YL2(&RDB)           HCRDB - POINTER TO READ BUFFER       X1440000
         DC    YL2(&PUB)           HCPUB - POINTER TO PUNCH BUFFER      X1442000
         DC    YL1(&FLG)           HCFLG - FLAG BYTE                    X1444000
         DC    &TIO                HCTIO - DA, M, N FOR TIO             X1446000
         DC    YL2(0,0,0,0)        HCRETX - FOUR RETURN ADDRESSES       X1448000
         DC    YL2(0)              HCSNS - AREA FOR STATUS BYTES        X1450000
         AIF   ('&DEV' EQ '1442').EIGHTY   BR IF 1442 READER/PUNCH.     X1452000
         DC    YL2(&LOG,0,0)       HCLOG - ARGUMENTS TO $LOG            X1454000
         DC    &RDS                HCRDS - Q, CC FOR READ SIO           X1456000
         DC    &PUS                HCPUS - Q, CC FOR PUNCH SIO          X1458000
         DC    YL2(0)              HCSIO - Q, CC FOR CURRENT SIO        X1460000
         MEXIT                                                          X1462000
.EIGHTY  DC    YL2(0)              HCPLN - NUMBER OF BYTES TO PUNCH     X1464000
         DC    AL3(&LOG1),AL4(0)   HCLOG1 - FIRST $LOG ARGUMENT LIST    X1466000
         DC    AL3(&LOG2),AL4(0)   HCLOG2 - SECOND $LOG ARGUMENT LIST   X1468000
         MEND                                                           X1470000
         MACRO                                                          X1472000
&L       $IHMSG &A,&B                                                   X1474000
         LCLA  &K,&X                                                    X1476000
&K       SETA  K'&B-3              LENGTH-1 OF CHARS WITHIN QUOTES      X1478000
         AIF   ('&A' EQ 'T').TITLE BRANCH IF THIS IS TITLE TEXT.        X1480000
&L       DC    YL1(&K),C'&A',C&B                                        X1482000
         MEXIT                                                          X1484000
.TITLE   ANOP                                                           X1486000
&K       SETA  &K+128                                                   X1488000
&X       SETA  48+K'&B/2                                                X1490000
&L       DC    YL1(&K),YL2(LPDA+&X)                                     X1492000
         DC    C&B                                                      X1494000
         MEND                                                           X1496000
         MACRO                                                          X1498000
         $END  &START=                                                  X1500000
ORG&SYSNDX EQU *                                                        X1502000
         ORG   &SYSECT                                                  X1504000
         AIF   ('&START' EQ '').NOOP                                    X1506000
         DC    A(&START),C'$$$$ PSEUDO-END CARD $$$$'                   X1508000
         ORG   ORG&SYSNDX                                               X1510000
         MEXIT                                                          X1512000
.NOOP    DC    C'    $$$$ PSEUDO-END CARD $$$$'                         X1514000
         ORG   ORG&SYSNDX                                               X1516000
         MEND                                                           X1518000
         MACRO                                                          X1520000
&L       $SIGNON &REMOTE=,&PASSWD=,&DIAL=                               X1522000
         LCLC  &R,&P                                                    X1524000
*                                                                     * X1526000
*********************************************************************** X1528000
*                                                                     * X1530000
*                      DEFAULT /*SIGNON CARD                          * X1532000
*                                                                     * X1534000
*********************************************************************** X1536000
*                                                                     * X1538000
&L       DC    X'0102A08F8F'       SOH, STX, BCB, FCS, FCS              X1540000
         DC    YL1(X'F0',C'A')     RCB, SRCB                            X1542000
         AIF   (&REMOTE GE 10).RMT10                                    X1544000
&R       SETC  ' '                                                      X1546000
.RMT10   ANOP                                                           X1548000
&P       SETC  '        '(1,8-K'&PASSWD)                                X1550000
$SIGNON  EQU   *                                                        X1552000
         AIF   ('&DIAL' EQ '').NODIAL                                   X1554000
         DC    CL80'/*SIGNON       REMOTE&REMOTE&R &PASSWD&P DIAL &DIALCX1556000
               ',YL1(ETB)                                               X1558000
         MEXIT                                                          X1560000
.NODIAL  DC    CL80'/*SIGNON       REMOTE&REMOTE&R &PASSWD&P',YL1(ETB)  X1562000
.*                                                                      X1564000
         MEND                                                           X1566000
         PRINT ON                                                       X1568000
         TITLE 'HRTPSYS3 - GLOBAL SYMBOL DEFINITIONS'                   X1570000
*                                                                     * X1572000
*********************************************************************** X1574000
*                                                                     * X1576000
*              HARDWARE DEFINITIONS                                   * X1578000
*                                                                     * X1580000
*********************************************************************** X1582000
*                                                                     * X1584000
         GBLA  &MACHSIZ            SIZE OF CORE STORAGE                 X1586000
         GBLA  &S3BSCA             BSC ADAPTER NUMBER                   X1588000
         GBLB  &S3XPAR             HARDWARE TRANSPARENCY                X1590000
         GBLB  &S35424             5424 MFCU                            X1592000
         GBLB  &S31442             1442 CARD READ-PUNCH                 X1594000
         GBLB  &S35471             5471 PRINTER-KEYBOARD                X1596000
         GBLB  &S35475             5475 DATA ENTRY KEYBOARD             X1598000
*                                                                     * X1600000
*********************************************************************** X1602000
*                                                                     * X1604000
*              PRINTER SPECIFICATION                                  * X1606000
*                                                                     * X1608000
*********************************************************************** X1610000
*                                                                     * X1612000
         GBLA  &S3FORML            LENGTH OF FORMS                      X1614000
         GBLA  &PC(12)             CARRIAGE CONTROL                     X1616000
         GBLA  &PRTCONS            5203 PRINTER AS OUTPUT CONSOLE       X1618000
*                                                                     * X1620000
*********************************************************************** X1622000
*                                                                     * X1624000
*              TELECOMMUNICATION SPECIFICATIONS                       * X1626000
*                                                                     * X1628000
*********************************************************************** X1630000
*                                                                     * X1632000
         GBLA  &RMTID              HASP REMOTE NUMBER                   X1634000
         GBLA  &TPBFSIZ            HASP RJE BUFFER SIZE                 X1636000
         GBLA  &MLBFSIZ            HASP MULTILEAVING BUFFER SIZE        X1638000
         GBLC  &PASSWD             SECURITY PASSWORD                    X1640000
         GBLC  &DIAL,&DIAL1        AUTO CALL FEATURE - TELEPHONE NUMBER X1642000
*                                                                     * X1644000
*********************************************************************** X1646000
*                                                                     * X1648000
*              SOFTWARE OPTIONS                                       * X1650000
*                                                                     * X1652000
*********************************************************************** X1654000
*                                                                     * X1656000
         GBLA  &COMP               COMPRESSION OPTION                   X1658000
         GBLA  &S3NRDRS            NR OF SIMULTANEOUS READERS           X1660000
         GBLA  &S3NPUNS            NR OF SIMULTANEOUS PUNCHES           X1662000
         GBLB  &S3OBJDK            OS OBJECT DECK SUPPORT               X1664000
         GBLB  &S396COL            S/3 LOAD MODE SUPPORT                X1666000
         GBLB  &DEBUG              MAINTENANCE FEATURES                 X1668000
         GBLB  &S3SIP              S/3 CARD SYSTEM                      X1670000
         GBLA  &S3TRACE            INTERNAL MESSAGE TABLE SIZE          X1672000
         GBLB  &S3CMDS             LOCAL COMMANDS OPTION                X1674000
*                                                                     * X1676000
*********************************************************************** X1678000
*                                                                     * X1680000
*              INTERNAL VARIABLE SYMBOLS                              * X1682000
*                                                                     * X1684000
*********************************************************************** X1686000
*                                                                     * X1688000
         GBLA  &FBN,&TEMP,&TMP,&TM,&CCT,&CCB                            X1690000
         TITLE 'HRTPSYS3 - GLOBAL SYMBOL VALUES'                        X1692000
&MACHSIZ SETA  8192                SIZE OF CORE STORAGE                 X1694000
&S3BSCA  SETA  1                   BSC ADAPTER NUMBER                   X1696000
&S3XPAR  SETB  0                   TRANSPARENCY FEATURE                 X1698000
&S35424  SETB  1                   5424 MFCU                            X1700000
&S31442  SETB  0                   1442 CARD READ-PUNCH                 X1702000
&S35471  SETB  0                   5471 PRINTER-KEYBOARD                X1704000
&S35475  SETB  0                   5475 DATA ENTRY KEYBOARD             X1706000
&S3FORML SETA  66                  PRINTER FORMS LENGTH                 X1708000
&PC(1)   SETA  1                   CARRIAGE CHANNEL 1                   X1710000
&PC(2)   SETA  0                   CARRIAGE CHANNEL 2                   X1712000
&PC(3)   SETA  0                   CARRIAGE CHANNEL 3                   X1714000
&PC(4)   SETA  0                   CARRIAGE CHANNEL 4                   X1716000
&PC(5)   SETA  0                   CARRIAGE CHANNEL 5                   X1718000
&PC(6)   SETA  0                   CARRIAGE CHANNEL 6                   X1720000
&PC(7)   SETA  0                   CARRIAGE CHANNEL 7                   X1722000
&PC(8)   SETA  0                   CARRIAGE CHANNEL 8                   X1724000
&PC(9)   SETA  0                   CARRIAGE CHANNEL 9                   X1726000
&PC(10)  SETA  0                   CARRIAGE CHANNEL 10                  X1728000
&PC(11)  SETA  0                   CARRIAGE CHANNEL 11                  X1730000
&PC(12)  SETA  &S3FORML-5          CARRIAGE CHANNEL 12                  X1732000
&PRTCONS SETA  2                   5203 AS OUTPUT CONSOLE               X1734000
&RMTID   SETA  1                   HASP REMOTE TERMINAL NUMBER          X1736000
&TPBFSIZ SETA  400                 HASP RJE BUFFER SIZE                 X1738000
&MLBFSIZ SETA  400                 MULTI-LEAVING BUFFER SIZE            X1740000
&PASSWD  SETC  ''                  PASSWORD                             X1742000
&DIAL    SETC  ''                  TELEPHONE NUMBER                     X1744000
&DIAL1   SETC  ''                  TELEPHONE NUMBER CONTINUED           X1746000
&COMP    SETA  2                   COMPRESSION OPTION                   X1748000
&CCB     SETA  2                   INTERNAL                             X1750000
&CCT     SETA  3                   INTERNAL                             X1752000
&S3NRDRS SETA  1                   NUMBER OF LOGICAL READERS            X1754000
&S3NPUNS SETA  1                   NUMBER OF LOGICAL PUNCHES            X1756000
&S3OBJDK SETB  0                   2-FOR-1 OPTION                       X1758000
&S396COL SETB  0                   1-FOR-2 OPTION                       X1760000
&DEBUG   SETB  0                   DEBUG OPTION                         X1762000
&S3SIP   SETB  0                   S/3 CARD SYSTEM                      X1764000
&S3TRACE SETA  10                  INTERNAL MESSAGE TABLE SIZE          X1766000
&S3CMDS  SETB  0                   LOCAL COMMANDS OPTION                X1768000
         TITLE 'GENERAL EQUATES'                                        X1770000
         AIF   (&S35424).NOBOOT                                         X1772000
         PUNCH 'B && 31 ''X2( 2a  $ {b    SK{ CX1774000
                ''N{  @{} $$$$@{} '   1442 BOOTSTRAP             X1776000
.NOBOOT  ANOP                                                           X1778000
*                                                                       X1780000
*                                                                       X1782000
*              GENERAL EQUATES ---                                      X1784000
*                                                                       X1786000
*                                                                       X1788000
         SPACE 3                                                        X1790000
*                                                                       X1792000
*              SYMBOLIC REGISTERS                                       X1794000
*                                                                       X1796000
R1       EQU   1                                                        X1798000
R2       EQU   2                                                        X1800000
PSR      EQU   4                                                        X1802000
ARR      EQU   8                                                        X1804000
IAR      EQU   16                                                       X1806000
IAR1     EQU   32                                                       X1808000
IAR2     EQU   64                                                       X1810000
*                                                                       X1812000
HCR      EQU   R1                                                       X1814000
FBR      EQU   R2                                                       X1816000
         SPACE 3                                                        X1818000
*                                                                       X1820000
*              INTERRUPT LEVEL REGISTERS                                X1822000
*                                                                       X1824000
IL0      EQU   128+0                                                    X1826000
IL1      EQU   128+64                                                   X1828000
IL2      EQU   128+32                                                   X1830000
IL3      EQU   128+16                                                   X1832000
IL4      EQU   128+8                                                    X1834000
         SPACE 3                                                        X1836000
*                                                                       X1838000
*              EVENT WAIT FIELD BITS                                    X1840000
*                                                                       X1842000
EWFUNIT  EQU   1                                                        X1844000
EWFWORK  EQU   2                                                        X1846000
EWFPERM  EQU   4                                                        X1848000
EWFPOST  EQU   128                 EARLY POST FLAG.  NOT IN EWFALL.     X1850000
EWFALL   EQU   EWFUNIT+EWFWORK+EWFPERM                                  X1852000
         SPACE 3                                                        X1854000
*                                                                       X1856000
*              ADDRESSABILITY                                           X1858000
*                                                                       X1860000
         $USING HCD,HCR                                                 X1862000
         $USING FBD,FBR                                                 X1864000
         TITLE 'FUNCTION BLOCK DSECT'                                   X1866000
*                                                                       X1868000
*                                                                       X1870000
*              FUNCTION BLOCK DSECT.                                    X1872000
*                                                                       X1874000
*                                                                       X1876000
FBD      DSECT                                                          X1878000
FBNEXT   $DS   YL2                 POINTER TO NEXT FUNCTION BLOCK.      X1880000
FBENT    $DS   YL2                 NEXT ENTRY POINT FOR FUNCTION.       X1882000
FBREG1   $DS   YL2                 SAVE-AREA FOR REGISTER 1.            X1884000
FBEWF    $DS   X                   FUNCTION BLOCK EVENT WAIT FIELD.     X1886000
*                                                                       X1888000
*              SHORT FUNCTION BLOCK ENDS HERE.                          X1890000
*                                                                       X1892000
FBFLG    $DS   X                   FLAG BYTE.                           X1894000
FFLAST   EQU   128                   LAST-FB-OF-THIS-TYPE FLAG.         X1896000
FBRET1   $DS   YL2                 SUBROUTINE RETURN ADDRESS SAVE.      X1898000
FBBUF    $DS   YL2                 BUFFER POINTER.                      X1900000
FBBCT    $DS   X                   CURRENT NR OF BUFFERS CHAINED.       X1902000
FBBMX    $DS   X                   MAX BUFFER CT, FOR LITTLE WAITABIT.  X1904000
FBFCS    $DS   XL2                 FUNCTION CONTROL SEQUENCE.           X1906000
FBFCS1   EQU   FBFCS-1                                                  X1908000
FBFCS2   EQU   FBFCS                                                    X1910000
FCSPR1   EQU   X'0800'             FCS FOR PRINTER 1                    X1912000
FCSPR2   EQU   X'0400'             FCS FOR PRINTER 2                    X1914000
FCSPR3   EQU   X'0200'             FCS FOR PRINTER 3                    X1916000
FCSPR4   EQU   X'0100'             FCS FOR PRINTER 4                    X1918000
FCSPR5   EQU   X'0008'             FCS FOR PRINTER 5                    X1920000
FCSPR6   EQU   X'0004'             FCS FOR PRINTER 6                    X1922000
FCSPR7   EQU   X'0002'             FCS FOR PRINTER 7                    X1924000
FCSPU7   EQU   X'0400'             FCS FOR PUNCH 7                      X1926000
FCSPU6   EQU   X'0200'             FCS FOR PUNCH 6                      X1928000
FCSPU5   EQU   X'0100'             FCS FOR PUNCH 5                      X1930000
FCSPU4   EQU   X'0008'             FCS FOR PUNCH 4                      X1932000
FCSPU3   EQU   X'0004'             FCS FOR PUNCH 3                      X1934000
FCSPU2   EQU   X'0002'             FCS FOR PUNCH 2                      X1936000
FCSPU1   EQU   X'0001'             FCS FOR PUNCH 1                      X1938000
FBRCB    $DS   X                   RECORD CONTROL BYTE.                 X1940000
RCBPR1   EQU   X'94'               RCB FOR PRINTER 1                    X1942000
RCBPR2   EQU   X'A4'               RCB FOR PRINTER 2                    X1944000
RCBPR3   EQU   X'B4'               RCB FOR PRINTER 3                    X1946000
RCBPR4   EQU   X'C4'               RCB FOR PRINTER 4                    X1948000
RCBPR5   EQU   X'D4'               RCB FOR PRINTER 5                    X1950000
RCBPR6   EQU   X'E4'               RCB FOR PRINTER 6                    X1952000
RCBPR7   EQU   X'F4'               RCB FOR PRINTER 7                    X1954000
RCBPU1   EQU   X'95'               RCB FOR PUNCH 1                      X1956000
RCBPU2   EQU   X'A5'               RCB FOR PUNCH 2                      X1958000
RCBPU3   EQU   X'B5'               RCB FOR PUNCH 3                      X1960000
RCBPU4   EQU   X'C5'               RCB FOR PUNCH 4                      X1962000
RCBPU5   EQU   X'D5'               RCB FOR PUNCH 5                      X1964000
RCBPU6   EQU   X'E5'               RCB FOR PUNCH 6                      X1966000
RCBPU7   EQU   X'F5'               RCB FOR PUNCH 7                      X1968000
*                                                                       X1970000
*              NORMAL FUNCTION BLOCK ENDS HERE.                         X1972000
*                                                                       X1974000
FBWORK   EQU   *                   START OF OPTIONAL WORKAREA.          X1976000
FBRET2   $DS   XL2                 ALTERNATE RETURN ADDR SAVEAREA.      X1978000
FBXR1    $DS   XL2                 ALTERNATE R1 SAVE AREA.              X1980000
FBAREA   $DS   XL2                 POINTER TO SOURCE OR SINK AREA.      X1982000
FBSRCB   $DS   XL1                 SRCB RETURNED TO CALLER.             X1984000
FBCSEQ   EQU   FBSRCB              3-BYTE CMD SEQ WORKAREA.             X1986000
FBCLNG   EQU   FBREG1              LENGTH TO COMPRESS.                  X1988000
FBHCP    $DS   XL2                 POINTER TO HOPPER CONTROL AREA.      X1990000
FBCURL   $DS   XL2                 CURRENT POSITION IN CURRENT BUFFER.  X1992000
FB40SV   $DS   XL40                40-BYTE AREA FOR 2-FOR-1 CARDS.      X1994000
FB48SV   $DS   XL8                 8 MORE BYTES FOR 1-FOR-2 CARDS.      X1996000
         TITLE 'DSECT FOR HOPPER CONTROL AREA'                          X1998000
*                                                                       X2000000
*              HOPPER CONTROL AREA (HCA) DSECT                          X2002000
*                                                                       X2004000
*                                                                       X2006000
HCD      DSECT                                                          X2008000
HCFBP    $DS   YL2                 POINTER TO LOGICAL DEVICE FB.        X2010000
HCRDB    $DS   YL2                 POINTER TO READ BUFFER.              X2012000
HCPUB    $DS   YL2                 POINTER TO PUNCH BUFFER.             X2014000
HCFLG    $DS   YL1                 FLAG BYTE ---                        X2016000
HFRBB    EQU   1                     READ BUFFER IS BUSY.               X2018000
HFPBB    EQU   2                     PUNCH BUFFER IS BUSY.              X2020000
HFEOF    EQU   4                     END-OF-FILE.                       X2022000
HFLCD    EQU   8                     LAST-CARD SWITCH ON 1442.          X2024000
HF5424   EQU   16                    DEVICE-IS-5424 FLAG.               X2026000
HCTIO    $DS   YL1                 5424&1442 - DA, M, N BYTE OF TIO.    X2028000
HCRET1   $DS   YL2                 1ST-LEVEL-SUBROUTINE RETURN.         X2030000
HCRET2   $DS   YL2                 2ND-LEVEL-SUBROUTINE RETURN.         X2032000
HCRET3   $DS   YL2                 3RD-LEVEL-SUBROUTINE RETURN.         X2034000
HCRET4   $DS   YL2                 4TH-LEVEL-SUBROUTINE RETURN.         X2036000
HCSNS    $DS   YL2                 AREA FOR STATUS BYTES.               X2038000
HCLOG    $DS   3YL2                CONTIGUOUS AREA FOR $LOG.            X2040000
HCRDS    $DS   YL2                 5424 - LAST 2 BYTES OF READ SIO.     X2042000
HCPUS    $DS   YL2                 5424 - LAST 2 BYTES OF PUNCH SIO.    X2044000
HCSIO    $DS   YL2                 5424 - CURRENT SIO.                  X2046000
         ORG   HCSNS+1             ORG BACK FOR 1442-UNIQUE FIELDS.     X2048000
HCPLN    $DS   YL2                 1442 - NR OF BYTES TO PUNCH.         X2050000
HCLOG1   DS    XL7                 1442 - FIRST $LOG ARGUMENT.          X2052000
HCLOG2   DS    XL7                 1442 - SECOND $LOG ARGUMENT.         X2054000
HRTPSYS3 CSECT                                                          X2056000
         ENTRY FEIBM                                                    X2058000
FEIBM    EQU   HRTPSYS3+X'60'      'PGM 360D51014, FE SVC NO 000103.'   X2060000
         SPACE 5                                                        X2062000
         ORG   HRTPSYS3+256*(1+&S3SIP)                                  X2064000
*                                  IF &S3SIP, DO NOT OVERLAY THE 256    X2066000
*                                  BYTES BETWEEN X'100' AND X'1FF',     X2068000
*                                  FOR PURPOSES OF THE SYSTEM/3 CARD    X2070000
*                                  SYSTEM INITIALIZATION PROGRAM.       X2072000
         AIF   (NOT &S35424).NOMFCUA                                    X2074000
         TITLE 'MFCU - HOPPER CONTROL AREAS'                            X2076000
*                                                                       X2078000
*              HCA FOR HOPPER 1 (PRIMARY HOPPER)                        X2080000
*                                                                       X2082000
H1PUB    DC    CL98' '             PUNCH BUFFER NUMBER 1.               X2084000
HCA1     $HCA  DEV=5424,FLG=HF5424,RDB=H1RDB,PUB=H1PUB,LOG=LOG5424,    CX2086000
               RDS=X'F105',PUS=X'F706',TIO=X'F0'                        X2088000
H1RDB    DS    CL96' '             READ BUFFER NUMBER 1.                X2090000
*                                                                       X2092000
*                                                                       X2094000
*              HCA FOR HOPPER 2 (SECONDARY HOPPER)                      X2096000
*                                                                       X2098000
         ORG   H1RDB+128                                                X2100000
H2PUB    DC    CL98' '             PUNCH BUFFER NUMBER 2.               X2102000
HCA2     $HCA  DEV=5424,FLG=HF5424,RDB=H2RDB,PUB=H2PUB,LOG=LOG5424,    CX2104000
               RDS=X'F904',PUS=X'FF07',TIO=X'F8'                        X2106000
H2RDB    DS    CL96' '             READ BUFFER NUMBER 2.                X2108000
         SPACE 5                                                        X2110000
*                                                                       X2112000
*                                                                       X2114000
*              PRINT BUFFER FOR MFCU.                                   X2116000
*                                                                       X2118000
*                                                                       X2120000
HPRB     EQU   HRTPSYS3            256-BYTE AREA FOR LEFT AND           X2122000
*                                  RIGHT MFCU PRINT BUFFERS.            X2124000
.NOMFCUA ANOP                                                           X2126000
         TITLE '5203 PRINTING AREA AND CHAIN IMAGE'                     X2128000
         SPACE 5                                                        X2130000
*                                                                     * X2132000
*********************************************************************** X2134000
*                                                                     * X2136000
*        LINE PRINTER DATA AND CHAIN IMAGE AREA                       * X2138000
*                                                                     * X2140000
*********************************************************************** X2142000
*                                                                     * X2144000
         SPACE 5                                                        X2146000
         AIF   (NOT &S35424).NOMFCUB                                    X2148000
         ORG   H2PUB+256                                                X2150000
.NOMFCUB ANOP                                                           X2152000
LPIA     DC    CL124' '            AREA FOR PRINT CHAIN IMAGE.          X2154000
LPDA     DC    CL134'COMMUNICATION ESTABLISHED'  AREA FOR PRINT LINE.   X2156000
         TITLE 'INITIALIZATION - HEREP SECTION'                         X2158000
IHEREP   EQU   *                                                        X2160000
         $LIO  14,0,0,IHFORMS      SPECIFY FORMS LENGTH.                X2162000
         $MVC  LPIA+47,IHLC,48     SET 48-CHAR PRINT CHAIN.             X2164000
         $SNS  14,0,3,IHSNS        GET STATUS TO CHECK PRINT CHAIN.     X2166000
         $TBN  IHSNS,4             IS 48-CHAR CHAIN MOUNTED...          X2168000
         $JT   IHSTART             JUMP IF SO.                          X2170000
         $MVC  LPIA+119,IHPN,120   NO.  SET 120-CHAR PRINT CHAIN.       X2172000
IHSTART  EQU   *                                                        X2174000
         $CLC  LOGID,IHID,4        IS LOG AREA INTACT...                X2176000
         $JE   IHGO                PROBABLY.  CONTINUE.                 X2178000
         $B    IHCLEAR             NO.  CLEAR THE PRINT LINE,           X2180000
         $MVC   LPDA+60,IHERROR,33  SET UP ERROR MESSAGE,               X2182000
         $B    IHTITLE             GO PRINT IT, AND                     X2184000
         $J    IHEND               CLEAR THE LOG AREA.                  X2186000
IHGO     $LA   R2,ICAPTION         POINT TO FIRST CAPTION.              X2188000
IH01     $B    IHCLEAR             CLEAR THE PRINT LINE.                X2190000
         $CLI  (0,R2),0            IS THIS NED OF CAPTIONS...           X2192000
         $JE   IHEND               IF SO, EXIT FROM THIS SECTION.       X2194000
         $TBN  (0,R2),X'80'        IS THIS A TITLE LINE...              X2196000
         $JF   IHCT                JUMP IF NOT-  COUNT LINE.            X2198000
IHTTL    $SBF  (0,R2),X'80'        TITLE PRINTING - RESET TITLE BIT,    X2200000
         $L    R1,(2,R2)           AND SET TO-LOCATION FOR TITLE.       X2202000
         $MVC  IHWK,(0,R2)         PUT LENGTH-1 OF TITLE IN WORKAREA    X2204000
         $MVC  IHTMV+1,(0,R2)      AND IN MVC LENGTH FIELD.             X2206000
         $A    R2,IHWK             POINT R2 TO LAST                     X2208000
         $LA   R2,(3,R2)           CHARACTER OF TITLE.                  X2210000
IHTMV    $MVC  (0,R1),(0,R2),*-*   MOVE TITLE TO PRINT LINE.            X2212000
         $LA   R2,(1,R2)           POINT R2 TO THE NEXT CAPTION.        X2214000
         $B    IHTITLE             GO PRINT THE TITLE.                  X2216000
         $B    IH01                THEN CHECK NEXT CAPTION.             X2218000
IHCT     $MVC  LPDA+73,IHCCAP,14   SET UP BIT-NUMBER CAPTION.           X2220000
         $MVC  LPDA+68,(1,R2)      SET BIT NUMBER INTO CAPTION.         X2222000
         $LA   R1,LPDA+58          SET RIGHTMOST BYTE FOR MVC.          X2224000
         $MVC  IHWK,(0,R2)         7OVE LENGTH-1 TO WORKAREA            X2226000
         $MVC  IHCMV+1,(0,R2)      AND TO LENGTH FIELD OF MVC.          X2228000
         $A    R2,IHWK             POINT R2 TO LAST                     X2230000
         $LA   R2,(2,R2)           CHARACTER OF CAPTION.                X2232000
IHCMV    $MVC  (0,R1),(0,R2),*-*   MOVE REMAINDER OF CAPTION.           X2234000
         $LA   R2,(1,R2)           THEN POINT R2 TO NEXT CAPTION.       X2236000
IHC01    $ALC  IHBITS,IHBITS,IHBITL  IS THIS COUNTER SIGNIFICANT...     X2238000
         $JC   IHC02,32+128        JUMP IF SO (CARRY OCCURRED).         X2240000
         $ALC  IHC02+3,IHTWO,2     POINT TO NEXT COUNTER                X2242000
         $B    IHC01               AND LOOP.                            X2244000
IHC02    $L    R1,LOGID+2          GET COUNTER INTO R1,                 X2246000
         $B    IDIVIDE             CONVERT TO DECIMAL,                  X2248000
         $B    IHPRINT             GO PRINT.                            X2250000
         $ALC  IHC02+3,IHTWO,2     POINT TO THE NEXT COUNTER.           X2252000
         $B    IH01                THEN GO CHECK NEXT CAPTION.          X2254000
IHEND    $MVC  LOGID,IHID,4        SET LOG ID TO C'HASP'.               X2256000
         $MVI  LOGEND,0            SET LOW-ORDER BYTE TO ZERO.          X2258000
         $MVC  LOGEND-1,LOGEND,LOGLEN-1  SET REMAINING BYTES TO ZERO.   X2260000
         $MVC  LPDA+24,IHCOM,25    SET UP 'COMM ESTAB' MESSAGE.         X2262000
         $B    0                   THEN GO LOAD MORE CARDS.             X2264000
IHCCAP   $DC   C'--- BIT N --- '   PART OF DETAIL LINE CAPTION.         X2266000
IHID     $DC   C'HASP'             LOG AREA IDENTIFIER.                 X2268000
IHTWO    $DC   YL2(2)              CONSTANT OF TWO.                     X2270000
IHWK     $DC   YL2(0)              WORKAREA, INITIALIZED TO ZERO.       X2272000
*                                                                     * X2274000
*********************************************************************** X2276000
*                                                                     * X2278000
*        SUBROUTINE TO CONVERT TO DECIMAL AND SET PRINT LINE          * X2280000
*                                                                     * X2282000
*********************************************************************** X2284000
*                                                                     * X2286000
IDIVIDE  $ST   ARR,IDRET+3         SAVE RETURN ADDRESS.                 X2288000
         $ST   R2,IDR2+3           SAVE REGISTER 2.                     X2290000
         $LA   R2,IDTAB            POINT R2 TO THE DIVISION TABLE.      X2292000
         $MVC  HERDEC+4,IDZERO,5   SET RESULT TO C'00000'.              X2294000
         $MVC  IDIV1A+3,IDIV3+3,2  SET HI-ORD RESULT ADDRESS.           X2296000
IDIV1    $A    R1,(1,R2)           SUBTRACT 10000 (,1000,...,1).        X2298000
         $JC   IDIV2,32            JUMP IF NO CARRY.                    X2300000
IDIV1A   $ALC  *-*,IDTAB+19        ELSE ADD ONE TO A DECIMAL DIGIT,     X2302000
         $B    IDIV1               AND GO SUBTRACT AGAIN.               X2304000
IDIV2    $A    R1,(11,R2)          ADD BACK IN 10000 (,1000,...,1).     X2306000
         $LA   R2,(2,R2)           POINT TO THE NEXT ADDEND.            X2308000
         $ALC  IDIV1A+3,IDTAB+19,2 UP THE DEC DIGIT PTR BY ONE.         X2310000
         $CLC  IDIV1A+3,IDIVLIM,2  IS IT AT ITS LIMIT...                X2312000
         $BNE  IDIV1               IF NOT, WORK ON THE NEXT DIGIT.      X2314000
IDIV3    $ITC  HERDEC,HERDEC-1,4   BLANK NONSIGNIFICANT DIGITS,         X2316000
IDR2     $LA   R2,*-*              RESTORE REGISTER 2,                  X2318000
IDRET    $B    *-*                 AND RETURN TO CALLER.                X2320000
IDZERO   $DC   C'00000'            CONSTANT OF DECIMAL ZEROES.          X2322000
IDTAB    DC    HL2'-10000,-1000,-100,-10,-1'  TABLE FOR DIVISION        X2324000
         DC    HL2'10000,1000,100,10,1'   OF A 16-BIT VALUE.            X2326000
HERDEC   EQU   LPDA+74                                                  X2328000
IDIVLIM  $DC   YL2(HERDEC+5)                                            X2330000
*                                                                     * X2332000
*********************************************************************** X2334000
*                                                                     * X2336000
*        SUBROUTINE TO PRINT TITLE LINE                               * X2338000
*                                                                     * X2340000
*********************************************************************** X2342000
*                                                                     * X2344000
IHTITLE  $ST   ARR,IHRET+3         SAVE RETURN ADDRESS.                 X2346000
IHTI00   $NOPJ IHTI1               FIRST-TIME SWITCH                    X2348000
         $MVI  IHTI00+1,0          FOR CARRIABE EJECT.                  X2350000
         $SIO  14,0,4,1            SKIP TO CHANNEL 1.                   X2352000
         $TIO  14,0,6,*-2          WAIT TILL NOT BUSY.                  X2354000
IHTI1    $SIO  14,0,0,2            SPACE 2 BEFORE TITLE.                X2356000
         $TIO  14,0,6,*-2          WAIT TILL NOT BUSY.                  X2358000
IHTI2    $LIO  14,0,6,IHPCDA       THEN SET DATA ADDRESS REGISTER.      X2360000
         $LIO  14,0,4,IHPCIA       SPECIFY CHAIN IMAGE ADDRESS.         X2362000
         $SIO  14,0,2,2            AND PRINT AND SPACE 2.               X2364000
         $TIO  14,0,6,*-2          WAIT TILL NOT BUSY.                  X2366000
         $J    IHRET               RETURN TO CALLER.                    X2368000
*                                                                     * X2370000
*********************************************************************** X2372000
*                                                                     * X2374000
*        SUBROUTINE TO PRINT DETAIL LINE                              * X2376000
*                                                                     * X2378000
*********************************************************************** X2380000
*                                                                     * X2382000
IHPRINT  $ST   ARR,IHRET+3         SAVE RETURN ADDRESS.                 X2384000
         $LIO  14,0,6,IHPCDA       SET DATA ADDRESS REGISTER.           X2386000
         $LIO  14,0,4,IHPCIA       SPECIFY CHAIN IMAGE ADDRESS.         X2388000
         $SIO  14,0,2,1            PRINT AND SPACE 1.                   X2390000
         $TIO  14,0,6,*-2          WAIT TILL NOT BUSY.                  X2392000
         $J    IHRET               THEN RETURN TO CALLER.               X2394000
IHFORMS  $DC   YL1(&S3FORML,0)     FORMS LENGTH REGISTERS.              X2396000
IHPCDA   $DC   YL2(LPDA)           ADCON FOR PRINTER DATA AREA.         X2398000
IHPCIA   $DC   YL2(LPIA)           ADCON FOR PRINTER IMAGE AREA.        X2400000
IHCOM    $DC   C'COMMUNICATION ESTABLISHED'                             X2402000
*                                                                     * X2404000
*********************************************************************** X2406000
*                                                                     * X2408000
*        SUBROUTINE TO CLEAR THE PRINT LINE                           * X2410000
*                                                                     * X2412000
*********************************************************************** X2414000
*                                                                     * X2416000
IHCLEAR  $ST   ARR,IHRET+3         SAVE RETURN ADDRESS.                 X2418000
         $MVI  LPDA+131,C' '       BLANK THE LOW-ORDER BYTE.            X2420000
         $MVC  LPDA+130,LPDA+131,131  BLANK THE REMAINING BUTES.        X2422000
IHRET    $B    *-*                 THEN RETURN TO CALLER.               X2424000
         TITLE 'INITIALIZATION - HEREP CAPTIONS'                        X2426000
ICAPTION EQU   *                                                        X2428000
         $IHMSG T,'H E R E P  ---  HASP ENVIRONMENTAL RECORDING AND EDICX2430000
               TING PROGRAM  ---  H E R E P'                            X2432000
         AIF   (NOT &S35424).NOMFCUC                                    X2434000
         $IHMSG T,'5424 MULTI-FUNCTION CARD UNIT --- STATUS BYTE 1'     X2436000
         $IHMSG 0,'READ CHECK'                                          X2438000
         $IHMSG 1,'PUNCH CHECK'                                         X2440000
         $IHMSG 2,'PUNCH INVALID'                                       X2442000
         $IHMSG 3,'PRINT DATA CHECK'                                    X2444000
         $IHMSG 4,'PRINT CLUTCH CHECK'                                  X2446000
         $IHMSG 5,'HOPPER CHECK'                                        X2448000
         $IHMSG 6,'FEED CHECK'                                          X2450000
         $IHMSG 7,'NO-OP'                                               X2452000
.NOMFCUC ANOP                                                           X2454000
         $IHMSG T,'5203 PRINTER --- STATUS BYTE 1'                      X2456000
         $IHMSG 0,'CHAIN SYNCHRONIZATION CHECK'                         X2458000
         $IHMSG 1,'INCREMENTER SYNC CHECK'                              X2460000
         $IHMSG 2,'THERMAL CHECK'                                       X2462000
         $IHMSG 6,'UNPRINTABLE CHARACTER'                               X2464000
         $IHMSG 7,'CE SNS BIT'                                          X2466000
         $IHMSG T,'5203 PRINTER --- STATUS BYTE 2'                      X2468000
         $IHMSG 0,'CARRIAGE SYNC CHECK'                                 X2470000
         $IHMSG 1,'CARRIAGE SPACE CHECK'                                X2472000
         $IHMSG 2,'FORMS JAM CHECK'                                     X2474000
         $IHMSG 3,'INCREMENTER FAILURE CHECK'                           X2476000
         $IHMSG 4,'CE SNS BIT LATCHED'                                  X2478000
         $IHMSG 5,'HAMMER ECHO CHECK'                                   X2480000
         $IHMSG 6,'ANY HAMMER ON CHECK'                                 X2482000
         $IHMSG 7,'NO-OP'                                               X2484000
         $IHMSG T,'BINARY SYNCHRONOUS COMMUNICATIONS ADAPTER --- STATUSCX2486000
                BYTE 2'                                                 X2488000
         $IHMSG 0,'TIMEOUT'                                             X2490000
         $IHMSG 1,'CYCLIC REDUNDANCY CHECK'                             X2492000
         $IHMSG 2,'ADAPTER CHECK DURING TRANSMIT'                       X2494000
         $IHMSG 3,'ADAPTER CHECK DURING RECEIVE'                        X2496000
         $IHMSG 4,'BAD ASCII'                                           X2498000
         $IHMSG 5,'ABORTIVE DISCONNECT'                                 X2500000
         $IHMSG 6,'DISCONNECT TIMEOUT'                                  X2502000
         AIF   (NOT &S31442).IHMEND  *                                  X2504000
         $IHMSG T,'1442 CARD READ PUNCH --- STATUS BYTE 1'              X2506000
         $IHMSG 0,'READ COMPARE'                                        X2508000
         $IHMSG 2,'PUNCH CHECK'                                         X2510000
         $IHMSG 3,'DATA OVERRUN'                                        X2512000
         $IHMSG 5,'NO-OP LATCH'                                         X2514000
         $IHMSG 6,'FEED CHECK'                                          X2516000
         $IHMSG 7,'INVALID CARD CODE'                                   X2518000
         $IHMSG T,'1442 CARD READ PUNCH --- STATUS BYTE 2'              X2520000
         $IHMSG 3,'READ STATION JAM'                                    X2522000
         $IHMSG 4,'HOPPER MISFEED'                                      X2524000
         $IHMSG 5,'FEED CLUTCH'                                         X2526000
         $IHMSG 6,'PUNCH STATION JAM'                                   X2528000
         $IHMSG 7,'TRANSPORT JAM'                                       X2530000
.IHMEND  DC    X'0'                LAST-CAPTION INDICATOR.              X2532000
IHERROR  $DC   C'HEREP COUNTERS HAVE BEEN ALTERED.'                     X2534000
IHBIT1   EQU   *                                                        X2536000
         AIF   (NOT &S35424).NOMFCUD                                    X2538000
         DC    B'11111111'         5424 VALID COUNTERS                  X2540000
.NOMFCUD ANOP                                                           X2542000
         DC    B'1110001111111111' 5203 VALID COUNTERS                  X2544000
         DC    B'11111110'         BSCA VALID COUNTERS                  X2546000
         AIF   (NOT &S31442).IHB1442  *                                 X2548000
         DC    B'1011011100011111' 1442 VALID COUNTERS                  X2550000
.IHB1442 ANOP                      *                                    X2552000
IHBITS   EQU   *-1                 ADDRESS OF BIT PATTERN.              X2554000
IHBITL   EQU   IHBITS-IHBIT1+1     LENGTH OF BIT PATTERN.               X2556000
IHSNS    $DC   YL2(0)              PRINTER SENSE BYTES FOR HEREP.       X2558000
IHLC     $DC   C'1234567890#@/STUVWXYZ&&,%JKLMNOPQR-$*ABCDEFGHI+.'''    X2560000
IHPN     $DC   2C'1234567890XY/STUVW|:_",=JKLMNOPQR-Z(ABCDEFGHI+.)%$*#&CX2562000
               &@<;^''?>'                                               X2564000
         $END  START=IHEREP                                             X2566000
         ORG   IHEREP                                                   X2568000
         TITLE 'HRTPSYS3 - COMMUTATOR'                                  X2570000
*                                                                       X2572000
*                                                                       X2574000
*              MAIN COMMUTATOR                                          X2576000
*                                                                       X2578000
*                                                                       X2580000
$COM     $LA   FBR,$FB1            POINT TO FIRST FUNCTION BLOCK.       X2582000
COMM1    $TBF  (FBEWF,FBR),EWFALL  IS FUNCTION DISPATCHABLE...          X2584000
         $JF   COM2                IF NOT, JUMP.                        X2586000
         $L    R1,(FBREG1,FBR)     YES.  RESTORE REGISTER 1             X2588000
         $L    IAR,(FBENT,FBR)     AND GIVE THE FUNCTION CONTROL.       X2590000
$COMRET  $ST   ARR,(FBENT,FBR)     ON RETURN, SAVE NEXT ENTRY POINT,    X2592000
$COMRETA $ST   R1,(FBREG1,FBR)     AND SAVE REGISTER 1.                 X2594000
COM2     $CLI  (FBNEXT-1,FBR),0    SET CC TO INDICATE IF END OF CHAIN.  X2596000
$COMRETB EQU   COM2                                                     X2598000
         $L    FBR,(FBNEXT,FBR)    POINT TO NEXT FUNCTION BLOCK.        X2600000
         $BNE  COMM1               IF IT EXISTS, CHECK DISPATCHABILITY. X2602000
         $B    $COM                OTHERWISE START AGAIN AT TOP.        X2604000
         TITLE 'MFCU - HOPPER DRIVER'                                   X2606000
         AIF   (NOT &S35424).NOMFCUE                                    X2608000
$MFCU    EQU   *                                                        X2610000
         $B    HREAD               GO READ A CARD.                      X2612000
         $B    HBLANK              CHECK CARD FOR BLANK.                X2614000
         $JE   HAP                 IF BLANK, GO AWAIT PUNCH.            X2616000
         AIF   (NOT &S3CMDS).NOCMDM                                     X2618000
*                                                                       X2620000
*              CHECK FOR LOCAL COMMANDS                                 X2622000
*                                                                       X2624000
         $L    R1,(HCRDB,HCR)      POINT TO THE READ BUFFER.            X2626000
         $B    $CMDSCAN            GO CHECK LOCAL COMMANDS.             X2628000
         $L    R1,(FBREG1,FBR)     RESTORE HOPPER POINTER.              X2630000
         $BE   $MFCU               IF COMMAND, GO READ AGAIN.           X2632000
.NOCMDM  ANOP                                                           X2634000
*                                                                       X2636000
*              AWAITING-READ ROUTINE                                    X2638000
*                                                                       X2640000
HAR      $MVC  (HCFBP,HCR),A$FBRD1,2  SET ARG TO ALLOCATE.              X2642000
         $B    HGET                GO TO ALLOCATION SUBROUTINE.         X2644000
         $BNE  $MFCU               IF HOP NOT READY, MAKE DORMANT.      X2646000
*                                                                       X2648000
*              READING ROUTINE                                          X2650000
*                                                                       X2652000
HRD      $SBN  (HCFLG,HCR),HFRBB   SHOW READ BUFFER BUSY.               X2654000
         $ST   IAR,(FBENT,FBR)     SET NEXT ENTRY ADDRESS.              X2656000
         $TBF  (HCFLG,HCR),HFRBB   DID LOGICAL READER FREE BUFFER...    X2658000
         $BF   $COMRETA            NON-PROCESS-EXIT IF NOT.             X2660000
         $TBN  (HCFLG,HCR),HFEOF   DID LOGICAL READER SET EOF...        X2662000
         $BT   $MFCU               MAKE HOPPER DORMANT IF SO.           X2664000
         $B    HREAD               OTHERWISE READ THE NEXT CARD         X2666000
         $B    HRD                 AND WAIT FOR IT TO BE PROCESSED.     X2668000
*                                                                       X2670000
*              AWAITING-PUNCH ROUTINE                                   X2672000
*                                                                       X2674000
HAP      $MVC  (HCFBP,HCR),A$FBPU1,2  SET ARG TO ALLOCATE.              X2676000
         $B    HGET                GO TO ALLOCATION SUBROUTINE.         X2678000
         $BNE  $MFCU               IF HOP NOT READY, MAKE DORMANT.      X2680000
*                                                                       X2682000
*              PUNCHING ROUTINE                                         X2684000
*                                                                       X2686000
HPU      $ST   IAR,(FBENT,FBR)     SET NEXT ENTRY ADDRESS.              X2688000
         $TBF  (HCFLG,HCR),HFPBB+HFEOF  DID LOGICAL PCH RTN SET A FLAG. X2690000
         $BT   $COMRETA            NON-PROCESS-EXIT IF NOT.             X2692000
         $TBN  (HCFLG,HCR),HFEOF   DID HE SAY END-OF-FILE...            X2694000
         $BT   HAP                 IF SO, GO AWAIT PUNCH AGAIN.         X2696000
HPU1     $MVC  (HCSIO,HCR),(HCPUS,HCR),2  SET UP RD-PU-PRT SIO.         X2698000
         $B    HEXCP               GO ISSUE THE SIO.                    X2700000
         $JE   HPU2                IF NO ERRORS, SHOW PU BUF FREE.      X2702000
         $TBF  (HCSNS,HCR),X'47'   IF PU CK, HOP CK, FEED CK, OR NO-OP, X2704000
         $JF   HPU3                SKIP FREEING PUNCH BUFFER.           X2706000
HPU2     $SBF  (HCFLG,HCR),HFPBB   OTHERWISE FREE PUNCH BUFFER.         X2708000
         $L    R1,(HCPUB,HCR)      POINT TO THE PUNCH BUFFER.           X2710000
         $MVI  (95,R1),C' '        SET LOW-ORDER CHAR TO BLANK.         X2712000
         $MVC  (94,R1),(95,R1),95  PROPAGATE IT TO CLEAR THE BUFFER.    X2714000
         $L    R1,(FBREG1,FBR)     THEN RESTORE INDEX REGISTER 1.       X2716000
HPU3     $TBF  (HCSNS,HCR),X'81'   IF NO READ CHECK NOR NO-OP,          X2718000
         $JT   HPU5                GO CHECK CARD FOR BLANKS.            X2720000
HPU4     $B    HREAD               OTHERWISE READ ANOTHER CARD.         X2722000
HPU5     $B    HBLANK              GO CHECK CARD FOR BLANKS.            X2724000
         $BE   HPU                 IF BLANK, GO TO THE TOP.             X2726000
         $B    HPU4                IF NOT BLANK, READ ANOTHER CARD.     X2728000
         EJECT                                                          X2730000
*                                                                     * X2732000
*********************************************************************** X2734000
*                                                                     * X2736000
*        SUBROUTINE TO CHECK FOR A BLANK READ BUFFER                  * X2738000
*                                                                     * X2740000
*********************************************************************** X2742000
*                                                                     * X2744000
HBLANK   $ST   ARR,(HCRET1,HCR)    SAVE RETURN ADDRESS.                 X2746000
         $L    R1,(HCRDB,HCR)      POINT TO FIRST BYTE OF READ BUFFER.  X2748000
         $CLI  (95,R1),C' '        IF LOW-ORDER BYTE IS NOT BLANK,      X2750000
         $JNE  HBLRET              GO RETURN CONDITION NOT-EQUAL.       X2752000
         $CLC  (94,R1),(95,R1),95  ELSE TEST THE REMAINING BYTES TOO.   X2754000
HBLRET   $L    R1,(FBREG1,FBR)     THEN RESTORE REGISTER 1 AND          X2756000
         $L    IAR,(HCRET1,HCR)    RETURN CONDITION EQUAL OR NOT-EQUAL. X2758000
.NOMFCUE ANOP                                                           X2760000
         SPACE 5                                                        X2762000
*                                                                     * X2764000
*********************************************************************** X2766000
*                                                                     * X2768000
*        SUBROUTINE TO ALLOCATE LOGICAL DEVICE ROUTINE                * X2770000
*                                                                     * X2772000
*********************************************************************** X2774000
*                                                                     * X2776000
HGET     $ST   ARR,(HCRET1,HCR)    SAVE RETURN ADDRESS.                 X2778000
         $ST   R2,(HCRET2,HCR)     SAVE REGISTER 2.                     X2780000
         $SBF  (HCFLG,HCR),HFPBB+HFEOF+HFLCD  RESET VARIOUS FLAGS.      X2782000
         $ST   IAR,(FBENT,FBR)     SET NEXT ENTRY ADDRESS.              X2784000
         $B    HTIO                GO SEE IF HOPPER IS READY.           X2786000
         $JNE  HGNOT               IF NOT, RETURN CONDITION NOT-EQUAL.  X2788000
         $L    R2,(HCFBP,HCR)      ELSE POINT TO FIRST FB.              X2790000
HGET1    $TBN  (FBEWF,FBR),EWFUNIT IS IT WAITING FOR UNIT...            X2792000
         $JT   HGOT                IF SO, GO ASSIGN UNIT.               X2794000
         $TBN  (FBFLG,FBR),FFLAST  IF NOT, IS IT LAST OF ITS TYPE...    X2796000
         $JF   HGET2               IF NOT, GO POINT TO THE NEXT ONE.    X2798000
         $L    R2,(HCRET2,HCR)     LAST OF TYPE, SO NON-PROCESS-        X2800000
         $B    $COMRETA            EXIT AND TRY AGAIN NEXT TIME.        X2802000
HGET2    $L    R2,(FBNEXT,FBR)     NOT LAST.  POINT TO NEXT FB AND      X2804000
         $B    HGET1               SEE IF IT'S WAITING FOR A UNIT.      X2806000
HGOT     $ST   R1,(FBHCP,FBR)      ALLOCATE - POINT FB TO HCA           X2808000
         $ST   R2,(HCFBP,HCR)      AND POINT HCA TO FB,                 X2810000
         $POST *,UNIT              POST THE FB FOR UNIT,                X2812000
         $L    R2,(HCRET2,HCR)     RESTORE INDEX REGISTER 2,            X2814000
         $CLI  *-1,0               SET CONDITION CODE EQUAL,            X2816000
HGNOT    $L    IAR,(HCRET1,HCR)    AND RETURN WITH CORRECT CONDITION.   X2818000
         SPACE 1                                                        X2820000
A$FBRD1  $DC   YL2($FBRD1)         ADR OF FIRST LOGICAL READER FB.      X2822000
A$FBPU1  $DC   YL2($FBPU1)         ADR OF FIRST LOGICAL PUNCH FB.       X2824000
         SPACE 5                                                        X2826000
*                                                                     * X2828000
         AIF   (NOT &S35424).NOMFCUF                                    X2830000
*********************************************************************** X2832000
*                                                                     * X2834000
*        SUBROUTINE TO READ A SINGLE CARD                             * X2836000
*                                                                     * X2838000
*********************************************************************** X2840000
*                                                                     * X2842000
HREAD    $ST   ARR,(HCRET1,HCR)    SAVE RETURN ADDRESS.                 X2844000
         $MVC  (HCSIO,HCR),(HCRDS,HCR),2  SET UP READ SIO.              X2846000
         $B    HEXCP               GO READ A CARD.                      X2848000
         $JNE  HEXCP1              REREAD IF ERROR.                     X2850000
         $L    IAR,(HCRET1,HCR)    RETURN CONDITION EQUAL.              X2852000
         EJECT                                                          X2854000
*                                                                     * X2856000
*********************************************************************** X2858000
*                                                                     * X2860000
*        SUBROUTINE TO DO AND CHECK ANY INPUT/OUTPUT OPERATION.       * X2862000
*                                                                     * X2864000
*********************************************************************** X2866000
*                                                                     * X2868000
HEXCP    $ST   ARR,(HCRET2,HCR)    SAVE RETURN ADDRESS.                 X2870000
HEXCP1   $ST   IAR,(FBENT,FBR)     SET NEXT ENTRY ADDRESS.              X2872000
         $B    HTIO                GO TIO FOR READY.                    X2874000
         $BE   HSIO                IF READY, GO TRY TO ISSUE SIO.       X2876000
         $BNE  $COMRETA            EXIT IF SIO WAS NOT ISSUED.          X2878000
         $B    $COMRET             ELSE EXIT & SET NEXT ENTRY ADDRESS.  X2880000
         $TIO  15,0,7,$COMRETA     THEN EXIT TILL NOT BUSY.             X2882000
         $B    HSNS                WHEN NOT BUSY, TEST COMPLETION.      X2884000
         $L    IAR,(HCRET2,HCR)    THEN RETURN CONDITION TO CALLER.     X2886000
         SPACE 5                                                        X2888000
*                                                                     * X2890000
*********************************************************************** X2892000
*                                                                     * X2894000
*        SUBROUTINE TO START INPUT/OUTPUT FOR THE MFCU                * X2896000
*                                                                     * X2898000
*********************************************************************** X2900000
*                                                                     * X2902000
HSIO     $ST   ARR,(HCRET3,HCR)    SAVE RETURN ADDRESS.                 X2904000
HSERROR  $NOPJ HSRETF              RETURN FALSE IF ERROR RECOVERY.      X2906000
         $TIO  15,0,7,HSRETF       RETURN FALSE IF BUSY.                X2908000
HSHURRY  $J    HSSNS               JUMP TO SENSE IF NO HURRY.           X2910000
         $TBF  (HCSIO-1,HCR),6     HURRY SWITCH IS SET.  IF THIS IS NOT X2912000
         $JF   HSRETF              READ-ONLY, RETURN CONDITION FALSE.   X2914000
HSSNS    $SNS  15,0,3,(HCSNS,HCR)  OTHERWISE READ THE STATUS BYTES.     X2916000
HSSTK    $CLI  (HCSIO,HCR),*-*     IS SAME STACKER REQUESTED...         X2918000
         $JE   HS01                IF SO, PROCEED WITH THE SIO.         X2920000
         $TBF  (HCSNS-1,HCR),3     IF NOT, IS THE TRANSPORT CLEAR...    X2922000
         $JT   HS00                SWITCH STACKERS IF IT IS.            X2924000
         $TBF  (HCSIO-1,HCR),6     ELSE SEE IF THIS IS A READ-ONLY SIO. X2926000
         $JF   HSRETF              IF NOT READ-ONLY, WAIT NORMALLY.     X2928000
         $MVI  HSHURRY+1,128       OTHERWISE SET THE HURRY SWITCH       X2930000
         $J    HSRETF              AND RETURN CONDITION FALSE.          X2932000
HS00     $MVI  HSHURRY+1,0         STACKER CHANGE.  RESET THE HURRY     X2934000
         $MVC  HSSTK+1,(HCSIO,HCR) SWITCH AND SET NEW STACKER NUMBER.   X2936000
HS01     EQU   *                                                        X2938000
         $MVC  HSSIO+2,(HCSIO,HCR),2  SET UP THE IN-LINE $SIO.          X2940000
         $TBN  (HCSIO-1,HCR),4     IS PRINT REQUIRED...                 X2942000
         $JF   HS11                JUMP IF NOT.                         X2944000
         $TBN  (HCSNS-1,HCR),X'C0' IS ANY PRINT BUFFER FREE...          X2946000
         $JT   HSRETF              IF NOT, RETURN CONDITION FALSE.      X2948000
         $SBF  HS03+3,X'80'        ASSUME PRINT BUFFER 1 FREE.          X2950000
         $TBF  (HCSNS-1,HCR),X'80' IS PRINT BUFFER 1 FREE...            X2952000
         $JT   HS02                JUMP IF SO.                          X2954000
         $SBN  HS03+3,X'80'        ELSE SET $MVC FOR BUFFER 2           X2956000
         $SBN  HSSIO+2,X'80'       AND $SIO FOR BUFFER 2.               X2958000
HS02     $L    R1,(HCPUB,HCR)      SET $MVC FROM-ADDRESS.               X2960000
HS03     $MVC  HPRB+95,(95,R1),96  MOVE PUNCH BUFFER TO PRINT BUFFER.   X2962000
         $L    R1,(FBREG1,FBR)     RESTORE R1 TO POINT TO HCA.          X2964000
HS11     $LIO  15,0,5,(HCRDB,HCR)  LOAD THE MFCU READ DATA ADDRESS REG  X2966000
         $LIO  15,0,6,(HCPUB,HCR)  AND THE MFCU PUNCH ADDRESS REGISTER. X2968000
         $B    HTIO                MAKE SURE THE HOPPER'S READY.        X2970000
         $JF   HSRET               IF NOT, RETURN CONDITION FALSE.      X2972000
HSSIO    $SIO  0,0,0,0             ISSUE THE START-I/O.                 X2974000
         $CLI  *-1,0               SET CONDITION EQUAL.                 X2976000
         $L    IAR,(HCRET3,HCR)    RETURN WITH CONDITION EQUAL.         X2978000
HSRETF   $CLI  *,0                 SET CONDITION NOT-EQUAL.             X2980000
HSRET    $L    IAR,(HCRET3,HCR)    RETURN CONDITION TO CALLER.          X2982000
         SPACE 5                                                        X2984000
*                                                                     * X2986000
*********************************************************************** X2988000
*                                                                     * X2990000
*        SUBROUTINE TO PERFORM MFCU ERROR DETECTION AND LOGGING       * X2992000
*                                                                     * X2994000
*********************************************************************** X2996000
*                                                                     * X2998000
HSNS     $ST   ARR,(HCRET3,HCR)    SAVE RETURN ADDRESS.                 X3000000
         $B    HTIO                GO SEE IF HOPPER IS READY.           X3002000
         $JE   HSNSRT              IF READY, RETURN CONDITION EQUAL.    X3004000
         $SNS  15,0,3,(HCSNS,HCR)  OTHERWISE READ IN STATUS BYTES.      X3006000
         $CLI  (HCSNS,HCR),1       CHECK THE MFCU ERROR STATUS.         X3008000
         $JL   HSNSRTE             IF ALL BITS ARE OFF, RETURN EQUAL.   X3010000
         $JE   HSNSRTF             IF ONLY NO-OP, RETURN UNEQUAL.       X3012000
         $MVC  HSMSG+2,(HCSNS,HCR),2  MOVE STATUS BYTES TO MESSAGE.     X3014000
         $LA   R1,HSMSG            POINT TO MESSAGE WITH R1.            X3016000
         $B    $MSG                GO PUT MSG INTO TRACE TABLE.         X3018000
         $L    R1,(FBREG1,FBR)     THEN RESTORE REGISTER 1.             X3020000
         $MVC  HSNS1+1,(HCSNS,HCR) SAVE THE ERROR STATUS BYTE.          X3022000
         $LA   R1,(HCSNS,HCR)      SET R1 AS ARGUMENT TO $LOG.          X3024000
         $B    $LOG                GO LOG THE ERROR BITS.               X3026000
         $L    R1,(FBREG1,FBR)     THEN RESTORE R1, AND                 X3028000
HSNS1    $MVI  (HCSNS,HCR),*-*     RESTORE THE ERROR STATUS BYTE.       X3030000
         $TBF  (HCSNS,HCR),X'C7'   IF ONLY PUN INVALID OR PRT CHK,      X3032000
         $JF   HSNS2               DO NOT JUMP HERE, BUT                X3034000
HSNSRTE  $CLI  *-1,0               SET CONDITION EQUAL                  X3036000
         $L    IAR,(HCRET3,HCR)    AND RETURN.                          X3038000
HSNS2    $MVI  HSERROR+1,0         ELSE SET THE ERROR RECOVERY FLAG.    X3040000
         $ST   IAR,(FBENT,FBR)     SET NEXT ENTRY ADDRESS.              X3042000
         $SNS  15,0,3,(HCSNS+4,HCR)  READ IN THE MFCU STATUS BYTES.     X3044000
         $TBF  (HCSNS+4,HCR),X'FE'   CHECK ALL ERROR BITS BUT NOP.      X3046000
         $BF   $COMRETA            IF NOT ALL OFF, NON-PROCESS EXIT.    X3048000
         $MVI  HSERROR+1,128       THEN RESET THE ERROR RECOVERY FLAG,  X3050000
HSNSRTF  $CLI  *,0                 SET CONDITION NOT-EQUAL, AND         X3052000
HSNSRT   $L    IAR,(HCRET3,HCR)    RETURN CONDITION TO CALLER.          X3054000
HSMSG    DC    X'0500000F'         BASIC STATUS MESSAGE FOR 5424.       X3056000
.NOMFCUF ANOP                                                           X3058000
         SPACE 5                                                        X3060000
*                                                                     * X3062000
*********************************************************************** X3064000
*                                                                     * X3066000
*        SUBROUTINE TO TEST I/O FOR NOT READY/UNIT CHECK              * X3068000
*                                                                     * X3070000
*********************************************************************** X3072000
*                                                                     * X3074000
HTIO     $ST   ARR,(HCRET4,HCR)    SAVE RETURN ADDRESS.                 X3076000
         $MVC  HTIO1+1,(HCTIO,HCR) SET UP THE TIO INSTRUCTION.          X3078000
         $CLI  *,0                 SET CONDITION NOT-EQUAL.             X3080000
HTIO1    $TIO  0,0,0,HTIO2         BRANCH IF HOPPER NOT READY.          X3082000
         $CLI  *-1,0               ELSE SET CONDITION EQUAL.            X3084000
HTIO2    $L    IAR,(HCRET4,HCR)    RETURN CONDITION TO CALLER.          X3086000
         AIF   (NOT &S31442).NO1442  *                                  X3088000
         TITLE '1442 CARD READ/PUNCH DRIVER'                            X3090000
*                                                                       X3092000
*              1442 HOPPER CONTROL AREA AND DATA AREA.                  X3094000
*                                                                       X3096000
HCA1442  $HCA  DEV=1442,RDB=GDATA,PUB=GPDATA,TIO=X'50',                CX3098000
               LOG1=LOG1442A,LOG2=LOG1442B                              X3100000
         AIF   (NOT &S35424).NOMFCUG                                    X3102000
GDATA    DS    CL82                READ BUFFER.                         X3104000
GPDATA   DS    CL82                PUNCH BUFFER.                        X3106000
         AGO   .NOMFCUH                                                 X3108000
.NOMFCUG ANOP                                                           X3110000
GDATA    EQU   HRTPSYS3            READ BUFFER.                         X3112000
GPDATA   EQU   GDATA+82            PUNCH BUFFER.                        X3114000
.NOMFCUH ANOP                                                           X3116000
         SPACE 10                                                       X3118000
*                                                                       X3120000
*              UNASSIGNED-1442 ROUTINE.                                 X3122000
*                                                                       X3124000
$1442    EQU   *                                                        X3126000
GDOR     $B    GSIORD              GO READ A CARD.                      X3128000
         $BNE  GDOR                IF ERROR, GO READ AGAIN.             X3130000
         $CLI  GDATA,C' '          IS THE CARD BLANK...                 X3132000
         $JNE  GAR                 NO.  GO TO AWAITING-READ.            X3134000
         $CLC  GDATA+78,GDATA+79,79  MAYBE.  CHECK ALL COLUMNS.         X3136000
         $JNE  GAR                 IF BLANK, FALL THROUGH.              X3138000
*                                                                       X3140000
*              AWAITING-PUNCH ROUTINE.                                  X3142000
*                                                                       X3144000
GAP      $MVC  (HCFBP,HCR),A$FBPU1,2  SET ARGUMENT TO ALLOCATE.         X3146000
         $B    HGET                GO TO ALLOCATION SUBROUTINE.         X3148000
         $BNE  GDOR                IF NOT READY, MAKE DORMANT.          X3150000
*                                                                       X3152000
*              ACTIVELY-PUNCHING ROUTINE.                               X3154000
*                                                                       X3156000
GPU      $ST   IAR,(FBENT,FBR)     SET NEXT ENTRY ADDRESS.              X3158000
         $TBF  (HCFLG,HCR),HFPBB+HFEOF  DO WE HAVE WORK TO DO...        X3160000
         $BT   $COMRETA            IF NOT, NON-PROCESS-EXIT.            X3162000
         $TBN  (HCFLG,HCR),HFEOF   IS IT END-OF-FILE...                 X3164000
         $BT   GAP                 IF SO, GO AWAIT PUNCH AGAIN.         X3166000
GPU1     $B    GSIOPU              NO, PUNCH BUFFER BUSY.  GO PUNCH.    X3168000
         $BNE  GPU1                IF ERROR, GO RE-PUNCH.               X3170000
         $SBF  (HCFLG,HCR),HFPBB   OTHERWISE RESET PUNCH-BUSY           X3172000
         $B    GPU                 AND GO WAIT FOR NEXT CARD.           X3174000
*                                                                       X3176000
*              AWAITING-READ ROUTINE.                                   X3178000
*                                                                       X3180000
GAR      EQU   *                                                        X3182000
         AIF   (NOT &S3CMDS).NOCMDG                                     X3184000
*                                                                       X3186000
*              BUT FIRST, CHECK LOCAL COMMANDS                          X3188000
*                                                                       X3190000
         $L    R1,(HCRDB,HCR)      POINT TO THE READ BUFFER.            X3192000
         $B    $CMDSCAN            GO CHECK LOCAL COMMANDS.             X3194000
         $L    R1,(FBREG1,FBR)     RESTORE HOPPER POINTER.              X3196000
         $BE   $1442               IF COMMAND, GO READ AGAIN.           X3198000
.NOCMDG  $MVC  (HCFBP,HCR),A$FBRD1,2  SET ARG TO ALLOCATE.              X3200000
         $B    HGET                GO TO ALLOCATION SUBROUTINE.         X3202000
         $BNE  HGET1-3             IF UNREADY, ALLOCATE NEVERTHELESS.   X3204000
*                                                                       X3206000
*              ACTIVELY-READING ROUTINE.                                X3208000
*                                                                       X3210000
GRD      $SBN  (HCFLG,HCR),HFRBB   SHOW READ BUFFER BUSY.               X3212000
         AIF   (NOT &S3OBJDK).GNOOBJ  *                                 X3214000
         $MVI  GDATA+80,0          AVOID APPEARANCE OF 2-FOR-1 CARD.    X3216000
.GNOOBJ  $TBN  (HCSNS,HCR),X'40'   IS THE LAST-CARD SWITCH ON...        X3218000
         $JF   GRD1                IF NOT, SKIP LAST-CARD CODE.         X3220000
         $SBN  (HCFLG,HCR),HFLCD   ALSO SET THE LAST-CARD FLAG.         X3222000
GRD1     $ST   IAR,(FBENT,FBR)     SET NEXT ENTRY LOCATION.             X3224000
         $TBF  (HCFLG,HCR),HFRBB   IS THE READ BUFFER FREE YET...       X3226000
         $BF   $COMRETA            IF STILL BUSY, NON-PROCESS EXIT.     X3228000
         $MVI  (HCSNS,HCR),0       MAKE SURE THE LAST-CARD BIT'S OFF.   X3230000
         $TBF  (HCFLG,HCR),HFEOF+HFLCD  DID LOGICAL RDR SET EOF ETC...  X3232000
         $JF   GRD3                YES, ONE OR THE OTHER.  SO JUMP.     X3234000
GRD2     $B    GSIORD              NO, SO GO READ THE NEXT CARD.        X3236000
         $BNE  GRD2                IF ERROR IN THE READ, READ IT AGAIN. X3238000
         $B    GRD                 OTHERWISE GO SHOW BUFFER BUSY.       X3240000
GRD3     $TBN  (HCFLG,HCR),HFEOF   DID LOGICAL READER SEE AN EOF...     X3242000
         $BT   $1442               IF HE DID, MAKE THIS READER DORMANT. X3244000
         $SBN  (HCFLG,HCR),HFEOF   NO, WE PREVIOUSLY SET LAST-CARD.     X3246000
         $B    GRD                 SHOW EOF AND TELL IT TO $READER.     X3248000
*                                                                     * X3250000
*********************************************************************** X3252000
*                                                                     * X3254000
*        SUBROUTINE TO START I/O FOR ANY OPERATION AND SNS IF REQUIRED* X3256000
*                                                                     * X3258000
*********************************************************************** X3260000
*                                                                     * X3262000
GSIORD   $LIO  5,0,4,(HCRDB,HCR)   READ EBCDIC - LOAD DATA ADDRESS REG, X3264000
         $MVI  GSIO1+1,X'51'       AND SET $SIO TO READ-EBCDIC.         X3266000
         $J    GSIO                THEN JUMP TO COMMON ROUTINE.         X3268000
GSIOPU   $LIO  5,0,4,(HCPUB,HCR)   PUNCH AND FEED - LOAD DATA ADR REG,  X3270000
         $LIO  5,0,0,(HCPLN,HCR)   SET 128 MINUS PUNCH COUNT,           X3272000
         $MVI  GSIO1+1,X'52'       AND SET $SIO TO PUNCH-AND-FEED.      X3274000
GSIO     $ST   ARR,(HCRET3,HCR)    SET RETURN ADDRESS.                  X3276000
         $ST   IAR,(FBENT,FBR)     SET NEXT ENTRY ADDRESS.              X3278000
         $TIO  5,0,2,$COMRETA      NON-PROCESS-EXIT IF BUSY.            X3280000
         $TIO  5,0,0,$COMRETA      NON-PROCESS-EXIT TILL READY.         X3282000
GSIO1    $SIO  5,0,*-*,1           $SIO AND SPECIFY STACKER 2.          X3284000
         $ST   IAR,(FBENT,FBR)     THEN SET NEXT ENTRY ADDRESS          X3286000
         $TIO  5,0,2,$COMRETA      AND NON-PROCESS-EXIT TILL NOT BUSY.  X3288000
         $CLI  GSIO1+1,X'50'       WAS THE $SIO MERELY A RUN-OUT...     X3290000
         $JE   GSNSRT              IF YES, RETURN TO THE CALLER.        X3292000
         $B    HTIO                ELSE GO TEST FOR NOT-READY/UNIT-CHK. X3294000
         $SNS  5,0,3,(HCSNS,HCR)   READ IN THE STATUS BYTES.            X3296000
         $JNE  GSIO2               LOG MESSAGE UNLESS READY.            X3298000
         $TBN  (HCSNS,HCR),X'40'   IF READY, CHECK LAST CARD.           X3300000
         $JF   GSNSRT              RETURN IF NOT-LAST-CARD.             X3302000
         $MVI  GSIO1+1,X'50'       LAST CARD - SET FEED-ONLY            X3304000
         $B    GSIO+3              AND RUN OUT LAST CARD.               X3306000
GSIO2    EQU   *                                                        X3308000
         $MVC  GSMSG+2,(HCSNS,HCR),2  MOVE STATUS BYTES TO MESSAGE.     X3310000
         $LA   R1,GSMSG            POINT R1 TO THE MESSAGE              X3312000
         $B    $MSG                AND PUT IT IN THE TRACE TABLE.       X3314000
         $L    R1,(FBREG1,FBR)     THEN RESTORE R1.                     X3316000
         $MVC  (HCLOG1,HCR),(HCSNS,HCR) SET UP STATUS BYTE 1 AND        X3318000
         $MVC  (HCLOG2,HCR),(HCSNS-1,HCR)  STATUS BYTE 2 FOR LOGGING.   X3320000
         $LA   R1,(HCLOG1,HCR)     POINT ARGUMENT REGISTER TO LOG ARGS  X3322000
         $B    $LOG                FOR BYTE 1 AND GO $LOG.              X3324000
         $LA   R1,(7,R1)           POINT ARGUMENT REGISTER TO LOG ARGS  X3326000
         $B    $LOG                FOR BYTE 2 AND GO $LOG.              X3328000
         $L    R1,(FBREG1,FBR)     THEN RESTORE REGISTER 1.             X3330000
         $CLI  *-1,0               SET CONDITION EQUAL.                 X3332000
         $TBF  (HCSNS,HCR),X'B7'   ARE THERE ERRORS...                  X3334000
         $JT   GSNSRT              JUMP IF NOT.                         X3336000
         $CLI  *,0                 ELSE SET CONDITION NOT-EQUAL.        X3338000
GSNSRT   $L    IAR,(HCRET3,HCR)    RETURN TO CALLER WITH CONDITION.     X3340000
GSMSG    DC    X'05000005'         BASIC STATUS MESSAGE FOR 1442.       X3342000
.NO1442  $DROP HCR                 DISESTABLISH ADDRESSABILITY.         X3344000
         TITLE '5203 LINE PRINTER CONTROL AREA'                         X3346000
         $USING PCA,PCR            ESTABLISH ADDRESSABILITY.            X3348000
*                                                                       X3350000
*              5203 LINE PRINTER CONTROL AREA                           X3352000
*                                                                       X3354000
PCA      EQU   *                   CONTROL AREA LOCATION.               X3356000
PCR      EQU   R1                  CONTROL AREA BASE.                   X3358000
*                                                                       X3360000
*              FOLLOWING 4 BYTES ARE SIO CONTROL CODES FOR SPACE 0,     X3362000
*              SPACE 1, SPACE 2, AND SPACE 3.  THEY MUST APPEAR AT      X3364000
*              PCA+0.                                                   X3366000
*                                                                       X3368000
         DC    YL1(0,1,2,3)        CONTROL CODES FOR SPACING.           X3370000
PCDA     $DC   YL2(LPDA)           ADCON FOR PRINTER DATA AREA.         X3372000
PCIA     $DC   YL2(LPIA)           ADCON FOR PRINTER IMAGE AREA.        X3374000
*                                                                       X3376000
*              FOLLOWING 4 BYTES ARE SIO N-CODES FOR PRINT AND SPACE,   X3378000
*              PRINT AND SKIP, SPACE ONLY, AND SKIP ONLY.  THEY MUST    X3380000
*              START AT PCA+8.                                          X3382000
*                                                                       X3384000
         DC    YL1(2,6,0,4)        N-CODES FOR ALL CASES.               X3386000
PCFLG    DC    X'0'                PRINTER FLAG BYTE.                   X3388000
PFBSY    EQU   1                     PRINT DATA AREA BUSY BIT.          X3390000
PFASG    EQU   2                     PRINTER-ASSIGNED BIT.              X3392000
PCCC     DC    X'0'                PRINTER SUB-RECORD CONTROL BYTE.     X3394000
PCSNS    $DC   YL2(0)              PRINTER STATUS BYTES.                X3396000
*                                                                       X3398000
*              FOLLOWING 16 BYTES ARE THE EQUIVALENT OF A 12-CHAN       X3400000
*              CARRIAGE CONTROL TAPE.  EACH SPECIFIES A LINE NUMBER     X3402000
*              TO WHICH PAPER WILL BE SKIPPED WHEN THE SRCB SO          X3404000
*              SPECIFIES.  THEY MUST START AT PCA+16.                   X3406000
*                                                                       X3408000
PCCCTL   EQU   *                                                        X3410000
         DC    YL1(0,&PC(1),&PC(2),&PC(3),&PC(4),&PC(5),&PC(6),&PC(7),&CX3412000
               PC(8),&PC(9),&PC(10),&PC(11),&PC(12),&S3FORML,0,0)       X3414000
PCSKIP   DC    X'0'                SAVE AREA FOR SKIP LINE NR.          X3416000
PCLOGA   DC    X'0',YL2(LOG5203A,0,0)  LOG STATUS BYTE 1.               X3418000
PCLOGB   DC    X'0',YL2(LOG5203B,0,0)  LOG STATUS BYTE 2.               X3420000
PCMSG    DC    X'0500000E'         BASIC STATUS MESSAGE FOR 5203.       X3422000
         TITLE '5203 LINE PRINTER DRIVER'                               X3424000
$5203    EQU   *                                                        X3426000
         $ST   IAR,(FBENT,FBR)     STORE LOCATION.                      X3428000
         $TBN  (PCFLG,PCR),PFBSY   NON-PROCESS EXIT TILL LINE           X3430000
         $BF   $COMRETB            PRINTER DATA AREA IS BUSY.           X3432000
*                                                                       X3434000
*              A LINE AWAITS PRINTING.  COMPLETE THE SIO Q-BYTE.        X3436000
*                                                                       X3438000
         $MNZ  (LP10+3,PCR),(PCCC,PCR)  SET SRCB ZONE IN MNN.           X3440000
LP10     $MNN  (LP40+1,PCR),(*-*,R1)  SET SIO Q-BYTE FROM TABLE.        X3442000
*                                                                       X3444000
*              NOW COMPLETE THE CONTROL-CODE BYTE.                      X3446000
*                                                                       X3448000
         $MVC  (LP20+3,PCR),(PCCC,PCR)  MOVE SRCB TO MVC INSTRUCTION.   X3450000
         $SBF  (LP20+3,PCR),X'E0'  RESET ALL BUT BITS 3-7.              X3452000
LP20     $MVC  (LP40+2,PCR),(*-*,R1)  SET CONTROL CODE IN THE SIO.      X3454000
         $TBN  (LP40+1,PCR),4      DOES SIO SAY SKIP...                 X3456000
         $JF   LP30                JUMP IF NOT. ELSE                    X3458000
         $MVC  (PCSKIP,PCR),(LP40+2,PCR) SAVE LINE NR AND               X3460000
         $SBF  (LP40+1,PCR),4      CHANGE THE SKIP                      X3462000
         $MVI  (LP40+2,PCR),X'01'  TO A SPACE-1.                        X3464000
*                                                                       X3466000
*              NON-PROCESS EXIT TILL PRINTER IS READY.                  X3468000
*                                                                       X3470000
LP30     $TIO  14,0,0,(LP70,PCR)   BRANCH IF NOT READY/UNIT CHECK.      X3472000
*                                                                       X3474000
*              PRINTER IS READY.  NOW LOAD REGISTERS AND PRINT.         X3476000
*              THEN NON-PROCESS EXIT TILL PRINTER IS NOT BUSY.          X3478000
*                                                                       X3480000
         $LIO  14,0,4,(PCDA,PCR)   LOAD MPDAR.                          X3482000
         $LIO  14,0,6,(PCIA,PCR)   LOAD MPIAR.                          X3484000
LP40     $SIO  14,0,0,0            START I/O AS SET UP ABOVE.           X3486000
         $ST   IAR,(FBENT,FBR)     STORE LOCATION.                      X3488000
         $TIO  14,0,6,$COMRETB     NON-PROCESS EXIT TILL NOT BUSY.      X3490000
*                                                                       X3492000
*              CHECK PRINTER STATUS AND RE-ISSUE SIO IF NECESSARY.      X3494000
*                                                                       X3496000
         $MVI  (PCSNS-1,PCR),0     ZERO STATUS BYTE 1 BEFORE TIO.       X3498000
         $TIO  14,0,0,(LP70,PCR)   BRANCH IF NOT READY/UNIT CHECK.      X3500000
         $TBF  (PCSNS-1,PCR),X'16' IF INCREMENTER OR HAMMER CHECK,      X3502000
         $BF   (LP30,PCR)          GO PRINT THE LINE AGAIN.             X3504000
         $CLI  (PCSKIP,PCR),0      WAS SKIP CALLED FOR...               X3506000
         $JE   LP60                JUMP IF NOT.                         X3508000
         $MVI  (LP40+1,PCR),X'E4'  YES. SET SKIP-ONLY                   X3510000
         $MVC  (LP40+2,PCR),(PCSKIP,PCR)  AND LINE NUMBER,              X3512000
         $MVI  (PCSKIP,PCR),0      ZERO LINE NUMBER,                    X3514000
         $B    (LP30,PCR)          AND GO SKIP.                         X3516000
*                                                                       X3518000
*              PRINTING IS COMPLETE.  FREE THE DATA AREA AND WAIT.      X3520000
*                                                                       X3522000
LP60     EQU   *                                                        X3524000
         $SBF  (PCFLG,PCR),PFBSY   SHOW THE DATA AREA FREE.             X3526000
         $B    $5203               GO WAIT TILL IT AGAIN COMES BUSY.    X3528000
*                                                                       X3530000
*              POSSIBLE UNIT CHECK.  SENSE AND LOG STATUS.              X3532000
*                                                                       X3534000
LP70     $ST   ARR,(LP79+3,PCR)    SAVE RETURN ADDRESS.                 X3536000
         $SNS  14,0,3,(PCSNS,PCR)  READ IN THE STATUS BYTES.            X3538000
         $MVC  (PCMSG+2,PCR),(PCSNS,PCR),2  MOVE STATUS TO MESSAGE.     X3546000
         $LA   R1,(PCMSG,PCR)      POINT R1 TO MESSAGE                  X3548000
         $B    $MSG                AND PUT IT IN THE TRACE TABLE.       X3550000
         $L    R1,(FBREG1,FBR)     THEN RESTORE R1.                     X3552000
         $MVC  (PCLOGA,PCR),(PCSNS,PCR)  SET UP STATUS BYTE 1 AND       X3554000
         $MVC  (PCLOGB,PCR),(PCSNS-1,PCR)  STATUS BYTE 2 FOR LOGGING.   X3556000
         $LA   R1,(PCLOGA,PCR)     GO TO $LOG SUBROUTINE                X3558000
         $B    $LOG                  FOR STATUS BYTE 1.                 X3560000
         $LA   R1,(7,R1)           GO TO $LOG SUBROUTINE                X3562000
         $B    $LOG                  FOR STATUS BYTE 2.                 X3564000
         $LA   R1,PCA              RESTORE REGISTER 1.                  X3566000
LP78     $ST   IAR,(FBENT,FBR)     STORE LOCATION AND NON-              X3568000
         $TIO  14,0,0,$COMRETB       PROCESS-EXIT TILL 5203 IS READY.   X3570000
LP79     $B    *-*                 THEN RETURN TO CALLER.               X3572000
         $DROP PCR                 DISESTABLISH ADDRESSABILITY.         X3574000
         TITLE 'LOGICAL-READER FUNCTION'                                X3576000
*                                                                       X3578000
*                                                                       X3580000
*              LOGICAL READER - WAIT FOR WORK.                          X3582000
*                                                                       X3584000
*                                                                       X3586000
$READER  $WAIT UNIT                WAIT TO BE POSTED BY MFCU OR 1442.   X3588000
         $USING HCD,HCR            SET BASE FOR HOPPER CONTROL DSECT.   X3590000
         $B    $REQ                REQUEST PERMISSION FROM HASP.        X3592000
         $L    R1,(FBHCP,FBR)      POINT REG 1 TO HOPPER CONTROL AREA.  X3594000
*                                                                       X3596000
*                                                                       X3598000
*              WAIT FOR PERMISSION TO SEND.  THEN ANALYZE CARDS.        X3600000
*                                                                       X3602000
*                                                                       X3604000
         $WAIT PERM                WAIT FOR PERMISSION TO SEND.         X3606000
RDRIO    $ST   IAR,(FBENT,FBR)     STORE LOCATION.                      X3608000
         $TBN  (HCFLG,HCR),HFRBB   IS THERE A CARD TO PROCESS...        X3610000
         $BF   $COMRETA            IF NOT, RETURN TO COMMUTATOR.        X3612000
         $L    R2,(HCRDB,HCR)      POINT R2 TO CARD COLUMN 1.           X3614000
*                                                                       X3616000
*                                                                       X3618000
*              ANALYZE THE CARD JUST READ.                              X3620000
*                                                                       X3622000
*                                                                       X3624000
RDRCK1   $CLC  (4,R2),LOGEOF,5     IS IT LOGICAL END-OF-FILE...         X3626000
         $JE   RDREOF              JUMP IF SO.                          X3628000
         AIF   (NOT &S31442).RDX1442  *                                 X3630000
         $TBN  (HCFLG,HCR),HFEOF   FOR 1442, WAS LAST CARD READ...      X3632000
         $JT   RDREOF              JUMP IF SO.                          X3634000
.RDX1442 AIF   (NOT &S3OBJDK).RDR10  *                                  X3636000
         $CLI  (80,R2),C'1'        IS IT FIRST 2-FOR-1 CARD...          X3638000
         $JE   RDRTWO              JUMP IF SO.                          X3640000
.RDR10   ANOP                      *                                    X3642000
         EJECT                                                          X3644000
*                                                                       X3646000
*                                                                       X3648000
*              NORMAL CARD PROCESSING.                                  X3650000
*                                                                       X3652000
*                                                                       X3654000
RDR10    $L    R2,(HCFBP,HCR)      POINT R2 TO THE FUNCTION BLOCK.      X3656000
         $MVC  (FBAREA,FBR),(HCRDB,HCR),2  SET SOURCE AREA ADDRESS.     X3658000
         $MVC  (FBCLNG,FBR),EIGHTY,2  SET LENGTH OF SOURCE.             X3660000
         $MVC  (FBSRCB,FBR),(FBRCB,FBR)  SET RCB TO SEND.               X3662000
         $B    $CMPR               GO COMPRESS AND PUT IN BUFFER.       X3664000
         $SBF  (HCFLG,HCR),HFRBB   SHOW HOPPER'S READ BUFFER FREE,      X3666000
         $B    RDRIO               AND WAIT FOR THE NEXT CARD TO READ.  X3668000
EIGHTY   $DC   YL2(80)             LENGTH OF AN INPUT CARD TO SEND.     X3670000
         AIF   (NOT &S3OBJDK).RDREOF *                                  X3672000
         EJECT                                                          X3674000
*                                                                       X3676000
*                                                                       X3678000
*              TWO - FOR - ONE  CARD PROCESSING.                        X3680000
*                                                                       X3682000
*                                                                       X3684000
*                                                                       X3686000
*                                                                       X3688000
*              SQUEEZE CARD 1 INTO FIRST 40 BYTES OF PUNCH BUFFER.      X3690000
*                                                                       X3692000
*                                                                       X3694000
RDRTWO   $ST   R1,RDT10+3          SAVE HOP CTRL AREA POINTER.          X3696000
         $L    R1,(HCPUB,HCR)      POINT TO THE PUNCH BUFFER.           X3698000
         $B    RDSQUEZE            GO SQUEEZE THE CARD.                 X3700000
RDT10    $LA   R1,*-*              RESTORE HCA POINTER.                 X3702000
         $L    R2,(HCFBP,HCR)      RESTORE FB POINTER.                  X3704000
         $SBF  (HCFLG,HCR),HFRBB   SHOW READ BUFFER FREE.               X3706000
         $ST   IAR,(FBENT,FBR)     STORE LOCATION.                      X3708000
         $TBN  (HCFLG,HCR),HFRBB   WAS A CARD READ...                   X3710000
         $BF   $COMRETA            RETURN TO COMMUTATOR IF NOT.         X3712000
         $L    R2,(HCRDB,HCR)      POINT R2 TO READ BUFFER.             X3714000
         $CLI  (80,R2),C'2'        CHECK FOR 2D-CARD INDICATOR.         X3716000
         $BNE  RDRCK1              IF ABSENT, GO TREAT AS NORMAL.       X3718000
*                                                                       X3720000
*                                                                       X3722000
*              SQUEEZE CARD 2 INTO PUNCH BUFFER + 40.                   X3724000
*                                                                       X3726000
*                                                                       X3728000
         $ST   R1,RDT30+3          SAVE HCA POINTER.                    X3730000
         $L    R1,(HCPUB,HCR)      POINT R1 TO THE                      X3732000
         $LA   R1,(40,R1)          PUNCH BUFFER PLUS FORTY.             X3734000
         $B    RDSQUEZE            SQUEEZE THIS CARD.                   X3736000
RDT30    $LA   R1,*-*              RESTORE HCA POINTER.                 X3738000
         $L    R2,(HCRDB,HCR)      POINT R2 TO THE READ BUFFER.         X3740000
         $L    R1,(HCPUB,HCR)      POINT R1 TO THE PUNCH BUFFER.        X3742000
         $MVC  (79,R2),(79,R1),80  MOVE CARD INTO READ BUFFER.          X3744000
         $L    R1,RDT30+3          RESTORE R1 AGAIN                     X3746000
         $B    RDR10               AND TREAT THE CARD AS NORMAL.        X3748000
.RDREOF  ANOP                      *                                    X3750000
*                                                                       X3752000
*                                                                       X3754000
*              END - OF - FILE  PROCESSING.                             X3756000
*                                                                       X3758000
*                                                                       X3760000
RDREOF   $L    R2,(HCFBP,HCR)      POINT R2 TO FUNCTION BLOCK.          X3762000
         $B    $LEOF               SHOW HASP LOGICAL END-OF-FILE.       X3764000
         $L    R1,(FBHCP,FBR)      AGAIN POINT TO HOP CTRL AREA.        X3766000
         $SBN  (HCFLG,HCR),HFEOF   SHOW HOPPER THE END-OF-FILE.         X3768000
         $SBF  (HCFLG,HCR),HFRBB   RESET THE READ-BUF-BUSY FLAG.        X3770000
         $B    $READER             THEN WAIT AGAIN FOR WORK.            X3772000
         AIF   (NOT &S3OBJDK).RDSQUEZ  *                                X3774000
         EJECT                                                          X3776000
*                                                                       X3778000
*                                                                       X3780000
*              SQUEEZE  SUBROUTINE.                                     X3782000
*                                                                       X3784000
*                                                                       X3786000
RDSQUEZE $ST   ARR,RDSQEND+3       SAVE RETURN ADDRESS.                 X3788000
         $MVI  RDSQCT,40           SET COUNT OF 40.                     X3790000
RDSQ0    $CLI  (0,R2),C'0'         CHECK BYTE FOR NUMERIC.              X3792000
         $JNL  RDSQ1               JUMP IF WITHIN NUMERIC.              X3794000
         $ALC  (0,R2),FIFTY7       OTHERWISE ADD 57 - THIS MAKES        X3796000
*                                  C1 THRU C6 GO TO FA THRU FF.         X3798000
RDSQ1    $CLI  (1,R2),C'0'         DO THE SAME FOR                      X3800000
         $JNL  RDSQ2               THE SECOND BYTE.                     X3802000
         $ALC  (1,R2),FIFTY7                                            X3804000
RDSQ2    $MZN  (0,R1),(0,R2)       THEN MOVE THE TWO HALVES             X3806000
         $MNN  (0,R1),(1,R2)       TO A SINGLE OUTPUT BYTE.             X3808000
         $LA   R2,(2,R2)           POINT TO NEXT INPUT                  X3810000
         $LA   R1,(1,R1)           AND NEXT OUTPUT BYTES.               X3812000
         $SLC  RDSQCT,ONE          REDUCE COUNT BY 1.                   X3814000
         $BNE  RDSQ0               LOOP FOR 40 COUNTS.                  X3816000
RDSQEND  $B    *-*                 THEN RETURN TO CALLER.               X3818000
.RDSQUEZ $DROP HCR                 DROP BASE FOR HOPPER CONTROL DSECT.  X3820000
         EJECT                                                          X3822000
*                                                                       X3824000
*                                                                       X3826000
*              CONSTANTS FOR THE LOGICAL READER ---                     X3828000
*                                                                       X3830000
*                                                                       X3832000
FIFTY7   $DC   YL1(57)             57 FOR SQUEEZE ROUTINE.              X3834000
RDSQCT   $DS   &S3OBJDK.X          SQUEEZE LOOP COUNTER.                X3836000
RDLEOF   $DC   X'008000'           LOGICAL EOF - RCB, SRCB, SCB.        X3838000
LOGEOF   $DC   C'/*EOF'            LOGICAL END-OF-FILE INDICATOR.       X3840000
         SPACE 5                                                        X3842000
MTWO     $DC   HL2'-2'                                                  X3844000
ONE      $DC   HL2'1'                                                   X3846000
WORK     $DS   HL2                                                      X3848000
         TITLE 'LOGICAL PRINTER FUNCTION'                               X3850000
*                                                                       X3852000
*                                                                       X3854000
*              WAIT FOR PERMISSION.  THEN SEND TO HASP A 'PERMISSION-   X3856000
*              RECEIVED' SEQUENCE.                                      X3858000
*                                                                       X3860000
*                                                                       X3862000
$PRINTER $WAIT PERM                WAIT FOR HASP TO REQUEST PERMISSION. X3864000
         $TBF  PCFLG,PFASG         IS THE PRINTER AVAILABLE...          X3866000
         $BF   $COMRETA            NON-PROCESS EXIT IF NOT.             X3868000
PRPERM   EQU   *                                                        X3870000
         $SBN  PCFLG,PFASG         SHOW PRINTER ASSIGNED.               X3872000
         $B    $PERM               SEND PERMISSION TO HASP.             X3874000
*                                                                       X3876000
*              SET UP PRINT LINE AND WAIT TILL IT'S PRINTED.            X3878000
*                                                                       X3880000
PR       $ST   IAR,(FBENT,FBR)     STORE LOCATION.                      X3882000
         $TBF  PCFLG,PFBSY         IS PRINT BUFFER FREE...              X3884000
         $BF   $COMRETA            RETURN IF NOT.                       X3886000
         $MVC  LPDA+131,LPDA+132,132  CLEAR PRINTER DATA AREA.          X3888000
         $MVC  (FBAREA,FBR),PCDA,2 SET OUTPUT AREA FOR $DCOM.           X3890000
         $B    $DCOM               GO FILL THE PRINT BUFFER.            X3892000
         $J    PREOF               IF EOF, GO CLEAN UP.                 X3894000
         $MVC  PCCC,(FBSRCB,FBR)   SET SRCB FOR CARRIAGE CTL.           X3896000
         AIF   (&S35471).PR71                                           X3898000
         $CLI  (FBSRCB,FBR),X'8E'  IS THIS THE FORMS MOUNT MESSAGE...   X3900000
         $JNE  PR1                 JUMP IF NOT.                         X3902000
         $MVI  PCCC,X'83'          YES.  CHANGE SRCB TO PRINT & SPACE 3 X3904000
         $SBN  PCFLG,PFBSY         AND SHOW PRINT BUFFER BUSY.          X3906000
         $ST   IAR,(FBENT,FBR)     WAIT TILL                            X3908000
         $TBF  PCFLG,PFBSY         PRINT BUFFER                         X3910000
         $BF   $COMRETA            IS FREE.                             X3912000
         $MVI  PCCC,X'A3'          THEN SET SPACE 3 IMMEDIATE.          X3914000
PR1      EQU   *                                                        X3916000
         AGO   .PR71X                                                   X3918000
.PR71    $CLI  (FBSRCB,FBR),X'8E'  IF THIS IS FORMS MOUNT MESSAGE,      X3920000
         $BE   PR                  DON'T PRINT IT.                      X3922000
.PR71X   ANOP                                                           X3924000
         $SBN  PCFLG,PFBSY         SHOW LINE TO BE PRINTED.             X3926000
         $B    PR                  GO WAIT FOR IT TO COMPLETE.          X3928000
*                                                                       X3930000
*              LOGICAL END-OF-FILE ON PRINTER.                          X3932000
*                                                                       X3934000
PREOF    $SBF  PCFLG,PFASG         UNASSIGN THE PRINTER.                X3936000
         $TBF  (FBEWF,FBR),EWFPOST HAS HASP ASKED PERMISSION AGAIN...   X3938000
         $BT   PRPERM              YES.  GO GIVE HASP PERMISSION.       X3940000
         $B    $PRINTER            NO.  WAIT TILL HASP ASKS.            X3942000
         TITLE 'LOGICAL PUNCH FUNCTION'                                 X3944000
*                                                                       X3946000
*                                                                       X3948000
*              LOGICAL PUNCH - AWAIT PERMISSION FROM ANY HOPPER ROUTINE X3950000
*              TO SEND HASP PERMISSION TO SEND COMPRESSED CARD IMAGES   X3952000
*              TO US.                                                   X3954000
*                                                                       X3956000
*                                                                       X3958000
$PUNCH   $WAIT PERM                WAIT FOR HASP TO REQUEST PERMISSION. X3960000
PUPERM   EQU   *                                                        X3962000
         $WAIT UNIT                THEN WAIT FOR MFCU OR 1442.          X3964000
         $USING HCD,HCR            SET BASE FOR HOPPER CONTROL DSECT.   X3966000
         $B    $PERM               SEND PERMISSION TO HASP.             X3968000
*                                                                       X3970000
*              IF PUNCH BUFFER FREE, DECOMPRESS A CARD.                 X3972000
*                                                                       X3974000
PUN      $L    R1,(FBHCP,FBR)      POINT R1 TO HOPPER CONTROL AREA.     X3976000
PUN20    $ST   IAR,(FBENT,FBR)     SAVE LOCATION FOR NON-PROCESS EXIT.  X3978000
         $TBF  (HCFLG,HCR),HFPBB   IS PUNCH BUFFER FREE...              X3980000
         $BF   $COMRETA            NON-PROCESS-EXIT IF NOT.             X3982000
PUN30    $MVC  (FBAREA,FBR),(HCPUB,HCR),2  SET DECOMPRESSION ARGUMENT.  X3984000
         $B    $DCOM               DECOMPRESS NEXT CARD.                X3986000
         $J    PUEOF               JUMP IF END-OF-FILE.                 X3988000
         $SBN  (HCFLG,HCR),HFPBB   OTHERWISE SHOW PUNCH BUFFER BUSY.    X3990000
         AIF   (NOT &S35424).NOMFCUI                                    X3992000
         AIF   (NOT &S31442).PUX1442                                    X3994000
         $TBN  (HCFLG,HCR),HF5424  IF DEVICE IS A 5424,                 X3996000
         $JT   PUN40               SKIP LENGTH SPECIFICATION.           X3998000
.NOMFCUI ANOP                                                           X4000000
         $MVC  (HCPLN,HCR),(HCPUB,HCR),2  OTHERWISE                     X4002000
         $SLC  (HCPLN,HCR),(FBAREA,FBR),2  CALCULATE                    X4004000
         $SBF  (HCPLN,HCR),X'80'   128-(NR OF COLUMNS TO PUNCH).        X4006000
         $B    PUN20               THEN WAIT FOR PUNCH TO COMPLETE.     X4008000
         AIF   (NOT &S35424).NOMFCUJ                                    X4010000
PUN40    EQU   *                                                        X4012000
.PUX1442 $L    R1,(HCPUB,HCR)      POINT TO THE CARD IMAGE.             X4014000
         $CLI  (0,R1),X'6A'        IS IT A JOB SEPARATOR CARD...        X4016000
         $JNE  PUNOTJS             JUMP IF NOT.                         X4018000
         $MVC  (31,R1),PUJOBNR,32  YES.  SET SKELETON S/3 HEADER.       X4020000
         $CLI  (41,R1),X'6A'       IS THOUSANDS OF JOB NR BLANK...      X4022000
         $JE   PUJN1               JUMP IF YES.                         X4024000
         $MNN  (16,R1),(41,R1)     ELSE SET THOUSANDS IN CARD.          X4026000
PUJN1    $CLI  (51,R1),X'6A'       IS HUNDREDS OF JOB NR BLANK...       X4028000
         $JE   PUJN2               JUMP IF YES.                         X4030000
         $MNN  (17,R1),(51,R1)     ELSE SET HUNDREDS IN CARD.           X4032000
PUJN2    $CLI  (61,R1),X'6A'       IS TENS OF JOB NR BLANK...           X4034000
         $JE   PUJN3               JUMP IF YES.                         X4036000
         $MNN  (18,R1),(61,R1)     ELSE SET TENS IN CARD.               X4038000
PUJN3    $MNN  (19,R1),(71,R1)     SET UNITS IN CARD.                   X4040000
         $MVI  (95,R1),C' '        BLANK OUT                            X4042000
         $MVC  (94,R1),(95,R1),63  COLUMNS 33-96.                       X4044000
         $B    PUN                 THEN WAIT FOR PUNCH TO COMPLETE.     X4046000
PUNOTJS  EQU   *                                                        X4048000
         AIF   (NOT &S396COL).PUNO96                                    X4050000
         $CLI  (72,R1),X'80'       IS THIS HALF A 1-FOR-2 CARD...       X4052000
         $JNE  PUNOT96             JUMP IF NOT.                         X4054000
         $TBN  (79,R1),1           IS THIS THE FIRST HALF...            X4056000
         $JF   PU96E               JUMP IF NOT.                         X4058000
         $MVC  (FB48SV,FBR),(49,R1),48  SAVE FIRST HALF.                X4060000
         $L    R1,(FBHCP,FBR)      RESTORE HCA POINTER.                 X4062000
         $SBF  (HCFLG,HCR),HFPBB   SHOW PUNCH BUFFER NOT BUSY.          X4064000
         $B    PUN30               GO DECOMPRESS HEXT HALF.             X4066000
PU96E    $MVC  (95,R1),(49,R1),48  SECOND HALF.  MOVE IT TO COLS 49-96  X4068000
         $MVC  (47,R1),(FB48SV,FBR),48  AND FIRST HALF TO COLS 1-48.    X4070000
         $B    PUN                 THEN WAIT FOR PUNCH TO COMPLETE.     X4072000
PUNOT96  EQU   *                                                        X4074000
.PUNO96  AIF   (NOT &S3OBJDK).PUNOOBJ                                   X4076000
         $CLI  (0,R1),X'02'        IS THIS AN OS OBJECT DECK CARD...    X4078000
         $JE   PUNTWO              JUMP IF SO.                          X4080000
.PUNOOBJ $B    PUN                 GO WAIT FOR PUNCH TO COMPLETE.       X4082000
         AIF   (NOT &S3OBJDK).PUEOF                                     X4084000
*                                                                       X4086000
*              2-FOR-1 PROCESSING.  CREATE FIRST CARD OF TWO.           X4088000
*                                                                       X4090000
*                                                                       X4092000
PUNTWO   $MVC  (FB40SV,FBR),(79,R1),40  SAVE LAST 40 CARD COLUMNS.      X4094000
         $MVC  (79,R1),(39,R1),40  SHIFT CARD RIGHT 40 BYTES.           X4096000
         $MVI  (80,R1),C'1'        SHOW THIS CARD IS 1ST OF 2.          X4098000
         $B    PUEXPAND            EXPAND THE CARD.                     X4100000
         $L    R1,(FBHCP,FBR)      RESTORE HOPPER CONTROL AREA POINTER. X4102000
         $ST   IAR,(FBENT,FBR)     STORE LOCATION.                      X4104000
         $TBF  (HCFLG,HCR),HFPBB   IS PUNCH BUFFER FREE YET...          X4106000
         $BF   $COMRETA            IF NOT, RETURN TO COMMUTATOR.        X4108000
*                                                                       X4110000
*                                                                       X4112000
*              2-FOR-1 - CREATE SECOND CARD OF TWO.                     X4114000
*                                                                       X4116000
*                                                                       X4118000
         $SBN  (HCFLG,HCR),HFPBB   SHOW CARD READY TO PUNCH.            X4120000
         $L    R1,(HCPUB,HCR)      THEN POINT TO PUNCH BUFFER.          X4122000
         $MVC  (79,R1),(FB40SV,FBR),40  MOVE LAST 40 COLUMNS TO BUFFER. X4124000
         $MVI  (80,R1),C'2'        MARK THIS CARD AS SECOND CARD.       X4126000
         $B    PUEXPAND            EXPAND CARD IN PUNCH BUFFER.         X4128000
         $B    PUN                 THEN RETURN TO NORMAL PROCESSING.    X4130000
         EJECT                                                          X4132000
.PUEOF   ANOP                      *                                    X4134000
.NOMFCUJ ANOP                                                           X4136000
*                                                                       X4138000
*              LOGICAL END-OF-FILE.                                     X4140000
*                                                                       X4142000
PUEOF    $SBN  (HCFLG,HCR),HFEOF   SHOW LOGICAL EOF.                    X4144000
         $TBF  (FBEWF,FBR),EWFPOST HAS HASP ASKED PERMISSION AGAIN...   X4146000
         $BT   PUPERM              YES.  GO GIVE HASP PERMISSION.       X4148000
         $B    $PUNCH              NO.  WAIT TILL HASP ASKS.            X4150000
         AIF   (NOT &S3OBJDK).PUXPAND  *                                X4152000
*                                                                       X4154000
*                                                                       X4156000
*              EXPAND CARDS TO TWO-FOR-ONE.                             X4158000
*                                                                       X4160000
*                                                                       X4162000
PUEXPAND $ST   ARR,PUXRET+3        SAVE RETURN ADDRESS.                 X4164000
         $ST   R2,PUX90+3          SAVE REGISTER 2.                     X4166000
         $LA   R2,(0,R1)           LOAD R2 FROM R1.                     X4168000
         $MVI  PUEXCT,40           SET COUNT TO 40.                     X4170000
PUX20    $MNZ  (0,R2),(40,R1)      SET NUMERIC PORTION OF BYTE.         X4172000
         $SBN  (0,R2),X'F0'        MAKE ZONE BITS ALL 1.                X4174000
         $CLI  (0,R2),C'9'         IF F0 THROUGH F9, IT'S               X4176000
         $JNH  PUX30               CORRECT AS IS.                       X4178000
         $SLC  (0,R2),FIFTY7       MAKE FA THRU FF INTO C1 THRU C6.     X4180000
PUX30    $MNN  (1,R2),(40,R1)      SET NUMERIC PORTION OF 2D BYTE.      X4182000
         $SBN  (1,R2),X'F0'        SET ALL ZONE BITS ON.                X4184000
         $CLI  (1,R2),C'9'         IF F0 THRU F9,                       X4186000
         $JNH  PUX40               IT'S ALL RIGHT AS IS.                X4188000
         $SLC  (1,R2),FIFTY7       OTHERWISE MAKE IT C1 THROUGH C6.     X4190000
PUX40    $LA   R2,(2,R2)           POINT TO 2D NEXT SINK BYTE           X4192000
         $LA   R1,(1,R1)           AND TO NEXT SOURCE BYTE.             X4194000
         $SLC  PUEXCT,ONE          IF COUNT NOT EXPIRED,                X4196000
         $BNE  PUX20               LOOP TO DO THE REST.                 X4198000
PUX90    $LA   R2,*-*              OTHERWISE RESTORE REGISTER 2         X4200000
PUXRET   $B    *-*                 AND RETURN TO THE CALLER.            X4202000
PUEXCT   $DS   X                   LOOP COUNTER BYTE.                   X4204000
.PUXPAND $DROP HCR                 DROP BASE FOR HOPPER CONTROL DSECT.  X4206000
         AIF   (NOT &S35424).NOMFCUK                                    X4208000
PUJOBNR  $DC   C'**********  JOB 0000  **********'  JOB SEPARATOR CARD. X4210000
.NOMFCUK ANOP                                                           X4212000
         AIF   (NOT &S35471).NO5471  *                                  X4214000
         TITLE 'CONSOLE CONTROL AREA FOR 5471 PRINTER/KEYBOARD'         X4216000
CCR      EQU   R1                                                       X4218000
CCA      EQU   *                                                        X4220000
         $USING CCA,CCR                                                 X4222000
*                                                                     * X4224000
*********************************************************************** X4226000
*                                                                     * X4228000
*              CONSOLE CONTROL AREA                                   * X4230000
*                                                                     * X4232000
*********************************************************************** X4234000
*                                                                     * X4236000
CCFLG    DC    YL1(CFOUT+CFPBSY)   FLAG BYTE.                           X4238000
CFPBSY   EQU   128                   PRINTER IS BUSY.                   X4240000
CFPREQ   EQU   64                    REQUEST TO SIO ON PRINTER.         X4242000
CFKREQ   EQU   32                    REQUEST TO SIO ON KEYBOARD.        X4244000
CFCREQ   EQU   16                    REQUEST TO CARRIAGE-RETURN.        X4246000
CFOUT    EQU   8                     OUTPUT IS BEING PROCESSED.         X4248000
CFREQ    EQU   4                     REQUEST-PENDING LIGHT IS LIT.      X4250000
CFINP    EQU   2                     PROCEED LIGHT IS LIT.              X4252000
CFACT    EQU   1                     5471 IS AVAILABLE.                 X4254000
*                                                                     * X4256000
*********************************************************************** X4258000
*                                                                     * X4260000
*              KEYBOARD SECTION                                       * X4262000
*                                                                     * X4264000
*********************************************************************** X4266000
*                                                                     * X4268000
CCKSN1   $DC   YL2(0)              KEYBOARD STATUS BYTES.               X4270000
CCKSN0   EQU   CCKSN1-1                                                 X4272000
CCKCMD   DC    X'0'                COMMAND ASSOC WITH CFKREQ.           X4274000
CCKD     DC    CL120'COMMUNICATION ESTABLISHED'                         X4276000
CCKC     $DC   YL2(CCKD)           POINTER TO CURRENT BYTE.             X4278000
CCKF     $DC   YL2(CCKD)           POINTER TO FIRST BYTE.               X4280000
CCKL     $DC   YL2(CCKD+L'CCKD-1)  POINTER TO LAST AVL BYTE.            X4282000
*                                                                     * X4284000
*********************************************************************** X4286000
*                                                                     * X4288000
*              KEYBOARD COMMANDS                                      * X4290000
*                                                                     * X4292000
*********************************************************************** X4294000
*                                                                     * X4296000
CCKTB    EQU   *              THESE FOUR RESET AND ALLOW PROCEED.       X4298000
         DC    X'05'               ENABLE REQUEST KEY, NO LIGHTS.       X4300000
         DC    X'21'               REQUEST LIGHT, ALL KEYS DISABLED.    X4302000
         DC    X'17'               PROCEED LIGHT, ALL KEYS ENABLED.     X4304000
         DC    X'33'               BOTH LIGHTS, ONLY 'OTHER' KEYS ENB.  X4306000
*                                                                     * X4308000
*********************************************************************** X4310000
*                                                                     * X4312000
*              PRINTER SECTION                                        * X4314000
*                                                                     * X4316000
*********************************************************************** X4318000
*                                                                     * X4320000
CCPSN1   $DC   YL2(0)              PRINTER STATUS BYTES.                X4322000
CCPCMD   DC    X'0'                COMMAND ASSOC WITH CFPREQ.           X4324000
CCPCHAR  DC    X'0'                CHARACTER TO PRINT.                  X4326000
CCPD     EQU   CCKD                PRINTER DATA AREA.                   X4328000
CCPF     EQU   CCKF                POINTER TO FIRST BYTE.               X4330000
CCPC     EQU   CCKC                POINTER TO CURRENT BYTE.             X4332000
CCPL     $DC   YL2(CCPD+25)        POINTER TO LAST+1 BYTE TO PRINT.     X4334000
*                                                                     * X4336000
*********************************************************************** X4338000
*                                                                     * X4340000
*              PRINTER COMMANDS                                       * X4342000
*                                                                     * X4344000
*********************************************************************** X4346000
*                                                                     * X4348000
CCPTB    EQU   *                                                        X4350000
         DC    X'85'               PRINT, ENABLE, AND RESET.            X4352000
         DC    X'45'               CARRIAGE RETURN, ENABLE, AND RESET.  X4354000
*                                                                     * X4356000
*********************************************************************** X4358000
*                                                                     * X4360000
*              MISCELLANEOUS                                          * X4362000
*                                                                     * X4364000
*********************************************************************** X4366000
*                                                                     * X4368000
CCBUF    $DC   YL2(0)              STOLEN-BUFFER POINTER.               X4370000
CCFOUR   $DC   YL2(4)              CONSTANT OF FOUR.                    X4372000
CCMSGP   $DC   YL2(MSGFIRST)       INTERNAL-MESSAGE POINTER.            X4374000
CCM4     $DC   HL2'-4'             CONSTANT OF MINUS 4.                 X4376000
*                                                                     * X4378000
*********************************************************************** X4380000
*                                                                     * X4382000
*              SUBROUTINE TO START INPUT/OUTPUT                       * X4384000
*                                                                     * X4386000
*********************************************************************** X4388000
*                                                                     * X4390000
CCSIOZ   $MVI  (CCSIO2+1,CCR),0    SET TO RESTORE REGISTERS.            X4392000
CCSIO    $ST   ARR,(CCSIOR+3,CCR)  SAVE RETURN ADDRESS.                 X4394000
         $MVC  (CCSIOX+2,CCR),(0,R2)  SET SIO CC-BYTE.                  X4396000
         $SBF  (CCSIOX+1,CCR),8    ASSUME SIO IS FOR KEYBOARD.          X4398000
         $TBF  (0,R2),X'C0'        IS SIO FOR KEYBOARD...               X4400000
         $JT   CCSIO2              JUMP IF SO.                          X4402000
         $SBN  (CCSIOX+1,CCR),8    NO, SIO IS FOR PRINTER.              X4404000
CCSIO1   $LIO  1,1,0,(CCPCHAR+1,CCR)  LOAD CHARACTER FOR PRINTING.      X4406000
         $SBN  (CCFLG,CCR),CFPBSY  SHOW PRINTER BUSY.                   X4408000
CCSIO2   $NOPB (CCRR,CCR)          RESTORE REGISTERS IF SET TO $B.      X4410000
         $MVI  CCSIO2+1,X'80'      RESET $B TO $NOPB.                   X4412000
CCSIOX   $SIO  1,*-*,0,*-*         START THE KEYBOARD OR PRINTER.       X4414000
CCSIOR   $B    *-*                 THEN RETURN TO CALLER.               X4416000
*                                                                     * X4418000
*********************************************************************** X4420000
*                                                                     * X4422000
*              SUBROUTINE TO RESTORE REGISTERS                        * X4424000
*                                                                     * X4426000
*********************************************************************** X4428000
*                                                                     * X4430000
CCRR     $ST   ARR,(CCARR,CCR)     SAVE RETURN ADDRESS.                 X4432000
         $LA   R2,*-*              RESTORE REGISTER 2.                  X4434000
CCR2     EQU   *-1                                                      X4436000
         $L    PSR,(CCPSR,CCR)     RESTORE PROGRAM STATUS REGISTER.     X4438000
         $LA   R1,*-*              RESTORE REGISTER 1.                  X4440000
CCR1     EQU   *-1                                                      X4442000
         $B    *-*                 RETURN TO CALLER.                    X4444000
CCARR    EQU   *-1                                                      X4446000
CCPSR    $DC   YL2(0)              PROGRAM STATUS REGISTER SAVEAREA.    X4448000
*                                                                     * X4450000
*********************************************************************** X4452000
*                                                                     * X4454000
*              SUBROUTINE TO POST CONSOLE PROCESSOR                   * X4456000
*                                                                     * X4458000
*********************************************************************** X4460000
*                                                                     * X4462000
CCPOST   $ST   ARR,(CCPEND+3,CCR)  SAVE RETURN ADDRESS.                 X4464000
         $SBN  (CCFLG,CCR),CFACT   TURN ON THE ACTION BIT.              X4466000
         $POST $FBCON,WORK+EWFPOST POST CONSOLE PROCESSOR.              X4468000
CCPEND   $B    *-*                 RETURN TO CALLER.                    X4470000
*                                                                     * X4472000
*********************************************************************** X4474000
*                                                                     * X4476000
*              START-UP-THE-KEYBOARD ROUTINE                          * X4478000
*                                                                     * X4480000
*********************************************************************** X4482000
*                                                                     * X4484000
CIKGO    $LA   R2,(CCKTB,CCR)      POINT TO TABLE OF KEYBOARD COMMANDS, X4486000
CIKCMD   $LA   R2,(*-*,R2)         AND SELECT THE CORRECT ONE.          X4488000
         $B    (CCSIOZ,CCR)        THEN GO START THE KEYBOARD.          X4490000
*      LABEL CINT MUST FOLLOW IMMEDIATELY                               X4492000
         TITLE 'CONSOLE INTERRUPT ROUTINE FOR 5471 PRINTER/KEYBOARD'    X4494000
*                                                                     * X4496000
*********************************************************************** X4498000
*                                                                     * X4500000
*              CONTROL STARTS HERE FOR ALL 5471 INTERRUPTS            * X4502000
*                                                                     * X4504000
*********************************************************************** X4506000
*                                                                     * X4508000
CINT     $ST   R1,CCR1             SAVE REGISTER 1.                     X4510000
         $LA   R1,CCA              SET CONTROL AREA ADDRESSABILITY.     X4512000
         $ST   R2,(CCR2,CCR)       SAVE REGISTER 2.                     X4514000
         $ST   PSR,(CCPSR,CCR)     SAVE PROGRAM STATUS REGISTER.        X4516000
         $JF   *+1                 RESET TEST-FALSE INDICATOR.          X4518000
         $SNS  1,0,1,(CCKSN1,CCR)  READ KEYBOARD INFORMATION.           X4520000
         $TBF  (CIKCMD+2,CCR),1    IF REQ KEY INTERRUPTS ARE ENABLED    X4522000
         $TBN  (CCKSN1,CCR),X'80'  AND THIS IS A REQUEST,               X4524000
         $JT   CIRQUEST            GO TAKE CARE OF IT.                  X4526000
         $TBN  (CIKCMD+2,CCR),2    IF OTHER KEY INTERRUPTS ARE ENABLED  X4528000
         $TBN  (CCKSN1,CCR),X'40'  AND THIS IS END/CANCEL,              X4530000
         $JT   CICANCEL            GO TAKE CARE OF IT.                  X4532000
         $TBN  (CIKCMD+2,CCR),2    IF OTHER KEY INTERRUPTS ARE DISABLED X4534000
         $TBN  (CCKSN1,CCR),8      OR THIS IS NOT RETURN/DATA,          X4536000
         $JF   CIPRT               IT MUST BE A PRINTER INTERRUPT.      X4538000
         $TBN  (CCKSN1,CCR),4      IF THIS IS THE RETURN KEY,           X4540000
         $JT   CIEND               TREAT IT LIKE THE END KEY.           X4542000
*                                                                     * X4544000
*********************************************************************** X4546000
*                                                                     * X4548000
*              DATA KEY INTERRUPT                                     * X4550000
*                                                                     * X4552000
*********************************************************************** X4554000
*                                                                     * X4556000
         $MVC  (CCPCHAR,CCR),(CCKSN0,CCR)  SET CHARACTER FOR PRINTING.  X4558000
         $LA   R2,(CCPTB,CCR)      SET SIO ARGUMENT.                    X4560000
         $B    (CCSIO,CCR)         GO START PRINTING.                   X4562000
         $L    R2,(CCKC,CCR)       POINT TO PLACE IN BUFFER.            X4564000
         $MVC  (0,R2),(CCPCHAR,CCR)  MOVE CHARACTER TO BUFFER.          X4566000
         $LA   R2,(1,R2)           UP PLACE POINTER BY 1                X4568000
         $ST   R2,(CCKC,CCR)       AND SAVE IT.                         X4570000
         $CLC  (CCKC,CCR),(CCKL,CCR),2  ARE WE OUT OF BUFFER...         X4572000
         $BNH  (CIKGO,CCR)         IF NOT, GO START KEYBOARD.           X4574000
         $SBN  (CCFLG,CCR),CFCREQ  REQUEST CARRIAGE RETURN.             X4576000
         $J    CIEND1              SKIP IMMEDIATE CARRIAGE RETURN.      X4578000
*                                                                     * X4580000
*********************************************************************** X4582000
*                                                                     * X4584000
*              CANCEL KEY INTERRUPT                                   * X4586000
*                                                                     * X4588000
*********************************************************************** X4590000
*                                                                     * X4592000
CICANCEL EQU   *                                                        X4594000
         $TBN  (CCKSN1,CCR),X'10'  END/CANCEL.  IS IT END KEY...        X4596000
         $JT   CIEND               JUMP IF SO.  OTHERWISE CANCEL.       X4598000
         $MVI  (CCPCHAR,CCR),C'*'  SHOW CANCEL WITH ASTERISK.           X4600000
         $LA   R2,(CCPTB,CCR)      SET SIO ARGUMENT.                    X4602000
         $B    (CCSIO,CCR)         GO PRINT ASTERISK.                   X4604000
         $SBN  (CCFLG,CCR),CFCREQ  REQUEST CARRIAGE RETURN.             X4606000
         $MVC  (CCKC,CCR),(CCKF,CCR),2  RESET BUFFER POINTER.           X4608000
         $B    (CIKGO,CCR)         THEN GO START THE KEYBOARD.          X4610000
*                                                                     * X4612000
*********************************************************************** X4614000
*                                                                     * X4616000
*              END KEY OR RETURN KEY INTERRUPT                        * X4618000
*                                                                     * X4620000
*********************************************************************** X4622000
*                                                                     * X4624000
CIEND    $LA   R2,(CCPTB+1,CCR)    SET SIO ARG FOR CARRIAGE RETURN.     X4626000
         $B    (CCSIO,CCR)         GO START CARRIAGE RETURN.            X4628000
CIEND1   $SBF  (CIKCMD+2,CCR),2    RESET PROCEED IN KEYBOARD COMMAND,   X4630000
         $B    (CCPOST,CCR)        POST CONSOLE PROCESSOR,              X4632000
         $B    (CIKGO,CCR)         AND GO START THE KEYBOARD.           X4634000
*                                                                     * X4636000
*********************************************************************** X4638000
*                                                                     * X4640000
*              REQUEST KEY INTERRUPT                                  * X4642000
*                                                                     * X4644000
*********************************************************************** X4646000
*                                                                     * X4648000
CIRQUEST $SBN  (CIKCMD+2,CCR),1    CHANGE THE KEYBOARD COMMAND.         X4650000
         $SBN  (CCFLG,CCR),CFREQ   SHOW REQUEST TO CONSOLE PROCESSOR.   X4652000
         $TBF  (CCFLG,CCR),CFINP+CFOUT  IF NOTHING IS HAPPENING,        X4654000
         $BT   (CCPOST,CCR)        POST THE CONSOLE PROCESSOR.          X4656000
         $B    (CIKGO,CCR)         ANYWAY, GO START THE KEYBOARD.       X4658000
*                                                                     * X4660000
*********************************************************************** X4662000
*                                                                     * X4664000
*              INTERRUPT FROM THE PRINTER                             * X4666000
*                                                                     * X4668000
*********************************************************************** X4670000
*                                                                     * X4672000
CIPRT    $SBF  (CCFLG,CCR),CFPBSY  RESET PRINTER-BUSY BIT.              X4674000
CIP1     $TBN  (CCFLG,CCR),CFCREQ  IS CARRIAGE RETURN REQUEST PENDING.. X4676000
         $JT   CIP3                YES.  GO START CARRIAGE RETURN.      X4678000
CIP2     $TBN  (CCFLG,CCR),CFOUT   IS THE PRINTER PROCESSING OUTPUT...  X4680000
         $JF   CIP4                JUMP IF NOT.                         X4682000
         $L    R2,(CCPC,CCR)       YES.  POINT TO PLACE IN BUFFER.      X4684000
         $LA   R2,(1,R2)           UP THE POINTER BY 1,                 X4686000
         $ST   R2,(CCPC,CCR)       AND SAVE IT.                         X4688000
         $MVC  (CCPCHAR,CCR),(0,R2)  MOVE THE CHARACTER FOR PRINTING.   X4690000
         $LA   R2,(CCPTB,CCR)      SET SIO ARGUMENT TO PRINT.           X4692000
         $CLC  (CCPC,CCR),(CCPL,CCR),2  IS THE OUTPUT COMPLETE...       X4694000
         $JL   CIPSIO              JUMP IF NOT TO START PRINTER.        X4696000
         $SBF  (CCFLG,CCR),CFOUT   YES.  RESET OUTPUT FLAG              X4698000
         $B    (CCPOST,CCR)        AND POST CONSOLE PROCESSOR.          X4700000
CIP3     $SBF  (CCFLG,CCR),CFCREQ  RESET CARRIAGE-RETURN BIT, AND       X4702000
         $LA   R2,(CCPTB+1,CCR)    SET SIO ARG FOR CARRIAGE RETURN.     X4704000
CIPSIO   $B    (CCSIOZ,CCR)        GO START THE PRINTER.                X4706000
         $B    CINT                ON INTERRUPT, GO TO THE TOP.         X4708000
CIP4     $B    (CCRR,CCR)          RESTORE REGISTERS,                   X4710000
         $SIO  1,1,0,1             RESET AND DISABLE PRINTER,           X4712000
         $B    CINT                AND GO TO THE TOP ON INTERRUPT.      X4714000
         TITLE 'CONSOLE PROCESSOR FOR 5471 PRINTER/KEYBOARD'            X4716000
*                                                                     * X4718000
*********************************************************************** X4720000
*                                                                     * X4722000
*              5471 CONSOLE PROCESSOR                                 * X4724000
*                                                                     * X4726000
*********************************************************************** X4728000
*                                                                     * X4730000
$CON     $ST   IAR,(FBENT,FBR)     STORE LOC FOR NON-PROCESS EXIT.      X4732000
         $TBF  (FBEWF,FBR),EWFPOST HAVE WE BEEN POSTED...               X4734000
         $BF   $COMRETA            IF NOT, NON-PROCESS-EXIT.            X4736000
         $SBN  (FBEWF,FBR),EWFPOST OTHERWISE RESET POST FLAG.           X4738000
*                                                                     * X4740000
*********************************************************************** X4742000
*                                                                     * X4744000
*              COMPLETED INPUT IS PROCESSED HERE.                     * X4746000
*                                                                     * X4748000
*********************************************************************** X4750000
*                                                                     * X4752000
         $TBN  (CCFLG,CCR),CFACT+CFINP  HAS 5471 JUST COMPLETED INPUT.. X4754000
         $JF   CONREQ              JUMP IF NOT.                         X4756000
         $SBF  (CCFLG,CCR),CFINP   YES.  RESET INPUT FLAG.              X4758000
         $L    R1,(CCBUF,CCR)      REPLACE STOLEN                       X4760000
         $MVC  (0,R1),$MLPOOL,2      MULTILEAVING BUFFER                X4762000
         $ST   R1,$MLPOOL              IN BUFFER POOL.                  X4764000
         $L    R1,(FBREG1,FBR)     RESTORE REGISTER 1.                  X4766000
         $SLC  (CCKC,CCR),(CCKF,CCR),2  COMPUTE INPUT LENGTH.           X4768000
         $JZ   CONREQ              IF NO INPUT, JUMP.                   X4770000
         $MVC  (FBAREA,FBR),(CCKF,CCR),2  SET COMPRESSION SOURCE AREA.  X4772000
         $MVC  (FBCLNG,FBR),(CCKC,CCR),2  SET LENGTH TO COMPRESS.       X4774000
         $MVI  (FBSRCB,FBR),X'92'  SET RCB TO SEND.                     X4776000
         $B    $CMPR               COMPRESS AND PUT INTO BUFFER.        X4778000
         $B    $BFLUSH             FLUSH THE BUFFER.                    X4780000
         $LA   CCR,CCA             RESTORE R1.                          X4782000
*                                                                     * X4784000
*********************************************************************** X4786000
*                                                                     * X4788000
*              REQUEST FOR INPUT IS PROCESSED HERE.                   * X4790000
*                                                                     * X4792000
*********************************************************************** X4794000
*                                                                     * X4796000
CONREQ   $TBN  (CCFLG,CCR),CFREQ+CFACT  IS THE REQUEST LIGHT LIT...     X4798000
         $JF   CONOUT              JUMP IF NOT.                         X4800000
         $CLI  $MLPOOL-1,0         CAN WE STEAL A TELEPROCESSING BUFFER X4802000
         $JE   CONOUT              JUMP IF NOT.                         X4804000
         $L    R1,$MLPOOL          YES.  STEAL A                        X4806000
         $MVC  $MLPOOL,(0,R1),2      TELEPROCESSING BUFFER              X4808000
         $ST   R1,CCBUF                AND RESTORE                      X4810000
         $LA   R1,CCA                    REGISTER 1.                    X4812000
         $SBF  (CCFLG,CCR),CFREQ+CFACT  RESET REQUEST AND ACTION FLAGS. X4814000
         $SBN  (CCFLG,CCR),CFINP   SET INPUT FLAG.                      X4816000
         $MVC  (CCKC,CCR),(CCKF,CCR),2  RESET 5471 BUFFER POINTER.      X4818000
         $SIO  1,0,0,0             DISABLE THE KEYBOARD.                X4820000
         $MVI  (CIKCMD+2,CCR),2    SET COMMAND TO PROCEED.              X4822000
         $SIO  1,0,0,X'17'         ENABLE ALL KEYS, SHOW PROCEED LIGHT. X4824000
*                                                                     * X4826000
*********************************************************************** X4828000
*                                                                     * X4830000
*              CHECK IF WE CAN START OUTPUT NOW.                      * X4832000
*                                                                     * X4834000
*********************************************************************** X4836000
*                                                                     * X4838000
CONOUT   $TBF  (CCFLG,CCR),CFOUT+CFINP  IS ANYTHING HAPPENING...        X4840000
         $JF   CONEND              YES.  RETURN TO THE TOP.             X4842000
         $SNS  1,1,1,(CCPSN1,CCR)  GET 5471 PRINTER STATUS.             X4844000
         $TBN  (CCPSN1,CCR),4      IS END-OF-FORMS BIT ON...            X4846000
         $JT   CONEND              YES.  RETURN TO THE TOP.             X4848000
         $CLC  MSGPLACE,(CCMSGP,CCR),2  ARE WE UP TO DATE ON MESSAGES.. X4850000
         $JE   CNOMSG              JUMP IF WE ARE.                      X4852000
*                                                                     * X4854000
*********************************************************************** X4856000
*                                                                     * X4858000
*              PROCESS INTERNAL (8-CHARACTER) MESSAGES HERE           * X4860000
*                                                                     * X4862000
*********************************************************************** X4864000
*                                                                     * X4866000
         $MVI  (CCPD+7,CCR),C'0'   SET 1ST 8 DATA BYTES                 X4868000
         $MVC  (CCPD+6,CCR),(CCPD+7,CCR),7  TO CHARACTER '0'.           X4870000
         $ALC  (CCMSGP,CCR),FOUR,2 UP MESSAGE POINTER BY 4.             X4872000
         $CLC  (CCMSGP,CCR),AMSGLAST,2  IS POINTER PAST END OF MESSAGES X4874000
         $JNH  *+1+5               JUMP IF NOT.                         X4876000
         $MVC  (CCMSGP,CCR),AMSGFRST,2  YES.  RESET THE POINTER.        X4878000
         $L    R2,(CCMSGP,CCR)     SET SOURCE REG TO LAST BYTE PREV MSG X4880000
         $A    R2,(CCM4,CCR)       BACK UP TO THE RIGHT MESSAGE.        X4882000
         $LA   R1,(CCPD,CCR)       AND SINK REGISTER TO START OF BUF.   X4884000
         $MVI  CMSGK,4             SET LOOP COUNT TO 4.                 X4886000
CMSGL    $LA   R2,(1,R2)           POINT TO NEXT SOURCE BYTE.           X4888000
         $MNZ  (0,R1),(0,R2)       MOVE ZONE FROM SOURCE TO SINK.       X4890000
         $MNN  (1,R1),(0,R2)       MOVE NUM FROM SOURCE TO SINK+1.      X4892000
         $CLI  (0,R1),C'9'         IS SINK BYTE NUMERIC...              X4894000
         $JNH  CML1                JUMP IF YES.                         X4896000
         $SLC  (0,R1),FIFTY7       NO.  MAKE IT A THROUGH F.            X4898000
CML1     $CLI  (1,R1),C'9'         SAME FOR                             X4900000
         $JNH  CML2                  THE SECOND                         X4902000
         $SLC  (1,R1),FIFTY7           SINK BYTE.                       X4904000
CML2     $LA   R1,(2,R1)           POINT TO NEXT PAIR OF SINK BYTES.    X4906000
         $SLC  CMSGK,ONE           REDUCE COUNTER BY 1.                 X4908000
         $BNZ  CMSGL               LOOP 4 TIMES.                        X4910000
         $ST   R1,CCPL             SET LOC OF LAST+1 SINK BYTE.         X4912000
         $LA   R1,CCA              RESTORE REGISTER 1 AS BASE.          X4914000
         $LA   R2,$FBCON           RESTORE REGISTER 2 AS FB POINTER.    X4916000
         $J    CONMSG              AND THEN START PRINTING.             X4918000
CMSGK    DS    X                   LOOP COUNTER.                        X4920000
*                                                                     * X4922000
*********************************************************************** X4924000
*                                                                     * X4926000
*              PROCESS MESSAGES FROM HASP HERE                        * X4928000
*                                                                     * X4930000
*********************************************************************** X4932000
*                                                                     * X4934000
CNOMSG   $CLI  (FBBUF-1,FBR),0     IS THERE A MESSAGE FROM HASP...      X4936000
         $JE   CONEND              JUMP IF NOT.                         X4938000
         $MVC  (FBAREA,FBR),(CCPF,CCR),2  SHOW SINK AREA ADDRESS.       X4940000
         $B    $DCOM               DECOMPRESS A MESSAGE.                X4942000
         $NOPJ *+1                 $DCOM RETURNS TO *+3 IF NOT EOF.     X4944000
         $MVC  (CCPL,CCR),(FBAREA,FBR),2  SAVE ADR OF LAST+1 BYTE.      X4946000
*                                                                     * X4948000
*********************************************************************** X4950000
*                                                                     * X4952000
*              START PRINTING EITHER MESSAGE TYPE HERE.               * X4954000
*                                                                     * X4956000
*********************************************************************** X4958000
*                                                                     * X4960000
CONMSG   $ST   IAR,(FBENT,FBR)     NON-PROCESS EXIT                     X4962000
         $TBN  (CCFLG,CCR),CFPBSY    TILL PRINTER IS                    X4964000
         $BT   $COMRETA                NOT BUSY.                        X4966000
         $MVC  (CCPC,CCR),(CCPF,CCR),2  SHOW MESSAGE STARTING ADDRESS.  X4968000
         $SBN  (CCFLG,CCR),CFOUT+CFPBSY  THEN SET OUTPUT AND PRINTER    X4970000
         $SBF  (CCFLG,CCR),CFACT   BUSY FLAGS, RESET ACTION FLAG.       X4972000
         $LIO  1,1,0,(CCPD+1,CCR)  LOAD FIRST CHARACTER FOR PRINTING.   X4974000
         $SIO  1,1,0,X'85'         AND START THE PRINTER.               X4976000
CONEND   $B    $CON                THEN RETURN TO THE TOP.              X4978000
         $DROP CCR                 DISESTABLISH ADDRESSABILITY.         X4980000
         AGO   .NOCONP             *                                    X4982000
.NO5471  AIF   (NOT &S35475).NO5475  *                                  X4984000
         TITLE '5475 DATA ENTRY KEYBOARD CONTROL AREA'                  X4986000
*                                                                     * X4988000
*********************************************************************** X4990000
*                                                                     * X4992000
*              5475 DATA ENTRY KEYBOARD CONTROL AREA                  * X4994000
*                                                                     * X4996000
*********************************************************************** X4998000
*                                                                     * X5000000
CCA      EQU   *                   START OF CONTROL AREA.               X5002000
CCR      EQU   R1                  BASE REGISTER FOR CONTROL AREA.      X5004000
         $USING CCA,CCR            ESTABLISH ADDRESSABILITY.            X5006000
CCR1     $DS   YL2                 SAVE AREA FOR REGISTER 1.            X5008000
CCR2     $DS   YL2                 SAVE AREA FOR REGISTER 2.            X5010000
CCPSR    $DS   YL2                 SAVE AREA FOR PROGRAM STATUS REG.    X5012000
CCKF     $DC   YL2(CCKD)           POINTER TO 1ST BYTE OF BUFFER.       X5014000
CCKL     $DC   YL2(CCKD+L'CCKD)    POINTER TO LAST+1 BYTE OF BUFFER.    X5016000
CCKC     $DC   YL2(CCKD)           POINTER TO CURRENT BYTE OF BUFFER.   X5018000
CCDC     $DC   XL2'EE24'           CURRENT DISPLAY INDICATORS.          X5020000
CCDF     $DC   XL2'EE24'           INITIAL DISPLAY INDICATORS.          X5022000
CCDT     DC    X'EE24BAB674D6DEA4FEF6'  DISPLAY INDICATORS TABLE.       X5024000
CCEC     $DC   C'01'               CURRENT EBCDIC INDICATORS.           X5026000
CCEF     $DC   C'01'               INITIAL DISPLAY INDICATORS.          X5028000
CCKD     DC    CL120' '            BUFFER.                              X5030000
CCS1     $DS   YL2                 SENSE BYTES FOR N = 1.               X5032000
CCS2     $DS   YL2                 SENSE BYTES FOR N = 2.               X5034000
         TITLE '5475 DATA ENTRY KEYBOARD INTERRUPT HANDLER'             X5036000
*                                                                     * X5038000
*********************************************************************** X5040000
*                                                                     * X5042000
*              5475 DATA ENTRY KEYBOARD INTERRUPT HANDLER             * X5044000
*                                                                     * X5046000
*********************************************************************** X5048000
*                                                                     * X5050000
CINT     $ST   R1,CCR1             SAVE REGISTER 1.                     X5052000
         $LA   R1,CCA              SET ADR OF CONSOLE CONTROL AREA.     X5054000
         $ST   R2,(CCR2,CCR)       SAVE REGISTER 2                      X5056000
         $ST   PSR,(CCPSR,CCR)     AND PROGRAM STATUS REGISTER.         X5058000
         $JF   *+1                 RESET TEST-FALSE INDICATOR.          X5060000
         $SNS  1,0,1,CCS1          GET FOUR                             X5062000
         $SNS  1,0,2,CCS2            STATUS BYTES.                      X5064000
         $TBN  (CCS2,CCR),1        IS THIS A FUNCTION KEY INTERRUPT...  X5066000
         $JT   CIFUNC              JUMP IF SO.                          X5068000
         $TBN  (CCS1,CCR),1        IS THIS A DATA KEY INTERRUPT...      X5070000
         $JF   CIERROR             IF MULTI-PUNCH OR NONE, ERROR.       X5072000
*                                                                     * X5074000
*********************************************************************** X5076000
*                                                                     * X5078000
*              DATA KEY INTERRUPT                                     * X5080000
*                                                                     * X5082000
*********************************************************************** X5084000
*                                                                     * X5086000
         $TBF  (CCS1,CCR),4        IF MULTI-PUNCH TOO,                  X5088000
         $TBF  CISIO+2,X'20'       OR IF THE ERROR LIGHT WAS ON,        X5090000
         $JF   CIERROR             SHOW AN ERROR.                       X5092000
         $L    R2,(CCKC,CCR)       GET POINTER TO CURRENT CHARACTER.    X5094000
         $MVC  (0,R2),(CCS1-1,CCR) MOVE KEYED DATA TO IT.               X5096000
         $LA   R2,(1,R2)           POINT TO NEXT CHARACTER.             X5098000
         $ST   R2,(CCKC,CCR)       SAVE THE POINTER.                    X5100000
         $CLC  (CCKC,CCR),(CCKL,CCR),2  ARE WE AT BUFFER END...         X5102000
         $JNL  CIEND               JUMP IF SO.                          X5104000
         DC    X'5601',YL2(CCEC-CCA,CCEF-CCA) $AZ CCEC,CCEF,2           X5106000
*                                  ADD ONE TO EBCDIC COUNTER.           X5108000
         $MNN  CID1+3,(CCEC-1,CCR)  SET MVC FOR LEFT DISPLAY.           X5110000
         $MNN  CID2+3,(CCEC,CCR)  SET MVC FOR RIGHT DISPLAY.            X5112000
         $LA   R2,(CCDT,CCR)       POINT TO DISPLAY TABLE.              X5114000
CID1     $MVC  (CCDC-1,CCR),(*-*,R2)  SET LEFT DISPLAY CHARACTER.       X5116000
CID2     $MVC  (CCDC,CCR),(*-*,R2)  SET RIGHT DISPLAY CHARACTER.        X5118000
         $J    CIEXIT              RETURN FROM INTERRUPT.               X5120000
*                                                                     * X5122000
*********************************************************************** X5124000
*                                                                     * X5126000
*              FUNCTION KEY INTERRUPT                                 * X5128000
*                                                                     * X5130000
*********************************************************************** X5132000
*                                                                     * X5134000
CIFUNC   $TBF  (CCS1,CCR),5        IF MULTIPCH OR DATA KEY ALSO,        X5136000
         $JF   CIERROR             SHOW AN ERROR.                       X5138000
         $TBN  (CCS2-1,CCR),4      IF NOT ERROR RESET KEY,              X5140000
         $JF   CIF1                SKIP.                                X5142000
         $MVI  CISIO+2,X'4F'       OTHERWISE RESET ERROR.               X5144000
CIF1     $TBN  CISIO+2,X'20'       IF ERROR LIGHT NOT OFF,              X5146000
         $JT   CIERROR             SHOW ERROR AGAIN.                    X5148000
         $TBN  (CCS2-1,CCR),8      IF NOT FIELD ERASE KEY,              X5150000
         $JF   CIF2                JUMP.                                X5152000
*                                                                     * X5154000
*********************************************************************** X5156000
*                                                                     * X5158000
*              FUNCTION KEY -- FIELD ERASE KEY FUNCTION               * X5160000
*                                                                     * X5162000
*********************************************************************** X5164000
*                                                                     * X5166000
         $MVC  (CCEC,CCR),(CCEF,CCR),2  REFRESH EBCDIC COUNTER.         X5168000
         $MVC  (CCDC,CCR),(CCDF,CCR),2  REFRESH DISPLAY COUNTER.        X5170000
         $MVI  (CCKD+119,CCR),C' '  SET INPUT BUFFER                    X5172000
         $MVC  (CCKD+118,CCR),(CCKD+119,CCR),119   TO BLANKS.           X5174000
         $MVC  (CCKC,CCR),(CCKF,CCR),2  REFRESH INPUT BUFFER POINTER.   X5176000
         $J    CIEXIT              EXIT FROM INTERRUPT.                 X5178000
*                                                                     * X5180000
*********************************************************************** X5182000
*                                                                     * X5184000
*              FUNCTION KEY -- RELEASE KEY FUNCTION                   * X5186000
*                                                                     * X5188000
*********************************************************************** X5190000
*                                                                     * X5192000
CIF2     $TBN  (CCS2-1,CCR),16     IF NOT RELEASE KEY,                  X5194000
         $JF   CIEXIT              JUMP.                                X5196000
CIEND    $SBF  $FBCON+FBEWF-FBD,EWFWORK  POST $FBCON FOR WORK.          X5198000
         $MVI  CISIO+2,9           SET SIO TO DISABLE KEYBOARD.         X5200000
         $J    CIEXIT              GO EXIT.                             X5202000
*                                                                     * X5204000
*********************************************************************** X5206000
*                                                                     * X5208000
*              LIGHT THE ERROR LIGHT                                  * X5210000
*                                                                     * X5212000
*********************************************************************** X5214000
*                                                                     * X5216000
CIERROR  $MVI  CISIO+2,X'2B'       SET ERROR LIGHT, LOCK DATA KEYS.     X5218000
*                                                                     * X5220000
*********************************************************************** X5222000
*                                                                     * X5224000
*              EXIT FROM INTERRUPT ROUTINE                            * X5226000
*                                                                     * X5228000
*********************************************************************** X5230000
*                                                                     * X5232000
CIEXIT   $LIO  1,0,0,(CCDC,CCR)    SET DISPLAY INDICATORS.              X5234000
         $L    R2,(CCR2,CCR)       RESTORE R2.                          X5236000
         $L    PSR,(CCPSR,CCR)     RESTORE PSR.                         X5238000
         $L    R1,(CCR1,CCR)       RESTORE R1.                          X5240000
CISIO    $SIO  1,0,0,X'4F'         START THE KEYBOARD.                  X5242000
         $B    CINT                BRANCH ON NEXT INTERRUPT.            X5244000
         TITLE '5475 DATA ENTRY KEYBOARD INPUT PROCESSOR'               X5246000
*                                                                     * X5248000
*********************************************************************** X5250000
*                                                                     * X5252000
*              5475 DATA ENTRY KEYBOARD INPUT PROCESSOR               * X5254000
*                                                                     * X5256000
*********************************************************************** X5258000
*                                                                     * X5260000
$CON     $WAIT WORK                WAIT FOR WORK.                       X5262000
         $SLC  (CCKC,CCR),(CCKF,CCR),2  COMPUTE INPUT LENGTH.           X5264000
         $JZ   CONEND              IF NO INPUT, JUMP.                   X5266000
         $MVC  (FBAREA,FBR),(CCKF,CCR),2  SET COMPRESSION SOURCE AREA.  X5268000
         $MVC  (FBCLNG,FBR),(CCKC,CCR),2   SET LENGTH TO COMPRESS.      X5270000
         $MVI  (FBSRCB,FBR),X'92'  SET RCB TO SEND.                     X5272000
         $B    $CMPR               COMPRESS AND PUT INTO BUFFER.        X5274000
         $B    $BFLUSH             FLUSH THE BUFFER.                    X5276000
         $LA   CCR,CCA             RESTORE R1.                          X5278000
CONEND   $MVC  (CCEC,CCR),(CCEF,CCR),2  REFRESH EBCDIC COUNTER.         X5280000
         $MVC  (CCDC,CCR),(CCDF,CCR),2  REFRESH DISPLAY COUNTER.        X5282000
         $MVC  (CCKC,CCR),(CCKF,CCR),2   REFRESH INPUT BUFFER POINTER.  X5284000
         $MVI  CISIO+2,X'4F'       REFRESH SIO.                         X5286000
         $LIO  1,0,0,ZERO          DON'T BURN OUT THE '01' LIGHTS.      X5288000
         $SIO  1,0,0,X'4F'         UNLOCK THE KEYBOARD.                 X5290000
         $B    $CON                GO WAIT FOR NEXT MESSAGE.            X5292000
         $DROP CCR                                                      X5294000
.NO5475  AIF   (&PRTCONS NE 1 AND &PRTCONS NE 2).NOCONP                 X5296000
         TITLE 'CONSOLE MESSAGE SUPPORT FOR 5203 PRINTER'               X5298000
         $USING PCA,PCR            ESTABLISH ADDRESSABILITY             X5300000
$CONP    $WAIT WORK                WAIT FOR BUFFERS OR LOCAL MESSAGES.  X5302000
CP00     $TBN  (PCFLG,PCR),PFASG   IS PRINTER ASSIGNED...               X5304000
         $JF   CP10                JUMP IF NOT.                         X5306000
         AIF   (&PRTCONS EQ 1).CP2 *                                    X5308000
CP01     $CLI  (FBBUF-1,FBR),0     IS A BUFFER QUEUED...                X5310000
         $BE   $CONP               EXIT IF NOT.                         X5312000
         $B    $FREEBUF            YES.  FREE THE BUFFER                X5314000
         $B    CP01                AND CHECK FOR MORE BUFFERS.          X5316000
         AGO   .CP3                *                                    X5318000
.CP2     $CLC  (FBBCT,FBR),(FBBMX,FBR)  YES.  SHOULD WE FORCE MESSAGES  X5320000
         $JNL  CP05                JUMP IF SO.                          X5322000
         $B    $COMRET             OTHERWISE NON-PROCESS-EXIT           X5324000
         $B    CP00                AND TRY AGAIN.                       X5326000
CP05     $B    CPEJECT             EJECT A PAGE ON THE PRINTER.         X5328000
.CP3     ANOP                      *                                    X5330000
CP10     $SBN  FBEWF-FBD+$FBPR1,EWFUNIT  LOCK THE LOGICAL PRINTER.      X5332000
CP20     $B    CPWAIT              WAIT TILL PRINTER ISN'T BUSY.        X5334000
         $MVC  LPDA+131,LPDA+132,132  CLEAR PRINTER DATA AREA.          X5336000
         $CLI  (FBBUF-1,FBR),0     ARE THERE HASP MESSAGES...           X5338000
         $JE   CP30                JUMP IF NOT.                         X5340000
         $MVC  (FBAREA,FBR),(PCDA,PCR),2  YES.  SET PRINT LINE ADDRESS. X5342000
         $B    $DCOM               DECOMPRESS MESSAGE TO PRINT LINE.    X5344000
         $NOPJ *+1                 $DCOM RETURNS TO *+3 IF NOT EOF.     X5346000
         $J    CPPRINT             THEN GO PRINT.                       X5348000
CP30     $CLC  MSGPLACE,CMSGP,2    ARE WE UP TO DATE ON LOCAL MSGS...   X5350000
         $JE   CP40                JUMP IF SO.                          X5352000
         $ALC  CMSGP,FOUR,2        NO.  POINT TO NEXT.                  X5354000
         $CLC  CMSGP,AMSGLAST,2    ARE WE OUT OF RANGE...               X5356000
         $JNH  CP31                JUMP IF NOT.                         X5358000
         $MVC  CMSGP,AMSGFRST,2    YES.  POINT TO START OF CIRCLE.      X5360000
CP31     $L    R1,(PCDA,PCR)       POINT R1 TO PRINT LINE.              X5362000
         $MVI  (7,R1),X'F0'        SET FIRST 8 BYTES                    X5364000
         $MVC  (6,R1),(7,R1),7       TO EBCDIC ZERO.                    X5366000
         $MVI  CPCT,4              SET LOOP COUNT TO 4.                 X5368000
CP32     $LA   R2,MSGFIRST         POINT TO LOW-ORDER MESSAGE BYTE.     X5370000
CMSGP    EQU   CP32+3                                                   X5372000
         $A    R2,MTHREE           LOWER THE PTR TO HI-ORD MSG BYTE.    X5374000
CP33     $MNZ  (0,R1),(0,R2)       SET SINK CHARACTER FROM ZONE.        X5376000
         $CLI  (0,R1),X'FA'        IS IT NUMERIC...                     X5378000
         $JL   CP34                JUMP IF YES.                         X5380000
         $SLC  (0,R1),FIFTY7       NO.  MAKE IT ALPHABETIC.             X5382000
CP34     $MNN  (1,R1),(0,R2)       SET SINK CHARACTER FROM NUMERIC.     X5384000
         $CLI  (1,R1),X'FA'        IS IT NUMERIC...                     X5386000
         $JL   CP35                JUMP IF YES.                         X5388000
         $SLC  (1,R1),FIFTY7       NO.  MAKE IT ALPHABETIC.             X5390000
CP35     $LA   R1,(2,R1)           UP SINK REGISTER BY 2                X5392000
         $LA   R2,(1,R2)           AND SOURCE REGISTER BY 1.            X5394000
         $SLC  CPCT,ONE            REDUCE LOOP COUNT BY 1.              X5396000
         $BNZ  CP33                LOOP IF MORE TO DO.                  X5398000
         $LA   R2,$FBCONP          OTHERWISE RESTORE                    X5400000
         $L    R1,(FBREG1,FBR)     BOTH REGISTERS.                      X5402000
CPPRINT  $MVI  (PCCC,PCR),X'81'    SET SINGLE-SPACE.                    X5404000
         $SBN  (PCFLG,PCR),PFBSY   SHOW PRINT BUFFER BUSY.              X5406000
         $B    CP20                GO WAIT TILL IT'S FREE.              X5408000
*                                                                       X5410000
*              NO MORE WORK.  FREE THE LOGICAL PRINTER.                 X5412000
*                                                                       X5414000
CP40     $TBN  (PCFLG,PCR),PFASG   DID WE INTERRUPT PRINTING...         X5416000
         $BT   CPEJECT             YES.  EJECT A PAGE.                  X5418000
         $POST $FBPR1,UNIT         IN ANY CASE, UNLOCK THE LOGICAL      X5420000
         $B    $CONP               PRINTER AND WAIT TO BE POSTED AGAIN. X5422000
*                                                                     * X5424000
*********************************************************************** X5426000
*                                                                     * X5428000
*              SUBROUTINE TO EJECT A PAGE.                            * X5430000
*                                                                     * X5432000
*********************************************************************** X5434000
*                                                                     * X5436000
CPEJECT  $ST   ARR,CPEJEND+3       SAVE RETURN ADDRESS.                 X5438000
         $B    CPWAIT              WAIT TILL PRINTER IS READY.          X5440000
         $SBN  (PCFLG,PCR),PFBSY   SHOW PRINT BUFFER BUSY.              X5442000
         $MVI  (PCCC,PCR),X'B1'    SPECIFY IMMEDIATE EJECT.             X5444000
         $B    CPWAIT              WAIT TILL IT'S DONE.                 X5446000
CPEJEND  $B    *-*                 THEN RETURN TO THE CALLER.           X5448000
*                                                                     * X5450000
*********************************************************************** X5452000
*                                                                     * X5454000
*              SUBROUTINE TO WAIT TILL PRINT BUFFER IS FREE.          * X5456000
*                                                                     * X5458000
*********************************************************************** X5460000
*                                                                     * X5462000
CPWAIT   $ST   ARR,CPWEND+3        SAVE RETURN ADDRESS.                 X5464000
         $ST   IAR,(FBENT,FBR)     STORE LOCATION.                      X5466000
         $TBF  (PCFLG,PCR),PFBSY   IF PRINT BUFFER ISN'T FREE,          X5468000
         $BF   $COMRETA            NON-PROCESS-EXIT.                    X5470000
CPWEND   $B    *-*                 OTHERWISE RETURN TO CALLER.          X5472000
CPCT     DS    X                   LOOP COUNTER.                        X5474000
MTHREE   $DC   HL2'-3'             CONSTANT OF -3.                      X5476000
         $DROP PCR                 DISESTABLISH ADDRESSABILITY.         X5478000
.NOCONP  ANOP                      *                                    X5480000
         TITLE 'BSCA CONTROL AREA'                                      X5482000
BCA      EQU   *                                                        X5484000
BCR      EQU   R1                                                       X5486000
         $USING BCA,BCR                                                 X5488000
*                                                                       X5490000
*                                                                       X5492000
*              BSCA CONTROL AREA                                        X5494000
*                                                                       X5496000
*                                                                       X5498000
BIRESTOR $ST   ARR,(BIRXIT,BCR)    SAVE RETURN ADDRESS.                 X5500000
         $L    PSR,(BIPSR,BCR)     RESTORE PROGRAM STATUS REGISTER.     X5502000
         $LA   R1,*-*              RESTORE INDEX REGISTER 1.            X5504000
BIR1     EQU   *-1                 SAVE AREA FOR REGISTER 1.            X5506000
         $LA   R2,*-*              RESTORE INDEX REGISTER 2.            X5508000
BIR2     EQU   *-1                 SAVE AREA FOR REGISTER 2.            X5510000
         $B    *-*                 RETURN TO CALLER.                    X5512000
BIRXIT   EQU   *-1                 SAVE AREA FOR RETURN ADDRESS.        X5514000
BIPSR    $DS   YL2                 SAVE AREA FOR PROG STAT REGISTER.    X5516000
*                                                                       X5518000
*                                                                       X5520000
*              FLAG BYTES.                                              X5522000
*                                                                       X5524000
*                                                                       X5526000
BCF1     $DC   X'0'                FLAG BYTE.                           X5528000
BFWAIT   EQU   128                 $BSCA WAIT FLAG.                     X5530000
BFPOST   EQU   64                  $BSCA POST FLAG.                     X5532000
BFCSON   EQU   32                  FCS-BIT-TURNED-ON FLAG.              X5534000
BFCSOFF  EQU   16                  FCS-BIT-TURNED-OFF FLAG.             X5536000
BFWAB    EQU   8                   WE-SENT-WAIT-A-BIT FLAG.             X5538000
BFMSG    EQU   4                   MESSAGE-PENDING FLAG.                X5540000
BFRCVE   EQU   2                   RECEIVE-END FLAG.                    X5542000
BF2SEC   EQU   1                   2-SEC-TIMEOUT-END FLAG.              X5544000
*                                                                       X5546000
*                                                                       X5548000
*              SENSE DATA                                               X5550000
*                                                                       X5552000
*                                                                       X5554000
BCSNS    $DC   YL2(0)              BSCA STATUS BYTES.                   X5556000
BCLEN    $DC   YL2(0)              COMPUTED LENG OF RECEIVED DATA.      X5558000
BCLOG    DC    X'0',YL2(LOGBSCA,0,0)  $LOG PARAMETER LIST.              X5560000
BCMSG    DC    AL4(0)              ARGUMENT TO $MSG.                    X5562000
*                                                                     * X5564000
*********************************************************************** X5566000
*                                                                     * X5568000
*        SUBROUTINE TO SAVE REGS AND SENSE IF NECESSARY               * X5570000
*                                                                     * X5572000
*********************************************************************** X5574000
*                                                                     * X5576000
BISAV    $ST   ARR,BIARR+3         SAVE RETURN ADDRESS.                 X5578000
         AIF   (&S3BSCA EQ 1).BSCA1                                     X5580000
         DC    X'C184',YL2(*+2)    TEST BSCA#1 OP END.                  X5582000
.BSCA1   ANOP                                                           X5584000
BISAV1   $TIO  8,0,3,BIITB         BR IF INTERMEDIATE-TEXT-BLOCK.       X5586000
         $TIO  8,0,1,BIOPE         BR IF OPERATION-END.                 X5588000
         AIF   (NOT &DEBUG).BIS1   *                                    X5590000
         $ST   PSR,BIDBUG          SAVE PSR ACROSS THE $ALC.            X5592000
         $ALC  BIUINT,ONE,2        UP UNSOLICITED-INTERRUPT CTR BY 1.   X5594000
         $L    PSR,BIDBUG          RESTORE THE PSR.                     X5596000
         $J    BIGNORE             IGNORE IF NOT OP-END.                X5598000
.BIS1    ANOP                      *                                    X5600000
BIITB    EQU   *                                                        X5602000
         AIF   (NOT &DEBUG).BIS2   *                                    X5604000
         $ST   PSR,BIDBUG          SAVE PSR ACROSS THE $ALC.            X5606000
         $ALC  BIIINT,ONE,2        UP ITB-INTERRUPT COUNTER BY 1.       X5608000
         $L    PSR,BIDBUG          RESTORE PSR.                         X5610000
BIGNORE  EQU   *                                                        X5612000
.BIS2    ANOP                      *                                    X5614000
         $SIO  8,0,0,3             IF NOT OP-END, RESET AND ENABLE.     X5616000
         $B    BISAV1              NEXT INTERRUPT, GO DO IT AGAIN.      X5618000
         AIF   (NOT &DEBUG).BIS3   *                                    X5620000
BIDBUG   $DC   YL2(0)              DEBUG PSR SAVEAREA.                  X5622000
BIUINT   $DC   YL2(0)              UNSOLICITED-INTERRUPT COUNTER.       X5624000
BIIINT   $DC   YL2(0)              ITB-INTERRUPT COUNTER.               X5626000
.BIS3    ANOP                      *                                    X5628000
BIOPE    $ST   R1,BIR1             SAVE REGISTER 1.                     X5630000
         $LA   R1,BCA              SET R1 AS BCA BASE REGISTER.         X5632000
         $ST   R2,(BIR2,BCR)       SAVE REGISTER 2.                     X5634000
         $ST   PSR,(BIPSR,BCR)     SAVE PROGRAM STATUS REGISTER.        X5636000
         $JF   *+1                 RESET TEST-FALSE INDICATOR.          X5638000
         $SNS  8,0,3,(BCSNS,BCR)   READ IN THE STATUS BYTES.            X5640000
         $TBF  (BCSNS-1,BCR),X'FF' IF ALL UNIT CHECK BITS ARE OFF,      X5642000
         $JT   BIARR               RETURN TO CALLER.                    X5644000
         $MVC  (BCLOG,BCR),(BCSNS-1,BCR)  SET BYTE FOR LOGGING.         X5646000
         $LA   R1,(BCLOG,BCR)      POINT TO LOG PARAMETER AREA.         X5648000
         $B    $LOG                GO LOG STATUS BYTE 2.                X5650000
         $LA   R1,BCA              AGAIN SET R1.                        X5652000
         $MVC  (BCMSG+2,BCR),(BCSNS,BCR),2  SET SENSE BYTES IN MSG.     X5654000
         $MVI  (BCMSG,BCR),5       SET MSG NR = 5 (UNIT CHECK).         X5656000
         $SBN  (BCF1,BCR),BFMSG    SET MESSAGE-PENDING FLAG,            X5658000
BIARR    $B    *-*                 AND GO RETURN TO CALLER.             X5660000
*                                                                     * X5662000
*********************************************************************** X5664000
*                                                                     * X5666000
*              ADCONS FOR TRANSMIT/RECEIVE                            * X5668000
*                                                                     * X5670000
*        NOTE - BCRCV1 THROUGH BCXMT2 AND BCSSEQ ARE SET INITIALLY    * X5672000
*        FOR TRANSMISSION OF THE /*SIGNON CARD.  BCRCV2 WILL BE       * X5674000
*        FURTHER INITIALIZED WITH &MLBFSIZ BY $ALC.                   * X5676000
*                                                                     * X5678000
*********************************************************************** X5680000
*                                                                     * X5682000
*                                                                     * X5684000
BCRWB1   $DC   YL2(BCWAB2)         WAITABIT - START OF RECEIVE.         X5686000
BCRWB2   $DC   YL2(BCWAB3)         WAITABIT - END+1 OF RECEIVE.         X5688000
BCXWB1   $DC   YL2(BCWAB1)         WAITABIT - START OF TRANSMIT.        X5690000
BCXWB2   $DC   YL2(BCWAB2)         WAITABIT - END+1 OF TRANSMIT.        X5692000
*                                                                       X5694000
BCR1     $DC   YL2($MLB1+1)        START OF RECEIVE.                    X5696000
BCR2     $DC   YL2($MLB1+1+0)      END+1 OF RECEIVE.                    X5698000
BCX1     $DC   YL2($MLB1+1)        START OF TRANSMIT.                   X5700000
BCX2     $DC   YL2($MLB1+1+88)     END+1 OF TRANSMIT.                   X5702000
BCX1S    $DC   YL2($MLB1+1)        $BSCA START OF TRANSMIT.             X5704000
BCX2S    $DC   YL2($MLB1+1+88)     $BSCA END+1 OF TRANSMIT.             X5706000
*                                                                       X5708000
BCSSEQ   $DC   XL5'0102A08F8F'     SAVE AREA FOR STARTING SEQUENCE.     X5710000
*                                                                       X5712000
*                                                                       X5714000
*              BCB, FCS, AND MISCELLANEOUS STUFF.                       X5716000
*                                                                       X5718000
*                                                                       X5720000
BCRFCS   $DC   YL2(0)              RECEIVED FUNCTION CONTROL SEQUENCE.  X5722000
BCRBCB   $DC   X'0'                EXPECTED BLOCK CTRL BYTE (BITS 4-7). X5724000
BCXFCS   $DC   X'8F8F'             MOST-RECENTLY-TRANSMITTED FCS.       X5726000
BCXBCB   $DC   X'0'                NEXT-TO-XMIT BCB (BITS 4-7).         X5728000
$FCS     $DC   X'8FCF'             $FCS - BITS TURNED OFF BY $BSCA,     X5730000
*                                    TURNED BACK ON BY $FREEBUF.        X5732000
$FCS1    EQU   $FCS-1                                                   X5734000
$FCS2    EQU   $FCS                                                     X5736000
BCWK1    $DC   X'0'                FIRST BCB WORKAREA.                  X5738000
BCWK2    $DC   X'0'                SECOND BCB WORKAREA.                 X5740000
BC16     $DC   YL1(16)             CONSTANT OF 16.                      X5742000
BCFIVE   $DC   YL2(5)              CONSTANT OF FIVE.                    X5744000
BMLBFSIZ $DC   YL2(0)              SIZE OF MULTILEAVING BUFFER,         X5746000
BCADR    $DC   YL2(BSXOPE)         ADCON FOR $BSCA.                     X5748000
*                                  INITIALIZED WITH &MLBFSIZ BY $MVC.   X5750000
*                                                                       X5752000
*                                                                       X5754000
*              EBCDIC CHARACTERS USED BY TP HARDWARE.                 * X5756000
*                                                                       X5758000
*                                                                       X5760000
DLE      EQU   X'10'               DATA LINK ESCAPE.                    X5762000
ACK      EQU   X'70'               POSITIVE ACKNOWLEDGE ZERO.           X5764000
NAK      EQU   X'3D'               NEGATIVE ACKNOWLEDGE.                X5766000
STX      EQU   X'02'               START OF TEXT.                       X5768000
ETB      EQU   X'26'               END OF TEXT BLOCK.                   X5770000
         AIF   (&S3XPAR).BCXPAR    *                                    X5772000
SOH      EQU   X'01'               NON-TRANSPARENT SOH.                 X5774000
         AGO   .SOH                *                                    X5776000
.BCXPAR  ANOP                      *                                    X5778000
SOH      EQU   DLE                 TRANSPARENT SOH - USE DLE.           X5780000
.SOH     ANOP                      *                                    X5782000
*                                                                       X5784000
*                                                                       X5786000
*              HASP CHARACTERS USED                                     X5788000
*                                                                       X5790000
*                                                                       X5792000
BCB      EQU   X'80'               BCB (BITS 4-7 FILLED IN LATER).      X5794000
FCS      EQU   X'80'               FCS (BITS 4-7 FILLED IN LATER).      X5796000
WAB      EQU   X'40'               WAB (ADDED TO FIRST FCS).            X5798000
EOB      EQU   X'00'               END-OF-BLOCK RCB.                    X5800000
SRCB     EQU   X'80'               SUB-RECORD CONTROL BLOCK.            X5802000
SKP      EQU   X'10'               FLAG IN BCB TO IGNORE COUNT.         X5804000
RCBERR   EQU   X'E0'               RCB FOR BCB-ERROR RECORD.            X5806000
*                                                                       X5808000
*                                                                       X5810000
*              WAIT-A-BIT SEQUENCE                                      X5812000
*                                                                       X5814000
*                                                                       X5816000
BCWAB1   EQU   *                                                        X5818000
         DC    YL1(SOH,STX,BCB+SKP,FCS+WAB,FCS,EOB,EOB,EOB,ETB)         X5820000
BCWAB2   EQU   *                                                        X5822000
         DC    XL9'0'              RECEIVE AREA AFTER WAB SENT.         X5824000
BCWAB3   EQU   *                                                        X5826000
*                                                                       X5828000
*                                                                       X5830000
*              BCB-ERROR CONTROL RECORD - EXPECTED COUNT GOES IN        X5832000
*              SRCB, RECEIVED COUNT GOES IN BCB.                        X5834000
*                                                                       X5836000
*                                                                       X5838000
BCBERR   $DC   YL1(SOH,STX,BCB+SKP,FCS,FCS,RCBERR,SRCB,EOB,ETB)         X5840000
*                                                                       X5842000
*                                                                       X5844000
*              START-OF-TEXT SEQUENCE                                   X5846000
*                                                                       X5848000
*                                                                       X5850000
BCSTXSEQ $DC   YL1(SOH,STX)                                             X5852000
STXSEQ   EQU   BCSTXSEQ                                                 X5854000
*                                                                       X5856000
*                                                                       X5858000
*              END-OF-TEXT-BLOCK SEQUENCE                               X5860000
*                                                                       X5862000
*                                                                       X5864000
ETBSEQ   $DC   YL1(EOB,ETB)                                             X5866000
*                                                                       X5868000
*                                                                       X5870000
*              POSITIVE ACKNOWLEDGMENT SEQUENCE                         X5872000
*                                                                       X5874000
*                                                                       X5876000
ACKSEQ   $DC   YL1(DLE,ACK)                                             X5878000
         TITLE 'BSCA INTERRUPT ROUTINE'                                 X5880000
*                                                                     * X5882000
*********************************************************************** X5884000
*                                                                     * X5886000
*        PREPARE FUNCTION CONTROL SEQUENCE BEFORE TRANSMITTING        * X5888000
*                                                                     * X5890000
*********************************************************************** X5892000
*                                                                     * X5894000
BIXMTF   EQU   *                                                        X5896000
         $L    R2,(BCX1,BCR)       POINT TO FIRST BYTE TO XMIT.         X5898000
         $CLI  (1,R2),STX          ARE WE SENDING TEXT...               X5900000
         $JNE  BIXMT               IF NOT, FORGET ABOUT THE FCS.        X5902000
         $MVC  (4,R2),($FCS,BCR),2 MOVE FCS INTO ITS SPOT.              X5904000
         $MVC  (BCXFCS,BCR),($FCS,BCR),2  SAVE FCS LAST-XMITTED.        X5906000
         $TBN  (BCF1,BCR),BFWAB    CHECK THE WAIT-A-BIT FLAG.           X5908000
         $JF   BIXMT               SKIP IF IT'S OFF.                    X5910000
         $SBN  (3,R2),WAB          OTHERWISE SET WAB IN FCS1.           X5912000
*                                                                     * X5914000
*********************************************************************** X5916000
*                                                                     * X5918000
*        START A TRANSMIT OPERATION.                                  * X5920000
*                                                                     * X5922000
*********************************************************************** X5924000
*                                                                     * X5926000
BIXMT    $LIO  8,0,4,(BCX1,BCR)    SET CURRENT ADDRESS REGISTER.        X5928000
         $LIO  8,0,2,(BCX2,BCR)    SET TRANSITION ADDRESS REGISTER.     X5930000
         $LIO  8,0,1,(BCX2,BCR)    SET STOP ADDRESS REGISTER.           X5932000
         $B    (BIRESTOR,BCR)      RESTORE R1, R2, PSR.                 X5934000
         $SIO  8,0,2,3             START TRANSMIT-ONLY, RESET, ENABLE.  X5936000
*                                                                     * X5938000
*********************************************************************** X5940000
*                                                                     * X5942000
*        PROCESS INTERRUPT AFTER COMPLETION OF TRANSMIT.              * X5944000
*                                                                     * X5946000
*********************************************************************** X5948000
*                                                                     * X5950000
BSXOPE   $B    BISAV               SAVE R1, R2, PSR. SENSE IF REQ'D.    X5952000
         $TBF  (BCSNS-1,BCR),X'26' CK FOR DISCONNECTS, ADAPT CHECK.     X5954000
         $JT   BIRCV               IF ALL OFF, GO START RECEIVE.        X5956000
         $B    BIDISCON            OTHERWISE USE DISCONNECT SUBRTN.     X5958000
         $B    BIXMT               THEN TRY TO RE-TRANSMIT.             X5960000
         SPACE                                                          X5962000
*                                                                     * X5964000
*********************************************************************** X5966000
*                                                                     * X5968000
*        START A RECEIVE OPERATION.                                   * X5970000
*                                                                     * X5972000
*********************************************************************** X5974000
*                                                                     * X5976000
BIRCV    $LIO  8,0,4,(BCR1,BCR)    SET CURRENT ADDRESS REGISTER.        X5978000
         $LIO  8,0,1,(BCR2,BCR)    SET STOP ADDRESS REGISTER.           X5980000
         $B    (BIRESTOR,BCR)      RESTORE R1, R2, PSR.                 X5982000
         $SIO  8,0,1,3             START RECEIVE-ONLY, RESET, ENABLE.   X5984000
*                                                                     * X5986000
*********************************************************************** X5988000
*                                                                     * X5990000
*        PROCESS INTERRUPT AFTER COMPLETION OF RECEIVE.               * X5992000
*                                                                     * X5994000
*********************************************************************** X5996000
*                                                                     * X5998000
         $B    BISAV               SAVE R1, R2, PSR. SENSE IF REQ'D.    X6000000
         $SNS  8,0,4,BCESQ+3       READ CURRENT ADDRESS REGISTER.       X6002000
         $SNS  8,0,4,(BCLEN,BCR)   READ IT AGAIN TO COMPUTE LENGTH.     X6004000
         $SLC  (BCLEN,BCR),(BCR1,BCR),2  COMPUTE RECEIVED LENGTH.       X6006000
         $SLC  BCESQ+3,ONE,2       COMPUTE ADR OF LAST RCVD BYTE.       X6008000
*                                                                     * X6010000
*********************************************************************** X6012000
*                                                                     * X6014000
*        CHECK FOR AND PROCESS UNIT CHECKS HERE.                      * X6016000
*                                                                     * X6018000
*********************************************************************** X6020000
*                                                                     * X6022000
         $TBF  (BCSNS-1,BCR),X'D6' CHECK FOR DISCONNECTS, TIMEOUT,      X6024000
*                                  BCC CHECK, OR ADAPTER CHECK.         X6026000
         $JT   BCROK               IF ALL OFF, JUMP.                    X6028000
         $B    BIDISCON            GO TAKE CARE OF POSSIBLE DISCONNECT. X6030000
         $J    BINAKA              THEN SEND TO HASP A NAK.             X6032000
*                                                                     * X6034000
*********************************************************************** X6036000
*                                                                     * X6038000
*        IF NO UNIT CHECK, THIS CODE EXAMINES START AND END SEQ'S.    * X6040000
*                                                                     * X6042000
*********************************************************************** X6044000
*                                                                     * X6046000
BCROK    $L    R2,(BCR1,BCR)       POINT R2 TO 1ST RCVD BYTE.           X6048000
         $CLI  (0,R2),NAK          IF NAK WAS RECEIVED,                 X6050000
         $JE   BIRNAK                GO PROCESS IT.                     X6052000
         $CLC  (1,R2),(ACKSEQ,BCR),2  IF DLE-ACK WAS RECEIVED,          X6054000
         $JE   BIACK0              GO PROCESS IT.                       X6056000
         $CLI  (1,R2),STX          IF STX WAS NOT RECEIVED,             X6058000
         $JNE  BISEQERR               GO HANDLE THE ERROR.              X6060000
BCESQ    $CLI  *-*,ETB             IF DLE-STX AND ETB ALL OKAY,         X6062000
         $JE   BIBCB               GO EXAMINE THE HASP CONTROL BYTES.   X6064000
BISEQERR EQU   *                   ERROR IN STARTING OR ENDING SEQ.     X6066000
         $MVC  (BCMSG+2,BCR),(1,R2),2  MOVE START SEQ TO MESSAGE.       X6068000
         $MVI  (BCMSG,BCR),3       SET CODE 3 = SEQUENCE ERROR.         X6070000
         $SBN  (BCF1,BCR),BFMSG    SHOW MESSAGE PENDING.                X6072000
*                                                                     * X6074000
*********************************************************************** X6076000
*                                                                     * X6078000
*        THIS CODE SENDS A NEGATIVE ACKNOWLEDGEMENT TO HASP.          * X6080000
*                                                                     * X6082000
*********************************************************************** X6084000
*                                                                     * X6086000
BINAKA   EQU   *                                                        X6088000
         $TBN  (BCF1,BCR),BFWAB    IS THIS THE WAB SEQUENCE...          X6090000
         $JT   BINAKB              YES.  SKIP THE FOLLOWING.            X6092000
         $CLC  (BCLEN,BCR),(BCFIVE,BCR),2  IF 5 OR FEWER BYTES RCVD,    X6094000
         $JNH  BINAKB              TEST FOR TIMEOUT                @N30 X6096000
*                                       SINCE MORE THAN 5 BYTES HAVE    X6098000
*                                  BEEN RECEIVED, WE HAVE NO CHOICE BUT X6100000
*                                  TO ASSUME HASP RECEIVED OUR TRANS-   X6102000
*                                  MISSION CORRECTLY.                   X6104000
         $L    R2,(BCX1,BCR)       SET STOP ADDRESS                     X6106000
         $LA   R2,(2,R2)             TO START ADDRESS                   X6108000
         $ST   R2,(BCX2S,BCR)          PLUS TWO.                        X6110000
         $MVC  (BCSSEQ-3,BCR),(ACKSEQ,BCR),2  SET DLE ACK AS SAVED SEQ. X6112000
BINAKB   EQU   *                                                        X6114000
         $TBN  (BCSNS-1,BCR),X'80' IF TIMEOUT,                          X6116000
         $BT   BIRCV               MERELY START RECEIVE AGAIN.          X6118000
         $TBN  (BCF1,BCR),BFWAB    IF WE WERE SENDING WAB,              X6120000
         $BT   BIXMTF              SEND WAB AGAIN, NOT NAK.             X6122000
BINAK    EQU   *                   SEND A NAK TO HASP.                  X6124000
         $L    R2,(BCX1,BCR)       POINT TO 1ST TRANSMIT BYTE.          X6126000
         $MVI  (0,R2),NAK          SET IT TO NAK.                       X6128000
         $LA   R2,(1,R2)           ESTABLISH AND                        X6130000
         $ST   R2,(BCX2,BCR)         SET STOP ADDRESS.                  X6132000
         $B    BIXMT               GO START TRANSMISSION.               X6134000
*                                                                     * X6136000
*********************************************************************** X6138000
*                                                                     * X6140000
*        THIS CODE HANDLES A NAK RECEIVED FROM HASP.                  * X6142000
*                                                                     * X6144000
*********************************************************************** X6146000
*                                                                     * X6148000
BIRNAK   EQU   *                                                        X6150000
         $MVC  (BCMSG+2,BCR),ZERO,2  ZERO OUT MIDDLE MESSAGE BYTES.     X6152000
         $MVI  (BCMSG,BCR),2       SET MESSAGE CODE TO 2 = RCVD NAK.    X6154000
         $SBN  (BCF1,BCR),BFMSG    SHOW MESSAGE PENDING.                X6156000
         $TBN  (BCF1,BCR),BFWAB    DID HASP NAK OUR WAB SEQUENCE...     X6158000
         $BT   BIXMTF              YES.  GO SEND IT AGAIN.              X6160000
         $MVC  (4,R2),(BCSSEQ,BCR),5  NO, REGULAR XMISSION.  REFRESH    X6162000
         $MVC  (BCX2,BCR),(BCX2S,BCR),4  TRANSMIT LIMITS AND            X6164000
         $B    BIXMTF              FIRST 5 BYTES AND RE-XMIT.           X6166000
*                                                                     * X6168000
*********************************************************************** X6170000
*                                                                     * X6172000
*        THIS CODE HANDLES DLE-ACK RECEIVED FROM HASP.                * X6174000
*                                                                     * X6176000
*********************************************************************** X6178000
*                                                                     * X6180000
BIACK0   $SBF  (BCRFCS-1,BCR),WAB  IF REAL DLE-ACK, RESET RCVD WAB.     X6182000
BIACK    EQU   *                                                        X6184000
         $SBN  (BCF1,BCR),BFPOST+BFRCVE  SET POST FLAG, SHOW RCV END.   X6186000
         $B    (BIRESTOR,BCR)      RESTORE REGISTERS.                   X6188000
         $SIO  8,0,0,7             START A 2-SECOND TIMEOUT.            X6190000
         $TIO  8,0,1,*+2           RESET OP-END INTERRUPT LATCH.        X6192000
         $SBN  BCF1,BF2SEC         SHOW 2-SEC TIMEOUT ENDED.            X6194000
         $SIO  8,0,0,1             CLEAR THE INTERRUPT.                 X6196000
*                                                                     * X6198000
*********************************************************************** X6200000
*                                                                     * X6202000
*        THIS CODE TAKES CARE OF RECEIVED-TEXT RECORDS.               * X6204000
*                                                                     * X6206000
*********************************************************************** X6208000
*                                                                     * X6210000
BIBCB    EQU   *                                                        X6212000
         $MVC  (BCRFCS,BCR),(4,R2),2  SAVE RECEIVED FCS.                X6214000
         $TBN  (2,R2),X'20'        IS RESET-BCB FLAG ON...              X6216000
         $JF   BISKP               JUMP IF NOT.                         X6218000
         $MNN  (BCRBCB,BCR),(2,R2) YES.  RESET BCB AS INDICATED.        X6220000
BISKP    $TBF  (2,R2),X'30'        IF EITHER RESET-BCB OR IGNORE-BCB,   X6222000
         $BF   BIACK               END BCB PROCESSING.                  X6224000
         $MNN  (BCWK1,BCR),(2,R2)  MOVE RECEIVED AND EXPECTED           X6226000
         $MNN  (BCWK2,BCR),(BCRBCB,BCR)  BCB'S TO WORKAREAS.            X6228000
         $SLC  (BCWK2,BCR),(BCWK1,BCR)  COMPUTE EXPECTED MINUS RECEIVED X6230000
         $JNZ  BIBAD               IF NOT THE SAME, JUMP.               X6232000
         $ALC  (BCRBCB,BCR),ONE    ELSE UP EXPECTED-BCB BY ONE          X6234000
         $B    BIACK               AND END BCB PROCESSING.              X6236000
         SPACE 2                                                        X6238000
*                                                                     * X6240000
*********************************************************************** X6242000
*                                                                     * X6244000
*        THIS CODE HANDLES BLOCK-CONTROL-BYTE ERRORS.                 * X6246000
*                                                                     * X6248000
*********************************************************************** X6250000
*                                                                     * X6252000
BIBAD    $MVI  (1,R2),X'FF'        SIGNAL $BSCA TO THROW BUFFER AWAY.   X6254000
         $JP   BIPLUS              JUMP IF DIFFERENCE WAS POSITIVE.     X6256000
         $ALC  (BCWK2,BCR),(BC16,BCR)  ELSE MAKE DIFFERENCE MODULO 16.  X6258000
BIPLUS   $CLI  (BCWK2,BCR),2       COMPARE WITH MAX ALLOWED DIFFERENCE. X6260000
         $BNH  BIACK               BR IF NOT BCB ERROR.                 X6262000
         $MVC  (BCMSG+1,BCR),(2,R2)  SHOW RECEIVED BCB IN MESSAGE.      X6264000
         $MVI  (BCMSG+2,BCR),X'80' SHOW HI BIT OF EXPECTED AND FILL     X6266000
         $MNN  (BCMSG+2,BCR),(BCRBCB,BCR)  IN BITS 4-7 OF EXPECTED BCB. X6268000
         $MVI  (BCMSG,BCR),1       SET CODE OF 1 = BCB CHECK,           X6270000
         $SBN  (BCF1,BCR),BFMSG      AND SET MESSAGE-PENDING FLAG.      X6272000
         $MNN  (BCBERR-6,BCR),(BCWK1,BCR) TELL HASP ABOUT BCB ERROR --- X6274000
         $MNN  (BCBERR-2,BCR),(BCRBCB,BCR)  GIVE HIM EXPECTED & RCVD.   X6276000
         $MVC  (8,R2),(BCBERR,BCR),9  MOVE BCB ERR SEQ TO RCV AREA.     X6278000
         $ST   R2,(BCX1,BCR)       SET TRANSMIT ADDRESS.                X6280000
         $LA   R2,(9,R2)           ADD 9 TO IT.                         X6282000
         $ST   R2,(BCX2,BCR)       SET STOP ADDRESS.                    X6284000
         $B    BIXMTF              THEN TRANSMIT WITH FCS.              X6286000
*                                                                     * X6288000
*********************************************************************** X6290000
*                                                                     * X6292000
*        SUBROUTINE TO TAKE CARE OF DISCONNECT STATUS BITS.           * X6294000
*                                                                     * X6296000
*********************************************************************** X6298000
*                                                                     * X6300000
BIDISCON $ST   ARR,BIDRET+3        SAVE RETURN ADDRESS.                 X6302000
         $TBF  (BCSNS-1,BCR),6     IS A DISCONNECT BIT ON...            X6304000
         $JT   BIDRET              IF NOT, RETURN TO CALLER.            X6306000
         $SIO  8,0,0,X'82'         IF SO, DISABLE BSCA AND              X6308000
         $SIO  8,0,0,X'C2'         ENABLE BSCA.                         X6310000
BID1     $B    (BIRESTOR,BCR)      RESTORE REGISTERS                    X6312000
         $SIO  8,0,0,7             AND START 2-SECOND TIMEOUT.          X6314000
         $B    BISAV               THEN SAVE REGISTERS AND SENSE.       X6316000
         $TBN  (BCSNS,BCR),2       IF THE DATASET IS NOT READY,         X6318000
         $BF   BID1                DO IT ALL OVER AGAIN.                X6320000
BIDRET   $B    *-*                 OTHERWISE RETURN TO CALLER.          X6322000
         TITLE '$BSCA - MAIN PROCESSOR FOR BSCA'                        X6324000
$BSCA    EQU   *                                                        X6326000
*                                                                       X6328000
*                                                                       X6330000
*              $BSCA DOESN'T USE FBEWF BUT RATHER BFWAIT AND BFPOST     X6332000
*              IN THE BSCA CONTROL AREA.                                X6334000
*                                                                       X6336000
*                                                                       X6338000
*                                                                       X6340000
         $ST   IAR,(FBENT,FBR)     STORE LOCATION.                      X6342000
         $TBF  (BCF1,BCR),BFPOST+BFMSG  POSTED OR MESSAGE...            X6344000
         $BT   $COMRETA            IF NOT, RETURN TO COMMUTATOR.        X6346000
         $TBN  (BCF1,BCR),BFMSG    IS A MESSAGE SPECIFIED...            X6348000
         $SBF  (BCF1,BCR),BFMSG    (RESET THE MESSAGE SWITCH.)          X6350000
         $JF   BS000               IF NOT, END OF RECEIVE.              X6352000
         $LA   R1,(BCMSG,BCR)      OTHERWISE POINT TO MESSAGE           X6354000
         $B    $MSG                AND ADD IT TO TRACE TABLE.           X6356000
         $B    $COMRETB            THEN RETURN WITHOUT CHANGING FBREG1. X6358000
BS000    EQU   *                                                        X6360000
         $SBF  (BCF1,BCR),BFWAIT+BFPOST  SET OFF THE WAIT & POST BITS.  X6362000
*                                                                       X6364000
*                                                                       X6366000
*              EXAMINE THE BUFFER FOR WHICH A RECEIVE OPERATION         X6368000
*              HAS JUST COMPLETED.                                      X6370000
*                                                                       X6372000
*                                                                       X6374000
         $TBN  (BCF1,BCR),BFRCVE   IS RECEIVE ENDED...                  X6376000
         $BF   $BSCA               IF NOT, EXIT.                        X6378000
         $TBN  (BCF1,BCR),BFWAB    WAS THIS WAIT-A-BIT SEQUENCE...      X6380000
         $JT   BS100               IF SO, BYPASS RCVD-BUFFER CODE.      X6382000
         $L    R1,(FBBUF,FBR)      POINT TO THE BUFFER.                 X6384000
         $MVC  (FBRCB,FBR),(2,R1)  SAVE THE STARTING SEQUENCE.          X6386000
         $CLI  (2,R1),STX          DOES THE BUFFER CONTAIN TEXT...      X6388000
         $JNE  BS030               NO, ACK.  GO FREE IT.                X6390000
*                                                                       X6392000
*              BUFFER CONTAINS TEXT.  QUEUE IT ON THE                   X6394000
*              APPROPRIATE PROCESSOR.                                   X6396000
*                                                                       X6398000
         $LA   R2,$FBFRSTE         POINT TO FIRST ELIGIBLE FB.          X6400000
         $MVC  BS010+1,(6,R1)      ASSUME RECORD IS TEXT.               X6402000
         $TBF  (6,R1),X'0F'        IS IT A CONTROL RECORD...            X6404000
         $JF   BS010               SKIP IF NOT.                         X6406000
         $MVC  BS010+1,(7,R1)      YES.  MOVE SRCB TO CLI INSTRUCTION.  X6408000
         $CLI  (6,R1),0            DOES RCB INDICATE END-OF-BLOCK...    X6410000
         $JE   BS029               IF SO, MERELY FREE THE BUFFER.       X6412000
         $CLI  (7,R1),C'B'         UNLESS TERMINATION RECORD,           X6414000
         $JNE  BS010               CONTINUE.                            X6416000
         $SIO  8,0,0,X'80'         DISABLE BSCA AND INTERRUPTS.         X6418000
         $MVI  BS010+1,X'91'       SET CONSOLE OUTPUT RCB.              X6420000
         $MVI  $FBBSCA+6,X'FF'     SET $BSCA PERMANENT WAIT.            X6422000
         $MVI  (6,R1),X'91'        SET CONSOLE OUTPUT RCB.              X6424000
         $MVI  (7,R1),X'83'        SET SRCB FOR PRT & SPACE 3.          X6426000
BS010    $CLI  (FBRCB,FBR),*-*     IS THIS THE RIGHT FB...              X6428000
         $JE   BS011               JUMP IF SO.                          X6430000
         $CLI  (FBNEXT-1,FBR),0    NO.  IS THERE ANOTHER FB...          X6432000
         AIF   (&DEBUG).BSD1                                            X6434000
         $JE   BS029               IF NOT, GO FREE THE BUFFER.          X6436000
         AGO   .BSD2                                                    X6438000
.BSD1    $BE   ABEND               DUMP IF UNKNOWN RCB.                 X6440000
.BSD2    $L    R2,(FBNEXT,FBR)     YES.  POINT TO NEXT FB.              X6442000
         $B    BS010                 AND GO LOOP.                       X6444000
BS011    $TBF  (6,R1),X'0F'        IS THIS A CONTROL RECORD...          X6446000
         $JT   BS028               JUMP IF SO.                          X6448000
*                                                                     * X6450000
*********************************************************************** X6452000
*                                                                     * X6454000
*        THIS CODE HANDLES BUFFERS CONTAINING ALL TEXT RECORDS        * X6456000
*                                                                     * X6458000
*********************************************************************** X6460000
*                                                                     * X6462000
         $ALC  (FBBCT,FBR),ONE     UP FB'S BUFFER COUNT BY ONE.         X6464000
         $CLC  (FBBCT,FBR),(FBBMX,FBR)  IS BUFFER CT .GE. MAXIMUM...    X6466000
         $JL   BS015               JUMP IF NOT.                         X6468000
         $MVC  BS013+1,(FBFCS1,FBR)  OTHERWISE                          X6470000
BS013    $SBF  $FCS1,*-*               TURN OFF                         X6472000
         $MVC  BS014+1,(FBFCS2,FBR)      THE APPROPRIATE                X6474000
BS014    $SBF  $FCS2,*-*                   BIT IN $FCS.                 X6476000
         $SBN  BCF1,BFCSOFF        SHOW FCS BIT TURNED OFF.             X6478000
BS015    $POST *,WORK              POST THE FB FOR WORK.                X6480000
         $TBN  (FBFLG,FBR),BFCSON  DID THIS FB SET FCS RECENTLY...      X6482000
         $SBF  (FBFLG,FBR),BFCSON  (SHOW IT DIDN'T.)                    X6484000
         $JF   *+1+4               SKIP IF NOT.                         X6486000
         $SBF  BCF1,BFCSON         YES.  DON'T HASTEN TRANSMISSION      X6488000
         AIF   (NOT &S35471).BS71                                       X6490000
         $CLI  (FBRCB,FBR),X'91'   IS THIS BUFFER FOR THE 5471...       X6492000
         $JNE  *+1+3               JUMP IF NOT.                         X6494000
         $SBF  (FBEWF,FBR),EWFPOST YES.  RESET THE POST BIT TOO.        X6496000
.BS71    ANOP                                                           X6498000
         $LA   R2,(FBBUF,FBR)      POINT TO FB'S BUFFER CHAIN WORD.     X6500000
BS016    $CLC  (0,R2),ZERO,2       LOOP - IS THIS END-OF-CHAIN...       X6502000
         $JE   BS017               JUMP IF SO.                          X6504000
         $L    R2,(0,R2)           OTHERWISE POINT TO NEXT BUFFER       X6506000
         $B    BS016               AND GO TO START OF LOOP.             X6508000
BS017    $ST   R1,(0,R2)           PUT THIS BUFFER ON END OF CHAIN.     X6510000
         $LA   R2,$FBBSCA          THEN                                 X6512000
         $MVC  (FBBUF,FBR),(0,R1),2  REMOVE BUFFER FROM OUR OWN         X6514000
         $MVC  (0,R1),ZERO,2           CHAIN AND ZERO ITS CHAIN WORD.   X6516000
         $SLC  (FBBCT,FBR),ONE     REDUCE OUR BUFFER CT BY ONE.         X6518000
         AIF   (NOT &DEBUG).BS018  *                                    X6520000
         $BM   ABEND               ABEND IF COUNT IS NEGATIVE.          X6522000
.BS018   $J    BS100               SKIP OVER THE $FREEBUF CALL.         X6524000
*                                                                     * X6526000
*********************************************************************** X6528000
*                                                                     * X6530000
*        THIS CODE HANDLES CONTROL BUFFERS (REQUEST AND PERMISSION)   * X6532000
*                                                                     * X6534000
*********************************************************************** X6536000
*                                                                     * X6538000
BS028    $POST *,PERM+EWFPOST      POST LOGICAL READER FOR PERMISSION   X6540000
*                                  OR LOGICAL PRINTER OR PUNCH FOR      X6542000
*                                  REQUEST (AND SET EARLY-POST FLAG).   X6544000
*                                                                       X6546000
*              FREE THE BUFFER.                                         X6548000
*                                                                       X6550000
BS029    $LA   R2,$FBBSCA          POINT TO OUR OWN FB.                 X6552000
BS030    $B    $FREEBUF            GO FREE OUR TOP BUFFER.              X6554000
*                                                                     * X6556000
*********************************************************************** X6558000
*                                                                     * X6560000
*              DECISION-MAKING BEFORE TRANSMIT                        * X6562000
*                                                                     * X6564000
*********************************************************************** X6566000
*                                                                     * X6568000
BS100    $L    R1,(FBREG1,FBR)     RESTORE R1 TO POINT TO BCA.          X6570000
         $CLI  (FBEWF,FBR),X'FF'   IF $BSCA PERMANENT WAIT,             X6572000
         $BE   $BSCA               JUST RETURN.                         X6574000
BS101    $TBN  (BCRFCS-1,BCR),WAB  IF HASP SENT US WAIT-A-BIT,          X6576000
         $JT   BS108               GO CHECK FOR A FREE BUFFER.          X6578000
         $CLI  (FBBUF-1,FBR),0     IF THERE'S A TEXT BUFFER TO SEND,    X6580000
         $JNE  BSD                 GO SEND IT.                          X6582000
         $CLI  $MLPOOL-1,0         IF THERE'S NO FREE BUFFER,           X6584000
         $JE   BS106               GO NON-PROCESS EXIT.                 X6586000
         $TBN  (BCF1,BCR),BFCSON   WAS AN FCS BIT TURNED ON...          X6588000
         $JT   BSB                 IF SO, REPORT IT IMMEDIATELY.        X6590000
         $TBN  (BCF1,BCR),BFCSOFF  WAS AN FCS BIT TURNED OFF...         X6592000
         $JT   BS106               IF SO, WAIT A LITTLE.                X6594000
         $CLI  (FBRCB,FBR),STX     IF HASP HAS JUST SENT US TEXT        X6596000
         $JE   BSB                 ACKNOWLEDGE IMMEDIATELY.             X6598000
BS106    $ST   IAR,(FBENT,FBR)     NON-PROCESS EXIT HERE,               X6600000
         $TBF  (BCF1,BCR),BFPOST+BF2SEC  WAITING FOR EITHER BFPOST      X6602000
         $BT   $COMRETA            OR BF2SEC TO COME ON.                X6604000
         $TBN  (BCF1,BCR),BFPOST   IF WE GOT POSTED,                    X6606000
         $SBF  (BCF1,BCR),BFPOST   RESET POST FLAG AND                  X6608000
         $BT   BS101               GO CHECK WHY.                        X6610000
BS108    $CLI  $MLPOOL-1,0         IF 2-SEC AND A BUFFER IS FREE,       X6612000
         $JNE  BSB                 ACKNOWLEDGE.                         X6614000
*                                                                     * X6616000
*********************************************************************** X6618000
*                                                                     * X6620000
*              SEND WAIT-A-BIT TO HASP                                * X6622000
*                                                                     * X6624000
*********************************************************************** X6626000
*                                                                     * X6628000
BSA      $MVC  (BCX2,BCR),(BCXWB2,BCR),8  SET WAB XMIT/RCV ARGS,        X6630000
         $SBN  (BCF1,BCR),BFWAB    SHOW WE'VE SENT WAIT-A-BIT,          X6632000
         $J    BSF                 AND GO FILL IN THE FCS.              X6634000
*                                                                     * X6636000
*********************************************************************** X6638000
*                                                                     * X6640000
*              SEND LOGICAL ACKNOWLEDGMENT TO HASP                    * X6642000
*                                                                     * X6644000
*********************************************************************** X6646000
*                                                                     * X6648000
BSB      $B    BSGBUF              GET THE FREE BUFFER.                 X6650000
         $CLC  ($FCS,BCR),(BCXFCS,BCR),2  HAS FCS CHANGED...            X6652000
         $JE   BSC                 SEND DLE-ACK0 IF NOT.                X6654000
         $MVC  (6,R2),(ETBSEQ,BCR),2 SET UP THE ENDING SEQUENCE,        X6656000
         $LA   R2,(7,R2)           AND SPECIFY                          X6658000
         $ST   R2,(BCX2,BCR)       TRANSMIT STOP ADDRESS.               X6660000
         $J    BSE                 THEN GO SET UP STARTING SEQ.         X6662000
*                                                                     * X6664000
*********************************************************************** X6666000
*                                                                     * X6668000
*              SEND PHYSICAL ACK (DLE-ACK0) TO HASP                   * X6670000
*                                                                     * X6672000
*********************************************************************** X6674000
*                                                                     * X6676000
BSC      EQU   *                                                        X6678000
         $MVC  (1,R2),(ACKSEQ,BCR),2  SET UP THE PHYSICAL ACK,          X6680000
         $LA   R2,(2,R2)           AND SPECIFY                          X6682000
         $ST   R2,(BCX2,BCR)       TRANSMIT STOP ADDRESS.               X6684000
         $J    BSX                 THEN GO START TRANSMISSION.          X6686000
*                                                                     * X6688000
*********************************************************************** X6690000
*                                                                     * X6692000
*              SEND THE TEXT BUFFER TO HASP                           * X6694000
*                                                                     * X6696000
*********************************************************************** X6698000
*                                                                     * X6700000
BSD      $L    R1,(FBBUF,FBR)      POINT TO THE TEXT BUFFER.            X6702000
         $B    BSGADR              FILL IN SOME ADDRESSES,              X6704000
         $L    R2,(1,R2)           GET XMIT STOP ADR-3 (SET BY $CKLEN), X6706000
         $LA   R2,(3,R2)           ADD 3 TO IT, AND                     X6708000
         $ST   R2,(BCX2,BCR)       SPECIFY TRANSMIT STOP ADDRESS.       X6710000
*                                                                     * X6712000
*********************************************************************** X6714000
*                                                                     * X6716000
*              SET UP STX SEQUENCE                                    * X6718000
*                                                                     * X6720000
*********************************************************************** X6722000
*                                                                     * X6724000
BSE      $L    R2,(BCX1,BCR)       POINT TO THE BUFFER.                 X6726000
         $MVC  (1,R2),(STXSEQ,BCR),2  SET UP THE STARTING SEQUENCE.     X6728000
         $MVI  (2,R2),BCB          SET SKELETON BLOCK CTRL BYTE.        X6730000
         $MNN  (2,R2),(BCXBCB,BCR) FILL IN MOD-16 BLOCK COUNT.          X6732000
         $ALC  (BCXBCB,BCR),ONE    UP BLOCK COUNTER BY ONE.             X6734000
*                                                                     * X6736000
*********************************************************************** X6738000
*                                                                     * X6740000
*              FILL IN FUNCTION CONTROL SEQUENCE                      * X6742000
*                                                                     * X6744000
*********************************************************************** X6746000
*                                                                     * X6748000
BSF      $L    R2,(BCX1,BCR)       POINT TO FIRST XMIT BYTE.            X6750000
         $MVC  (4,R2),($FCS,BCR),2 SET CURRENT BCS IN BUFFER.           X6752000
         $MVC  (BCXFCS,BCR),($FCS,BCR),2  SHOW LAST FCS TRANSMITTED.    X6754000
         $TBN  (BCF1,BCR),BFWAB    IS THIS THE WAB SEQUENCE...          X6756000
         $JF   BSX                 IF NOT, GO TRANSMIT.                 X6758000
         $SBN  (3,R2),WAB          YES.  SHOW WAB IN FCS.               X6760000
*                                                                     * X6762000
*********************************************************************** X6764000
*                                                                     * X6766000
*              START TRANSMIT HERE                                    * X6768000
*                                                                     * X6770000
*********************************************************************** X6772000
*                                                                     * X6774000
BSX      $MVC  (BCX2S,BCR),(BCX2,BCR),4  SAVE TRANSMIT START AND END.   X6776000
         $L    R2,(BCX1,BCR)       POINT TO 1ST BYTE TO TRANSMIT.       X6778000
         $MVC  (BCSSEQ,BCR),(4,R2),5  SAVE FIRST 5 BYTES.               X6780000
         $LA   R2,$FBBSCA          POINT R2 TO OUR FB.                  X6782000
         $SNS  8,0,3,(BCSNS,BCR)   GET THE BSCA STATUS DATA.            X6784000
         $TBF  (BCSNS-1,BCR),6     ARE BOTH DISCONNECT BITS OFF...      X6786000
         $JT   BSY                 GO TRANSMIT IF SO.                   X6788000
         $SIO  8,0,0,X'80'         IF NOT, DISABLE BSCA                 X6790000
         $SIO  8,0,0,X'C0'         AND ENABLE BSCA.                     X6792000
         $ST   IAR,(FBENT,FBR)     THEN STORE LOCATION.                 X6794000
         $SNS  8,0,3,(BCSNS,BCR)   GET THE BSCA STATUS DATA.            X6796000
         $TBN  (BCSNS,BCR),2       IS DATA SET NOW READY...             X6798000
         $BF   $COMRETA            NON-PROCESS EXIT IF NOT.             X6800000
BSY      $LIO  8,0,4,(BCX1,BCR)    LOAD CURRENT,                        X6802000
         $LIO  8,0,2,(BCX2,BCR)    TRANSITION, AND                      X6804000
         $LIO  8,0,1,(BCX2,BCR)    STOP ADDRESSES.                      X6806000
         $SIO  8,0,2,1             START XMIT AND RESET INTERRUPTS.     X6808000
         $SBF  (BCF1,BCR),BFPOST+BF2SEC+BFRCVE+BFCSON+BFCSOFF           X6810000
         $L    IL2,(BCADR,BCR)     SET INTERRUPT ADDRESS,               X6812000
         $SIO  8,0,0,2             AND ENABLE BSCA INTERRUPTS.          X6814000
         $B    $BSCA               THEN GO TO THE TOP.                  X6816000
BS200    EQU   BSY                 ENTRY FOR INITIALIZATION.            X6818000
*                                                                     * X6820000
*********************************************************************** X6822000
*                                                                     * X6824000
*              SUBROUTINE TO GET A FREE BUFFER                        * X6826000
*                                                                     * X6828000
*********************************************************************** X6830000
*                                                                     * X6832000
BSGBUF   $L    R1,$MLPOOL          GET A FREE BUFFER.                   X6834000
         $MVC  $MLPOOL,(0,R1),2    DEQUEUE IT FROM POOL.                X6836000
         $MVC  (0,R1),(FBBUF,FBR),2  QUEUE IT LAST-IN-FIRST-OUT         X6838000
         $ST   R1,(FBBUF,FBR)      ON THE BSCA BUFFER QUEUE.            X6840000
         $ALC  (FBBCT,FBR),ONE     UP THE BSCA BUFFER COUNT BY ONE.     X6842000
BSGADR   $LA   R2,(1,R1)           LET R2 POINT TO THE BUFFER.          X6844000
         $LA   R1,BCA              LET R1 POINT TO THE BCA.             X6846000
         $ST   R2,(BCX1,BCR)       SET TRANSMIT STARTING ADR.           X6848000
         $ST   R2,(BCR1,BCR)       SET RECEIVE STARTING ADR.            X6850000
         $ST   R2,(BCR2,BCR)       SET RECEIVE ENDING                   X6852000
         $ALC  (BCR2,BCR),(BMLBFSIZ,BCR),2   ADDRESS.                   X6854000
         $SBF  (BCF1,BCR),BFWAB    RESET XMIT-WAITABIT FLAG.            X6856000
         $ST   ARR,BSGEND+3        SET RETURN ADDRESS.                  X6858000
BSGEND   $B    *-*                 RETURN TO CALLER.                    X6860000
         AIF   (NOT &S3CMDS).NOCMDS                                     X6862000
         TITLE 'LOCAL COMMAND HANDLING SUBROUTINE'                      X6864000
$CMDSCAN EQU   *                                                        X6866000
         $ST   ARR,CMDARR          SAVE RETURN ADDRESS.                 X6868000
         $ST   R2,CMDR2            SAVE CALLER'S R2.                    X6870000
         $CLC  (9,R1),CMD01,10     IS THIS /*CARRIAGE...                X6872000
         $JNE  CMD020              GO TEST NEXT COMMAND IF NOT.         X6874000
         SPACE 1                                                        X6876000
         $LA   R1,(9,R1)           POINT TO LAST CHAR OF CMD.           X6878000
CMD01A   $LA   R1,(1,R1)           POINT TO NEXT CHAR.                  X6880000
         $CLI  (0,R1),C' '         IS IT A BLANK...                     X6882000
         $BE   CMD01A              LOOP TILL A NONBLANK.                X6884000
         SPACE 1                                                        X6886000
         $CLI  (0,R1),C'L'         IS OPERAND NR-OF-LINES...            X6888000
         $JNE  CMD01B              JUMP IF NOT.                         X6890000
         $MVI  CMD01T,13           YES.  USE CARRIAGE CHAN 13.          X6892000
         $LA   R1,(2,R1)           POINT JUST PAST 'L='.                X6894000
         $J    CMD01C              GO GET 2D SUBOPERAND.                X6896000
         SPACE 1                                                        X6898000
CMD01B   $B    $CVB                GET 1ST SUBOPERAND= CHAN NR.         X6900000
         $CLI  (0,R1),C'='         IS DELIMITER AN EQUAL...             X6902000
         $JNE  CMDSYN              SYNTAX ERROR IF NOT.                 X6904000
         $CLI  $CVBANS,12          IF CHANNEL .GT. 12,                  X6906000
         $JH   CMDOPD              OPERAND ERROR.                       X6908000
         $MVC  CMD01T,$CVBANS,1    1ST SUBOP OK.  SAVE IT.              X6910000
         SPACE 1                                                        X6912000
         $LA   R1,(1,R1)           POINT JUST PAST '='                  X6914000
CMD01C   $B    $CVB                AND GET 2D SUBOPERAND.               X6916000
         $CLI  (0,R1),C','         IS DELIMITER A COMMA...              X6918000
         $JE   CMD01D              JUMP IF SO.                          X6920000
         $CLI  (0,R1),C' '         IS DELIMITER A BLANK...              X6922000
         $JNE  CMDSYN              SYNTAX ERROR IF NEITHER.             X6924000
         $CLI  $CVBANS,112         IF LINE NR .GT. 112,                 X6926000
         $JH   CMDOPD              OPERAND ERROR.                       X6928000
         SPACE 1                                                        X6930000
CMD01D   $LA   R2,PCCCTL           POINT TO PRINTER CARRIAGES.          X6932000
         $LA   R2,(*-*,R2)         POINT TO SELECTED CHAN.              X6934000
CMD01T   EQU   *-1                                                      X6936000
         $MVC  (0,R2),$CVBANS,1    SET NEW CHAN LINE NUMBER.            X6938000
         $CLC  (0,R2),PCCCTL+13    IF LINE NR .GT. FORM LENGTH,         X6940000
         $JH   CMDOPD              OPERAND ERROR.                       X6942000
         SPACE 1                                                        X6944000
         $CLI  CMD01T,13           WAS OPERAND NR-OF-LINES...           X6946000
         $JNE  CMD01E              JUMP IF NOT.                         X6948000
         $LIO  14,0,0,PCCCTL+14    YES.  LOAD FORMS LENGTH REG.         X6950000
         $MVC  PCCCTL+12,PCCCTL+13,12  SET ALL CHAN'S TO LINE-NR.       X6952000
         SPACE 1                                                        X6954000
CMD01E   $CLI  (0,R1),C' '         WAS PREVIOUS OPERAND LAST...         X6956000
         $LA   R1,(1,R1)           POINT JUST PAST COMMA.               X6958000
         $BNE  CMD01B              B IF NOT LAST OPERAND.               X6960000
         $J    CMDEND              ELSE EXIT.                           X6962000
CMDOPD   $LA   R1,CMDOPDMS         OPERAND ERROR.                       X6964000
         $J    CMDEND+4            PRINT 'C0DE0002'.                    X6966000
CMDOPDMS DC    X'C0DE0002'                                              X6968000
CMDSYN   $LA   R1,CMDSYNMS         SYNTAX ERROR.                        X6970000
         $J    CMDEND+4            PRINT 'C0DE0001'.                    X6972000
CMDSYNMS DC    X'C0DE0001'                                              X6974000
CMDENDMS DC    X'C0DE0000'         NORMAL END.                          X6976000
CMDEND   $LA   R1,CMDENDMS         PRINT 'C0DE0000'.                    X6978000
         $B    $MSG                GO LOG MESSAGE.                      X6980000
         $CLI  *-1,X'00'           SET CONDITION CODE EQUAL.            X6982000
CMD020   EQU   *                   START PROCESSING COMMAND 2.          X6984000
         $LA   R2,*-*              RESTORE REGISTER 2.                  X6986000
CMDR2    EQU   *-1                                                      X6988000
         $B    *-*                 RETURN TO CALLER.                    X6990000
CMDARR   EQU   *-1                                                      X6992000
CMD01    $DC   C'/*CARRIAGE'                                            X6994000
         EJECT                                                          X6996000
*                                                                       X6998000
*              SUBROUTINE TO CONVERT TO BINARY                          X7000000
*                                                                       X7002000
$CVB     $ST   ARR,CVBE1+3         SAVE RETURN ADDRESS.                 X7004000
         $CLI  (0,R1),X'F0'        IS FIRST DIGIT NUMERIC...            X7006000
         $BL   CMDSYN              SYNTAX ERROR IF NOT.                 X7008000
         SPACE 1                                                        X7010000
CVBA     $LA   R1,(1,R1)           FIND LOW-ORDER DIGIT.                X7012000
         $CLI  (0,R1),X'F0'        IS THIS CHAR NUMERIC...              X7014000
         $BNL  CVBA                LOOP IF SO.                          X7016000
         $ST   R1,CVBE+3           SAVE ADR OF NON-NUMERIC CHAR         X7018000
         SPACE 1                                                        X7020000
CVBB     $SLC  $CVBANS,$CVBANS,2   ZERO OUT ANSWER SPOT.                X7022000
         $LA   R2,CVBTAB-2         POINT TO TABLE MINUS 2.              X7024000
         SPACE 1                                                        X7026000
CVBC     $LA   R2,(2,R2)           POINT TO NEXT TABLE ENTRY            X7028000
         $A    R1,MONE             AND TO NEXT-HIGHER-ORD DIGIT         X7030000
         $CLI  (0,R1),X'F0'        IS DIGIT NUMERIC...                  X7032000
         $JL   CVBE                IF NOT, END OF CONVERSION.           X7034000
         SPACE 1                                                        X7036000
CVBD     $SLC  (0,R1),ONE          REDUCE DIGIT BY 1.                   X7038000
         $CLI  (0,R1),X'F0'        WAS THE DIGIT ZERO...                X7040000
         $BL   CVBC                IF SO, DO NEXT DIGIT.                X7042000
         $ALC  $CVBANS,(1,R2),2    ELSE ADD ITS PLACE-VALUE             X7044000
         $B    CVBD                AND LOOP.                            X7046000
         SPACE 1                                                        X7048000
CVBE     $LA   R1,*-*              POINT R1 TO NON-NUMERIC CHAR         X7050000
CVBE1    $B    *-*                 AND RETURN TO CALLER.                X7052000
         SPACE 1                                                        X7054000
CVBTAB   DC    HL2'1,10,100,1000,10000'  PLACE-VALUE TABLE.             X7056000
         SPACE 1                                                        X7058000
$CVBANS  $DC   YL2(0)              BINARY ANSWER.                       X7060000
.NOCMDS  ANOP                                                           X7062000
         TITLE '$LEOF, $PERM, $REQ --- COMMAND SEQUENCE SUBROUTINES'    X7064000
*                                                                       X7066000
*              SEND LOGICAL END-OF-FILE TO HASP.                        X7068000
*                                                                       X7070000
$LEOF    EQU   *                                                        X7072000
         $MVC  (FBCSEQ-2,FBR),(FBRCB,FBR)  SET UP RCB.                  X7074000
         $MVI  (FBCSEQ-1,FBR),X'80'  SET UP SRCB = X'80'.               X7076000
         $J    COMMON2             JUMP TO COMMON CODE.                 X7078000
*                                                                       X7080000
*              SEND PERMISSION-GRANTED TO HASP.                         X7082000
*                                                                       X7084000
$PERM    EQU   *                                                        X7086000
         $MVI  (FBCSEQ-2,FBR),X'A0'  SET 'PERMISSION' COMMAND CODE.     X7088000
         $SBN  (FBEWF,FBR),EWFPOST RESET (SET TO 1) THE EARLY POST FLAG X7090000
         $J    COMMON1             JUMP TO COMMON CODE.                 X7092000
*                                                                       X7094000
*              SEND REQUEST-PERMISSION TO HASP.                         X7096000
*                                                                       X7098000
$REQ     EQU   *                                                        X7100000
         $MVI  (FBCSEQ-2,FBR),X'90'  SET 'REQUEST' COMMAND CODE.        X7102000
*                                                                       X7104000
*              COMMON CODE FOR ABOVE THREE SUBROUTINES.                 X7106000
*                                                                       X7108000
COMMON1  $MVC  (FBCSEQ-1,FBR),(FBRCB,FBR)  SET RCB AS BYTE 2 OF SEQ.    X7110000
COMMON2  $MVI  (FBCSEQ,FBR),0      SET ZERO AS BYTE 3 OF SEQUENCE.      X7112000
         $ST   ARR,(FBRET2,FBR)    SAVE ARR IN ALTERNATE ARR SAVEAREA.  X7114000
         $LA   R1,3                SPECIFY LENGTH OF SEQUENCE.          X7116000
         $B    $CKLEN              GO GET SPACE FOR IT IN CUR BUFFER.   X7118000
         $MVC  (0,R1),(FBCSEQ,FBR),3  MOVE SEQUENCE TO BUFFER.          X7120000
         $B    $BFLUSH             THEN TRUNCATE THE BUFFER.            X7122000
         $L    IAR,(FBRET2,FBR)    FINALLY, RETURN TO THE CALLER.       X7124000
         TITLE 'DECOMPRESSION'                                          X7126000
*                                                                     * X7128000
*********************************************************************** X7130000
*                                                                     * X7132000
*        $DCOM UNBLOCKS ANOTHER RECORD INTO CALLER'S OUTPUT AREA.     * X7134000
*                                                                     * X7136000
*                                                                     * X7138000
*        VARIOUS LOCATIONS IN THE FB ARE USED AS FOLLOWS ---          * X7140000
*                                                                     * X7142000
*        FBRET1 - RETURN ADDRESS SAVE AREA.                           * X7144000
*        FBXR1  - INDEX REGISTER 1 SAVE AREA.                         * X7146000
*        FBCURL - POINTER TO CURRENT LOCATION IN CURRENT BUFFER,      * X7148000
*           MAINTAINED BY $DCOM.                                      * X7150000
*        FBSRCB - LOGICAL RECORD'S SRCB, RETURNED TO THE CALLER       * X7152000
*           BY $DCOM.                                                 * X7154000
*        FBAREA - POINTER TO THE DECOMPRESSION AREA, SUPPLIED         * X7156000
*           BY THE CALLER TO $DCOM.  ON OUTPUT, POINTER TO LAST+1     * X7158000
*           BYTE OF DECOMPRESSED LOGICAL RECORD.                      * X7160000
*        FBBUF  - BUFFER CHAIN ORIGIN.  BUFFERS ARE ADDED TO THE      * X7162000
*           CHAIN BY $BSCA AND FREED BY $DCOM.                        * X7164000
*                                                                     * X7166000
*        OPERATION ---                                                * X7168000
*                                                                     * X7170000
*             IF NO CURRENT BUFFER EXISTS, MAKE THE BUFFER            * X7172000
*        POINTED TO BY FBBUF CURRENT.  IF FBBUF IS ZERO, NON-         * X7174000
*        PROCESS-EXIT.                                                * X7176000
*             DECOMPRESS THE LOGICAL RECORD POINTED TO BY             * X7178000
*        FBCURL.                                                      * X7180000
*             IF RECORD IS NOT LOGICAL EOF, CHECK NEXT RCB.           * X7182000
*        IF IT IS ZERO, SHOW NO CURRENT BUFFER AND FREE THE           * X7184000
*        CURRENT BUFFER.  IN ANY CASE, RETURN TO +3.                  * X7186000
*             IF RECORD IS LOGICAL EOF SHOW NO CURRENT BUFFER,        * X7188000
*        FREE THE CURRENT BUFFER, AND RETURN TO +0.                   * X7190000
*                                                                     * X7192000
*********************************************************************** X7194000
*                                                                     * X7196000
$DCOM    $ST   ARR,(FBRET1,FBR)    SAVE RETURN ADDRESS.                 X7198000
         $ST   R1,(FBXR1,FBR)      SAVE INDEX REGISTER 1.               X7200000
         $L    R1,(FBCURL,FBR)     POINT TO CURRENT LOC IN BUFFER.      X7202000
         $CLI  (FBCURL-1,FBR),0    ARE WE WORKING ON A BUFFER...        X7204000
         $JNE  DCGO                JUMP IF SO.                          X7206000
         $ST   IAR,(FBENT,FBR)     STORE LOCATION.                      X7208000
         $CLI  (FBBUF-1,FBR),0     IS THERE ANOTHER BUFFER...           X7210000
         $BE   $COMRETA            NON-PROCESS EXIT IF NOT.             X7212000
         $L    R1,(FBBUF,FBR)      POINT TO THE BUFFER.                 X7214000
         $LA   R1,(6,R1)           POINT TO ITS FIRST RCB.              X7216000
DCGO     EQU   *                   EXAMINE NEXT REC IN BUF.             X7218000
         $CLI  (2,R1),0            IS THE SCB ZERO (LOGICAL EOF)...     X7220000
         $JE   DCFRET              JUMP IF SO TO RETURN.                X7222000
         $ALC  (FBRET1,FBR),THREE,2  OTHERWISE UP RETURN ADDRESS BY 3.  X7224000
         $ST   R2,DCR2             SAVE REGISTER 2 ACROSS DECOMPRESS.   X7226000
         $MVC  (FBSRCB,FBR),(1,R1) MOVE SRCB TO THE FB.                 X7228000
         $LA   R1,(2,R1)           POINT TO THE FIRST STRING CTL BYTE.  X7230000
         $L    R2,(FBAREA,FBR)     POINT TO DECOMPRESSION AREA.         X7232000
*                                                                       X7234000
*              EXAMINE STRING CONTROL BYTE AND GO TO EITHER             X7236000
*                END-OF-LOGICAL-RECORD CODE,                            X7238000
*                DUPLICATE-CHARACTER-STRING CODE, OR                    X7240000
*                NONDUPLICATE-CHARACTER-STRING CODE.                    X7242000
*              R1 POINTS TO STRING CONTROL BYTE.                        X7244000
*              R2 POINTS TO NEXT AVAILABLE BYTE IN OUTPUT AREA.         X7246000
*                                                                       X7248000
DC01     $TBF  (0,R1),X'80'        IF END-OF-LOGICAL-RECORD,            X7250000
         $JT   DCEOR               GO TO EOR CODE.                      X7252000
         $MVC  DCWK,(0,R1)         OTHERWISE SAVE SCB.                  X7254000
         $TBF  (0,R1),X'40'        IF THIS IS A DUPLICATE STRING,       X7256000
         $JT   DCDUP               GO TO DUPLICATE-STRING CODE.         X7258000
*                                                                       X7260000
*              PROCESS A NONDUPLICATE CHARACTER STRING.                 X7262000
*                                                                       X7264000
         $SBF  DCWK,X'C0'          ISOLATE STRING COUNT.                X7266000
         $A    R1,DCWK             POINT R1 TO NEXT SCB MINUS 1.        X7268000
         $A    R2,DCWK             POINT R2 TO (CUR OUTPUT LOC)+LENGTH. X7270000
         $MVC  DCMV1+1,DCWK        SET MVC TO MOVE LENGTH+1.            X7272000
DCMV1    $MVC  (0,R2),(1,R1),*-*   MOVE FROM BUFFER TO OUTPUT AREA.     X7274000
         $J    DCLOOP              GO LOOP TO DO NEXT SCB.              X7276000
*                                                                       X7278000
*              PROCESS A DUPLICATE STRING OF CHARACTERS OR BLANKS.      X7280000
*                                                                       X7282000
DCDUP    $SBF  DCWK,X'E0'          ISOLATE DUPLICATE COUNT.             X7284000
         $A    R2,DCWK             POINT R2 TO (CUR OUTPUT LOC)+COUNT.  X7286000
         $MVI  (1,R2),C' '         ASSUME BLANK DUPLICATION.            X7288000
         $TBF  (0,R1),X'20'        IS THIS ASSUMPTION CORRECT...        X7290000
         $JT   DCBLK               IF SO, GO SET UP THE MVC.            X7292000
         $LA   R1,(1,R1)           NO.  POINT TO CHAR TO BE DUPED.      X7294000
         $MVC  (1,R2),(0,R1)       SET DUP CHAR INSTEAD OF BLANK.       X7296000
DCBLK    $MVC  DCMV2+1,DCWK        SET LENGTH FOR MVC.                  X7298000
DCMV2    $MVC  (0,R2),(1,R2),*-*   OVERLAP FIELDS FOR DUPLICATION.      X7300000
DCLOOP   $LA   R1,(1,R1)           NOW POINT TO NEXT SCB                X7302000
         $B    DC01                AND GO PROCESS IT.                   X7304000
*                                                                       X7306000
*              END OF LOGICAL RECORD.                                   X7308000
*                                                                       X7310000
DCEOR    $ST   R2,WORK             TEMP SAVE PTR TO LAST+1 BYTE.        X7312000
         $MVI  (0,R2),C' '         SET THE TWO GARBAGE BYTES            X7314000
         $MVI  (1,R2),C' '           AT END OF OUTPUT TO ZERO.          X7316000
         $LA   R2,*-*              RESTORE THE FB REGISTER.             X7318000
DCR2     EQU   *-1                 SAVEAREA FOR R2.                     X7320000
         $MVC  (FBAREA,FBR),WORK,2 SET PTR TO LAST+1 OUTPUT BYTE.       X7322000
         $LA   R1,(1,R1)           POINT TO THE NEXT RCB                X7324000
         $ST   R1,(FBCURL,FBR)       AND SAVE ITS LOCATION.             X7326000
         $CLI  (0,R1),0            IS IT END-OF-BUF RCB...              X7328000
         $JNE  DCRET               JUMP IF NOT.                         X7330000
*                                                                       X7332000
*              END OF MULTILEAVING BUFFER                               X7334000
*              OR LOGICAL END-OF-FILE                                   X7336000
*                                                                       X7338000
DCFRET   $MVI  (FBCURL-1,FBR),0    SHOW NO CURRENT BUFFER.              X7340000
         $B    $FREEBUF            FREE CURRENT BUFFER.                 X7342000
*                                                                       X7344000
*              EXIT TO CALLER                                           X7346000
*                                                                       X7348000
DCRET    $L    R1,(FBXR1,FBR)      RESTORE R1                           X7350000
         $L    IAR,(FBRET1,FBR)      AND RETURN.                        X7352000
DCWK     $DC   YL2(0)              WORKING LOCATION.                    X7354000
THREE    $DC   YL2(3)              CONSTANT OF THREE.                   X7356000
 TITLE 'COMPRESS'                                                       X7358000
*                                                                     * X7360000
*********************************************************************** X7362000
*                                                                     * X7364000
*        $CMPR COMPRESSES DATA FROM USER'S INPUT AREA INTO A          * X7366000
*              TRANSMISSION BUFFER.                                   * X7368000
*                                                                     * X7370000
*        VARIOUS LOCATIONS IN THE FB ARE USED AS FOLLOWS ---          * X7372000
*                                                                     * X7374000
*        FBRET2 - RETURN ADDRESS SAVE AREA.                           * X7376000
*        FBENT  - NON-PROCESS-EXIT REENTRY ADDRESS SAVE AREA.         * X7378000
*        FBXR1  - REGISTER 1 SAVE AREA.                               * X7380000
*        FBAREA - ADDRESS OF FIRST (HIGH-ORDER) TEXT BYTE, SET BY USE * X7382000
*        FBCLNG - LENGTH OF TEXT TO COMPRESS, SET BY USER.            * X7384000
*        FBSRCB - RECORD CONTROL BYTE (RCB) FOR COMPRESSED RECORD,    * X7386000
*          SET BY USER.  (NOTE- SRCB WILL ALWAYS BE SET TO X'80'.)    * X7388000
*                                                                     * X7390000
*        INPUT AREA - MUST BE 2 BYTES LONGER THAN MAXIMUM LENGTH      * X7392000
*          SPECIFIED IN FBCLNG.  THE INPUT AREA IS DESTROYED BY $CMPR.* X7394000
*                                                                     * X7396000
*        OPERATION ---                                                * X7398000
*                                                                     * X7400000
*        1. $CMPR USES AN INTERNAL WORKAREA.  IF THIS AREA IS IN USE, * X7402000
*           NON-PROCESS-EXIT TILL IT BECOMES FREE.                    * X7404000
*        2. COMPRESS THE USER'S TEXT INTO THE INTERNAL WORKAREA.      * X7406000
*        3. SET THE 2 BYTES IN FRONT OF THE WORKAREA TO THE RCB       * X7408000
*           (FROM FBSRCB) AND THE SRCB (X'80').                       * X7410000
*        4. CALL $CKLEN TO GET SPACE IN A TRANSMISSION BUFFER.        * X7412000
*           $CKLEN MAY NON-PROCESS-EXIT IF NO SPACE IS AVAILAB.E      * X7414000
*        5. SHOW THE INTERNAL WORKAREA FREE AND RETURN TO THE CALLER. * X7416000
*                                                                     * X7418000
*********************************************************************** X7420000
*                                                                     * X7422000
$CMPR    $ST   ARR,(FBRET2,FBR)    SAVE RETURN ADDRESS.                 X7424000
         $ST   R1,(FBXR1,FBR)      SAVE INDEX REGISTER 1.               X7426000
         $ST   IAR,(FBENT,FBR)     PREPARE TO NON-PROCESS EXIT.         X7428000
CMPNOP   $NOPB $COMRETB            EXIT IF COMPRESSION AREA IN USE.     X7430000
         $SBF  CMPNOP+1,X'80'      SET ABOVE NO-OP TO BRANCH.           X7432000
         $ST   R2,COREG2+3         SAVE INDEX REGISTER 2.               X7434000
         $MVC  COACC,(FBAREA,FBR),2  SET SOURCE AREA ADDRESS.           X7436000
         $L    R1,(FBCLNG,FBR)     GET COUNT TO COMPRESS.               X7438000
         $ST   R1,COEND            SAVE TO END TRUNC.                   X7440000
         $A    R1,(FBAREA,FBR)     POINT TO LO-ORD+1 BYTE.              X7442000
         AIF   (&COMP EQ 0).COMP0  *                                    X7444000
COTRUNC  $A    R1,MONE             POINT TO PREVIOUS BYTE.              X7446000
         $CLI  (0,R1),C' '         IS THE BYTE BLANK...                 X7448000
         $JNE  CONOTADJ            IF NOT, END OF TRUNCATION.           X7450000
         $ALC  COEND,MONE,2        REDUCE TRUNCATION CTR BY 1.          X7452000
         $BNZ  COTRUNC             LOOP UNLESS COL 1 BLANK.             X7454000
         AIF   (&COMP GE 2).CMPBLK *                                    X7456000
CONOTADJ $LA   R1,(1,R1)           POIKNT TO LAST+1 CHARACTER.          X7458000
         AGO   .COMP0              *                                    X7460000
.CMPBLK  $LA   R1,(&CCB,R1)        SHOW RECORD AS MIN BLANKS.           X7462000
* FORCE LAST CHARACTER 'X' TO BE FOLLOWED BY 'X+1', 'X'.                X7464000
CONOTADJ $MVI  (1,R1),1            SET LAST+1 TO '1'.                   X7466000
         $ALC  (1,R1),(0,R1)       SET LAST+1 TO 'LAST'+'1'.            X7468000
         $MVC  (2,R1),(0,R1)       SET LAST+2 TO LAST+0.                X7470000
         $LA   R1,(1,R1)           POINT R1 TO LAST+1 NONBLANK BYTE.    X7472000
         $ST   R1,COEND            SAVE THIS LOCATION.                  X7474000
         $LA   R1,COSINK           POINT R1 TO SINK AREA.               X7476000
         $L    R2,(FBAREA,FBR)     POINT R2 TO SOURCE AREA.             X7478000
         $DROP FBR                 FB IS NO LONGER ADDRESSABLE.         X7480000
COOP     EQU   *                   BEGIN A STRING                       X7482000
         $ST   R2,COORG            SET START OF STRING                  X7484000
         AIF   (NOT(&COMP EQ 2 OR &COMP EQ 3 AND &CCB EQ 2)).COMP1      X7486000
*GHP IF BLANK ONLY OR BOTH WITH SMALL COUNT                             X7488000
* LOOK FOR BLANK STRING                                                 X7490000
         $CLC  (&CCB-1,R2),COBLANK,&CCB IS THIS MINIMUM LENGTH BLANKS   X7492000
         $JNE  CONOTBL             IF NOT BLANK EXIT COMPRESSION        X7494000
*                                                                       X7496000
*        BLANK COMPRESSION                                              X7498000
*                                                                       X7500000
COMPBNK  $MVC  COCHSAV,(31,R2),1   SAVE CURRENT LIMIT CHARACTER         X7502000
         $MVI  (31,R2),1           SET TO NON-BLANK                     X7504000
         $LA   R2,(&CCB,R2)        POINT TO FIRST UNCHECKED CHARACTER   X7506000
COMPBNKL $CLI  (0,R2),C' '         TEST FOR BLANK                       X7508000
         $JNE  COFINBNK            IF NOT FINISH UP STRING              X7510000
         $LA   R2,(1,R2)           INCREMENT TO NEXT CHARACTER          X7512000
         $B    COMPBNKL            CONTINUE                             X7514000
COFINBNK $ST   R2,COACC            SAVE REG FOR COUNT CALC              X7516000
         $L    R2,COORG            PICK UP START OF STRING              X7518000
         $MVC  (31,R2),COCHSAV,1   RESTORE SAVED CHARACTER              X7520000
         $L    R2,COACC            PICK SCAN POINTER UP                 X7522000
         $SLC  COACC,COORG,2       CALCULATE LENGTH OF BLANK STRING     X7524000
         $MVC  (0,R1),COACC,1      INSERT LENGTH INTO SCB               X7526000
         $SBN  (0,R1),X'80'        FLAG AS BLANK STRING                 X7528000
         $LA   R1,(1,R1)           POINT TO NEXT SCB                    X7530000
         $B    COOP                BEGIN NEXT STRINT                    X7532000
CONOTBL  EQU   *                                                        X7534000
.COMP1   AIF   (&COMP NE 3).COMP2                                       X7536000
*GHP IF DUPLICATE CHARACTER COMPRESS OF ANY KIND                        X7538000
* LOOK FOR DUPLICATE CHARACTER STRING                                   X7540000
         $CLC  (&CCT-1,R2),(&CCT-2,R2),&CCT-1 DO WE HAVE DUPLICATES     X7542000
         $JNE  CONODUP             IF NOT EXIT COMPRESSION              X7544000
*                                                                       X7546000
*        DUPLICATE CHARACTER COMPRESSION                                X7548000
*                                                                       X7550000
COMPDUP  $MVC  COCHSAV,(31,R2),1   SAVE CURRENT LIMIT CHARACTER         X7552000
         $MVI  (31,R2),1           SET TO VALUE OF 1                    X7554000
         $ALC  (31,R2),(0,R2),1    INSURE CHARACTER NOT SAME            X7556000
         $MVC  COCH,(0,R2),1       SET COMPARE CHARACTER                X7558000
         $LA   R2,(&CCT,R2)        POINT TO FIRST UNCHECKED CHARACTER   X7560000
COCH     EQU   *+1                                                      X7562000
COMPDUPL $CLI  (0,R2),C' '         TEST FOR DUPLICATE CHARACTER         X7564000
         $JNE  COFINDUP            IF NOT FINISH UP STRING              X7566000
         $LA   R2,(1,R2)           INCREMENT TO NEXT CHARACTER          X7568000
         $B    COMPDUPL            LOOP FOR NEXT                        X7570000
COFINDUP $ST   R2,COACC            SAVE REG FOR COUNT CALC              X7572000
         $L    R2,COORG            PICK UP START OF STRING              X7574000
         $MVC  (31,R2),COCHSAV,1   RESTORE SAVED CHARACTER              X7576000
         $L    R2,COACC            PICK SCAN POINTER UP                 X7578000
         $SLC  COACC,COORG,2       CALCULATE LENGTH OF STRING           X7580000
         $MVC  (0,R1),COACC,1      INSERT LENGTH INTO SCB               X7582000
         AIF   (&COMP NE 3 OR &CCB LT 3).COMP2A                         X7584000
*GHP IF DUPLICATE AND BLANK BUT NOT SHORT &CCB                          X7586000
         $CLI  COCH,C' '           LOOK FOR BLANK STRING                X7588000
         $JNE  CODUALNB            IF NOT EXIT TO DUPLICATE STRING      X7590000
         $SBN  (0,R1),X'80'        FLAG AS BLANK STRING                 X7592000
         $LA   R1,(1,R1)           POINT TO NEXT SCB                    X7594000
         $B    COOP                BEGIN NEXT STRING                    X7596000
CODUALNB EQU   *                                                        X7598000
.COMP2A  ANOP                                                           X7600000
         $SBN  (0,R1),X'A0'        FLAG AS DUPLICATE STRING             X7602000
         $MVC  (1,R1),COCH,1       SET DUPLICATE CHARACTER              X7604000
         $LA   R1,(2,R1)           POINT TO NEXT SCB                    X7606000
         $B    COOP                BEGIN NEXT STRING                    X7608000
CONODUP  EQU   *                                                        X7610000
.COMP2   ANOP                                                           X7612000
*                                                                       X7614000
*        CREATE CHARACTER STRING                                        X7616000
*                                                                       X7618000
         $LA   R2,(63,R2)          POINT TO END OF MAXIMUM STRING+1     X7620000
         $ST   R2,COLIM            SAVE FOR END CALCULATION             X7622000
         $CLC  COLIM,COEND,2       TEST FOR END OF RECORD               X7624000
         $JNH  COCHLOP             IF NOT DEVELOP CHARACTER STRING      X7626000
         $L    R2,COEND            PICK END SEQUENCE                    X7628000
         $ST   R2,COLIM            SAVE FOR FINISH OF STRING            X7630000
         $CLC  COORG,COEND,2       CAN WE DO MORE SEARCHING             X7632000
         $JL   COCHLOP             IF SO DEVELOP STRING                 X7634000
         $MVI  (0,R1),0            SET STRING CONTROL TO END OF RECORD  X7636000
.COEND   ANOP                      *                                    X7638000
COREG2   $LA   R2,*-*              RESTORE REGISTER 2.                  X7640000
         $USING FBD,FBR            MAKE THE FUNCTION BLK ADDRESSABLE.   X7642000
         $ST   R1,COMVC1+4         SET UP THE MVC FROM-LOCATION.        X7644000
         $A    R1,COSINK2          SUBTRACT THE ADCON (COSINK-2).       X7646000
         $ST   R1,(FBAREA,FBR)     SAVE TEMPORARILY THE LENGTH-1.       X7648000
         $MVC  COMVC1+1,(FBAREA,FBR)  SET LENGTH-1 INTO THE MVC.        X7650000
         $LA   R1,(1,R1)           SET TRUE LENGTH INTO R1.             X7652000
         $MVC  COSINK-2,(FBSRCB,FBR)  SET RCB INTO RECORD.              X7654000
         $MVI  COSINK-1,X'80'      SET SRCB INTO RECORD.                X7656000
         $B    $CKLEN              GO GET SPACE IN BUFFER.              X7658000
COMVC1   $MVC  (0,R1),*-*,*-*      MOVE RECORD TO BUFFER.               X7660000
         $SBN  CMPNOP+1,X'80'      SHOW WE'RE DONE WITH WORKAREA.       X7662000
         $L    R1,(FBXR1,FBR)      RESTORE REGISTER 1                   X7664000
         $L    IAR,(FBRET2,FBR)      AND RETURN TO CALLER.              X7666000
         AIF   (&COMP LT 2).COMP00 *                                    X7668000
CORETURN $B    *-*                 RETURN TO CALLER                     X7670000
*                                                                       X7672000
*        STRING SEARCH LOOP                                             X7674000
*                                                                       X7676000
COCHLOP  $MVC  COCHSAV,(&CCB-1,R2),&CCB SAVE CHARACTER STRING           X7678000
         $MVC  (&CCB-1,R2),COBLANK,&CCB INSERT BLANKS TO STOP SCAN      X7680000
         $L    R2,COORG PICK UP START OF STRING                         X7682000
COCHLOOP $LA   R2,(1,R2)           POINT TO NEXT CHARACTER              X7684000
         AIF   (NOT(&COMP EQ 2 OR &COMP EQ 3 AND &CCB EQ 2)).COMP3      X7686000
* GHP IF BLANK ONLY OR BOTH WITH SMALL COUNT                            X7688000
         $CLC  (&CCB-1,R2),COBLANK,&CCB IS THIS MINIMUM LENGTH BLANK    X7690000
         AIF   (&COMP EQ 2).COMP4                                       X7692000
*GHP IF SHORT BLANK AND DUPLICATE COMPRESS                              X7694000
         $JE   COCHFIN             IF MATCH FINISH STRING               X7696000
.COMP3   ANOP                                                           X7698000
*GHP IF DUPLICATE CHARACTER COMPRESS OF ANY KIND                        X7700000
         $CLC  (&CCT-1,R2),(&CCT-2,R2),&CCT-1 DO WE HAVE DUPLICATES     X7702000
.COMP4   ANOP                                                           X7704000
         $BNE  COCHLOOP            IF NOT CONTINUE                      X7706000
*                                                                       X7708000
*        MOVE CHARACTER STRING                                          X7710000
*                                                                       X7712000
COCHFIN  EQU   *                                                        X7714000
         $ST   R2,COACC            PREPARE TO CALCULATE STRING LENGTH   X7716000
         $L    R2,COLIM            PICK UP START OF MODIFIED STRING     X7718000
         $MVC  (&CCB-1,R2),COCHSAV,&CCB RESET CHARACTER STRING          X7720000
         $L    R2,COACC            PICK UP START OF NEXT STRING         X7722000
         $SLC  COACC,COORG,2       STRING LENGTH                        X7724000
         $MVC  (0,R1),COACC,1      SET STRING COUNT                     X7726000
         $SBN  (0,R1),X'C0'        SET STRING CONTROL BYTE              X7728000
         $A    R1,COACC            POINT TO LAST OF STRING RECEIVER     X7730000
         $LA   R1,(1,R1)           PLUS ONE, NEXT SCB                   X7732000
         $MVC  COMVC+1,COACC,1     SET MOVE COUNT                       X7734000
COMVC    $MVC  (0,R1),(0,R2),*-*   MOVE STRING PLUS ONE                 X7736000
         $B    COOP                LOOK AT NEXT STRING                  X7738000
COLIM    $DC   HL2'0'              ADDRESS OF END OF MAXIMUM STRING+    X7740000
COBLANK  $DC   CL(&CCB)' '         BLANK STRING FOR COMPARE             X7742000
COCHSAV  $DC   CL(&CCB)' '         SAVE CHARACTERS                      X7744000
         AGO   .COMP00                                                  X7746000
.COMP0   ANOP                                                           X7748000
*GHP NO COMPRESSION OPTION                                              X7750000
*                                                                       X7752000
*        MOVE MAXIMUM LENGTH STRINGS                                    X7754000
*                                                                       X7756000
         $ST   R1,COEND            SAVE LOC OF LAST+1 CHARACTER.        X7758000
         $LA   R1,COSINK           POINT R1 TO COMPRESSION AREA.        X7760000
         $L    R2,(FBAREA,FBR)     POINT R2 TO SOURCE AREA.             X7762000
COOP     $ST   R2,COORG            SAVE START OF STRING                 X7764000
         $LA   R2,(63,R2)          POINT TO END OF STRING+1             X7766000
         $ST   R2,COACC            SAVE FOR END TEST                    X7768000
         $CLC  COACC,COEND,2       DO WE EXTEND BEYOND DATA             X7770000
         $JNL  COLST               IF BEYOND MOVE LAST STRING           X7772000
         $MVI  (0,R1),X'C0'+63     SET SCB COUNT TO 63                  X7774000
         $LA   R1,(64,R1)          POINT TO LAST CHARACTER+1            X7776000
         $MVC  (0,R1),(0,R2),64    MOVE FULL STRING IN                  X7778000
         $B    COOP                LOOP FOR MORE                        X7780000
COLST    $L    R2,COEND            SET UPPER LIMIT+1                    X7782000
         $SLC  COEND,COORG,2       CALCULATE LENGTH                     X7784000
         $MVC  (0,R1),COEND,1      SET LENGTH IN SCB                    X7786000
         $SBN  (0,R1),X'C0'        INSERT STRING ID                     X7788000
         $A    R1,COEND            POINT TO END SCB                     X7790000
         $LA   R1,(1,R1)                                                X7792000
         $MVC  COMVC+1,COEND,1     SET MOVE INSTRUCTION                 X7794000
COMVC    $MVC  (0,R1),(0,R2),*-*   MOVE CHARACTER STRING                X7796000
         $MVI  (0,R1),X'00'        SET END OF RECORD SCB                X7798000
         AGO   .COEND              *                                    X7800000
.COMP00  ANOP                                                           X7802000
COEND    $DC   HL2'0'              ADDRESS OF END OF RECORD+1-&CCT      X7804000
COORG    $DC   HL2'0'              ADDRESS OF START OF STRING           X7806000
COACC    $DC   HL2'0'              WORK AREA                            X7808000
MONE     $DC   HL2'-1'             CONSTANT OF '-1'.                    X7810000
COSINK2  $DC   YL2(2-COSINK)       ADCON TO SUBTRACT.                   X7812000
         DC    YL2(0)              2 BYTES BEFORE THE AREA.             X7814000
COSINK   DC    XL(128+&CCB)'0'     COMPRESSION AREA.                    X7816000
         TITLE '$CKLEN - RETURN ADDRESS FOR ML BUFFER STUFFING'         X7818000
*********************************************************************** X7820000
*                                                                     * X7822000
*                                                                     * X7824000
*        ROUTINE $CKLEN SPECIFIES TO CALLER AN ADDRESS IN A MULTI-    * X7826000
*        LEAVING BUFFER INTO WHICH THE USER WILL MOVE A COMPLETE LOGIC* X7828000
*        AL RECORD.                                                   * X7830000
*                                                                     * X7832000
*        INPUT FROM CALLER -                                          * X7834000
*              IN XR1, THE LENGTH OF THE CALLER'S COMPLETE LOGICAL    * X7836000
*              RECORD.                                                * X7838000
*              IN XR2, THE ADDRESS OF THE CALLER'S FB.                * X7840000
*                                                                     * X7842000
*        OUTPUT TO CALLER -                                           * X7844000
*              IN XR1, THE ADDRESS OF THE LOW-ORDER (HIGH-ADDRESS) BYT* X7846000
*              OF THE AREA (WITHIN A ML BUFFER) THAT HAS BEEN ASSIGNED* X7848000
*              TO THE CALLER.                                         * X7850000
*                                                                     * X7852000
*        SYSTEM LOCATIONS USED -                                      * X7854000
*              $CURMLB POINTS TO CHAIN FIELD OF CURRENT ML BUFFER.    * X7856000
*              $CURMLL POINTS TO LAST USABLE BYTE OF DITTO.           * X7858000
*              $CURMLP POINTS TO LAST-USED BYTE OF DITTO.             * X7860000
*              $MLPOOL POINTS TO A CHAIN OF FREE ML BUFFERS.          * X7862000
*                                                                     * X7864000
*        OPERATION -                                                  * X7866000
*                                                                     * X7868000
*      THE ROUTINE ATTEMPTS TO GET SPACE IN THE CURRENT BUFFER.  IF   * X7870000
* SUCCESSFUL, IT RETURNS TO THE CALLER.  IF NOT ENOUGH SPACE EXISTS   * X7872000
* IN THE CURRENT BUFFER, THE ROUTINE QUEUES IT ON $FBBSCA.  ALSO, IF  * X7874000
* NOT ENOUGH SPACE EXISTS OR UPON ENTRY THERE WAS NO CURRENT BUFFER,  * X7876000
* THE ROUTINE TRIES TO GET ANOTHER BUFFER.  IF SUCCESSFUL, IT INIT-   * X7878000
* IALIZES THE POINTERS TO THE NEW CURRENT BUFFER AND AGAIN ATTEMPTS   * X7880000
* TO GET SPACE.  IF UNSUCCESSFUL AT GETTING A NEW CURRENT BUFFER, IT  * X7882000
* TAKES A NON-PROCESS EXIT AND ON REENTRY TRIES AGAIN TO GET A        * X7884000
* BUFFER.                                                             * X7886000
*                                                                     * X7888000
*      $BFLUSH ---                                                    * X7890000
*                                                                     * X7892000
*      THIS ENTRY IS FOR TRUNCATING AND QUEUEING THE CURRENT BUFFER.  * X7894000
* WHEN $BFLUSH IS CALLED, THERE MUST BE A CURRENT BUFFER.  AFTER THE  * X7896000
* ROUTINE HAS QUEUED THE BUFFER, IT TRIES TO GET ANOTHER BUFFER.  IF  * X7898000
* SUCCESSFUL, IT INITIALIZES POINTERS TO THE NEW CURRENT BUFFER.  BUT * X7900000
* IF THERE ARE NO FREE BUFFERS, THE ROUTINE RETURNS TO THE CALLER     * X7902000
* RATHER THAN DO A NON-PROCESS EXIT.                                  * X7904000
*                                                                     * X7906000
*********************************************************************** X7908000
*                                                                     * X7910000
*              ENTRY TO TRUNCATE CURRENT BUFFER.                      * X7912000
*                                                                     * X7914000
$BFLUSH  $ST   ARR,(FBRET1,FBR)    SAVE RETURN ADDRESS.                 X7916000
         $LA   R1,0                SHOW ZERO AS THE LENGTH TO GET.      X7918000
         $J    CKL30               GO QUEUE THE CURRENT BUFFER.         X7920000
*                                                                       X7922000
*              ENTRY TO OBTAIN SPACE IN THE CURRENT BUFFER.             X7924000
*                                                                       X7926000
$CKLEN   $ST   ARR,(FBRET1,FBR)    SAVE RETURN ADDRESS.                 X7928000
         $ST   R1,(FBREG1,FBR)     SAVE LENGTH REQUIRED BY CALLER.      X7930000
         $ST   IAR,(FBENT,FBR)     SAVE REENTRY POINT FOR NO BUFFERS.   X7932000
         $CLI  $CURMLB-1,0         IS THERE NOW A CURRENT BUFFER...     X7934000
         $JE   CKL40               IF NOT, GO TRY TO GET ONE.           X7936000
*                                                                       X7938000
*                                                                       X7940000
*              IF ENOUGH SPACE IS AVAILABLE IN CURRENT ML BUFFER,       X7942000
*              ASSIGN THAT SPACE TO THE CALLER AND RETURN.              X7944000
*                                                                       X7946000
*                                                                       X7948000
CKL21    $ALC  (FBREG1,FBR),$CURMLP,2  ADD TO IT THE CURRENT POINTER.   X7950000
         $CLC  (FBREG1,FBR),$CURMLL,2  IS SUM .LE. ADR OF LAST AVL BYTE X7952000
         $JH   CKL30               JUMP IF NOT TO QUEUE CUR ML BUFFER.  X7954000
         $L    R1,(FBREG1,FBR)     SET OUTPUT TO CALLER IN R1,          X7956000
         $ST   R1,$CURMLP          AND UPDATE $CURMLP.                  X7958000
         $L    IAR,(FBRET1,FBR)    THEN RETURN TO CALLER.               X7960000
*                                                                       X7962000
*                                                                       X7964000
*              NOT ENOUGH SPACE IS LEFT IN CURRENT ML BUFFER TO SATISFY X7966000
*              THE CALLER'S REQUEST.  QUEUE THE CURRENT ML BUFFER       X7968000
*              FOR TRANSMISSION.                                        X7970000
*                                                                       X7972000
*                                                                       X7974000
CKL30    EQU   *                                                        X7976000
         $ST   R1,(FBREG1,FBR)     SAVE R1 IN THE FB.                   X7978000
         $LA   R1,$FBBSCA+FBBUF-FBD POINT TO XMIT BUF QUEUEING FIELD.   X7980000
CKL31    $CLC  (0,R1),ZERO,2       ARE WE AT END-OF-CHAIN...            X7982000
         $JZ   CKL32               JUMP IF YES.                         X7984000
         $L    R1,(0,R1)           NO, NOT YET.  GO TO NEXT LINK.       X7986000
         $B    CKL31               CHECK NEXT LINK FOR END-OF-CHAIN.    X7988000
CKL32    $MVC  (0,R1),$CURMLB,2    STICK CUR BUF ON END OF CHAIN.       X7990000
         $L    R1,$CURMLB          POINT R1 TO CURRENT BUFFER.          X7992000
         $MVC  (2,R1),$CURMLP,4    BYTES 1-4 TO AL2(0,LAST BYTE USED).  X7994000
         $MVI  $CURMLB-1,0         SHOW NO CURRENT BUFFER.              X7996000
         $L    R1,(2,R1)           POINT TO THE LAST BYTE USED.         X7998000
         $MVC  (2,R1),ETBSEQ,2     MOVE IN EOB AND ETB AS END SEQUENCE. X8000000
         $ALC  $FBBSCA+FBBCT-FBD,ONE  UP $BSCA BUFFER CTR BY ONE.       X8002000
         $SBN  BCF1,BFPOST         POST THE BSCA PROCESSOR.             X8004000
*                                                                       X8006000
*                                                                       X8008000
*              GET A NEW ML BUFFER, INITIALIZE FOR IT, AND              X8010000
*              GO BACK TO SATISFY CALLER'S REQUEST.                     X8012000
*                                                                       X8014000
*                                                                       X8016000
CKL40    $CLC  (FBREG1,FBR),ZERO,2 IF ENTRY WAS NOT VIA $BFLUSH,        X8018000
         $JNE  CKL50               GO TRY TO GET ANOTHER BIFFER.        X8020000
         $L    IAR,(FBRET1,FBR)    OTHERWISE RETURN TO CALLER.          X8022000
CKL50    $L    R1,$MLPOOL          GET ADDRESS OF A NEW BUFFER          X8024000
         $ST   R1,$CURMLB          AND SHOW IT AS OUR CURRENT BUFFER.   X8026000
         $CLI  $MLPOOL-1,0         WAS A BUFFER AVAILABLE...            X8028000
         $BE   $COMRETB            IF NOT, NON-PROCESS EXIT.            X8030000
         $MVC  $MLPOOL,(0,R1),2    DEQUEUE BUFFER FROM FREE POOL.       X8032000
         $LA   R1,(5,R1)           POINT TO THE SPOT FOR FCS2.          X8034000
         $ST   R1,$CURMLP          SET LAST-USED BYTE.                  X8036000
         $A    R1,CKLLAST          UP R1 TO LAST AVAILABLE BYTE.        X8038000
         $ST   R1,$CURMLL          SET LAST AVAILABLE BYTE.             X8040000
         $L    R1,(FBREG1,FBR)     SET R1 AS ON ENTRY.                  X8042000
         $B    CKL21               NOW GO ALLOCATE FOR THE USER.        X8044000
*                                                                       X8046000
*                                                                       X8048000
*              CONSTANTS AND SYSTEM CELLS.                              X8050000
*                                                                       X8052000
*                                                                       X8054000
ZERO     $DC   YL2(0)              HALFWORD CONSTANT OF ZERO.           X8056000
$CURMLP  $DC   YL2(0)              POINTER TO CURRENT BUFFER'S FCS2.    X8058000
$CURMLL  $DC   YL2(0)              POINTER TO LAST AVAILABLE BYTE.      X8060000
$CURMLB  $DC   YL2(0)              POINTER TO CUR ML BUF CHAIN WORD.    X8062000
CKLLAST  $DC   YL2(0-7)            CONSTANT TO COMPUTE $CURMLL,         X8064000
*                                  INITIALIZED WITH &MLBFSIZ BY $ALC.   X8066000
$MLPOOL  $DS   YL2                 POOL POINTER - SET BY INITIALIZATION X8068000
         TITLE '$FREEBUF - FREE A ML BUFFER'                            X8070000
*                                                                       X8072000
*                                                                       X8074000
*              $FREEBUF - DEQUEUE A ML BUFFER FROM A FUNCTION BLOCK,    X8076000
*        REDUCE THE FUNCTION BLOCK'S COUNT OF BUFFERS BY ONE, AND       X8078000
*        QUEUE THE FREED BUFFER ON $MLPOOL.                             X8080000
*                                                                       X8082000
*                                                                       X8084000
$FREEBUF $ST   ARR,FRERET+3        SAVE RETURN ADDRESS.                 X8086000
         $ST   R1,FRER1+3          SAVE REGISTER 1.                     X8088000
         $SLC  (FBBCT,FBR),ONE     REDUCE BUFFER COUNT BY 1.            X8090000
         AIF   (NOT &DEBUG).FREBUG *                                    X8092000
         $BM   ABEND               IF NEGATIVE, ABEND.                  X8094000
.FREBUG  $CLC  (FBBCT,FBR),(FBBMX,FBR)  CAN WE TAKE MORE BUFFERS...     X8096000
         $JNL  FRE1                JUMP IF NOT.                         X8098000
         $MVC  FFCB1+1,(FBFCS1,FBR)  OTHERWISE                          X8100000
FFCB1    $SBN  $FCS1,*-*               TURN ON                          X8102000
         $MVC  FFCB2+1,(FBFCS2,FBR)      THE APPROPRIATE                X8104000
FFCB2    $SBN  $FCS2,*-*                   BIT IN $FCS.                 X8106000
         $SBN  BCF1,BFCSON+BFPOST  SHOW FCS BIT ON, POST BSCA.          X8108000
         $SBN  (FBFLG,FBR),BFCSON  SHOW THIS FB TURNED FCS ON.          X8110000
FRE1     $L    R1,(FBBUF,FBR)      POINT TO CURRENT BUFFER.             X8112000
         $MVC  (FBBUF,FBR),(0,R1),2  DEQUEUE IT FROM FUNCTION BLOCK.    X8114000
         $MVC  (0,R1),$MLPOOL,2    QUEUE IT ONTO                        X8116000
         $ST   R1,$MLPOOL          THE FREE BUFFER CHAIN.               X8118000
         AIF   (NOT &S35471).F71   *                                    X8120000
         $POST $FBCON,WORK+EWFPOST POST 5471 PROCESSOR.                 X8122000
.F71     ANOP                      *                                    X8124000
FRER1    $LA   R1,*-*              RESTORE REGISTER 1                   X8126000
FRERET   $B    *-*                 AND RETURN TO CALLER.                X8128000
         AIF   (NOT &DEBUG).NOABEND  *                                  X8130000
         TITLE 'ABNORMAL END DUMP SUBROUTINE'                           X8132000
ABEND    EQU   *                                                        X8134000
         $ST   ARR,1               DUMP ARR                             X8136000
         $ST   R1,3                DUMP R1                              X8138000
         $ST   R2,5                DUMP R5                              X8140000
         $SIO  14,0,4,1            EJECT A PAGE.                        X8142000
         $MVC  DCUR,ZERO,2         START DUMPING AT ZERO                X8144000
D1       $L    R2,DCUR             GET DUMP START.                      X8146000
         $L    R1,DLN              POINT TO START OF LINE.              X8148000
         $MVI  (131,R1),C' '       SET PRINT LINE                       X8150000
         $MVC  (130,R1),(131,R1),131                   TO BLANKS.       X8152000
         $CLC  DCUR,DLIM,2         IS THERE MORE CORE TO DUMP...        X8154000
         $JL   D3                  JUMP IF YES.                         X8156000
D2       $HPL  HA                  HALT IF NO.                          X8158000
         $B    ABEND+12            RESTART IF REQUESTED.                X8160000
D3       $MVI  DFC,2               DUMP 2 BYTES OF LINE ADR             X8162000
         $LA   R2,DCUR-1           SHOW WHERE ADDRESS IS.               X8164000
         $B    DFORMAT             GO DO IT.                            X8166000
         $LA   R1,(2,R1)           ADD 2 BLANKS.                        X8168000
         $L    R2,DCUR             NOW DUMP THE CORE,                   X8170000
         $MVI  DFC,4               4 BYTES AT A TIME.                   X8172000
         $B    DFORMAT             BYTES 0-3                            X8174000
         $B    DFORMAT             BYTES 4-7                            X8176000
         $B    DFORMAT             BYTES 8-11                           X8178000
         $B    DFORMAT             BYTES 12-15                          X8180000
         $LA   R1,(1,R1)           ADD A BLANK                          X8182000
         $B    DFORMAT             BYTES 16-19                          X8184000
         $B    DFORMAT             BYTES 20-23                          X8186000
         $B    DFORMAT             BYTES 24-27                          X8188000
         $B    DFORMAT             BYTES 28-31                          X8190000
         $LA   R1,(1,R1)           ADD A BLANK                          X8192000
         $MVI  (0,R1),C'*'         ASTERISK                             X8194000
         $L    R2,DCUR             POINT TO SOURCE                      X8196000
         $MVC  (32,R1),(31,R2),32  MOVE FOR EBCDIC.                     X8198000
         $MVI  (33,R1),C'*'        ASTERISK                             X8200000
         $SNS  14,0,3,WORK         FIND LENGTH OF CHAIN IMAGE.          X8202000
         $LA   R2,48               ASSUME 48-CHARACTER CHAIN.           X8204000
         $TBN  WORK,4              IS IT 48-CHAR                        X8206000
         $JT   DE1                 JUMP YES                             X8208000
         $LA   R2,60               NO, 120                              X8210000
DE1      $ST   R2,DCC              SAVE COUNT.                          X8212000
         $MVI  DCCC,32             SAVE CT OF CHARS TO CK.              X8214000
         $MVC  DCCK,DCCC           SET NR OF CHARS TO CK.               X8216000
DE10     $L    R2,DIM              POINT TO 1ST IMAGE BYTE.             X8218000
         $MVC  DCK,DCC             SET IMAGE LENGTH.                    X8220000
         $LA   R1,(1,R1)           GET A BYTE OF DUMP.                  X8222000
         $MVC  DE11+1,(0,R1)       MOVE IT INTO CLI.                    X8224000
DE11     $CLI  (0,R2),*-*          CHECK CHARACTER.                     X8226000
         $JE   DE12                JUMP IF PRINTABLE.                   X8228000
         $LA   R2,(1,R2)           ELSE PT TO NEXT IMAGE CHAR.          X8230000
         $SLC  DCK,ONE             REDUCE IMAGE CT BY 1.                X8232000
         $BNZ  DE11                CK AGAIN IF NOT ZERO.                X8234000
         $MVI  (0,R1),C' '         ELSE SET TO BLANK.                   X8236000
DE12     $SLC  DCCK,ONE            MORE CHARS TO CHECK...               X8238000
         $BNZ  DE10                B IF SO.                             X8240000
         $MVI  DDP+1,X'80'         ALLOW DUP-LINE ASTERISKS.            X8242000
DPRINT   $LIO  14,0,4,DIM          SET PRINTER IMAGE ADR.               X8244000
         $LIO  14,0,6,DLN          SET PRINTER DATA ADDRESS.            X8246000
         $SIO  14,0,2,1            PRINT                                X8248000
         $APL  14,0,2              WAIT                                 X8250000
DA       $L    R2,DCUR             POINT TO CURRENT SOURCE.             X8252000
         $ALC  DCUR,DC32,2         UP CUR PTR BY 32.                    X8254000
         $CLC  DCUR,DLIM,2         IF AT LIMIT,                         X8256000
         $BNL  D2                  GO HALT.                             X8258000
         $CLC  (31,R2),(63,R2),32  CHECK DUPLICATE LINE.                X8260000
         $BNE  D1                  IF NOT, DUMP IT.                     X8262000
DDP      $NOPB DA                  B IF AST ALREADY PRINTED.            X8264000
         $MVI  DDP+1,0             SET $NOPB TO $B.                     X8266000
         $L    R2,DLN              NO.  GET ADDR OF LINE.               X8268000
         $MVI  (131,R2),C' '       DLEAR THE                            X8270000
         $MVC  (130,R2),(131,R2),131  LINE.                             X8272000
         $MVC  (3,R2),DAST,4       SET ASTERISKS.                       X8274000
         $B    DPRINT              PRINT ASTERISKS.                     X8276000
         SPACE 5                                                        X8278000
DFORMAT  $ST   ARR,DFEND+3         SAVE RETURN ADDRESS.                 X8280000
         $MVC  DFK,DFC             DON'T DESTROY CALLER'S COUNT.        X8282000
DF0      $MNZ  (0,R1),(0,R2)       SINK A ZONE.                         X8284000
         $MNN  (1,R1),(0,R2)       SINK A NUMERIC.                      X8286000
         $SBN  (0,R1),X'F0'        SET ALL ZONE BITS IN                 X8288000
         $SBN  (1,R1),X'F0'        BOTH SINK BYTES.                     X8290000
         $CLI  (0,R1),C'9'         IS LEFT BYTE NUMERIC...              X8292000
         $JNH  DF1                 JUMP YES.                            X8294000
         $SLC  (0,R1),FIFTY7       NO.  ADJUST IT.                      X8296000
DF1      $CLI  (1,R1),C'9'         IS RIGHT BYTE NUMERIC...             X8298000
         $JNH  DF2                 JUMP YES.                            X8300000
         $SLC  (1,R1),FIFTY7       NO.  ADJUST IT.                      X8302000
DF2      $LA   R1,(2,R1)           UP SINK REGISTER BY 2.               X8304000
         $LA   R2,(1,R2)           UP SOURCE REGISTER BY 1.             X8306000
         $SLC  DFK,ONE             REDUCE COUNT BY 1.                   X8308000
         $BNZ  DF0                 BR IF MORE TO DO.                    X8310000
         $LA   R1,(1,R1)           OTHERWISE LEAVE A BLANK              X8312000
DFEND    $B    *-*                 AND RETURN.                          X8314000
         SPACE 5                                                        X8316000
DLN      $DC   YL2(LPDA)                                                X8318000
DIM      $DC   YL2(LPIA)                                                X8320000
DLIM     $DC   YL2(&MACHSIZ-1)                                          X8322000
DCUR     $DS   YL2                                                      X8324000
DC32     $DC   HL2'32'                                                  X8326000
DAST     $DC   C'****'                                                  X8328000
DFK      DS    X                                                        X8330000
DFC      DS    X                                                        X8332000
DCK      DS    X                                                        X8334000
DCC      DS    X                                                        X8336000
DCCK     DS    X                                                        X8338000
DCCC     DS    X                                                        X8340000
.NOABEND ANOP                      *                                    X8342000
         TITLE '$LOG - HASP ERROR RECORDING'                            X8344000
*                                                                     * X8346000
*********************************************************************** X8348000
*                                                                     * X8350000
*        $LOG COUNTS THE 1-BITS IN A STATUS BYTE.                     * X8352000
*                                                                     * X8354000
*        INPUT IS R1 POINTING TO A 7-BYTE AREA ---                    * X8356000
*           BYTE 0   - THE STATUS BYTE (DESTROYED ON OUTPUT)          * X8358000
*           BYTE 1,2 - POINTER TO FIRST COUNTER (TRANSPARENT)         * X8360000
*           BYTE 3-6 - 4-BYTE WORK AREA (GARBAGE).                    * X8362000
*                                                                     * X8364000
*        R1 AND R2 ARE TRANSPARENT TO THE CALLER.                     * X8366000
*                                                                     * X8368000
*********************************************************************** X8370000
*                                                                     * X8372000
         SPACE 3                                                        X8374000
$LOG     $ST   ARR,(4,R1)          SAVE RETURN ADDRESS.                 X8376000
         $ST   R2,(6,R1)           SAVE REGISTER 2.                     X8378000
         $L    R2,(2,R1)           POINT R2 TO FIRST COUNTER.           X8380000
LOG1     $ALC  (0,R1),(0,R1)       ADD THE STATUS BYTE TO ITSELF.       X8382000
         $JC   LOG2,X'20'          SKIP IF NO CARRY.                    X8384000
         $ALC  (1,R2),ONE,2        OTHERWISE UP A COUNTER BY ONE.       X8386000
LOG2     $LA   R2,(2,R2)           POINT R2 TO THE NEXT COUNTER.        X8388000
         $BC   LOG1,162            B IF CARRY OR IF NO CARRY & NOT ZERO X8390000
         $L    R2,(6,R1)           OTHERWISE, RESTORE R2                X8392000
         $L    IAR,(4,R1)          AND RETURN TO CALLER.                X8394000
         SPACE 5                                                        X8396000
LOGEND   EQU   &MACHSIZ-1                                               X8398000
         AIF   (NOT &S31442).LOG1442  *                                 X8400000
LOG1442B EQU   &MACHSIZ-16         1442 STATUS BYTE 2 COUNTERS          X8402000
LOG1442A EQU   &MACHSIZ-32         1442 STATUS BYTE 1 COUNTERS          X8404000
&MACHSIZ SETA  &MACHSIZ-32         *                                    X8406000
.LOG1442 ANOP                      *                                    X8408000
LOGBSCA  EQU   &MACHSIZ-16         BSCA STATUS BYTE 2 COUNTERS          X8410000
LOG5203B EQU   &MACHSIZ-32         5203 STATUS BYTE 2 COUNTERS          X8412000
LOG5203A EQU   &MACHSIZ-48         5203 STATUS BYTE 1 COUNTERS          X8414000
         AIF   (NOT &S35424).NOMFCUL                                    X8416000
LOG5424  EQU   &MACHSIZ-64         5424 STATUS BYTE 1 COUNTERS          X8418000
.NOMFCUL ANOP                                                           X8420000
&MACHSIZ SETA  &MACHSIZ-48-&S35424*16                                   X8422000
LOGLEN   EQU   LOGEND-&MACHSIZ+1   LENGTH OF LOG COUNTERS               X8424000
LOGID    EQU   &MACHSIZ-1          ADDRESS OF LOG ID                    X8426000
&MACHSIZ SETA  &MACHSIZ-5          LEAVE SPACE FOR 'HASP'               X8428000
         TITLE '$MSG --- MESSAGE-TRACING SUBROUTINE'                    X8430000
$MSG     $ST   ARR,MSGXIT+3        SAVE RETURN ADDRESS.                 X8432000
         $ALC  MSGPLACE,FOUR,2     UP MSG TRACE ADR BY 4.               X8434000
         $CLC  MSGPLACE,AMSGLAST,2 COMPARE WITH THE MAXIMUM.            X8436000
         $JNH  MSG01               JUMP IF STILL WITHIN BOUNDS.         X8438000
         $MVC  MSGPLACE,AMSGFRST,2 ELSE RESET TRACE ADR TO FIRST.       X8440000
MSG01    $MVC  MSGFIRST,(3,R1),4   PUT MESSAGE IN TRACE BABLE.          X8442000
         AIF   (NOT &S35471).MSGP  *                                    X8444000
         $POST $FBCON,WORK+EWFPOST POST 5471 PROCESSOR FOR WORK.        X8446000
         AGO   .MNOPRT             *                                    X8448000
         $POST $FBCONP,WORK        POST CONSOLE PRINTER FOR WORK.       X8450000
.MSGP    AIF   (&PRTCONS NE 1 AND &PRTCONS NE 2).MNOPRT  *              X8452000
         $POST $FBCONP,WORK        POST PRTCON PROCESSOR FOR WORK.      X8454000
.MNOPRT  ANOP                      *                                    X8456000
MSGPLACE EQU   MSG01+3             ADR OF LOW-ADDRESS TRACE ENTRY.      X8458000
MSGXIT   $B    *-*                 RETURN TO CALLER.                    X8460000
         SPACE 5                                                        X8462000
MESSAGES DC    XL(4*&S3TRACE)'0'   MESSAGE TRACE TABLE                  X8464000
MSGFIRST EQU   MESSAGES+3          ADR OF FIRST ENTRY                   X8466000
MSGLAST  EQU   MESSAGES+L'MESSAGES-1  ADR OF LAST ENTRY                 X8468000
FOUR     $DC   YL2(4)              CONSTANT OF 4.                       X8470000
AMSGFRST $DC   YL2(MSGFIRST)       POINTER TO FIRST ENTRY               X8472000
AMSGLAST $DC   YL2(MSGLAST)        POINTER TO LAST ENTRY                X8474000
         TITLE 'FUNCTION BLOCKS'                                        X8476000
         AIF   (NOT &S35424).NOMFCUM                                    X8478000
A5424    $FB   ENT=$MFCU,SHORT=YES,R1=HCA1                              X8480000
B5424    $FB   ENT=$MFCU,SHORT=YES,R1=HCA2                              X8482000
.NOMFCUM ANOP                                                           X8484000
         AIF   (NOT &S31442).FB5203  *                                  X8486000
#1442    $FB   ENT=$1442,SHORT=YES,R1=HCA1442                           X8488000
.FB5203  ANOP                                                           X8490000
#5203    $FB   ENT=$5203,SHORT=YES,R1=PCA                               X8492000
BSCA     $FB   ENT=BS200,R1=BCA,BMX=0                                   X8494000
$FBFRSTE EQU   *                   FIRST FB ELIGIBLE FOR RCVD BUFFERS.  X8496000
         AIF   (NOT &S35471).CON75 *                                    X8498000
CON      $FB   ENT=$CON,R1=CCA,WORK=11,RCB=X'91',BMX=255,EWF=EWFPOST    X8500000
         AGO   .CONEND                                                  X8502000
.CON75   AIF   (NOT &S35475).CONP                                       X8504000
CON      $FB   ENT=CONEND,R1=CCA,WORK=11                                X8506000
.CONP    AIF   (&PRTCONS NE 1 AND &PRTCONS NE 2).CONEND                 X8508000
CONP     $FB   ENT=$CONP,R1=PCA,WORK=11,RCB=X'91',BMX=255               X8510000
.CONEND  ANOP                                                           X8512000
&TEMP    SETA  &S3NRDRS            *                                    X8514000
&TMP     SETA  1                                                        X8516000
.RD      AIF   (&TEMP LE 0).RDE    *                                    X8518000
RD&TMP   $FB   ENT=$READER,RCB=X'83'+16*&TMP,WORK=9,                   CX8520000
               FLG=FFLAST*(&TMP/&S3NRDRS)                               X8522000
&TEMP    SETA  &TEMP-1                                                  X8524000
&TMP     SETA  &TMP+1                                                   X8526000
         AGO   .RD                                                      X8528000
.RDE     ANOP                                                           X8530000
PR1      $FB   ENT=$PRINTER,                                           CX8532000
               BMX=NBUFPR,WORK=11,RCB=RCBPR1,FCS=FCSPR1                 X8534000
&TEMP    SETA  &S3NPUNS            *                                    X8536000
&TMP     SETA  1                                                        X8538000
.PU      AIF   (&TEMP LE 0).PUE    *                                    X8540000
PU&TMP   $FB   ENT=$PUNCH,FLG=FFLAST*(&TMP/&S3NPUNS),                  CX8542000
               WORK=11+40*&S3OBJDK+48*&S396COL-40*&S3OBJDK*&S396COL,   CX8544000
               BMX=NBUFPU,RCB=RCBPU&TMP,FCS=FCSPU&TMP                   X8546000
&TEMP    SETA  &TEMP-1                                                  X8548000
&TMP     SETA  &TMP+1                                                   X8550000
         AGO   .PU                                                      X8552000
.PUE     ANOP                                                           X8554000
         SPACE 5                                                        X8556000
$FB&FBN  EQU   0                   END OF FUNCTION BLOCKS.              X8558000
NBUF     EQU   (&MACHSIZ-(*-HRTPSYS3))/(&MLBFSIZ+2)  NR OF T P BUFFERS. X8560000
NBUFPR   EQU   1+NBUF/3            BUFS PER PRINTER                     X8562000
NBUFPU   EQU   1+NBUF*2/9          BUFS PER PUNCH                       X8564000
         TITLE 'BUFFER INITIALIZATION'                                  X8566000
*                                                                     * X8568000
*********************************************************************** X8570000
*                                                                     * X8572000
*        BUFFER INITIALIZATION AND /*SIGNON SETUP                     * X8574000
*                                                                     * X8576000
*********************************************************************** X8578000
*                                                                     * X8580000
$MLB1    $DC   YL2(0)              1ST BUF, TO BE QUEUED TO $FBBSCA.    X8582000
         $SIGNON REMOTE=&RMTID,PASSWD=&PASSWD,DIAL=&DIAL&DIAL1          X8584000
         SPACE 3                                                        X8586000
*                                                                     * X8588000
*********************************************************************** X8590000
*                                                                     * X8592000
*        INITIALIZE VARIOUS LOCATIONS WITH &MLBFSIZ                   * X8594000
*                                                                     * X8596000
*********************************************************************** X8598000
*                                                                     * X8600000
IBUF     $LA   R1,BFSZ             POINT TO &MLBFSIZ.                   X8602000
         $MVC  BMLBFSIZ,(0,R1),2   SET BUFFER SIZE IN BSCA.             X8604000
         $ALC  CKLLAST,(0,R1),2    ADD BUFFER SIZE IN $CKLEN.           X8606000
         $ALC  BCR2,(0,R1),2       ADD BUFFER SIZE FOR /*SIGNON BUF.    X8608000
         $ALC  IBUF0+3,(0,R1),2    ADD BUF SIZE FOR BUFFER INITIALIZ.   X8610000
         $SLC  IMCHSZ,(0,R1),2     SUBTRACT BUF SIZE FOR BUF INIT.      X8612000
         $ALC  IBFSZ,(0,R1),2      ADD BUFFER SIZE FOR BUFFER INIT.     X8614000
         $LA   R2,$MLPOOL          POINT TO BUF POOL POINTER.           X8616000
IBUF0    $LA   R1,$MLB1+0+2        AND R1 TO SECOND BUFFER.  THIS       X8618000
*                            INSTRUCTION INITIALIZED WITH &MLBFSIZ.     X8620000
*                                                                     * X8622000
*********************************************************************** X8624000
*                                                                     * X8626000
*        MOVE REMAINING BUFFER INITIALIZATION CODE TO LOW CORE.       * X8628000
*                                                                     * X8630000
*********************************************************************** X8632000
*                                                                     * X8634000
         $MVC  X'80'+IBUF3-IBUF1-1,IBUF3-1,IBUF3-IBUF1                  X8636000
         $B    X'80'                                                    X8638000
*                                                                     * X8640000
*********************************************************************** X8642000
*                                                                     * X8644000
*        CODE FROM HERE TO IBUF3 GETS EXECUTED IN LOW CORE.           * X8646000
*                                                                     * X8648000
*********************************************************************** X8650000
*                                                                     * X8652000
IBUF1    $ST   R1,WORK             PUT R1 IN STORAGE FOR COMPARE.       X8654000
         $CLC  WORK,IMCHSZ,2       IS 2D (3D,...) BUF WITHIN BOUNDS...  X8656000
         $JH   IBUF2               IF NOT, JUMP TO ZERO PREV BUF PTR.   X8658000
         $ST   R1,(0,R2)           YES.  POINT PREV BUFFER TO IT,       X8660000
         $LA   R2,(0,R1)           MAKE IT THE PREVIOUS BUFFER,         X8662000
         $A    R1,IBFSZ            AND POINT R1 TO NEXT BUFFER.         X8664000
         $B    X'80'               THEN DO IT AGAIN.                    X8666000
IBUF2    $MVC  (0,R2),ZERO,2       ZERO PREVIOUS BUFFER POINTER.        X8668000
*                                                                     * X8670000
*********************************************************************** X8672000
*                                                                     * X8674000
*        QUEUE ONTO $FBBSCA THE BUFFER CONTAINING /*SIGNON CARD       * X8676000
*                                                                     * X8678000
*********************************************************************** X8680000
*                                                                     * X8682000
         $LA   R2,$MLB1            POINT TO THE SIGNON BUFFER.          X8684000
         $ST   R2,FBBUF+$FBBSCA-FBD  QUEUE SIGNON BUFFER ON $FBBSCA.    X8686000
         $MVI  FBBCT+$FBBSCA-FBD,1 SET $FBBSCA BUFFER COUNTER TO 1.     X8688000
         $B    $COM                READY, SET, GO.                      X8690000
IMCHSZ   $DC   YL2(&MACHSIZ-0-2)   MAX STARTING ADDRESS OF A BUFFER,    X8692000
*                                  INITIALIZED WITH &MLBFSIZ BY $SLC.   X8694000
IBFSZ    $DC   YL2(0+2)            MULTI-LEAVING BUFFER SIZE,           X8696000
*                                  INITIALIZED WITH &MLBFSIZ BY $ALC.   X8698000
IBUF3    EQU   *                                                        X8700000
         TITLE 'INITIALIZATION'                                         X8702000
         SPACE 20                                                       X8704000
$INIT    DS    0H                  AVOID POSSIBLE 'END' CARD ERROR.     X8706000
         SPACE 5                                                        X8708000
         $MVC  FEIBM+31,FESVCNO,32 SET IBM FE SERVICE NUMBER.           X8710000
         $MVC  LPIA+47,ILC,48      SET 48-CHAR PRINT CHAIN.             X8712000
         $SNS  14,0,3,ISNS         GET STATUS TO CHECK PRINT CHAIN.     X8714000
         $TBN  ISNS,4              IS 48-CHAR CHAIN MOUNTED...          X8716000
         $JT   REP                 JUMP IF SO.                          X8718000
         $MVC  LPIA+119,IPN,120    NO.  SET 120-CHAR PRINT CHAIN.       X8720000
         $J    REP                 THEN JUMP OVER CONSTATNS.            X8722000
ISNS     $DC   YL2(0)              PRINTER STATUS BYTES.                X8724000
ILC      $DC   C'1234567890#@/STUVWXYZ&&,%JKLMNOPQR-$*ABCDEFGHI+.'''    X8726000
IPN      $DC   2C'1234567890XY/STUVW|:_",=JKLMNOPQR-Z(ABCDEFGHI+.)%$*#&CX8728000
               &@<;^''?>'                                               X8730000
         TITLE 'REP PROCESSOR'                                          X8732000
*                                                                       X8734000
*                                                                       X8736000
*              REP PROCESSOR.                                           X8738000
*                                                                       X8740000
*                                                                       X8742000
         AIF   (NOT &S35424).NOMFCUN                                    X8744000
REP      $APL  15,0,0              HANG IF PRIMARY MFCU NOT READY.      X8746000
         $LIO  15,0,5,AREPD        LOAD MFCU READ DATA ADR REG.         X8748000
         $SIO  15,0,1,0            READ A CARD FROM PRIMARY HOPPER.     X8750000
         $APL  15,0,7              WAIT TILL MFCU NOT BUSY.             X8752000
         $SNS  15,0,3,REPSNS       GET MFCU STATUS BYTES.               X8754000
         $TBN  REPSNS-1,X'80'      DID CARD READ OKAY...                X8756000
         $JF   RP01                JUMP IF SO.                          X8758000
         AGO   .NOMFCUO                                                 X8760000
.NOMFCUN ANOP                                                           X8762000
REP      $APL  5,0,0               HANG IF 1442 NOT READY.              X8764000
         $LIO  5,0,4,AREPD         LOAD 1442 DATA ADR REG.              X8766000
         $SIO  5,0,1,1             READ EBCDIC FROM 1442.               X8768000
         $APL  5,0,2               HANG TILL 1442 NOT BUSY.             X8770000
         $SNS  5,0,3,REPSNS        GET 1442 STATUS BYTES.               X8772000
         $TBN  REPSNS,X'40'        IS LAST-CARD BIT ON...               X8774000
         $JF   RP00                JUMP IF NOT.                         X8776000
         $SIO  5,0,0,1             YES.  RUN OUT LAST CARD.             X8778000
RP00     $TBF  REPSNS,X'97'        WERE THERE ANY ERRORS...             X8780000
         $JT   RP01                JUMP IF NOT.                         X8782000
.NOMFCUO ANOP                                                           X8784000
         $HPL  F3                  NO.  HALT SHOWING A READ CHECK.      X8786000
         $B    REP                 THEN GO READ AGAIN.                  X8788000
*                                                                       X8790000
*                                                                       X8792000
*              CHECK FOR /*SIGNON, &MLBFSIZ=, EOR, REP.                 X8794000
*                                                                       X8796000
*                                                                       X8798000
RP01     $CLC  REPD+3,RPEOR,3      IS THE CARD END-OF-REP...            X8800000
         $JE   REPEOR              JUMP IF SO.                          X8802000
         $CLC  AMPMLB,REPD+8,9     IS THE CARD &MLBFSIZ=...             X8804000
         $BE   BUFFERSZ            JUMP IF SO.                          X8806000
         $CLC  REPD+7,RPSIGN,8     IS THE CARD SIGNON...                X8808000
         $JE   REPSIGN             JUMP IF SO.                          X8810000
         $CLC  REPD+3,RPREP,3      IS THE CARD A REP CARD...            X8812000
         $BNE  REP                 IF NOT, GO READ ANOTHER.             X8814000
*                                                                       X8816000
*                                                                       X8818000
*              PROCESS A REP CARD.                                      X8820000
*                                                                       X8822000
*                                                                       X8824000
         $LA   R1,REPD+16          POINT TO BYTE 1 OF REP DATA.         X8826000
         $CLI  REPD+11,C' '        IS NO ADDRESS SPECIFIED...           X8828000
         $JE   RP20                JUMP IF SO.                          X8830000
         $LA   R2,REPD+8           NO.  POINT TO FIRST BYTE.            X8832000
         $CLI  (0,R2),C'0'         TRANSLATE                            X8834000
         $JNL  RP10                  FIRST CHARACTER                    X8836000
         $ALC  (0,R2),FIFTY7           TO HEX CHARACTER.                X8838000
RP10     $CLI  (1,R2),C'0'         TRANSLATE                            X8840000
         $JNL  RP11                  SECOND CHARACTER                   X8842000
         $ALC  (1,R2),FIFTY7           TO HEX CHARACTER.                X8844000
RP11     $CLI  (2,R2),C'0'         TRANSLATE                            X8846000
         $JNL  RP12                  THIRD CHARACTER                    X8848000
         $ALC  (2,R2),FIFTY7           TO HEX CHARACTER.                X8850000
RP12     $CLI  (3,R2),C'0'         TRANSLATE                            X8852000
         $JNL  RP13                  FOURTH CHARACTER                   X8854000
         $ALC  (3,R2),FIFTY7           TO HEX CHARACTER.                X8856000
RP13     $MZN  RPMVI+2,(0,R2)      SET BEGINNING                        X8858000
         $MNN  RPMVI+2,(1,R2)        ADDRESS INTO                       X8860000
         $MZN  RPMVI+3,(2,R2)          THE                              X8862000
         $MNN  RPMVI+3,(3,R2)            $MVI.                          X8864000
         SPACE 5                                                        X8866000
*                                                                       X8868000
*                                                                       X8870000
*              PROCESS THE REP DATA.                                    X8872000
*                                                                       X8874000
*                                                                       X8876000
RP20     $CLI  (0,R1),C' '         IS THIS THE END OF THE REP CARD...   X8878000
         $BE   REP                 YES.  GO GET THE NEXT CARD.          X8880000
         $CLI  (0,R1),C','         IS THIS END-OF-OPERAND...            X8882000
         $JNE  RP21                NO.  GO PROCESS 2 COLUMNS.           X8884000
         $LA   R1,(1,R1)           YES.  GO TO NEXT COLUMN              X8886000
         $B    RP20                AND CHECK IT.                        X8888000
RP21     $CLI  (0,R1),C'0'         IS THE COL '0' THROUGH '9'...        X8890000
         $JNL  RP22                JUMP IF YES.                         X8892000
         $ALC  (0,R1),FIFTY7       ELSE MAKE IT X'FA' THROUGH X'FF'.    X8894000
RP22     $CLI  (1,R1),C'0'         DO THE SAME                          X8896000
         $JNL  RP23                  FOR THE                            X8898000
         $ALC  (1,R1),FIFTY7           SECOND CHARACTER.                X8900000
RP23     $MZN  RPMVI+1,(0,R1)      SET UP THE BYTE                      X8902000
         $MNN  RPMVI+1,(1,R1)        TO REPLACE.                        X8904000
RPMVI    $MVI  *-*,*-*             REP THE LOC TO THE BYTE.             X8906000
         $ALC  RPMVI+3,ONE,2       UP THE REP ADDRESS BY ONE.           X8908000
         $LA   R1,(2,R1)           POINT TO NEXT 2 CARD COLUMNS.        X8910000
         $B    RP20                GO INSPECT THEM.                     X8912000
         SPACE 5                                                        X8914000
*                                                                     * X8916000
*********************************************************************** X8918000
*                                                                     * X8920000
*        END OF REP AND CONTROL CARD PROCESSING.                      * X8922000
*                                                                     * X8924000
*********************************************************************** X8926000
*                                                                     * X8928000
REPSIGN  $MVC  $SIGNON+79,REPD+79,80  OVERLAY DEFAULT SIGNON CARD.      X8930000
REPEOR   $LIO  14,0,0,IFORMS       SPECIFY 5203 FORMS LENGTH.           X8932000
         AIF   (NOT &S35424).NOMFCUP                                    X8934000
         $LIO  15,0,4,AHPRB        SPECIFY 5424 PRINT BUFFER ADDRESS.   X8936000
.NOMFCUP ANOP                                                           X8938000
*                                                                     * X8940000
*********************************************************************** X8942000
*                                                                     * X8944000
*        ENABLE DATASET AND WAIT FOR DATASET READY.                   * X8946000
*                                                                     * X8948000
*********************************************************************** X8950000
*                                                                     * X8952000
IBSCA    $SIO  8,0,0,X'80'         DISABLE BSCA.                        X8954000
         $SIO  8,0,0,X'C0'         ENABLE BSCA.                         X8956000
*                                                                     * X8958000
*********************************************************************** X8960000
*                                                                     * X8962000
*              CHECK FOR TELEPHONE NUMBER TO CALL.                    * X8964000
*                                                                     * X8966000
*********************************************************************** X8968000
*                                                                     * X8970000
         $LA   R1,$SIGNON+33       POINT TO WHERE 'DIAL ' SHOULD BE.    X8972000
         $CLC  (0,R1),IDIAL,5      IS IT THERE...                       X8974000
         $JNE  IBSCA1              JUMP IF NOT.                         X8976000
         $LA   R1,(4,R1)           YES.  SEARCH FOR START.              X8978000
ID1      $LA   R1,(1,R1)           POINT TO NEXT CHARACTER.             X8980000
         $CLI  (0,R1),C' '         IS IT BLANK...                       X8982000
         $BE   ID1                 LOOP IF SO.                          X8984000
         $ST   R1,IDCA             SAVE ADR FOR CUR ADR REG.            X8986000
ID2      $LA   R1,(1,R1)           LOOK FOR END OF NUMBER.              X8988000
         $CLI  (0,R1),C' '         IS THIS END OF NUMBER...             X8990000
         $BNE  ID2                 LOOP IF NOT.                         X8992000
         $ST   R1,IDPA             SAVE ADR FOR STOP ADR REG.           X8994000
ID3      $SNS  8,0,3,IBSCSNS       GET BSCA STATUS.                     X8996000
         $TBN  IBSCSNS,1           IF DATA LINE IS OCCUPIED,            X8998000
         $JT   IBSCA1              ASSUME OPERATOR DIALED.              X9000000
         $LIO  8,0,4,IDCA          SET CURRENT ADDRESS REGISTER.        X9002000
         $LIO  8,0,1,IDPA          SET STOP ADDRESS REGISTER.           X9004000
         $SIO  8,0,4,1             AUTO CALL, RESET INTERRUPTS.         X9006000
ID3A     $TIO  8,0,1,ID3B          BRANCH IF OP-END INTERRUPT.          X9008000
         $B    ID3A                OTHERWISE LOOP.                      X9010000
ID3B     $SNS  8,0,3,IBSCSNS       GET BSCA STATUS.                     X9012000
         $TBF  IBSCSNS-1,X'80'     IS THE TIMEOUT BIT OFF...            X9014000
         $JT   IBSCA1              JUMP IF SO.                          X9016000
ID4      $HPL  CA                  HALT CA = CALL ABORTED.              X9018000
         $B    IBSCA               IF OPR SAYS START, TRY AGAIN.        X9020000
IDPA     $DS   YL2                 TEL. NR. STOP ADDRESS.               X9022000
IDCA     $DS   YL2                 TEL. NR. START ADDRESS.              X9024000
IDIAL    $DC   C'DIAL '            CONSTANT OF 'DIAL '.                 X9026000
IBSCA1   $SNS  8,0,3,IBSCSNS       GET THE STATUS BYTES.                X9028000
         $TBN  IBSCSNS,2           IS DATASET REALLY READY...           X9030000
         $BF   IBSCA1              IF NOT, LOOP TILL READY.             X9032000
*                                                                     * X9034000
*********************************************************************** X9036000
*                                                                     * X9038000
*        SEND TO HASP THE SEQUENCE SOH-ENQ.                           * X9040000
*                                                                     * X9042000
*********************************************************************** X9044000
*                                                                     * X9046000
IBSCENQ  $LIO  8,0,4,IBIA1         SET CURRENT ADDRESS REGISTER.        X9048000
         $LIO  8,0,2,IBIA2         SET TRANSITION ADDRESS REGISTER.     X9050000
         $LIO  8,0,1,IBIA3         SET STOP ADDRESS REGISTER.           X9052000
         $SIO  8,0,2,1             START TRANSMIT/RECEIVE.              X9054000
IBSCQ1   $TIO  8,0,1,IBSCQ2        BRANCH IF OP-END INTERRUPT.          X9056000
         $B    IBSCQ1              OTHERWISE LOOP.                      X9058000
IBSCQ2   $SIO  8,0,0,1             RESET OP-END INTERRUPT.              X9060000
         $SNS  8,0,3,IBSCSNS       THEN GET STATUS BYTES.               X9062000
         $TBF  IBSCSNS-1,X'FF'     ARE THERE ANY ERRORS...              X9064000
         $JT   IBSCACK             JUMP IF NOT.                         X9066000
         $TBF  IBSCSNS-1,X'7F'     YES.  IS IT ONLY TIMEOUT...          X9068000
         $BT   IBSCENQ             IF SO, GO SEND SOH-ENQ AGAIN.        X9070000
         AIF   (NOT &DEBUG).IBNOBUG  *                                  X9072000
         $SNS  0,0,0,IBSCKNOB      READ IN THE KNOBS.                   X9074000
         $TBN  IBSCKNOB,1          IS LOW-ORDER KNOB ODD...             X9076000
         $BF   IBSCA               NO.  DO NOT HALT.                    X9078000
         $MNZ  IBH1+4,IBSCSNS-1    YES.  SET ZONE AND NUMERIC           X9080000
         $MNN  IBH2+4,IBSCSNS-1    OF STATUS BYTE 2.                    X9082000
         $LA   R1,IBHTAB           POINT TO HALT INDICATOR TABLE.       X9084000
IBH1     $MVC  IBHPL+1,(*-*,R1)    SET LEFT HALT INDICATOR.             X9086000
IBH2     $MVC  IBHPL+2,(*-*,R1)    SET RIGHT HALT INDICATOR.            X9088000
IBHPL    $HPL  **                  HALT PROGRAM LEVEL.                  X9090000
         $B    IBSCA               THEN GO TO THE TOP.                  X9092000
IBHTAB   DC    X'6F0376571B5D7D077F5F3F796C737C3C'                      X9094000
IBSCKNOB $DC   YL2(0)              KNOB READ-IN AREA.                   X9096000
.IBNOBUG $B    IBSCA               GO TO THE TOP.                       X9098000
IBI1     DC    X'012D'             SOH, ENQ.                            X9100000
IBI2     DC    X'0000'             SPACE FOR DLE, ACK0.                 X9102000
IBI3     EQU   *                   STOP ADDRESS LOCATION.               X9104000
IBIA1    $DC   YL2(IBI1)           CURRENT ADDRESS.                     X9106000
IBIA2    $DC   YL2(IBI2)           TRANSITION ADDRESS.                  X9108000
IBIA3    $DC   YL2(IBI3)           STOP ADDRESS.                        X9110000
IBSCSNS  $DC   YL2(0)              BSCA STATUS BYTES.                   X9112000
IBSCACK  $CLC  IBI2+1,ACKSEQ,2     DID HASP SAY DLE-ACK0...             X9114000
         $BNE  IBSCENQ             IF NOT, GO DO SOH-ENQ AGAIN.         X9116000
         $TIO  14,0,0,IBSCP        IF PRINTER NOT READY, SKIP PRINT.    X9118000
         $SIO  14,0,4,1            EJECT A PAGE.                        X9120000
         $LIO  14,0,4,PCIA         LOAD PRINTER IMAGE ADDRESS.          X9122000
         $LIO  14,0,6,PCDA         LOAD PRINTER DATA ADDRESS.           X9124000
         $SIO  14,0,2,3            PRINT 'COMM ESTAB',SPACE 3.          X9126000
         $SIO  14,0,0,3            SPACE ANOTHER 3.                     X9128000
IBSCP    EQU   *                                                        X9130000
         AIF   (NOT &S35471).INO71 *                                    X9132000
         $L    IL1,AINT            SET 5471 INTERRUPT ADDRESS.          X9134000
         $LIO  1,1,0,CCPD+1        LOAD 1ST CHAR TO PRINT.              X9136000
         $SIO  1,1,0,X'85'         START PRINTING 'COMM ESTAB'.         X9138000
         $SIO  1,0,0,5             ENABLE REQUEST KEY INTERRUPTS.       X9140000
         $B    IBUF                GO INITIALIZE BUFFERS.               X9142000
AINT     $DC   YL2(CINT)           ADDRESS OF 5471 INTERRUPT ROUTINE.   X9144000
         AGO   .INO75              *                                    X9146000
.INO71   AIF   (NOT &S35475).INO75 *                                    X9148000
         $L    IL1,AINT            SET 5475 INTERRUPT ADDRESS.          X9150000
         $B    IBUF                GO INITIALIZE BUFFERS.               X9152000
AINT     $DC   YL2(CINT)           ADDRESS OF 5475 INTERRUPT ROUTINE.   X9154000
.INO75   ANOP                      *                                    X9156000
*                                                                     * X9158000
*********************************************************************** X9160000
*                                                                     * X9162000
*        CONVERT-TO-BINARY ROUTINE FOR &MLBFSIZ=.                     * X9164000
*                                                                     * X9166000
*********************************************************************** X9168000
*                                                                     * X9170000
         $B    IBUF                GO INITIALIZE BUFFERS.               X9172000
BUFFERSZ $LA   R2,MULTAB           POINT TO MULTIPLICATION TABLE.       X9174000
         $MVC  BFSZ,ZERO,2         CLEAR DEFAULT BUFFER SIZE.           X9176000
         $L    R1,AREPD            POINT TO THE CARD IMAGE.             X9178000
BU1      $CLI  (0,R1),C' '         SEARCH                               X9180000
         $JE   BU2                   FOR                                X9182000
         $LA   R1,(1,R1)               LEFTMOST                         X9184000
         $B    BU1                       BLANK.                         X9186000
BU2      $A    R1,MONE             POINT TO NEXT-LEFT DIGIT.            X9188000
         $CLI  (0,R1),C'='         IS IT RATHER EQUAL-SIGN...           X9190000
         $BE   BU5                 YES.  END OF CONVERSION.             X9192000
BU3      $SLC  (0,R1),ONE          NO.  REDUCE DIGIT BY                 X9194000
         $CLI  (0,R1),X'F0'          ONE AND JUMP IF IT'S               X9196000
         $JL   BU4                 GONE BELOW X'F0'.                    X9198000
         $ALC  BFSZ,(1,R2),2       IF NOT, ADD THE PROPER FACTOR        X9200000
         $B    BU3                   TO THE TOTAL, AND THEN LOOP.       X9202000
BU4      $LA   R2,(2,R2)           BELOW X'F0'.  POINT TO NEXT FACTOR   X9204000
         $B    BU2                   AND GO TO OUTER LOOP START.        X9206000
BU5      EQU   REP                 &MLBFSIZ= CARD MAY APPEAR ANYWHERE   X9208000
*                                  BEFORE THE ' EOR' OR '/*SIGNON' CARD X9210000
BFSZ     $DC   YL2(&MLBFSIZ)       DEFAULT BUFFER SIZE.                 X9212000
AMPMLB   $DC   C'&&MLBFSIZ='       MLBFSIZ CONTROL CARD.                X9214000
MULTAB   DC    HL2'1,10,100,1000,10000'                                 X9216000
         TITLE 'INITIALIZATION - MISCELLANEOUS CONSTANTS'               X9218000
         AIF   (NOT &S35424).NOMFCUS                                    X9220000
AHPRB    $DC   YL2(HPRB)           ADCON FOR MFCU PRINT BUFFER.         X9222000
.NOMFCUS ANOP                                                           X9224000
         SPACE 5                                                        X9226000
IFORMS   $DC   YL1(&S3FORML,0)     FORMS LENGTH REGISTERS.              X9228000
AREPD    $DC   YL2(REPD)           POINTER TO REP CARD READ AREA.       X9230000
         AIF   (NOT &S35424).NOMFCUQ                                    X9232000
REPD     EQU   H1RDB               REP READ-IN AREA.                    X9234000
         AGO   .NOMFCUR                                                 X9236000
.NOMFCUQ ANOP                                                           X9238000
REPD     EQU   GDATA               REP READ-IN AREA.                    X9240000
.NOMFCUR ANOP                                                           X9242000
REPSNS   $DC   YL2(0)              REP STATUS BYTES.                    X9244000
RPREP    $DC   C'REP'              REP CARD INDICATOR.                  X9246000
RPSIGN   $DC   C'/*SIGNON'         SIGN-ON CARD INDICATOR.              X9248000
RPEOR    $DC   C'EOR'              END-OF-REP INDICATOR.                X9250000
FESVCNO  $DC   C'PGM 360D51014, FE SVC NO 000103.'                      X9252000
         END   $INIT               INITIAL ENTRY IS $INIT.              X9254000
