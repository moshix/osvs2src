         TITLE 'PROGRAM FETCH    IEWFTMIN'                              00054402
*                                                                       00054802
*2356 041400-041600                                                2125 00055102
*     093000,095800                                                3625 00056002
*0931095260                                                      A31918 00059002
*0931065000                                                      M6119  00063202
*058600-059299                                                   XM6366 00067402
*044420-044784,087020-087100                                     XM5009 00071602
*STATUS CHANGE LEVEL 003                                                00075802
*                                                                       00080000
*FUNCTION/OPERATION  PROGRAM FETCH IS PART OF THE RESIDENT NUCLEUS. ITS 00100000
*     FUNCTION IS THE LOADING AND RELOCATING OF EXECUTABLE MODULES INTO 00120000
*     CORE STORAGE.                                                     00140000
*                                                                       00160000
*ENTRY POINTS  THE ENTRY POINT FOR FINCH (SUPERVISOR) IS IEWMSEPT.  THE 00180000
*     ENTRY POINT FOR OVERLAY SUPERVISOR IS IEWFBOSV. BOTH THESE        00200000
*     ROUTINES ENTER PROGRAM FETCH VIA A BRANCH AND LINK                00220000
*                                                                       00240000
*INPUT  SEE NOTES                                                       00260000
*                                                                       00280000
*OUTPUT  SEE NOTES                                                      00300000
*                                                                       00320000
*EXTERNAL ROUTINES  SEE NOTES                                           00340000
*                                                                       00360000
*EXITS  SEE NOTES                                                       00380000
*                                                                       00400000
*TABLES/WORK AREAS  PROGRAM FETCH USES A WORK AREA THAT IS ALLOCATED AS 00420000
*     FOLLOWS  56 BYTES   CHANNEL PROGRAM                               00440000
*               4 BYTES   ECB                                           00460000
*              32 BYTES   IOB                                           00480000
*               8 BYTES   I/O SEEK ADDRESS                              00500000
*              12 BYTES   FETCH SEEK BUFFER                             00520000
*              40 BYTES   REGISTER SAVE AREA                            00540000
*             256 BYTES   RLD BUFFER                                    00560000
*                                                                       00580000
*ATTRIBUTES  READ ONLY - REENTRANT - PRIVELEGED - ENABLED - RESIDENT    00600000
*                                                                       00620000
*NOTES                                                                  00640000
*                                                                       00660000
*              ON ENTERING FETCH FINCH WILL PROVIDE THE FOLLOWING       00680000
*              PARAMETERS                                               00700000
*                                                                       00720000
*                         ADDRESS OF FETCH WORK CORE IN REG 3           00740000
*                         ADDRESS OF FETCH PARAMETER LIST IN REG 1      00760000
*                         RETURN ADDRESS IN REG 14                      00780000
*                                                                       00800000
         EJECT                                                          00820000
*              WHEN RETURNING TO FINCH FETCH WILL PROVIDE THE           00840000
*              FOLLOWING PARAMETERS                                     00860000
*                                                                       00880000
*                         REG 6 WILL BE SAVED ACROSS FETCH              00900000
*                         RELOCATED ENTRY POINT                         00920000
*                             (LAST ENTRY IN FETCH PARAMETER LIST)      00940000
*                         RETURN CONDITION CODE IN REG 15               00960000
*                         IF PROGRAM IS IN OVEFLAY SEGTAB WILL BE       00980000
*                         INITIALIZED WITH DCB AND NOTE LIST            01000000
*                         ADDRESS AND THE TESTRAN BIT WILL BE SET       01020000
*                         IF REQUIRED                                   01040000
*                                                                       01060000
*                                                                       01080000
*                                                                       01100000
*                             FETCH PARAMETER LIST                      01120000
*                                                                       01140000
*                   ****************************************            01160000
*                   *                                      *            01180000
*                0  *           DCB  ADDRESS               *            01200000
*                   *                                      *            01220000
*                   ****************************************            01240000
*                   *                                      *            01260000
*                4  *        CORE ADDRESS OF NOTE LIST     *            01280000
*                   *                                      *            01300000
*                   ****************************************            01320000
*                   *                                      *            01340000
*                8  *         ADDRESS OF BLDL ENTRY        *            01360000
*                   *                                      *            01380000
*                   ****************************************            01400000
*                   *                                      *            01420000
*               12  *       NUMBER OF RELOCATION FACTORS   *            01440000
*                   *                                      *            01460000
*                   ****************************************            01480000
*                   *                                      *            01500000
*               16  *       ADDRESS OF PROB PROG CORE      *            01520000
*                   *                                      *            01540000
*                   ****************************************            01560000
*                   *                                      *            01580000
*               20  *         RELOCATED ENTRY POINT        *            01600000
*                   *                                      *            01620000
*                   ****************************************            01640000
*                                                                       01660000
*                                                                       01680000
         EJECT                                                          01700000
*                                                                       02060000
*                                                                       02080000
*                                                                       02100000
*              DURING THE EXECTION OF FETCH THE FOLLOWING ROUTINES      02120000
*              ARE REFERENCED                                           02140000
*                                                                       02160000
*                         TTR CONVERT ROUTINE                           02180000
*                            CONVERT RELATIVE TRACK ADDRESS             02200000
*                            TO ABSOLUTE TRACK ADDRESS                  02220000
*                                                                       02240000
*                         SUPERVISOR VALIDITY CHECK ROUTINE             02260000
*                            VALIDITY CHECK ADDRESS INTO                02280000
*                            WHICH FETCH LOADS A MODULE                 02300000
*                                                                       02320000
*                         GETMAIN                                       02340000
*                                                                       02360000
*                         FREEMAIN                                      02380000
*                                                                       02400000
*                         EXCP  EXECUTE CHANNEL PROGRAM                 02420000
*                                                                       02440000
*                         WAIT                                          02460000
*                                                                       02480000
*                                                                       02500000
*                                                                       02520000
*              THE FOLLOWING TERMINATION CODES ARE RETURNED BY          02540000
*              FETCH TO CONTENTS SUPERVISOR AND OVERLAY                 02560000
*              SUPERVISOR IN REG 15  (LOW ORDER BYTE)                   02580000
*                                                                       02600000
*                         X'00'  SUCCESSFUL LOAD                        02620000
*                         X'0F'  PERMANENT IO ERROR                     02640000
*                         X'0E'  INVALID ADDRESS                        02660000
*                         X'0D'  INVALID RECORD TYPE                    02680000
         EJECT                                                          02700000
*              AN ERROR CODE RETURNED BY FETCH TO EITHER THE SUPERVISOR 02720000
*              OR OVERLAY SUPERVISOR RESULTS IN AN ABEND. IN THE CASE   02740000
*              OF A PERMANENT IO ERROR THE EXACT NATURE OF THE ERROR    02760000
*              CAN BE DETERMINED AS FOLLOWS                             02780000
*                                                                       02800000
*                         REG 3 OF THE ABEND DUMP WILL CONTAIN THE      02820000
*                         ADDRESS OF THE WORK CORE USED BY FETCH        02840000
*                                                                       02860000
*                         60 BYTES FROM THE START OF THIS WORK CORE IS  02880000
*                         THE IOB USED BY FETCH                         02900000
*                                                                       02920000
*                         IN THE IOB PLUS 8 BYTES IS THE CHANNEL STATUS 02940000
*                         WORD STORED BY IOS. AN ANALYSIS OF THE TWO    02960000
*                         BYTES OF STATUS INFORMATION WILL REVEAL       02980000
*                         THE EXACT NATURE OF THE IO ERROR              03000000
*                                                                       03020000
         EJECT                                                          03040000
*                                                                       03060000
*                                                                       03080000
WKREGF   EQU   0                             WORK REG                   03100000
ENDREG EQU   0                                                          03120000
WKREGA   EQU   1                             WORK REG                   03140000
PTRREG   EQU   1                                                        03160000
WKREGB   EQU   2                             WORK REG                   03180000
*MINBASE2 EQU   3                             BASE FOR DSECT            03200002
GREG3    EQU   3                       GENERAL REGISTER 3        PREMVM 03202002
MINBASE2 EQU   5                             BASE FOR DSECT      PREMVM 03210002
MINBASE1 EQU   4                             FETCH BASE REG             03220000
*PARREG   EQU   5                             PARAM. LIST ADDR          03240002
RELFACRG EQU   7                                                        03260000
DCBREG   EQU   7                             DCB ADDR                   03280000
NOTEREG  EQU   8                             NOTE LIST                  03300000
PDSREG   EQU   9                             PARTITIONED DATA SET ADDR  03320000
CDEREG   EQU   9                       PTR TO CDE (ADDR IS IN    PREMVM 03330002
*                                      COMPLIMENT FORM ON ENTRY  PREMVM 03332002
*                                      FROM PROGRAM MANAGER)     PREMVM 03334002
WKREGD   EQU   10                            WORK REG                   03340000
WKREGC   EQU   11                            WORK REG                   03360000
WKREGE   EQU   12                            WORK REG                   03380000
SEGREG   EQU   13                            SEGMENT NUMBER REG         03400000
LINKREG  EQU   14                            LINK/RETURN                03420000
CODEREG  EQU   15                            ERROR/TERMINATION CODE     03440000
RECONE   EQU   1                       REC NU FOR MBBCCHHR FLD   A31918 03446020
RECZERO  EQU   0                       REC NU FOR MBBCCHHR FLD  OS57172 03456002
EXCP     EQU   0                                                        03460000
CVTPTR   EQU   16                      LOC OF CVT POINTER               03462000
CVTTCBP  EQU   0                       OFFSET FROM TCB TO TCB POINTER   03464000
CURRENT  EQU   4                       OFFSET FROM TCB PTR TO CURRENT   03468000
*                                       TCB POINTER                     03470000
VEQR     EQU   X'80'                   VIRTUAL=REAL SWITCH              03472000
PRIVDCB  EQU   X'40'                    PRIV DCB IN USE SW.             03474002
KEYZERO  EQU   X'0F'                   MASK FOR DEB KEY ZERO     PREMVM 03474402
ADDR     EQU   B'0111'                  ADDR PART OF REG MASK           03476002
*                                                                       03480000
*                                                                       03500000
******   FETCH COMPLETION CODE DEFINITIONS                       PREMVM 03510002
*                                                                       03512002
SUCCESS  EQU   X'00'                   SUCCESSFUL FETCH          PREMVM 03514002
GMFAIL   EQU   X'0C'                   GETMAIN FAILED            PREMVM 03516002
INVREC   EQU   X'0D'                   INVALID CTL/RLD RECORD    PREMVM 03518002
INVADDR  EQU   X'0E'                   INVALID ADDRESS           PREMVM 03518402
*                  ABOVE RETURN CODE NOT SUPPORTED IN THIS VERSION      03518802
PERMIO   EQU   X'0F'                   PERMANENT I/O ERROR       PREMVM 03519202
*                                                                       03519602
         EJECT                                                          03520000
*                                                                       03540000
*        INITIALIZATION ROUTINE                                         03560000
*                                                                       03580000
IEWFTMIN CSECT                                                          03600000
         ENTRY IEWMSEPT                                                 03620000
         ENTRY MINAPNDG                      APPENDAGE TABLE ENTRY PT   03660000
         SPACE                                                          03680000
         SPACE                                                          03700000
*IEWMSEPT LR    WKREGB,MINBASE1     CURRENT TCB ADDRESS                 03720002
IEWMSEPT EQU   *                                                 PREMVM 03730002
         BALR  MINBASE1,0          FINCH (SUPERVISOR) ENTRY POINT       03740000
         USING MIN004,MINBASE1               FETCH BASE                 03760000
*        USING WKCORE,MINBASE2               DSECT BASE                 03780002
         USING WKAREA,MINBASE2               DSECT BASE          PREMVM 03790002
*MIN004  LR    PARREG,WKREGA                 PARAM ADDR TO PERM REG     03800002
*        LM    DCBREG,PDSREG,0(PARREG)       SET DCB,NOTE LIST + BLDL   03820002
MIN004   EQU   *                                                 PREMVM 03830002
         LR    MINBASE2,SEGREG         SET WORKAREA BASE         PREMVM 03830402
******   GETMAIN FOR EXTENT LIST/NOTE LIST AND PROB PROG SPACE          03832002
         LA    WKREGC,EXLSIZE          LENGTH OF EXTENT LIST     PREMVM 03834002
         LCR   WKREGB,CDEREG           ADDRESS OF CDE            PREMVM 03839902
         USING CDENTRY,WKREGB                                    PREMVM 03846602
         TM    CDATTR,CDMIN            MINOR CDE?                PREMVM 03848602
         BZ    MIN004B                 BRANCH IF NOT             PREMVM 03850602
         L     WKREGB,CDXLMJP          ADDRESS OF MAJOR CDE      PREMVM 03852602
MIN004B  EQU   *                                                 PREMVM 03853002
         LA    WKREGB,CDXLMJP          PTR TO EXTENT LIST PTR    PREMVM 03853102
         DROP  WKREGB                                            PREMVM 03853202
         LA    1,XGMLIST               POINT TO GETMAIN PARMLIST PREMVM 03857302
         GETMAIN  EC,LV=(WKREGC),A=(WKREGB),SP=255,MF=(E,(1))    PREMVM 03859902
         LTR   CODEREG,CODEREG         TEST RETURN CODE          PREMVM 03861902
         BZ    MIN004C                 BRANCH IF SUCCESSFUL      PREMVM 03863902
         LA    CODEREG,GMFAIL          SET ERROR CODE            PREMVM 03865902
         BR    LINKREG                 RETURN                    PREMVM 03866302
MIN004C  EQU   *                                                 PREMVM 03877602
         L     WKREGB,0(WKREGB)        GET ADDR OF XLIST/NLIST   PREMVM 03882002
         USING EXLNL,WKREGB                                      PREMVM 03882402
         ST    WKREGC,EXLLNTH          STORE TOTAL LIST LENGTH   PREMVM 03882802
         LA    WKREGC,1                NO. OF REL. FACTORS       PREMVM 03882902
         ST    WKREGC,EXLRELFC         STORE NO. OF BLOCKS       PREMVM 03883002
         SPACE                                                          03885602
*    OBTAIN MAIN STORAGE FOR LOAD MODULE                                03887602
         SPACE                                                          03889602
         L     WKREGC,WKLNTH           MODULE LENGTH             PREMVM 03891602
         SRL   WKREGC,8                SHIFT OUT EXTRANEOUS BYTE PREMVM 03894202
         ST    WKREGC,EXLCORSZ         STORE MODULE SIZE         PREMVM 03896802
         MVI   EXLSZIND,SZIND          INDICATE A SIZE FIELD     PREMVM 03899402
         NC    WKIOADDR,WKIOADDR       TEST FOR PROBLEM PROGRAM  PREMVM 03902002
*                                      SPACE ALREADY ALLOCATED   PREMVM 03904602
         BNZ   MIN004D                 IF SO, BRANCH             PREMVM 03907202
         LA    WKREGE,EXLCORAD         POINT TO ADDR FIELD       PREMVM 03909802
         LA    1,XGMLIST               POINT TO GETMAIN PARMLIST PREMVM 03912402
         SPACE                                                          03914802
*    TEST IF GETMAIN IS REQUIRED ON A PAGE BOUNDARY                     03914902
         SPACE                                                          03915102
         TM    WKATTR+1,PDS2ORG0       TEXT ORG'ED AT ZERO?      YM4612 03915202
         BZ    MIN004C5                NO, SKIP ALIGN TEST       YM4612 03915302
         TM    WKTXORG,PDS2PAGA        PAGE ALIGN REQD?          YM4612 03915402
         BZ    MIN004C5                GO IF NO                  YM4612 03915502
*                                      ELSE ISSUE GM ON PAGE BDY YM4612 03915602
         SPACE                                                          03915702
         GETMAIN  EC,LV=(WKREGC),A=(WKREGE),SP=(WKREGD),MF=(E,(1)),    X03915902
               BNDRY=PAGE                                        YM4612 03917102
         SPACE                                                          03917202
         B     MIN004C7                AND CONTINUE              YM4612 03917302
         SPACE                                                          03917402
MIN004C5 EQU   *                                                        03917602
         SPACE                                                          03918002
         GETMAIN  EC,LV=(WKREGC),A=(WKREGE),SP=(WKREGD),MF=(E,(1))      03918302
         SPACE                                                          03918402
MIN004C7 EQU   *                                                        03918902
         L     WKREGE,0(WKREGE)        GET P/P RELOC FACTOR      PREMVM 03920002
         LTR   CODEREG,CODEREG         TEST RETURN CODE          PREMVM 03920202
         BZ    MIN004E                 BRANCH IF SUCCESSFUL      PREMVM 03922802
         LA    CODEREG,GMFAIL          SET ERROR CODE            PREMVM 03925402
         BR    LINKREG                 RETURN                    PREMVM 03928002
MIN004D  EQU   *                                                 PREMVM 03930602
         L     WKREGE,WKIOADDR         GET ADDR OF P/P SPACE     PREMVM 03933202
         ST    WKREGE,EXLCORAD         STORE IT IN EXTENT LIST   PREMVM 03935802
MIN004E  EQU   *                                                 PREMVM 03938402
         ST    WKREGE,PPADDR           SAVE P/P RELOC FACTOR     PREMVM 03941002
         MVI   EXLADIND,ADIND          INDICATE AN ADDR FIELD    PREMVM 03943602
         LA    NOTEREG,NOTELIST        SET NOTELIST POINTER      PREMVM 03946202
         ST    NOTEREG,NOTESAVE        SAVE NOTELIST ADDRESS     PREMVM 03948802
         DROP  WKREGB                                            PREMVM 03951402
         LCR   WKREGB,CDEREG           GET CDE ADDR              PREMVM 03954002
         USING CDENTRY,WKREGB                                    PREMVM 03956602
         OI    CDATTR2,CDXLE          INDICATE EXTENT LIST BUILT PREMVM 03959202
         DROP  WKREGB                                            PREMVM 03961802
         LA    PDSREG,WKNAME           SET PTR TO BLDL ENTRY     PREMVM 03964402
         LA    SEGREG,1                      SET SEG NO. TO 1           03967002
*        TM    31(WKREGB),X'02'    TEST XCTL TO PROBLEM PROGRAM         03969602
*        BZ    MIN005                                                   03972202
*        NI    31(WKREGB),X'FD'    CLEAR FLAG                           03974802
         BC    15,MIN005                                                03977402
         EJECT                                                          03980000
MIN005   BALR  MINBASE1,0                    RESET BASE                 04000000
         USING *,MINBASE1                                               04020000
         OI    IOB,X'03'                     INIT IOB FLAGS             04040000
         ST    MINBASE2,IOB+16               INIT IOB CHAN PRG POINTER  04060000
         ST    DCBREG,IOB+20                 DCB ADDR INIOB             04080000
         ST    DCBREG,DCBSAVE          SAVE DCB ADDRESS          PREMVM 04082002
         NI    SWITCH,X'00'            INITIALIZE SWITCH TO ZERO PREMVM 04102002
MIN0053  L     WKREGA,44(DCBREG)        POINT TO DEB                    04150402
MIN0053A EQU   *                                                 PREMVM 04151602
         USING DEBBASIC,WKREGA         ESTABLISH DSECT BASE      PREMVM 04155202
         TM    DEBFLGS1,DEBAPFIN       AUTHORIZED LIBRARY?       PREMVM 04156402
         BZ    MIN0053B                IF NOT, BRANCH            PREMVM 04157602
         OI    WKFLG1,WKAUTH           SET AUTH. LIBRARY SWITCH  PREMVM 04158802
         DROP  WKREGA                  DROP DSECT BASE           PREMVM 04160002
MIN0053B EQU   *                                                 PREMVM 04161402
         LA    WKREGB,MINAPNDG               GET APENDG. ADDR           04161702
         O     WKREGB,MINDBMSK         SET DEBEXSCL TO 04 IN REG 22125  04167802
         ST    WKREGB,28(WKREGA)       STOR APNDG ADDR IN DEB    22125  04173902
         LA    WKREGA,ECB                    ADDR OF ECB                04180000
         ST    WKREGA,IOB+4                  ECB ADDR IN IOB            04200000
         XC    IOB+28(2),IOB+28              CLEAR IOB BLOCK COUNT      04220000
         LA    WKREGA,IOBSKBUF+3             TO SET  SEARCH ADDR        04240000
         ST    WKREGA,CHPG1                                             04260000
         MVI   CHPG1,X'31'                   RESET OP CODE              04280000
         ST    MINBASE2,CHPG1+8              SET TIC TO ADDR            04300000
         MVC   CHPG1+4(5),CPROG1             SET SRCH FLGS+CNT & TIC OP 04320000
         MVC   CHPG1+40(16),CPROG2           SET READ COUNT AND DATA    04340000
         MVC   CHPG1+20(4),CHPG1+4            SET CC&COUNT IN T/N       04360000
         LA    WKREGA,SEEKBUF+3                                         04380000
         ST    WKREGA,CHPG1+40                                          04400000
         MVI   CHPG1+40,X'9E'                                           04420000
         MVC   CHPG1+24(8),CHPG1+40                                     04440000
MIN0055  LR    WKREGA,SEGREG                 SEG NO. TO WORK REG        04482000
*        L     RELFACRG,16(PARREG)           GET REL FAC NON-OVER       04500002
         L     RELFACRG,PPADDR         GET REL FAC FOR 1ST LOAD  PREMVM 04510002
         LA    RELFACRG,0(RELFACRG)                                     04520002
MIN009   LM    WKREGF,WKREGA,12(PDSREG)      GET TTR FOR TEXT           05080000
         SLDL  WKREGF,16                     SET TTR IN REG             05100000
         IC    WKREGF,11(PDSREG)             CONCAT. FACTOR             05120000
         BAL   WKREGE,MIN0201                TO CONVERT RTN SET UP      05140000
         EJECT                                                          05160000
*                                                                       05180000
*        FETCH LOADING ROUTINE                                          05200000
*                                                                       05220000
         LA    WKREGC,CHPG1+32               ADDR OF TIC TO LOC         05240000
         BAL   WKREGE,MIN020+4                                          05260000
         TM    23(PDSREG),X'40'              ED ASSIG ORIGIN IS ZERO    05280000
         BC    8,MIN0091                                                05300000
         ST    RELFACRG,CHPG1+32             STOR ADDR FOR FIRST TXT    05320000
         BC    15,MIN0092                                               05340000
MIN0091  L     WKREGA,32(PDSREG)             ORIGIN OF FIRST TXT        05360000
         SRL   WKREGA,8                                                 05380000
         AR    WKREGA,RELFACRG               ADD RELOCATION FAC         05400000
         ST    WKREGA,CHPG1+32               STOR IN CHAN PROG          05420000
MIN0092  MVI   CHPG1+32,X'06'                RESTOR OP CODE             05440000
         MVC   CHPG1+38(2),27(PDSREG)        SET COUNT IN TEXT CCW      05460000
         TM    22(PDSREG),X'01'              TEST 1TXT (3 RLD           05480000
         BC    8,MIN010                                                 05500000
         MVI   CHPG1+36,X'00'                CLEAR CHAIN FLAG           05520000
         MVI   RLDBUF,X'FF'                  SET FETCH LAST INDIC       05540000
         BC    15,MIN0101                                               05560000
MIN010   MVI   CHPG1+36,X'40'                SET CC BIT IN RD TEXT CCW  05580000
         LA    WKREGA,RLDBUF                 ADDR OF RLD BUF            05600000
         ST    WKREGA,CHPG1+48               STOR ADDR IN CHAN PROG     05620000
         MVI   CHPG1+48,X'06'                RESTOR OP CODE             05640000
         MVC   CHPG1+53(3),CPROG3+5          RESET RD DATA COUNT CCW    05660000
MIN0101  LA    WKREGE,MIN014                 SET RET FOR EXCP           05680000
MIN011   MVC   IOBSKBUF+1(7),SEEKBUF+1       SEEK ADDR TO IOB SEEK BUFF 05700000
         MVI   ECB,X'00'                     CLEAR ECB FLAGS            05720000
MIN01015 LA    WKREGA,IOB                    SET FOR EXCP               05748402
         SVC   EXCP                                                     05760000
MIN0121  WAIT  1,ECB=ECB                                                05940000
MIN013   TM    ECB,X'20'                     TEST PERM IO ERROR         05960000
         BCR   1,WKREGE                      BRANCH X'20' NO ERROR      05980000
         LA    CODEREG,X'0F'                                            06000000
         B     MIN0320                       RETURN IO ERROR            06020000
MIN014   TM    RLDBUF,X'FF'                  TEST FETCH LAST INDIC      06040000
         BC    1,MIN032                      TO TERM                    06060000
         BAL   WKREGE,MIN018                 CHK CORR LENGTH            06080000
         MVC   CHPG1+52(4),CPROG3+4          RESET CCW                  06100000
         TM    RLDBUF,X'02'                  TEST FOR RLD TYPE REC      06120000
         BC    1,MIN021                      BRANCH RLD TYPE            06140000
         TM    RLDBUF,X'01'                  TEST CCW TYPE              06160000
         BC    1,MIN016                      BRANCH CCW                 06180000
         LA    CODEREG,X'0D'                                            06200000
         B     MIN0320                       RETURN INVALID RLD         06202000
MIN016   TM    RLDBUF,X'04'                  TEST NEXT REC LAST         06240000
         BC    8,MIN017                      BRANCH NEXT NOT LAST       06260000
         MVI   CHPG1+36,X'00'                PULL CC BIT                06280000
         MVI   RLDBUF,X'FF'                  SET FETCH LAST INDIC       06300000
MIN017   L     WKREGA,RLDBUF+8               GET CCW DATA ADDR          06320000
         LA    WKREGA,0(RELFACRG,WKREGA)     RELOCATE DATA ADDR         06340000
         LR    WKREGB,WKREGA                 SET ADDR TO VAL CHK        06360000
         BAL   WKREGE,MIN0202                TO VAL CHK SET-UP          06380000
         AH    WKREGB,RLDBUF+14              VAL CHK END TXT ADDR       06400000
         BCTR  WKREGB,0            ADJ TO ADDRESS LAST TXT BYTE         06410000
         BAL   WKREGE,MIN0202                TO VAL CHK SET-UP          06420000
         ST    WKREGA,CHPG1+32               STOR CHKED ADDR IN CCW     06440000
         MVI   CHPG1+32,X'06'                RESTOR OP CODE             06460000
         MVC   CHPG1+37(3),RLDBUF+13         COUNT TO RD TEXT CCW       06480000
         LA    WKREGC,CHPG1+24          TIC TO FIRST '9E'        M6119  06490020
         BAL   WKREGE,MIN020+4          IN C. P. CHAIN.          M6119  06500020
         BC    15,MIN0101                                               06520000
MIN018   LH    WKREGA,IOB+14                 GET RESID CT FROM IOB      06540000
         LTR   WKREGA,WKREGA                 TEST FOR ZERO CT           06560000
         BCR   8,WKREGE                                                 06580000
         LA    WKREGB,256                    GET MAX COUNT              06600000
         SR    WKREGB,WKREGA                 SUB RESID COUNT            06620000
         LA    WKREGA,16                                                06640000
         AH    WKREGA,RLDBUF+6               CALC CORR LENGTH           06660000
         AH    WKREGA,RLDBUF+4               ADD NO. OF BYTES OF ESDID  06680000
         CR    WKREGA,WKREGB                 DO BYTES READ=CALC COUNT   06700000
         BCR   8,WKREGE                      READ OK                    06720000
         LA    WKREGA,0(WKREGA)                                         06740000
         ST    WKREGA,CHPG1+52               PULL SILI+SET EX CNT       06760000
         BAL   WKREGE,MIN020                 TO SET CHAN PROG           06780000
         BC    15,MIN0101                                               06800000
MIN019   TM    RLDBUF,X'01'                  TEST REC FOR RLD+CCW       06820000
         BC    1,MIN016                      BRANCH YES                 06840000
         TM    RLDBUF,X'04'                  THIS REC LAST              06860000
         BC    1,MIN032                      LAST-TO NORMAL TERM        06880000
         LA    WKREGC,CHPG1+40                                          06900000
         BAL   WKREGE,MIN020+4                                          06920000
         BC    15,MIN0101                                               06940000
         EJECT                                                          06960000
*                                                                       06980000
*        THIS IS THE SET CHANNEL PROGRAM SUBROUTINE                     07000000
*                                                                       07020000
MIN020   LA    WKREGC,CHPG1+48               GET ADDR RD DATA CCW       07040000
         ST    WKREGC,CHPG1+16               SET TIC ADDR               07060000
         MVI   CHPG1+16,X'08'                RESTOR OP CODE             07080000
         BCR   15,WKREGE                     RETURN                     07100000
*                                                                       07120000
*        THIS IS THE SUBROUTINE THAT SETS PARAMS. FOR TTR CONVERT RTN   07140000
*                                                                       07160000
MIN0201  STM   PDSREG,CODEREG,REGSAVE+12     SAVE REG 9-15              07180000
*   VALIDITY CHECK THE DEB AS WE DIDN'T COPY IT                         07240002
*        L     WKREGA,44(DCBREG)        R1=DEB FOR TTR CONV             07252002
         L     WKREGA,DCBSAVE          GET DCB ADDRESS           PREMVM 07252402
         L     WKREGA,44(WKREGA)       GET DEB ADDRESS IN R1     PREMVM 07252802
         TM    SWITCH,PRIVDCB           IS IT A PRIVATE DCB?            07254002
         BZ    MIN02015                 GO IF NO                        07256002
*        ST    WKREGF,REGSAVE+4         SAVE R0                         07258002
*VALIDAT DEBCHK (LINKREG),TYPE=VERIFY        DEBPTR IS RETD IN R1       07258402
*        L     WKREGF,REGSAVE+4         RESTORE R0                      07258802
         L     WKREGA,DEBSAVE          USE VALIDATED DEB PTR     PREMVM 07258902
MIN02015 LA    WKREGB,SEEKBUF                ADDR OF SEEK BUF           07259202
         L     CODEREG,CVTRTN                ADDR OF CONVERT RTN        07260000
         BALR  LINKREG,CODEREG                                          07280000
         MVC   IOBSKBUF(1),SEEKBUF           M TO IOB                   07300000
         LM    PDSREG,CODEREG,REGSAVE+12     RESTOR REG                 07320000
         BCR   15,WKREGE                     RETURN                     07340000
CVTRTN   DC    V(IECPCNVT)                                              07360000
MINDBMSK DC    X'04000000'             MASK FOR DEBEXSCL         22125  07370018
*                                                                       07380000
*        VALIDITY CHECK SET UP ROUTINE                                  07400000
*                                                                       07420000
*        THIS ROUTINE SAVES AND RESTORES THE REGISTERS USED             07440000
*        BY THE VALIDITY CHECK ROUTINE. IT ALSO SETS UP THE             07460000
*        REQUIRED PARAMETERS AND TESTS THE CONDITION CODE               07480000
*        RETURNED BY THE VALIDITY CHECK ROUTINE                         07500000
*                                                                       07520000
*MIN0202 LR    WKREGD,SEGREG                 TEST FOR OVERLAY           07540002
*        BCT   WKREGD,MIN02021               OVERLAY VAL CHK            07560002
*  TM  16(PARREG),X'FF'           TEST FOR PROG TO PP CORE              07580002
*        BCR   8,WKREGE                      NOT PP CORE SKIP VAL CHK   07600002
*MIN02021 STM   7,10,REGSAVE+12               SAVE REGS FOR VAL CHK     07620002
*        LR    7,WKREGB                      ADDR TO BE VAL CHK'D       07640002
*        L     8,16                          ADDR OF CVT                07660002
*        L     8,24(8)                       ADDR OF VAL CHK RTN        07680002
*        SR    9,9                           NO TCB ADDR                07700002
*        BALR  10,8                          TO VAL CHK RTN             07720002
*        BC    8,MIN0203                     BRANCH ADDRESS VALID       07740002
*        LA    CODEREG,X'0E'                                            07760002
*        B     MIN0320                       RETURN                     07782002
*MIN0203 LM    7,10,REGSAVE+12               RESTOR REGS                07800002
MIN0202  EQU   *                                                 PREMVM 07810002
         BCR   15,WKREGE                     RETURN                     07820000
         EJECT                                                          07840000
*                                                                       07860000
*        FETCH RELOCATION ROUTINE                                       07880000
*                                                                       07900000
MIN021   LA    PTRREG,RLDBUF+16              SET PTR TO FIRST RPFA      07920000
         LR    ENDREG,PTRREG                                            07940000
         AH    ENDREG,RLDBUF+6               CALC SIZE OF BUFF          07960000
MIN022 LA    PTRREG,4(PTRREG)              SKIP R+P POINTERS            07980000
MIN023 TM    0(PTRREG),X'E0'               TEST RELOCATION REQUIRED     08000000
       BC    7,MIN026                      BRANCH NOT REQUIRED          08020000
       L     WKREGB,0(PTRREG)              ADDR OF LOAD CONSTANT        08040000
         LA    WKREGB,0(RELFACRG,WKREGB)     ADD RELOCATION             08060000
         BAL   WKREGE,MIN0202                TO VAL CHK SET-UP          08080000
         SR    WKREGD,WKREGD                 CLEAR REG                  08100000
       ST    WKREGD,REGSAVE                CLEAR REG SAVE AREA          08120000
       NI    0(PTRREG),X'0F'               CLEAR UNWANTED FLAGS         08140000
       IC    WKREGD,0(PTRREG)              COUNT INTO REG               08160000
       SRL   WKREGD,2                                                   08180000
       LA    WKREGC,REGSAVE+3              SET ADDR OF BOUNDARY WORD    08200000
       SR    WKREGC,WKREGD                 SET BOUND. WORD TO ' BYTES   08220000
       EX    WKREGD,MIN027                 MOVE ADCON TO BOUND WRD      08240000
       L     WKREGE,REGSAVE                LOAD FROM BUND WRD           08260000
         TM    0(PTRREG),X'02'               ADD OR SUB RELOC FACTOR    08280000
         BC    8,MIN024                      BRANCH TO ADD              08300000
       SR    WKREGE,RELFACRG               SUB RELOCATION FACTOR        08320000
         BC    15,MIN025                                                08340000
MIN024   AR    WKREGE,RELFACRG               ADD RELOC FACTOR           08360000
MIN025 ST    WKREGE,REGSAVE                RET TO BOUNDARY WORD         08380000
       EX    WKREGD,MIN028                 RET ADCON                    08400000
MIN026 LR    WKREGC,PTRREG                 SAVE POINTER                 08420000
       LA    PTRREG,4(PTRREG)              ADD 4 TO COUNT               08440000
       CR    PTRREG,ENDREG                 DOES PTR =END                08460000
       BC    8,MIN019                      COMPLETE  BRANCH OUT         08480000
       TM    0(WKREGC),X'01'               TEST TERM FLAG               08500000
       BC    1,MIN023                      SAME R++                     08520000
       BC    15,MIN022                     DIFF R+P POINTERS  INDEX+4   08540000
         SPACE                                                          08560000
MIN027 MVC   0(1,WKREGC),0(WKREGB)                                      08580000
MIN028 MVC   0(1,WKREGB),0(WKREGC)                                      08600000
         EJECT                                                          08620000
*                                                                       08640000
*        FETCH TERMINATION                                              08660000
*                                                                       08680000
MIN032   SR    CODEREG,CODEREG               SET SUCCESSFUL LOAD CODE   08700000
MIN0320  EQU   *                                                 PREMVM 08716102
MIN0320A EQU   *                                                 PREMVM 08734902
         LTR   CODEREG,CODEREG          TEST IF ERROR IN FETCH   PREMVM 08739602
         BCR   7,LINKREG                AND BR IF YES            XM5009 08744702
MIN0321  TM    23(PDSREG),X'20'              ED ASIGN ENT PT = ZERO     08860000
         BC    1,MIN033                                                 08880000
         L     WKREGA,28(PDSREG)             GET ENTRY POINT            08900000
         LA    RELFACRG,0(RELFACRG,WKREGA)   GET RELOCATED EP    PREMVM 08920002
*MIN033   ST    RELFACRG,20(PARREG)           REL ENT PT TO FETCH LIST  08940002
MIN033   LR    WKREGE,RELFACRG               PASS RELOCATED EP   PREMVM 08950002
         BCR   15,LINKREG                    RETURN                     08960000
         EJECT                                                          08980000
*                                                                       08982000
*    PAGE FIX LIST                                                      08984000
*                                                                       08986000
         CNOP  0,8                     INSURE DBL WRD BOUNDARY   M6455  08986400
FIXLIST  DC    X'00'                                                    08988000
         DC    AL3(MINAPNDG)           BEGINNING OF FIX AREA            08990000
         DC    X'80'                   LAST OF LIST INDICATOR           08992000
         DC    AL3(MINAPG02+2)         END OF FIX AREA                  08994000
*                                                                       08996000
         SPACE                                                          09000000
         SPACE                                                          09020000
*                                                                       09040000
*        END OF EXTENT APPENDAGE                                        09060000
*                                                                       09080000
*        THIS ROUTINE WILL RECEIVE CONTROL FROM IOS WHEN                09100000
*        IOS DETECTS AN END OF EXTENT CONDITION ON AN EXCP              09120000
*        BY FETCH. THE FUNCTION OF THIS ROUTINE IS TO UPDATE            09140000
*        THE SEEK ADDRESS IN THE IOB AND UCB WITH THE                   09160000
*        NEXT EXTENT ADDRESS FROM THE DEB.                              09180000
*                                                                       09200000
         SPACE                                                          09220000
MINAPNDG DC    A(MINAPG00)                   END OF EXTENT              09240000
         DC    A(MINAPG02)                   RETURN                     09260000
         DC    A(MINAPG02)                   RETURN                     09280000
         DC    A(MINAPG02)             C.E.                      23625  09300018
         DC    A(MINAPG02)                   RETURN                     09320000
         SPACE                                                          09340000
MINAPG00 SR    WKREGE,WKREGE                 CLEAR REG FOR M            09360000
*        IC    WKREGE,48(7)                  GET M FROM UCB             09380002
         IC    WKREGE,0(6)                   GET M FROM MBBCCHHR PREMVM 09390002
         LA    WKREGE,1(WKREGE)              INDEX M BY 1               09400000
*        STC   WKREGE,48(7)                  STOR NEW M IN UCB          09420002
         STC   WKREGE,0(6)                   STOR NEW M IN SEEK@ PREMVM 09430002
*        CLC   16(1,3),48(7)                 CHK FOR LAST EXTENT        09440002
         CLC   16(1,3),0(6)                  CHK FOR LAST EXTENT PREMVM 09450002
         BCR   12,LINKREG                    ERROR RETURN               09460000
         SLL   WKREGE,4                      USE M AS INDEX FACTOR      09480000
         LA    WKREGE,32(WKREGE,3)           CALC PTR TO NEW EXTENT     09500000
*        MVC   49(6,7),4(WKREGE)             BBCCHH TO UCB              09520002
         MVC   1(6,6),4(WKREGE)              BBCCHH TO SEEK FLD  PREMVM 09522002
*        MVI   55(7),RECONE             R IN CCHHR IN UCB TO ONE A31918 09524002
         MVI   7(6),RECZERO          SET R IN CCHHR IN   PREMVM,OS57172 09530002
*                                    SEEK ADDR TO ZERO   PREMVM,OS57172 09530402
*        MVC   32(8,2),48(7)           SET IOBSEEK = UCB         23625  09532002
         MVC   32(8,2),0(6)            SET IOBSEEK = SEEK FIELD  PREMVM 09534002
         SPACE                                                          09536002
****************                                                        09538002
*  SET THE 2ND TIC FOLLOWING THE SEARCH-ID CCW TO POINT TO THE          09538402
*  CORRECT READ COUNT CCW IN CASE THE CHANNEL PROGRAM IS RESTARTED      09538802
*  BY THE DASD ERP AFTER A CORRECTABLE I/O ERROR ON THE 1ST RECORD      09539202
*  OF THE NEW EXTENT. THIS PREVENTS RECROSSING THE END-OF-EXTENT        09539602
*  AND TRYING TO UPDATE TO THE NEXT EXTENT PREMATURELY, WHICH           09539702
*  WOULD BE DISASTROUS.                                         OS57172 09539802
****************                                                        09539902
         SPACE                                                          09546602
         LR    WKREGE,WKREGB           POINT TO THE IOB         OS57172 09548602
         LA    WKREGC,IOB-(CHPG1+17)   OFFSET FROM TIC ADDR FLD OS57172 09550602
*                                      TO START OF IOB          OS57172 09552602
         SR    WKREGE,WKREGC           POINT TO TIC ADDR FLD    OS57172 09553002
         L     WKREGC,8(WKREGB)        GET CURRENT CCW POINTER  OS57172 09553102
*                                      FROM CSW IN IOB          OS57172 09553202
         LA    WKREGD,8                WIDTH OF ONE CCW         OS57172 09564902
         SR    WKREGC,WKREGD           BACK UP CSW PTR TO POINT OS57172 09574902
*                                      TO START OF LAST CCW     OS57172 09575302
*                                      EXECUTED                 OS57172 09575702
         STCM  WKREGC,ADDR,0(WKREGE)   SET TIC-TO ADDRESS       OS57172 09576102
         BC    15,8(LINKREG)                 RETURN                     09576602
         SPACE                                                          09588302
         SPACE                                                          09600000
MINAPG02 BCR   15,LINKREG                    NORMAL RETURN              09620000
         EJECT                                                          09640000
*                                                                       09660000
*        FETCH CHANNEL PROGRAM                                          09680000
*                                                                       09700000
CPROG1   DC    XL1'60'                                                  09720000
         DC    XL3'05'                                                  09740000
         DC    XL1'08'                                                  09760000
*                                                                       09780000
*                                                                       09800000
*                                                                       09820000
CPROG2   DC    XL1'9E'                                                  09840000
         DC    AL3(0)                                                   09860000
         DC    XL1'A0'                                                  09880000
         DC    XL3'08'                                                  09900000
*                                                                       09920000
*                                                                       09940000
*                                                                       09960000
CPROG3   DC    XL1'06'                                                  09980000
         DC    XL3'0'                                                   10000000
         DC    XL1'20'                                                  10020000
         DC    XL3'100'                                                 10040000
*                                                                       10060000
*                                                                       10080000
*                                                                       10100000
*        FETCH CONSTANTS                                                10102002
LINKDCB  DC    V(IEFLINK)                                               10104002
SVCDCB   DC    V(IEASVDCB)                                              10106002
         EJECT                                                          10110000
*        IKJTCB   SYS=AOS1                                        M6455 10119902
         IKJTCB   SYS=AOS2                                       PREMVM 10120102
         EJECT                                                          10120302
**************************************************************** PREMVM 10124802
*                                                                       10125202
*     COMBINED EXTENT LIST / NOTE LIST CONSTRUCTED BY FETCH             10125602
*     WHEN INVOKED BY CONTENTS SUPERVISOR. THE NOTE LIST                10126002
*     PORTION EXISTS ONLY FOR MODULES IN OVERLAY STRUCTURE.             10126402
*                                                                       10126802
EXLNL    DSECT                                                          10127802
EXLIST   DS    0F        START OF EXTENT LIST                           10127902
EXLLNTH  DS    F              LENGTH OF EXTENT (PLUS NOTE) LIST         10128402
EXLRELFC DS    F              NUMBER OF CORE BLKS FOR MODULE            10128802
EXLCORSZ DS    0F             SIZE OF CORE BLK ALLOC TO MODULE          10129202
EXLSZIND DS    XL1              - FLAG TO IND A SIZE FIELD              10129302
EXLSZBLK DS    FL3              - SIZE IN BYTES                         10129602
EXLCORAD DS    0F             ADDRESS OF CORE BLOCK ALLOCATED           10130002
EXLADIND DS    XL1              - FLAG TO IND AN ADDRESS FIELD          10130402
EXLADBLK DS    AL3              - ADDRESS OF FIRST BYTE                 10130802
*                                                                       10131202
SZIND    EQU   X'80'          SIZE INDICATOR                            10131602
ADIND    EQU   X'00'          ADDR INDICATOR                            10132002
EXLSIZE  EQU   *-EXLIST       LENGTH OF XTENT LIST PORTION              10132402
*                                                                       10132802
*        NOTE LIST FOR OVERLAY MODULES.                                 10133202
*                                                                       10133602
NOTELIST DS    0F        BEGINNING OF NOTELIST                          10134002
NLRELFAC DS    F         RELOCATION FACTOR FOR THE MODULE               10134402
*                        (ALSO, THE ADDRESSS OF THE SEGTAB)             10134802
NLCORSIZ DS    XL3       MS CORE REQUIREMENT OF THE MODULE              10135202
NLCONCAT DS    XL1       CONCATENATION NUMBER OF MODULE DATA SET        10135602
NLENTRYS DS    0F        NOTELIST ENTRIES(ONE/SEGMENT)...               10136002
NLSEGTTR DS    XL3            TTR FOR READING THE SEGMENT               10136402
NLZERO   DC    X'00'          ZERO                                      10136802
*--------                                                               10137202
NLENTSZ  EQU   2         ENTRY SIZE (FOR SHIFT-MULTIPLY)                10137602
NLPFXSZ EQU   8          LENGTH OF NL PREFIX PORTION                    10138002
         EJECT                                                          10138402
         IHACDE                                                         10156202
         EJECT                                                          10159602
         IEZDEB                                                         10163002
**************************************************************** PREMVM 10166402
         EJECT                                                          10169802
         IHAFETWK                                                       10171802
         SPACE                                                          10172202
*                                                                       10173202
*                                                                       10176602
         ORG   WKFETCH                                           PREMVM 10178602
*WKCORE   DSECT                                                         10180002
WKCORE   EQU   *                                                 PREMVM 10190002
CHPG1    DS    7D                            CHANNEL PROG               10200000
ECB      DS    1F                            EVENT CONTROL BLOCK        10220000
IOB      DS    8F                            IO BLOCK                   10240000
IOBSKBUF DS    2F                            IOB SEEK BUFFER            10260000
SEEKBUF  DS    3F                            SEEK BUFFER                10280000
REGSAVE  DS    10F                           REG SAVE AREA              10300000
RLDBUF   DS    64F                           RLD BUFFER                 10320000
DCBSAVE  DS    1F                      SAVE DCB ADDRESS          PREMVM 10330002
NOTESAVE DS    1F                      SAVE NOTELIST ADDRESS     PREMVM 10330402
PPADDR   DS    1F                      SAVE P/P RELOC FACTOR     PREMVM 10332002
PSDCB    EQU   *-44                    PSEUDO DCB TO LOCATE DEB  PREMVM 10334002
*                                      COPY AFTER VALIDATION     PREMVM 10338002
DEBSAVE  DS    1F                      ADDRESS OF DEB COPY       PREMVM 10338802
DEBLEN   DS    1F                      SIZE OF COPIED DEB        PREMVM 10339202
*                                                                       10340000
*                                                                       10360000
SWITCH   EQU   CHPG1+13                SWITCH BYTE                      10362000
*                                       X'80' TASK IS RUNNING V=R       10364000
PGFIXECB EQU   REGSAVE                 ECB USED TO FIX THE AVT          10366000
*                                       AND EOX APPENDAGE               10368000
*                                                                       10380000
*                                                                       10400000
*        REGSAVE                                                        10420000
*           1-4  BOUNDARY WORD FOR RELOCATION RTN                       10440000
*           5-8                                                         10460000
*           9-12                                                        10480000
*          13-40 REG SAVE AREA  9-15                                    10500000
*                                                                       10520000
         SPACE 3                                                        10522002
         ORG   WKNAME                                            PREMVM 10524002
         IHAPDS  DSECT=NO                                        PREMVM 10530002
         END                                                            10540000
