         TITLE 'PROGRAM FETCH    IEWFTMIN'                              00170003
*                                                                       00200003
*2356 041400-041600                                                2125 00250003
*     093000,095800                                                3625 00300003
*0931095260                                                      A31918 00350003
*0931065000                                                      M6119  00400003
*058600-059299                                                   XM6366 00450003
*044420-044784,087020-087100                                     XM5009 00500003
*STATUS CHANGE LEVEL 003                                                00550003
*                                                                       00600003
*FUNCTION/OPERATION  PROGRAM FETCH IS PART OF THE RESIDENT NUCLEUS. ITS 00650003
*     FUNCTION IS THE LOADING AND RELOCATING OF EXECUTABLE MODULES INTO 00700003
*     CORE STORAGE.                                                     00750003
*                                                                       00800003
*ENTRY POINTS  THE ENTRY POINT FOR FINCH (SUPERVISOR) IS IEWMSEPT.  THE 00850003
*     ENTRY POINT FOR OVERLAY SUPERVISOR IS IEWFBOSV. BOTH THESE        00900003
*     ROUTINES ENTER PROGRAM FETCH VIA A BRANCH AND LINK                00950003
*                                                                       01000003
*INPUT  SEE NOTES                                                       01050003
*                                                                       01100003
*OUTPUT  SEE NOTES                                                      01150003
*                                                                       01200003
*EXTERNAL ROUTINES  SEE NOTES                                           01250003
*                                                                       01300003
*EXITS  SEE NOTES                                                       01350003
*                                                                       01400003
*TABLES/WORK AREAS  PROGRAM FETCH USES A WORK AREA THAT IS ALLOCATED AS 01450003
*     FOLLOWS  56 BYTES   CHANNEL PROGRAM                               01500003
*               4 BYTES   ECB                                           01550003
*              32 BYTES   IOB                                           01600003
*               8 BYTES   I/O SEEK ADDRESS                              01650003
*              12 BYTES   FETCH SEEK BUFFER                             01700003
*              40 BYTES   REGISTER SAVE AREA                            01750003
*             256 BYTES   RLD BUFFER                                    01800003
*                                                                       01850003
*ATTRIBUTES  READ ONLY - REENTRANT - PRIVELEGED - ENABLED - RESIDENT    01900003
*                                                                       01950003
*NOTES                                                                  02000003
*                                                                       02050003
*              ON ENTERING FETCH FINCH WILL PROVIDE THE FOLLOWING       02100003
*              PARAMETERS                                               02150003
*                                                                       02200003
*                         ADDRESS OF FETCH WORK CORE IN REG 3           02250003
*                         ADDRESS OF FETCH PARAMETER LIST IN REG 1      02300003
*                         RETURN ADDRESS IN REG 14                      02350003
*                                                                       02400003
         EJECT                                                          02450003
*              WHEN RETURNING TO FINCH FETCH WILL PROVIDE THE           02500003
*              FOLLOWING PARAMETERS                                     02550003
*                                                                       02600003
*                         REG 6 WILL BE SAVED ACROSS FETCH              02650003
*                         RELOCATED ENTRY POINT                         02700003
*                             (LAST ENTRY IN FETCH PARAMETER LIST)      02750003
*                         RETURN CONDITION CODE IN REG 15               02800003
*                         IF PROGRAM IS IN OVEFLAY SEGTAB WILL BE       02850003
*                         INITIALIZED WITH DCB AND NOTE LIST            02900003
*                         ADDRESS AND THE TESTRAN BIT WILL BE SET       02950003
*                         IF REQUIRED                                   03000003
*                                                                       03050003
*                                                                       03100003
*                                                                       03150003
*                             FETCH PARAMETER LIST                      03200003
*                                                                       03250003
*                   ****************************************            03300003
*                   *                                      *            03350003
*                0  *           DCB  ADDRESS               *            03400003
*                   *                                      *            03450003
*                   ****************************************            03500003
*                   *                                      *            03550003
*                4  *        CORE ADDRESS OF NOTE LIST     *            03600003
*                   *                                      *            03650003
*                   ****************************************            03700003
*                   *                                      *            03750003
*                8  *         ADDRESS OF BLDL ENTRY        *            03800003
*                   *                                      *            03850003
*                   ****************************************            03900003
*                   *                                      *            03950003
*               12  *       NUMBER OF RELOCATION FACTORS   *            04000003
*                   *                                      *            04050003
*                   ****************************************            04100003
*                   *                                      *            04150003
*               16  *       ADDRESS OF PROB PROG CORE      *            04200003
*                   *                                      *            04250003
*                   ****************************************            04300003
*                   *                                      *            04350003
*               20  *         RELOCATED ENTRY POINT        *            04400003
*                   *                                      *            04450003
*                   ****************************************            04500003
*                                                                       04550003
*                                                                       04600003
         EJECT                                                          04650003
*                                                                       04700003
*                                                                       04750003
*                                                                       04800003
*              DURING THE EXECTION OF FETCH THE FOLLOWING ROUTINES      04850003
*              ARE REFERENCED                                           04900003
*                                                                       04950003
*                         TTR CONVERT ROUTINE                           05000003
*                            CONVERT RELATIVE TRACK ADDRESS             05050003
*                            TO ABSOLUTE TRACK ADDRESS                  05100003
*                                                                       05150003
*                         SUPERVISOR VALIDITY CHECK ROUTINE             05200003
*                            VALIDITY CHECK ADDRESS INTO                05250003
*                            WHICH FETCH LOADS A MODULE                 05300003
*                                                                       05350003
*                         GETMAIN                                       05400003
*                                                                       05450003
*                         FREEMAIN                                      05500003
*                                                                       05550003
*                         EXCP  EXECUTE CHANNEL PROGRAM                 05600003
*                                                                       05650003
*                         WAIT                                          05700003
*                                                                       05750003
*                                                                       05800003
*                                                                       05850003
*              THE FOLLOWING TERMINATION CODES ARE RETURNED BY          05900003
*              FETCH TO CONTENTS SUPERVISOR AND OVERLAY                 05950003
*              SUPERVISOR IN REG 15  (LOW ORDER BYTE)                   06000003
*                                                                       06050003
*                         X'00'  SUCCESSFUL LOAD                        06100003
*                         X'0F'  PERMANENT IO ERROR                     06150003
*                         X'0E'  INVALID ADDRESS                        06200003
*                         X'0D'  INVALID RECORD TYPE                    06250003
         EJECT                                                          06300003
*              AN ERROR CODE RETURNED BY FETCH TO EITHER THE SUPERVISOR 06350003
*              OR OVERLAY SUPERVISOR RESULTS IN AN ABEND. IN THE CASE   06400003
*              OF A PERMANENT IO ERROR THE EXACT NATURE OF THE ERROR    06450003
*              CAN BE DETERMINED AS FOLLOWS                             06500003
*                                                                       06550003
*                         REG 3 OF THE ABEND DUMP WILL CONTAIN THE      06600003
*                         ADDRESS OF THE WORK CORE USED BY FETCH        06650003
*                                                                       06700003
*                         60 BYTES FROM THE START OF THIS WORK CORE IS  06750003
*                         THE IOB USED BY FETCH                         06800003
*                                                                       06850003
*                         IN THE IOB PLUS 8 BYTES IS THE CHANNEL STATUS 06900003
*                         WORD STORED BY IOS. AN ANALYSIS OF THE TWO    06950003
*                         BYTES OF STATUS INFORMATION WILL REVEAL       07000003
*                         THE EXACT NATURE OF THE IO ERROR              07050003
*                                                                       07100003
         EJECT                                                          07150003
*                                                                       07200003
*                                                                       07250003
WKREGF   EQU   0                             WORK REG                   07300003
ENDREG EQU   0                                                          07350003
WKREGA   EQU   1                             WORK REG                   07400003
PTRREG   EQU   1                                                        07450003
WKREGB   EQU   2                             WORK REG                   07500003
*MINBASE2 EQU   3                             BASE FOR DSECT            07550003
GREG3    EQU   3                       GENERAL REGISTER 3        PREMVM 07600003
MINBASE2 EQU   5                             BASE FOR DSECT      PREMVM 07650003
MINBASE1 EQU   4                             FETCH BASE REG             07700003
*PARREG   EQU   5                             PARAM. LIST ADDR          07750003
RELFACRG EQU   7                                                        07800003
DCBREG   EQU   7                             DCB ADDR                   07850003
NOTEREG  EQU   8                             NOTE LIST                  07900003
PDSREG   EQU   9                             PARTITIONED DATA SET ADDR  07950003
CDEREG   EQU   9                       PTR TO CDE (ADDR IS IN    PREMVM 08000003
*                                      COMPLIMENT FORM ON ENTRY  PREMVM 08050003
*                                      FROM PROGRAM MANAGER)     PREMVM 08100003
WKREGD   EQU   10                            WORK REG                   08150003
WKREGC   EQU   11                            WORK REG                   08200003
WKREGE   EQU   12                            WORK REG                   08250003
SEGREG   EQU   13                            SEGMENT NUMBER REG         08300003
LINKREG  EQU   14                            LINK/RETURN                08350003
CODEREG  EQU   15                            ERROR/TERMINATION CODE     08400003
RECONE   EQU   1                       REC NU FOR MBBCCHHR FLD   A31918 08450003
RECZERO  EQU   0                       REC NU FOR MBBCCHHR FLD  OS57172 08500003
EXCP     EQU   0                                                        08550003
* CVTPTR   EQU   16                      LOC OF CVT POINTER     ZA00857 08600003
* CVTTCBP  EQU   0                     OFSET FRM TCB TO TCB PTR ZA00857 08650003
CURRENT  EQU   4                       OFFSET FROM TCB PTR TO CURRENT   08700003
*                                       TCB POINTER                     08750003
VEQR     EQU   X'80'                   VIRTUAL=REAL SWITCH              08800003
PRIVDCB  EQU   X'40'                    PRIV DCB IN USE SW.             08850003
KEYZERO  EQU   X'0F'                   MASK FOR DEB KEY ZERO     PREMVM 08900003
ADDR     EQU   B'0111'                  ADDR PART OF REG MASK           08950003
*                                                                       09000003
*                                                                       09050003
******   FETCH COMPLETION CODE DEFINITIONS                       PREMVM 09100003
*                                                                       09150003
SUCCESS  EQU   X'00'                   SUCCESSFUL FETCH          PREMVM 09200003
GMFAIL   EQU   X'0C'                   GETMAIN FAILED            PREMVM 09250003
INVREC   EQU   X'0D'                   INVALID CTL/RLD RECORD    PREMVM 09300003
INVADDR  EQU   X'0E'                   INVALID ADDRESS           PREMVM 09350003
*                  ABOVE RETURN CODE NOT SUPPORTED IN THIS VERSION      09400003
PERMIO   EQU   X'0F'                   PERMANENT I/O ERROR       PREMVM 09450003
*                                                                       09500003
         EJECT                                                          09550003
*                                                                       09600003
*        INITIALIZATION ROUTINE                                         09650003
*                                                                       09700003
* IEWFTMIN CSECT                                                ZA00857 09750003
         ENTRY IEWFTMIN                                                 09760003
         ENTRY IEWMSEPT                                                 09800003
         ENTRY MINAPNDG                      APPENDAGE TABLE ENTRY PT   09850003
         SPACE                                                          09900003
         SPACE                                                          09950003
*IEWMSEPT LR    WKREGB,MINBASE1     CURRENT TCB ADDRESS                 10000003
IEWMSEPT EQU   *                                                 PREMVM 10050003
IEWFTMIN EQU   *                                                ZA00857 10060003
         BALR  MINBASE1,0          FINCH (SUPERVISOR) ENTRY POINT       10100003
         USING MIN004,MINBASE1               FETCH BASE                 10150003
*        USING WKCORE,MINBASE2               DSECT BASE                 10200003
         USING WKAREA,MINBASE2               DSECT BASE          PREMVM 10250003
*MIN004  LR    PARREG,WKREGA                 PARAM ADDR TO PERM REG     10300003
*        LM    DCBREG,PDSREG,0(PARREG)       SET DCB,NOTE LIST + BLDL   10350003
MIN004   EQU   *                                                 PREMVM 10400003
         LR    MINBASE2,SEGREG         SET WORKAREA BASE         PREMVM 10450003
******   GETMAIN FOR EXTENT LIST/NOTE LIST AND PROB PROG SPACE          10500003
         LA    WKREGC,EXLSIZE          LENGTH OF EXTENT LIST     PREMVM 10550003
         LCR   WKREGB,CDEREG           ADDRESS OF CDE            PREMVM 10600003
         USING CDENTRY,WKREGB                                    PREMVM 10650003
         TM    CDATTR,X'04'            MINOR CDE?               ZA00857 10700003
         BZ    MIN004B                 BRANCH IF NOT             PREMVM 10750003
         L     WKREGB,CDXLMJP          ADDRESS OF MAJOR CDE      PREMVM 10800003
MIN004B  EQU   *                                                 PREMVM 10850003
         LA    WKREGB,CDXLMJP          PTR TO EXTENT LIST PTR    PREMVM 10900003
         DROP  WKREGB                                            PREMVM 10950003
         LA    1,XGMLIST               POINT TO GETMAIN PARMLIST PREMVM 11000003
         GETMAIN  EC,LV=(WKREGC),A=(WKREGB),SP=255,MF=(E,(1))    PREMVM 11050003
         LTR   CODEREG,CODEREG         TEST RETURN CODE          PREMVM 11100003
         BZ    MIN004C                 BRANCH IF SUCCESSFUL      PREMVM 11150003
         LA    CODEREG,GMFAIL          SET ERROR CODE            PREMVM 11200003
         BR    LINKREG                 RETURN                    PREMVM 11250003
MIN004C  EQU   *                                                 PREMVM 11300003
         L     WKREGB,0(WKREGB)        GET ADDR OF XLIST/NLIST   PREMVM 11350003
         USING EXLNL,WKREGB                                      PREMVM 11400003
         ST    WKREGC,EXLLNTH          STORE TOTAL LIST LENGTH   PREMVM 11450003
         LA    WKREGC,1                NO. OF REL. FACTORS       PREMVM 11500003
         ST    WKREGC,EXLRELFC         STORE NO. OF BLOCKS       PREMVM 11550003
         SPACE                                                          11600003
*    OBTAIN MAIN STORAGE FOR LOAD MODULE                                11650003
         SPACE                                                          11700003
         L     WKREGC,WKLNTH           MODULE LENGTH             PREMVM 11750003
         SRL   WKREGC,8                SHIFT OUT EXTRANEOUS BYTE PREMVM 11800003
         ST    WKREGC,EXLCORSZ         STORE MODULE SIZE         PREMVM 11850003
         MVI   EXLSZIND,SZIND          INDICATE A SIZE FIELD     PREMVM 11900003
         NC    WKIOADDR,WKIOADDR       TEST FOR PROBLEM PROGRAM  PREMVM 11950003
*                                      SPACE ALREADY ALLOCATED   PREMVM 12000003
         BNZ   MIN004D                 IF SO, BRANCH             PREMVM 12050003
         LA    WKREGE,EXLCORAD         POINT TO ADDR FIELD       PREMVM 12100003
         LA    1,XGMLIST               POINT TO GETMAIN PARMLIST PREMVM 12150003
         SPACE                                                          12200003
*    TEST IF GETMAIN IS REQUIRED ON A PAGE BOUNDARY                     12250003
         SPACE                                                          12300003
         TM    WKATTR+1,PDS2ORG0       TEXT ORG'ED AT ZERO?      YM4612 12350003
         BZ    MIN004C5                NO, SKIP ALIGN TEST       YM4612 12400003
         TM    WKTXORG,PDS2PAGA        PAGE ALIGN REQD?          YM4612 12450003
         BZ    MIN004C5                GO IF NO                  YM4612 12500003
*                                      ELSE ISSUE GM ON PAGE BDY YM4612 12550003
         SPACE                                                          12600003
         GETMAIN  EC,LV=(WKREGC),A=(WKREGE),SP=(WKREGD),MF=(E,(1)),    X12650003
               BNDRY=PAGE                                        YM4612 12700003
         SPACE                                                          12750003
         B     MIN004C7                AND CONTINUE              YM4612 12800003
         SPACE                                                          12850003
MIN004C5 EQU   *                                                        12900003
         SPACE                                                          12950003
         GETMAIN  EC,LV=(WKREGC),A=(WKREGE),SP=(WKREGD),MF=(E,(1))      13000003
         SPACE                                                          13050003
MIN004C7 EQU   *                                                        13100003
         L     WKREGE,0(WKREGE)        GET P/P RELOC FACTOR      PREMVM 13150003
         LTR   CODEREG,CODEREG         TEST RETURN CODE          PREMVM 13200003
         BZ    MIN004E                 BRANCH IF SUCCESSFUL      PREMVM 13250003
         LA    CODEREG,GMFAIL          SET ERROR CODE            PREMVM 13300003
         BR    LINKREG                 RETURN                    PREMVM 13350003
MIN004D  EQU   *                                                 PREMVM 13400003
         L     WKREGE,WKIOADDR         GET ADDR OF P/P SPACE     PREMVM 13450003
         ST    WKREGE,EXLCORAD         STORE IT IN EXTENT LIST   PREMVM 13500003
MIN004E  EQU   *                                                 PREMVM 13550003
         ST    WKREGE,PPADDR           SAVE P/P RELOC FACTOR     PREMVM 13600003
         MVI   EXLADIND,ADIND          INDICATE AN ADDR FIELD    PREMVM 13650003
         LA    NOTEREG,NOTELIST        SET NOTELIST POINTER      PREMVM 13700003
         ST    NOTEREG,NOTESAVE        SAVE NOTELIST ADDRESS     PREMVM 13750003
         DROP  WKREGB                                            PREMVM 13800003
         LCR   WKREGB,CDEREG           GET CDE ADDR              PREMVM 13850003
         USING CDENTRY,WKREGB                                    PREMVM 13900003
         OI    CDATTR2,X'20'          INDICATE EXTENT LIST BILT ZA00857 13950003
         DROP  WKREGB                                            PREMVM 14000003
         LA    PDSREG,WKNAME           SET PTR TO BLDL ENTRY     PREMVM 14050003
         LA    SEGREG,1                      SET SEG NO. TO 1           14100003
*        TM    31(WKREGB),X'02'    TEST XCTL TO PROBLEM PROGRAM         14150003
*        BZ    MIN005                                                   14200003
*        NI    31(WKREGB),X'FD'    CLEAR FLAG                           14250003
         BC    15,MIN005                                                14300003
         EJECT                                                          14350003
MIN005   BALR  MINBASE1,0                    RESET BASE                 14400003
         USING *,MINBASE1                                               14450003
         OI    IOB,X'03'                     INIT IOB FLAGS             14500003
         ST    MINBASE2,IOB+16               INIT IOB CHAN PRG POINTER  14550003
         ST    DCBREG,IOB+20                 DCB ADDR INIOB             14600003
         ST    DCBREG,DCBSAVE          SAVE DCB ADDRESS          PREMVM 14650003
         NI    SWITCH,X'00'            INITIALIZE SWITCH TO ZERO PREMVM 14700003
MIN0053  L     WKREGA,44(DCBREG)        POINT TO DEB                    14750003
MIN0053A EQU   *                                                 PREMVM 14800003
         USING DEBBASIC,WKREGA         ESTABLISH DSECT BASE      PREMVM 14850003
         TM    DEBFLGS1,X'02'          AUTHORIZED LIBRARY?      ZA00857 14900003
         BZ    MIN0053B                IF NOT, BRANCH            PREMVM 14950003
         OI    WKFLG1,WKAUTH           SET AUTH. LIBRARY SWITCH  PREMVM 15000003
         DROP  WKREGA                  DROP DSECT BASE           PREMVM 15050003
MIN0053B EQU   *                                                 PREMVM 15100003
*        LA    WKREGB,MINAPNDG               GET APENDG. ADDR   ZA00857 15150003
         L     WKREGB,MINAPTAB         LOAD APPG ADDRESS        ZA00857 15160003
         O     WKREGB,MINDBMSK         SET DEBEXSCL TO 04 IN REG 22125  15200003
         ST    WKREGB,28(WKREGA)       STOR APNDG ADDR IN DEB    22125  15250003
         LA    WKREGA,ECB                    ADDR OF ECB                15300003
         ST    WKREGA,IOB+4                  ECB ADDR IN IOB            15350003
         XC    IOB+28(2),IOB+28              CLEAR IOB BLOCK COUNT      15400003
         LA    WKREGA,IOBSKBUF+3             TO SET  SEARCH ADDR        15450003
         ST    WKREGA,CHPG1                                             15500003
         MVI   CHPG1,X'31'                   RESET OP CODE              15550003
         ST    MINBASE2,CHPG1+8              SET TIC TO ADDR            15600003
         MVC   CHPG1+4(5),CPROG1             SET SRCH FLGS+CNT & TIC OP 15650003
         MVC   CHPG1+40(16),CPROG2           SET READ COUNT AND DATA    15700003
         MVC   CHPG1+20(4),CHPG1+4            SET CC&COUNT IN T/N       15750003
         LA    WKREGA,SEEKBUF+3                                         15800003
         ST    WKREGA,CHPG1+40                                          15850003
         MVI   CHPG1+40,X'9E'                                           15900003
         MVC   CHPG1+24(8),CHPG1+40                                     15950003
MIN0055  LR    WKREGA,SEGREG                 SEG NO. TO WORK REG        16000003
*        L     RELFACRG,16(PARREG)           GET REL FAC NON-OVER       16050003
         L     RELFACRG,PPADDR         GET REL FAC FOR 1ST LOAD  PREMVM 16100003
         LA    RELFACRG,0(RELFACRG)                                     16150003
MIN009   LM    WKREGF,WKREGA,12(PDSREG)      GET TTR FOR TEXT           16200003
         SLDL  WKREGF,16                     SET TTR IN REG             16250003
         IC    WKREGF,11(PDSREG)             CONCAT. FACTOR             16300003
         BAL   WKREGE,MIN0201                TO CONVERT RTN SET UP      16350003
         EJECT                                                          16400003
*                                                                       16450003
*        FETCH LOADING ROUTINE                                          16500003
*                                                                       16550003
         LA    WKREGC,CHPG1+32               ADDR OF TIC TO LOC         16600003
         BAL   WKREGE,MIN020+4                                          16650003
         TM    23(PDSREG),X'40'              ED ASSIG ORIGIN IS ZERO    16700003
         BC    8,MIN0091                                                16750003
         ST    RELFACRG,CHPG1+32             STOR ADDR FOR FIRST TXT    16800003
         BC    15,MIN0092                                               16850003
MIN0091  L     WKREGA,32(PDSREG)             ORIGIN OF FIRST TXT        16900003
         SRL   WKREGA,8                                                 16950003
         AR    WKREGA,RELFACRG               ADD RELOCATION FAC         17000003
         ST    WKREGA,CHPG1+32               STOR IN CHAN PROG          17050003
MIN0092  MVI   CHPG1+32,X'06'                RESTOR OP CODE             17100003
         MVC   CHPG1+38(2),27(PDSREG)        SET COUNT IN TEXT CCW      17150003
         TM    22(PDSREG),X'01'              TEST 1TXT (3 RLD           17200003
         BC    8,MIN010                                                 17250003
         MVI   CHPG1+36,X'00'                CLEAR CHAIN FLAG           17300003
         MVI   RLDBUF,X'FF'                  SET FETCH LAST INDIC       17350003
         BC    15,MIN0101                                               17400003
MIN010   MVI   CHPG1+36,X'40'                SET CC BIT IN RD TEXT CCW  17450003
         LA    WKREGA,RLDBUF                 ADDR OF RLD BUF            17500003
         ST    WKREGA,CHPG1+48               STOR ADDR IN CHAN PROG     17550003
         MVI   CHPG1+48,X'06'                RESTOR OP CODE             17600003
         MVC   CHPG1+53(3),CPROG3+5          RESET RD DATA COUNT CCW    17650003
MIN0101  LA    WKREGE,MIN014                 SET RET FOR EXCP           17700003
MIN011   MVC   IOBSKBUF+1(7),SEEKBUF+1       SEEK ADDR TO IOB SEEK BUFF 17750003
         MVI   ECB,X'00'                     CLEAR ECB FLAGS            17800003
MIN01015 LA    WKREGA,IOB                    SET FOR EXCP               17850003
         SVC   EXCP                                                     17900003
MIN0121  WAIT  1,ECB=ECB                                                17950003
MIN013   TM    ECB,X'20'                     TEST PERM IO ERROR         18000003
         BCR   1,WKREGE                      BRANCH X'20' NO ERROR      18050003
         LA    CODEREG,X'0F'                                            18100003
         B     MIN0320                       RETURN IO ERROR            18150003
MIN014   TM    RLDBUF,X'FF'                  TEST FETCH LAST INDIC      18200003
         BC    1,MIN032                      TO TERM                    18250003
         BAL   WKREGE,MIN018                 CHK CORR LENGTH            18300003
         MVC   CHPG1+52(4),CPROG3+4          RESET CCW                  18350003
         TM    RLDBUF,X'02'                  TEST FOR RLD TYPE REC      18400003
         BC    1,MIN021                      BRANCH RLD TYPE            18450003
         TM    RLDBUF,X'01'                  TEST CCW TYPE              18500003
         BC    1,MIN016                      BRANCH CCW                 18550003
         LA    CODEREG,X'0D'                                            18600003
         B     MIN0320                       RETURN INVALID RLD         18650003
MIN016   TM    RLDBUF,X'04'                  TEST NEXT REC LAST         18700003
         BC    8,MIN017                      BRANCH NEXT NOT LAST       18750003
         MVI   CHPG1+36,X'00'                PULL CC BIT                18800003
         MVI   RLDBUF,X'FF'                  SET FETCH LAST INDIC       18850003
MIN017   L     WKREGA,RLDBUF+8               GET CCW DATA ADDR          18900003
         LA    WKREGA,0(RELFACRG,WKREGA)     RELOCATE DATA ADDR         18950003
         LR    WKREGB,WKREGA                 SET ADDR TO VAL CHK        19000003
         BAL   WKREGE,MIN0202                TO VAL CHK SET-UP          19050003
         AH    WKREGB,RLDBUF+14              VAL CHK END TXT ADDR       19100003
         BCTR  WKREGB,0            ADJ TO ADDRESS LAST TXT BYTE         19150003
         BAL   WKREGE,MIN0202                TO VAL CHK SET-UP          19200003
         ST    WKREGA,CHPG1+32               STOR CHKED ADDR IN CCW     19250003
         MVI   CHPG1+32,X'06'                RESTOR OP CODE             19300003
         MVC   CHPG1+37(3),RLDBUF+13         COUNT TO RD TEXT CCW       19350003
         LA    WKREGC,CHPG1+24          TIC TO FIRST '9E'        M6119  19400003
         BAL   WKREGE,MIN020+4          IN C. P. CHAIN.          M6119  19450003
         BC    15,MIN0101                                               19500003
MIN018   LH    WKREGA,IOB+14                 GET RESID CT FROM IOB      19550003
         LTR   WKREGA,WKREGA                 TEST FOR ZERO CT           19600003
         BCR   8,WKREGE                                                 19650003
         LA    WKREGB,256                    GET MAX COUNT              19700003
         SR    WKREGB,WKREGA                 SUB RESID COUNT            19750003
         LA    WKREGA,16                                                19800003
         AH    WKREGA,RLDBUF+6               CALC CORR LENGTH           19850003
         AH    WKREGA,RLDBUF+4               ADD NO. OF BYTES OF ESDID  19900003
         CR    WKREGA,WKREGB                 DO BYTES READ=CALC COUNT   19950003
         BCR   8,WKREGE                      READ OK                    20000003
         LA    WKREGA,0(WKREGA)                                         20050003
         ST    WKREGA,CHPG1+52               PULL SILI+SET EX CNT       20100003
         BAL   WKREGE,MIN020                 TO SET CHAN PROG           20150003
         BC    15,MIN0101                                               20200003
MIN019   TM    RLDBUF,X'01'                  TEST REC FOR RLD+CCW       20250003
         BC    1,MIN016                      BRANCH YES                 20300003
         TM    RLDBUF,X'04'                  THIS REC LAST              20350003
         BC    1,MIN032                      LAST-TO NORMAL TERM        20400003
         LA    WKREGC,CHPG1+40                                          20450003
         BAL   WKREGE,MIN020+4                                          20500003
         BC    15,MIN0101                                               20550003
         EJECT                                                          20600003
*                                                                       20650003
*        THIS IS THE SET CHANNEL PROGRAM SUBROUTINE                     20700003
*                                                                       20750003
MIN020   LA    WKREGC,CHPG1+48               GET ADDR RD DATA CCW       20800003
         ST    WKREGC,CHPG1+16               SET TIC ADDR               20850003
         MVI   CHPG1+16,X'08'                RESTOR OP CODE             20900003
         BCR   15,WKREGE                     RETURN                     20950003
*                                                                       21000003
*        THIS IS THE SUBROUTINE THAT SETS PARAMS. FOR TTR CONVERT RTN   21050003
*                                                                       21100003
MIN0201  STM   PDSREG,CODEREG,REGSAVE+12     SAVE REG 9-15              21150003
*   VALIDITY CHECK THE DEB AS WE DIDN'T COPY IT                         21200003
*        L     WKREGA,44(DCBREG)        R1=DEB FOR TTR CONV             21250003
         L     WKREGA,DCBSAVE          GET DCB ADDRESS           PREMVM 21300003
         L     WKREGA,44(WKREGA)       GET DEB ADDRESS IN R1     PREMVM 21350003
         TM    SWITCH,PRIVDCB           IS IT A PRIVATE DCB?            21400003
         BZ    MIN02015                 GO IF NO                        21450003
*        ST    WKREGF,REGSAVE+4         SAVE R0                         21500003
*VALIDAT DEBCHK (LINKREG),TYPE=VERIFY        DEBPTR IS RETD IN R1       21550003
*        L     WKREGF,REGSAVE+4         RESTORE R0                      21600003
         L     WKREGA,DEBSAVE          USE VALIDATED DEB PTR     PREMVM 21650003
MIN02015 LA    WKREGB,SEEKBUF                ADDR OF SEEK BUF           21700003
         L     CODEREG,CVTRTN                ADDR OF CONVERT RTN        21750003
         BALR  LINKREG,CODEREG                                          21800003
         MVC   IOBSKBUF(1),SEEKBUF           M TO IOB                   21850003
         LM    PDSREG,CODEREG,REGSAVE+12     RESTOR REG                 21900003
         BCR   15,WKREGE                     RETURN                     21950003
CVTRTN   DC    V(IECPCNVT)                                              22000003
MINDBMSK DC    X'04000000'             MASK FOR DEBEXSCL         22125  22050003
*                                                                       22100003
*        VALIDITY CHECK SET UP ROUTINE                                  22150003
*                                                                       22200003
*        THIS ROUTINE SAVES AND RESTORES THE REGISTERS USED             22250003
*        BY THE VALIDITY CHECK ROUTINE. IT ALSO SETS UP THE             22300003
*        REQUIRED PARAMETERS AND TESTS THE CONDITION CODE               22350003
*        RETURNED BY THE VALIDITY CHECK ROUTINE                         22400003
*                                                                       22450003
*MIN0202 LR    WKREGD,SEGREG                 TEST FOR OVERLAY           22500003
*        BCT   WKREGD,MIN02021               OVERLAY VAL CHK            22550003
*  TM  16(PARREG),X'FF'           TEST FOR PROG TO PP CORE              22600003
*        BCR   8,WKREGE                      NOT PP CORE SKIP VAL CHK   22650003
*MIN02021 STM   7,10,REGSAVE+12               SAVE REGS FOR VAL CHK     22700003
*        LR    7,WKREGB                      ADDR TO BE VAL CHK'D       22750003
*        L     8,16                          ADDR OF CVT                22800003
*        L     8,24(8)                       ADDR OF VAL CHK RTN        22850003
*        SR    9,9                           NO TCB ADDR                22900003
*        BALR  10,8                          TO VAL CHK RTN             22950003
*        BC    8,MIN0203                     BRANCH ADDRESS VALID       23000003
*        LA    CODEREG,X'0E'                                            23050003
*        B     MIN0320                       RETURN                     23100003
*MIN0203 LM    7,10,REGSAVE+12               RESTOR REGS                23150003
MIN0202  EQU   *                                                 PREMVM 23200003
         BCR   15,WKREGE                     RETURN                     23250003
         EJECT                                                          23300003
*                                                                       23350003
*        FETCH RELOCATION ROUTINE                                       23400003
*                                                                       23450003
MIN021   LA    PTRREG,RLDBUF+16              SET PTR TO FIRST RPFA      23500003
         LR    ENDREG,PTRREG                                            23550003
         AH    ENDREG,RLDBUF+6               CALC SIZE OF BUFF          23600003
MIN022 LA    PTRREG,4(PTRREG)              SKIP R+P POINTERS            23650003
MIN023 TM    0(PTRREG),X'E0'               TEST RELOCATION REQUIRED     23700003
       BC    7,MIN026                      BRANCH NOT REQUIRED          23750003
       L     WKREGB,0(PTRREG)              ADDR OF LOAD CONSTANT        23800003
         LA    WKREGB,0(RELFACRG,WKREGB)     ADD RELOCATION             23850003
         BAL   WKREGE,MIN0202                TO VAL CHK SET-UP          23900003
         SR    WKREGD,WKREGD                 CLEAR REG                  23950003
       ST    WKREGD,REGSAVE                CLEAR REG SAVE AREA          24000003
       NI    0(PTRREG),X'0F'               CLEAR UNWANTED FLAGS         24050003
       IC    WKREGD,0(PTRREG)              COUNT INTO REG               24100003
       SRL   WKREGD,2                                                   24150003
       LA    WKREGC,REGSAVE+3              SET ADDR OF BOUNDARY WORD    24200003
       SR    WKREGC,WKREGD                 SET BOUND. WORD TO ' BYTES   24250003
       EX    WKREGD,MIN027                 MOVE ADCON TO BOUND WRD      24300003
       L     WKREGE,REGSAVE                LOAD FROM BUND WRD           24350003
         TM    0(PTRREG),X'02'               ADD OR SUB RELOC FACTOR    24400003
         BC    8,MIN024                      BRANCH TO ADD              24450003
       SR    WKREGE,RELFACRG               SUB RELOCATION FACTOR        24500003
         BC    15,MIN025                                                24550003
MIN024   AR    WKREGE,RELFACRG               ADD RELOC FACTOR           24600003
MIN025 ST    WKREGE,REGSAVE                RET TO BOUNDARY WORD         24650003
       EX    WKREGD,MIN028                 RET ADCON                    24700003
MIN026 LR    WKREGC,PTRREG                 SAVE POINTER                 24750003
       LA    PTRREG,4(PTRREG)              ADD 4 TO COUNT               24800003
       CR    PTRREG,ENDREG                 DOES PTR =END                24850003
       BC    8,MIN019                      COMPLETE  BRANCH OUT         24900003
       TM    0(WKREGC),X'01'               TEST TERM FLAG               24950003
       BC    1,MIN023                      SAME R++                     25000003
       BC    15,MIN022                     DIFF R+P POINTERS  INDEX+4   25050003
         SPACE                                                          25100003
MIN027 MVC   0(1,WKREGC),0(WKREGB)                                      25150003
MIN028 MVC   0(1,WKREGB),0(WKREGC)                                      25200003
         EJECT                                                          25250003
*                                                                       25300003
*        FETCH TERMINATION                                              25350003
*                                                                       25400003
MIN032   SR    CODEREG,CODEREG               SET SUCCESSFUL LOAD CODE   25450003
MIN0320  EQU   *                                                 PREMVM 25500003
MIN0320A EQU   *                                                 PREMVM 25550003
         LTR   CODEREG,CODEREG          TEST IF ERROR IN FETCH   PREMVM 25600003
         BCR   7,LINKREG                AND BR IF YES            XM5009 25650003
MIN0321  TM    23(PDSREG),X'20'              ED ASIGN ENT PT = ZERO     25700003
         BC    1,MIN033                                                 25750003
         L     WKREGA,28(PDSREG)             GET ENTRY POINT            25800003
         LA    RELFACRG,0(RELFACRG,WKREGA)   GET RELOCATED EP    PREMVM 25850003
*MIN033   ST    RELFACRG,20(PARREG)           REL ENT PT TO FETCH LIST  25900003
MIN033   LR    WKREGE,RELFACRG               PASS RELOCATED EP   PREMVM 25950003
         BCR   15,LINKREG                    RETURN                     26000003
         EJECT                                                          26050003
*                                                                       26100003
*    PAGE FIX LIST                                                      26150003
*                                                                       26200003
         CNOP  0,8                     INSURE DBL WRD BOUNDARY   M6455  26250003
FIXLIST  DC    X'00'                                                    26300003
         DC    AL3(MINAPNDG)           BEGINNING OF FIX AREA            26350003
         DC    X'80'                   LAST OF LIST INDICATOR           26400003
         DC    AL3(MINAPG02+2)         END OF FIX AREA                  26450003
*                                                                       26500003
         SPACE                                                          26550003
         SPACE                                                          26600003
*                                                                       26650003
*        END OF EXTENT APPENDAGE                                        26700003
*                                                                       26750003
*        THIS ROUTINE WILL RECEIVE CONTROL FROM IOS WHEN                26800003
*        IOS DETECTS AN END OF EXTENT CONDITION ON AN EXCP              26850003
*        BY FETCH. THE FUNCTION OF THIS ROUTINE IS TO UPDATE            26900003
*        THE SEEK ADDRESS IN THE IOB AND UCB WITH THE                   26950003
*        NEXT EXTENT ADDRESS FROM THE DEB.                              27000003
*                                                                       27050003
         SPACE                                                          27100003
MINAPTAB DC    A(MINAPNDG)             ADDRESS OF APPENDAGES    ZA00857 27110003
MINAPNDG DC    A(MINAPG00)                   END OF EXTENT              27150003
         DC    A(MINAPG02)                   RETURN                     27200003
         DC    A(MINAPG02)                   RETURN                     27250003
         DC    A(MINAPG02)             C.E.                      23625  27300003
         DC    A(MINAPG02)                   RETURN                     27350003
         SPACE                                                          27400003
MINAPG00 SR    WKREGE,WKREGE                 CLEAR REG FOR M            27450003
*        IC    WKREGE,48(7)                  GET M FROM UCB             27500003
         IC    WKREGE,0(6)                   GET M FROM MBBCCHHR PREMVM 27550003
         LA    WKREGE,1(WKREGE)              INDEX M BY 1               27600003
*        STC   WKREGE,48(7)                  STOR NEW M IN UCB          27650003
         STC   WKREGE,0(6)                   STOR NEW M IN SEEK@ PREMVM 27700003
*        CLC   16(1,3),48(7)                 CHK FOR LAST EXTENT        27750003
         CLC   16(1,3),0(6)                  CHK FOR LAST EXTENT PREMVM 27800003
         BCR   12,LINKREG                    ERROR RETURN               27850003
         SLL   WKREGE,4                      USE M AS INDEX FACTOR      27900003
         LA    WKREGE,32(WKREGE,3)           CALC PTR TO NEW EXTENT     27950003
*        MVC   49(6,7),4(WKREGE)             BBCCHH TO UCB              28000003
         MVC   1(6,6),4(WKREGE)              BBCCHH TO SEEK FLD  PREMVM 28050003
*        MVI   55(7),RECONE             R IN CCHHR IN UCB TO ONE A31918 28100003
         MVI   7(6),RECZERO          SET R IN CCHHR IN   PREMVM,OS57172 28150003
*                                    SEEK ADDR TO ZERO   PREMVM,OS57172 28200003
*        MVC   32(8,2),48(7)           SET IOBSEEK = UCB         23625  28250003
         MVC   32(8,2),0(6)            SET IOBSEEK = SEEK FIELD  PREMVM 28300003
         SPACE                                                          28350003
****************                                                        28400003
*  SET THE 2ND TIC FOLLOWING THE SEARCH-ID CCW TO POINT TO THE          28450003
*  CORRECT READ COUNT CCW IN CASE THE CHANNEL PROGRAM IS RESTARTED      28500003
*  BY THE DASD ERP AFTER A CORRECTABLE I/O ERROR ON THE 1ST RECORD      28550003
*  OF THE NEW EXTENT. THIS PREVENTS RECROSSING THE END-OF-EXTENT        28600003
*  AND TRYING TO UPDATE TO THE NEXT EXTENT PREMATURELY, WHICH           28650003
*  WOULD BE DISASTROUS.                                         OS57172 28700003
****************                                                        28750003
         SPACE                                                          28800003
         LR    WKREGE,WKREGB           POINT TO THE IOB         OS57172 28850003
         LA    WKREGC,IOB-(CHPG1+17)   OFFSET FROM TIC ADDR FLD OS57172 28900003
*                                      TO START OF IOB          OS57172 28950003
         SR    WKREGE,WKREGC           POINT TO TIC ADDR FLD    OS57172 29000003
         L     WKREGC,8(WKREGB)        GET CURRENT CCW POINTER  OS57172 29050003
*                                      FROM CSW IN IOB          OS57172 29100003
         LA    WKREGD,8                WIDTH OF ONE CCW         OS57172 29150003
         SR    WKREGC,WKREGD           BACK UP CSW PTR TO POINT OS57172 29200003
*                                      TO START OF LAST CCW     OS57172 29250003
*                                      EXECUTED                 OS57172 29300003
         STCM  WKREGC,ADDR,0(WKREGE)   SET TIC-TO ADDRESS       OS57172 29350003
         BC    15,8(LINKREG)                 RETURN                     29400003
         SPACE                                                          29450003
         SPACE                                                          29500003
MINAPG02 BCR   15,LINKREG                    NORMAL RETURN              29550003
MINAPEND DS    0H                                               ZA00857 29560003
         EJECT                                                          29600003
*                                                                       29650003
*        FETCH CHANNEL PROGRAM                                          29700003
*                                                                       29750003
CPROG1   DC    XL1'60'                                                  29800003
         DC    XL3'05'                                                  29850003
         DC    XL1'08'                                                  29900003
*                                                                       29950003
*                                                                       30000003
*                                                                       30050003
CPROG2   DC    XL1'9E'                                                  30100003
         DC    AL3(0)                                                   30150003
         DC    XL1'A0'                                                  30200003
         DC    XL3'08'                                                  30250003
*                                                                       30300003
*                                                                       30350003
*                                                                       30400003
CPROG3   DC    XL1'06'                                                  30450003
         DC    XL3'0'                                                   30500003
         DC    XL1'20'                                                  30550003
         DC    XL3'100'                                                 30600003
*                                                                       30650003
*                                                                       30700003
*                                                                       30750003
*        FETCH CONSTANTS                                                30800003
LINKDCB  DC    V(IEFLINK)                                               30850003
SVCDCB   DC    V(IEASVDCB)                                              30900003
         EJECT                                                          30950003
*        IKJTCB   SYS=AOS1                                      ZA00857 31000003
*        IKJTCB   SYS=AOS2                                      ZA00857 31050003
         EJECT                                                          31100003
**************************************************************** PREMVM 31150003
*                                                                       31200003
*     COMBINED EXTENT LIST / NOTE LIST CONSTRUCTED BY FETCH             31250003
*     WHEN INVOKED BY CONTENTS SUPERVISOR. THE NOTE LIST                31300003
*     PORTION EXISTS ONLY FOR MODULES IN OVERLAY STRUCTURE.             31350003
*                                                                       31400003
EXLNL    DSECT                                                          31450003
EXLIST   DS    0F        START OF EXTENT LIST                           31500003
EXLLNTH  DS    F              LENGTH OF EXTENT (PLUS NOTE) LIST         31550003
EXLRELFC DS    F              NUMBER OF CORE BLKS FOR MODULE            31600003
EXLCORSZ DS    0F             SIZE OF CORE BLK ALLOC TO MODULE          31650003
EXLSZIND DS    XL1              - FLAG TO IND A SIZE FIELD              31700003
EXLSZBLK DS    FL3              - SIZE IN BYTES                         31750003
EXLCORAD DS    0F             ADDRESS OF CORE BLOCK ALLOCATED           31800003
EXLADIND DS    XL1              - FLAG TO IND AN ADDRESS FIELD          31850003
EXLADBLK DS    AL3              - ADDRESS OF FIRST BYTE                 31900003
*                                                                       31950003
SZIND    EQU   X'80'          SIZE INDICATOR                            32000003
ADIND    EQU   X'00'          ADDR INDICATOR                            32050003
EXLSIZE  EQU   *-EXLIST       LENGTH OF XTENT LIST PORTION              32100003
*                                                                       32150003
*        NOTE LIST FOR OVERLAY MODULES.                                 32200003
*                                                                       32250003
NOTELIST DS    0F        BEGINNING OF NOTELIST                          32300003
NLRELFAC DS    F         RELOCATION FACTOR FOR THE MODULE               32350003
*                        (ALSO, THE ADDRESSS OF THE SEGTAB)             32400003
NLCORSIZ DS    XL3       MS CORE REQUIREMENT OF THE MODULE              32450003
NLCONCAT DS    XL1       CONCATENATION NUMBER OF MODULE DATA SET        32500003
NLENTRYS DS    0F        NOTELIST ENTRIES(ONE/SEGMENT)...               32550003
NLSEGTTR DS    XL3            TTR FOR READING THE SEGMENT               32600003
NLZERO   DC    X'00'          ZERO                                      32650003
*--------                                                               32700003
NLENTSZ  EQU   2         ENTRY SIZE (FOR SHIFT-MULTIPLY)                32750003
NLPFXSZ EQU   8          LENGTH OF NL PREFIX PORTION                    32800003
         EJECT                                                          32850003
*        IHACDE                                                 ZA00857 32900003
         EJECT                                                          32950003
*        IEZDEB                                                 ZA00857 33000003
**************************************************************** PREMVM 33050003
         EJECT                                                          33100003
         IHAFETWK                                                       33150003
         SPACE                                                          33200003
*                                                                       33250003
*                                                                       33300003
         ORG   WKFETCH                                           PREMVM 33350003
*WKCORE   DSECT                                                         33400003
WKCORE   EQU   *                                                 PREMVM 33450003
CHPG1    DS    7D                            CHANNEL PROG               33500003
ECB      DS    1F                            EVENT CONTROL BLOCK        33550003
IOB      DS    8F                            IO BLOCK                   33600003
IOBSKBUF DS    2F                            IOB SEEK BUFFER            33650003
SEEKBUF  DS    3F                            SEEK BUFFER                33700003
REGSAVE  DS    10F                           REG SAVE AREA              33750003
RLDBUF   DS    64F                           RLD BUFFER                 33800003
DCBSAVE  DS    1F                      SAVE DCB ADDRESS          PREMVM 33850003
NOTESAVE DS    1F                      SAVE NOTELIST ADDRESS     PREMVM 33900003
PPADDR   DS    1F                      SAVE P/P RELOC FACTOR     PREMVM 33950003
PSDCB    EQU   *-44                    PSEUDO DCB TO LOCATE DEB  PREMVM 34000003
*                                      COPY AFTER VALIDATION     PREMVM 34050003
DEBSAVE  DS    1F                      ADDRESS OF DEB COPY       PREMVM 34100003
DEBLEN   DS    1F                      SIZE OF COPIED DEB        PREMVM 34150003
*                                                                       34200003
*                                                                       34250003
SWITCH   EQU   CHPG1+13                SWITCH BYTE                      34300003
*                                       X'80' TASK IS RUNNING V=R       34350003
PGFIXECB EQU   REGSAVE                 ECB USED TO FIX THE AVT          34400003
*                                       AND EOX APPENDAGE               34450003
*                                                                       34500003
*                                                                       34550003
*        REGSAVE                                                        34600003
*           1-4  BOUNDARY WORD FOR RELOCATION RTN                       34650003
*           5-8                                                         34700003
*           9-12                                                        34750003
*          13-40 REG SAVE AREA  9-15                                    34800003
*                                                                       34850003
         SPACE 3                                                        34900003
         ORG   WKNAME                                            PREMVM 34950003
         IHAPDS  DSECT=NO                                        PREMVM 35000003
