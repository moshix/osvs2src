 TITLE 'IFBOBR00 - IGE0025F/IGE0625F - OBR/MDR RECORDER'                00070002
         EJECT                                                          11550002
*STATUS: CHANGE LEVEL 000 (MODULE SUPPORT CODE Y02021)                * 11690002
*FUNCTION:                                                            * 11760002
*        THE OBR/MDR MODULE FORMATS RECORDS ON A PERMANENT I/O        * 11830002
*        DEVICE ERROR (LONG OBR), ON A STATISTICS COUNTER OVERFLOW    * 11900002
*        CONDITION (SHORT OBR), OR A MISCELLANEOUS DATA RECORDING     * 11970002
*        (MDR).  IF PROCESSING AN OBR RECORDING, LONG OR SHORT,       * 12040002
*        OBR/MDR WILL INTERROGATE THE DEFERRED INCIDENT RECORDING     * 12110002
*        QUEUE (PAGING DATA SET ERROR RECORDINGS), AND WILL FORMAT    * 12180002
*        ANY THAT ARE PRESENT.                                        * 12250002
*        THE RECORDING TO SYS1.LOGREC IS TEMPORARILY QUEUED BY THE    * 12320002
*        RECORDING REQUEST ROUTINE OF THE ASYNCHRONOUS RECORDING      * 12390002
*        FACILITY VIA THE RECORD MACRO.  THE ACTUAL RECORDING OF THE  * 12460002
*        RECORD IS DONE BY SVC76 VIA THE RECORDING TASK ROUTINE OF    * 12530002
*        THE ASYNCHRONOUS RECORDING FACILITY.                         * 12600002
*        OBR/MDR IS CALLED BY IBM SUPPLIED ERROR RECOVERY PROCEDURE   * 12670002
*        ROUTINES.  WORK STORAGE IS OBTAINED VIA THE GETMAIN MACRO.   * 12740002
*        AN ESTAE EXIT IS ESTABLISHED IF THE GETMAIN IS SUCCESSFUL.   * 12810002
*        THE ESTAE EXIT IS USED TO FREEMAIN IF A PROGRAM CHECK OCCURS * 12880002
*        WITHIN OBR/MDR.                                              * 12950002
*        THE TYPE OF RECORD TO BE PROCESSED (OBR OR MDR) IS           * 13020002
*        DETERMINED BY THE EWAMDR FLAG OF EWAFLG2.                    * 13090002
*        IF OBR, THE RECORD IS FORMATTED, AND QUEUED VIA THE RECORD   * 13160002
*        MACRO.                                                       * 13230002
*        IF MDR, THE RECORD IS COMPLETED, AND QUEUED VIA THE RECORD   * 13300002
*        MACRO.  MDR RECORDS MAY BE PARTIALLY PREFORMATTED DEPENDING  * 13370002
*        UPON THE DEVICE TYPE OR ACCESS METHOD IN USE.                * 13440002
*                                                                     * 13510002
*                                                                     * 13580002
*ENTRY POINT:                                                         * 13650002
*        CONTROL IS PASSED TO THE FIRST EXECUTABLE STATEMENT OF THIS  * 13720002
*        MODULE FROM THE ERP THROUGH A SPECIAL XCTL INTERFACE.        * 13790002
*                                                                     * 13860002
*                                                                     * 13930002
*INPUT:                                                               * 14000002
*        IOSB POINTER IN REGISTER 1.                                  * 14070002
*                                                                     * 14140002
*                                                                     * 14210002
*OUTPUT:                                                              * 14280002
*        SYS1.LOGREC RECORDING VIA THE RECORD MACRO.                  * 14350002
*                                                                     * 14420002
*                                                                     * 14490002
*EXTERNAL REFERENCES:                                                 * 14560002
*        RECORDING REQUEST ROUTINE, IO CORE MANAGER, ESTAE, GETMAIN.  * 14630002
*                                                                     * 14700002
*                                                                     * 14770002
*EXITS,NORMAL: OBR                                                    * 14840002
*              1. IF DDR IS REQUESTED OR ERROR WAS A TCAM EOD, THE    * 14910002
*              BINARY EQUIVALENT OF THE MODULE NAME IS LOADED INTO    * 14980002
*              REGISTER 13, AND OBR/MDR BRANCHES TO THE SPECIAL ERROR * 15050002
*              XCTL ROUTINE.                                          * 15120002
*              2. ISSUES SVC15 FOLLOWED BY SVC3.                      * 15190002
*                                                                     * 15260002
*              MDR                                                    * 15330002
*              1. PLACES 'TPR' IN EBCDIC IN THE FIRST 3 BYTES OF THE  * 15400002
*              BUFFER.  PLACES X'00' IN FOURTH BYTE OF THE BUFFER TO  * 15470002
*              INDICATE SUCCESS.                                      * 15540002
*                 A. ISSUES SVC15 FOLLOWED BY SVC3, OR:               * 15610002
*                 B. XCTL'S TO CALLING ROUTINE.                         15680002
*                                                                     * 15750002
*                                                                     * 15820002
*EXITS,ERROR:  OBR                                                    * 15890002
*              1. NO SPECIAL ERROR EXITS.                             * 15960002
*              MDR                                                    * 16030002
*              1. PLACES ERROR CODE IN FOURTH BYTE OF BUFFER.         * 16100002
*                   X'0F' - SIZE OF FIELD 24 BYTES OR LESS.           * 16170002
*                   X'FF' - UNSUCCESSFUL RECORDING.                   * 16240002
*                 A. ISSUES SVC15 FOLLOWED BY SVC3.                   * 16310002
*                 B. XCTL'S TO CALLING ROUTINE.                       * 16380002
*                                                                     * 16450002
*                                                                     * 16520002
*TABLES/WORK AREAS:                                                   * 16590002
*              OBR: GETMAIN AREA IS USED TO BUILD RECORD.             * 16660002
*                                                                     * 16730002
*              MDR: FOR 2715 AND 3270 (BTAM ACCESS METHOD) THE RECORD * 16800002
*              IS FORMATTED IN THE GETMAIN AREA.  ALL OTHER DEVICES   * 16870002
*              THE HEADER IS COMPLETED IN THE PREFORMATTED RECORD     * 16940002
*              BUFFER PROVIDED BY THE CALLING ROUTINE.                * 17010002
*ATTRIBUTES: REENTRANT, PRIVILEGED, NON-RESIDENT, ENABLED             * 17080002
*                                                                       17150002
*CHARACTER CODE DEPENDENCY: THIS MODULE IS CHARACTER CODE DEPENDENT   * 17220002
*                            AND MUST BE REASSEMBLED IF MODE CHANGED  * 17290002
*                            FROM EBCDIC.                             * 17360002
*                                                                     * 17430002
* NOTES  - NOT APPLICABLE                                               17500002
         EJECT                                                          17570002
*                        LONG OBR RECORD                              * 17640002
*    ****************************************************************** 17710002
*    * CLASS  * SYS.  *                              *                * 17780002
* +0 *SOURCE  * RELE- *   S W I T C H E S            *   SPARES       * 17850002
*    *        *  ASE  *                              *                * 17920002
*    ****************************************************************** 17990002
*    *                               *                                * 18060002
* +8 *          DATE                 *         TIME                   * 18130002
*    *                               *                                * 18200002
*    ****************************************************************** 18270002
*    *        *                      *     CPU       *                * 18340002
* +16*  NOT   *   CPU SERIAL NO.     *   IDENTITY    *   NOT USED     * 18410002
*    *  USED  *                      *               *                * 18480002
*    ****************************************************************** 18550002
*    *                                                                * 18620002
* +24*                   JOB IDENTITY                                 * 18690002
*    *                                                                * 18760002
*    ****************************************************************** 18830002
*    *                                                                * 18900002
* +32*                        FAILING CCW                             * 18970002
*    *                                                                * 19040002
*    ****************************************************************** 19110002
*    *                                                                * 19180002
* +40*                      CHANNEL STATUS WORD                       * 19250002
*    *                                                                * 19320002
*    ****************************************************************** 19390002
*    * DEVICE *                *                                      * 19460002
* +48* DENP.  *SECONDARY       *              DEVICE TYPE             * 19530002
*    * DATA   *   CUA          *                                      * 19600002
*    ****************************************************************** 19670002
*    * SDR    *                *               *                      * 19740002
* +56* BYTE   *PRIMARY         *      I/O      *     SENCE BYTE       * 19810002
*    * CNT.   *  CUA           *     RETRIES   *        COUNT         * 19880002
*    ****************************************************************** 19950002
*    *                                                                * 20020002
* +64*                        DEVICE                                  * 20090002
*    *                                                                * 20160002
*    *                                                                * 20230002
*    /                                                                / 20300002
* +72/                     DEPENDENT                                  / 20370002
*    *                                                                * 20440002
*    **                                                               * 20510002
*    *                                                                * 20580002
* +80*                      INFORMATION                               * 20650002
*    *                                                                * 20720002
*    ****************************************************************** 20790002
*    *                                                                * 20860002
* +88*                   STATISTICS COUNTER AREA                      * 20930002
*    *                                                                * 21000002
*    ****************************************************************** 21070002
*    *   STATISTICS   *         STATISTICS COUNTER AREA               * 21140002
* +96*   CNTR. AREA   *            (IF MORE THAN 10 BYTES)            * 21210002
*    *     (CONT.)    *                                               * 21280002
*    ****************************************************************** 21350002
*    *                               *                                * 21420002
*+104*   STATISTICS COUNTER AREA     *       SENSE BYTE DATA          * 21490002
*    *          (CONTINUE)           *         (VARIABLE ON DEVICE)   * 21560002
*    *********************************                                * 21630002
*    *                                                                * 21700002
*    /                                                                / 21770002
*    /                                                                / 21840002
*    *                                                                * 21910002
*    ****************************************************************** 21980002
       EJECT                                                            22050002
*                         OBR SHORT RECORD                            * 22120002
*     ***************************************************************** 22190002
*     * CLASS * SYSTEM *                             *                * 22260002
* +0  *-------*RELEASE *  S W I T C H E S            *                * 22330002
*     *SOURCE *        *                             *                * 22400002
*     ***************************************************************** 22470002
*     *                               *                               * 22540002
* +8  *           DATE                *           TIME                * 22610002
*     *                               *                               * 22680002
*     ***************************************************************** 22750002
*     *       *                       *               *               * 22820002
* +16 *  NOT  *  CPU SERIAL NUMBER    *  CPU IDENTITY *   NOT USED    * 22890002
*     *  USED *                       *               *               * 22960002
*     ***************************************************************** 23030002
*     *                               *  SDR   *                      * 23100002
* +24 *        DEVICE TYPE            * LENDTH *   CHANNEL UNIT       * 23170002
*     *                               *        *            ADDRESS   * 23240002
*     ***************************************************************** 23310002
*     *                                                               * 23380002
* +32 /             STATISTIC COUNTER AREA                            / 23450002
*     /                                                               / 23520002
*     *               (10 OR 20 BYTES)                                * 23590002
*     *                                                               * 23660002
*     ***************************************************************** 23730002
         EJECT                                                          23800002
*                        T TYPE NON-STANDARD RECORD                   * 23870002
*                          FOTMATTED BY - MDR                         * 23940002
*********************************************************************** 24010002
*       *  CLASS/ * SYS./ *             * REC. *                      * 24080002
*  +0   *   SOURCE* REL-  *  SWITCHES   *  ID  *   SPARES             * 24150002
*       *   (91)  *  EASE *             *      *                      * 24220002
*       *************************************************************** 24290002
*       *                               *                             * 24360002
*  +8   *           DATE                *         TIME                * 24430002
*       *                               *                             * 24500002
*       *************************************************************** 24570002
*       *  NOT    *      CPU            *   CPU      *   NOT          * 24640002
*  +16  *   USED  *      SERIAL         *  IDENTITY  *     USED       * 24710002
*       *         *        NUMBER       *            *                * 24780002
*       *************************************************************** 24850002
*       *                                                             * 24920002
*  +24  *        DEVICE DEPENDENT DATA  --- VARIABLE                  * 24990002
*       *                                                             * 25060002
*********************************************************************** 25130002
       EJECT                                                            25200002
*                                                                       25270002
*      THE FOLLOWING EQUATES ARE FOR GENERAL PURPOSE REGISTERS          25340002
*                                                                       25410002
ZEROREG  EQU   0                       REGISTER  0 USED FOR ADDR'BITITY 25480002
R0PARM   EQU   0                       REGISTER  0 PARAMETER            25550002
R1PARM   EQU   1                       REGISTER  1 PARAMETER            25620002
R2CVTBAS EQU   2                       REGISTER  2 CVT BASE             25690002
R3CBASE  EQU   3                       REGISTER  3 CSECT BASE           25760002
R4UCB    EQU   4                       REGISTER  4 UCB POINTER          25830002
R5WORK   EQU   5                       REGISTER  5 WORK REG             25900002
R6WORK   EQU   6                       REGISTER  6 WORK REG             25970002
R7WORK   EQU   7                       REGISTER  7 WORK REG             26040002
R8RECADR EQU   8                       REGISTER  8 ADDR OF MDR RECORD   26110002
R8WORK   EQU   8                       REGISTER  8 WORK REG - ADDR OF   26180002
*                                                   SDR AREA OF RECORD  26250002
*                                                   PASSED FROM 1STLOAD 26320002
R9LOGBAS EQU   9                       REGISTER  9 DSECT BASE           26390002
R10SIZE  EQU   10                      REGISTER 10 RECORD SIZE          26460002
R10WORK  EQU   10                      REGISTER 10 WORK REG             26530002
R11BUFSV EQU   11                      REGISTER 11 MDR BUFFER ADDRESS   26600002
R11CNTRL EQU   11                      REGISTER 11 CONTROL BAL          26670002
R11WORK  EQU   11                      REGISTER 11 WORK REG             26740002
R12IOB   EQU   12                      REGISTER 12 ADDR OF IOB          26810002
R13PARM  EQU   13                      REGISTER 13 PARM TO XCTL         26880002
R14EXIT  EQU   14                      REGISTER 14 EXIT ADDR            26950002
R14LINK  EQU   14                       LINK REGISTER            Y02021 27020002
R15CODE  EQU   15                      REGISTER 15 COND CODE            27090002
*                                                                       27160002
*      THE FOLLOWING EQUATES ARE FOR ABSOLUTE VALUES,CONDITION CODE     27230002
*        SETTINGS, AND SVC NUMBERS                                      27300002
*                                                                       27370002
ADDONE   EQU   1                       TO ADD ONE TO ANY COUNT          27440002
HALFBYTE EQU   4                       NUM OF BITS IN HALF A BYTE       27510002
MAKBIN   EQU   9                       NUM TO MAKE BINARY REPRESENTAION 27580002
*                                       OF HEX ALPHABETICS(EG.C1+9=CA)  27650002
ENDREG   EQU   20                      NUM OF BITS TO SHIFT CUA TO LOW  27720002
*                                       ORDER BYTES OF REG              27790002
*                                       ARE 'ON'                        27860002
EQUAL    EQU   8                       EQUAL CONDITION CODE             27930002
TCRECLEN EQU   82                      LEN OF A TCAM RECORD             28000002
*                                       ONLY 4 BITS IN A REG            28070002
NXTSDRST EQU   256                     NUM OF BYTES IN A STAT TAB SECTN 28140002
TCAMREC  EQU   X'34'                   RECORD CLASS/SOURCE - TCAM       28210002
ATCMEXT1 EQU   X'28'                   STCAM ERP CODE          @Y30APDZ 28220003
ATCMEXT2 EQU   X'6A'                    ATCAMERP CODE          @Y30APDZ 28230003
ATCAMREC EQU   X'36'                    RECORD CLASS/COURSE - VTAM      28240003
EXIT     EQU   3                       SVC NUM TO RETURN TO SUPERVISOR  28280002
ERREXCP  EQU   15                      SVC NUM TO FREE AN RQE           28350002
         EJECT                                                          28420002
*      THE FOLLOWING EQUATES ARE FOR LENGTHS & DISPLACEMENTS            28490002
*                                                                       28560002
ZERO     EQU   0                       DIS OF ZERO                      28630002
TWO      EQU   2                       DIS OF TWO                       28700002
*                                       AND WORD CONTAINING ADDR OF SNS 28770002
*                                       TCAM FLAGS                      28840002
*                                       FLAG BYTE & ADDR OF CCH REC BUF 28910002
SIZE     EQU   2                       DIS TO SIZE OF RECORD   Z16953VM 28980030
*                                      IN CCH BUFFER RECORD    Z16953VM 29080030
ONE      EQU   1                       LENGHT OF ONE                    29190002
THREE    EQU   3                       LENGHT OF THREE                  29260002
CUA      EQU   3                       LENGHT OF CUA                    29330002
FOUR     EQU   4                       LENGHT OF FOUR                   29400002
SIX      EQU   6                       FOR PACKING PCCA CPUID  Z15459VM 29405030
FIVE     EQU   5                        LENGTH OF FIVE         @G30HIMD 29410002
SEVEN    EQU   7                                               @Z40RSVS 29420004
HEX00    EQU   X'00'                                           @Z40RSVS 29440004
EIGHT    EQU   X'08'                    MASK                     Y02021 29470002
HEXDF     EQU   X'DF'                                          @AZ08966 29490003
HEXC0    EQU   X'C0'                                           @AZ08966 29510003
TWELVE   EQU   12                      CONSTANT OF 12          @YM6451P 29540002
SIXTEEN  EQU   16                      CONSTANT OF 16          @YM6451P 29610002
TWENTY6  EQU   26                      FOR SSL ALL BUT 4 BITS  Z15459VM 29630030
TWENTY8  EQU   28                       & MULTIPLYING BY 4.    Z15459VM 29650030
OLDSDR   EQU   10                      LENGTH OF OLD STAT TAB ENTRY     29680002
NXTSTAD  EQU   2                       LENGTH OF UCB ADDRESSES          29750002
DEVTYPE  EQU   2                       LENGTH OF DEV CLASS FLD IN UCB   29820002
HDR      EQU   32                       LENGTH OF SHORT RE HDR   X03127 29890002
*                                       OF EXPANDED SENSE DATA          29960002
*                                       MAGNETIC TAPE EXTENSION         30030002
*                                       UCB EXTENSION                   30100002
SNB040   EQU   4                       DIS TO 4TH SENSE BYTE            30170002
SNB020   EQU   2                   DIS TO 2ND SENSE BYTE       @Z40RSVS 30190004
EMULATE  EQU   X'08'               DEVICE EMULATION ACTIVE     @Z40RSVS 30210004
*                                       ZEUS IN THE ERP WORK AREA       30240002
SNSBYT   EQU   1                       LENGTH OF ONE SENSE BYTE         30310002
RELLN    EQU   2                       LENGTH OF REL # IN CVT           30380002
CSWLEN   EQU   7                       LENGTH OF THE CSW                30450002
DBLWRD   EQU   8                       LENGTH OF 2 FULL WORDS           30520002
JOBLEN   EQU   8                       LENGTH OF JOB NAME FROM TIOT     30590002
CCWLEN   EQU   8                       LENGTH OF A CCW                  30660002
THREEDBL EQU   24                      LENGTH OF THREE DOUBLE WORDS     30730002
FOURDBL  EQU   32                      LENGTH OF 4 DOUBLE WDS  @YM6451P 30800002
FIVEDBL  EQU   40                       LENGTH OF 5 DOUBLE WDS  YM5956P 30830002
SAVLEN   EQU   72                       LENGTH OF SAVE REG AREA         30870002
LOGLEN   EQU   256                     LENGTH OF LOG DSECT - WORK AREA  30940002
INCOM    EQU   X'40'                   BIT IN SW1 FLD=SHORT 3670 REC    31010002
FOX      EQU   X'0F'                   INSTRUCTION MASK        @YM6451P 31080002
VS2IND   EQU   X'80'                    VS2 SYSTEM RELEASE IND.  Y02021 31150002
TPEREC   EQU   X'91'                   RECORD CLASS & SOURCE - MDR      31220002
LOGCLR   EQU   X'FE'                    CLEAR IOSLOG FLAG      @YM2957P 31310002
HEX20    EQU   X'20'                    160 BYTE INDICATOR     @YM2957P 31320002
TPERRUNG EQU   X'FE'                   MDR RUNNING FLAG                 31360002
IOBERCCW EQU   40                      DIS IN IOB=ADDR OF BUFF-2715     31430002
SUCCESS  EQU   3                       DIS IN BUFFER=SUCCESS SYM RETRND 31500002
RELEN    EQU   2                       LENGTH OF REL # IN CVT PREFIX    31570002
MSG      EQU   3                       LENGTH OF 'TPR' SUCCESS MSG      31640002
MDRINFO  EQU   6                       LENGTH OF INFO DESCRIBING THE RC 31710002
REMHDR   EQU   18                      LENGTH OF THE HEADER REC MINUS 6 31780002
REMAINDR EQU   214                     LENGTH OF THE BODY OF THE REC    31850002
         EJECT                                                          31920002
*                                                                       31990002
*      THE FOLLOWING EQUATES ARE FOR ABSOLUTE VALUES,COND CODE          32060002
*        SETTINGS,AND SVC NUMBERS                                       32130002
*                                                                       32200002
HALFREG  EQU   16                      NUM OF BITS IN HALF A REGISTER   32270002
OK       EQU   X'00'                   SUCCESS SYMBOL=REC WRITTEN OK    32340002
TOSMALL  EQU   X'0F'                   SUCCESS SYMBOL=REC LENGTH <24    32410002
NOTSUC   EQU   X'FF'                   SUCCESS SYMBOL=REC NOT WRITTEN   32480002
ID3670   EQU   X'06'                   RECORD ID FOR A 3670             32550002
ID2715   EQU   X'08'                   RECORD ID FOR A 2715             32620002
         EJECT                                                          32690002
*                                                                       32760002
*      THE FOLLOWING EQUATES ARE FOR BIT AND MASK SETTINGS              32830002
*                                                                       32900002
OBRREC   EQU   X'30'                   UNIT CHECK - OBR RECORD TYPE     32970002
TEMPERR  EQU   X'40'                   BIT IN RECORD TO SIG A TEMP ERR  33040002
TIMEBIT  EQU   X'08'                   BIT IN REC TO SIG THAT THE TIME  33110002
*                                       MACRO WAS USED                  33180002
TCAMEXT1 EQU   X'2F'                   TCAM ERP SUFFIX - EXIT ROUTINE   33250002
TCAMEXT2 EQU   X'30'                   TCAM ERP SUFFIX - EXIT ROUTINE   33320002
TCAMEXT3 EQU   X'31'                   TCAM ERP SUFFIX - EXIT ROUTINE   33390002
HIGHBIT  EQU   X'07'                   BITS TO SAVE ONLY THE PHYSICAL   33460002
*                                       UNIT ADDR IN MERLIN SENSE BYTE  33530002
MERZEUS  EQU   X'01'                   BIT IN INTERNAL FLAGS FOR MER/ZU 33600002
TEMPSHRT EQU   X'60'                   BITS IN RECORD TO SIGNIFY A      33670002
*                                       TEMPORARY ERROR & A SHORT REC   33740002
SAVEUNIT EQU   X'0F'                   MASK TO SAVE UNIT ADDR           33810002
SAVECHAN EQU   X'F8'                   MASK TO SAVE CHANNEL ADDR + HIGH 33880002
*                                       ORDER BIT OF UNIT ADDR   S99204 33950002
NOTVALID EQU   X'0F'                   INVALID SENSE FOR 2314           34020002
NUMERIC  EQU   X'F0'                   MASK IN BYTE IF A NUMBER (FO-F9) 34090002
NOSDR    EQU   X'08'                   INTERNAL SW IF NO SDR INFO       34160002
*                                       IS NEEDED FOR THIS DEVICE       34230002
TCAMFLG  EQU   X'0F'                   BITS APPENDED TO ERPFLG IN REC   34300002
CLROPT   EQU   X'80'                   BIT IN STAT TAB=DO NOT CLEAR     34370002
*                                       OPTION LIMIT BYTE               34440002
SHORT    EQU   X'20'                   BIT IN SW FLD OF REC=SHORT OBR   34510002
         EJECT                                                          34580002
*                                                                       34650002
*      THE FOLLOWING EQUATES ARE FOR DEVICE CLASSES AND TYPES           34720002
*                                                                       34790002
DASD     EQU   X'20'                   DIRECT ACCESS DEV CLASS          34860002
         SPACE                                                          34930002
DA23051  EQU   X'06'                   UNIT TYPE - 2305-1 (ZEUS)        35000002
DA23052  EQU   X'07'                   UNIT TYPE - 2305-2 (ZEUS)        35070002
DA2314   EQU   X'08'                    UNIT TYPE - 2314/2319           35140003
DA3330   EQU   X'09'                                           @AZ08966 35170003
DA3340   EQU   X'0A'                   UNIT TYPE - 3340 WINCHSR XL03130 35210002
DA3350   EQU   X'0B'               UNIT TYPE - 3350            @Z40RSVS 35230004
HC0      EQU   X'C0'               MASK FOR CU ADDR            @Z40RSVS 35250004
         SPACE                                                          35280002
T3400    EQU   X'03'                   UNIT TYPE - 3400(ASPEN)          35350002
         SPACE                                                          35420002
UR3505   EQU   X'06'                   UNIT TYPE - 3505 - REDLAKE       35490002
UR3211   EQU   X'09'                   UNIT TYPE - 3211                 35560002
UR3525   EQU   X'0C'                   UNIT TYPE - 3525 - PIKLAKE       35630002
UR3838   EQU   X'4C'                   GUSHER-3838 DEVICE CODE @ZA26472 35660030
UR3886   EQU   X'17'                    UNIT TYPE-3886-SHARK     X03127 35700002
UR3850   EQU   X'42'                    UNIT TYPE-3850-SS/1     Y30LPDG 35720003
UR3895   EQU   X'19'                    UNIT TYPE-3895-MOHAWK  @G30HIMD 35730002
UR3540   EQU   X'44'                    UNIT TYPE-3540-ERIC     Y30OPDP 35740003
ARGO     EQU   X'0E'               UNIT TYPE-3800-ARGO         @Z402IVS 35750000
ARGERADR EQU   36                  3800 BUFFER ADDRESS         @Z402IVS 35760000
         EJECT                                                          35770002
IGE0025F CSECT                                                          35840002
         USING LOGDSECT,R9LOGBAS                                        35910002
LOGDSECT DSECT                                                          35980002
         SPACE                                                          36050002
*      STANDARD RECORD HEADER AREA                                      36120002
BLDAREA  DS    CL144                   RECORD FORMAT AREA               36190002
RECINFO  EQU   BLDAREA+24              RECORD INFO                      36260002
CLASRC   EQU   BLDAREA                 CLASS/SOURCE                     36330002
FLG1EWA  EQU   CLASRC                   PLACE FOR EWA FLAG              36360003
SYSREL   EQU   BLDAREA+1               SYS REL NUM                      36400002
SWITCHES EQU   BLDAREA+2               RECORD INDEPENDENT SWITCHES      36470002
SW1      EQU   BLDAREA+3               RECORD                           36540002
SW2      EQU   BLDAREA+4                      DEPENDENT                 36610002
SW3      EQU   BLDAREA+5                                SWITCHES        36680002
DATE     EQU   BLDAREA+8               DATE                             36750002
TIME     EQU   BLDAREA+12              TIME                             36820002
CPUSER   EQU   BLDAREA+16              CPU SERIAL NUMBER                36890002
CPUMOD   EQU   BLDAREA+20              CPU MODEL NUMBER                 36960002
         SPACE                                                          37030002
*       SHORT OBR RECORD FIELDS                                         37100002
SDEVTYP  EQU   BLDAREA+24              DEVICE TYPE                      37170002
SSDRCNT  EQU   BLDAREA+28              # OF SDR BYTES                   37240002
SCUA     EQU   BLDAREA+29              CHANNEL UNIT ADDRESS             37310002
SSDR     EQU   BLDAREA+32              SDR DATA - STAT COUNTERS         37380002
         SPACE                                                          37450002
*      FULL OBR RECORD FIELDS - UNIT CHECK                              37520002
JOBID    EQU   BLDAREA+24              JOB NAME                         37590002
FAILCCW  EQU   BLDAREA+32              FAILING CCW                      37660002
CSW      EQU   BLDAREA+40              CHANNEL STATUS WORD FIELD        37730002
CSW1     EQU   BLDAREA+41              CHANNEL STATUS WORD FIELD + 1    37800002
DEVDEPC  EQU   BLDAREA+48              # OF DBL WRDS IN DEV DEP DATA AR 37870002
SECUA    EQU   BLDAREA+49              SECONDARY/LOGICAL CHAN UNIT ADDR 37940002
SECUA0C  EQU   BLDAREA+50              CHANNEL PORTION OF SEC/LOG CUA   38010002
DEVTYP   EQU   BLDAREA+52              DEVICE TYPE                      38080002
SDRCNT   EQU   BLDAREA+56              # OF SDR BYTES                   38150002
PCUA     EQU   BLDAREA+57              PRIMARY CHAN UNIT ADDR           38220002
PCUA0C   EQU   BLDAREA+58              CHANNEL PORTION OF PRIM/PHYSICAL 38290002
PCUAUA   EQU   BLDAREA+59              UNIT ADDR PORTION OF PRIM/PHYS   38360002
IORETRY  EQU   BLDAREA+60              # OF I/O RETRIES(DOS ONLY)       38430002
SENSCNT  EQU   BLDAREA+62              # OF BYTES OF                    38500002
SENSCNT1 EQU   BLDAREA+63                             SENSE DATA        38570002
         SPACE                                                          38640002
*        DEVICE DEPENDENT DATA AREA - DIRECT ACCESS - 3 DOUBLE WORDS    38710002
VOLABEL  EQU   BLDAREA+64              VOLUME ID                        38780002
LASTSK   EQU   BLDAREA+72              LAST SEEK ADDRESS                38850002
HOMADDR  EQU   BLDAREA+80              HOME ADDRESS READ                38920002
SDR      EQU   BLDAREA+88              SDR WORK AREA - STAT COUNTERS    38990002
         SPACE                                                          39060002
*        DEVICE DEPENDENT DATA AREA - 3211 PRINTER - 1 DOUBLE WORD      39130002
IDTYPE  EQU    BLDAREA+64              CORRELATION NUMBER               39200002
         EJECT                                                          39270002
*        DEVICE DEPENDENT DATA AREA - 3400 TAPE - ASPEN - 3 DBL WORDS   39340002
AVOLABEL EQU   BLDAREA+64              VOLUME LABEL                     39410002
ADEVDPDT EQU   BLDAREA+72              SPECIAL IN-CORE CNTRS FOR 3400'S 39480002
         SPACE                                                          39550002
*        DEVICE DEPENDENT DATA AREA - TCAM OBR                          39620002
TSIOCNT  EQU   BLDAREA+64              # OF START I/O INST              39690002
TTEMPERR EQU   BLDAREA+66              # OF TEMPORARY ERRORS            39760002
TMASK    EQU   BLDAREA+67              LINE MASK                        39830002
TOP1     EQU   BLDAREA+68              TCAM OP                          39900002
TOP2     EQU   BLDAREA+69                      CODES                    39970002
TFLAGS   EQU   BLDAREA+70              FLAG BYTE                        40040002
TGRAPHIC EQU   BLDAREA+71              GRAPHIC CHARACTER -FROM LCBSENS1 40110002
TTERMNAM EQU   BLDAREA+72              TERMINAL NAME                    40180002
TSENSE0  EQU   BLDAREA+80              SENCE BYTE ZERO - FROM LCBSENS0  40250002
TSENSE1  EQU   BLDAREA+81              SENCE BYTE ONE - FROM LCBSNSV    40320002
*      AREA USED FOR CHANNEL ERROR MESSAGE                              40390002
MSGAREA  EQU   BLDAREA+16              CHANNEL ERROR MSG                40460002
MSGCUA   EQU   MSGAREA+38              CUA PORTION OF MSG               40530002
MSGCUA1  EQU   MSGCUA+1                 CUA OFFSET IN MSG        XM0462 40600002
CUAVAL   EQU   1                        CUA UNIT ADDR VALID      XM0462 40670002
MSGBLAME EQU   MSGAREA+51              BLAME FIELD PORTION OF MSG       40740002
MSGOPCD  EQU   MSGAREA+56              FAILING OP CODE PORTION OF MSG   40810002
MSGSTAT  EQU   MSGAREA+59              FAILING DEV/CHAN STATUS          40880002
MSGTIME  EQU   MSGAREA+63              TIME STAMP                       40950002
         SPACE                                                          41020002
*      THE FOLLOWING ARE USED AS WORK AREAS FOR INITIALIZING THE MSG    41090002
UNPKAREA EQU   MSGAREA+79              UNPACK WORK AREA                 41160002
STAT     EQU   UNPKAREA-1              PACKED STATUS                    41230002
OPCD     EQU   UNPKAREA-2              PACKED OP CODE                   41300002
UNPKOPCD EQU   UNPKAREA                UNPACKED OP CODE POSITION        41370002
UNPKSTAT EQU   UNPKAREA+2              UNPACKED STATUS POSITION         41440002
UNPKCUA   EQU  UNPKAREA+3              UNPACK CUA AREA                  41510002
         SPACE                                                          41580002
*      THE FOLLOWING MSG AREAS ARE USED TO FORMAT THE TIME STAMP        41650002
TIMEAREA EQU   MSGTIME                 TIME WORK AREA                   41720002
*              UNPACKED TIME =   HHMMSSTH                               41790002
UNPKHH   EQU   TIMEAREA+3              UNPACKED HOURS - HH              41860002
UNPKMM   EQU   TIMEAREA+5              UNPACKED MINUTES - MM            41930002
UNPKSS   EQU   TIMEAREA+7              UNPACKED SECONDS - SS            42000002
UNPKTEN  EQU   TIMEAREA+9              UNPACKED TENTHS OF A SECOND - T  42070002
UNPKHUN  EQU   TIMEAREA+10             UNPACKED HUNDREDS OF A SECOND -H 42140002
*              FORMATED TIME = HH.MM.SS                                 42210002
FORHH    EQU   TIMEAREA+1              FORMATED HOURS - HH              42280002
FRSTDOT  EQU   TIMEAREA+3              FIRST PERIOD - AFTER HH          42350002
FORMM    EQU   TIMEAREA+4              FORMATED MINUTES - MM            42420002
SECDOT   EQU   TIMEAREA+6              SECOND PERIOD - AFTER MM         42490002
FORSS    EQU   TIMEAREA+7              FORMATED SECONDS - SS            42560002
         SPACE 2                                                        42630002
SAVEREGS DS    CL20                     SAVE AREA                Y02021 42700002
WORKAREA EQU   SAVEREGS                 WORK AREA                Y02021 42770002
STAELIST DS    CL16                     STAE LIST AREA           Y02021 42840002
ESTAPARM DS    2F                       STAE PARAM LIST AREA     Y02021 42910002
         DS    CL50                     ALIGHNMENT                      42980002
FLAGS    DS    CL1'0'                   INTERNAL FLAGS                  43050002
*        MRRLIN/ZEUS     -  X'01'                                       43120002
*        CCH MESSAGE     -   X'02'                                      43190002
*        BYPASS WRITTING REC-X'04'     FOR 2ND LOAD                     43260002
*        BYPASS SDR INFO    -X'08'     FOR 2ND LOAD                     43330002
INTSW    DS    CL1                      INTERNAL SWITCH          Y02021 43400002
GOTCORE  EQU   X'01'                    GETMAIN OK IND           Y02021 43470002
TCAMTYPE EQU   X'04'                    TCAM RECORDING           Y02021 43610002
MDRTYPE  EQU   X'08'                    MDR RECORDING            Y02021 43680002
CLRDIR   EQU   X'FD'                    CLEAR DIR BIT            Y02021 43750002
IOSBADDR DS    CL4                      IOSB POINTER             Y02021 43820002
OBRECB   DS    CL4                      SAVE                            43890002
REG2715  EQU   OBRECB                   2715 SAVE AREA                  43960002
BINXCTL  DS    CL3                      SPECIAL XCTL SAVE AREA          44030002
         DS    CL1                      SPARE                    Y02021 44100002
SAVEPTR  DS    CL4                      POINTER TO REG SAVE AREA Y02021 44170002
REGSAVE  DS    CL72                     STANDARD REG SAVE AREA @YM2957P 44240002
WRK1AREA EQU   REGSAVE                  MDR WORK AREA            Y02021 44310002
         EJECT                                                          44380002
         USING MDRBUFFR,R8RECADR                                        44450002
MDRBUFFR DSECT                                                          44520002
         SPACE                                                          44590002
BUFFER   DS    CL238                   BUFFER LENGTH           @YM6451P 44660002
*      THE FOLLOWING FIELDS ARE COMMON TO ALL MDR BUFFERS - SIX BYTES   44730002
BUFSIZE  EQU   BUFFER                  SIZE OF THIS RECORD              44800002
BUFSUBID EQU   BUFFER+2                VARIABLE SUB ID                  44870002
BUFXCTL  EQU   BUFFER+3                SPECIAL XCTL INFO                44940002
BUFRECID EQU   BUFFER+5                ID OF DEVICE FOR WHICH RECORD    45010002
*                                       WILL BE GENERATED               45080002
*      THE FOLLOWING FIELDS ARE AVAILABLE IN A FORMATTED BUFFER         45150002
EXTRA18  EQU   BUFFER+6                18 BYTES OF ZEROS-FOR HEADER     45220002
FBUFBODY EQU   BUFFER+24               BODY OF RECORD IN FORMATTED BUFF 45290002
         SPACE                                                          45360002
*      THE FOLLOWING HEADER WILL BE PUT IN THE FIRST 24 BYTES OF BUFFER 45430002
MCLASRC  EQU   BUFFER                   RECORD CLASS AND SOURCE  Y02021 45500002
MSYSREL  EQU   BUFFER+1                 SYSTEM RELEASE           Y02021 45570002
MSWITCHS EQU   BUFFER+2                 SWITCHES                 Y02021 45640002
MSW1     EQU   BUFFER+3                 SWITCH FLD               Y02021 45710002
MRECID   EQU   BUFFER+4                 RECORD ID                Y02021 45780002
MSUBID   EQU   BUFFER+5                 VAR SUBID FIELD LENGTH   Y02021 45850002
SPARE    EQU   BUFFER+6                SPARE FIELD                      45920002
MDATE    EQU   BUFFER+8                 DATE                     Y02021 45990002
MTIME    EQU   BUFFER+12                TIME                     Y02021 46060002
MCPUSER  EQU   BUFFER+16                CPU SERIAL #             Y02021 46130002
MCPUMOD  EQU   BUFFER+20                CPU MODEL #              Y02021 46200002
BUFINFO  EQU   BUFFER+24               DEVICE DEPENDENT BODY OF RECORD  46270002
*      THE FOLLOWING FIELD IS AVAILABLE FOR A NON-FORMATTED BUFFER      46340002
*        IE-2715,3270(BTAM)                                             46410002
BUFBODY  EQU   BUFFER+6                BODY OF RECORD                   46480002
         SPACE                                                          46550002
       EJECT                                                            46620002
         USING CVTMAP,R2CVTBAS                                   Y02021 46690002
         CVT   DSECT=YES,LIST=YES                                       46760030
         EJECT                                                          46830002
         USING UCBOB,R4UCB                                       Y02021 46900002
         USING UCBUCS,R6WORK                                            46970002
         USING UCBCMEXT,R10WORK                                @YM00142 47000002
         IEFUCBOB LIST=YES,PREFIX=YES                                   47040002
         EJECT                                                          47110002
         IECDIOCM                                                       47180002
         EJECT                                                          47250002
         IHASRB                                                         47320002
         EJECT                                                          47390002
         IHAPSA                                                         47460002
         EJECT                                                          47530002
         USING IOSB,R12IOB                                              47600002
         IECDIOSB                                                       47670002
         EJECT                                                          47740002
         USING EWA,R1PARM                                               47810002
         IECDERWA  (ALL)                                        YM7629P 47950002
         EJECT                                                          48020002
         USING ASCB,R5WORK                                       Y02021 48090002
         IHAASCB                                                        48160002
         EJECT                                                          48230002
IGE0025F CSECT                                                          48300002
*********************************************************************** 48370002
*                                                                     * 48440002
*****    ENTRY  TO  OUTBOARD  RECORDER  (OBR)  ROUTINE            ***** 48510002
*                                                                     * 48580002
*                        XCTL LOAD NAME - 025F                        * 48650002
*                                                                     * 48720002
*********************************************************************** 48790002
         SPACE 2                                                        48860002
         SPACE 2                                               @Y17CSWT 48930003
**** MODULE DISTRIBUTION LIBRARY ID AND CREATION DATE.         @Y17CSWT 48940003
         USING *,15                                            @Y17CSWT 48950003
OBRSTART BAL   R3CBASE,OBRSTL2        INIT BASE REG & BRANCH   @Y17CSWT 48960003
         USING *,R3CBASE                AROUND ID & DATE       @Y17CSWT 48970003
         DROP  15                      DROP TEMP BASE REG      @Y17CSWT 48980003
         DC    AL1(OBRSTL2-OBRSTL1)    LENGTH OF MOD ID & DATE @Y17CSWT 48990003
OBRSTL1  DC    CL8'IFBOBR00'           MODULE ID               @Y17CSWT 49000003
         DC    C'&SYSDATE'             DATE OF COMPILATION     @Y17CSWT 49010003
OBRSTL2  DS    0H                      CONTINUE PROCESSING     @Y17CSWT 49020003
         SPACE 2                                               @Y17CSWT 49030003
         USING OBRPGMCK,R15CODE                                         49070002
         L     R2CVTBAS,CVTPTR         LOAD CVT POINTER                 49140002
         LR    R12IOB,R1PARM            GET IOSB POINTER         Y02021 49210002
         GETMAIN RC,LV=328,SP=255                                Y02021 49420002
         LR    R9LOGBAS,R1PARM          GET WORK AREA POINTER    Y02021 49490002
         LR    R1PARM,R12IOB            RESTORE REG 1            Y02021 49560002
         LTR   R15CODE,R15CODE          TEST FOR RETURN CODE     Y02021 49630002
         BZ    YESGET              YES,GETMAIN IS GOOD         @ZA02772 49700003
         TM    IOSPKEY,IOSIDR      NO, DIR RECORDING?          @ZA02772 49710003
         BO    NOMAIN1             YES,EXIT--IOSB/SRB/EWA CANNOT BE     49720003
**                                 FREED                       @ZA02772 49730003
         TM    CVTOPTA,CVTNIP      NIP RUNNING?                @ZA02772 49740003
         BO    NOMAIN              FREE IOSB                   @ZA02772 49750003
*                                                                       49770002
**     TEST FOR MDR RECORD OR GO CHECK FOR TCAM EOD RTN OR DDR          49840002
*                                                                       49910002
         L     R1PARM,IOSERP            GET EWA ADDRESS          Y02021 49980002
         L     R4UCB,IOSUCB             GET UCB ADDRESS          Y02021 50050002
         TM    EWAFLG2,EWAMDR           TEST FOR MDR             Y02021 50120002
         BZ    TCREC1                   NO-GO TEST FOR TCAM      Y02021 50190002
         B     MDR1                     BRANCH TO SPECIAL ENTRY  Y02021 50260002
         SPACE 1                                                        50330002
YESGET   TM    CVTOPTA,CVTNIP      NIP RUNNING?                @ZA02772 50340003
         BZ    CLRMAIN             YES,GO PROCESS              @ZA02772 50350003
         TM    IOSPKEY,IOSIDR      DIR RECORDING?              @ZA02772 50360003
         BO    DIRTST              YES, GO DELETE IOSB/SRB/EWA @ZA02772 50370003
         B     NOMAIN              NO, GO FREE IOSB            @ZA02772 50380003
CLRMAIN  XC    BLDAREA(LOGLEN),BLDAREA  CLEAR GOTTEN CORE        Y02021 50400002
         XC    REGSAVE(SAVLEN),REGSAVE  CLEAR GOTTEN CORE        Y02021 50470002
         ST    R1PARM,IOSBADDR          SAVE IOSB POINTER        Y02021 50540002
         MVC   STAELIST(SIXTEEN),ESTALIST    GET LIST TO MAIN    Y02021 50610002
         LA    R5WORK,ESTAPARM          GET PARAM LIST ADDR      Y02021 50680002
         STM   R2CVTBAS,R12IOB,ESTAPARM SAVE REGISTERS FOR ESTAE Y02021 50750002
         LA    R1PARM,STAELIST          GET STAE LIST ADDR       Y02021 50820002
         L     R6WORK,PGMCKADD          GET ESTAE RTN ADDR       Y02021 50890002
         ESTAE (6),PARAM=(5),MF=(E,(1))                                 50960002
         L     R1PARM,IOSERP            GET EWA ADDRESS          Y02021 51030002
DIRENTRY L     R4UCB,IOSUCB             GET UCB ADDRESS          Y02021 51100002
         SR    R15CODE,R15CODE          CLEAR CODE REG           Y02021 51170002
         TM    EWAFLG2,EWAMDR           TEST FOR MDR             Y02021 51240002
         BO    MDR                      YES - BRANCH             Y02021 51310002
*                                                                       51380002
**     ROUTINE TO BUILD THE RECORD HEADER - FIRST 24 BYTES              51450002
*                                                                       51520002
         TM    IOSFLB,IOSSDR       NO OBR RECORDING?           @Z402IVS 51540000
         BO    DIRTST              YES,EXIT                    @Z402IVS 51560000
         MVI   CLASRC,OBRREC           SET RECORD TYPE - CLASS/SOURCE   51590002
         TM    IOSFLA,IOSEX+IOSERR PERMANENT ERROR?            @ZA06044 51660003
         BM    SETREL              YES, BYPASS SETTING TEMP FLAG        51730003
         OI    SW1,TEMPERR             SET TEMPERARY ERROR SW    A44509 51800002
         SPACE                                                          51870002
SETREL   LR    R11WORK,R2CVTBAS        LOAD CVT ADDR                    51940002
         SH    R11WORK,CONST4          SUBTRACT TO ADDR OF REL #        52010002
         PACK  WORKAREA(DBLWRD),ZERO(RELLN,R11WORK)   PACK REL #        52080002
         CVB   R11WORK,WORKAREA         CONVERT REL # TO BINARY  Y02021 52150002
         STC   R11WORK,SYSREL          STORE REL # IN REC               52220002
         OI    SYSREL,VS2IND            SET VS2 IND IN RECORD    Y02021 52290002
         TIME  DEC                     GET TIME AND DATE                52360002
         ST    R0PARM,TIME             STORE TIME IN REC                52430002
         ST    R1PARM,DATE             STORE DATE IN REC                52500002
         MVI   SWITCHES,TIMEBIT        SET'TIME MACRO USED' SW IN REC   52570002
         EJECT                                                 Z15459VM 52640030
*                                                              Z15459VM 52670030
**** OBTAIN CPUID OF MACHINE ON WHICH ERROR OCCURED.           Z15459VM 52700030
*                                                              Z15459VM 52730030
         LA    R4UCB,CPUSER            R4=@ CPUID FIELD IN OBR Z15459VM 52760030
         BAL   R6WORK,CPUIDRTE         OBTAIN CPUID FOR ERP CPUZ15459VM 52790030
         SPACE                                                          52850002
         MVC   SECUA0C(TWO),UCBCHA      MOVE SEC/ALT CUA TO REC  Y02021 52920002
         MVC   DEVTYP(FOUR),UCBTYP      MOVE DEV TYPE TO REC     Y02021 52990002
         SPACE 2                                                        53060002
*                                                                       53130002
*      FIND PRIMARY/PHYSICAL CHANNEL UNIT ADDRESS OF FAILING DEVICE     53200002
*                                                                       53270002
         MVC   PCUA0C(TWO),EWACHA  MOVE IN EWA CUA             @ZA03185 53280003
         OC    PCUA0C(TWO),PCUA0C  IS IT ZERO?                 @ZA03185 53290003
         BNZ   EWACUA              NO, EXIT                    @ZA03185 53300003
         LA    R5WORK,CUA              LOAD NUM OF CHAR IN A CUA        53340002
         L     R6WORK,UCBNAME-ONE       LOAD NUM OF CHAR IN CUA  Y02021 53410002
LABL1    STC   R6WORK,SAVEREGS         STORE CHAR OF CUA                53480002
         TM    SAVEREGS,NUMERIC        IS IT NUMERIC                    53550002
         BO    LABL2                   YES - BR TO CONTINUE             53620002
         LA    R6WORK,MAKBIN(R6WORK)   ADD 9 TO LOW ORDER BITS OF BYTE  53690002
LABL2    SRDL  R6WORK,HALFBYTE         SHIFT 4 LOW ORDER BITS TO NXT RG 53760002
         SRL   R6WORK,HALFBYTE         SHIFT OUT UNWANTED BITS          53830002
         BCT   R5WORK,LABL1            BR IF THERE ARE MORE CHAR'S      53900002
         SRL   R7WORK,ENDREG           SHIFT BINARY CUA TO LOW ORDER    53970002
         STH   R7WORK,PCUA0C           STORE PRIM/PHY CUA IN REC        54040002
         SPACE                                                          54110002
         EJECT                                                          54180030
*                                                                       54210030
*      THE FOLLOWING CHECKS FOR TCAM AND IF A FULL OBR RECORD IS NEEDED 54250002
*                                                                       54320002
EWACUA   EQU   *                                               @ZA03185 54330003
         L     R10WORK,UCBEXTPT         UCB EXTENSION POINTER  @YM00142 54350002
         CLI   UCBETI,TCAMEXT1          WAS A TCAM ERP USED      Y02021 54390002
         BL    TCAM1                   TEST FOR ATCAM CODE     @Y30APDZ 54460003
         CLI   UCBETI,TCAMEXT3          WAS A TCAM ERP USED 3705 Y02021 54670002
         BH    TCAM2                    TEST FOR ATCAM  ODE    @Y30APDZ 54740003
TCREC    MVI   CLASRC,TCAMREC          SET REC TYPE CLASS/SOURCE - TCAM 54810002
         TM    EWTCFLG,EWTCOVF+EWTCEOD  TEST FOR OVRFLO OR EOD   Y02021 54880002
         BZ    FULLREC                 NO - BR TO MAKE A FULL OBR REC   54950002
         B     TAMOFL                  YES - BR TO INIT TCAM ONLY FLDS  55020002
TCAM1    CLI   UCBETI,ATCMEXT1          WAS AN ATCAM ERP USED  @Y30APDZ 55025003
         BE    ATCMREC                  YES, PUT IN NEW CLASS REC       55030003
TCAM2    CLI   UCBETI,ATCMEXT2         WAS AN ATCAM ERP USED   @Y30APDZ 55035003
         BNE   TSTPERM                 NO, GO ON PROCESSING    @Y30APDZ 55040003
ATCMREC  MVI   CLASRC,ATCAMREC         PUT IN ATCAM CLASS REC ID        55045003
         TM    EWAFLG3,X'01'           PERM ERROR              @Y30APDZ 55050003
         BO    FULLREC                 YES                     @Y30APDZ 55055003
         TM    EWTCFLG,EWTCOVF+EWTCEOD  OVERFLOW-EOD           @Y30APDZ 55060003
         BNZ   TAMOFL                  YES                     @Y30APDZ 55065003
         OI    EWTCFLG,EWTCOVF         TURN ON OVERFLOW        @Y30APDZ 55070003
         B     TAMOFL                                          @Y30APDZ 55075003
         SPACE                                                          55090002
*      A CHECK IS MADE FOR A FULL OBR RECORD IF ONE OF THE FOLLOWING:   55160030
*        .PERMANENT ERROR,I.E.,IOSEX | IOSERR(EXCLUSIVE OR)             55170030
*        .LONG OBR REQUESTED,I.E. IOSLOG BIT ON.                        55180030
*        .ROTATIONAL POSITION SENSING (RPS) DEVICE.(3800 NOT SUPPORTED) 55190030
*        .COUNTER OVERFLOW FOR VARIABLE LENGTH SDR DEVICE.              55200030
*                                                                       55210030
TSTPERM  TM    IOSFLA,IOSEX+IOSERR     PERMANENT ERROR?        @ZA06044 55220030
         BM    FULLREC             YES, OUTPUT FULL RECORD     @ZA06044 55230003
         TM    IOSFLB,IOSLOG           LONG OBR REQUESTED?     Z12990VM 55250003
         BO    FULLREC                 YES-CREATE LONG OBR     Z12990VM 55270003
         CLI   UCBTBYT3,UCB3UREC   IS THIS A UNIT RECORD DEV?  @Z402IVS 55274000
         BNE   TSTPERM1            NO-BYPASS 3800 CHECK        Z12032VM 55278000
         CLI   UCBTBYT4,UCB3800    IS IT A 3800 DEVICE?        @Z402IVS 55282000
         BE    FULLREC             YES,GO TEST FOR FULL RECORD @Z402IVS 55286000
         B     TSTOVFL             NO-BYPASS DASD/RPS CHECK    Z12032VM 55290000
TSTPERM1 EQU   *                   CONTINUE W DASD/RPS CHK     Z12032VM 55294000
         CLI   UCBTBYT3,UCB3DACC     IS IT DASD?               @AZ07944 55300003
         BNE   TSTOVFL               NO TEST CNTR. OVFL.       @AZ07944 55310003
         TM    UCBTBYT2,UCBRPS       IS IT RPS?                @AZ07944 55320003
         BO    FULLREC               YES FULL OBR              @AZ07944 55330003
TSTOVFL  TM    EWAFLG2,EWACOVF       TEST FOR CNTR. OVFL.      @AZ07944 55340003
         BZ    TERM                    NO CHECK FOR TCAM       @Z40RSVS 55370003
         TM    UCBFL5,UCBVSDR           CHECK FOR VAR LENGTH SDR Y02021 55440002
         BZ    SHOBR                   NO - BR TO PROCESS A SHORT OBR   55510002
         OI    SW1,TEMPERR             SET TEMP ERROR SW FOR NEW DEVICE 55580002
         EJECT                                                          55610030
*                                                                       55650002
*      ROUTINE TO FIND THE FAILING JOD IDENTITY                         55720002
*                                                                       55790002
FULLREC  TM    IOSPKEY,IOSIDR      TEST FOR FULL RECORD        @ZA02772 55860003
         BZ    FULLRECA                 NO-BRANCH AROUND         Y02021 55930002
         MVC   JOBID(JOBLEN),DIRJOB     PUT IN DIR JOB           Y02021 56000002
         B     SETPTR                   CONTINUE                 Y02021 56070002
         SPACE 1                                                        56140002
FULLRECA L     R5WORK,CVTTCBP           GET TABLE POINTER        Y02021 56210002
         L     R5WORK,TWELVE(R5WORK)    GET CURRENT ASCB PTR     Y02021 56280002
         L     R5WORK,ASCBJBNI          GET PTR TO JOB ID        Y02021 56350002
         LTR   R5WORK,R5WORK            TEST FOR ADDRESS         Y02021 56370002
         BZ    SETPTR                   NO JOBNAME IF ZERO       Y02021 56390002
         MVC   JOBID(JOBLEN),ZERO(R5WORK)    MOVE JOB NAME TO RE Y02021 56420002
         SPACE                                                          56490002
SETPTR   LA    R8WORK,VOLABEL          LOAD ADDR OF DEVICE DEPENDENT    56560002
         SPACE                                                          56630002
*                                                                       56700002
*      ROUTINE TO DETERMINE DEVICE TYPE OF FAILING UNIT                 56770002
*                                                                       56840002
         CLI   UCBTBYT3,UCB3UREC        TEST FOR UNIT RECORD     Y02021 56910002
         BE    CK3505                  YES - BR TO CK TYPE              56980002
         CLI   UCBTBYT3,UCB3TAPE        TEST FOR TAPE            Y02021 57050002
         BE    TAPES                   YES - BR TO CK TYPE              57120002
         CLI   UCBTBYT3,UCB3DACC        TEST FOR DIRECT ACCESS   Y02021 57190002
         BNE   CCWCSW                  NO - BR TO GET CCW/CCW-NO DDD    57260002
         L     R5WORK,EWADCNT           GET POINTER TO DEV DEP   Y02021 57330002
         LA    R5WORK,FIVEDBL(R5WORK)   POINTER TO DA SENSE     YM5956P 57400002
         SPACE                                                          57470002
         CLI   UCBTBYT4,DA2314          TEST FOR 2314            Y02021 57540002
         BH    MERL                    NO - BUT ITS 370 DA I/O          57610002
         BL    MOVESEEK                NO - BR TO MOVE SEEK ADDR        57680002
*                                      YES - THIS IS A 2314             57750002
         MVC   OBRECB(SNSBYT),SNB040(R5WORK) GET SENSE BYTE 4    Y02021 57820002
*                                                      BYTE(CONTAINS    57890002
*                                                      PHY UNIT ADDR)   57960002
         B     PHYSDEV                 BRANCH AROUND 3330 CODE          58030002
OI       OI    OBRECB,HEX00        EXECUTED INSTRUCTION        @Z40RSVS 58060004
         SPACE                                                          58100002
*                                       I/O AND NO STAT CNTRS   XL03130 58170002
MERL     OI    FLAGS,MERZEUS+NOSDR     SET FLAG FOR 2ND LOAD= 370 DA    58240002
         CLI   UCBTBYT4,DA3350     TEST FOR                    @Z40RSVS 58260004
         BE    MOVESEEK            YES - BR - PHY CUA OK       @Z40RSVS 58280004
         CLI   UCBTBYT4,DA3340          TEST FOR WINCHESTER      Y02021 58310002
         BE    WIN                 YES                         @AZ08966 58380003
         MVC   OBRECB(SNSBYT),SNB040(R5WORK) GET SENSE BYTE 4    Y02021 58450002
         TM    SNB020(R5WORK),EMULATE EMULATION ACTIVE ?       @Z40RSVS 58520004
         BNO   NOEMU               NO, DONT CONVERT SNSB 4     @Z40RSVS 58523004
         CLI   UCBTBYT4,DA3330      3330?                      @AZ08966 58526003
         BNE   MOVESEEK                                        @AZ08966 58529003
         NI    PCUAUA,HEXDF              MASK OFF BIT 2        @AZ08966 58532003
         B     MOVESEEK                                        @AZ08966 58535003
WIN      TM    SNB020(R5WORK),EMULATE    IS IT 3344?           @AZ08966 58538003
         BNO   MOVESEEK                  UA OK FOR 3340        @AZ08966 58541003
         SR    R6WORK,R6WORK             3344 NEEDS SPCL CONV  @AZ08966 58544003
         IC    R6WORK,SNB040(R5WORK)     PICKUP SENSE BYTE 4   @AZ08966 58547003
         SRDL  R6WORK,THREE               MOVE STRING AND      @AZ08966 58550003
         SRL   R6WORK,THREE               DEVISE CODE TO       @AZ08966 58553003
         SLDL  R6WORK,THREE               BITS 3 TO 7.         @AZ08966 58556003
         NI    PCUAUA,HEXC0          STRIP BITS 2 TO 7         @AZ08966 58559003
         STC   R6WORK,OBRECB             SAVE STRING DEV CODE  @AZ08966 58562003
         OC    PCUAUA(ONE),OBRECB        MOVE STRING DEV CODE  @AZ08966 58565003
         B     MOVESEEK                                        @AZ08966 58568003
         SPACE 2                                                        58577004
NOEMU    NI    OBRECB,HIGHBIT      AND OUT 5 HIGH ORDER BITS   @Z40RSVS 58580004
         SPACE                                                          58590002
PHYSDEV  BAL   R11CNTRL,SETPHYUN       BRANCH TO PUT PHYSICAL/PRIMARY   58660002
*                                       UNIT ADDR IN RECORD             58730002
MOVESEEK MVC   IORETRY(TWO),EWACNTR1    MOVE RETRY COUNT         Y02021 58800002
*                                                                       58870002
*      THE FOLLOWING CHECKS FOR PARTICULAR DEVICES(2305,2321,ETC),      58940002
*        FINDS THERE VOL SERS,AND PUTS IT IN THE RECORD                 59010002
*                                                                       59080002
         CLI   UCBTBYT4,DA23051         TEST FOR 2305-1          Y02021 59150002
         BE    ZVOL                    YES - BR TO GET VOL SER          59220002
         CLI   UCBTBYT4,DA23052         TEST FOR 2305-2          Y02021 59290002
         BNE   ASPTAP                   NO-GO MOVE DEV DEP       Y02021 59360002
ZVOL     OI    FLAGS,MERZEUS+NOSDR      SET FLAGS                Y02021 59430002
         B     ASPTAP                   NO-GO MOVE DEV DEP       Y02021 59500002
         EJECT                                                          59570002
*                                                                       59640002
*      THE FOLLOWING CHECKS FOR 3400 TAPES AND MOVES VOL SER'S TO REC   59710002
*                                                                       59780002
TAPES    CLI   UCBTBYT4,T3400           TEST FOR ASPEN           Y02021 59850002
         BE    ASPTAP                  YES - BR TO GET DEV DEP DATA     59920002
         LA    R8WORK,DBLWRD(R8WORK)   BUMP POINTER TO SDR AREA FOR 2ND 59990002
         MVI   DEVDEPC,ONE             SET LEN OF DEV DEP AREA IN REC   60060002
         SPACE                                                          60130002
VOLID    BAL   R14LINK,GETDEVD          GET DEV DEP DATA         Y02021 60200002
         B     CCWCSW                  BRANCH TO GET FAILING CCW & CSW  60270002
         SPACE                                                          60340002
ASPTAP   LA    R8WORK,THREEDBL(R8WORK)  BUMP COUNTER FOR DEV DEP Y02021 60410002
         MVI   DEVDEPC,THREE           PUT DBL WRD SIZE OF DEV DEP AREA 60480002
         B     VOLID                   BRANCH TO GET VOL SER OF TAPE    60550002
         SPACE 3                                                        60620002
*                                                                       60690002
*      ROUTINE TO INITIALIZE FIELDS FOR A SHORT OBR RECORD --- STAT     60760002
*        COUNTER OVERFLOW ON A DEVICE WITHOUT VARIABLE LENGTH STATS     60830002
*                                                                       60900002
SHOBR    MVC   SDEVTYP(FOUR),UCBTYP     GET DEV TYPE FLD TO RE   Y02021 60970002
         OI    SW1,TEMPSHRT            SET SW FOR TEMP ERR/SHORT RECORD 61040002
         CLC   TY2314(DEVTYPE),UCBTBYT3 TEST FOR 2314            Y02021 61110002
         BNE   MOVCUA                  NO - BR TO MOVE CUA              61180002
         L     R5WORK,EWADCNT           GET POINTER TO DEV DEP   Y02021 61250002
         LA    R5WORK,FOURDBL(R5WORK)   GET POINTER TO SENSE     Y02021 61320002
         MVC   OBRECB(SNSBYT),FOUR(R5WORK)   GET 4TH SNS BYTE    Y02021 61390002
         BAL   R11CNTRL,SETPHYUN       BR TO DETERMINE PHYSICAL CUA     61460002
         SPACE                                                          61530002
MOVCUA   MVC   SCUA(CUA),PCUA          MOVE PHYSICAL CUA TO PROPER      61600002
*                                       PLACE FOR SHORT RECORD          61670002
         LA    R8WORK,SSDR             LOAD ADDR OF SDR AREA FOR        61740002
*                                       2ND LOAD                        61810002
         B     OBR1                     BRANCH TO COMPLETE       Y02021 61880002
*                                                                       61950002
*      PICK UP DEVICE DEPENDENT DATA                                    62020002
*                                                                       62090002
GETDEVD  CLI   EWADCNT,ZERO            CHECK FOR ZERO COUNT    @YM6451P 62160002
         BCR   EIGHT,R14LINK           YES-RETURN              @YM6451P 62180002
         IC    R5WORK,EWADCNT          GET COUNT               @YM6451P 62200002
         BCTR  R5WORK,ZERO              DECREMENT FOR EXECUTE    Y02021 62230002
         L     R6WORK,EWADCNT           GET POINTER TO DATA      Y02021 62300002
         EX    R5WORK,MOVEDEVD          MOVE DATA                Y02021 62370002
         BR    R14LINK                  RETURN                   Y02021 62440002
         SPACE 1                                                        62510002
MOVEDEVD MVC   IDTYPE(ZERO),ZERO(R6WORK)    MOVE DEV DEP DATA    Y02021 62580002
         SPACE 1                                                        62650002
         EJECT                                                          62720002
*                                                                       62790002
*      THE FOLLOWING CHECKS FOR CERTAIN UNIT RECORD DEVICES IF:         62860002
*        3505,3525 = SET FLAG FOR 125F FOR NO SDR CNTRS                 62930002
*        3211 = MAINTAIN COUNTER TO RELATE 'T' TYPE ERRORS TO OBR REC'S 63000002
*                                                                       63070002
CK3505   CLI   UCBTBYT4,UR3505          TEST FOR 3505-REDLAKE    Y02021 63140002
         BE    SETFLG                  YES - BR TO SET FLG              63210002
         CLI   UCBTBYT4,UR3850          TES FOR 3850(OAK,SS/1)  Y30LPDG 63230003
         BE    SETFLG                   YES--BR                 Y30LPDG 63250003
         CLI   UCBTBYT4,UR3895          TEST FOR 3895          @G30HIMD 63260002
         BE    SETFLG                   YES BRANCH             @G30HIMD 63270002
         CLI   UCBTBYT4,UR3525          TEST FOR 3525-PIKLAKE    Y02021 63280002
         BNE   CK3211                  NO - BR AROUND SETTING FLG       63350002
SETFLG   OI    FLAGS,NOSDR             SET FLAG FOR 2ND LOAD-NO STAT    63420002
*                                       COUNTERS FOR THIS DEVICE        63490002
CK3211   L     R6WORK,UCBXTADR          ADDR OF UCB UCS EXT.     Y02021 63560002
         CLI   UCBTBYT4,UR3211          TEST FOR 3211            Y02021 63630002
         BE    ROUT3211                 YES BRANCH               X03127 63700002
         CLI   UCBTBYT4,UR3540          TEST FOR 3540           Y30OPDP 63720003
         BE    ROUT3540                                         Y30OPDP 63740003
         CLI   UCBTBYT4,UR3886          TEST FOR 3886            Y02021 63770002
         BE    ROUT3540                 YES BRANCH             @G30HIMD 63790002
         CLI   UCBTBYT4,UR3895          TEST FOR 3895          @G30HIMD 63810002
         BNE   CCWCSW                   NO- GET CCW AND CSW      X03127 63840002
         BAL   R14LINK,GETDEVD          GET DEV DEP DATA       @G30HIMD 63850002
         LA    R8WORK,FIVEDBL(R8WORK)   BUMP PTR TO SDR AREA   @G30HIMD 63860002
         MVI   DEVDEPC,FIVE             SET LENGTH TO 5 DBLWDS @G30HIMD 63870002
         B     CCWCSW                   THEN GET CCW AND CSW   @G30HIMD 63880002
ROUT3540 BAL   R14LINK,GETDEVD          GET DEV DEP DATA        Y30OPDP 63910003
         B     INDVDPCT                 BR TO INC DEV DEP COUNT  X03127 63980002
ROUT3211 XR    R5WORK,R5WORK            CLEAR REG                X03127 64050002
         IC    R5WORK,UCBERCNT          GET ERR CNT FROM EXT     Y02021 64120002
         STC   R5WORK,IDTYPE           STORE ERR CNT IN REC             64190002
         LA    R5WORK,ADDONE(R5WORK)   UPDATE ERR CNT(CORRELATION #)    64260002
         STC   R5WORK,UCBERCNT          STORE ERR CNT IN EXT     Y02021 64330002
         SPACE                                                          64400002
INDVDPCT LA    R8WORK,DBLWRD(R8WORK)    BUMP PTR TO SDR AREA     X03127 64470002
         MVI   DEVDEPC,ONE             SET LENGTH IN DOUBLE WORDS OF    64540002
*                                       THE DEVICE DEPENDENT DATA AREA  64610002
         EJECT                                                          64680002
*                                                                       64750002
*      ROUTINE TO FIND CSW AND FAILING CCW FOR ALL DEVICES              64820002
*                                                                       64890002
CCWCSW   CLI   UCBTBYT3,UCB3DACC        TEST FOR DIRECT ACCESS  YM5956P 64960002
         BNE   CCWCSW1                  NO-BRANCH AROUND        YM5956P 65040002
         L     R5WORK,EWADCNT           GET DEV DEP POINTER     YM5956P 65120002
         MVC   FAILCCW(CCWLEN),FOURDBL(R5WORK) GET FAILING CCW  YM5956P 65200002
         MVC   CSW1(CSWLEN),THREEDBL+ONE(R5WORK)  GET CSW TO RE  Y02021 65310002
         B     OBR1                     GO COMPLET RECORD        Y02021 65380002
         SPACE 1                                                        65450002
CCWCSW1  CLI   IOSCOD,IOSINTC           TEST FOR INTERCEPT      YM5956P 65470002
         BE    CSWMOVE                  YES-GET CSW             YM5956P 65490002
CCWCSW2  L     R5WORK,IOSVST            GET CHAN PROG START    @YM2957P 65520002
         SPACE                                                          65590002
TESTTCAM CLI   CLASRC,TCAMREC          IS THIS A TCAM RECORD            65660002
         BE    MVCSWCCW                YES-GET CSW,CCW         @ZA28495 65730030
         CLI   CLASRC,ATCAMREC         VTAM RECORD?            @ZA28495 65760030
         BNE   CSWTEST            NO - BR AROUND FURTHER TESTS @ZA28495 65790030
MVCSWCCW MVC   CSW1(CSWLEN),EWTCCSW     GET TCAM CSW          @ZA28495  65800030
         MVC   FAILCCW(CCWLEN),EWTCCCW  GET TCAM CCW             Y02021 65870002
         B     TAMOFL                   GO COMPLETE RECORD       Y02021 65940002
         SPACE                                                          66010002
CSWTEST  CLC   ZEROS(THREE),IOSCSW      CHECK IF CCW ADD ZERO   YM5956P 66080002
         BE    CCWMOVE                 YES - BR TO MOVE 1ST CCW IN THE  66780002
*                                       CHAN PGM CHAIN-NOT THE FAILING  66850002
         L     R5WORK,IOSCC             LOAD CMD ADD FROM CSW    Y02021 66920002
CSWTEST2 LA    R7WORK,CCWLEN            LOAD LENGTH OF A CCW     Y02021 66990002
         SR    R5WORK,R7WORK           SUBTRACT TO ADDR OF FAILING CCW  67060002
         SPACE                                                          67130002
CCWMOVE  MVC   FAILCCW(CCWLEN),ZERO(R5WORK) MOVE FAILING CCW TO RECORD  67200002
CSWMOVE  MVC   CSW1(CSWLEN),IOSCSW      MOVE CSW TO RECORD       Y02021 67410002
         EJECT                                                          67480002
TAMOFL   CLI   CLASRC,TCAMREC          IS THIS A TCAM OBR               67550002
         BE    TAMOFL1                 YES                     @Y30APDZ 67620003
         CLI   CLASRC,ATCAMREC         VTAM RECORD?            @Y30APDZ 67625003
         BNE   OBR1                    NO                      @Y30APDZ 67630003
*                                      TEST REMOVED   @ZA28495@Y30APDZ  67635030
         BAL   R14LINK,GETDEVD         GET DEVICE DEP DATA     @Y30APDZ 67645003
         MVI   DEVDEPC,TWO             DEVICE DEP DATA         @Y30APDZ 67650003
         TM    EWTCFLG,EWTCOVF+EWTCEOD  TEST FOR EOD OR OVERFLOW        67655003
         BNZ   WRTTCAM                 BRANCH IF ONES OR MIZED @Y30APDZ 67660003
         MVC   TSENSE0(TWO),EWTCSNL     MOVE IN SENSE          @Y30APDZ 67665003
         B     WRTTCAM                 GO WRITE                @Y30APDZ 67670003
TAMOFL1  EQU   *                                               @Y30APDZ 67675003
         BAL   R14LINK,GETDEVD          GET DEV DEP DATA         Y02021 67690002
         OI    TFLAGS,TCAMFLG           SET TCAM FLAG FOR EREP   Y02021 67760002
         OI    INTSW,TCAMTYPE           SET TCAM TYPE RECORD     Y02021 67830002
         MVI   DEVDEPC,TWO             DBL WRD LEN OF DEV DEP DATA AREA 67900002
         TM    EWTCFLG,EWTCOVF+EWTCEOD  TEST FOR EOD OR OVERFLOW Y02021 67970002
         BNZ   WRTTCAM                  BRANCH IF ONES OR MIXED  Y02021 68040002
         MVC   TSENSE0(TWO),EWTCSNL     MOVE IN SENSE          @YM2957P 68110002
         SPACE                                                          68180002
*                                                                       68250002
*       WRITE TCAM RECORD ON LOGREC                                     68320002
*                                                                       68390002
WRTTCAM  LA    R0PARM,TCRECLEN          LOAD LENGTH OF RECORD    Y02021 68460002
         B     SETADR                   BRANCH TO WRITE RECORD   Y02021 68530002
*                                       TO SYS1.LOGREC                  68600002
*                                                                       68670002
*      ROUTINE TO PUT PHYSICAL/PRIMARY CUA IN OBR RECORD                68740002
*                                                                       68810002
SETPHYUN NI    OBRECB,SAVEUNIT         SAVE UNIT ADDR IN WORK AREA      68880002
         NI    PCUAUA,SAVECHAN         SAVE CHANNEL ADDR AND HIGH ORDER 68950002
*                                       BIT OF UNIT ADDR IN PCUA S99204 69020002
         CLI   OBRECB,NOTVALID         IS SENSE INFO VALID - 2314       69090002
         BCR   EQUAL,R11CNTRL          NOT VALID - RETURN               69160002
         OC    PCUAUA(ONE),OBRECB      INSERT PHYSICAL UNIT ADDR IN REC 69230002
         BR    R11CNTRL                RETURN TO CALLING ROUTINE        69300002
         EJECT                                                          69370002
OBR1     TM    FLAGS,NOSDR              ANY STAT COUNTERS?       Y02021 69440002
         BO    SENSE                   NO - GO GET SENSE DATA           69510002
         SPACE 2                                                        69580002
*                                                                       69650002
****     ROUTINE TO CHECK,RECORD, AND CLEAR STATISTICS TABLE       **** 69720002
****             FOR THE FAILING DEVICE                            **** 69790002
*                                                                       69860002
         L     R10WORK,UCBEXTPT         UCB EXTENSION POINTER  @YM00142 69890002
         XR    R7WORK,R7WORK           CLEAR REG                        69930002
         IC    R7WORK,UCBSTI            INSERT STAT TAB OFFSET   Y02021 70000002
         SPACE 1                                                        70070002
         CLC   TY2314(DEVTYPE),UCBTBYT3 TEST FOR 23214           Y02021 70140002
         BNE   NOT2314                  NO-BRANCH                Y02021 70210002
         LA    R5WORK,OLDSDR            GET COUNT                Y02021 70280002
         B     NEWSTAT2                 GO COMPLETE RECORD       Y02021 70350002
         SPACE                                                          70420002
NOT2314  L     R5WORK,CVTSTB           LOAD ADDR OF STAT TAB            70490002
LOOP1    CLM   R4UCB,X'3',ZERO(R5WORK)  IS DEV IN THIS SEC OF STATS     70560003
         BL    LOOP2                   YES - INCR ADJUSTED CORRECTLY    70630002
         LA    R5WORK,NXTSTAD(R5WORK)  LOAD ADDR OF FIRST UCB IN THE    70700002
*                                       NEXT STAT TAB SECTION           70770002
         LA    R7WORK,NXTSDRST(R7WORK) BUMP OFFSET PAST THIS SECTION    70840002
         B     LOOP1                   BRANCH BACK TO COMPARE ADDRESSES 70910002
LOOP2    MH    R7WORK,MULTICON         MULTIPLY OFFSET BY 10            70980002
         AL    R7WORK,CVTSTB           ADD ADDR OF STAT TABS TO OFFSET  71050002
         SPACE                                                          71120002
         TM    UCBFL5,UCBVSDR           DOES THIS DEV HAVE VAR   Y02021 71190002
*                                       LENGTH SDR'S                    71260002
         BO    NEWSTAT                 YES - PROCESS NEW STATS          71330002
         MVC   ZERO(OLDSDR,R8WORK),ZERO(R7WORK)  MOVE STAT CTRS TO REC  71400002
         XC    ZERO(OLDSDR,R7WORK),ZERO(R7WORK)  CLEAR STAT CTRS        71470002
         LA    R5WORK,OLDSDR            GET COUNT OF 10          X03127 71540002
         B     NEWSTAT2                 BRANCH TO HANDLE RECORD  X03127 71610002
         SPACE                                                          71680002
NEWSTAT  IC    R5WORK,ZERO(R7WORK)      GET FLAGS BYTE           X03127 71750002
         N     R5WORK,MASK              SAVE LOW ORDER COUNT     X03127 71820002
         MH    R5WORK,MULTICON          MULTIPLY BY 10           X03127 71890002
         AH    R5WORK,MULTICON          ADD 10                   X03127 71960002
         LR    R6WORK,R5WORK            SAVE COUNT               X03127 72030002
         BCTR  R5WORK,ZERO              REDUCE COUNT BY 1        X03127 72100002
         EX    R5WORK,MOVESTAT          MOVE STAT CTRS TO RECORD X03127 72170002
         BCTR  R5WORK,ZERO              REDUCE COUNT BY 1        X03127 72240002
         BCTR  R5WORK,ZERO              REDUCE COUNT BY 1        X03127 72310002
         EX    R5WORK,CLRSTAT           CLEAR STATS FROM +2      X03127 72380002
         TM    ZERO(R7WORK),CLROPT      TEST CLEARING CE MODE    X03127 72450002
         BO    NEWSTAT1                 NO-BRANCH AROUND         X03127 72520002
         MVI   ONE(R7WORK),ZERO         CLR CE MODE BYTE         X03127 72590002
NEWSTAT1 LR    R5WORK,R6WORK            GET COUNT OF STATS       X03127 72660002
NEWSTAT2 TM    SW1,SHORT                TEST FOR SHORT RECORD    X03127 72730002
         BO    NEWSTAT3                 YES-BRANCH AROUND        X03127 72800002
         LA    R8WORK,ZERO(R5WORK,R8WORK)   BUMP POINTER         X03127 72870002
         STC   R5WORK,SDRCNT            GET CNT TO LONG RECORD   X03127 72940002
         B     SENSE                    CONT. BUILDING RECORD    X03127 73010002
         SPACE                                                          73080002
NEWSTAT3 STC   R5WORK,SSDRCNT           GET COUNT IN SHORT RE    X03127 73150002
         LA    R0PARM,HDR(R5WORK)       GET COUNT OF SHORT RE    X03127 73220002
         SPACE                                                          73290002
SETADR   LA    R1PARM,BLDAREA          LOAD ADDRESS OF RECORD           73360002
SETADRA  LA    R13PARM,REGSAVE          POINTER TO SAVE AREA     Y02021 73430002
         SPACE                                                          73500002
       RECORD TYPE=LOGREC,DATAADR=(1),LENGTH=(0),BUFFER=YES,RCVRY=ESTAE 73640002
         ESTAE 0                                               @ZA06003 73670004
DIRTST   TM    IOSPKEY,IOSIDR      TEST FOR DIR RECORD         @ZA02772 73710003
         BZ    TERM                                            @ZA02772 74010003
         BAL   R6WORK,FREEIOSB     GO FREE IOSB/SRB/EWA        @ZA02772 74310003
         BAL   R14LINK,FREECORA    GO FREE GOTTEN CORE         @ZA02772 74610003
         SVC   EXIT                RETURN TO SUPERVISOR        @ZA02772 74910003
**                                                             @ZA02772 75210003
*                                                                       76020002
*      FREE IOSB AND EWA                                                76090002
*                                                                       76160002
FREEIOSB L     R7WORK,IOSSRB       GET SRB PTR                 @ZA02772 76230003
         MVC   ZERO(FOUR,R7WORK),IOSERP PUT EWA PTR IN CHAIN FLD        76300003
         LR    R1PARM,R7WORK       GET SRB POINTER             @ZA02772 76370003
         SPACE 1                                               @YM2957P 76452002
*     GET LOCAL LOCK TO PROTECT FRR STACK FOR CORE MGR         @YM2957P 76458002
*        REGS 11-14 ARE DESTROYED BY SETLOCK                   @YM2957P 76464002
*                                                              @YM2957P 76470002
         SPACE 1                                               @YM2957P 76476002
GETLOCK  SETLOCK   OBTAIN,TYPE=LOCAL,MODE=UNCOND,              @YM2957PX76482002
               RELATED=(IECVSMGR,IGE0025F(FREELOCK))           @YM2957P 76488002
         SPACE 1                                               @YM2957P 76494002
         USING IOCOM,R5WORK                                    @ZA02772 76500003
         L     R5WORK,CVTIXAVL          GET IOS TABLE PTR        Y02021 76510002
         L     R15CODE,IOCORMGT         GET IO CORE MGT PTR      Y02021 76580002
         LA    R11WORK,HEX20            INDICATE 160 BYTES     @YM2957P 76650002
         LA    R13PARM,REGSAVE          SAVE AREA POINTER        Y02021 76720002
         BAL   R14LINK,FOUR(R15CODE)    LINK TO CORE MGR         Y02021 76790002
         SPACE 1                                               @YM2957P 76810002
FREELOCK SETLOCK   RELEASE,TYPE=LOCAL,                         @YM2957PX76820002
               RELATED=(IECVSMGR,IGE0025F(GETLOCK))            @YM2957P 76830002
         SPACE 1                                               @YM2957P 76840002
         BR    R6WORK              RETURN                      @ZA02772 76850003
         DROP  R5WORK                                          @ZA02772 77550003
         SPACE 2                                                        78260002
         EJECT                                                          78330002
*                                                                       78400002
****     ROUTINE TO PUT SENSE BYTES OF FAILING UNIT IN RECORD      **** 78470002
*                                                                       78540002
SENSE    MVI   SENSCNT,ZERO             INITIALIZE COUNT TO ZERO Y02021 78610002
         L     R10WORK,UCBEXTPT         UCB EXTENSION POINTER  @YM00142 78640002
         SR    R6WORK,R6WORK            CLEAR WORK REG           Y02021 78680002
         IC    R6WORK,UCBSNSCT          GET SENSE COUNT          Y02021 78750002
         CLI   UCBTBYT3,UCB3DACC        TEST FOR DIRECT ACCESS   Y02021 78820002
         BE    DASNS                    YES-BRANCH TO HANDLE     Y02021 78890002
         LA    R5WORK,EWAIERP           GET PTR TO SENSE         Y02021 78960002
         B     DASNS1                   BRANCH TO COMPLETE       Y02021 79030002
         SPACE                                                          79100002
DASNS    L     R5WORK,EWADCNT           GET PTR TO DEV DEP       Y02021 79170002
         LA    R5WORK,FIVEDBL(R5WORK)   GET POINTER TO SENSE    YM5956P 79240002
DASNS1   LTR   R6WORK,R6WORK            TEST FOR ANY COUNT       Y02021 79310002
         BZ    SVCPRE                   YES-NO SENSE             Y02021 79380002
         STH   R6WORK,SENSCNT           COUNT TO RECORD          Y02021 79450002
         BCTR  R6WORK,ZERO              DECREMENT COUNT FOR MOVE Y02021 79520002
         EX    R6WORK,MOVESENS         MOVE SENSE BYTES TO RECORD       79590002
         SPACE                                                          79660002
SVCPRE   SR    R8WORK,R9LOGBAS          LENGTH OF RE LESS SENSE  Y02021 79730002
         AH    R8WORK,SENSCNT          ADD LENGTH OF SENSE              79800002
         LR    R0PARM,R8WORK           LOAD LENGTH OF RECORD            79870002
         B     SETADR                   BRANCH TO RECORD REC     Y02021 79940002
*                                                                       80010002
***      ROUTINE TO FREE GOTTEN CORE                                    80080002
*                                                                       80150002
         SPACE                                                          80220002
FREECORE L     R12IOB,IOSBADDR          GET ORIGINAL IOSB PTR    Y02021 80290002
FREECORA LR    R6WORK,R14LINK           SAVE RETURN REG          Y02021 80360002
         LR    R1PARM,R9LOGBAS          POINTER TO GOTTEN CORE   Y02021 80430002
         SPACE                                                          80500002
         FREEMAIN  RC,A=(1),LV=328,SP=255                        Y02021 80570002
         LR    R14LINK,R6WORK           RESTORE RETURN REG       Y02021 80640002
         BR    R14LINK                 RETURN TO CALLER.Z15459VM Y02021 80710030
         SPACE                                                          80716030
*                                                              Z15459VM 80722030
**** ROUTINE TO OBTAIN CPUID DIGITS FROM PCCA ENTRY, FOR CPU   Z15459VM 80728030
**** ON WHICH ERROR OCCURED.                                   Z15459VM 80734030
*                                                              Z15459VM 80740030
CPUIDRTE EQU   *                                               Z15459VM 80746030
         L     R1PARM,IOSERP           SET R1= @EWA            Z15459VM 80752030
         IC    R7WORK,EWACPU           STO CCA OFFSET          Z15459VM 80758030
         SLL   R7WORK,TWENTY8          MASK OUT ALL BUT LO 4   Z15459VM 80764030
         SRL   R7WORK,TWENTY6            BITS & MULT BY 4      Z15459VM 80770030
         L     R5WORK,CVTPCCAT     R5= @ PHYSICAL CCA VECT TBL Z15459VM 80776030
         L     R5WORK,ZERO(R7WORK,R5WORK) R5= @ PCCA ENTRY     Z15459VM 80782030
         PACK  ZERO(FOUR,R4UCB),SIX(SIX,R5WORK) PACK PCCA CPUIDZ15459VM 80788030
         L     R5WORK,ZERO(ZERO,R4UCB) R5= PACKED CPUID        Z15459VM 80794030
         SRL   R5WORK,FOUR             SHIFT OUT SIGN BITS     Z15459VM 80800030
         STIDP ZERO(R4UCB)             STO CPUID THIS CPU      Z15459VM 80806030
         STCM  R5WORK,X'7',ONE(R4UCB)  STO CPUID DIGITS ERP CPUZ15459VM 80812030
         L     R4UCB,IOSUCB            RESET R4 TO UCB         Z15459VM 80818030
         BR    R6WORK                  RETURN TO OBR/MDR STIPD Z15459VM 80824030
         EJECT                                                          80830030
*        HOUSEKEEPING - FREE CORE - TEST FOR PROPER EXIT       @YM6451P 80850002
         SPACE                                                          80920002
TERM     BAL   R14LINK,FREECORE    GO FREE GOTTEN CORE         @ZA02772 80990003
         TM    IOSFLB,IOSSDR       NO OBR RECORDING?           @Z402IVS 81060000
         BO    NOMAIN              YES,EXIT                    @Z402IVS 81130000
*                                                                       81200002
*        TEST FOR RETURN TO EOD MODULE                                  81270002
*                                                                       81340002
         L     R4UCB,IOSUCB             GET ORIG UCB ADDR        Y02021 81410002
         L     R1PARM,IOSERP            GET ORIG EWA ADDR        Y02021 81480002
TCREC1   L     R10WORK,UCBEXTPT         UCB EXTENSION POINTER  @YM00142 81550002
         NI    IOSFLB,LOGCLR            CLEAR IOSLOG FLAG      @YM2957P 81560002
         CLI   UCBETI,TCAMEXT1          WAS TCAM ERP USED        Y02021 81580002
         BE    TCREC2                   YES-GO TEST FOR EOD      Y02021 81620002
         CLI   UCBETI,TCAMEXT3          WAS A TCAM ERP USED 3705 Y02021 81830002
         BNE   DDRTEST                  NO-CONTINUE              Y02021 81900002
TCREC2   TM    EWTCFLG,EWTCEOD          TCAM EOD RECORD          Y02021 81970002
         BZ    DDRTEST                  NO-GO TEST FOR DDR       Y02021 82040002
         LR    R1PARM,R12IOB            IOSB TO REG 1            Y02021 82110002
         LH    R13PARM,EODMOD           GET MODULE NAME IN REG   Y02021 82180002
         B     EXIT1                    GO XCTL TO MODULE        Y02021 82250002
         EJECT                                                 @AZ09708 82320003
*        THE FOLLOWING ROUTINE CHECKS TO SEE IF THE DYNAMIC    @AZ09708 82330003
*        DEVICE REALLOCATION ROUTINE(DDR) IS TO BE INVOKED     @AZ09708 82340003
*        OR IF THE OTHER EXITS TO THE SVC, ETC ARE TO BE DONE  @AZ09708 82350003
*                                                              @AZ09708 82360003
DDRTEST  EQU   *                                               @AZ09708 82370003
         CLI   UCBTBYT3,UCB3UREC       UNIT RECORD DEVICE?     @ZA26472 82370430
         BNE   NOTUREC                 NO BYPASS UNIT RECORD   @ZA26472 82370830
         CLI   UCBTBYT4,UR3838         3838 DEVICE?            @ZA26472 82371230
         BE    NOMAIN                  YES-NO DDR SWAP.        @ZA26472 82371630
         CLC   UCBTBYT3(DEVTYPE),UR3800  ARGONAUT?    Z12990VM @Z402IVS 82373000
         BE    NOMAIN                  YES-NO DDR SWAP.        @ZA26472 82376030
         B     DDRIN1                  CHECK FOR PERMANENT ERR @ZA26472 82377030
NOTUREC  EQU   *                                               @ZA26472 82378030
         CLI   UCBTBYT3,UCB3DACC        DASD DEVICE            @AZ09708 82380003
         BNE   DDRIN1                   NO-BYPASS EMULATION CHK@AZ09708 82390003
         CLI   UCBTBYT4,DA2314          2314/2319 DEVICE       @AZ09708 82400003
         BE    DDRIN1                   YES-BYPASS EMULATION CK@AZ09708 82410003
         TM    EWDSNS2,EWD24            DEV. EMULATION ACTIVE  @AZ08966 82420003
         BO    NOMAIN                 YES, DON'T SWAP                   82464004
         CLC   UCBTBYT3(DEVTYPE),UR3350 DEVICE 3350?           @Z40RSVS 82466004
         BE    NOMAIN              YES, STD EXIT               @Z40RSVS 82472004
DDRIN1   EQU   *                                               @AZ09708 82502003
         TM    IOSFLA,IOSEX+IOSERR     TEST PERM ERR OR ERP CNTL        82550003
         BNM   NOMAIN              EXIT TO SUPERVISOR          @ZA02799 82560003
DDRIN    EQU   *                                               Z12032VM 82630003
         CLI   UCBTBYT3,UCB3DACC                               Z12032VM 82636003
         BNE   DDRIN2                                          Z12032VM 82642003
         TM    UCBSTAB,UCBPGFL                                 Z12032VM 82648003
         BO    NOMAIN                                          Z12032VM 82654003
DDRIN2   EQU   *                                               Z12032VM 82660003
         TM    CVTOPTA,CVTDDR          IS DDR IN THIS SYSTEM            82670002
         BO    DDREXIT                 YES - BR TO EXIT TO DDR          82740002
         SPACE                                                          82810002
*        THE FOLLOWING IS THE STANDARD EXIT - RETURN TO SUPERVISOR      82880002
         SPACE                                                          82950002
NOMAIN   LR    R1PARM,R12IOB             GET IOSB ADDR TO REG 1@AZ08966 83020003
         SVC   ERREXCP                   FREE IOSB             @AZ08966 83050003
NOMAIN1  SVC   EXIT                RETURN TO SUPERVISOR        @ZA02772 83090003
         SPACE                                                          83160002
*        THE FOLLOWING SETS PARAMETERS FOR EXIT TO DDR                  83230002
         SPACE                                                          83300002
DDREXIT  EQU   *                   Z12032VM                    Z12032VM 83370003
         LR    R1PARM,R12IOB                                   Z12032VM 83390003
         LH    R13PARM,DDRMOD                                  Z12032VM 83410003
         B     EXIT1                    GO TO DDR                Y02021 83440002
         SPACE                                                          83510002
         EJECT                                                          83580002
*******************************************************************     83650002
*                                                                 *     83720002
*****    ENTRY TO THE NON-STANDARD T TYPE RECORDER ROUTINE        ***** 83790002
*                                                                 *     83860002
*                                                                 *     83930002
*******************************************************************     84000002
         SPACE                                                          84070002
MDR      MVI   IOSBADDR,TPERRUNG        SET MDR IN-PROGRESS IND  Y02021 84140002
         SPACE                                                          84210002
*                                                                       84280002
*      ROUTINE TO DETERMINE IF THIS RECORD HAS A FORMATED BUFFER        84350002
*                                                                       84420002
*      MDR1 ENTRY IS FROM AN UNSUCCESSFUL GETMAIN                       84490002
*                                                                       84560002
MDR1     TM    UCBTBYT3,UCB3TAPE+UCB3COMM+UCB3DISP                      84630003
         BNZ   ADDRIOB       LOG BIT NOT ON - BRANCH TO                 84670003
*                            GET BUFFER ADDRESS                         84710003
*                                      YES - ITS A BUFFERED LOG DEVICE  84770002
         CLI   UCBTBYT3,DASD            TEST FOR DIRECT ACCESS   Y02021 84840002
         BE    DABUFPTR                 YES-GO CHK UNIT TYPE     Y02021 84910002
         CLI   UCBTBYT4,UR3895          IS THIS A 3895?        @G30HIMD 84930002
         BE    DABUFPTR                 YES,BRANCH             @G30HIMD 84950002
*                                      NO - THEN ITS A 3211 PRINTER     84980002
*      UNIT RECORD DEVICE,CHARACTER READER,FUTURE OTHER                 85010030
         L     R6WORK,UCBXTADR          GET PRT TO UCS EXT       Y02021 85050002
         CLI   UCBTBYT4,ARGO       3800?                       @Z402IVS 85070000
         BE    BUF3800             YES, GO                     @Z402IVS 85090000
         L     R8RECADR,UCBERADR        LOAD BUFFER ADDR         Y02021 85120002
         B     SAVEADR                 BRANCH TO FORMAT RECORD          85190002
BUF3800  L     R8RECADR,ARGERADR(R6WORK) LOAD BUFFER ADDRESS   @Z402IVS 85210000
         B     SAVEADR             BRANCH TO FORMAT RECORD     @Z402IVS 85230000
         SPACE                                                          85260002
DABUFPTR L     R8RECADR,EWADCNT         GET PTR TO BUFFER        Y02021 85330002
         B     SAVEADR                 BRANCH TO FORMAT RECORD          85400002
         EJECT                                                          85470030
*                                                                       85480030
*      DEVICE CLASSES:TAPE,COMMUNIC,DISPLAY OR CHAN TO CHAN ADAPTER.    85490030
*                                                                       85500030
ADDRIOB  L     R8RECADR,EWTCBUFF        LOAD BUFFER ADDR         Y02021 85540002
*                                      NOTE: IF TCAM IS THE ACCESS      85610002
*                                       METHOD THIS IS A FORMATED BUFF  85680002
*                                       IF NOT-ITS A NON FORMATED BUFF  85750002
         L     R10WORK,UCBEXTPT         UCB EXTENSION POINTER  @YM00142 85780002
         CLI   UCBETI,TCAMEXT1          IS IT TCAM               Y02021 85820002
*                                    TP=X'2F',X'30',X'31'      Z16952VM 85890030
         BL    NOTFORM                 NOT TP-UNFORMATTED BUF  Z16952VM 85990030
         CLI   UCBETI,TCAMEXT3          IS IT TCAM               Y02021 86100002
         BH    NOTFORM                 NOT TP-UNFORMATTED BUF  Z16952VM 86170030
SAVEID   LR    R11BUFSV,R8RECADR       SAVE RECORD/BUFFER ADDR          86240002
         B     SAVEXCTL                BR TO BYPASS SUB ID ZEROING      86310002
*                                                                       86380002
*      THE FOLLOWING CODE HANDLES NON-FORMATTED BUFFER-RECORD IS        86450002
*      FORMATTED IN THE GETMAIN AREA                                    86520002
*      TAPE,COMMUNIC OR DISPLAY,BUT NOT TCAM                            86590030
*                                                                       86620030
NOTFORM  LR    R11BUFSV,R8RECADR        SAVE BUFFER ADDR         Y02021 86660002
*                                                                       86940002
*      THE FOLLOWING TEST IS FOR UNSUCCESSFUL GETMAIN                   87010002
*                                                                       87080002
         LTR   R15CODE,R15CODE          TEST FOR COMPLETION CODE Y02021 87150002
         BNZ   SAVEXCTL                 YES-GO TEST FOR XCTL     Y02021 87220002
         MVC   BLDAREA(MDRINFO),BUFFER  MOVE FIRST 6 BYTES       Y02021 87240002
         SR    R10SIZE,R10SIZE          CLEAR REGISTER         @YM6451P 87260002
         LH    R10SIZE,BUFSIZE          GET BUFFER SIZE        @YM6451P 87267002
         SH    R10SIZE,CONST7           ADJUST COUNT BY 7      @YM6451P 87274002
         EX    R10SIZE,MOVEBUFF         MOVE REST OF BUFFER    @YM6451P 87281002
         LR    R8RECADR,R9LOGBAS        USE GOTTEN CORE TO       Y02021 87290002
*                                       FORMAT THE HEADER               87360002
         LH    R10SIZE,BUFSIZE         LOAD SIZE OF BUFF                87430002
         LA    R10SIZE,REMHDR(R10SIZE) ADD 18 FOR HEADER                87500002
         STH   R10SIZE,BUFSIZE         STORE BACK UPDATED SIZE          87570002
         SPACE                                                          87640002
         CLI   BUFRECID,ID2715         IS THIS A 2715                   87710002
         BE    CLRSUBID                YES - BR TO CLEAR SUB ID         87780002
         B     SAVEXCTL                NO - BRANCH-DONT CLEAR SUB ID    87850002
         SPACE 2                                                        87920002
SAVEADR  LR    R11BUFSV,R8RECADR       SAVE RECORD/BUFFER ADDRESS       87990002
CLRSUBID MVI   BUFSUBID,ZERO           CLEAR VARIABLE SUB ID            88060002
SAVEXCTL LTR   R15CODE,R15CODE          TEST FOR COMPLETION CODE Y02021 88130002
         BZ    SAVXCTL1                 NO-BRANCH AROUND         Y02021 88200002
         ICM   R13PARM,THREE,BUFXCTL    GET XCTL NAME IN REG 13  Y02021 88270002
         ICM   R12IOB,EIGHT,MDRINPRG    SET MDR IN PROG IND      Y02021 88340002
         MVI   SUCCESS(R11BUFSV),NOTSUC MARK NOT SUCCESSFUL      Y02021 88410002
         B     TERM1A                   GO FINISH TERM TESTS     Y02021 88480002
SAVXCTL1 MVC   BINXCTL(TWO),BUFXCTL     MOVE XCTL INFO TO RECORD Y02021 88550002
         SPACE                                                          88620002
*                                                                       88690002
*      ROUTINE TO SAVE AND CHECK RECORD SIZE                            88760002
*                                                                       88830002
         LH    R10SIZE,BUFSIZE         LOAD AND SAVE SIZE OF RECORD     88900002
         CLC   BUFSIZE(SIZE),HDRLEN    IS RECORD SIZE GREATER THEN 24   88970002
         BH    INITHDR                 YES- BR TO FORMAT HEADER         89040002
         SPACE                                                          89110002
         MVI   SUCCESS(R11BUFSV),TOSMALL    PUT SUCCESS SYMBOL IN BUFF  89180002
         B     TERM1                   BRANCH TO TERMINATE              89250002
         EJECT                                                          89320002
*                                                                       89390002
*      ROUTINE TO INITIALIZE THE MDR HEADER RECORD                      89460002
*                                                                       89530002
INITHDR  MVC   MRECID(ONE),BUFRECID     MOVE RECORD ID TO RE     Y02021 89600002
         MVC   MSUBID(ONE),BUFSUBID     MOVE SUB ID TO RE        Y02021 89670002
         XC    MSWITCHS(TWO),MSWITCHS   CLEAR SWITCH FIELD       Y02021 89740002
         XC    SPARE(TWO),SPARE        CLEAR UNUSED SPACE               89810002
         SPACE                                                          89880002
         MVI   MCLASRC,TPEREC           SET RECORD CLS AND SRC   Y02021 89950002
         SPACE                                                          90020002
         LR    R5WORK,R2CVTBAS         LOAD CVT ADDR                    90090002
         SH    R5WORK,CONST4           SUBTRACT TO ADDR OF REL #        90160002
         PACK  WRK1AREA(DBLWRD),ZERO(RELEN,R5WORK)    PACK REL #        90230002
         CVB   R6WORK,WRK1AREA          CONVERT REL # TO BINARY  Y02021 90300002
         STC   R6WORK,MSYSREL           STORE REL # IN RECORD    Y02021 90370002
         OI    MSYSREL,VS2IND           SET VS2 RELEASE IND      Y02021 90440002
         SPACE                                                          90510030
**** OBTAIN CPUID OF MACHINE ON WHICH ERROR OCCURED.           Z15459VM 90560030
         LA    R4UCB,WRK1AREA          R4=@ WRKAREA IN MDR     Z15459VM 90610030
         BAL   R6WORK,CPUIDRTE         OBTAIN CPUID FOR ERP CPUZ15459VM 90660030
         MVC   MCPUSER(DBLWRD),WRK1AREA  STO IN CPUID AREA/MDR Z15459VM 90710030
         SPACE                                                          90790002
         CLI   MRECID,ID3670            TEST FOR 3670            Y02021 90860002
         BNE   SETIME                  NO - BR TO CONTINUE              90930002
         CH    R10SIZE,MIN3670         IS REC SIZE LESS THEN NORMAL     91000002
         BNL   SETIME                  NO - BR TO CONTINUE              91070002
         OI    MSW1,INCOM               SET SHORT RECORD SW      Y02021 91140002
         SPACE                                                          91210002
SETIME   TIME  DEC                     GET TIME AND DATE                91280002
         ST    R0PARM,MTIME             STORE TIME IN REC        Y02021 91350002
         ST    R1PARM,MDATE             STORE DATE IN REC        Y02021 91420002
         OI    MSWITCHS,TIMEBIT         SET TIME MACRO SW        Y02021 91490002
         SPACE                                                          91560002
*                                                                       91630002
*      ROUTINE TO WRITE RECORD TO SYS1.LOGREC                           91700002
*                                                                       91770002
         LR    R0PARM,R10SIZE           GET COUNT                Y02021 91840002
         LR    R1PARM,R8RECADR         LOAD ADDR OF RECORD              91910002
         LA    R13PARM,REGSAVE          LOAD SAVE AREA ADDR      Y02021 91980002
       RECORD TYPE=LOGREC,DATAADR=(1),LENGTH=(0),BUFFER=YES,RCVRY=ESTAE 92050002
         LTR   R15CODE,R15CODE         WAS RECORD WRITTEN               92120002
         BZ    RECOK                   YES - BR TO INSERT SUCCESS SYM   92190002
         SPACE                                                          92260002
         MVI   SUCCESS(R11BUFSV),NOTSUC PUT SUCCESS SYMBOL IN BUFF      92330002
         B     TERM1                   BR TO TERMINATE                  92400002
         SPACE                                                          92470002
RECOK    MVC   ZERO(MSG,R11BUFSV),TPR  MOVE 'TPR' TO BUFFER             92540002
         MVI   SUCCESS(R11BUFSV),OK    PUT SUCCESS SYMBOL IN BUFF       92610002
         EJECT                                                          92680002
*                                                                       92750002
*      ROUTINE TO TERMINATE - EXIT TO ERROR XCTL ROUTINE OR SUPERVISOR  92820002
*                                                                       92890002
TERM1    ESTAE 0                                               @ZA06003 92960004
         XR    R13PARM,R13PARM     CLEAR R13                   @ZA06003 93010004
         ICM   R13PARM,THREE,BINXCTL LOAD XCTL MOD NAME        @ZA02772 93060003
TERM1A   DS    0H                                              @ZA02772 93160003
         LTR   R13PARM,R13PARM         IS THERE XCTL INFO               93310002
         BZ    EXIT3                   NO - BR TO EXIT TO SUPERVISOR    93380002
         CLI   SUCCESS(R11BUFSV),NOTSUC UNSUCCESSFUL RECDG?    @ZA02772 93390003
         BE    EXIT1               YES, BYPASS FREE CORE       @ZA02772 93400003
         BAL   R14LINK,FREECORE    GO FREE GOTTEN CORE         @ZA02772 93410003
         LR    R1PARM,R12IOB       GET IOSB ADDR               @ZA02772 93420003
         SPACE                                                          93450002
*        EXIT TO SPECIAL XCTL ROUTINE                                   93520002
EXIT1    L     R14EXIT,CVTXTLER         LOAD ADDR OF ERR XCTL RT Y02021 93590002
         BR    R14EXIT                 BR TO SPECIAL XCTL ENTRY         93660002
         SPACE                                                          93730002
**       FREE IOSB AND RETURN TO SUPERVISOR                    @ZA02772 93800003
EXIT3    TM    IOSPKEY,IOSIDR      DIR RECORDING?              @ZA02772 93820003
         BO    EXIT4               YES, GO TO SPECIAL EXIT     @ZA02772 93840003
         BAL   R14LINK,FREECORE    GO FREE GOTTEN CORE         @ZA02772 93860003
         LR    R1PARM,R12IOB       GET IOSB ADDR               @ZA02772 93880003
         LA    R1PARM,ZERO(R1PARM) CLEAR HIGH ORDER BYTE OF RQE ADDR    93900003
         SVC   ERREXCP                  FREE IOSB                Y02021 93940002
         SVC   EXIT                    EXIT TO SUPERVISOR               94010002
         SPACE 1                                               @ZA02772 94018003
**       DIR EXIT ROUTINE                                      @ZA02772 94026003
EXIT4    EQU   *                                       @ZA26915@ZA02772 94034030
         CLI   SUCCESS(R11BUFSV),NOTSUC  UNSUCCESS?    @ZA26915@ZA02772 94039030
         BE    EXIT5                   YES-BYPSSFREEMN @ZA26915@ZA02772 94044030
         BAL   R6WORK,FREEIOSB       FREE IOSB/SRB/EWA @ZA26915@ZA02772 94049030
         BAL   R14LINK,FREECORE    GO FREE GOTTEN CORE @ZA26915@ZA02772 94054030
         SVC   EXIT                    RETURN TO SVC   @ZA26915@ZA02772 94059030
EXIT5    EQU   *                                       @ZA26915@ZA02772 94064030
         BAL   R6WORK,FREEIOSB       FREE IOSB/SRB/EWA @ZA26915@ZA02772 94069030
         SVC   EXIT                    RETURN TO SVC   @ZA26915@ZA02772 94074030
         SPACE 1                                                        94080002
MIN3670  DC    H'37'                   MINIMUM RECORD SIZE FOR 3670     94150002
HDRLEN   DC    H'24'                   BYTES IN A MDR RECORD HEADER     94220002
TPR      DC    C'TPR'                  CHARACTERS PLACED IN BUFFER      94290002
*                                       IF RECORD WAS WRITTEN           94360002
MDRINPRG DC    X'FE'                    MDR IN PROGRESS IND      Y02021 94390002
CONST4   DC    H'4'                    CONSTANT OF FOUR                 94430002
CONST7   DC    H'7'                     BUFFER COUNT ADJUST    @YM6451P 94460002
TY2314   DC    X'2008'                 2314 DEVICE CLASS AND TYPE CODE  94500002
UR3800   DC    X'080E'             ARGONAUT-3800               @Z402IVS 94520000
UR3350   DC    X'200B'             3350                        @Z40RSVS 94550004
ZEROS    DC    X'000000'               CONSTANT OF ZEROS                94570002
         SPACE                                                          94640002
*      THE FOLLOWING INSTRUCTIONS ARE EXECUTED BY EXECUTE -EX-          94710002
         SPACE                                                          94780002
MOVESENS MVC   ZERO(ZERO,R8WORK),ZERO(R5WORK)    MOVE SENSE TO RECORD   94850002
         SPACE                                                          94920002
MOVESTAT MVC   ZERO(ZERO,R8WORK),ZERO(R7WORK)    MOVE STATS TO REX03127 94990002
         SPACE                                                          95060002
CLRSTAT  XC    TWO(ZERO,R7WORK),TWO(R7WORK)  CLEAR STAT COUNTERS X03127 95130002
         SPACE                                                          95200002
MOVEBUFF MVC   RECINFO(ZERO),BUFBODY    MOVE REMAINDER OF BFR  @YM6451P 95220002
         SPACE 1                                               @YM6451P 95240002
         DS    0H                                                       95270002
DDRMOD   DC    XL2'19C9'               BINARY EQUIV OF DDR MOD NAME     95340002
EODMOD   DC    XL2'2357'               BINARY EQUIV OF EOD MOD NAME     95410002
MULTICON DC    H'10'                   LENGTH OF NORM STAT COUNTER      95480002
         SPACE 3                                                        95550002
MASK     DC    F'15'                   STAT TABLE COUNT MASK   @YM6451P 95620002
DIRJOB   DC    C'PAGE ERR'             JOB NAME FOR DIR        @YM6451P 95690002
         SPACE 1                                                        95760002
ESTALIST ESTAE MF=L                                                     95830002
PGMCKADD DC    A(OBRPGMCK)              ESTAE ENTRY POINT        Y02021 95900002
         SPACE 1                                                        95970002
         EJECT                                                          96040002
*                                                                       96110002
****   WARNING-DO NOT PUT ANY CODE BEYOND THIS POINT                    96180002
*                                                                       96250002
*                                                                       96320002
***      STAE EXIT ROUTINE TO FREE CORE                                 96390002
*                                                                       96460002
         SPACE                                                          96530002
OBRPGMCK C     R0PARM,STAETEST          TEST FOR WORK AREA       Y02021 96600002
         BE    GETREGS                  NO-USE REG 2             Y02021 96670002
         L     R2CVTBAS,ZERO(R1PARM)    GET POINTER INTO REG 2   Y02021 96740002
GETREGS  LM    R2CVTBAS,R12IOB,ZERO(R2CVTBAS)     GET REGS       Y02021 96810002
         L     R13PARM,FRECORAD         GET BRANCH ADDRESS       Y02021 96880002
         BR    R13PARM                  BRANCH TO FREE CORE      Y02021 96950002
*                                       R14 CONTAINS RETURN ADDR Y02021 97020002
FRECORAD DC    A(FREECORA)             PTR TO FREE CORE RTN    @YM6451P 97090002
STAETEST DC    A(12)                    STAE STORAGE TEST        Y02021 97160002
PTCHAREA DC    30F'0'                  PGM PATCH AREA                   97230002
PATCHEND EQU   *                                                Z40HIVS 97260003
         END                                                            97300002
