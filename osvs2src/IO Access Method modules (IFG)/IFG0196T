         TITLE 'IFG0196T/OPEN - OUTPUT TAPE HEADER LABEL PREPARATION'   00100021
IFG0196T CSECT                                                          00400021
*                                                                     * 00460002
*        VS2 SU32 DELETIONS                                             00462000
*                                                              @G32DSMI 00462832
*        VS2 RELEASE 04 CHANGES/DELETIONS                               00463632
*381957-382392,493500,493600                                   @ZA02210 00464432
*0000182000-188000                                             @ZA09620 00465232
*0000                                                          @ZA08326 00466032
*0000                                                          @ZA13576 00469037
*0000                                                          @ZA19724 00469537
*A408500,409500                                                @ZA26229 00469637
*C381957,382286                                                @ZA26229 00469937
* MODULE NAME = IFG0196T (OS/VS2)                                     * 00470002
*                                                                     * 00480002
* DESCRIPTIVE NAME = TAPE OUTPUT HEADER LABEL PROPARATION             * 00490002
*                                                                     * 00492002
* COPYRIGHT = NONE                                                    * 00494002
*                                                                     * 00496002
* STATUS = RELEASE 2, LEVEL 0                                         * 00498002
*                                                                     * 00498402
* FUNCTION =                                                          * 00498802
*        1. WAIT FOR VOLUME LABEL REWRITE INITIATED IN PREVIOUS MOD.  * 00498902
*                                                                     * 00499002
*        2. CONSTRUCT FILE LABEL 1 USING INFORMATION FROM THE JFCB    * 00499102
*        AND UCB AND WRITE IT OUT.                                    * 00499202
*                                                                     * 00499302
*        3. CONSTRUCT FILE LABEL 2 USING INFORMATION FROM THE JFCB    * 00499402
*        AND TIOT AND WRITE IT OUT. BEFORE WRITING OUT HEADER LABEL   * 00499502
*        TWO INFORMATION, CHECK FOR CHECKPOINT DATA SET.  IF IT IS    * 00499902
*        A CHECKPOINT DATA SET, TEST IF IT IS SECURE OR CAN BE MADE   * 00500302
*        SECURE.  TURN ON CHECKPOINT DATA SET AND VOLUME INDICATORS   * 00500702
*        IF THE VOLUME CAN BE MADE SECURE, OR SET THE CHECKPOINT      * 00501102
*        DATA SET INDICATOR IF IT IS ALREADY SECURE.                  * 00501202
*                                                                     * 00501502
*        1B. FOR A NO-WAIT ENTRY, IF PROTECT WAS SPECIFIED,           * 00504232
*        4. IF USER LABELS ARE TO BE PROCESSED, TRANSFER CONTROL TO   * 00504302
*        THE OUTPUT USER LABEL MODULE (IFG0196U).OTHERWISE, WRITE     * 00506302
*        TAPE MARK FOLLOWING THE HEADER LABEL.                        * 00506702
*                                                                     * 00508302
*        5. IF AN I/O ERROR OCCURS DURING THE WRITING OF THE LABELS,  * 00508702
*        AND THE DATA SET IS THE FIRST ON THE VOLUME, AN ATTEMPT TO   * 00509102
*        RECOVER IS MADE WHENEVER POSSIBLE.                           * 00513302
*                                                                     * 00518002
* NOTES = SEE BELOW                                                   * 00522202
*                                                                     * 00526402
*    DEPENDENCIES =                                                   * 00530602
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 00534802
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 00539002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 00543202
*                                                                     * 00553202
*    RESTRICTIONS = NONE                                              * 00563202
*                                                                     * 00565202
*    REGISTER CONVENTIONS =                                           * 00565602
*            R2 POINTS TO DCB                                         * 00566002
*            R4 POINTS TO OPEN WORK AREA                              * 00566402
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 00566502
*            R6 POINTS TO THE WTG TABLE                               * 00566602
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 00577702
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 00587702
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 00588102
*            R10 POINTS TO THE UCB                                    * 00588502
*                                                                     * 00588602
*    PATCH LABEL = SEE NEXT TO LAST LABEL BEFORE ORG STATEMENT AT END * 00588702
*                  OF LISTING.                                        * 00588802
*                                                                     * 00592502
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 00594502
*                                                                     * 00594902
*    PROCESSOR = ASSEMBLER XF                                         * 00595302
*                                                                     * 00595702
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 00596102
*                  ORG STATEMENT AT END OF LISTING                    * 00596202
*                                                                     * 00622102
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 00632102
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 00642102
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 00644102
*                                                                     * 00646102
* ENTRY POINT = IFG0196T FROM IFG0196Q TAPE OUTPUT DATA CHECK AND     * 00648102
*                                       REWRITE VOLUME LABEL OR       * 00652102
*                             IFG0196N TAPE OUTPUT SECURITY           * 00654102
*                                                                     * 00656702
*    PURPOSE = SEE FUNCTION                                           * 00658702
*                                                                     * 00660702
*    LINKAGE =                                                        * 00662702
*        FROM IFG0196Q:                                               * 00663102
*          LA    RET,K0  OR K4                                        * 00663502
*          IECRES LOAD,MODID=ID6Q6T,BRCODE=(14),BRANCH=QUEUED         * 00663902
*                                                                     * 00664302
*        FROM IFG0196N:                                               * 00664402
*          SR    RET,RET                                              * 00664502
*          LA    RF,ID6N6T                                            * 00664602
*          IECRES LOAD,MODID=(RF),BRCODE=(RET),BRANCH=QUEUED          * 00666402
*                                                                     * 00669102
* INPUT = TAPE POSITIONED FOR LABEL WRITING                           * 00670902
*                                                                     * 00672702
* OUTPUT = TAPE HEADER LABELS WRITTEN                                 * 00674502
*                                                                     * 00676302
* EXIT-NORMAL = IFG0196U - TAPE OUTPUT USER LABEL MODULE              * 00678102
*               IFG0194A - VOLUME/UNIT SELECTION                      * 00679902
*               IFG0194J - MESSAGE MODULE                             * 00680302
*                                                                     * 00681702
* EXIT-ERROR = NONE                                                   * 00683502
*                                                                     * 00685302
* EXTERNAL REFERENCES = SEE BELOW                                     * 00687102
*                                                                     * 00688902
*    ROUTINES = IFG019RA                                              * 00690702
*                                                                     * 00692502
*    DATA AREAS = NONE                                                * 00694302
*                                                                     * 00696102
*    CONTROL BLOCK = CVT, DCB, DSAB, JFCB, UCB                        * 00706102
*                                                                     * 00708102
* TABLES = STANDARD                                                   * 00708502
*                                                                     * 00708902
* MACROS = IECRES, MODESET, EXCP, XLATE, XCTLTABL, IECDSECS, IECEQU   * 00709302
*                                                                     * 00709702
* CHANGE ACTIVITY = NEW RELEASE (LEVEL 0)                             * 00714202
*                                                                     * 00716202
*********************************************************************** 00718202
         EJECT                                                          06700021
         SPACE 1                                                        06800021
*                   ADDRESSABILITY                                      06900021
         SPACE 1                                                        07000021
         BALR  RBASE,0                  LOAD BASE REGISTER              07100021
         USING *,RBASE                                                  07200021
*                                                                       07300021
         USING FORCORE,RCORE                                            07400021
         USING WTG,RWTG                 WHERE-TO-GO TABLE        Y02080 07450002
         USING IHADCB,RDCB                                              07500021
         USING SRT,RUCB                                                 07600021
         USING TIOENTRY,RTIOT                                           07700021
         USING CVT,RB                                                   07800021
         SPACE 1                                                        07900021
         B     OTA42900(RET)            GO TO PROPER ENTRY              08000021
OTA42900 EQU   *                        BRANCH TABLE                    08100002
         B     OTA43100                 NO WAIT ENTRY                   08200032
         B     OTA42950                 WAIT ENTRY             @G32DSMI 08210032
         B     OTA45230                 CHK PT SEC ENTRY         Y02083 08220032
*                                                              @G32DSMI 08230032
OTA42950 EQU   *                        NO WAIT ENTRY          @G32DSMI 08240032
*                                                              @G32DSMI 08250032
         BAL   RB,OTA46000              CHECK IF RACDEF NEEDED @G32DSMI 08260032
*                                                                       08300021
*        THE FOLLOWING WAIT CODE IS PART OF THE REWRITE VOLUME LABEL    08400021
*        FUNCTION. REFER TO THE PRECEEDING MODULE PROLOG FOR DETAILS.   08500021
*                                                                       08600021
OTA43000 EQU   *                        WAIT ENTRY                      08700002
         LA    RC,K15                   613-10 ABEND ON I/O ERR  YM8520 08750002
         IECRES WAIT                                                    08800021
         TM    DXECB,ECBNOERR           I/O ERROR                       08900021
         BO    OTA43100                 NO, BRANCH                      09000021
         TM    IOBSTAT0,CSWUNITX        UNIT EXCEPTION                  09100021
         BNO   OTA45900                 NO, BRANCH                      09200021
OTA43100 EQU   *                        NO WAIT ENTRY                   09300002
*                                                                     * 15800021
         NI    JFCBMASK+K4,ALLBITS-DS1WRSEC RESET SECURITY IND   YM7530 15850002
*                                                                YM7530 15900002
         ST    RCORE,DXCCW1             RESET CCW1                      17500021
         MVC   DXCCW1+4(4),ARDCCW6T     NO FLAG, 80 CHARACTERS          17600021
*                   CONSTRUCT HEADER LABEL 1                            18900021
         SPACE 1                                                        19000021
         MVC   FL1LABI(4),AHDR1P        SET IDENTIFIER TO HDR1          19100021
         SPACE 1                                                        19200021
*                                                              @ZA09620 19300037
*      DETERMINE 17 LEAST SIGNIFICANT NON-BLANK                @ZA09620 19307037
*      CHARACTERS IN DATA SET NAME IN JFCB                     @ZA09620 19314037
*                                                              @ZA09620 19321037
         LA    RD,JFCBDSNM     STARTING ADDR OF JFCB TO REG    @ZA09620 19328037
         LA    RF,JFCBDSNM+27  GET ADDR OF FIRST POSSIBLE      @ZA09620 19335037
OTA43400 EQU   *               SIGNIFICANT CHARACTER           @ZA09620 19342037
         CLI   K16(RF),BLANK   IS CHARACTER BLANK              @ZA09620 19349037
         BNE   OTA43500        NO, BRANCH                      @ZA09620 19356037
         BCT   RF,OTA43400     DECR PTR AND BR TO TEST         @ZA09620 19363037
OTA43500 EQU   *               NEXT CHAR TO LEFT               @ZA09620 19370037
         CLR   RF,RD           IS LEFT POINTER WITHIN FIELD    @ZA09620 19377037
         LA    RD,L'FL1ID(,RF) POINT TO FIRST BLANK            @ZA09620 19384037
         BNL   OTA43600        BR TO BUILD DSNAME              @ZA09620 19391037
*                                                              @ZA09620 19398037
*      PLACE DSNAME FROM JFCB INTO FILE IDENTIFICATION         @ZA09620 19405037
*                                                              @ZA09620 19412037
         MVC   FL1ID,JFCBDSNM  INSERT FIRST 17 CHARACTERS      @ZA09620 19419037
         B     OTA43700        GO SET UP GENERATION NUMBER     @ZA09620 19426037
OTA43600 EQU   *                                               @ZA09620 19433037
         MVC   FL1ID,0(RF)     USE LAST 17 LEAST SIG           @ZA09620 19440037
*                                                              @ZA09620 19447037
*                   GENERATION NUMBER AND VERSION NUMBER                19454037
*                                                              @ZA09620 19461037
         SPACE 1                                                        19468037
OTA43700 EQU *                                                 @ZA09620 19475037
         MVI   FL1GNO,BLANK             SET GEN NUMBER AND VER          19500002
         MVC   FL1GNO+1(44),FL1GNO      NUMBER OF GENERATION AND THE    19600021
*                                       REST OF THE LABEL TO BLANKS     19700021
         CLI   JFCBELNM+1,BLANK         GENERATION DATA SET             19800021
         BE    OTA43800                 NO,GO SET UP FILE SERIAL        19900021
         LA    RC,8                     LEN OF GEN&VER NUMBER  @ZA09620 20000037
         SLR   RD,RC                    POINT TO GEN NUMBER    @ZA09620 20100037
         MVC   FL1GNO,K1(RD)            MOVE IN GEN NUMBER     @ZA09620 20200037
         MVC   FL1VNG,K6(RD)            MOVE IN VERSION NUMBER @ZA09620 20300037
         SPACE 1                                                        20400021
*                   FILE SERIAL,VOLUME SEQUENCE AND FILE SEQUENCE       20500021
         SPACE 1                                                        20600021
OTA43800 MVC   FL1FILSR,UCBSQC          FILE SERIAL NUMBER              20700021
         LH    RB,JFCBVLSQ              GET VOLUME SEQUENCE NUMBER      20800021
         LTR   RB,RB                    IS IT ZERO                      20900021
         BNZ   OTA43900                 NO,GO TO CONVERT IT             21000021
         LA    RB,1(RB)                 YES,INITIALIZE IT TO ONE        21100021
OTA43900 CVD   RB,DXCCW2                CONVERT TO PACKED DECIMAL       21200021
         UNPK  FL1VOLSQ,DXCCW2          VOLUME SEQ NUMBER TO EBCDIC     21300021
         OI    FL1VOLSQ+3,ZONEOF        REMOVE SIGN BITS                21400021
         LH    RB,JFCBFLSQ              GET FILE SEQUENCE NUMBER        21500021
         CVD   RB,DXCCW2                CONVERT TO PACKED DECIMAL       21600021
         UNPK  FL1FILSQ,DXCCW2          FILE SEQUENCE NUM TO LABEL      21700021
         OI    FL1FILSQ+3,ZONEOF        REMOVE SIGN BITS                21800021
         SPACE 1                                                        21900021
*                   CREATION DATE                                       22000021
         SPACE 1                                                        22100021
         SR    RB,RB                    CLEAR WORK REGISTER             22200021
         IC    RB,JFCBCRDT              GET YEAR OF CREATION            22300021
         CVD   RB,DXCCW2                CONVERT YEAR TO DECIMAL         22400021
         UNPK  FL1CREDT+1(K2),DXCCW2    PLACE YEAR IN EBCDIC INTO       22500021
         OI    FL1CREDT+2,ZONEOF        REMOVE SIGN BITS                22600021
         IC    RB,JFCBCRDT+1            PICK UP THE TWO CHARACTERS OF   22700021
         SLA   RB,8                     THE DAY OF CREATION             22800021
         IC    RB,JFCBCRDT+2            FROM THE JFCB                   22900021
         CVD   RB,DXCCW2                CONVERT DAY TO DECIMAL          23000021
         UNPK  FL1CREDT+3(K3),DXCCW2    CREATION DAY IN EBCDIC TO       23100021
         OI    FL1CREDT+5,ZONEOF        RESET SIGN BITS                 23200021
         SPACE 1                                                        23300021
*                   EXPIRATION DATE                                     23400021
         SPACE 1                                                        23500021
         SR    RB,RB                    CLEAR WORK REGISTER             23600021
         IC    RB,JFCBXPDT              PICK UP YEAR OF EXPIRATION      23700021
         CVD   RB,DXCCW2                CONVERT YEAR TO DECIMAL         23800021
         UNPK  FL1EXPDT+1(K2),DXCCW2    PLACE YEAR IN EBCDIC INTO       23900021
         OI    FL1EXPDT+2,ZONEOF        RESET SIGN BITS                 24000021
         LH    RB,JFCBXPDT+1            PICK UP DAY OF EXPIRATION       24100021
         CVD   RB,DXCCW2                CONVERT DAY TO DECIMAL          24200021
         UNPK  FL1EXPDT+3(K3),DXCCW2    EXPIRATION DAY IN EBCDIC TO     24300021
         OI    FL1EXPDT+5,ZONEOF        RESET SIGN BITS                 24400021
         SPACE 1                                                        24500021
*                   BLOCK COUNT                                         24600021
         SPACE 1                                                        24700021
         MVI   FL1FSEC,CHAR0            RESET SECURITY INDICATOR        24800021
         MVC   FL1BLKCT(6),FL1FSEC      EBCDEC ZERO BLOCK COUNT         24900021
         SPACE 1                                                        25000021
*                   DATA SET SECURITY                                   25100021
         SPACE 1                                                        25200021
         TM    JFCBIND2,JFCBSCTY        DOES JFCB SPECIFY SECURITY      25400021
         BNO   OTA44100                 NO GO CHECK ASCII               25500021
         MVI   FL1FSEC,FL1SECTY         YES,SET DATA SET SECURITY IND   25600021
         TM    JFCBIND2,JFCBRWPW        DOES JFCB SPECIFY RWPW OPTION   25700021
         BNO   OTA44100                 NO, DO NOT SET INDICATOR        25800021
         MVI   FL1FSEC,FL1WRSEC         IND SECTY IS FOR WR ONLY        25900021
         SPACE 1                                                        26000021
*                   SYSTEM CODE AND RESERVED FIELDS                     26100021
OTA44100 EQU   *                        TEST SYSTEM CODE, RESERVED FLD  26200002
         TM    JFCBLTYP,JFCBAL          ANSI LABEL SPECIFIED            26300021
         BZ    OTA44300                 NO, GO SET SYSTEM CODE          26400021
         MVC   FL1SYSCD(K5),ANSICD      MOVE SYSTEM CODE TO LABEL       26500021
         TM    JFCBIND2,JFCBSCTY        IS SECURITY INDICATED           26600021
         BO    OTA44200                 YES, GO TRANSLATE LABEL         26700021
         MVI   FL1FSEC,BLANK            NO, SET BYTE TO BLANK           26800021
OTA44200 EQU   *                        TRANSLATE LABEL                 26900002
         BAL   RC,OTA45850              GO PERFORM TRANSLATE            27000021
         B     OTA44400                 BRANCH TO SET CHANNEL PROGRAM   27100021
         SPACE 1                                                        27200021
OTA44300 MVC   FL1SYSCD,VSSYSC          INSERT SYSTEM CODE       XM1056 27360002
*                                       INTO HEADER                     27370002
         SPACE 1                                                        27400021
*                   SET UP CHANNEL PROGRAM TO WRITE LABEL               27500021
OTA44400 EQU   *                        BUILD WRITE LABEL CHAN PROG     27600002
         SPACE 1                                                        27700021
         MVI   DXCCW1,CCWWRTAP          DITTO FOR WRITE OPERATION CODE  27800021
         MVI   DXCCW1+4,CCWSILI         SET SILI FLAG ON                27900021
         SPACE 1                                                        28000021
*                   WRITE HEADER LABEL 1                                28100021
         LA    RC,K15                   INT CODE - I/O ERROR WRITE LBL  28200021
         BAL   RB,OTA45800              GO TO PERFORM WRITE OPERATION   28300021
         BO    OTA44500                 BRANCH IF NO I/O ERROR          28400021
         TM    IOBSTAT0,CSWUNITX        UNIT EXCEPTION CAUSE ERROR      28500021
         BZ    OTA45900                 NO, BRANCH                      28600021
OTA44500 EQU   *                        NO I/O ERROR                    28700002
*                                                                       28800021
*                   SET UP TO WRITE HEADER LABEL 2                      28900021
*                                                                       29000021
         MVC   FL1LABI,AHDR1P           MOVE IN HDR                     29100021
         MVI   FL1NO,CHAR2              SET FILE LABEL IDENTIFIER TO 2  29200021
         MVI   FL2TRTCH,BLANK           SET PART OF LABEL TO            29300021
         MVC   FL2TRTCH+1(K45),FL2TRTCH  BLANKS - 47 CHARACTERS         29400021
         SPACE 1                                                        29500021
*                  BLOCKING ATTRIBUTE                                   29600021
         SPACE 1                                                        29700021
         SR    RB,RB                    CLEAR WORK REGISTER             29800021
         IC    RB,JFCRECFM              PICK UP RECORD FORMAT           29900021
         SRL   RB,3                     BITS 0,1 CONTAIN BLK ATTRIB     30000021
         STC   RB,FL2BLKA               TO PREPARE FOR TRANSLATE, ZERO  30100021
         NI    FL2BLKA,X'03'            ALL BUT BITS 0,1                30200021
         TR    FL2BLKA,ABLKA            TRANSLATE TO S, B, R OR BLANK   30300021
*                                                                       30400021
*                  RECORD FORMAT                                        30500021
*                                                                       30600021
         SRL   RB,3                     BITS 0,1 CONTAIN RECORD FORMAT  30700021
         STC   RB,FL2RECFM              F=BIT 0  V=BIT 1  U=BITS 0,1    30800021
*   DEFAULT TO RECFM = D IF NEITHER BIT IS ON                           30900021
         TR    FL2RECFM,ARECFM          TRANSLATE TO  V,F,D OR U        31000021
         SPACE 1                                                        31100021
*                   DENSITY                                             31200021
         SPACE 1                                                        31300021
         MVI   FL2DEN,K4                SET DEN=4                 99223 31350002
         CLI   JFCDEN,DCBD6250          6250 SPECIFIED            99223 31360002
         BE    OTA44550                 YES,SET ZONEBITS          99223 31370002
         IC    RB,JFCDEN                PICK UP DENSITY FROM THE JFCB   31400021
         SRL   RB,6                     BITS 0 AND 1 CONTAIN DENSITY    31500021
         STC   RB,FL2DEN                00=LOW 01=MEDIUM 02=HIGH        31600021
OTA44550 EQU   *                        SET ZONE BITS                   31650002
         OI    FL2DEN,DENSET            SET DENSITY TO EBCDIC 0,1 OR 2  31700021
         SPACE 1                                                        31800021
*                   TAPE RECORDING TECHNIQUE                            31900021
         SPACE 1                                                        32000021
         IC    RB,JFCTRTCH              PICK UP TAPE RECORDING TECH     32100021
         SRL   RB,4                     13=C ,23=E,2B=ET,3B=T,O=BLANK   32200021
         STC   RB,FL2TRTCH              PLACE FIRST CHAR OF TRTCH INTO  32300021
         TR    FL2TRTCH(1),ATRTCH       THE LABEL AS BLANK,C,E OR T     32400021
         CLI   JFCTRTCH,JFCTREV         IS IT EVEN PARITY AND TRA       32500021
         BC    6,OTA44600               NO,THE SECOND CHAR S/B BLANK    32600021
         MVI   FL2TRTCH+1,CHART         SET SECOND CHAR TO TRANSLATE    32700021
         SPACE 1                                                        32800021
*                   BLOCK SIZE AND LOGICAL RECORD LENGTH                32900021
         SPACE 1                                                        33000021
OTA44600 LH    RB,JFCBLKSI              PICK UP BLOCK LENGTH            33100021
         CVD   RB,DXCCW2                CONVERT BLOCK LENGTH TO D       33200021
         UNPK  FL2BLKL,DXCCW2           BLOCK LENGTH IN EBCDIC TO       33300021
         OI    FL2BLKL+4,ZONEOF         RESET SIGN BITS                 33400021
         LH    RB,JFCLRECL              PICK UP LOGICAL RECORD LENGTH   33500021
         CH    RB,AGRTR32K              IS LRECL INDIC GRTR 32K         33600021
         BE    OTA44700                 BR TO SET LABEL TO 9'S          33700021
         CVD   RB,DXCCW2                CONVERT TO DECIMAL              33800021
         UNPK  FL2LRECL,DXCCW2          LOGICAL RECORD LEN TO LABEL     33900021
         OI    FL2LRECL+4,ZONEOF        RESET SIGN BITS                 34000021
         B     OTA44800                 BR TO CONTINUE MERGE            34100021
OTA44700 EQU   *                        SET LRECL TO 9'S                34200002
         MVI   FL2LRECL,X'F9'           SET LRECL TO 9'S                34300021
         MVC   FL2LRECL+1(K4),FL2LRECL  INDICATING GRTR 32K             34400021
OTA44800 EQU   *                        CONTINUE MERGE                  34500002
         SPACE 1                                                        34600021
*                   FILE POSITION AND JOB/STEP IDENTIFICATION           34700021
         SPACE 1                                                        34800021
         L     RB,CVTPTR                GET CVT ADDRESS                 34900021
         L     RB,CVTTCBP-CVT(RB)       GET TCB POINTERS                35000021
         L     RB,K4(RB)                GET TCB ADDRESS                 35100021
         L     RB,TCBTIO-TCB(RB)        GET TIOT ADDRESS                35200021
         SPACE                                                          35300021
OTA44900 MVI   FL2FILP,C'0'             SET FILE POSITION TO ZERO       35400021
         MVC   FL2JOBD,TIOCNJOB-TIOT(RB)  MOVE IN JOB NAME              35500021
         MVI   FL2JSSP,SLASH            (INSERT SLASH)                  35600021
         MVC   FL2STEPD,TIOCSTEP-TIOT(RB)  MOVE IN STEP NAME            35700021
         SPACE 1                                                        35800021
*                   CARRIAGE CONTROL CHARACTER SET                      35900021
         SPACE 1                                                        36000021
         TM    JFCRECFM,JFCMAC          JFCB SPECIFY MACHINE CONTROL    36100021
         BC    12,OTA45000              NO,GO SEE IF ASA CONTROL CHAR   36200021
         MVI   FL2CNTRL,CHARM           SET MACHINE CODE CONTROL CHAR   36300021
OTA45000 TM    JFCRECFM,JFCASA          JFCB SPECIFY ASA CONTROL CHAR   36400021
         BNO   OTA45100                 NO, GO CHECK ASCII LABEL        36500021
         MVI   FL2CNTRL,CHARA           SET CONTROL CHARACTER TO ASA    36600021
         SPACE 1                                                        36700021
*                                                                       36800021
OTA45100 EQU   *                        CHECK ASII LABEL                36900002
         TM    JFCBLTYP,JFCBAL          ANSI LABLE SPECIFIED            37000021
         BZ    OTA45200                 NO, CHECK FOR T.U. ID     99223 37100002
*   GET BUFFER OFFSET LENGTH FROM JFCB AND CONVERT IT FOR LABEL 2       37200021
         MVC   DXCCW2(K1),JFCBUFOF      GET BUFFER OFFSET LENGTH        37300021
         NI    DXCCW2,X'FF'-JFCBFOFL    TURN OFF BIT ZERO               37400021
         SR    RB,RB                    ZERO OUT REGISTER               37500021
         IC    RB,DXCCW2                GET BUFFER LENGTH IN REG        37600021
         CVD   RB,DXCCW2                CONVERT TO DECIMAL              37700021
         UNPK  FL2BUFOF,DXCCW2          PLACE IN LABEL AREA             37800021
         OI    FL2BUFOF+K1,ZONEOF       RESET SIGN BITS                 37900021
         BAL   RC,OTA45850              GO PERFORM TRANSLATE            38000021
         B     OTA45210                 GO TEST FOR CHKPT        Y02083 38050002
OTA45200 EQU   *                        CHECK FOR T.U. ID               38100002
         CLI   UCBTBYT4,UCB3400         TEST FOR 3400 DRIVE      YM1491 38150002
         BNE   OTA45210                 NO, GO TEST FOR CHKPT    YM1491 38160002
         L     RC,UCBEXTPT              GET PT TO NEW UCB BLK    Y02146 38162002
         CLI   UCBSNSCT-UCBCMEXT(RC),K24 24 SENSE BYTES          Y02146 38172002
         BNE   OTA45210                 NO, GO TEST FOR CHKPT    Y02083 38180002
         L     RC,UCBXTN                LOAD UCB EXT ADDRS        99223 38190002
         USING UCBMT,RC                                           99223 38190402
         LH    RB,UCBCTD                GET TAPE UNIT ID          99223 38192002
         N     RB,SNMASK                CLEAR HI ORDER BITS    @ZA08326 38192137
         DROP  RC                                                 99223 38192637
         CVD   RB,DXCCW2                CONVERT TO DECIMAL     @ZA08326 38193137
         UNPK  FL2ID,DXCCW2             PLACE IN LABEL         @ZA13576 38193237
         OI    FL2ID+K4,ZONEOF          STRIP SIGN             @ZA13576 38193337
*********************************************************************** 38193637
* GET THE MODEL NO. CODE FROM THE SENSE INFORMATIONS AND                38195237
* PLACE THE MODEL NO. CHARACTER INTO THE SERIAL NO.                     38195637
         LA    RC,DXCCW2                GET CCW2 ADDR          @ZA26229 38195737
         MVC   DXCCW1+K4(K4),CCW6TK7    SILI FLAG,7 SNS BYTES  @ZA02210 38204637
         ST    RC,DXCCW1                PUT AREA ADDR INTO CCW @ZA02210 38208637
         MVI   DXCCW1,CCWSENSE          SNS CMD CODE INTO CCW  @ZA02210 38212637
         BAL   RB,OTA45800              GO ISSUE SENSE COMMAND @ZA02210 38222637
         LA    RC,K15                   INT CODE- I/O ERROR WRT@ZA02210 38224637
         BZ    OTA45900                 NO, GO REJECT VOLUME   @ZA02210 38226637
         IC    RC,DXCCW2+K6             GET MOD NMBR FROM SNS  @ZA26229 38228637
         SLL   RC,K28                   CLEAR REG EXCEPT FOR   @ZA13576 38229637
         SRL   RC,K28                   HALF BYTE MOD. NO.     @ZA13576 38230637
         IC    RC,CHARTBL(RC)           GET CHAR. FROM TABLE   @ZA13576 38231637
         STC   RC,FL2ID                 MOD. NO. TO LABEL      @ZA13576 38232637
*               RESET CCW TO WRITE LABEL                       @ZA13576 38234637
         ST    RCORE,DXCCW1             RESET CCW1             @ZA02210 38236837
         MVC   DXCCW1+K4(K4),ARDCCW6T   SILI FLAG, 80 CHARS    @ZA02210 38238837
         MVI   DXCCW1,CCWWRTAP          WRITE OPERATION CODE   @ZA02210 38239237
*********************************************************************** 38239637
OTA45210 EQU   *                        BEGIN TEST FOR CHKPT D/S Y02083 38240437
         L     R1,DXDSAB                ADR OF DSAB              Y02083 38246002
         USING DSAB,R1                                           Y02083 38296002
         TM    DSABFLG4,DSABCKDS        THIS A CHK PT DATA SET   Y02083 38346002
         BNO   OTA45260                 NO                       Y02083 38396002
         TM    DSABFLG4,DSABCKVL        VOL ALREADY SECURE       Y02083 38446002
         BO    OTA45245                 YES                      Y02083 38496002
*********************************************************************** 38498002
*        ASK THE OPERATOR IF THE VOLUME CAN BE MADE SECURE            * 38498402
*********************************************************************** 38498802
OTA45220 EQU   *                        INSTR MUST FOLLOW        Y02083 38499202
         MVC   DXRETMOD,ID6T6T          SET RTN NAME & ADDRESS   Y02083 38499602
         MVI   DXRETCOD,K8              SET BR TAB RETURN VALUE  Y02083 38499702
         XC    DXWORK1,DXWORK1          ZERO REPLY(WTOR) AREA    Y02083 38499802
         LA    R1,DXWORK1               POINT TO REPLY AREA      Y02083 38499902
         LA    R0,K3                    SET REPLY LENGTH         Y02083 38533202
         SLL   R0,K24                   IN HI ORDER BYTE         Y02083 38543202
         OR    R1,R0                    SET UP WTOR PARM         Y02083 38553202
         IECRES LOAD,MODID=ID6T4J,BRCODE=K52,BRANCH=QUEUED       Y02083 38563202
*********************************************************************** 38565202
*              TEST HIS REPLY                                         * 38565602
*********************************************************************** 38566002
OTA45230 EQU   *                        INSTR MUST FOLLOW        Y02083 38566402
         IECRES WAIT                    WAIT FOR REPLY           Y02083 38566502
         L     R1,DXDSAB                DSAB ADR                 Y02083 38566602
         OC    DXWORK1(K3),BLANKS       FOLD REPLY TO UPPER CASE Y02083 38577702
         CLC   KYES,DXWORK1             REPLY YES                Y02083 38587702
         BE    OTA45240                 YES                      Y02083 38588102
         CLC   KNO,DXWORK1              REPLY NO                 Y02083 38588502
         BE    OTA45250                 YES                      Y02083 38588602
         B     OTA45220                 NEITHER ISSUE MSG AGAIN  Y02083 38588702
*********************************************************************** 38588802
*              UPDATE DSAB INDICATORS                                 * 38592502
*********************************************************************** 38594502
OTA45240 EQU   *                        INSTR MUST FOLLOW        Y02083 38594902
         MODESET EXTKEY=SCHED                                    Y02083 38595302
         OI    DSABFLG4,DSABCKVL        SET DSAB SECURE VOL IND  Y02083 38595702
         MODESET EXTKEY=DATAMGT                                  Y02083 38596102
OTA45245 EQU   *                        FLAG CHKPT D/S           Y02083 38597402
         MVI   FL2DSIND,FL2CKDS         SET CHK PT IND IN LABEL  Y02083 38600002
         B     OTA45260                 WRITE HDR 2 LABEL        Y02083 38622102
OTA45250 EQU   *                        INSTR MUST FOLLOW        Y02083 38632102
         MODESET EXTKEY=SCHED                                    Y02083 38642102
         NI    DSABFLG4,X'FF'-DSABCKDS  RESET CK PT DATA SET IND Y02083 38644102
         MODESET EXTKEY=DATAMGT                                  Y02083 38646102
         DROP  R1                                                Y02083 38648102
         SPACE 1                                                        38650202
*                                                                       38656702
*                   WRITE HEADER LABEL 2                                38658702
*                                                                       38659102
         SPACE 1                                                        38660702
OTA45260 EQU   *                        INSTR MUST FOLLOW        Y02083 38662702
         LA    RC,K15                   INT CODE - I/O ERROR WRITE LBL  38665502
         BAL   RB,OTA45800              GO WRITE FILE LABEL 2           38674102
         BO    OTA45300                 BRANCH IF NO ERROR              38700021
         TM    IOBSTAT0,CSWUNITX        IS ERROR UNIT EXCEPTION         38800021
         BZ    OTA45900                 NO, GO REJECT VOLUME            38900021
*                                                                       39000021
* BYPASS USER LABEL PROCESSING IF SYSOUT TAPE                           39100021
*                                                                       39200021
OTA45300 EQU   *                        BYPASS USER LABEL IF SYSOUT     39300002
         SPACE                                                          39600021
*                   SEE IF USER LABELS ARE TO BE PROCESSED              39700021
         SPACE                                                          39800021
         TM    JFCBLTYP,JFCBUL          WAS USER LABELS SPECIFIED       39900021
         BNO   OTA45400                 NO, DO NOT PROCESS USER LABELS  40000021
*                                                                Y02134 40050002
         IECRES LOAD,MODID=ID6T6U,BRCODE=K0,BRANCH=QUEUED        Y02134 40100002
         EJECT                                                          40300002
*                   WRITE TAPE MARK FOLLOWING HEADER LABELS             40400021
         SPACE 1                                                        40500021
OTA45400 EQU   *                        WRITE TAPE MARK                 40600002
         MVI   DXCCW1,CCWWTM            SET UP CCW TO WRITE TAPE MARK   40700021
         MVI   DXCCW1+4,CCWSILI+CCWCMDCH  CHAIN A NOP                   40800021
         MVC   DXCCW2,DXCCW1            INSURE A VALID CCW     @ZA26229 40850037
         MVI   DXCCW2,CCWNOP            SET CCW FOR NOP                 40900021
         MVI   DXCCW2+K4,K0             INSURE NO CHAINING     @ZA26229 40950037
         LA    RC,K16                   INT CODE - I/O ERROR WRITE TM   41000021
         BAL   RB,OTA45800              GO TO WRITE TAPE MARK           41100021
         BO    OTA45500                 BRANCH IF NO ERROR              41200021
         TM    IOBSTAT0,CSWUNITX        IS ERROR UNIT EXCEPTION         41300021
         BZ    OTA45900                 NO, GO REJECT VOLUME            41400021
OTA45500 EQU   *                        NO ERROR WRITING TAPE MARK      41500002
         OI    DXATOUTA,DXATHDTM        TM WRITTEN AFTER HDR LBL Y02144 41550002
*                                                                YM8526 41560002
         CLC   JFCBFLSQ,ONE6T           CHECK FILE SEQ ONE       YM8526 41570002
         BH    OTA45600                 BRANCH IF GT ONE         YM8526 41580002
*                                                                Y02134 41600002
         MVC   DXRETMOD,ID6T6V          SET UP RETURN LOAD       Y02134 41650002
         MVI   DXRETCOD,K8              SET UP RETURN OFFSET     Y02134 41700002
*                                                                Y02134 42200002
         IECRES LOAD,MODID=ID6T4J,BRCODE=K48,BRANCH=QUEUED       Y02134 42250002
*                                                                YM8526 42260002
OTA45600 IECRES LOAD,MODID=ID6T6V,BRCODE=K8,BRANCH=QUEUED        YM8526 42270002
         EJECT                                                          42500002
*                                                                       42700021
         SPACE                                                          42800021
*                   CLOSED SUBROUTINE TO ISSUE I/O OPERATIONS           42900021
         SPACE 1                                                        43000021
*                        IT IS ASSUMED THAT ALL CONTROL BLOCKS          43100021
*                        HAVE ALREADY BEEN SET UP                       43200021
         SPACE 1                                                        43300021
*                             BAL  RA,PRHR50                            43400021
*                             RETURN                                    43500021
         SPACE 1                                                        43600021
OTA45800 EQU   *                        I/O SUBROUTINE                  43700002
         EXCP  DXIOB                    ISSUE I/O OPERATION             43800021
         IECRES WAIT                                                    43900021
         TM    DXECB,ECBNOERR           IS THERE AN UNUSUAL CONDITION   44000021
         BR    RB                       RETRN TO CALLER                 44100021
         EJECT                                                          44200002
*    TRANSLATE LABEL DATA BEFORE WRITING                                44300021
OTA45850 EQU   *                        TRANSLATE LABEL ROUTINE         44400002
         XLATE DXLBL,K80,TO=A                                           44500021
         BR    RC                       RETURN TO CALLER                44600021
         EJECT                                                          44700002
OTA45900 EQU   *                        ASK FOR NEW VOLUME              45200021
         NI    DCBIFLGS,X'FF'-DCBIFPIO  TURN OFF ERROR FLAGS IN         45300021
*                                       DCB TO ISSUE REWIND             45400021
*                                       AND/OR UNLOAD COMMAND           45500021
*                                                                Y02134 45550002
         LR    R0,RC                    LOAD ERROR CODE          Y02134 45560002
*                                                                Y02134 45570002
         MVC   DXCALLID,ID6T6T          SETUP ERROR ID           YM7530 45580002
         MVC   DXRETMOD,ID6T6N          SET UP RETURN LOAD       Y02134 45600002
         MVI   DXRETCOD,K0              SET UP RETURN OFFSET     Y02134 45650002
*                                                                Y02134 45700002
         IECRES LOAD,MODID=ID6T4A,BRCODE=K16,BRANCH=QUEUED       Y02134 45750002
         EJECT                                                 @G32DSMI 45850032
*                                                              @G32DSMI 45900032
***************************************************************@G32DSMI 45950032
*                                                              @G32DSMI 46000032
*        ISSUE RACDEF DEFINE IF THE VOLUME IS ELIGIBLE TO BE   @G32DSMI 46050032
*        UPDATED TO RACF OR NEWLY DEFINED TO RACF.             @G32DSMI 46100032
*                                                              @G32DSMI 46150032
***************************************************************@G32DSMI 46200032
*                                                              @G32DSMI 46250032
OTA46000 EQU   *                        CHK IF RACDEF NEEDED   @G32DSMI 46300032
*                                                              @G32DSMI 46350032
         TM    JFCFLGS1,JFCBPROT        CHK FOR AUTOMATIC RACF @G32DSMI*46400032
                                        DATA SET PROTECTION    @G32DSMI 46450032
         BZR   RB                       RETURN IF NOT          @G32DSMI 46500032
*                                                              @G32DSMI 46550032
OTA46100 EQU   *                        ISSUE RACDEF           @G32DSMI 46600032
         MVC   DXCCW5(RACDLNTH),RACDLIST  MOVE IN RACDEF LIST  @G32DSMI 46650032
*                                                              @G32DSMI 46700032
         RACDEF ENTITY=UCBVOLI,MF=(E,DXCCW5) ISSUE RACDEF      @G32DSMI 46750032
*                                                              @G32DSMI 46800032
         LTR   RF,RF                    TEST IF SUCCESSFUL     @G32DSMI 46850032
         BNZ   OTA46300                 BRANCH IF NOT          @G32DSMI 46900032
         NI    JFCFLGS1,X'FF'-JFCBPROT  TURN OFF PROTECT       @G32DSMI 46950032
         L     RC,DXDEBXAD              ADDRESS OF DEB EXTN    @G32DSMI 47000032
         USING DEBXTN,RC                                       @G32DSMI 47050032
         OI    DEBXFLG1,DEBXDSSI        TURN ON RACF INDICATOR @G32DSMI 47100032
         DROP  RC                                              @G32DSMI 47150032
*                                                              @G32DSMI 47200032
OTA46200 EQU   *                        RETURN                 @G32DSMI 47250032
*                                                              @G32DSMI 47300032
         BR    RB                       RETURN                 @G32DSMI 47350032
*                                                              @G32DSMI 47400032
OTA46300 EQU   *                        ISSUE DMABCOND         @G32DSMI 47450032
*                                                                       47500032
         LA    R0,OABD245               CAUSE 913-44 ABEND     @G32DSMI 47550032
         LA    RC,K4                    NOT DEFINED RETURN CODE@G32DSMI 47600032
         CR    RF,RC                    RETURN CODE = 4        @G32DSMI 47650032
         BE    OTA46400                 YES                    @G32DSMI 47700032
         LA    R0,OABD248               CAUSE 913-4C ABEND     @G32DSMI 47750032
*                                                              @G32DSMI 47800032
OTA46400 EQU   *                        ISSUE DMABCOND         @G32DSMI 47850032
         DMABCOND (R0),ID6T0P           ABEND                  @G32DSMI 47900032
         EJECT                                                          48300002
*                   CONSTANTS                                           48800021
         SPACE 1                                                        48900021
         DS    0H                                                       49000021
RACDLIST RACDEF TYPE=DEFINE,CLASS='TAPEVOL',MF=L  RACDEF       @G32DSMI 49003032
RACDLNTH EQU   *-RACDLIST               LENGTH OF PARM LIST    @G32DSMI 49006032
ONE6T    DC    H'1'                     HALFWORD CONSTANT ONE    YM8526 49010002
AGRTR32K DC    X'8000'                  VALUE IN LABEL WHEN LRECLGT     49100021
ARDCCW6T DC    X'20000050'              SILI FLAG, 80 CHARACTERS        49200021
AHDR1P   DC    C'HDR1'                                                  49300021
CCW6TK7  DC    X'20000007'              CCW LENGTH CONSTANT    @ZA02210 49350037
         DS    0F                                              @ZA08326 49360037
SNMASK   DC    X'0000FFFF'              SER NUMBER MASK        @ZA08326 49370037
CHARTBL  DC    C'0003570000046800'      CHARACTER TABLE        @ZA19724 49380037
         DS    0F                                                       49390037
ANSICD   DC    C'OS360'                 ANSI SYSTEM CODE                49400021
ARECFM   EQU   *                        RECFM TRANSLATE TABLE           49500021
OABD248  EQU   248                      CAUSE 913-4C ABEND     @G32DSMI 49530032
OABD245  EQU   245                      CAUSE 913-44 ABEND     @G32DSMI 49560032
*                                  TYPE D ADDED FOR ASCII               49600021
         DC    C'DVFU'                  DEC,VARIABLE,FIXED,UNKNOWN      49700021
ATRTCH   DC    C' CET'                  BLANK,CONVERSION,EVEN PAR       49800021
ABLKA    DC    C' SBR'                  BLK ATTRB TRANSLATE TABLE       49900021
VSSYSC   DC    C'IBM OS/VS 370'         VS SYSTEM CODE           XM1056 50560002
BLANKS   DC    C'   '                   3 BLANK CHARS            Y02083 50570002
KYES     DC    C'YES'                   YES REPLY MASK           Y02083 50572002
KNO      DC    C'NO '                   NO REPLY MASK            Y02083 50574002
         EJECT                                                          50576002
*                                                                Y02083 50576402
*              EQUATES                                           Y02083 50578002
*                                                                Y02083 50578102
         SPACE 1                                                        50578402
FL2CKDS  EQU   C'C'                     FL2DSIND CHK PT IND      Y02083 50578802
         EJECT                                                          50580002
XCTL6T   XCTLTABL ID=(ID6T6N,6N,ID6T6V,6V,ID6T4A,4A,ID6T4J,4J,   Y02134X50700002
               ID6T0P,0P,                                      @G32DSMI*50720032
               ID6T6T,6T,ID6T6U,6U),BRT=YES,LENGTH=              Y02083 50750002
         IECDSECS CVT,TCB,TIOT,DCB,UCB,MAIN,WTG,DSAB,            Y02083*50850032
               JSCB,RACVT,IEZDEB,                              @Z40RSDS*53850032
               EXPAND=YES                                      @Z40RSDS 56850032
         IECEQU IEZDEB=YES                                              59850032
         END                                                            62850032
