         TITLE 'IFG0196W/OPEN - ACCESS METHOD EXECUTOR RETURN FUNCTION,X00100000
               JFCB TO DSCB MERGE'                                      00150000
         COPY  LCGASMSW                                                 00460000
IFG0196W CSECT                                                          00500021
         ENTRY IGG0190S                                          Y02080 00550002
IGG0190S EQU   IFG0196W                 ALLIAS ENTRY POINT       Y02080 00560002
*********************************************************************** 00570002
*                                                                     * 00580002
*                                                                     * 00582000
*        VS2 RELEASE 03 DELETIONS/CHANGES                             * 00584000
*0000161108,163200-163950                                       Y30ASJC 00586000
*C000364000,A00036710-367070                                   @ZA10215 00587037
*C000                                                          @ZA13601 00587537
*A37920-37990                                                  @ZA32721 00587737
*                                                                     * 00588000
* MODULE NAME = IFG0196W (OS/VS2)                                     * 00590002
*                                                                     * 00592002
* DESCRIPTIVE NAME = ACCESS METHOD EXECUTOR RETURN FUNCTION, JFCB TO  * 00594002
*                    DSCB MERGE                                       * 00594802
*                                                                     * 00596002
* COPYRIGHT = NONE                                                    * 00598002
*                                                                     * 00598402
* STATUS = RELEASE 2, LEVEL 0                                         * 00598802
*                                                                     * 00599202
* FUNCTION =                                                          * 00599602
*        1. OPEN ACCESS METHOD RETURN FUNCTIONS:                      * 00599702
*           A. RESTORE THE WTG TABLE ENTRIES FOR USE BY IFG019RA      * 00601702
*           THE ACCESS METHOD EXECUTORS ZEROED THE IDTTR'S.           * 00603702
*                                                                     * 00603802
*           B. VALIDITY CHECK THE DEB.                                * 00604702
*                                                                     * 00606702
*        2. RESUME PARALLEL PROCESSING WITH RESIDENT ROUTINE.         * 00607102
*                                                                     * 00607202
*        3. TEST IF CHECK POINT DATA SET INDICATOR IN THE DSAB IS ON. * 00607402
*        IF IT IS, TURN ON THE SWITCH IN THE DSCB AND SET THE DSCB    * 00607802
*        MODIFIED SWITCH ON.                                          * 00608202
*                                                                     * 00608602
*        4. MERGE JFCB FIELDS TO THE DSCB.                            * 00609002
*                                                                     * 00609602
*        5. IF THE DSCB HAS BEEN MODIFIED, WRITE BACK THE DSCB TO THE * 00611602
*        VTOC.                                                        * 00611702
*                                                                     * 00612002
* NOTES = SEE BELOW                                                   * 00612602
*                                                                     * 00613202
*    DEPENDENCIES =                                                   * 00613802
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 00614402
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 00615002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 00615902
*                                                                     * 00617902
*    RESTRICTIONS = NONE                                              * 00618302
*                                                                     * 00618702
*    REGISTER CONVENTIONS =                                           * 00619102
*            R2 POINTS TO DCB                                         * 00619502
*            R4 POINTS TO OPEN WORK AREA                              * 00619602
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 00619802
*            R6 POINTS TO THE WTG TABLE                               * 00619902
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 00629802
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 00631802
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 00633802
*            R10 POINTS TO THE UCB                                    * 00635802
*                                                                     * 00637802
*    PATCH LABEL = SEE NEXT TO LAST LABEL BEFORE ORG STATEMENT AT END * 00638202
*                  OF LISTING.                                        * 00638602
*                                                                     * 00639002
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 00639402
*                                                                     * 00639502
*    PROCESSOR = ASSEMBLER XF                                         * 00639602
*                                                                     * 00639702
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 00649702
*                  ORG STATEMENT AT END OF LISTING                    * 00651702
*                                                                     * 00653702
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 00655702
*                  PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY, * 00657702
*                  LINK PACK AREA RESIDENT/PAGEABLE                   * 00658102
*                                                                     * 00658502
* ENTRY POINT =                                                       * 00658902
*        IFG0196W OR IGG0190S                                         * 00659002
*                                                                     * 00659302
*    PURPOSE = SEE FUNCTION                                           * 00659402
*                                                                     * 00659502
*    LINKAGE =                                                        * 00659602
*        FROM IGG0193K:                                               * 00661702
*           LA   REG15,WTGPREFX(,RWTG)                                * 00663702
*           L    15,0(,15)                                            * 00665702
*           STM  0,14,IECREGSV-IECPREFX(15)                           * 00667702
*           MVC  WTGMODNM+6(2,6),0(RWTGC)                             * 00668102
*           MVC  WTGMODEP+1(3,6),2(RWTGC)                             * 00668502
*           LA   6,WTGMNODNM(,6)                                      * 00668902
*           L    5,CVTPTR(0,0)                                        * 00669302
*           L    5,CVTDMSR-CVT(,5)                                    * 00669402
*           B    20(,5)                                               * 00669502
*                                                                     * 00669602
* INPUT =                                                             * 00671602
*        JFCB IN MAIN WORK AREA.                                      * 00672002
*        FORMAT 1 DSCB IN MAIN WORK AREA.                             * 00672402
*                                                                     * 00673602
* OUTPUT =                                                            * 00675602
*        REINITIALIZED WTG ENTRIES                                    * 00676002
*        UPDATED FORMAT 1 DSCB IN VTOC.                               * 00676402
*                                                                     * 00677602
* EXIT-NORMAL =                                                       * 00678002
*        IFG0196X                                                     * 00678102
*        IFG0198N                                                     * 00678202
*                                                                     * 00678402
* EXIT-ERROR = NONE                                                   * 00678802
*                                                                     * 00679202
* EXTERNAL REFERENCES = SEE BELOW                                     * 00679302
*                                                                     * 00679402
*    ROUTINES = NONE                                                  * 00679502
*                                                                     * 00686302
*    DATA AREAS = STANDARD                                            * 00688302
*                                                                     * 00690302
*    CONTROL BLOCK = STANDARD                                         * 00692302
*                                                                     * 00692702
* TABLES = STANDARD                                                   * 00693102
*                                                                     * 00695402
* MACROS = IECEQU, IECRES, IECDSECS, MODESET, DEBCHK, EXCP, XCTLTABL  * 00697402
*                                                                     * 00697502
* CHANGE ACTIVITY = NEW RELEASE (LEVEL 0)                             * 00697602
*                                                                     * 00698402
*********************************************************************** 00698802
         EJECT                                                          11600021
         IECDSECS CVT,TCB,TIOT,UCB,DCB,ACB,MAIN,WTG,DSAB,        Y02134*11700002
               IEZDEB,PREFX,RRPL                                 Y02144 11702002
TIOTSPOL EQU   X'06'                                                    12040000
         IECEQU AOS=YES,IEZDEB=YES                               Y02134 12070002
*********************************************************************** 12088002
*                                                                     * 12098002
*    OPEN AM RETURN FUNCTIONS:                                        * 12098402
*                                                                     * 12098802
*    RESTORE THE WTG TABLE ENTRIES FOR USE BY THE IFG019RA            * 12099202
*    RESIDENT ROUTINE, SINCE THE ACCESS METHOD EXECUTORS ZEROED       * 12099602
*    THE IDTTR'S WHEN THEY WERE THROUGH PROCESSING.                   * 12099702
*    DEB VALIDITY CHECKING IS ACCOMPLISHED VIA A DEB VALIDITY CHECK   * 12099802
*    ROUTINE.                                                         * 12099902
*                                                                     * 12109902
*    REGISTERS 9-14,0-1 ARE RESTORED IN CASE A PARALLEL OPEN DCB IS   * 12111902
*    GOING TO A DEFERED ABEND AND DID NOT GO THROUGH THE EXECUTORS,   * 12113902
*    IN WHICH CASE THEY ARE SIGNIFICANT, ALTHOUGH NOT USED FOR        * 12115902
*    PROCESSING.                                                      * 12117902
*                                                                     * 12118302
*********************************************************************** 12118702
*                                                                       12119902
         USING IHADCB,RDCB              DEFINE BASE TO USER'S DCB       12200021
         USING FORCORE,RCORE            DEFINE BASE TO MAIN WORK AREA   12300021
         USING WTG,RWTG                 DEFINE BASE TO WTG TABLE        12400021
         USING TIOENTRY,RTIOT           DEFINE BASE TO TIOT DD ENTRY    12500021
         USING UCBOB,RUCB               DEFINE BASE TO MAIN UCB         12600021
         USING DEBBASIC,RDEB            DEFINE BASE TO DEB       Y02134 12700002
*                                                                       12800021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         12900021
         USING *,RBASE                  DEFINE BASE REGISTER            13000021
*                                                                       13100021
         CLI   WTGMODNM+K1,C'G'         IS ENTRY FROM IGG019XX EXECUTOR 13200021
         BE    OFN00400                 BR IF YES TO INITIALIZE         13300021
*                                                                       13400021
OFN00100 B     OFN00200(RET)            BR TO INDICATED FUNCTION        13500021
*                                                                       13600021
OFN00200 B     OFN10000                 RET=0 CONTINUE NORMAL OPEN      13700021
         B     OFN23600                 RET=4 NO LONGER OPENING         13800021
*                                                                       13900021
*********************************************************************** 14000021
*                                                                       14100021
*  REINITIALIZE WHERE-TO-GO TABLE ENTRY IDTTR'S AND REGISTERS AFTER     14200021
*  RECEIVING CONTROL FROM IGG019XX ACCESS METHOD EXECUTOR MODULES.      14300021
*                                                                       14400021
OFN00400 EQU   *                        ACCESS METHOD RETURN ENTRY      14500002
         L     RC,WTGPREFX              GET PTR TO WTG PREFIX    Y02144 14550002
         L     RC,IECRRPRM-IECPREFX(,RC) GET RRPLIST PTR         Y02144 14560002
         OI    RRFLAGS1-RRPLIST(RC),RRFAMEXR SHOW A.M. EXECUTOR  Y02144 14580002
*                                       RETURNED CONTROL         Y02144 14590002
         IECRES LOAD,MODNM=THISMOD,PREFIX=WTGPREFX,BRANCH=NO     Y02080*14640002
                                        GIVE OPT TRACE A SHOT    Y02080 14690002
         XC    WTGMODEP,WTGMODEP        CLEAR NEXT MOD ADDR      Y02080 14692002
         LR    RPARC,RPAR               POINT TO FIRST ENTRY IN LIST    14700021
         LA    RWTGC,WTGENTRY           POINT TO FIRST WTG TABLE ENTRY  14800021
         USING WTGENTRY,RWTGC           DEFINE BASE TO CURRENT WTG      14900021
*                                                                       15000021
OFN00600 EQU   *                        PROCESS DCB                     15100002
         L     RCORE,WTGCORE-K1         LOAD CURRENT WORK AREA ADDR     15200021
         LA    RCORE,0(RCORE)           CLEAR HIGH ORDER BYTE           15300021
         LTR   RCORE,RCORE              TEST IF DCB HAS WORK AREA       15400021
         BZ    OFN01000                 BR IF NO TO PROCESS NEXT DCB    15500021
         MVC   WTGIDTTR,ID6W6W          SET ID TTR TO CURRENT ID YM1342 15502002
         MVI   DXRESIND,K0              SET INDICATOR TO XCTL    YM1342 15504002
         LA    RET,K4                   DEFAULT BR INDEX VALUE   YM1342 15506002
         ST    RET,DXREGE               SAVE FOR LOAD BY 19RA    YM1342 15508002
         L     RDCB,PLISTDCB(,RPARC)    LOAD CURRENT DCB ADDR   YM01212 15510002
         TM    DCBOFLGS,DCBOBUSY        IS COPIED DCB BUSY?      Y02080 15550002
         BZ    OFN01000                 NO, DO NOT USE USERS     Y02080*15560002
                                        DCBOFLGS                 Y02080 15570002
*                                                                       15600021
*                                                                       15900021
         L     RDCB,DXUDCBAD            GET PTR TO USER'S DCB    Y02082 16010002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER'S KEY      Y02082 16020002
         OC    DCBOFLGS,DCBOFLGS        TOUCH THE USER'S MEMORY  Y02082 16040002
         LA    R0,ALLBITS-DCBOBUSY      SET MASK FOR BUSY BIT    YM3005 16040402
         IC    R1,DCBOFLGS              GET USER'S DCBOFLGS      Y02082 16042002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 16046002
         OR    R0,R1                    COMBINE COPIED DCBOFLGS  YM3005 16046102
         L     RDCB,DXPDCBAD            WITH USER'S DCBOFLGS     YM3005 16046402
         IC    R0,DCBOFLGS              MAKING COPIED BUSY BIT   YM3005 16046802
         NR    R1,R0                    SAME AS USER'S BUSY BIT  YM3005 16048402
         STC   R1,DCBOFLGS              UPDATE DCBOFLGS IN COPY  Y02082 16049602
         TM    DCBOFLGS,DCBOLOCK+DCBOBUSY IS DCB BEING OPENED?   YM1342 16051602
         BNO   OFN01000                 BRANCH IF NOT            YM1342 16053602
*                                                                Y02004 16104902
* TEST FOR ACB                                                   Y02004 16105002
*                                                                Y02004 16105102
         TM    DCBMACRF,DCBMEXCP        IS ACCESS METHOD EXCP    Y02004 16105202
         BO    OFN00640                 YES, CANNOT BE AN ACB    Y02004 16105602
         TM    DCBDSRG2,ACBDORGA        IS CONTROL BLOCK AN ACB? Y02004 16105702
         BZ    OFN00640                 BRANCH IF NOT ACB       Y30ASJC 16110800
         CLI   ACBAMETH-IFGACB(RACB),ACBVTAM IF VTAM, NO DEBCHK Y30ASJC 16112800
         BE    OFN01000                 REG 14 SET TO 4         Y30ASJC 16113200
         B     OFN00670                 DEBCHK ACB              Y30ASJC 16113600
*                                                                       16114002
* TEST FOR SPOOLED DCB                                                  16115602
*                                                                       16117202
OFN00640 EQU   *                        TEST FOR SPOOLED DCB     Y02004 16118802
         L     RTIOT,DXTIOTAD           RESET TIOT ENTRY ADDR    Y02134 16120402
*                                                                       16126000
         TM    TIOELINK,TIOTSPOL        SPOOLED DATA SET?        Y02120 16176802
         BZ    OFN00670                 BRANCH IF NO             Y02120 16178802
*                                                                       16184802
*        SPOOLED DCB'S DEB'S DEBDCBAD POINTS TO ACB SO NO DEBCHK Y02120 16185002
*        CAN BE DONE ON DCB - DEBECBAD POINTS TO SUBSYSTEM ACB   Y02120 16185202
*        DEBCHK THE ACB POINTED TO BY DEBECBAD                   Y02120 16185702
*                                                                       16192602
         L     RDEB,DCBDEBAD            GET DEB                  Y02120 16198602
         L     RET,DEBDCBAD             LOAD CI ACB FOR DEBCHK   Y02120 16200602
         DEBCHK (RET),AM=SUBSYS         DEBCHK THE CI ACB'S DEB  Y02120 16208602
         LA    R1,K0(R1)                CLEAR HIGH BYTE OF DEBAD Y02120 16212502
         LA    RDEB,K0(RDEB)            CLEAR HIGH BYTE OF DEBAD Y02120 16222502
         CR    RDEB,R1                  ARE DEBS EQUAL?          Y02120 16222902
         BNE   OFN00670                 BR IF NO TO FORCE DEBCHK Y02120 16223102
         XR    RET,RET                  BRANCH OFFSET            YM1342 16223502
         ST    RET,DXREGE               STORE BRANCH OFFSET      Y02120 16223602
         LA    RET,K8                   GET DEB EXT OFFSET       YM3051 16225602
         SR    R1,RET                   POINT TO DEB EXTN ADDR   Y02134 16226302
         MVC   DXDEBXAD+K1(K3),K1(R1)   DEB EXT ADDR TO WKAREA   Y02134 16228302
         B     OFN01000                 BRANCH TO CHECK NEXT DCB Y02120 16229102
OFN00670 EQU   *                        FORCE DEBCHK             Y01021 16231802
         L     R1,DXUDCBAD              POINT TO USER'S DCB      Y02082 16255002
         DEBCHK (R1)                    VALIDATE DEB             Y02082 16255402
         STCM  R1,B'0111',DCBDEBAD+K1   STORE VERIFIED DEBAD     Y02134 16266002
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 16276002
         MODESET KEYADDR=DXUKEY,WORKREG=13 ASSUME USER KEY       Y02082 16281602
* REPEAT DCB FIELD CHANGES                                       Y02082 16283802
         STCM  R1,B'0111',DCBDEBAD+K1   STORE VERIFIED DEBAD     Y02082 16286002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 16288202
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 16290402
*                                                                       16297002
*        SET A BRANCH INDEX VALUE OF 0 FOR RE-ENTRY INTO THIS    YM1342 16297402
*        MODULE IF A DCB OR NON-VTAM ACB IS BEING OPENED.        YM1342 16298602
*                                                                       16310002
         XR    RET,RET                  DCB STILL BEING OPEN     Y02134 16400002
         ST    RET,DXREGE               SET FOR LOAD BY IFG019RA YM1342 16500002
*                                                                       16502002
*        CHAIN DEB EXTENSION FOR ALL DCB/ACBS WHICH ARE STILL    Y02134 16504002
*        BEING PROCESSED (LOCK & BUSY BITS ON) OR WHICH HAVE THE Y02134 16506002
*        OPEN BIT ON BUT ARE NOT BEING PROCESSED AND FOR WHICH   Y02134 16508002
*        THE DEB EXTENSION HAS NOT ALREADY BEEN CHAINED.         Y02134 16508402
*        THIS IS NOT DONE FOR A SPOOLED DCB.                     Y02134 16508802
*                                                                       16510002
OFN00900 L     RDEB,DCBDEBAD            GET DEB ADDRESS          Y02134 16520002
         LA    RD,DEBBASIC              CLEAR HI BYTE OF DEB ADD Y02134 16522002
         LA    RC,DEBBASIC-DEBXTNP      OFFSET BACK TO DEBX PTR  Y02134 16524002
         SR    RD,RC                    RD POINTS TO DEBX PTR    Y02134 16526002
         USING DEBXTNP,RD                                        Y02134 16528002
         CLC   DEBXTNP,DXDEBXAD         IS DEBX ALREADY CHAINED? Y02134 16530002
         BE    OFN00950                 BRANCH IF YES            Y02134 16532002
         L     RC,DXDEBXAD              LOAD DEBX ADDR           Y02134 16534002
         USING DEBXTN,RC                DEB EXTENSION USING      Y02134 16536002
         ST    RC,DEBXTNP               PUT DEBX PTR IN DEB      Y02134 16538002
         LA    RDEB,DEBBASIC            CLEAR HI BYTE OF RDEB    Y02134 16540002
         ST    RDEB,DEBXDBPR            PUT DEB ADDR IN DEBX     Y02134 16542002
         DROP  RC,RD                                             Y02134 16544002
OFN00950 EQU   *                        DEBX ALREADY CHAINED            16546002
         OI    DEBFLGS1,DEBXTNIN        TURN ON DEB EXTENSION    Y02134 16548002
*                                       BIT                      Y02134 16550002
*                                                                       16600021
OFN01000 EQU   *                        ACB FPR VTAM                    16700002
         TM    PLISTOPT(RPARC),LASTNTRY  CHECK FOR LAST DCB ENTRY       16800021
         BO    OFN01200                 BR IF YES                       16900021
         LA    RPARC,K4(,RPARC)         ADVANCE TO NEXT DCB ENTRY       17000021
         LA    RWTGC,L'WTGENTRY(RWTGC)  ADVANCE TO NEXT WTG ENTRY       17100021
         B     OFN00600                 BR TO PROCESS NEXT DCB          17200021
*                                                                       17300021
*********************************************************************** 17400021
*                                                                       17500021
*  LOCATE A DCB TO START PARALLEL PROCESSING.                           17600021
*                                                                       17700021
OFN01200 EQU   *                                                        17800021
         LA    RWTGC,WTGENTRY-WTG(,RWTG)  POINT TO FIRST ENTRY IN WTG   17900021
         LR    RPARC,RPAR               POINT TO FIRST DCB IN PARM LIST 18000021
         L     RES,CVTPTR               GET CVT ADDR                    18100021
         L     RES,CVTDMSR-CVT(,RES)    LOAD ADDR IFG019RA ROUTINE      18200021
*                                                                       18300021
OFN01400 EQU   *                        FIND AN ACTIVE DCB              18400002
         CLC   WTGIDTTR(K2),ID6W6W      IS DCB ACTIVE IN THIS MODULE    18500002
         BE    OFN01600                 BR IF YES                       18600021
*                                                                       18700021
         LA    RPARC,K4(RPARC)          ADVANCE TO NEXT PARM DCB ADDR   18800021
         LA    RWTGC,L'WTGENTRY(RWTGC)  ADVANCE TO NEXT WTG ENTRY       18900021
         B     OFN01400                 BR TO FIND ACTIVE DCB           19000021
*                                                                       19100021
OFN01600 EQU   *                        ACTIVE DCB                      19200002
         L     RDCB,PLISTDCB(,RPARC)    LOAD CURRENT DCB ADDR           19300021
         L     RCORE,WTGCORE-K1         LOAD CURRENT WORK AREA ADDR     19400021
*                                                                       19500021
         DROP  RWTGC                                             Y02080 19600002
*                                                                       19700021
         LM    RTIOT,RET,DXREG9         RESTORE REGISTERS 9-14          19800021
         LM    R0,R1,DXREG0             RESTORE REGISTERS 0-1           19900021
*                                                                       20000021
         B     OFN00100                 BR TO USE BRANCH TABLE          20100021
*                                                                       20200021
*********************************************************************** 20300021
*                                                                       20400021
*  PARALLEL PROCESSING BY THE RESIDENT ROUTINE RESUMES HERE.            20500021
*                                                                       20600021
*********************************************************************** 20700021
*                                                                       20800021
*  SAVE DCB MODIFICATION MASK IN DEB                                    20900021
*                                                                       21000021
OFN10000 EQU   *                                                        21100021
         L     RDEB,DCBDEBAD            GET DEB ADDRESS          Y02134 21134002
         L     RF,DXDEBXAD              GET DEB EXTENSION ADDRESSY02134 21150002
         USING DEBXTN,RF                USING ON DEBX ADDR       Y02134 21152002
         OC    DEBXDCBM,JFCBMASK        MOVE DCB MASK TO DEBX    Y02134 21154002
         BZ    OFN10200                 BR IF NO MASK BITS SET          21600021
         OI    DEBOFLGS,DEBDCB          SET DCB MOD BIT IN DEB   Y02134 21700002
         XC    JFCBMASK(K4),JFCBMASK    CLEAR DCB MERGE MASK IN JFCB    21800021
OFN10200 EQU   *                        NO MASK BITS SET                21900002
*                                                                       22100021
         TM    JFCBMASK+K4,JFCMPSWD     DID DATA SET REQ A PASSWORD     22200021
         BZ    OFN10400                 BRANCH IF NO                    22300021
         OI    DEBFLGS1,DEBPWCKD        IND PASSWORD HAS BEEN CHECKED   22400021
         NI    JFCBMASK+K4,X'FF'-JFCMPSWD  CLEAR JFCB PW REQ SWITCH     22500021
OFN10400 EQU   *                        DATA SET DID NOT REQ A PASSWORD 22600002
*                                                                       22700021
*********************************************************************** 22800021
*                                                                       22900021
         L     RTIOT,DXTIOTAD           REESTABLISH TIOT ADDR    Y02134 23430002
         TM    TIOELINK,TIOTSPOL        SPOOLED DATA SET?        Y02120 23452002
         BM    OFN23000                 BRANCH IF YES            Y02120 23454002
*                                                                       23500021
         LA    RET,K4                   LOAD ENTRY CODE FOR NULL DS     23600021
         TM    JFCBMASK+K4,JFCMNULL     CHECK FOR NULL DATA SET         23700021
         BO    OFN23200                 BR IF YES                       23800021
*                                                                       23900021
         L     RUCB,DXUCBADR            LOAD FIRST UCB ADDR      Y02082 24000002
*                                                                       24100021
         TM    UCBTBYT3,UCB3DACC        IS DEVICE DIRECT ACCESS         24400021
         BZ    OFN23000                 BR IF NO                        24500021
*                                                                       24600021
*********************************************************************** 24700021
*                                                                       24800021
         EJECT                                                          24900021
*********************************************************************** 25000021
*                                                                     * 25100021
*    OPEN FINAL JFCB TO DSCB MERGE FUNCTIONS:                         * 25700002
*                                                                     * 25800021
*    MERGES JFCB FIELDS TO THE DSCB.                                  * 26300021
*    IF THE DSCB HAS BEEN MODIFIED BY THIS MERGE OR BY ANY OTHER      * 26400021
*    FUNCTION, WRITES THE DSCB BACK TO THE VTOC.                      * 26500002
*                                                                     * 26600021
*********************************************************************** 32200021
*                                                                       32400021
*********************************************************************** 32500021
*                                                                       32600021
*  PROCESSING FOR DIRECT ACCESS ONLY.                                   32700021
*                                                                       32800021
OFN20000 EQU   *                                                        32900021
         CLI   DSCFMTID,C'1'            CHECK FOR FORMAT 1 DSCB         33000021
         BNE   OFN23000                 BR IF NO, (FMT 4 DSCB)          33100021
*                                                                       33200021
         TM    JFCBIND1,JFCRLSE         CHECK FOR PARTIAL RELEASE       33300021
         BZ    OFN20200                 BR IF NO                        33400021
         OI    DEBOFLGS,DEBOFRLS        SET PARTIAL RELEASE BIT IN DEB  33500021
*                                                                       33600021
OFN20200 EQU   *                        NOT A PARTIAL RELEASE           33700002
         L     RF,DXDSAB                CURRENT DSAB ADR         Y02083 33750002
         USING DSAB,RF                                           Y02083 33760002
         TM    DSABFLG4,DSABCKDS        CHK PT DS IND ON IN DSAB Y02083 33770002
         BNO   OFN20210                 NO                       Y02083 33780002
         OI    DSCDSIND,K1              SET IND ON IN DSCB       Y02083 33790002
         OI    JFCBMASK+K4,JFCMDMOD     SET DSCB MOD SW ON       Y02083 33792002
         DROP  RF                                                Y02083 33792402
OFN20210 EQU   *                        NO CHK PT DS IND IN DSAB Y02083 33794002
         TM    0(RPARC),PLISTUPD        OUTPUT, OUTIN, UPDATE    A50703 33800021
         BNO   OFN22000                 BR IF NO, NO MERGE FOR INPUT    33900021
*                                                                       34000021
*********************************************************************** 34100021
*                                                                       34200021
*        JFCB TO DSCB MERGE                                             34300021
*                                                                       34400021
* MERGE IS PERFORMED FOR OUTPUT AND OUTIN, ONLY, WITH THE        A50703 34450021
* FOLLOWING EXCEPTIONS-                                          A50703 34500021
*    - PERFORMED FOR UPDAT IF BOTH THE DSCB AND DCB DSORG'S      A50703 34550021
*      ARE DA (BDAM FOR UPDAT)                                   A50703 34600021
*    - NOT PERFORMED FOR ISAM (DCB DSORG=IS) UNLESS LOAD MODE    A48584 34650021
*      IS SPECIFIED (IE, LOAD MODE IS THE INDICATION OF OUTPUT   A48584 34700021
*      FOR ISAM, SINCE OPEN OPTIONS ARE IGNORED FOR ISAM)        A48584 34750021
*                                                                       34900021
* MERGE OPTCD ONLY IF DSORG IN DSCB AND DCB ARE BOTH DA OR BOTH   M0943 35050021
* NOT DA.  IF ONE IS DA AND THE OTHER IS NOT, THE DATA SET IS     M0943 35060021
* BEING ACCESSED DIFFERENTLY THAN AT CREATION, AND OPTCD BIT      M0943 35070021
* MEANINGS MAY CONFLICT.  PARTICULARLY, BDAM OPTCD A AND SAM      M0943 35080021
* OPTCD Q ARE THE SAME BIT.                                       M0943 35090021
         TM    DCBMACRF,DCBMEXCP        EXCP                      M0943 35090421
         BZ    OFN20300                 NO, BR, DSORG PRESENT    A50703 35090821
         TM    0(RPARC),PLISTOP1-PLISTUPD  UPDATE                A50703 35091221
         BZ    OFN22000                 YES, BR, SKIP MERGE      A50703 35091621
         TM    DCBMACRF,DCBMFOUN        IS DSORG FIELD PRESENT   A50703 35091921
         BZ    OFN20600                 NO, BR, SKIP OPTCD MERGE A50703 35092221
OFN20300 EQU   *                        DSOG PRESENT             A50703 35092502
         TM    DCBDSORG,DCBORGDA        DCB DSORG DA             A50703 35092821
         BNO   OFN20350                 NO, BR                   A50703 35093121
         TM    DSCFILTY,DCBORGDA        DSCB DSORG DA            A50703 35093421
         BO    OFN20500                 YES, BR, MERGE OPTCD TOO A50703 35093721
         TM    0(RPARC),PLISTOP1-PLISTUPD  UPDATE                A50703 35094021
         BZ    OFN22000                 YES, BR, SKIP MERGE      A50703 35094321
         B     OFN20600                 NO, BR, SKIP OPTCD MERGE A50703 35094621
OFN20350 EQU   *                        DCB DSORG NOT DA         A50703 35094902
         TM    0(RPARC),PLISTOP1-PLISTUPD  UPDATE                A50703 35095221
         BZ    OFN22000                 YES, BR, SKIP MERGE      A50703 35095521
         TM    DCBDSORG,DCBORGIS        DCB DSORG IS (ISAM)      A48584 35095821
         BNO   OFN20400                 NO, BR                   A48584 35096121
         TM    DCBMACRF,DCBMEXCP        EXCP                     A48584 35096421
         BO    OFN22000                 YES, BR, SKIP MERGE      A48584 35096721
*                                       NO, LOAD MODE TEST VALID A48584 35097021
         TM    DCBMACRF+1,DCBMPMOV+DCBMLOC  ISAM LOAD MODE       A48584 35097321
         BZ    OFN22000                 NO, BR, SKIP MERGE       A48584 35097621
         B     OFN20500                 YES, MERGE OPTCD TOO     A48584 35097921
OFN20400 EQU   *                        DCB DSORG NOT ISAM       A50703 35098202
         TM    DSCFILTY,DCBORGDA        DSCB DSORG DA            A50703 35098521
         BO    OFN20600                 YES, BR, NO OPTCD MERGE  A50703 35098821
*                                       NO, MERGE OPTCD TOO      A50703 35099121
*                                                                A50703 35099421
OFN20500 EQU   *                        MERGE OPTCD TOO           M0943 35099802
         CLC   DSCOPTCD,JFCOPTCD        COMPARE OPTION CODE FIELDS      35100021
         BE    OFN20600                 BR IF EQUAL                     35200021
         MVC   DSCOPTCD,JFCOPTCD        ****MERGE****                   35300021
         OI    JFCBMASK+K4,JFCMDMOD     SET DSCB MOD SW ON              35400021
*                                                                       35500021
OFN20600 EQU   *                        OPTION CODE FIELDS EQUAL        35600002
         CLC   DSCRECFM,JFCRECFM        COMPARE RECFM FIELDS     A50703 35610021
         BE    OFN20700                 BR IF EQUAL              A50703 35620021
         MVC   DSCRECFM,JFCRECFM        ****MERGE****            A50703 35630021
         OI    JFCBMASK+K4,JFCMDMOD     SET DSCB MOD SW ON       A50703 35640021
*                                                                A50703 35650021
OFN20700 EQU   *                        RECFM FIELDS EQUAL       A50703 35660002
         CLC   DSCKEYL,JFCKEYLE         COMPARE KEY LENGTH FIELDS       35700021
         BE    OFN20800                 BR IF EQUAL                     35800021
         MVC   DSCKEYL,JFCKEYLE         ****MERGE****                   35900021
         OI    JFCBMASK+K4,JFCMDMOD     SET DSCB MOD SW ON              36000021
*                                                                       36100021
OFN20800 EQU   *                        KEY LENGTH FIELDS EQUAL         36200002
         NC    DSCFILTY,DSCFILTY        CHECK FOR ZERO DSCB DSORG       36300021
         BNZ   OFN20900                 BR IF NO               @ZA10215 36400037
         MVC   DSCFILTY,JFCDSORG        ***MERGE****                    36420037
         OI    JFCBMASK+K4,JFCMDMOD     SET DSCB MOD SW ON              36440037
*                                                                       36460037
OFN20900 EQU   *                                               @ZA10215 36480037
         TM    DCBDSORG,DCBORGPS+DCBORGUM  DCB PSU SPECIFIED   @ZA10215 36500037
         BNO   OFN21000                 NO,BR                  @ZA10215 36520037
         TM    JFCDSORG,JFCORGPO+JFCORGPS JFCB PS OR PO SPEC.  @ZA13601 36540037
         BZ    OFN21000                 NO,BR                  @ZA13601 36560037
         OI    DSCFILTY,DS1ORGUN        SET DSCB UNMOVABLE     @ZA10215 36580037
         OI    JFCBMASK+4,JFCMDMOD      SET DSCB MOD SW ON     @ZA10215 36600037
*                                                                       36700021
OFN21000 EQU   *                        COMPARE BLOCK SIZE FIELDS       36800002
         CLC   DSCBLKL,JFCBLKSI         COMPARE BLOCK SIZE FIELDS       36900021
         BE    OFN21200                 BR IF EQUAL                     37000021
         MVC   DSCBLKL,JFCBLKSI         ***MERGE***                     37100021
         OI    JFCBMASK+K4,JFCMDMOD     SET DSCB MOD SW ON              37200021
*                                                                       37300021
OFN21200 EQU   *                        COMPARE RECORD LENGTH FIELDS    37400002
         CLC   DSCLRECL,JFCLRECL        COMPARE RECORD LENGTH FIELDS    37500021
         BE    OFN21300                 BR IF EQUAL                     37600037
         MVC   DSCLRECL,JFCLRECL        ****MERGE****                   37700021
         OI    JFCBMASK+K4,JFCMDMOD     SET DSCB MOD SW ON              37800021
*                                                                       37900021
OFN21300 EQU   *                        CHK FOR PROTECTION IN JFCB      37910037
         TM    JFCBIND2,JFCSECUR        PROTECT?               @ZA32721 37920037
         BNO   OFN21400                 NO                     @ZA32721 37930037
         OI    DSCDSIND,DS1SECTY        INDICATE PROTECT       @ZA32721 37940037
         NI    DSCDSIND,X'FF'-DS1WRSEC  NOPWREAD=OFF           @ZA32721 37950037
         TM    JFCBIND2,JFCBRWPW        NOPWREAD?              @ZA32721 37960037
         BNO   OFN21310                 NO                     @ZA32721 37970037
         OI    DSCDSIND,DS1WRSEC        MODIFY DSCB1           @ZA32721 37980037
OFN21310 OI    JFCBMASK+K4,JFCMDMOD     SET DSCB MOD SW ON     @ZA32721 37990037
OFN21400 EQU   *                        CKECK KEY POSITION FOR ISAM     38000002
         CLC   DSCRKP,JFCRKP            COMPARE KEY POSITION FOR ISAM   38100021
         BE    OFN22000                 BR IF EQUAL                     38200002
         MVC   DSCRKP,JFCRKP            ****MERGE****                   38300021
         OI    JFCBMASK+K4,JFCMDMOD     SET DSCB MOD SW ON              38400021
*                                                                       38500021
*********************************************************************** 39700021
*                                                                       39800021
*        WRITE BACK DSCB IF MODIFIED                                    39900021
*                                                                       40000021
OFN22000 EQU   *                                                        40100021
         TM    JFCBMASK+K4,JFCMDMOD     IS DSCB MODIFIED SW ON          40200021
         BZ    OFN23000                 BR IF OFF                       40300021
         TM    UCBJBNR,UCBVRDEV         TEST FOR VIO UCB         Y02132 40305002
         BNO   OFN22200                 BR IF NOT                Y02132 40310002
*        WRITE FORMAT 1 DSCB TO SWA FOR VIO                      Y02132 40315002
         MODESET EXTKEY=SCHED           ASSUME SCHEDULER KEY     Y02132 40320002
*                                                                Y02132 40325002
         MVC   VDSDSCB-VDSUCB+L'JFCBDSNM(DSCEXT2-DSCFMTID,RUCB),DXDSCB  40330002
*                                                                Y02132 40335002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02132 40340002
*                                                                Y02132 40345002
         MVI   DXECB,ECBCOD7F           INDICATE NO ERROR - 196X Y02132 40350002
         B     OFN22450                 CONTINUE PROCESSING      Y02132 40355002
OFN22200 EQU   *                        NOT VIO UCB              Y02132 40360002
*                                                                       40400021
*        CONSTRUCT CHANNEL PROGRAM TO WRITE BACK DSCB                   40500021
*                                                                       40600021
*        SEARCH ID EQ                                                   40700021
*        TIC *-8                                                        40800021
*        SEARCH KEY EQ                                                  40900021
*        NOP  (NO CHAIN, SLI)                                           41000021
*        WRITE DATA  (DSCB)  (NO CHAIN , 96 BYTES)                      41100002
*                                                                       41500021
         XC    DXCCW1(K40),DXCCW1       CLEAR CCW AREA                  41600002
         LA    RF,DXDAADDR+K3           SEARCH ADDRESS                  41700021
         ST    RF,DXCCW1                INTO SEARCH ID EQ CCW           41800021
         LA    RF,DXCCW1                TIC *-8                         42000021
         ST    RF,DXCCW2                INTO FIRST TIC                  42100021
         LA    RF,JFCBDSNM              DSNAME KEY ADDRESS              42200021
         ST    RF,DXCCW3                INTO SEARCH KEY EQ CCW          42300021
         LA    RF,DXDSCB                DSCB ADDRESS                    42400021
         ST    RF,DXCCW5                INTO WRITE CCW                  42500021
         OC    DXCCW1(K40),OFN2800K     OR IN CMND, FLAGS, LENGTH       42900002
*                                                                       43000021
*        REINITIALIZE WORK DEB EXTENT FOR THIS FIRST VOLUME             43100021
*                                                                       43200021
         MVI   DXDEBBIN+K1,K0           CLEAR BIN NUMBER                43300021
*                                                                       43400021
         LA    RUCB,0(RUCB)             SET MODE TO ZERO                44900021
         ST    RUCB,DXDEBUCB            PUT MAIN UCB ADDR IN DEB        45000021
*                                                                       45100021
         XC    DXDEBSCC(K4),DXDEBSCC    SET START EXTENT TO COVER DISK  45200021
*                                                                       45300021
         L     RF,CVTPTR                GET CVT ADDR                    45400021
         L     RF,CVTZDTAB-CVT(,RF)     GET ADDR I/O DEVICE TABLE       45500021
         SR    R1,R1                    CLEAR REG FOR IC                45600021
         IC    R1,UCBTBYT4              GET UCB DEVICE TYPE             45700021
         IC    R1,0(R1,RF)              INDEX TO DEVICE OFFSET BYTE     45800021
         AR    RF,R1                    ADDR OF DEVICE ENTRY IN TABLE   45900021
         MVC   DXDEBECC(K4),0(RF)       SET MAX EXTENT FROM DEVICE TBL  46000021
*                                                                       46100021
         MVC   DXDEBNTR,OFN2820K        SET TRACKS TO LARGEST NUMBER    46200021
*                                                                       46300021
         LA    RF,K16                   BACK UP RDEB TO POINT           46400021
         SR    RDEB,RF                  TO PREFIX SECTION FOR           46500021
         MVC   DXDAADDR+K1(K7),K1(RDEB)  DSCB BBCCHHR DISK ADDR         46600021
         MVI   DXDAADDR,K0              SET M TO ZERO                   46700021
         AR    RDEB,RF                  RESTORE DEB POINTER             46800021
*                                                                       46900021
*        START DSCB WRITE BACK                                          47000021
*                                                                       47100021
         EXCP  DXIOB                    START DSCB WRITE BACK           47200021
*                                                                       47300021
OFN22450 EQU   *                        CONTINUE                 Y02132 47305002
         STM   RTIOT,RUCB,DXWORK1       SAVE REGS 9-10                  47400021
         LM    RTIOT,RUCB,DXCCW8        LOAD REGS 9-10 FROM DXCCW8      47500021
*                                       SO THAT XCTL AND WAIT WILL      47600021
*                                       NOT DESTROY DXCCW8 WHEN THE     47700021
*                                       RESIDENT ROUTINE SAVES THE      47800021
*                                       REGISTERS.                      47900021
         LA    RET,K0                   LOAD BRANCH TABLE OFFSET        48000021
         B     OFN23400                 BR TO XCTL TO MODULE IFG0196X   48100021
*                                                                       48200021
*********************************************************************** 48300021
*                                                                       48400021
OFN23000 EQU   *                        OUTLIMITS                       48500002
         LA    RET,K0                   LOAD ENTRY CODE FOR OUTLIM      48600021
*                                                                       48700021
OFN23200 EQU   *                        NULL DATA SET                   48800002
         NI    JFCBMASK+K4,X'FF'-JFCMDMOD  TURN OFF ANY DSCB MOD SW     48900021
*                                                                       49000021
OFN23400 EQU   *                        GO TO NEXT MODULE               49100002
*                                   XCTL TO IFGO196X TO CONTINUE Y02080 49130002
         IECRES LOAD,MODID=ID6W6X,BRCODE=(RET),BRANCH=QUEUED     Y02080 49250002
*                                                                       49300021
*********************************************************************** 49400021
*                                                                       49500021
OFN23600 EQU   *                        NO LONGER OPENING ENTRY         49600002
*                                                                YM1342 49610002
* TEST FOR VTAM ACB                                              YM1342 49620002
*                                                                YM1342 49630002
         TM    DCBMACRF,DCBMEXCP        IS ACCESS METHOD EXCP    YM1342 49640002
         BO    OFN23700                 YES, CANNOT BE AN ACB    YM1342 49650002
         TM    DCBDSRG2,ACBDORGA        IS CONTROL BLOCK AN ACB? YM1342 49660002
         BZ    OFN23700                 BRANCH IF NO             YM1342 49670002
         USING IFGACB,RACB              ADDRESS ACB              YM1342 49680002
         CLI   ACBAMETH,ACBVTAM         IS THIS ACB FOR VTAM?    YM3011 49690002
         BNE   OFN23700                 NO, EXIT TO IFG0198N     YM1342 49700002
         USING IHADCB,RDCB              RESTORE DCB ADDRESSING   YM1342 49710002
         LA    RET,K8                   LOAD ENTRY FOR LAST MOD  YM1342 49712002
OFN23700 EQU   *                        GO TO TERMINATE MOD      YM1342 49720002
         IECRES LOAD,MODID=ID6W8N,BRCODE=(RET),BRANCH=QUEUED     Y02080 49750002
*                                  XCTL TO LAST MOD TO TERMINATE Y02080 49760002
*                                                                       49800021
         DROP  RDEB                                                     49900021
*                                                                       50000021
*********************************************************************** 50100021
*                                                                       50200021
*        CONSTANTS                                                      50300021
*                                                                       50400021
*        CCW'S TO WRITE BACK DSCB                                       50500021
OFN2800K DC    X'3100000040000005'      SEARCH ID EQ                    50600021
         DC    X'0800000000000000'      TIC *-8                         50700021
         DC    X'290000004000002C'      SEARCH ID EQ                    50800021
         DC    X'0300000020000001'      NOP  (NO CHAIN, SLI)            50900021
         DC    X'0500000000000060'      WRITE DATA (NO CHAIN, 96)       51000002
*                                                                       51400021
OFN2820K DC    X'7FFF'                  MAX NO. OF TRACKS IN EXTENT     51500021
*                                                                       51600021
OFN2840K DC    C'IFG0196W'              FULL NAME OF THIS MODULE        51700021
*                                                                       51800021
         XCTLTABL ID=(ID6W6W,6W,ID6W6X,6X,ID6W8N,8N,             Y02080X51930002
               THISMOD,IFG0196W),                                Y02080X51932002
               BRT=YES,LENGTH=                                   Y02080 51940002
*                                                                       52000021
         IDDVDSCB                                                       52005002
         IECDSECS EXPAND=YES            EXPAND DESIRED DSECTS HERE      52100021
*                                                                       52200021
         END                                                            52300021
