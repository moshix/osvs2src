         TITLE 'IFG0196X/OPEN - LOAD EXCP APPENDAGES, WRITE BACK JFCB'  00100021
IFG0196X CSECT                                                          00400021
*********************************************************************** 00500002
*                                                                     * 00600002
*        VS2 RELEASE 999 DELETIONS/CHANGES                            * 00650003
*0000                                                          @ZA02876 00656003
*0000717100                                                    @ZA07588 00662003
*                                                                     * 00670003
* MODULE NAME = IFG0196X (OS/VS2)                                     * 00700002
*                                                                     * 00800002
* DESCRIPTIVE NAME = LOAD EXCP APPENDAGES, WRITE BACK JFCB            * 00900002
*                                                                     * 01000002
* COPYRIGHT = NONE                                                    * 01100002
*                                                                     * 01200002
* STATUS = RELEASE 2, LEVEL 0                                         * 01300002
*                                                                     * 01400002
* FUNCTION =                                                          * 01500002
*        1. WAIT FOR DSCB WRITE-BACK TO COMPLETE WHICH WAS INITIATED  * 01600002
*        IN IFG0196W IF DSCB WAS  MODIFIED.                           * 01700002
*                                                                     * 01800002
*        2. FOR MAGNETIC TAPE, IF REDUCED ERROR RECOVERY (RER) WAS    * 01900002
*        REQUESTED, INFORM CALLER VIA WTP AND INDICATE RER IN DEB.    * 02000002
*                                                                     * 02100002
*        3. IF DCB IS EXCP WITH APPENDAGES AND THE CALLER IS AUTHO-   * 02200002
*        RIZED, LOAD THE APPENDAGES AND STORE THEIR ADDRESSES IN THE  * 02300002
*        DEB APPENDAGE VECTOR TABLE FOR THE DCB.                      * 02400002
*                                                                     * 02500002
*        4. RESTORE THE OPEN PARAMETER LIST DCB "OPEN OPTION" FOR     * 02600002
*        DCB'S STILL BEING OPENED.                                    * 02700002
*                                                                     * 02800002
*        5. INITIATE CHANNEL PROGRAM TO WRITE BACK THE JFCB SO THAT   * 02900002
*        IT  WILL BE AVAILABLE FOR WRITING TRAILER LABELS DURING      * 03000002
*        EOV OR WHEN THE DATA SET IS REOPENED.                        * 03100002
*                                                                     * 03200002
* NOTES = SEE BELOW                                                   * 03300002
*                                                                     * 03400002
*    DEPENDENCIES =                                                   * 03500002
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 03600002
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 03700002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 03800002
*                                                                     * 03900002
*    RESTRICTIONS = NONE                                              * 04000002
*                                                                     * 04100002
*    REGISTER CONVENTIONS =                                           * 04200002
*            R2 POINTS TO DCB                                         * 04300002
*            R4 POINTS TO OPEN WORK AREA                              * 04400002
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 04500002
*            R6 POINTS TO THE WTG TABLE                               * 04600002
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 04700002
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 04800002
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 04900002
*            R10 POINTS TO THE UCB                                    * 05000002
*                                                                     * 05100002
*    PATCH LABEL = SEE THIRD LABEL BEFORE ORG STATEMENT AT END        * 05200002
*                  OF LISTING.                                        * 05300002
*                                                                     * 05400002
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 05500002
*                                                                     * 05600002
*    PROCESSOR = ASSEMBLER XF                                         * 05700002
*                                                                     * 05800002
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 05900002
*                  ORG STATEMENT AT END OF LISTING                    * 06000002
*                                                                     * 06100002
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 06200002
*                  PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY, * 06300002
*                  LINK PACK AREA RESIDENT/PAGEABLE                   * 06400002
*                                                                     * 06500002
* ENTRY POINT = IFG0196X                                              * 06600002
*                  R14 = 0 DSCB WAIT FUNCTION                         * 06700002
*                  R14 = 4 WRITE BACK JFCB FUNCTION                   * 06800002
*                                                                     * 06900002
*    PURPOSE = SEE FUNCTION                                           * 07000002
*                                                                     * 07100002
*    LINKAGE =                                                        * 07200002
*        LA  RET,K0                                                   * 07300002
*        IECRES LOAD,MODID=ID6W6X,BRCODE=(RET),BRANCH=QUEUED          * 07400002
*                                                                     * 07500002
* INPUT = REGISTERS AND WORK AREA                                     * 07600002
*                                                                     * 07700002
* OUTPUT =                                                            * 07800002
*        EXCP APPENDAGES LOADED AND AVT FILLED IF DCB IS EXCP WITH    * 07900002
*        APPENDAGES AND CALLER IS AUTHORIZED.                         * 08000002
*                                                                     * 08100002
*        JFCB WRITTEN BACK.                                           * 08200002
*                                                                     * 08300002
* EXIT-NORMAL = IFG0198N - CONTINUE OPENING DCB                       * 08400002
*                                                                     * 08500002
* EXIT-ERROR = IFG0190P ABEND PROCESSING                              * 08600002
*                INTERNAL CODE:                                       * 08700002
*                  31 - I/O ERROR WRITING BACK F1 DSCB                * 08800002
*                  228 - INVALID APPENDAGE ID                         * 08900002
*                                                                     * 09000002
* EXTERNAL REFERENCES = SEE BELOW                                     * 09100002
*                                                                     * 09200002
*    ROUTINES = NONE                                                  * 09300002
*                                                                     * 09400002
*    DATA AREAS = NONE                                                * 09500002
*                                                                     * 09600002
*    CONTROL BLOCK = NONE                                             * 09700002
*                                                                     * 09800002
* TABLES = NONE                                                       * 09900002
*                                                                     * 10000002
* MACROS =                                                            * 10100002
*        IECRES, DMABCOND,MODESET, TESTAUTH, LOAD, XCTABL, IECDSECS   * 10200002
*                                                                     * 10300002
* CHANGE ACTIVITY = NEW RELEASE (LEVEL 0)                             * 10400002
*                                                                     * 10400204
*        CHANGE ACTIVITY VS2 RELEASE 041                       @Z40JSGD 10401004
*0000                                                          @Z40JSGD 10402004
*0000715100                                                    @VS42097 10402200
*                                                                     * 10500002
*********************************************************************** 10600002
          EJECT                                                         10700002
         IECDSECS CVT,TCB,TIOT,SMFTCT,RRPL, DEFINE DSECTS TO BE. YM7835*11700002
               UCB,MAIN,WTG,PREFX,APP,ACB,IEZDEB               @Z40JSGD 11800004
PGFXFLG  EQU   X'02'                    USER PGFX APPENDAGE INDR YM2877 11810002
         IECEQU AOS=YES,IEZDEB=YES                             @Z40JSGD 11850004
*                                                                       12100021
         USING IHADCB,RDCB              DEFINE BASE TO USER'S DCB       12200021
         USING FORCORE,RCORE            DEFINE BASE TO MAIN WORK AREA   12300021
         USING WTG,RWTG                 DEFINE BASE TO WTG TABLE        12400021
         USING TIOENTRY,RTIOT           DEFINE BASE TO TIOT DD ENTRY    12500021
         USING UCBOB,RUCB               DEFINE BASE TO MAIN UCB         12600021
         USING DEBBASIC,RDEB            DEFINE BASE TO DEB     @Z40JSGD 12700004
*                                                                       12800021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         12900021
         USING *,RBASE                  DEFINE BASE REGISTER            13000021
*                                                                       13100021
         B     OFN30200(RET)            BR TO INDICATED FUNCTION        13200021
*                                                                       13300021
OFN30200 B     OFN30400                 RET=0 DSCB WAIT          XM5603 13302000
         B     OFN50000                 RET=4 NULL DATA SET OR WRITE   X13500002
                                        BACK JFCB                       13500802
*********************************************************************** 20900021
*                                                                     * 21000021
*        DSCB WAIT FUNCTION                                           * 21050002
*                                                                     * 21198802
*       IF I/O ERROR WRITING BACK THE DSCB, XCTL TO IFG0190P WITH     * 21199202
*       OPEN INTERNAL ABEND CODE 031 TO GIVE A 213-18 ABEND.          * 21199602
*                                                                     * 21199702
*********************************************************************** 21300021
*                                                                     * 21400021
OFN30400 EQU   *                        DSCB WAIT FUNCTION       XM5603 28502002
         L     RTIOT,DXTIOTAD           GET CURRENT TIOT ENTRY   Y02080 28504002
         TM    DCBMACRF,DCBMEXCP        IS THIS AN EXCP DCB      XM5603 28508500
         BO    OFN30450                 YES, CAN'T BE SPOOLED    XM5603 28508602
         TM    DCBDSORG+K1,ACBDORGA     IS THIS A SPOOLED ACB OR XM5603 28509600
*                                       JAM ACB                  XM5603 28509800
         BO    OFN50000                 YES,GO WRITE BACK JFCB   XM5603 28510002
*                                                                       28510402
         TM    TIOELINK,TIOESYIN+TIOESYOT  SPOOLED DATA SET?     Y02120 28510802
         BM    OFN50000                 BRANCH IF YES            Y02120 28533102
*                                                                       28600021
*********************************************************************** 28700021
*                                                                       28800021
*        WAIT FOR ANY DSCB WRITE BACK TO COMPLETE                       28900021
*        (WRITE WAS INITIATED IN PREVIOUS MODULE IFG0196W)              29000002
*                                                                       29100021
OFN30450 EQU   *                        DSCB WAIT CONTINUED      XM5603 29150002
         TM    JFCBMASK+K4,JFCMDMOD     IS DSCB MODIFIED SW ON          29200021
         BZ    OFN40000                 NO GO TO EXCP APPEND FUNCTION   29300002
         L     RUCB,DXUCBADR            GET CURRENT UCB ADDR     YM3875 29310002
         TM    UCBJBNR,UCBVRDEV         VIO UCB?                 YM3875 29350002
         BO    OFN32400                 YES, CONTINUE            YM3875 29360002
*                                                                       29400021
         IECRES WAIT                    WAIT FOR WRITE TO COMPLETE      29500021
*                                                                       29600021
         TM    DXECB,ECBCOD7F           CHECK FOR I/O ERROR             29700021
         BNO   OFN32200                 BR IF YES                       29800021
*                                                                       29900021
         LA    RF,DXCCW5                TEST IF CHANNEL PROGRAM         30000021
         L     R1,IOBCOMAD              TERMINATED AFTER NOP CCW        30100021
         LA    R1,0(R1)                 BY EXAMINING CSW STORED         30200021
         CR    R1,RF                    IN IOB                          30300021
         BNE   OFN32400                 BR IF NO, THE WRITE WAS GOOD    30400021
*                                                                       30500021
OFN32200 EQU   *                        I/O ERROR WRITING DSCB          30600002
*                                                                       30700021
OABD031  EQU   31                       I/O ERROR WRITING BACK          30800021
*                                       FORMAT 1 DSCB                   30900021
         DMABCOND OABD031,ID6X0P        XCTL TO PROB DET / ABEND        31000002
*                                                                       31100021
OFN32400 EQU   *                        DSCB WRITE GOOD, CONTINUE       31200002
         OI    DXATDACC,DXATUPDB        UPDATED DSCB WRITTEN     Y02144 31250002
         LM    RTIOT,RUCB,DXWORK1       RESTORE SAVED REGS 9-10         31300021
         NI    JFCBMASK+K4,X'FF'-JFCMDMOD  RESET DSCB MODIFIED SWITCH   31400021
*                                                                       31500021
*********************************************************************** 32100021
*                                                                     * 32200021
*    LOAD IGG019XX EXCP APPENDAGE ROUTINES FOR EXCP DCB WHICH HAS     * 32250002
*    REQUESTED THEM, AND STORE THEIR ADDRESSES IN THE DEB APPENDAGE   * 32300002
*    VECTOR TABLE FOR THIS DCB.                                       * 32350002
*                                                                     * 32360002
*    ONE ABEND IS POSSIBLE: 913-20                                    * 32370002
*                                                                     * 32400021
*********************************************************************** 32500021
*                                                                       37600021
OFN40000 EQU   *                        EXCP APPENDAGE FUNCTION         37700002
         L     RUCB,DXUCBADR            GET CURRENT UCB ADDR     Y02080 37800002
*                                                                       37900021
         TM    UCBTBYT3,UCB3DACC        IS DEVICE DIRECT ACCESS         38200021
         BO    OFN40600                 BR IF YES                       38300002
*                                                                       38400021
         TM    UCBTBYT3,UCB3TAPE        IS DEVICE MAGNETIC TAPE         38500021
         BNO   OFN40600                 BR IF NO                        38600002
*                                                                       38700021
*                                                                       38900021
*********************************************************************** 38950002
*                                                                     * 38960002
*  PROCESSING FOR MAGNETIC TAPE ONLY.                                   39000021
*                                                                     * 39050002
*********************************************************************** 39060002
*                                                                       39100021
         TM    JFCBLTYP,JFCNSL          TEST IF NSL                     39200021
         BZ    OFN40200                 BR IF NO                        39300021
         OI    DEBOFLGS,DEBOFNSL        SET NSL BIT IN DEB FOR CLOSE    39400021
OFN40200 EQU   *                        STANDARD LABELS                 39500002
*                                                                       39600021
*********************************************************************** 39650002
*                                                                     * 39660002
*  TEST IF MAGNETIC TAPE REDUCED ERROR RECOVERY IS DESIRED,             39700021
*  SO THAT A MESSAGE CAN BE WRITTEN TO THE PROGRAMMER,                  39800021
*  AND A BIT SET ON IN THE DEB TO INDICATE IT TO IOS.                   39900021
*                                                                     * 39950002
*********************************************************************** 39960002
*                                                                       40000021
         TM    DCBMACRF,DCBMEXCP        IS EXCP SPECIFIED               40100021
         BNO   OFN40400                 BR IF NO                        40200021
         TM    DCBMACRF,DCBMAPP         DO WE HAVE A SHORT DCB          40300021
         BNO   OFN40600                 BR IF YES, NO OPTCD             40400021
         CLI   DCBOPTCD,ALLBITS         WAS DCB EXPANDED UNDER          40500021
*                                       RELEASE 16 EXCP                 40600021
         BE    OFN40600                 BR IF YES, REDUCED ERROR        40700021
*                                       RECOVERY NOT ACTUALLY REQUESTED 40800021
*                                                                       40900021
OFN40400 EQU   *                        NOT EXCP                        41000002
         TM    DCBOPTCD,DCBOPTZ         IS REDUCED ERROR RECOVERY       41100021
         BZ    OFN40600                 SPECIFIED BY USER, BR IF NO     41200021
         L     RF,CVTPTR                GET ADDRESS OF CVT              41300021
         L     RC,CVTZDTAB-CVT(,RF)     GET DEVICE TABLE ADDR           41400021
         TM    0(RC),X01                IS RER FEATURE SYSGENED         41500021
         BZ    OFN40600                 BR IF NO                        41600021
         OI    DEBOFLGS,DEBOFERR        SET RER BIT IN DEB              41700021
*                                                                       41800021
*********************************************************************** 41850002
*                                                                     * 41860002
*        WRITE MESSAGE TO PROGRAMMER STATING THAT REDUCED ERROR         41900021
*        RECOVERY HAS BEEN REQUESTED.                                   42000021
*                                                                     * 42050002
*********************************************************************** 42060002
*                                                                       42100021
         MVC   MSGLSTSZ(OFN5800L),OFN5800K  MOVE MSG TO WORK AREA       42200021
         MVC   MESSAGEA+K8(K3),UCBNAME  MOVE IN UNIT NAME               42300021
         L     RF,CVTTCBP-CVT(,RF)      GET ADDR TCB POINTERS           42400021
         L     RF,K4(,RF)               GET CURRENT TCB ADDR            42500021
         L     RF,TCBTIO-TCB(,RF)       GET TIOT STARTING ADDR          42600021
         MVC   MESSAGEA+K12(K8),TIOCNJOB-TIOT(RF)  ADD JOB NAME         42700021
*                                                                       42800021
         WTO   MF=(E,MSGLSTSZ)          WRITE MSG TO PROGRAMMER         42900021
*                                                                       43000021
*********************************************************************** 43300021
*                                                                       43400021
*  CHECK FOR EXCP WITH APPENDAGES                                       43500021
*                                                                     * 43550002
*********************************************************************** 43560002
*                                                                       43600021
OFN40600 EQU   *                        SHORT DCB                       43750002
*                                                                       43760002
         TM    DCBMACRF,DCBMEXCP+DCBMAPP  IS DCB EXCP WITH APPENDAGES   43800021
         BNO   OFN50000                 NO, GO TO FINAL WRITE JFCB      43900002
*                                                                       44000021
*********************************************************************** 44050002
*                                                                     * 44060002
*  LOAD EXCP APPENDAGES SPECIFIED IN THE EXCP DCB                       44100021
*                                                                     * 44150002
*********************************************************************** 44160002
*                                                                       44200021
         SR    RD,RD                    CLEAR FOR IC INSTR              44300021
         SR    RF,RF                    CLEAR FOR IC INSTR              44400021
         IC    RF,DEBNMEXT              NO OF EXTENTS                   44500021
         IC    RD,DEBEXSCL              SHIFT BY SCALE FACTOR           44600021
         SLL   RF,0(RD)                 SIZE OF DEV DEPEND SECT IN RF   44700002
         IC    RD,DEBAMLNG              GET AM SECTION LENGTH           44800021
         AR    RF,RD                    ADD AM SECTION                  44900021
         LA    RF,K32(RF,RDEB)          PT TO ID SECTION                45000021
*                                                                       45100021
         MVC   WTGMODNM(K6),OFN5860K    MODULE NAME STARTS WITH IGG019  45200021
         L     RC,DEBAPPAD              PT TO APPENDAGE BLOCK           45300021
         LA    RC,K0(RC)                ZERO HIGH ORDER BYTE     YM2877 45350002
*                                                                       45400021
         MVC   DXCCW1(L'DCBEOEA),DCBEOEA  SET UP EOE ENTRY       YM6415 45450002
         MVC   DXCCW1+K2(L'DCBSIOA),DCBSIOA  SWAP PCI AND SIO    YM6415X45500002
                                        ENTRIES SO THAT ORDER OF YM6415X45550002
                                        ENTRIES IS SAME AS DEB   YM6415 45600002
         MVC   DXCCW1+K4(L'DCBPCIA),DCBPCIA  SET UP PCI ENTRY    YM6415 45650002
         MVC   DXCCW1+K6(L'DCBCENDA+L'DCBXENDA),DCBCENDA  SET UP YM6415X45700002
                                        CE AND ABE ENTRIES       YM6415 45710002
*                                                                       45750002
         LA    RUCB,K0                  INDEX OF FIRST APP ID    YM1133 45900002
         LR    RD,RF                    POINT TO FIRST DEBSUBID         46000021
*                                                                       46100021
OFN41200 EQU   *                        PROCESS APPENDAGE, LOOP ENTRY   46200002
         LA    RET,DXCCW1(RUCB)         GET ADDR OF CURRENT APP  YM6415 46250002
         CLI   K1(RET),BLANK            CHECK FOR BLANK ID       YM1133 46300002
         BE    OFN41400                 BR IF NO ID                     46400021
*                                                                       46500021
         MVC   WTGMODID,0(RET)          ADD ID TO IGG019 MOD NME YM1133 46600002
         MVC   0(2,RD),0(RET)           SAVE ID IN DEB           YM1133 46700002
         LA    RD,2(RD)                 NEXT DEB RTNE ID ADDR           46800021
*                                                                Y02082 46900402
*********************************************************************** 46902802
*                                                                     * 46905602
* MAKE SURE USER IS AUTHORIZED TO LOAD THESE APPENDAGES          Y02082 46908002
*                                                                     * 46910402
*********************************************************************** 46912802
*                                                                Y02082 46915202
         TESTAUTH KEY=YES,FCTN=1 IS CALLER AUTHORIZED?           Y02082 46917602
         LTR   RF,RF                    ZERO IF YES              Y02082 46920002
         BZ    OFN41250                 LOAD APPENDAGES          Y02082 46930002
*                                                                Y02082 46940002
         LR    R0,RUCB                  SAVE APPEN ID INDEX      YM1133 46960002
         SLL   R0,K1                    CALC SUBSCRIPT ENTRY     YM1133 46970002
         L     RF,CVTPTR                POINTER TO CVT           Y02082 46980002
         L     RF,CVTAIDVT-CVT(,RF)     PTR TO APP NAME TABLE    Y02082 46990002
         LA    R1,APPENTRY-APPNMTBL(,RF) POINT TO 1ST ENTRY      Y02082 46998202
         AR    R1,R0                    SUBSCRIPTED AS PER DCB   Y02082 47000702
         LH    R0,APPCOUNT-APPTYPE(,R1) COUNT OF APPENDAGE IDS   Y02082 47003202
         LH    R1,APPOFFST-APPTYPE(,R1) OFFSET TO 1ST ID IN LIST Y02082 47005702
         LA    R1,APPNAMID-APPNMTBL(R1,RF) BEGINNING OF LIST     Y02082 47008202
         LTR   R0,R0                    CHECK FOR EMPTY LIST     Y02082 47010702
         BZ    OFN41240                 YES, ISSUE ABEND         Y02082 47013202
*                                                                Y02082 47015702
OFN41230 EQU   *                        IDS SEARCH               Y02082 47018202
         CLC   0(K2,R1),WTGMODID        COMPARE ID TO VALID LIST Y02082 47020702
         BE    OFN41250                 EQUAL, OK TO LOAD        Y02082 47023202
         LA    R1,K2(,R1)               STEP TO NEXT ID          Y02082 47025702
         BCT   R0,OFN41230              LOOP FOR NO. OF IDS      Y02082 47028202
*                                                                Y02082 47030702
OABD0228 EQU   228                      INTER CONST 913-20 ABEND Y02082 47033202
*                                                                Y02082 47043202
OFN41240 EQU   *                        ABEND 913-20             Y02082 47045202
         MVC   0(K8,RWTG),ID6X6X        RESTORE MODULE NAME      Y02082 47047202
         DMABCOND OABD0228,ID6X0P       INVALID APPENDAGE ID     Y02082 47053202
*                                                                Y02082 47063202
OFN41250 EQU   *                        LOAD APPEND ADDR IN AVT  Y02082 47065202
         IECRES LOAD,BRANCH=NO,PREFIX=WTGPREFX GET APPEND EP     YM1133 47115202
         L     R0,WTGMODEP              SAVE APPEND EP           YM1133 47165202
         XC    WTGMODEP,WTGMODEP        ZERO APPEND EP           YM1133 47215202
*                                                                       47300021
         ST    R0,0(,RC)                STORE ADDR IN APP VECTOR TBL    47400021
         L     R1,DEBAPPAD              POINT TO START OF AVT    YM2877 47405002
         LA    R1,K4(R1)                POINT TO SIO APP ENTRY   YM2877 47410002
         CR    R1,RC                    IS CURRENT ENTRY SIO     YM2877 47415002
         BNE   OFN41350                 BRANCH IF NOT SIO APP    YM2877 47420002
         TM    DCBMACRF,PGFXFLG         TEST IF THE CALLER HAS   YM2877X47425002
                                        A PGFIX APPENDAGE        YM2877 47430002
         BZ    OFN41300                 BRANCH IF NOT            YM2877 47435002
         OI    K0(RC),DEBPGFX           SET PGFX FLAG FOR IOS    YM2877 47440002
OFN41300 EQU   *                        TEST IF AUTHORIZED       YM2877 47445002
         TESTAUTH KEY=YES,STATE=YES,FCTN=1  TEST IF CALLER IS    YM2877X47450002
                                        AUTHORIZED FOR EXCPVR    YM2877 47455002
         LTR   RF,RF                    ZERO IF AUTHORIZED       YM2877 47460002
         BNZ   OFN41350                 BRANCH IF NOT            YM2877 47465002
         OI    K0(RC),DEBIOVR           SET EXCPVR AUTHORIZED    YM2877X47470002
                                        FLAG IN DEB FOR IOS      YM2877 47475002
OFN41350 EQU   *                        UPDATE NUMBER OF ID'S    YM2877 47480002
         IC    R1,DEBNMSUB              UPDATE NUMBER OF                47500021
         LA    R1,K1(R1)                SUBROUTINE ID'S IN              47600021
         STC   R1,DEBNMSUB              DEB BY 1                        47700021
*                                                                       47800021
OFN41400 EQU   *                        NO ID, TRY NEXT ONE             47900002
         LA    RUCB,2(RUCB)             NEXT ID PTR                     48000021
         LA    RC,4(RC)                 NEXT ENTRY IN APP VECTOR TBL    48100021
*                                                                       48200021
         CH    RUCB,MAXAPPNO            CHECK IF DONE 5 APPEN    YM1133 48400002
         BL    OFN41200                 BR IF NO, LOOP ON APPENDAGES    48500021
*                                                                       48600021
         MVC   WTGMODNM,ID6X6X          RESTORE MOD NAME TO IFG0196X    48900002
*                                                                       49000021
*********************************************************************** 49050002
*                                                                     * 49900021
*    WRITE BACK THE JFCB SO THAT MERGED AND UPDATED FIELDS WILL BE    * 49950002
*    AVAILABLE FOR WRITING TRAILER LABELS DURING EOV AND CLOSE,       * 50000002
*    OR WHEN THE DATA SET IS REOPENED.                                * 50050002
*                                                                     * 50060002
*    THE WRITE JFCB ROUTINES ARE IN IFG019RA.                         * 50070002
*                                                                     * 50120002
*********************************************************************** 50353202
*                                                                     * 50376602
OFN50000 EQU   *                        FINAL JFCB WRITE                55400002
         TM    JFCBMASK+K6,X'10'        WAS MOD CHANGED TO NEW          55500021
         BZ    OFN50200                 BR IF NO                        55600021
         NI    JFCBMASK+K6,X'FF'-X'10'  RESET SWITCH                    55700021
         NI    JFCBIND2,X'FF'-JFCNEW+JFCMOD  CHANGE NEW BACK TO MOD     55800021
OFN50200 EQU   *                        MOD NOT CHANGED TO NEW          55900002
*                                                                       56000021
         TM    JFCBMASK+K4,X01          WAS VOL SEQ NO. MODIFIED A38147 56020021
         BZ    OFN50300                 BR IF NO                 A38147 56040021
         XC    JFCBVLSQ,JFCBVLSQ        RESET VOL SEQ NO. TO 0   A38147 56060021
OFN50300 EQU   *                        VOL SEQ NOT MOD          A38147 56080002
*                                       RESET ANY BPAM CONCATENATION,   56100021
*                                       ISAM/BDAM PARALLEL MOUNT,       56120021
*                                       RECOVERED ABEND, AND            56140021
*                                       VOL SEQ NO. MODIFIED BITS       56160021
         NI    JFCBMASK+K4,X'FF'-JFCMBPAM-JFCMISAM-JFCMABND-X01  A38147 56180021
         NI    JFCBMASK+K6,X'FF'-JFCMNRPS-JFCMSDIR  RESET ANY NO RPS    56200021
*                                       AND SEARCH DIRECT INDR BITS     56300021
*                                                                       56400021
*********************************************************************** 56500021
*                                                                       56600021
*  RESTORE THE OPEN PARAMETER LIST DCB OPEN OPTION.                     56700021
*  THE SAME FUNCTION IS PERFORMED IN IFG0198N FOR DCB'S THAT ARE NO     56800021
*  LONGER BEING OPENED.                                                 56900021
*                                                                     * 56910002
*********************************************************************** 56950002
*                                                                       57000021
         TM    JFCBMASK+K6,JFCINOP+JFCOUTOP  WAS AN OVERRIDE USED       57100021
         BNO   OFN50600                 BRANCH IF NO                    57200021
*                                                                       57300021
         TM    0(RPARC),PLISTOUT        IS OPEN FOR OUTPUT (OUTIN)      57400021
         BZ    OFN50400                 BR IF NO, IT WAS INPUT          57500021
*                                       ASSUME LABEL=(,,,OUT) AND       57600021
*                                       CHANGE THE PARAMETER LIST       57700021
         NI    0(RPARC),X'FF'-PLISTOP1+PLISTOIN  ENTRY BACK TO OUTIN    57800021
         NI    JFCBMASK+K6,X'FF'-JFCINOP  RESTORE JFCB LABEL PARM       57900021
         TM    DCBMACRF,DCBMEXCP        TEST FOR EXCP           SA61146 57950002
         BO    OFN50600                 BR IF EXCP              SA61146 57960002
         MVC   DCBOFFSR,DCBOFFSW        EQUATE READ WITH WRITE CCW      58000021
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 58050002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 58060002
* REPEAT DCB FIELD CHANGES                                       Y02082 58070002
         MVC   DCBOFFSR,DCBOFFSW        EQUATE READ WITH WR CCW  Y02082 58072002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 58080002
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 58090002
         B     OFN50600                 BR TO CONTINUE                  58100021
*                                                                       58200021
OFN50400 OI    0(RPARC),PLISTIO         CHANGE ENTRY BACK TO INOUT      58300021
         NI    JFCBMASK+K6,X'FF'-JFCOUTOP  RESTORE JFCB LABEL PARM      58400021
         TM    DCBMACRF,DCBMEXCP        TEST FOR EXCP           SA61146 58450002
         BO    OFN50600                 BR IF EXCP              SA61146 58460002
         MVC   DCBOFFSW,DCBOFFSR        EQUATE WRITE WITH READ CCW      58500021
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 58550002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 58560002
* REPEAT DCB FIELD CHANGES                                       Y02082 58570002
         MVC   DCBOFFSW,DCBOFFSR        EQUATE WRITE WITH RD CCW Y02082 58572002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 58580002
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 58590002
*                                                                       58600021
OFN50600 EQU   *                        CONTINUE WRITE JFCB FUNCTION    58700002
*                                                                       58800021
*                                                                       58801004
* RESTORE JFCBDISP IF IT WAS SAVED IN JFCBMASK BY IFG0193A     @Z40JSGD 58802004
*                                                                       58803004
         TM    JFCBMASK+K7,JFCMDSPM+JFCMDSPO WAS DISP SAVED    @Z40JSGD 58804004
         BZ    OPN50720                 NO-BYPASS RESTORE      @Z40JSGD 58805004
         NI    JFCBIND2,ALLBITS-JFCDISP CLEAR DISP BEFORE REST @Z40JSGD 58806004
         TM    JFCBMASK+K7,JFCMDSPM     WAS BIT 1 SAVED        @Z40JSGD 58807004
         BZ    OPN50710                 NO-BIT 2 MUST BE REST  @Z40JSGD 58808004
         OI    JFCBIND2,JFCMOD          YES-RESTORE BIT 1      @Z40JSGD 58809004
         TM    JFCBMASK+K7,JFCMDSPO     WAS BIT 2 SAVED        @Z40JSGD 58810004
         BZ    OPN50715                 NO-RESTORE FINISHED    @Z40JSGD 58811004
OPN50710 OI    JFCBIND2,JFCOLD          YES-RESTORE BIT 2      @Z40JSGD 58812004
OPN50715 EQU   *                        SET EXTENT FULL SW     @Z40JSGD 58812204
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP             @Z40JSGD 58812304
         BNO   OPN50716                 NO-CHECK FOR PS        @Z40JSGD 58812504
         TM    DCBMACRF,DCBMCOM         IS IT COM              @Z40JSGD 58812704
         BZ    OPN50717                 NO-PS                  @Z40JSGD 58812904
OPN50716 NC    DCBDSORG,DCBDSORG        IS IT SAM              @Z40JSGD 58813004
         BZ    OPN50717                 YES-SET SW             @Z40JSGD 58813204
         TM    DCBDSORG,DCBDSGPS        IS IT SAM              @Z40JSGD 58813804
         BNO   OPN50720                 NO-NO EXTENT FULL SW   @Z40JSGD 58814004
OPN50717 SR    RD,RD                    WORK REG               @Z40JSGD 58814204
         SR    RF,RF                    WORK REG               @Z40JSGD 58814404
         IC    RF,DEBNMEXT              NUMBER OF EXTENTS      @Z40JSGD 58814604
         IC    RD,DEBEXSCL              LENGTH OF EXTENTS      @Z40JSGD 58814804
         SLL   RF,0(RD)                 LENGTH OF DEVICE SECT  @Z40JSGD 58815004
         LA    RD,DEBBASND(RF)          START OF ACCESS METH   @Z40JSGD 58815204
         USING DEBACSMD,RD              ADDRESSABILITY         @Z40JSGD 58815404
         OI    DEBVOLBT,DEBEXFUL        SET EXTENT FULL SWITCH @Z40JSGD 58815604
*                                       TO FORCE ADDING EXTENTS@Z40JSGD 58815804
*                                       TO CURRENT VOLUME      @Z40JSGD 58816004
         DROP  RD                                              @Z40JSGD 58816204
OPN50720 EQU   *                        RESTORE COMPLETE       @Z40JSGD 58816804
*********************************************************************** 58900021
*                                                                       59000021
*  WRITE BACK JFCB IF MODIFIED                                          59100021
*                                                                       59200021
         MVI   DXECB,ECBCOD7F           'POST' ECB SO THAT WAIT CAN     59300021
*                                       BE DONE WHETHER OR NOT THE      59400021
*                                       JFCB IS WRITTEN BACK.           59500021
         TM    JFCBTSDM,JFCNWRIT        IS JFCB WRITE BACK INHIBITED    59600021
         BO    OFN51600                 BR IF YES                       59700021
*                                                                       59800021
***  NOTE, BECAUSE MANY PLACES IN OPEN AND OPEN EXECUTOR MODULES        59900021
***  DO NOT SET THE JFCB MODIFIED BIT WHEN THEY MODIFY THE JFCB,        60000021
***  THE JFCB MUST BE WRITTEN BACK NO MATTER HOW THIS BIT IS SET        60100021
***  IN ORDER TO NOT LOSE ANY MODIFICATIONS TO THE JFCB.                60200021
***  THUS, AS LONG AS THIS SITUATION EXISTS, THE FOLLOWING TWO LINES    60300021
***  MUST BE COMMENTS AND NOT ACTUAL INSTRUCTIONS.                      60400021
***      TM    JFCBMASK+K4,JFCMJMOD     HAS JFCB BEEN MODIFIED          60500021
***      BZ    OFN51600                 BR IF NO                        60600021
*                                                                       60700021
         NI    JFCBMASK+K4,X'FF'-JFCMJMOD  RESET JFCB MODIFIED SWITCH   60800021
*                                                                       60900021
***  SET 'JFCB OPENED' BIT ON TO INDICATE THIS FACT TO SCHEDULER Y02134 60910002
*                                                                       60920002
         OI    JFCFLGS1,X'80'           SET BIT                  Y02134 60930002
*                                                                       60980002
*        IF JFCBPWBP IS ON USER MODIFIED JFCB SO THAT DISP=NEW,  YM7835 61030002
*        CAUSING PASSWORD CHECKING TO BE BYPASSED, AND OPENED    YM7835 61040002
*        FOR INPUT TO WRITE-PASSWORD PROTECTED DATASET SO        YM7835 61080002
*        THAT PASSWORD WAS NOT REQUESTED. JFCB MUST NOT BE       YM7835 61130002
*        REWRITTEN OR A SUBSEQUENT OPEN FOR OUTPUT WILL NOT      YM7835 61180002
*        CAUSE PASSWORD TO BE REQUESTED.                         YM7835 61230002
*        TESTING JFCBPWBP CAN BE BYPASSED IF NL, NSL OR BLP    @ZA02876 61240003
*        TAPE DATA SETS ARE BEING OPENED, SINCE THEY CAN NOT   @ZA02876 61250003
*        BE PASSWORD PROTECTED.                                @ZA02876 61260003
*                                                                       61280002
         TM    JFCBLTYP,JFCSL+JFCBAL    SL OR AL TAPE?         @ZA02876 61330003
         BZ    OFN51000                 NO, BR TO REWRITE JFCB @ZA02876 61380003
         TM    JFCBMASK+K5,JFCBPWBP     DID USER MODIFY JFCB     Y02082 68402402
         BO    OFN51600                 BR IF YES, DON'T REWRITE YM7835 68402802
*                                       JFCB                     YM7835 68404802
OFN51000 EQU   *                        REWRITE JFCB                    68406602
         LA    R0,DXJBF                 LOAD POINTER TO JFCB     Y02134 68438802
         LA    R1,TIOEJFCB              JFCB TTR IN TIOT         Y02134 68450702
*                                                                       68452402
         IECRES WRJFCB,(R1),(R0)        WRITE JFCB               Y02134 68502402
         SPACE                                                          68552402
OFN51600 EQU   *                        DO NOT WRITE JFCB               68600002
         IECRES LOAD,MODID=ID6X8N,BRCODE=0,BRANCH=QUEUED         Y02080 68750002
*                                       XCTL TO IFG0198N TO WAIT Y02080 68760002
*                                                                       68800021
         DROP  RWTG,RDEB                                                68900021
*                                                                       69000021
*********************************************************************** 69100021
*                                                                       69200021
*        CONSTANTS                                                      69300021
*                                                                       69400021
MAXAPPNO DC    H'10'                    MAX NO OF APPENDAGES ID  YM1133 69450002
OFN5800K WTO   'IEC105I DDD,JOBNAMEX REDUCED ERROR RECOVERY REQUESTED',X69500021
               MF=L,DESC=4,             SYSTEM STATUS                  X69600021
               ROUTCDE=(11)             PROGRAMMER INFORMATION          69700021
OFN5800L EQU   *-OFN5800K               LENGTH OF MESSAGE               69800021
*                                                                       69900021
OFN5860K DC    C'IGG019'                PREFIX NAME OF EXCP APPENDAGES  71000021
*                                                                       71300021
         XCTLTABL ID=(ID6X6X,IFG0196X,ID6X0P,0P,                 Y02080X71400002
               ID6X8N,8N),BRT=YES,LENGTH=                        Y02080 71450002
         EJECT                                                          71500002
         DCBD  DSORG=(PS,IS,DA,TQ,XA)                          @VS42097 71510000
         IECDSECS EXPAND=YES            EXPAND DESIRED DSECTS HERE      74510003
*                                                                       77510003
         END                                                            80510003
