         TITLE 'IFG0198N/OPEN - WORK AREA FREEMAIN'                     00100002
         COPY  LCGASMSW                                                 00370000
IFG0198N CSECT                                                          00400021
*********************************************************************** 00450002
*                                                                     * 00460002
*        VS2 RELEASE 999 DELETIONS/CHANGES                            * 00460137
*0000                                                          @ZA01349 00460237
*A274000-274600                                                @ZA25895 00460337
*        VS2 RELEASE 03 DELETIONS/CHANGES                             * 00460737
*0000399700,399800,403158,403170                               @ZA02546 00460803
*                                                                     * 00462003
* MODULE NAME = IFG0198N (OS/VS2)                                     * 00470002
*                                                                     * 00480002
* DESCRIPTIVE NAME = WORK AREA FREEMAIN                               * 00490002
*                                                                     * 00492002
* COPYRIGHT = NONE                                                    * 00494002
*                                                                     * 00496002
* STATUS = RELEASE 2, LEVEL 0                                         * 00498002
*                                                                     * 00498402
* FUNCTION =                                                          * 00498802
*        1. IF OUTPUT, SET LAST OPERATION SWITCH TO WAS-A-WRITE SO    * 00499102
*        THAT TRAILER LABELS WILL BE WRITTEN BY EOV/CLOSE.            * 00499202
*                                                                     * 00499302
*        2. RESTORE OPEN PARAMETER LIST DCB OPEN OPTIONS FOR DCB'S    * 00499402
*        THAT ARE NO LONGER BEING OPENED.                             * 00499502
*                                                                     * 00504302
*        3. SYNCHRONIZE PROCESSING ALL DCB'S TO THIS MODULE, AND      * 00506302
*        CEASE PROCESSING IN PARALLEL WITH THE RESIDENT ROUTINE.      * 00508302
*                                                                     * 00515302
*        4. IF QSAM, PARALLEL DCB PROCESSING IS REQUESTED, COMPLETE   * 00515802
*        THE PARALLEL DATA ACCESS BLOCK--PDAB.                        * 00516302
*                                                                       00516802
*        5. CLEAR THE WTG TABLE ENTRY FOR EACH DCB EXCEPT WHERE       * 00517302
*        DEFERRED ABENDS OR CONCATENATION ARE INVOLVED.               * 00517702
*                                                                     * 00517802
*        6. UPDATE DSAB'S FOR THE DATA SET AND FOR ALL CONCATENATED   * 00517902
*        DSAB'S FOR ISAM OR BPAM INPUT/UPDATE:                        * 00518202
*          A. SET DSAB OPEN BIT IN DSABFLG2;                          * 00518602
*          B. INCREMENT DSABOPCT FIELD.                               * 00518702
*                                                                     * 00519102
*        7. TEST FOR A CHECK POINT DATA SET SECURITY INTERFACE.  IF IT* 00519502
*        EXISTS, UPDATE THE USER'S DCB TO THE STATUS OF THE PROTECTED * 00519602
*        DCB AND PLACE THE ADDRESS OF THE SECURITY INTERFACE ERROR    * 00519702
*        ROUTINE IN THE READ/WRITE AND CHECK ROUTINE ADDRESS SLOTS OF * 00519802
*        THE USER'S DCB.                                              * 00522102
*                                                                     * 00525602
*        8. IF DEFERRED ABEND SITUATION, RESTORE REGISTERS AND ISSUE  * 00527902
*        ABEND.                                                       * 00530202
*                                                                     * 00532502
*        9. FREEMAIN THE WTG TABLE. THIS FREES ALL WORKAREAS AS WELL. * 00534802
*                                                                     * 00537102
* NOTES = SEE BELOW                                                   * 00539402
*                                                                     * 00541702
*    DEPENDENCIES =                                                   * 00544002
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 00546302
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 00548602
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 00550902
*                                                                     * 00553202
*    RESTRICTIONS = NONE                                              * 00563202
*                                                                     * 00565202
*    REGISTER CONVENTIONS =                                           * 00565602
*            R2 POINTS TO DCB                                         * 00566002
*            R4 POINTS TO OPEN WORK AREA                              * 00566402
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 00566502
*            R6 POINTS TO THE WTG TABLE                               * 00566602
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 00577702
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 00587702
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 00588102
*            R10 POINTS TO THE UCB                                    * 00588502
*                                                                     * 00588602
*    PATCH LABEL = SEE NEXT TO LAST LABEL BEFORE ORG STATEMENT AT END * 00588702
*                  OF LISTING.                                        * 00588802
*                                                                     * 00592502
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 00594502
*                                                                     * 00594902
*    PROCESSOR = ASSEMBLER XF                                         * 00595302
*                                                                     * 00595702
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 00596102
*                  ORG STATEMENT AT END OF LISTING                    * 00596202
*                                                                     * 00609602
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 00619602
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 00621602
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 00622002
*                                                                     * 00622402
* ENTRY POINT = IFG0198N FROM IFG0196W, ACCESS METHOD EXECUTOR RETURN * 00622802
*                        OR IFG0196X, LOAD EXCP APPEN, WRITE BACK JFCB* 00622902
*                                                                     * 00626302
*    PURPOSE = SEE FUNCTION                                           * 00627102
*                                                                     * 00628102
*    LINKAGE =                                                        * 00629102
*        FROM IFG0196W:                                               * 00629502
*           LA    RET,K8                                              * 00629902
*           IECRES LOAD,MODID=ID6W8N,BRCODE=(RET),BRANCH=QUEUED       * 00630002
*                                                                     * 00680002
*        FROM IFG0196X:                                               * 00690002
*           IECRES LOAD,MODID=ID6X8N,BRCODE=0,BRANCH=QUEUED           * 00700002
*                                                                     * 00730002
* INPUT = STANDARD                                                    * 00780002
*                                                                     * 00830002
* OUTPUT =                                                            * 00880002
*   OPEN RETURN CODE IN REGISTER 15 -                                 * 00930002
*      CODE IS LARGEST OF ALL DCB CODES IN A PARALLEL DCB OPEN        * 00980002
*      0 - ALL ENTRIES IN PARAMETER LIST OPENED CORRECTLY.            * 01030002
*      4 - ALL ENTRIES IN PARAMETER LIST HAVE SUCCESSFULLY            * 01080002
*          COMPLETED OPEN, BUT ONE OR MORE ENTRIES HAS A              * 01130002
*          WARNING MESSAGE.                                           * 01180002
*      8 - ONE OR MORE ENTRIES IN PARAMETER LIST WAS NOT              * 01230002
*          OPENED SUCCESSFULLY.  THE ENTRIES WITH ERRORS              * 01280002
*          WERE RESTORED TO THEIR PRE-OPEN STATUS.                    * 01330002
*     12 - ONE OR MORE ENTRIES WAS NOT OPENED SUCCESSFULLY.           * 01380002
*          THE ENTRIES WITH ERRORS WERE NOT RESTORED, AND             * 01430002
*          CANNOT BE REOPENED WITHOUT RESTORATION.                    * 01480002
*                                                                     * 01530002
* EXIT-NORMAL = RETURN TO CALLER OF OPEN                              * 01580002
*                                                                     * 01630002
* EXIT-ERROR = ABEND                                                  * 01680002
*                                                                     * 01730002
* EXTERNAL REFERENCES = SEE BELOW                                     * 01780002
*                                                                     * 01830002
*    ROUTINES = STANDARD                                              * 01880002
*                                                                     * 01930002
*    DATA AREAS = STANDARD                                            * 01980002
*                                                                     * 02030002
*    CONTROL BLOCK = STANDARD                                         * 02080002
*                                                                     * 02130002
* TABLES = STANDARD                                                   * 02180002
*                                                                     * 02230002
* MACROS = IECDSECS, IECEQU, DMABCOND, MODESET, IECRES, XCTLTABL      * 02280002
*                                                                     * 02330002
* CHANGE ACTIVITY = NEW RELEASE (LEVEL 0)                             * 02380002
*                                                                     * 02430002
*********************************************************************** 02580002
         EJECT                                                          02630002
         IECDSECS CVT,TCB,RB,DCB,ACB,MAIN,PREFX,WTG,TIOT,IEZDEB, Y02134*11730002
               DSAB,PSA,RRPL,PDAB                               YL03123 11737502
         IECEQU AOS=YES,IEZDEB=YES                                      11750002
*                                                                       11759200
TIOTSPOL EQU   X'06'                    JES SPOOL D.S. INDICATORS     $ 11760200
         USING TIOENTRY,RTIOT           DEFINE BASE TO TIOT DD ENTRY    11765100
*                                                                       11800021
         USING IHADCB,RDCB              DEFINE BASE TO USER'S DCB       11900021
         USING FORCORE,RCORE            DEFINE BASE TO MAIN WORK AREA   12000021
         USING WTG,RWTG                 DEFINE BASE TO XCTL/WTG TABLE   12100021
*                                                                       12200021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         12300021
         USING *,RBASE                  DEFINE BASE REGISTER            12400021
*                                                                       12500021
         B     OFN60200(RET)            BRANCH TO INDICATED FUNCTION    12600021
*                                                                       12700021
OFN60200 B     OFN60600                 RET=0 STILL PROCESSING   YM1342 12800002
         B     OFN70000                 RET=4 DCB IS NOT BEING OPENED   12900021
         B     OFN70400                 RET=8 RE-SYNCH RETURN           13000002
*                                                                       13200021
OFN60600 EQU   *                        STILL PROCESSING ENTRY          14600002
*                                                                       14700021
*********************************************************************** 14800021
*                                                                       14900021
*  IF OUTPUT MODE, SET LAST OPERATION WAS A WRITE INDICATOR             15000021
*  IN DCB FOR EOV/CLOSE, SO THAT TRAILER LABELS WILL BE WRITTEN.        15100021
*                                                                       15200021
         NI    DCBOFLGS,X'FF'-DCBOWRIT  CLEAR WRITE SWITCH IN DCB       15300021
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 15350002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 15360002
* REPEAT DCB FIELD CHANGES                                       Y02082 15370002
         NI    DCBOFLGS,X'FF'-DCBOWRIT  CLEAR WRT SWITCH IN DCB  Y02082 15372002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 15380002
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 15390002
         TM    0(RPARC),PLISTOIN        IS OPEN FOR OUTPUT OR OUTIN     15400021
         BNO   OFN70400                 BR IF NO TO SYNCH DCB'S         15500002
         OI    DCBOFLGS,DCBOWRIT        SET WRITE SW ON FOR EOV/CLOSE   15600021
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 15650002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 15660002
* REPEAT DCB FIELD CHANGES                                       Y02082 15670002
         OI    DCBOFLGS,DCBOWRIT        SET WRITE SW ON FOR C/E  Y02082 15672002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 15680002
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 15690002
         B     OFN70400                 BR TO SYNCH DCB'S               15700002
*                                                                       25300021
*********************************************************************** 25400021
*                                                                       25500021
*  RESTORE THE OPEN PARAMETER LIST DCB OPEN OPTION FOR DCB'S THAT       25600021
*  ARE NO LONGER BEING OPENED.                                          25700021
*  THE SAME FUNCTION IS PERFORMED IN IFG0196X FOR DCB'S THAT ARE        25800021
*  STILL BEING OPENED.                                                  25900021
*                                                                       26000021
OFN70000 EQU   *                        DCB NOT BEING OPENED ENTRY      26100002
         TM    JFCBMASK+K6,JFCINOP+JFCOUTOP  WAS AN OVERRIDE USED       26200021
         BNO   OFN70400                 BRANCH IF NO                    26300021
*                                                                       26400021
         TM    0(RPARC),PLISTOUT        IS OPEN FOR OUTPUT (OUTIN)      26500021
         BZ    OFN70200                 BR IF NO, IT WAS INPUT          26600021
*                                       ASSUME LABEL=(,,,OUT) AND       26700021
*                                       CHANGE THE PARAMETER LIST       26800021
         NI    0(RPARC),X'FF'-PLISTOP1+PLISTOIN  ENTRY BACK TO OUTIN    26900021
         NI    JFCBMASK+K6,X'FF'-JFCINOP  RESTORE JFCB LABEL PARM       27000021
         TM    DCBMACRF,DCBMEXCP        CHECK FOR EXCP          SA61146 27050002
         BO    OFN70400                 BR IF EXCP              SA61146 27060002
         MVC   DCBOFFSR,DCBOFFSW        EQUATE READ WITH WRITE CCW      27100021
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 27150002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 27160002
* REPEAT DCB FIELD CHANGES                                       Y02082 27170002
         MVC   DCBOFFSR,DCBOFFSW        EQUATE READ WITH WRT CCW Y02082 27172002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 27180002
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 27190002
         B     OFN70400                 BR TO CONTINUE                  27200021
*                                                                       27300021
OFN70200 EQU   *                        FIRST,SEE IF BDAM      @ZA25895 27400037
         TM    DCBDSORG,DCBDSGDA        IS DCB FOR BDAM?       @ZA25895 27410037
         BNO   OFN70205                 NO,BRANCH              @ZA25895 27420037
         OI    0(RPARC),PLISTUPD        YES,CHANGE TO UPDATE   @ZA25895 27430037
         B     OFN70210                 GO RESET JFCB LABEL PRM@ZA25895 27440037
OFN70205 OI    0(RPARC),PLISTIO         CHANGE ENTRY BACK TO IN@ZA25895 27450037
OFN70210 NI    JFCBMASK+K6,X'FF'-JFCOUTOP  RESTORE JFCB LABEL P@ZA25895 27460037
         TM    DCBMACRF,DCBMEXCP        TEST FOR EXCP           SA61146 27550002
         BO    OFN70400                 BR IF EXCP              SA61146 27560002
         MVC   DCBOFFSW,DCBOFFSR        EQUATE WRITE WITH READ CCW      27600021
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 27650002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 27660002
* REPEAT DCB FIELD CHANGES                                       Y02082 27670002
         MVC   DCBOFFSW,DCBOFFSR        EQUATE WRITE WITH RD CCW Y02082 27672002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 27680002
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 27690002
*                                                                       27700021
*********************************************************************** 28000021
*                                                                       28100021
*  SYNCHRONIZE ALL DCB'S TO THIS POINT AND THEN CEASE PROCESSING        28200021
*  IN PARALLEL WITH THE RESIDENT ROUTINE.                               28300021
*                                                                       28400021
OFN70400 EQU   *                        SYNCH DCBS                      28450002
         IECRES SYNCHDCB                SYNCHRONIZE THE DCB'S TO HERE   28600021
*                                                                       37100021
*********************************************************************** 37200021
*                                                                       37300021
*  LOOP THROUGH THE DCB/ACB PARAMETER LIST. DO THE FOLLOWING,           37320002
*  AS APPROPRIATE:                                                      37340002
*    (1) SET A RETURN CODE;                                             37360002
*    (2) SET THE OPEN BIT, RESET THE BUSY BIT;                          37380002
*    (3) SET THE DSAB OPEN BIT;                                         37400002
*    (4) INCREMENT THE DSAB OPEN COUNT;                                 37420002
*    (5) CLEAR THE WTG TABLE ENTRY EXCEPT FOR                           37440002
*        ... A DCB/ACB HAVING A DELAYED ABEND PENDING;                  37460002
*        ... A DCB/ACB HAVING AN IGNORED ABEND PENDING;                 37480002
*        ... A DCB WITH CONCATENATION IN PROGRESS;                      37500002
*        ... A NON-SPOOLED ACB WITH CONCATENATION IN PROGRESS.          37520002
*                                                                       37600021
         L     RPAR,WTGPREFX            GET PTR TO WTG PREFIX    Y02080 37650002
         USING IECPREFX,RPAR                                     Y02080 37700002
         L     RPAR,IECUPRML            GET DCB PARM LIST ADDR   Y02080 37750002
         DROP  RPAR                                              Y02080 37800002
         LR    RPARC,RPAR               ADDR OF FIRST DCB PARM ENTRY    37900021
         USING USERPRML,RPARC                                    Y02080 37950002
         LA    RWTGC,WTGENTRY           ADDR OF FIRST WTG ENTRY         38000021
         USING WTGENTRY,RWTGC           DEFINE BASE TO WTG ENTRY        38100021
         MVI   WTGLNG,K0                INIT OPEN RTN CODE TO 0  Y02080 38300002
*                                                                       38400021
OFN72200 EQU   *                        PROCESS DCB                     38500002
         L     RCORE,WTGCORE-K1         LOAD MAIN WORK AREA ADDR        38600021
         LA    RCORE,0(RCORE)           CLEAR HIGH ORDER BYTE           38700021
         LTR   RCORE,RCORE              TEST IF DCB HAS WORK AREA       38800021
         BNZ   OFN72400                 BR IF YES                       38900021
*                                                                       39000021
         LA    R1,K8                    RET CODE = 8             YM3011 39050002
         BAL   RB,OFN72500              GO SET RET CODE          YM3011 39100002
         B     OFN74500                 BR TO PROCESS NEXT DCB   YM1342 39600002
*                                                                       39700021
OFN72400 EQU   *                        DCB HAS WORK AREA               39800002
         L     RDCB,PLISTDCB(,RPARC)    LOAD CURRENT DCB ADDR    YM3011 39850002
*                                                                       39900002
**********************************************************************  39910002
*                                                                       39920002
*    TEST FOR VTAM ACB                                           YM3011 39950002
*                                                                       39960002
*        DO NOT CHECK FOR EXCP BEFORE CHECKING DSORG           @ZA02546 39970003
*        BECAUSE THE DDNAME MAY BE THERE AND THE DSORG         @ZA02546 39980003
*        WILL BE ZERO IF NOT PRESENT BECAUSE IT IS A COPY.     @ZA02546 39982003
         TM    DCBDSRG2,ACBDORGA        IS CONTROL BLOCK ACB     YM3011 39990002
         BZ    OFN72405                 NO, CAN'T BE VTAM        YM3011 39992002
         USING IFGACB,RACB              ADDRESSABILITY TO ACB    YM3011 39992402
         CLI   ACBAMETH,ACBVTAM         IS THIS A VTAM ACB       YM3011 39994002
         BE    OFN72430                 YES, CHECK ERROR CODE    YM3011 39996002
*                                                                       39998002
OFN72405 EQU   *                        CHECK FOR DELAYED ABEND  YM3011 39998402
         TM    JFCBMASK+K4,JFCMABND     DELAYED ABEND PENDING    Y02144 40000002
         BO    OFN74500                 BR IF YES                YM1342 40100002
         TM    DXATOPEN,DXATIGN         IGNORED ABEND PENDING    Y02144 40150002
         BO    OFN74500                 BR IF YES                YM1342 40160002
*                                                                       40200021
         L     RTIOT,DXTIOTAD           GET CURRENT TIOT ENTRY   YM1342 40303002
*                                                                X02989 40306002
*  TEST FOR VSAM ACB'S AND SET RETURN CODES                      X02989 40306402
*                                                                X02989 40306802
         TM    JFCDSRG2,JFCORGAM        IS THIS A VSAM DATA SET  XM1037 40314002
         BNO   OFN72460                 BR IF NO                 Y02134 40315702
*        DO NOT CHECK FOR EXCP BEFORE CHECKING DSORG           @ZA02546 40316903
*        BECAUSE THE DDNAME MAY BE THERE AND THE DSORG         @ZA02546 40317303
*        WILL BE ZERO IF NOT PRESENT BECAUSE IT IS A COPY.     @ZA02546 40317703
         TM    ACBDSORG+K1,ACBDORGA     IS CONTROL BLOCK AN ACB  X02989 40322902
         BNO   OFN72460                 BR IF NO                 YM1342 40324102
         TM    ACBOFLGS,ACBOPEN         IS ACB OPEN              X02989 40325302
         BNO   OFN72425                 BR IF NO                 X02989 40326502
         CLI   ACBERFLG,K0              ARE ERROR FLAGS SET      X02989 40327702
         BE    OFN73810                 BR IF NO, GO SET DSAB    YM1342 40328902
         LA    R1,K4                    SET RET CODE = 4         YM3011 40330102
         BAL   RB,OFN72500              GO SET RET CODE          YM3011 40331302
         B     OFN73810                 BR TO SET DSAB           YM1342 40332502
         USING IHADCB,RDCB              REDEFINE BASE TO DCB     X02989 40333702
OFN72425 EQU   *                        ACB NOT OPEN             X02989 40334902
         LA    R1,K8                    SET RET CODE = 8         YM3011 40336102
         BAL   RB,OFN72480              ENSURE OPEN BIT OFF    @ZA01349 40336537
         BAL   RB,OFN72500              GO SET RET CODE          YM3011 40337302
         B     OFN73980                 BR, VSAM ACB NOT OPEN    YM1342 40338502
*                                                                       40339702
*********************************************************************** 40340902
*                                                                       40342102
*    TEST FOR VTAM ERRORS AND SET RETURN CODE                    YM3011 40343302
*                                                                       40344502
OFN72430 EQU   *                        TEST FOR VTAM ERRORS     YM3011 40345702
         USING IFGACB,RACB              DETERMINE BASE FOR ACB   YM3011 40346902
         TM    ACBOFLGS,ACBIOSFG        IS BUSY BIT ON           YM3011 40356902
         BO    OFN72440                 YES, TEST ERROR FLG      YM3011 40358902
         LA    R1,K8                    RET CODE = 8             YM3011 40359302
         BAL   RB,OFN72480              ENSURE OPEN BIT OFF    @ZA01349 40359437
         BAL   RB,OFN72500              GO SET RET CODE          YM3011 40359702
         MVC   ACBDDNM,DDNINIT          INITIALIZE DD NAME       YM3011 40360102
         L     RACB,DXUDCBAD            USERS ACB                YM3011 40362202
         MODESET KEYADDR=DXUKEY,WORKREG=1 USERS KEY              YM3011 40363002
*   REPEAD FIELD CHANGES                                                40363402
         MVC   ACBDDNM,DDNINIT          INIT DDNAME              YM3011 40363802
         MODESET EXTKEY=DATAMGT         RETURN TO DM DEY         YM3011 40363902
         L     RACB,DXPDCBAD            COPIED DCB               YM3011 40364002
         B     OFN73980                 GO TEST FOR DEB EXT      YM3011 40364202
*                                                                       40366202
OFN72440 EQU   *                        BUSY BIT ON, TEST ERR FLGYM3011 40368202
         CLI   ACBERFLG,K0              ERROR FLAG ON            YM3011 40368302
         BNE   OFN72450                 YES, SET RET CODE = 4    YM3011 40368402
         B     OFN72455                 NO, OPEN ON, BUSY OFF    YM3011 40372502
*                                                                       40374602
OFN72450 EQU   *                        BUSY ON, ERROR FLAGS ON  YM3011 40376602
         LA    R1,K4                    RET CODE = 4             YM3011 40376702
         BAL   RB,OFN72500              GO SET RET CODE          YM3011 40380802
         B     OFN72455                 CLEAR WTG TABLE ENTRY    YM3011 40382802
*                                                                       40384802
OFN72455 EQU   *                        TURN ON OPEN, BUSY OFF   YM3011 40384902
         USING IHADCB,RDCB                                       YM3011 40385002
         XI    DCBOFLGS,DCBOPEN+DCBOBUSY OPEN ON BUSY OFF        YM3011 40389102
         L     RDCB,DXUDCBAD            USERS DCB                YM3011 40389602
         MODESET KEYADDR=DXUKEY,WORKREG=1                        YM3011 40390002
*     REPEAT DCB FIELD CHANGES                                          40390802
         XI    DCBOFLGS,DCBOPEN+DCBOBUSY OPEN ON BUSY OFF        YM3011 40390902
         MODESET EXTKEY=DATAMGT         SESUME DATA MGT KEY      YM3011 40391002
         L     RDCB,DXPDCBAD            COPIED DCB ADDR          YM3011 40391702
         B     OFN74000                 CLEAR WTG TABLE ENTRY    YM3011 40393302
*                                                                YM1342 40393402
*   ON ENTRY TO THIS MODULE THE OPEN BIT CAN BE ON FOR           YM1342 40397502
*   A VSAM ACB AND AN ISAM-VSAM CI DCB.  A VSAM ACB              YM1342 40401602
*   WILL NOT PASS THROUGH THE FOLLOWING TEST.                    YM1342 40405702
*                                                                YM1342 40409802
OFN72460 EQU   *                        NOT MSAM ACB             Y02134 40422202
         TM    DCBOFLGS,DCBOPEN         CHECK FOR OPENED DCB     YM1342 40434602
         BO    OFN73810                 BR IF OPEN               YM1342 40447002
*                                                                       40459402
         TM    DCBOFLGS,DCBOLOCK+DCBOBUSY  CHECK LOCK AND BUSY BITS     40494202
         BO    OFN72600                 BR IF STILL OPENING             40500021
*                                                                       40600021
         MVI   WTGLNG,K12               SET RETURN CODE          Y02080 40770002
         B     OFN73980                 BR IF NOT STILL OPENING         40771002
*                                                                       40781037
*********************************************************************** 40791037
*                                                                       40793037
*    CLOSED SUBROUTINE TO ENSURE OPEN BIT IS OFF IF THIS                40795037
*    DCB IS NOT OPENED SUCCESSFULLY (IE THE ERROR RETURN CODE IS        40797037
*    GREATER THAN 8 AND A WORK AREA WAS OBTAINED).                      40799437
*                                                                       40799837
OFN72480 EQU   *                                               @ZA01349 40799937
         NI    DCBOFLGS,X'FF'-DCBOPEN   ENSURE OPEN BIT OFF    @ZA01349 40816637
         L     RDCB,DXUDCBAD            ADDRESS USER DCB       @ZA01349 40826637
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY     @ZA01349 40828637
         NI    DCBOFLGS,X'FF'-DCBOPEN   ENSURE OPEN BIT OFF    @ZA01349 40830637
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY    @ZA01349 40832637
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB    @ZA01349 40833037
         BR    RB                       RETURN                 @ZA01349 40833137
*                                                                       40833337
*********************************************************************** 40850002
*                                                                       40860002
*    CLOSED SUBROUTINE TO DETERMINE IF PRESENT RET CODE IS       YM3011 40870002
*    GREATER THAN PREVIOUS.  IF IT IS, IT REPLACES PREVIOUS.  IF YM3011 40880002
*    NOT, THE PREVIOUS RET CODE IS LEFT.  PREVIOUS RET CODE IS   YM3011 40890002
*    IN CORE LOCATION WTGLNG AND PRESENT CODE IS IN REG 1        YM3011 40892002
*                                                                       40894002
OFN72500 EQU   *                        SET RET CODE             YM3011 40896002
         CLM   R1,K1,WTGLNG             PRESENT RC LARGER PREV.  YM3011 40898002
         BLR   RB                       NO, DON'T SET RET CODE   YM3011 40898402
         STC   R1,WTGLNG                YES, SET RET CODE        YM3011 40898802
         BR    RB                       RETURN                   YM3011 40899202
*                                                                       40899602
OFN72600 EQU   *                        STILL OPENING                   40900002
         XI    DCBOFLGS,DCBOPEN+DCBOBUSY  SET OPEN BIT ON, BUSY BIT OFF 45200021
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 45210002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 45220002
* REPEAT DCB FIELD CHANGES                                       Y02082 45230002
         XI    DCBOFLGS,DCBOPEN+DCBOBUSY  SET OPEN, BUSY BITS    Y02082 45232002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 45240002
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 45242002
*                                                                       45250002
*  QSAM PARALLEL INPUT PROCESSING OCCURS HERE.  A REQUEST FOR QPIP      45251002
*  IS RECOGNIZED BY A DCB EXIT LIST CODE OF X'12'.  THE ADDRESS OF THE  45252002
*  DCB IS ADDED TO A QUEUE OF DCB ADDRESSES IN A PARALLEL DATA ACCESS   45253002
*  BLOCK.  THE ADDRESS OF THE PDAB IS OBTAINED FROM THE DCB EXIT LIST.  45254002
*  WHEN SPACE IS AVAILABLE IN THE PDAB, THE DCB ADDRESS IS ADDED TO THE 45255002
*  QUEUE; THE PARALLEL GET ROUTINE IS LOADED; AND THE DCB IS MARKED     45256002
*  OPEN FOR QPIP--DCBPOPEN IS SET TO 1.                                 45257002
*                                                                       45258002
         TM    DCBOFLGS,DCBOPEN         OPENED FOR PROCESSING    YM1343 45259002
         BZ    OFN73810                 BR NO                    YM1343 45260002
         TM    DCBMACF1,DCBMEXCP        USING EXCP               YM1343 45261002
         BO    OFN73810                 BR YES                   YM1343 45262002
         TM    DCBDSRG2,DCBACBM         CONTROL BLOCK AN ACB     YM1343 45263002
         BO    OFN73810                 BR YES                   YM1343 45264002
         TM    DCBDSRG1,DCBORGPS+DCBORGPO CAPABLE OF QSAM        YM1343 45265002
         BZ    OFN73810                 BR NO                    YM1343 45266002
         TM    DCBMACF1,DCBMGET         USING QSAM GET           YM1343 45267002
         BZ    OFN73810                 BR NO                    YM1343 45268002
         TM    DCBQSWS,DCBPOPEN         ALREADY OPEN FOR QPIP    YM1343 45269002
         BO    OFN73810                 BR YES                   YM1343 45270002
         TM    0(RPARC),PLISTM01        INPUT PROCESSING         YM1343 45271002
         BO    OFN73810                 BR NO                    YM1343 45272002
         TM    TIOELINK,TIOESYIN        SPOOLED INPUT            YM1343 45274002
         BO    OFN73810                 BR YES                   YM1343 45275002
         L     RF,TIOESTTB                                       YM1343 45276002
         N     RF,OFN7745K              DUMMY DATA SET           YM1343 45277002
         BZ    OFN73810                 BR YES                   YM1343 45278002
         TM    DCBRECFM,DCBRECVR+DCBRECST SPANNED RECORDS        YM1343 45279002
         BO    OFN73810                 BR YES                   YM1343 45280002
         TM    DCBBFTEK,DCBBFTE         EXCHANGE BUFFERING       YM1343 45281002
         BO    OFN73810                 BR YES                   YM1343 45282002
         TM    DCBRECFM,DCBRECTK        TRK OVERFLOW             YM1343 45283002
         BO    OFN73810                 BR YES                   YM1343 45284002
         TM    DCBMACF1,DCBMGMOV+DCBMLOC MOVE OR LOCATE MODE     YM1343 45285002
         BZ    OFN73810                 BR NO                    YM1343 45286002
         L     RD,DCBEXLST                                       YM1343 45287002
         N     RD,OFN7745K              EXIT LIST PRESENT        YM1343 45288002
         BZ    OFN73810                 BR NO                    YM1343 45289002
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 45290002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 45291002
OFN72720 EQU   *                        CHECK ENTRY              YM1343 45291402
         CLI   0(RD),XLQPIP             PARALLEL INPUT PROC      YM1343 45293002
         BE    OFN72730                 BR YES                   YM1343 45294002
         CLI   0(RD),XLQPIP+LASTNTRY    PARALLEL INPUT PROC      YM1343 45295002
         BE    OFN72730                 BR YES                   YM1343 45296002
         TM    0(RD),LASTNTRY           LAST EXLST ENTRY         YM1343 45297002
         BO    OFN72900                 BR YES                   YM1343 45298002
         LA    RD,K4(,RD)               STEP TO NEXT ENTRY       YM1343 45299002
         B     OFN72720                 GO CHECK NEXT ENTRY      YM1343 45300002
OFN72730 EQU   *                        PARALLEL INPUT PROCESS   YM1343 45301002
         L     RET,0(,RD)               LOCATE PDAB              YM1343 45302002
         USING IHAPDAB,RET                                       YM1343 45303002
         LH    RD,PDANODCB              GET CURRENT NO. DCB'S    YM1343 45304002
         AH    RD,OFN7740K              ADD THIS ONE             YM1343 45305002
         BNP   OFN72900                 BR IF COUNT INVALID      YM1343 45306002
         LH    RF,PDAMAXCB              GET MAX ENTRIES          YM1343 45307002
         LTR   RF,RF                    POSITIVE NUMBER          YM1343 45308002
         BNP   OFN72900                 BR NO                    YM1343 45309002
         CR    RD,RF                    THIS ENTRY EXCEED MAX    YM1343 45310002
         BH    OFN72900                 BR YES                   YM1343 45311002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 45312002
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 45313002
         IECRES LOAD,MODNM=OFN7760N,BRANCH=NO,PREFIX=WTGPREFX    YM1307 45314002
         OI    DCBQSWS,DCBPOPEN         COMPLETED PARALLEL OPEN  YM1343 45315002
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 45316002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 45317002
         STH   RD,PDANODCB              UPDATE NO. OF DCB'S      YM1343 45318002
         SLL   RD,K2                    LENGTH OF DCB LIST       YM1343 45319002
         LA    RDCB,0(,RDCB)                                     YM1343 45320002
         ST    RDCB,PDADCBAL-K4(RD)     ADD DCB ADDR TO LIST     YM1343 45321002
         LA    RB,PDADCBAL-K4(RD)       ADDR OF LAST DCB ENTRY   YM1343 45322002
         LR    RC,RB                    ALLOW WAIT ON FIRST REQ  YM1343 45323002
         LA    RA,K4                    BXLE INCR FOR IGG019JD   YM1343 45324002
         STM   RA,RD,PDADCBAI           UPDATE PDAB PARAMETERS   YM1343 45325002
         MVC   PDAGRTNA,WTGMODEP        ADD ENTRY POINT TO PDAB  YM1343 45326002
         OI    DCBQSWS,DCBPOPEN         COMPLETED PARALLEL OPEN  YM1343 45327002
OFN72900 EQU   *                        LAST EXLST ENTRY                45328002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 45329002
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 45330002
*                                                                Y02082 45511502
*        SET DSAB OPEN BIT ON AND INCREMENT OPEN COUNT IN DSAB.  Y02134 45515002
*        DO THE SAME IN ALL CONCATENATED DSABS.                  Y02134 45522502
*        THIS IS NOT DONE IF CONCATENATION OF UNLIKE ATTRIBUTES  Y02134 45530002
*        IS OCCURRING.                                           Y02134 45537502
*                                                                       45575002
OFN73810 EQU   *                        DSAB OPEN BIT PROCESS    Y02082 45577002
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP               Y02134 45585002
         BO    OFN73815                 YES AVOID ACB TEST       Y02134 45595002
         TM    DCBDSRG2,ACBDORGA        IS IT AN ACB             Y02134 45597002
         BO    OFN73815                 YES, DON'T TEST SPOOL DCBY02134 45599002
         TM    TIOELINK,TIOTSPOL        IS IT SPOOLED DCB        Y02134 45599402
         BZ    OFN73815                 NO, GO INCREMENT DSAB    YM1111 45599502
         TM    DCBOFLGS,DCBOCON         CONCATENATION            YM1111 45599602
         BZ    OFN74000                 BR NO TO ZERO WTG ENTRY  YM1111 45599702
         B     OFN74500                 BYPASS ZEROING WTG ENTRY YM1111 45599802
OFN73815 EQU   *                        INCREMENT DSAB           Y02134 45599902
         L     RC,DXDSABAD              FIRST DSAB ADDRESS       Y02134 45600002
         USING DSAB,RC                                           Y02134 45627502
         LTR   RC,RC                    IS THERE A DSAB          Y02134 45627602
         BZ    OFN74000                 BRANCH IF NO             YM1342 45627702
         MODESET EXTKEY=SCHED           ASSUME SCHED KEY         Y02082 45628102
         OI    DSABFLG2,DSABOPEN        TURN ON OPEN BIT IN      Y02134 45629002
*                                       FIRST DSAB               Y02134 45629802
         MODESET EXTKEY=DATAMGT         ASSUME DATA MGT KEY      Y02082 45630202
         TM    DCBOFLGS,DCBOCON         CONCATENATION            Y02134 45630302
         BZ    OFN73820                 BRANCH IF NO             YM1342 45630402
         TM    DCBMACRF,DCBMEXCP        IS ACCESS METHOD EXCP    YM1342 45630502
         BO    OFN74500                 BR IF YES, NOT AN ACB    YM1342 45630602
         TM    DCBDSRG2,ACBDORGA        IS CONTROL BLOCK AN ACB  YM1342 45630702
         BZ    OFN74500                 BR NO                    YM1342 45630802
         TM    TIOELINK,TIOTSPOL        CHK IF SPOOLED ACB       YM1342 45630902
         BZ    OFN74500                 BR NO                    YM1342 45631002
         NI    DCBOFLGS,X'FF'-DCBOCON   INSURE EOVC BIT OFF      YM1342 45631102
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         YM1342 45631202
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        YM1342 45631302
* REPEAT DCB FIELD CHANGES                                       YM1342 45631402
         NI    DCBOFLGS,X'FF'-DCBOCON   INSURE EOVC BIT OFF      YM1342 45631502
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      YM1342 45631602
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      YM1342 45631702
         B     OFN74000                 GO ZERO WTG ENTRY        YM1342 45631802
OFN73820 EQU   *                        NO CONCATENATION         Y02134 45632202
         OI    DXATOPEN,DXATDSIN        DSAB COUNT INCR STARTED  Y02144 45633002
         L     RF,DSABOPCT-K2           OPEN COUNT 2ND HWORD     Y02134 45635002
OFN73860 EQU   *                        INCREMENT DSAB COUNT     Y02134 45642502
         LR    R0,RF                    LOAD TO MANIPULATE       Y02134 45650002
         SRDL  R0,K16                   COUNT IN HIGH 2 BYTES    Y02134 45657502
*                                       OF REG 1                 Y02134 45665002
         SRA   R1,K16                   PROPOGATE SIGN BYTE      Y02134 45672502
         LTR   R1,R1                    IS IT NEGATIVE?          Y02134 45680002
         MODESET EXTKEY=SCHED           DSAB KEY                 Y02082 45682002
         BNL   OFN73880                 BRANCH IF NO             Y02134 45687502
         SR    R1,R1                    SET TO ZERO              Y02134 45695002
         B     OFN73900                 BRANCH TO INCREMENT      Y02134 45702502
OFN73880 EQU   *                        COUNT TOO LARGE?         Y02134 45710002
         C     R1,=F'32767'             COMPARE TO X'7FFF'       Y02134 45717502
         BNL   OFN73920                 DON'T INCREMENT IF HIGH  Y02134 45725002
*                                       OR EQUAL                 Y02134 45732502
OFN73900 EQU   *                        INCREMENT COUNT          Y02134 45740002
         LA    R1,K1(,R1)               INCREMENT DSAB OPEN      Y02134 45747502
*                                       COUNT BY ONE             Y02134 45749502
         SLL   R1,K16                   PUT IN HIGH 2 BYTES OF 1 Y02134 45755002
         SLDL  R0,K16                   R0 IS UPDATED FULLWORD   Y02134 45762502
         CS    RF,R0,DSABOPCT-K2        SWAP UPDATED VALUE IN    Y02134 45770002
         BNE   OFN73860                 TRY AGAIN IF ALTERED     Y02134 45777502
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 45779502
OFN73920 EQU   *                        INCREMENT OPEN COUNT IN  Y02134 45792502
*        SUBSEQUENT CONCATENATED DSABS                                  45800002
         L     RC,DSABFCHN              GET NEXT DSAB            Y02134 45807502
         LTR   RC,RC                    IS THERE A NEXT ONE      Y02134 45815002
         BZ    OFN73930                 GET OUT IF NOT           Y02134 45822502
         L     RTIOT,DSABTIOT           GET TIOT ENTRY ADDR      Y02134 45830002
         CLI   TIOEDDNM,C' '            IS THERE A DDNAME?       Y02134 45837502
         BE    OFN73820                 BRANCH IF NO             Y02134 45845002
OFN73930 EQU   *                        DSABS COMPLETE           Y02144 45855002
         OI    DXATOPEN,DXATDFIN        DSAB COUNT INCR FINISHED Y02144 45857002
         EJECT                                                          45864002
*                                                                Y02083 45866002
*****************************************************************Y02083 45868002
*                                                                Y02083 45870002
*  AT THIS POINT TEST TO SEE IF A CHECKPOINT DATA SET SECURITY   Y02083 45872002
*  INTERFACE EXISTS.  IF SO, UPDATE THE USER'S DCB TO THE        Y02083 45874002
*  STATUS OF THE PROTECTED DCB AND PLACE THE ADDRESS OF THE      Y02083 45876002
*  SECURITY-INTERFACE ERROR ROUTINE IN THE READ/WRITE AND        Y02083 45878002
*  CHECK ROUTINE ADDRESS SLOTS OF THE USER'S DCB.                Y02083 45880002
*  IF A SECURITY INTERFACE EXISTS, THERE ARE THREE VERSIONS OF   YM3806 45880402
*  THE DCB THAT EXIST: THE USER'S DCB IN USER'S KEY, THE COPIED  YM3806 45880802
*  DCB IN KEY 5, AND THE CHECKPOINT DCB REPRESENTING THE USER    YM3806 45881202
*  DCB IN KEY ZERO. AT THIS POINT THE TRUE USER'S DCB KEY OF     YM3806 45881702
*  USER WILL BE UPDATED FROM THE TRUE COPIED DCB KEY 5.          YM3806 45881902
*                                                                Y02083 45882002
         L     RC,DXDSAB                FETCH DSAB ADDRESS       YM1342 45884002
         USING DSAB,RC                  ADDRESS DSAB             Y02083 45886002
         TM    DSABFLG4,DSABCKVL        SECURE CHK PT VOL REF    YM3827 45886402
         BNO   OFN74000                 NO, CONT NORMAL PROC     YM3827 45886802
         TM    DSABFLG4,DSABCKSI        SECURITY INTERFACE EXIST Y02083 45888002
         BZ    OFN74000                 IF NOT, BRANCH           YM1441 45890002
         DROP  RC                       DSAB ADDRESSABILITY      Y02083 45892002
         L     RC,DXUDCBAD              GET KEY ZERO DCB ADDR    YM3806 45895002
         L     RDCB,DXPDCBAD            GET COPIED DCB ADDR      YM3806 45895402
         LA    RF,K4                    BACKUP PROT. DCB ADDR BY Y02083 45896002
         SR    RC,RF                    4 TO GET USER'S DCB ADDR Y02083 45898002
         MODESET EXTKEY=ZERO            GET IN KEY ZERO          YM3806 45898402
         L     RC,K0(,RC)               GET TRUE USER'S DCB ADDR Y02083 45899002
         ICM   RB,B'0111',DCBEXLSA-IHADCB(RC) SAVE USER'S EX LST YM3863 45899402
         AH    RDCB,DXUDCBPL            PNT PAST PROT. DCB PREFX Y02083 45900002
         AH    RC,DXUDCBPL              PNT PAST USER DCB PREFX  Y02083 45901002
         LH    RF,DXUDCBML              GET DCB MOVE LENGTH      Y02083 45902002
         BCTR  RF,R0                    ADJUST FOR MOVE INSTR    Y02083 45906002
         L     R1,DXTCBADR              FETCH USER TCB ADDRESS   Y02083 45906202
         USING TCB,R1                   ADDRESS TCB              Y02083 45906402
         MODESET KEYADDR=TCBPKF,WORKREG=1 USER KEY               Y02083 45907002
         DROP  R1                       TCB ADDRESSABILITY       Y02083 45907202
         EX    RF,OFNMOVER              UPDATE USER'S DCB        Y02083 45908002
         SH    RC,DXUDCBPL              RESTORE PT TO USER'S DCB YM3863 45908402
         STCM  RB,B'0111',DCBEXLSA-IHADCB(RC) RESTORE USER EX LSTYM2874 45908802
         MODESET EXTKEY=DATAMGT         BACK TO D/M KEY          Y02083 45909002
         SH    RC,DXUDCBPL              POINT TO USER DCB PREFX  Y02083 45911002
         IECRES LOAD,MODNM=OFN19SI,BRANCH=NO,PREFIX=WTGPREFX     YM1342 45911402
         L     R0,WTGMODEP              GET S/I ERROR RTN EPA    YM1342 45911802
         L     R1,DXTCBADR              FETCH USER TCB ADDRESS   Y02083 45912202
         USING TCB,R1                   ADDRESS TCB              Y02083 45912402
         MODESET KEYADDR=TCBPKF,WORKREG=1 USER KEY               Y02083 45913002
         DROP  R1                       TCB ADDRESSABILITY       Y02083 45913202
         STCM  R0,K7,DCBREAD+K1-IHADCB(RC) DROP INTO USER'S DCB  Y02083 45914002
         STCM  R0,K7,DCBCHECK+K1-IHADCB(RC) READ/WRITE AND CHECK Y02083 45916002
*                                       ROUTINE ADDRESS SLOTS    Y02083 45916202
         MODESET EXTKEY=DATAMGT         BACK TO D/M KEY          Y02083 45917002
         L     RDCB,DXPDCBAD            RESTORE COPIED DCB ADDR  Y02083 45918002
         B     OFN74000                 CONTINUE                 YM3011 45918402
*                                                                       45918802
*********************************************************************** 45919202
*                                                                       45919602
*    TEST FOR DEB EXTENSION.  IF ONE EXISTS, FREE IT.  IN ERROR  YM3011 45919702
*    CONDITION AT THIS POINT.  ERROR FROM THE EXECUTORS.         YM3011 45919802
*                                                                       45943102
OFN73980 EQU   *                        IF DEB EXT, FREE IT      YM3011 45953102
         L     R1,DXDEBXAD              GET DEB EXT ADDR         YM3011 45967002
         LTR   R1,R1                    DOES DEB EXT EXIST       YM3011 45977002
         BZ    OFN74000                 NO, CONTINUE             YM3011 45987002
*                                       YES, FREE DEB            YM3011 45989002
         USING DEBXTN,R1                                         YM3011 45989402
         LH    R0,DEBXLNGH              GET DEB EXT LENGTH       YM3011 45989802
         IECRES FREE,LV=(R0),A=(R1),PREFIX=NO,                         C45990202
               STM=(2,14,WTGPREFX)      FREE DEB EXTENSION       YM3011 45998002
         B     OFN74000                 CONTINUE                 YM3011 46000002
         EJECT                                                          46005802
OFN74000 EQU   *                        CLEAR WTG TABLE ENTRY    YM1342 46013602
         XC    WTGENTRY,WTGENTRY        CLEAR WTG TABLE ENTRY    YM1342 46036902
*                                                                Y02083 46060202
*****************************************************************Y02083 46083502
*                                                                Y02083 46106802
*  CHECK FOR END OF DCB WORKAREA FREEMAIN LOOP                   Y02083 46130102
*                                                                Y02083 46153402
OFN74500 EQU   *                        CONTINUE                 YM1342 46176702
         TM    PLISTOPT(RPARC),LASTNTRY CHECK FOR LAST DCB ENTRY        46200002
         LA    RPARC,K4(RPARC)          ADVANCE TO NEXT DCB ENTRY       46500021
         LA    RWTGC,L'WTGENTRY(RWTGC)  ADVANCE TO NEXT WTG ENTRY       46600021
         BZ    OFN72200                 NO, GO PROCESS NEXT DCB         46700002
*                                                                       48700021
*********************************************************************** 48800021
*                                                                       48900021
*  SEE IF THERE IS A DCB LEFT THAT HAS A DEFERRED ABEND PENDING.        49000021
*                                                                       49100021
         LR    RPARC,RPAR               ADDR OF FIRST DCB PARM ENTRY    49200021
         LA    RWTGC,WTGENTRY-WTG(,RWTG)  ADDR OF FIRST WTG ENTRY       49300021
         L     RC,WTGPREFX              GET WTG PREFIX PTR       Y02144 49350002
         L     RC,IECRRPRM-IECPREFX(,RC) GET RRPLIST ADDRESS     Y02144 49352002
         USING RRPLIST,RC                                        Y02144 49360002
*                                                                       49400021
OFN75400 EQU   *                        CHECK FURTHER FOR DELAYED ABEND 49500002
         L     RCORE,WTGCORE-K1         LOAD MAIN WORK AREA ADDR        49600021
         LA    RCORE,0(RCORE)           CLEAR HIGH ORDER BYTE           49700021
         LTR   RCORE,RCORE              TEST IF DCB HAS WORK AREA       49800021
         BZ    OFN75500                 BR IF NO, ADDR CLEARED   Y02144 49900002
         TM    JFCBMASK+K4,JFCMABND     DELAYED ABEND DCB?       Y02144 49950002
         BO    OFN75600                 YES, GO ISSUE ABEND      Y02144 49960002
         TM    DXATOPEN,DXATIGN         IGNORED ABEND DCB?       Y02144 49972002
         BZ    OFN76000                 NO, BRANCH TO PROCESSING Y02082 49980002
*                                       FOR UNLIKE CONCATENATION Y02082 49992002
         CLC   RRMLRTRY,RRFWORK         PRIOR IGNORED ABEND DCB  Y02144 49998402
         BNE   OFN75500                 YES,GO CHK IF LAST ENTRY Y02144 49999202
         STM   RPARC,RWTGC,RRMLRTRY     SAVE CURR DCB ENTRY ADDR Y02144 50013602
*                                       AND CURR WTG ENTRY ADDR  Y02144 50023602
*********************************************************************** 50025602
*                                                                       50027602
*  CHECK FOR END OF LOOP LOOKING FOR A DELAYED/IGNORED ABEND.           50027702
*                                                                       50027802
OFN75500 EQU   *                        END OF LOOP CHECK        Y02144 50028002
         TM    PLISTOPT(RPARC),LASTNTRY CHECK FOR LAST DCB ENTRY Y02144 50042402
         LA    RPARC,K4(RPARC)          ADVANCE TO NEXT DCB ENTRY       50056602
         LA    RWTGC,L'WTGENTRY(RWTGC)  ADVANCE TO NEXT WTG ENTRY       50056702
         BZ    OFN75400                 BR NO TO CHK FURTHER FOR Y02144 50066402
*                                       A DELAYED ABEND DCB      Y02144 50071202
         CLC   RRMLRTRY,RRFWORK         IGNORED ABEND PENDING    Y02144 50073202
         BE    OFN76400                 NO, BR TO FREE WTG TABLE Y02144 50075202
         LM    RPARC,RWTGC,RRMLRTRY     GET CURR DCB ENTRY ADDR  Y02144 50077202
*                                       AND CURR WTG ENTRY ADDR  Y02144 50079202
         LA    RCORE,OFN76400           GET MAINLINE RETRY ADDR  Y02144 50081202
         ST    RCORE,RRMLRTRY           SAVE MAINLINE RETRY ADDR Y02144 50081602
         XC    RRFWORK,RRFWORK          CLEAR RRPLIST WORK WORD  Y02144 50082002
         L     RCORE,WTGCORE-K1         LOAD MAIN WORK AREA ADDR Y02144 50083202
*                                                                       50085602
*********************************************************************** 50100021
*                                                                       50200021
*  DO A DELAYED/IGNORED ABEND ON THIS DCB.  RESTORE REGISTERS FIRST.    50300002
*                                                                       50400021
OFN75600 EQU   *                        DELAY/IGNORE ABEND       Y02144 50450002
         L     RDCB,DXUDCBAD            LOAD CURRENT DCB ADDR    YM5924 50500002
         LM    RTIOT,RET,DXREG9         RESTORE REGISTERS 9-14          50600021
         L     R0,DXREG0                RESTORE REGISTER 0              50700021
*                                                                       50800021
         SR    RF,RF                    LOAD PROBLEM DETERMINATION      50900021
         IC    RF,DXRETCOD              RETURN CODE IN REGISTER 15      51000021
*                                                                       51100021
         LH    R1,DXABCODE              LOAD THE ABEND CODE      Y02134 51107502
         SRL   R1,K4                    ALIGN RIGHT              Y02134 51117502
         ABEND (1),DUMP,,SYSTEM,        SYSTEM ABEND WITH A DUMP Y02080*51122502
               DUMPOPT=SNAPLIST                                         51172502
*                                                                       53300021
*********************************************************************** 53400021
*                                                                       53500021
*  SPECIAL PROCESSING FOR EOV CONCATENATION WITH UNLIKE ATTRIBUTES,     53600021
*  WHICH CAN ONLY OCCUR IF OPENING ONLY ONE DCB VIA BR FROM EOV. Y02082 53700002
*  THE LOGIC BEGINNING AT LABEL 'OFN76000' CAN ONLY BE ENTERED   Y02082 53750002
*  IF EOV CONCATENATION IS IN PROCESS.                           Y02082 53800002
*                                                                       54100021
OFN76000 EQU   *                        EOV CONATENATION PROCESSING     54200002
*                                                                       55300021
*  TURN OFF THE EOVC BIT FOR ALL EXCEPT A QSAM GET THAT WENT            55320021
*  THROUGH EOV (NOT FEOV).  THE QSAM GET SUBROUTINE WILL TEST IT AND    55340021
*  TURN IT OFF.  IT MUST BE OFF BEFORE THE DCB GOES TO EOV/FEOV AGAIN.  55360021
         L     RDCB,PLISTDCB(,RPAR)     LOAD DCB ADDR                   55400021
         TM    DCBMACRF,DCBMEXCP        IS THIS AN EXCP DCB      A40495 55410021
         BO    OFN76050                 BR IF YES, NEVER FEOV   SA58096 55420002
         TM    DCBCIND2,DCBC2FEO        CHECK FOR FEOV           A40495 55430021
         BZ    OFN76100                 BR IF NO                 A40495 55440021
         NI    DCBCIND2,X'FF'-DCBC2FEO  RESET FEOV BIT           A40495 55450021
OFN76050 EQU   *                        NEVER FEOV              SA58096 55462002
         NI    DCBOFLGS,ALLBITS-DCBOCON RESET EOVC BIT          SA58096 55464002
         L     RDCB,DXUDCBAD            LOAD USERS DCB          ZA30837 55464237
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY       ZA30837 55464437
         NI    DCBCIND2,X'FF'-DCBC2FEO  RESET FEOV BIT          ZA30837 55464637
         NI    DCBOFLGS,ALLBITS-DCBOCON RESET EOVC BIT          ZA30837 55464837
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY     ZA30837 55465037
         L     RDCB,DXPDCBAD            ADDRESS COPY DCB        ZA30837 55465237
         B     OFN76400                                         SA58096 55466002
OFN76100 EQU   *                                                 A40495 55470021
         TM    DCBMACRF,DCBMGET         CHECK FOR QSAM GET              55500021
         BO    OFN76200                 BR IF YES                       55600021
         TM    DCBMACRF,DCBMREAD        CHECK FOR BSAM READ             55640000
         BO    OFN76200                 BR IF YES                       55660000
OFN76150 EQU   *                        NOT FEOV                 A40495 55690002
         NI    DCBOFLGS,X'FF'-DCBOCON   RESET EOVC BIT                  55700021
         L     RDCB,DXUDCBAD            ADDRESS USER DCB         Y02082 55702002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 55704002
* REPEAT DCB FIELD CHANGES                                       Y02082 55706002
         NI    DCBOFLGS,X'FF'-DCBOCON   RESET EOVC BIT           Y02082 55706402
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 55708002
         L     RDCB,DXPDCBAD            ADDRESS COPY OF DCB      Y02082 55708402
         TM    DCBMACRF,DCBMEXCP        IS ACCESS METHOD EXCP    YM1342 55720002
         BO    OFN76200                 YES, EXCP                       55730002
         TM    DCBDSORG+K1,ACBDORGA     IS CONTROL BLOCK AN ACB         55740000
         BO    OFN76400                 YES, BR TO FREE WTG TABLE       55750000
OFN76200 EQU   *                        QSAM GET                        55800002
*                                                                       55900021
*  INTERCHANGE REGISTERS 0-8 FROM THE SVRB 0-15 GENERAL REGISTER        56000021
*  SAVE AREA AND THE USER'S SAVE AREA POINTED TO BY REGISTER 13.        56100021
*  NOTE THAT THE ACCESS METHOD ROUTINES SAVED REGISTERS 0-8 IN          56200021
*  THE REGISTER 13 SAVE AREA TWO FULL WORDS FURTHER AWAY THAN IS        56300021
*  NORMAL FOR A REGISTER 13 SAVE AREA.  THE EOV SVC ROUTINES            56400021
*  INTERCHANGED THESE REGISTERS SO THAT THE SVRB WOULD HAVE THE         56500021
*  USER'S REGISTERS FOR SYNCH EXITS TO THE USER DURING EOV,             56600021
*  CLOSE, AND OPEN.                                                     56700021
*                                                                       56800021
         L     RET,CVTPTR               GET CVT ADDR             Y02082 56850002
         L     RET,CVTTCBP-CVT(,RET)    GET ADDR TCB POINTERS    Y02082 56860002
         L     RET,K4(,RET)             GET CURRENT TCB ADDR     Y02082 56870002
         L     RET,TCBRBP-TCB(,RET)     GET ADDR OF SVRB         Y02082 56880002
         USING RBSECT,RET               DEFINE BASE TO SVRB      Y02082 56890002
*                                                                Y02082 56892002
         L     RD,RBGRS13               GET REG 13 SAVE AREA POINTER    56900021
         L     RF,WTGPREFX              GET PREFIX               Y02082 56910002
         STM   R0,RET,IECREGSV-IECPREFX(RF)    SAVE REGS ALTERED Y02082 56920002
*                                       BY SETLOCK               Y02082 56930002
         MODESET EXTKEY=SUPR            KEY ZERO FOR SETLOCK     Y02082 56940002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND, GET THE LOCAL    Y02082*56950002
               RELATED=(FREEMAIN,IFG0198N(OFN76300))             Y02082 56960002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 56970002
         MODESET KEYADDR=DXUKEY,WORKREG=12 USER KEY              Y02082 56980002
         OC    K28(K36,RD),K28(RD)      MAKE SURE IT'S STILL IN  Y02082 56990002
*                                       USER'S CORE              Y02082 56992002
         MODESET EXTKEY=SUPR            KEY ZERO FOR XC'S        Y02082 56994002
         XC    RBGRS0(K36),K28(RD)      INTERCHANGE REGISTERS 0-8       57000021
         XC    K28(K36,RD),RBGRS0       BY TRIPLE EXCLUSIVE ORING       57100021
         XC    RBGRS0(K36),K28(RD)      THE TWO FIELDS                  57200021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 57210002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS            Y02082 57220002
         MODESET EXTKEY=SUPR            KEY 0 FOR SETLOCK        Y02082 57230002
OFN76300 SETLOCK RELEASE,TYPE=LOCAL,    RELEASE LOCAL LOCK       Y02082*57240002
               RELATED=(FREEMAIN,IFG0198N(OFN76200))             Y02082 57250002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 57260002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 57270002
*                                                                       57400021
OFN76400 EQU   *                        FREE WTG TABLE                  57401002
         SR    R9,R9                    SAVE THE OPEN RETURN     YM0868 57510002
         IC    R9,WTGLNG                CODE                     Y02080 57520002
*                                                                       57666700
*********************************************************************** 57700021
*                                                                       57800021
*        FREEMAIN THE WHERE-TO-GO TABLE                                 57900021
*                                                                       58000021
         IECRES FREE,A=(RWTG),PREFIX=WTG FREEMAIN WTG TABLE CORE Y02080 58850002
         LR    RF,R9                    LOAD THE OPEN RETRN CODE Y02080 58950002
*                                                                Y02080 59150002
*        RETURN TO CALLER                                        Y02080 59200002
*                                                                Y02080 59250102
         IECRES EXIT                    RETURN                   Y02080 59260102
*                                                                Y02080 59290002
*                                                                       59300021
         DROP  RWTGC                                             Y02080 59400002
         EJECT                                                          59402002
*                                                                       59500021
*********************************************************************** 59600021
*                                                                       59700021
*        CONSTANTS                                                      59750000
*                                                                       59900021
OFNMOVER MVC   K0(K0,RC),K0(RDCB)       OBJECT OF EXECUTE INS.   Y02083 59902002
OFN7800K DC    H'8'                     LENGTH RESIDENT WK AREA PREFIX  60000021
OFN7740K DC    H'1'                                             YL03123 60002002
OFN7745K DC    A(X'FFFFFC')                                     YL03123 60003002
DDNINIT  DC    X'FF00000000000000'      INITIAL VALUE FOR DDNAME YM3011 60013002
*                                                                       60050002
SNAPLIST SNAP  SDATA=TRT,MF=L           READ ONLY SNAP LIST FOR  Y02144*60060002
                                        ABEND OPTION DUMPOPT     Y02144 60070002
*                                                                       60100021
         XCTLTABL ID=(OFN19SI,IGG019SI,OFN7760N,IGG019JD),       YM1342*60280002
               BRT=YES,LENGTH=                                   Y02080 60290002
*                                                                       60300021
         IECDSECS TCB,EXPAND=YES        EXPAND DSECTS HERE       Y02083 60400002
         END                                                            60600021
