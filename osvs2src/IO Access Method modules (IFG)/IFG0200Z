         TITLE 'IFG0200Z - STANDARD LABEL TAPE TRAILER PROCESSING'      00100021
IFG0200Z CSECT                                                          00400021
*********************************************************************** 00500021
*                                                                     * 00600021
*          VS2 RELEASE 037 CHANGES                                    * 00602037
*415652-415957,503500,503600                                   @ZA02210 00604037
*0000422000-424000                                             @ZA07585 00607037
*0000                                                          @ZA08326 00608037
*0000                                                          @ZA13576 00609037
*0000414917-415047-415147                                      @ZA19724 00609537
*C415026-415056,415116,415392,415925                           @ZA24994 00609737
*          VS2 RELEASE 03 DELETIONS                                   * 00610002
*0000185500                                                     ZA00016 00620002
*          VS1 RELEASE 02 DELETIONS                                   * 00650002
*0000                                                            XM1201 00660002
*                                                                     * 00700021
*          RELEASE 21 DELETIONS/CHANGES                               * 01200021
*                                                                A41662 01250021
* MODULE NAME = IFG0200Z                                              * 01260002
*                                                                     * 01270002
* DESCRIPTIVE NAME = STANDARD LABEL TAPE TRAILER PROCESSING           * 01280002
*                                                                     * 01290002
* COPYRIGHT = NONE                                                    * 01292002
*                                                                     * 01300021
* STATUS CHANGE LEVEL 000                                             * 01400021
*                                                                     * 01500021
* FUNCTION -                                                          * 01600021
*    THIS MODULE CONTAINS THE FUNCTION(S) OR PART(S) OF FUNCTION(S)-- * 01700021
*    CLOSE TAPE STANDARD TRAILER LABEL FUNCTION.                      * 01800021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)' FOR DETAILS.         * 01900021
*                                                                     * 02000021
* ENTRY POINTS -                                                      * 02100021
*         IFG0200Z - ENTRY POINT VIA AN XCTL FROM THE FOLLOWING--     * 02200021
*             INITIAL ENTRY--                                           02300021
*                IFG0200Y - PROCESS CLOSE TAPE STANDARD TRAILER LABEL   02400021
*                           FUNCTION.                                   02500021
*             SECOND ENTRY--                                            02600021
*                IFG0200P - CONTINUE PROCESSING CLOSE TAPE STANDARD     02700021
*                           TRAILER LABEL FUNCTION.                     02800021
*             THIRD ENTRY--                                             02900021
*                IFG0200P - CONTINUE PROCESSING CLOSE TAPE STANDARD     03000021
*                           TRAILER LABEL FUNCTION.                     03100021
*                                                                     * 03200021
* INPUT -                                                             * 03300021
*    ENTERED IN DATA MANAGEMENT KEY                              Y02082 03350002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 03400021
*                                                                     * 03500021
* OUTPUT -                                                            * 03600021
*    EXIT IN DATA MANAGEMENT KEY                                 Y02082 03650002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 03700021
*                                                                     * 03800021
* EXTERNAL REFERENCES -                                               * 03900021
*         IFG019RA - OPEN/CLOSE/EOV RESIDENT ROUTINE FOR XCTL AND     * 04000002
*                    WAIT.                                            * 04100021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 04200021
*                                                                     * 04300021
* EXITS, NORMAL -                                                     * 04400021
*    EXIT VIA THE RESIDENT ROUTINE XCTL TO THE FOLLOWING--            * 04500021
*         IFG0202A - PROCESS CLOSE TAPE STANDARD USER LABEL FUNCTION. * 04600021
*         IFG0202F - PROCESS CLOSE TAPE VOLUME STATISTICS FUNCTION.   * 04700021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 04800021
*                                                                     * 04900021
* EXITS, ERROR -                                                      * 05000021
*    EXIT IS TO THE PROBLEM DETERMINATION MODULE IFG0200P, IF AN      * 05100021
*    ABEND SITUATION OCCURS IN THIS MODULE.  REFER TO THE FOLLOWING   * 05200021
*    'FUNCTION PROLOG(S)'.                                            * 05300021
*                                                                     * 05400021
* TABLES/WORK AREAS -                                                 * 05500021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 05600021
*                                                                     * 05700021
* ATTRIBUTES -                                                        * 05800021
*    REENTRANT, REFRESHABLE, READ-ONLY, ENABLED, PRIVILEGED           * 05900021
*                                                                     * 06000021
* CHARACTER CODE DEPENDENCY -                                         * 06100021
*    CLASS ONE CHARACTER CODE DEPENDENCY - THE EBCDIC CHARACTER CODE  * 06200021
*    WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED IF A      * 06300021
*    DIFFERENT CHARACTER SET IS USED FOR EXECUTION.                   * 06400021
*                                                                     * 06500021
* NOTES -                                                             * 06600021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 06700021
*                                                                     * 06800021
*********************************************************************** 06900021
         EJECT                                                          07000021
         USING IHADCB,RDCB                                              07100021
         USING FORCORE,RCORE                                            07200021
         USING WTG,RWTG                 WHERE-TO-GO TABLE        Y02080 07250002
         USING TCB,RET                                                  07300021
         USING UCBOB,RUCB                                               07400021
         USING CVT,RD                                                   07500021
         USING TIOENTRY,RTIOT                                           07600021
         USING DEB,RDEB                                                 07700021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         07800021
         USING *,RBASE                                                  07900021
         EJECT                                                          08000021
*                                                                     * 08100021
*                          FUNCTION PROLOG                            * 08200021
*                                                                     * 08300021
*********************************************************************** 08400021
*                                                                     * 08500021
* FUNCTION NAME -                                                     * 08600021
*    CLOSE TAPE STANDARD TRAILER LABEL FUNCTION.                      * 08700021
*                                                                     * 08800021
* (STATUS) -                                                          * 08900021
*    NOT APPLICABLE                                                   * 09000021
*                                                                     * 09100021
* FUNCTION -                                                          * 09200021
*    WRITE A TAPE MARK FOLLOWING DATA SET.                            * 09300021
*    CONSTRUCT AND WRITE TRAILER LABEL 1 FROM INFORMATION IN THE JFCB,* 09400021
*    DCB, AND UCB.                                                    * 09500021
*    CONSTRUCT AND WRITE TRAILER LABEL 2 FROM INFORMATION IN THE JFCB * 09600021
*    AND TIOT.                                                        * 09700021
*    FOR ASCII TAPE, LABELS ARE TRANSLATED BEFORE WRITING.            * 09800021
*                                                                     * 09900021
* ENTRY POINTS -                                                      * 10000021
*    ENTERED FROM THE FOLLOWING--                                     * 10100021
*    CLOSE TAPE ACCESS METHOD EXECUTOR INTERFACE FUNCTION.            * 10200021
*                                                                     * 10300021
* INPUT -                                                             * 10400021
*    A POINTER TO EACH OF THE FOLLOWING--                             * 10500021
*       CURRENT PARAMETER LIST ENTRY.                                 * 10600021
*       DD ENTRY IN THE TIOT.                                         * 10700021
*       WTG TABLE.                                                    * 10800021
*       CURRENT WTG TABLE ENTRY.                                      * 10900021
*       DCB.                                                          * 11000021
*       CLOSE WORK AREA.                                              * 11100021
*       RESIDENT ROUTINE.                                             * 11200021
*       UCB.                                                          * 11300021
*       DEB.                                                          * 11400021
*                                                                     * 11500021
* OUTPUT -                                                            * 11600021
*    TRAILER LABELS 1 AND 2.                                          * 11700021
*                                                                     * 11800021
* EXTERNAL REFERENCES -                                               * 11900021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 12000021
*                                                                     * 12100021
* EXITS, NORMAL -                                                     * 12200021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 12300021
*    CLOSE TAPE STANDARD USER LABEL FUNCTION.                         * 12400021
*    CLOSE TAPE VOLUME STATISTICS FUNCTION.                           * 12500021
*                                                                     * 12600021
* EXITS, ERROR -                                                      * 12700021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 12800021
*    EXIT WITH THE FOLLOWING INTERNAL CODES--                         * 12900021
*       61 - 714 ABEND - ERROR IN WRITING TRAILER LABEL 1.            * 13000021
*       62 - 714 ABEND - ERROR IN WRITING TAPE MARK.                  * 13100021
*       63 - 714 ABEND - ERROR IN WRITING TRAILER LABEL 2.            * 13200021
*                                                                     * 13300021
* TABLES/WORK AREAS -                                                 * 13400021
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 13500021
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 13600021
*                                                                     * 13700021
* ATTRIBUTES -                                                        * 13800021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 13900021
*                                                                     * 14000021
* CHARACTER CODE DEPENDENCY -                                         * 14100021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 14200021
*                                                                     * 14300021
* NOTES -                                                             * 14400021
*    NOT APPLICABLE                                                   * 14500021
*                                                                     * 14600021
*********************************************************************** 14700021
         EJECT                                                          14800021
         B     CTA00100(RET)            USE BRANCH TABLE                14900021
CTA00100 EQU   *                                                        15000021
         B     CTA00200                 ENTRY FOR SL TRAILER PROC.      15100021
         B     CTA00300                 ENTRY FROM P.D. AFTER TM        15200021
         B     CTA01500                 ENTRY FROM P.D. AFTER TRL1      15300021
*                                                                       15400021
*****          WRITE TAPE MARK FOLLOWING USER'S DATA                    15500021
*                                                                       15600021
CTA00200 EQU   *                                                        15700021
         MVC   DXCCW1,AWTMCCWB          SET UP CCW TO WRITE TAPE MARK   15800021
         MVI   DXCCW1+K4,CCWCMDCH+CCWSILI  COMMAND CHAIN                15900021
         MVC   DXCCW2,AWTMCCWB          SET UP NEXT CCW                 16000021
         MVI   DXCCW2,CCWNOP            NOP OP CODE                     16100021
         BAL   RC,CTA02800              WRITE TAPE MARK BEFORE TRAILER  16200021
         LA    R0,CABD062               ERR-WRITE TAPE MARK             16300021
         LA    RET,K4                   SET UP FOR BRANCH TABLE         16400021
         BC    12,CTA02900              BRANCH IF I/O ERROR             16500021
         OI    DXATOUTA,DXATDATM        SHOW TM AFTER DATA       Y02144 16550002
         SPACE 1                                                        16600021
*                                                                       16700021
*****          CONSTRUCT END OF FILE LABEL 1                            16800021
*                                                                       16900021
CTA00300 EQU   *                                                        17000021
         MVC   FL1LABI,AEOF             SET FILE LABEL ID TO EOF        17100021
         MVI   FL1NO,CHAR1              SET FILE LABEL NUMBER TO 1      17200021
         SPACE 1                                                        17300021
*                                                                       17400021
*****          DETERMINE 17 LEAST SIGNIFICANT NON-BLANK                 17500021
*****          CHARACTERS IN DATA SET NAME IN JFCB                      17600021
*                                                                       17700021
         LA    RD,JFCBDSNM              STARTING ADDR OF JFCB TO REG    17800021
         LA    RF,JFCBDSNM+27           GET ADDR OF 1ST POSSIBLE A41662 17900021
CTA00400 EQU   *                        SIGNIFICANT CHARS        A41662 18000021
         CLI   K16(RF),BLANK            IS CHAR NOT BLANK        A41662 18100021
         BNE   CTA00500                 BR TO FINISH ROUTINE     A41662 18200021
         BCT   RF,CTA00400              DECR PTR AND BR TO TEST  A41662 18300021
CTA00500 EQU   *                        NEXT CHAR TO LEFT        A41662 18400021
         CLR   RF,RD                    IS LEFT PTR WITHIN FIELD A41662 18500021
         LA    RD,L'FL1ID(,RF)          POINT TO FIRST BLANK    ZA00016 18550002
         BNL   CTA00600                 BR TO BUILD DSNAME       A41662 18600021
         SPACE 1                                                        18900021
*                                                                       19000021
*****          PLACE DSNAME FROM JFCB INTO FILE IDENTIFICATION          19100021
*                                                                       19200021
         MVC   FL1ID,JFCBDSNM           INSERT FIRST 17 CHARACTERS      19300021
         B     CTA00700                 GO SET UP GENERATION NUMBER     19400021
CTA00600 EQU   *                                                        19500021
         MVC   FL1ID,0(RF)              USE LAST 17 LEAST SIG    A41662 19600021
*                                       CHARACTERS               A41662 19700021
         SPACE 1                                                        20000021
*                                                                       20100021
*****          GENERATION NUMBER AND VERSION NUMBER OF GENERATION       20200021
*                                                                       20300021
CTA00700 EQU   *                                                        20400021
         MVI   FL1GNO,BLANK             SET GENERATION NUM AND VERSION  20500021
         MVC   FL1GNO+K1(K44),FL1GNO    NUMBER OF GENERATION TO BLANKS  20600021
         CLI   JFCBELNM+K1,BLANK        IS THIS A GENERATION DATA SET-  20700021
         BE    CTA00800                 NO, GO SET UP FILE SERIAL NUM   20800021
         LA    RET,K8                   YES, SUBTRACT 8 FROM REGISTER   20900021
         SLR   RD,RET                   CONTAINING FIRST BLANK IN DSN   21000021
         MVC   FL1GNO,K1(RD)            RD NOW POINTS TO GENERATION NUM 21100021
         MVC   FL1VNG,K6(RD)            WHICH IS OF FORM GNNNNVNN       21200021
         SPACE 1                                                        21300021
*                                                                       21400021
*****          FILE SERIAL, VOLUME SEQUENCE, AND FILE SEQUENCE NOS.     21500021
*                                                                       21600021
CTA00800 EQU   *                                                        21700021
         MVC   FL1FILSR,UCBSQC          FILE SERIAL NUMBER              21800021
         LH    RC,JFCBVLSQ              VOL SEQ NUM OF FIRST VOL        21900021
         LTR   RC,RC                    IS IT ZERO-                     22000021
         BZ    CTA00900                 YES, VOL SEQ NO. IN DEB CORRECT 22100021
         BCTR  RC,0                     NO, SUBTRACT 1 AND ADD VOL SEQ  22200021
*                                       NO. IN THE DEB                  22300021
CTA00900 EQU   *                                                        22400021
         AH    RC,DEBTVLSQ              FIRST VOL OF DS IN DEB IS 1     22500021
         CVD   RC,DXCCW2                BINARY TO PACKED DECIMAL        22600021
         UNPK  FL1VOLSQ,DXCCW2          VOLUME SEQUENCE NUM IN EBCDIC   22700021
         OI    FL1VOLSQ+K3,ZONEOF       REMOVE SIGN BITS                22800021
         LH    RC,JFCBFLSQ              PICK UP FILE SEQUENCE NUMBER    22900021
         CVD   RC,DXCCW2                BINARY TO PACKED DECIMAL        23000021
         UNPK  FL1FILSQ,DXCCW2          FILE SEQUENCE NUM IN EBCDIC     23100021
         OI    FL1FILSQ+K3,ZONEOF       REMOVE SIGN BITS                23200021
         SPACE 1                                                        23300021
*                                                                       23400021
*****          CREATION DATE                                            23500021
*                                                                       23600021
         SR    RC,RC                    CLEAR WORK REGISTER             23700021
         IC    RC,JFCBCRDT              YEAR OF CREATION IS 1 BYTE JFCB 23800021
         CVD   RC,DXCCW2                CONVERT YEAR TO DECIMAL         23900021
*                                       LABEL TO BE OF FORM  BYYDDD     24000021
         UNPK  FL1CREDT+K1(K2),DXCCW2   PLACE YEAR IN EBCDIC INTO LABEL 24100021
         OI    FL1CREDT+K2,ZONEOF       REMOVE SIGN BITS                24200021
         IC    RC,JFCBCRDT+K1           PICK UP THE TWO CHARACTERS OF   24300021
         SLA   RC,K8                    THE DAY OF CREATION             24400021
         IC    RC,JFCBCRDT+K2           FROM THE JFCB                   24500021
         CVD   RC,DXCCW2                CONVERT DAY TO DECIMAL          24600021
         UNPK  FL1CREDT+K3(K3),DXCCW2   CREATION DAY IN EBCDIC TO LABEL 24700021
         OI    FL1CREDT+K5,ZONEOF       REMOVE SIGN BITS                24800021
         SPACE 1                                                        24900021
*                                                                       25000021
*****          EXPIRATION DATE                                          25100021
*                                                                       25200021
         SR    RC,RC                    CLEAR WORK REGISTER             25300021
         IC    RC,JFCBXPDT              PICK UP YEAR OF EXPIRATION      25400021
         CVD   RC,DXCCW2                CONVERT YEAR TO DECIMAL         25500021
*                                       LABEL FIELD IS BYYDDD           25600021
         UNPK  FL1EXPDT+K1(K2),DXCCW2   PLACE YEAR IN EBCDIC INTO LABEL 25700021
         OI    FL1EXPDT+K2,ZONEOF       REMOVE SIGN BITS                25800021
         LH    RC,JFCBXPDT+K1           PICK UP DAY OF EXPIRATION       25900021
         CVD   RC,DXCCW2                CONVERT DAY TO DECIMAL          26000021
         UNPK  FL1EXPDT+K3(K3),DXCCW2   DAY IN EBCDIC TO TRAILER LABEL  26100021
         OI    FL1EXPDT+K5,ZONEOF       REMOVE SIGN BITS                26200021
         SPACE 1                                                        26300021
*                                                                       26400021
*****          BLOCK COUNT                                              26500021
*                                                                       26600021
         L     RC,DCBBLKCT              BLOCK COUNT FROM THE DCB        26700021
         CVD   RC,DXCCW2                CONVERT BLOCK COUNT TO DECIMAL  26800021
         UNPK  FL1BLKCT,DXCCW2          BLOCK COUNT IN EBCDIC TO LABEL  26900021
         OI    FL1BLKCT+K5,ZONEOF       REMOVE SIGN BITS                27000021
         TM    DCBMACRF,DCBMEXCP        THE PROBLEM PROGRAM USING EXCP  27100021
         BC    12,CTA01000              NO, BLOCK COUNT IN DCB IS VALID 27200021
         TM    DCBMCRF1,DCBMDEV         TAPE DEPENDENT PORTION EXIST    27300021
         BC    5,CTA01000               YES, ASSUME BLOCK CT IN DCB OK  27400021
         MVI   FL1BLKCT,CHAR0           SET BLOCK CT IN LABEL TO ZEROS  27500021
         MVC   FL1BLKCT+K1(K5),FL1BLKCT  SINCE FIELD NOT PRESENT IN DCB 27600021
         SPACE 1                                                        27700021
*                                                                       27800021
*****          DATA SET SECURITY                                        27900021
*                                                                       28000021
CTA01000 EQU   *                                                        28100021
         MVI   FL1FSEC,FL1NOSEC         RESET DATA SET SECURITY IND.    28200021
         TM    JFCBIND2,JFCBSCTY        DOES THE JFCB SPECIFY SECURITY- 28300021
         BC    12,CTA01100              NO, DO NOT SET INDICATOR        28400021
         MVI   FL1FSEC,FL1SECTY         YES, SET DATA SET SECURITY IND  28500021
         TM    JFCBIND2,JFCBRWPW        DOES JFCB SPECIFY RWPW OPTION   28600021
         BNO   CTA01100                 BR IF NOT                       28700021
         MVI   FL1FSEC,FL1WRSEC         IND SECURITY IS FOR WRITE ONLY  28800021
         SPACE 1                                                        28900021
*                                                                       29000021
*****          SYSTEM CODE AND RESERVED FIELDS                          29100021
*                                                                       29200021
CTA01100 EQU   *                                                        29300021
         SPACE 1                                                        29400021
*                                                                       29500021
*****          TRANSLATE ANSI LABEL DATA BEFORE WRITING LABEL           29600021
*                                                                       29700021
         TM    UCBSTAB,UCBBSTR          TEST FOR ANSI LABELS-           29800021
         BNO   CTA01300                 BR IF NOT- BYPASS TRANSLATION   29900021
         TM    JFCBIND2,JFCBSCTY        DOES JFCB SPECIFY SECURITY-     30000021
         BO    CTA01200                 BR IF YES TO SET SYSTEM CODE    30100021
         MVI   FL1FSEC,BLANK            NO, ACCESS. BYTE TO BLANK       30200021
CTA01200 EQU   *                                                        30300021
         MVC   FL1SYSCD(K5),ASYSCD      MOVE IN NEW SYSTEM CODE         30400021
         BAL   RC,CTA02750              TRANSLATE LABEL DATA            30500021
         B     CTA01400                 BR TO WRITE LABEL               30600021
CTA01300 EQU   *                        ANSI                            30700021
         MVC   FL1SYSCD,VSSYSC          INSERT VS SYSTEM CODE    XM1201 30870002
*                                       INTO TRAILER             XM1201 30880002
         SPACE 1                                                        30900021
CTA01400 EQU   *                                                        31000021
*                                                                       31100021
*****          SET UP CHANNEL PROGRAM TO WRITE LABEL                    31200021
*                                                                       31300021
         LA    RC,DXLBL                 PLACE ADDRESS OF LABEL AREA TO  31400021
         ST    RC,DXCCW1                OBTAINED CORE INTO CCW          31500021
         MVI   DXCCW1,CCWWRTAP          DITTO FOR WRITE OPERATION CODE  31600021
         MVC   DXCCW1+K4(K4),AWTMCCWB+K4  SPECIFY SILI FLAG, LENGTH 80  31700021
*                                                                       31800021
*****          WRITE END-OF-FILE LABEL 1                                31900021
*                                                                       32000021
         BAL   RC,CTA02800              BR TO WRITE TRAILER LABEL 1     32100021
         LA    R0,CABD061               ERR- WRITE TRL1                 32200021
         LA    RET,K8                   SET UP FOR BRANCH TABLE         32300021
         BC    12,CTA02900              BRANCH IF I/O ERROR             32400021
         OI    DXATOUTA,DXATTRL1        SHOW TRL1 WRITTEN        Y02144 32450002
         SPACE 1                                                        32500021
*                                                                       32600021
*****          PREPARE DATA SET TRAILER LABEL 2                         32700021
*                                                                       32800021
CTA01500 EQU   *                                                        32900021
         MVI   FL1NO,CHAR2              SET FILE LABEL IDENTIFIER TO 2  33000021
         MVI   FL2TRTCH,BLANK           SET PART OF LABEL TO            33100021
         MVC   FL2TRTCH+K1(K45),FL2TRTCH  BLANKS - 47 CHARACTERS        33200021
         SPACE 1                                                        33250002
*                                                                Y02083 33260002
*****          SET CHECKPOINT D/S INDICATOR IF APPROPRIATE       Y02083 33270002
*                                                                Y02083 33280002
         L     RC,DXDSAB                FETCH DSAB ADDRESS       Y02083 33290002
         USING DSAB,RC                  ADDRESS DSAB             Y02083 33292002
         TM    DSABFLG4,DSABCKDS        Q - CHECKPOINT D/S       Y02083 33294002
         BZ    CTA01600                 IF NOT, BR               Y02083 33296002
         DROP  RC                       DSAB ADDRESSABILITY      Y02083 33298002
         MVI   FL2DSIND,FL2CKDS         SET CHKPT LABEL FLAG     Y02083 33298402
CTA01600 EQU   *                                                 YO2083 33298802
         SPACE 1                                                        33300021
*                                                                       33400021
*****          BLOCKING ATTRIBUTE                                       33500021
*                                                                       33600021
         SR    RC,RC                    CLEAR WORK REGISTER             33700021
         IC    RC,JFCRECFM              RECORD FORMAT FROM JFCB         33800021
         SRL   RC,3                     BITS 0,1 CONTAIN BLK ATTRIB     33900021
         STC   RC,FL2BLKA               TO PREPARE FOR TRANSLATE, ZERO  34000021
         NI    FL2BLKA,X'03'            ALL BUT BITS 0,1                34100021
         TR    FL2BLKA,ABLKA            TRANSLATE TO S,B,R, OR BLANK    34200021
         SPACE 1                                                        34300021
*                                                                       34400021
*****          RECORD FORMAT                                            34500021
*                                                                       34600021
         SRL   RC,3                     BITS 0,1 CONTAIN RECORD FORMAT  34700021
         STC   RC,FL2RECFM              F = BIT 0  V = BIT 1  U = 0,1   34800021
*              DEFAULT TO RECFM=D IF NEITHER BIT ON                     34900021
         TR    FL2RECFM,ARECFM          TRANSLATE TO D,V,F OR U         35000021
         SPACE 1                                                        35100021
*                                                                       35200021
*****          BLOCK SIZE AND LOGICAL RECORD LENGTH                     35300021
*                                                                       35400021
         LH    RC,JFCBLKSI              PICK UP BLOCK LENGTH FROM JFCB  35500021
         CVD   RC,DXCCW2                CONVERT BLOCK LENGTH TO DECIMAL 35600021
         UNPK  FL2BLKL,DXCCW2           BLOCK LENGTH IN EBCDIC TO LABEL 35700021
         OI    FL2BLKL+K4,ZONEOF        REMOVE SIGN BITS                35800021
         LH    RC,JFCLRECL              PICK UP LOGICAL RECORD LENGTH   35900021
         CH    RC,AGRTR32K              IS LRECL GREATER THAN 32K-      36000021
         BE    CTA01800                 BR IF YES TO SET LABEL TO 9'S   36100021
         CVD   RC,DXCCW2                CONVERT LOGICAL RECORD LENGTH   36200021
         UNPK  FL2LRECL,DXCCW2          LOG RECORD LENGTH IN EBCDIC     36300021
         OI    FL2LRECL+K4,ZONEOF       REMOVE SIGN BITS                36400021
         B     CTA01900                 BR TO CONTINUE MERGE            36500021
CTA01800 EQU   *                                                        36600021
         MVI   FL2LRECL,X'F9'           SET LRECL TO 9'S INDICATING     36700021
         MVC   FL2LRECL+K1(K4),FL2LRECL  GREATER THAN 32K               36800021
CTA01900 EQU   *                                                        36900002
         MVI   FL2DEN,CHAR4             SET DENSITY TO FOUR       99223 36950002
         TM    JFCDEN,DEN6250           IS DENSITY 6250 BPI       99223 36960002
         BO    CTA02000                 YES- BRANCH               99223 36970002
         SR    RC,RC                    CLEAR WORK REGISTER             37000021
         IC    RC,JFCDEN                PICK UP DENSITY FROM THE JFCB   37100021
         SRL   RC,6                     BITS 0 AND 1 CONTAIN DENSITY    37200021
         STC   RC,FL2DEN                00=200 01=556 02=800 03=1600BPI 37300021
         OI    FL2DEN,DENSET            SET DENSITY TO EBCDIC 0,1,2,3   37400021
CTA02000 EQU   *                                                  99223 37450002
         MVI   FL2FILP,C'0'             SET FILE POSITION TO ZERO       37500021
         CLC   UCBVOLI,JFCBVOLS         IS THIS THE 1ST VOL-            37600021
         BE    CTA02100                 YES, FILE POSITION IND S/B ZERO 37700021
         MVI   FL2FILP,FILPOS1          NO, SET FILE POSITION IND TO 1  37800021
CTA02100 EQU   *                                                        37900021
         USING TIOT,RC                                                  38000021
         L     RD,CVTPTR                VECTOR TABLE ADDRESS            38100021
         L     RC,CVTTCBP               POINTER TO TCB                  38200021
         L     RC,K4(,RC)               TCB ADDRESS                     38300021
         L     RC,TCBTIO-TCB(,RC)       TIOT ADDRESS                    38400021
         MVC   FL2JOBD,TIOCNJOB         PLACE JOB/STEP IDENTIFICATION   38500021
         MVC   FL2STEPD,TIOCSTEP        FROM THE TIOT INTO THE LABEL    38600021
         DROP  RC                                                       38700021
         MVI   FL2JSSP,SLASH            INSERT SLASH                    38800021
         SPACE 1                                                        38900021
*                                                                       39000021
*****          TAPE RECORDING TECHNIQUE                                 39100021
*                                                                       39200021
         SR    RC,RC                    CLEAR WORK REGISTER             39300021
         IC    RC,JFCTRTCH              PICK UP TAPE RECORDING TECH     39400021
         SRL   RC,4                     13=C , 2B=ET, 0=BLANK           39500021
         STC   RC,FL2TRTCH              PLACE FIRST CHARACTER OF TRTCH  39600021
         TR    FL2TRTCH(K1),ATRTCH      INTO LABEL AS BLANK, C, E, OR T 39700021
         CLI   JFCTRTCH,JFCTREV         IS IT BOTH EVEN PARITY AND TRAN 39800021
         BC    6,CTA02200               NO, THE SECOND CHAR S/B BLANK   39900021
         MVI   FL2TRTCH+K1,CHART        TAPE RECORD TECH SHOULD BE ET   40000021
         SPACE 1                                                        40100021
*                                                                       40200021
*****          CARRIAGE CONTROL CHARACTER SET                           40300021
*                                                                       40400021
CTA02200 EQU   *                                                        40500021
         TM    JFCRECFM,JFCMAC          JFCB SPECIFY MACHINE CODE CNTRL 40600021
         BC    12,CTA02300              NO, SEE IF ASA CONTROL CHAR     40700021
         MVI   FL2CNTRL,CHARM           SET MACHINE CODE CONTROL CHAR   40800021
CTA02300 EQU   *                                                        40900021
         TM    JFCRECFM,JFCASA          JFCB SPECIFY ASA CNTRL CHAR SET 41000021
         BC    12,CTA02400              NO, DO NOT SET CARRIAGE CNTRL   41100021
         MVI   FL2CNTRL,CHARA           YES, SET CONTROL CHAR TO ASA    41200021
CTA02400 EQU   *                                                        41300021
         TM    UCBSTAB,UCBBSTR          TEST FOR ANSI LABEL-            41400021
         BO    CTA02450                 YES, SKIP TAPE ID               41410002
*                                                                       41450002
*****          SET UP TAPE DRIVE ID FOR 3400 SERIES STANDARD LABELS     41460002
*                                                                       41470002
CTA01950 EQU   *                                                  99223 41480002
         CLI   UCBTBYT4,UCB3400         TEST FOR 3400 DRIVE      YM1491 41494002
         BNE   CTA02500                 NO - BRANCH              YM1491 41496002
         L     RC,UCBEXTPT              GET ADDR OF COMMON EXT   Y02146 41496402
         CLI   UCBSNSCT-UCBCMEXT(RC),K24  IS IT MODEL A          Y02146 41496802
         BNE   CTA02500                 NO                        99223 41498402
         USING UCBMT,RC                 SET UP ADDRESSABILITY FOR 99223 41498802
*                                       THE UCB EXTENSION         99223 41499202
         L     RC,UCBXTN                GET EXTENSION ADDRESS    99223  41499637
         LH    RC,UCBCTD                PUT ID OF CREATING     @ZA24994 41502637
         N     RC,SNMASK                DRIVE INTO RET         @ZA24994 41505637
         DROP  RC                                                 99223 41508637
         CVD   RC,DXCCW2                CONVERT ID             @ZA24994 41511637
         UNPK  FL2ID,DXCCW2             PUT ID IN LABEL        @ZA13576 41527737
         OI    FL2ID+K4,ZONEOF          STRIP SIGN             @ZA13576 41529737
* GET THE MODEL NUMBER,POSITION IT AT BITS 12-15 IN            @ZA08326 41533237
* REG C, AND ADD IT TO THE DEVICE SERIAL NUMBER.               @ZA08326 41536237
         LA    RC,DXCCW2                GET AREA ADR.          @ZA24994 41539237
         ST    RC,DXCCW1                PUT AREA ADR. IN CCW   @ZA02210 41542237
         MVC   DXCCW1+K4(K4),CCW0ZK07   SILI FLAG. 7 SNS BYTES @ZA02210 41545237
         MVI   DXCCW1,CCWSENSE          SNS CMD CODE IN CCW    @ZA02210 41548237
         BAL   RC,CTA02800              GO ISSUE SENSE CMD     @ZA02210 41551237
         BZ    CTA02900                 BRANCH IF I-O ERROR    @ZA02210 41554237
         IC    RC,DXCCW2+K6             GET SIXTH SENSE BYTE   @ZA24994 41592537
         SLL   RC,K28                   CLEAR RC EXCEPT FOR    @ZA08326 41592737
         SRL   RC,K28                   HALF BYTE MOD NO.      @ZA13576 41593137
         IC    RC,CHARTBL(RC)           GET CHAR FROM TABLE    @ZA13576 41593537
         STC   RC,FL2ID                 PLACE MOD NO INTO LBL  @ZA13576 41593937
*****          RESET CCW TO WRITE LABEL                        @ZA08326 41594337
         LA    RC,DXLBL                 GET AREA ADDRESS       @ZA02210 41594537
         ST    RC,DXCCW1                PUT AREA ADR IN CCW    @ZA02210 41594937
         MVI   DXCCW1,CCWWRTAP          DITTO FOR WRT OP CODE  @ZA02210 41595337
         MVC   DXCCW1+K4(K4),AWTMCCWB+K4  SILI FLAG, LENGTH 80 @ZA02210 41595737
         B     CTA02500                 BR IF NOT TO WRITE LABEL        41596337
         SPACE 1                                                        41600021
*                                                                       41700021
*****          BUFFER ALIGNMENT                                         41800021
*                                                                       41900021
CTA02450 EQU   *                                                  99223 41950002
         MVC   DXCCW3(K1),JFCBUFOF      GET BUFFER OFFSET LENGTH        42000021
         NI    DXCCW3,X'FF'-JFCBFOFL    TURN OFF BIT 0                  42100021
         SR    RC,RC                    CLEAR WORK REGISTER    @ZA07585 42200037
         IC    RC,DXCCW3                PLACE BUF LNGTH IN REG @ZA07585 42300037
         CVD   RC,DXCCW3                CONV BUFF LNG TO DECIM @ZA07585 42400037
         UNPK  FL2BUFOF,DXCCW3          UNPACK AND PLACE INTO LABEL     42500021
         OI    FL2BUFOF+K1,ZONEOF       RESET SIGN BITS                 42600021
         MVC   FL1LABI,AEOF             MOVE IN E-O-F CONSTANT          42700021
         SPACE 1                                                        42800021
*                                                                       42900021
*****          TRANSLATE ANSI DATA BEFORE WRITING LABEL                 43000021
*                                                                       43100021
         BAL   RC,CTA02750              TRANSLATE LABEL DATA            43200021
         SPACE 1                                                        43300021
*                                                                       43400021
*****          WRITE END OF FILE LABEL 2                                43500021
*                                                                       43600021
CTA02500 EQU   *                                                        43700021
         EXCP  DXIOB                    GO WRITE FILE LABEL 2           43800021
         TM    JFCBTSDM,JFCSDS          IS DATA SET SYSOUT              43900021
         BO    CTA02700                 YES, DO NOT PROCESS USER LA     44000021
         TM    JFCBLTYP,JFCBUL          WAS SUL SPECIFIED-              44100021
         BNO   CTA02700                 NO, DO NOT PROCESS USER LABELS  44200021
         SR    RET,RET                  SET UP FOR BRANCH TABLE         44300021
         LA    RF,ULTAMOD               UL MOD ID                       44400021
CTA02600 EQU   *                                                        44500021
         IECRES LOAD,MODID=(RF),BRCODE=(RET),BRANCH=QUEUED       Y02080 44650002
*                                    XCTL TO ULTAMOD OR VOLDPMOD YO2080 44660002
CTA02700 EQU   *                                                        44700021
         LA    RF,VOLDPMOD              VOL DISP MOD ID                 44800021
         LA    RET,K8                   SET UP FOR BRANCH TABLE         44900021
         B     CTA02600                 BRANCH TO XCTL                  45000021
         EJECT                                                          45100021
CTA02750 EQU   *                                                        45200021
         XLATE DXLBL,K80,TO=A           TRANSLATE LABEL DATA            45300021
         BR    RC                       RETURN TO CALLER                45400021
         EJECT                                                          45500021
         SPACE 1                                                        45600021
**********                MACROS                             ********** 45700021
*                                                                     * 45800021
         SPACE 1                                                        45900021
*            CLOSED SUBROUTINE TO ISSUE I/O OPERATIONS                  46000021
*            AND TEST FOR UNIT EXCEPTION AND I/O ERROR                  46100021
*  ( IT IS ASSUMED THAT ALL CONTROL BLOCKS HAVE ALREADY BEEN SET UP )   46200021
*                                                                       46300021
*        ENTRY TO THE ROUTINE IS AS FOLLOWS-                            46400021
*           BAL   RC,CTA02800                                           46500021
*        RETURN TO THE CALLING ROUTINE TAKES PLACE AS FOLLOWS-          46600021
*           BO    12(RC)           RETURN IF UNIT EXCEPTION             46700021
*        OR                                                             46800021
*           BR    RC               RETURN IF NO UNIT EXCEPTION          46900021
*                                                                       47000021
*        THE CONDITION CODE WILL HAVE BEEN SET TO '1' IF AN I/O         47100021
*        ERROR HAS OCCURRED.                                            47200021
         SPACE 1                                                        47300021
CTA02800 EQU   *                                                        47400021
         EXCP  DXIOB                    INITIATE I/O OPERATION          47500021
         IECRES WAIT                    WAIT FOR I/O COMPLETION         47600021
         TM    IOBSTAT0,CSWUNITX        TEST FOR UNIT EXCEPTION CAUSED  47700021
         BO    K12(RC)                  END-OF-TAPE - BR IF YES         47800021
         TM    DXECB,ECBNOERR           TEST FOR UNUSUAL I/O CONDITION  47900021
         BR    RC                       RETURN TO CALLER OF SUBROUTINE  48000021
         SPACE 1                                                        48100021
*                                                                     * 48200021
**********                                                   ********** 48300021
         EJECT                                                          48400021
         SPACE 1                                                        48500021
*********************************************************************** 48600021
*                                                                     * 48700021
*                        ERROR PROCESSING                             * 48800021
*                                                                     * 48900021
*********************************************************************** 49000021
         SPACE 1                                                        49100021
CTA02900 EQU   *                                                        49200021
         DMABCOND (0),PDMOD             ABEND MACRO                     49300021
         EJECT                                                          49400021
         SPACE 1                                                        49500021
*********************************************************************** 49600021
*                                                                     * 49700021
*                       CONSTANTS                                     * 49800021
*                                                                     * 49900021
*********************************************************************** 50000021
         SPACE 1                                                        50100021
AWTMCCWB DC    X'1F00000020000050'      WRITE TAPE MARK;COUNT FOR WRITE 50200021
AEOF     DC    C'EOF'                   CHARACTERS EOF                  50300021
CHARTBL  DC    C'0003570000046800'      MOD. CODE TO CHAR TABLE@ZA19724 50350037
         DS    0F                                                       50351037
SNMASK   DC    X'0000FFFF'              TAPE MODEL NUMBER      @ZA08326 50353037
CCW0ZK07 DC    X'20000007'              CCW LENGTH             @ZA02210 50360037
ASYSCD   DC    C'OS360'                 ANSI SYSTEM CODE                50400021
VSSYSC   DC    C'IBM OS/VS 370'         VS SYSTEM CODE                  50460002
ARECFM   EQU   *                        RECFM TRANSLATE TABLE           50500021
         DC    C'DVFU'                  DEC,VARIABLE,FIXED,UNKNOWN      50600021
ATRTCH   DC    C' CET'                  CONVERSION,EVEN,TRANSLATE       50700021
ABLKA    DC    C' SBR'                  BLK ATTRB TRANSLATE TABLE       50800021
         DS    0H                                                       50900021
AGRTR32K DC    X'8000'                  VALUE IN LABEL WHEN LRECLGT 32K 51000021
         LTORG                                                          51100021
         XCTLTABL ID=(PDMOD,0P,ULTAMOD,2A,VOLDPMOD,2F),SVC=020,  Y02080X51200002
               BRT=YES,LENGTH=2040,PATCH=100                     Y02080 51250037
FL2CKDS  EQU   C'C'                TAPE CHKPT D/S INDICATOR      Y02083 51260002
         IECDSECS CVT,TCB,TIOT,DCB,DEB,UCB,DSAB,MAIN,WTG,        Y02083*51300002
               EXPAND=YES                                        Y02083 51350002
         IECEQU                                                         51400021
         END                                                            51500021
