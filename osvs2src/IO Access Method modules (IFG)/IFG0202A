         TITLE 'IFG0202A - USER LABEL TAPE TRAILER PROCESSING'          00100021
IFG0202A CSECT                                                          00400021
*********************************************************************** 00500021
*                                                                     * 00600021
*                                                                     * 00700021
*          RELEASE 21 DELETIONS/CHANGES                               * 01200021
*0000431000                                                     SA55619 01250000
*                                                                     * 01300021
* MODULE NAME = IFG0202A                                              * 01350002
*                                                                     * 01360002
* DESCRIPTIVE NAME = USER LABEL TAPE TRAILER PROCESSING               * 01370002
*                                                                     * 01380002
* COPYRIGHT = NONE                                                    * 01390002
*                                                                     * 01392002
* STATUS CHANGE LEVEL 000                                             * 01400021
*                                                                     * 01500021
* FUNCTION -                                                          * 01600021
*    THIS MODULE CONTAINS THE FUNCTION(S) OR PART(S) OF FUNCTION(S)-- * 01700021
*    CLOSE TAPE STANDARD USER LABEL FUNCTION.                         * 01800021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)' FOR DETAILS.         * 01900021
*                                                                     * 02000021
* ENTRY POINTS -                                                      * 02100021
*         IFG0202A - ENTRY POINT VIA AN XCTL FROM THE FOLLOWING--     * 02200021
*             INITIAL ENTRY--                                         * 02300021
*                IFG0200Z - PROCESS CLOSE TAPE STANDARD USER LABEL    * 02400021
*                           FUNCTION.                                 * 02500021
*             SECOND ENTRY--                                          * 02600021
*                IFG0200Y - PROCESS CLOSE TAPE STANDARD USER LABEL    * 02700021
*                           FUNCTION.                                 * 02800021
*             THIRD ENTRY--                                           * 02900021
*                IFG0200P - CONTINUE PROCESSING CLOSE TAPE STANDARD   * 03000021
*                           USER LABEL FUNCTION.                      * 03100021
*                                                                     * 03200021
* INPUT -                                                             * 03300021
*    ENTERED IN DATA MANAGEMENT KEY                              Y02082 03350002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 03400021
*                                                                     * 03500021
* OUTPUT -                                                            * 03600021
*    EXIT IN DATA MANAGEMENT KEY                                 Y02082 03650002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 03700021
*                                                                     * 03800021
* EXTERNAL REFERENCES -                                               * 03900021
*         IFG019RA - OPEN/CLOSE/EOV RESIDENT ROUTINE FOR XCTL AND     * 04000002
*                    WAIT.                                            * 04100021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 04200021
*                                                                     * 04300021
* EXITS, NORMAL -                                                     * 04400021
*    EXIT VIA THE RESIDENT ROUTINE XCTL TO THE FOLLOWING--            * 04500021
*         IFG0202F - PROCESS CLOSE TAPE VOLUME STATISTICS FUNCTION.   * 04600021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 04700021
*                                                                     * 04800021
* EXITS, ERROR -                                                      * 04900021
*    EXIT IS TO THE PROBLEM DETERMINATION MODULE IFG0200P, IF AN      * 05000021
*    ABEND SITUATION OCCURS IN THIS MODULE.  REFER TO THE FOLLOWING   * 05100021
*    'FUNCTION PROLOG(S)'.                                            * 05200021
*                                                                     * 05300021
* TABLES/WORK AREAS -                                                 * 05400021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 05500021
*                                                                     * 05600021
* ATTRIBUTES -                                                        * 05700021
*    REENTRANT, REFRESHABLE, READ-ONLY, ENABLED, PRIVILEGED           * 05800021
*                                                                     * 05900021
* CHARACTER CODE DEPENDENCY -                                         * 06000021
*    CLASS ONE CHARACTER CODE DEPENDENCY - THE EBCDIC CHARACTER CODE  * 06100021
*    WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED IF A      * 06200021
*    DIFFERENT CHARACTER SET IS USED FOR EXECUTION.                   * 06300021
*                                                                     * 06400021
* NOTES -                                                             * 06500021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 06600021
*                                                                     * 06700021
*********************************************************************** 06800021
         EJECT                                                          06900021
         USING IHADCB,RDCB                                              07000021
         USING FORCORE,RCORE                                            07100021
         USING WTG,RWTG                 WHERE-TO-GO TABLE        Y02080 07150002
         USING TCB,RET                                                  07200021
         USING CVT,RD                                                   07300021
         USING DEB,RDEB                                                 07400021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         07500021
         USING *,RBASE                                                  07600021
         EJECT                                                          07700021
*                                                                     * 07800021
*                          FUNCTION PROLOG                            * 07900021
*                                                                     * 08000021
*********************************************************************** 08100021
*                                                                     * 08200021
* FUNCTION NAME -                                                     * 08300021
*    CLOSE TAPE STANDARD USER LABEL FUNCTION.                         * 08400021
*                                                                     * 08500021
* (STATUS) -                                                          * 08600021
*    NOT APPLICABLE                                                   * 08700021
*                                                                     * 08800021
* FUNCTION -                                                          * 10950000
*    DETERMINE IF USER LABEL PROCESSING IS REQUIRED.                  * 10960000
*    TWO USER LABEL WORK AREAS ARE OBTAINED - DESCRIBED BELOW:   Y02082 10961502
*      THE FIRST AREA IS GOTTEN IN KEY 5 FOR CLOSE (152 BYTES)   Y02082 10963002
*      1) 72 BYTE WORK AREA                                      Y02082 10964502
*      2) 80 BYTE LABEL BUFFER                                   Y02082 10966002
*      THE SECOND AREA IS GOTTEN IN THE USER'S KEY TO BE UPDATED Y02082 10967502
*      BY THE USER (96 BYTES)                                    Y02082 10970502
*      1) 80 BYTE LABEL BUFFER                                   Y02082 10972002
*      2) 16 BYTE PARAMETER LIST                                 Y02082 10973502
*                                                                Y02082 10975002
*    IF INPUT HEADER OR TRAILER ARE REQUESTED, THIS FUNCTION READS    * 10994000
*    THE USER LABELS AND PASSES THEM IN LABEL BUFFER TO APPROPRIATE   * 10996000
*    USER EXIT VIA IECRES=UEXIT. UPON RETURN, A CONDITION CODE   Y02082 10998002
*    IS EXAMINED. IF 4, CONTINUE TO READ LABELS, IF 0, EXIT.          * 10998400
*    IF OUTPUT HEADER OR TRAILER ARE REQUESTED, THIS FUNCTION FIRST   * 10998800
*    EXITS TO APPROPRIATE USER EXIT TO FORMAT USER LABELS AND UPON    * 10999202
*    RETURN, REACTS ACCORDING TO THE CODE RETURNED BY THE USER -      * 10999600
*    0 - DO NOT WRITE LABEL, DISCONTINUE USER LABEL PROCESSING (I.E.  * 10999700
*        RETURN TO CALLER OF THIS ROUTINE),                           * 10999800
*    4 - WRITE LABEL, THEN DISCONTINUE UL PROCESSING,                 * 10999900
*    8 - WRITE LABEL, AND IF LESS THAN 8 LABELS HAVE BEEN CREATED,    * 11033200
*        RETURN TO USER. IF 8 LABELS HAVE BEEN CREATED, UL PROCESSING * 11043200
*        IS ENDED.                                                    * 11053200
*    FOR ASCII TAPE, LABELS ARE TRANSLATED BEFORE WRITING.            * 11063200
*                                                                     * 11065200
* ENTRY POINTS -                                                      * 11066700
*    ENTERED FROM THE FOLLOWING--                                     * 11100021
*    CLOSE TAPE ACCESS METHOD EXECUTOR INTERFACE FUNCTION.            * 11200021
*    CLOSE TAPE STANDARD TRAILER LABEL FUNCTION.                      * 11300021
*                                                                     * 11400021
* INPUT -                                                             * 11500021
*    A POINTER TO EACH OF THE FOLLOWING--                             * 11600021
*       CURRENT PARAMETER LIST ENTRY.                                 * 11700021
*       DD ENTRY IN THE TIOT.                                         * 11800021
*       WTG TABLE.                                                    * 11900021
*       CURRENT WTG TABLE ENTRY.                                      * 12000021
*       DCB.                                                          * 12100021
*       CLOSE WORK AREA.                                              * 12200021
*       RESIDENT ROUTINE.                                             * 12300021
*       UCB.                                                          * 12400021
*       DEB.                                                          * 12500021
*                                                                     * 12600021
* OUTPUT -                                                            * 12700021
*    USER LABELS READ OR WRITTEN ON TAPE FOR USER.                    * 12800021
*    THE TAPE IS LEFT POSITIONED -                                    * 12900021
*    1) BEYOND THE LAST UL PROCESSED, OR                              * 13000021
*    2) IF NO UL, BEYOND THE DATA SET LABELS.                         * 13100021
*                                                                     * 13200021
* EXTERNAL REFERENCES -                                               * 13300021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 13400021
*    USER'S EXIT ROUTINES - ENTERED BY MEANS OF SYNCHRONOUS EXIT      * 13500021
*    (SVC 12).                                                        * 13600021
*                                                                     * 13700021
* EXITS, NORMAL -                                                     * 13800021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 13900021
*    CLOSE TAPE VOLUME STATISTICS FUNCTION.                           * 14000021
*                                                                     * 14100021
* EXITS, ERROR -                                                      * 14200021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 14300021
*    EXIT WITH THE FOLLOWING INTERNAL CODE--                          * 14400021
*       64 - 214 ABEND - ERROR IN READING USER LABEL.                 * 14500021
*    IF THERE IS A READ/WRITE ERROR, THIS FUNCTION SYNCHS TO USER     * 14600021
*    WITH A PARAMETER LIST WHICH (IN THE THIRD ENTRY) CONTAINS AN     * 14700021
*    ERROR FLAG AND A POINTER TO STATUS INFO (CSW STATUS). AFTER THE  * 14800021
*    USER HAS HAD THE OPPORTUNITY TO EXAMINE ERROR INFO, THIS         * 14900021
*    FUNCTION REACTS AS FOLLOWS -                                     * 15000021
*    1) OUTPUT ERROR - UL PROCESSING IS ENDED                         * 15100021
*    2) INPUT ERROR - USER RETURNS A CODE OF 0 OR 4                   * 15200021
*       0 - DISCONTINUE UL PROCESSING                                 * 15300021
*       4 - READ NEXT LABEL IF LESS THAN 8 HAVE BEEN READ. IF 8 UL    * 15400021
*           HAVE BEEN READ, UL PROCESSING IS ENDED.                   * 15500021
*                                                                     * 15600021
* TABLES/WORK AREAS -                                                 * 15700021
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 15800021
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 15900021
*                                                                     * 16000021
* ATTRIBUTES -                                                        * 16100021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 16200021
*                                                                     * 16300021
* CHARACTER CODE DEPENDENCY -                                         * 16400021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 16500021
*                                                                     * 16600021
* NOTES -                                                             * 16700021
*    NOT APPLICABLE                                                   * 16800021
*                                                                     * 16900021
*********************************************************************** 17000021
         EJECT                                                          17100021
         B     CTA03000(RET)            USE BRANCH TABLE                17200021
CTA03000 EQU   *                                                        17300021
         B     CTA03200                 ENTRY FROM SL PROCESSING        17400021
         B     CTA03100                 ENTRY FROM RETURN OF EXECUTOR   17500021
         B     CTA03300                 ENTRY FROM P.D. MOD             17600021
CTA03100 EQU   *                                                        17700021
         LA    RC,SLPSUP                PT TO 'DEFERRED PROCESSING'     17800021
         B     CTA03400                 BR TO CHK EXIT LIST FOR CODE    17900021
CTA03200 EQU   *                                                        18000021
         IECRES WAIT                    WAIT FOR TRL2                   18100021
         TM    IOBSTAT0,CSWUNITX        UNIT EXCEPTION                  18200021
         BO    CTA03250                 BRANCH IF YES            Y02144 18300002
         TM    DXECB,ECBNOERR           PERM. I/O ERROR                 18400021
         BC    12,CTA06500              BRANCH IF ERROR                 18500021
CTA03250 EQU   *                        USER RECOVERY INDICATOR  Y02144 18550002
         OI    DXATOUTA,DXATTRL2        SHOW TRL2 WRITTEN        Y02144 18560002
CTA03300 EQU   *                                                        18600021
*                                                                       18700021
*****          INITIALIZE FOR SUL EXIT-LIST CODE CHECK                  18800021
*                                                                       18900021
         LA    RC,EXIT4                 PT TO OUTPUT USER TRAILER LABEL 19000021
CTA03400 EQU   *                                                        19100021
         MODESET KEYADDR=DXUKEY,WORKREG=15                       Y02082 19150002
         L     RF,DCBEXLST              LOAD EXIT LIST ADDR FROM DCB    19200021
         LA    RF,0(,RF)                ZERO HIGH-ORDER BYTE OF EXLST   19300021
         LTR   RF,RF                    IS THE EXIT LIST ADDR ZERO-     19400021
         BZ    CTA05300                 YES, DON'T PROCESS USER LABELS  19500021
CTA03500 EQU   *                                                        19600021
         CLC   0(K1,RF),0(RC)           DO CODE BYTES MATCH-            19700021
         BE    CTA03600                 BR IF YES TO PROCESS USER       19800021
         CLC   0(K1,RF),K1(RC)          CHECK AGAIN ('LAST ENTRY' BIT)  19900021
         BE    CTA03600                 BR IF YES TO PROCESS USER       20000021
         TM    0(RF),LASTNTRY           TEST FOR LAST EXIT LIST ENTRY-  20100021
         LA    RF,K4(,RF)               INCREMENT TO NEXT ENTRY         20200021
         BC    12,CTA03500              BR IF NOT LAST TO CHK NEXT      20300021
         B     CTA05300                 BR TO POSITION TAPE- NO UL      20400021
CTA03600 EQU   *                                                        20500021
         L     RC,0(,RF)                EXIT LIST ENTRY                 20600021
         MODESET EXTKEY=DATAMGT         RETURN TO CLOSE KEY      Y02082 20650002
         LA    RF,0(,RC)                ZERO HI-ORDER BYTE              20700021
         LTR   RF,RF                    IS EXIT ADDRESS ZERO-           20800021
         BZ    CTA05300                 YES, DON'T PROCESS USER LABELS  20900021
*    GET USER LABEL WORK AREA FOR CLOSE                          Y02082 20950002
         IECRES GET,LV=USERLDM,PREFIX=YES, GET USER LBL WORKAREA Y02144*21050002
               STM=(2,14,WTGPREFX),ID=ULWA                       Y02144 21070002
         USING ULDMWK,R1                DEFINE BASE FOR UL W.A.  Y02082 21100002
         STM   RES,RC,ULREGSAV          SAVE REGS (INCLUDES DCB  Y02082 21150002
*                                       EXIT LIST ENTRY FOR UL)  Y02082 21200002
         LR    RC,R1                    POINT TO AREA OBTAINED          21600021
         USING ULDMWK,RC                DEFINE UL WORK AREA BASE Y02082 21610002
*    GET USER LABEL WORK AREA FOR USER                           Y02082 21620002
         IECRES GET,LV=USERLU,KEY=USER,PREFIX=NO,SP=K229,        Y02082*21630002
               STM=(2,14,WTGPREFX)                               YM3926 21640002
*                                                                Y02082 21650002
         MODESET EXTKEY=DATAMGT         RETURN TO CLOSE KEY      Y02082 21660002
         USING ULUWK,RA                 USER'S UL WK AREA BASE   Y02082 21670002
         LR    RA,R1                    GET ADDR OF GOTTEN CORE  Y02082 21680002
         LA    R1,CHAR0                 INITIALIZE COUNT                21800021
         STH   R1,ULCNT                 AND SAVE FOR LATER USE          21900021
         NI    ULREQ,X'FF'-LASTNTRY     ZERO HI-ORDER BIT OF UL ENTRY   22000021
*******************************************************************     22100021
*        TEST FOR NEW CODE BYTE X'0C' . IF PRESENT,LABEL PROCESS-       22200021
*        ING WILL BE DEFERRED AT EOF AND NOT AT EOV.                    22300021
*******************************************************************     22400021
         CLI   ULREQ,XLDEFSL            DEFERRED LABEL PROCESSING       22500021
         BE    CTA04300                 YES,PERFORM NORMAL PROCESSING   22600021
*                                       SINCE THIS MODULE WILL NOT      22700021
*                                       BE ENTERED AT EOF(DEFERRED).    22800021
         EJECT                                                          22900021
*  OUTPUT LABEL PROCESSING                                              23000021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 23010002
         MVI   ULBUFR,BLANK             SET LABEL BUFFER AREA           23100021
         MVC   ULBUFR+K1(L'ULBUFR-K1),ULBUFR  TO BLANKS                 23200021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 23210002
CTA03700 EQU   *                                                        23300021
         TM    JFCBLTYP,JFCBAL+JFCBUL   ANSI USER LABELS SPEC.          23400021
         BO    CTA03800                 YES,SKIP LABEL COUNTING         23500021
         LH    R1,ULCNT                 PICK UP PREVIOUS COUNT          23600021
         LA    R1,K1(,R1)               INCREMENT BY 1                  23700021
         STH   R1,ULCNT                 SAVE UPDATED COUNT              23800021
         CLI   ULCNT+K1,MAXNOLAB        TEST,BR IF MAX NBR OF UL        23900021
         BH    CTA05200                 ALREADY PROCESSED               24000021
CTA03800 EQU   *                        INITIALIZE BUFFER HEADING       24100021
         IC    RB,ULCNT+K1              GET LABEL NUMBER         Y02082 24110002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 24120002
         STC   RB,ULBUFR+K3             STORE IN USER'S BUFFER   Y02082 24130002
         MVC   ULBUFR(K3),UTLCON        SET 'UTL' IN LABEL       Y02082 24140002
*                                                                Y02082 24150002
*    MODULE WILL RETURN FROM SYNCH IN DATA MANAGEMENT KEY        Y02082 24160002
         BAL   RB,CTA05400              GO TO SYNCH TO USER             24400021
*                                                                       24500021
*                                                                       24600021
         LTR   RF,RF                    TEST,BR IF LABEL NOT            24700021
         BZ    CTA05200                 TO BE WRITTEN                   24800021
*****************************************************************Y02082 24810002
*    THE FOLLOWING CODE MOVES THE UTL FROM THE USER'S FETCH      Y02082 24820002
*    PROTECTED CORE TO CLOSE'S USER LABEL WORK AREA BUFFER       Y02082 24830002
*                                                                Y02082 24840002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 24850002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 24860002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 24870002
*    GET LOCAL LOCK                                              Y02082 24880002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*24890002
               RELATED=('PREVENT FREE USER CORE=RELEASED BELOW') Y02082 24900002
*                                                                Y02082 24910002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 24930002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 24940002
*    VERIFY CORE HELD IN USER'S KEY AND MEMORY                   Y02082 24950002
         OC    ULUWK(USERLU),ULUWK      PROGRAM CHECK IF NOT     Y02082 24960002
*                                                                Y02082 24970002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 24980002
*                                                                Y02082 24990002
         MVC   ULDMBUFR,ULBUFR          COPY LABEL FROM USER W.A.Y02082 25000002
*                                                                Y02082 25010002
*    RESET FIRST FOUR CHARACTERS OF LABEL THEN ESTABLISH         Y02082 25020002
*    CHANNEL PROGRAM TO WRITE USER LABELS                        Y02082 25030002
*                                                                Y02082 25040002
         MVC   ULDMBUFR(K3),UTLCON      SET 'UTL' IN DM LABEL    Y02082 25050002
         MVC   ULBUFR(K3),UTLCON        SET 'UTL' IN USER'S LABELY02082 25060002
         TM    JFCBLTYP,JFCBAL+JFCBUL   IF 'AUL' SPEC, BYPASS    Y02082 25070002
         BO    CTA03850                 RESTORING LABEL NUMBER   Y02082 25080002
         MVC   ULDMBUFR+K3(K1),ULCNT+K1 LABEL NO. IN DM LABEL    Y02082 25090002
         MVC   ULBUFR+K3(K1),ULCNT+K1   LABEL NO. IN USER'S LABELY02082 25100002
CTA03850 EQU   *                        RELEASE LOCK             Y02082 25110002
*    RELEASE LOCK                                                Y02082 25120002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 25130002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 25140002
*                                                                Y02082 25150002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 25160002
*                                                                Y02082 25170002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 25190002
*                                                                Y02082 25200002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 25210002
*                                                                Y02082 25220002
*****************************************************************Y02082 25230002
CTA03900 EQU   *                        POINT TO LABEL BUFFER           25700021
         LA    R1,ULDMBUFR              PT CCW TO LABEL BUFFER   Y02082 25710002
         ST    R1,DXCCW1                STORE IN CCW                    25900021
         MVI   DXCCW1,CCWWRTAP          WRITE OP-CODE TO CCW            26000021
         MVC   DXCCW1+K4(K4),LENGTH     80-CHAR LENGTH                  26100021
         TM    JFCBLTYP,JFCBAL+JFCBUL   ANSI USER LABELS SPEC.          26200021
         BNO   CTA04000                 NO,BYPASS TRANSLATE             26300021
* TRANSLATE LABEL BUFFER DATA BEFORE WRITING                            26400021
         XLATE (R1),K80,TO=A            TRANSLATE USER LABEL            26500021
*                                                                Y02082 26503002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 26506002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 26509002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 26512002
*    GET LOCAL LOCK                                              Y02082 26515002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*26518002
               RELATED=('PREVENT FREE USER CORE-RELEASED BELOW') Y02082 26521002
*                                                                Y02082 26524002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 26530002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 26533002
*    VERIFY CORE HELD IN USER'S KEY AND MEMORY                   Y02082 26536002
         OC    ULUWK(USERLU),ULUWK      PROGRAM CHECK IF NOT     Y02082 26539002
*                                                                Y02082 26542002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 26545002
*                                                                Y02082 26548002
         MVC   ULBUFR,ULDMBUFR          COPY TRANSLATED LABEL    Y02082 26551002
*    RELEASE LOCAL LOCK                                          Y02082 26554002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 26557002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 26560002
*                                                                Y02082 26563002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 26566002
*                                                                Y02082 26569002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 26575002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 26578002
CTA04000 EQU   *                        GO WRITE LABEL                  26600021
         BAL   RB,CTA06300              GO TO ISSUE EXCP                26700021
*  ERROR CHECKING                                                       26800021
         BZ    CTA04100                 BR IF NO UNIT EXCEPTION (I.E.   26900021
*                                       WRITING BEYOND EOT REFLECTOR)   27000021
         OI    DXECB,ECBCOD7F           IGNORE UF FOR TRAILERS          27100021
CTA04100 TM    DXECB,ECBNOERR           TEST FOR UNCORRECTABLE I/O ERR  27200021
         BNZ   CTA04200                 NO ERROR ENCOUNTERED.           27300021
*                                                                       27400021
*  ERROR WHEN ATTEMPTING TO WRITE LABEL.  GO TO USER WITH ERROR         27500021
*  INDICATIONS, THEN TERMINATE UL PROCESSING (RETURN CODE NOT           27600021
*  EXAMINED).                                                           27700021
         LA    R1,DXIOB                 INSERT POINTER TO STATUS INFO   27800021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 27850002
         ST    R1,ULERRPTR              IN PARAMETER LIST               27900021
         OI    ULERRPTR,ERROR           FLAG IN ERROR                   28000021
*    MODULE WILL RETURN HERE IN DATA MANAGEMENT KEY              Y02082 28050002
         BAL   RB,CTA05500              GO TO SYNCH TO USER (BUFFER     28100021
*                                       CONTAINS LABEL UNABLE TO WRITE) 28200021
*                                                                       28300021
*  NOTE - CLOSE (AND TCLOSE) PROCESS USER LABELS PRIOR TO               28400021
*  TURNING OFF OPENED BIT IN DCBOFLGS.                                  28500021
         B     CTA05200                 UL PROCESSING COMPLETED         28600021
CTA04200 EQU   *                                                        28700021
         CLI   ULRETCOD,WRITNEXT        TEST,BR IF USER RETURNED A CODE 28800021
         BE    CTA03700                 TO CONTINUE UL PROCESSING       28900021
*  OTHERWISE, IT IS ASSUMED THE USER RETURNED A CODE = 4, I.E. NO       29000021
*  FURTHER UL PROCESSING.                                               29100021
         B     CTA05200                 UNCONDITIONAL BRANCH            29200021
         EJECT                                                          29300021
CTA04300 EQU   *                                                        29400021
*  INPUT LABEL PROCESSING                                               29500021
*                                                                       29600021
*                                                                       29700021
         LA    R1,ULDMBUFR              PT CCW TO LABEL BUFFER   Y02082 29750002
         ST    R1,DXCCW1                STORE IN CCW                    29900021
         MVI   DXCCW1,CCWRDTAP          READ OP-CODE TO CCW             30000021
         MVC   DXCCW1+K4(K4),LENGTH     80-CHAR LENGTH                  30100021
CTA04400 EQU   *                                                        30200021
         BAL   RB,CTA06300              GO TO ISSUE EXCP                30300021
*                                                                       30400021
         BO    CTA04900                 BR IF UNIT EXCEPTION ON READ    30500021
*                                       (READ TAPE MARK)                30600021
         TM    DXECB,ECBNOERR           TEST,BR IF PERM I/O ERR         30700021
         BZ    CTA04800                 ENCOUNTERED                     30800021
*                                                                       30900021
         TM    JFCBLTYP,JFCBAL+JFCBUL   ANSI USER LABELS SPEC.          31000021
         BNO   CTA04500                 NO,BYPASS TRANSLATE             31100021
*  TRANSLATE LABEL BEFORE PROCESSING                                    31200021
         XLATE ULDMBUFR,K80             TRANSLATE LABEL          Y02082 31250002
CTA04500 EQU   *                        CHECK LABEL TYPE                31400021
         CLC   ULDMBUFR(K3),UTLCON      TEST,BR IF USER HDR LABELY02082 31450002
         BE    CTA04600                 WAS READ                        31600021
         CLC   ULDMBUFR(K3),UTLCON      TEST,BR IF USER TRLR LAB Y02082 31650002
         BE    CTA04600                 WAS READ                        31800021
*  NOTE - INPUT TRAILER LABEL PROCESSING LEAVES TAPE POSITIONED BETWEEN 31900021
*  FIRST AND SECOND DATA SET TRAILER.                                   32000021
*  THE FOLLOWING ALLOWS PROCESSING OF USER LABELS EVEN THOUGH THE       32100021
*  TAPE MAY CONTAIN MORE DATA SET LABELS THAN CAN CURRENTLY BE          32200021
*  CREATED UNDER O/S.                                                   32300021
         CLC   ULDMBUFR(K3),EOV         TEST, BR TO READ AGAIN   Y02082 32350002
         BE    CTA04400                 IF TRAILER WAS READ             32500021
         CLC   ULDMBUFR(K3),AEOF        TEST, BR TO READ AGAIN   Y02082 32550002
         BE    CTA04400                 IF TRAILER WAS READ             32700021
         CLC   ULDMBUFR(K3),HDR         TEST, BR TO READ AGAIN   Y02082 32750002
         BE    CTA04400                 IF HEADER WAS READ              32900021
         B     CTA05200                 UNCONDITIONAL BRANCH    SA57218 33100002
*                                                                       33200021
*                                                                       33300021
*                                                                       33400021
CTA04600 EQU   *                                                        33500021
         MVC   ULCNT+K1(K1),ULDMBUFR+K3 SAVE LABEL NUMBER        Y02082 33503002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 33506002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 33509002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 33512002
*    GET LOCAL LOCK                                              Y02082 33515002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*33518002
               RELATED=('PREVENT FREE USER CORE-RELEASED BELOW') Y02082 33521002
*                                                                Y02082 33524002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 33530002
*    VERIFY CORE HELD IN USER'S KEY AND MEMORY                   Y02082 33533002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 33536002
         OC    ULUWK(USERLU),ULUWK      PROG CHK IF NOT USER'S   Y02082 33539002
*                                                                Y02082 33542002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 33545002
*                                                                Y02082 33548002
         MVC   ULBUFR,ULDMBUFR          COPY LABEL FOR USER      Y02082 33551002
*    RELEASE LOCAL LOCK                                          Y02082 33554002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 33557002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 33560002
*                                                                Y02082 33563002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 33566002
*                                                                Y02082 33569002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 33575002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 33578002
*    MODULE WILL RETURN FROM SYNCH IN DATA MANAGEMENT KEY        Y02082 33581002
         BAL   RB,CTA05400              GO TO SYNCH TO USER             33700021
CTA04700 EQU   *                                                        33800021
         CLI   ULRETCOD,READNEXT        TEST,BR IF USER DID NOT RETURN  33900021
         BNE   CTA04750                 CODE TO READ NEXT LABEL SA57218 34000002
         TM    JFCBLTYP,JFCBAL+JFCBUL   WERE ANSI LABELS SPEC.          34100021
         BO    CTA04400                 YES,GO READ ANOTHER             34200021
         CLI   ULCNT+K1,MAXNOLAB        TEST,BR IF MAX NBR OF USER      34300021
         BL    CTA04400                 BR TO READ NEXT RECORD  SA57218 34500002
*                                                                       34600021
* DONE WITH LABEL PROCESSING, BUT MAY HAVE READ A TAPE MARK.    SA57218 34650002
* NOW POSITION TO LOGICAL END OF FILE BY SPACING PAST THE       SA57218 34660002
* TAPEMARK AT THE END OF THE TRAILER LABEL SET.                 SA57218 34670002
*                                                                       34680002
CTA04750 EQU   *                                                SA57218 34690002
         MVI   DXCCW1,CCWFSF            FORWARD SPACE OPCODE    SA57218 34692002
         MVI   DXCCW1+K7,K1             SET COUNT TO ONE        SA57218 34694002
         BAL   RB,CTA06300              GO TO ISSUE EXCP        SA57218 34696002
*        THE ABOVE IMMEDIATE OPERATION MAY RETURN               SA57218 34698002
*        A CONTROL UNIT OR DEVICE ERROR AFTER CHANNEL END       SA57218 34698402
*        HAS BEEN POSTED.                                       SA57218 34698802
         TM    DXECB,ECBNOERR           TEST FOR I/O ERROR      SA57218 34699202
         BNO   CTA06400                 GO TO ABEND ROUTINE     SA57218 34699602
         B     CTA05200                 FREEMAIN IF NO ERROR    SA57218 34699702
CTA04800 EQU   *                                                        34700021
*  ERROR ENCOUNTERED DURING READ                                        34800021
*                                                                       34900021
         LA    R1,DXIOB                 INSERT POINTER TO STATUS INFO   35000021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 35050002
         ST    R1,ULERRPTR              IN PARAMETER LIST               35100021
         OI    ULERRPTR,ERROR           FLAG ERROR                      35200021
         MODESET EXTKEY=DATAMGT         W/A FETCH PROT           Y02082 35250002
         LH    R1,ULCNT                 UPDATE LABEL NUMBER             35300021
         MODESET KEYADDR=DXUKEY,WORKREG=15 RET TO USER KEY       Y02082 35350002
         LA    R1,K1(,R1)               BY 1                            35400021
         STC   R1,ULBUFR+K3             PASS NO OF LABEL UNABLE TO READ 35600021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 35650002
         STH   R1,ULCNT                 SAVE UPDATE LABEL NO.    Y02082 35660002
         LA    RB,CTA04700              TO USER - SYNCH TO USER THEN    35700021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 35750002
*    MODULE WILL RETURN TO CTA04700 IN DATA MANAGEMENT KEY       Y02082 35760002
         B     CTA05500                 RETURN TO TEST RETURN CODE.     35800021
*                                                                       35900021
CTA04900 EQU   *                                                        36000021
*  TAPE MARK READ.  IF USER HAS PROCESSED ANY PREVIOUS LABELS,          36100021
*  FREEMAIN AND RETURN TO CALLER.                               SA57218 36200002
*  IF USER HAS NOT PROCESSED ANY PREVIOUS LABELS, SYNCH TO USER         36300021
*  WITH LABEL BUFFER POINTER SET TO ZERO, THEN                  SA57218 36400002
*  FREEMAIN AND RETURN TO CALLER.                                       36500021
*                                                                       36600021
         CLI   ULCNT+K1,CHAR0           TEST,BR IF PREVIOUS LABELS      36700021
         BH    CTA05200                 HAVE BEEN PROCESSED     SA57218 36800002
         TM    JFCBLTYP,JFCBAL+JFCBUL   WERE AUL'S SPECIFIED            36900021
         BO    CTA05200                 YES, BRANCH-CONTINUE    SA57218 37000002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 37050002
*    MODULE WILL RETURN IN DATA MANAGEMENT KEY                   Y02082 37060002
         XC    ULERRPTR,ULERRPTR        ZERO ERROR PARM                 37100021
         SR    R1,R1                    ZERO BUFFER PTR                 37200021
         BAL   RB,CTA05600              GO TO SYNCH TO USER             37300021
*                                                                       37400021
*                                                                       38500021
CTA05200 EQU   *                                                        38600021
*  ESTABLISH NAME OF ROUTINE WHICH CALLED THIS ROUTINE, THEN            38700021
*  FREEMAIN AND RETURN TO CALLER.                                       38800021
*                                                                       38900021
*    FREEMAIN USER'S USER LABEL WORK AREA                        Y02082 39010002
         IECRES FREE,A=(RA),PREFIX=NO,SP=K229,LV=USERLU,         Y02082*39020002
               KEY=USER,STM=(2,14,WTGPREFX)                      Y02082 39030002
*                                                                Y02082 39040002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 39050002
*                                                                Y02082 39060002
         LM    RES,RB,ULREGSAV          RESTORE REGS             Y02082 39070002
*    FREEMAIN CLOSE'S USER LABEL WORK AREA                       Y02082 39080002
         IECRES FREE,A=(RC),PREFIX=YES,STM=(2,14,WTGPREFX)       Y02082 39090002
*                                                                       39400021
*****          TEST FOR RETURN FROM UL PROCESSING ROUTINES              39500021
*                                                                       39600021
CTA05300 EQU   *                                                        39700021
         MODESET EXTKEY=DATAMGT         CLOSE NORMAL KEY         Y02082 39750002
         SR    RET,RET                  SET UP FOR BRANCH TABLE         39800021
         IECRES LOAD,MODID=VOLDPMOD,BRCODE=(RET),BRANCH=QUEUED   Y02080 39950002
*                                       XCTL TO VOLDPMOD         Y02080 39960002
         EJECT                                                          40000021
CTA05400 EQU   *                                                        40100021
         XC    ULERRPTR,ULERRPTR        ZERO ERROR IND                  40200021
CTA05500 EQU   *                                                        40300021
         LA    R1,ULBUFR                POINT TO LABEL BUFFER           40400021
CTA05600 EQU   *                                                        40500021
         ST    R1,ULPARM                PTR TO LABEL BUFFER      Y02082 40550002
         L     R1,DXUDCBAD              GET USER'S DCB ADDR      Y02082 40600002
         ST    R1,ULPARM+K4             PUT IN PARM LIST         Y02082 40650002
         XC    ULTOTPTR,ULTOTPTR        ZERO TOTALING ENTRY             40800021
         MVI   ULDCBPTR,K0              CLEAR FLAG BYTE                 40900021
         L     R7,DCBDEBAD              LOAD DEB ADDR            Y02082 41170002
         CLC   0(K3,R1),UTLCON          CK IF PROCESSING TRLRS          41200021
         BE    CTA05700                 TRLRS,BR TO CK FOR EOF          41300021
*                                                                       41400021
         TM    DCBOFLGS,DCBOWRIT        IS IT OUTPUT                    41500021
         BO    CTA06000                 YES, BR WITH NO EOF FLAG        41600021
         TM    DEBOPATB-DEB(R7),DEBOPRBK  IS DCB OPEN FOR RDBACK        41700021
         BNM   CTA05700                 NO,BR TO CHK FOR EOF            41800021
*                                                                       41900021
         LH    R1,DEBVOLSQ-DEB(R7)      GET DEB VOL SEQ NUMBER          42000021
         BCT   R1,CTA06000              DECREMENT--IF NOT ZERO          42100021
         B     CTA05900                 IF ZERO, BR TO INDIC EOF        42200021
*                                                                       42300021
CTA05700 EQU   *                                                        42400021
         LH    R1,JFCBVLSQ              WAS VOL SEQ SPECIFIED IN DD     42500021
         LTR   R1,R1                    TEST                            42600021
         BZ    CTA05800                 BR IF VOL SEQ NOT SPECIFIED     42700021
         BCTR  R1,0                     DECR BY ONE SINCE DEB VOL SEQ   42800021
*                                       ALWAYS STARTS WITH ONE          42900021
CTA05800 EQU   *                                                        43000021
         AH    R1,DEBTVLSQ-DEB(R7)      ADD DEB VOL SEQ         SA55619 43100000
         SR    RF,RF                    CLEAR WORK REGISTER             43200021
         IC    RF,JFCBNVOL              GET TOTAL NUMBER OF VOLS        43300021
         CR    R1,RF                    COMPARE VOLS USED TO TOTAL      43400021
         BE    CTA05900                 IF EQ INDICATE EOF              43500021
         CLC   VOLLABI,AEOF             CHK FOR EOF IF ON OTHER         43600021
*                                       THAN THE LAST VOLUME OF         43700021
*                                       A MULTI-VOLUME DATA SET         43800021
         BNE   CTA06000                 IF NOT EQ, BR TO INDICATE EOV   43900021
CTA05900 EQU   *                                                        44000021
         OI    ULDCBPTR,EOFFLG          SET FLAG TO INDICATE EOF        44100021
*                                                                       44200021
CTA06000 EQU   *                                                        44300021
         TM    DCBMACRF,DCBMEXCP        CK IF USING EXCP                44400021
         BO    CTA06100                 EXCP, SKIP TOTALING             44500021
         TM    DEBOPATB-DEB(R7),DEBOPOUT-DEBOPRBK  OPENED FOR INPT/RDBK 44600021
         BZ    CTA06100                 YES, SKIP TOTALING              44700021
         TM    DCBOPTCD,DCBOPTT         CK IF TOTALING SPECIFIED        44800021
         BZ    CTA06100                 BR IF NO TOTALING               44900021
*                                                                       45000021
         L     R7,K40(R7)               GET PTR TO TOTALING AREA        45100021
         USING TOTSAVWA,R7              ESTABLISH BASE FOR AREA         45200021
         MVC   ULTOTPTR,TOTEOVPT        TOTLING PTR TO PARM LIST        45300021
         DROP  R7                       DROP BASE                       45400021
*                                                                       45500021
CTA06100 EQU   *                                                        45600021
*  TAKE USER EXIT WITH IECRES-UEXIT MACRO                        Y02082 45800002
*                                                                       46400021
         MODESET EXTKEY=DATAMGT         KEY OF CLOSE W/A         Y02082 46410002
         NI    DCBOFLGS,X'FF'-DCBOLOCK  SET LOCK BIT TO ZERO     Y02082 46450002
*                                                                Y02082 46460002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 46470002
*                                                                Y02082 46480002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,WTGPREFX)          Y02082 46490002
*                                                                Y02082 46492002
         LA    R1,ULPARM                POINT TO PARAMETER LIST  Y02082 46494002
         IECRES UEXIT,EXITAD=ULREQ,STM=(2,13,WTGPREFX)           Y02082 46500002
         L     RDCB,DXUDCBAD            GET PTR TO USER'S DCB    Y02082 48384002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER'S KEY      Y02082 48386002
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT TO ONE      Y02082 48388402
         IC    R1,DCBOFLGS              GET USER'S DCBOFLGS      Y02082 48388802
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 48389602
         L     RDCB,DXPDCBAD            POINT TO COPIED DCB      Y02082 48389702
         LA    R0,DCBOBUSY              SET MASK FOR BUSY BIT    Y02082 48389802
         NR    R1,R0                    SELECT THE BUSY BIT      Y02082 48389902
         IC    R0,DCBOFLGS              COMBINE WITH DCBOFLGS    Y02082 48390002
         OR    R1,R0                      FROM COPIED DCB.       Y02082 48416102
         STC   R1,DCBOFLGS              UPDATE DCBOFLGS IN COPY  Y02082 48426102
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT TO ONE             48573802
         STC   RF,ULRETCOD              SAVE USERS RETURN CODE   YM4618 48583802
         BR    RB                       RETURN                          48600021
         EJECT                                                          48700021
CTA06300 EQU   *                                                        48800021
         EXCP  DXIOB                    ISSUE EXCP                      48900021
         IECRES WAIT                    WAIT FOR I/0 COMPLETION         49000021
         TM    IOBSTAT0,CSWUNITX        TEST FOR UNIT EXCEPTION AND SET 49100021
*                                       CONDITION CODE ACCORDINGLY      49200021
         BR    RB                       RETURN TO CALLER                49300021
         EJECT                                                          49400021
         SPACE 1                                                        49500021
*********************************************************************** 49600021
*                                                                     * 49700021
*                        ERROR PROCESSING                             * 49800021
*                                                                     * 49900021
*********************************************************************** 50000021
         SPACE 1                                                        50100021
CTA06400 EQU   *                                                        50200021
         LA    R0,CABD064               ERR- READ UL                    50300021
         DMABCOND (0),PDMOD,RETURN=VOLDPMOD  ABEND MACRO                50400021
CTA06500 EQU   *                                                        50500021
         LA    R0,CABD063               ERR- WRITE TRL2                 50600021
         LA    RET,K8                   SET UP FOR BRANCH TABLE         50700021
         DMABCOND (0),PDMOD             ABEND MACRO                     50800021
         EJECT                                                          50900021
*                                                                       51000021
*                        CONSTANTS                                      51100021
*                                                                       51200021
LENGTH   DC    X'20000050'              SILI, COUNT = 80 BYTES          51300021
UTLCON   DC    C'UTL'                   TRAILER LABEL CONSTANT          51400021
UHLCON   DC    C'UHL'                   HEADER LABEL CONSTANT           51500021
EOV      DC    C'EOV'                   FIRST THREE CHAR OF LABEL       51600021
HDR      DC    C'HDR'                   FIRST THREE CHAR OF LABEL       51700021
AEOF     DC    C'EOF'                   FIRST THREE CHAR OF LABEL       51800021
*                                                                       51900021
*****          DCB EXIT LIST CODE BYTES USED FOR TESTING                52000021
*                                                                       52100021
EXIT4    DC    X'04'                    CREATE OUTPUT UTL               52200021
         DC    X'84'                    SAME BUT LAST ENTRY             52300021
SLPSUP   DC    X'0C'                    SUL PROCESSING WAS              52400021
*                                       SUPPRESSED AT EOF               52500021
         DC    X'8C'                    SAME BUT LAST ENTRY             52600021
*                                                                       52700021
         LTORG                                                          52800021
         XCTLTABL ID=(PDMOD,0P,VOLDPMOD,2F),SVC=020,             Y02080X52900002
               BRT=YES,LENGTH=                                   Y02080 52950002
         IECDSECS CVT,TCB,RB,DCB,DEB,MAIN,USERLAB,USERTOT,PREFX, Y02080X53000002
               WTG,PSA,RRPL,EXPAND=YES                           Y02144 53050002
         IECEQU                                                         53100021
         END                                                            53200021
