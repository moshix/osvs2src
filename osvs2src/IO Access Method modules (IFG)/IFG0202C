         TITLE 'IFG0202C - DA INPUT USER HEADER LABEL PROCESSING '      00100021
IFG0202C CSECT                                                          00400021
*********************************************************************** 00500021
*                                                                     * 00600021
*                                                                     * 00700021
*          RELEASE 21 DELETIONS/CHANGES                               * 01200021
*0000023000-024000,120000-128000,459000                          A38013 01250021
*0000510000                                                     SA55619 01260000
*                                                                     * 01300021
* MODULE NAME = IFG0202C                                              * 01350002
*                                                                     * 01360002
* DESCRIPTIVE NAME = DA INPUT USER HEADER LABEL PROCESSING            * 01370002
*                                                                     * 01380002
* COPYRIGHT = NONE                                                    * 01390002
*                                                                     * 01392002
* STATUS CHANGE LEVEL 000                                             * 01400021
*                                                                     * 01500021
* FUNCTION -                                                          * 01600021
*    THIS MODULE CONTAINS THE FUNCTION(S) OR PART(S) OF FUNCTION(S)-- * 01700021
*    CLOSE DA INPUT USER LABELS FUNCTION.                             * 01800021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)' FOR DETAILS.         * 01900021
*                                                                     * 02000021
* ENTRY POINTS -                                                      * 02100021
*         IFG0202C - ENTRY POINT VIA AN XCTL FROM THE FOLLOWING--     * 02200021
*             IFG0200Y - PROCESS INPUT USER LABELS FUNCTION.          * 02300021
*                                                                     * 02500021
* INPUT -                                                             * 02600021
*    ENTERED IN DATA MANAGEMENT KEY                              Y02082 02650002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 02700021
*                                                                     * 02800021
* OUTPUT -                                                            * 02900021
*    EXIT IN DATA MANAGEMENT KEY                                 Y02082 02950002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 03000021
*                                                                     * 03100021
* EXTERNAL REFERENCES -                                               * 03200021
*         IFG019RA - OPEN/CLOSE/EOV RESIDENT ROUTINE FOR XCTL AND     * 03300002
*                    WAIT.                                            * 03400021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 03500021
*                                                                     * 03600021
* EXITS, NORMAL -                                                     * 03700021
*    EXIT VIA THE RESIDENT ROUTINE XCTL TO THE FOLLOWING--            * 03800021
*         IFG0202E - PROCESS CLOSE DA EXIT FUNCTION.                  * 03900021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 04000021
*                                                                     * 04100021
* EXITS, ERROR -                                                      * 04200021
*    EXIT IS TO THE PROBLEM DETERMINATION MODULE IFG0200P, IF AN      * 04300021
*    ABEND SITUATION OCCURS IN THIS MODULE.  REFER TO THE FOLLOWING   * 04400021
*    'FUNCTION PROLOG(S)'.                                            * 04500021
*                                                                     * 04600021
* TABLES/WORK AREAS -                                                 * 04700021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 04800021
*                                                                     * 04900021
* ATTRIBUTES -                                                        * 05000021
*    REENTRANT, REFRESHABLE, READ-ONLY, ENABLED, PRIVILEGED           * 05100021
*                                                                     * 05200021
* CHARACTER CODE DEPENDENCY -                                         * 05300021
*    CLASS ONE CHARACTER CODE DEPENDENCY - THE EBCDIC CHARACTER CODE  * 05400021
*    WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED IF A      * 05500021
*    DIFFERENT CHARACTER SET IS USED FOR EXECUTION.                   * 05600021
*                                                                     * 05700021
* NOTES -                                                             * 05800021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 05900021
*                                                                     * 06000021
*********************************************************************** 06100021
         EJECT                                                          06200021
         USING IHADCB,RDCB                                              06300021
         USING FORCORE,RCORE                                            06400021
         USING WTG,RWTG                 WHERE-TO-GO TABLE        Y02080 06450002
         USING TCB,RET                                                  06500021
         USING UCBOB,RUCB                                               06700021
         USING DEB,RDEB                 ESTABLISH BASE FOR DEB          06800021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         06900021
         USING *,RBASE                                                  07000021
         EJECT                                                          07100021
*                                                                     * 07200021
*                          FUNCTION PROLOG                            * 07300021
*                                                                     * 07400021
*********************************************************************** 07500021
*                                                                     * 07600021
* FUNCTION NAME -                                                     * 07700021
*    CLOSE DA INPUT USER LABELS FUNCTION.                             * 07800021
*                                                                     * 07900021
* (STATUS) -                                                          * 08000021
*    NOT APPLICABLE                                                   * 08100021
*                                                                     * 08200021
* FUNCTION -                                                          * 11350000
*    IF THE USER HAS SPECIFIED A LABEL TYPE OF SUL FOR PHYSICAL       * 11360000
*    SEQUENTIAL OR DIRECT DATA SET AND IF THE APPROPRIATE USER LABEL  * 11370000
*    EXIT IS ACTIVE (I.E., DCB EXIT LIST CONTAINS ENTRY FOR UL EXIT), * 11380000
*    THIS FUNCTION READS USER TRAILER LABELS FOR PRESENTATION TO THE  * 11390000
*    USER'S INPUT TRAILER LABEL PROCESSING ROUTINE.                   * 11392000
*    A 152 BYTE USER LABEL WORK AREA IS OBTAINED FOR CLOSE FROM  Y02082 11392502
*    FETCH PROTECTED SUBPOOL 229 IN DATA MANAGEMENT KEY. A 96    Y02082 11393002
*    BYTE USER LABEL WORK AREA IS OBTAINED FOR THE USER FROM     Y02082 11393502
*    FETCH PROTECTED SUBPOOL 229 IN USER KEY.                    Y02082 11394002
*    LABELS ARE READ AND PRESENTED TO THE USER UNTIL                  * 11398000
*    1) AN EOF IS ENCOUNTERED,                                        * 11398400
*    2) THE USER INDICATES TERMINATION OF PROCESSING VIA A RETURN     * 11398800
*       CODE, OR                                                      * 11399200
*    3) THE MAXIMUM NUMBER OF LABELS (8) HAVE BEEN PROCESSED.         * 11399600
*    AFTER THE USER'S ROUTINE HAS PROCESSED THE LABEL PASSED TO IT,   * 11399700
*    THE CODE RETURNED BY THE USER DIRECTS FURTHER PROCESSING AS      * 11399800
*    FOLLOWS--                                                        * 11399900
*       RETURN CODE   ACTION TAKEN BY THIS FUNCTION                   * 11433200
*    INPUT DATA SETS                                                  * 11443200
*         0           NO FURTHER PROCESSING OF USER LABELS (UL) AND   * 11453200
*                     NORMAL PROCESSING BY I/O SUPPORT CONTINUES.     * 11463200
*         4           IF 8 UL HAVE NOT BEEN READ, READ NEXT UL. IF 8  * 11465200
*                     UL HAVE BEEN READ, THERE IS NO FURTHER          * 11465600
*                     PROCESSING OF UL.                               * 11466000
*    UPDATE OPERATIONS                                                * 11466400
*         0           SAME AS FOR INPUT.                              * 11466500
*         4           SAME AS FOR INPUT.                              * 11466600
*         8           WRITE LABEL IN LABEL BUFFER (I.E., LABEL HAS    * 11477700
*                     BEEN UPDATED), THEN PERFORM NO FURTHER          * 11487700
*                     PROCESSING.                                     * 11488100
*        12           WRITE LABEL IN LABEL BUFFER, THEN READ NEXT UL. * 11488500
*                                                                     * 11493100
* ENTRY POINTS -                                                      * 11497700
*    ENTERED FROM THE FOLLOWING--                                     * 11500021
*    CLOSE DA ACCESS METHOD INTERFACE FUNCTION.                       * 11600021
*                                                                     * 11700021
* INPUT -                                                             * 11800021
*    A POINTER TO EACH OF THE FOLLOWING--                             * 11900021
*       CURRENT PARAMETER LIST ENTRY- RPARC                           * 12000021
*       DD ENTRY IN THE TIOT- RTIOT                                   * 12100021
*       WTG TABLE- RWTG                                               * 12200021
*       CURRENT WTG TABLE ENTRY- RWTGC                                * 12300021
*       DCB- RDCB                                                     * 12400021
*       WORK AREA- RCORE                                              * 12500021
*       RESIDENT ROUTINE- RES                                         * 12600021
*       UCB- RUCB                                                     * 12700021
*       DEB- RDEB                                                     * 12800021
*                                                                     * 12900021
* OUTPUT -                                                            * 13000021
*    USER TRAILER LABELS ARE PROCESSED.                               * 13100021
*                                                                     * 13200021
* EXTERNAL REFERENCES -                                               * 13300021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 13400021
*    USER'S INPUT LABEL EXIT ROUTINES - ENTERED BY MEANS OF           * 13500021
*    IECRES-UEXIT MACRO GIVING CONTROL TO IFG019RA WHO GIVES     Y02082 13650002
*    CONTROL TO THE USER EXIT WITH THE FOLLOWING INPUT           Y02082 13660002
*       REG 0    CONTAINS NO MEANINGFUL INFO                          * 13700021
*           1    POINTER TO 4 WORD PARAMETER LIST WHICH CONTAINS -    * 13800021
*                POINTER TO LABEL BUFFER                              * 13900021
*                POINTER TO DCB                                       * 14000021
*                FLAG BYTE, PTR TO STATUS INFO (IF PERMANENT ERROR)   * 14100021
*                OR ZERO                                              * 14200021
*                4-BYTES RESERVED (FOR OUTPUT, THIS FIELD POINTS TO   * 14300021
*                IMAGE AREA IF USER TOTALING WAS REQUESTED(DCBOPTCD=T)* 14400021
*                OR IS ZERO)                                          * 14500021
*           2-13 CONTENTS OF USER'S REGS BEFORE I/O SUPP              * 14600021
*           14   RETURN ADDRESS                                       * 14700021
*           15   EXIT ADDRESS                                         * 14800021
*                                                                     * 14900021
*    THE LOCK BIT (BIT 6) IN DCBOFLGS FIELD IS SET TO            Y02082 15200002
*    1 TO PREVENT ANOTHER I/O SUPPORT FUNCTION FROM OPERATING ON THIS * 15300021
*    DCB WHILE THE USER IS IN CONTROL.  ON RETURN FROM THE USER'S     * 15400021
*    ROUTINE, THIS BIT IS RESET TO 0.                                 * 15500021
*                                                                     * 15600021
* EXITS, NORMAL -                                                     * 15700021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 15800021
*    CLOSE DA EXIT FUNCTION.                                          * 15900021
*                                                                     * 16000021
* EXITS, ERROR -                                                      * 16100021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 16200021
*    NO LABELS CAN BE READ - EXIT TO USER'S ROUTINE WITH LABEL BUFFER * 16300021
*    POINTER IN PARM LIST SET TO ZERO. OTHER PARAMETERS UNCHANGED.    * 16400021
*    ON RETURN FROM USER'S ROUTINE, THE RETURN CODE IS IGNORED AND    * 16500021
*    NORMAL PROCESSING CONTINUES.                                     * 16600021
*    I/O ERROR READING A USER LABEL - THE USER'S ROUTINE IS ENTERED.  * 16700021
*    AGAIN WITH THE FOLLOWING INPUT                                   * 16800021
*       BIT 0 OF FLAG BYTE SET TO ONE, PTR TO STANDARD                * 16900021
*       STATUS INFORMATION.                                           * 17000021
*    OTHER PARAMETERS ARE UNCHANGED.                                  * 17100021
*    I/O ERROR WRITING UPDATED USER LABEL - IN ADDITION TO SETTING    * 17200021
*    BIT 0 OF THE FLAG BYTE, BIT 1 IS ALSO SET. A PTR IS PASSED       * 17300021
*    POINTING TO STANDARD STATUS INFORMATION.                         * 17400021
*    THE OTHER PARAMETERS ARE UNCHANGED.                              * 17500021
*                                                                     * 17600021
* TABLES/WORK AREAS -                                                 * 17700021
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 17800021
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 17900021
*                                                                     * 18000021
* ATTRIBUTES -                                                        * 18100021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 18200021
*                                                                     * 18300021
* CHARACTER CODE DEPENDENCY -                                         * 18400021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 18500021
*                                                                     * 18600021
* NOTES -                                                             * 18700021
*    NOT APPLICABLE                                                   * 18800021
*                                                                     * 18900021
*********************************************************************** 19000021
         EJECT                                                          19100021
*                                                                Y02082 19120002
*    OBTAIN CORE FOR USER LABEL WORK AREA FOR CLOSE              Y02082 19140002
*                                                                Y02082 19160002
         IECRES GET,LV=USERLDM,PREFIX=YES,SP=K229,               Y02082*19180002
               STM=(2,14,WTGPREFX),ID=ULWA                       Y02144 19200002
         STM   RES,RC,0(R1)             SAVE REGS 5-12 FOR CALLER       19500021
         LR    RC,R1                    SET BASE FOR ULWK AREA          19600021
         USING ULDMWK,RC                BASE FOR USER LABEL W.A. Y02082 19610002
*                                                                Y02082 19620002
*    OBTAIN CORE FOR USER LABEL WORK AREA FOR THE USER           Y02082 19640002
*                                                                Y02082 19660002
         IECRES GET,LV=USERLU,PREFIX=NO,SP=K229,KEY=USER,        Y02082*19680002
               STM=(2,14,WTGPREFX)                               Y02082 19684002
*                                                                Y02082 19688002
         USING ULUWK,R9                 USER LABEL WORK AREA BASEY02082 19692002
         LR    R9,R1                    ADDR OF GOTTEN CORE      Y02082 19696002
*                                                                Y02082 19696802
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 19697602
         XC    DXCCW1(DXCCW8-DXCCW1),DXCCW1  CLEAR CHAN PROG AREA       19700021
         NI    ULREQ,X'FF'-LASTNTRY     TURN OFF LAST ENTRY FLAG-IF ON  19800021
*                                                                       19900021
*  THE DSCB MUST BE READ INTO I/O SUPPORT WORK AREA                     20000021
*                                                                       20100021
         CLI   DSCEXTYP,ULEXT           IS FIRST EXTENT FOR USER LABELS 20200021
         BE    CDA02520                 BR IF YES TO SET UP CP          20300021
*        NO UL TRACK EXISTS, OR NO TRAILERS EXIST ON UL TRACK.          20400021
*                                                                       20500021
         LA    RB,CDA04300              SET RETURN ADDRESS AFTER SYNCH  20600021
*                                       USER                            20700021
CDA02500 EQU   *                                                        20800021
         SR    R1,R1                    ZERO WILL BE STORED AS LABEL    20900021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 20950002
         XC    ULERRPTR,ULERRPTR        CLEAR ERROR INDCTS              21000021
*    GO TO SYNCH IN USER KEY                                     Y02082 21050002
         B     CDA04700                 GO TO SYNCH TO USER             21100021
*                                                                       21200021
CDA02520 EQU   *                                                        21300021
*  SET UP CHANNEL PROGRAM AND WORK AREA TO READ FIRST TRAILER           21400021
*  CHANNEL PROGRAM TO READ FIRST TRAILER IS                             21500021
*    READ COUNT INTO ULWK8                                              21600021
*    SEARCH KEY EQUAL   KEY IN ULWK6 = 'UTL0'                           21700021
*    TIC *-16                                                           21800021
*    READ DATA (LABEL) INTO BUFFER                                      21900021
*                                                                       22000021
         LA    R1,ULWK8                 POINT TO AREA INTO WHICH        22100021
         ST    R1,DXCCW1                COUNT IS READ                   22200021
         LA    R1,ULWK6                 POINT TO AREA CONTAINING        22300021
*                                       SEARCH ARGUMENT                 22400021
         ST    R1,DXCCW2                FOR SEARCH KEY EQUAL            22500021
         LA    R1,DXCCW1                POINT TO READ COUNT CCW         22600021
         ST    R1,DXCCW3                IN TIC                          22700021
         LA    R1,ULDMBUFR              POINT TO LABEL BUFFER    Y02082 22750002
         ST    R1,DXCCW4                IN READ DATA                    22900021
         OC    DXCCW1(K32),ULCP1        COMBINE CP SKELETON WITH PTRS   23000021
*                                                                       23100021
*        INITIALIZE IOBDADAD WITH R=0                                   23200021
*                                                                       23300021
         XC    DXDAADDR,DXDAADDR        CLEAR IOBDADAD TO ZERO          23400021
         MVC   DXDAADDR+K3(K4),DSCLOWLM  CCHH FROM START OF 1ST EXTENT  23500021
         SPACE                                                          24300021
         TM    DCBDSORG,DCBORGDA        TEST,BR IF NOT DIRECT ORG       24400021
         BZ    CDA02600                 DATA SET                        24500021
         MVC   ULDMBUFR(CDA0500L),CDA0500K MOVE PARM LIST        YM5789 24600002
         STH   RUCB,ULDMBUFR+CDA0500L   MOVE UCBADDR AND CCHH    YM5789 24650002
         MVC   ULDMBUFR+K2+CDA0500L(K6),DXDAADDR+K1 TO MINOR NAM YM5789 24700002
         ENQ   (,ULDMBUFR+CDA0500L),MF=(E,ULDMBUFR) ENQ ON ULTRK YM5789 24760002
CDA02600 EQU   *                                                        24800021
*                                                                       24900021
         MVC   ULWK6,UTLCONST           SET UP SEARCH ARG = UTLO        25000021
         MVC   ULWK10,UTLCONST          NECESSARY SINCE FIRST CHANNEL   25100021
*                                       PROGRAM DOES NOT READ KEY       25200021
         OI    ULWK2,K1                 SET FIRST READ SWITCH           25300021
*                                                                       25400021
*        READ FIRST TRAILER LABEL                                       25500021
*                                                                       25600021
         BAL   RB,CDA04200              GO READ TRAILER                 25700021
*                                                                       25800021
*  ESTABLISH CHANNEL PROGRAM FOR SUBSEQUENT USE, THEN TEST              25900021
*  FOR I/O ERROR.                                                       26000021
*                                                                       26100021
*  SET UP CHANNEL PROGRAM TO WRITE BACK LABEL AND READ NEXT LABEL       26200021
*    SEARCH KEY EQUAL    KEY=UTL(N)                                     26300021
*    TIC *-8                                                            26400021
*    WRITE DATA          WRITE UPDATED LABEL                            26500021
*    SEARCH ID EQUAL     ID OF RECORD PRIOR TO UTL(N)                   26600021
*    TIC *-8             CHECK                                          26700021
*    RD CKD    (SKIP)    LABEL JUST WRITTEN                             26800021
*    RD CKD              READ NEXT LABEL                                26900021
*                                                                       27000021
*  WHEN ONLY UPDATING IS PERFORMED, CC FLAG IN RD CKD IS TURNED OFF.    27100021
*                                                                       27200021
*  WHEN NO UPDATING IS PERFORMED,CHANNEL PROGRAM TO READ NEXT LABEL IS  27300021
*    SEARCH KEY EQUAL    KEY OF PREVIOUS LABEL                          27400021
*    TIC *-8                                                            27500021
*    RD CKD              READ NEXT LABEL                                27600021
*                                                                       27700021
*                                                                       27800021
*  PROCEDURE USED BELOW IS TO USE KEY IN ULWK10 (KEY OF LABEL           27900021
*  PROCESSED) AS SEARCH ARGUMENT FOR SUBSEQUENT I/O OPERATIONS.         28000021
         MVC   DXCCW1,DXCCW2            SEARCH KEY CCW TO DXCCW1        28100021
         XC    DXCCW2(DXCCW8-DXCCW2),DXCCW2  CLEAR REMAINING CP AREA    28200021
         LA    R1,DXCCW1                SET UP DXCCW2                   28300021
         ST    R1,DXCCW2                AS TIC TO                       28400021
         MVI   DXCCW2,CCWTIC            DXCCW1                          28500021
*  DXCCW3 IS ESTABLISHED AFTER USER RETURNS CODE                        28600021
         LA    R1,DXDAADDR+K3           ADDR OF IOBADDR+3 (CCHHR) FOR   28700021
         ST    R1,DXCCW4                SEARCH ID                       28800021
         LA    R1,DXCCW4                TIC TO                          28900021
         ST    R1,DXCCW5                DXCCW4                          29000021
         LA    R1,ULWK8                 RD CKD INTO                     29100021
         ST    R1,DXCCW7                ULWK8                           29200021
         OC    DXCCW4(K32),ULCP3        COMBINE SKELETON CP & PTRS      29300021
CDA02700 EQU   *                                                        29400021
         TM    DXECB,ECBCOD7F           TEST, BR IF I/O ERROR           29500021
         BNO   CDA03700                 ENCOUNTERED                     29600021
         NI    ULWK2,X'FF'-K1           SET 1ST-READ-SW OFF IF ON       29700021
         IC    R1,ULWK9                 'R' OF COUNT READ IN            29800021
         BCTR  R1,0                     DECREMENTED BY ONE - USED IN OR 29900021
         STC   R1,DXDAADDR+K7           FOR WRITE VERIFICATION          30000021
*****************************************************************Y02082 30002502
*    THE FOLLOWING CODE WILL COPY THE UTL FROM CLOSE'S USER      Y02082 30005002
*    LABEL WORK AREA TO THE USER'S BUFFER                        Y02082 30007502
*                                                                Y02082 30010002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 30020002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 30030002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 30032002
*    GET LOCAL LOCK                                              Y02082 30034002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*30034402
               RELATED=('PREVENT FREE USER CORE-RELEASED BELOW') Y02082 30034802
*                                                                Y02082 30034902
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 30039102
*    VERIFY THAT CORE FOR USER'S BUFFER STILL HELD BY USER       Y02082 30041102
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 30043302
         OC    ULUWK(USERLU),ULUWK      PROGRAM CHECK IF NOT USERY02082 30045302
*                                                                Y02082 30047302
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 30047402
*                                                                Y02082 30058802
         MVC   ULBUFR,ULDMBUFR          COPY LABEL TO USER BUFFERY02082 30064402
*    RELEASE LOCAL LOCK                                          Y02082 30066402
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 30068402
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 30068802
*                                                                Y02082 30069202
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 30069602
*                                                                Y02082 30069702
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 30069802
         MODESET KEYADDR=DXUKEY,WORKREG=15 USER WORK AREA        Y02082 30069902
*                                                                Y02082 30070002
*****************************************************************Y02082 30072502
*                                                                       30100021
         BAL   RB,CDA04500              GO TO SYNCH TO USER             30200021
*                                                                Y02134 30250002
*    RETURN IN D/M KEY                                           Y02134 30260002
*                                                                Y02134 30270002
         LTR   RF,RF                    TEST,BR IF USER RETURNED        30300021
         BZ    CDA04250                 A CODE = 0 (NO FURTHER PROCESS) 30400021
CDA02800 EQU   *                                                        30500021
*  SOME TYPE OF I/O WILL BE INITIATED.  SEARCH WILL BE BASED UPON KEY   30600021
*  OF LABEL 'JUST PROCESSED'.                                           30700021
         MVC   ULWK6,ULWK10             SET UP SEARCH ARGUMENT          30800021
         XC    DXCCW3,DXCCW3            ENSURE THAT PRVIUS CCW DOES NOT 30900021
*  CONFLICT WITH CHANNEL PROGRAM TO BE COMPLETED BELOW.                 31000021
         CLI   ULRETCOD,READNEXT        TEST,BR IF USER DOES NOT WANT   31100021
         BNE   CDA02860                 NEXT LABEL TO BE READ           31200021
*        READ NEXT LABEL                                                31300021
         CLI   ULWK10+K3,CHAR7          TEST,BR IF MAX NBR OF LABELS    31400021
         BC    10,CDA04250              ALREADY READ                    31500021
*  ESTABLISH THIRD CCW TO READ NEXT LABEL                               31600021
         LA    R1,ULWK8                 SET RD CKD CCW TO READ INTO     31700021
         ST    R1,DXCCW3                AREA STARTING AT ULWK8          31800021
         OC    DXCCW3,RDCKD             COMBINE SKELETON CCW WITH ADDR  31900021
*                                                                       32000021
CDA02840 EQU   *                                                        32100021
         BAL   RB,CDA04200              GO READ NEXT LABEL ( OR WRITE   32200021
*                                       THEN READ NEXT LABEL)           32300021
         B     CDA02700                 GO CHECK FOR ERROR              32400021
*                                                                       32500021
CDA02860 EQU   *                                                        32600021
*  CHECK IF 8 OR 12 IS A VALID RETURN CODE                              32700021
         L     RDEB,DCBDEBAD            POINTER TO USER'S DEB           32800021
         TM    DCBOFLGS,DCBOPEN         CK IF DCB IS OPEN               32900021
         BO    CDA02900                 DCB OPEN,USER'S DEB EXISTS      33000021
         LA    RDEB,DXDEB               DURING OPEN,USE WORK DEB        33100021
CDA02900 EQU   *                                                        33200021
         TM    DEBOPATB,DEBOPOUT-DEBOPUPD  TEST,BR IF OPENED FOR        33300021
         BO    CDA03000                 OUTPUT                          33400021
         BM    CDA04250                 BR IF NOT UPDAT OR INPUT        33500021
         TM    DEBOPATB,DEBOPUPD        TEST,BR IF OPENED FOR           33600021
         BO    CDA03100                 UPDAT                           33700021
         B     CDA04250                 BR IF INPUT                     33800021
CDA03000 EQU   *                                                        33900021
         TM    DCBDSORG,DCBORGDA        IF NOT UPDATE, DIRECT DATA SET  34000021
         BZ    CDA04250                 FOR OUTPUT IS ALSO VALID.       34100021
CDA03100 EQU   *                                                        34200021
*  SET UP THIRD CCW TO WRITE UPDATED LABEL                              34300021
         LA    R1,ULBUFR                ESTABLISH WRITE DATA CCW TO     34400021
         ST    R1,DXCCW3                WRITE LABEL BUFFER              34500021
         OC    DXCCW3,WRDATA            COMBINE SKELETON CCW WITH ADDR  34600021
*                                                                       34700021
*****************************************************************Y02082 34702502
*    THE FOLLOWING CODE WILL COPY THE UPDATED USER LABEL FROM    Y02082 34705002
*    THE USER'S BUFFER TO CLOSE'S LABEL BUFFER                   Y02082 34707502
*                                                                Y02082 34710002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 34712502
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 34715002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 34717502
*    GET LOCAL LOCK                                              Y02082 34720002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*34722502
               RELATED=('PREVENT FREE USER CORE-RELEASED BELOW') Y02082 34725002
*                                                                Y02082 34727502
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 34732502
*    VERIFY THAT CORE FOR USER'S BUFFER STILL HELD BY USER       Y02082 34735002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 34737502
         OC    ULUWK(USERLU),ULUWK      PROGRAM CHECK IF NOT USERY02082 34740002
*                                                                Y02082 34742502
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 34745002
*                                                                Y02082 34747502
         MVC   ULDMBUFR,ULBUFR          COPY LABEL TO CLOSE W.A. Y02082 34750002
*    RELEASE LOCAL LOCK                                          Y02082 34752502
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 34755002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 34757502
*                                                                Y02082 34760002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 34762502
*                                                                Y02082 34765002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 34770002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 34772502
*                                                                Y02082 34775002
*****************************************************************Y02082 34777502
         CLI   ULRETCOD,WRITNEXT        TEST,BR IF LABEL IS TO BE       34800021
         BE    CDA03600                 WRITTEN ONLY                    34900021
         CLI   ULRETCOD,WRITNEXT+READNEXT  TEST IF LABEL TO BE WRITTEN  35000021
         BNE   CDA04250                 BR, INVALID CODE RETURNED, END  35100021
*                                       PROCESSING IN THIS MODULE       35200021
*                                                                       35300021
*        WRITE UPDATED LABEL AND READ NEXT LABEL                        35400021
*                                                                       35500021
         CLI   ULWK10+K3,CHAR7          TEST,BR IF MAX NUMBER OF LABELS 35600021
         BC    10,CDA03500              ALREADY BEEN READ               35700021
         OI    DXCCW6+K4,CCWCMDCH       ENSURE COMMAND CHAIN FLAG IN    35800021
*                                       VERIFICATION RD CKD IS ON       35900021
         B     CDA02840                 GO PERFORM I/O                  36000021
*                                                                       36100021
CDA03500 EQU   *                                                        36200021
         MVI   ULRETCOD,WRITNEXT        MAX NUMBER OF LABELS HAVE       36300021
*  BEEN READ, RETURN CODE CHANGED TO WRITE LABEL ONLY.                  36400021
*  FALL THRU TO WRITE LABEL                                             36500021
*                                                                       36600021
*        WRITE UPDATED LABEL                                            36700021
CDA03600 EQU   *                                                        36800021
         NI    DXCCW6,X'FF'-CCWCMDCH    TURN OFF COMMND CHAIN FLAG IN   36900021
*                                       CCW THAT PERFORMS WRITE         37000021
*                                       VERIFICATION                    37100021
         BAL   RB,CDA04200              GO WRITE UPDATED LABEL          37200021
*                                                                       37300021
         TM    DXECB,ECBCOD7F           TEST,BR (IE,NO FURTHER PROCESS) 37400021
         BO    CDA04250                 NO I/O ERROR                    37500021
*                                                                       37600021
CDA03700 EQU   *                                                        37700021
*        I/O ERROR                                                      37800021
*                                                                       37900021
         LA    R1,DXIOB                 PUT PTR TO STATUS INFO IN       38000021
         MODESET KEYADDR=DXUKEY,WORKREG=15  ASSUME USER KEY      Y02082 38050002
         ST    R1,ULERRPTR              PARAMETER LIST                  38100021
         MVI   ULERRPTR,ERROR           FLAG ERROR COND(ALSO RESETS ANY 38200021
*                                       OTHER ERROR FLAGS TO ZERO).     38300021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 38350002
*                                                                Y02082 38360002
*  DETERMINE TYPE OF CHANNEL PROGRAM BEING USED WHEN ERROR OCCURRED.    38400021
*                                                                       38500021
         CLI   ULRETCOD,WRITNEXT        TEST,BR IF ERROR ON READ ONLY   38600021
         BL    CDA03800                 (IF ERROR ON FIRST READ,        38700021
*                                       ULRETCOD=0, BR TAKEN)           38800021
*  EITHER WRITING OR WRITING THEN READING                               38900021
         MVC   ULWK3+K1(K3),IOBCOMAD+K1  OBTAIN CSW POINTER             39000021
         L     R1,ULWK3                 FROM IOB                        39100021
         LA    R0,DXCCW7+K8             POINT 8 BYTES PAST READ CCW,    39200021
         CR    R1,R0                    THEN COMPARE WITH CSW POINTER   39300021
         BNE   CDA04000                 BR IF ERROR DURING WRITE        39400021
CDA03800 EQU   *                                                        39500021
*  READ ERROR                                                           39600021
         SR    R1,R1                                                    39700021
         IC    R1,ULWK6+K3              OBTAIN LAST CHAR OF KEY         39800021
         TM    ULWK2,CSWUNITX           TEST IF ERROR ON FIRST READ     39900021
         BO    CDA03900                 BR IF FIRST READ                40000021
*  RECONSTRUCT KEY AREA                                                 40100021
         MVC   ULWK10(K3),UTLCONST      'UTL' TO KEY AREA               40200021
         LA    R1,K1(,R1)               INCREMENT 'N' OF KEY            40300021
         STC   R1,ULWK10+K3             AND PLACE IN KEY AREA           40400021
CDA03900 EQU   *                                                        40500021
*  SET UP BUFFER TO TELL USER WHAT LABEL WE WERE UNABLE TO READ         40600021
         NI    ULWK2,X'FF'-K1           SET 1ST READ SW OFF IF ON       40700021
         MVC   ULDMBUFR(K3),UTLCONST    'UTL' TO BUFFER          Y02082 40750002
         LA    R1,K1(,R1)               LABEL NUMBER                    40900021
         STC   R1,ULDMBUFR+K3           TO BUFFER                Y02082 40950002
         MODESET KEYADDR=DXUKEY,WORKREG=15    ASSUME USER KEY    Y02082 41025002
*                                                                Y02082 41035002
         MVC   ULBUFR(K4),ULDMBUFR      COPY LABEL TYPE TO USER  Y02082 41037502
         B     CDA04100                 GO TO BRANCH TO USER            41100021
*                                                                       41200021
CDA04000 EQU   *                                                        41300021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 41350002
*  WRITE ERROR                                                          41400021
         OI    ULERRPTR,ERROROUT        FLAG WRITE ERROR CONDITION      41500021
CDA04100 EQU   *                                                        41600021
         BAL   RB,CDA04600              GO TO SYNCH TO USER             41700021
*                                                                Y02082 41750002
*    RETURN FROM SYNCH IN DATA MANAGEMENT KEY                    Y02082 41752002
*                                                                Y02082 41760002
         LTR   RF,RF                    TEST,BR IF USER RETURNS CODE=0, 41800021
         BZ    CDA04250                 (NO FURTHER PROCESSING)         41900021
         ST    RF,ULWK1                 SAVE RETURN CODE                42000021
         CLI   ULRETCOD,READNEXT        TEST,BR IF USER WANTS NEXT      42100021
         BE    CDA02800                 LABEL TO BE READ                42200021
         B     CDA04250                 BR,INVALID CODE RETURNED BY     42300021
*                                       USER                            42400021
         EJECT                                                          42500021
*                                                                       42600021
*********************************************************************** 42700021
*                                                                       42800021
*                   CLOSED SUBROUTINE TO ISSUE I/O OPERATIONS           42900021
*                                                                       43000021
*        IT IS ASSUMED THAT ALL CONTROL BLOCKS HAVE ALREADY BEEN SET UP 43100021
*                                                                       43200021
CDA04200 EQU   *                                                        43300021
         EXCP  DXIOB                    INITIATE I/O                    43400021
*                                                                       43500021
         IECRES WAIT                    WAIT FOR I/O COMPLETION         43600021
*                                                                       43700021
         TM    IOBSTAT0,CSWUNITX        TEST,BR IF NOT UNIT             43800021
         BCR   14,RB                    EXCEPTION (EOF)                 43900021
         CLI   ULWK10+K3,CHAR0          HAVE ANY LABELS BEEN READ       44000021
         LA    RB,CDA04250              PREVIOUSLY- SET UP RETURN ADDR  44100021
         BC    12,CDA02500              GO TO SYNCH TO USER IF NO       44200021
*        NO FURTHER UL PROCESSING IS PERFORMED.  FREE CORE AND RETURN   44300021
*        TO CALLER.                                                     44400021
*                                                                       44500021
CDA04250 EQU   *                                                        44600021
         TM    DCBDSORG,DCBORGDA        TEST,BR IF NOT DIRECT ORG       44700021
         BZ    CDA04300                 DATA SET                        44800021
         MVC   ULDMBUFR(CDA0500L),CDA0500K MOVE PARM LIST        YM5789 44850002
         STH   RUCB,ULDMBUFR+CDA0500L   MOVE UCBADDR AND CCHH    YM5789 44900002
         MVC   ULDMBUFR+K2+CDA0500L(K6),DXDAADDR+K1 TO MINOR NAM YM5789 44950002
         DEQ   (,ULDMBUFR+CDA0500L),MF=(E,ULDMBUFR) DEQ ULTRK    YM5789 45000002
CDA04300 EQU   *                                                        45100021
*    FREEMAIN USER'S USER LABEL WORK AREA                        Y02082 45105002
         IECRES FREE,A=(R9),PREFIX=NO,SP=K229,LV=USERLU,         Y02082*45110002
               KEY=USER,STM=(2,14,WTGPREFX)                      Y02082 45115002
*                                                                Y02082 45120002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 45125002
         LR    R1,RC                    INITIALIZE REG FOR FREEMAIN     45200021
         LM    RES,RC,0(R1)             RESTORE CALLER'S REGS           45300021
         IECRES FREE,A=(R1),PREFIX=YES,STM=(2,14,WTGPREFX)       Y02082 45350002
* USER LABEL WORK AREA, LABEL BUFFER AND PARAMETER LIST          Y02080 45500002
*                                                                       45600021
*  RETURN TO CALLER                                                     45700021
*                                                                       45800021
         LA    RET,K8                   SET BRANCH OFFSET        A38013 45900021
         IECRES LOAD,MODID=DAFINMOD,BRCODE=(RET),BRANCH=QUEUED   Y02080 46050002
*                                       XCTL TO DAFINMOD         Y02080 46060002
         EJECT                                                          46100021
*********************************************************************** 47600021
*        CLOSED SUBROUTINE TO GIVE CONTROL TO USER EXIT ROUTINE  Y02082 47700002
*        REGISTER CONTENTS AT ENTRY TO USER EXIT ARE AS FOLLOWS- Y02082 48100002
*                        R0 - CONTAINS NO MEANINGFUL INFO               48200021
*                        R1 - PTR TO PARAMETER LIST                     48300021
*                    R2-R13 - USER'S CONTENTS BEFORE I/O SUPPORT        48400021
*                       R14 - RETURN ADDRESS (SET BY SYNCH)             48500021
*                       R15 - EXIT ADDRESS                              48600021
*                                                                       48700021
CDA04500 EQU   *                                                        48800021
         XC    ULERRPTR,ULERRPTR        CLEAR PREVIOUS ERROR PARM       48900021
CDA04600 EQU   *                                                        49000021
         LA    R1,ULBUFR                PTR TO LABEL BUFFER             49100021
CDA04700 EQU   *                                                        49200021
         ST    R1,ULPARM                PTR TO LABEL BUFFER      Y02082 49250002
         L     R1,DXUDCBAD              GET USER'S DCB ADDR      Y02082 49300002
         ST    R1,ULPARM+K4             PUT IN PARM LIST         Y02082 49350002
         MVI   ULDCBPTR,K0              CLEAR FLAG BYTE                 49500021
         L     R7,DCBDEBAD              USER'S DEB ADDRESS              49600021
         OI    ULDCBPTR,EOFFLG          INDICATE EOF            SA55619 49690000
         TM    DCBOFLGS,DCBOPEN         CK IF DCB ALREADY OPEN          49700021
         BZ    CDA04800                 NO,CTL FROM OPEN,INDIC EOF      49800021
         TM    DCBDSORG,DCBORGDA        IS DSORG DIRECT                 49900021
         BO    CDA04800                 YES, INDIC EOF                  50000021
         SR    R1,R1                    CLEAR WORK REGISTER             50100021
         IC    R1,DEBNMEXT-DEB(R7)      GET NUMBER OF EXTENTS           50200021
         SLL   R1,4                     16(NO.EXTNTS)=LNGTH IN DEB      50300021
         LH    R1,DEBDVMOD-DEB(R1,R7)   GET DEB VOL SEQ NUMBER          50400021
         AH    R1,JFCBVLSQ              ADD JFCB VOL SEQ NUMBER         50500021
         SR    RF,RF                    CLEAR WORK REGISTER             50600021
         IC    RF,JFCBNVOL              GET TOTAL NUMBER OF VOLS        50700021
         CR    R1,RF                    COMPARE VOLS USED TO TOTAL      50800021
         BE    CDA04800                 IF EQ, INDICATE EOF             50900021
         NI    ULDCBPTR,X'FF'-EOFFLG    NOT EQ, INDICATE EOV    SA55619 50950000
*                                                                       51100021
CDA04800 EQU   *                                                        51200021
         MODESET EXTKEY=DATAMGT         ASSUME DATAMGT KEY       Y02082 51210002
         NI    DCBOFLGS,X'FF'-DCBOLOCK  SET LOCK BIT = 0         Y02082 51250002
*                                                                Y02082 51260002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 51270002
*                                                                Y02082 51280002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,WTGPREFX)          Y02082 51290002
*                                                                Y02082 51292002
         LA    R1,ULPARM                POINT TO PARAMETER LIST         51300021
         IECRES UEXIT,EXITAD=ULREQ,STM=(2,13,WTGPREFX)           Y02082 51600002
         STC   RF,ULRETCOD              SAVE USERS RETURN CODE   YM5975 51650002
         L     RDCB,DXUDCBAD            GET PTR TO USER'S DCB    Y02082 53380402
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER'S KEY      Y02082 53381202
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT = 1         Y02082 53381602
         IC    R1,DCBOFLGS              GET USER'S DCBOFLGS      Y02082 53381702
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 53381902
         L     RDCB,DXPDCBAD            POINT TO COPIED DCB      Y02082 53391902
         LA    R0,DCBOBUSY              SET MASK FOR BUSY BIT    Y02082 53406102
         NR    R1,R0                    SELECT THE BUSY BIT      Y02082 53416102
         IC    R0,DCBOFLGS              COMBINE WITH DCBOFLGS    Y02082 53426102
         OR    R1,R0                      FROM COPIED DCB.       Y02082 53428102
         STC   R1,DCBOFLGS              UPDATE DCBOFLGS IN COPY  Y02082 53430102
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT = 1                53575802
         BR    RB                       UNCONDITIONAL BRANCH            53600021
         EJECT                                                          53700021
         SPACE 1                                                        53800021
**********************************************************************  53900021
*                                                                    *  54000021
*                    CONSTANTS                                       *  54100021
*                                                                    *  54200021
**********************************************************************  54300021
UTLCONST DC    C'UTL0'                  SEARCH ARGUMENT                 54400021
CDA0500K ENQ   (CDA0501K,,E,8,SYSTEM),MF=L ENQ LIST FORM         YM5789 54500002
CDA0500L EQU   *-CDA0500K               LENGTH OF ENQ/DEQ LIST   YM5789 54550002
CDA0501K DC    CL8'SYSZUSRL'            MAJOR NAME               YM5789 54600002
*   CHANNEL PROGRAM TO READ FIRST TRAILER                               54900021
ULCP1    CCW   X'12',0,X'40',8          READ COUNT                      55000021
         CCW   X'29',0,X'40',4          SEARCH KEY EQUAL                55100021
         CCW   X'08',0,0,0              TIC *-16                        55200021
         CCW   X'06',0,0,80             READ DATA                       55300021
ULCP2    CCW   X'05',0,X'40',80         WRITE DATA                      55400021
WRDATA   EQU   ULCP2                                                    55500021
ULCP3    CCW   X'31',0,X'40',5          SEARCH ID EQUAL                 55600021
         CCW   X'08',0,0,0              TIC                             55700021
         CCW   X'1E',0,X'50',92         READ COUNT,KEY,DATA  (SKIP)     55800021
RDCKD    CCW   X'1E',0,0,92             READ COUNT,KEY,DATA             55900021
         XCTLTABL ID=(DAFINMOD,2E),SVC=020,                      Y02080X56000002
               BRT=YES,LENGTH=                                   Y02080 56050002
         IECDSECS CVT,TCB,RB,DCB,DEB,UCB,MAIN,USERLAB,USERTOT,   Y02080*56100002
               PREFX,WTG,PSA,RRPL,EXPAND=YES                     Y02144 56150002
         IECEQU                                                         56300021
         END                                                            56400021
