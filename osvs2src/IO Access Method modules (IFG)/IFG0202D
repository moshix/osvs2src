         TITLE 'IFG0202D - DA OUTPUT USER TRAILER LABEL PROCESSING'     00200021
IFG0202D CSECT                                                          00800021
*********************************************************************** 01000021
*                                                                     * 01200021
*                                                                     * 01400021
*          RELEASE 21 DELETIONS/CHANGES                               * 02400021
*                                                                     * 02600021
* MODULE NAME = IFG0202D                                              * 02650002
*                                                                     * 02700002
* DESCRIPTIVE NAME = DA OUTPUT USER TRAILER LABEL PROCESSING          * 02750002
*                                                                     * 02760002
* COPYRIGHT = NONE                                                    * 02770002
*                                                                     * 02780002
* STATUS CHANGE LEVEL 000                                             * 02800021
*                                                                     * 03000021
* FUNCTION -                                                          * 03200021
*    THIS MODULE CONTAINS THE FUNCTION(S) OR PART(S) OF FUNCTION(S)-- * 03400021
*    CLOSE DA OUTPUT USER LABELS FUNCTION.                            * 03600021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)' FOR DETAILS.         * 03800021
*                                                                     * 04000021
* ENTRY POINTS -                                                      * 04200021
*         IFG0202D - ENTRY POINT VIA AN XCTL FROM THE FOLLOWING--     * 04400021
*             IFG0201R - CONTINUE PROCESSING OUTPUT USER LABELS       * 04600021
*                        FUNCTION.                                    * 04800021
*                                                                     * 05000021
* INPUT -                                                             * 05200021
*    ENTERED IN DATA MANAGEMENT KEY                              Y02082 05250002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 05400021
*                                                                     * 05600021
* OUTPUT -                                                            * 05800021
*    EXIT IN DATA MANAGEMENT KEY                                 Y02082 05850002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 06000021
*                                                                     * 06200021
* EXTERNAL REFERENCES -                                               * 06400021
*         IFG019RA - OPEN/CLOSE/EOV RESIDENT ROUTINE FOR XCTL AND     * 06600002
*                    WAIT.                                            * 06800021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 07000021
*                                                                     * 07200021
* EXITS, NORMAL -                                                     * 07400021
*    EXIT VIA THE RESIDENT ROUTINE XCTL TO THE FOLLOWING--            * 07600021
*         IFG0202E - PROCESS CLOSE DA WRITE FILE MARK FUNCTION.       * 07800021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 08000021
*                                                                     * 08200021
* EXITS, ERROR -                                                      * 08400021
*    EXIT IS TO THE PROBLEM DETERMINATION MODULE IFG0200P, IF AN      * 08600021
*    ABEND SITUATION OCCURS IN THIS MODULE.  REFER TO THE FOLLOWING   * 08800021
*    'FUNCTION PROLOG(S)'.                                            * 09000021
*                                                                     * 09200021
* TABLES/WORK AREAS -                                                 * 09400021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 09600021
*                                                                     * 09800021
* ATTRIBUTES -                                                        * 10000021
*    REENTRANT, REFRESHABLE, READ-ONLY, ENABLED, PRIVILEGED           * 10200021
*                                                                     * 10400021
* CHARACTER CODE DEPENDENCY -                                         * 10600021
*    CLASS ONE CHARACTER CODE DEPENDENCY - THE EBCDIC CHARACTER CODE  * 10800021
*    WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED IF A      * 11000021
*    DIFFERENT CHARACTER SET IS USED FOR EXECUTION.                   * 11200021
*                                                                     * 11400021
* NOTES -                                                             * 11600021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 11800021
*                                                                     * 12000021
*********************************************************************** 12200021
         EJECT                                                          12400021
         USING ULDMWK,RC                                         Y02080 12600002
         USING IHADCB,RDCB                                              12800021
         USING FORCORE,RCORE                                            13000021
         USING WTG,RWTG                 WHERE-TO-GO TABLE        Y02080 13050002
         USING UCBOB,RUCB                                               13200021
         USING TCB,RET                                                  13400021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         13800021
         USING *,RBASE                                                  14000021
         EJECT                                                          14200021
*                                                                     * 14400021
*                          FUNCTION PROLOG                            * 14600021
*                                                                     * 14800021
*********************************************************************** 15000021
*                                                                     * 15200021
* FUNCTION NAME -                                                     * 15400021
*    CLOSE DA OUTPUT USER LABELS FUNCTION.                            * 15600021
*                                                                     * 15800021
* (STATUS) -                                                          * 16000021
*    NOT APPLICABLE                                                   * 16200021
*                                                                     * 16400021
* FUNCTION -                                                          * 20450000
*    DETERMINE IF CURRENT VOLUME IS FIRST VOLUME FOR NEW DA DATA SET. * 20500000
*    LOCATE FIRST VOLUME BY SEARCHING THE UCB'S FOR ALL UNITS         * 20550000
*    ALLOCATED TO THE DATA SET.                                       * 20560000
*    READ THE FORMAT 1 DSCB.                                          * 20570000
*    A 152 BYTE USER LABEL WORK AREA IS OBTAINED FOR CLOSE FROM  Y02082 20580002
*    FETCH PROTECTED SUBPOOL 229 IN DATA MANAGEMENT KEY. A 96    Y02082 20590002
*    BYTE USER LABEL WORK AREA IS OBTAINED FOR THE USER FROM     Y02082 20592002
*    FETCH PROTECTED SUBPOOL 229 IN USER KEY.                    Y02082 20594002
*    IF A TRACK WAS ALLOCATED FOR USER LBLS,CONTROL IS GIVEN TO THE   * 20598000
*    USER'S LABEL CONSTRUCTION ROUTINE VIA IECRES-UEXIT MACRO.   Y02082 20598402
*    ON RETURN FROM THE USER'S ROUTINE, IF A LABEL WAS CONSTRUCTED, IT* 20598800
*    IS WRITTEN FOLLOWED BY 2 FILEMARKS FOR HEADERS (UHL(N+1)), OR    * 20599200
*    ONE FILEMARK FOR TRAILERS (UTL(N+1)).  DEPENDING ON THE RETURN   * 20599600
*    CODE PASSED BY THE USER'S ROUTINE, ANOTHER LABEL IS PROCESSED OR * 20599700
*    CONTROL IS GIVEN BACK TO THE I/O SUPPORT FUNCTION.               * 20599800
*    WRITE UP TO EIGHT USER TRAILER LABELS AS REQUIRED FOR DATA SETS  * 20599900
*    ON DIRECT ACCESS VOLUMES.                                        * 20649900
*                                                                     * 20659900
* ENTRY POINTS -                                                      * 20699900
*    ENTERED FROM THE FOLLOWING--                                     * 20800021
*    CLOSE DA WRITE DSCB FUNCTION.                                    * 21000021
*                                                                     * 21200021
* INPUT -                                                             * 21400021
*    A POINTER TO EACH OF THE FOLLOWING--                             * 21600021
*       CURRENT PARAMETER LIST ENTRY.                                 * 21800021
*       DD ENTRY IN THE TIOT.                                         * 22000021
*       WTG TABLE.                                                    * 22200021
*       CURRENT WTG TABLE ENTRY.                                      * 22400021
*       DCB.                                                          * 22600021
*       CLOSE WORK AREA.                                              * 22800021
*       RESIDENT ROUTINE.                                             * 23000021
*       UCB.                                                          * 23200021
*       DEB.                                                          * 23400021
*                                                                     * 23600021
* OUTPUT -                                                            * 23800021
*    USER TRAILER LABELS ARE WRITTEN ON THE FIRST VOLUME FOR NEW DA   * 24000021
*    DATA SETS.                                                       * 24200021
*                                                                     * 24400021
* EXTERNAL REFERENCES -                                               * 24600021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 24800021
*    CONVERT ROUTINE TTR TO MBBCCHHR.                                 * 25000021
*    USER'S OUTPUT LABEL EXIT ROUTINES - ENTERED FROM IFG019RA   Y02082 25200002
*    THROUGH IECRES-UEXIT MACRO WITH THE FOLLOWING INPUT         Y02082 25400002
*       REG 0    CONTAINS NO MEANINGFUL INFO                          * 25600021
*           1    POINTER TO 4 WORD PARAMETER LIST WHICH CONTAINS -    * 25800021
*                POINTER TO LABEL BUFFER                              * 26000021
*                POINTER TO DCB                                       * 26200021
*                FLAG BYTE, PTR TO STATUS INFO (IF PERMANENT ERROR)   * 26400021
*                OR ZERO                                              * 26600021
*                POINTER TO IMAGE AREA (IF TOTALING WAS REQUESTED)    * 26800021
*                OR ZERO                                              * 27000021
*           2-13 CONTENTS OF USER'S REGS BEFORE I/O SUPP. LOADED Y02082 27200002
*                BY IFG019RA                                     Y02082 27250002
*           14   RETURN ADDRESS                                       * 27400021
*           15   EXIT ADDRESS                                         * 27600021
*                                                                     * 27800021
*    THE LOCK BIT (BIT 6) IN DCBOFLGS FIELD IS SET TO            Y02082 28400002
*    1 TO PREVENT ANOTHER I/O SUPPORT FUNCTION FROM OPERATING ON THIS * 28600021
*    DCB WHILE THE USER IS IN CONTROL.  ON RETURN FROM THE USER'S     * 28800021
*    ROUTINE, THIS BIT IS RESET TO 0.                                 * 29000021
*                                                                     * 29200021
* EXITS, NORMAL -                                                     * 29400021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 29600021
*    CLOSE DA WRITE FILE MARK FUNCTION.                               * 29800021
*                                                                     * 30000021
* EXITS, ERROR -                                                      * 30200021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 30400021
*    EXIT WITH THE FOLLOWING INTERNAL CODES--                         * 30600021
*       89 - 314 ABEND - ERROR IN READING THE FORMAT 1 DSCB FROM      * 30800021
*                        THE FIRST VOLUME.                            * 31000021
*    NO USER LABEL EXTENT EXISTS-THE APPROPRIATE EXIT ROUTINE IS      * 31200021
*    ENTERED WITH THE BUFFER POINTER SET TO ZERO.   OTHER             * 31400021
*    INPUT AS USUAL.                                                  * 31600021
*    I/O ERROR WRITING A USER LABEL - THE USER'S ROUTINE IS ENTERED.  * 31800021
*    AGAIN WITH                                                       * 32000021
*       BIT 0 OF FLAG BYTE SET TO ONE, PTR TO STANDARD                * 32200021
*       STATUS INFORMATION.                                           * 32400021
*    OTHER INPUT AS FOR NORMAL ENTRY.                                 * 32600021
*                                                                     * 32800021
* TABLES/WORK AREAS -                                                 * 33000021
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 33200021
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 33400021
*                                                                     * 33600021
* ATTRIBUTES -                                                        * 33800021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 34000021
*                                                                     * 34200021
* CHARACTER CODE DEPENDENCY -                                         * 34400021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 34600021
*                                                                     * 34800021
* NOTES -                                                             * 35000021
*    NOT APPLICABLE                                                   * 35200021
*                                                                     * 35400021
*********************************************************************** 35600021
         EJECT                                                          35800021
*    OBTAIN USER LABEL WORK AREA FOR CLOSE                       Y02082 35850002
         IECRES GET,LV=USERLDM,PREFIX=YES,STM=(2,14,WTGPREFX),   Y02082*35900002
               SP=K229,ID=ULWA                                   Y02144 35950002
         STM   RES,RC,0(R1)             SAVE REGS 5-12 FOR CALLER       36600021
         LR    RC,R1                    SET BASE FOR ULWK DSECT         36800021
*    OBTAIN USER LABEL WORK AREA FOR USER                        Y02082 36830002
         IECRES GET,LV=USERLU,PREFIX=NO,STM=(2,14,WTGPREFX),     Y02082*36860002
               SP=K229,KEY=USER                                  Y02082 36890002
         USING ULUWK,R9                 DEFINE USER'S UL BASE    Y02082 36920002
         LR    R9,R1                    ADDR OF GOTTEN CORE      Y02082 36950002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 36980002
         NI    ULREQ,X'FF'-LASTNTRY     TURN OFF LAST ENTRY INDIC IF ON 37000021
         XC    DXCCW1(DXCCW8-DXCCW1),DXCCW1  CLEAR CHAN PROG AREA       37200021
*                                                                       37400021
*        DETERMINE IF A USER LABEL EXTENT HAS BEEN ALLOCATED FOR THIS   37600021
*        DATA SET.                                                      37800021
*                                                                       38000021
         CLI   DSCEXTYP,ULEXT           IS 1ST EXTENT FOR USER LABELS   38200021
         BE    CDA05200                 YES, CONTINUE                   38400021
*                                                                       38600021
*        NO USER LABEL TRACK WAS ALLOCATED.  EXIT TO USER'S ROUTINE     38800021
*        WITH POINTER TO LABEL BUFFER ZEROED.                           39000021
*                                                                       39200021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 39230002
         XC    ULERRPTR,ULERRPTR        CLEAR ANY ERROR INDICTNS        39400002
         SR    R1,R1                    BUFFER POINTER TO ZERO          39600021
         LA    RB,CDA05500              POINT TO RETURN AFTER SYNCH     39800021
         B     CDA06300                 GO SYNCH TO USER                40000021
*                                                                Y02134 40050002
*        RETURN IN DATAMGT KEY                                   Y02134 40100002
*                                                                Y02134 40150002
*                                                                       40200021
*        EXTENT EXISTS - PROCESS USER LABELS                            40400021
*                                                                       40600021
CDA05200 EQU   *                                                        40800021
         XC    DXDAADDR,DXDAADDR        ZERO IOBOADAD IN IOS' IOB       41000021
         MVC   DXDAADDR+K3(K4),DSCLOWLM  CCHH FROM START OF 1ST EXTENT  41200021
*                                                                       43000021
*        PROCESS USER TRAILER LABELS.                                   43200021
*                                                                       43400021
*                                                                       43600021
*        STRUCTURE COUNT AND KEY FIELDS IN WORK AREA.  SET IOBDADAD     43800021
*        IN I/O SUPPORT'S IOB.                                          44000021
*                                                                       44200021
         LA    R1,ULWK8                 ADDR OF COUNT                   44400021
         ST    R1,DXCCW1                READ COUNT INTO WK1             44600021
         LA    R1,ULWK10                ADDR OF KEY                     44800021
         ST    R1,DXCCW2                SEARCH ON KEY IN WK3            45000021
         LA    R1,DXCCW1                ADDR OF READ COUNT CCW          45200021
         ST    R1,DXCCW3                TIC TO CCW1                     45400021
         OC    DXCCW1(K32),ULCP13       OR CP SKELETON OVER ADDRESSES   45600021
         MVC   ULWK10,UTLCONS3          KEY=UTLO FOR SEARCH KEY EQUAL   45800021
*                                                                       46000021
         BAL   RB,CDA06000              EXECUTE CP TO FIND UTL0         46200021
         TM    DXECB,ECBNOERR           CHECK FOR I/O ERROR             46400021
         BZ    CDA05400                 ERROR, BR TO SET UP EXIT TO USR 46600021
         SPACE                                                          46800021
*                           SET UP  CP TO WRITE USER TRLR               47000021
*                           AS EACH LABEL (UTLN) IS WRITTEN, A FILE     47200021
*                           MARK (UTL(N+1)) WILL BE WRITTEN FOLLOWING   47400021
*                                                                       47600021
         XC    DXCCW1(DXCCW5-DXCCW1),DXCCW1  CLEAR CHNL PGM 1 OUT       47800021
         LA    R1,DXDAADDR+K3           ADDR OF ID                      48000021
         ST    R1,DXCCW1                SEARCH ID FROM IOBDADAD+3       48200021
         LA    R1,DXCCW1                ADDR OF SEARCH ID CCW           48400021
         ST    R1,DXCCW2                TIC TO CCW1                     48600021
         LA    R1,ULWK8                 ADDR OF COUNT AND KEY           48800021
         ST    R1,DXCCW3                WRITE C,K FROM ULWK1            49000021
         LA    R1,ULWK5                 ADDR OF DATA                    49200021
         ST    R1,DXCCW4                WRITE LABEL FROM BUFFER         49400021
         OC    DXCCW1(K32),ULCP23       OR CP SKELETON OVER ADDRESSES   49600021
         MVC   DXCCW5(K24),DXCCW1       APPEND CP FOR WRITE CHECKING    49800021
         LA    R1,DXCCW5                ADDR OF SEARCH ID CCW           50000021
         ST    R1,DXCCW6                TIC BACK TO CCW5                50200021
         MVI   DXCCW6,CCWTIC            RESTORE TIC OP                  50400021
         MVI   DXCCW7,X'1E'             MAKE OP READ                    50600021
         OI    DXCCW7+K4,X'10'          SET SKIP BIT ON                 50800021
         NI    DXCCW7+K4,X'FF'-CCWCMDCH  TURN OFF CC FLAG IN LAST CCW   51000021
         MVC   ULWK5(K12),ULWK8         SET UP COUNT, KEY FOR FILE MARK 51200021
         SR    R1,R1                    CLEAR R1                        51400021
         STC   R1,ULWK6+K3              DATA LENGTH=0 FOR FILE MRK      51600021
*                                       IF DISP=MOD,UTL0 MAY HAVE       51800021
*                                       LENGTH OF 80 BYTES              52000021
CDA05300 EQU   *                                                        52200021
         IC    R1,ULWK9                 R OF COUNT FOR UTL TO BE WRITTN 52400021
         BCTR  R1,0                     R-1                             52600021
         STC   R1,DXDAADDR+K7           R IN IOBDADAD                   52800021
         LA    R1,K2(,R1)               R-1+2=R+1                       53000021
         STC   R1,ULWK6                 R IN COUNT FIELD OF UTL(N+1)    53200021
*                                                                       53400021
         IC    R1,ULWK10+K3             N FROM LABEL TO BE WRITTEN      53600021
         LA    R1,K1(,R1)               N+1                             53800021
         STC   R1,ULWK7+K3              KEY FOR UTL(N+1)                54000021
*                                                                       54200021
         MVI   ULWK9+K3,K80             DATA LENGTH = 80 FOR UTLN       54400021
*                                                                       54600021
         CLI   ULWK7+K3,MAXNOLAB        CHECK IF 8 TRAILERS      YM1122 54800002
         BH    CDA05500                 YES,BR TO SET UP RETURN  YM1170 55000002
*                                                                       55200021
         MVC   ULDMBUFR(K4),ULWK7       PRIME LAB BUFF WITH UTLN YM1122 55400002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 55405002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 55410002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 55415002
*    GET LOCAL LOCK                                              Y02082 55420002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*55425002
               RELATED=('PREVENT FREE USER CORE-RELEASE BELOW')  Y02082 55430002
*                                                                Y02082 55435002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 55445002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 55450002
*    VERIFY USER STILL HOLDS USER LABEL WORK AREA CORE           Y02082 55455002
         OC    ULUWK(USERLU),ULUWK      PGM CHK IF NOT USER CORE Y02082 55460002
*                                                                Y02082 55465002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 55470002
         MVC   ULBUFR(K4),ULDMBUFR      COPY 'UTLN' TO USER BUFF Y02082 55475002
*                                                                Y02082 55480002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 55485002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 55490002
*    RELEASE LOCAL LOCK                                          Y02082 55495002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 55500002
*                                                                Y02082 55505002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 55515002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 55520002
*                                                                       55600021
*        GO TO USER'S ROUTINE TO CONSTRUCT LABEL.                       55800021
*                                                                       56000021
         BAL   RB,CDA06100              GO EXIT TO USER'S ROUTINE       56200021
*                                                                Y02134 56250002
*        RETURN IN DATAMGT KEY                                   Y02134 56300002
*                                                                Y02134 56350002
         LTR   RF,RF                    CHECK FOR RETURN CODE=0         56600021
         BZ    CDA05500                 CODE IS ZERO, BRANCH TO RETURN  56800021
         ST    RF,ULWK1                 SAVE RETURN CODE                57000021
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 57005002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 57010002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 57015002
*    GET LOCAL LOCK                                              Y02082 57020002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*57025002
               RELATED=('PREVENT FREE USER CORE-RELEASED BELOW') Y02082 57030002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 57040002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 57045002
*    VERIFY USER STILL HOLDS USER LABEL WORK AREA CORE           Y02082 57050002
         OC    ULUWK(USERLU),ULUWK      PGM CHK IF NOT           Y02082 57055002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 57060002
*                                                                Y02082 57065002
         MVC   ULDMBUFR,ULBUFR          COPY USER'S BUFFER       Y02082 57070002
         MVC   ULDMBUFR(K4),ULWK7       PRIME LAB BUFF WITH UTLN YM1122 57072002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 57075002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 57080002
*    RELEASE LOCAL LOCK                                          Y02082 57085002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 57090002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 57100002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 57105002
         BAL   RB,CDA06000              GO WRITE LABEL                  57200021
*                                                                       57400021
         TM    DXECB,ECBNOERR           CHECK FOR I/O ERROR             57600021
         BZ    CDA05400                 YES, BR TO TAKE SPECIAL EXIT    57800021
         CLI   ULWK1+K3,READNEXT        CHECK RET CODE FOR MORE LABELS  58000021
         BE    CDA05500                 NO, PREVIOUS LABEL WAS LAST     58200021
         CLI   ULWK1+K3,WRITNEXT        CHECK IF RETURN CODE IS VALID   58400021
         BNE   CDA05500                 BRANCH IF NOT VALID             58600021
*                                                                       58800021
         MVC   ULWK8(K12),ULWK5         UTL(N+1) BECOMES C,K OF NXT LBL 59000021
         B     CDA05300                 BR TO PROCESS NEXT LABEL        59200021
         EJECT                                                          59400021
CDA05400 EQU   *                                                        59600021
*                                                                       59800021
*        IF AN I/O ERROR OCCURS WRITING USER TRAILER LABELS, A SPECIAL  60000021
*        EXIT IS TAKEN TO THE USER'S ROUTINE.  INPUT TO THE USER'S      60200021
*        ROUTINE IS THE SAME AS FOR OTHER EXITS WITH ONE EXCEPTION-     60400021
*        IN THE THIRD WORD OF THE PARAMETER LIST, BIT 0 IS SET TO ONE   60600021
*        AND THE THREE LOW ORDER BYTES CONTAIN A POINTER TO STATUS      60800021
*        INFO (PTR TO IOB).                                             61000021
*                                                                       61200021
         LA    R1,DXIOB                 INSERT POINTER TO STATUS INFO   61400021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 61450002
         ST    R1,ULERRPTR              IN PARAMETER LIST               61600021
         OI    ULERRPTR,ERROR           FLAG ERROR                      61800021
         BAL   RB,CDA06200              GO TO SYNCH TO USER             62000021
*    CONTROL WILL BE RETURNED HERE IN DATA MANAGEMENT KEY        Y02082 62050002
*                                                                       62200021
*        DETERMINE WHICH I/O SUPPORT FUNCTION  REQUIRED USER            62400021
*        TRAILER LABELS TO BE WRITTEN                                   62600021
*                                                                       62800021
CDA05500 EQU   *                        SET RETURN FOR TRLR PROCESSING  63000021
*                                                                       63200021
*        CONTROL IS FROM CLOSE.  FOR NEW DIRECT DATA SETS, THE          63400021
*        UCB ADDRESS IN THE WORK DEB REFLECTS THE 1ST VOLUME AND MUST   63600021
*        BE RESTORED TO THE UCB ADDRESS FOR THE CURRENT VOLUME BEFORE   63800021
*        CONTINUING WITH CLOSE PROCESSING.                              64000021
*                                                                       64200021
         L     RB,DXTIOTAD              GET TIOT ADDR            Y02082 64250002
         USING TIOENTRY,RB              TIOT ENTRY BASE          Y02082 64300002
         L     RUCB,DXUCBADR            GET ADDRESS OF CURR UCB  Y02134 64400002
         DROP  RB                                                Y02082 64450002
*                                                                       66800021
         ST    RUCB,DXCCW10             STORE UCB ADDRESS        Y02134 67000002
         MVC   DXDEBUCB+K1(K3),DXCCW10+K1  RESTORE WORK DEB UCB ADDR    67200021
*    FREEMAIN USER'S USER LABEL WORK AREA                        Y02082 67230002
         IECRES FREE,A=(R9),PREFIX=NO,SP=K229,LV=USERLU,         Y02082*67260002
               KEY=USER,STM=(2,14,WTGPREFX)                      Y02082 67290002
*                                                                Y02082 67320002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 67350002
*                                                                       67400021
*        FREE  WORKAREA AND LABEL BUFFER AND XCTL TO I/O SUPPORT        67600021
*        MODULE WHICH CALLED THIS MODULE.                               67800021
*                                                                       68000021
         LR    R1,RC                    START OF AREA TO BE FREED       68200021
         LM    RES,RC,0(R1)             RESTORE CALLING MODULE'S REGS   68400021
         IECRES FREE,A=(R1),PREFIX=YES,STM=(2,14,WTGPREFX)       Y02082 68430002
*                                                                       69000021
         SR    RET,RET                  SET UP FOR BRANCH TABLE         69200021
         IECRES LOAD,MODID=DAFINMOD,BRCODE=(RET),BRANCH=QUEUED   Y02080 69450002
*                                       XCTL TO DAFINMOD         Y02080 69500002
         EJECT                                                          69600021
         SPACE 2                                                        69800021
*                                                                       70000021
*        CLOSED SUBROUTINE TO ISSUE I/O OPERATIONS                      70200021
*                                                                       70400021
         SPACE                                                          70600021
*        IT IS ASSUMED THAT ALL CONTROL BLOCKS HAVE ALREADY BEEN SET UP 70800021
         SPACE 3                                                        71000021
CDA06000 EQU   *                                                        71200021
         EXCP  DXIOB                    INITIATE I/O                    71400021
*                                                                       71600021
         IECRES WAIT                    WAIT FOR I/O COMPLETION         71800021
*                                                                       72000021
         BR    RB                       UNCONDITIONAL BRANCH            72200021
         EJECT                                                          72400021
*        CLOSED SUBROUTINE TO ISSUE IECRES-UEXIT MACRO TO GIVE   Y02082 72600002
*        CONTROL TO USER EXIT ROUTINE FROM IFG019RA.             Y02082 72700002
*        REGISTER CONTENTS AT ENTRY TO USER EXIT ARE AS FOLLOWS-        73400002
*                        R0 - CONTAINS NO MEANINGFUL INFO               73600021
*                        R1 - PTR TO PARAMETER LIST                     73800021
*                    R2-R13 - USER'S CONTENTS BEFORE I/O SUPPORT        74000021
*                       R14 - RETURN ADDRESS                            74200002
*                       R15 - EXIT ADDRESS                              74400021
*                                                                       74600021
CDA06100 EQU   *                                                        74800021
         XC    ULERRPTR,ULERRPTR        ZERO ERROR INDICATIONS          75000021
CDA06200 EQU   *                                                        75200021
         LA    R1,ULBUFR                PTR TO LABEL BUFFER             75400021
CDA06300 EQU   *                                                        75600021
         ST    R1,ULPARM                PTR TO LABEL BUFFER      Y02082 75650002
         L     R1,DXUDCBAD              GET USER'S DCB ADDR      Y02082 75700002
         ST    R1,ULPARM+K4             PUT IN PARM LIST         Y02082 75750002
         XC    ULTOTPTR,ULTOTPTR        ZERO TOTALING AREA              76000021
         TM    DCBDSORG,DCBORGDA        CK FOR DIRECT ORGANIZATION      76200021
         BO    CDA06400                 BR IF DIRECT                    76400021
         TM    DCBMACRF,DCBMEXCP        CK IF EXCP                      76600021
         BO    CDA06400                 BR IF EXCP,SKIP TOTALING        76800021
         TM    DCBOPTCD,DCBOPTT         TEST,BR IF USER TOTALING        77000021
         BZ    CDA06400                 HAS NOT BEEN REQUESTED          77200021
*                                                                       77400021
         L     R7,DCBDEBAD              GET ADDRESS OF USER'S DEB       77600021
         SR    R1,R1                    CLEAR WORK REG                  77800021
         IC    R1,DEBNMEXT-DEB(R7)      GET NUMBER OF EXTENTS           78000021
         SLL   R1,K4                    MULTIPLY BY 16                  78200021
         L     R7,K36(R1,R7)            GET ADDR TOTALING WORKAREA-     78400021
*                                       DEB ADDR+32+4+LENGTH EXTENTS    78600021
         USING TOTSAVWA,R7              SET BASE - TOTALING AREA        78800021
         MVC   ULTOTPTR,TOTEOVPT        CURRENT IMAGE AREA ADDR TO      79000021
*                                       USR LBL PARM LIST               79200021
         DROP  R7                       DROP TOTALING AREA BASE         79400021
*                                                                       79600021
CDA06400 EQU   *                                                        79800021
         MODESET EXTKEY=DATAMGT         ASSUME DATAMGT KEY       Y02134 79810002
         NI    DCBOFLGS,X'FF'-DCBOLOCK  SET LOCK BIT = 0         Y02082 79850002
*                                                                Y02082 79900002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 79950002
*                                                                Y02082 79960002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,WTGPREFX)          Y02082 79970002
*                                                                Y02082 79980002
         LA    R1,ULPARM                POINT TO PARAMETER LIST         80000021
         IECRES UEXIT,EXITAD=ULREQ,STM=(2,13,WTGPREFX)           Y02082 80600002
         L     RDCB,DXUDCBAD            GET PTR TO USER'S DCB    Y02082 83810002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER'S KEY      Y02082 83820002
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT = 1         Y02082 83840002
         IC    R1,DCBOFLGS              GET USER'S DCBOFLGS      Y02082 83842002
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 83846002
         L     RDCB,DXPDCBAD            POINT TO COPIED DCB      Y02082 83846402
         LA    R0,DCBOBUSY              SET MASK FOR BUSY BIT    Y02082 83848002
         NR    R1,R0                    SELECT THE BUSY BIT      Y02082 83848402
         IC    R0,DCBOFLGS              COMBINE WITH DCBOFLGS    Y02082 83848802
         OR    R1,R0                      FROM COPIED DCB.       Y02082 83849202
         STC   R1,DCBOFLGS              UPDATE DCBOFLGS IN COPY  Y02082 83849602
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT = 1                84200021
         MVC   ULDMBUFR(K4),ULWK10      REINSERT UTLN/UHLN       Y02082 84230002
         BR    RB                       UNCONDITIONAL BRANCH            84600021
         EJECT                                                          84800021
         SPACE 1                                                        85000021
**********************************************************************  85200021
*                                                                    *  85400021
*                    CONSTANTS                                       *  85600021
*                                                                    *  85800021
**********************************************************************  86000021
         SPACE 1                                                        86200021
         DS    0F                                                       86400021
UTLCONS3 DC    C'UTL0'                  KEY USED IN SEARCH KEY EQ       86600021
ULCP13   CCW   X'12',0,X'40',8          READ COUNT                      86800021
         CCW   X'29',0,X'40',4          SEARCH KEY EQUAL                87000021
         CCW   X'08',0,0,0              TIC                             87200021
         CCW   X'03',0,0,1              NOP                             87400021
*                                                                       87600021
ULCP23   CCW   X'31',0,X'40',5          SEARCH ID EQUAL                 87800021
         CCW   X'08',0,0,0              TIC TO CCW1                     88000021
         CCW   X'1D',0,X'40',92         WRITE CKD    UTLO     LABEL     88200021
         CCW   X'1D',0,X'40',12         WRITE CKD    UTL0     FILE MARK 88400021
         XCTLTABL ID=(DAFINMOD,2E),SVC=020,BRT=YES,LENGTH=       Y02080 88600002
         IECDSECS CVT,TCB,RB,TIOT,DCB,DEB,UCB,MAIN,USERLAB,USERTOT,    *88800021
               PREFX,WTG,PSA,RRPL,EXPAND=YES                     Y02144 88850002
         IECEQU                                                         89200021
         END                                                            89400021
