         TITLE 'IFG0202E - DIRECT ACCESS FINAL PROCESSING'              00200021
IFG0202E CSECT                                                          00800021
*********************************************************************** 01000021
*                                                                     * 01200021
*      VS2 RELEASE 03.7 DELETIONS/CHANGES                             * 01250000
*0000                                                          @ZA12212 01300000
*                                                                     * 01350000
*                                                                     * 01400021
*          RELEASE 21.7 DELETIONS/CHANGES                             * 01450002
*0000038000,172000,342000,348000,440000,594000,599600,602000,   SA53753 02201002
*0000718500-720320,742000,750000-752000,814000                  SA53753 02202002
*0000600920-601220,812530-812550                                SA53147 02252002
*          RELEASE 21 DELETIONS/CHANGES                               * 02400021
*0000                                                            A37487 02430021
*0000056000-058000,172000,220000-236000,330000-334000,350000-    A38013 02460021
*0000352000,626000,642000-658000,722000-724000,814000            A38013 02520021
*0000812000                                                     SA51711 02530021
*0000578000                                                      M1801  02570021
*0000770000                                                     SA50728 02580021
*0000777000                                                      M4362  02590021
*                                                                     * 02600021
* MODULE NAME = IFG0202E                                              * 02650002
*                                                                     * 02700002
* DESCRIPTIVE NAME = DIRECT ACCESS FINAL PROCESSING                   * 02750002
*                                                                     * 02760002
* COPYRIGHT = NONE                                                    * 02770002
*                                                                     * 02780002
* STATUS CHANGE LEVEL 000                                             * 02800021
*                                                                     * 03000021
* FUNCTION -                                                          * 03200021
*    THIS MODULE CONTAINS THE FUNCTION(S) OR PART(S) OF FUNCTION(S)-- * 03400021
*    CLOSE DA WRITE FILE MARK FUNCTION.                               * 03600021
*    CLOSE DA EXIT FUNCTION.                                          * 03800002
*    CLOSE DA PARTIAL RELEASE INTERFACE FUNCTION.                     * 03801002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)' FOR DETAILS.         * 04000021
*                                                                     * 04200021
* ENTRY POINTS -                                                      * 04400021
*         IFG0202E - ENTRY POINT VIA AN XCTL FROM THE FOLLOWING--     * 04600021
*             INITIAL ENTRY--                                         * 04800021
*                IFG0200Y - PROCESS CLOSE DA WRITE FILE MARK          * 05000021
*                IFG0201R   FUNCTION.                                 * 05200021
*                IFG0202D                                             * 05400021
*                IFG0RR0B                                             * 05401002
*             DADSM PARTIAL RELEASE MODULE - PROCESS CLOSE DA WRITE   * 05402002
*                        DSCB FUNCTION.                               * 05403002
*             SECOND ENTRY--                                          * 06000021
*                IFG0200P - CONTINUE PROCESSING CLOSE DA WRITE FILE   * 06200021
*                           MARK FUNCTION.                            * 06400021
*             THIRD ENTRY--                                           * 06600021
*                IFG0200P - PROCESS CLOSE DA EXIT FUNCTION.           * 06800021
*                IFG0200Y                                             * 06860021
*                IFG0202C                                             * 06920021
*                                                                     * 07000021
* INPUT -                                                             * 07200021
*    ENTERED IN DATA MANAGEMENT KEY                              Y02082 07250002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 07400021
*                                                                     * 07600021
* OUTPUT -                                                            * 07800021
*    EXIT IN DATA MANAGEMENT KEY                                 Y02082 07850002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 08000021
*                                                                     * 08200021
* EXTERNAL REFERENCES -                                               * 08400021
*         IFG019RA - OPEN/CLOSE/EOV RESIDENT ROUTINE FOR XCTL AND     * 08600002
*                    WAIT.                                            * 08800021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 09000021
*                                                                     * 09200021
* EXITS, NORMAL -                                                     * 09400021
*    EXIT VIA THE RESIDENT ROUTINE XCTL TO THE FOLLOWING--            * 09600021
*         IFG0202H - PROCESS CLOSE/EOV SMF DATA SET FUNCTION.         * 09700021
*         IFG0202J - PROCESS CLOSE FINAL STRING.                      * 09800021
*         IFG0RR0B - FORCE CLOSE PROCESSING.                          * 09800502
*    OR AN XCTL MACRO INSTRUCTION TO DADSM PARTIAL RELEASE MODULE     * 09801002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 10000021
*                                                                     * 10200021
* EXITS, ERROR -                                                      * 10400021
*    EXIT IS TO THE PROBLEM DETERMINATION MODULE IFG0200P, IF AN      * 10600021
*    ABEND SITUATION OCCURS IN THIS MODULE.  REFER TO THE FOLLOWING   * 10800021
*    'FUNCTION PROLOG(S)'.                                            * 11000021
*                                                                     * 11200021
* TABLES/WORK AREAS -                                                 * 11400021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 11600021
*                                                                     * 11800021
* ATTRIBUTES -                                                        * 12000021
*    REENTRANT, REFRESHABLE, READ-ONLY, ENABLED, PRIVILEGED           * 12200021
*                                                                     * 12400021
* CHARACTER CODE DEPENDENCY -                                         * 12600021
*    CLASS ONE CHARACTER CODE DEPENDENCY - THE EBCDIC CHARACTER CODE  * 12800021
*    WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED IF A      * 13000021
*    DIFFERENT CHARACTER SET IS USED FOR EXECUTION.                   * 13200021
*                                                                     * 13400021
* NOTES -                                                             * 13600021
*    THIS MODULE HAS AN ALIAS NAME OF IFG0202E.                       * 13700002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 13800021
*                                                                     * 14000021
*********************************************************************** 14200021
         EJECT                                                          14400021
*                                                                       14401002
         USING IHADCB,RDCB                                              14600021
         USING FORCORE,RCORE                                            14800021
         USING TCB,RET                                                  15000021
         USING UCBOB,RUCB                                               15200021
         USING CVT,RD                                                   15400021
         USING TIOENTRY,RTIOT                                           15600021
         USING DEB,RDEB                                                 15800021
         USING WTG,RWTG                                          A38013 15860021
         USING WTGENTRY,RWTGC                                    A38013 15920021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         16000021
         USING *,RBASE                                                  16200021
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM6520 16201002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM6520 16202002
         BE    CDA06560                 BRANCH IF RECOVERY ENTRY YM6520 16203002
         TM    WTGPATHS,WTGPRLSE        ENTERED FROM PART RLSE  SA53753 16210002
         BO    CDA07940                 BR IF YES               SA53753 16220002
         B     CDA06550(RET)            USE BRANCH TABLE                16400021
CDA06550 EQU   *                                                        16600021
         B     CDA06560                 INITIAL ENTRY                   16800021
         B     CDA07000                 ENTRY FROM P. D. RTN            17000021
         B     CDA07840                 ENTRY TO DA EXIT        SA53753 17200002
         EJECT                                                          17400021
*                                                                     * 17600021
*                          FUNCTION PROLOG                            * 17800021
*                                                                     * 18000021
*********************************************************************** 18200021
*                                                                     * 18400021
* FUNCTION NAME -                                                     * 18600021
*    CLOSE DA WRITE FILE MARK FUNCTION.                               * 18800021
*                                                                     * 19000021
* (STATUS) -                                                          * 19200021
*    NOT APPLICABLE                                                   * 19400021
*                                                                     * 19600021
* FUNCTION -                                                          * 19800021
*    WRITE A FILE MARK FOR A PHYSICAL SEQUENTIAL DATA SET OPENED FOR  * 20000021
*    OUTPUT PROCESSING.                                               * 20200021
*                                                                     * 20400021
* ENTRY POINTS -                                                      * 20600021
*    ENTERED FROM THE FOLLOWING--                                     * 20800021
*    CLOSE DA WRITE DSCB FUNCTION.                                    * 21000021
*    CLOSE DA OUTPUT USER LABELS FUNCTION.                            * 21200021
*                                                                     * 21400021
* INPUT -                                                             * 21600021
*    A POINTER TO EACH OF THE FOLLOWING--                             * 21800021
*       CURRENT PARAMETER LIST ENTRY- RPARC                           * 22000021
*       DD ENTRY IN THE TIOT- RTIOT                                   * 22200021
*       WTG TABLE- RWTG                                               * 22400021
*       CURRENT WTG TABLE ENTRY- RWTGC                                * 22600021
*       DCB- RDCB                                                     * 22800021
*       WORK AREA- RCORE                                              * 23000021
*       RESIDENT ROUTINE- RES                                         * 23200021
*       UCB- RUCB                                                     * 23400021
*       DEB- RDEB                                                     * 23600021
*                                                                     * 23800021
* OUTPUT -                                                            * 24000021
*    FILE MARK IS WRITTEN.                                            * 24200021
*                                                                     * 24400021
* EXTERNAL REFERENCES -                                               * 24600021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 24800021
*                                                                     * 25000021
* EXITS, NORMAL -                                                     * 25200021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 25400021
*    CLOSE DA EXIT FUNCTION.                                          * 25600021
*                                                                     * 25800021
* EXITS, ERROR -                                                      * 26000021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 26200021
*    EXIT WITH THE FOLLOWING INTERNAL CODES--                         * 26400021
*       90 - 614 ABEND - ERROR IN WRITING FILE MARK.                  * 26600021
*      234 - 614 ABEND - M IN DCBFDAD REFRENCES AN EXTENT        Y02082 26650002
*                        IN THE DEB WHICH IS NOT THERE           Y02082 26700002
*                                                                     * 26800021
* TABLES/WORK AREAS -                                                 * 27000021
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 27200021
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 27400021
*                                                                     * 27600021
* ATTRIBUTES -                                                        * 27800021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 28000021
*                                                                     * 28200021
* CHARACTER CODE DEPENDENCY -                                         * 28400021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 28600021
*                                                                     * 28800021
* NOTES -                                                             * 29000021
*    NOT APPLICABLE                                                   * 29200021
*                                                                     * 29400021
*********************************************************************** 29600021
         EJECT                                                          29800021
CDA06560 EQU   *                                                        30000021
         LR    RET,RUCB                   MAIN UCB ADDRESS       Y02080 30050002
         USING UCBOB,RUCB                                               32000021
*                                                                       32200021
* NOTE- CLOSE WILL NOT PERFORM ANY DIRECT ACCESS DISPOSITION.           32400021
*       SCHEDULER WILL ASSUME THIS FUNCTION.                            32600021
*                                                                       32800021
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP                      33600021
         BZ    CDA06600                 BRANCH IF NOT EXCP              33800021
         TM    DCBMCRF1,DCBMDEV         TEST FOR PRESENCE OF DA DEV DEP 34000021
         BZ    CDA08000                 BRANCH IF NOT PRESENT   XA02024 34200002
         TM    DCBMACRF,DCBMRCI         COMMON INTERFACE        XA02024 34250002
         BZ    CDA08000                 NO, GO TO DA END        XA02024 34300002
CDA06600 EQU   *                                                        34400021
         TM    DCBDSORG,DCBORGPO        IS IT PO                XA02024 34450002
         BO    CDA07840                 YES, GO CHECK PRLSE     XA02024 34500002
         TM    DCBDSORG,DCBORGPS        TEST FOR PHYSICAL SEQUENTIAL    34600021
         BZ    CDA08000                 BR IF NOT PHYSICAL SEQ  XA02024 34800002
         NC    DCBFDAD+K3(K4),DCBFDAD+K3 TEST CCHH FOR ZERO     SA51711 34810000
         BZ    CDA08000                 BRANCH IF TRUE          SA51711 34820000
         SR    RC,RC                    CLEAR REGISTER                  35400021
         IC    RC,DCBFDAD               GET M (CURRENT EXTENT NUMBER)   35600021
         CLM   RC,B'0001',DEBNMEXT      ARE THERE M EXTENTS      Y02082 35650002
*                                       IN THE DEB               Y02082 35700002
CABD614  EQU   234                      BAD DCBFDAD INTERNAL     Y02082 35750002
*                                       ABEND CODE               Y02082 35760002
         LA    R0,CABD614               LOAD INTERNAL ABCODE     Y02082 35770002
         BNL   CDA08210                 BRANCH IF NO-ABEND       Y02082 35780002
         SLL   RC,K4                    MULTIPLY BY 16                  35800021
         AR    RDEB,RC                  CAN POINT TO CURRENT EXTENT     36000021
         MVC   DXDEBBIN(K12),DEBBINUM   GET NR OF USER EXTENTS          36200021
         MVC   DXCCW4+K1(K8),DCBFDAD    MOVE MBBCCHHR TO WORKAREA       36400021
*                                                                       36410002
* THIS CODE WILL NOT ALLOW A FILE MARK TO BE WRITTEN ON THE     SA56326 36420002
* CURRENT AND THE NEXT TRACK WHEN DCBFDAD FIELD CCHH=00000000   SA56326 36430002
* OR FFFFFFFF.                                                  SA56326 36440002
*                                                               SA56326 36442002
         CLC   DXCCW4+K4(K4),FOXES      TEST FOR NO DATA        SA56326 36450002
         BE    CDA08000                 BR TO EXIT IF NO DATA   SA56326 36460002
*                                       ..WITHOUT WRITING EOF   SA56326 36470002
         NC    DXCCW4+K4(K4),DXCCW4+K4  TEST FOR ZERO           SA56326 36480002
         BZ    CDA08000                 BR IF NO DATA           SA56326 36490002
*                                       ..WITHOUT WRITING EOF   SA56326 36500002
         MVI   DXDEBMOD,X'C0'           SET MODFY IN DEB                36600021
         L     R1,DCBDVTBL              ADDRESS OF DEVICE TABLE         36800021
         LH    RF,K4(R1)                PICK UP NR OF BYTES PER TRACK   37000021
         CH    RF,DCBTRBAL              IS FULL TRCK AVAILABLE FOR FM   37200021
         BE    CDA07600                 BR IF FULL TRCK AVAILABLE       37400021
*                                       RC NOT ZEROED BEFORE INSERT     37600021
         TM    DCBMCRF1,DCBMWRIT+DCBMWID  TEST FOR BDAM          A37487 37660021
         BO    CDA06650                 YES, BR                  A37487 37720021
         TM    DCBRECFM,DCBRECFX+DCBRECST  TEST FOR FIXED STANDARD      37800021
         BNO   CDA07000                 BR , IF NOT F STANDARD          38000021
*    FOR FIXED STANDARD, WRITE FILE MARK ON EXISTING TRACK              38200021
*        BDAM DATA SET                                                  38260021
CDA06650 EQU   *                                                 A37487 38320021
         IC    RC,K7(R1)                LAST RECORD ID OV'HEAD          38400021
         TM    K9(R1),X'08'             TWO BYTE OVERHEAD USED          38600021
         BNO   CDA06700                 BRANCH NO                       38800021
         LH    RC,K6(R1)                GET TWO BYTE OVERHEAD           39000021
CDA06700 EQU   *                                                        39200021
         LR    RF,RC                    COPY RC                         39400021
         SR    RC,RC                    CLEAR REGISTER                  39600021
         IC    RC,DCBKEYCN              KEY O'HEAD (0 IF KEYS)          39800021
         SR    RF,RC                    HI ORDER 3 BYTES OF RF          40000021
*                                       ARE ZEROED                      40200021
         LR    RC,RDEB                  SAVE PTR TO CURRENT EXTENT      40400021
         L     RDEB,DCBDEBAD            PICK UP DEB ADDRESS             40600021
         SR    RD,RD                    CLEAR REGISTER                  40800021
         IC    RD,DEBNMEXT              PICK UP NO. OF EXTENTS          41000021
         SLL   RD,K4                    MULTIPLY BY 16                  41200021
         AR    RD,RDEB                  ADD DEB ADDRESS                 41400021
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP                      41600021
         BZ    CDA06800                 BRANCH,NOT EXCP                 41800021
         LA    RF,K8                    GET LENGTH NEEDED FOR FM        42000021
         B     CDA06900                 GO CK ENOUGH SPACE              42200021
CDA06800 EQU   *                                                        42400021
         TM    DCBMCRF1,DCBMWRIT+DCBMWID  TEST FOR BDAM          A37487 42420021
         BNO   CDA06850                 NO, BR                   A37487 42440021
         SR    RDEB,RDEB                ZERO REG                 A37487 42460021
         IC    RDEB,DCBKEYLE            GET KEY LENGTH           A37487 42480021
         AH    RDEB,DCBBLKSI            ADD BLOCKSIZE FROM DCB   A37487 42500021
         AR    RF,RDEB                                           A37487 42520021
*                                       RF=BLKSI+KEYLEN+ID-KEYOVHA37487 42540021
         B     CDA06900                 BR AROUND FIX STANDARD   A37487 42560021
CDA06850 EQU   *                                                 A37487 42580021
         AH    RF,K44(RD)               ADD KEYLENGTH+BLOCKSIZE         42600021
CDA06900 CH    RF,DCBTRBAL              WILL A RCD FIT ON THIS TK       42800021
         LR    RDEB,RC                  RESTORE PTR TO CURRENT EXTENT   43000021
         BP    CDA07000                 BR IF NO TO CK NEXT TRACK       43200021
         BAL   RC,CDA08100              BR IF YES TO SET UP TO WR FM    43400021
         IC    RF,DXCCW4+K8             GET R OF LAST REC WRITTEN       43600021
         LA    RF,K1(,RF)               INCR R BY 1.                    43800021
         STC   RF,DXCCW7+K4             STORE NEW R  COUNT BUFF SA53753 44000002
         LA    RET,K4                   SET UP FOR BR TABLE IF ERROR    44200021
         BAL   RC,CDA08200              GO TO WRITE FM.                 44400021
*    RECORD DOES NOT FIT ON THIS TRACK. CHECK NEXT TRACK.               44600021
CDA07000 EQU   *                                                        44800021
         SR    RF,RF                    CLEAR WORK REG                  45000021
         MVI   DXCCW4+K8,K0             SET R=0                         45200021
         IC    RF,DXCCW4+K7             (RF)=000H                       45400021
         LA    RF,K1(,RF)               RF=H+1                          45600021
         STC   RF,DXCCW4+K7             C(DXCCW4+7)=CCH(H+1)            45800021
         L     R1,DCBDVTBL              ADDRESS OF DEVICE TABLE         46000021
         CLC   DXCCW4+K7(K1),K3(R1)     IS TRACK VALID                  46200021
         BNL   CDA07100                 BR IF TRK NOT VALID             46400021
         L     R1,DCBDEBAD              DEB ADDRESS                     46600021
         TM    DEBOFLGS-DEB(R1),DEBOFSPL  CHK FOR SPLIT CYL             46800021
         BNO   CDA07600                 BR IF NO SPLIT CYL              47000021
         CLC   DXCCW4+K7(K1),DEBENDHH+K1  CHK FOR SPLIT CYL END TRK     47200021
         BNH   CDA07600                 BR IF NOT END TRACK             47400021
*              IF TRACK NOT VALID FOR DEVICE OR AT END OF SPLIT CYL     47600021
*              STEP TO NEXT CYLINDER                                    47800021
CDA07100 EQU   *                                                        48000021
CDA07400 EQU   *                        NOT 2321, ADD 1 TO CC           53200021
         LH    RF,DXCCW4+K4             C(RF)=00CC                      53400021
         LA    RF,K1(,RF)               C(RF)=00C(C+1)                  53600021
         SLL   RF,K16                   C(RF)=C(C+1)00                  53800021
*                                                                       54000021
CDA07500 EQU   *                        SET TRACK TO ZERO OR START      54200021
*                                       OF SPLIT CYLINDER               54400021
         ST    RF,DXCCW4+K4             C(DXCCW4+4)=NEXT CYL            54600021
         L     RF,DCBDEBAD              ADDR OF DEB                     54800021
         TM    DEBOFLGS-DEB(RF),DEBOFSPL  CHK FOR SPLIT CYL             55000021
         BZ    CDA07600                 BR IF NOT SPLIT CYL             55200021
         MVC   DXCCW4+K7(K1),DEBSTRHH+K1  SPLIT CYL, SET TRK TO START   55400021
*    CHECK WITHIN THIS EXTENT                                           55600021
CDA07600 EQU   *                        CHECK IF STILL WITHIN EXTENT    55800021
         CLC   DXCCW4+K4(K4),DEBENDCC   IS NEW TRK IN EXTENT            56000021
         BNH   CDA07700                 BRANCH IF YES                   56200021
         L     RDEB,DCBDEBAD            PICK UP DEB ADDRESS             56400021
         SR    RF,RF                    CLEAR WORK REGISTERS            56600021
         SR    RC,RC                    CLEAR REG                       56800021
         IC    RC,DCBFDAD               GET M(CURRENT EXTENT NUMBER)    57000021
         IC    RF,DEBNMEXT              PICK UP NUMBER OF EXTENTS       57200021
         LA    RC,K1(,RC)               UPDATE M TO POINT TO NEXT EXT   57400021
         CR    RC,RF                    ARE THERE ANY MORE EXTENTS      57600021
         BC    10,CDA07800              DO NOT WRITE FILE MARK    M1801 57800002
         SLL   RC,K4                    MULTIPLY BY 16                  58000021
         AR    RDEB,RC                  POINT TO CORRECT EXTENT         58200021
         MVC   DXDEBBIN(K12),DEBBINUM   MOVE EXTENT INFO TO WORK AREA   58400021
         MVC   DXCCW4+K2(K6),DXDEBBIN   PLACE BEGINNING BBCCHH IN SCH   58600021
CDA07700 EQU   *                                                        58800021
         MVI   DXCCW4+K8,K0             SET SEARCH R TO 0               59000021
         BAL   RC,CDA08100              SET UP TO WRITE FILE MARK       59200021
         MVI   DXCCW7+K4,K1             SET R OF FM=01.         SA53753 59400002
         LA    RET,K8                   SET UP FOR BR TABLE IF ERROR    59600021
         BAL   RC,CDA08200              GO TO WRITE THE FILE MARK       59800021
         OI    DXATDACC,DXATEOF         EOF WRITTEN FOR PS DS    Y02144 59810002
CDA07800 EQU   *                                                 M1801  59850021
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM6520 59852002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM6520 59854002
         BE    CDA08060                 BRANCH IF RECOVERY ENTRY YM6520 59856002
         MODESET EXTKEY=SCHED           ASSUME SCHED KEY         Y02082 59860002
         NI    TIOELINK,X'FF'-TIOSYOUT  INSURE INDICATOR OFF     M1801  59900021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 59910002
         OC    DSCLSTAR(3),DSCLSTAR     CHECK IF ANY DATA        M1801  59950021
         BZ    CDA07840                 BRANCH IF NONE          SA53753 59960002
         MODESET EXTKEY=SCHED           ASSUME SCHED KEY         Y02082 59960402
         OI    TIOELINK,TIOSYOUT        SET INDICATOR IF DATA    M1801  59970021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 59970102
         EJECT                                                  SA53753 59970202
*********************************************************************** 59970402
*                                                                     * 59971002
*                          FUNCTION PROLOG                            * 59972002
*                                                                     * 59973002
*********************************************************************** 59974002
*                                                                     * 59975002
* FUNCTION NAME -                                                     * 59976002
*    CLOSE DA PARTIAL RELEASE INTERFACE FUNCTION.                     * 59977002
*                                                                     * 59978002
* (STATUS) -                                                          * 59979002
*    NOT APPLICABLE                                                   * 59980002
*                                                                     * 59981002
* FUNCTION -                                                          * 59982002
*    XCTL TO THE PARTIAL RELEASE ROUTINES TO RELEASE UNUSED EXTERNAL  * 59983002
*    STORAGE AND WRITE BACK THE FORMAT 1 DSCB IF RELEASE IS SPECIFIED.* 59984002
*                                                                     * 59985002
* ENTRY POINTS -                                                      * 59986002
*    ENTERED FROM THE FOLLOWING--                                     * 59987002
*    CLOSE DA UPDATE DSCB FUNCTION.                                   * 59988002
*    DADSM PARTIAL RELEASE ROUTINE.                                   * 59989002
*                                                                     * 59990002
* INPUT -                                                             * 59991002
*    A POINTER TO EACH OF THE FOLLOWING--                             * 59992002
*       CURRENT PARAMETER LIST ENTRY- RPARC                           * 59993002
*       DD ENTRY IN THE TIOT- RTIOT                                   * 59994002
*       WTG TABLE- RWTG                                               * 59995002
*       CURRENT WTG TABLE ENTRY- RWTGC                                * 59996002
*       DCB- RDCB                                                     * 59997002
*       WORK AREA- RCORE                                              * 59998002
*       RESIDENT ROUTINE- RES                                         * 59999002
*       UCB- RUCB                                                     * 60000002
*       DEB- RDEB                                                     * 60001002
*                                                                     * 60002002
* OUTPUT -                                                            * 60003002
*    UNUSED STORAGE IS RELEASED AND AN UPDATED FORMAT 1 DSCB IS       * 60004002
*    WRITTEN IF PARTIAL RELEASE IS SPECIFIED.                         * 60004202
*                                                                     * 60005002
* EXTERNAL REFERENCES -                                               * 60006002
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 60007002
*                                                                     * 60008002
* EXITS, NORMAL -                                                     * 60009002
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 60010002
*    CLOSE DA PARTIAL RELEASE INTERFACE FUNCTION.                     * 60011002
*                                                                     * 60012002
* EXITS, ERROR -                                                      * 60013002
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 60014002
*    EXIT WITH THE FOLLOWING INTERNAL CODES--                         * 60015002
*       87 - A14 ABEND - I/O ERROR OCCUR DURING PARTIAL RELEASE.      * 60016002
* TABLES/WORK AREAS -                                                 * 60018002
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 60019002
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 60020002
*                                                                     * 60021002
* ATTRIBUTES -                                                        * 60022002
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 60023002
*                                                                     * 60024002
* CHARACTER CODE DEPENDENCY -                                         * 60025002
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 60026002
*                                                                     * 60027002
* NOTES -                                                             * 60028002
*    MODULE ID FOR PARTIAL RELEASE ROUTINE IS IGG020P1.               * 60029002
*                                                                     * 60031002
*********************************************************************** 60032002
*                                                                       60033002
         EJECT                                                  SA53753 60033202
CDA07840 EQU   *                                                SA53753 60034002
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM6520 60034202
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM6520 60034402
         BE    CDA08060                 BRANCH IF RECOVERY ENTRY YM6520 60034602
         TM    UCBJBNR,UCBVRDEV         TEST FOR VIO             Y02132 60034802
         BO    CDA08000                 BR IF YES, NO PART REL   Y02132 60035002
         L     RDEB,DCBDEBAD            RELOAD DEB ADDR         SA53753 60035202
         L     RET,DXTCBADR             CURRENT TCB ADDRESS     SA53753 60039802
         TM    TCBFLG,TCBFA             IS ABEND BIT ON         SA53753 60040002
         BO    CDA08000                 BR IF YES - NO PARTIAL  SA53753 60041002
*                                       RELEASE                 SA53753 60042002
         TM    DCBOFLGS,DCBOWRIT        WAS DATA SET            SA53753 60042402
*                                       OPEN FOR OUTPUT         SA53753 60042802
         BZ    CDA08000                 BRANCH IF NO            SA53753 60042902
         TM    DEBOFLGS,DEBOFRLS        TEST FOR PARTIAL        SA53753 60053002
*                                       RELEASE                 SA53753 60056002
         BZ    CDA08000                 BRANCH IF NOT           SA53753 60059002
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP             @ZA12212 60059200
         BZ    CDA07920                 BRANCH IF NOT EXCP     @ZA12212 60059400
         TM    DCBMCRF1,DCBMDEV         TEST FOR PRESENCE OF   @ZA12212 60059600
*                                       DA DEV DEP SECTION     @ZA12212 60059800
         BZ    CDA08000                 BRANCH IF NOT PRESENT  @ZA12212 60060000
CDA07920 EQU   *                                               @ZA12212 60060200
         CLC   DCBFDAD(K8),FOXES        TEST FOR NO DATA       @ZA12212 60060400
         BE    CDA08000                 BR TO EXIT IF NO DATA  @ZA12212 60060800
         NC    DCBFDAD(K8),DCBFDAD      TEST FOR ZERO          @ZA12212 60061200
         BZ    CDA08000                 BR IF NO DATA          @ZA12212 60061600
         TM    DEBOFLGS,DEBOFSPL        TEST IF SPLIT CYL       SA53753 60062002
         BO    CDA08000                 YES,NO PARTIAL RELEASE  SA53753 60065002
         TM    DSCFILTY,DS1ORGIS        IS THIS ISAM DATA SET   SA53753 60068002
         BO    CDA08000                 YES, NO PARTIAL RELEASE SA53753 60071002
         OI    WTGPATHS,WTGPRLSE        IND RLSE COMING UP      SA53753 60074002
         LA    RCORE,0(RCORE)           MAKE  REG. POSITIVE     SA53753 60086002
         IECRES LOAD,PREFIX=WTGPREFX,MODNM=CLRLSE,BRANCH=DIRECT  Y02080 60089002
*                                                                       60128002
*  IF RETURNING FROM PARTIAL RELEASE, CONTINUE PROCESSING HERE          60131002
*                                                                       60134002
CDA07940 EQU   *                                                SA53753 60137002
         MVC   WTGMODNM(K8),IFG2E       RESTORE NAME 'IFG0202E'  YM2488 60138002
         NI    WTGPATHS,CHARFF-WTGPRLSE ZERO PARTIAL RELEASE    SA53753 60140002
*                                       INDICATOR               SA53753 60143002
         LA    R0,X10                   LOAD REG WITH I/O       SA53753 60146002
*                                       ERROR CODE              SA53753 60149002
         CR    R1,R0                    CK FOR I/O ERROR        SA53753 60152002
         BNE   CDA08000                 BRANCH IF NO             SM5456 60155002
         LA    R0,CABD087               ERR - PARTIAL RELEASE   SA53753 60158002
         B     CDA08210                 BRANCH TO ISSUE ABEND   SA53753 60161002
         EJECT                                                  SA53753 60200002
*                                                                       60240002
*                          FUNCTION PROLOG                            * 60400021
*                                                                     * 60600021
*********************************************************************** 60800021
*                                                                     * 61000021
* FUNCTION NAME -                                                     * 61200021
*    CLOSE DA EXIT FUNCTION.                                          * 61400021
*                                                                     * 61600021
* (STATUS) -                                                          * 61800021
*    NOT APPLICABLE                                                   * 62000021
*                                                                     * 62200021
* FUNCTION -                                                          * 62400021
*    INTERFACE WITH SMF DATA SET FUNCTION IF THE DATA SET IS NOT      * 62500021
*    SYSIN OR SYSOUT.                                                 * 62600021
*                                                                     * 62800021
* ENTRY POINTS -                                                      * 63000021
*    ENTERED FROM THE FOLLOWING--                                     * 63200021
*    CLOSE DA ACCESS METHOD EXECUTOR INTERFACE FUNCTION.              * 63260021
*    CLOSE DA INPUT USER LABEL FUNCTION.                              * 63320021
*    CLOSE DA WRITE FILE MARK FUNCTION.                               * 63400021
*                                                                     * 63600021
* INPUT -                                                             * 63800021
*    A POINTER TO EACH OF THE FOLLOWING--                             * 64000021
*       CURRENT PARAMETER LIST ENTRY- RPARC                           * 64200021
*       DD ENTRY IN THE TIOT- RTIOT                                   * 64400021
*       WTG TABLE- RWTG                                               * 64600021
*       CURRENT WTG TABLE ENTRY- RWTGC                                * 64800021
*       DCB- RDCB                                                     * 65000021
*       WORK AREA- RCORE                                              * 65200021
*       RESIDENT ROUTINE- RES                                         * 65400021
*       UCB- RUCB                                                     * 65600021
*       DEB- RDEB                                                     * 65800021
*                                                                     * 66000021
* OUTPUT -                                                            * 66200021
*    DA STRING COMPLETE.                                              * 66400021
*                                                                     * 66600021
* EXTERNAL REFERENCES -                                               * 66800021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 67000021
*                                                                     * 67200021
* EXITS, NORMAL -                                                     * 67400021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 67600021
*    CLOSE FINAL STRING.                                              * 67800021
*    CLOSE/EOV SMF DATA SET FUNCTION.                                 * 67900021
*                                                                     * 68000021
* EXITS, ERROR -                                                      * 68200021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 68400021
*                                                                     * 68600021
* TABLES/WORK AREAS -                                                 * 68800021
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 69000021
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 69200021
*                                                                     * 69400021
* ATTRIBUTES -                                                        * 69600021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 69800021
*                                                                     * 70000021
* CHARACTER CODE DEPENDENCY -                                         * 70200021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 70400021
*                                                                     * 70600021
* NOTES -                                                             * 70800021
*    NOT APPLICABLE                                                   * 71000021
*                                                                     * 71200021
*********************************************************************** 71400021
         EJECT                                                          71600021
CDA08000 EQU   *                                                        71800021
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM6520 71850002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM6520 71900002
         BE    CDA08060                 BRANCH IF RECOVERY ENTRY YM6520 71950002
         L     RDEB,DCBDEBAD            RELOAD DEB ADDR                 72000002
         TM    WTGPATHS,WTGSMF          SMF REQUESTED            A38013 72040021
         BZ    CDA08020                 BRANCH IF NOT            A38013 72080021
         TM    JFCBTSDM,JFCSDS          IS SYSIN/SYSOUT DS       A38013 72120021
         BO    CDA08020                 BRANCH IF YES            A38013 72160021
         LA    RF,SMFMOD                SET UP FOR XCTL TO SMF   A38013 72200021
         MVC   DXRETMOD,FINALMOD        MOVE IN RETURN IDTTR     A38013 72240021
         B     CDA08040                 BRANCH TO SMF STRING     A38013 72280021
CDA08020 EQU   *                                                 A38013 72320021
         LA    RF,FINALMOD              SET UP FOR XCTL          A38013 72360021
CDA08040 EQU   *                                                 A38013 72400021
         SR    RET,RET                  SET BRANCH OFFSET        A38013 72440021
         IECRES LOAD,MODID=(RF),BRCODE=(RET),BRANCH=QUEUED       Y02080 72530002
*                                       XCTL TO SMF OR FINAL     Y02080 72580002
CDA08060 EQU   *                                                 YM6520 72581002
         MVC   WTGMODNM,RECMOD          MOVE RECOVERY MOD NAME   YM6520 72582002
         L     RF,DXATCOM3              GET RRPLIST PTR          YM6520 72583002
         USING RRPLIST,RF                                               72584002
         L     RF,RRFWORK               RECOVERY SUBRTN SAVEAREA YM6520 72585002
         DROP  RF                                                       72586002
         L     RET,IECREGSV-IECEXTPR+K4*RET(,RF) GET RETURN ADDR YM6520 72587002
         ST    RET,WTGMODEP             SET EPA TO RETURN ADDR   YM6520 72588002
         LM    R0,RD,0(RF)              GET RECOVERY SUBRTN REGS YM6520 72590002
         IECRES LOAD,EXTPR=(RF),BRANCH=DIRECT RETURN TO IFG0RR0B YM6520 72592002
         EJECT                                                          72600021
CDA08100 EQU   *                                                        72800021
         LA    RF,DXCCW4+K4             ID OF FILE MARK                 73000021
         ST    RF,DXCCW1                STORE SEARCH ID                 73200021
         LA    RF,DXCCW1                ADDRESS OF FIRST CCW            73400021
         MVI   DXCCW1,CCWSCHID          SEARCH ID EQU OP CODE           73600021
         ST    RF,DXCCW2                STORE TIC ADDR                  73800021
         MVC   DXCCW1+K4(K5),CX10       SET CC FLAG AND NO. OF BYTES    74000021
         LA    RF,DXCCW7                ADDRESS OF COUNT BUFFER SA53753 74200002
         ST    RF,DXCCW3                STORE IN CCW3                   74400021
         MVI   DXCCW3,X'1D'             WRITE CT,KEY,DATA               74600021
         MVC   DXCCW3+K4(K4),CX12       SET SILI FLAG AND BYTE COUNT    74800021
         MVC   DXCCW7(K4),DXCCW4+K4     MOVE CCHH INTO COUNT    SA53753 75000002
         XC    DXCCW7+K5(K3),DXCCW7+K5  CLEAR KEY AND DATA      SA53753 75200002
*                                       LENGTH                  SA53753 75201002
         BR    RC                       RETURN TO CALLER                75400021
         EJECT                                                          75600021
CDA08200 EQU   *                                                        75800021
         ST    RET,DXWORK               SAVE RETURN OFFSET       YM2488 76000002
         MVC   DXDAADDR,DXCCW4+K1       MOVE IN SEEK ADDRESS            76200021
         MVI   DXDAADDR,K0              ASSURE A ZERO M                 76400021
*                                                                       76600021
*        THIS CODE WILL NOT ALLOW A FILE MARK TO BE WRITTEN AT          76800021
*        CCHH = 00000000 BY TESTING FOR THAT SEEK ADDRESS,      SA51711 77050000
*        AND BY TESTING SEEK ADDRESS FOR CCHH = FFFFFFFF TO     SA50728 77100021
*        INDICATE THAT NO DATA HAS BEEN WRITTEN TO FILE.        SA50728 77150021
*                                                                       77200021
         NC    DXDAADDR+K3(K4),DXDAADDR+K3 TEST FOR TRACK ZERO  SA51711 77400021
         BCR   8,RC                     NO EOF IF ZERO          SA51711 77600021
         CLC   DXDAADDR+K3(K4),FOXES    TEST FOR NO DATA        SA50728 77650021
         BCR   8,RC                     NO DATA,                 M4362  77700021
*                                       EXIT WITHOUT WRITING EOFSA50728 77750021
         EXCP  DXIOB                    GO WRITE FILE MARK              77800021
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM7047 77810002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM7047 77820002
         BNE   CDA08204                 BR IF NOT RECOVERY ENTRY YM7047 77830002
         WAIT  ,ECB=DXECB               WAIT FOR COMPLETION      YM7047 77840002
         B     CDA08208                 GO CHK FOR ERROR         YM7047 77850002
CDA08204 EQU   *                                                 YM7047 77860002
         IECRES WAIT                    WAIT FOR COMPLETION             78000021
CDA08208 EQU   *                                                 YM7047 78010002
         TM    DXECB,ECBNOERR           CK FOR PERM I/O ERROR           78200021
         BCR   1,RC                     BRANCH IF NO ERROR              78400021
         L     RET,DXWORK               LOAD RETURN OFFSET       YM2488 78600002
         LA    R0,CABD090               ERR- WRITE FILE MARK            78800021
CDA08210 EQU   *                                                SA53753 78801002
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM6520 78850002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM6520 78900002
         BE    CDA08060                 BRANCH IF RECOVERY ENTRY YM6520 78950002
         DMABCOND (0),PDMOD             ABEND MACRO                     79000021
         EJECT                                                          79200021
         SPACE 1                                                        79400021
*********************************************************************** 79600021
*                                                                     * 79800021
*                       CONSTANTS                                     * 80000021
*                                                                     * 80200021
*********************************************************************** 80400021
         SPACE 1                                                        80600021
CX10     DC    X'4000000508'            CC, 5 BYTES, TIC                80800021
CX12     DC    X'20000008'              SILI,8 CHARACTERS               81000021
IFG2E    DC    C'IFG0202E'              TO RESTORE NAME          YM2488 81050002
RECCORID DC    C'RR0A'                  RECOVERY CORE ID         YM6520 81100002
FOXES    DC    F'-1'                    OVERWRITE PROTECTION    SA50728 81250021
BADKEY   DC    H'8'                     NO MATCH FOR KEY ERROR  SA53753 81251002
*                                       CODE                    SA53753 81252002
         XCTLTABL ID=(FINALMOD,2J,PDMOD,0P,SMFMOD,2H,CLRLSE,IGG020P1,  *81400002
               RECMOD,IFG0RR0B),SVC=020,BRT=YES,LENGTH=          YM6520 81401002
         IECDSECS CVT,TCB,TIOT,DCB,DEB,UCB,MAIN,WTG,PREFX,             *81600002
               RRPL,EXPAND=YES                                   YM6520 81700002
         IECEQU                                                         81800021
         END                                                            82000021
