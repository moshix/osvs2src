         TITLE 'IFG0202H - CLOSE/EOV SMF ROUTINE'                       00200021
IFG0202H CSECT                                                          00800021
         ENTRY IFG0553B                                          Y02080 00850002
IFG0553B EQU   IFG0202H                 ALLIAS ENTRY POINT       Y02080 00900002
*********************************************************************** 01000021
*                                                                     * 01200021
*          VS2 RELEASE 03 DELETIONS/CHANGES                           * 01250037
*0000636000,638000,648000,650000                                Z30AAJC 01270037
*0000                                                          @ZA05458 01290037
*0000                                                          @ZA07184 01310037
*0000362000                                                    @ZA14716 01320037
*          VS1 RELEASE 01 DELETIONS                                     01330037
*0000                                                            XM5543 01350000
*          VS1 RELEASE 02 DELETIONS                                   * 01352000
*0000699500                                                      XM0454 01354000
*                                                                     * 01400021
*          RELEASE 21 DELETIONS/CHANGES                               * 02400021
*                                                                M1771  02450021
*0000372000-374000                                               M0143  02500021
*                                                                A39153 02600021
*                                                                A41413 02800021
*                                                                A43244 03000021
*                                                                A38013 03200021
*                                                                A44480 03400021
*0000384000,386000,390000,392000                                 A52390 03480021
*                                                                     * 03600021
* MODULE NAME = IFG0202H                                              * 03650002
*                                                                     * 03700002
* DESCRIPTIVE NAME = CLOSE/EOV SMF ROUTINE                            * 03750002
*                                                                     * 03760002
* COPYRIGHT = NONE                                                    * 03770002
*                                                                     * 03780002
* STATUS CHANGE LEVEL 000                                             * 03800021
*                                                                     * 04000021
* FUNCTION -                                                          * 04200021
*    THIS MODULE CONTAINS THE FUNCTION(S) OR PART(S) OF FUNCTION(S)-- * 04400021
*    CLOSE/EOV SMF RECORD BUILDER FUNCTION.                           * 04600021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)' FOR DETAILS.         * 04800021
*                                                                     * 05000021
* ENTRY POINTS -                                                      * 05200021
*         IFG0202H - ENTRY POINT VIA AN XCTL FROM THE FOLLOWING--     * 05400021
*             INITIAL ENTRY--                                         * 05600021
*                IFG0202B - PROCESS CLOSE/EOV SMF RECORD BUILDER      * 05800021
*                IFG0202E   FUNCTION.                                 * 06000021
*                IFG0202F                                             * 06200021
*             SECOND ENTRY--                                          * 06400021
*                IFG0551T - PROCESS CLOSE/EOV SMF RECORD BUILDER      * 06600021
*                IFG0552R   FUNCTION.                                 * 06800021
*                IFG0552T                                             * 07000021
*                IFG0552X                                             * 07200021
*                IFG0553P                                             * 07400021
*                IFG0554P                                             * 07600021
*             EITHER ENTRY--                                          * 07610002
*                IFG0RR0B - PROCESS CLOSE/EOV SMF RECORD BUILDER      * 07620002
*                                                                     * 07800021
* INPUT -                                                             * 08000021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 08200021
*                                                                     * 08400021
* OUTPUT -                                                            * 08600021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 08800021
*                                                                     * 09000021
* EXTERNAL REFERENCES -                                               * 09200021
*         IFG019RA - OPEN/CLOSE/EOV RESIDENT ROUTINE FOR XCTL AND     * 09400002
*                    WAIT.                                            * 09600021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 09800021
*                                                                     * 10000021
* EXITS, NORMAL -                                                     * 10200021
*    EXIT VIA THE RESIDENT ROUTINE XCTL TO THE FOLLOWING--            * 10400021
*         IFG0202I - CONTINUE PROCESSING CLOSE/EOV SMF RECORD BUILDER * 10600021
*                    FUNCTION. (DIRECT ACCESS)                        * 10800021
*         IFG0202J - PROCESS CLOSE FINAL STRING.                      * 11000021
*         IFG0202B - PROCESS CLOSE TAPE FUNCTION.                     * 11200021
*         IFG0202F                                                    * 11400021
*         IFG0551T - PROCESS EOV TAPE OUTPUT FUNCTION.                * 11600021
*         IFG0552R - PROCESS EOV TAPE INPUT FUNCTION.                 * 11800021
*         IFG0552T                                                    * 12000021
*         IFG0552X                                                    * 12200021
*         IFG0553P - PROCESS EOV DIRECT ACCESS INPUT FUNCTION.        * 12400021
*         IFG0554P - PROCESS EOV DIRECT ACCESS OUTPUT FUNCTION.       * 12600021
*         IFG0RROB - FORCE CLOSE PROCESSING                           * 12700002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 12800021
*                                                                     * 13000021
* EXITS, ERROR -                                                      * 13200021
*    EXIT IS TO THE PROBLEM DETERMINATION MODULE IFG0200P, IF AN      * 13400021
*    ABEND SITUATION OCCURS IN THIS MODULE.  REFER TO THE FOLLOWING   * 13600021
*    'FUNCTION PROLOG(S)'.                                            * 13800021
*                                                                     * 14000021
* TABLES/WORK AREAS -                                                 * 14200021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 14400021
*                                                                     * 14600021
* ATTRIBUTES -                                                        * 14800021
*    REENTRANT, REFRESHABLE, READ-ONLY, ENABLED, PRIVILEGED           * 15000021
*                                                                     * 15200021
* CHARACTER CODE DEPENDENCY -                                         * 15400021
*    CLASS ONE CHARACTER CODE DEPENDENCY - THE EBCDIC CHARACTER CODE  * 15600021
*    WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED IF A      * 15800021
*    DIFFERENT CHARACTER SET IS USED FOR EXECUTION.                   * 16000021
*                                                                     * 16200021
* NOTES -                                                             * 16400021
*    THIS MODULE HAS AN ALIAS NAME OF IFG0553B.                       * 16600021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 16800021
*                                                                     * 17000021
*********************************************************************** 17200021
         EJECT                                                          17400021
         USING IHADCB,RDCB                                              17600021
         USING FORCORE,RCORE                                            17800021
         USING CVT,RD                                                   18000021
         USING TCB,RET                                                  18200021
         USING UCBOB,RUCB                                               18400021
         USING TIOENTRY,RTIOT                                           18600021
         USING DEB,RDEB                                                 18800021
         USING SMF14RCD,R7                                              19000021
         USING WTG,RWTG                                                 19200021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         19400021
         USING *,RBASE                                                  19600021
         L     RF,DXATCOM3              GET RRPLIST PTR          Y02144 19650002
         USING RRPLIST,RF                                        Y02144 19700002
         OI    RRFLAGS1,RRFSMF          INDICATE SMF IN CONTROL  Y02144 19750002
         DROP  RF                                                Y02144 19760002
         OI    DXATDACC,DXATSMF         INDICATE SMF PROCESSING  YM4614*19770002
                                        STARTED FOR THE DATA SET YM4614 19780002
         B     CCM01700(RET)            USE BRANCH TABLE                19800021
CCM01700 EQU   *                                                        20000021
         B     CCM01900                 ENTRY FROM CLOSE                20200021
*        ENTRY FROM EOV ( OFFSET 4 )                                    20400021
         EJECT                                                          20600021
*                                                                     * 20800021
*                          FUNCTION PROLOG                            * 21000021
*                                                                     * 21200021
*********************************************************************** 21400021
*                                                                     * 21600021
* FUNCTION NAME -                                                     * 21800021
*    CLOSE/EOV SMF RECORD BUILDER FUNCTION.                           * 22000021
*                                                                     * 22200021
* (STATUS) -                                                          * 22400021
*    NOT APPLICABLE                                                   * 22600021
*                                                                     * 22800021
* FUNCTION -                                                          * 23000021
*    THIS FUNCTION IS CALLED BY CLOSE/EOV WHEN THE SYSTEM MANAGEMENT  * 23200021
*    FACILITIES DATA SET INFORMATION IS DESIRED. THIS FUNCTION BUILDS * 23400021
*    THE TYPE 14/15 SMF RECORD AND ISSUE AN SVC 83 TO HAVE THE RECORD * 23600021
*    WRITTEN ON THE SYS1.MAN DATA SET.                                * 23800021
*    IF ENTRY WAS FROM CLOSE, THIS FUNCTION CALCULATES THE CORE NEEDED* 24000021
*    FOR UCB SEGMENTS FOR ALL VOLUMES TO BUILD THE SMF RECORD.        * 24200021
*    A GETMAIN IS ISSUED FOR THE CORE REQUIRED TO BUILD THE RECORD.   * 24400021
*                                                                     * 24600021
* ENTRY POINTS -                                                      * 24800021
*    ENTERED FROM THE FOLLOWING--                                     * 25000021
*    CLOSE SMF INTERFACE FUNCTIONS.                                   * 25200021
*    EOV SMF INTERFACE FUNCTIONS.                                     * 25400021
*                                                                     * 25600021
* INPUT -                                                             * 25800021
*    ENTERED IN DATA MANAGEMENT KEY                              Y02082 25850002
*    A POINTER TO EACH OF THE FOLLOWING--                             * 26000021
*       CURRENT PARAMETER LIST ENTRY- RPARC                           * 26200021
*       DD ENTRY IN THE TIOT- RTIOT                                   * 26400021
*       WTG TABLE- RWTG                                               * 26600021
*       CURRENT WTG TABLE ENTRY- RWTGC                                * 26800021
*       DCB- RDCB                                                     * 27000021
*       WORK AREA- RCORE                                              * 27200021
*       RESIDENT ROUTINE- RES                                         * 27400021
*       UCB- RUCB                                                     * 27600021
*       DEB- RDEB                                                     * 27800021
*                                                                     * 28000021
* OUTPUT -                                                            * 28200021
*    EXIT IN DATA MANAGEMENT KEY                                 Y02082 28250002
*    AN SMF RECORD IS WRITTEN FOR TAPE OR D. A. DATA SETS.            * 28400021
*                                                                     * 28600021
* EXTERNAL REFERENCES -                                               * 28800021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 29000021
*                                                                     * 29200021
* EXITS, NORMAL -                                                     * 29400021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 29600021
*    CLOSE/EOV FUNCTIONS THAT CALLED THIS FUNCTION.                   * 29800021
*                                                                     * 30000021
* EXITS, ERROR -                                                      * 30200021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 30400021
*                                                                     * 30600021
* TABLES/WORK AREAS -                                                 * 30800021
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 31000021
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 31200021
*                                                                     * 31400021
* ATTRIBUTES -                                                        * 31600021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 31800021
*                                                                     * 32000021
* CHARACTER CODE DEPENDENCY -                                         * 32200021
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 32400021
*                                                                     * 32600021
* NOTES -                                                             * 32800021
*    NOT APPLICABLE                                                   * 33000021
*                                                                     * 33200021
*********************************************************************** 33400021
         EJECT                                                          33600021
         LA    R0,K320                  LOAD MIN GETMAIN SIZE           33800021
         B     CCM02000                 BRANCH TO GET CORE              34000021
CCM01900 EQU   *                                                        34200021
*                                                                       34400021
*   THIS SECTION OF CODE IS EXECUTED WHEN ENTRY IS FROM CLOSE.          34600021
*   IT WILL DETERMINE IF ADDITIONAL CORE IS REQUIRED TO BUILD THE SMF   34800021
*   RECORD. THIS CODE IS ENTERED FOR EACH DCB IN THE CLOSE WTG TABLE.   35000021
*                                                                       35200021
         LA    R0,K320                  LOAD MIN GETMAIN SIZE           35400021
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP               A39153 35600021
         BZ    CCM01920                 BRANCH IF NOT            A39153 35800021
         TM    DCBMACRF,DCBMCOM         COMMON INTERFACE PRESENT A39153 36000021
         BZ    CCM01925                 BRANCH IF NOT          @ZA14716 36200037
CCM01920 EQU   *                                                 A39153 36400021
         TM    DCBDSRG2,DCBDSGTQ        TEST FOR TCAM MSG QUEUE SA50816 36402002
         BO    CCM01923                 BRANCH IF YES           SA50816 36404002
         TM    DCBDSORG,DCBORGIS+DCBORGDA+DCBORGPO  IS/DA/PO DATA SET   36600021
         BZ    CCM02000                 BRANCH IF NO                    36800021
CCM01923 EQU   *                        TCAM MSG QUEUE          SA50816 36802002
         XR    RET,RET                  CLEAR REG                       37000021
         TM    DCBDSORG,DCBORGDA        BDAM                    YA03180 37000302
         BNO   CCM01924                 BRANCH IF NOT           YA03180 37000602
         TM    DCBMACRF,DCBMEXCP        EXCP                    YA03180 37000902
         BO    CCM01925                 BDAM-EXCP, USE DEBNMEXT YA03180 37001202
         B     CCM01930                 USE TIOT IF NOT         YA03180 37001502
CCM01924 EQU   *                        TEST FOR ISAM           YA03180 37001802
         TM    DCBDSORG,DCBORGIS        IS IT AN ISAM DATA SET  SA54605 37002002
         BNO   CCM01930                 BRANCH IF NOT ISAM      SA54605 37004002
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP               M1771  37750021
         BZ    CCM01926                 BRANCH IF NOT EXCP      YA03180 37760002
CCM01925 EQU   *                        USE NUMBER OF EXTENTS   YA03180 37760302
         IC    RET,DEBNMEXT             GET NUMBER OF EXTENTS    M1771  37770021
         B     CCM01980                 GO DECREMENT THIS NUMBER M1771  37780021
CCM01926 EQU   *                                                YA03180 37790002
         IC    RET,DEBNPEE              GET NO. OF PRIME EXTENTS M1771  37792021
         LA    RET,K2(RET)              ADD 1 UCB SEGMENT EACH   M1771  37794021
*                                       FOR INDEX AND OVERFLOW   M1771  37796021
         B     CCM01980                 GO DECREMENT THIS NUMBER M1771  37798021
CCM01930 EQU   *                                                 M1771  37798421
         LR    RF,RTIOT                 SAVE TIOT ENTRY PTR      A41413 37800021
         XR    R1,R1                    CLEAR REG                A41413 38000021
CCM01940 EQU   *                                                 A41413 38200021
         IC    R1,TIOELNGH              GET LEN OF THIS ENTRY    A52390 38280021
         AR    RTIOT,R1                 POINT TO NEXT ENTRY      A52390 38360021
* CALCLULATE NUMBER OF UNITS FOR THIS DD ENTRY                   A52390 38440021
         SH    R1,DDBASLEN              SUBTR DD ENTRY BASE LEN  A52390 38520021
         SRL   R1,K2                    DIV BY 4 BYTES PER UCB   A52390 38600021
*                                       ENTRY TO GET NO. UNITS   A52390 38680021
         AR    RET,R1                   ADD ONTO TOTAL NO.       A41413 38800021
         TM    DCBDSORG,DCBORGPO        IS IT BPAM              SA54605 38802002
         BNO   CCM01960                 BRANCH IF NO            SA54605 38804002
         CLI   TIOELNGH,X'00'           TEST IF END OF TIOT      A41413 39400021
         BE    CCM01960                 BRANCH IF END OF TIOT    A41413 39600021
         CLI   TIOEDDNM,BLANK           CHECK NEXT DDNAME        A41413 39800021
         BE    CCM01940                 BRANCH TO GET NEXT ENTRY A41413 40000021
CCM01960 EQU   *                                                 A41413 40200021
         LR    RTIOT,RF                 RESTORE TIOT ENTRY PTR   A41413 40400021
CCM01980 EQU   *                                                 A41413 41200021
         BCTR  RET,0                    DECREASE COUNT BY ONE           41400021
         MH    RET,UCBSIZE              MULTIPLY BY SIZE OF UCB         41600021
*                                       SEGMENT IN SMF RECORD           41800021
         AR    R0,RET                   ADD UCB SEG TO SIZE      A41413 42000021
CCM02000 LR    RET,R0                   SAVE AMOUNT FOR FREEMAIN        42200021
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM4614 42250002
         LA    RF,IECREGSV-IECPREFX(,R1) ADDR OF REG SAVE AREA   YM4614 42300002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM4614 42350002
         LR    R1,RF                    GET EXTENDED PREFIX ADDR YM4614 42400002
         BNE   CCM02050                 BR IF NOT RECOVERY ENTRY YM4614 42450002
         L     RF,8(,RF)                RECOVERY REG SAVE AREA   YM4614 42500002
CCM02050 IECRES GET,LV=(RET),PREFIX=YES, GET CORE FOR SMF RECORD YM4614*42552002
               STM=(2,14,0(RF)),A=(R1),ID=SFWA                   YM4614 42554002
         LR    R7,R1                    SET RECORD BASE                 42600021
*                                                                       44400021
*   THIS SECTION BUILDS THE JFCB SEGMENT AND THE DEVICE INDEPENDENT     44600021
*   DCB/DEB SEGMENT OF THE SMF RECORD                                   44800021
*                                                                       45000021
         MVC   SMFJFCB1,INFMJFCB        COPY THE JFCB                   45200021
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP               A39153 45400021
         BZ    CCM02140                 BRANCH IF NOT            A39153 45600021
         TM    DCBMACRF,DCBMCOM         COMMON INTERFACE PRESENT A39153 45800021
         BZ    CCM02100                 BRANCH IF NOT            A39153 46000021
         MVC   SMFDCBOR,DCBDSORG        DCBDSORG FIELD           A39153 46200021
CCM02100 TM    DCBMACRF,DCBMFOUN        FOUNDATION EXT. PRESENT  A39153 46400021
         BZ    CCM02120                 BRANCH IF NOT            A39153 46600021
         MVC   SMFDCBRF,DCBRECFM        DCBRECFM FIELD           A39153 46800021
CCM02120 TM    DCBMACRF,DCBMAPP         APPENDAGES PRESENT       A39153 47000021
         BZ    CCM02200                 BRANCH IF NOT            A39153 47200021
         B     CCM02160                 MOVE IN DCBOPTCD         A39153 47400021
CCM02140 EQU   *                                                 A39153 47600021
         MVC   SMFDCBOR,DCBDSORG        DCBDSORG FIELD                  47800021
         MVC   SMFDCBRF,DCBRECFM        DCBRECFM FIELD                  48000021
CCM02160 EQU   *                                                 A39153 48200021
         MVC   SMFDCBOP,DCBOPTCD        DCBOPTCD FIELD                  48400021
CCM02200 EQU   *                                                 A39153 48600021
         MVC   SMFDCBMF,DCBMACRF        DCBMACRF FIELD                  48800021
         MVC   SMFDCBFL,DCBOFLGS        DCBOFLGS FIELD                  49000021
         MVC   SMFDEBFL,DEBOFLGS        DEBOFLGS FIELD                  49200021
         MVC   SMFDEBOP,DEBOPATB        DEBOPATB FIELD                  49400021
         MVC   SMFTIOT(SMFJFCB1-SMFTIOT),0(RTIOT)  TIOT ENTRY FOR THIS  49600021
*                                       DCB                             49800021
         TM    DCBMACRF,DCBMEXCP        IS THIS EXCP                    50000021
         BO    CCM02250                 BRANCH IF YES                   50200021
         TM    DCBDSORG,DCBORGPS        IS THIS A PS DATA SET           50400021
         BNO   CCM02300                 BRANCH IF NO                    50600021
         TM    DCBCIND2,DCBCNCHS        IS THIS CHAIN SCHED.   @ZA05458 50650037
         BNO   CCM02250                 BRANCH IF NO           @ZA05458 50700037
         OI    SMFJFCB1+JFCOPTCD-INFMJFCB,JFCPCIBT    SET      @ZA05458 50750037
*                                       CHAIN SCHEDULING       @ZA05458 50770037
CCM02250 EQU   *                                                        50800021
         LA    R1,K4                    SET UP FOR TAPE OFFSET   A43244 51000021
         TM    UCBTBYT3,UCB3DACC        IS THIS A DA DEVICE      A43244 51600021
         BZ    CCM02280                 BRANCH TO GET DEBVOLSQ   A43244 51800021
CCM02260 EQU   *                                                 A43244 52000021
         IC    R1,DEBNMEXT              GET NUMBER OF EXTENTS           52200021
         SLL   R1,4                     MULT BY EXTENT SECTION SIZE     52400021
CCM02280 EQU   *                                                 A43244 52600021
         LA    R1,DEBDVMOD-DEB(R1,RDEB)  GET ADDR OF DEBVOLSQ           52800021
         MVC   SMFDEBVL,0(R1)           DEBVOLSQ FIELD                  53000021
CCM02300 EQU   *                                                        53200021
         ST    RDCB,REGSAVE             SAVE DCB POINTER                53400021
         STM   RCORE,RET,REGSAVE+K4     SAVE REGISTERS                  53600021
         L     RD,CVTPTR                GET POINTER TO CVT              53800021
         L     RET,CVTTCBP              PTR TO TCB                      54000021
         L     RET,K4(RET)              PTR TO CURRENT TCB              54200021
         L     RF,TCBTCT-TCB(RET)       GET PTR TO TCT                  54400021
         USING SMFTCT,RF                                                54600021
         MVC   SMF14JBN+K10(K4),TCTJMR  SAVE ADDR OF JMR                54800021
         L     R1,TCTIOTBL              GET PTR TO TCT TIOT             55000021
         DROP  RF                                                       55200021
         USING TCTTIOT,R1                                               55400021
         LA    RET,K4                   SET UP INDEX                    55600021
CCM02400 LA    RET,K4(RET)              INCREMENT TABLE PTR             55800021
         LA    RF,0(RET,R1)             PTR TO LOOK UP ENTRY            56000021
         CLC   0(K4,RF),ZERO            CHECK FOR END OF TABLE   YM3762 56200002
         BNZ   CCM02500                 BRANCH IF NOT END               56400021
         LM    RCORE,RET,REGSAVE+K4     RESTORE REGISTERS               56600021
         B     CCM04800                 BRANCH TO FREEMAIN              56800021
CCM02500 CLC   0(K2,RF),DCBTIOT         CHECK FOR CORRECT ENTRY         57000021
         BNE   CCM02400                 BRANCH IF NOT                   57200021
         LH    RF,K2(RF)                GET ENTRY DISPLACEMENT          57400021
         AR    RF,R1                    GET ENTRY ADDR                  57600021
         ST    RF,REGSAVE+K48           SAVE TCTUCBP                    57800021
         DROP  R1                                                       58000021
         TM    UCBJBNR,UCBVRDEV         TEST FOR VIO DATA SET   YM3859  58050002
         BZ    CCM02550                 BRANCH IF NOT           YM3859  58100002
         OI    SMF14RIN,SMF14VIO        SET VIO BIT IN SMF REC  YM3859  58150002
CCM02550 EQU   *                        TEST DEVICE TYPE        YM3859  58200002
         TM    UCBTBYT3,UCB3DACC        IS THIS A DA DEVICE             58600021
         BO    CCM05000                 BRANCH IF YES                   58800021
*                                                                       59000021
*   THIS SECTION BUILDS THE DCB/DEB EXTENSION, THE UCB SEGMENT          59200021
*   FOR DATA SETS ON TAPE DEVICES.                                      59400021
*                                                                       59600021
         USING TCTUCBP,RF                                               59800021
         LM    RCORE,RF,REGSAVE+K4      RESTORE REGISTERS               60000021
         XC    REGSAVE(K52),REGSAVE     CLEAR REGSAVE CORE       A39153 60200021
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP               A39153 60400021
         BZ    CCM05050                 BRANCH IF NOT            A39153 60600021
         TM    DCBMACRF+1,DCBMDEV       DEV. INTERFACE PRESENT   A39153 60800021
         BZ    CCM05070                 BRANCH IF NOT            A39153 61000021
CCM05050 EQU   *                                                 A39153 61200021
         MVC   SMFDCBBL,DCBBLKCT        DCBBLKCT FIELD                  61400021
CCM05070 EQU   *                                                 A39153 61600021
         MVC   SMFDSSNO,UCBSQC          DATA SET SERIAL NUMBER          61800021
         MVC   SMFUCBCH(K2),UCBCHA      UCBCHA FIELD                    62000021
         NI    SMFUCBCH,X'3F'           MASK OFF BITS 0 AND 1    A44480 62200021
         MVC   SMFUCBTY,UCBTYP          UCBTYP FIELD                    62400021
         MVC   SMFSRTEV,UCBVOLI         UCBVOLI FIELD                   62600021
         MVC   SMFSRTES,UCBSTAB         UCBSTAB FIELD                   62800021
         LA    RUCB,0(,RUCB)            CLEAR HIGH ORDER BYTE    A38013 63000021
         XR    R0,R0                    CLEAR REG                A38013 63200021
         IC    R0,TCTSCTR               SET LOOP CONTROL         A38013 63400021
         LR    R1,RF                    POINT TO FIRST UCB      Z30AAJC 63600003
CCM05080 CLM   RUCB,3,0(R1)             TEST FOR CORRECT UCB    Z30AAJC 63800003
         BE    CCM05090                 BRANCH IF CORRECT        A38013 64000021
         LA    R1,K8(R1)                INCREMENT INDEX          A38013 64200021
         BCT   R0,CCM05080              TEST FOR LAST ENTRY      A38013 64400021
         B     CCM04450                 BRANCH IF LAST           A38013 64600021
CCM05090 EQU   *                        GET EXCP COUNT          Z30AAJC 64800003
         MVC   SMFEXCP,K4(R1)           GET EXCP COUNT IN TCTIOT        65000003
CCM04450 EQU   *                                                 A38013 65200021
         MVC   SMFSRTEF(K4),UCBFSCT     UCBFSCT AND UCBFSEQ FIELDS      65400021
         MVI   SMF14NUC,K1              SET NUMBER OF UCB'S TO 1        65600021
SMFRCDLN EQU   X'124'                   SMF RECORD LENGTH        XM5543 65950000
         LA    RF,SMFRCDLN              SET RECORD LENGTH        XM5543 65960000
         STH   RF,SMF14LEN              STORE LENGTH IN RECORD          66000021
*                                                                       66050021
*   THE ESV EXTENSION IS NOT SUPPORTED FOR REL 21                       66200021
*                                                                       66250021
*   THIS SECTION FILLS IN THE REMAINING FIELDS AND ISSUES THE           66300021
*   SMFWTM MACRO TO WRITE THE RECORD ON THE SYS1.MAN DATA SET.          66350021
*                                                                       66360021
*     CHECK FOR A TEMPORARY DATA SET BY EXAMINING THE  DSN      SA60779 66362002
         CLC   JFCBDSNM(K3),SYSDS2H     SYSTEM GENERATED NAME?  SA60779 66364002
         BNE   CCM04500                 BRANCH, NOT A TEMP DS   SA60779 66366002
         CLC   JFCBDSNM+K8(K2),SYSTME2H  TEST FOR .T            SA60779 66368002
         BNE   CCM04500                 BRANCH, NOT A TEMP DS   SA60779 66370002
         CLI   JFCBDSNM+K16,PERIOD      TEST FOR '.'            SA60779 66372002
         BNE   CCM04500                 BRANCH, NOT A TEMP DS   SA60779 66374002
         OI    SMF14RIN,SMF14TDS        SET TEMP INDICATOR              66800021
CCM04500 EQU   *                                                        67000021
         MVI   SMF14RTY,K14             SET RECORD TYPE TO 14           67200021
         TM    SMFDEBOP,DEBOPOUT-DEBOPRBK  TEST FOR INPUT RDBACK DS     67400021
         BZ    CCM04600                 BRANCH IF INPUT/RDBACK          67600021
         OI    SMF14RTY,K15             SET RECORD TYPE TO 15           67800021
CCM04600 TIME  BIN                      ISSUE TIME SVC                  68000021
         STM   R0,R1,SMF14TME+K2        SAVE REGS                       68200021
         MVC   SMF14TME(K8),SMF14TME+K2  MOVE IN TIME                   68400021
         L     R1,SMF14JBN+K10          GET PTR TO JMR                  68600021
         USING JMRJOB,R1                                                68950000
         MVC   SMF14JBN(SMF14UID-SMF14JBN),JMRJOB  JMRJOB FIELD         69000021
         MVC   SMF14UID,JMRUSEID        JMRUSEID FIELD                  69200021
         MVC   SMF14SID(K4),JMRCPUID    JMRCPUID FIELD                  69400021
         MVI   SMF14SDC,SMF14UCB-SMFDCBDE  DCBDEBSZ FIELD               69600021
         MVI   SMF14SUC,SMF14UCE-SMF14UCB  UCBSEGSZ FIELD        XM0454 69950000
         OC    DXREGE,DXREGE            TEST FOR CLOSE ENTRY            70000021
         BZ    CCM04700                 BRANCH IF YES                   70200021
         OI    SMF14RIN,SMF14EOV        SET EOV BIT                     70400021
CCM04700 EQU   *                        POINT TO SMF RECORD             70600021
         SMFWTM (R7)                    WRITE SMF RECORD                70800021
CCM04800 EQU   *                                                        71000021
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM4614 71020002
         LA    RF,IECREGSV-IECPREFX(,R1) ADDR OF REG SAVE AREA   YM4614 71040002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM4614 71060002
         BNE   CCM04850                 BR IF NOT RECOVERY ENTRY YM4614 71080002
         L     RF,8(,RF)                RECOVERY REG SAVE AREA   YM4614 71100002
CCM04850 EQU   *                                                 YM4614 71110002
         LR    R1,R7                    SET UP FOR FREEMAIN             71200021
         IECRES FREE,A=(1),PREFIX=YES,STM=(0,14,0(RF))           YM4614*71250002
                                        FREE SMF RECORD AREA     YM4614 71350002
         L     RF,DXATCOM3              GET RRPLIST PTR          YM4614 71360002
         USING RRPLIST,RF                                        YM4614 71370002
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM4614 71380002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM4614 71390002
         BNE   CCM04900                 BR IF NOT RECOVERY ENTRY YM4614 71400002
         NI    RRFLAGS1,X'FF'-RRFSMF    RESET SMF IN CONTROL FLG YM4614 71410002
         MVC   WTGMODNM,RECMOD          MOVE RECOVERY MOD NAME   YM4614 71420002
         L     RF,RRFWORK               RECOVERY SUBRTN SAVEAREA YM4614 71430002
         L     RET,IECREGSV-IECEXTPR+K4*RET(,RF) GET RETURN ADDR YM4614 71440002
         ST    RET,WTGMODEP             SET EPA TO RETURN ADDR   YM4614 71450002
         LM    R0,RD,0(RF)              GET RECOVERY SUBRTN REGS YM4614 71460002
         IECRES LOAD,EXTPR=(RF),BRANCH=DIRECT RETURN TO IFG0RR0B YM4614 71480002
*                                                                       71490002
CCM04900 LM    RTIOT,RET,DXREGSAV       RESTORE CALLER'S         YM4614 71800002
         LM    R0,R1,DXREG0             REGISTERS                       72000021
         LTR   RET,RET                  ENTRY FROM CLOSE                72200021
         BNZ   CCM04950                 BRANCH IF NOT                   72400021
         LA    RET,K12                  RETURN FOR CLOSE RTN     A38013 72600021
         CLC   DXRETMOD(2),FINALMOD     RETURNING TO IFG0202J           72660000
         BNE   CCM04950                 NO, XCTL TO DXRETMOD            72670000
         NI    RRFLAGS1,X'FF'-RRFSMF    RESET SMF IN CONTROL FLG Y02144 72680002
         IECRES LOAD,MODID=FINALMOD,BRCODE=(RET),BRANCH=QUEUED   Y02080 72710002
*                                       XCTL TO FINALMOD         Y02080 72720002
CCM04950 EQU   *                                                        72800021
*                                       CLEAR TTR TO ENABLE      XM0454 72910000
*                                       XCTLING BY NAME          XM0454 72920000
         NI    RRFLAGS1,X'FF'-RRFSMF    RESET SMF IN CONTROL FLG Y02144 73010002
         IECRES LOAD,MODID=DXRETMOD,BRCODE=(RET),BRANCH=QUEUED   Y02080 73050002
*                                   XCTL TO FINAL MOD OR EOV RTN Y02080 73100002
CCM05000 EQU   *                                                        73200021
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM4614 73210002
         LA    RF,IECREGSV-IECPREFX(,R1) ADDR OF REG SAVE AREA   YM4614 73220002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM4614 73230002
         BNE   CCM05010                 NO, GO TEST FOR CLOSE  @ZA07184 73240037
         L     RF,8(,RF)                RECOVERY REG SAVE AREA @ZA07184 73310037
         MVC   WTGMODNM+4(K2),CLOSESVC  MOVE IN C'20'          @ZA07184 73380037
         LR    R1,R7                    PASS REG 7 TO REG 1    @ZA07184 73450037
         B     CCM05020                 RECOV. BRANCH DIRECT   @ZA07184 73520037
CCM05010 EQU   *                                               @ZA07184 73590037
         LM    RTIOT,RET,DXREGSAV       RESTORE CALLERS        @ZA07184 73660037
         L     R0,DXREG0                REGISTERS              @ZA07184 73730037
         CLI   WTGMODNM+4,X'F2'         ENTRY FROM CLOSE?      @ZA07184 73800037
         MVC   WTGMODNM+4(K2),CLOSESVC  MOVE IN C'20'          @ZA07184 73870037
         LR    R1,R7                    PASS REG 7 TO REG 1    @ZA07184 73940037
         BNE   CCM05020                 ENTRY NOT FROM CLOSE   @ZA07184 74010037
*                                       BRANCH DIRECT          @ZA07184 74080037
         IECRES LOAD,MODID=SMFDAMOD,BRCODE=(RET),BRANCH=QUEUED @ZA07184 74150037
CCM05020 IECRES LOAD,MODID=SMFDAMOD,EXTPR=(RF),BRANCH=DIRECT   @ZA07184 74220037
         EJECT                                                          74400021
         SPACE 1                                                        74600021
**********************************************************************  74800021
*                                                                    *  75000021
*              CONSTANTS                                             *  75200021
*                                                                    *  75400021
**********************************************************************  75600021
         SPACE 1                                                        75800021
ZERO     DC    F'0'                     CONSTANT ZERO            YM3762 75820002
DDBASLEN DC    Y(TIOESTTB-TIOENTRY)     TIOT ENTRY BASE LEN      A52390 75900021
UCBSIZE  DC    H'24'                    SIZE OF UCB SECTION             76000021
CLOSESVC DC    C'20'                    SVCCODE FOR CLOSE               76200021
SYSDS2H  DC    C'SYS'                   SYSTEM DS INDICATOR     SA60779 76202002
SYSTME2H DC    C'.T'                    TIME FOR TEMP DS        SA60779 76204002
RECCORID DC    C'RR0A'                  RECOVERY CORE ID         YM4614 76500002
         XCTLTABL ID=(SMFDAMOD,2I,FINALMOD,2J,RECMOD,IFG0RR0B),  YM4614*76550002
               SVC=020,BRT=YES,LENGTH=                           YM4614 76552002
         IECDSECS CVT,TCB,TIOT,SMF,SMFRCD,SMFTCT,JMR,DCB,DEB,UCB,WTG,  *76600021
               PREFX,MAIN,RRPL,EXPAND=YES                        Y02144 76800002
         IECEQU                                                         77000021
         END                                                            77200021
