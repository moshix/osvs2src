         TITLE 'IFG0202I - SMF DIRECT ACCESS MODULE'                    00200021
IFG0202I CSECT                                                          00800021
*********************************************************************** 01000021
*                                                                     * 01200021
*          VS 2 RELEASE 03 DELETIONS/CHANGES                         *  01250002
*0000                                                           ZA00822 01260002
*0000405020,696000,696300,696650,697900,698000,698100           Z30AAJC 01260103
*000069592003,69600003                                         @ZA05226 01270137
*0000677900,678700                                             @ZA08712 01280137
*0000                                                          @ZA15962 01289137
*          VS 1 RELEASE 01 DELETIONS                                  * 01300000
*0000                                                            XM5543 01350000
*          VS 1 RELEASE 02 DELETIONS                                  * 01352002
*0000643500                                                      XM0454 01354002
*                                                                     * 01400021
*          RELEASE 21 DELETIONS/CHANGES                               * 02400021
* 304000-308000,394000,400000,404000-508000,686000-690000        M1771  02450021
*                                                                A39153 02600021
*                                                                A42935 02800021
*                                                                A38013 03000021
*                                                                A43330 03200021
*                                                                A44480 03400021
*0000414500                                                     SA55575 03450002
*                                                                     * 03600021
* MODULE NAME = IFG0202I                                              * 03650002
*                                                                     * 03700002
* DESCRIPTIVE NAME = SMF DIRECT ACCESS MODULE                         * 03750002
*                                                                     * 03760002
* COPYRIGHT = NONE                                                    * 03770002
*                                                                     * 03780002
* STATUS CHANGE LEVEL 000                                             * 03800021
*                                                                     * 04000021
* FUNCTION -                                                          * 04200021
*    THIS MODULE CONTAINS THE FUNCTION(S) OR PART(S) OF FUNCTION(S)-- * 04400021
*    CLOSE/EOV SMF RECORD BUILDER FUNCTION.                           * 04600021
*       THIS FUNCTION STARTS IN MODULE IFG0202H, AND CONTINUES HERE   * 04800021
*       ONLY FOR DIRECT ACCESS DATA SETS.                             * 05000021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)' FOR DETAILS.         * 05200021
*                                                                     * 05400021
* ENTRY POINTS -                                                      * 05600021
*         IFG0202I - ENTRY POINT VIA AN XCTL FROM THE FOLLOWING--     * 05800021
*             IFG0202H - CONTINUE PROCESSING CLOSE/EOV SMF RECORD     * 06000021
*                        BUILDER FUNCTION.                            * 06200021
*                                                                     * 06400021
* INPUT -                                                             * 06600021
*    ENTERED IN DATA MANAGEMENT KEY                              Y02082 06650002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 06800021
*                                                                     * 07000021
* OUTPUT -                                                            * 07200021
*    EXIT IN DATA MANAGEMENT KEY                                 Y02082 07250002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 07400021
*                                                                     * 07600021
* EXTERNAL REFERENCES -                                               * 07800021
*         IFG019RA - OPEN/CLOSE/EOV RESIDENT ROUTINE FOR XCTL AND     * 08000002
*                    WAIT.                                            * 08200021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 08400021
*                                                                     * 08600021
* EXITS, NORMAL -                                                     * 08800021
*    EXIT VIA THE RESIDENT ROUTINE XCTL TO THE FOLLOWING--            * 09000021
*         IFG0202J - PROCESS CLOSE FINAL STRING.                      * 09200021
*         IFG0553P - PROCESS EOV DIRECT ACCESS INPUT FUNCTION.        * 09400021
*         IFG0554P - PROCESS EOV DIRECT ACCESS OUTPUT FUNCTION.       * 09600021
*         IFG0RROB - FORCE CLOSE PROCESSING                           * 09700002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 09800021
*                                                                     * 10000021
* EXITS, ERROR -                                                      * 10200021
*    EXIT IS TO THE PROBLEM DETERMINATION MODULE IFG0200P, IF AN      * 10400021
*    ABEND SITUATION OCCURS IN THIS MODULE.  REFER TO THE FOLLOWING   * 10600021
*    'FUNCTION PROLOG(S)'.                                            * 10800021
*                                                                     * 11000021
* TABLES/WORK AREAS -                                                 * 11200021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 11400021
*                                                                     * 11600021
* ATTRIBUTES -                                                        * 11800021
*    REENTRANT, REFRESHABLE, READ-ONLY, ENABLED, PRIVILEGED           * 12000021
*                                                                     * 12200021
* CHARACTER CODE DEPENDENCY -                                         * 12400021
*    CLASS ONE CHARACTER CODE DEPENDENCY - THE EBCDIC CHARACTER CODE  * 12600021
*    WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED IF A      * 12800021
*    DIFFERENT CHARACTER SET IS USED FOR EXECUTION.                   * 13000021
*                                                                     * 13200021
* NOTES -                                                             * 13400021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOG(S)'.                     * 13600021
*                                                                     * 13800021
*********************************************************************** 14000021
         EJECT                                                          14200021
         USING IHADCB,RDCB                                              14400021
         USING FORCORE,RCORE                                            14600021
         USING UCBOB,RUCB                                               14800021
         USING TIOENTRY,RTIOT                                           15000021
         USING DEB,RDEB                                                 15200021
         USING CVT,RD                                                   15400021
         USING SMF14RCD,R7                                              15600021
         USING TCTUCBP,RF                                               15800021
         USING WTG,RWTG                                                 16000021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         16200021
         USING *,RBASE                                                  16400021
         EJECT                                                          16600021
*                                                                     * 16800021
*                          FUNCTION PROLOG                            * 17000021
*                                                                     * 17200021
*********************************************************************** 17400021
*                                                                     * 17600021
* FUNCTION NAME -                                                     * 17800021
*    CLOSE/EOV SMF RECORD BUILDER FUNCTION.                           * 18000021
*                                                                     * 18200021
* (STATUS) -                                                          * 18400021
*    NOT APPLICABLE                                                   * 18600021
*                                                                     * 18800021
* FUNCTION -                                                          * 19000021
*    THIS FUNCTION IS CALLED BY CLOSE/EOV WHEN THE SYSTEM MANAGEMENT  * 19200021
*    FACILITIES DATA SET INFORMATION IS DESIRED. THIS FUNCTION BUILDS * 19400021
*    THE TYPE 14/15 SMF RECORD AND ISSUE AN SVC 83 TO HAVE THE RECORD * 19600021
*    WRITTEN ON THE SYS1.MAN DATA SET.                                * 19800021
*    IF ENTRY WAS FROM CLOSE, THIS FUNCTION SETS UP POINTERS TO       * 20000021
*    VARIOUS CONTROL BLOCKS REQUIRED TO BUILD THE SMF RECORD.         * 20200021
*    A GETMAIN IS ISSUED FOR THE CORE REQUIRED TO BUILD THE RECORD IF * 20400021
*    ENTRY WAS FROM EOV OR IF THE RECORD WILL NOT FIT IN THE WORKAREA * 20600021
*    USED BY CLOSE.                                                   * 20800021
*                                                                     * 21000021
* ENTRY POINTS -                                                      * 21200021
*    ENTERED FROM THE FOLLOWING--                                     * 21400021
*    CLOSE SMF INTERFACE FUNCTIONS.                                   * 21600021
*    EOV SMF INTERFACE FUNCTIONS.                                     * 21800021
*                                                                     * 22000021
* INPUT -                                                             * 22200021
*    A POINTER TO EACH OF THE FOLLOWING--                             * 22400021
*       CURRENT PARAMETER LIST ENTRY- RPARC                           * 22600021
*       DD ENTRY IN THE TIOT- RTIOT                                   * 22800021
*       WTG TABLE- RWTG                                               * 23000021
*       CURRENT WTG TABLE ENTRY- RWTGC                                * 23200021
*       DCB- RDCB                                                     * 23400021
*       WORK AREA- RCORE                                              * 23600021
*       RESIDENT ROUTINE- RES                                         * 23800021
*       UCB- RUCB                                                     * 24000021
*       DEB- RDEB                                                     * 24200021
*                                                                     * 24400021
* OUTPUT -                                                            * 24600021
*    AN SMF RECORD IS WRITTEN FOR TAPE AND D. A. DATA SETS.           * 24800021
*                                                                     * 25000021
* EXTERNAL REFERENCES -                                               * 25200021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 25400002
*                                                                     * 25600021
* EXITS, NORMAL -                                                     * 25800021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 26000002
*    CLOSE/EOV FUNCTIONS THAT CALLED THIS FUNCTION.                   * 26200021
*                                                                     * 26400021
* EXITS, ERROR -                                                      * 26600021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 26800002
*                                                                     * 27000021
* TABLES/WORK AREAS -                                                 * 27200021
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 27400021
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 27600021
*                                                                     * 27800021
* ATTRIBUTES -                                                        * 28000021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 28200002
*                                                                     * 28400021
* CHARACTER CODE DEPENDENCY -                                         * 28600021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 28800002
*                                                                     * 29000021
* NOTES -                                                             * 29200021
*    NOT APPLICABLE                                                   * 29400021
*                                                                     * 29600021
*********************************************************************** 29800021
         EJECT                                                          30000021
*                                                                       30200021
*   THIS SECTION BUILDS THE DCB/DEB EXTENSION.                          30400021
*                                                                       31000021
         LR    R7,R1                    RESTORE BASE REG FOR SMF REC    31200021
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP               A39153 31400021
         BZ    CCM02520                 BRANCH IF NOT            A39153 31600021
         TM    DCBMACRF,DCBMCOM         COMMON INTERFACE PRESENT A39153 31800021
         BZ    CCM02600                 BRANCH IF NOT            A39153 32000021
         TM    DCBMACRF+K1,DCBMDEV      DEV. INTERFACE PRESENT   A39153 32200002
         BZ    CCM02600                 BRANCH IF NOT            A39153 32400021
CCM02520 EQU   *                        NOT EXCP                 A39153 32600002
         TM    DCBDSORG,DCBORGDA        TEST FOR DIRECT ORG      A43330 32800021
         BZ    CCM02540                 BRANCH IF NOT            A43330 33000021
         OI    SMF14RIN,SMF14DDA        SET DA INDICATOR         A43330 33200021
         B     CCM02600                 BRANCH TO RESTORE REG    A43330 33400021
CCM02540 EQU   *                        NOT DIRECT ORG           A43330 33600002
         TM    DCBDSORG,DCBORGPS        TEST FOR PHYSICAL SEQ           33800021
         BZ    CCM02600                 BRANCH IF NOT PS         A39153 34000021
         LR    R1,RDEB                  SET UP PARM REGS FOR IECPRLTV   34200021
         LA    RDCB,DCBFDAD             GET DISK ADDR TO BE CONVERTED   34400021
         L     RD,CVTPTR                GET POINTER TO CVT              34600021
         L     RF,CVTPRLTV              GET ADDRESS OF CONVERT ROUTINE  34800021
         BALR  RET,RF                   LINK TO CONVERT ROUTINE         35000021
CCM02600 L     RDCB,REGSAVE             RESTORE REGISTERS               35200021
         LM    RCORE,RET,REGSAVE+K4     RESTORE REGISTERS               35400021
         LTR   RF,RF                    TEST RETURN CODE                35600021
         BNZ   CCM02700                 BRANCH IF NOT ZERO              35800021
         ST    R0,SMF14NTU              INSERT TRACKS USED IN RECORD    36000021
CCM02700 EQU   *                                                        36200021
         L     RF,REGSAVE+K48           RESTORE PTR TO TCTUCBP          36400002
         XC    REGSAVE(K52),REGSAVE     CLEAR REGSAVE CORE       A39153 36600021
         OI    SMF14RIN,SMF14DAD        SET DASD INDICATOR              36800021
         ST    R8,SMF14TME+K2           SAVE R8                         37000021
         STM   RC,RET,SMF14TME+K6       SAVE REGISTERS                  37200021
         XR    RD,RD                    CLEAR REG                       37400021
         IC    RD,TCTSCTR               GET NO. UCB ENTRIES IN TCT      37600021
         SLL   RD,3                     MULTIPLY BY ENTRY SIZE          37800021
         LA    RD,K4(RD,RF)             GET ADDR OF RLSE INFO           38000021
         MVC   SMF14NTR+K1(K3),K1(RD)   NBR OF TRACKS RELEASED   YM6805X38200002
                                        BY DADSM PARTIAL RELEASE YM6805 38205002
         MVC   SMF14NER,K0(RD)          NUMBER OF EXTENTS       SA60362 38400002
*                                       RELEASED BY DADSM       SA60362 38402002
         MODESET EXTKEY=SUPR            GET IN SUPERV KEY        YM5936 38404002
         XC    K0(K4,RD),K0(RD)         ZERO RLSE INFO IN TCT   SA60362 38410002
         MODESET EXTKEY=DATAMGT         RESUME DM KEY            YM5936 38420002
*                                                                       38450021
*   THIS SECTION PREPARES TO BUILD THE UCB SEGMENT(S) FOR AN ISAM       38500021
*   DATA SET. ONE UCB SEGMENT WILL BE BUILT FOR EACH OF THE INDEX       38550021
*   AND OVERFLOW AREAS PLUS ONE UCB SEGMENT FOR EACH PRIME VOLUME.      38560021
*                                                                       38570021
         LR    RD,RTIOT                 GET TIOT ADDRESS         YM6805 38580002
         LA    R9,SMF14UCB              SET BASE FOR UCB SEGS    YM6805 38600002
         USING SMF14UCB,R9              UCB SEGMENT ADDRESSING   YM6805 38800002
         XR    R8,R8                    ZERO LOOP CONTROL REGS          39000021
         XR    R0,R0                    ZERO REGISTER            YM6805 39200002
         LA    R1,DEBDVMOD-DEB(RDEB)    POINT TO FIRST EXTENT           39600021
         TM    SMFDCBOR,DCBORGIS        IS THIS AN ISAM DATA SET        39800021
         BZ    CCM02740                 BRANCH IF NOT ISAM       M1771  40000021
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP               A42935 40200021
         BO    CCM02770                 BRANCH IF YES            M1771  40250021
         XR    RET,RET                  ZERO REGISTER            YM6805 40253002
         XC    DXXCTL,DXXCTL            CLEAR TEMP WORK AREA     YM6805 40256002
         IC    R0,TIOELNGH-TIOENTRY(,RD)  LENGTH OF DD ENTRY     YM6805 40259002
         AR    RD,R0                    POINT TO NEXT ENTRY      YM6805 40262002
         LA    RC,K2                    SET LOOP CONTROL         YM6805 40265002
CCM02703 EQU   *                        TEST IF LAST ENTRY       YM6805 40268002
         IC    R0,TIOELNGH-TIOENTRY(,RD)  GET ENTRY LENGTH       YM6805 40271002
         LTR   R0,R0                    IS NEXT ENTRY LAST       YM6805 40274002
         BZ    CCM02706                 YES, BRANCH              YM6805 40277002
         CLI   TIOEDDNM-TIOENTRY(RD),BLANK  CONCAT'D DD ENTRY    YM6805 40280002
         BNE   CCM02706                 NO, BRANCH               YM6805 40283002
         LA    RET,K1(,RET)             INCR NBR ADDITIONAL DDS  YM6805 40286002
         AR    RD,R0                    POINT TO NEXT ENTRY      YM6805 40289002
         BCT   RC,CCM02703              LOOP IF POSSIBLE 3 DDS   YM6805 40292002
*                                                                YM6805 40293002
CCM02706 EQU   *                        GET NBR OF INDEX EXTENTS YM6805 40295002
         STC   RET,DXXCTL               SAVE ADDITIONAL DD COUNT YM6805 40298002
         IC    R8,DEBNIEE               GET NBR OF INDEX EXTENTS M1771  40300021
         LTR   R8,R8                    TEST FOR ZERO EXTENTS    M1771  40350021
         BZ    CCM02710                 BRANCH IF ZERO           M1771  40400021
         L     R1,DEBFIEAD              ADDR OF 1ST INDEX EXTENT M1771  40450021
         BAL   RET,CCM02800             GO BUILD THE UCB SEGMENT YM6805 40500002
         STCM  RUCB,3,DXXCTL+K2         SAVE INDEX UNIT USED    Z30AAJC 40502003
         CLI   DXXCTL,K2                3 DD CARDS               YM6805 40504002
         BNE   CCM02710                 NO, BRANCH               YM6805 40506002
         MVI   DXXCTL,K1                SET DD COUNT TO ONE      YM6805 40508002
         BAL   RET,CCM05500             GET NEXT TCT DD ENTRY    YM6805 40510002
*                                                                YM6805 40520002
CCM02710 EQU   *                        GET NBR OF PRIME EXTENTS YM6805 40550002
         IC    R8,DEBNPEE               GET NO. OF PRIME EXTENTS M1771  40600021
         LTR   R8,R8                    TEST FOR ZERO EXTENTS    M1771  40650021
         BZ    CCM02720                 BRANCH IF ZERO           M1771  40700021
         CLI   DEBNOEE,K0               OVERFLOW EXIST           YM6805 40710002
         BE    CCM02715                 NO, BRANCH               YM6805 40720002
         L     R1,DEBFOEAD              PT TO 1ST OVFLOW EXTENT  YM6805 40730002
         MVC   DXXCTL+6(K2),K2(R1)      SAVE OVERFLOW UNIT       YM6805 40740002
CCM02715 EQU   *                        BUILD PRIME UCB SEGMENTS YM6805 40742002
         L     R1,DEBFPEAD              ADDR OF 1ST PRIME EXTENT M1771  40750021
         BAL   RET,CCM02800             GO BUILD UCB SEGMENT(S)  YM6805 40760002
         CLI   DXXCTL,K0                ANOTHER DD CARD          YM6805 40770002
         BE    CCM02720                 NO, BRANCH               YM6805 40780002
         MVI   DXXCTL,K0                SET DD COUNT TO ZERO     YM6805 40790002
         BAL   RET,CCM05500             GET NEXT TCT DD ENTRY    YM6805 40800002
*                                                                YM6805 40820002
CCM02720 EQU   *                        GET NBR OF OVFLOW EXTNTS YM6805 40850002
         IC    R8,DEBNOEE               NO. OF OVERFLOW EXTENTS  M1771  40900021
         LTR   R8,R8                    TEST FOR ZERO EXTENTS    M1771  40950021
         BZ    CCM03650                 BRANCH IF ZERO           M1771  41000021
         MVC   DXXCTL+2(K2),DXXCTL+4    MOVE OVERFLOW UNIT USED  YM6805 41010002
         L     R1,DEBFOEAD              1ST OVERFLOW EXTENT ADDR M1771  41050021
         LA    RET,CCM03650             RETURN TO ISAM SECTION   YM6805 41100002
         B     CCM02800                 GO BUILD THE UCB SEGMENT M1771  41150021
*                                                                       41200021
*   THIS SECTION PREPARES TO BUILD A UCB SEGMENT FOR EACH               41250021
*   DATA SET IN CONCATENATED BPAM INPUT.                                41300021
*                                                                       41350021
CCM02740 EQU   *                        NOT ISAM                 M1771  41400002
         TM    SMFDCBOR,DCBORGPO        TEST FOR BPAM DATA SET  SA55575 41450002
         BZ    CCM02770                 BRANCH IF NOT BPAM       M1771  41500021
         TM    DEBOPATB,DEBOPOUT        TEST FOR INPUT           M1771  41550021
         BNZ   CCM02770                 BRANCH IF NOT INPUT      M1771  41600021
         SR    RD,RD                    CLEAR REGISTER FOR IC    YM6805 41610002
         IC    RD,DEBAMLNG              LENGTH OF BPAM SECTION   M1771  41650021
         LTR   RD,RD                    IS IT CONCATENATED INPUT M1771  41700021
         BZ    CCM02770                 BRANCH IF NOT            M1771  41750021
         XR    RC,RC                    ZERO REGISTER            M1771  41800021
         IC    RC,DEBNMEXT              GET NUMBER OF EXTENTS    M1771  41850021
         MH    RC,XTNTSIZE              CALCULATE EXTENT LENGTH  M1771  41900021
         AR    RC,R1                    POINT TO BPAM SECTION    M1771  41950021
         IC    R8,0(,RC)                GET NUMBER OF EXTENTS    M1771  42000021
*                                       FOR THE FIRST DATA SET   M1771  42050021
CCM02750 EQU   *                        FROM DEBEXTNM FIELD      M1771  42100021
         STM   RC,RD,DXXCTL             SAVE CURRENT POINTER AND M1771  42150021
*                                       NO. OF BYTES LEFT IN     M1771  42200021
*                                       BPAM SECTION             M1771  42250021
         BAL   RET,CCM02800             GO BUILD THE UCB SEGMENT YM6805 42300002
         BAL   RET,CCM05500             GET NEXT TCT DD ENTRY    YM6805 42310002
         LM    RC,RD,DXXCTL             RESTORE BPAM SECTION PTR M1771  42350021
*                                       AND NO. OF BYTES IN BPAM M1771  42400021
*                                       SECTION                  M1771  42450021
         SR    RET,RET                  ZERO REGISTER FOR IC     YM6805 42500002
         IC    RET,0(,RC)               EXTENT NO. OF CURRENT    YM6805X42550002
                                        DATA SET                 YM6805 42560002
         LA    RC,K1(RC)                POINT TO NEXT EXTENT NO. M1771  42600021
         IC    R8,0(,RC)                EXTENT NO. OF NEXT D/S   M1771  42650021
         SR    R8,RET                   CALCULATE NBR OF EXTENTS YM6805X42700002
                                        FOR THIS DATA SET        YM6805 42750002
         BCT   RD,CCM02750              GO BUILD THE UCB SEGMENT M1771  42800021
CCM02760 EQU   *                        BUILD UCB SEG            M1771  42850002
         XR    R8,R8                    ZERO REGISTER            M1771  42900021
         IC    R8,DEBNMEXT              GET NUMBER OF EXTENTS    M1771  42950021
         SR    R8,RET                   CALCULATE NO. OF EXTENTS YM6805X43000002
                                        FOR THE LAST DATA SET    YM6805 43050002
         BAL   RET,CCM02800             GO BUILD THE UCB SEGMENT YM6805 43100002
         XC    DXXCTL,DXXCTL            CLEAR THE STORAGE AREA   M1771  43150021
         B     CCM04400                 GO COMPLETE THE RECORD   M1771  43200021
*                                                                       43250021
*   THIS SECTION PREPARES TO BUILD THE UCB SEGMENT(S) FOR               43300021
*   ALL OTHER DATA SETS.                                                43350021
*                                                                       43400021
CCM02770 EQU   *                        NOT CONCATENATED         M1771  43450002
         IC    R8,DEBNMEXT              GET NUMBER OF EXTENTS    M1771  43500021
         BAL   RET,CCM02800             GO BUILD THE UCB SEGMENT YM6805 43550002
         TM    SMFDCBOR,DCBORGIS        IS THIS AN ISAM DATA SET        51000021
         BNO   CCM04400                 BRANCH IF NO                    51200021
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP              YA03180 51205002
         BO    CCM04400                 NO ISAM EXTENSION IF SO YA03180 51210002
*                                                                       51400021
*   THIS SECTION BUILDS THE ISAM EXTENSION SEGMENT.                     51600002
*                                                                       51800021
CCM03650 EQU   *                        ZERO EXTENTS             M1771  51850002
         TM    SMFJFCB1+(JFCDSORG-INFMJFCB),JFCORGIS  TEST FOR ISAM     52000021
         BNO   CCM03700                 BRANCH IF NOT ISAM IN JFCB      52200021
         OI    SMF14RIN,SMF14JIS        SET JFCB ISAM BIT               52400021
CCM03700 MVI   SMF14SET,K28             SET EXTENSION SIZE              52600021
         OI    SMF14RIN,SMF14IS         SET DCB ISAM BIT                52800021
         USING SMFISAMX,R9              ISAM SEGMENT ADDRESSING  YM6805 53000002
         MVC   SMFDCBMA,DCBMAC          DCBMAC FIELD                    53200021
         MVC   SMFDCBNL,DCBNLEV         DCBNLEV FIELD                   53400021
         MVC   SMFDCBR3(K8),DCBRORG3    DCBRORG3 FIELD                  53600021
         MVC   SMFDCBR2,DCBRORG2        DCBRORG2 FIELD                  53800021
         MVC   SMFDCBNO,DCBNOREC        DCBNOREC FIELD                  54000021
         MVC   SMFDCBR1,DCBRORG1        DCBRORG1 FIELD                  54200021
         IC    R8,DEBNIEE               GET NUM OF EXTENTS IN INDEX     54400021
         LTR   R8,R8                    TEST FOR ZERO EXTENTS           54600021
         BZ    CCM03900                 BRANCH IF ZERO                  54800021
         STC   R8,SMFDEBNI              STORE IN SMF RECORD             55000021
         L     R1,DEBFIEAD              ADDR OF 1ST INDEX EXTENT YM6805 55200002
         BAL   RET,CCM05010             CALCULATE NUMBER OF      YM6805X55400002
                                        CYLINDERS IN INDEX AREA  YM6805 55410002
         STH   RD,SMFNCYLS              STORE NUM OF CYLINDERS          55600021
CCM03900 EQU   *                                                        55800021
         IC    R8,DEBNPEE               GET NUM OF EXTENTS IN PRIME     56000002
         LTR   R8,R8                    TEST FOR ZERO EXTENTS           56200021
         BZ    CCM04100                 BRANCH IF ZERO                  56400021
         STC   R8,SMFDEBNP              STORE IN SMF RECORD             56600021
         L     R1,DEBFPEAD              ADDR OF 1ST PRIME EXTENT YM6805 56800002
         BAL   RET,CCM05010             CALCULATE NUMBER OF      YM6805X57000002
                                        CYLINDERS OF PRIME DATA  YM6805 57200002
         STH   RD,SMFNPCYL              STORE NUM OF CYLINDERS          57400021
CCM04100 EQU   *                                                        57600021
         IC    R8,DEBNOEE               GET NUM OF EXTENTS IN OVFL      57800021
         LTR   R8,R8                    TEST FOR ZERO EXTENTS           58000021
         BZ    CCM04300                 BRANCH IF ZERO                  58200021
         STC   R8,SMFDEBNO              STORE IN SMF RECORD             58400021
         L     R1,DEBFOEAD              ADDR OF 1ST OVFLW EXTENT YM6805 58600002
         BAL   RET,CCM05010             CALCULATE NUMBER OF      YM6805X58800002
                                        CYLINDERS IN OVERFLOW    YM6805 58810002
         STH   RD,SMFNOCYL              STORE NUM OF CYLINDERS          59000021
CCM04300 EQU   *                                                        59200021
         LA    R9,SMFNOCYL+L'SMFNOCYL-SMFISAMX(R9)  INCREMENT    YM6805X59400002
                                        TO END OF ISAM SEGMENT   YM6805 59410002
*                                                                       59450002
*   THIS SECTION FILLS IN THE REMAINING FIELDS AND ISSUES THE           59500021
*   SMFWTM MACRO TO WRITE THE RECORD ON THE SYS1.MAN DATA SET.          59550021
*                                                                       59560021
CCM04400 SR    R9,R7                    GET RECORD LENGTH        YM6805 59600002
         STH   R9,SMF14LEN              STORE LENGTH IN RECORD   YM6805 59800002
         DROP  R9                                                YM6805 60000002
         L     R8,SMF14TME+K2           RESTORE R8                      60200002
         LM    RC,RET,SMF14TME+K6       RESTORE REGS                    60400021
         XC    SMF14TME+2(K16),SMF14TME+2  CLEAR TEMP REG SAVE AREA     60600021
*     CHECK FOR A TEMPORARY DATA SET BY EXAMINING THE DSN       SA60779 60650002
         CLC   JFCBDSNM(K3),SYSDS2I     SYSTEM GENERATED NAME?  SA60779 60700002
         BNE   CCM05100                 BRANCH, NOT A TEMP DS   SA60779 60750002
         CLC   JFCBDSNM+K8(K2),SYSTME2I  CHECK FOR '.T'         SA60779 60760002
         BNE   CCM05100                 BRANCH IF NOT A TEMP DS SA60779 60770002
         CLI   JFCBDSNM+K16,PERIOD      TEST FOR '.'            SA60779 60780002
         BNE   CCM05100                 BRANCH IF NOT A TEMP DS SA60779 60790002
         OI    SMF14RIN,SMF14TDS        SET TEMP INDICATOR              61200021
CCM05100 EQU   *                                                        61400021
         MVI   SMF14RTY,K14             SET RECORD TYPE TO 14           61600021
         TM    SMFDEBOP,DEBOPOUT-DEBOPRBK  TEST FOR INPUT RDBACK DS     61800021
         BZ    CCM05200                 BRANCH IF INPUT/RDBACK          62000021
         OI    SMF14RTY,K15             SET RECORD TYPE TO 15           62200021
CCM05200 TIME  BIN                      ISSUE TIME SVC                  62400021
         STM   R0,R1,SMF14TME+K2        SAVE REGS                       62600021
         MVC   SMF14TME(K8),SMF14TME+K2  MOVE IN TIME                   62800021
         L     R1,SMF14JBN+K10          GET PTR TO JMR                  63000021
         USING JMRJOB,R1                                                63050002
         MVC   SMF14JBN(SMF14UID-SMF14JBN),JMRJOB  JMRJOB FIELD         63400021
         MVC   SMF14UID,JMRUSEID        JMRUSEID FIELD                  63600021
         MVC   SMF14SID(K4),JMRCPUID    JMRCPUID FIELD                  63800021
         MVI   SMF14SDC,SMF14UCB-SMFDCBDE  DCBDEBSZ FIELD               64000021
         MVI   SMF14SUC,SMF14UCE-SMF14UCB  UCBSEQSZ FIELD        YM3791 64350002
         OC    DXREGE,DXREGE            TEST FOR CLOSE ENTRY            64400021
         BZ    CCM05300                 BRANCH IF YES                   64600021
         OI    SMF14RIN,SMF14EOV        SET EOV BIT                     64800021
CCM05300 EQU   *                        POINT TO SMF RECORD             65000021
         SMFWTM (R7)                    WRITE SMF RECORD                65200021
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM4614 65210002
         LA    RF,IECREGSV-IECPREFX(,R1) ADDR OF REG SAVE AREA   YM4614 65220002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM4614 65230002
         BNE   CCM05350                 BR IF NOT RECOVERY ENTRY YM4614 65240002
         L     RF,8(,RF)                RECOVERY REG SAVE AREA   YM4614 65250002
CCM05350 EQU   *                                                 YM4614 65260002
         LR    R1,R7                    SET UP FOR FREEMAIN             65400021
         IECRES FREE,A=(1),PREFIX=YES,STM=(0,14,0(RF))           YM4614*65810002
                                        FREE SMF RECORD AREA     YM4614 65860002
         L     RF,DXATCOM3              GET RRPLIST PTR          YM4614 65870002
         USING RRPLIST,RF                                        YM4614 65880002
         L     R1,WTGPREFX              GET BASE PREFIX ADDR     YM4614 65890002
         CLC   IECCORID-IECPREFX(K4,R1),RECCORID  RECOVERY ENTRY YM4614 65900002
         BNE   CCM05400                 BR IF NOT RECOVERY ENTRY YM4614 65910002
         NI    RRFLAGS1,X'FF'-RRFSMF    RESET SMF IN CONTROL FLG YM4614 65920002
         MVC   WTGMODNM,RECMOD          MOVE RECOVERY MOD NAME   YM4614 65930002
         L     RF,RRFWORK               RECOVERY SUBRTN SAVEAREA YM4614 65940002
         L     RET,IECREGSV-IECEXTPR+K4*RET(,RF) GET RETURN ADDR YM4614 65950002
         ST    RET,WTGMODEP             SET EPA TO RETURN ADDR   YM4614 65960002
         LM    R0,RD,0(RF)              GET RECOVERY SUBRTN REGS YM4614 65970002
         IECRES LOAD,EXTPR=(RF),BRANCH=DIRECT RETURN TO IFG0RR0B YM4614 65980002
*                                                                       65990002
CCM05400 EQU   *                                                        66000021
         LM    RTIOT,RET,DXREGSAV       RESTORE CALLER'S                66200021
         LM    R0,R1,DXREG0             REGISTERS                       66400021
         LA    RET,K0(,RET)             CLEAR HIGH ORDER BYTE           66500000
         LTR   RET,RET                  ENTRY FROM CLOSE                66600021
         LA    RET,K12                  SET RETURN OFFSET        A38013 66800021
         BZ    CCM05410                 BRANCH IF YES                   67150000
         L     RET,DXREGE               RESTORE RETURN OFFSET           67200021
         MVC   WTGMODNM+4(K2),EOVSVC    MOVE IN C'55' FOR EOV           67400021
CCM05405 EQU   *                                                        67600021
*                                       CLEAR TTR TO ENABLE      XM0454 67750002
*                                       XCTLING BY NAME          XM0454 67770002
         NI    RRFLAGS1,X'FF'-RRFSMF    SHOW SMF               @ZA08712 67790037
*                                       NOT IN CONTROL         @ZA08712 67800037
         IECRES LOAD,MODID=DXRETMOD,BRCODE=(RET),BRANCH=QUEUED   Y02080 67810002
*                                    XCTL TO FINALMOD, OR EOV DA Y02080 67820002
CCM05410 EQU   *                        XCTL TO FINALMOD                67860000
         NI    RRFLAGS1,X'FF'-RRFSMF    SHOW SMF               @ZA08712 67870037
*                                       NOT IN CONTROL         @ZA08712 67890037
         IECRES LOAD,MODID=FINALMOD,BRCODE=(RET),BRANCH=QUEUED   Y02080 67910002
         EJECT                                                   YM6805 67915002
*                                                                       67920002
*   THIS ROUTINE ADVANCES TO THE NEXT DD ENTRY IN THE TCT.              67925002
*                                                                       67930002
CCM05500 EQU   *                        GET  NEXT TCT ENTRY      YM6805 67940002
         L     RD,CVTPTR                POINT TO CVT             YM6805 67950002
         L     RD,CVTTCBP               POINT TO TCB WORDS       YM6805 67960002
         L     RD,K4(RD)                POINT TO CURRENT TCB     YM6805 67970002
         USING TCB,RD                                            YM6805 67980002
         L     RD,TCBTCT                POINT TO TCT             YM6805 67990002
         USING SMFTCT,RD                                         YM6805 68000002
         L     RD,TCTIOTBL              POINT TO TCT IO TBL      YM6805 68010002
         USING TCTTIOT,RD                                        YM6805 68020002
         SR    RF,RD                    OFFSET TO CURRENT DD     YM6805 68030002
         LA    RC,TCTDCBTD              POINT TO FIRST DD ENTRY  YM6805 68040002
         USING TCTDCBTD,RC                                       YM6805 68050002
CCM05600 EQU   *                        TEST FOR CURRENT DD      YM6805 68060002
         CH    RF,TCTIOTSD              IS THIS CURRENT DD       YM6805 68070002
         BE    CCM05700                 BRANCH IF YES            YM6805 68080002
         LA    RC,TCTDCBLE              POINT TO NEXT DD ENTRY   YM6805 68090002
         B     CCM05600                 GO CHECK NEXT            YM6805 68100002
CCM05700 EQU   *                        TEST IF END OF TCT       YM6805 68110002
         XR    RF,RF                    ZERO REGISTER            YM6805 68120002
         C     RF,TCTDCBLE              IS THIS END OF TCT       YM6805 68130002
         BE    CCM05800                 YES, GO USE THIS OFFSET  YM6805 68140002
         LA    RC,TCTDCBLE              POINT TO NEXT DD ENTRY   YM6805 68150002
CCM05800 EQU   *                        GET OFFSET OF NEXT DD    YM6805 68160002
         LH    RF,TCTIOTSD              OFFSET OF NEXT DD        YM6805 68170002
         AR    RF,RD                    POINT TO NEXT DD ENTRY   YM6805 68180002
         BR    RET                      RETURN                   YM6805 68190002
         DROP  RC,RD                                             YM6805 68192002
         EJECT                                                   YM6805 68194002
*                                                                       68196002
*   THIS ROUTINE CALCULATES THE NUMBER OF CYLINDERS IN AN ISAM          68197002
*   INDEX, PRIME, OR OVERFLOW AREA.                                     68198002
*                                                                       68199002
CCM05010 EQU   *                                                        68200021
         XR    RD,RD                    CLEAR REG                       68400021
CCM05030 AH    RD,DEBENDCC-DEBDVMOD(,R1)  ADD ENDING CYL ADDR    YM6805 68600002
         SH    RD,DEBSTRCC-DEBDVMOD(,R1)  LESS STARTING CYL ADDR YM6805 68800002
         LA    RD,K1(,RD)               CALCULATE NO. OF CYL     M1771  68850021
         LA    R1,DEBVOLSQ-DEBDVMOD(,R1)  INCREMENT TO NEXT      YM6805X69000002
                                        EXTENT                   YM6805 69050002
         BCT   R8,CCM05030              BRANCH IF MORE EXTENTS          69200021
         BR    RET                      RETURN TO CALLER         YM6805 69400002
         EJECT                                                   YM6805 69450002
*                                                                       69500021
*   THIS ROUTINE BUILDS THE UCB SEGMENT(S).                             69550021
*                                                                       69560021
         USING DEBDVMOD,R1              BASE FOR DEB EXTENT      M1771  69562021
         USING SMF14UCB,R9              BASE FOR UCB SEGMENT     YM6805 69563002
CCM02800 IC    RD,SMF14NUC              GET NUMBER OF UCB        M1771  69570021
         LA    RD,K1(RD)                INCREMENT NO. OF UCB'S   M1771  69580021
         STC   RD,SMF14NUC              STORE NUMBER OF UCB      M1771  69590021
         L     RUCB,DEBUCBAD            GET UCB ADDR FROM EXTNT@ZA05226 69594037
         LA    RUCB,UCBOB               CLEAR HI ORDER BYTE    @ZA05226 69596037
         MVC   SMFUCBCH(K2),UCBCHA      UCBCHA FIELD             YM6805 69605002
         NI    SMFUCBCH,ALLBITS-X80-X40  MASK OFF BITS 0 AND 1   YM6805 69610002
         TM    UCBTYP+K1,X'08'          MSS VOLUME?            @ZA15962 69615037
         BZ    CCM02900                 NO, BRANCH             @ZA15962 69616037
         OI    SMFUCBCH,X'80'           SET MSS VOLUME BIT     @ZA15962 69617037
CCM02900 MVC   SMFUCBTY,UCBTYP          UCBTYP FIELD           @ZA15962 69618037
         MVC   SMFSRTEV,UCBVOLI         UCBVOLI FIELD            YM6805 69620002
         MVC   SMFSRTES,UCBSTAB         UCBSTAB FIELD            YM6805 69625002
CCM03000 EQU   *                        GET NBR OF UCB ENTRIES   YM6805 69635002
         XR    RC,RC                    CLEAR REGISTER FOR IC    YM6805 69640002
         USING TCTUCBP,RF                                        Y02144 69641002
         IC    RC,TCTSCTR               SET LOOP CONTROL - GET   YM6805X69645002
                                        NO. OF UCB ENTRIES       YM6805 69650002
         LR    RD,RF                    WORKING PTR TO TCTUCBP'S YM6805 69655002
         TM    TCTFLGS,TCTVAMDS         TEST FOR VAM DATA SET   ZA00822 69657002
         BO    CCM03206                 BRANCH IF VAM NOT ISAM  ZA00822 69659002
*                                                                       69660002
CCM03100 CLM   RUCB,3,TCTUCBP-TCTUCBP(RD)  TEST FOR CORRECT UCB Z30AAJCX69665003
                                        ENTRY IN TCTTIOT         YM6805 69670002
         BE    CCM03200                 BRANCH IF CORRECT UCB    YM6805 69675002
         LA    RD,TCTDCTR+L'TCTDCTR-TCTUCBP(RD)  INCR INDEX      YM6805 69680002
         BCT   RC,CCM03100              TEST FOR LAST ENTRY      YM6805 69685002
         TM    DCBMACRF,DCBMEXCP        EXCP DCB                 YM6805 69690002
         BO    CCM03300                 YES, BRANCH              YM6805 69695002
         TM    DCBDSORG,DCBORGIS        ISAM DCB                 YM6805 69700002
         BZ    CCM03300                 NO, BRANCH               YM6805 69705002
         IC    RC,DXXCTL                GET ADDITIONAL DD CNT    YM6805 69710002
         LTR   RC,RC                    ANY MORE DD CARDS        YM6805 69715002
         BZ    CCM03300                 NO, BRANCH               YM6805 69720002
         BCTR  RC,0                     DECREMENT                YM6805 69725002
         STC   RC,DXXCTL                STORE BACK               YM6805 69730002
         ST    RET,SMF14NTA             SAVE RETURN ADDRESS      YM6805 69735002
         BAL   RET,CCM05500             GET NEXT TCT DD ENTRY    YM6805 69740002
         L     RET,SMF14NTA             RESTORE RETURN ADDR      YM6805 69745002
         B     CCM03000                 GO CHECK THIS TCT DD     YM6805X69750002
                                        ENTRY FOR UNIT           YM6805 69755002
*                                                                       69760002
CCM03200 EQU   *                        SAVE OVFLOW UNIT USED    YM6805 69765002
         TM    DCBMACRF,DCBMEXCP        EXCP DCB                 YM6805 69770002
         BO    CCM03206                 YES, BRANCH              YM6805 69775002
         TM    DCBDSORG,DCBORGIS        ISAM DCB                 YM6805 69780002
         BZ    CCM03206                 NO, BRANCH               YM6805 69785002
         CLM   RUCB,3,DXXCTL+K6         SAME AS OVFLOW UNIT     Z30AAJC 69790003
         BNE   CCM03203                 NO, BRANCH               YM6805 69795002
         STCM  RUCB,3,DXXCTL+K4         SAVE OVFLOW UNIT USED   Z30AAJC 69800003
CCM03203 EQU   *                        TEST IF ALREADY USED     YM6805 69805002
         CLM   RUCB,3,DXXCTL+K2         THIS UNIT ALREADY USED  Z30AAJC 69810003
         BE    CCM03300                 YES, BRANCH              YM6805 69815002
CCM03206 EQU   *                        MOVE IN EXCP COUNT       YM6805 69820002
         MVC   SMFEXCP,TCTDCTR-TCTUCBP(RD)  EXCP COUNT           YM6805 69825002
*                                                                       69830002
CCM03300 XR    RC,RC                    ZERO COUNT               YM6805 69835002
         XR    RD,RD                    CLEAR REGISTER           YM6805 69840002
CCM03400 AH    RC,DEBNMTRK              ADD SPACE FOR EACH       YM6805X69845002
                                        EXTENT (NO. OF TRACKS)   YM6805 69850002
         LA    RD,K1(,RD)               INCREMENT EXTENT COUNT   YM6805 69855002
         BCT   R8,CCM03500              BRANCH IF MORE EXTENTS   YM6805 69860002
         B     CCM03600                 BRANCH IF NO MORE        YM6805 69865002
CCM03500 CLC   DEBUCBAD+K1(K3),DEBUCBAD+K17  IS NEXT EXTENT ON   YM6805X69870002
                                        SAME UNIT AS THIS        YM6805 69875002
         LA    R1,K16(,R1)              INCREMENT TO NEXT EXTENT YM6805 69880002
         BE    CCM03400                 BRANCH IF SAME UCB       YM6805 69885002
CCM03600 ST    RC,SMF14NTA              NUMBER OF TRACKS         YM6805 69890002
         STC   RD,SMF14NEX              NUMBER OF EXTENTS        YM6805 69895002
         LA    R9,SMF14NTA+L'SMF14NTA-SMF14UCB(R9)  INCREMENT    YM6805X69900002
                                        BASE TO UCB SEGMENT      YM6805 69905002
         LTR   R8,R8                    TEST FOR MORE EXTENTS    YM6805 69915002
         BNZ   CCM02800                 BRANCH IF MORE EXTENTS   YM6805 69920002
         LA    R1,K16(,R1)              INCREMENT TO NEXT EXTENT YM6805 69925002
         BR    RET                      RETURN TO CALLER         YM6805 69930002
         DROP  R1                       DROP BASE TO DEB EXTENT  YM6805 69935002
         DROP  RF                       DROP BASE TO TCTUCBP     YM6805 69940002
         EJECT                                                   YM6805 69945002
**********************************************************************  70000021
*                                                                    *  70200021
*              CONSTANTS                                             *  70400021
*                                                                    *  70600021
**********************************************************************  70800021
         SPACE 1                                                        71000021
XTNTSIZE DC    H'16'                    DEB EXTENT LENGTH        M1771  71050021
EOVSVC   DC    C'55'                    SVC CODE FOR EOV                71200021
SYSDS2I  DC    C'SYS'                   SYSTEM GENERATED NAME   SA60779 71210002
SYSTME2I DC    C'.T'                    SYSTEM GENERATED TIME   SA60779 71220002
RECCORID DC    C'RR0A'                  RECOVERY CORE ID         YM4614 71230002
         SPACE 1                                                 YM6805 71240002
         XCTLTABL ID=(FINALMOD,2J,RECMOD,IFG0RR0B),              YM4614*71550002
               SVC=020,BRT=YES,LENGTH=                           YM4614 71560002
         IECDSECS CVT,TCB,TIOT,SMF,SMFRCD,SMFTCT,JMR,DCB,DEB,UCB,WTG,  *71600021
               MAIN,PREFX,RRPL,EXPAND=YES                        Y02144 71800002
         IECEQU                                                         72000021
         END                                                            72200021
