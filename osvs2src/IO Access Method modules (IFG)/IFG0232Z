         TITLE 'IFG0232Z - TCLOSE FINAL PROCESSING'                     00100002
IFG0232Z CSECT                                                          00400002
         ENTRY IFG0202U                                          Y02080 00450002
IFG0202U EQU   IFG0232Z                 ALIAS ENTRY POINT        Y02080 00460002
*                                                                       00500021
*********************************************************************** 00600021
*                                                                     * 00700021
*          VS2 RELEASE 03 DELETIONS/CHANGES                           * 00750000
*0000                                                          @ZA03180 00752000
*          VS1 RELEASE 02 DELETIONS/CHANGES                           * 00760002
*0000483790-483798                                               XM1037 00762002
*0000427000,484000-485000,575000,586000                          X02989 00770002
*                                                                     * 00800021
*          VS2 RELEASE 02 DELETIONS/CHANGES                           * 00900002
*0000450000-452000                                               Y02080 00901002
*0000077000,173000,192000-193000,267000-268000,575000-575620,    YM1272 00902002
*0000580000                                                      YM1272 00903002
*          RELEASE 22 DELETIONS/CHANGES                               * 01200021
*          RELEASE 21 DELETIONS/CHANGES                               * 01300021
*0000                                                            A38013 01320021
*                                                                M0039  01350021
*0000024000,030000,033000-036000,037000,490000-495000            A35953 01370021
*D485120-485280,486000                                          SA48558 01380021
*D445000                                                         S21940 01390021
*                                                                     * 01400021
* MODULE NAME - IFG0232Z                                              * 01410002
*                                                                     * 01420002
* DESCRIPTIVE NAME - TCLOSE FINAL PROCESSING                          * 01430002
*                                                                     * 01440002
* COPYRIGHT - NONE                                                    * 01450002
*                                                                     * 01460002
* CHANGE ACTIVITY - SEE DELETIONS/CHANGES FOLLOWING THE CSECT CARD.   * 01470002
*                                                                     * 01480002
* STATUS CHANGE LEVEL 000                                             * 01500021
*                                                                     * 01600021
* FUNCTION -                                                          * 01700021
*    THIS MODULE CONTAINS THE FOLLOWING FUNCTIONS -                   * 01800021
*       1. TCLOSE DIRECT ACCESS OUTPUT FUNCTION, PART II;             * 01900021
*       2. TCLOSE FINAL FUNCTION                                      * 02000021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOGS' FOR DETAILS.           * 02100021
*                                                                     * 02200021
* ENTRY POINTS -                                                      * 02300021
*         IFG0232Z - REFER TO 'INPUT' FOR A LIST OF CALLING MODULES   * 02360021
*                    AND THEIR RESPECTIVE ENTRY CONDITIONS.           * 02420021
*                                                                     * 02500021
* INPUT -                                                             * 02600021
*    ENTERED IN DATA MANAGEMENT KEY                              Y02082 02650002
*    REGISTER 14 ('RET') WILL CONTAIN ONE OF THE BRANCH TABLE OFFSETS * 02700021
*    LISTED BELOW, THE BRANCH TABLE BEING USED TO DETERMINE AT        * 02800021
*    WHICH POINT PROCESSING IS TO BEGIN-                              * 02900021
*       0 - ENTRY FROM EITHER IFG0232D OR IFG0232J TO WRITE A FILE    * 02950021
*           MARK TO DELIMIT AN OUTPUT DATA SET ON A DIRECT ACCESS     * 03000021
*           DEVICE.                                                   * 03050021
*       4 - ENTRY FROM ANY OF THE FOLLOWING MODULES TO PERFORM        * 03100021
*           TCLOSE FINAL PROCESSING-                                  * 03200021
*           IGC0002C                                                  * 03270021
*           IFG0232D                                                  * 03340021
*           IFG0232J                                                  * 03410021
*           IFG0232S                                                  * 03480021
*           IFG0232Y (AN ALIAS FOR IFG0202B, THE CLOSE/TCLOSE NSL     * 03550021
*                    INTERFACE FUNCTION)                              * 03620021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOGS' FOR ADDITIONAL INPUTS. * 03900021
*                                                                     * 04000021
* OUTPUT -                                                            * 04100021
*    EXIT IN DATA MANAGEMENT KEY                                 Y02082 04150002
*    REFER TO THE FOLLOWING 'FUNCTION PROLOGS'.                       * 04200021
*                                                                     * 04300021
* EXTERNAL REFERENCES -                                               * 04400021
*         IFG019RA - OPEN/CLOSE/EOV RESIDENT ROUTINE FOR XCTL, WAIT,  * 04500002
*                    AND SYNCH. REFER TO THE FOLLOWING 'FUNCTION      * 04600021
*                    PROLOGS'.                                        * 04700021
*                                                                     * 04800021
* EXITS, NORMAL -                                                     * 04900021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOGS'.                       * 05000021
*                                                                     * 05100021
* EXITS, ERROR -                                                      * 05200021
*         IFG0230P - WHEN AN ERROR CONDITION OCCURS IN THIS MODULE.   * 05300021
*                    REFER TO THE FOLLOWING 'FUNCTION PROLOGS'.       * 05400021
*                                                                     * 05500021
* TABLES/WORK AREAS -                                                 * 05600021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOGS'.                       * 05700021
*                                                                     * 05800021
* ATTRIBUTES -                                                        * 05900021
*    REENTRANT, REFRESHABLE, READ-ONLY, ENABLED, PRIVILEGED           * 06000021
*                                                                     * 06100021
* CHARACTER CODE DEPENDENCY -                                         * 06200021
*    CLASS ONE CHARACTER CODE DEPENDENCY - THE EBCDIC CHARACTER CODE  * 06300021
*    WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED IF A      * 06400021
*    DIFFERENT CHARACTER SET IS USED FOR EXECUTION.                   * 06500021
*                                                                     * 06600021
* NOTES -                                                             * 06700021
*    THIS MODULE HAS AN ALIAS NAME OF IFG0202U.                       * 06750021
*    REFER TO THE FOLLOWING 'FUNCTION PROLOGS'.                       * 06800021
*                                                                     * 06900021
*********************************************************************** 07000021
*                                                                       07100021
         BALR  RBASE,0                  ESTABLISH ADDRESSABILITY        07200021
         USING *,RBASE                                                  07300021
         USING FORCORE,RCORE                                            07400021
         USING CVT,RET                                                  07500021
         USING IHADCB,RDCB                                              07600002
         USING DEBBASIC,RDEB            ADDRESSABILITY TO DEB    YM1272 07700002
         USING TIOT,RTIOT                                               07800021
         USING WTG,RWTG                                                 07900021
         USING UCB,RUCB                                                 08000021
*                                                                       08100021
         B     BRTABLE5(RET)            DETERMINE TYPE OF ENTRY TO RTN  08200021
BRTABLE5 EQU   *                                                        08300021
         B     TCD01700             (0) BR TO FINISH DA PROCESSING      08400021
         B     TCM50000             (4) BR TO PERFORM TCLOSE CLEANUP    08500021
*********************************************************************** 08900021
*                                                                     * 09000021
*                          FUNCTION PROLOG                            * 09100021
*                                                                     * 09200021
*********************************************************************** 09300021
*                                                                     * 09400021
* FUNCTION - 'TCLOSE DIRECT ACCESS OUTPUT FUNCTION', PART II          * 09500021
*                                                                     * 09600021
* (STATUS) -                                                          * 09700021
*    NOT APPLICABLE                                                   * 09800021
*                                                                     * 09900021
* FUNCTION -                                                          * 10000021
*    1.  WRITE FILE MARK FOLLOWING USER'S DATA;                       * 10100002
*    2.  POSITION THE VOLUME, EITHER BEFORE THE FIRST RECORD          * 10200021
*        (REREAD), OR AFTER THE LAST RECORD (LEAVE).                  * 10300021
*                                                                     * 10400021
* ENTRY POINTS -                                                      * 10500021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 10600002
*                                                                     * 10700021
* INPUT -                                                             * 10800021
*    1. REGISTER CONTENTS AT ENTRY ARE AS FOLLOWS-                    * 10900021
*       'RDCB' - ADDRESS OF THE DCB BEING PROCESSED;                  * 11000021
*       'RCORE'- ADDRESS OF THE WORK AREA FOR THAT DCB;               * 11100021
*       'RES'  - ADDRESS OF THE OPEN/CLOSE/EOV RESIDENT ROUTINE;      * 11200021
*       'RWTG' - ADDRESS OF THE WHERE-TO-GO TABLE;                    * 11300021
*       'RPARC'- ADDRESS OF THE CURRENT TCLOSE PARAMETER LIST ENTRY;  * 11400021
*       'RWTGC'- ADDRESS OF THE CURRENT WHERE-TO-GO TABLE ENTRY;      * 11500021
*       'RTIOT'- ADDRESS OF THE CURRENT TIOT ENTRY FOR THE DCB;       * 11600021
*       'RUCB' - ADDRESS OF THE CURRENT UCB FOR THE DCB;              * 11700021
*       'RDEB' - ADDRESS OF THE DCB'S DEB;                            * 11800021
*                                                                     * 11900021
* OUTPUT -                                                            * 12000021
*    1. AT EXIT TO THE TCLOSE FINAL FUNCTION, OUTPUT IS VIRTUALLY THE * 12100021
*       SAME AS AT INPUT TO THIS FUNCTION;                            * 12200021
*    2. AT EXIT TO PROBLEM DETERMINATION MODULE IFG0230P-             * 12300021
*       REGISTER CONTENTS ARE THE SAME AS AT ENTRY EXCEPT THAT        * 12400021
*          REGISTER 'R0' CONTAINS THE INTERNAL ERROR CODE;            * 12500002
*       WORK AREA INDICATORS-                                         * 12600021
*          'DXCALLID' - CONTAINS THE ID OF THIS MODULE.               * 12700021
*                                                                     * 12800021
* EXTERNAL REFERENCES -                                               * 12900021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 13000002
*                                                                     * 13100021
* EXITS, NORMAL -                                                     * 13200021
*    1. TO PART II OF THIS MODULE- THE 'TCLOSE FINAL FUNCTION'.       * 13300021
*                                                                     * 13400021
* EXITS, ERROR -                                                      * 13500021
*    EXIT TO IFG0230P WITH ONE OF THE FOLLOWING INTERNAL ABEND CODES: * 13550002
*        131 (117/04)- ERROR WRITING FILE MARK;                       * 13600002
*        233 (117/34)- M IN DCBFDAD REFERENCES A NONEXISTENT EXTENT   * 13650002
*            IN DEB.                                                  * 13670002
*                                                                     * 13700021
* TABLES/WORK AREAS -                                                 * 13800021
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 13900021
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 14000021
*                                                                     * 14100021
* ATTRIBUTES -                                                        * 14200021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 14300002
*                                                                     * 14400021
* CHARACTER CODE DEPENDENCY -                                         * 14500021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 14600002
*                                                                     * 14700021
* NOTES -                                                             * 14800021
*                                                                     * 14900021
*********************************************************************** 15000021
*                                                                       15100021
TCD01700 EQU   *                                                        15200021
         L     RDEB,DCBDEBAD            RESTORE USER'S DEB ADDR         15300021
*                                                                       15400021
*****    WRITE FILE MARK FOLLOWING USER'S DATA RECORDS                  15500021
*                                                                       15600021
         SR    RC,RC                    CLEAR WORK REGISTER             15700021
         IC    RC,DCBFDAD               PICK UP M (CURRENT EXTENT NUMBE 15800021
         CLM   RC,B'0001',DEBNMEXT      ARE THERE M EXTENTS      Y02082 15850002
*                                       IN THE DEB               Y02082 15860002
         BL    TCD01710                 BRANCH IF YES-CONTINUE   Y02082 15890002
         LA    RC,TCABD117              LOAD INTERNAL ABCODE     Y02082 15890402
         B     TCD03100                 ABEND                    Y02082 15892002
TCABD117 EQU   233                      INVALID DCBFDAD INTERNAL Y02082 15892402
*                                       ABEND CODE               Y02082 15892802
TCD01710 EQU   *                        SET UP ABEND CODE        Y02082 15894002
         SLL   RC,K4                    MULTIPLY BY 16 TO POINT TO EXTE 15900021
         LR    RD,RDEB                  SAVE DEB ADDRESS                16000021
         LA    RDEB,DEBBASND            POINT TO END OF BASIC    YM1272 16020002
*                                       SECTION OF THE DEB       YM1272 16040002
         USING DEBDASD,RDEB             ADDRESSABILITY TO DIRECT YM1272 16060002
*                                       ACCESS SECTION OF DEB    YM1272 16080002
         AR    RDEB,RC                  NOW POINTING TO PROPER EXTENT   16100021
         MVC   DXDEBBIN(K12),DEBBINUM   PLACE USER'S EXTENT IN WORK ARE 16200021
         DROP  RDEB                                              YM1272 16250002
         MVC   DXCCW4+K1(K8),DCBFDAD    MOVE MBBCCHHR TO WORK AREA      16300021
         MVI   DXDEBUCB,X'C0'           SET MODIFIER BYTE TO ALLOW WRIT 16400021
         L     R1,DCBDVTBL              ADDRESS OF DEVICE TABLE         16500021
         LH    RF,K4(R1)                PICK UP NR OF BYTES PER TRACK   16600021
         CH    RF,DCBTRBAL              IS FULL TRCK AVAILABLE FOR FM   16700021
         BE    TCD02300                 BR IF FULL TRCK AVAILABLE       16800021
         TM    DCBRECFM,DCBRECFX+DCBRECST IS THE USER WRITING F STD     16900021
         BNO   TCD01800                 NO,DO NOT WRITE F.M. ON THIS    17000021
*                                       TRACK                           17100021
         SR    RC,RC                    INITIALIZE REGISTER             17200021
         IC    RC,DEBNMEXT-DEBBASIC(,RD)  PICK UP NBR OF EXTENTS YM1272 17300002
         SLL   RC,K4                    MULTIPLY BY 16                  17400021
         AR    RC,RD                    ADD DEB ADDRESS                 17500021
         LH    RF,K44(RC)               ADD KEYLENGTH+BLOCKSIZE         17600021
         CH    RF,DCBTRBAL              WILL A RECORD FIT ON THIS TRACK 17700021
         BH    TCD01800                 NO,DO NOT ATTEMPT WRITE THIS TR 17800021
         BAL   RD,TCD02900              YES,GO SET UP CHANNEL PROGRAM   17900021
         IC    RF,DXCCW4+K8             ADD 1 TO LAST RECORD NUMBER     18000021
         LA    RF,K1(,RF)               WRITTEN BY THE PROBLEM PROGRAM  18100021
         STC   RF,DXDSCB+K4             STORE UPDATED RECORD NUMBER     18200021
         BAL   RD,TCD03000              GO TO WRITE THE FILE MARK       18300021
         OI    DXATDACC,DXATEOF         EOF MARK WRITTEN         Y02144 18350002
TCD01800 EQU   *                                                        18400021
         STM   RWTGC,RDEB,DXCCW5+K4     SAVE VOLATILE REGS              18500021
         LR    RWTGC,RDCB               ESTABLISH DCB BASE              18600021
         DROP  RDCB                                                     18700021
         USING IHADCB,RWTGC                                             18800021
         LA    RDCB,DXCCW4+K1           ADDR OF MBBCCHHR WORK           18900021
*                                       AREA FOR CONVERT RTNS           19000021
         L     R1,DCBDEBAD              ESTABLISH DEB BASE              19100021
         USING DEBBASIC,R1              ADDRESSABILITY TO DEB    YM1272 19300002
         L     RF,CVTPTR                                                19400021
         L     RF,CVTPRLTV-CVT(RF)      MBBCCHHR TO TTR ADDRESS         19500021
         BALR  RET,RF                   TTR0 IN REG 0                   19600021
         AL    R0,CON10000              BUMP IT BY ONE                  19700021
         ST    R0,DXCCW7+K4             SAVE TT+1,R                     19800021
         L     RF,CVTPTR                                                19900021
         L     RF,CVTPCNVT-CVT(RF)      TTR TO MBBCCHHR ADDRESS         20000021
         BALR  RET,RF                   MBBCCHHR IN DXCCW4+1            20100021
         LTR   RF,RF                    IS ANOTHER TRK AVAILABLE        20200021
         LA    RF,TCD02500              BRANCH IF NO - DO NOT           20300021
         BNZ   TCD02200                 WRITE FILE MARK                 20400021
         CLI   DXCCW4+K1,K0             IS EXTENT NUMBER 0              20500021
*                                       SPLIT ALLOCATION ALLOWED        20600021
*                                       ON FIRST EXTENT ONLY            20700021
         BE    TCD01900                 YES - GO CHECK IF SPLIT         20800021
         SR    RF,RF                    CLEAR WORK REGISTER             20900021
         IC    RF,DXCCW4+K1             PICK UP CURRENT EXT NBR         21000021
         CLM   RF,B'0001',DEBNMEXT      ARE THERE M EXTENTS      Y02082 21010002
*                                       IN THE DEB               Y02082 21020002
         BL    TCD01850                 BRANCH IF YES,CONTINUE   Y02082 21030002
         LA    RC,TCABD117              BAD FDAD INTERNAL ABCODE Y02082 21040002
         LA    RF,TCD03100              ABEND-INVALID FDAD       Y02082 21050002
         B     TCD02200                 BRANCH TO RESTORE REGS   Y02082 21060002
*                                                                Y02082 21070002
TCD01850 EQU   *                        CALCULATE EXTENT ADDRESS Y02082 21080002
         SLL   RF,K4                    MULTIPLY BY 16                  21100021
         AR    RF,R1                    ADD DEB ADDRESS                 21200021
         MVC   DXDEBUCB+K1(K15),K33(RF)    PUT USER EXTENT IN WORK AREA 21300021
         B     TCD02100                 GO WRITE FILE MARK              21400021
TCD01900 EQU   *                                                        21500021
         TM    DEBOFLGS,DEBOFSPL        ARE THERE SPLIT CYLINDER        21600021
         BNO   TCD02100                 BR IF NO SPLIT CYLINDERS        21700021
         SR    RC,RC                    START H                         21800021
         SR    RD,RD                    END H                           21900021
         SR    RF,RF                    NEW H IN FDAD                   22000021
         SR    RUCB,RUCB                EXTENT OFFSET                   22100021
         IC    RUCB,DXCCW4+K1           GET NEW M                       22200021
         SLL   RUCB,K4                  TIMES 16 FOR INDEXING           22300021
         IC    RF,DXCCW4+K7             SECOND H OF NEW HH              22400021
         LA    R1,DEBBASND              POINT TO END OF BASIC    YM1272 22420002
*                                       SECTION OF THE DEB       YM1272 22440002
         USING DEBDASD,R1               ADDRESSABILITY TO DIRECT YM1272 22460002
*                                       ACCESS SECTION OF DEB    YM1272 22480002
         IC    RC,DEBSTRHH+K1(RUCB)     START H                         22500021
         IC    RD,DEBENDHH+K1(RUCB)     END H                           22600021
         DROP  R1                                                YM1272 22650002
*                                                                       22700021
*****    TEST IF CURRENT ADDRESS WITHIN SPLIT                           22800021
*                                                                       22900021
         CR    RF,RC                    IS NEW H BELOW START H          23000021
         BL    TCD02000                 BRANCH IF YES - NEED TO         23100021
*                                       GET NEW MBBCCHHR                23200021
         CR    RF,RD                    IS NEW H ABOVE END H            23300021
         BNH   TCD02100                 BR IF NO -  H IS GOOD           23400021
*                                                                       23500021
*****    NEW H OUTSIDE DEB EXTENTS - NEED TO GET NEW MBBCCHHR           23600021
*                                                                       23700021
TCD02000 EQU   *                                                        23800021
         SR    RD,RC                    NO OF TRACKS -1 IN SPLIT        23900021
         L     RUCB,DCBDVTBL            ADDR OF DEVICE TABLE            24000021
         USING UNITABLE,RUCB                                            24100021
         IC    RC,UNITSIHH+K1           GET NO. OF TRACKS               24200021
         DROP  RUCB                                                     24300021
         SR    RC,RD                    SUBTRACT NO TRACKS IN           24400021
*                                     SPLIT - 1 FROM NO OF              24500021
*                                       TRACKS IN CYLINDER              24600021
         BCTR  RC,0                     SUBTRACT ONE MORE - THIS        24700021
*                                       IS CORRECT TRACK                24800021
*                                       DISPLACEMENT TO ADD             24900021
*                                       TO OLD TT+1,R                   25000021
         SLL   RC,K16                   SHIFT TO ADD                    25100021
         AL    RC,DXCCW7+K4             ADD TT+1,R                      25200021
         LR    R0,RC                    PUT IN RE FOR CONVERSION        25300021
         L     RF,CVTPTR                                                25400021
         L     RF,CVTPCNVT-CVT(RF)      TTR TO MBBCCHHR ADDR            25500021
         BALR  RET,RF                   MBBCCHHR IN DXCCW4+1            25600021
         LTR   RF,RF                    NEW TRACK AVAILABLE             25700021
         LA    RF,TCD02500                                              25800021
         BNZ   TCD02200                 BR IF NO - NO FILE MARK         25900021
TCD02100 EQU   *                                                        26000021
         LA    RF,TCD02400              WRITE FILE MARK                 26100021
TCD02200 EQU   *                                                        26200021
         LR    RDCB,RWTGC               RESTORE DCB BASE                26300021
         DROP  RWTGC                                                    26400021
         USING IHADCB,RDCB                                              26500021
         LM    RWTGC,RDEB,DXCCW5+K4     RESTORE VOLATILE REGS           26600021
         USING DEBDASD,RDEB             ADDRESSABILITY TO DIRECT YM1272 26800002
*                                       ACCESS SECTION OF DEB    YM1272 26850002
         MVI   DXCCW4+K8,K0             ZERO R TO SEARCH ON TO          26900021
*                                       WRITE ON NEW TRACK              27000021
         BR    RF                       RETURN                          27100021
TCD02300 EQU   *                                                        27200021
         CLC   DXCCW4+K4(K4),DEBENDCC   IS CCHH IN THIS EXTENT          27300021
         BH    TCD01800                 NO,GO SEE IF ANOTHER            27400021
*                                       EXTENT                          27500021
TCD02400 EQU   *                                                        27600021
         BAL   RD,TCD02900              YES,GO TO SET UP CHANNEL PROG   27700021
         MVI   DXDSCB+K4,K1             SET RECORD NUMBER OF FILE MARK  27800021
         BAL   RD,TCD03000              GO TO WRITE THE FILE MARK       27900021
         OI    DXATDACC,DXATEOF         EOF MARK WRITTEN         Y02144 27950002
*                                                                       28000021
*****    SET CURRENT POSITION POINTER IN THE DCB                        28100021
*                                                                       28200021
TCD02500 EQU   *                                                        28300021
         USING DEBBASIC,RDEB            ADDRESSABILITY TO DEB    YM1272 28350002
         L     RDEB,DCBDEBAD            RESTORE ADDRESS OF USER'S DEB   28400021
         TM    PLISTOPT(RPARC),PLISTLV  IS DISPOSITION 'LEAVE'-         28500021
         BNM   TCD02600                 ..BR IF YES- DCBFDAD IS CORRECT 28600021
         LA    RD,DEBBASND              POINT TO END OF BASIC    YM1272 28620002
*                                       SECTION OF THE DEB       YM1272 28640002
         USING DEBDASD,RD               ADDRESSABILITY TO DIRECT YM1272 28660002
*                                       ACCESS SECTION OF DEB    YM1272 28680002
         MVC   DCBFDAD+K1(K6),DEBBINUM  SET BBCCHH TO BEGINNING OF EXTE 28700021
         DROP  RD                                                YM1272 28750002
         MVI   DCBFDAD,K0               SET M EQUAL TO ZERO             28800021
         MVI   DCBFDAD+K7,K0            SET RECORD NUMBER TO ZERO       28900021
         L     RC,DCBDVTBL              PICK UP BASE OF DEVICE TABLE    29000021
         MVC   DCBTRBAL,K4(RC)          SET NUM OF BYTES REMAING TO MAX 29100021
*                                                                       29200021
*****    UPDATE FULL DISK ADDRESS IN BSAM IOB                           29300021
*                                                                       29400021
TCD02600 EQU   *                                                        29500021
         L     RD,DCBIOBA               PICK UP ADDRESS OF PREVIOUS IOB 29600021
         LA    RD,K0(,RD)               CLEAR HIGH BYTE (FOR COMPARE)   29700021
         LR    R0,RD                                                    29800021
         SR    RC,RC                                                    29900021
         LR    R1,RD                    COPY ICB/IOB ADDRESS            30000021
         TM    DCBCIND2,DCBC2CHN        IS PCI USED                     30100021
         BO    TCD02700                 YES  BRANCH                     30200021
         LA    R1,K8(RD)                ADJUST IOB FOR NORMAL SCHED.    30300021
         LA    RC,K8                                                    30400021
TCD02700 EQU   *                                                        30500021
         MODESET KEYADDR=DXUKEY,WORKREG=14 ICB/IOB KEY           Y02082 30550002
         MVC   K32(K8,R1),DCBFDAD       UPDATE 1ST ICB/IOB              30600021
TCD02800 EQU   *                                                        30700021
         L     RD,K0(,RD)               ADDRESS OF NEXT IOB IN CHAIN    30800021
         LA    RD,K0(,RD)               CLEAR HI BYTE                   30900021
         LA    R1,K0(RC,RD)             FORM THE IOB OR ICB ADDRESS     31000021
         MVC   K32(K8,R1),DCBFDAD       UPDATE IOB/ICB  FDAD            31100021
         CR    RD,R0                    IS THIS LAST IOB IN CHAIN       31200021
         BNE   TCD02800                 ..BRANCH IF NOT                 31300021
*                                       ..ELSE DROP THROUGH TO TCLOSE   31400021
*                                       ..FINAL FUNCTION                31500021
         MODESET EXTKEY=DATAMGT         TCLOSE WORK AREA KEY     Y02082 31550002
         TITLE 'IFG0232Z - TCLOSE FINAL FUNCTION'                       31600021
*********************************************************************** 31700021
*                                                                     * 31800021
*                          FUNCTION PROLOG                            * 31900021
*                                                                     * 32000021
*********************************************************************** 32100021
*                                                                     * 32200021
* FUNCTION NAME - 'TCLOSE FINAL FUNCTION'                             * 32300021
*                                                                     * 32400021
* (STATUS) -                                                          * 32500021
*    NOT APPLICABLE                                                   * 32600021
*                                                                     * 32700021
* FUNCTION -                                                          * 32800021
*    1. SYNCHRONIZE PROCESSING OF ALL DATA CONTROL BLOCKS TO THE      * 32900021
*       BEGINNING OF THIS FUNCTION;                                   * 33000021
*    2. ISSUE A 'DELAYED ABEND' UTILIZING THE ABEND CODE PROVIDED     * 33100021
*       BY THE PROBLEM DETERMINATION ROUTINE IF THAT WAS REQUESTED    * 33200021
*       BY THE USER IN HIS ABEND EXIT ROUTINE;                        * 33300021
*       RESET DEBDCBAD TO POINT TO THE CALLER'S DCB.             Y02082 33301002
*    3. TERMINATE THE OPTIONAL TRACE FACILITY (GTF) IF IT IS ACTIVE;  * 33400021
*    4. RESET VARIOUS DATA SET STATUS INDICATORS IN THE DCB AND DEB   * 33700002
*       IN ORDER THAT PROCESSING MAY CONTINUE.                        * 33800021
*    5. RELEASE THE WHERE-TO-GO (WTG) TABLE MAIN STORAGE WORK AREA    * 33900002
*       AND THE TCLOSE WORK AREA FOR EACH DCB. THIS IS DONE VIA THE   * 33950002
*       RESIDENT ROUTINE WHICH ALSO DEQ'S THE TIOT.                   * 33960002
*    6. RETURN TO THE USER.                                           * 34000002
*                                                                     * 34100021
* ENTRY POINTS -                                                      * 34200021
*    REFER TO THE PRECEDING 'MODULE PROLOG'.                          * 34300002
*                                                                     * 34400021
* INPUT -                                                             * 34500021
*    1. REGISTER CONTENTS AT ENTRY ARE AS FOLLOWS-                    * 34600021
*       'RDCB' - ADDRESS OF THE DCB BEING PROCESSED;                  * 34700021
*       'RCORE'- ADDRESS OF THE WORK AREA FOR THAT DCB;               * 34800021
*       'RES'  - ADDRESS OF THE OPEN/CLOSE/EOV RESIDENT ROUTINE;      * 34900021
*       'RWTG' - ADDRESS OF THE WHERE-TO-GO TABLE;                    * 35000021
*       'RPARC'- ADDRESS OF THE CURRENT TCLOSE PARAMETER LIST ENTRY;  * 35100021
*       'RWTGC'- ADDRESS OF THE CURRENT WHERE-TO-GO TABLE ENTRY;      * 35200021
*       'RTIOT'- ADDRESS OF THE CURRENT TIOT ENTRY FOR THE DCB;       * 35300021
*       'RUCB' - ADDRESS OF THE CURRENT UCB FOR THE DCB;              * 35400021
*       'RDEB' - ADDRESS OF THE DCB'S DEB;                            * 35500021
*    2. WORK AREA CONTENTS ARE AS FOLLOWS-                            * 35600021
*       'WTGPATHS+1' X'80' - THE OPTIONAL TRACE FACILTY IS ACTIVE     * 35700021
*                            AND SHOULD BE TERMINATED PRIOR TO EXIT;  * 35800021
*       'DCBOFLGS' - X'01', OFF - THE COMBINATION OF THESE TWO CONDI- * 35900021
*       'JFCBMASK+4' - X'02'    - TIONS INDICATES THAT A DELAYED      * 36000021
*                                 ABEND HAS BEEN REQUESTED, IN WHICH  * 36100021
*                                 CASE THE FOLLOWING ADDITIONAL       * 36200021
*                                 INPUT APPLIES-                      * 36300021
*       'DXRETCOD' - CONTAINS THE TCLOSE INTERNAL ERROR CODE;         * 36400021
*       'DXABCODE-1' - CONTAINS THE SYSTEM ABEND CODE.                * 36500021
*       'DXCCW1'   - X'FF' - INDICATES THAT PROCESSING WAS TERMINATED * 36550021
*                            ON THE CORRESPONDING DCB. DO NOT RESET   * 36560021
*                            ANY PROCESSING INDICATORS OTHER THAN     * 36570021
*                            'DCBOBUSY' IN FIELD 'DCBOFLGS' (INDI-    * 36580021
*                            CATES THAT THE DCB IS BEING PROCESSED    * 36590021
*                            BY AN I/O SUPPORT FUNCTION).             * 36592021
*                                                                     * 36600021
* OUTPUT -                                                            * 36700021
*    1. AT EXIT TO THE USER-                                          * 36800021
*       REGISTER CONTENTS WILL BE THE SAME AS WHEN THE TCLOSE    X02989 37070002
*       MACRO WAS INVOKED BY THE USER EXCEPT FOR REGISTER 15.    X02989 37080002
*         RETURN CODES IN REGISTER 15:                           X02989 37082002
*              0     ALL ENTRIES IN TCLOSE PARAMETER LIST        X02989 37084002
*                    HAVE COMPLETED TCLOSE SUCCESSFULLY.         X02989 37086002
*                                                                X02989 37088002
*              4     ONE OR MORE ENTRIES IN TCLOSE PARAMETER     X02989 37088402
*                    LIST HAVE FAILED TO COMPLETE TCLOSE         X02989 37088802
*                    SUCCESSFULLY.                               X02989 37089202
*       CONTROL BLOCK INDICATORS-                                     * 37100021
*          'DCBOFLGS' - X'C5', OFF - THE DCB RDBACK, EOF, OUTPUT, AND * 37200021
*                                    'BUSY' INDS WILL BE TURNED OFF;  * 37300021
*          'DEBOFLGS' - X'20', OFF - THE DEB 'EOF' IND IS TURNED OFF; * 37400021
*          IOB - ALL NECESSARY FLAGS ARE RESET TO CONTINUE PROCESSING.* 37500021
*                                                                     * 38800021
* EXTERNAL REFERENCES -                                               * 38900021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 39000002
*                                                                     * 39100021
* EXITS, NORMAL -                                                     * 39200021
*    RETURN TO THE USER UPON COMPLETION OF ALL TCLOSE PROCESSING.     * 39300002
*                                                                     * 39400002
* EXITS, ERROR -                                                      * 39600021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 39700002
*                                                                     * 39800021
* TABLES/WORK AREAS -                                                 * 39900021
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 40000021
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 40100021
*                                                                     * 40200021
* ATTRIBUTES -                                                        * 40300021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 40400002
*                                                                     * 40500021
* CHARACTER CODE DEPENDENCY -                                         * 40600021
*    REFER TO THE PRECEDING MODULE PROLOG.                            * 40700002
*                                                                     * 40800021
* NOTES -                                                             * 40900021
*                                                                     * 41000021
*********************************************************************** 41100021
*                                                                       41200021
TCM50000 EQU   *                                                        41300021
         IECRES SYNCHDCB                SYNCHRONIZE DCB PROCESSING     *41400002
                                        ..OF ALL DCBS TO THIS POINT     41500002
*                                                                       41510002
*********************************************************************** 41520002
*                                                                       41530002
*  CHECK IF ANY DCB WANTS TO BRANCH OUT OF THIS MODULE RATHER           41540002
*  THAN SYNCHDCB.  IF SO, BRANCH THE DCB OUT EXPLICITLY, SINCE          41550002
*  THE BRANCH WILL NOT BE DONE BY THE RESIDENT ROUTINE.  THIS           41560002
*  CHECK IS NEEDED ONLY AS LONG AS AN IECRES LOAD EXISTS IN THE         41570002
*  SAME LAST MODULE WHICH HAS AN IECRES SYNCHDCB.                       41580002
*                                                                       41590002
         L     RD,WTGPREFX              GET PTR TO WTG PREFIX    Y02080 41600002
         USING IECPREFX,RD                                       Y02080 41650002
         L     RD,IECUPRML              GET DCB PARM LIST ADDR   Y02080 41700002
         DROP  RD                                                Y02080 41750002
         LA    RF,WTGENTRY              ADDR OF FIRST WTG ENTRY         41800002
         SR    R0,R0                    CLEAR XCTL OUT DCB INDICATOR    41850002
         USING WTGENTRY,RF              DEFINE BASE TO WTG ENTRY        41900002
*                                                                       41950002
TCM50100 EQU   *                                                        42000002
         L     RC,WTGCORE-K1            LOAD MAIN WORK AREA ADDR        42050002
         LA    RC,0(RC)                 CLEAR HIGH ORDER BYTE           42100002
         LTR   RC,RC                    TEST IF DCB HAS WORK AREA       42150002
         BZ    TCM50300                 BR IF NO                        42200002
*                                                                       42250002
         CLC   WTGMODID,WTGIDTTR        IS WTG ENTRY ID CURRENT ID      42300002
         BNE   TCM50200                 BR IF NO, IS XCTL OUT DCB       42350002
         LA    RET,K4                   SET RET CODE TO RE-SYNCH ENTRY  42400002
         ST    RET,DXREGE-FORCORE(,RC)  STORE RET IN DCB REG SAVE AREA  42450002
         B     TCM50300                 BR TO INCR TO NEXT DCB IN LOOP  42500002
*                                                                       42550002
TCM50200 EQU   *                                                        42600002
         LR    R0,RD                    SAVE RPARC DCB PARM LIST ADDR   42650002
         LR    R1,RF                    SAVE RWTGC WTG ENTRY ADDR       42700002
*                                                                       42750002
TCM50300 EQU   *                                                        42800002
         TM    PLISTOPT(RD),LASTNTRY    CHECK FOR LAST DCB ENTRY        42850002
         LA    RD,K4(,RD)               ADVANCE TO NEXT DCB ENTRY       42900002
         LA    RF,WTGEND-WTGENTRY(,RF)  ADVANCE TO NEXT WTG ENTRY       42950002
         BNO   TCM50100                 BR TO PROCESS NEXT DCB          43000002
*                                                                       43050002
TCM50400 EQU   *                                                        43100002
         LTR   R0,R0                    DOES A DCB WANT TO XCTL OUT     43150002
         BZ    TCM50500                 BR IF NO                        43200002
*                                                                       43250002
         LR    RPARC,R0                 LOAD CURRENT RPARC ADDR         43300002
         LR    RWTGC,R1                 LOAD CURRENT RWTGC ADDR         43350002
         DROP  RF                       DROP OLD BASE TO WTG ENTRY      43400002
         USING WTGENTRY,RWTGC           DEFINE BASE TO WTG ENTRY        43450002
         L     RDCB,PLISTDCB(,RPARC)    LOAD CURRENT DCB ADDR           43500002
         L     RCORE,WTGCORE-K1         LOAD CURRENT WORK AREA ADDR     43550002
         LM    RTIOT,RET,DXREG9         LOAD REGS 9-14                  43600002
         LM    R0,R1,DXREG0             LOAD REGS 0-1                   43650002
*                                                                       43700002
         IECRES LOAD,MODID=(RWTGC),PREFIX=WTGPREFX,BRANCH=DIRECT Y02080 43750002
         DROP  RWTGC                                                    43910002
*                                                                       43920002
TCM50500 EQU   *                                                        43950002
*                                                                       43960002
*********************************************************************** 43970002
*                                                                       43980002
*****    TERMINATE THE TRACE FACILITY IF IT WAS ACTIVE                  44000021
*                                                                       44100021
         SR    RD,RD                    SET INTERNAL SW TO IND THAT THE 44200021
*                                       ..TRACE FACILITY IS NOT ACTIVE  44300021
         TM    WTGPATHS+K1,WTGTRACE     IS THE TRACE FACILITY ACTIVE-   44400021
         BNO   TCM52500                 ..BR IF NOT TO RELEASE   S21940 44500021
*                                       ..THE RES RTN WORK AREA  S21940 44550021
         LA    RD,K1                    SET INTERNAL SW TO IND THAT THE 44600021
*                                       ..TRACE FACILITY WAS ACTIVE     44700021
         NI    WTGPATHS+K1,X'FF'-WTGTRACE INDICATE THE THE TRACE        44800021
*                                       ..FACILITY IS TO BE TERMINATED  44900021
*                                                                       44910002
*********************************************************************** 44920002
*                                                                       44930002
*****    LOOP THROUGH THE LIST OF DCB'S AND DETERMINE WHICH             44940002
*****    DCB'S ARE HAVING A DEFERRED ABEND.                             44950002
*                                                                       44960002
TCM52500 EQU   *                                                        44990002
         L     RPAR,WTGPREFX            LOAD PREFIX POINTER      Y02080 45020002
         USING IECPREFX,RPAR            PREFIX ADDRESSABILITY    Y02080 45050002
         L     RPAR,IECUPRML            LOAD TCLOSE PARM LIST    Y02080 45080002
         DROP  RPAR                                              Y02080 45110002
         LR    RPARC,RPAR               PT TO 1ST PARM ENTRY            45140002
         LA    RWTGC,WTGENTRY           LOAD ADDR OF FIRST WTG ENTRY    45170002
         USING WTGENTRY,RWTGC           DEFINE BASE TO WTG ENTRY        45200002
         MVI   WTGLNG,K0                SET RETURN CODE TO ZERO  Y02080 45230002
TCM52700 EQU    *                                                       45260002
         L     RCORE,K4(RWTGC)          LOAD ADDRESS OF TCLOSE WK AREA  45290002
         LA    RCORE,K0(,RCORE)         CLEAR HIGH-ORDER BYTE           45320002
         LTR   RCORE,RCORE              IS THERE A WORK AREA ADDRESS-   45350002
         BNZ   TCM52900                 BR IF YES                X02989 45380002
         MVI   WTGLNG,K4                SET RETURN CODE          Y02080 45410002
         B     TCM54100                 BR TO CHECK NEXT ENTRY   X02989 45440002
TCM52900 EQU   *                                                 X02989 45470002
         L     RDCB,PLISTDCB(,RPARC)    LOAD ADDRESS OF DCB             45500002
         TM    JFCBMASK+K4,JFCMABND     DELAYED ABEND PENDING    Y02144 45530002
         BO    TCM54100                 BR IF YES                Y02144 45560002
         TM    DXATOPEN,DXATIGN         IGNORED ABEND PENDING    Y02144 45590002
         BO    TCM54100                 BR IF YES                Y02144 45620002
         L     RDEB,DCBDEBAD            LOAD DEB ADDR            Y02082 45650002
         TM    DCBMACRF,DCBMEXCP        IS ACCESS METHOD EXCP    X02989 45680002
         BO    TCM53600                 BR IF YES                X02989 45710002
         TM    DCBDSORG+K1,ACBDORGA     IS CONTROL BLOCK AN ACB  X02989 45740002
         BNO   TCM53600                 BR IF NO                 X02989 45770002
         TM    ACBAMETH-IFGACB(RDCB),ACBVSAM IS ACB FOR VSAM     X02989 45800002
         BNO   TCM53600                 BR TO FREE WORK AREA     X02989 45830002
         CLI   ACBERFLG-IFGACB(RDCB),K0 IS ERROR FLAG ZERO       X02989 45860002
         BE    TCM53800                 BRANCH IF YES            XM1037 45890002
         MVI   WTGLNG,K4                SET RETURN CODE          Y02080 45920002
         B     TCM53800                 BR TO FREE WORK AREA     X02989 45950002
TCM53600 EQU   *                                                 X02989 45980002
         TM    DCBOFLGS,DCBOPEN+DCBOLOCK+DCBOBUSY  WAS DCB PROC  X02989 46010002
         BO    TCM53700                 BR IF YES                X02989 46040002
         MVI   WTGLNG,K4                SET RETURN CODE          Y02080 46070002
         B     TCM54100                 BR TO CHECK NEXT ENTRY   X02989 46100002
TCM53700 EQU   *                                                 X02989 46130002
         NI    DCBOFLGS,X'FF'-DCBOBUSY  TURN OFF 'DCB BUSY' IND  A35953 46160002
*                                                                A35953 46190002
         L     RUCB,DEBSUCBA            LOAD UCB ADDR          @ZA03180 46200000
         LA    RUCB,K0(RUCB)            CLEAR HIGH ORDER BYTE  @ZA03180 46210000
         LTR   RUCB,RUCB                DUMMY DATA SET?        @ZA03180 46212000
         BZ    TCM53750                 YES, BR-NOT DA DATA SET@ZA03180 46214000
         USING UCB,RUCB                                        @ZA03180 46216000
         CLI   UCBTBYT3,UCB3DACC        DIRECT ACCESS DATA SET?@ZA03180 46218000
         BNE   TCM53750                 NO, BR                 @ZA03180 46218400
         DROP  RUCB                                            @ZA03180 46218800
         TM    DXCCW,ALLBITS            WAS PROCESSING TERMIN-  SA48558 46220002
*                                       ..ATED ON THIS DCB-     SA48558 46250002
         BO    TCM53800                 ..BR IF YES- DON'T RESET A35953 46280002
*                                       ..PROCESSING INDICATORS  A35953 46310002
*                                                                A35953 46340002
*****    RESET DCB AND DEB PROCESSING STATUS INDICATORS          A35953 46370002
*                                                                A35953 46400002
TCM53750 EQU   *                                               @ZA03180 46410000
         NI    DCBOFLGS,X'FF'-DCBOWRIT-DCBORDBK-DCBOEOF          A35953 46430002
*                                       RESET OUTPUT, READBACK,  A35953 46460002
*                                       EOF INDICATORS IN DCB    A35953 46490002
         NI    DEBOFLGS,X'FF'-DEBOFEOF  RESET 'VOLUME FULL'      A35953 46520002
*                                       ..INDICATOR IN DEB       A35953 46550002
*                                                                       46580002
TCM53800 EQU   *                                                 A35953 46610002
         TM    DCBMACRF,DCBMEXCP        TEST IF EXCP             Y02082 46640002
         BO    TCM53850                 BRANCH IF YES            Y02082 46670002
         TM    DCBDSRG2,ACBDORGA        TEST IF AN ACB           Y02082 46700002
         BO    TCM53900                 DO NOT POINT THE DEB     Y02082X46730002
                                        TO THE ACB               Y02082 46740002
TCM53850 EQU   *                        POINT DEB TO USER'S DCB  Y02082 46760002
         L     RDEB,DCBDEBAD            GET DEB ADDRESS          Y02082 46790002
         MVC   DEBDCBAD+K1(L'DEBDCBAD-K1),DXUDCBAD+K1 POINT DEB  Y02082*46820002
                                        TO USER'S DCB            Y02082 46850002
         LR    R1,RDEB                  LOAD DEB ADDRESS         YM1272 46880002
         LA    RF,DEBBASIC-DEBXTNP      NEGATIVE OFFSET TO DEB   YM1272 46910002
*                                       EXTENSION ADDRESS        YM1272 46940002
         SR    R1,RF                    POINT R1 TO DEB PREFIX   YM1272 46970002
         L     RF,DEBXTNP-DEBXTNP(,R1)  LOAD DEB EXTENSION ADDR  YM1272 47000002
         NI    DEBXFLG1-DEBXTN(RF),X'FF'-DEBXCDCB  DEBDCBAD      YM1272 47030002
*                                       POINTS TO THE USER'S DCB YM1272 47060002
*                                                                Y02082 47090002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 47120002
*                                                                Y02082 47150002
TCM53900 EQU   *                        REFRESH THE USER'S DCB   Y02082 47180002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,WTGPREFX)          Y02082 47210002
*                                                                Y02083 47240002
* IF A CHECKPOINT DATA SET SECURITY INTERFACE EXISTS, UPDATE     Y02083 47270002
* THE USER'S DCB FROM THE PROTECTED DCB.                         Y02083 47300002
* IF A SECURITY INTERFACE EXISTS, THERE ARE THREE DCBS: THE      YM3806 47310002
* USER'S IN USER'S KEY, THE COPIED DCB IN KEY 5, AND THE CHECK-  YM3806 47320002
* POINT DCB IN KEY ZERO.  AT THIS TIME THE TRUE USER'S DCB WILL  YM3806 47322002
* BE UPDATED WITH THE TRUE COPIED DCB WHIS IS IN KEY 5.          YM3806 47324002
*                                                                Y02083 47330002
         L     R1,DXDSAB                FETCH DSAB ADDRESS       Y02083 47360002
         USING DSAB,R1                  ADDRESS DSAB             Y02083 47390002
         TM    DSABFLG4,DSABCKSI        CHKPT SECURITY INTERFACE Y02083 47420002
         DROP  R1                       DSAB ADDRESSABILITY      Y02083 47450002
         BZ    TCM53950                 IF NOT, BRANCH           Y02083 47480002
         L     RDCB,DXUDCBAD            GET KEY ZERO DCB ADDR    Y02083 47510002
         LA    R1,K4                    BACKUP PROT. DCB ADDR BY Y02083 47540002
         SR    RDCB,R1                  4 TO GET USER DCB ADDR   Y02083 47570002
         MODESET EXTKEY=ZERO            GET INTO KEY ZERO        YM3806 47580002
         L     RF,K0(,RDCB)             GET USER'S DCB ADDR      Y02083 47600002
         L     RDCB,DXPDCBAD            PNT TO COPIED DCB        YM3806 47630002
         AH    RF,DXUDCBPL              PNT PAST USER DCB PREFX  Y02083 47660002
         AH    RDCB,DXUDCBPL            PNT PAST PROT. DCB PREFX Y02083 47690002
         LH    R1,DXUDCBML              GET DCB MOVE LENGTH      Y02083 47720002
         BCTR  R1,R0                    ADJUST FOR MOVE INSTR    Y02083 47750002
         L     RET,DXTCBADR             FETCH USER TCB ADDRESS   Y02083 47780002
         USING TCB,RET                  ADDRESS TCB              Y02083 47810002
         MODESET KEYADDR=TCBPKF,WORKREG=14 USER KEY              Y02083 47840002
         DROP  RET                      TCB ADDRESSABILITY       Y02083 47870002
         EX    R1,TCMMOVER              UPDATE USER'S DCB        Y02083 47900002
         MODESET EXTKEY=DATAMGT         BACK TO D/M KEY          Y02083 47930002
TCM53950 EQU   *                        CLEAR WTG TABLE ENTRY    Y02083 47960002
         XC    WTGENTRY,WTGENTRY        CLEAR WTG TABLE ENTRY           47990002
*                                                                       48020002
TCM54100 EQU   *                                                        48050002
*                                                                       48080002
*********************************************************************** 48110002
*                                                                       48140002
*  CHECK FOR END OF DCB WORK AREA FREEMAIN LOOP                         48170002
*                                                                       48200002
         TM    PLISTDCB(RPARC),LASTNTRY IS THIS THE LAST TCLOSE ENTRY-  48230002
         LA    RPARC,K4(,RPARC)         PT TO NEXT TCLOSE ENTRY         48260002
         LA    RWTGC,WTGEND-WTGENTRY(,RWTGC)   PT TO NEXT WTG ENTRY     48290002
         BNO   TCM52700                 ..BR IF NOT TO CHECK NEXT ENTRY 48320002
*                                                                       48350002
*********************************************************************** 48380002
*                                                                       48410002
*  SEE IF THERE IS A DCB LEFT THAT HAS A DEFERRED ABEND PENDING.        48440002
*                                                                       48470002
         LR    RPARC,RPAR               ADDR OF FIRST DCB PARM ENTRY    48500002
         LA    RWTGC,WTGENTRY-WTG(,RWTG)  ADDR OF FIRST WTG ENTRY       48530002
         L     RC,WTGPREFX              GET WTG PREFIX PTR       Y02144 48560002
         L     RC,IECRRPRM-IECPREFX(,RC) GET RRPLIST ADDRESS     Y02144 48590002
         USING RRPLIST,RC                                        Y02144 48620002
*                                                                       48650002
TCM54120 EQU   *                                                        48680002
         L     RCORE,WTGCORE-K1         LOAD MAIN WORK AREA ADDR        48710002
         LA    RCORE,0(RCORE)           CLEAR HIGH ORDER BYTE           48740002
         LTR   RCORE,RCORE              TEST IF DCB HAS WORK AREA       48770002
         BZ    TCM54160                 BR IF NO, ADDR CLEARED   Y02144 48800002
         TM    JFCBMASK+4,JFCMABND      DELAYED ABEND DCB?       Y02144 48830002
         BO    TCM54200                 YES, GO ISSUE ABEND      Y02144 48860002
*                                       NO,MUST BE IGNORED ABEND Y02144 48890002
         CLC   RRMLRTRY,RRFWORK         PRIOR IGNORED ABEND DCB  Y02144 48920002
         BNE   TCM54160                 YES,GO CHK IF LAST ENTRY Y02144 48950002
         STM   RPARC,RWTGC,RRMLRTRY     SAVE CURR DCB ENTRY ADDR Y02144 48980002
*                                       AND CURR WTG ENTRY ADDR  Y02144 49010002
*********************************************************************** 49040002
*                                                                       49070002
*  CHECK FOR END OF LOOP LOOKING FOR A DELAYED/IGNORED ABEND.           49100002
*                                                                       49130002
TCM54160 EQU   *                                                        49160002
         TM    PLISTOPT(RPARC),LASTNTRY CHK FOR LAST DCB ENTRY          49190002
         LA    RPARC,K4(RPARC)          PT TO NEXT DCB ENTRY            49220002
         LA    RWTGC,WTGEND-WTGENTRY(RWTGC) PT TO NEXT WTG ENTRY        49250002
         BZ    TCM54120                 BR NO TO CHK FURTHER FOR Y02144 49280002
*                                       A DELAYED ABEND DCB      Y02144 49310002
         CLC   RRMLRTRY,RRFWORK         IGNORED ABEND PENDING    Y02144 49340002
         BE    TCM54500                 NO, BR TO FREE WTG TABLE Y02144 49370002
         LM    RPARC,RWTGC,RRMLRTRY     GET CURR DCB ENTRY ADDR  Y02144 49400002
*                                       AND CURR WTG ENTRY ADDR  Y02144 49430002
         LA    RCORE,TCM54500           GET MAINLINE RETRY ADDR  Y02144 49460002
         ST    RCORE,RRMLRTRY           SAVE MAINLINE RETRY ADDR Y02144 49490002
         XC    RRFWORK,RRFWORK          CLEAR RRPLIST WORK WORD  Y02144 49520002
         L     RCORE,WTGCORE-K1         LOAD MAIN WORK AREA ADDR Y02144 49550002
*                                                                       49580002
*********************************************************************** 49610002
*                                                                       49640002
*  DO A DELAYED/IGNORED ABEND ON THIS DCB.  RESTORE REGISTERS FIRST.    49670002
*                                                                       49700002
TCM54200 EQU   *                                                        49730002
         L     RDCB,DXUDCBAD            LOAD CURRENT DCB ADDR    YM5924 49760002
         LM    RTIOT,RET,DXREG9         RESTORE REGISTERS 9-14          49790002
         L     R0,DXREG0                RESTORE REGISTER 0              49820002
*                                                                       49850002
         SR    RF,RF                    LOAD PROBLEM DETERMINATION      49880002
         IC    RF,DXRETCOD              RETURN CODE IN REGISTER 15      49910002
*                                                                       49940002
         LH    R1,DXABCODE              LOAD THE ABEND CODE      Y02134 49970002
         SRL   R1,K4                    ALIGN RIGHT              Y02134 50000002
         ABEND (1),DUMP,,SYSTEM,        SYSTEM ABEND WITH A DUMP Y02080*50030002
               DUMPOPT=SNAPLIST                                  Y02144 50060002
*                                                                       50090002
*********************************************************************** 50120002
*                                                                       50150002
*  FREE MAIN STORAGE USED FOR WTG TABLE AND ALL OTHERS           Y02080 50200002
*                                                                       50300021
TCM54500 EQU   *                                                        50400021
         SR    R9,R9                    ZERO REGISTER            Y02080 50550002
         IC    R9,WTGLNG                SAVE RETURN CODE         Y02080 50600002
         IECRES FREE,A=(RWTG),PREFIX=WTG  FREE WTG TABLE         Y02080 50950002
*                                                                       51000021
*****    RETURN TO CALLER                                               51100021
*                                                                       51200021
         LR    RF,R9                    LOAD RETURN CODE         Y02080 51300002
         IECRES EXIT                    RETURN                   Y02080 51390002
*                                                                Y02080 51396002
         SPACE 2                                                        51400021
*********************************************************************** 51500021
*              SUBROUTINES                                            * 51600021
*********************************************************************** 51700021
*                                                                       51800021
*****    INITIALIZE CHANNEL PROGRAM TO WRITE A FILE MARK                51900021
*                                                                       52000021
TCD02900 EQU   *                                                        52100021
         LA    RF,DXCCW4+K4             PLACE ADDRESS OF CCHHR          52200021
         ST    RF,DXCCW1                INTO SEARCH CCW                 52300021
         LA    RF,DXCCW1                ADDRESS OF CCW1                 52400021
         MVI   DXCCW1,CCWSCHID          SET UP SEARCH OPERATION CODE    52500021
         ST    RF,DXCCW2                ADDRESS OF CCW1 INTO TIC CCW    52600021
         MVC   DXCCW1+K4(K5),ACCW1CD    COMMAND CHAIN,5 CHARACTERS,TIC  52700021
         LA    RF,DXDSCB                PLACE ADDRESS OF THE FILE MARK  52800021
         ST    RF,DXCCW3                INTO THE WRITE DATA CCW         52900021
         MVI   DXCCW3,X'1D'             WRITE COUNT , KEY , DATA        53000021
         MVC   DXCCW3+K4(K4),ACCW3CC    8 CHARACTERS                    53100021
         MVC   DXDSCB(K5),DXCCW4+K4     PLACE CCHHR INTO THE KEY        53200021
         XC    DXDSCB+K5(K3),DXDSCB+K5  ZERO OUT THE DATA PORTION       53300021
         BR    RD                       RETURN TO CALLER                53400021
         EJECT                                                          53500021
*                                                                       53600021
*****    COMPLETE CONTROL BLOCKS AND WRITE FILE MARK                    53700021
*                                                                       53800021
TCD03000 EQU   *                                                        53900021
         MVC   DXDAADDR,DXCCW4+K1       PLACE FULL DISK ADDRESS INTO IO 54000021
         MVI   DXDAADDR,K0              SET M (EXTENT NUMBER) TO ZERO   54100021
         LA    RC,TABD131               LOAD INTERNAL ERROR CODE        54200021
         EXCP  DXIOB                    INITIATE I/O OPERATION          54300021
         IECRES WAIT                    INVOKE IECRES MACRO TO 'WAIT'   54400021
         TM    DXECB,ECBNOERR           TEST FOR SUCCESSFUL COMPLETION- 54500021
         BCR   1,RD                     ..BR IF YES- RETURN TO CALLER   54600021
TCD03100 EQU   *                        ERROR EXIT TO P.D.       Y02082 54650002
         DMABCOND (RC),ABEND2Z          ..ELSE EXIT TO THE PROBLEM     C54700021
                                        ..DETERMINATION FUNCTION        54800021
         EJECT                                                          56100021
*********************************************************************** 56200021
*              CONSTANTS                                              * 56300021
*********************************************************************** 56400021
*                                                                       56500021
TCMMOVER MVC   K0(K0,RF),K0(RDCB)       OBJECT OF EXECUTE INS    Y02083 56502002
CON10000 DC    F'65536'                 FULLWD CONSTANT OF X'00010000'  56600021
ACCW3CC  DC    X'20000008'              LENGTH EQ 8, SILI FLAG ON       56700021
ACCW1CD  DC    X'6000000508'            LENGTH EQ 5, CMD CHAIN AND SILI 56800021
*                                       ..FLAGS, AND 'TIC' OP CODE      56900021
SNAPLIST SNAP  SDATA=TRT,MF=L           READ ONLY SNAP LIST FOR  Y02144*56950002
                                        ABEND OPTION DUMPOPT     Y02144 56960002
*                                                                       56970002
         SPACE 2                                                        57000021
*********************************************************************** 57100021
*        TABLE OF MODULE IDS AND ENTRY POINT ADDRESSES                * 57200002
*********************************************************************** 57300021
*                                                                       57400021
XCTLTB2Z XCTLTABL ID=(ABEND2Z,0P),SVC=023,BRT=YES,LENGTH=        YM1272 57500002
         SPACE 2                                                        57600021
         IECEQU AOS=YES,IEZDEB=YES                               YM1272 57650002
         IECDSECS CVT,                                                 C57700021
               TIOT,                                                   C57800021
               DSAB,                                             Y02083C57850002
               DCB,                                                    C57900021
               ACB,                                              Y02080X57950002
               IEZDEB,                                           YM1272C58000002
               UCB,                                                    C58100021
               MAIN,                                                   C58200021
               UNITTAB,                                                C58300021
               WTG,                                                    C58400021
               PREFX,                                            Y02080*58410002
               TCB,                                                    C58450000
               RRPL,                                             Y02144*58460002
               EXPAND=YES                                               58500021
         SPACE 2                                                        58700021
         END                                                            58800021
