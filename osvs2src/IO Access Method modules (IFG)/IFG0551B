         TITLE 'IFG0551B - SYNAD DIAGNOSTIC ROUTINE'                    00100021
IFG0551B CSECT                                                          00400021
*********************************************************************** 00450002
*                                                                     * 00500002
*                                                                     * 00550002
*        VS2 RELEASE 02 DELETIONS                                     * 00600002
*                                                                     * 00650002
*        VS2 RELEASE 03 DELETIONS                                     * 00652000
*0000428000                                                    @ZA01339 00654000
*                                                                     * 00660002
*        VS2 RELEASE 037 DELETIONS                                    * 00661037
*D27950002-31560002,35000021-35100021,43000021-43300002        @ZA16052 00662037
*D46400002-48900002                                            @ZA16052 00663037
*A31550102-31550902,44180121-44180421,44187002-44189002        @ZA16052 00664037
*C290000                                                       @ZA25479 00665037
*0000                                                          @ZA27758 00665537
*                                                                       00666037
*********************************************************************** 00670002
*                                                                     * 00700002
* MODULE NAME = IFG0551B (OS/VS2)                                     * 00750002
*                                                                     * 00800002
* DESCRIPTIVE NAME = SYNAD DIAGNOSTIC ROUTINE                         * 00850002
*                                                                     * 00900002
* COPYRIGHT = NONE                                                    * 00950002
*                                                                     * 01000002
* STATUS = RELEASE 2, LEVEL 0                                         * 01050002
*                                                                     * 01100002
* FUNCTION =                                                          * 01150002
*        THIS MODULE IS ENTERED FROM IGC0005E FOR THREE REASONS WITH  * 01200002
*        A BRANCH TABLE OFFSET IN REGISTER 7 INDICATING THE FUNCTION  * 01250002
*        DESIRED.                                                     * 01300002
*                                                                     * 01350002
*        1)-REGISTER 7 = 20 - PROBLEM DETERMINATION MESSAGE 'IEC020I  * 01400002
*        EROPT=ABE OR AN INVALID CODE AND/OR NO SYNAD EXIT SPECIFIED' * 01450002
*        IS MOVED TO OFFSET 8 INTO THE EOV WORKAREA AND MODULE        * 01500002
*        IFG0551D IS GIVEN CONTROL TO WRITE THE MESSAGE AND ISSUE     * 01550002
*        AN 001 ABEND.                                                * 01600002
*                                                                     * 01650002
*        2)-REGISTER 7 = 0 - THE SYNAD EXIT IS TAKEN FOR A QSAM DCB.  * 01700002
*                                                                     * 01750002
*        3)-REGISTER 7 = 4, 8, 12, 16 - THIS MODULE ATTEMPTS TO ALLOW * 01800002
*        A QSAM/BSAM DCB TO CONTINUE PROCESSING AFTER AN I/O ERROR BY * 01850002
*        ANALYZING THE TYPE OF ERROR. IF THE ERROR CAN BE ACCEPTED OR * 01900002
*        SKIPPED THE APPROPRIATE CHANNEL PROGRAMS ARE RESTARTED AND   * 01950002
*        RETURN IS MADE TO THE ACCESS METHOD CALLER OF EOV. IF THE    * 02000002
*        ERROR CAN NOT BE IGNORED OR SKIPPED, MODULE IFG0551D IS      * 02050002
*        GIVEN CONTROL TO ISSUE AN 001 ABEND AND AN INFORMATIONAL     * 02100002
*        MESSAGE EXPLAINING THE SITUATION.                            * 02150002
         EJECT                                                          02200002
*        THE SPECIFIC MEANINGS OF THE SETTINGS OF REGISTER 7          * 02250002
*        UNDER CASE 3) ABOVE, ARE AS FOLLOWS -                        * 02252002
*        4 - A QSAM DCB HAS EITHER RETURNED FROM THE SYNAD ROUTINE    * 02300002
*        (THIS THEN BEING THE SECOND ENTRY TO EOV), OR THERE IS NO    * 02350002
*        SYNAD ROUTINE IN THE DCB (THIS THEN BEING THE FIRST ENTRY    * 02400002
*        TO EOV). IN EITHER CASE THE DCBEROPT ERROR OPTION IS USED    * 02450002
*        TO DETERMINE WHETHER TO SKIP OR ACCEPT THE ERROR, OR TO      * 02500002
*        ABEND IMMEDIATELY.                                           * 02550002
*        8, 12, 16 - THIS INDICATES A SECOND ENTRY TO EOV FOR A BSAM  * 02600002
*        DCB WHICH HAS RETURNED FROM THE SYNAD ROUTINE, IMPLYING THE  * 02650002
*        I/O ERROR IS TO BE ACCEPTED IF POSSIBLE.                     * 02700002
*        8 - THERE IS AT LEAST ONE CHANNEL PROGRAM TO BE RESCHEDULED. * 02750002
*        12 - CHAINED SCHEDULING.                                     * 02800002
*        16 - THERE IS AT LEAST 1 CHANNEL PROGRAM TO RESCHEDULE AND   * 02850002
*        THE DEVICE BEING PROCESSED IS A PRINTER.                     * 02900002
*                                                                     * 02950002
* NOTES = SEE BELOW                                                   * 03000002
*                                                                     * 03050002
*    DEPENDENCIES =                                                   * 03100002
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 03150002
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 03200002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 03250002
*                                                                     * 03300002
*    RESTRICTIONS = NONE                                              * 03350002
*                                                                     * 03400002
*    REGISTER CONVENTIONS =                                           * 03450002
*            R2 POINTS TO DCB                                         * 03500002
*            R4 POINTS TO OPEN WORK AREA                              * 03550002
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 03600002
*            R6 POINTS TO THE WTG TABLE                               * 03650002
*                                                                     * 03700002
*    PATCH LABEL = SEE THIRD FROM LAST LABEL BEFORE ORG STATEMENT AT  * 03750002
*                  END OF LISTING.                                    * 03800002
*                                                                     * 03850002
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 03900002
*                                                                     * 03950002
*    PROCESSOR = ASSEMBLER XF                                         * 04000002
*                                                                     * 04050002
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 04100002
*                  ORG STATEMENT AT END OF LISTING                    * 04150002
*                                                                     * 04200002
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 04250002
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 04300002
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 04350002
         EJECT                                                          04400002
* ENTRY POINT = IFG0551B                                              * 04450002
*                                                                     * 04500002
*    PURPOSE = SEE FUNCTION                                           * 04550002
*                                                                     * 04600002
*    LINKAGE =                                                        * 04650002
*        THIS MODULE IS TRANSFERRED CONTROL THROUGH THE IECRES-LOAD   * 04700002
*        MACRO.                                                       * 04750002
*                                                                     * 04800002
* INPUT =                                                             * 04850002
*        ENTERED IN PROTECT KEY 5                                     * 04860002
*        REGISTER 2 POINTS TO THE USER'S DCB.                         * 04900002
*        REGISTER 4 POINTS TO THE EOV WORKAREA.                       * 04950002
*        REGISTER 6 CONTAINS THE ADDRESS OF THE IOB HAVING THE   YM4610 04960002
*              I/O ERROR IF REGISTER 7 CONTAINS 8 OR 16          YM4610 04970002
*        REGISTER 7 CONTAINS AN ENTRY CODE USED IN A BRANCH TABLE.    * 05000002
*              THE CONTENTS ARE EXPLAINED ABOVE UNDER FUNCTION.       * 05050002
*        REGISTER 12 POINTS TO THE IOB HAVING THE I/O ERROR IF        * 05100002
*              REGISTER 7 CONTAINS 4 OR 12.                           * 05150002
*        REGISTER 12 POINTS TO THE LAST SCHEDULED IOB IF         YM4610 05160002
*              REGISTER 7 CONTAINS 8 OR 16                       YM4610 05170002
*                                                                     * 05200002
* OUTPUT =                                                            * 05250002
*        IFG0551D PASSED CONTROL IN PROTECT KEY 5 -                   * 05300002
*        REGISTER 7 = 0 INDICATES THE EOV WORKAREA CONTAINS MESSAGE   * 05350002
*        'IEC020I DCB EROPT=ABE OR AN INVALID CODE AND/OR NO SYNAD    * 05400002
*        EXIT SPECIFIED', AND AN 001 ABEND IS TO BE ISSUED.           * 05450002
*        REGISTER 4 POINTS TO THE EOV WORKAREA.                       * 05500002
*        REGISTER 1 POINTS TO DXREG1 WHERE THE 001 ABEND IS INDICATED.* 05550002
*        REGISTER 2 POINTS TO THE USER'S DCB.                         * 05600002
*                                                                     * 05650002
*        IFG0551D PASSED CONTROL IN PROTECT KEY 5 -                   * 05700002
*        REGISTER 7 SET TO 4 INDICATES IFG0551D IS TO CONSTRUCT AND   * 05750002
*        ISSUE MESSAGE 'IEC020I NON-ACCEPTABLE ERROR' AND ISSUE AN    * 05800002
*        001 ABEND.                                                   * 05850002
*        REGISTER 2 POINTS TO THE USER'S DCB.                         * 05852002
*        REGISTER 4 POINTS TO THE EOV WORKAREA.                       * 05860002
*                                                                     * 05900002
*        SYNAD EXIT - REGISTER 15 CONTAINS THE SYNAD ADDRESS. THE     * 05950002
*        SVRB CONTAINS THE USER'S REGSITERS FOR USE IN THE SYNAD      * 06000002
*        ROUTINE.                                                     * 06050002
*                                                                     * 06100002
*        RETURN TO THE ACCESS METHOD MODULES TO CONTINUE ACCESS       * 06150002
*        METHOD PROCESSING AFTER RESTARTING ALL NECESSARY CHANNEL     * 06200002
*        PROGRAMS TO ACCEPT OR SKIP AN I/O ERROR. REGISTER 15 SET TO  * 06250002
*        ZERO. SVRB CONTAINS THE ACCESS METHOD REGISTERS AS IN THE    * 06300002
*        FIRST ENTRY TO EOV.                                          * 06350002
         EJECT                                                          06400002
* EXIT-NORMAL =                                                       * 06450002
*        IFG0551D TO ISSUE PROBLEM DETERMINATION MESSAGE AND ABEND.   * 06500002
*        EXIT TO ACCESS METHOD CALLER OF EOV.                         * 06550002
*                                                                     * 06600002
* EXIT-ERROR =                                                        * 06650002
*        IFG0551D TO ISSUE PROBLEM DETERMINATION MESSAGE AND ABEND.   * 06700002
*                                                                     * 06750002
* EXTERNAL REFERENCES = SEE BELOW                                     * 06800002
*                                                                     * 06850002
*    ROUTINES =                                                       * 06900002
*        NONE.                                                        * 06950002
*                                                                     * 07000002
*    DATA AREAS =                                                     * 07050002
*        EOV WORKAREA.                                                * 07100002
*        SVRB SAVE AREA.                                              * 07150002
*        USER REGISTER SAVE AREA.                                     * 07200002
*                                                                     * 07250002
*    CONTROL BLOCK =                                                  * 07300002
*        CVT                                                          * 07350002
*        TCB                                                          * 07400002
*        SVRB                                                         * 07450002
*        UCB                                                          * 07500002
*        DCB                                                          * 07550002
*        ACCESS METHOD IOBS/ICBS                                      * 07600002
*                                                                     * 07650002
* TABLES =                                                            * 07700002
*        NONE                                                         * 07750002
*                                                                     * 07800002
* MACROS =                                                            * 07850002
*        MODESET                                                      * 07900002
*        IECRES FREE                                                  * 07950002
*        IECRES EXIT                                                  * 08000002
*        IECRES GET                                                   * 08050002
*        EXCP                                                         * 08100002
*        XCTLTABL                                                     * 08150002
*        IECDSECS                                                     * 08200002
*        IECEQU                                                       * 08250002
*                                                                     * 08300002
* CHANGE ACTIVITY =                                                   * 08350002
*        SEE CHANGES/DELETIONS SECTION JUST AFTER CSECT CARD          * 08360002
*                                                                     * 08400002
*********************************************************************** 08450002
         EJECT                                                          08500002
         BALR  RBASE,0                  ESTABLISH BASE                  12900021
         USING EIN05300,RBASE                                           13000021
         USING IHADCB,RDCB                                              13100021
         USING FORCORE,RCORE                                            13150002
*                                                                       13200021
EIN05300 EQU   *                        BASE ADDRESS                    13300002
*                                                                       13400021
*        THE FOLLOWING ROUTINE CHAINS DOWN THE CVT,TCB AND RB TO PICK   13415002
*        UP THE CURRENT SVRB                                            13420002
*                                                                       13425002
         L     RET,CVTPTR               CVT ADDRESS              Y02080 13430002
         L     RET,K0(K0,RET)           ADDR TO TCB PTRS         Y02080 13435002
         L     RET,K4(K0,RET)           ACTIVE TCB PTR           Y02080 13440002
         L     RET,K0(K0,RET)           SVRB PTR                 Y02080 13445002
         USING RBSECT,RET                                        M0135  13447002
*                                                                       13450002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       YM4610 13450102
         BAL   RBASE,EIN05600           BRANCH AROUND ABEND SUBRTN      13500021
         USING EIN05400,RBASE           ESTABLISH NEW ADDRESSABILITY    13600021
*        RBASE IS USED FOR BASE REGISTER AND ABEND ENTRY POINT          13700021
         EJECT                                                          13750002
EIN05400 EQU   *                        GO TO IFG0551D                  13800002
*                                                                       13850002
*        REGISTER 7 INDICATES THE CALLING SEQUENCE TO IFG0551D          13900002
*                                                                       13902002
*        R7=0 - GO TO IFG0551D WITH R7=0 INDICATING FOR IT TO           13904002
*              CONSTRUCT AND WRITE THE NON-ACCEPTABLE ERROR MSG         13906002
*              AND ISSUE AN 001 ABEND                                   13908002
*                                                                       13908402
*        R7 POINTS TO MESSAGE WHICH IS MOVED TO WORKAREA, INDICATING    13908802
*              FOR IFG0551D TO WRITE IT AND ISSUE 001 ABEND BY          13909202
*              PASSING IFG0551D R7=4.                                   13909602
*                                                                       13909702
         USING WTG,RWTG                                          Y02080 13910002
         LTR   R7,R7                    CHECK FOR PROPER ENTRY  SA53086 13950021
*                                       TO MESSAGE MODULE       SA53086 13960021
         BZ    EIN05450                 BRANCH TO INDICATE      SA53086 13970021
*                                       NON-ACCEPTABLE ERROR    SA53086 13980021
*                                       MESSAGE TO MSG MODULE   SA53086 13990021
         LA    R1,DXREG1                RE-ESTABLISH REG 1              14000021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 14050002
         XC    K0(K12,R1),K0(R1)                                        14100021
         MVI   K1(R1),K16               INDICATE 001 ABEND              14200002
         LH    RF,K0(R7)                GET LENGTH OF MSG               14300021
         BCTR  RF,R0                    DECR BY 1 FOR EX OPCODE         14400021
         EX    RF,EIN05500              MOVE MSG TO WKAREA              14500021
         LA    R7,K4                    INDICATE NORMAL ENTRY   SA53086 14550021
*                                       FOR MSG MODULE          SA53086 14600021
EIN05450 EQU   *                        GIVE IFG0551D CONTROL           14650002
         MODESET EXTKEY=DATAMGT         RET EOV KEY              Y02082 14700002
         MVC   DXXMODNM,ERRNAME         GET IFG0551D NAME               15000021
         MVC   DXXMODEP+K1(K3),MOD2E2F+K2 GET TTR OF IFG0551D    Y02080 15100002
         IECRES LOAD,PREFIX=DXXPREFX,BRANCH=DIRECT               Y02080 15450002
EIN05500 EQU   *                        MOVE MESSAGE TO WORKAREA        15500002
         MVC   MSGLSTSZ(K0),K0(R7)                                      15510002
         EJECT                                                          15550002
EIN05600 EQU   *                        DETERMINE FUNCTION REQUESTED    15600002
         B     EIN05700(R7)             BR TABLE FOR PROCESSING SYNAD   15700021
EIN05700 EQU   *                        BRANCH TABLE                    15800002
         B     EIN06200                 0-SETUP FOR GET OR PUT ROUTINE  15900002
         B     EIN06500                 4-CHECK FOR USER ERROR OPTIONS  16000002
         B     EIN07500                 8-CHECK FOR SCHEDULING          16100002
         B     EIN07800                 12-GO ISSUE SVC FOR EXCP        16200002
         B     EIN07400                 16-GET NEXT IOB FOR SCHEDULING  16300002
         LA    R7,MSG22F                20-GET ADDR FOR IEC020I MSG     16400002
         BR    RBASE                    BR TO SETUP ABEND AND XCTL      16500021
         SPACE 2                                                        16550002
EIN05900 EQU   *                        EXIT TO ACCESS METHOD           16700002
         LR    RC,RCORE                 SAVE WORKAREA POINTER    YM3068 16750002
         TM    DCBSYNAD+K3,K1           IS SYNAD PRESENT                17500021
         BO    EIN06000                 NO BRANCH                       17600021
         LM    R0,R8,K28(RD)            GET ERR REGS PRE-SAVED IN REG13 17700021
         MVC   K36(K28,RD),K40(RET)     RESTORE USER REGS - 2--8        17800021
         MODESET EXTKEY=SUPR                                     Y02082 17850002
         STM   R0,R8,K32(RET)           RESTORE ERROR FLAGS TO SVRB     17900021
EIN06000 EQU   *                        FREE EOV WORKAREA               18000002
         MODESET EXTKEY=DATAMGT                                  YM5000 18002002
         LR    R1,RC                    WORK AREA TO R 1         YM3068 18010002
         IECRES FREE,A=(1),PREFIX=EOV   FREE WORK AREA           Y02080 18092402
         XR    RF,RF                    INDICATE NO SYNAD        A42485 18094002
         IECRES EXIT                    RETURN                   Y02080 18160002
         EJECT                                                          18190002
EIN06100 EQU   *                        RESCHEDULE IOBS FOR QSAM        18200002
*                                       FIXED-STANDARD DATA SET         18250002
*                                                                       18300021
*   MUST GO TO EOB RTN IF FIXED-STANDARD DATA SET AND LAST IOB SO THAT* 18400021
*   SEARCH ADDRESS CAN BE UPDATED FOR SKIP ONLY                       * 18500021
*                                                                       18600021
         L     RTIOT,DCBIOBA            GET IOB ADDRESS FORM DCB        18700021
         LA    RTIOT,K0(RTIOT)          CLEAR HIGH BYTE                 18800021
         CR    RWTG,RTIOT               ARE WE BACK TO ORIGINAL IOB     18900021
         BNE   EIN07400                 NO  BRANCH                      19000021
         SR    R7,R7                    CLEAR REG                       19400021
         IC    R7,DCBOFFSR              READ CCW OFFSET FOR EOB RT      19500021
*********************************************************************** 19560021
*                                                                       19580021
*        THE FOLLOWING ROUTINE DETERMINES IF A SYNCH OR BALR SHOULD BE  19600021
*        TAKEN TO THE EOB ROUTINE AND TAKES IT.  THE DECISION IS MADE   19620021
*        ON THE BASIS OF THE CALLING RB. IF IT IS KEY 0-7, CHANGE OF    19640002
*        KEY IS UNNECESSARY AND BALR IS USED. IF IT IS USER KEY, THE    19660021
*        KEY IS CHANGED TO THAT OF THE USER VIA A SYNCH MACRO.          19680002
*        A GETMAIN IS ISSUED TO GET A SAVEAREA FOR THE I/O              19700002
*        ROUTINE IN SP 230. IT IS FREED UPON RETURN. ALL EOV            19720002
*        REGISTERS ARE SAVED IN THE EOV WORKAREA (+0).  THIS ADDRESS    19740021
*        IS PASSED TO EOB WHEN BALR IS USED.  EOB STORES 2 REGISTERS    19760021
*        (9,10) AT OFFSET 64 IN THIS WORKAREA.                          19780021
*                                                                       19800021
*********************************************************************** 19820021
EIN06130 EQU   *                        SAVE REGISTERS           M0135  19860002
         MODESET EXTKEY=DATAMGT                                  Y02082 19870002
         STM   R0,RF,K0(RCORE)          SAVE EOV REGISTERS IN    M0135  19880021
*                                       WORKAREA                        19900021
         MODESET EXTKEY=SUPR            SVRB KEY                 Y02082 19910002
         ST    RCORE,RBEXSAVE           SAVE RCORE               Y02082 19912002
         MODESET EXTKEY=DATAMGT         RETURN TO D.M.KEY        Y02082 19914002
         EJECT                                                          19914402
         L     R0,CONREGMN              LOAD GETMAIN CONSTANT    Y02082 19916002
         IECRES GET,LV=(0),PREFIX=NO,STM=(2,14,DXXPREFX),        Y02082*19918802
               KEY=USER                 GET SAVEAREA             Y02082 19919202
         LR    RD,R1                    PUT PTR TO GOTTEN CORE   Y02082 19919602
*                                       IN R13                   Y02082 19919702
         L     RF,DCBEOB                LOAD EOB ADDRESS IN R15  M0135  19920021
         L     RC,RBLINK                PTR TO PREVIOUS RB       M0135  19980021
         CLI   RBOPSW+K1-RBSECT(RC),X80 IS PREVIOUS RB IN        Y02082 20000002
*                                       SYSTEM KEY               Y02082 20010002
         BNL   EIN06140                 NO, BR TO SET UP SYNCH   Y02082 20020002
         LR    RBASE,RWTG               PUT IOB IN R3 FOR EOB    M0135  20060021
         BALR  RET,RF                   BRANCH TO EOB            M0135  20080021
         BALR  RET,0                    ESTABLISH ADDRESSABILITY Y02082 20100002
         USING *,RET                    BASE FOR FOLLOWING BRANCH       20110002
         B     EIN06150                 RESTORE REGS             Y02082 20150002
         DROP  RET                      NO LONGER NEEDED                20160002
EIN06140 EQU   *                        SYNCH                    M0135  20180002
         LR    RBASE,RWTG               PUT IOB PTR IN R3        M0135  20360021
         SYNCH (15)                     GO TO EOB IN PROB PGM    M0135  20380021
*                                       STATE                    M0135  20400021
         EJECT                                                          20450002
*                                                                       20520021
*        THE FOLLOWING ROUTINE CHAINS DOWN THE CVT,TCB AND RB TO PICK   20540021
*        UP THE CURRENT SVRB AFTER GOING TO EOB ROUTINE                 20560002
*                                                                       20600021
EIN06150 EQU   *                        GET REGS TO FREEMAIN     Y02082 20650002
         L     RET,CVTPTR               CVT ADDRESS              M0135  20680021
         L     RET,K0(K0,RET)           ADDR TO TCB PTRS         M0135  20700021
         L     RET,K4(K0,RET)           ACTIVE TCB PTR           M0135  20720021
         L     RET,K0(K0,RET)           SVRB PTR                 M0135  20740021
*                                                                       20800021
         USING RBSECT,RET                                        M0135  20840021
         L     RCORE,RBEXSAVE           LOAD PTR TO EOV WKAREA   M0135  20860021
         L     RBASE,K12(RCORE)         RELOAD BASE REGISTER     M0135  20880021
         L     R0,CONREGMN              LOAD GETMAIN CONSTANT    Y02082 20930002
         MODESET EXTKEY=DATAMGT                                  Y02082 20932002
         IECRES FREE,A=(RD),PREFIX=NO,STM=(0,14,DXXPREFX),       Y02082*20950002
               KEY=USER,LV=(0)          FREE SAVEAREA            Y02082 20952002
         DROP  RET                                               M0135  20960021
         LM    R0,RF,K0(RCORE)          RESTORE ALL EOV          M0135  20980021
*                                       REGISTERS                M0135  21000021
         B     EIN05900                 BR TO EXIT               M0135  21020021
         EJECT                                                          21040002
*                                                                       21050002
*        REG 7 = 0 ENTRY POINT - TAKE QSAM SYNAD EXIT                   21090002
*                                                                       21140002
EIN06200 EQU   *                        QSAM I/O ERROR ANALYSIS         21200002
         SR    RWTG,RWTG                CLEAR REG                       21400021
         TM    K0(RC),IOBWRITE          IOB IN WRITE STATUS             21500021
         IC    RWTG,DCBOFFSW            GET WRITE CCW OFFSET            21600021
         BO    EIN06300                 YES - BRANCH                    21700021
*                                                                       21800021
         IC    RWTG,DCBOFFSR            GET READ CCW OFFSET             21900021
EIN06300 EQU   *                        GET CCW                         22000002
         SH    RWTG,EIGHTCON            REDUCE OFFSET BY 8              22100021
         SLL   RWTG,K24                 SHIFT TO HIGH ORDER BYTE        22200021
         LA    R7,K8(RC)                PUT IOBAD IN SAME REG AS        22300021
*                                       OFFSET CONSTANT                 22350021
         OR    RWTG,R7                  OFFSET CONSTANT                 22500021
         LR    RC,RCORE                 PRIME RC                 YM1304 22550002
         LR    RTIOT,RWTG               SET UP PARM REG FOR RET  A43881 22600021
         LR    RUCB,R1                  SAVE PARM IN UCB REG            22800021
         L     RF,DCBSYNAD              GET SYNAD ADDRESS        A42485 23050021
         LA    RF,K0(RF)                CLEAR HIGH BYTE        @ZA27758 23070037
         LM    R2,R8,K36(RD)            GET GERR/PERR REGS 2-8   Y02082 23100002
         MVC   K32(K32,RD),K36(RET)     RESTORE REGISTERS 1-8    Y02082 23200002
         MODESET EXTKEY=ZERO                                     Y02082 23250002
         STM   R2,R8,K40(RET)           SAVE GERR PERR REGS      Y02082 23300002
         LR    R8,RUCB                  SAVE PARM IN R8          Y02080 23350002
         IECRES FREE,A=(RC),PREFIX=EOV  FREE WORK AREA           Y02080 23596002
         LR    R0,RTIOT                 RESTORE PARAMETER REGS          23598002
         LR    R1,R8                    RESTORE PARM FROM R8     Y02080 23598402
         IECRES EXIT                    RETURN TO ACCESS METHOD  Y02080 23760002
         EJECT                                                          23770002
*                                                                       23790002
*        REG 7 = 4 ENTRY POINT - IMPLEMENT ERROR OPTION IF              23840002
*        ERROR CAN BE ACCEPTED.                                         23842002
*        RETURN FROM SYNAD FOR QSAM OR NO SYNAD PRESENT.                23850002
*                                                                       23890002
EIN06500 EQU   *                        RESET ERROR FLAGS               24100002
*                                                                       24200021
         NI    DCBIFLGS,X'FF'-DCBIFPIO  TURN OFF ERROR FLAGS            24300037
         NI    DCBCIND2,ALLBITS-X10     TURN OFF 2ND ENTRY FLAG         24400021
*                                                                       24420021
*  COPY THE IOB PREFIX ADDRESS FOR NORMAL SCHEDULING OR THE             24440021
*  INTERRUPT CONTROL BLOCK (ICB) ADDRESS FOR CHAINED CHANNEL-           24460021
*  PROGRAM SCHEDULING, PASSED FROM IGC0005E.                            24480021
*                                                                       24500021
         LR    RWTG,RC                 COPY IOB OR ICB ADDRESS          24550037
*                                                                       24600021
*  THE FOLLOWING ROUTINE DETERMINES THOSE ERRORS WHICH THE USER         24800021
*  CANNOT ACCEPT.                                                       25000021
*                                                                       25200021
         XR    R7,R7                    SET INDICATOR TO TELL   SA53086 25250021
*                                       MSG MODULE TO BUILD     SA53086 25300021
*                                       NON-ACCEPTABLE MESSAGE  SA53086 25350021
*                                                                       25710021
*  TEST SECOND CSW STATUS BYTE FOR NON-ACCEPTABLE ERRORS;               25720021
*  PROGRAM CHECK, PROTECTION CHECK, CHANNEL DATA CHECK,                 25730021
*  CHANNEL CONTROL CHECK, INTERFACE CONTROL CHECK,                      25740021
*  CHAINING CHECK.                                                      25750021
*                                                                       25760021
         TM    K21(RWTG),ALLBITS-X80-X40  NON-ACCEPTABLE ERROR   A44814 25830021
         BNZR  RBASE                    YES BRANCH TO ABEND             25900002
         TM    K20(RWTG),X02            DOES UNIT CHECK EXIST    A44814 26000021
         BNO   EIN06600                 NO-BRANCH TO ERR OPT TEST       26100021
         TM    DCBDEVT,DCBDEVDA         DA USED                         26200021
         BNO   EIN06600                 NO-BRANCH TO ERR OPT TEST       26300021
*                                                                       26320021
*  TEST SENSE BYTES FOR NON-ACCEPTABLE ERRORS, THAT IS                  26340021
*  ANYTHING BUT A DATA CHECK (NOT IN COUNT FIELD).                      26360021
*                                                                       26380021
         TM    K10(RWTG),ALLBITS-X08    TEST FIRST SENSE BYTE    A44814 26400021
*                                       FOR NON ACCEPTABLE ERROR        26420021
         BNZR  RBASE                    YES BRANCH TO ABEND             26470002
         TM    K11(RWTG),ALLBITS        TEST SECOND SENSE BYTE   A44814 26560021
*                                       FOR NON-ACCEPTABLE ERROR        26620021
         BNZR  RBASE                    YES BRANCH TO ABEND             26670002
         EJECT                                                          26720002
EIN06600 EQU   *                        ERROR ACCEPTABLE-TEST DCBEROPT  26800002
         TM    DCBEROPT,DCBERACC+DCBERSKP  TEST USERS ERROR      A44814 26860021
*                                       OPTION FOR SKIP OR ACCEPT       26920021
         BM    EIN06700                 YES, EITHER SKIP OR      A44814 26980021
*                                       ACCEPT SPECIFIED, DO NOT ABEND  27040021
*                                                                       27100021
         LA    R7,MSG22F                GET ADDR OF IEC020I MSG         27200021
         BR    RBASE                    BRANCH TO ABEND                 27300002
         SPACE 2                                                        27400002
EIN06700 EQU   *                        SKIP OR ACCEPT I/O ERROR        27900002
*                                                                       27950002
         LR    RA,RC                    SAVE BAD ICB ADDR.     @ZA16052 28000037
         TM    DCBCIND2,DCBC2CHN        IS PCI BEING USED?     @ZA16052 28500037
         BO    EIN06725                 YES,DEFAULT TO ACCEPT  @ZA25479 29000037
         TM    DCBEROPT,X40             IS EROPT=SKP?          @ZA16052 29500037
         BO    EIN06800                 YES,NON PCI GO TO SKIP @ZA16052 30000037
EIN06725 EQU   *                        ACCEPT SECTION         @ZA16052 30500037
*                                                              @ZA16052 31000037
         MVI   K4(RC),ECBCOD7F          FLAG IOB AS COMPLETE     A43881 31560021
*                                       WITHOUT ERROR            A43881 31630021
*                                                                       31700021
         TM    K0(RC),IOBWRITE          IN WRITE STATUS                 31800021
         BO    EIN07700                 YES BRANCH                      31900021
*                                                                       32000021
         TM    DCBCIND2,DCBC2CHN        IS PCI BEING USED               32100021
         BO    EIN07800                 YES BRANCH TO PCI SECTION       32200021
         B     EIN07500                 NO,BRANCH TO GET NEXT IOB       32300021
         SPACE 2                                                        32400002
EIN06800 EQU   *                        SKIP ERROR OPTION               32500002
*                                                                       32600021
         TM    K0(RC),IOBWRITE          IN WRITE STATUS                 32700021
         LA    R7,MSG22F                GET ADDR OF IEC020I MSG         32800021
         BCR   1,RBASE                  YES - BRANCH                    32900021
*                                                                       33000021
*                                                                       33100021
         L     RWTG,K0(RC)              GET NEXT IOB                    33200021
*                                                                       33300021
         LA    RWTG,K0(RWTG)            CLEAR HI BYTE                   33400021
         EJECT                                                          33450002
*                                                                       33480021
*   IF NO SYNAD IS PRESENT WITH SKIP OPTION, REGS WERE NOT SAVED IN     33560021
*   USER SAVE AREA BY A PREVIOUS ENTRY.  MUST UPDATE SVRB SAVE AREA     33640021
*   DIRECTLY TO GIVE GERR THE CORRECT IOB TO WAIT ON.                   33720021
*                                                                       33800021
         TM    DCBSYNAD+K3,K1           IS SYNAD PRESENT                33900021
         BO    EIN06900                 NO-----BRANCH                   34000021
*                                                                       34100021
         ST    R6,K40(RD)               SAVE FOR GERR                   34200021
         B     EIN07000                 BR TO CHECK FOR PCI             34300021
*                                                                       34400021
EIN06900 EQU   *                        PUT IOB ADDR IN SVRB SAVEAREA   34500002
*                                                                       34600021
         MODESET EXTKEY=ZERO                                     Y02082 34650002
         ST    R6,K44(RET)              SAVE FOR GERR                   34700021
         MODESET KEYADDR=DXUKEY,WORKREG=1                        Y02082 34750002
*                                                                       34800021
EIN07000 EQU   *                        UPDATE IOBSEEK IF ONE IOB,      34900002
*                                       DA, NOT PCI, OR SEARCH DIRECT   34950002
*                                                                       35200021
         TM    DCBDEVT,DCBDEVDA         DA USED                         35300021
         BZ    EIN07100                 NO BRANCH                       35400021
*                                                                       35500021
         TM    DCBCIND1,BLANK           SEARCH DIRECT                   35600021
         BO    EIN07100                 YES BRANCH                      35700021
*                                                                       35800021
         CLC   K1(K3,RC),K1(R6)         MORE THAN ONE IOB               35900021
         BNE   EIN07100                 YES BRANCH                      36000021
*                                                                       36100021
         MVC   K40(K8,R6),DCBFDAD       PUT NEXT REC ADDR IN IOB        36200002
*                                                                       36300021
EIN07100 EQU   *                        BSAM SHOULDN'T BE HERE          36400002
*                                                                       36500021
         TM    DCBCIND2,DCBC2QSM        DCB USING QSAM                  36600021
         BZ    EIN07400                 NO BRANCH                       36700021
         EJECT                                                          37050002
EIN07200 EQU   *                        SETUP FOR EXCP FOR QSAM         37100002
*                                                                       37200021
         TM    DCBCIND2,DCBC2CHN        IS PCI BEING USED               37300021
         BO    EIN07800                 IF SO, BRANCH TO PCI SECTION.   37400021
         TM    DCBDEVT,DCBDVPR1         DCB USING PRINTER?      SA67189 37401002
         BNO   EIN07210                 NO, BRANCH              SA67189 37402002
         TM    DCBDEVT,X10              IS DCB A PRINTER?       SA67189 37403002
         BNO   EIN07233                 YES, BRANCH             SA67189 37404002
*                                                               SA67189 37405002
EIN07210 EQU   *                        NOT A PRINTER           SA67189 37406002
*                                                               SA67189 37407002
         XC    DCBIOBA+K1(K3),DCBIOBA+K1  CLEAR ADDRESS FIELD IOBA      37500021
         B     EIN07267                 BR, ISSUE EXCP          SA67189 37500702
*                                                               SA67189 37501402
EIN07233 EQU   *                        OPENED TO PRINTER       SA67189 37502102
*                                                               SA67189 37502802
         LA    RC,K0(RC)                CLEAR HIGH BYTE         SA67189 37503502
         LR    R6,RC                    COPY IOB ADDRESS        SA67189 37504202
         B     EIN07550                 PROCESS NEXT IOB        SA67189 37504902
*                                                               SA67189 37505602
EIN07267 EQU   *                        NOT A PRINTER           SA67189 37506302
*                                                               SA67189 37507002
         O     RC,DCBIOBA               FLAGS TO REG HI BYTE            37600021
         ST    RC,DCBIOBA               SAVE THIS IOB ADDRESS IN DCB    37700021
         L     RC,K0(RC)                GET NEXT IOB IN CHAIN           37800021
         LA    RC,K0(RC)                H1 BYTE CLEARED                 37900021
EIN07300 EQU   *                        RESCHEDULE IOB                  38000002
         LR    R6,RC                    COPY IOB ADDRESS                38100021
*                                                                       38200021
*        REG 7 = 16 ENTRY POINT - BSAM PRINTER                          38250002
*                                                                       38260002
EIN07400 EQU   *                        ISSUE EXCP                      38300002
*                                                                       38400021
         LA    R1,K8(R6)                LOAD ADDRESS OF IOB FOR EXCP    38500021
*                                                                       38600021
         EXCP  (1)                                                      38700021
*                                                                       38800021
*        REG 7 = 8 ENTRY POINT - BSAM NON-PCI                           38850002
*                                                                       38860002
EIN07500 EQU   *                        QSAM-ACCEPT NON-PCI             38900002
*                                                                       39000021
         TM    DCBCIND2,DCBC2QSM        IS QSAM BEING USED              39100021
         BZ    EIN07675                 NO,BRANCH OUT           SA53086 39200021
*                                                               SA67189 39200702
EIN07550 EQU   *                        PROCESS NEXT IOB        SA67189 39201402
*                                                               SA67189 39202102
         L     R6,K0(R6)                GET NEXT IOB IN CHAIN           39300021
         LA    R6,K0(R6)                CLEAR BYTE H1                   39400021
         TM    DCBEROPT,X80             ACC OPTION USED                 39500021
         BO    EIN07600                 YES, BRANCH                     39600021
         TM    DCBCIND1,BLANK           SEARCH DIRECT                   39700021
         BO    EIN06100                 BR TO PROCESS IOB               39800021
EIN07600 EQU   *                        SCHEDULE IF NOT ALREADY         39900002
         CR    RC,R6                    HAS IOB BEEN SCHEDULED          39950002
         BNE   EIN07400                 NO BRANCH TO SCHEDULE IT        40000021
         B     EIN05900                 RETURN TO GERR/PERR/CHECK       40300021
         EJECT                                                          40300402
*                                                                       40302021
*     FOR BSAM, NON CHAINED SCHEDULING RESTART IO FROM THE IOB  SA53086 40310021
*     AFTER THE ONE IN ERROR UP TO AND INCLUDING THE LAST ONE   SA53086 40320021
*     ISSUED.                                                   SA53086 40330021
*                                                                       40340021
*     IF AN IOB HAS BIT 4 IN THE IOB PREFIX SET TO ONE, THE IOB  YM7557 40342002
*     REPRESENTS A READ WHEN LABEL OVERRIDE (,,,OUT) IS          YM7557 40344002
*     SPECIFIED, OR A WRITE WHEN LABEL OVERRIDE (,,,IN) IS       YM7557 40346002
*     SPECIFIED. IN EITHER CASE THE ECB IS ALREADY POSTED AND    YM7557 40348002
*     WILL NOT BE RESCHEDULED. THE PERMANENT ERROR FLAGS ARE     YM7557 40348402
*     SET AND NO FURTHER IOBS WILL BE RESCHEDULED.               YM7557 40348802
*                                                                       40349202
EIN07650 EQU   *                        EXCP IOB                        40350002
         TM    K0(RWTG),X08             INVALID REQUEST          YM7557 40352002
         BZ    EIN07655                 BRANCH IF NOT            YM7557 40354002
         OI    DCBIFLGS,X40+X80         SET PERMANENT ERROR FLGS YM7557 40356002
         B     EIN05900                 RETURN                   YM7557 40358002
EIN07655 EQU   *                        SCHEDULE IOB             YM7557 40360002
         LA    R1,K8(RWTG)               ADDR OF IOB FOR EXCP   SA53086 40380021
         EXCP  (1)                       ISSUE EXCP             SA53086 40390021
         CR    R6,RC                     LAST TO BE SCHEDULED   SA53086 40392021
         BE    EIN05900                  YES, RETURN            SA53086 40394021
EIN07675 EQU   *                        TEST IF MORE                    40394402
         L     RWTG,0(RWTG)              NEXT IOB TO START      SA53086 40396021
         LA    RWTG,0(RWTG)              CLEAR HIGH BYTE        SA53086 40396421
         B     EIN07650                  BRANCH TO RESTART      SA53086 40398021
*                                                                       40400021
**********************************************************************  40500021
*                                                                       40600021
EIN07700 EQU   *                        QSAM SKIP OUTPUT ERROR          40700002
*                                       ABEND UNLESS PRINTER DEVICE     40750002
         LA    R7,MSG22F                GET ADDR OF IEC020I MSG         40800021
*                                                                       40900021
         TM    DCBDEVT,K72              DCB USING PRINTER               41000021
         BNOR  RBASE                    NO - BRANCH                     41100002
*                                                                       41200021
         CLI   K12(RC),X40+X04          WAS IOB INTERCEPTED             41300002
         BE    EIN07300                 YES BR TO RESCHEDULE IT         41400021
         B     EIN07200                 NO BR TO RESCHEDULE NEXT        41500021
         EJECT                                                          41600002
*                                                                       41650002
*        REG 7 = 12 ENTRY POINT - BSAM PCI                              41700002
*                                                                       41750002
EIN07800 EQU   *                        RESET FLAGS IN MAIN IOB PREFIX  42000002
         L     R8,DCBIOBAD              GET MAIN IOB.            A49379 42200021
*                                                                       42600021
         MVI   K24(R8),K0               SET FLAG 3 TO ZERO       A49379 42700021
         MVI   K17(R8),K0               CLEAR FLAG2            @ZA01339 42750000
         NI    K16(R8),IOBDATCH+IOBCMDCH  RESET FLAG1          @ZA01339 42800000
*                                                                       42900021
*                                                                       43000037
*                                                                       43200037
*    ICB'S WILL BE RESTARTED ONLY IF TIC'ED ON TO NEXT ICB     @ZA16052 43400037
*    INDICATING USER HAS MORE THAN ONE UNCHECKED I/O REQUEST. 19CU      43600021
*    UPDATES SO THAT LAST NOP LINKS TO ICB IN ERROR IF RESTART IS       43700021
*    NECESSARY. IF ICB IN ERROR AND LAST NOP ARE SAME THEN THERE ARE    43800021
*    NOT ANY OUTSTANDING REQUESTS,(I.E.,ICB IN ERROR WAS LAST IN        43900021
*    CHAIN AND THEREFORE DID NOT TIC TO NEXT ICB).                      44000021
*       FOR BSAM,                                              @ZA16052 44100037
*     IF THE FIRST ICB TO BE SCHEDULED HAS BIT 4 IN THE ICB      YM7557 44102002
*     PREFIX SET TO ONE, THE ICB                                 YM7557 44102102
*     REPRESENTS A READ WHEN LABEL OVERRIDE (,,,OUT) IS          YM7557 44104002
*     SPECIFIED, OR A WRITE WHEN LABEL OVERRIDE (,,,IN) IS       YM7557 44106002
*     SPECIFIED. IN EITHER CASE THE ECB IS ALREADY POSTED AND    YM7557 44108002
*     THE MAIN IOB WILL NOT BE EXCPED.                           YM7557 44110002
*                                                                       44114002
         MVI   K4(R8),ECBCOD7F          SET THE MAIN IOB'S ECB   A49379 44150021
*                                       COMPLETE AS EOB ROUTINE  A49379 44160021
*                                       MAY TRY TO JOIN RATHER   A49379 44170021
*                                       THAN RESTARTING ICB'S    A49379 44180021
*                                                              @ZA16052 44182037
         TM    DCBCIND2,DCBC2QSM        IF QSAM,               @ZA16052 44183037
         BC    1,EIN07925               GO EXCP                @ZA16052 44184037
*                                                              @ZA16052 44185037
         L     R6,K0(RC)                GET NEXT ICB             YM7557 44186037
         TM    K0(R6),X08               INVALID REQUEST          YM7557 44187037
         BO    EIN05900                 BRANCH IF YES            YM7557 44188037
*                                                              @ZA16052 44189037
EIN07925 EQU   *                        EXCP                   @ZA16052 44190037
*                                                              @ZA16052 44191037
         L     R6,K12(R8)               GET POINTER TO ICB WITH  A49379 44200021
         SR    R9,R9                      LAST NOP.                     44300021
         IC    R9,K2(R8)                GET NOP OFFSET           A49379 44400021
         SR    R6,R9                    SUBTRACT NOP OFFSET             44500021
         LA    RC,K0(RC)                ZERO HIGH BYTE BAD ICB   A49379 44800021
         LA    R6,K0(R6)                ZERO HIGH BYTE                  44900021
         EJECT                                                          44950002
*                                                                A49379 45000021
*        IF THE ICB THAT ENDS THE CHAIN, POINTED TO BY THE LAST  A49379 45050021
*        NOP POINTER IN THE MAIN IOB, IS THE SAME AS THE ICB IN  A49379 45100021
*        ERROR THEN THE ERROR OCCURRED ON THE LAST REQUEST IN    A49379 45150021
*        THE CHAIN, THEREFORE DON'T RESTART.                     A49379 45200021
*                                                                A49379 45250021
         CR    RC,R6                    COMPARE BAD ICB WITH ICB A49379 45300002
*                                       WITH LAST NOP WHICH IS   A49379 45350002
*                                       LAST ICB IN THE CHAIN    A49379 45360002
         BE    EIN05900                 BR IF ERROR ICB IS LAST  A49379 45400002
*                                       IN CHAIN, DON'T RESTART  A49379 45450002
EIN07950 EQU   *                        YES,ISSUE EXCP                  45500002
         MVI   K4(R8),K0                SET MAIN IOB NOT         A49379 45600002
*                                       COMPLETE                        45700002
         LA    R8,K16(R8)               GET IOS' IOB.            A49379 45800002
*                                                                       45900021
         EXCP  (R8)                                              A49379 46000021
*                                                                       46100021
         B     EIN05900                 BR TO GERR/PERR/CHECK           46200002
         EJECT                                                          46300002
         EJECT                                                          48930002
**********************************************************************  48960021
**********                     CONSTANTS                    **********  48990021
**********************************************************************  49020021
*                                                                       49050021
CON322F  DC    H'32'                    CONSTANT OF 32                  49100021
MSG22F   DC    AL2(ENDMS22F-*)          ERROR MESSAGE                   49600021
         DC    AL2(4)                   IEC020I INVLD/NO SYNAD SPECIFED 49700021
         DC    C'IEC020I DCB EROPT=ABE OR AN ' MSG PART 1               49800002
         DC    C'INVALID CODE, AND/OR ' MSG PART 2                      49850002
         DC    C'NO SYNAD EXIT SPECIFIED' MSG PART 3             A39511 49900002
ENDMS22F EQU   *                        END OF MSG                      49910002
         SPACE 2                                                        49910402
EIGHTCON DC    H'8'                     CONSTANT OF 8                   49912002
CONREGMN DS    0F                       USER SAVEAREA SP, LENGTH M0135  49920002
         DC    AL1(250)                 SUBPOOL VALUE            M0135  49940021
         DC    AL3(K72)                 LENGTH VALUE             M0135  49960021
         EJECT                                                          49980002
XCTLTA2F XCTLTABL ID=(MOD2E2F,1D,ERRNAME,IFG0551D),SVC=055,      Y02080X50250002
               BRT=YES,LENGTH=                                   Y02080 50270002
         IECDSECS  DCB,UCB,CVT,RB,MAIN,WTG,PREFX,EXPAND=YES      Y02080 50300002
IOBDATCH EQU   X'80'                    DATA CHAIN             @ZA01339 50310000
IOBCMDCH EQU   X'40'                    COMMAND CHAIN          @ZA01339 50320000
         IECEQU                                                         50400021
         END                                                            50500021
