         TITLE 'IFG0551R - EOV TAPE OUTPUT TRAILER LABEL 2 PREPARATION' 00100021
         COPY  LCGASMSW                                                 00200000
IFG0551R CSECT                                                          00400021
*********************************************************************** 00450002
*                                                                     * 00500002
*                                                                     * 00550002
*          VS2 RELEASE 02 DELETIONS                                   * 00600002
*                                                                     * 00650002
*                                                                     * 00700002
*********************************************************************** 00750002
*          VS2 RELEASE 037 DELETIONS/ADDITIONS                        * 00757037
*                                                                     * 00761037
*0000                                                         @ZA10242* 00765037
*0000                                                         @ZA19724* 00769037
*C252790-252796,252850-252882,252898-252906                   @ZA24994* 00773037
*********************************************************************** 00785037
*                                                                     * 00792037
*                                                                     * 00800002
* MODULE NAME = IFG0551R (OS/VS2)                                     * 00850002
*                                                                     * 00900002
* DESCRIPTIVE NAME = TAPE OUTPUT TRAILER LABEL 2                      * 00950002
*                                                                     * 01000002
* COPYRIGHT = NONE                                                    * 01050002
*                                                                     * 01100002
* STATUS = RELEASE 2, LEVEL 0                                         * 01150002
*                                                                     * 01200002
* FUNCTION =                                                          * 01250002
*        1) WAIT FOR WRITE TO COMPLETE (TRAILER 1) WHICH WAS INITIATED* 01300002
*        IN PREVIOUS MODULE (551P).                                   * 01350002
*        2) CONSTRUCT TRAILER LABEL 2 FROM INFORMATION IN THE JFCB,   * 01400002
*        TIOT, DCB, UCB, ETC..                                        * 01450002
*        3) IF ASCII WAS SPECIFIED, TRANSLATE THE LABEL TO ASCII.     * 01500002
*        4) WRITE TRAILER LABEL 2.                                    * 01550002
*        5) IF USER LABELS ARE SPECIFIED IN THE JFCB, SEARCH THE      * 01600002
*        CALLER'S EXIT LIST FOR AN ACTIVE USER LABEL EXIT.            * 01650002
*        6) IF NO USER LABELS ARE SPECIFIED, OR IF NO ACTIVE USER     * 01700002
*        LABEL EXIT EXISTS, OR UPON COMPLETION OF USER LABEL PRO-     * 01750002
*        CESSING, CONTROL IS PASSED TO IFG0551T.                      * 01800002
*        7) FOR USER LABEL PROCESSING, 2 WORK AREAS ARE OBTAINED      * 01850002
*        FROM FETCH PROTECTED SUBPOOL 229 CORE. A 152 BYTE AREA IS    * 01900002
*        GOTTEN FOR EOV IN KEY 5 AND A 96 BYTE AREA IS GOTTEN FOR     * 01950002
*        THE CALLER IN THE CALLER'S PROTECT KEY. THE IECRES UEXIT     * 02000002
*        MACRO IS USED TO PASS CONTROL TO THE CALLER'S USER LABEL     * 02050002
*        ROUTINE TO ENABLE THE CALLER TO FORMAT HIS OUTPUT LABEL.     * 02100002
*        8) UPON RETURN FROM THE CALLER'S USER LABEL ROUTINE, A       * 02150002
*        RETURN CODE IS EXAMINED AS FOLLOWS:                          * 02200002
*        0 - DO NOT WRITE CURRENT LABEL AND DISCONTINUE USER LABEL    * 02250002
*        PROCESSING.                                                  * 02300002
*        4 - WRITE CURRENT LABEL AND DISCONTINUE USER LABEL PROC      * 02350002
*        8 - WRITE CURRENT LABEL AND CONTINUE USER LABEL PROC.        * 02400002
*        9) THE CALLER MAY WRITE UP TO 8 USER LABELS (THE LIMIT       * 02450002
*        DOES NOT APPLY TO ASCII). ALSO, ASCII LABELS ARE             * 02500002
*        TRANSLATED BEFORE BEING WRITTEN.                             * 02550002
*        10) IF AN I/O ERROR OCCURS WHILE WRITING TRAILER LABEL 2     * 02600002
*        OR USER LABELS, PROBLEM DETERMINATION IS GIVEN CONTROL       * 02650002
*        WITH AN INTERNAL CODE OF 141.                                * 02700002
*                                                                     * 02750002
* NOTES = SEE BELOW                                                   * 02800002
*                                                                     * 02850002
*    DEPENDENCIES =                                                   * 02900002
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 02950002
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 03000002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 03050002
*                                                                     * 03100002
*    RESTRICTIONS = NONE                                              * 03150002
*                                                                     * 03200002
*    REGISTER CONVENTIONS =                                           * 03250002
*            R2 POINTS TO DCB                                         * 03300002
*            R4 POINTS TO OPEN WORK AREA                              * 03350002
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 03400002
*            R6 POINTS TO THE WTG TABLE                               * 03450002
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 03500002
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 03550002
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 03600002
*            R10 POINTS TO THE UCB                                    * 03650002
*                                                                     * 03700002
*    PATCH LABEL = SEE THIRD FROM LAST LABEL BEFORE ORG STATEMENT AT  * 03750002
*                  END OF LISTING.                                    * 03800002
*                                                                     * 03850002
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 03900002
*                                                                     * 03950002
*    PROCESSOR = ASSEMBLER XF                                         * 04000002
*                                                                     * 04050002
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 04100002
*                  ORG STATEMENT AT END OF LISTING                    * 04150002
*                                                                     * 04200002
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 04250002
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 04300002
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 04350002
*                                                                     * 04400002
* ENTRY POINT =                                                       * 04450002
*        IFG0551R                                                     * 04500002
*                                                                     * 04550002
*    PURPOSE = SEE FUNCTION                                           * 04600002
*                                                                     * 04650002
*    LINKAGE =                                                        * 04700002
*        THIS MODULE IS TRANSFERRED CONTROL THROUGH THE IECRES-LOAD   * 04750002
*        MACRO INSTRUCTION.                                           * 04800002
*                                                                     * 04850002
* INPUT =                                                             * 04900002
*        GIVEN CONTROL IN PROTECT KEY 5.                              * 04950002
*        REGISTER 2 POINTS TO THE COPIED DCB.                         * 05000002
*        DEBDCBAD POINTS TO THE COPIED DCB.                           * 05050002
*        REGISTER 4 POINTS TO THE EOV WORKAREA                        * 05100002
*                                                                     * 05150002
* OUTPUT =                                                            * 05200002
*        THE NEXT MODULE IS GIVEN CONTROL IN PROTECT KEY 5 WITH       * 05250002
*        REGISTER 2 POINTING TO THE COPIED DCB,                       * 05300002
*        DEBDCBAD POINTING TO THE COPIED DCB,                         * 05350002
*        AND REGISTER 4 POINTING TO THE EOV WORKAREA,                 * 05400002
*                                                                     * 05450002
* EXIT-NORMAL =                                                       * 05500002
*        IFG0551T - VOLUME DISPOSITION, BRANCH CODE = 0               * 05550002
*                                                                     * 05600002
* EXIT-ERROR =                                                        * 05650002
*        IFG0550P - PROBLEM DETERMINATION, I/O ERROR, INT CODE=141    * 05700002
*                                                                     * 05750002
* EXTERNAL REFERENCES = SEE BELOW                                     * 05800002
*                                                                     * 05850002
*    ROUTINES =                                                       * 05900002
*        IFG019RA THROUGH THE IECRES MACRO.                           * 05950002
*                                                                     * 06000002
*    DATA AREAS =                                                     * 06050002
*        EOV WORKAREA.                                                * 06100002
*                                                                     * 06150002
*    CONTROL BLOCK =                                                  * 06200002
*        CVT                                                          * 06250002
*        DEB                                                          * 06300002
*        JFCB                                                         * 06350002
*        UCB                                                          * 06400002
*        TCB                                                          * 06450002
*        TIOT                                                         * 06500002
*        DSAB                                                         * 06550002
*        PSA                                                          * 06600002
*        RB                                                           * 06650002
*                                                                     * 06700002
* TABLES =                                                            * 06750002
*                                                                     * 06800002
* MACROS =                                                            * 06850002
*        MODESET                                                      * 06900002
*        IECRES LOAD                                                  * 06950002
*        IECRES GET                                                   * 07000002
*        IECRES FREE                                                  * 07050002
*        IECRES UEXIT                                                 * 07100002
*        IECRES INIT                                                  * 07150002
*        EXCP                                                         * 07200002
*        WAIT                                                         * 07250002
*        DMABCOND                                                     * 07300002
*                                                                     * 07350002
* CHANGE ACTIVITY =                                                   * 07400002
*        SEE CHANGES/DELETIONS SECTION JUST AFTER CSECT CARD.         * 07450002
*                                                                     * 07500002
*********************************************************************** 07550002
         EJECT                                                          07600002
*********************************************************************** 13300021
CHARC    EQU   C'C'                     CHARACTER C              Y02083 13350002
ETOCHAR9 EQU   X'F9'                    CHARACTER NINE (9)              13360002
         SPACE 1                                                        13400021
*                   ADDRESSABILITY                                      13500021
         SPACE 1                                                        13600021
         BALR  RBASE,0                  ESTABLISH BASE                  13700021
         USING *,RBASE                                                  13800021
         USING FORCORE,RCORE                                            13900021
         USING IHADCB,RDCB                                              14000021
         USING DEB,RDEB                                                 14100021
         USING SRT,RUCB                                                 14200021
         BAL   R8,ETO04700              GO WAIT FOR EOV1 TO COMPLETE    14300021
         BNO   ETO04900                 BR IF I/O ERROR                 14400021
         OI    DXATOUTA,DXATTRL1        TRL1 LABEL WRITTEN       Y02144 14450002
*                   PREPARE DATA SET TRAILER LABEL 2                    14500021
         SPACE 1                                                        14600021
         MVI   FL1NO,CHAR2              SET FILE LABEL IDENTIFIER TO 2  14700021
         MVI   FL2TRTCH,BLANK           SET PART OF LABEL TO            14800021
         MVC   FL2TRTCH+K1(K45),FL2TRTCH  BLANKS - 47 CHARACTERS        14900021
         SPACE 1                                                        15000021
*                  BLOCKING ATTRIBUTE                                   15100021
         SPACE 1                                                        15200021
         SR    R7,R7                    CLEAR WORK REGISTER             15300021
         IC    R7,JFCRECFM              PICK UP RECORD FORMAT FROM THE  15400021
         SRL   R7,K3                    BITS 0,1 CONTAIN BLK ATTRIBUTE  15500021
         STC   R7,DXLBL+K38             ZERO ALL BUT BITS 0,1 TO        15600021
         NI    DXLBL+K38,K3             PREPARE FOR TRANSLATE           15700021
         TR    DXLBL+K38(K1),ABLKA9E    TRANSLATE TO S,B,R, OR BLANK    15800021
*                                                                       15900021
*                  RECORD FORMAT                                        16000021
         TM    DCBRECFM,JFCVARD         FORMAT D RECORDS                16100021
         BZ    ETO02000                 NO, BRANCH                      16200021
         MVI   FL2RECFM,CHARD           MOVE D-FORMAT TO LABEL          16300021
         B     ETO02100                 GO MOVE BLOCK SIZE              16400021
ETO02000 EQU   *                        NOT FORMAT D RECORDS            16500002
         SRL   R7,K3                    BITS 0,1 CONTAIN RECORD FORMAT  16600021
         STC   R7,FL2RECFM              F = BIT 0  V = BIT 1  U = BITS  16700021
         TR    FL2RECFM,ARECFM9E        TRANSLATE TO V,F OR U           16800021
         SPACE 1                                                        16900021
*                   BLOCK SIZE AND LOGICAL RECORD LENGTH                17000021
ETO02100 EQU   *                        SET BLKSIZE AND LRECL           17100002
         SPACE 1                                                        17200021
         L     R1,DXDSAB                ADR OF DSAB              Y02083 17250002
         USING DSAB,R1                                           Y02083 17260002
         TM    DSABFLG4,DSABCKDS        CHK PT DS IND ON IN DSAB Y02083 17270002
         BNO   ETO02110                 NO                       Y02083 17280002
         MVI   FL2DSIND,CHARC           SET CHK PT IND IN LABEL  Y02083 17290002
         MODESET EXTKEY=SCHED                                    Y02083 17290402
         NI    DSABFLG4,X'FF'-DSABCKVL  RESET CHK PT IND         Y02083 17292002
         MODESET EXTKEY=DATAMGT                                  Y02083 17292402
         DROP  R1                                                Y02083 17294002
ETO02110 EQU   *                        INSTR MUST FOLLOW        Y02083 17296002
         LH    R1,JFCBLKSI              PICK UP BLOCK LENGTH            17300021
         CVD   R1,DXCCW2                CONVERT BLOCK LENGTH TO DECIMAL 17400021
         UNPK  FL2BLKL,DXCCW2           BLOCK LENGTH IN EBCDIC TO LABEL 17500021
         OI    FL2BLKL+K4,ZONEOF        REMOVE SIGN BITS                17600021
         LH    R1,JFCLRECL              PICK UP LOGICAL RECORD LENGTH   17700021
         CH    R1,AGRTR39E              IS LRECL INDIC GRTR 32K         17800021
         BE    ETO02200                 BR TO SET LABEL TO 9'S          17900021
         CVD   R1,DXCCW2                CONVERT LOGICAL REC LEN TO DEC  18000021
         UNPK  FL2LRECL,DXCCW2          LOG RECORD LEN IN EBCDIC TO LBL 18100021
         OI    FL2LRECL+K4,ZONEOF       REMOVE SIGN BITS                18200021
         B     ETO02300                 BRANCH TO CHK DUAL DENSITY      18300021
ETO02200 EQU   *                        SET LRECL TO NINES              18400002
         MVI   FL2LRECL,ETOCHAR9        SET LRECL TO 9'S                18500002
         MVC   FL2LRECL+K1(K4),FL2LRECL  INDICATING GRTR 32K            18600021
         SPACE 1                                                        18700021
ETO02300 EQU   *                        CHECK FOR DUAL DENSITY          18800002
         TM    UCBTBYT2,UCBDDMSK        DUAL DENSITY UNIT         99223 18900002
         BNM   ETO02400                 NO, BRANCH                99223 19000002
         TM    DEBOPATB,K4              INOUT PROCESSING                19100021
         BO    ETO02400                 BR IF NO                        19200021
         LA    R0,DXCCW3                PREPARE                         19300021
         ST    R0,DXCCW1                FOR                             19400021
         MVI   DXCCW1,CCWSENSE          SENSE COMMAND                   19500021
         MVC   DXCCW1+K4(K4),SEN89E     LENGTH 8 BYTES, SILI      99223 19600002
         XC    DXCCW3(K8),DXCCW3        CLEAR SENSE AREA          99223 19650002
         BAL   R8,ETO04600              GO TO PERFORM SENSE OPERATION   19700021
         TM    UCBTBYT2,PE              PHASE-ENCODED UNIT        99223 19710002
         BO    ETO02350                 YES,GO SET 1600/800 BPI   99223 19720002
         MVI   FL2DEN,CHAR4             SET DENSITY TO 6250 BPI   99223 19730002
         TM    DXCCW3+K6,X10            ALT DENSITY SET IN UNIT   99223 19740002
         BNO   ETO02500                 NO,MUST BE 6250           99223 19750002
         MVI   FL2DEN,CHAR3             YES,MUST BE 1600 BPI      99223 19760002
         B     ETO02500                 GO SET FILE POSITION      99223 19770002
ETO02350 EQU   *                        CHECK FOR 1600 OR 800 BPI 99223 19780002
         MVI   FL2DEN,CHAR3             SET DENSITY IN LABEL TO 1600    19800021
         TM    DXCCW3+K3,K4             IS DENSITY ON UNIT 1600         19900021
         BO    ETO02500                 BR IF YES-DENSITY MERGE IS COMP 20000021
         MVI   FL2DEN,CHAR2             SET DENSITY IN LABEL TO 800     20100021
         B     ETO02500                 DENSITY MERGE IS COMPLETE       20200021
ETO02400 EQU   *                        NOT INOUT                       20300002
         MVI   FL2DEN,CHAR4             SET DENSITY TO 6250 BPI   99223 20310002
         CLI   JFCDEN,DCBD6250          6250 BPI SPECIFIED        99223 20320002
         BE    ETO02500                 YES,CONTINUE              99223 20330002
         IC    R7,JFCDEN                GET DENSITY FROMJFCB            20400021
         SRL   R7,K6                    SHIFT TO LOW BITS               20500021
         STC   R7,FL2DEN                STORE IN LBL                    20600021
         OI    FL2DEN,ZONEOF            OR IN ZONE                      20700021
ETO02500 MVI   FL2FILP,ZONEOF           SET FILE POSITION TO ZERO       20800021
         CLC   UCBVOLI,JFCBVOLS         IS THIS THE FIRST VOL OF DS     20900021
         BE    ETO02600                 YES, LEAVE FILE POS IND 0       21000021
         MVI   FL2FILP,CHAR1            NO,SET FILE POSITION INDICATOR  21100021
ETO02600 L     R7,DEBTCBAD              REESTABLISH THE ADDRESS OF THE  21200021
         L     R7,TCBTIO-TCB(K0,R7)     START OF THE TIOT               21300021
         MVC   FL2JOBD,TIOCNJOB-TIOT(R7)  PLACE JOB/STEP IDENTIFICATION 21400021
         MVI   FL2JSSP,SLASH            (INSERT SLASH)                  21500021
         MVC   FL2STEPD,TIOCSTEP-TIOT(R7)  FROM THE TIOT TO LABEL       21600021
         SPACE 1                                                        21700021
*                   TAPE RECORDING TECHNIQUE                            21800021
         SPACE 1                                                        21900021
         SR    R7,R7                    CLEAR WORK REGISTER             22000021
         IC    R7,JFCTRTCH              PICK UP TAPE RECORDING TECH     22100021
         SRL   R7,K4                    13=C, 23=E , 2B=ET, 0=BLANK     22200021
         STC   R7,FL2TRTCH              PLACE FIRST CHARACTER OF TRTCH  22300021
         TR    FL2TRTCH(K1),ATRTCH9E    THE LABEL AS BLANK,C,E OR T     22400021
         CLI   JFCTRTCH,DCBTRTET        IS IT BOTH EVEN PARITY AND TRAN 22500021
         BNE   ETO02700                 NO,THE SECOND CHAR S/B BLANK    22600021
         MVI   FL2TRTCH+K1,CHART        YES,TAPE REC TECH SHOULD BE T   22700021
         SPACE 1                                                        22800021
*                   CARRIAGE CONTROL CHARACTER SET                      22900021
         SPACE 1                                                        23000021
ETO02700 TM    JFCRECFM,DCBRECCM        JFCB SPEC MACH CODE CTL CHAR    23100021
         BNO   ETO02800                 NO,GO SEE IF ASA CONTROL CHAR   23200021
         MVI   FL2CNTRL,CHARM           YES,SET MACHINE CODE CTL CHAR   23300021
ETO02800 TM    JFCRECFM,DCBRECCA        JFCB SPECIFY ASA CONTROL CHAR   23400021
         BNO   ETO02900                 NO,DO NOT SET UP CARRIAGE CTL   23500021
         MVI   FL2CNTRL,CHARA           YES,SET CONTROL CHAR TO ASA     23600021
ETO02900 EQU   *                        CHECK FOR USASI                 23700002
*                                                                     * 23800021
*  IF CREATING A USASI LABEL, MERGE BUFFER OFFSET AND TRANSLATE LABEL * 23900021
*                                                                     * 24000021
         TM    JFCBLTYP,JFCBAL          IS THIS A USASI LABEL           24100021
         BNO   ETO02950                 NO,BRANCH/WRITE LABEL     99223 24200002
         SR    R7,R7                    CLEAR REGISTER                  24300021
         IC    R7,JFCBUFOF              GET BLOCK PREFIX LENGTH         24400021
         N     R7,BITOFF9E              TURN OFF BUFOFF=L BIT           24500021
         CVD   R7,DXCCW3                CONVERT LENGTH TO               24600021
*                                       DECIMAL                         24700021
         UNPK  FL2BUFOF(K2),DXCCW3+K6(K2)  UNPACK LENGTH TO LABEL       24800021
         OI    FL2BUFOF+K1,ZONEOF       CHANGE SIGN CODE                24900021
         MVC   FL1LABI,AEOV             MOVE IN EOV CHARACTERS          25000021
         XLATE DXLBL,K80,TO=A           TRANSLATE LABEL TO ASCII        25100021
         B     ETO03000                 GO WRITE LABEL 2          99223 25110002
         SPACE 1                                                        25200021
ETO02950 EQU   *                        CHECK FOR TAPE UNIT ID    99223 25210002
         CLI   UCBTBYT4,UCB3400         TEST FOR 3400 DRIVE      YM1491 25220002
         BNE   ETO03000                 NO,GO WRITE LABEL        YM1491 25230002
         L     R7,UCBEXTPT              GET UCB EXTEN PTR        Y02146 25240002
         CLI   UCBSNSCT-UCBCMEXT(R7),K24 IS THIS 3420 TAPE UNIT  Y02146 25242002
         BNE   ETO03000                 NO,GO WRITE LABEL         99223 25250002
         L     R7,UCBXTN                GET UCB EXTENSION ADDR    99223 25260002
         USING UCBMT,R7                                           99223 25262002
         LH    R7,UCBCTD                GET ID OF CREATING DRIVE  99223 25270002
         N     R7,SNMASK                CLEAR HI ORDER         @ZA13576 25272037
         DROP  R7                                                 99223 25273037
         CVD   R7,DXCCW3                CONVERT ID TO DECIMAL     99223 25274037
         UNPK  FL2ID,DXCCW3             UNPACK ID TO EBCDIC       99223 25275037
         OI    FL2ID+K4,ZONEOF          REMOVE SIGN BITS          99223 25276037
* GET THE MODEL NO. FROM THE SIXTH SENSE BYTE AND                       25277037
* PLACE IT IN THE LABEL.                                                25278037
         LA    R7,DXCCW3                GET AREA ADDRESS       @ZA24994 25279037
         ST    R7,DXCCW1                PUT AREA ADR. IN CCW   @ZA24994 25279637
         MVC   DXCCW1+K4(K4),SEN89E     SILI AND COUNT         @ZA13576 25281037
         MVI   DXCCW1,CCWSENSE          SENSE CMD CODE         @ZA13576 25282037
         BAL   R8,ETO04600              ISSUE SENSE CMD.       @ZA13576 25283037
         BZ    ETO04900                 BR. IF IO ERROR        @ZA13576 25284037
         IC    R7,DXCCW3+K6             GET SIXTH SNS BYTE     @ZA24994 25285037
         SLL   R7,K28                   CLEAR RB EXCEPT FOR    @ZA24994 25285837
         SRL   R7,K28                   HALF BYTE SER NUMBER   @ZA24994 25286637
         IC    R7,CHARTBL(R7)           GET CHAR. FROM TABLE   @ZA24994 25287437
         STC   R7,FL2ID                 PLACE MOD NO. IN LBL.  @ZA24994 25288237
*            RESET CCW TO WRITE LABEL                          @ZA13576 25289037
         LA    R7,DXLBL                 GET AREA ADDR.         @ZA24994 25289837
         ST    R7,DXCCW1                PUT AREA ADR. IN CCW   @ZA24994 25290637
         MVI   DXCCW1,CCWWRTAP          INSERT WRITE OP CODE   @ZA13576 25293037
         MVC   DXCCW1+K4(K4),LENGTH     SILI AND LNGTH OF 80   @ZA13576 25294037
*                   WRITE END OF VOLUME FILE LABEL 2                    25300021
ETO03000 EQU   *                        WRITE EOV2 LABEL                25400002
         SPACE 1                                                        25500021
         BAL   R8,ETO04600              GO WRITE FILE LABEL 2           25600021
         BNO   ETO04900                 IF I/O ERROR,GO ABEND           25700021
         OI    DXATOUTA,DXATTRL2        TRL2 LABEL WRITTEN       Y02144 25750002
         SPACE 1                                                        25800021
*                   SEE IF USER LABELS ARE TO BE PROCESSED              25900021
         SPACE 1                                                        26000021
         TM    JFCBLTYP,JFCBUL          USER LABELS SPECIFIED           26100021
         BZ    ETO03300                 NO, BRANCH TO EXIT              26200021
         TM    DCBMACRF,DCBMEXCP        IS THIS EXCP                    26300021
         BZ    ETO03100                 NO, GO                          26400021
         TM    DCBMACRF,DCBMFOUN        DOES EXCP DCB HAVE FOUND. EXT.  26500021
         BZ    ETO03300                 NO, GO                          26600021
ETO03100 EQU   *                        CHECK EXIT LIST                 26700002
         L     R7,DCBEXLST              PICK UP EXIT LIST FROM DCB      26800021
         LA    R7,K0(K0,R7)             ZERO HI ORDER BYTE OF EXIT LIST 26900021
         LTR   R7,R7                    IS THE EXIT LIST ZERO           27000021
         BZ    ETO03300                 YES, EXIT TO NEXT LOAD EOV      27100021
ETO03200 EQU   *                        EXIT LIST ADDR NOT 0     Y02082 27150002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 27200002
         CLI   K0(R7),XLOUTL            IS THIS ACTIVE EXIT 4    Y02082 27250002
         BE    ETO03400                 YES, PROCESS USER LABELS        27300021
         CLI   K0(R7),XLOUTL+LASTNTRY   SEE IF LAST IND ALSO ON         27400021
         BE    ETO03400                 YES, PROCESS USER LABELS        27500021
         TM    K0(R7),LASTNTRY          IS THIS LAST ENTRY IN LIST      27600021
         LA    R7,K4(K0,R7)             POINT TO NEXT ENTRY             27700021
         BNO   ETO03200                 IF NOT,LAST,CHECK NEXT ENTRY    27800021
ETO03300 EQU   *                        NO USER LABEL ENTRY             27900002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 27950002
         SPACE 1                                                        28000021
*                   EXIT                                                28100021
         LA    RWTGC,DXXENTRY           SET R8 FOR RES RTN              28200021
         LA    RWTG,DXXAREA             POINT TO EOV WTG                28300021
         SR    RET,RET                  ZERO RETURN REG                 28400021
         IECRES XCTL,MOD1T1R            GO TO NEXT MODULE               28500021
*                   EXIT TO USER LABEL HANDLING ROUTINE                 28600021
ETO03400 EQU   *                        VALID USER LABEL ENTRY          28700002
         L     R7,K0(K0,R7)             PICK UP EXIT ADDRESS            28800021
         LR    RC,R7                    SET UP REG 12 TO PASS EXIT ADR  28900021
         LA    R7,K0(K0,R7)             ZERO THE HI ORDER BYTE          29000021
         LTR   R7,R7                    IS EXIT ADDR ZERO IF ACTIVE     29100021
         BZ    ETO03300                 YES,DO NOT PROCESS USER LABELS  29200021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 29250002
*                                                                Y02082 37250002
*    OBTAIN CORE FOR USER LABEL WORK AREAS                       Y02082 37300002
*                                                                Y02082 37350002
         IECRES GET,LV=USERLDM,PREFIX=YES,SP=K229,               Y02082*37400002
               STM=(2,14,DXXPREFX),ID=ULWA                       Y02144 37450002
         USING ULDMWK,R1                                         Y02082 37500002
         STM   RPAR,RC,ULREGSAV         SAVE REGS 5 - 12         Y02082 37550002
         DROP  R1                                                Y02082 37600002
         LR    RUCB,R1                  PT TO GOTTEN CORE        Y02082 37650002
         USING ULDMWK,RUCB                                       Y02082 37700002
*                                                                Y02082 37750002
         IECRES GET,LV=USERLU,PREFIX=NO,KEY=USER,SP=K229,        Y02082*37800002
               STM=(2,14,DXXPREFX)                               Y02082 37850002
         LR    R9,R1                    PT TO GOTTEN CORE        Y02082 37900002
         USING ULUWK,R9                                          Y02082 37950002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 38000002
         LA    R1,CHAR0                 INITIALIZE COUNT                38500021
         STH   R1,ULCNT                 SAVE FOR LATER USE              38600021
*  OUTPUT LABEL PROCESSING                                              38700021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 38750002
         MVI   ULBUFR,BLANK             SET LABEL BUFFER AREA           38800021
         MVC   ULBUFR+K1(K79),ULBUFR    TO BLANKS                       38900021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 38950002
ETO03500 EQU   *                        CHECK FOR ASCII                 39000002
         TM    JFCBLTYP,JFCBAL+JFCBUL   ANSI USER LABELS SPEC.          39100021
         BO    ETO03600                 YES, SKIP LABEL COUNTING        39200021
         LH    R1,ULCNT                 PICK UP PREVIOUS COUNT          39300021
         LA    R1,K1(K0,R1)             INCREMENT BY 1                  39400021
         STH   R1,ULCNT                 SAVE UPDATED COUNT              39500021
         CLI   ULCNT+K1,MAXNOLAB        TEST,BR IF MAX NBR OF UL        39600021
         BH    ETO04000                 ALREADY PROCESSED               39700021
ETO03600 EQU   *                        INITIALIZE BUFFER HEADING       39800021
         IC    R8,ULCNT+K1              GET LABEL NUMBER         Y02082 39810002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 39850002
         STC   R8,ULBUFR+K3             PUT LABEL NO. IN USER BUFY02082 39860002
         MVC   ULBUFR(K3),UTLCON        INITIALIZE FIRST 4 CHAR OF      39900021
         BAL   R8,ETO04100              GO TO SYNCH TO USER             40100021
*                                                                       40200021
*                                                                       40300021
         LTR   RF,RF                    TEST,BR IF LABEL NOT            40400021
         BZ    ETO04000                 TO BE WRITTEN                   40500021
*  RESET FIRST 4 CHAR OF LABEL THEN                                     40600021
*  ESTABLISH CHANNEL PROGRAM TO WRITE USER LABEL                        40700021
*                                                                       40800021
         L     RF,DXXPREFX              PT TO PREFIX             Y02082 40805002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 40810002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 40815002
*    OBTAIN LOCAL LOCK                                           Y02082 40820002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*40825002
               RELATED=('PREVENT FREE USER CORE-RELEASED BELOW') Y02082 40830002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 40835002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 40840002
*    VERIFY USER STILL HOLDS USER LABEL BUFFER                   Y02082 40845002
         OC    ULUWK(USERLU),ULUWK      PGM CHECK IF NOT         Y02082 40850002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 40855002
         MVC   ULDMBUFR,ULBUFR          COPY LABEL FROM USER     Y02082 40860002
         L     RF,DXXPREFX              POINT TO PREFIX          Y02082 40865002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 40870002
*    RELEASE LOCAL LOCK                                          Y02082 40875002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 40880002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 40885002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 40890002
*                                                                       40900021
         MVC   ULDMBUFR(K3),UTLCON      SET 'UTL' IN LABEL       Y02082 40905002
         TM    JFCBLTYP,JFCBAL+JFCBUL   IF 'AUL' SPEC, BYPASS           41100021
         BO    ETO03700                 RESTORING LABEL NUMBER          41200021
         MVC   ULDMBUFR+K3(K1),ULCNT+K1 LABEL NO. IN LABEL       Y02082 41205002
ETO03700 EQU   *                        POINT TO LABEL BUFFER           41400021
         LA    R1,ULDMBUFR              PT CCW TO LABEL BUFFER   Y02082 41405002
         ST    R1,DXCCW1                                                41600021
         MVI   DXCCW1,CCWWRTAP          WRITE OP-CODE TO CCW            41700021
         MVC   DXCCW1+K4(K4),LENGTH     80-CHAR LENGTH                  41800021
         TM    JFCBLTYP,JFCBAL+JFCBUL   ANSI USER LABEL SPEC.           41900021
         BNO   ETO03800                 NO, BYPASS TRANSLATE            42000021
*   TRANSLATE LABEL BEFORE PROCESSING                                   42100021
         XLATE (R1),K80,TO=A            TRANSLATE USER LABEL            42200021
ETO03800 EQU   *                        GO WRITE LABEL                  42300021
         BAL   R8,ETO04600              GO ISSUE EXCP                   42400021
         BZ    ETO03900                 ERROR ENCOUNTERED.              42500021
*                                                                       42600021
*                                                                       42700021
         CLI   ULRETCOD,WRITNEXT        TEST,BR IF USER RETURNED A CODE 42800021
         BE    ETO03500                 TO CONTINUE UL PROCESSING       42900021
*  OTHERWISE, IT IS ASSUMED THE USER RETURNED A CODE = 4, I.E. NO       43000021
*  FURTHER UL PROCESSING.                                               43100021
         B     ETO04000                 UNCONDITIONAL BRANCH            43200021
*                                                                       43300021
ETO03900 EQU   *                        ERROR PROCESSING                43400002
*  ERROR WHEN ATTEMPTING TO WRITE LABEL.  GO TO USER WITH ERROR         43500021
*  INDICATIONS, THEN TERMINATE UL PROCESSING (RETURN CODE NOT           43600021
*  EXAMINED).                                                           43700021
         LA    R1,DXIOB                 INSERT POINTER TO STATUS INFO   43800021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 43850002
         ST    R1,ULPARM+K8             IN PARAMETER LIST               43900021
         OI    ULPARM+K8,LASTNTRY+ERROROUT  FLAG IN ERROR               44000021
         BAL   R8,ETO04200              GO TO SYNCH TO USER (BUFFER     44100021
*                                       CONTAINS LABEL UNABLE TO WRITE) 44200021
ETO04000 EQU   *                        FREE USER LABEL WORK AREAS      44300002
*                                                                       44400021
*                                                                       44500021
*                                                                Y02082 44530002
*    FREEMAIN CORE FOR USER LABEL WORK AREAS                     Y02082 44560002
*                                                                Y02082 44590002
         IECRES FREE,A=(9),PREFIX=NO,LV=USERLU,SP=K229,          Y02082*44620002
               KEY=USER,STM=(2,14,DXXPREFX)                      Y02082 44650002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 44680002
*    FREE EOV'S USER LABEL WORK AREA    Y02082                          44710002
         LR    R1,RUCB                  ADDR OF WORK AREA (UL)   Y02082 44740002
         LM    RPAR,RC,ULREGSAV         RESTORE REGS 5 - 12      Y02082 44770002
         IECRES FREE,A=(1),PREFIX=YES,STM=(2,14,DXXPREFX)        Y02082 44800002
         SPACE 2                                                        45000021
         B     ETO03300                 BRANCH TO DO XCTL               45100021
         SPACE 2                                                        45200021
*                                                                       45300021
ETO04100 EQU   *                        SYNCH ENTRY 1                   45400002
         XC    ULPARM+K8(K4),ULPARM+K8  ZERO ERROR IND                  45500021
ETO04200 EQU   *                        SYNCH ENTRY 2                   45600002
         LA    R1,ULBUFR                POINT TO LABEL BUFFER           45700021
ETO04300 EQU   *                        SYNCH ENTRY 3                   45800002
         ST    R1,ULPARM                PTR TO LABEL BUFFER      Y02082 45850002
         L     R1,DXUDCBAD              GET USER'S DCB ADDR      Y02082 45900002
         ST    R1,ULPARM+K4             PUT IN PARM LIST         Y02082 45950002
         XC    ULTOTPTR(K4),ULTOTPTR    ZERO TOTALING ENTRY             46100021
         MVI   ULDCBPTR,K0              CLEAR FLAG BYTE                 46200021
         L     R7,DCBDEBAD              GET ADDRESS OF USER'S DEB       46300021
*                                                                       46400021
         TM    DCBMACRF,DCBMEXCP        CK IF USING EXCP                46500021
         BO    ETO04400                 EXCP, SKIP TOTALING             46600021
         TM    DCBOPTCD,DCBOPTT         CK IF TOTALING SPECIFIED        46700021
         BZ    ETO04400                 BR IF NO TOTALING               46800021
*                                                                       46900021
         L     R7,K40(R7)               GET PTR TO TOTALING AREA        47000021
         USING TOTSAVWA,R7              ESTABLISH BASE FOR AREA         47100021
         MVC   ULTOTPTR(K4),TOTEOVPT    TOTLING PTR TO PARM LIST        47200021
         DROP  R7                       DROP BASE                       47300021
*                                                                       47400021
ETO04400 EQU   *                        COPY DCB                        47500002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 47510002
         NI    DCBOFLGS,X'FF'-DCBOLOCK  SET LOCK BIT TO ZERO     Y02082 47550002
*                                                                Y02082 47560002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 47570002
*                                                                Y02082 47580002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,DXXPREFX)          Y02082 47590002
*                                                                Y02082 47592002
         LA    R1,ULPARM                POINT TO PARAMETER LIST         47600021
         MVC   DEBDCBAD(K4),DXUDCBAD    USER DCB ADDR TO DEB   @ZA10242 47700037
         IECRES UEXIT,EXITAD=ULREQ,STM=(2,13,DXXPREFX)           Y02082 48600037
         STCM  R2,K7,DEBDCBAD+K1        COPIED DCB ADDR TO DEB @ZA10242 49500037
         L     RDCB,DXUDCBAD            GET PTR TO USER'S DCB    Y02082 50490002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER'S KEY      Y02082 50492002
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT TO ONE      Y02082 50494002
         LA    R0,ALLBITS-DCBOBUSY      ISOLATE BUSY BIT MASK    YM3005 50496002
         IC    R1,DCBOFLGS              GET CALLER'S OFLGS       YM3005 50496402
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 50498002
         L     RDCB,DXPDCBAD            GET PTR TO COPIED DCB    Y02082 50498402
         OR    R0,R1                    ISOLATE CALLER BUSY BIT  YM3005 50498802
         IC    R1,DCBOFLGS              GET COPIED DCBOFLGS      YM3005 50499202
         NR    R1,R0                    UPDTE BUSY BIT TO CALLER YM3005 50499602
         STC   R1,DCBOFLGS              UPDATE DCBOFLGS IN COPY  Y02082 50499802
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT TO ONE             50500021
         ST    RF,ULWK1                 SAVE RETURN CODE         YM4663 50550002
         BR    R8                       RETURN                          50700021
*                                                                       50800021
*                                                                       51000021
         SPACE 1                                                        51100021
         EJECT                                                          51200021
*                   CLOSED SUBROUTINE TO ISSUE I/O OPERATIONS           51300021
         SPACE 1                                                        51400021
*                        IT IS ASSUMED THAT ALL CONTROL BLOCKS          51500021
*                        HAVE ALREADY BEEN SET UP                       51600021
         SPACE 1                                                        51700021
*                             BAL  R8,PRTR50                            51800021
*                             RETURN                                    51900021
         SPACE 1                                                        52000021
ETO04600 EQU   *                        I/O ROUTINE                     52100002
         EXCP  DXIOB                    INITIATE I/O OPERATION          52200021
ETO04700 WAIT  ,ECB=DXECB               WAIT FOR COMPLETION OF I/O OPER 52300021
         TM    IOBSTAT0,CSWUNITX        IS THERE A UNIT EXCEPTION ERROR 52400021
         BC    12,ETO04800              NO,GO CHECK IF ANY I/O ERROR    52500021
         TM    IOBSTAT0,IOERR           TEST FOR UNIT CHK ALSO  SA58747 52550002
         BO    ETO04800                 YES, CHK ANY I/O ERROR  SA58747 52560002
         OI    DXECB,ECBCOD7F           IGNORE ERROR                    52600021
ETO04800 EQU   *                        CHECK FOR ERROR                 52700002
         TM    DXECB,ECBNOERR           IS THERE AN UNUSUAL I/O COND    52800021
         BR    R8                       RETURN TO CALLER                52900021
         EJECT                                                          53000021
* ***                                                                   53100021
* ***          NOTIFY OPERATOR THAT JOB IS BEING TERMINATED             53200021
* ***          DUE TO I/O ERROR                                         53300021
* ***                                                                   53400021
* ***                                                                   53500021
ETO04900 EQU   *                        ABEND                           53600002
         LA    RWTGC,DXXENTRY           SET R8 FOR RES RTN              53700021
         LA    RWTG,DXXAREA             POINT TO EOV WTG                53800021
         DMABCOND 141,MODPD1R           GO TO PROB DETER. FOR ABEND     53900021
*                                       137                             54000021
         SPACE 1                                                        54100021
*                   CONSTANTS                                           54200021
         LTORG                                                          54300021
         SPACE 1                                                        54400021
SEN89E   DC    X'20000008'              SENSE 8 BYTES - SILI      99223 54500002
ATRTCH9E DC    C' CET'                  CONVERSION,EVEN PARITY,TRANSLAT 54600021
SNMASK   DC    X'0000FFFF'              SER NUMBER MASK        @ZA13576 54630037
CHARTBL  DC    C'0003570000046800'      CHAR. TBL FOR MOD NO.  @ZA19724 54660037
         DS    0H                                                       54700021
AGRTR39E DC    X'8000'                  VALUE IN LABEL WHEN LRECLGT 32K 54800021
AEOV     DC    C'EOV'                   CHARACTERS -EOV-                54900021
ARECFM9E EQU   *-1                      RECFM TRANSLATE TABLE           55000021
         DC    C'VFU'                   VARIABLE,FIXED,UNKNOWN REC FMT  55100021
ABLKA9E  DC    C' SBR'                  BLK AATTRB TRANSLATE TABLE      55200021
BITOFF9E DC    F'127'                   MASK FOR BUFOFF=L BIT           55300021
*                                                                       55400021
*                        CONSTANTS                                      55500021
*                                                                       55600021
LENGTH   DC    X'20000050'              SILI, COUNT = 80 BYTES          55700021
UTLCON   DC    C'UTL'                   TRAILER LABEL CONSTANT          55800021
*                                                                       55900021
XCTLTA1R XCTLTABL ID=(MOD1T1R,1T,MODPD1R,0P),                    Y02080X56000002
               SVC=055,BRT=YES,LENGTH=                           Y02080 56050002
         IECDSECS CVT,TCB,RB,DCB,UCB,MAIN,DEB,USERLAB,USERTOT,         X57000021
               DSAB,                                             Y02083X57010002
               WTG,PREFX,PSA,                                    Y02080*57050002
               TIOT,RRPL,EXPAND=YES                              Y02144 57100002
         IECEQU                                                         57200021
         END                                                            57300021
