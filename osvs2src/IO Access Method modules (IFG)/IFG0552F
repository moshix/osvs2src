         TITLE 'IFG0552F EOV TAPE OUT HEADER 2/USER LABEL PREPARATION'  00100021
         COPY  LCGASMSW                                                 00200000
IFG0552F CSECT                                                          00400021
*********************************************************************** 00450002
*                                                                     * 00500002
*                                                                     * 00550002
*          VS2 RELEASE 037 DELETIONS/CHANGES                          * 00600037
*0000                                                          @ZA02850 00610037
*240999-241666,560500,560600                                   @ZA02210 00620037
*0000                                                          @ZA08326 00650037
*0000                                                          @ZA13576 00660037
*0000234000                                                    @ZA14707 00670037
*0000                                                          @ZA19724 00680037
*C240999,241432,241656-241750                                  @ZA26229 00700037
*********************************************************************** 00750002
*                                                                     * 00800002
* MODULE NAME = IFG0552F (OS/VS2)                                     * 00850002
*                                                                     * 00900002
* DESCRIPTIVE NAME = OUTPUT TAPE - WRITE HEADER LABEL 2, USER LABELS  * 00950002
*                                                                     * 01000002
* COPYRIGHT = NONE                                                    * 01050002
*                                                                     * 01100002
* STATUS = RELEASE 2, LEVEL 0                                         * 01150002
*                                                                     * 01200002
* FUNCTION =                                                          * 01250002
*        ENTRY ONE                                                    * 01300002
*        1) WAIT FOR I/O TO COMPLETE INITIATED IN PREVIOUS MODULE.    * 01350002
*        2) IF I/O ERROR, A NEW VOLUME WILL BE REQUESTED BY           * 01400002
*        TRANSFERRING CONTROL TO IFG0552N, BRANCH CODE = 0.           * 01450002
*        3) CONSTRUCT HEADER LABEL 2 USING INFORMATION FROM THE JFCB  * 01500002
*        AND TIOT. IF ASCII SPECIFIED, TRANSLATE THE LABEL BEFORE     * 01550002
*        WRITING.                                                     * 01600002
*        4) WRITE HEADER LABEL 2. IF I/O ERROR OCCURS, REQUEST A NEW  * 01650002
*        VOLUME AS IN 2) ABOVE.                                       * 01700002
*        5) IF USER LABELS ARE SPECIFIED, PROCESS THEM.               * 01750002
*        6) WRITE TAPE MARK AFTER HEADER LABEL 2 (OR USER LABELS).    * 01800002
*        7) ISSUE TAPE ATTRIBUTE MESSAGE BY TRANSFERRING CONTROL TO   * 01850002
*        IFG0554J, BRANCH CODE = 48. RETURN TO THIS MODULE WITH A     * 01900002
*        RETURN BRANCH CODE OF 4.                                     * 01950002
*        ENTRY TWO                                                    * 02000002
*        8) IF THE ACCESS METHOD EXECUTOR IS NEEDED, TRANSFER CONTROL * 02050002
*        TO IFG0551L, BRANCH CODE = 0. OTHERWISE, COPY THE DCB FROM   * 02100002
*        THE WORK AREA TO CALLER'S STORAGE, FREE THE EOV WORK AREA,   * 02150002
*        AND RETURN TO THE CALLER OF EOV.                             * 02200002
*                                                                     * 02250002
* NOTES = SEE BELOW                                                   * 02300002
*                                                                     * 02350002
*    DEPENDENCIES =                                                   * 02400002
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 02450002
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 02500002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 02550002
*                                                                     * 02600002
*    RESTRICTIONS = NONE                                              * 02650002
*                                                                     * 02700002
*    REGISTER CONVENTIONS =                                           * 02750002
*            R2 POINTS TO DCB                                         * 02800002
*            R4 POINTS TO OPEN WORK AREA                              * 02850002
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 02900002
*            R6 POINTS TO THE WTG TABLE                               * 02950002
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 03000002
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 03050002
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 03100002
*            R10 POINTS TO THE UCB                                    * 03150002
*                                                                     * 03200002
*    PATCH LABEL = SEE THIRD FROM LAST LABEL BEFORE ORG STATEMENT AT  * 03250002
*                  END OF LISTING.                                    * 03300002
*                                                                     * 03350002
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 03400002
*                                                                     * 03450002
*    PROCESSOR = ASSEMBLER XF                                         * 03500002
*                                                                     * 03550002
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 03600002
*                  ORG STATEMENT AT END OF LISTING                    * 03650002
*                                                                     * 03700002
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 03750002
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 03800002
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 03850002
*                                                                     * 03900002
* ENTRY POINT =                                                       * 03950002
*        IFG0552F                                                     * 04000002
*                                                                     * 04050002
*    PURPOSE = SEE FUNCTION                                           * 04100002
*                                                                     * 04150002
*    LINKAGE =                                                        * 04200002
*        THIS MODULE IS TRANSFERRED CONTROL THROUGH THE IECRES-LOAD   * 04250002
*        MACRO INSTRUCTION.                                           * 04300002
*                                                                     * 04350002
* INPUT =                                                             * 04400002
*        GIVEN CONTROL IN PROTECT KEY 5.                              * 04450002
*        REGISTER 2 POINTS TO THE COPIED DCB.                         * 04500002
*        DEBDCBAD POINTS TO THE COPIED DCB.                           * 04550002
*        REGISTER 4 POINTS TO THE EOV WORKAREA                        * 04600002
*                                                                     * 04650002
* OUTPUT =                                                            * 04700002
*        THE NEXT MODULE IS GIVEN CONTROL IN PROTECT KEY 5 WITH       * 04750002
*        REGISTER 2 POINTING TO THE COPIED DCB,                       * 04800002
*        DEBDCBAD POINTING TO THE COPIED DCB,                         * 04850002
*        AND REGISTER 4 POINTING TO THE EOV WORKAREA,                 * 04900002
*                                                                     * 04950002
* EXIT-NORMAL =                                                       * 05000002
*        IFG0551L - ACCESS METHOD MODULE, BRANCH CODE = 0             * 05050002
*        IFG0554J - ISSUE TAPE ATTRIBUTE MSG, BRANCH CODE = 48        * 05100002
*           RETURN TO IFG0552F, BRANCH CODE = 4                       * 05150002
*        IFG0552N - I/O ERROR-ASK FOR NEW VOLUME, BRANCH CODE=0       * 05200002
*                                                                     * 05250002
* EXIT-ERROR = NONE                                                   * 05300002
*                                                                     * 05350002
* EXTERNAL REFERENCES = SEE BELOW                                     * 05400002
*                                                                     * 05450002
*    ROUTINES =                                                       * 05500002
*        IFG019RA THROUGH THE IECRES MACRO.                           * 05550002
*                                                                     * 05600002
*    DATA AREAS =                                                     * 05650002
*        EOV WORKAREA.                                                * 05700002
*                                                                     * 05750002
*    CONTROL BLOCK =                                                  * 05800002
*        CVT                                                          * 05850002
*        DEB                                                          * 05900002
*        DSAB                                                         * 05950002
*        JFCB                                                         * 06000002
*        PSA                                                          * 06050002
*        RB                                                           * 06100002
*        TCB                                                          * 06150002
*        UCB                                                          * 06200002
*                                                                     * 06250002
* TABLES =                                                            * 06300002
*                                                                     * 06350002
* MACROS =                                                            * 06400002
*        IECRES LOAD                                                  * 06450002
*        IECRES GET                                                   * 06500002
*        IECRES FREE                                                  * 06550002
*        IECRES INIT                                                  * 06600002
*        IECRES UEXIT                                                 * 06650002
*        IECRES EXIT                                                  * 06700002
*        IECRES WAIT                                                  * 06750002
*        EXCP                                                         * 06800002
*        XLATE                                                        * 06850002
*        SETLOCK                                                      * 06900002
*                                                                     * 06950002
* CHANGE ACTIVITY =                                                   * 07000002
*        SEE CHANGES/DELETIONS SECTION JUST AFTER CSECT CARD.         * 07050002
*                                                                     * 07100002
*********************************************************************** 07150002
         EJECT                                                          07200002
CHARC    EQU   C'C'                     CHARACTER C              Y02083 13450002
EABD144  EQU   144                      I/O ERROR WRITING LBL  @ZA02850 13460037
         SPACE 1                                                        13500021
*                   ADDRESSABILITY                                      13600021
         SPACE 1                                                        13700021
         BALR  RBASE,0                  ESTABLISH BASE                  13800021
         USING *,RBASE                                                  13900021
         USING FORCORE,RCORE                                            14000021
         USING WTG,RWTG                 BASE FOR WTG TABLE       Y02080 14050002
         USING DEBBASIC,RDEB                                     YM1272 14100002
         USING IHADCB,RDCB                                              14200021
         USING SRT,RUCB                                                 14300021
         SPACE 1                                                        14400021
*                                                                Y02134 14404002
         B     ETO20300(RET)            BR TO INDICATED FUNCTION Y02134 14408002
*                                                                Y02134 14412002
ETO20300 EQU   *                        BRANCH TABLE             Y02134 14416002
*                                                                Y02134 14420002
         B     ETO20400                 BRANCH IF SL/AL          Y02134 14424002
         B     ETO24300                 BRANCH FOR NL/NSL/BLP    Y02134 14428002
*                                                                Y02134 14436002
         EJECT                                                          14440002
*                                                                Y02134 14444002
ETO20400 EQU   *                        WAIT FOR HDR1            Y02134 14448002
*                                                                Y02134 14452002
         BAL   RC,ETO22200              GO WAIT FOR HDR1         YM3927 14500002
         BNO   ETO24000                 BR IF I/O ERROR                 14600021
*                   PREPARE HEADER LABEL 2                              14700021
         SPACE 1                                                        14800021
         MVI   FL1NO,CHAR2              SET FILE LABEL IDENTIFIER TO 2  14900002
         MVI   FL2TRTCH,BLANK           SET PART OF LABEL TO            15000021
         MVC   FL2TRTCH+K1(K45),FL2TRTCH  BLANKS - 47 CHARACTERS        15100021
         SPACE 1                                                        15200021
*                  BLOCKING ATTRIBUTE                                   15300021
         SPACE 1                                                        15400021
         SR    R7,R7                    CLEAR WORK REGISTER             15500021
         IC    R7,JFCRECFM              PICK UP RECORD FORMAT FROM THE  15600021
         SRL   R7,K3                    BITS 0,1 CONTAIN BLK ATTRIBUTE  15700021
         STC   R7,DXLBL+K38             ZERO ALL BUT BITS 0,1 TO        15800021
         NI    DXLBL+K38,K3             PREPARE FOR TRANSLATE           15900021
         TR    DXLBL+K38(K1),ABLKA0W    TRANSLATE TO S, B, R OR BLANK   16000021
*                                                                       16100021
*                  RECORD FORMAT                                        16200021
*                                                                       16300021
         TM    JFCRECFM,JFCRFO          TEST FOR RECFM = D              16400021
         BZ    ETO20500                 NO, GET RECORD FORMAT           16500021
         MVI   FL2RECFM,DCBRECUN+DCBRECCA  SET RECFM = D IN LABEL       16600021
         B     ETO20600                 GO GET BLOCK SIZE               16700021
ETO20500 EQU   *                        GET RECORD FORMAT               16800021
         SRL   R7,K3                    BITS 0,1 CONTAIN RECORD FORMAT  16900021
         STC   R7,FL2RECFM              F = BIT 0  V = BIT 1  U = BITS  17000021
         TR    FL2RECFM,ARECFM0W        TRANSLATE TO V,F OR U           17100021
         SPACE 1                                                        17200021
ETO20600 EQU   *                        GET BLOCK SIZE                  17300021
         L     R7,DXDSAB                ADR OF DSAB              Y02083 17350002
         USING DSAB,R7                                           Y02083 17360002
         TM    DSABFLG4,DSABCKDS        DSAB IND A CHECK PT DS   Y02083 17370002
         BNO   ETO20610                 NO   CONTINUE            Y02083 17380002
         MVI   FL2DSIND,CHARC           PUT CHK PT CHAR IN LABEL Y02083 17390002
         DROP  R7                                                Y02083 17392002
ETO20610 EQU   *                        INSTR MUST FOLLOW        Y02083 17394002
*                             BUFFER OFFSET                             17400021
         SPACE 1                                                        17500021
         LH    R7,JFCBLKSI              PICK UP BLOCK LENGTH            17600021
         CVD   R7,DXCCW2                CONVERT BLOCK LENGTH TO DECIMAL 17700021
         UNPK  FL2BLKL,DXCCW2           BLOCK LENGTH IN EBCDIC TO LABEL 17800021
         OI    FL2BLKL+K4,ZONEOF        RESET SIGN BITS                 17900021
         LH    R7,JFCLRECL              PICK UP LOGICAL RECORD LENGTH   18000021
         CH    R7,AGRTR30W              IS LRECL INDIC GRTR 32K         18100021
         BE    ETO20700                 BR TO SET LABEL TO 9'S          18200021
         CVD   R7,DXCCW2                CONVERT LOGICAL REC LEN TO DEC  18300021
         UNPK  FL2LRECL,DXCCW2          LOGICAL REC LEN IN EBCDIC       18400021
         OI    FL2LRECL+K4,ZONEOF       RESET SIGN BITS                 18500021
         B     ETO20800                 BR TO CONTINUE MERGE            18600021
ETO20700 EQU   *                        SET LRECL TO NINES              18700002
         MVI   FL2LRECL,ALLBITS-K6      SET LRECL TO 9'S                18800021
         MVC   FL2LRECL+K1(K4),FL2LRECL  INDICATING GRTR 32K            18900021
*                                                                       19000021
*                  DENSITY                                              19100021
ETO20800 EQU   *                        SET DENSITY                     19200002
         MVI   FL2DEN,CHAR4             SET DENSITY TO 4          99223 19250002
         TM    JFCDEN,DEN6250           IS DENSITY 6250           99223 19260002
         BO    ETO20850                 YES,BRANCH                99223 19270002
         SR    R7,R7                    CLEAR WORK REGISTER             19300021
         IC    R7,JFCDEN                PICK UP DENSITY FROM THE JFCB   19400021
         SRL   R7,K6                    BITS 0 AND 1 CONTAIN DENSITY    19500021
         STC   R7,FL2DEN                00=200 01=556 10=800 11=1600    19600021
         OI    FL2DEN,DENSET            SET DENSITY TO EBCDIC           19700021
*                                                                       19800021
*                   FILE POSITION AND JOB/STEP IDENTIFICATION           19900021
*                                                                       20000021
ETO20850 EQU   *                        DENSITY = 6250            99223 20050002
         MVI   FL2FILP,FILPOS1          A VOLUME SWITCH HAS OCCURRED    20100021
         L     R7,DEBTCBAD              REESTABLISH THE ADDRESS OF THE  20200021
         L     R7,TCBTIO-TCB(K0,R7)     BEGINNING OF THE TIOT           20300021
         MVC   FL2JOBD,TIOCNJOB-TIOT(R7)  PLACE JOB/STEP IDENTIFICATION 20400021
         MVI   FL2JSSP,SLASH            (INSERT SLASH)                  20500021
         MVC   FL2STEPD,TIOCSTEP-TIOT(R7)  FROM THE TIOT TO LABEL       20600021
         SPACE 1                                                        20700021
*                   TAPE RECORDING TECHNIQUE                            20800021
         SPACE 1                                                        20900021
         SR    R7,R7                    CLEAR WORK REGISTER             21000021
         IC    R7,JFCTRTCH              PICK UP TAPE RECORDING TECH     21100021
         SRL   R7,K4                    13=C, 23=E , 2B=ET, 0=BLANK     21200021
         STC   R7,FL2TRTCH              PLACE FIRST CHARACTER OF TRTCH  21300021
         TR    FL2TRTCH(K1),ATRTCH0W    THE LABEL AS BLANK,C,E OR T     21400021
         CLI   JFCTRTCH,DCBTRTET        IS IT BOTH EVEN PARITY AND TRAN 21500021
         BC    6,ETO20900               NO,THE SECOND CHAR S/B BLANK    21600021
         MVI   FL2TRTCH+K1,CHART        YES,TAPE RECORD TRANS           21700021
         SPACE 1                                                        21800021
*                   CARRIAGE CONTROL CHARACTER SET                      21900021
         SPACE 1                                                        22000021
ETO20900 TM    JFCRECFM,DCBRECCM        JFCB SPECIFY MACHINE CODE CTL   22100021
         BC    12,ETO21000              NO,GO SEE IF ASA CONTROL CHAR   22200021
         MVI   FL2CNTRL,CHARM           YES,SET MACHINE CODE CTL CHAR   22300021
ETO21000 TM    JFCRECFM,DCBRECCA        JFCB SPECIFY ASA CONTROL CHAR   22400021
         BC    12,ETO21100              NO,DO NOT SET UP CARRIAGE CNTRL 22500021
         MVI   FL2CNTRL,CHARA           YES,SET CONTROL CHAR TO ASA     22600021
*                                                                       22700021
ETO21100 EQU   *                        DON'T SET CARRIAGE CONTROL      22800002
*                             BUFFER OFFSET                             22900021
         TM    JFCBLTYP,JFCBAL          WERE ANSI LABEL SPEC.           23000021
         BNO   ETO21350                 NO, CHECK FOR 6250        99223 23100002
ETO21200 SR    R7,R7                    CLEAR REG                       23200021
         IC    R7,JFCBUFOF              LOAD OFFSET LENGTH              23300021
         A     R7,BITOFF0W              TURN OFF BUFOFF = L BIT@ZA14707 23400037
ETO21300 CVD   R7,DXCCW2                CONVERT TO DECIMAL              23500021
         UNPK  FL2BUFOF,DXCCW2          UNPACK                          23600021
         OI    FL2BUFOF+K1,ZONEOF       TURN OFF SIGN BIT               23700021
         MVC   FL1LABI,HDR0W            MOVE IN HEADER CONSTANT         23800021
*   TRANSLATE LABEL BEFORE WRITING                                      23900021
         XLATE DXLBL,K80,TO=A           TRANSLATE                       24000021
         B     ETO21400                 GO WRITE LABEL            99223 24050002
*  IF CREATING SL ON A 6250 BPI TAPE UNIT, THE ID OF THE CREATING       24052002
*  DEVICE IS PLACED IN HDR2/EOF2/EOV2. TAPE UNIT ID IS FOUND IN THE     24054002
*  UCB EXTENSION.                                                       24056002
ETO21350 EQU   *                        SET TAPE UNIT ID          99223 24060002
         CLI   UCBTBYT4,UCB3400         TEST FOR 3400 DRIVE      YM1491 24070002
         BNE   ETO21400                 NO - BRANCH              YM1491 24080002
         L     R7,UCBEXTPT              GET UCB EXTEN PTR        Y02146 24090002
         CLI   UCBSNSCT-UCBCMEXT(R7),K24 IS IT 3420 TAPE UNIT    Y02146 24090402
         BNE   ETO21400                 NO - BRANCH               99223 24092002
         USING UCBMT,R7                 SET UP ADDRESSABILITY     99223 24094002
         L     R7,UCBXTN                GET EXTENSION ADDRESS     99223 24096002
         LH    R7,UCBCTD                PUT ID OF CREATING DRIV@ZA08326 24098037
         N     R7,SNMASK                INTO R7                @ZA08326 24098437
         DROP  R7                                                 99223 24098837
         CVD   R7,DXCCW2                CONVERT ID                99223 24099237
         UNPK  FL2ID,DXCCW2             PLACE IN LABEL         @ZA08326 24099337
         OI    FL2ID,ZONEOF             STRIP SIGN             @ZA13576 24099437
* GET THE MODEL NO. CODE FROM THE SENSE INFORMATION AND                 24099737
* PLACE THE MODEL NO. CHARACTER INTO THE SERIAL NO.                     24099837
         LA    RC,DXCCW2                GET AREA ADDRESS       @ZA26229 24099937
         MVC   DXCCW1+K4(K4),CCW2FK07   SILI FLAG,7 SNS BYTES  @ZA02210 24133237
         ST    RC,DXCCW1                PUT AREA ADDR INTO CCW @ZA26229 24143237
         MVI   DXCCW1,CCWSENSE          SNS CMD CODE INTO CCW  @ZA02210 24153237
         BAL   RC,ETO22100              GO ISSUE SENSE COMMAND @ZA02210 24163237
         BZ    ETO24000                 IF I/O ERR,NOTIFY OPER @ZA02210 24165237
         IC    RC,DXCCW2+K6             GET SIXTH SENSE BYTE   @ZA26229 24165637
         SLL   RC,K28                   CLEAR RC EXCEPT FOR    @ZA26229 24166037
         SRL   RC,K28                   HALF BYTE MOD. NO.     @ZA26229 24168037
         IC    RC,CHARTBL(RC)           GET CHAR. FROM TABLE   @ZA26229 24170037
         STC   RC,FL2ID                 PLACE MOD NO INTO LBL. @ZA26229 24172037
         OI    FL2ID+K4,ZONEOF          STRIP SIGN             @ZA08326 24180037
ETO21400 EQU   *                        WRITE LABEL                     24188937
         SPACE 1                                                        24200021
*                   WRITE HEADER LABEL 2                                24300021
         SPACE 1                                                        24400021
         MVC   DXCCW1,ANOPCCW           GET BASIC CCW                   24500021
         ST    RCORE,DXCCW1             ADDRESS OF WRITE AREA           24600021
         MVI   DXCCW1,CCWWRTAP          WRITE COMMAND                   24700021
         BAL   RC,ETO22100              GO WRITE FILE LABEL 2    YM3927 24800002
         BC    12,ETO24000              IF I/O ERROR, GO NOTIFY THE OP  24900021
         SPACE 1                                                        25000021
*                   SEE IF USER LABELS ARE TO BE PROCESSED              25100021
         SPACE 1                                                        25200021
ETO21500 EQU   *                        CHECK FOR USER LABELS SPEC      25300002
         TM    JFCBLTYP,JFCBUL          BRANCH IF NOT 'AUL' OR          25400021
         BNO   ETO21900                 'SUL' AS LABEL TYPE             25500021
         TM    DCBMACRF,DCBMEXCP        IS THIS EXCP                    25600021
         BZ    ETO21600                 NO, GO                          25700021
         TM    DCBMACRF,DCBMFOUN        DOES DCB HAVE FOUNDATION EXT.   25800021
         BZ    ETO21900                 NO, GO                          25900021
ETO21600 EQU   *                        EXAMINE EXIT LIST               26000002
         L     R7,DCBEXLST              PICK UP EXIT LIST FROM DCB      26100021
         LA    R7,K0(K0,R7)             ZERO HI ORDER BYTE OF EXIT LIST 26200021
         LTR   R7,R7                    IS THE EXIT LIST ZERO           26300021
         BZ    ETO21900                 YES, GO TO WRITE TAPE MARK      26400021
ETO21700 EQU   *                        EXIT LIST NON-ZERO       Y02082 26500002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 26510002
         CLI   K0(R7),XLOUHL            IS THIS ACTIVE EXIT 2    Y02082 26550002
         BE    ETO22300                 YES, PROCESS USER LABELS        26600021
         CLI   K0(R7),XLOUHL+LASTNTRY   SEE IF LAST IND ALSO ON         26700021
         BE    ETO22300                 YES, PROCESS USER LABELS        26800021
         TM    K0(R7),LASTNTRY          IS THIS LAST ENTRY IN LIST      26900021
         LA    R7,K4(K0,R7)             POINT TO NEXT ENTRY             27000021
         BC    12,ETO21700              IF NOT,LAST,CHECK NEXT ENTRY    27100021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 27150002
         EJECT                                                          27160002
ETO21800 EQU   *                        WRITE TAPE MARK                 27200002
         SPACE 1                                                        27300021
*                   WRITE TAPE MARK FOLLOWING HEADER LABELS             27400021
         SPACE 1                                                        27500021
ETO21900 MVC   DXCCW1(K16),AWTMCCWW     SET UP CCW TO WRITE TAPE MARK   27600021
         BAL   RC,ETO22100              GO TO WRITE TAPE MARK    YM3927 27700002
         BC    12,ETO24000              IF I/O ERROR,GO NOTIFY THE OPER 27800021
         OI    DXATOUTA,DXATHDTM        TM WRITTEN AFTER HDR LBL Y02144 27850002
         MVI   DXCCW1+K4,CCWSILI        RESET CHAIN COMMAND FLAG IN CCW 27900021
*                                                                Y02134 27904002
*****************************************************************Y02134 27954002
*                                                                Y02134 27964002
*        GO ISSUE TAPE ATTRIBUTE MESSAGE                         Y02134 27974002
*                                                                Y02134 27984002
*****************************************************************Y02134 27994002
*                                                                Y02134 27996002
         MVC   DXRETMOD,ID2F2F          SET UP RETURN LOAD       Y02134 27998002
         MVI   DXRETCOD,K4              RETURN OFFSET            Y02134 27998402
*                                                                Y02134 27998802
         LA    RWTGC,DXXENTRY           SET R8 FOR RES RTN       Y02134 27998902
         LA    RWTG,DXXAREA             POINT TO EOV WTG         Y02134 27999002
         IECRES LOAD,MODID=ID2F4J,BRCODE=K48,BRANCH=QUEUED       Y02134 27999202
*                                                                Y02134 28001602
*****************************************************************Y02134 28003602
*                                                                Y02134 28004002
*                   EXIT                                                28100021
*                                                                Y02134 28200002
*****************************************************************Y02134 28210002
*                                                                Y02134 28250002
ETO22000 SR    RET,RET                  ZERO RETURN REG                 28300021
         LA    RWTGC,DXXENTRY           SET R8 FOR RES RTN              28400021
         LA    RWTG,DXXAREA             POINT TO EOV WTG                28500021
         IECRES LOAD,MODID=(R7),BRANCH=QUEUED GO TO NEXT MODULE  Y02080 28650002
         EJECT                                                          28700002
*                                                                Y02134 28750002
*****************************************************************Y02134 28760002
*                                                                Y02134 28770002
*                   CLOSED SUBROUTINE TO ISSUE I/O OPERATIONS           28800021
*                        IT IS ASSUMED THAT ALL CONTROL BLOCKS          29000021
*                        HAVE ALREADY BEEN SET UP                       29100021
*                             BAL  R8,PRHR50                            29300021
*                             RETURN                                    29400021
*                                                                Y02134 29450002
*****************************************************************Y02134 29460002
*                                                                Y02134 29470002
ETO22100 EQU   *                        I/O ROUTINE                     29600002
*                                                                Y02134 29650002
         EXCP  DXIOB                    ISSUE I/O OPERATION             29700021
*                                                                Y02134 29750002
ETO22200 IECRES WAIT                    WAIT FOR I/O             Y02134 29800002
*                                                                Y02134 29850002
         TM    DXECB,ECBNOERR           IS THERE AN UNUSUAL I/O COND    29900021
         BR    RC                       RETURN TO CALLER         YM3927 30000002
         EJECT                                                          30050002
*                                                                Y02134 30060002
*****************************************************************Y02134 30070002
*                                                                Y02134 30080002
*                   EXIT TO USER LABEL HANDLING ROUTINE                 30100021
*                                                                Y02134 30150002
*****************************************************************Y02134 30160002
*                                                                Y02134 30170002
ETO22300 EQU   *                        PROCESS USER LABELS             30200002
*                                                                Y02134 30250002
         L     R7,K0(K0,R7)             PICK UP EXIT ADDRESS            30300021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 30350002
         LR    RC,R7                    SET UP REG 12 TO PASS EXIT ADR  30400021
         LA    R7,K0(K0,R7)             ZERO THE HI ORDER BYTE          30500021
         LTR   R7,R7                    IS EXIT ADDR ZERO IF ACTIVE     30600021
         BZ    ETO21900                 YES,DO NOT PROCESS USER LABELS  30700021
         EJECT                                                          30800021
*  OBTAIN USER CORE FOR WORK AREA, LABEL BUFFER, AND PARAMETER          38800021
*  LIST AREA                                                     Y02082 38900002
*                                                                       39000021
         IECRES GET,LV=USERLDM,PREFIX=YES,SP=K229,               Y02082*39050002
               STM=(2,14,WTGPREFX),ID=ULWA                       Y02144 39100002
*                                                                Y02082 39150002
         USING ULDMWK,R1                                         Y02082 39200002
         STM   RPAR,RC,ULREGSAV         SAVE REGS                Y02082 39250002
         DROP  R1                                                Y02082 39300002
         LR    RUCB,R1                                           Y02082 39350002
         USING ULDMWK,RUCB                                       Y02082 39400002
*    GET CORE FOR USER'S USER LABEL WORK AREA                    Y02082 39450002
         IECRES GET,LV=USERLU,PREFIX=NO,SP=K229,KEY=USER,        Y02082*39500002
               STM=(2,14,WTGPREFX)                               Y02082 39550002
         LR    R9,R1                    ADDR OF GOTTEN CORE      Y02082 39600002
         USING ULUWK,R9                                          Y02082 39650002
*                                                                Y02082 39700002
*                                                                       40100021
*  OUTPUT LABEL PROCESSING                                              40200021
         MVI   ULBUFR,BLANK             SET LABEL BUFFER AREA           40300021
         MVC   ULBUFR+K1(K79),ULBUFR    TO BLANKS                       40400021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 40450002
         LA    R1,CHAR0                 INIT COUNT               Y02082 40460002
         STH   R1,ULCNT                 SAVE FOR LATER USE       Y02082 40470002
ETO22400 EQU   *                        CHECK FOR ANSI LABELS           40500002
         TM    JFCBLTYP,JFCBAL+JFCBUL   ANSI USER LABELS SPEC.          40600021
         BO    ETO22500                 YES, SKIP LABEL COUNTING        40700021
         LH    R1,ULCNT                 PICK UP PREVIOUS COUNT          40800021
         LA    R1,K1(K0,R1)             INCREMENT BY 1                  40900021
         STH   R1,ULCNT                 SAVE UPDATED COUNT              41000021
         CLI   ULCNT+K1,MAXNOLAB        TEST,BR IF MAX NBR OF UL        41100021
         BH    ETO23100                 ALREADY PROCESSED               41200021
ETO22500 EQU   *                        INITIALIZE BUFFER HEADING       41300021
         ICM   R8,K14,UHLCON            SET UHL                  Y02082 41350002
         IC    R8,ULCNT+K1              SET LABEL NUMBER         Y02082 41400002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 41450002
         ST    R8,ULBUFR                SET 'UHLN' IN BUFFER     Y02082 41500002
         BAL   R8,ETO23200              GO TO SYNCH TO USER             41700002
*                                                                       41800021
*                                                                       41900021
         LTR   RF,RF                    TEST,BR IF LABEL NOT            42000021
         BZ    ETO23100                 TO BE WRITTEN                   42100021
*  RESET FIRST 4 CHAR OF LABEL THEN                                     42200021
*  ESTABLISH CHANNEL PROGRAM TO WRITE USER LABEL                        42300021
*                                                                       42400021
*                                                                       42500021
         MVC   ULDMBUFR(K3),UHLCON      SET 'UHL'                Y02082 42550002
ETO22700 EQU   *                        CHECK FOR ANSI LABELS           42700002
         TM    JFCBLTYP,JFCBAL+JFCBUL   IF 'AUL' SPECIFIED, BYPASS      42800021
         BO    ETO22800                 RESTORING LABEL NUMBER          42900021
         MVC   ULDMBUFR+K3(K1),ULCNT+K1 LABEL NUMBER             Y02082 42950002
ETO22800 EQU   *                        POINT TO LABEL BUFFER           43100021
         LA    R1,ULDMBUFR              POINT TO LABEL BUFFER    Y02082 43150002
         ST    R1,DXCCW1                SAVE ADDRESS                    43300021
         MVI   DXCCW1,CCWWRTAP          WRITE OP-CODE TO CCW            43400021
         MVC   DXCCW1+K4(K4),ANOPCCW+K4  80-CHAR LENGTH                 43500021
         TM    JFCBLTYP,JFCBAL+JFCBUL   ANSI USER LABEL SPEC.           43600021
         BNO   ETO22900                 NO, BYPASS TRANSLATE            43700021
*   TRANSLATE LABEL BEFORE PROCESSING                                   43800021
         XLATE (R1),K80,TO=A            TRANSLATE USER LABEL            43900021
         MODESET KEYADDR=DXUKEY,WORKREG=8 ASSUME USER KEY        Y02082 43950002
         LA    R1,ULBUFR                POINT TO LABEL BUFFER    Y02082 43960002
         XLATE (R1),K80,TO=A            TRANSLATE USER'S LABEL   Y02082 43970002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 43980002
ETO22900 EQU   *                        GO WRITE LABEL                  44000021
         BAL   RC,ETO22100              GO TO ISSUE EXCP         YM3927 44100002
*  ERROR CHECKING                                                       44200021
         BZ    ETO23000                 BR IF ERROR                     44300021
         TM    IOBSTAT0,CSWUNITX        CHECK FOR UNIT EXCEPTION        44400021
*                                       WRITING BEYOND EOT REFLECTOR    44500021
         BO    ETO23000                 CREATING HEADERS                44600021
*                                                                       44700021
*                                                                       44800021
         CLI   ULRETCOD,WRITNEXT        TEST,BR IF USER RETURNED A CODE 44900021
         BE    ETO22400                 TO CONTINUE UL PROCESSING       45000021
*  OTHERWISE, IT IS ASSUMED THE USER RETURNED A CODE = 4, I.E. NO       45100021
*  FURTHER UL PROCESSING.                                               45200021
         B     ETO23100                 UNCONDITIONAL BRANCH            45300021
*                                                                       45400021
ETO23000 EQU   *                        ERROR WRITING LABEL             45500002
*  ERROR WHEN ATTEMPTING TO WRITE LABEL.  GO TO USER WITH ERROR         45600021
*  INDICATIONS, THEN TERMINATE UL PROCESSING (RETURN CODE NOT           45700021
*  EXAMINED).                                                           45800021
         LA    R1,DXIOB                 INSERT POINTER TO STATUS INFO   45900021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 45950002
         ST    R1,ULPARM+K8             IN PARAMETER LIST               46000021
         OI    ULPARM+K8,LASTNTRY+ERROROUT  FLAG IN ERROR               46100021
         BAL   R8,ETO23300              GO TO SYNCH TO USER (BUFFER     46200021
*                                       CONTAINS LABEL UNABLE TO WRITE) 46300021
*                                                                       46400021
ETO23100 EQU   *                        FREE UL WORK AREAS              46500002
*                                                                       46600021
*                                                                       46700021
         LM    RPAR,RWTGC,ULREGSAV      RESTORE REGS 5-8         YM3971 46850002
* FREE USER LABEL WORK AREA, LABEL BUFFER AND PARAMETER LIST     Y02080 46950002
         IECRES FREE,A=(R9),PREFIX=NO,SP=K229,KEY=USER,          Y02082*47000002
               LV=USERLU,STM=(2,14,WTGPREFX)                     Y02082 47050002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 47150002
         LR    R1,RUCB                  RUCB PTR TO AREA TO FREE Y02082 47152002
         LM    R9,RC,ULREGSAV+(R9-RPAR)*K4 RESTORE REGS 9-12     YM3971 47160002
         IECRES FREE,A=(R1),PREFIX=YES,STM=(2,14,WTGPREFX)       Y02082 47170002
         SPACE 2                                                        47200021
         B     ETO21800                 GO WR TM AFTER UL               47300021
         SPACE 2                                                        47400021
*                                                                       47500021
*                                                                       47600021
ETO23200 EQU   *                        SYNCH ENTRY 1                   47700002
         XC    ULPARM+K8(K4),ULPARM+K8  ZERO ERROR IND                  47800021
ETO23300 EQU   *                        SYNCH ENTRY 2                   47900002
         LA    R1,ULBUFR                POINT TO LABEL BUFFER           48000021
ETO23400 EQU   *                        SYNCH ENTRY 3                   48100002
         ST    R1,ULPARM                PTR TO LABEL BUFFER      Y02082 48150002
         L     R1,DXUDCBAD              GET USER'S DCB ADDR      Y02082 48200002
         ST    R1,ULPARM+K4             PUT IN PARM LIST         Y02082 48250002
         XC    ULTOTPTR(K4),ULTOTPTR    ZERO TOTALING ENTRY             48400021
         MVI   ULDCBPTR,K0              CLEAR FLAG BYTE                 48500021
         L     R7,DCBDEBAD              GET ADDRESS OF USER'S DEB       48600021
*                                                                       48700021
ETO23500 EQU   *                        CHECK FOR EXCP                  48800002
         TM    DCBMACRF,DCBMEXCP        CK IF USING EXCP                48900021
         BO    ETO23600                 EXCP, SKIP TOTALING             49000021
         TM    DCBOPTCD,DCBOPTT         CK IF TOTALING SPECIFIED        49100021
         BZ    ETO23600                 BR IF NO TOTALING               49200021
*                                                                       49300021
         L     R7,K40(R7)               GET PTR TO TOTALING AREA        49400021
         USING TOTSAVWA,R7              ESTABLISH BASE FOR AREA         49500021
         MVC   ULTOTPTR(K4),TOTEOVPT    TOTLING PTR TO PARM LIST        49600021
         DROP  R7                       DROP BASE                       49700021
*                                                                       49800021
ETO23600 EQU   *                        NO USER TOTALING                49900002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 49902002
         NI    DCBOFLGS,X'FF'-DCBOLOCK  SET LOCK BIT TO ZERO     Y02082 49904002
*                                                                Y02082 49908002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 49912002
*                                                                Y02082 49916002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,WTGPREFX)          Y02082 49920002
*                                                                Y02082 49924002
         LA    R1,ULPARM                POINT TO PARAMETER LIST         50000021
         MODESET EXTKEY=DATAMGT         D.M. KEY                 Y02082 50136002
         IECRES UEXIT,EXITAD=ULREQ,STM=(2,13,DXXPREFX)           Y02082 50200002
         L     RDCB,DXUDCBAD            GET PTR TO USER'S DCB    Y02082 52716402
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER'S KEY      Y02082 52724002
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT TO ONE      Y02082 52731602
         LA    R0,ALLBITS-DCBOBUSY      ISOLATE BUSY BIT MASK    YM3005 52739202
         IC    R1,DCBOFLGS              GET CALLER'S OFLGS       YM3005 52741202
         MODESET EXTKEY=DATAMGT         RESUME DATA MGT KEY      Y02082 52746802
         L     RDCB,DXPDCBAD            GET PTR TO COPIED DCB    Y02082 52754402
         OR    R0,R1                    ISOLATE CALLER BUSY BIT  YM3005 52762002
         IC    R1,DCBOFLGS              GET COPIED DCBOFLGS      YM3005 52772002
         NR    R1,R0                    UPDTE BUSY BIT TO CALLER YM3005 52782002
         STC   R1,DCBOFLGS              UPDATE DCBOFLGS IN COPY  Y02082 52792402
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT TO ONE             52900021
         ST    RF,ULWK1                 SAVE RETURN CODE                53000021
*                                                                Y02082 53084002
*     COPY USER LABEL TO EOV'S BUFFER                            Y02082 53086002
*                                                                Y02082 53088002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 53088402
*     GET LOCAL LOCK                                             Y02082 53088802
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 53089202
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 53089602
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*53089702
               RELATED=('PREVEMT FREE USER CORE-RELEASED BELOW') Y02082 53089802
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 53089902
*     VERIFY USER STILL HOLD USER LABEL WORK AREA                Y02082 53090602
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 53091002
         OC    ULUWK(USERLU),ULUWK      PGM CHECK IF NOT         Y02082 53091402
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 53091802
         MVC   ULDMBUFR,ULBUFR          COPY LABEL TO EOV'S BUFF Y02082 53091902
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 53118902
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 53128902
*     FREE LOCAL LOCK                                            Y02082 53138902
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 53140902
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 53142902
         MODESET EXTKEY=DATAMGT         D.M. KEY                 Y02082 53144902
         L     RF,ULWK1                 RESTORE RETURN CODE      Y01021 53146002
         BR    R8                       RETURN                          53173002
*                                                                       53200021
         SPACE 1                                                        53300021
*                                                                       53400021
         SPACE                                                          53500021
*EOV HAS FOUND AN UNCORRECTABLE I/O ERROR, BUT WILL ASK FOR NEW         53600021
*VOLUME RATHER THAN ABEND WITH '137'                                    53700021
         SPACE                                                          53800021
ETO24000 EQU   *                        I/O ERROR DURING CONTROL OPERAT 53900021
         LA    R0,EABD144               INTERNAL CODE 637-04   @ZA02850 53910037
         LA    R7,ID2F2N                GO REJECT VOLUME         Y02134 54100002
         B     ETO22000                 GO XCTL                         54200021
*              ADD 1 TO VOLUME SEQUENCE NUMBER IN DEB                   54204002
*                                                                       54208002
ETO24300 LH    R1,DXVOLSEQ              GET NEW VOL SEQ          Y02134 54212002
         LA    RET,DEBBASND+K4          PT TO ACCESS METH SECT   YM1272 54214002
         USING DEBACSMD,RET             BASE FOR ACCESS METH     YM1272 54216002
         STH   R1,DEBVOLSQ              STORE VOL SEQ NO.        YM1272 54220002
         DROP  RET                                               YM1272 54222002
*                                                                       54224002
*                                                                Y02134 54260802
ETO26500 EQU   *                        PREPARE TO EXIT                 54264002
*                                                                Y02134 54264102
*              RESET TAPEMARK BIT IN DCBOFLGS                           54268002
*                                                                       54272002
         NI    DCBOFLGS,X'FF'-DCBOEOF   RESET TAPEMARK BIT              54276002
         OI    DCBOFLGS,DCBOLOCK        UNLOCK DCB                      54280002
         MVC   DEBDCBAD+K1(L'DEBDCBAD-K1),DXUDCBAD+K1 POINT DEB  Y02082*54286002
                                        TO USER DCB              Y02082 54286402
         L     RF,DXDEBXAD              GET PTR TO DEB EXTENSION YM1272 54287202
         NI    DEBXFLG1-DEBXTN(RF),ALLBITS-DEBXCDCB DEB PT USER  YM1272 54287602
*                        CHECK IF EXCP SPECIFIED                        54288002
         TM    DXOPCLSW,UCBMOUNT        LOAD A.M. EXECUTOR              54292002
         BO    ETO26700                 YES, GO                         54296002
*                                                                Y02134 54296802
ETO26650 EQU   *                        FREE EOV WORK AREA       Y02134 54307402
*                                                                Y02134 54308002
*****************************************************************Y02134 54308102
*                                                                       54308802
*                        RELEASE EOV WORK AREA                          54309402
*                                                                       54310002
*****************************************************************Y02134 54310102
*                                                                Y02134 54310202
         NI    DCBOFLGS,ALLBITS-DCBOBUSY  RESET I/O SUPPORT BIT         54310602
         IECRES INIT,DCBCOPY=FRWKAR,STM=(0,14,DXXPREFX)          Y02082 54314602
*                                                                Y02134 54320002
         LR    R1,RCORE                 LOC OF BYTES TO FREE            54324002
         IECRES FREE,A=(1),PREFIX=EOV                            Y02080 54328002
*                        EXIT                                           54332002
         SR    RF,RF                    ZERO RETURN CODE                54336002
*                                                                Y02080 54340002
*        RETURN TO CALLER                                        Y02080 54344002
*                                                                Y02080 54348002
         IECRES EXIT                    RETURN                   Y02080 54352002
*                                                                Y02080 54364002
*                                                                       54368002
*              LOAD THE ACCESS METHOD EXECUTOR                          54372002
*                                                                       54376002
ETO26700 LA    R7,ID2F1L                GO TO ACCESS METHOD MOD  Y02134 54380002
         B     ETO22000                 BRANCH TO ROUTINE        Y02134 54384002
*                                                                Y02134 54388002
         EJECT                                                          54392002
         SPACE 1                                                        54396002
*                   CONSTANTS                                           54400021
         SPACE 1                                                        54600021
AWTMCCWW CCW   X'1F',0,X'60',80         WRITE TAPE MARK CCW             54700021
ANOPCCW  CCW   X'03',0,X'20',80         NOP, COUNT FOR WRITE CCW        54800021
CHARTBL  DC    C'0003570000046800'      CHAR. TABLE FOR MOD NO @ZA19724 54850037
         DS    0H                                                       54900021
AGRTR30W DC    X'8000'                  VALUE IN LABEL WHEN LRECLGT 32K 55000021
ATRTCH0W DC    C' CET'                  CONVERSION,EVEN PARITY,TRAN     55100021
ARECFM0W EQU   *-1                      RECFM TRANSLATE TABLE           55200021
         DC    C'VFU'                   VARIABLE,FIXED,UNKNOWN REC FMT  55300021
ABLKA0W  DC    C' SBR'                  BLK AATTRB TRANSLATE TABLE      55400021
*                                       CONS                            55500021
HDR0W    DC    C'HDR'                   CHARACTERS HDR                  55600021
BITOFF0W DC    F'127'                   MASK FOR BUFOFF = L BIT         55700021
SNMASK   DC    X'0000FFFF'              SER. NO. MASK          @ZA08326 55800037
*                                                                       55900021
UHLCON   DC    C'UHL'                   HEADER LABEL CONSTANT           56000021
CCW2FK07 DC    X'20000007'              CCW LENGTH ,SILI FLAG  @ZA02210 56060037
*                                                                       56100021
*                                                                Y02134 56120002
         XCTLTABL ID=(ID2F2F,2F,ID2F2N,2N,ID2F1L,1L,             YM1193X56150002
               ID2F4J,4J),SVC=055,BRT=YES,LENGTH=2040,PATCH=100  Y02080 56160037
         IECDSECS CVT,TCB,DCB,UCB,MAIN,USERLAB,USERTOT,RB,       YM1272X57200002
               DSAB,IEZDEB,                                      YM1272X57210002
               TIOT,WTG,PREFX,PSA,RRPL,EXPAND=YES                Y02144 57250002
         IECEQU IEZDEB=YES                                       YM1272 57400002
         END                                                            57500021
