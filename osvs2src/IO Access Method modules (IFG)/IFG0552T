 TITLE 'IFG0552T - EOV TAPE INPUT STD TRAILER LABEL (CONT.) AND VOLUME C00100002
               DISPOSITION FUNCTION'                                    00102002
         COPY  LCGASMSW                                                 00110002
IFG0552T CSECT                                                          00120002
*********************************************************************** 00170002
*                                                                     * 00220002
*                                                                     * 00270002
*          VS2 RELEASE 02 DELETIONS                                   * 00320002
*                                                                     * 00370002
*                                                                     * 00420002
*********************************************************************** 00470002
*                                                                     * 00520002
* MODULE NAME = IFG0552T (OS/VS2)                                     * 00570002
*                                                                     * 00620002
* DESCRIPTIVE NAME = EOV TAPE INPUT STD TRAILER LABEL AND VOLUME      * 00670002
*                    DISPOSITION FUNCTION                             * 00720002
*                                                                     * 00770002
* COPYRIGHT = NONE                                                    * 00820002
*                                                                     * 00870002
* STATUS = RELEASE 2, LEVEL 0                                         * 00920002
*                                                                     * 00970002
* FUNCTION =                                                          * 01020002
*        THIS MODULE PROCESSES TAPE INPUT STANDARD USER TRAILER       * 01070002
*        LABELS FOR END OF VOLUME AND DETERMINES VOLUME DISPOSITION.  * 01120002
*        1) OBTAIN CORE FOR 2 USER LABEL WORK AREAS. A 152 BYTE       * 01170002
*        WORK AREA FOR EOV FROM FETCH PROTECTED SUBPOOL 229 IN DATA   * 01220002
*        MANAGEMENT KEY. A 96 BYTE USER LABEL WORK AREA FOR THE       * 01270002
*        CALLER FROM FETCH PROTECTED SUBPOOL 229 IN THE CALLER'S      * 01320002
*        KEY.                                                         * 01370002
*        2) READ THE USER LABELS FROM THE TAPE AND USE IECRES UEXIT   * 01420002
*        TO SYNCH TO THE CALLER'S USER LABEL EXIT ROUTINE. (UP TO     * 01470002
*        8 LABELS ARE READ EXCEPT FOR ASCII WHICH HAS NO LIMIT.)      * 01520002
*        3) PROCESSING CONTINUES OR TERMINATES ACCORDING TO THE       * 01570002
*        RETURN CODE PASSED IN REGISTER 15 BY THE CALLER AFTER THE    * 01620002
*        CALLER'S USER LABEL ROUTINE HAS COMPLETED. IF THE CALLER'S   * 01670002
*        ROUTINE RETURNS A 4, CONTINUE READING USER LABELS. ANY       * 01720002
*        OTHER RETURN CODE INDICATES TERMINATE USER LABEL PROC.       * 01770002
*        4) AFTER ALL THE USER LABELS HAVE BEEN READ, OR THE CALLER   * 01820002
*        INDICATED TO TERMINATE USER LABEL PROCESSING, FREE THE       * 01870002
*        USER LABEL WORK AREAS.                                       * 01920002
*        5) POSITION THE TAPE AT LOAD POINT FOR READ BACKWARD OR      * 01970002
*        AT END OF DATA SET (BEYOND TRAILER LABELS) FOR READ FORWARD. * 02020002
*        6) IF DATA SET IS AT EOF, TRANSFER CONTROL TO IFG0552X       * 02070002
*        TO PROCESS END OF FILE CONDITION.                            * 02120002
*        7) IF NOT AT EOF (THEN AT EOV), AND SMF IS ACTIVE, TRANSFER  * 02170002
*        CONTROL TO IFG0553B TO PROCESS SMF RECORDS. SET UP           * 02220002
*        DXRETMOD TO RETURN TO IFG0552V.                              * 02270002
*        8) IF SMF NOT ACTIVE, TRANSFER CONTROL TO IFG0552V.          * 02320002
*                                                                     * 02370002
* NOTES = SEE BELOW                                                   * 02420002
*                                                                     * 02470002
*    DEPENDENCIES =                                                   * 02520002
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 02570002
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 02620002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 02670002
*                                                                     * 02720002
*    RESTRICTIONS = NONE                                              * 02770002
*                                                                     * 02820002
*    REGISTER CONVENTIONS =                                           * 02870002
*            R2 POINTS TO DCB                                         * 02920002
*            R4 POINTS TO OPEN WORK AREA                              * 02970002
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 03020002
*            R6 POINTS TO THE WTG TABLE                               * 03070002
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 03120002
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 03170002
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 03220002
*            R10 POINTS TO THE UCB                                    * 03270002
*                                                                     * 03320002
*    PATCH LABEL = SEE THIRD FROM LAST LABEL BEFORE ORG STATEMENT AT  * 03370002
*                  END OF LISTING.                                    * 03420002
*                                                                     * 03470002
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 03520002
*                                                                     * 03570002
*    PROCESSOR = ASSEMBLER XF                                         * 03620002
*                                                                     * 03670002
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 03720002
*                  ORG STATEMENT AT END OF LISTING                    * 03770002
*                                                                     * 03820002
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 03870002
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 03920002
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 03970002
*                                                                     * 04020002
* ENTRY POINT =                                                       * 04070002
*        IFG0552T                                                     * 04120002
*                                                                     * 04170002
*    PURPOSE = SEE FUNCTION                                           * 04220002
*                                                                     * 04270002
*    LINKAGE =                                                        * 04320002
*        THIS MODULE IS TRANSFERRED CONTROL THROUGH THE IECRES-LOAD   * 04370002
*        MACRO INSTRUCTION.                                           * 04420002
*                                                                     * 04470002
* INPUT =                                                             * 04520002
*        GIVEN CONTROL IN PROTECT KEY 5.                              * 04570002
*        REGISTER 2 POINTS TO THE COPIED DCB.                         * 04620002
*        DEBDCBAD POINTS TO THE COPIED DCB.                           * 04670002
*        REGISTER 4 POINTS TO THE EOV WORKAREA                        * 04720002
*                                                                     * 04770002
* OUTPUT =                                                            * 04820002
*        THE NEXT MODULE IS GIVEN CONTROL IN PROTECT KEY 5 WITH       * 04870002
*        REGISTER 2 POINTING TO THE COPIED DCB,                       * 04920002
*        DEBDCBAD POINTING TO THE COPIED DCB,                         * 04970002
*        AND REGISTER 4 POINTING TO THE EOV WORKAREA,                 * 05020002
*                                                                     * 05070002
* EXIT-NORMAL =                                                       * 05120002
*        IFG0552X - PROCESS EOF CONDITION                             * 05170002
*        IFG0553B - PROCESS SMF RECORDS                               * 05220002
*           RETURN MODULE = IFG0552V                                  * 05270002
*        IFG0552V - PROCESS VOLUME POSITIONING                        * 05320002
*                                                                     * 05370002
* EXIT-ERROR =                                                        * 05420002
*        IFG0550P - PROBLEM DETERMINATION                             * 05470002
*           INTERNAL CODE = 149, ERROR POSITIONING AFTER UL PROC      * 05520002
*           INTERNAL CODE = 150, ERROR POSITIONING TO LOGICAL EOD     * 05570002
*                                                                     * 05620002
* EXTERNAL REFERENCES = SEE BELOW                                     * 05670002
*                                                                     * 05720002
*    ROUTINES =                                                       * 05770002
*        IFG019RA THROUGH THE IECRES MACRO.                           * 05820002
*                                                                     * 05870002
*    DATA AREAS =                                                     * 05920002
*        EOV WORKAREA.                                                * 05970002
*                                                                     * 06020002
*    CONTROL BLOCK =                                                  * 06070002
*        CVT                                                          * 06120002
*        DEB                                                          * 06170002
*        JFCB                                                         * 06220002
*        PSA                                                          * 06270002
*        TCB                                                          * 06320002
*        RB                                                           * 06370002
*        TIOT                                                         * 06380002
*        UCB                                                          * 06390002
*                                                                     * 06392002
* TABLES =                                                            * 06394002
*                                                                     * 06396002
* MACROS =                                                            * 06398002
*        MODESET                                                      * 06398402
*        IECRES LOAD                                                  * 06398802
*        IECRES GET                                                   * 06399202
*        IECRES INIT                                                  * 06399602
*        IECRES FREE                                                  * 06399702
*        IECRES UEXIT                                                 * 06399802
*        IECRES WAIT                                                  * 06399902
*        EXCP                                                         * 06433202
*        XLATE                                                        * 06443202
*        SETLOCK                                                      * 06453202
*        DMABCOND                                                     * 06463202
*                                                                     * 06465202
* CHANGE ACTIVITY =                                                   * 06465602
*        SEE CHANGES/DELETIONS SECTION JUST AFTER CSECT CARD.         * 06466002
*                                                                     * 06466402
*********************************************************************** 06466502
         EJECT                                                          06466602
*****    INTERNAL ERROR CODES                                           06466702
*                                                                       06500021
EABD149  EQU   149                      ERROR POS FOLLOWING USER        06600021
*                                       ..TRAILER LABEL PROCESSING      06700021
EABD150  EQU   150                      ERROR POS TO END OF DATA SET    06800021
*                                                                       06900021
         BALR  RBASE,0                  ESTABLISH ADDRESSABILITY        07000021
         USING *,RBASE                                                  07100021
         USING FORCORE,RCORE                                            07200021
         USING WTG,RWTG                                          Y02080 07250002
         USING IHADCB,RDCB                                              07300021
         USING DEB,RDEB                                                 07400021
         USING UCB,RUCB                                                 07500021
         USING TIOENTRY,RTIOT                                           07600021
*                                                                M0110  07609021
*****          DETERMINE TYPE OF ENTRY INTO MODULE               M0110  07618021
*****          ALTHOUGH THERE IS ONLY A SINGLE ENTRY TO THIS     M0110  07627021
*****          MODULE, THE BRANCH TABLE IS UTILIZED TO PERMIT    M0110  07636021
*****          ADDITION OF NEW ENTRY POINTS AT A LATER DATE      M0110  07645021
*                                                                M0110  07654021
         B     ETI04000(RET)            DETERMINE TYPE OF ENTRY  M0110  07663021
ETI04000 EQU   *                        BRANCH TABLE             M0110  07672002
         B     ETI04100                 BR TO PROCESS USER LBLS  M0110  07681002
*                                                                M0110  07690021
*********************************************************************** 17800021
*              USER TRAILER LABEL PROCESSING                          * 17900021
*********************************************************************** 18000021
*                                                                       18100021
ETI04100 EQU   *                        USER TRAILER LABEL              18200002
*                                                                Y02082 18250002
*    OBTAIN CORE FOR USER LABEL WORK AREAS                       Y02082 18300002
*                                                                Y02082 18350002
         IECRES GET,LV=USERLDM,SP=K229,PREFIX=YES,               Y02082*18400002
               STM=(2,14,WTGPREFX),ID=ULWA                       Y02144 18450002
         USING ULDMWK,R1                                         Y02082 18500002
         STM   RES,RC,ULREGSAV          SAVE REGS (INCLUDE DCB   Y02082 18550002
*                                       EXIT LIST ADDR FOR UL)   Y02082 18600002
         DROP  R1                                                       18800021
*                                                                       18900021
*****          RUCB IS NOW USED AS THE USER LABEL WORK AREA BASE REG    19000021
*                                                                       19100021
         LR    RUCB,R1                  POINT TO AREA OBTAINED          19200021
         USING ULDMWK,RUCB              UL W.A. BASE             Y02082 19250002
*    GET CORE FOR USER'S USER LABEL WORK AREA                    Y02082 19300002
         IECRES GET,LV=USERLU,PREFIX=NO,SP=K229,KEY=USER,        Y02082*19350002
               STM=(2,14,WTGPREFX)                               Y02082 19360002
         LR    R9,R1                    PT TO GOTTEN CORE        Y02082 19370002
         USING ULUWK,R9                                          Y02082 19380002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 19390002
         LA    R1,CHAR0                 INITIALIZE COUNT                19400021
         STH   R1,ULCNT                 AND SAVE FOR LATER USE          19500021
         LA    R1,ULDMBUFR              PT TO LABEL BUFFER       Y02082 19550002
         ST    R1,DXCCW1                                                19700021
         MVI   DXCCW1,CCWRDTAP          INITLZ CCW FOR READ COMMAND     19800021
*                                       ..(FLAGS AND LNG STILL IN CCW)  19900021
         MVI   DXCCW1+K4,CCWSILI        SET 'SILI' FLAG ON              20000021
ETI04200 EQU   *                        READ A LABEL                    20100002
         BAL   RC,ETI06700              BR AND LINK TO READ A LABEL     20200021
         BO    ETI04300                 BR IF NO ERROR DURING I/O       20300021
         TM    IOBSTAT0,CSWUNITX        IS ERROR DUE TO UNIT EXCEPTION- 20400021
         BO    ETI05500                 ..BR IF YES- TAPE MARK READ     20500021
         B     ETI05400                 BR IF NOT- PERMANENT ERROR      20600021
ETI04300 EQU   *                        UNUSUAL ERROR CONDITION         20700002
         TM    JFCBLTYP,JFCBAL+JFCBUL   WERE ANSI USER LBLS SPECIFIED-  20800021
         BNO   ETI04400                 ..BR IF NOT- BYPASS TRANSLATION 20900021
         XLATE ULDMBUFR,K80             TRANSLATE ANSI LABEL     Y02082 20910002
ETI04400 EQU   *                        NOT ANSI USER LABELS     Y02082 20920002
         CLC   ULDMBUFR(K3),AUHL        USER HDR LABEL READ?     Y02082 20950002
         BE    ETI04500                 ..BR IF YES                     21300021
         CLC   ULDMBUFR(K3),AUTL        USER TRLR LABEL READ?    Y02082 21350002
         BE    ETI04500                 ..BR IF YES                     21500021
*                                                                       21600021
*              NOTE - INPUT TRAILER LABEL PROCESSING LEAVES THE TAPE    21700021
*              POSITIONED BETWEEN THE FIRST AND SECOND DATA SET         21800021
*              TRAILER LABELS. THE FOLLOWING ALLOWS PROCESSING OF USER  21900021
*              LABELS EVEN THOUGH THE TAPE MAY CONTAIN MORE DATA SET    22000021
*              LABELS THAN CAN CURRENTLY BE CREATED UNDER O/S.          22100021
*                                                                       22200021
         CLC   ULDMBUFR(K3),EOV         EOV LABEL READ?          Y02082 22250002
         BE    ETI04200                 ..BR IF YES- READ ANOTHER LABEL 22400021
         CLC   ULDMBUFR(K3),AEOF1       EOF LABEL READ?          Y02082 22450002
         BE    ETI04200                 ..BR IF YES- READ ANOTHER LABEL 22600021
         CLC   ULDMBUFR(K3),HDR         HDR LABEL READ?          Y02082 22650002
         BE    ETI04200                 ..BR IF YES- READ ANOTHER LABEL 22800021
         MVI   DXCCW1,CCWBSR            INITLZ CCW FOR 'BSR' COMMAND    22900021
         B     ETI05700                 BR- AN 'UNKNOWN' LABEL WAS READ 23000021
ETI04500 EQU   *                        USER HDR LABEL READ             23100002
         MVC   ULCNT+K1(K1),ULDMBUFR+K3 SAVE LABEL NUMBER        Y02082 23108002
         L     RF,WTGPREFX              PT TO PREFIX             Y02082 23116002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS            Y02082 23118002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 23120002
*    OBTAIN LOCAL LOCK                                           Y02082 23122002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*23124002
               RELATED=('PREVENT FREE USER CORE-RELEASED BELOW') Y02082 23126002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 23128002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 23130002
*    VERIFY USER STILL HOLDS USER LABEL BUFFER                   Y02082 23132002
         OC    ULUWK(USERLU),ULUWK      PGM CHECK IF NOT         Y02082 23134002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 23134402
         MVC   ULBUFR,ULDMBUFR          COPY LABEL TO USER       Y02082 23138002
         L     RF,WTGPREFX              PT TO PREFIX             Y02082 23140002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y20082 23142002
*   RELEASE LOCAL LOCK                                           Y02082 23144002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 23146002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 23148002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 23150002
         XC    ULPARM+K8(K4),ULPARM+K8  ZERO ERROR IND                  23300021
ETI04600 EQU   *                        SYNCH TO USER                   23400002
         LA    R1,ULBUFR                POINT TO LABEL BUFFER           23500021
         LA    RD,ETI05300              LOAD ADDR FOR RETURN FROM SYNCH 23600021
ETI04700 EQU   *                        SYNCH TO USER                   23700002
         ST    R1,ULPARM                PTR TO LABEL BUFFER      Y02082 23750002
         L     R1,DXUDCBAD              GET USER'S DCB ADDR      Y02082 23800002
         ST    R1,ULPARM+K4             PUT IN PARM LIST         Y02082 23850002
         XC    ULTOTPTR(K4),ULTOTPTR    ZERO TOTALING ENTRY             24000021
         MVI   ULDCBPTR,K0              CLEAR FLAG BYTE                 24100021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 24100402
         CLC   ULDMBUFR(K3),AUTL        TRLR LABEL PROCESSING    Y02082 24102002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 24152002
         BE    ETI04800                 ..BRANCH IF YES                 24300021
         TM    DCBOFLGS,DCBORDBK        IS THE DCB OPENED FOR 'RDBACK'- 24400021
         BNO   ETI04800                 ..BR IF NOT TO CHECK FOR EOF    24500021
         CLI   DXVOLSEQ+K1,K1           TEST FOR EOF READ BACK   Y02134 24600002
         BNH   ETI05000                 BRANCH IF READ BACK EOF  Y02134 24650002
         B     ETI05100                 BR IF NOT EOF            Y02134 24800002
ETI04800 EQU   *                        IS IT EOF?                      24900002
         CLC   JFCBNVOL,DXVOLSEQ+K1     CHECK FOR EOF            Y02134 25000002
         BNH   ETI05000                 BRANCH TO EOF            Y02134 25050002
         CLC   VOLLABI(K3),AEOF1        CHK FOR EOF IF NOT ON LAST VOL  26100021
*                                       ..OF A MULTI-VOL DATA SET       26200021
         BNE   ETI05100                 ..BR IF NOT TO INDICATE EOV     26300021
ETI05000 EQU   *                        READ BACK EOF                   26400002
         OI    ULDCBPTR,EOFFLG          SET FLAG TO INDICATE EOF        26500021
ETI05100 EQU   *                        NOT EOF                         26600002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 26610002
         NI    DCBOFLGS,ALLBITS-DCBOLOCK  IND USER EXIT TAKEN    Y02082 26650002
*                                                                Y02082 26660002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 26670002
*                                                                Y02082 26680002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,WTGPREFX)          Y02082 26690002
*                                                                Y02082 26692002
         LA    R1,ULPARM                POINT TO PARAMETER LIST         26700021
         IECRES UEXIT,EXITAD=ULREQ,STM=(2,13,DXXPREFX)           Y02082 26800002
         L     RDCB,DXUDCBAD            PT TO CALLER'S DCB       YM3005 26850002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME CALLER'S KEY    YM3005 26900002
         OI    DCBOFLGS,DCBOLOCK        INDICATE RETURN FR USER  Y02082 26950002
         LA    R0,ALLBITS-DCBOBUSY      ISOLATE BUSY BIT MASK    YM3005 27000002
         IC    R1,DCBOFLGS              GET CALLER'S OFLGS       YM3005 27050002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      YM3005 27100002
         L     RDCB,DXPDCBAD            PT TO COPIED DCB         YM3005 27150002
         OR    R0,R1                    ISOLATE CALLER BUSY BIT  YM3005 27200002
         IC    R1,DCBOFLGS              GET COPIED DCBOFLGS      YM3005 27250002
         NR    R1,R0                    UPDTE BUSY BIT TO CALLER YM3005 27300002
         STC   R1,DCBOFLGS              UPDATE OFLGS FIELD       YM3005 27350002
         OI    DCBOFLGS,DCBOLOCK        INDICATE RETURN FROM USER EXIT  29700021
         BR    RD                       RETURN TO CALLER OF SUBROUTINE  29800021
*                                                                       29850002
*                                                                       29860002
ETI05300 EQU   *                        PERMANENT ERROR                 29900002
         CH    RF,RDLBLCOD              SHOULD ADD'L LABELS BE READ-    30000021
         BNE   ETI05800                 ..BR IF NOT- ALL DONE           30100021
         TM    JFCBLTYP,JFCBAL+JFCBUL   WERE ANSI USER LBLS SPECIFIED-  30200021
         BO    ETI04200                 ..BR IF YES- READ ANOTHER LABEL 30300021
         CLI   ULCNT+K1,MAXNOLAB        HAS MAX NO. OF LBLS BEEN READ-  30400021
         BNL   ETI05800                 ..BR IF YES- ALL DONE           30500021
         B     ETI04200                 ..ELSE BR TO READ ANOTHER LABEL 30600021
*                                                                       30700021
*****          ERROR ENCOUNTERED DURING READ                            30800021
*                                                                       30900021
ETI05400 EQU   *                        READ ERROR                      31000002
         LH    R1,ULCNT                 LOAD THE CURRENT LABEL NUMBER,  31400021
         LA    R1,K1(,R1)               ..INCREMENT IT BY 1, AND        31500021
         STH   R1,ULCNT                 ..SAVE UPDATED LABEL NUMBER     31600021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 31602002
         STC   R1,ULBUFR+K3             SAVE THE NUMBER OF THE LABEL    31700021
*                                       ..WHICH COULD NOT BE READ       31800021
         LA    R1,DXIOB                 POINT TO STATUS INFO     Y02082 31802002
         ST    R1,ULPARM+K8             PUT IN PARM LIST         Y02082 31804002
         OI    ULPARM+K8,ERROR          FLAG THE ERROR           Y20082 31806002
         B     ETI04600                 BR TO SYNCH TO USER             31900021
*                                                                       32000021
*              A TAPE MARK HAS BEEN READ. IF USER HAS PREVIOUSLY        32100021
*              PROCESSED ANY LABELS,  REPOSITION TAPE, FREEMAIN,        32200021
*              AND RETURN TO CALLER. IF USER HAS NOT PREVIOUSLY         32300021
*              PROCESSED ANY LABELS, SYNCH TO USER WITH LABEL           32400021
*              BUFFER POINTER SET TO ZERO, THEN REPOSITION              32500021
*              TAPE, FREEMAIN, AND RETURN TO CALLER.                    32600021
*                                                                       32700021
ETI05500 EQU   *                        TAPE MARK READ                  32800002
         CLI   ULCNT+K1,CHAR0           HAVE LABELS PREVIOUSLY BEEN     32900021
*                                       ..PROCESSED                     33000021
         BH    ETI05600                 ..BRANCH IF YES                 33100021
         TM    JFCBLTYP,JFCBAL+JFCBUL   WERE ANSI USER LBLS SPECIFIED-  33200021
         BO    ETI05600                 ..BRANCH IF YES                 33300021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 33302002
         XC    ULPARM+K8(K4),ULPARM+K8  ZERO ERROR PARM                 33400021
         SR    R1,R1                    ZERO BUFFER PTR                 33500021
         BAL   RD,ETI04700              BR AND LINK TO SYNCH TO USER    33600021
ETI05600 EQU   *                        ANSI LABELS PROCESSED           33700002
         MVI   DXCCW1,CCWBSF            INITLZ CCW FOR 'BSF'            33800021
ETI05700 EQU   *                        UNKNOWN LABEL READ              33900002
         LA    RD,EABD149               INTERNAL ERROR CODE IN CASE OF  34000021
*                                       ..POSITIONING ERROR             34100021
         MVC   DXCCW1+K4(K4),CHNCOUNT   CHAIN TO 'NOP', SET CT TO 1     34200021
         BAL   RC,ETI06700              BR AND LINK TO PERFORM BACKSPAC 34300021
         BNO   ETI06800                 BR IF I/O ERROR                 34400021
ETI05800 EQU   *                        ALL LABELS READ                 34500002
*                                                                Y02082 34530002
*    FREEMAIN USER LABEL WORK AREAS                              Y02082 34560002
*                                                                Y02082 34590002
         IECRES FREE,A=(R9),PREFIX=NO,LV=USERLU,SP=K229,         Y02082*34620002
               KEY=USER,STM=(2,14,WTGPREFX)                      Y02082 34650002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 34680002
         LR    R1,RUCB                  PTR TO AREA TO BE FREED  Y02082 34710002
         LM    RES,RC,ULREGSAV          RESTORE REGS             Y02082 34740002
         IECRES FREE,A=(1),PREFIX=YES,STM=(2,14,WTGPREFX)        Y02082 34770002
*                                                                       35000021
*****          'RUCB' IS NOW USED AS THE BASE REGISTER FOR THE UCB      35100021
*                                                                       35200021
         USING UCB,RUCB                                                 35300021
*********************************************************************** 35500021
*              POSITION TAPE BEYOND LABELS                            * 35600021
*********************************************************************** 35700021
*                                                                       35800021
ETI05900 EQU   *                        POSITION TAPE                   35900002
         LA    RD,EABD150               INTERNAL ERROR CODE IN CASE OF  36000021
*                                       ..POSITIONING ERROR             36100021
         MVC   DXCCW1,ABSFCCW1          INITLZ CCW FOR 'BACKSPACE FILE' 36200021
         TM    DCBOFLGS,DCBORDBK        IS THIS READ BACKWARD MODE-     36300021
         BNO   ETI06000                 ..BR IF NOT TO POSITION         36400021
         BAL   RC,ETI06700              BACKSPACE PAST HEADER LABELS    36500021
         BNO   ETI06800                 IF I/O ERR, BR TO ERROR RTN     36600021
         MVI   DXCCW1,CCWNOP            INITLZ CCW FOR 'NOP' COMMAND    36700021
         BAL   RC,ETI06700              ISSUE 'NOP' TO TAPE DRIVE       36800021
         BO    ETI06000                 IF NO I/O ERR, BR TO FWD SPACE  36900021
         TM    IOBSENS1,UCBLDPT         ARE WE AT LOAD POINT-           37000021
         BO    ETI06100                 ..BR IF YES TO CONTINUE         37100021
         B     ETI06800                 ..ELSE BR TO ERROR ROUTINE      37200021
ETI06000 EQU   *                        POSITION OR FWDSPACE            37300002
         MVI   DXCCW1,CCWFSF            INITLZ CCW FOR 'FWD SPACE FILE' 37400021
         OI    DXCCW1+K4,CCWCMDCH       CHAIN TO 'NOP' COMMAND          37500021
         BAL   RC,ETI06700              FSF TO END OF DATA SET (READ    37600021
*                                       ..FORWARD OR PRECEDING HEADER   37700021
*                                       ..LABELS (RDBACK)               37800021
         BNO   ETI06800                 IF I/O ERR, BR TO ABEND         37900021
*                                                                       37950002
*                                                                       37960002
*********************************************************************** 37970002
*                                                                     * 37980002
*         EOV TAPE INPUT VOLUME DISPOSITION FUNCTION                  * 38000002
*                                                                     * 38050002
*********************************************************************** 38100002
*                                                                       38150002
*                                                                       38200002
*********************************************************************** 46200021
*              DETERMINE WHETHER EOV OR EOF HAS OCCURRED              * 46300021
*********************************************************************** 46400021
*                                                                       46500021
ETI06100 EQU   *                        DETERMINE EOV/EOF               46600002
         MVC   DXCCW1,ABSFCCW1          SETUP BASIC CCW                 46700021
         L     RUCB,DXUCBADR            LOAD CURRENT UCB         Y02134 46800002
         MVC   DXCCW7+K4(K4),SRTEFSCT   SAVE SEQ CT/ NO. IN WORK AREA   46900021
         LA    RF,MOD2T2X               PT TO ID/TTR OF EOF MODULE      47000021
         SR    RET,RET                  LD BR TABLE OFFSET FOR THAT MOD 47100021
         TM    DCBOFLGS,DCBORDBK        IS THIS 'READBACK' MODE-        47200021
         BO    ETI06400                 ..BR IF YES TO READBACK RTN     47300021
*                                                                       47400021
*****          READ FORWARD TESTING FOR EOV                             47500021
*                                                                       47600021
         MVC   DXCCW7(L'DXVOLSEQ),DXVOLSEQ SAVE VOL SEQ          Y02134 47700002
         CLC   JFCBNVOL,DXVOLSEQ+K1     TEST IF AT EOF           Y02134 48500002
         BNH   ETI06600                 ..BRANCH IF YES          Y02134 48600002
*                                                                       48700021
*****          PERFORM POSITIVE CHECK FOR END-OF-FILE IF ON OTHER       48800021
*****          THAN THE LAST VOLUME OF A MULTI-VOLUME DATA SET.         48900021
*                                                                       49000021
         TM    JFCOPTCD,JFCALLOW        DO WE BYPASS EOF PROCESSING-    49100021
         BO    ETI06500                 ..BRANCH IF YES                 49200002
         CLC   VOLLABI(K3),AEOF1        TEST FOR 'E-O-F' LABEL-         49300021
         BE    ETI06600                 ..BRANCH IF YES                 49400021
         B     ETI06500                 ..BR TO TEST FOR SMF PROCESSING 50200021
*                                                                       50300021
*****    READ BACKWARD TESTING FOR EOF                                  50400021
*                                                                       50500021
ETI06400 EQU   *                        READBACK ROUTINE                50600002
         CLI   DXVOLSEQ+K1,K1           TEST FOR EOF READ BACK   Y02134 50700002
         BNH   ETI06600                 BRANCH IF EOF            Y02134 50800002
*********************************************************************** 51000021
*              END-OF-VOLUME PROCESSING                               * 51100021
*********************************************************************** 51200021
*                                                                       51300021
ETI06500 EQU   *                        EOV PROCESSING                  51600002
*                                                                       51650021
         LA    RF,MOD2T2V               PT TO ID/TTR OF POSITIONING MOD 51700021
         SR    RET,RET                  LD BR TABLE OFFSET FOR THAT MOD 51800021
*                                                                       51900021
*****          DETERMINE WHETHER OR NOT SMF PROCESSING IS REQUIRED      52000021
*                                                                       52100021
         TM    DXXPATHS,WTGSMF          IS SMF PROCESSING REQ'D- A38013 52400021
         BNO   ETI06600                 ..BR IF NOT- XCTL TO VOL A38013 53000021
*                                       ..POSITIONING FUNCTION   A38013 53600021
         LA    RF,MODSMF2T              PT TO SMF MODULE'S ID/TTR       54200021
         LA    RET,K4                   LD BR TABLE OFFSET FOR THAT MOD 54300021
         MVC   DXRETMOD(K5),MOD2T2V     MOVE POSITIONING MOD ID/TTR     54400021
*                                       ..INTO RETURN ADDRESS SAVE AREA 54500021
         SPACE 2                                                        54600021
*********************************************************************** 54700021
*              EXIT                                                   * 54800021
*********************************************************************** 54900021
*                                                                       55000021
ETI06600 EQU   *                        EXIT                            55100002
         IECRES LOAD,MODID=(RF),BRCODE=(RET),BRANCH=QUEUED       Y02080 55250002
*                                  INVOKE IECRES MACRO TO 'XCTL' Y02080 55260002
         EJECT                                                          55300021
*********************************************************************** 55400021
*              SUBROUTINES                                            * 55500021
*********************************************************************** 55600021
*                                                                       55700021
*****          CLOSED SUBROUTINE TO PERFORM I/O OPERATIONS              55800021
*****          ENTRY TO THE SUBROUTINE IS VIA A 'BAL  RC,ETI06700'      55900021
*                                                                       56000021
ETI06700 EQU   *                        I/O SUBROUTINE                  56100002
         EXCP  DXIOB                    INITIATE I/O OPERATION          56200021
         IECRES WAIT                    INVOKE IECRES MACRO TO 'WAIT'   56300021
         TM    DXECB,ECBNOERR           TEST FOR AN UNUSUAL I/O CONDITI 56400021
         BR    RC                       RETURN TO CALLER OF SUBROUTINE  56500021
         SPACE 2                                                        56600021
*********************************************************************** 56700021
*              ERROR PROCESSING                                       * 56800021
*********************************************************************** 56900021
*                                                                       57000021
ETI06800 EQU   *                        ERROR ROUTINE/ ABEND            57100002
         DMABCOND (RD),ABEND2T          EXIT TO PROB DETERMINATION RTN  57200021
         SPACE 2                                                        57300021
*********************************************************************** 57400021
*              CONSTANTS                                              * 57500021
*********************************************************************** 57600021
*                                                                       57700021
ABSFCCW1 CCW   X'2F',0,X'20',1          BSF CMD, SILI FLAG, LNG EQ 1    57800021
CHNCOUNT DC    X'60000001'              CMD CHAIN & SILI FLAGS, LNG EQ  57900021
RDLBLCOD DC    H'4'                     RET CODE IND 'READ ANOTHER LABE 58000021
AEOF1    DC    C'EOF'                   TRAILER LABEL IDENTIFIER        58100021
EOV      DC    C'EOV'                   'EOV' TRAILER LABEL IDENTIFIER  58200021
HDR      DC    C'HDR'                   FIRST THREE CHAR OF DATA SET LA 58300021
AUHL     DC    C'UHL'                   USER HEADER LABEL IDENTIFIER    58400021
AUTL     DC    C'UTL'                   USER TRAILER LABEL IDENTIFIER   58500021
         EJECT                                                          58600021
*********************************************************************** 58700021
*              XCTL TABLE                                             * 58800021
*********************************************************************** 58900021
*                                                                       59000021
XCTLTB2R XCTLTABL ID=(ABEND2T,0P,MOD2T2V,2V,MOD2T2X,2X,MODSMF2T,3B),   C59100021
               SVC=055,BRT=YES,LENGTH=                           Y02080 59200002
         SPACE 2                                                        59300021
         IECDSECS CVT,                                                 C59400021
               TCB,                                                    C59500021
               RB,                                                     C59600021
               TIOT,                                                   C59700021
               WTG,                                              A38013C59800021
               DCB,                                                    C59900021
               DEB,                                                    C60000021
               UCB,                                                    C60100021
               MAIN,                                                   C60200021
               USERLAB,                                                C60300021
               PREFX,                                            Y02080*60350002
               RRPL,                                             Y02144*60360002
               PSA,                                              Y02082*60380002
               EXPAND=YES                                               60400021
         IECEQU ,                       INVOKE OPEN/CLOSE/EOV EQUATES   60500021
         SPACE 2                                                        60600021
         END                                                            60700021
