         TITLE 'IFG0553F - NEW VOLUME HEADER LABEL VERIFICATION'        00100021
         COPY  LCGASMSW                                                 00110002
IFG0553F CSECT                                                          00115002
*********************************************************************** 00165002
*                                                                     * 00215002
*          VS2 RELEASE 03 DELETIONS                                   * 00325000
*0000297556                                                     ZA00011 00335000
*                                                                     * 00335437
*          VS2-037 ADDITIONS, CHANGES, AND DELETIONS                  * 00335837
*0000A012993-013013,A019706-019726,A538000-538880              @ZA28943 00336237
*                                                                     * 00336637
*          VS2 RELEASE 04 DELETIONS                                   * 00337037
*0000022200                                                    @ZA03660 00345037
*                                                                     * 00365002
*                                                                     * 00415002
*********************************************************************** 00417002
*                                                                     * 00419002
* MODULE NAME = IFG0553F (OS/VS2)                                     * 00421002
*                                                                     * 00423002
* DESCRIPTIVE NAME = NEW VOLUME HEADER LABEL VERIFICATION             * 00423402
*                                                                     * 00423802
* COPYRIGHT = NONE                                                    * 00424202
*                                                                     * 00424602
* STATUS = RELEASE 2, LEVEL 0                                         * 00424702
*                                                                     * 00424802
* FUNCTION =                                                          * 00424902
*        1) THIS FUNCTION POSITIONS DATA SETS ON AL, NL, AND SL TAPE  * 00427702
*        TO THE DESIRED DATA SET AS INDICATED BELOW. AT THIS POINT,   * 00429702
*        THE MOUNT/VERIFY ROUTINE HAS COMPLETED BUT THE TAPE MAY      * 00431702
*        NOT BE POSITIONED CORRECTLY.                                 * 00432102
*        1A) NL TAPES ARE POSITIONED TO EITHER THE INTERBLOCK GAP     * 00432502
*        PRECEDING THE FIRST DATA RECORD (READ FORWARD) OR TO THE     * 00432902
*        INTERBLOCK GAP FOLLOWING THE LAST DATA RECORD(RDBACK).       * 00433302
*        1B) AL AND SL TAPES ARE POSITIONED TO EITHER THE INTERBLOCK  * 00433802
*        GAP PRECEDING HEADER LABEL 1 (READ FORWARD) OR PRECEDING     * 00434202
*        TRAILER LABEL 1 (READBACK).                                  * 00434602
*        2) WHEN A CONCATENATED DATA SET IS TO BE PROCESSED, THE JFCB * 00434702
*        FILE SEQUENCE NUMBER (JFCBFLSQ) INDICATES THAT DATA SET'S    * 00434802
*        POSITION ON THE TAPE; THIS FIELD IS UTILIZED AS FOLLOWS:     * 00434902
*        3A) FOR NL TAPES OR DATA SETS ON AL OR SL TAPE WITH A JFCB   * 00435802
*        FILE SEQUENCE NO. OF 1, THE DESIRED POSITION (JFCBFLSQ) IS   * 00437802
*        COMPARED TO THE CURRENT TAPE POSITION (SRTEFSCT) AND THE     * 00437902
*        TAPE IS MOVED BACKWARD OR FORWARD AS REQUIRED. POSITION      * 00438102
*        WITHIN THE DATA SET IS AS SPECIFIED IN SECTION (1) ABOVE.    * 00438502
*        3B) FOR DATA SETS ON AL OR SL TAPE WITH A JFCB FILE SEQUENCE * 00438602
*        NUMBER GREATER THAN 1, HEADER LABEL 1 OF THE FIRST DATA      * 00438702
*        SET ON THE TAPE IS READ TO OBTAIN THE FILE SEQUENCE NO.      * 00438802
*        (IE. LOGICAL POSITION) ON THE TAPE OF THAT DATA SET. IF      * 00439002
*        THAT FILE SEQUENCE NO. IS '1', THEN THE TAPE IS POSITIONED   * 00439402
*        AS IN (3A) ABOVE. IF THAT FILE SEQUENCE NO. IS GREATER       * 00439502
*        THAN '1', THEN THE DIFFERENCE BETWEEN THIS FILE SEQUENCE     * 00439602
*        NO. AND THAT OF THE DESIRED DATA SET INDICATES THE PHY-      * 00440002
*        SICAL POSITION OF THE DESIRED DATA SET ON THE TAPE. POSI-    * 00440402
*        TIONING WITHIN THE DATA SET IS AS SPECIFIED IN SECTION(1).   * 00440502
*        4) CONTROL IS TRANSFERRED TO IFG0553H (BRANCH CODE=24) FOR   * 00440602
*        NL TAPES.                                                    * 00440702
*        5) FOR NSL, A DCB COPY IS PERFORMED FROM THE WORK AREA TO    * 00441002
*        THE CALLER'S CORE, AND CONTROL IS PASSED TO NSLEHDRI WITH    * 00441402
*        A BRANCH CODE OF 20.                                         * 00441802
*        6) READ FILE LABEL 1 AND VERIFY IT IS HDR1, EOV1, OR EOF1.   * 00441902
*        7) COMPARE THE LEAST SIGNIFICANT (IE. LAST) 17 CHARACTERS    * 00442002
*        OF THE DATA SET NAME IN THE JFCB TO THE DATA SET NAME IN     * 00442102
*        FILE LABEL 1. IF THE NAMES ARE NOT IDENTICAL AND THE DATA    * 00442202
*        SET IS A MEMBER OF A GENERATION DATA GROUP, THEN THE UN-     * 00443902
*        QUALIFIED DATA SET NAME, THE GENERATION NUMBER, AND THE      * 00445902
*        VERSION NUMBER ARE ALL VERIFIED SEPARATELY. AN ERROR EXIT    * 00446002
*        IS TAKEN WHEN THE VARIOUS COMPARANDS ARE NOT IDENTICAL;      * 00449702
*        8) IF THE DCB CONTAINS A TAPE-DEPENDENT SECTION, THE BLOCK   * 00451702
*        COUNT FROM THE LABEL IS CONVERTED TO BINARY AND PLACED       * 00453702
*        IN THE DCB.                                                  * 00455702
*        9) PERFORM CHECKPOINT DATA SET PROCESSING.                   * 00456102
*        10) PROCESS INPUT USER HEADER LABELS, IF REQUIRED-           * 00456502
*        10A) GET 2 USER LABEL WORK AREAS. A 152 BYTE AREA FROM FETCH * 00456902
*        PROTECTED SUBPOOL 229 IN DATA MANAGEMENT KEY FOR EOV, AND A  * 00457302
*        96 BYTE AREA FROM THE SAME SUBPOOL IN CALLER'S KEY FOR THE   * 00457502
*        CALLER.                                                      * 00457902
*        10B) A LABEL IS READ AND CONTROL IS PASSED TO THE USER VIA A * 00458402
*        IECRES-UEXIT MACRO. ADDITIONAL LABELS ARE READ IF THE USER   * 00458802
*        PASSES A RETURN CODE OF '4'; THIS CONTINUES UNTIL EITHER THE * 00459202
*        MAXIMUM NUMBER OF LABELS HAS BEEN READ OR UNTIL THE USER     * 00459302
*        INDICATES THAT PROCESSING IS TO TERMINATE. THE RETURN CODES  * 00459802
*        THAT THE USER PASSES IN REG 15 ARE AS FOLLOWS:               * 00460202
*        0 - CONTINUE READING USER LABELS;                            * 00460602
*        4 - DISCONTINUE PROCESSING USER LABELS;                      * 00460702
*        11) POSITION THE TAPE TO THE FIRST DATA RECORD; IE. AT THE   * 00461002
*        INTERBLOCK GAP PRECEDING THE FIRST DATA RECORD (READ FORWARD)* 00461402
*        OR AT THE INTERBLOCK GAP FOLLOWING THE LAST DATA RECORD      * 00461802
*        (READ BACKWARD).                                             * 00462202
*        12) TRANSFER CONTROL TO IFG0553H WITH A BRANCH CODE = 0.     * 00462602
*                                                                     * 00463002
* NOTES = SEE BELOW                                                   * 00463102
*                                                                     * 00463402
*    DEPENDENCIES =                                                   * 00463802
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 00464202
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 00464302
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 00464402
*                                                                     * 00464502
*    RESTRICTIONS = NONE                                              * 00464602
*                                                                     * 00465502
*    REGISTER CONVENTIONS =                                           * 00465902
*            R2 POINTS TO DCB                                         * 00466302
*            R4 POINTS TO OPEN WORK AREA                              * 00466702
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 00467102
*            R6 POINTS TO THE WTG TABLE                               * 00467202
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 00467502
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 00467902
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 00468002
*            R10 POINTS TO THE UCB                                    * 00468102
*                                                                     * 00468702
*    PATCH LABEL = SEE THIRD FROM LAST LABEL BEFORE ORG STATEMENT AT  * 00469102
*                  END OF LISTING.                                    * 00469502
*                                                                     * 00469902
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 00470002
*                                                                     * 00470102
*    PROCESSOR = ASSEMBLER XF                                         * 00470602
*                                                                     * 00471002
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 00471402
*                  ORG STATEMENT AT END OF LISTING                    * 00471802
*                                                                     * 00471902
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 00472002
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 00472102
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 00472402
*                                                                     * 00472802
* ENTRY POINT =                                                       * 00472902
*        IFG0553F                                                     * 00473002
*                                                                     * 00473102
*    PURPOSE = SEE FUNCTION                                           * 00473202
*                                                                     * 00473602
*    LINKAGE =                                                        * 00473702
*        THIS MODULE IS TRANSFERRED CONTROL THROUGH THE IECRES-LOAD   * 00473802
*        MACRO INSTRUCTION.                                           * 00474202
*                                                                     * 00474302
* INPUT =                                                             * 00474402
*        GIVEN CONTROL IN PROTECT KEY 5.                              * 00474502
*        REGISTER 2 POINTS TO THE COPIED DCB.                         * 00475102
*        DEBDCBAD POINTS TO THE COPIED DCB.                           * 00475502
*        REGISTER 4 POINTS TO THE EOV WORKAREA                        * 00475902
*                                                                     * 00476302
* OUTPUT =                                                            * 00476702
*        THE NEXT MODULE IS GIVEN CONTROL IN PROTECT KEY 5 WITH       * 00477102
*        REGISTER 2 POINTING TO THE COPIED DCB,                       * 00477502
*        DEBDCBAD POINTING TO THE COPIED DCB,                         * 00477602
*        AND REGISTER 4 POINTING TO THE EOV WORKAREA,                 * 00478002
*                                                                     * 00478202
* EXIT-NORMAL =                                                       * 00478302
*        IFG0553H - NORMAL EXIT, BRANCH CODE = 0                      * 00478402
*                   NL LOOK-AHEAD MOUNT, BRANCH CODE = 24             * 00478502
*        IFG0554J - ISSUE SECURE VOLUME MESSAGE, BRANCH CODE = 56     * 00479102
*           RETURN MODULE - IFG0553F, BRANCH CODE = 4                 * 00479502
*                                                                     * 00479902
* EXIT-ERROR =                                                        * 00480302
*        IFG0550P - PROBLEM DETERMINATION                             * 00480702
*             INTERNAL CODE = 162, ERROR POS CONCAT DATA SET          * 00481002
*             INTERNAL CODE = 163, ERROR POS NEW VOL FOR READ FORWARD * 00481402
*             INTERNAL CODE = 164, ERROR READING HEADER LABEL         * 00481802
*             INTERNAL CODE = 165, INCORRECT DATA SET NAME            * 00481902
*             INTERNAL CODE = 191, ERR POS TO FIRST DATA RECORD       * 00482002
*             INTERNAL CODE = 194, ERROR POS NEW VOL FOR RDBACK       * 00482102
*             INTERNAL CODE = 195, INVALID HEADER LABEL READ          * 00482202
*             INTERNAL CODE = 196, ERR POS AFTER USER LABEL PROCESSING* 00482302
*             INTERNAL CODE = 240, CHK PT DS ON NON SEC VOL           * 00482402
*             INTERNAL CODE = 241, NON CHK PT DS ON SECURE VOL        * 00482502
*                                                                     * 00482602
* EXTERNAL REFERENCES = SEE BELOW                                     * 00482702
*                                                                     * 00482802
*    ROUTINES =                                                       * 00483402
*        IFG019RA THROUGH THE IECRES MACRO.                           * 00483802
*                                                                     * 00484202
*    DATA AREAS =                                                     * 00484602
*        EOV WORKAREA.                                                * 00485002
*                                                                     * 00485102
*    CONTROL BLOCK =                                                  * 00485802
*        CVT                                                          * 00487802
*        DEB                                                          * 00487902
*        DSAB                                                         * 00488002
*        JFCB                                                         * 00488102
*        PSA                                                          * 00488202
*        TCB                                                          * 00488602
*        UCB                                                          * 00488802
*        RB                                                           * 00489202
*                                                                     * 00489302
* TABLES =                                                            * 00489402
*                                                                     * 00489502
* MACROS =                                                            * 00489702
*        IECRES LOAD                                                  * 00489802
*        IECRES GET                                                   * 00489902
*        IECRES INIT                                                  * 00490002
*        IECRES FREE                                                  * 00490302
*        IECRES WAIT                                                  * 00490702
*        IECRES UEXIT                                                 * 00491102
*        DMABCOND                                                     * 00491502
*        EXCP                                                         * 00491602
*        DEBCHK                                                       * 00491702
*        XLATE                                                        * 00491802
*        SETLOCK                                                      * 00491902
*                                                                     * 00492002
* CHANGE ACTIVITY =                                                   * 00492102
*        SEE CHANGES/DELETIONS SECTION JUST AFTER CSECT CARD.         * 00492502
*                                                                     * 00492902
*********************************************************************** 00493002
         EJECT                                                          00493402
*                                                                       00493502
*****          INTERNAL ERROR CODES                                     00493602
*                                                                       00493702
EABD162  EQU   162                      ERROR POS CONCATENATED DATA SET 00493802
EABD163  EQU   163                      ERROR POS NEW VOL FOR RD FWD    00493902
EABD194  EQU   194                      ERROR POS NEW VOL FOR RDBACK    00494002
*                                                                       00494102
EABD164  EQU   164                      ERROR READING HEADER LABEL      00494202
EABD165  EQU   165                      INCORRECT DATA SET NAME         00494302
EABD191  EQU   191                      ERROR POSITIONING TO            00494402
*                                       ..FIRST DATA RECORD             00495002
EABD195  EQU   195                      INVALID HEADER LABEL READ       00498102
EABD196  EQU   196                      ERR POSITIONING FOLLOWING USER  00501802
*                                       ..HEADER LABEL PROCESSING       00505502
EABD240  EQU   240                      CHK PT DS ON NON SEC VOL Y02083 00509202
EABD241  EQU   241                      NON CHK PT DS ON SEC VOL Y02083 00512902
EABD249  EQU   249                      937-20 ABEND CODE        YM5950 00514902
CHARC    EQU   C'C'                     CHARACTER C              Y02083 00516602
*                                                                       00520302
         BALR  RBASE,0                  ESTABLISH ADDRESSABILITY        00524002
         USING *,RBASE                                                  00527702
         USING FORCORE,RCORE                                            00531402
         USING WTG,RWTG                 BASE FOR WTG TABLE       Y02080 00535102
         USING IHADCB,RDCB                                              00538802
         USING UCB,RUCB                                                 00542502
*                                                                       00545702
         USING DEB,RDEB                                                 00546202
         B     LABEL00(RET)             BR ON REG 14 CODE        Y02083 00549902
LABEL00  B     ETI18700                 NORMAL ENTRY             Y02083 00553602
         B     ETI24030                 RETURN FROM IFG0554J     Y02083 00557302
         B     ETI24016                 RETURN FROM SECURITY     YM5950 00559302
         B     ETI24011                 ASCII DISMOUNT RETURN    YM5950 00559702
*                                                                       00561002
*                                                                       01115002
*****    NOTE- 'RTIOT' AND 'RDEB' ARE NOW USED AS WORK REGISTERS        01120002
*                                                                       01125002
ETI18700 EQU   *                        CHECK FOR READBACK              01130002
         L     RDEB,DCBDEBAD            GET DEB ADDRESS          YM3929 01132002
         STCM  RUCB,B'0111',DEBUCBAD+K1 PUT UNIT ADDR INTO DEB   YM3929 01134002
         LH    RD,SRTEFSCT              GET UCB FILE SEQ CT      YM4646 01134402
         LTR   RD,RD                    IS UCBFSCT EQ ZERO       YM4646 01134802
         BNZ   ETI18750                 BR IF NOT                YM4646 01134902
         MODESET EXTKEY=ZERO            ASSUME UCB KEY           YM4646 01139802
         MVI   SRTEFSCT+K1,K1           SET UCB FSCT TO ONE      YM4646 01149802
         MVI   SRTEFSEQ+K1,K1           SET LOGICAL CT TO 1      YM5950 01151802
         MODESET EXTKEY=DATAMGT         ASSUME DATA MGT KEY      YM4646 01159802
ETI18750 EQU   *                        UCB FSCT NOT ZERO        YM4646 01160202
         TM    DCBOFLGS,DCBORDBK        IS THE DCB OPENED FOR 'RDBACK'- 01161102
         BO    ETI20300                 ..BR IF YES TO POS FOR 'RDBACK' 01166002
         LA    RD,EABD163               LOAD INTERNAL ERROR CODE        01170902
         TM    DCBOFLGS,DCBOCON         IS CONCATENATION IN PROGRESS-   01175802
         BZ    ETI19900                 ..BRANCH IF NOT                 01180702
*                                                                       01185602
*********************************************************************** 01190502
*              POSITIONING FOR A CONCATENATED DATA SET                * 01195402
*********************************************************************** 01200302
*                                                                       01205202
ETI18800 EQU   *                        CONCATENATION POSITIONING       01207202
         LA    RD,EABD162               LOAD INTERNAL ERROR CODE        01215002
         LH    RET,JFCBFLSQ             LOAD FILE SEQ NO. FROM JFCB     01219902
         CH    RET,REWND+6              IS JFCB FILE SEQ NO. EQ 1-      01224802
         BE    ETI18900                 ..BR IF YES                     01229702
         BH    ETI19000                 ..BR IF GREATER THAN 1          01234602
*                                                                       01239502
*****          PROCESS FILE SEQUENCE NUMBER EQUAL TO 0                  01244402
*                                                                       01249302
         LA    RET,K1                   INITLZ FOR FILE SEQ NO. EQUAL 1 01254202
         MVI   JFCBFLSQ+K1,K1           SET JFCB FILE SEQ NO. TO 1      01256202
         OI    DXXPATHS,WTGJFCBW        TURN ON JFCB 'WRITE-BACK' IND   01258202
*                                                                       01268902
*****          PROCESS FILE SEQUENCE NUMBER EQUAL TO 1                  01273802
*                                                                       01278702
ETI18900 EQU   *                        FILE SEQUENCE EQ ONE            01280702
         MODESET EXTKEY=SUPR            UCB/TIOT KEY             Y02082 01288502
         STH   RET,SRTEFSEQ             ST LOGICAL FILE SEQ NO. IN UCB  01293402
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 01298302
         TM    JFCBLTYP,JFCBLTM         LTM SPECIFIED ?        @2A28943 01299337
         BZ    ETI19900                 NO, BRANCH             @ZA28943 01300337
         BAL   RB,ETI26600              BR TO BYPASS LTM       @ZA28943 01301337
         B     ETI19900                 BR TO PERFORM POSITIONING       01303202
*                                                                       01308102
*****          PROCESS FILE SEQUENCE NUMBER GREATER THAN 1              01313002
*                                                                       01317902
ETI19000 EQU   *                        FILE SEQUENCE GT ONE            01319902
         TM    JFCBLTYP,JFCBAL+JFCSL    WAS SL OR AL SPECIFIED-         01327702
         BZ    ETI19500                 ..BR IF NOT- PERFORM NL POS     01332602
         CLC   SRTEFSCT(K2),REWND+K6    IS THE CURRENT POSITION '1'-    01334602
         BNE   ETI19300                 ..BR IF NOT TO POSITION         01342402
*                                                                       01347302
*****          AN SL TAPE IS CURRENTLY POSITIONED TO THE FIRST          01352202
*****          PHYSICAL DATA SET ON THE TAPE- USE THE DATA SET          01357102
*****          SEQUENCE NUMBER ( LOGICAL ) FROM THE HEADER 1 LABEL      01362002
*****          OF THAT DATA SET TO CALCULATE THE RELATIVE OFFSET        01366902
*****          ( PHYSICAL ) OF THE DESIRED DATA SET                     01371802
*                                                                       01376702
         LA    RC,DXLBL                 LOAD ADDRESS OF LABEL BUFFER,   01381602
         ST    RC,DXCCW1                ..STORE IT INTO 'READ' CCW      01386502
         MVI   DXCCW1,CCWRDTAP          INITLZ CCW FOR 'READ' COMMAND   01391402
         MVC   DXCCW1+K4(K4),ARDCCW0C   IND NO FLAGS, LNG EQ 80 BYTES   01395402
         TM    JFCBLTYP,JFCBAL          WERE 'ANSI' LABELS SPECIFIED-   01401202
         BZ    ETI19100                 ..BR IF NOT TO READ LABEL       01406102
         OI    DXCCW1+K4,CCWSILI        TURN ON 'SILI' INDICATOR        01408102
ETI19100 EQU   *                        GO READ LABEL                   01410102
         BAL   RC,ETI26400              BR AND LINK TO READ LABEL       01420802
         BNO   ETI26500                 BR TO ERROR RTN IF I/O ERROR    01425702
         TM    SRTESTAB,UCBBSTR         IS AN 'ANSI' VOLUME MOUNTED-    01430602
         BZ    ETI19200                 ..BR IF NOT TO CHK LABEL TYPE   01435502
         XLATE DXLBL,K80                TRANSLATE 'ANSI' LABEL DATA     01440402
ETI19200 EQU   *                        VERIFY HEADER1 READ             01442402
         CLC   FL1LABI,AVOL0C           IS THIS A VOLUME LABEL-         01450202
         BE    ETI19100                 ..BR IF YES- READ ANOTHER LABEL 01455102
         CLC   FL1LABI,UVOL3D           IS THIS A USER VOLUME LABEL-    01460002
         BE    ETI19100                 ..BR IF YES- READ ANOTHER LABEL 01464902
         CLC   FL1LABI,AHDR             IS THIS A HEADER LABEL-         01469802
         BNE   ETI26500                 ..BR IF NOT- ERROR              01474702
         MVI   DXCCW1,CCWBSR            INITLZ CCW FOR BSR COMMAND      01479602
         BAL   RC,ETI26400              BR AND LINK TO BSR PAST LABEL   01484502
         BNO   ETI26500                 BR IF ERROR TO ERROR RTN        01489402
         PACK  DXCCW2,FL1FILSQ          PACK LABEL FILE SEQ NO., THEN   01494302
         CVB   RET,DXCCW2               ..CONVERT IT TO BINARY AND      01499202
         MODESET EXTKEY=SUPR            UCB/TIOT KEY             Y02082 01504102
         STH   RET,SRTEFSEQ             ..STORE IT IN THE UCB           01509002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 01513902
         CH    RET,JFCBFLSQ             IS DESIRED DATA SET 1ST ON TAPE 01518802
*                                       ..(PHYSICAL POS EQ 1, LOGICAL   01523702
*                                       ..POSITION EQUAL ANYTHING )-    01528602
         BE    ETI20900                 ..BR IF YES- POS COMPLETE       01533502
         BH    ETI26500                 ..BR IF SPECIFIED SEQ NO. IS    01538402
*                                       ..LESS THAN THAT OF 1ST         01543302
*                                       ..PHYSICAL DATA SET- ERROR      01548202
*                                                                       01553102
*****          DETERMINE HOW TO POSITION AN SL DATA SET                 01558002
*                                                                       01562902
ETI19300 EQU   *                        SL POSITIONING                  01564902
         LH    RTIOT,SRTEFSEQ           LOAD CURRENT LOGICAL SEQ NO.    01572702
         MODESET EXTKEY=SUPR            UCB/TIOT KEY             Y02082 01577602
         MVC   SRTEFSEQ,JFCBFLSQ        ST DESIRED LOG SEQ NO. IN UCB   01582502
         SH    RTIOT,SRTEFSEQ           CALC RELATIVE OFFSET OF THE 2   01587402
*                                       ..DATA SETS-                    01592302
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 01597202
         BZ    ETI20900                 ..BR IF 0- POS COMPLETE         01602102
         BP    ETI19400                 ..BR IF POSITIVE TO BACKSPACE   01607002
*                                                                       01611902
*****          FORWARD SPACE TO AN SL DATA SET                          01616802
*                                                                       01621702
         LPR   RET,RTIOT                CALC NEW PHYSICAL SEQ NO.-      01626602
         AH    RET,SRTEFSCT             ..ADD RELATIVE OFFSET TO CUR    01631502
         MODESET EXTKEY=SUPR            UCB/TIOT KEY             Y02082 01636402
         STH   RET,SRTEFSCT             ..PHYSICAL POS AND STORE IN UCB 01641302
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 01646202
         B     ETI19600                 BR TO ACTUALLY PERFORM POS      01651102
*                                                                       01656002
*****          BACKSPACE TO A SL DATA SET                               01660902
*                                                                       01665802
ETI19400 EQU   *                        BSF                             01667802
         LR    RET,RTIOT                SAVE RELATIVE OFFSET            01675602
         SH    RET,SRTEFSCT             CALC NEW PHYSICAL SEQ NO.-      01680502
         BNM   ETI26500                 ..BR IF NOT MINUS- ERROR        01685402
         LPR   RET,RET                  INSURE POSITIVE SEQ NUMBER      01690302
         MODESET EXTKEY=SUPR            UCB/TIOT KEY             Y02082 01695202
         STH   RET,SRTEFSCT             ..AND STORE IN UCB              01700102
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 01705002
         B     ETI19600                 BR TO ACTUALLY PERFORM POS      01709902
*                                                                       01714802
*****          DETERMINE HOW TO POSITION AN NL DATA SET                 01719702
*                                                                       01724602
ETI19500 EQU   *                        NL POSITIONING                  01726602
         LH    RTIOT,SRTEFSCT           LOAD CURRENT PHYSICAL SEQ NO.   01734402
         MODESET EXTKEY=SUPR            UCB/TIOT KEY             Y02082 01739302
         STH   RET,SRTEFSEQ             STORE DESIRED LOGICAL AND       01744202
         STH   RET,SRTEFSCT             ..PHYSICAL SEQ NOS. IN UCB      01749102
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 01754002
         SR    RTIOT,RET                GET POSITIONING FACTOR          01758902
*                                                                       01763802
*****          PERFORM ACTUAL TAPE POSITIONING                          01768702
*                                                                       01773602
ETI19600 EQU   *                        POSITION TAPE                   01775602
         TM    JFCBLTYP,JFCBLP+JFCNL    WAS NL OR BLP SPECIFIED-        01783402
         BNZ   ETI19700                 ..BR IF YES TO CONTINUE         01788302
         MH    RTIOT,CONTHREE           MULTIPLY POSITIONING FACTOR BY  01793202
*                                       ..3 TO ACCOUNT FOR STD LABELS   01798102
ETI19700 EQU   *                        NL/BLP SPECIFIED                01802002
         MVI   DXCCW1,CCWBSF            INITLZ CCW FOR BSF COMMAND      01807902
         LTR   RTIOT,RTIOT              WHICH WAY DO WE POSITION-       01809902
         BM    ETI19800                 ..BR IF POSITIONING FORWARD     01817702
         BZ    ETI20900                 ..BR IF POSITIONING COMPLETE    01822602
         LA    RTIOT,K1(,RTIOT)         INCREASE NO. OF BSF BY 1        01827502
         BAL   RDEB,ETI21300            BR TO EXECUTE THE I/O LOOP      01832402
         TM    IOBSENSE+K1,UCBLDPT      WAS LOAD POINT REACHED-         01834402
         BO    ETI20900                 ..BR IF YES- POS COMPLETE       01842202
         LA    RTIOT,K1                 INITLZ FOR 1 FWD SPACE FILE     01847102
ETI19800 EQU   *                        FORWARD POSITIONING             01849102
         LPR   RTIOT,RTIOT              INSURE POSITIVE POS FACTOR      01856902
         MVI   DXCCW1,CCWFSF            INITLZ CCW FOR FSF COMMAND      01861802
         BAL   RDEB,ETI21300            BR TO EXECUTE THE I/O LOOP      01866702
         B     ETI20900                 ..BR- CONCATENATION POS DONE    01871602
*                                                                       01876502
*****          POSITIONING FOR READ FORWARD ON THE SAME DATA SET        01881402
*                                                                       01886302
ETI19900 EQU   *                        CHECK FILE SEQUENCE             01888302
         CLC   SRTEFSCT(K2),CONSTONE    IS CURRENT POSITION EQUAL '1'-  01896102
         BE    ETI20200                 ..BR IF YES- POS COMPLETE       01901002
ETI20000 EQU   *                        FILE SEQUENCE NOT EQUAL TO ONE  01903002
         MVI   DXCCW1,CCWREW            INITLZ CCW FOR REWIND COMMAND   01910802
         BAL   RC,ETI26400              BR AND LINK TO REWIND TAPE      01915702
         BNO   ETI26500                 BR IF ERROR TO ERROR RTN        01920602
         MVI   DXCCW1,CCWNOP            INITLZ CCW FOR A 'NOP'          01925502
         BAL   RC,ETI26400              BR AND LINK TO INITIATE 'NOP'   01930402
         BNO   ETI26500                 BR IF ERROR TO ERROR RTN        01935302
ETI20200 EQU   *                        FILE SEQUENCE EQUAL ONE         01937302
         TM    DCBOFLGS,DCBOCON         IS CONCATENATION TAKING PLACE-  01945102
         BO    ETI20900                 BR IF YES TO FINISH             01947102
         MODESET EXTKEY=SUPR            UCB/TIOT KEY             Y02082 01954902
         MVC   SRTEFSEQ(K2),DXCCW7+K6   UPDATE LOG SEQ NO. FROM WK AREA 01956902
         MVC   SRTEFSCT(K2),CONSTONE    INITLZ PHYSICAL SEQ NO. TO 1    01964702
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 01969602
         TM    JFCBLTYP,JFCBLTM         LTM SPECIFIED ?        @ZA28943 01970637
         BZ    ETI20900                 NO, BRANCH             @ZA28943 01971637
         BAL   RB,ETI26600              BAL TO POS PAST LTM    @ZA28943 01972637
         B     ETI20900                 BR TO FINISH                    01974502
*                                                                       01979402
*****          POSITIONING FOR 'RDBACK' ON THE SAME DATA SET            01984302
*                                                                       01989202
ETI20300 EQU   *                        READBACK POSITIONING            01991202
         LA    RD,EABD194               INTERNAL CODE FOR POS ERROR     01999002
         LH    RTIOT,DXCCW7+K4          LOAD OLD PHYSICAL SEQ NO.       02001002
         LH    RET,SRTEFSCT             LOAD CURRENT PHYSICAL SEQ NO.   02008802
         TM    JFCBLTYP,JFCBLP+JFCNL    WAS NL OR BLP SPECIFIED-        02013702
         BM    ETI20600                 ..BR IF YES                     02018602
         SR    RTIOT,RET                CALC POSITIONING FACTOR         02023502
         BNM   ETI20400                 BR TO POSITION FORWARD          02028402
         LA    RTIOT,K2                 INITLZ POS FACTOR FOR 2 BSF     02033302
         MVI   DXCCW1,CCWBSF            INITLZ CCW FOR BSF COMMAND      02038202
         BAL   RDEB,ETI21300            BR TO EXECUTE THE I/O LOOP      02043102
         LA    RTIOT,K2                 INITLZ POS FACTOR FOR FSF       02048002
         B     ETI20500                 BR TO FORWARD SPACE FILE        02052902
ETI20400 EQU   *                        FORWARD POSITIONING             02054902
         AH    RTIOT,CONSTONE           PLUS ONE TO POSITIONING FACTOR  02062702
         MH    RTIOT,CONTHREE           MULTIPLY POSITIONING FACTOR BY  02067602
*                                       ..3 TO ACCOUNT FOR STD LABELS   02072502
ETI20500 EQU   *                        FSF                             02074502
         MVI   DXCCW1,CCWFSF            INITLZ CCW FOR FSF COMMAND      02082302
         BAL   RDEB,ETI21400            BR TO EXECUTE THE I/O LOOP      02087202
         B     ETI20800                 BR TO UPDATE UCB FILE SEQUENCE  02092102
*                                       ..COUNT AND NUMBER              02097002
ETI20600 EQU   *                        NL/BLP                          02099002
         SR    RTIOT,RET                CALCULATE POSITIONING FACTOR    02106802
         BM    ETI20700                 BR TO POSITION BACKWARD         02111702
         AH    RTIOT,CONSTONE           PLUS ONE TO POSITIONING FACTOR  02116602
         MVI   DXCCW1,CCWFSF            INITLZ CCW FOR FSF COMMAND      02121502
         BAL   RDEB,ETI21300            BR TO EXECUTE THE I/O LOOP      02126402
ETI20700 EQU   *                        BACKWARD POSITIONING            02128402
         MVI   DXCCW1,CCWBSF            INITLZ CCW FOR BSF COMMAND      02136202
         LA    RTIOT,K1                 INITLZ POSITIONING FACTOR TO 1  02141102
         BAL   RDEB,ETI21300            BR TO EXECUTE THE I/O LOOP      02146002
ETI20800 EQU   *                        UPDATE UCB FILE SEQUENCE        02148002
         MODESET EXTKEY=SUPR            UCB/TIOT KEY             Y02082 02155802
         MVC   SRTEFSCT(K4),DXCCW7+K4   INITLZ PHYSICAL AND LOGICAL SEQ 02157802
*                                       ..NOS. FROM SAVE AREA           02165602
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 02170502
*                                                                       02175402
*****    NOTE- 'RDEB' AND 'RTIOT' ARE NO LONGER USED AS WORK REGS       02180302
*                                                                       02185202
ETI20900 EQU   *                        INIT DM COUNT TO ONE            02187202
         L     RDEB,DCBDEBAD            RESTORE DEB ADDRESS FROM DCB    02195002
         L     RTIOT,DXTIOTAD           RESTORE TIOT ADDR      @ZA03660 02220037
         NI    DCBOFLGS,X'FF'-DCBOEOF   RESET 'TAPE MARK READ' IND      02225002
         SPACE 2                                                        02250002
*********************************************************************** 02255002
*              EXITS                                                  * 02260002
*********************************************************************** 02265002
*                                                                       02270002
         TM    JFCBLTYP,JFCBAL+JFCSL    WAS AL OR SL SPECIFIED-         02275002
         BZ    ETI21000                 ..BRANCH IF NOT                 02280002
*                                                                       02285002
*****          EXIT TO PROCESS STANDARD HEADER LABELS                   02290002
*                                                                       02295002
         B     ETI23100                 BRANCH, PROCESS SL TAPE  Y02134 02310002
*                                                                       02315002
*****          NL AND NSL EXIT DETERMINATION                            02320002
*                                                                       02325002
ETI21000 EQU   *                        EXIT DETERMINATION              02330002
         LA    RF,MOD3F3H               ID/VCON OF MT-AHEAD MOD  Y02134 02335002
         TM    JFCBLTYP,JFCNSL          WAS NSL SPECIFIED-              02340002
         BO    ETI21200                 ..BRANCH IF YES                 02345002
         LA    RET,K24                  BR TABLE OFFSET FOR NL          02350002
ETI21100 EQU   *                        EXIT                            02355002
         L     RTIOT,DXTIOTAD           RELOAD TIOT PRT        @ZA03660 02357037
         IECRES LOAD,MODID=(RF),BRCODE=(RET),BRANCH=QUEUED       Y02080 02360002
*                                    INVOKE IECRES MACRO TO XCTL Y02080 02365002
         EJECT                                                          02370002
*                                                                       02375002
*****          XCTL TO 'NSLEHDRI' TO PROCESS HEADER LABELS              02380002
*                                                                       02385002
ETI21200 EQU   *                        PROCESS NSL                     02390002
*                                                                Y02082 02394002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 02394802
*                                                                Y02082 02394902
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,WTGPREFX)          Y02082 02396602
*                                                                Y02082 02397402
         L     RDCB,DXPDCBAD            GET COPIED DCB ADDR      YM5702 02397802
         MVC   DXXMODNM(K12),NSLEHDRI   NSL HEADER LABEL MODULE  Y02134 02398302
*                                       ..NAME INTO XCTL AREA           02400002
         LA    RET,K20                  BR TABLE OFFSET FOR NSL RETURN  02405002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          YM2866 02407002
         IECRES LOAD,PREFIX=DXXPREFX,BRANCH=DIRECT               Y02080 02410002
         SPACE 2                                                        02415002
*********************************************************************** 02420002
*              SUBROUTINES FOR VOLUME/DATA SET VERIFICATION           * 02425002
*********************************************************************** 02430002
*                                                                       02435002
*****          CLOSED SUBROUTINE TO ISSUE MULTIPLE POSITIONING CMDS     02440002
*                                                                       02445002
ETI21300 EQU   *                        SUBROUTINE FOR VOL/DS VER       02450002
         BAL   RC,ETI26400              BR AND LINK TO DO I/O           02455002
         BO    ETI21400                 BR IF NO ERROR TO CONTINUE      02460002
         TM    IOBSENS1,UCBLDPT         IS THE TAPE AT LOAD POINT-      02465002
         BNO   ETI26500                 ..BR IF NOT TO ERROR RTN        02470002
ETI21400 EQU   *                        NO ERROR                        02475002
         BCT   RTIOT,ETI21300           DECREMENT THE POSITIONING       02480002
*                                       ..FACTOR- CONTINUE IF MORE I/O, 02485002
         BR    RDEB                     ..ELSE RETURN TO CALLER         02490002
*                                                                       18700021
*********************************************************************** 18800021
*              VERIFY HEADER LABEL ( TRAILER LABEL IF READBACK )      * 18900021
*********************************************************************** 19000021
*                                                                       19100021
*****          READ LABEL                                               19200021
*                                                                       19300021
ETI23100 EQU   *                        READ LABEL                      19400002
         LA    RC,DXLBL                 LOAD ADDRESS OF LABEL BUFFER    19500021
         ST    RC,DXCCW1                ..STORE IT INTO 'READ' CCW      19600021
         MVI   DXCCW1,CCWRDTAP          INITLZ CCW FOR 'READ' COMMAND   19700021
         MVC   DXCCW1+K4(K4),ARDCCW7    IND NO FLAGS, LNG EQ 80 BYTES   19800002
         TM    JFCBLTYP,JFCBAL          WERE 'ANSI' LABELS SPECIFIED-   19900021
         BZ    ETI23200                 ..BR IF NOT TO READ LABEL       20000021
         MVI   DXCCW1+K4,CCWSILI        TURN ON SILI INDICATOR          20100002
ETI23200 EQU   *                        READ LABEL                      20200002
         LA    RD,EABD164               LOAD INTERNAL ERROR CODE        20300021
         BAL   RC,ETI26400              BR AND LINK TO READ LABEL       20400021
         BNO   ETI26500                 BR TO ERROR RTN IF I/O ERROR    20500021
         TM    SRTESTAB,UCBBSTR         IS AN 'ANSI' VOLUME MOUNTED-    20600021
         BZ    ETI23300                 ..BR IF NOT TO VERIFY LABEL     20700021
         XLATE DXLBL,K80                TRANSLATE 'ANSI' LABEL DATA     20800021
*                                                                       20900021
*****          PERFORM FILE LABEL 1 VERIFICATION                        21000021
*                                                                       21100021
ETI23300 EQU   *                        HEADER 1 VERIFY                 21200002
         LA    RD,EABD195               LOAD INTERNAL ERROR CODE        21300021
         CLC   FL1LABI,AVOL7            IS THIS A VOLUME LABEL-         21400021
         BE    ETI23200                 ..BR IF YES- READ ANOTHER LABEL 21500021
         CLC   FL1LABI,UVOL0C           IS THIS A USER VOLUME LABEL-    21600021
         BE    ETI23200                 ..BR IF YES READ ANOTHER LABEL  21700021
         BAL   RC,ETI26420              GO CHECK LABEL            99223 21750002
         B     ETI26500                 BRANCH TO ERROR ROUT      99223 21760002
*                                                                       22400021
****           DETERMINE 17 LEAST SIGNIFICANT NON-BLANK                 22500021
****           CHARACTERS IN DATA SET NAME IN JFCB                      22600021
*                                                                       22700021
*              NOTE- RDEB ( 'RB' ) IS NOW USED AS A WORK REGISTER       22800021
ETI23400 EQU   *                        DSNAME PROCESSING               22900002
         LA    R0,JFCBDSNM              PT TO JFCB DSNAME FIELD  A41622 23000021
         LA    RC,JFCBDSNM+K27          POINT TO FIRST POSSIBLE  A41662 23100021
*                                       ..SIGNIFICANT CHARACTER  A41662 23200021
ETI23500 EQU   *                        DETERMINE 17 CHAR DSN    A41662 23300002
         CLI   K16(RC),BLANK            IS THE 17TH SIGNIFICANT  A41662 23400021
*                                       ..CHARACTER A BLANK-     A41662 23500021
         BNE   ETI23600                 ..BR IF NOT- 'RC' PTS TO A41662 23600021
*                                       ..FIRST SIGNIFICANT CHAR A41662 23700021
         BCT   RC,ETI23500              DECR STARTING ADDR AND   A41662 23800021
*                                       ..BR TO CHECK AGAIN      A41662 23900021
ETI23600 EQU   *                        SIGNIFICANT CHAR         A41662 24000002
         LA    RB,K17(,RC)              PT TO FIRST BLANK BEYOND A41662 24100021
*                                       ..17 SIGNIFICANT CHARS   A41662 24200021
         CLR   RC,R0                    IS DSNAME STARTING ADDR  A41662 24300021
*                                       ..WITHIN JFCB DSN FIELD- A41662 24400021
         BNL   ETI23700                 ..BR IF YES- USE 'RC'    A41662 24500021
         LR    RC,R0                    ..ELSE USE JFCBDSNM      A41662 24600021
*                                       ..AS STARTING ADDRESS    A41662 24700021
*                                                                A41662 24800021
*****          COMPARE THE 17 LEAST SIGNIFICANT CHARACTERS IN    A41662 24900021
*****          THE JFCB DSNAME TO THE DATA SET LABEL DSNAME      A41662 25000021
*****          INCLUDING THE GENERATION AND VERSION NUMBERS      A41662 25100021
*                                                                A41662 25200021
ETI23700 EQU   *                        COMPARE DATA SET NAMES   A41662 25300002
         CLC   FL1ID,K0(RC)             ARE THE NAMES IDENTICAL- A41662 25400021
         BE    ETI23900                 ..BR IF CORRECT DATA SET NAME   25500021
*                                                                       25600021
*****          THE DSNAMES IN THE JFCB AND THE HEADER LABEL ARE NOT     25700021
*****          THE SAME. IN THE EVENT THAT THIS IS A 'DOS' TAPE,        25800021
*****          VERIFY THE DATA SET NAME, GENERATION NUMBER, AND         25900021
*****          VERSION NUMBER SEPARATELY. OTHERWISE, EXIT TO THE        26000021
*****          ERROR ROUTINE.                                           26100021
*                                                                       26200021
ETI23800 EQU   *                        DSNAMES NOT EQUAL A41662        26250002
         TM    JFCBIND1,JFCGDG          IS THIS A GENERATION DATA SET-  26300021
         BZ    ETI26450                 ..BR IF NOT TO ERROR RTN        26400021
         LA    RET,K9                   LD LENGTH OF GENERATION  A41662 26440021
*                                       ..AND VERSION NUMBER     A41662 26480021
         SR    RB,RET                   POINT TO THE PERIOD PRE- A41662 26520021
*                                       ..CEDING GENERATION NO.  A41662 26560021
         CLC   FL1GNO,K2(RB)            IS THE GENERATION NO. CORRECT-  26600021
         BNE   ETI26450                 ..BR IF NOT TO ERROR RTN        26700021
         CLC   FL1VNG,K7(RB)            IS THE VERSION NUMBER CORRECT-  26800021
         BNE   ETI26450                 ..BR IF NOT TO ERROR RTN        26900021
*                                                                A41662 26910021
*****          'R0' NOW POINTS TO 'JFCBDSNM'                     A41662 26920021
*****          'RB' NOW POINTS TO THE PERIOD PRECEDING THE       A41662 26930021
*****             GENERATION AND VERSION NUMBERS                 A41662 26940021
*****          'RC' NOW POINTS TO THE BEGINNING OF THE 17 LEAST  A41662 26950021
*****             SIGNIFICANT CHARACTERS- INCLUDING THE GENER-   A41662 26960021
*****             ATION AND VERSION NUMBERS                      A41662 26970021
*                                                                A41662 26980021
         LA    RD,K17                   LD LENGTH OF LABEL NAME  A41662 26990021
         SR    RB,R0                    CALC LENGTH OF DSN WITHOUT GDG  27000021
         CR    RB,RD                    IS THIS NAME GREATER THAN 17    27100021
*                                       ..CHARACTERS-                   27200021
         BH    ETI23840                 ..BR IF YES TO ADJUST ADDRESS   27300021
*                                       ..OF START OF JFCB DSNAME       27400021
         LR    RC,R0                    POINT TO START OF        A41662 27460021
*                                       ..JFCBDSNM FIELD         A41662 27520021
         B     ETI23860                 BRANCH TO COMPARE DSNAMES       27600021
*                                                                A41662 27610021
*****          THE FOLLOWING INSTRUCTION IS USED TO COMPARE THE  A41662 27620021
*****          DATA SET LABEL'S DSNAME TO THE DSNAME IN THE JFCB A41662 27630021
*****          WITHOUT THE GENERATION AND VERSION NUMBERS        A41662 27640021
*                                                                A41662 27650021
ETI23820 CLC   FL1ID(K0),K0(RC)         COMPARE DSNAMES          A41662 27660021
*                                                                A41662 27670021
ETI23840 EQU   *                        ADJUST ADDRESS                  27700002
         SR    RC,RET                   CALC STARTING ADDR OF    A41662 27770021
*                                       ..DSNAME GREATER THAN    A41662 27840021
*                                       ..17 CHARACTERS LONG     A41662 27910021
         LR    RB,RD                    LOAD DSNAME LENGTH OF 17 CHARS  28000021
ETI23860 EQU   *                        COMPARE DSNAMES                 28100002
         BCTR  RB,R0                    DECR LNG FOR USE IN 'CLC' INST  28200002
         EX    RB,ETI23820              IS THE DSNAME CORRECT-   A41662 28300021
         BNE   ETI26450                 ..BR IF NOT TO ERROR RTN        28400021
*                                                                       28500021
****           PLACE BLOCK COUNT INTO THE DCB                           28600021
*                                                                       28700021
ETI23900 EQU   *                        CHECK FOR EXCP                  28800002
         TM    DCBMACRF,DCBMEXCP        IS THE ACCESS METHOD EXCP-      28900021
         BNO   ETI24000                 ..BR IF NOT - BLK CT EXISTS     29000021
         TM    DCBMACRF+K1,DCBMDEV      IS THERE A TAPE SECTION-        29100002
         BZ    ETI24010                 BR IF NOT- BYPASS BLK CT Y02083 29200002
ETI24000 EQU   *                        BLOCK COUNT PROCESSING          29300002
         PACK  DXCCW6,FL1BLKCT          CONVERT BLK CT FROM EBCDIC TO   29400021
         OI    DXCCW6+K7,K15            UNPACKED, INSURE PROPER SIGN,   29500002
         CVB   RC,DXCCW6                ..CONVERT TO BINARY, AND STORE  29600021
         ST    RC,DCBBLKCT              ..BLOCK COUNT INTO THE DCB      29700021
         EJECT                                                          29701202
*********************************************************************** 29701302
*                                                                     * 29704402
*                          FUNCTION PROLOG                            * 29706402
*                                                                     * 29708402
*********************************************************************** 29708802
*                                                                     * 29709202
* FUNCTION NAME -                                                     * 29709302
*    'EOV TAPE INPUT STANDARD HEADER LABEL FUNCTION', PART II.        * 29709402
*                                                                     * 29709702
* (STATUS) -                                                          * 29710102
*    NOT APPLICABLE                                                   * 29710202
*                                                                     * 29711602
* FUNCTION -                                                          * 29713602
*    1. FOR DATA SETS ON AL OR SL TAPE, TEST FOR DATA SET SECURITY.   * 29714002
*       A DATA SET MAY BE BOTH READ AND WRITE PROTECTED, IN WHICH     * 29714102
*       CASE THE PASSWORD IS ALWAYS REQUIRED, OR IT MAY BE WRITE-     * 29714202
*       PROTECTED, IN WHICH CASE THE PASSWORD IS ONLY REQUIRED IF     * 29714302
*       THE DATA SET IS OPENED FOR 'INOUT'.CONTROL IS TRANSFERRED TO  * 29714702
*       OPEN/EOV SECURITY MODULE TO DETERMINE WHETHER OR NOT ACCESS   * 29715102
*       IS AUTHORIZED. IF AN ANSI TAPE HAS AN UNRECOGNIZABLE SECURITY * 29715502
*       INDICATOR, CONTROL IS TRANSFERRED TO MODULE IFG0552X TO       * 29715602
*       ISSUE AN ACCESSABILITY MESSAGE AND CLOSE THE DATA SET.        * 29716702
*                                                                     * 29718702
* ENTRY POINTS -                                                      * 29718802
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 29718902
*                                                                     * 29719502
* INPUT -                                                             * 29719902
*    1. REGISTER CONTENTS AT ENTRY ARE AS FOLLOWS-                    * 29720302
*       'RDCB' - ADDRESS OF THE DCB BEING PROCESSED;                  * 29720402
*       'RCORE'- ADDRESS OF THE WORK AREA FOR THAT DCB;               * 29720502
*       'RES'  - ADDRESS OF THE OPEN/CLOSE/EOV RESIDENT ROUTINE;      * 29720602
*       'RWTG' - ADDRESS OF THE WHERE-TO-GO TABLE;                    * 29720802
*       'RPARC'- ADDRESS OF THE EOV PSEUDO PARAMETER LIST ENTRY;      * 29720902
*       'RWTGC'- ADDRESS OF THE CURRENT WHERE-TO-GO TABLE ENTRY;      * 29721002
*       'RTIOT'- ADDRESS OF THE CURRENT TIOT ENTRY FOR THE DCB;       * 29721102
*       'RUCB' - ADDRESS OF THE CURRENT UCB FOR THE DCB;              * 29722002
*       'RDEB' - ADDRESS OF THE DCB'S DEB;                            * 29724002
*    2. CONTROL BLOCK INDICATORS-                                     * 29724102
*       'DCBOFLGS' - X'20', ON - INDICATES THAT CONCATENATION IS      * 29724402
*                                TAKING PLACE.                        * 29724802
*       'DEBFLGS1' - X'80', ON - INDICATES THAT 'OPEN' OR 'EOV' HAS   * 29724902
*                                PREVIOUSLY VERIFIED THE PASSWORD     * 29725302
*                                FOR THIS PROTECTED DATA SET.         * 29725702
*                                                                     * 29726102
* OUTPUT -                                                            * 29726202
*    1. AT EXIT TO IFG0195T (OPEN/EOV SECURITY MODULE)-               * 29726302
*       REGISTER CONTENTS ARE THE SAME AS AT ENTRY EXCEPT THAT        * 29726402
*          REGISTER 'RET' CONTAINS A BRANCH TABLE OFFSET OF '0';      * 29726602
*       CONTROL BLOCK INDICATORS-                                     * 29727002
*          'DCBOFLGS' - X'20', OFF - INDICATES THAT CONCATENATION     * 29727102
*                                    HAS BEEN COMPLETED.              * 29727202
*          'DEBFLGS1' - X'80', OFF - INDICATES THAT THE PASSWORD HAS  * 29727302
*                                    NOT PREVIOULY BEEN VERIFIED.     * 29727402
*    2. AT EXIT TO IFG0552X (EOD FUNCTION)-                           * 29728102
*       REGISTER CONTENTS ARE THE SAME AS AT ENTRY EXCEPT THAT        * 29730102
*          REGISTER 'RET' CONTAINS A BRANCH TABLE OFFSET OF '12'.     * 29730302
*    3. AT EXIT TO THE 'EOV TAPE INPUT VOLUME MOUNT-AHEAD FUNCTION',  * 29730702
*       OUTPUT IS VIRTUALLY THE SAME AS AT INPUT.                     * 29730802
*       BEFORE EITHER EXITING TO THE USER TO TO IFG0551L THE     Y02082 29730902
*       DCB ADDRESS IN THE DEB IS SET TO POINT TO THE USER DCB   Y02082 29731302
*                                                                     * 29731702
* EXTERNAL REFERENCES -                                               * 29732102
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 29732202
*                                                                     * 29732402
* EXITS, NORMAL -                                                     * 29732502
*         IFG0195T - TO VERIFY THAT A SECURITY-PROTECTED DATA SET MAY * 29732602
*                    BE ACCESSED;                                     * 29732702
*                                                                     * 29733202
* EXITS, ERROR -                                                      * 29733302
*         IFG0554A - TO ISSUE ANSI ACCESSABILITY MESSAGE (-2)         * 29733902
*                                                                     * 29735902
*         REFER TO THE PRECEEDING MODULE PROLOG.                      * 29736202
*                                                                     * 29736602
* TABLES/WORK AREAS -                                                 * 29736702
*    THE OPEN, CLOSE, OR EOV WORK AREA AND THE WHERE-TO-GO (WTG)      * 29736802
*    TABLE ARE DESCRIBED BY THE DSECTS AT THE END OF THE LISTING.     * 29736902
*                                                                     * 29737002
* ATTRIBUTES -                                                        * 29737302
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 29737702
*                                                                     * 29738102
* CHARACTER CODE DEPENDENCY -                                         * 29738202
*    REFER TO THE PRECEEDING MODULE PROLOG.                           * 29738302
*                                                                     * 29738902
* NOTES -                                                             * 29740902
*                                                                     * 29741002
*********************************************************************** 29741102
*                                                                       29741202
*********************************************************************** 29741302
*              TEST FOR DATA SET SECURITY                             * 29741402
*********************************************************************** 29741802
*                                                                       29742002
ETI24010 EQU   *                        TEST DATA SET SECURITY   YM5950 29742402
*                                                                YM5950 29742602
         TM    JFCBLTYP,JFCBAL          ANSI LABELS SPECIFIED-   YM5950 29742902
         BZ    ETI24012                 IF NOT- TEST SL SECURITY YM5950 29743002
*                                                                YM5950 29743102
*****          PERFORM SECURITY TESTS FOR ANSI ( AL ) DATA SET   YM5950 29743202
*                                                                YM5950 29743402
         CLI   FL1FSEC,BLANK            IS ACCESSIBILITY LIMITED YM5950 29743802
         BE    ETI24018                 ..BR IF NOT TO CONTINUE  YM5950 29743902
         CLI   FL1FSEC,FL1SECTY         SECURITY = READ/WRITE    YM5950 29744502
         BE    ETI24012                 ..BR YES TO TEST DEB FOR YM5950 29744902
*                                       ..PREVIOUS AUTHORIZATION YM5950 29745302
*                                                                YM5950 29745702
*        THE ANSI DATA SET LABEL CONTAINS AN INVALID SECURITY    YM5950 29745802
*        INDICATOR GO TO ISSUE ACCESSIBILITY MESSAGE             YM5950 29745902
*                                                                YM5950 29746102
         MVC   DXRETMOD,ID553F          SET UP RETURN MOD        YM5950 29746202
         MVI   DXRETCOD,K12             SET UP RETURN OFFSET     YM5950 29746302
*                                                                YM5950 29746402
         LA    R1,K2                    ACCESSABILITY CODE       YM5950 29746602
         L     RTIOT,DXTIOTAD           RELOAD TIOT PTR        @ZA03660 29746737
*                                                                YM5950 29746837
         IECRES LOAD,MODID=ID554J,BRCODE=K8,BRANCH=QUEUED        YM5950 29746937
*                                                                YM5950 29747037
ETI24011 EQU   *                        RETURN FROM DISMOUNT     YM5950 29747137
*                                                                YM5950 29747237
*        REJECT VOLUME AND ABEND                                 YM5950 29747337
         L     RTIOT,DXTIOTAD           RELOAD TIOT PTR        @ZA03660 29747437
         LA    R0,EABD249               937-20 ABEND             YM5950 29747537
         MVC   DXRETMOD,ID553F          SET UP RETURN MOD        YM5950 29747637
         MVI   DXRETCOD,K0              SET UP RETURN OFFSET     YM5950 29747737
*                                                                YM5950 29747837
         IECRES LOAD,MODID=ID3F4A,BRCODE=K16,BRANCH=QUEUED       YM5950 29747937
*                                                                YM5950 29748037
*****          CONTINUE SECURITY TESTS FOR SL AND AL DATA SETS   YM5950 29748137
*                                                                YM5950 29748237
ETI24012 EQU   *                        TEST LABEL SECURITY      YM5950 29748337
*                                                                YM5950 29748437
         NI    DEBFLGS1,X'FF'-DEBPWCKD  CLEAR THE                YM5950 29748537
*                                       'PASSWORD ..CHECKED'     YM5950 29748637
*                                       INDICATOR                YM5950 29748737
*                                                                YM5950 29748837
         CLI   FL1FSEC,FL1SECTY         SECURITY FOR READ/WRITE  YM5950 29748937
         BE    ETI24014                 BRANCH YES, GET PASSWORD YM5950 29749037
         CLI   FL1FSEC,FL1WRSEC         SECURITY FOR WRITE ONLY  YM5950 29749137
         BNE   ETI24018                 ..BR IF NOT TO CONTINUE  YM5950 29749237
*                                                                YM5950 29749337
*****          A PASSWORD IS REQUIRED IF THE USER HAS OPENED FOR YM5950 29749437
*****          'INOUT' AND THE DATA SET IS PROTECTED FOR OUTPUT  YM5950 29749537
*                                                                YM5950 29749637
         TM    DEBOPATB,DEBOPOUT-DEBOPRBK INPUT OR READBACK      YM5950 29749737
         BZ    ETI24018                 ..BRANCH IF YES          YM5950 29749837
*                                                                YM5950 29750002
*                                       ..MODE IS 'INOUT'        YM5950 29750202
ETI24014 EQU   *                        MODE IS INOUT            YM5950 29752202
*                                                                YM5950 29752302
         NI    DCBOFLGS,ALLBITS-DCBOCON SET OFF CONCATENATION    YM5950 29752602
*                                                                YM5950 29752702
         MVC   DXRETMOD,ID553F          SET UP RETURN LOAD       YM5950 29752802
         MVI   DXRETCOD,K8              SET UP RETURN OFFSET     YM5950 29752902
         L     RTIOT,DXTIOTAD           RELOAD TIOT PTR        @ZA03660 29753037
*                                                                YM5950 29753137
         IECRES LOAD,MODID=ID3F5T,BRCODE=K0,BRANCH=QUEUED        YM5950 29753237
*                                                                YM5950 29753502
ETI24016 EQU   *                        RETURN FROM PASSWORD     YM5950 29753602
*                                                                YM5950 29753902
         L     RDEB,DCBDEBAD            RESTORE PTR TO DEB       YM5950 29754002
         OI    DEBFLGS1,DEBPWCKD        TURN ON PASSWORD CHECK   YM5950 29754202
*                                                                YM5950 29754702
ETI24018 EQU   *                        READ HDR2 LABEL          YM5950 29754802
*                                                                YM5950 29754902
         TM    SRTESTAB,UCBBSTR         IS ANSI VOL MOUNTED       99223 29755002
         BO    ETI24100                 ..YES,CHECK FOR USER LABS 99223 29755102
         LA    RD,EABD164               LOAD ERROR CODE           99223 29755202
         BAL   RC,ETI26400              GO READ LABEL             99223 29755402
         BO    ETI24019                 BR, NO ERROR            ZA00011 29755600
         TM    IOBSTAT0,CSWUNITX        WAS A TAPE MARK READ    ZA00011 29755700
         BNO   ETI26500                 NO,BR TO ERROR ROUTINE  ZA00011 29757100
         MVC   DXCCW1(K16),BSFNOP1      SET UP 'BSF,NOP' CCWS   ZA00011 29761100
         LA    RD,EABD196               LOAD INT ERROR CODE     ZA00011 29761500
         BAL   RC,ETI26400              GO BACKSPACE FILE       ZA00011 29761600
         BNO   ETI26500                 BR IF I/O ERROR         ZA00011 29761700
         B     ETI24100                 BR,TEST FOR USER LABELS ZA00011 29761800
ETI24019 EQU   *                                                ZA00011 29761900
         BAL   RC,ETI26420              GO VERIFY LABEL TYPE      99223 29762000
*                                                                       29763202
         B     ETI24050                 GO BACKSPACE,NO LAB 2     99223 29764602
**                                        RETURN +4 IF LABEL OK   99223 29766002
         CLI   FL2ID+K4,BLANK           IS ID FIELD BLANK         99223 29767402
         BE    ETI24020                 .YES,CHECK FOR CHKPT DS  YM7820 29768802
         CLI   UCBTBYT4,UCB3400         TEST FOR 3400 DRIVE      YM1491 29770202
         BNE   ETI24020                 ..NO,CHECK FOR CHKPT DS  YM1491 29771602
         L     RC,UCBEXTPT              GET UCB EXTEN PTR        Y02146 29773002
         CLI   UCBSNSCT-UCBCMEXT(RC),K24 IS IT 3420?             Y02146 29774402
         BNE   ETI24020                 BR IF NOT                YM1491 29775802
*********************************************************************** 29777202
* IF THE TAPE UNIT IS A 6250 BPI UNIT AND IBM STANDARD LABELS ARE     * 29778602
* BEING PROCESSED,THE SERIAL NUMBER OF THE CREATING TAPE DEVICE       * 29780002
* IS OBTAINED FROM THE HDR2/EOF2/EOV2 LABEL AND PLACED IN THE UCB     * 29781402
* EXTENSION AREA ON THE TAPE UNIT THAT IS PROCESSING THE TAPE.        * 29783202
*********************************************************************** 29786202
         PACK  DXCCW6,FL2ID             CONVERT TAPE ID FROM      99223 29789202
         CVB   RB,DXCCW6                --INSURE PROPER SIGN      99223 29795202
         L     RC,UCBXTN                POINT TO UCB EXTENSION    99223 29798202
         MODESET EXTKEY=SUPR            SET KEY TO UCB KEY        99223 29801202
         USING UCBMT,RC                                           99223 29804202
         STH   RB,UCBCTD                STORE TAPE ID            YM8550 29807202
         DROP  RC                                                 99223 29810202
ETI24020 EQU   *                        BEGIN CHKPT DS TEST      Y02083 29813202
         L     RC,DXDSAB                ADDRESS OF DSAB          Y02083 29816202
         USING DSAB,RC                  ADDRESS DSAB             Y02083 29819202
         MODESET EXTKEY=SCHED           DSAB KEY                 Y02083 29822202
         NI    DSABFLG4,X'FF'-DSABCKVL  ZERO DSAB CHKPT VOL IND  Y02083 29825202
         MODESET EXTKEY=DATAMGT         RETURN TO D/M KEY        Y02083 29828202
*****************************************************************Y02083 29831202
* IF THIS IS A CHECKPOINT DATA SET, MAKE SURE THE VOLUME IS      Y02083 29834202
* SECURE. IF IT IS NOT OR A NON-CHECKPOINT DATA SET IS           Y02083 29837202
* ATTEMPTING TO USE A SECURE VOLUME, ABORT.                      Y02083 29840202
*****************************************************************Y02083 29843202
         CLI   FL2DSIND,CHARC           FL2DSIND=C (CHKPT DS)    Y02083 29843602
         BNE   ETI24035                 NO, FIND DATA SET TYPE   Y02083 29843702
*****************************************************************Y02083 29843802
* ASK OPERATOR IF THIS IS AN OLD SECURE VOLUME                   Y02083 29843902
*****************************************************************Y02083 29846202
ETI24025 EQU   *                        START WTOR LOGIC         Y02083 29846402
         MVC   DXRETMOD,ID553F          SET RETURN NAME & EPA    Y02083 29846602
         MVI   DXRETCOD,K4              SET BR TAB RETURN VALUE  Y02083 29846802
         XC    DXWORK1,DXWORK1          CLEAR WTOR REPLY AREA    Y02083 29847002
         LA    R1,DXWORK1               POINT TO REPLY AREA      Y02083 29847202
         LA    R0,K3                    SET REPLY LENGTH         Y02083 29847402
         SLL   R0,K24                   MOVE LENGTH TO HI BYTE   Y02083 29847602
         OR    R1,R0                    SET UP WTOR PARMS        Y02083 29847802
         L     RTIOT,DXTIOTAD           RELOAD TIOT PTR        @ZA03660 29847937
         IECRES LOAD,MODID=ID554J,BRCODE=K56,BRANCH=QUEUED       Y02083 29848002
ETI24030 EQU   *                        WAIT RETURN ENTRY        Y02083 29848202
         IECRES WAIT                    WAIT FOR REPLY           Y02083 29848402
         OC    DXWORK1(K3),BLANKS       FOLD REPLY TO UPPER CASE Y02083 29848602
         CLC   KYES,DXWORK1             REPLY=YES                Y02083 29848802
         BE    ETI24040                 IF YES, CONTINUE         Y02083 29849002
         CLC   KNO,DXWORK1              REPLY=NO                 Y02083 29849202
         BNE   ETI24025                 IF NOT, ISSUE MSG AGAIN  Y02083 29849402
*****************************************************************Y02083 29849602
* DATA SET NOT IDENTIFIED AS CHECKPOINT DATA SET                 Y02083 29849802
*****************************************************************Y02083 29850002
ETI24035 EQU   *                        BEGIN TEST FOR ERROR     Y02083 29850202
         TM    DSABFLG4,DSABCKDS        CHKPT DS IND ON IN DSAB  Y02083 29850402
         BNO   ETI24100                 IF NOT, CONTINUE         Y02083 29850602
         LA    R0,EABD240               LOAD INTERNAL ABEND CODE Y02038 29850802
         DMABCOND (R0),ID3D0P           ISSUE 937-10 ABEND       Y02083 29850902
*****************************************************************Y02083 29851402
* DATA SET WAS IDENTIFIED AS A CHECKPOINT DATA SET               Y02083 29852802
*****************************************************************Y02083 29854202
ETI24040 EQU   *                        BEGIN TEST FOR ERROR     Y02083 29855602
         L     RTIOT,DXTIOTAD           RELOAD TIOT PTR        @ZA03660 29855737
         TM    DSABFLG4,DSABCKDS        CHKPT DS IND ON IN DSAB  Y02083 29857002
         BO    ETI24045                 IF YES, CONTINUE         Y02083 29858402
         LA    R0,EABD241               LOAD INTERNAL ABEND CODE Y02083 29859802
         DMABCOND (R0),ID3D0P           ISSUE 937-14 ABEND       Y02083 29861202
*****************************************************************Y02083 29862602
* SET SECURE CHECKPOINT VOLUME INDICATOR IN DSAB                 Y02083 29864002
*****************************************************************Y02083 29865402
ETI24045 EQU   *                        SET DSAB VOL IND         Y02083 29866802
         MODESET EXTKEY=SCHED           SHIFT TO DSAB KEY        Y02083 29868202
         OI    DSABFLG4,DSABCKVL        SET DSAB CHKPT VOL IND   Y02083 29869602
         MODESET EXTKEY=DATAMGT         RETURN TO D/M KEY        Y02083 29871002
         B     ETI24100                 GO CHECK USER LABELS      99223 29872402
ETI24050 EQU   *                        BACKSPACE RECORD          99223 29873802
         MVI   DXCCW1,CCWBSR            SET 'BSR' OP CODE         99223 29875202
         LA    RD,EABD196               LOAD INT ERROR CODE       99223 29890802
         MVC   DXCCW1+K1(K15),BSFNOP1+K1  COMPLETE CCW FOR BSR    99223 29906402
*                                       --AND INSERT 'NOP'        99223 29922002
         BAL   RC,ETI26400              GO BACKSPACE RECORD       99223 29937602
         BNO   ETI26500                 BR IF I/O ERROR           99223 29953202
*                                                                       29968802
*********************************************************************** 29984402
*              USER HEADER LABEL PROCESSING                           * 30000021
*********************************************************************** 30100021
*                                                                       30200021
****           DETERMINE IF USER LABELS ARE TO BE PROCESSED             30300021
*                                                                       30400021
ETI24100 EQU   *                        CHECK FOR USER LABELS           30500002
         L     RDEB,DCBDEBAD            RESTORE THE DEB ADDRESS         30600021
         TM    JFCBLTYP,JFCBUL          WERE USER LABELS SPECIFIED-     30700021
         BNO   ETI26100                 ..BR IF NOT- BYPASS USER LBLS   30800021
         TM    DCBMACRF,DCBMEXCP        IS THE ACCESS METHOD EXCP-      30900021
         BZ    ETI24200                 ..BR IF NOT- TEST FOR EXIT LIST 31000021
         TM    DCBMACRF,DCBMFOUN        IS THERE A TAPE DEPEND SECTION- 31100021
         BZ    ETI26100                 ..BR IF NOT- BYPASS USER LBLS   31200021
ETI24200 EQU   *                        TEST FOR EXIT LIST              31300002
         L     RC,DCBEXLST              LOAD EXIT LIST ADDR FROM DCB    31400021
         LA    RC,K0(,RC)               ZERO HIGH ORDER BYTE            31500021
         LTR   RC,RC                    IS THERE A DCB EXIT LIST-       31600021
         BE    ETI26100                 ..BR IF NOT- BYPASS USER LBLS   31700021
ETI24300 EQU   *                        USER LABEL PROCESSING           31800002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 31805002
         CLI   K0(RC),XLIUHL            IS THERE AN INPUT HDR LBL EXIT- 31900021
         BE    ETI24500                 ..BR IF YES- CHECK FOR ADDR     32000021
         CLI   K0(RC),LASTNTRY+XLIUHL   IS 'LAST ENTRY' IND ALSO ON-    32100021
         BE    ETI24500                 ..BR IF YES- CHECK FOR ADDR     32200021
ETI24400 EQU   *                        CHECK FOR LAST ENTRY            32300002
         TM    K0(RC),LASTNTRY          IS THIS THE LAST LIST ENTRY-    32400021
         LA    RC,K4(,RC)               POINT TO NEXT ENTRY             32500021
         BNO   ETI24300                 ..BR IF NOT- CHECK NEXT ENTRY   32600021
         B     ETI26100                 ..ELSE BYPASS USER LABELS       32700021
ETI24500 EQU   *                        CHECK FOR VALID EXIT ADDRESS    32800002
         L     RC,K0(,RC)               LOAD EXIT LIST ADDRESS          32900021
         LA    RC,K0(,RC)               ZERO THE HIGH ORDER BYTE        33000021
         LTR   RC,RC                    IS THERE A VALID ADDRESS-       33100021
         BZ    ETI26100                 ..BR IF NOT- BYPASS USER LABELS 33200021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 33205002
*                                                                       33300021
*****          PROCESS USER HEADER LABELS                               33400021
*                                                                       33500021
ETI24600 EQU   *                        PROCESS USER HEADER LABELS      33600002
* OBTAIN MAIN STORAGE FOR USER LABEL WORK AREA                   Y02080 33650002
         IECRES GET,LV=USERLDM,PREFIX=YES,SP=K229,               Y02082*33655002
               STM=(2,14,WTGPREFX),ID=ULWA                       Y02144 33657002
         USING ULDMWK,R1                                         Y02082 33665002
         STM   RES,RC,ULREGSAV          SAVE REGS 5 - 12         Y02082 33670002
         DROP  R1                                                       34200021
*                                                                       34300021
*****          RUCB IS NOW USED AS THE USER LABEL WORK AREA BASE REG    34400021
*                                                                       34500021
         LR    RUCB,R1                  PT TO GOTTEN CORE        Y02082 34510002
         USING ULDMWK,RA                ESTAB ADDRESSABILITY     Y02082 34520002
*    GET USER'S USER LABEL WORK AREA                             Y02082 34530002
         IECRES GET,LV=USERLU,PREFIX=NO,KEY=USER,SP=K229,        Y02082*34540002
               STM=(2,14,WTGPREFX)                               Y02082 34550002
         USING ULUWK,R9                 ESTAB ADDRESSABILITY     Y02082 34560002
         LR    R9,R1                    PT TO GOTTEN CORE        Y02082 34570002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 34580002
         LA    R1,CHAR0                 INITIALIZE LABEL COUNT          34800021
         STH   R1,ULCNT                 ..AND SAVE FOR LATER USE        34900021
ETI24700 EQU   *                        SET UP READ CCW                 35000002
         LA    R1,ULDMBUFR              ADDR OF LABEL BUFFER     Y02082 35010002
         ST    R1,DXCCW1                ..AND STORE IN READ CCW         35200021
         MVI   DXCCW1,CCWRDTAP          INITLZ CCW FOR READ COMMAND     35300021
*                                       INDICATOR ON LNG STILL IN CCW)  35400021
         MVI   DXCCW1+K4,CCWSILI        SET 'SILI' FLAG ON              35500002
ETI24800 EQU   *                        READ LABEL                      35600002
         BAL   RC,ETI26400              BR AND LINK TO READ A LABEL     35700021
         BO    ETI24900                 BR IF NO I/O ERROR              35800021
         TM    IOBSTAT0,CSWUNITX        WAS A TAPE MARK READ-           35900021
         BO    ETI25700                 ..BR IF YES                     36000021
         B     ETI25600                 ..ELSE BR RO PROCESS ERROR      36100021
ETI24900 EQU   *                        NO TAPE MARK READ               36200002
         TM    JFCBLTYP,JFCBAL+JFCBUL   WERE ANSI USER LBLS SPECIFIED-  36300021
         BNO   ETI25000                 ..BR IF NOT- BYPASS TRANSLATION 36400021
         XLATE ULDMBUFR,K80             TRANSLATE ANSI LABEL     Y02082 36410002
ETI25000 EQU   *                        CHECK FOR HDR/TRLR              36600002
         CLC   ULDMBUFR(K3),AUHL7       USER HRD LABEL READ?     Y02082 36700002
         BE    ETI25100                 ..BR IF YES                     36800021
         CLC   ULDMBUFR(K3),AUTL7       USER TRLR LABEL READ?    Y02082 36900002
         BE    ETI25100                 ..BR IF YES                     37000021
*                                                                       37100021
*              NOTE - INPUT TRAILER LABEL PROCESSING LEAVES THE TAPE    37200021
*              POSITIONED BETWEEN THE FIRST AND SECOND DATA SET         37300021
*              TRAILER LABELS. THE FOLLOWING ALLOWS PROCESSING OF USER  37400021
*              LABELS EVEN THOUGH THE TAPE MAY CONTAIN MORE DATA SET    37500021
*              LABELS THAN CAN CURRENTLY BE CREATED UNDER O/S.          37600021
*                                                                       37700021
         BAL   RC,ETI26420              GO VERIFY LABEL TYPE      99223 37750002
         B     ETI25050                 WRONG LABEL TYPE          99223 37760002
         B     ETI24800                 GO READ NEXT LABEL        99223 37770002
ETI25050 EQU   *                        BACKSPACE RECORD          99223 37780002
         MVI   DXCCW1,CCWBSR            INITLZ CCW FOR 'BSR' COMMAND    38400021
         B     ETI25900                 BR- AN 'UNKNOWN' LABEL WAS READ 38500021
ETI25100 EQU   *                        HEADER/TRAILER READ             38600002
         MVC   ULCNT+K1(K1),ULDMBUFR+K3 SAVE LABEL NUMBER        Y02082 38603002
*                                                                Y02082 38606002
*    COPY LABEL TO USER'S BUFFER                                 Y02082 38609002
*                                                                Y02082 38612002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 38615002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 38618002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 38621002
*    OBTAIN LOCAL LOCK                                           Y02082 38624002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*38627002
               RELATED=('PREVENT FREE USER CORE-RELEASED BELOW') Y02082 38630002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 38633002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 38636002
*    VERIFY USER STILL HOLDS USER LABEL WORK AREA                Y02082 38639002
         OC    ULUWK(USERLU),ULUWK      PGM CHECK IF NOT         Y02082 38642002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 38645002
         MVC   ULBUFR,ULDMBUFR          COPY LABEL TO USER       Y02082 38648002
         L     RF,WTGPREFX              PT TO PREFIX             Y02082 38651002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 38654002
*    RELEASE LOCAL LOCK                                          Y02082 38657002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 38660002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 38663002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 38666002
         XC    ULPARM+K8(K4),ULPARM+K8  ZERO ERROR IND                  38800002
*                                                                       38900021
*****          PASS CONTROL TO USER FOR USER PROCESSING                 39000021
*                                                                       39100021
ETI25200 EQU   *                        GIVE CONTROL TO CALLER          39200002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 39210002
         NI    DCBOFLGS,X'FF'-DCBOLOCK  IND USER EXIT TAKEN      Y02082 39220002
*                                                                Y02082 39240002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 39260002
*                                                                Y02082 39280002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,WTGPREFX)          Y02082 39284002
*                                                                Y02082 39288002
         LA    R1,ULBUFR                POINT TO LABEL BUFFER           39300021
         LA    RD,ETI25500              LOAD ADDR FOR RETURN FROM SYNCH 39400021
ETI25300 EQU   *                        SYNCH TO CALLER                 39500002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 39550002
         ST    R1,ULPARM                PTR TO LABEL BUFFER      Y02082 39600002
         L     R1,DXUDCBAD              GET USER'S DCB ADDR      Y02082 39650002
         ST    R1,ULPARM+K4             PUT IN PARM LIST         Y02082 39700002
         XC    ULTOTPTR(K4),ULTOTPTR    ZERO THE USER TOTALING ENTRY    39800021
         MVI   ULDCBPTR,K0              CLEAR FLAG BYTE                 39900021
         LA    R1,ULPARM                POINT TO PARAMETER LIST         40000021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 40050002
         IECRES UEXIT,EXITAD=ULREQ,STM=(2,13,WTGPREFX)           Y02082 40100002
         L     RDCB,DXUDCBAD            PT TO CALLER'S DCB       YM3005 42762002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME CALLER'S KEY    YM3005 42772002
         OI    DCBOFLGS,DCBOLOCK        INDICATE RETURN FR USER  Y02082 42774002
         LA    R0,ALLBITS-DCBOBUSY      ISOLATE BUSY BIT MASK    YM3005 42776002
         IC    R1,DCBOFLGS              GET CALLER'S OFLGS       YM3005 42776402
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      YM3005 42813602
         L     RDCB,DXPDCBAD            PT TO COPIED DCB         YM3005 42823602
         OR    R0,R1                    ISOLATE CALLER BUSY BIT  YM3005 42833602
         IC    R1,DCBOFLGS              GET COPIED DCBOFLGS      YM3005 42843602
         NR    R1,R0                    UPDTE BUSY BIT TO CALLER YM3005 42845602
         STC   R1,DCBOFLGS              UPDATE OFLGS FIELD       YM3005 42847602
         OI    DCBOFLGS,DCBOLOCK        INDICATE RETURN FR USER  YM5981 42897602
         BR    RD                       RETURN TO CALLER                43100021
ETI25500 EQU   *                        RETURN FROM SYNCH               43200002
         CH    RF,RDAGAIN1              SHOULD ADD'L LABELS BE READ-    43300021
         BNE   ETI26000                 ..BR IF NOT- ALL DONE           43400021
         TM    JFCBLTYP,JFCBAL+JFCBUL   WERE ANSI USER LBLS SPECIFIED-  43500021
         BO    ETI24800                 ..BR IF YES- READ ANOTHER LABEL 43600021
         CLI   ULCNT+K1,MAXNOLAB        HAS MAX NO. OF LABELS BEEN READ 43700002
         BNL   ETI26000                 ..BR IF YES- ALL DONE           43800021
         B     ETI24800                 ..BR IF NOT TO READ NEXT LABEL  43900021
*                                                                       44000021
*****          ERROR ENCOUNTERED DURING READ                            44100021
*                                                                       44200021
ETI25600 EQU   *                        READ ERROR                      44300002
         LH    R1,ULCNT                 LOAD THE CURRENT LABEL NUMBER,  44700021
         LA    R1,K1(,R1)               ..INCREMENT IT BY 1, AND        44800021
         STH   R1,ULCNT                 ..SAVE IT IN THE WORK AREA      44900021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 44903002
         STC   R1,ULBUFR+K3             SAVE NO. OF LABEL WHICH COULD   45000002
*                                       ..NOT BE READ                   45100021
         LA    R1,DXIOB                 PTR TO STATUS INFO       Y02082 45103002
         ST    R1,ULPARM+K8             PUT IN PARM LIST         Y02082 45106002
         OI    ULPARM+K8,ERROR          INDICATE ERROR           Y02082 45109002
         B     ETI25200                 BR TO SYNCH TO USER             45200021
*                                                                       45300021
*              A TAPE MARK HAS BEEN READ. IF USER HAS PREVIOUSLY        45400021
*              PROCESSED ANY LABELS,  REPOSITION TAPE, FREEMAIN,        45500021
*              AND RETURN TO CALLER. IF USER HAS NOT PREVIOUSLY         45600021
*              PROCESSED ANY LABELS, SYNCH TO USER WITH LABEL           45700021
*              BUFFER POINTER SET TO ZERO, THEN REPOSITION              45800021
*              TAPE, FREEMAIN, AND RETURN TO CALLER.                    45900021
*                                                                       46000021
ETI25700 EQU   *                        TAPE MARK READ                  46100002
         CLI   ULCNT+K1,CHAR0           HAVE ANY LABELS BEEN PROCESSED- 46200002
         BH    ETI25800                 ..BR IF YES- ALL DONE           46300021
         TM    JFCBLTYP,JFCBAL+JFCBUL   WERE ANSI USER LBLS SPECIFIED-  46400021
         BO    ETI25800                 ..BR IF YES- ALL DONE           46500021
         MODESET EXTKEY=SUPR            SUPERVISOR KEY           Y02082 46503002
         XC    ULPARM+K8(K4),ULPARM+K8  ZERO ERROR PARAMETER            46600002
         SR    R1,R1                    ZERO BUFFER POINTER             46700021
         BAL   RD,ETI25300              BR AND LINK TO SYNCH TO USER    46800021
ETI25800 EQU   *                        BSF                             46900002
         MVI   DXCCW1,CCWBSF            INITLZ CCW FOR 'BSF' CMD M0961  47000021
ETI25900 EQU   *                        BSF                             47100002
         LA    RD,EABD196               LOAD INTERNAL ERROR CODE        47200021
         MVC   DXCCW1+K1(K15),BSFNOP1+K1 COMPLETE BACKSPACE CCW  M0961  47300002
*                                       ..AND INSERT 'NOP' CCW   M0961  47350021
         BAL   RC,ETI26400              BR AND LINK TO BACKSPACE        47400021
         BNO   ETI26500                 BR IF I/O ERROR                 47500021
ETI26000 EQU   *                        NO I/O ERROR                    47600002
*                                                                Y02082 47620002
*    FREEMAIN USER LABEL WORK AREAS                              Y02082 47640002
*                                                                Y02082 47660002
         IECRES FREE,A=(9),LV=USERLU,PREFIX=NO,SP=K229,          Y02082*47680002
               KEY=USER,STM=(2,14,WTGPREFX)                      Y02082 47700002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 47720002
         DROP  R9                                                Y02082 47740002
         LR    R1,RUCB                  CORE ADDR TO BE FREED    Y02082 47760002
         LM    RES,RC,ULREGSAV          RESTORE REGS 5 - 12      Y02082 47780002
         IECRES FREE,A=(1),PREFIX=YES,STM=(2,14,WTGPREFX)        Y02082 47800002
         USING UCB,RUCB                 RE-ESTABLISH UCB ADDRESSABILITY 48100021
*                                                                       48200021
*********************************************************************** 48300021
*              POSITION NEW VOLUME TO FIRST DATA RECORD               * 48400021
*********************************************************************** 48500021
*                                                                       48600021
ETI26100 EQU   *                        POSITION TO DATA RECORD         48700002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 48705002
         LA    RD,EABD191               LOAD INTERNAL ERROR CODE        48800021
         MVC   DXCCW1,AFSFCCW           INITLZ CCW FOR FSF COMMAND      48900021
         TM    DCBOFLGS,DCBORDBK        IS THE DCB OPENED FOR 'RDBACK'- 49000021
         BNO   ETI26200                 ..BR IF NOT TO ISSUE FSF        49100021
         MVI   DXCCW1,CCWBSF            INITLZ CCW FOR BSF COMMAND      49200021
ETI26200 EQU   *                        POSITION TAPE                   49300002
         BAL   RC,ETI26400              BR AND LINK TO POSITION TAPE    49400021
         BNO   ETI26500                 BR IF I/O ERROR                 49500021
         MVI   DXCCW1,CCWNOP            INITLZ CCW FOR 'NOP' COMMAND    49600021
         BAL   RC,ETI26400              BR TO WAIT FOR DEVICE END       49700021
         BO    ETI26300                 BR IF NO I/O ERROR              49800021
         TM    IOBSENS1,UCBLDPT         IS THE TAPE AT 'LOAD POINT'-    49900021
         BNO   ETI26500                 ..BR IF NOT TO ERR RTN          50000021
*                                       ..ELSE DROP THROUGH TO EXIT     50100021
         SPACE 2                                                        50200021
*********************************************************************** 50300021
*              EXIT                                                   * 50400021
*********************************************************************** 50500021
*                                                                       50600021
ETI26300 EQU   *                        EXIT                            50700002
         L     RTIOT,DXTIOTAD           RELOAD TIOT PTR        @ZA03660 50700137
         IECRES LOAD,MODID=MOD3F3H,BRCODE=K0,BRANCH=QUEUED       Y02080 50850002
*                                    INVOKE IECRES MACRO TO XCTL Y02080 50900002
         EJECT                                                          51400021
*********************************************************************** 51500021
*              SUBROUTINES                                            * 51600021
*********************************************************************** 51700021
*                                                                       51800021
*****          CLOSED SUBROUTINE TO PERFORM I/O OPERATIONS              51900021
*****          ENTRY TO THE SUBROUTINE IS VIA A 'BAL  RC,ETI26400'      52000021
*                                                                       52100021
ETI26400 EQU   *                        I/O SUBROUTINE                  52200002
         EXCP  DXIOB                    INITIATE I/O OPERATION          52300021
         IECRES WAIT                    INVOKE IECRES MACRO TO 'WAIT'   52400021
         TM    DXECB,ECBNOERR           TEST FOR AN I/O ERROR-          52500021
         BR    RC                       RETURN TO CALLER WITH           52600021
*                                       ..CONDITION CODE SET            52700021
         SPACE 2                                                        52800021
*  CLOSED SUBROUTINE USED TO VERIFY THAT LABEL IS HDR,EOF,OR EOV. 99223 52810002
*  RETURN TO CALLER VIA REGISTER RC.RETURN IS RC+4 IF PROPER TYPE.99223 52820002
ETI26420 EQU   *                        VERIFY HDR,EOF,EOV        99223 52830002
         CLC   FL1LABI,AHDR7            HEADER LABEL              99223 52840002
         BE    ETI26430                 YES,RETURN PLUS FOUR      99223 52850002
         CLC   FL1LABI,AEOF7            E-O-F LABEL               99223 52860002
         BE    ETI26430                 YES,RETURN PLUS FOUR      99223 52870002
         CLC   FL1LABI,EOV7             E-O-V LABEL               99223 52880002
         BNE   ETI26440                 YES,TAKE NORMAL RETURN    99223 52890002
ETI26430 EQU   *                        RETURN PLUS FOUR          99223 52892002
         LA    RC,K4(RC)                ADD 4 TO RETURN ADDR      99223 52894002
ETI26440 EQU   *                        NORMAL RETURN             99223 52896002
         BR    RC                       RETURN TO CALLER          99223 52898002
         SPACE 2                                                        52898402
*********************************************************************** 52900021
*              ERROR PROCESSING                                       * 53000021
*********************************************************************** 53100021
*                                                                       53200021
ETI26450 EQU   *                        ERROR PROCESSING                53300002
         LA    RD,EABD165               LOAD INTERNAL ERROR CODE        53400021
ETI26500 EQU   *                        ABEND                           53500002
         DMABCOND (RD),ABEND3F          EXIT TO PROB DETERMINATION RTN  53600021
         SPACE 2                                                        53700021
*********************************************************************** 53800021
*                                                                     * 53804037
*           CLOSED SUBROUTINE TO BYPASS LEADING TAPE MARK.            * 53808037
*      READ ONE RECORD. TEST TO SEE IF A TAPE MARK WAS READ. IF SO,   * 53812037
*      THE TAPE IS PROPERLY POSITIONED. IF A TAPE MARK WAS NOT READ   * 53816037
*      BACKSPACE ONE RECORD.                                          * 53820037
*                                                                     * 53824037
*********************************************************************** 53828037
ETI26600 MVC   DXCCW1,BSFNOP1+K8        MOVE IN CCW            @ZA28943 53832037
         LA    RF,DXLBL                 GET READ ADDRESS       @ZA28943 53836037
         ST    RF,DXCCW1                STORE ADDR IN CCW      @ZA28943 53838037
         MVI   DXCCW1,CCWRDTAP          INSERT READ OP         @ZA28943 53844037
         MVI   DXCCW1+K7,K12            SET READ LENGTH TO 12  @ZA28943 53848037
         BAL   RC,ETI26400              GO READ A RECORD       @ZA28943 53852037
         BO    ETI26650                 ECB=3F GO BSR          @ZA28943 53856037
         TM    IOBSTAT0,CSWUNITX        WAS A TAPE MARK READ ? @ZA28943 53860037
         BCR   1,RB                     YES RETURN             @ZA28943 53864037
         B     ETI26500                 NO ! BR I/O ERROR      @ZA28943 53868037
ETI26650 MVC   DXCCW1,BSFNOP1+K8        MOVE IN NEW CCW        @ZA28943 53872037
         MVI   DXCCW1,CCWBSR            INSERT BSR OP          @ZA28943 53876037
         BAL   RC,ETI26400              BACKSPACE THE RECORD   @ZA28943 53880037
         BNO   ETI26500                 I/O ERROR              @ZA28943 53884037
         BR    RB                       RETURN                 @ZA28943 53888037
         SPACE 2                                                        53892037
*********************************************************************** 53896037
*              CONSTANTS                                              * 53900021
*********************************************************************** 54000021
*                                                                       54100021
REWND    CCW   X'07',0,X'20',1          REWIND CCW                      54120002
ARDCCW0C DC    X'00000050'              CCW FOR READ OP - NO FLAGS,80 C 54160002
AFSFCCW  CCW   X'3F',0,X'20',1          FORWARD SPACE FILE              54200021
BSFNOP1  DC    X'2F00000060000001'      BSF COMMAND, CMD CHAIN,  M0961  54300021
*                                       ..SILI, AND LNG EQUAL 1  M0961  54350021
         DC    X'0300000020000001'      NOP CMD, SILI, LNG EQ 1  M0961  54400021
ARDCCW7  DC    X'00000050'              LENGTH EQ 50 FOR RD DATA M0961  54500021
RDAGAIN1 DC    H'4'                     'READ LABEL AGAIN' CODE  M0961  54600021
CONSTONE DC    X'0001'                  CONSTANT ONE             Y02134 54620002
CONTHREE DC    X'0003'                  HALFWORD CONSTANT OF 3   Y02134 54640002
AVOL0C   DC    C'VOL'                   VOLUME LABEL IDENTIFIER  Y02134 54660002
AHDR     DC    C'HDR'                   HEADER LABEL IDENTIFIER  Y02134 54680002
UVOL3D   DC    C'UVOL'                  USER VOLUME LABEL ID     Y02134 54700002
AVOL7    DC    C'VOL'                   VOLUME IDENTIFIER               54800021
AHDR7    DC    C'HDR'                   HEADER LABEL IDENTIFIER         54900021
EOV7     DC    C'EOV'                   END OF VOLUME IDENTIFIER        55000021
AEOF7    DC    C'EOF'                   END OF FILE IDENTIFIER          55100021
AUHL7    DC    C'UHL'                   USER HEADER LABEL IDENTIFIER    55200021
AUTL7    DC    C'UTL'                   USER TRAILER LABEL IDENTIFIER   55300021
UVOL0C   DC    C'UVL'                   USER VOLUME LABEL               55400021
BLANKS   DC    C'   '                   3 BLANK CHARACTERS       Y02083 55400202
KYES     DC    C'YES'                   'YES' REPLY MASK         Y02083 55400402
KNO      DC    C'NO '                   'NO ' REPLY MASK         Y02083 55400602
         EJECT                                                          55500021
*********************************************************************** 55600021
*              XCTL TABLE                                             * 55700021
*********************************************************************** 55800021
*                                                                       55900021
XCTLTB3F XCTLTABL ID=(ABEND3F,0P,MOD3F3H,3H,,NSLEHDRI,           Y02134X56000002
               ID3F4A,4A,                                        YM5950X56000102
               ID3D0P,0P,ID553F,3F,ID554J,4J,ID3F5T,5T),         YM5950X56000202
               SVC=055,BRT=YES,LENGTH=                           Y02134 56050002
         SPACE 2                                                        56100021
         IECDSECS CVT,                                                 C56200021
               TCB,                                                    C56300021
               TIOT,                                             Y02134X56320002
               RB,                                                     C56400021
               DCB,                                                    C56500021
               DEB,                                                    C56600021
               UCB,                                                    C56700021
               PSA,                                              Y02082X56720002
               MAIN,                                                   C56800021
               USERLAB,                                                C56900021
               WTG,                                              Y02080*56950002
               PREFX,                                            Y02080*56960002
               RRPL,                                             Y02144*56970002
               DSAB,                                             Y02083*56970202
               EXPAND=YES                                               57000021
         IECEQU ,                       INVOKE OPEN/CLOSE/EOV EQUATES   57100021
         SPACE 2                                                        57200021
         END                                                            57300021
