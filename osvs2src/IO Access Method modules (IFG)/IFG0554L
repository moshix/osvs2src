         TITLE 'IFG0554L, ALIAS IFG0195F/EOV, OPEN - DA INPUT USER HEADX00100021
               ER/TRAILER LABELS'                                       00200021
         COPY  LCGASMSW                                                 00300000
IFG0554L CSECT                                                          00500021
         ENTRY IFG0195F                                          Y02080 00550002
IFG0195F EQU   IFG0554L                 ALLIAS ENTRY POINT       Y02080 00560002
*********************************************************************** 00610002
*                                                                     * 00660002
*                                                                     * 00710002
*          VS2 RELEASE 037 DELETIONS/CHANGES                          * 00760037
*                                                                     * 00810037
*0000                                                          @ZA13594 00860037
*********************************************************************** 00910002
*                                                                     * 00960002
* MODULE NAME = IFG0554L (OS/VS2)                                     * 01010002
*                                                                     * 01060002
* DESCRIPTIVE NAME = EOV/OPEN DA INPUT USER HEADER LABELS             * 01110002
*                                                                     * 01160002
* COPYRIGHT = NONE                                                    * 01210002
*                                                                     * 01260002
* STATUS = RELEASE 2, LEVEL 0                                         * 01310002
*                                                                     * 01360002
* FUNCTION =                                                          * 01410002
*        THIS MODULE READS USER HEADER/TRAILER LABELS FOR OPEN-       * 01460002
*        EOV UNDER CONTROL OF THE CALLER'S INPUT USER HEADER/TRAILER  * 01510002
*        LABEL ROUTINE.                                               * 01560002
*        1) A 152 BYTE USER LABEL WORK AREA IS OBTAINED FOR EOV FROM  * 01610002
*        FETCH PROTECTED SUBPOOL 229 IN DATA MANAGEMENT KEY, AND      * 01660002
*        A 96 BYTE USER LABEL WORK AREA IS OBTAINED FOR THE CALLER    * 01710002
*        FROM FETCH PROTECTED SUBPOOL 229 IN THE CALLER'S KEY.        * 01760002
*        2) USER LABELS ARE READ AND PRESENTED TO THE CALLER UNTIL    * 01810002
*        AN EOF IS ENCOUNTERED, THE CALLER INDICATES TERMINATION OF   * 01860002
*        PROCESSING VIA A RETURN CODE, OR THE MAXIMUM NUMBER OF 8     * 01910002
*        USER LABELS HAVE BEEN PROCESSED.                             * 01960002
*        3) THE CALLER RETURNS TO THIS MODULE (AFTER PROCESSING EACH  * 02010002
*        USER LABEL) WITH A RETURN CODE IN REGISTER 15:               * 02060002
*        0 - TERMINATE USER LABEL PROCESSING.                         * 02110002
*        4 - CONTINUE USER LABEL PROCESSING                           * 02160002
*        8 - WRITE UPDATED USER LABEL AND TERMINATE                   * 02210002
*            USER LABEL PROCESSING.                                   * 02260002
*        12 - WRITE UPDATED USER LABEL AND CONTINUE                   * 02310002
*             USER LABEL PROCESSING.                                  * 02360002
*        RETURN CODES 8 AND 12 MAY ONLY BE USED IF THE DATA SET IS    * 02410002
*        PHYSICAL SEQUENTIAL AND OPENED FOR UPDATE, OR PHYSICAL       * 02460002
*        SEQUENTIAL OPENED FOR OUTPUT/OUTIN WITH DISP = MOD, OR       * 02510002
*        DSORG = DA OPENED FOR UPDATE OR OUTPUT.                      * 02560002
*        4) IF NO USER LABEL TRACK WAS ALLOCATED, THE CALLER'S EXIT   * 02610002
*        ROUTINE IS ENTERED WITH THE BUFFER POINTER SET TO ZERO. IF   * 02660002
*        NO LABELS CAN BE READ, EXIT TO CALLER'S EXIT ROUTINE         * 02710002
*        WITH THE LABEL BUFFER POINTER = ZERO.                        * 02760002
*        5) IF AN I/O ERROR OCCURS WHEN READING USER LABEL, THE       * 02810002
*        CALLER'S ROUTINE IS ENTERED AGAIN WITH BIT 0 OF THE          * 02860002
*        FLAG BYTE SET TO 1, AND A POINTER TO THE STATUS INFORMATION  * 02910002
*        IN THE WORK AREA IOB. ON RETURN, THE RETURN CODE IS IG-      * 02960002
*        NORED AND NORMAL PROCESSING RESUMES FOR EOV.                 * 03010002
*        8) IF AN I/O ERROR OCCURS WHILE WRITING THE UPDATED USER     * 03060002
*        LABEL, THE CALLER'S EXIT ROUTINE IS ENTERED WITH BITS 0      * 03110002
*        AND 1 OF THE FLAG BYTE IN THE PARAMETER LIST SET TO 1, AND   * 03160002
*        A POINTER TO THE STATUS INFORMATION IN THE WORK AREA IOB.    * 03210002
*                                                                     * 03260002
* NOTES = SEE BELOW                                                   * 03310002
*                                                                     * 03360002
*    DEPENDENCIES =                                                   * 03410002
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 03460002
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 03510002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 03560002
*                                                                     * 03610002
*    RESTRICTIONS = NONE                                              * 03660002
*                                                                     * 03710002
*    REGISTER CONVENTIONS =                                           * 03760002
*            R2 POINTS TO DCB                                         * 03810002
*            R4 POINTS TO OPEN WORK AREA                              * 03860002
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 03910002
*            R6 POINTS TO THE WTG TABLE                               * 03960002
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 04010002
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 04060002
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 04110002
*            R10 POINTS TO THE UCB                                    * 04160002
*                                                                     * 04210002
*    PATCH LABEL = SEE THIRD FROM LAST LABEL BEFORE ORG STATEMENT AT  * 04260002
*                  END OF LISTING.                                    * 04310002
*                                                                     * 04360002
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 04410002
*                                                                     * 04460002
*    PROCESSOR = ASSEMBLER XF                                         * 04510002
*                                                                     * 04560002
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 04610002
*                  ORG STATEMENT AT END OF LISTING                    * 04660002
*                                                                     * 04710002
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 04760002
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 04810002
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 04860002
*                                                                     * 04910002
* ENTRY POINT =                                                       * 04960002
*        IFG0554L                                                     * 05010002
*        IFG0195F - ALIAS                                             * 05060002
*                                                                     * 05110002
*    PURPOSE = SEE FUNCTION                                           * 05160002
*                                                                     * 05210002
*    LINKAGE =                                                        * 05260002
*        THIS MODULE IS TRANSFERRED CONTROL THROUGH THE IECRES-LOAD   * 05310002
*        MACRO INSTRUCTION.                                           * 05360002
*                                                                     * 05410002
* INPUT =                                                             * 05460002
*        GIVEN CONTROL IN PROTECT KEY 5.                              * 05510002
*        REGISTER 2 POINTS TO THE COPIED DCB.                         * 05560002
*        DEBDCBAD POINTS TO THE COPIED DCB.                           * 05610002
*        REGISTER 4 POINTS TO THE EOV WORKAREA                        * 05660002
*                                                                     * 05710002
* OUTPUT =                                                            * 05760002
*        THE NEXT MODULE IS GIVEN CONTROL IN PROTECT KEY 5 WITH       * 05810002
*        REGISTER 2 POINTING TO THE COPIED DCB,                       * 05860002
*        DEBDCBAD POINTING TO THE COPIED DCB,                         * 05910002
*        AND REGISTER 4 POINTING TO THE EOV WORKAREA,                 * 05960002
*                                                                     * 06010002
* EXIT-NORMAL =                                                       * 06060002
*        EXIT TO MODULE WHOSE ID/EPA IS IN DXRETMOD. THIS IS          * 06110002
*        NORMALLY THE CALLER OF THIS MODULE OR THE MODULE THAT THE    * 06160002
*        CALLER OF THIS MODULE WOULD HAVE GONE TO HAD THERE NOT BEEN  * 06210002
*        USER LABEL PROCESSING.                                       * 06260002
*                                                                     * 06310002
* EXIT-ERROR = NONE                                                   * 06360002
*                                                                     * 06410002
* EXTERNAL REFERENCES = SEE BELOW                                     * 06460002
*                                                                     * 06510002
*    ROUTINES =                                                       * 06560002
*        IFG019RA THROUGH THE IECRES MACRO.                           * 06610002
*                                                                     * 06660002
*    DATA AREAS =                                                     * 06710002
*        EOV WORKAREA.                                                * 06760002
*                                                                     * 06810002
*    CONTROL BLOCK =                                                  * 06860002
*        CVT                                                          * 06910002
*        DEB                                                          * 06960002
*        JFCB                                                         * 07010002
*        PSA                                                          * 07060002
*        TCB                                                          * 07110002
*        RB                                                           * 07160002
*                                                                     * 07210002
* TABLES =                                                            * 07260002
*                                                                     * 07310002
* MACROS =                                                            * 07360002
*        MODESET                                                      * 07410002
*        IECRES LOAD                                                  * 07460002
*        IECRES GET                                                   * 07510002
*        IECRES INIT                                                  * 07560002
*        IECRES FREE                                                  * 07610002
*        IECRES UEXIT                                                 * 07660002
*        EXCP                                                         * 07710002
*        WAIT                                                         * 07760002
*        SETLOCK                                                      * 07810002
*        ENQ                                                          * 07860002
*                                                                     * 07910002
* CHANGE ACTIVITY =                                                   * 07960002
*        SEE CHANGES/DELETIONS SECTION JUST AFTER CSECT CARD.         * 08010002
*                                                                     * 08060002
*********************************************************************** 08110002
         EJECT                                                          08160002
         IECDSECS CVT,TCB,RB,DCB,PSA,   DEFINE DSECTS TO BE      Y02082*23950002
               MAIN,DEB,USERLAB,WTG,    EXPANDED AT THE END      Y02144*24100002
               PREFX,RRPL                                        Y02144 24150002
*                                                                       24200021
         IECEQU ,                       DEFINE EQUATES                  24300021
*                                                                       24400021
         USING IHADCB,RDCB              DEFINE BASE TO DCB              24500021
         USING FORCORE,RCORE            DEFINE BASE TO DCB WORK AREA    24600021
         USING WTG,RWTG                 DEFINE BASE TO XCTL/WTG TABLE   24700021
         USING DEB,RDEB                 DEFINE BASE FOR DEB             24900021
*                                                                       25000021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         25100021
         USING *,RBASE                  DEFINE BASE REGISTER            25200021
*                                                                       25300021
*********************************************************************** 25400021
*                                                                       25500021
*                                                                Y02082 25550002
*     OBTAIN CORE FOR USER LABEL WORK AREAS                      Y02082 25600002
*                                                                Y02082 25650002
         IECRES GET,LV=USERLDM,PREFIX=YES,SP=K229,               Y02082*25700002
               STM=(2,14,WTGPREFX),ID=ULWA                       Y02144 25750002
         LR    RUCB,R1                  ADDR OF GOTTEN CORE      Y02082 25800002
         USING ULDMWK,RUCB                                       Y02082 25850002
*                                                                Y02082 25900002
         IECRES GET,LV=USERLU,PREFIX=NO,KEY=USER,SP=K229,        Y02082*25950002
               STM=(2,14,WTGPREFX)                               Y02082 26000002
         LR    R9,R1                    ADDR OF GOTTEN CORE      Y02082 26050002
         USING ULUWK,R9                                          Y02082 26100002
         MODESET EXTKEY=DATAMGT         DATA MANGEMENT KEY       Y02082 26150002
         CLI   WTGMODNM+K5,C'9'         IS THIS OPEN (IFG0195F)         26400021
         BNE   ULI01A                   BR IF NO                        26500021
         MVC   DXVOLMT2(K5),DXCCW7      SAVE DSCB CCHHR FOR OPEN        26600021
*                                                                       26700021
ULI01A   EQU   *                        NOT OPEN                        26800002
         CLI   DSCEXTYP,ULEXT           IS FIRST EXTENT FOR USER LABELS 26900021
         BNE   ULT300                   BR IF NO TO INFORM TO USER      27000021
*                                                                       27100021
*********************************************************************** 27200021
*                                                                       27300021
*  SET UP CHANNEL PROGRAM AND WORK AREA TO READ FIRST HEADER / TRAILER  27400021
*  LABEL                                                                27500021
*                                                                       27600021
*        READ COUNT        INTO ULWK8                                   27700021
*        SEARCH KEY EQ     KEY IN ULWK6 = 'UHL1'/'UTL0'                 27800021
*        TIC *-16                                                       27900021
*        READ DATA (LABEL) INTO BUFFER                                  28000021
*                                                                       28100021
         XC    DXCCW1(K32),DXCCW1       CLEAR CCW AREA                  28200021
         LA    R1,ULWK8                 POINT TO AREA INTO WHICH        28300021
         ST    R1,DXCCW1                COUNT IS READ                   28400021
         LA    R1,ULWK6                 POINT TO AREA CONTAINING        28500021
*                                       SEARCH ARGUMENT                 28600021
         ST    R1,DXCCW2                FOR SEARCH KEY EQUAL            28700021
         LA    R1,DXCCW1                POINT TO READ COUNT CCW         28800021
         ST    R1,DXCCW3                IN TIC                          28900021
         LA    R1,ULDMBUFR              POINT TO LABEL BUFFER    Y02082 28950002
         ST    R1,DXCCW4                IN READ DATA                    29100021
         OC    DXCCW1(K32),ULCP1        OR IN CMND, FLAGS, LENGTH       29200021
*                                                                       29300021
*        INITIALIZE IOBDADAD WITH R=0                                   29400021
*                                                                       29500021
*                                       MBB SET BEFORE ENTRY            29600021
         MVC   DXDAADDR+K3(K4),DSCLOWLM  CCHH FROM START OF 1ST EXTENT  29700021
         MVI   DXDAADDR+K7,K0           START SEARCH AT R0              29800021
*                                                                       29900021
         TM    DCBDSORG,DCBORGDA        IS THIS DIRECT ORGANIZATION     30000021
         BZ    ULT040                   BR IF NO                        30100021
*                                                                       30200021
         MVC   DXDEBUCB+1(K3),DXUCBADR+1 GET FIRST UCB ADDRESS @ZA13594 30210037
*                                                              @ZA13594 30220037
         MVC   ULDMBUFR(ULT6000L),ULT6000K MOVE PARM LIST        YM5789 30250002
         STH   RUCB,ULDMBUFR+ULT6000L   MOVE UCBADDR AND CCHH    YM5789 30300002
         MVC   ULDMBUFR+K2+ULT6000L(K6),DXDAADDR+K1 TO MINOR NAM YM5789 30350002
         ENQ   (,ULDMBUFR+ULT6000L),MF=(E,ULDMBUFR) ENQ ON ULTRK YM5789 30400002
         L     RC,DXATCOM3              GET RRPLIST PTR          Y02144 30450002
         USING RRPLIST,RC                                        Y02144 30460002
         OI    RRFLAGS1,RRFENQUL        SHOW ENQ'D ON UL TRACK   Y02144 30470002
*                                                                       30500021
ULT040   EQU   *                        NO ENQ NEEDED                   30600002
         MVC   ULWK6,UHLCONST           SET UP SEARCH ARG = UHL1        30700021
         NI    DXREGC,ALLBITS-LASTNTRY  TURN OFF HIGH ORDER BIT SA55619 30750002
         CLI   DXREGC,XLIUHL            IS THIS INPUT UHL EXIT  SA55619 30760000
         BE    ULT040B                  BR IF YES               SA66619 30770000
         MVC   ULWK6,UTLCONST           SET UP SEARCH ARG = UTL0        31000021
ULT040B  EQU   *                        INPUT UHL EXIT                  31100002
         MVC   ULWK10,ULWK6             NECESSARY SINCE FIRST CHANNEL   31200021
*                                       PROGRAM DOES NOT READ KEY       31300021
         OI    ULWK2,X01                SET FIRST READ SWITCH           31400021
*                                                                       31500021
*        READ FIRST HEADER / TRAILER LABEL                              31600021
*                                                                       31700021
         BAL   RC,ULEXCP                GO READ USER LABEL              31800021
*                                                                       31900021
*********************************************************************** 32000021
*                                                                       32100021
*  ESTABLISH CHANNEL PROGRAM FOR SUBSEQUENT USE, THEN TEST              32200021
*  FOR I/O ERROR.                                                       32300021
*                                                                       32400021
*  SET UP CHANNEL PROGRAM TO WRITE BACK LABEL AND READ NEXT LABEL       32500021
*                                                                       32600021
*        SEARCH KEY EQ       KEY = UHL(N) / UTL(N)                      32700021
*        TIC *-8                                                        32800021
*        WRITE DATA          WRITE UPDATED LABEL                        32900021
*        SEARCH ID EQ        ID OF RECORD PRIOR TO UHL(N)  / UTL(N)     33000021
*        TIC *-8             CHECK                                      33100021
*        RD CKD    (SKIP)    LABEL JUST WRITTEN                         33200021
*        RD CKD              READ NEXT LABEL                            33300021
*                                                                       33400021
*  WHEN ONLY UPDATING IS PERFORMED, CC FLAG IN RD CKD IS TURNED OFF.    33500021
*                                                                       33600021
*  WHEN NO UPDATING IS PERFORMED,CHANNEL PROGRAM TO READ NEXT LABEL IS  33700021
*                                                                       33800021
*        SEARCH KEY EQ       KEY OF PREVIOUS LABEL                      33900021
*        TIC *-8                                                        34000021
*        RD CKD              READ NEXT LABEL                            34100021
*                                                                       34200021
*  PROCEDURE USED BELOW IS TO USE KEY IN ULWK10 (KEY OF LABEL           34300021
*  PROCESSED) AS SEARCH ARGUMENT FOR SUBSEQUENT I/O OPERATIONS.         34400021
*                                                                       34500021
         MVC   DXCCW1(K16),DXCCW2       SEARCH KEY CCW TO DXCCW1        34600021
*                                       AND TIC *-8 TO DXCCW2           34700021
         XC    DXCCW3(K40),DXCCW3       CLEAR REMAINING CCW AREA        34800021
*                                                                       34900021
*  DXCCW3 IS ESTABLISHED AFTER USER RETURNS CODE                        35000021
         LA    R1,DXDAADDR+K3           ADDR OF IOBADDR+3 (CCHHR) FOR   35100021
         ST    R1,DXCCW4                SEARCH ID                       35200021
         LA    R1,DXCCW4                TIC TO                          35300021
         ST    R1,DXCCW5                DXCCW4                          35400021
         LA    R1,ULWK8                 RD CKD INTO                     35500021
         ST    R1,DXCCW7                ULWK8                           35600021
         OC    DXCCW4(K32),ULCP3        OR IN CMND, FLAGS, LENGTH       35700021
*                                                                       35800021
*********************************************************************** 35900021
*                                                                       36000021
ULT050   EQU   *                        TEST FOR I/O ERROR              36100002
         TM    DXECB,ECBCOD7F           TEST IF I/O ERROR               36200021
         BNO   ULT200                   BR IF YES                       36300021
*                                                                       36400021
         NI    ULWK2,X'FF'-X01          SET 1ST-READ-SW OFF IF ON       36500021
         IC    R1,ULWK9                 'R' OF COUNT READ IN            36600021
         BCTR  R1,R0                    DECR BY 1 - USED IN ORIENTATION 36700002
         STC   R1,DXDAADDR+K7           FOR WRITE VERIFICATION          36800021
*                                                                       36900021
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 36904502
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 36909002
         MODESET EXTKEY=ZERO            SUPERVISOR KEY           Y02082 36913502
*     OBTAIN LOCAL LOCK                                          Y02082 36918002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*36922502
               RELATED=('PREVENT FREE USER CORE-RELEASED BELOW') Y02082 36927002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 36931502
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 36936002
*     VERIFY USER STILL HOLDS USER LABEL WORK AREA               Y02082 36940502
         OC    ULUWK(USERLU),ULUWK      PGM CHECK IF NOT         Y02082 36945002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 36949502
         MVC   ULBUFR,ULDMBUFR          COPY LABEL TO USER BUFF  Y02082 36954002
*     RELEASE LOCAL LOCK                                         Y02082 36958502
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 36963002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 36967502
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 36972002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 36976502
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 36981002
         BAL   RD,ULSYNCH               GO TO SYNCH TO USER EXIT RTN    37000021
* RETURN IN DATAMGT KEY                                          Y02082 37100002
         LTR   RF,RF                    DID USER RETURN A CODE = 0      37200021
         BZ    ULT500                   BR IF YES (NO MORE PROCESSING)  37300021
*                                                                       37400021
ULT130   EQU   *                        RETURN CODE NOT ZERO            37500002
*  SOME TYPE OF I/O WILL BE INITIATED.  SEARCH WILL BE BASED UPON KEY   37600021
*  OF LABEL 'JUST PROCESSED'.                                           37700021
         MVC   ULWK6,ULWK10             SET UP SEARCH ARGUMENT          37800021
         XC    DXCCW3,DXCCW3            ENSURE THAT PRVIUS CCW DOES NOT 37900021
*        CONFLICT WITH CHANNEL PROGRAM TO BE COMPLETED BELOW.           38000021
         CLI   ULRETCOD,READNEXT        DIS USER RETURN A CODE = 4      38100021
         BE    ULT150                   BR IF YES TO READ NEXT LABEL    38200021
*                                                                       38300021
*  CHECK IF 8 OR 12 IS A VALID RETURN CODE                              38400021
         L     RDEB,DCBDEBAD            POINTER TO USER'S DEB           38500021
         CLI   WTGMODNM+K5,C'9'         IS THIS OPEN (IFG0195F)         38600021
         BNE   ULT135                   BR IF NO, USER'S DEB EXISTS     38700021
         LA    RDEB,DXDEB               DURING OPEN USE WORK DEB        38800021
ULT135   EQU   *                        NOT OPEN                        38900002
         TM    DEBOPATB,DEBOPOUT-DEBOPUPD  TEST IF OPENED FOR OUTPUT    39000021
         BO    ULT140                   BR IF YES                       39100021
         BM    ULT500                   BR IF NOT UPDAT OR INPUT        39200021
         TM    DEBOPATB,DEBOPUPD        TEST IF OPENED FOR UPDAT        39300021
         BO    ULT145                   BR IF YES                       39400021
         B     ULT500                   BR OPENED FOR INPUT             39500021
*                                                                       39600021
ULT140   EQU   *                        OPENED FOR OUTPUT               39700002
         TM    DCBDSORG,DCBORGDA        IF NOT UPDATE, DIRECT DATA SET  39800021
         BZ    ULT500                   FOR OUTPUT IS ALSO VALID.       39900021
*                                                                       40000021
*  SET UP THIRD CCW TO WRITE UPDATED LABEL                              40100021
*                                                                       40200021
ULT145   EQU   *                        WRITE UPDATED LABEL             40300002
         LA    R1,ULDMBUFR              ESTAB WRITE DATA CCW3 TO Y02082 40304502
         ST    R1,DXCCW3                WRITE FROM LABEL BUFFER         40500021
         OC    DXCCW3,ULCP2             OR IN CMND, FLAGS, LENGTH       40600021
*                                                                Y02082 40604002
*     COPY UPDATED LABEL TO EOV'S BUFFER                         Y02082 40608002
*                                                                Y02082 40612002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 40616002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 40620002
         MODESET EXTKEY=ZERO            SUPERVISOR KEY           Y02082 40624002
*     OBTAIN LOCAL LOCK                                          Y02082 40628002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*40632002
               RELATED=('PREVENT FREE USER CORE-RELEASED BELOW') Y02082 40636002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 40640002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 40644002
*     VERIFY USER STILL HOLDS USER LABEL WORK AREA               Y02082 40648002
         OC    ULUWK(USERLU),ULUWK      PGM CHECK IF NOT         Y02082 40652002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 40656002
         MVC   ULDMBUFR,ULBUFR          COPY LABEL FROM USER BUFFY02082 40660002
*     RELEASE LOCAL LOCK                                         Y02082 40664002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 40668002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 40672002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 40676002
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 40680002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 40684002
*                                                                       40700021
         MVC   ULDMBUFR(K4),ULWK10      MOVE UHLX/UTLX TO BUFFER YM1175 40750002
         CLI   ULRETCOD,WRITNEXT        IS LABEL TO BE WRITTEN ONLY     40800021
         BE    ULT170                   BR IF YES                       40900021
         CLI   ULRETCOD,WRITNEXT+READNEXT  IS LABEL TO BE WRITTEN AND   41000021
         BE    ULT160                   NEXT LABEL READ, BR IF YES      41100021
         B     ULT500                   INVALID CODE RETURNED, END      41200021
*                                       PROCESSING IN THIS MODULE       41300021
*                                                                       41400021
*        READ NEXT LABEL                                                41500021
*                                                                       41600021
ULT150   EQU   *                        READ NEXT LABEL                 41700002
         CLI   DXREGC,XLIUHL            IS THIS INPUT UHL EXIT  SA55619 41750000
         BE    ULT151                   BR IF YES               SA55619 41800000
         CLI   ULWK10+K3,C'7'           HAS MAX NO. OF UTL ALREADY      42000021
         BNL   ULT500                   BEEN READ, BR IF YES            42100021
         B     ULT152                   BR NO TO CONTINUE               42200021
ULT151   CLI   ULWK10+K3,C'8'           HAS MAX NO. OF UHL ALREADY      42300021
         BNL   ULT500                   BEEN READ, BR IF YES            42400021
*        ESTABLISH THIRD CCW TO READ NEXT LABEL                         42500021
ULT152   LA    R1,ULWK8                 SET RD CKD CCW TO READ INTO     42600021
         ST    R1,DXCCW3                AREA STARTING AT ULWK8          42700021
         OC    DXCCW3,RDCKD             OR IN CMND, FLAGS, LENGTH       42800021
*                                                                       42900021
ULT155   EQU   *                        GO READ NEXT LABEL (OR WRITE    43000021
         BAL   RC,ULEXCP                UPDATED LABEL AND READ NEXT     43100021
*                                       LABEL)                          43200021
         B     ULT050                   GO CHECK FOR ERROR              43300021
*                                                                       43400021
*        WRITE UPDATED LABEL AND READ NEXT LABEL                        43500021
*                                                                       43600021
ULT160   EQU   *                        WRITE THEN READ LABEL           43700002
         CLI   DXREGC,XLIUHL            IS THIS INPUT UHL EXIT  SA55619 43750000
         BE    ULT161                   BR IF YES               SA55619 43800000
         CLI   ULWK10+K3,C'7'           HAS MAX NO. OF UTL ALREADY      44000021
         BNL   ULT165                   BEEN READ, BR IF YES            44100021
         B     ULT162                   BR NO TO CONTINUE               44200021
ULT161   CLI   ULWK10+K3,C'8'           HAS MAX NO. OF UHL ALREADY      44300021
         BNL   ULT165                   BEEN READ, BR IF YES            44400021
ULT162   OI    DXCCW6+K4,CCWCMDCH       ENSURE COMMAND CHAIN FLAG IN    44500021
*                                       VERIFICATION RD CKD IS ON       44600021
         B     ULT155                   GO PERFORM I/O                  44700021
*                                                                       44800021
*        MAXIMUM NUMBER OF LABELS HAVE ALREADY BEEN READ,               44900021
*        RETURN CODE CHANGED TO WRITE LABEL ONLY.                       45000021
*                                                                       45100021
ULT165   EQU   *                        MAX NO. LABELS READ             45200002
         MVI   ULRETCOD,WRITNEXT        CHANGE RETURN CODE TO UPDATE    45300021
*                                                                       45400021
*        WRITE UPDATED LABEL                                            45500021
ULT170   EQU   *                        WRITE UPDATED LABEL             45600002
         NI    DXCCW6+K4,X'FF'-CCWCMDCH  TURN OFF CMND CHAIN FLAG IN RD 45700021
*                                  CCW THAT PERFORMS WRITE VERIFICATION 45800021
*                                                                       45900021
         BAL   RC,ULEXCP                GO WRITE UPDATED LABEL          46000021
*                                                                       46100021
         TM    DXECB,ECBCOD7F           TEST IF I/O ERROR               46200021
         BO    ULT500                   BR IF NO, NO MORE PROCESSING    46300021
*                                                                       46400021
*********************************************************************** 46500021
*                                                                       46600021
*  I/O ERROR HAS OCCURRED                                               46700021
*                                                                       46800021
ULT200   EQU   *                        I/O ERROR PROCESSING            46900002
         LA    R1,DXIOB                 PUT PTR TO STATUS INFO IN       47000021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 47004002
         ST    R1,ULERRPTR              PARAMETER LIST                  47100021
         MVI   ULERRPTR,ERROR           FLAG ERROR CONDITION(ALSO RESET 47200021
*                                       OTHER ERROR FLAGS TO ZERO).     47300021
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 47304002
*  DETERMINE TYPE OF CHANNEL PROGRAM BEING USED WHEN ERROR OCCURRED.    47400021
*                                                                       47500021
         CLI   ULRETCOD,WRITNEXT        IS ERROR ON READ ONLY           47600021
         BL    ULT210                   BR IF YES                       47700021
*                                       (IF ERROR ON FIRST READ,        47800021
*                                       ULRETCOD=0, BR TAKEN)           47900021
*        EITHER WRITING OR WRITING THEN READING                         48000021
         MVC   ULWK3+K1(K3),IOBCOMAD+K1  OBTAIN CSW POINTER             48100021
         L     R1,ULWK3                 FROM IOB                        48200021
         LA    R0,DXCCW7+K8             POINT 8 BYTES PAST READ CCW,    48300021
         CR    R1,R0                    THEN COMPARE WITH CSW POINTER   48400021
         BNE   ULT230                   BR IF ERROR DURING WRITE        48500021
*                                                                       48600021
*  READ ERROR                                                           48700021
*                                                                       48800021
ULT210   EQU   *                        READ ERROR OCCURRED             48900002
         SR    R1,R1                    CLEAR REG                       49000002
         IC    R1,ULWK6+K3              OBTAIN LAST CHAR OF KEY         49100021
         TM    ULWK2,X01                TEST IF ERROR ON FIRST READ     49200021
         BO    ULT220                   BR IF YES                       49300021
*                                       RECONSTRUCT KEY AREA            49400021
         MVC   ULWK10(K3),UHLCONST      'UHL' TO KEY AREA               49500021
         TM    DXREGC,XLIUTL            IS THIS INPUT UTL EXIT          49600021
         BNO   ULT040C                  BR IF NO                        49700021
         MVC   ULWK10(K3),UTLCONST      'UTL' TO KEY AREA               49800021
ULT040C  EQU   *                        NOT INPUT UTL EXIT              49900002
         LA    R1,K1(R1)                INCREMENT 'N' OF KEY            50000021
         STC   R1,ULWK10+K3             AND PLACE IN KEY AREA           50100021
*        SET UP BUFFER TO TELL USER WHAT LABEL WE WERE UNABLE TO READ   50200021
ULT220   EQU   *                        SET UP BUFFER                   50300002
         NI    ULWK2,X'FF'-X01          SET 1ST READ SW OFF IF ON       50400021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 50404002
         MVC   ULBUFR(K3),UHLCONST      'UHL' TO BUFFER                 50500021
         CLI   DXREGC,XLIUHL            IS THIS INPUT UHL EXIT  SA55619 50550000
         BE    ULT040D                  BR IF YES               SA55619 50600000
         MVC   ULBUFR(K3),UTLCONST      'UTL' TO BUFFER                 50800021
         LA    R1,K1(R1)                INCR N BY 1 SINCE START AT UTL0 50900021
ULT040D  EQU   *                        INPUT UHL EXIT                  51000002
         STC   R1,ULBUFR+K3             LABEL NUMBER TO BUFFER          51100021
         B     ULT240                   GO TO SYNCH TO USER EXIT RTN    51200021
*                                                                       51300021
*  WRITE ERROR                                                          51400021
*                                                                       51500021
ULT230   EQU   *                        WRITE ERROR                     51600002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 51604002
         OI    ULERRPTR,ERROROUT        FLAG WRITE ERROR CONDITION      51700021
ULT240   EQU   *                        SYNCH TO CALLER                 51800002
         BAL   RD,ULSYNCH1              GO TO SYNCH TO USER             51900021
* RETURN IN DATAMGT KEY                                          Y02082 52000002
         LTR   RF,RF                    DID USER RETURN A CODE = 0      52100021
         BZ    ULT500                   BR IF YES, (NO MORE PROCESSING) 52200021
         ST    RF,ULWK1                 SAVE RETURN CODE                52300021
         CLI   ULRETCOD,READNEXT        DID USER RETURN A CODE = 4      52400021
         BE    ULT130                   BR IF YES, TO READ NEXT LABEL   52500021
         B     ULT500                   BR, INVALID CODE RETURNED       52600021
*                                                                       52700021
*********************************************************************** 52800021
*                                                                       52900021
*  NO USER LABEL TRACK WAS ALLOCATED FOR THIS DATA SET.                 53000021
*                                                                       53100021
ULT300   EQU   *                        NO UL TRACK ALLOCATED           53200002
         SR    R1,R1                    ZERO USER LABEL BUFFER PTR      53300021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 53304002
         XC    ULERRPTR,ULERRPTR        ZERO ERROR INDICATORS           53400021
         BAL   RD,ULSYNCH2              GO TO SYNCH TO USER EXIT RTN    53500021
* RETURN IN DATAMGT KEY                                          Y02082 53550002
         B     ULT510                   BR TO RETURN TO CALLER          53600021
*                                                                       53700021
*                                                                       55200021
*********************************************************************** 55300021
*                                                                       55400021
*        CLOSED SUBROUTINE TO TAKE USER EXIT                     Y02082 55500002
*        REGISTER CONTENTS AT ENTRY TO EXIT ARE AS FOLLOWS-      Y02082 55900002
*                        R0 - CONTAINS NO MEANINGFUL INFORMATION        56000021
*                        R1 - PTR TO PARAMETER LIST                     56100021
*                    R2-R13 - USER'S CONTENTS BEFORE I/O SUPPORT        56200021
*                       R14 - RETURN ADDRESS (SET BY SYNCH)             56300021
*                       R15 - USER'S EXIT ROUTINE ADDRESS               56400021
*                                                                       56500021
ULSYNCH  EQU   *                        SYNCH ENTRY 1                   56600002
         XC    ULERRPTR,ULERRPTR        ZERO ERROR INDICATOR            56700021
ULSYNCH1 EQU   *                        SYNCH ENTRY 2                   56800002
         LA    R1,ULBUFR                PTR TO LABEL BUFFER             56900021
ULSYNCH2 EQU   *                        SYNCH ENTRY 3                   57000002
         ST    R1,ULPARM                PTR TO LABEL BUFFER      Y02082 57050002
         L     R1,DXUDCBAD              GET USER'S DCB ADDR      Y02082 57100002
         ST    R1,ULPARM+K4             PUT IN PARM LIST         Y02082 57150002
         NI    ULDCBPTR,X'FF'-LASTNTRY  INSURE HI-ORDER BIT OF SECOND   57300021
*                              PARAMETER IS OFF (WOULD BE ON IF FEOV)   57400021
         CLI   DXREGC,XLIUHL            IS THIS INPUT UHL EXIT  SA55619 57450000
         BE    UL450                    BR IF YES               SA55619 57500000
         L     RDEB,DCBDEBAD            USER'S DEB ADDRESS              57700021
         CLI   WTGMODNM+K5,C'9'         IS THIS OPEN (IFG0195F)         57800021
         BE    UL450                    BR IF YES                       57900021
         TM    DCBDSORG,DCBORGDA        IS DSORG DIRECT                 58000021
         BO    UL425                    BR IF YES, INDICATE EOF SA55619 58050000
         CLC   JFCBNVOL,DXVOLSEQ+K1     IS THIS LAST VOLSER      YM5340 58200002
         BE    UL425                    BR IF YES TO SET EOV     YM5340 58250002
         TM    DSCDSIND,LASTNTRY        LAST VOLUME WITH DATA    YM5340 58300002
         BNO   UL450                    BR IF NO                 YM5340 58350002
UL425    EQU   *                                                SA55619 59050000
         OI    ULDCBPTR,EOFFLG          INDICATE EOF            SA55619 59100000
*                                                                       59200021
UL450    EQU   *                        EOV - NOT EOF                   59300002
         MODESET EXTKEY=DATAMGT         DCB COPY KEY             Y02082 59302002
         NI    DCBOFLGS,X'FF'-DCBOLOCK  SET LOCK BIT = 0         Y02082 59310002
*                                                                Y02082 59350002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 59360002
*                                                                Y02082 59370002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,WTGPREFX)          Y02082 59380002
*                                                                Y02082 59390002
         LA    R1,ULPARM                POINT TO PARAMETER LIST         59400021
         IECRES UEXIT,EXITAD=DXREGC,STM=(2,13,WTGPREFX)          Y02082 59500002
         L     RDCB,DXUDCBAD            PT TO CALLER'S DCB       YM3005 59550002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME CALLER'S KEY    YM3005 59600002
         OI    DCBOFLGS,DCBOLOCK        INDICATE RETURN FR USER  Y02082 59650002
         LA    R0,ALLBITS-DCBOBUSY      ISOLATE BUSY BIT MASK    YM3005 59700002
         IC    R1,DCBOFLGS              GET CALLER'S OFLGS       YM3005 59750002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      YM3005 59800002
         L     RDCB,DXPDCBAD            PT TO COPIED DCB         YM3005 59850002
         OR    R0,R1                    ISOLATE CALLER BUSY BIT  YM3005 59900002
         IC    R1,DCBOFLGS              GET COPIED DCBOFLGS      YM3005 59950002
         NR    R1,R0                    UPDTE BUSY BIT TO CALLER YM3005 60000002
         STC   R1,DCBOFLGS              UPDATE OFLGS FIELD       YM3005 60050002
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT = 1                61300021
         ST    RF,ULWK1                 SAVE RETURN CODE                61400021
         BR    RD                       RETURN FROM SYNCH EXIT SUBR     61500021
         EJECT                                                          61600002
*********************************************************************** 61900021
*                                                                       62000021
*                   CLOSED SUBROUTINE TO ISSUE I/O OPERATIONS           62100021
*                                                                       62200021
*        IT IS ASSUMED THAT ALL CONTROL BLOCKS HAVE ALREADY BEEN SET UP 62300021
*                                                                       62400021
ULEXCP   EQU   *                        I/O ROUTINE                     62500002
         EXCP  DXIOB                    UPDATE / READ USER LABEL        62600021
*                                                                       62700021
         WAIT  ECB=DXECB                WAIT FOR I/O TO COMPLETE        62800021
*                                                                       62900021
         TM    IOBSTAT0,CSWUNITX        TEST IF UNIT EXCEPTION (EOF)    63000021
         BCR   14,RC                    BR RETURN IF NO                 63100021
*                                                                       63200021
         CLI   DXREGC,XLIUHL            IS THIS INPUT UHL EXIT  SA55619 63250000
         BE    ULEXC1                   BR IF YES               SA55619 63300000
         CLI   ULWK10+K3,C'0'           HAVE ANY UTL BEEN READ          63500021
         BH    ULT500                   PREVIOUSLY, BR IF YES           63600021
         B     ULEXC2                   BR NO TO CONTINUE               63700021
ULEXC1   CLI   ULWK10+K3,C'1'           HAVE ANY UHL BEEN READ          63800021
         BH    ULT500                   PREVIOUSLY, BR IF YES           63900021
*                                                                       64000021
*        NO HEADERS EXIST ON USER LABEL TRACK.                          64100021
ULEXC2   EQU   *                        NO HEADERS EXIST         Y02082 64150002
         MODESET KEYADDR=DXUKEY,WORKREG=1 USER BUFFER KEY        Y02082 64160002
         SR    R1,R1                    ZERO USER LBL BUFFER PTR Y02082 64200002
         XC    ULERRPTR,ULERRPTR        ZERO ERROR INDICATORS           64300021
         BAL   RD,ULSYNCH2              GO TO SYNCH TO USER EXIT RTN    64400021
* RETURN IN DATAMGT KEY                                          Y02082 64450002
*                                                                       64500021
*********************************************************************** 64600021
*                                                                       64700021
*        NO FURTHER UL PROCESSING IS PERFORMED.  FREE CORE AND RETURN   64800021
*        TO CALLER.                                                     64900021
*                                                                       65000021
ULT500   EQU   *                        ISSUE DEQ, RETURN               65100002
         TM    DCBDSORG,DCBORGDA        IS DS DIRECT ORGANIZATION       65200021
         BZ    ULT510                   BR IF NO                        65300021
         MVC   ULDMBUFR(ULT6000L),ULT6000K MOVE PARM LIST        YM5789 65350002
         STH   RUCB,ULDMBUFR+ULT6000L   MOVE UCBADDR AND CCHH    YM5789 65360002
         MVC   ULDMBUFR+K2+ULT6000L(K6),DXDAADDR+K1 TO MINOR NAM YM5789 65370002
         DEQ   (,ULDMBUFR+ULT6000L),MF=(E,ULDMBUFR) DEQ ULTRK    YM5789 65380002
*                                                                       65600021
ULT510   EQU   *                        FREE UL WORK AREAS              65700002
* FREE UL AREA, LABEL BUFFER AND PARAMETER LIST                  Y02080 65750002
         IECRES FREE,A=(R9),LV=USERLU,SP=229,KEY=USER,PREFIX=NO, Y02082*65800002
               STM=(0,14,WTGPREFX)      FREE USER WORK AREA      Y02082 65850002
         IECRES FREE,A=(RUCB),PREFIX=YES,STM=(0,14,WTGPREFX)     Y02080*65950002
                                        FREE EOV WORK AREA       Y02080 65960002
*                                                                       66000021
*  RETURN TO CALLER                                                     66100021
*                                                                       66200021
         CLI   WTGMODNM+K5,C'9'         IS THIS OPEN (IFG0195F)         66300021
         BNE   ULT530                   BR IF NO                        66400021
         MVC   DXCCW7(K5),DXVOLMT2      RESTORE DSCB CCHHR ADDR         66500021
*                                                                       66600021
ULT530   EQU   *                        RETURN TO DXRETMOD              66700002
         LM    RTIOT,RET,DXREG9         RESTORE REGISTERS 9-14          66800021
         LM    R0,R1,DXREG0             RESTORE REGISTERS 0-1           66900021
*                                                                       67000021
*                                       XCTL TO NEXT MODULE      Y02080 67050102
         IECRES LOAD,MODID=DXRETMOD,BRCODE=(RET),BRANCH=QUEUED   Y02080 67150002
*                                                                       67200021
         DROP  RUCB,RWTG                                                67300021
*                                                                       67400021
*********************************************************************** 67500021
*                                                                       67600021
*        CONSTANTS                                                      67700021
*                                                                       67800021
*  CHANNEL PROGRAM TO READ FIRST HEADER/TRAILER LABEL                   67900021
ULCP1    DC    X'1200000040000008'      READ COUNT                      68000021
         DC    X'2900000040000004'      SEARCH KEY EQ                   68100021
         DC    X'0800000000000000'      TIC *-16                        68200021
         DC    X'0600000000000050'      READ DATA                       68300021
*                                                                       68400021
*  CCW 3 OF CHANNEL PROGRAM TO UPDATE LABEL                             68500021
ULCP2    DC    X'0500000040000050'      WRITE DATA                      68600021
*                                                                       68700021
*  PART OF CHANNEL PROG TO READ NEXT LABEL AFTER UPDATE PREVIOUS LABEL  68800021
ULCP3    DC    X'3100000040000005'      SEARCH ID EQ                    68900021
         DC    X'0800000000000000'      TIC *-8                         69000021
         DC    X'1E0000005000005C'      READ COUNT,KEY,DATA (SKIP)      69100021
RDCKD    DC    X'1E0000000000005C'      READ COUNT,KEY,DATA             69200021
*                                                                       69300021
UHLCONST DC    C'UHL1'                  KEY OF FIRST HEADER LABEL       69400021
UTLCONST DC    C'UTL0'                  KEY OF FIRST TRAILER LABEL      69500021
ULT6000K ENQ   (ULT6001K,,E,8,SYSTEM),MF=L ENQ LIST FORM         YM5789 69550002
ULT6000L EQU   *-ULT6000K               LENGTH OF ENQ/DEQ LIST   YM5789 69600002
ULT6001K DC    CL8'SYSZUSRL'            MAJOR NAME               YM5789 69650002
*                                                                       70000021
         XCTLTABL SVC=055,BRT=YES,LENGTH=                        Y02080 70170002
*                                                                       70200021
         IECDSECS EXPAND=YES            EXPAND DESIRED DSECTS HERE      70300021
*                                                                       70400021
         END                                                            70500021
