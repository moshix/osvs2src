         TITLE 'IFG0554N                      EOV DIRECT ACCESS OUTPUT -00200002
               - FEOV PROCESSING'                                Y02134 00250002
IFG0554N CSECT                                                          00450002
*********************************************************************** 00500002
*                                                                     * 00550002
*                                                                     * 00600002
*          VS2 RELEASE 02 DELETIONS                                   * 00650002
*                                                                     * 00700002
*                                                                     * 00750002
*********************************************************************** 00800002
*                                                                     * 00850002
* MODULE NAME = IFG0554N (OS/VS2)                                     * 00900002
*                                                                     * 00950002
* DESCRIPTIVE NAME =                                                  * 01000002
*        EOV DIRECT ACCESS OUTPUT - FEOV PROCESSING                   * 01050002
*                                                                     * 01100002
* COPYRIGHT = NONE                                                    * 01150002
*                                                                     * 01200002
* STATUS = RELEASE 2, LEVEL 0                                         * 01250002
*                                                                     * 01300002
* FUNCTION =                                                          * 01350002
*        THIS MODULE IS ENTERED FROM IFG0551H IF FEOV HAS BEEN        * 01400002
*        ISSUED FOR A DIRECT ACCESS DATA SET FOR WHICH THE LAST       * 01450002
*        OPERATION WAS AN OUTPUT OPERATION (THE TRAILER SWITCH OR     * 01500002
*        'WRITE BIT', BIT ZERO IN DCBOFLGS, WAS SET TO ONE).          * 01550002
*        THIS MODULE WRITES A FILE MARK AFTER THE DATA USING THE      * 01600002
*        DCBFDAD FIELD TO DETERMINE THE LAST DATA RECORD WRITTEN.     * 01650002
*                                                                     * 01700002
*        THE FILE MARK IS WRITTEN ON THE TRACK CONTAINING THE LAST    * 01750002
*        DATA RECORD IF THE RECORD FORMAT IS FIXED STANDARD AND IF    * 01800002
*        A RECORD OF LENGTH DEBBLKSI WILL FIT ON THE TRACK.           * 01850002
*                                                                     * 01900002
*        A FILE MARK IS WRITTEN AS RECORD ONE ON THE NEXT TRACK AFTER * 01950002
*        THE LAST TRACK CONTAINING DATA WHETHER OR NOT THE RECORD     * 02000002
*        FORMAT IS FIXED STANDARD. THIS MAY REQUIRE GOING TO A NEW    * 02050002
*        EXTENT, BUT THE DATA SET WILL NOT BE EXTENDED ON THIS VOLUME * 02100002
*        IN ORDER TO WRITE A FILE MARK. NO FILE MARK WILL BE WRITTEN  * 02150002
*        ON THE NEXT TRACK IF NO SUCH TRACK EXISTS.                   * 02200002
*                                                                     * 02250002
*        THE FORMAT 1 DSCB IS READ, AND THE THE DS1LSTAR AND DS1TRBAL * 02300002
*        FIELDS ARE FILLED IN FROM DCBFDAD AND DCBTRBAL, INDICATING   * 02350002
*        THE LAST DATA RECORD AND THE TRACK BALANCE ON THE LAST TRACK * 02400002
*        OF THIS VOLUME, NOT INCLUDING THE FILE MARK JUST WRITTEN.    * 02450002
*        THE LAST VOLUME BIT (BIT 0 OF DSCDSIND) IS TURNED OFF. THE   * 02500002
*        FORMAT 1 DSCB IS THEN REWRITTEN.                             * 02550002
         EJECT                                                          02600002
*        IF NEITHER USER LABEL PROCESSING NOR SMF PROCESSING IS       * 02650002
*        REQUIRED, MODULE IFG0554P IS GIVEN CONTROL NEXT WITH         * 02700002
*        REGISTER 14 SET TO 4.                                        * 02750002
*                                                                     * 02800002
*        IF USER LABEL PROCESSING IS REQUIRED BUT NOT SMF PROCESSING  * 02850002
*        MODULE IFG0554Z IS NEXT GIVEN CONTROL WITH REGISTER 14 SET   * 02900002
*        TO ZERO.                                                     * 02950002
*                                                                     * 03000002
*        IF SMF PROCESSING AND NOT USER LABEL PROCESSING IS REQUIRED  * 03050002
*        MODULE IFG0553B (ALIAS FOR IFG0202H) IS GIVEN CONTROL WITH   * 03100002
*        DXRETMOD IN THE EOV WORKAREA SET TO THE ID-VCON OF IFG0554P  * 03150002
*        AS THE MODULE NEXT TO BE GIVEN CONTROL WHEN SMF PROCESSING   * 03200002
*        IS COMPLETED, AND REGISTER 14 SET TO 4, WHICH WILL BE        * 03250002
*        PASSED TO IFG0554P WHEN IT IS GIVEN CONTROL.                 * 03300002
*                                                                     * 03350002
*        IF BOTH SMF AND USER LABEL PROCESSING IS REQUIRED, MODULE    * 03400002
*        IFG0553B IS GIVEN CONTROL WITH DXRETMOD SET TO THE ID-VCON   * 03450002
*        OF IFG0554Z WITH REGISTER 14 SET TO ZERO.                    * 03500002
*                                                                     * 03550002
* NOTES =                                                             * 03600002
*        SEE BELOW.                                                   * 03650002
*                                                                     * 03700002
*    DEPENDENCIES =                                                   * 03750002
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 03800002
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 03850002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 03900002
*                                                                     * 03950002
*    RESTRICTIONS = NONE                                              * 04000002
*                                                                     * 04050002
*    REGISTER CONVENTIONS =                                           * 04100002
*            R2 POINTS TO DCB                                         * 04150002
*            R4 POINTS TO OPEN WORK AREA                              * 04200002
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 04250002
*            R6 POINTS TO THE WTG TABLE                               * 04300002
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 04350002
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 04400002
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 04450002
*            R10 POINTS TO THE UCB                                    * 04500002
*                                                                     * 04550002
*    PATCH LABEL = SEE THIRD FROM LAST LABEL BEFORE ORG STATEMENT AT  * 04600002
*                  END OF LISTING.                                    * 04650002
         EJECT                                                          04700002
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 04750002
*                                                                     * 04800002
*    PROCESSOR = ASSEMBLER XF                                         * 04850002
*                                                                     * 04900002
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 04950002
*                  ORG STATEMENT AT END OF LISTING                    * 05000002
*                                                                     * 05050002
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 05100002
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 05150002
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 05200002
*                                                                     * 05250002
* ENTRY POINT =                                                       * 05300002
*        IFG0554N                                                     * 05350002
*                                                                     * 05400002
*    PURPOSE = SEE FUNCTION                                           * 05450002
*                                                                     * 05500002
*    LINKAGE =                                                        * 05550002
*        THIS MODULE IS TRANSFERRED CONTROL THROUGH THE IECRES-LOAD   * 05600002
*        MACRO INSTRUCTION.                                           * 05650002
*                                                                     * 05700002
* INPUT =                                                             * 05750002
*        GIVEN CONTROL IN PROTECT KEY 5.                              * 05800002
*        REGISTER 2 POINTS TO THE COPIED DCB.                         * 05850002
*        DEBDCBAD POINTS TO THE COPIED DCB.                           * 05900002
*        REGISTER 4 POINTS TO THE EOV WORKAREA                        * 05950002
*                                                                     * 06000002
* OUTPUT =                                                            * 06050002
*        THE NEXT MODULE IS GIVEN CONTROL IN PROTECT KEY 5 WITH       * 06100002
*        REGISTER 2 POINTING TO THE COPIED DCB,                       * 06150002
*        THE DEBDCBAD POINTING TO THE COPIED DCB,                     * 06200002
*        AND REGISTER 4 POINTING TO THE EOV WORKAREA,                 * 06250002
*                                                                     * 06300002
*        IFG0553B -                                                   * 06350002
*        DXRETMOD SET TO ID-VCON OF IFG0554Z OR IFG0554P.             * 06400002
*        REGISTER 14 SET TO ZERO (DXRETMOD FOR IFG0554Z),             * 06450002
*        OR TO 4 (DXRETMOD FOR IFG0554P).                             * 06500002
*                                                                     * 06550002
*        IFG0554P -                                                   * 06600002
*        REGISTER 14 SET TO 4.                                        * 06650002
*                                                                     * 06700002
*        IFG0554Z -                                                   * 06750002
*        DXRETMOD SET TO ID-VCON IF IFG0554P.                         * 06800002
*        REGISTER 14 SET TO 0.                                        * 06850002
         EJECT                                                          06900002
* EXIT-NORMAL =                                                       * 06950002
*        IFG0554Z TO PROCESS USER TRAILER LABELS.                     * 07000002
*        IFG0554P TO CONTINUE EOV PROCESSING.                         * 07050002
*        IFG0554B FOR SMF PROCESSING.                                 * 07100002
*                                                                     * 07150002
* EXIT-ERROR =                                                        * 07200002
*        IFG0550P GIVEN CONTROL THROUGH DMABCOND MACRO WITH AN        * 07250002
*        INTERNAL ABEND CODE IN REGISTER 0 -                          * 07300002
*        232 - 737-2C ABEND IF DCBFDAD DOESN'T CORRESPOND TO THE DEB. * 07350002
*        187 - 737-10 - I/O ERROR WRITING FILE MARK.                  * 07400002
*        190 - 737-4 - I/O ERROR READING OR WRITING DSCB.             * 07450002
*                                                                     * 07500002
* EXTERNAL REFERENCES = SEE BELOW                                     * 07550002
*                                                                     * 07600002
*    ROUTINES =                                                       * 07650002
*        IFG019RA THROUGH THE IECRES MACRO.                           * 07700002
*                                                                     * 07750002
*        IECPRLTV - MBBCCHHR TO TTR CONVERT ROUTINE                   * 07800002
*                                                                     * 07850002
*    DATA AREAS =                                                     * 07900002
*        EOV WORKAREA.                                                * 07950002
*                                                                     * 08000002
*    CONTROL BLOCK =                                                  * 08050002
*        DCB                                                          * 08100002
*        TCB                                                          * 08150002
*        CVT                                                          * 08200002
*        UCB                                                          * 08250002
*        VDSCB                                                        * 08300002
*        DEB                                                          * 08350002
*                                                                     * 08400002
* TABLES =                                                            * 08450002
*        DEVICE CHARACTERISTICS TABLE                                 * 08500002
*                                                                     * 08550002
* MACROS =                                                            * 08600002
*        MODESET                                                      * 08650002
*        IECRES-LOAD                                                  * 08700002
*        EXCP                                                         * 08750002
*        WAIT                                                         * 08800002
*        DMABCOND                                                     * 08850002
*        XCTLTABL                                                     * 08900002
*        IECDSECS                                                     * 08950002
*        IECEQU                                                       * 09000002
*                                                                     * 09050002
* CHANGE ACTIVITY =                                                   * 09100002
*        SEE CHANGES/DELETIONS SECTION JUST AFTER CSECT CARD.         * 09150002
*                                                                     * 09200002
*********************************************************************** 09250002
         EJECT                                                          09300002
*        INTERNAL ABEND CODES                                           09350002
EABD187  EQU   187                      READ DSCB I/O ERROR 737-10      13600002
EABD190  EQU   190                      WRITE DSCB I/O ERROR 737-4      13800002
EABD737  EQU   232                      BAD DCBFDAD INTERNAL     Y02082 13850002
*                                       ABEND CODE 737-2C        Y02082 13900002
         BALR  RBASE,0                  ESTABLISH ADDRESSABILITY        14000000
         USING FORCORE,RCORE                                            14200000
         USING WTG,RWTG                 BASE FOR WTG TABLE       Y02080 14250002
         USING TIOENTRY,RTIOT                                           14400000
         USING UCB,RUCB                                                 14600000
         USING DEB,RDEB                                                 14800000
         USING DCBRELAD,RDCB                                            15000000
         USING CVT,RF                                                   15200000
         USING EDO00200,RBASE                                           15400000
EDO00200 EQU   *                        ENTRY                           15600002
*                                                                       15800000
*                       WRITE FILE MARK                                 18000000
*                                                                       18200000
         SR    R7,R7                    CLEAR WORK REGISTER             18400000
         IC    R7,DCBFDAD               PICK UP M (CURRENT EXTENT NO.)  18600000
         CLM   R7,B'0001',DEBNMEXT      ARE THERE M EXTENTS      Y02082 18650002
*                                       IN THE DEB               Y02082 18700002
         LA    R0,EABD737               737 INTERNAL ABCODE      Y02082 18750002
         BNL   EDO02450                 BRANCH IF NO-737 ABEND   Y02082 18760002
         SLL   R7,4                     MPY BY 16 TO POINT TO EXTENT    18800000
         AR    RDEB,R7                  POINTING TO PROPER EXTENT (DEB) 19000000
         MVC   DXDEBBIN(K12),DEBBINUM   PLACE USERS EXTENT IN WORK AREA 19200000
         MVC   DXCCW4+K1(K8),DCBFDAD    MOVE MBBCCHHR TO WORK AREA      19400000
         MVI   DXDEBUCB,DCBRECUN        SET MODIFIER BYTE ALLOW WRITES  19600000
         MVC   DXDEBUCB+K1(K3),DXUCBADR+K1 UCB ADDRESS TO DEB    Y02134 19800002
         L     R1,DCBDVTBL              ADDRESS OF DEVICE TABLE         20200000
         LH    RF,K4(R1)                PICK UP NR OF BYTES PER TRACK   20400000
         CH    RF,DCBTRBAL              IS FULL TRCK AVAILABLE FOR FM   20600000
         BE    EDO01100                 BR IF FULL TRCK AVAILABLE       20800000
         TM    DCBRECFM,DCBRECFX+DCBRECST  IS THE USER WRITING FIXED    21000000
*                                       STANDARD RECORDS                21200000
         BNO   EDO00500                 NO,DO NOT WRITE F.M. ON THIS    21400000
*                                       TRACK                           21600000
         EJECT                                                          21650002
*                                                                       21700002
*        IF FIXED STANDARD, WRITE FILE MARK ON SAME TRACK AS     Y02082 21750002
*        LAST RECORD IF BLOCK WILL FIT THERE                     Y02082 21760002
*                                                                       21770002
         IC    R8,K7(R1)                LAST RECORD ID OVERHEAD SA57120 21800002
         LR    RF,R8                    SAVE VALUE                      22000000
         IC    R8,DCBKEYCN              KEY OVERHEAD                    22200000
         SR    RF,R8                    HIGH ORDER 3 BYTES OF           22400000
*                                       RF ARE ZEROED OUT               22600000
         LR    RD,RDEB                  SAVE DEB REGISTER               22800000
         L     RDEB,DCBDEBAD            PICK UP DEB ADDRESS             23000000
         SR    RC,RC                    CLEAR REGISTER                  23200000
         IC    RC,DEBNMEXT              PICK UP NUMBER OF               23400000
*                                       EXTENTS                         23600000
         SLL   RC,K4                    MULTIPLY BY 16                  23800000
         AR    RC,RDEB                  ADD DEB ADDRESS                 24000000
         TM    DCBMACRF,DCBMEXCP        IS IT EXCP                      24200000
         BNO   EDO00300                 BRANCH IF NO                    24400000
         LA    RF,K8                    GET LENGTH NEEDED FOR FM        24600000
         B     EDO00400                 YES BRANCH                      24800000
EDO00300 EQU   *                        ADD DEBBLKSI VALUE              25000002
         AH    RF,K44(RC)               ADD KEYLENGTH+BLOCKSIZE         25200000
EDO00400 EQU   *                        SEE IF BLOCK FITS               25400002
         CH    RF,DCBTRBAL              WILL RECORD FIT ON THIS         25600000
*                                       TRACK                           25800000
         LR    RDEB,RD                  RESTORE DEB REGISTER            26000000
         BP    EDO00500                 NO,DON'T WRITE THIS TRACK       26200000
         BAL   R8,EDO01300              YES,GO SET UP CHANNEL PROGRAM   26400000
         IC    RF,DXCCW4+K8             ADD 1 TO LAST RECORD NUMBER     26600000
         LA    RF,K1(,RF)               WRITTEN BY THE PROBLEM PROGRAM  26800000
         STC   RF,DXDSCB+K4             STORE UPDATED RECORD NUMBER     27000000
         BAL   R8,EDO01400              GO TO WRITE THE FILE MARK       27200000
         OI    DXATDACC,DXATEOF         EOF MARK WRITTEN         Y02144 27250002
*                                                                       27300002
*        WRITE FILE MARK ON NEXT TRACK                                  27350002
*                                                                       27360002
EDO00500 EQU   *                        CALCULATE NEXT TRACK            27400002
         SR    RF,RF                    CLEAR WORK REGISTER             27600000
         MVI   DXCCW4+K8,K0             SET R=0                         27800000
         IC    RF,DXCCW4+K7             C(RJ)=000H                      28000000
         LA    RF,K1(,RF)               C(RJ)=H+1                       28200000
         STC   RF,DXCCW4+K7             C(CCW4+4)=CCH(H+1)              28400000
         L     R1,DCBDVTBL              ADDRESS OF DEVICE TABLE         28600000
         CLC   DXCCW4+K7(K1),K3(R1)     IS TRACK+1 VALID                28800000
         BNL   EDO00600                 BR IF TRACK NOT VALID           29000000
         L     R1,DCBDEBAD                                              29200000
         TM    K8(R1),DEBOFSPL          CHK FOR SPLIT CYLINDER          29400000
         BNO   EDO01100                 BR IF NO SPLIT CYLINDER         29600000
         EJECT                                                          29650002
*                                                                       29700002
*        SPLIT CYLINDER EXTENT                                          29750002
*                                                                       29760002
         CLC   DXCCW4+K7(K1),DEBENDHH+K1  CHK FOR SPLIT CYL END TRACK   29800000
         BNH   EDO01100                 BR IF NOT END TRACK             30000000
*                                                                       30200000
*   IF TRACK NUMBER IS NOT VALID FOR THE DEVICE OR IS THE LAST OF A     30400000
*   SPLIT CYLINDER, STEP TO THE NEXT CYLINDER.                          30600000
*                                                                       30800000
EDO00600 EQU   *                        CALCULATE NEXT CYLINDER         31000002
         LH    RF,DXCCW4+K4             C(RJ)=00CC                      36200000
         LA    RF,K1(,RF)               C(RJ)=00C(C+1)                  36400000
         SLL   RF,K16                   C(RJ)=C(C+1)00                  36600002
EDO01000 EQU   *                        SET TRACK TO ZERO OR START OF   37200002
*                                       SPLIT CYLINDER.                 37250002
         ST    RF,DXCCW4+K4             C(CCW4+4)=NEXT CYL, TRK ZERO    37400000
         L     RF,DCBDEBAD                                              37600000
         TM    K8(RF),DEBOFSPL          CHK FOR SPLIT CYLINDER          37800000
         BZ    EDO01100                 BR IF NOT SPLIT CYLINDER        38000000
         MVC   DXCCW4+K7(K1),DEBSTRHH+K1  SPLIT CYL, SET TRACK TO START 38200000
*                                                                       38400000
EDO01100 EQU   *                        IS ADDRESS IN EXTENT            38600002
         CLC   DXCCW4+K4(K4),DEBENDCC   IS CCHH IN THIS EXTENT          38800000
         BH    EDO01500                 NO,GO SEE IF ANOTHER EXTENT     39000000
EDO01200 EQU   *                        WRITE FILE MARK                 39200002
         BAL   R8,EDO01300              YES,GO TO SET UP CHANNEL PROG   39400000
         MVI   DXDSCB+K4,K1             SET RCD NO. OF FILE MARK TO 1   39600000
         BAL   R8,EDO01400              GO TO WRITE THE FILE MARK       39800000
         OI    DXATDACC,DXATEOF         EOF MARK WRITTEN         Y02144 39850002
         B     EDO01600                 EXIT, FILE MARK WRITTEN         40000000
         SPACE 2                                                        40200002
EDO01300 EQU   *                        BUILD CHANNEL PROGRAM SUBROUT'N 40400002
         LA    RF,DXCCW4+K4             PLACE ADDRESS OF CCHHR          40600000
         ST    RF,DXCCW1                INTO SEARCH CCW                 40800000
         LA    RF,DXCCW1                ADDRESS OF CCW1                 41000000
         MVI   DXCCW1,CCWSCHID          SET UP SEARCH OPERATION CODE    41200000
         ST    RF,DXCCW2                ADDRESS OF CCW1 INTO TIC CCW    41400000
         MVC   DXCCW1+K4(K5),WFMCCW1    COMMAND CHAIN,5 CHAR,TIC OPER   41600000
         LA    RF,DXDSCB                PLACE ADDRESS OF THE FILE MARK  41800000
         ST    RF,DXCCW3                INTO THE WRITE DATA CCW         42000000
         MVC   DXCCW2+K4(K5),WFMCCW2    COMMAND CHAIN,WR COMMAND OPER   42200000
         MVC   DXCCW3+K4(K4),WFMCCW3    8 CHARACTERS                    42400000
         MVC   DXDSCB(K5),DXCCW4+K4     PLACE CCHHR INTO THE KEY        42600000
         XC    DXDSCB+K5(K3),DXDSCB+K5  ZERO OUT THE DATA PORTION       42800000
         BR    R8                       RETURN TO CALLER                43000000
         EJECT                                                          43200002
EDO01400 EQU   *                        WRITE FILE MARK SUBROUTINE      43400002
         MVC   DXDAADDR,DXCCW4+K1       PLACE FULL DISK ADDRESS IN IOB  43600000
         MVI   DXDAADDR,K0              SET M (EXTENT NUMBER) TO ZERO   43800000
         EXCP  DXIOB                    EXECUTE CHANNEL PROGRAM         44000000
         WAIT  ,ECB=DXECB               WAIT FOR COMPLETION             44200000
         TM    DXECB,ECBCOD7F           TEST COMPLETION CODE            44400000
         BOR   R8                       RETURN TO CALLER                44600002
         LA    R0,EABD187               I/O ERROR WRITE FILE MARK       44800000
         B     EDO02450                 GO ISSUE 737 ABEND              45000000
         SPACE 2                                                        45200002
EDO01500 EQU   *                        GET NEXT EXTENT SUBROUTINE      45400002
         L     RDEB,DCBDEBAD            RESTORE ADDRESS OF USER'S DEB   45600000
         SR    RF,RF                    CLEAR WORK REGISTER             45800000
         SR    R7,R7                    CLEAR WORK REGISTER             46000000
         IC    R7,DCBFDAD               PICK UP M (CURRENT EXTENT NO.)  46200000
         IC    RF,DEBNMEXT              PICK UP NUMBER OF EXTENTS       46400000
         LA    R7,K1(,R7)               UPDATE M BY ONE                 46600000
         CR    R7,RF                    ARE THERE ANY MORE XTNTS        46800000
         BNL   EDO01600                 NO,FILE MARK NOT TO BE WRTN     47000002
         SLL   R7,K4                    MULTIPLY EXTENT NUMBER BY 16    47200002
         AR    RDEB,R7                  POINT TO CORRECT DEB EXTENT     47400000
         MVC   DXDEBBIN(K12),DEBBINUM   PUT BEGINNING CCHH IN WORK DEB  47600000
         MVC   DXCCW4+K2(K6),DXDEBBIN   STARTING BBCCHH TO SEARCH       47800000
         MVI   DXCCW4+K8,K0             SET RECORD NUMBER TO ZERO       48000000
         B     EDO01200                 WRITE FILE MARK IN NEW EXTENT   48200000
         EJECT                                                          48400002
*                                                                       48450002
*        READ FORMAT 1 DSCB                                             48500002
*                                                                       48550002
EDO01600 EQU   *                        SEE IF VIO                      48600002
         L     RDEB,DCBDEBAD            RESTORE ADDRESS OF USER'S DEB   48800000
         L     RUCB,DXUCBADR            PICK UP UCB POINTER      Y02134 49000002
         TM    UCBJBNR,UCBVRDEV         TEST FOR VIO UCB         Y02132 49012002
         BNO   EDO01700                 BR IF NOT                Y02132 49024002
*                                                                       49034002
*        READ VIO DSCB FROM SWA                                  Y02132 49036002
*                                                                       49046002
         MVC   DXDSCB(DSCEXT2-DSCFMTID),VDSDSCB-VDSUCB+L'JFCBDSNM(RUCB) 49048002
*                                                                Y02132 49060002
         OC    DXDSCB(DSCEXT2-DSCFMTID),DXDSCB IS DSCB = ZERO?   Y02132 49072002
         BZ    EDO02425                 BR IF YES,I/O ERROR      Y02132 49084002
*                                                                Y02132 49096002
         XC    DSCEXT2(DSCBEND-DSCEXT2),DSCEXT2 ZERO REMAIN CORE Y02132 49108002
*                                                                Y02132 49120002
         B     EDO01800                 CONTINUE PROCESSING      Y02132 49132002
EDO01700 EQU   *                        NOT VIO                  Y02132 49144002
*                                                                       49200000
*        READ REAL FORMAT 1 DSCB FROM VTOC                              49250002
*                                                                       49600000
         MVC   DXDEBUCB+K1(K3),DXUCBADR+K1 UCB ADDRESS TO DEB    Y02134 50000002
         XC    DXDEBSCC(K4),DXDEBSCC    CLEAR START CCHH                50400000
         L     R1,K16                   GET CVT ADDR                    50600000
         L     R1,K64(R1)               GET DEVICE TABLE                50800000
         SR    RF,RF                    CLEAR REG                       51000000
         IC    RF,UCBTBYT4              GET DEVICE TYPE                 51200000
         IC    RF,K0(RF,R1)             GET DEVICE INDEX                51400000
         LA    RF,K0(RF,R1)             GET DEVICE ENTRY                51600000
         MVC   DXDEBECC(K4),K0(RF)      GET MAX EXTENT                  51800000
         MVI   DXDEBNTR,MAXTRK          INDICATE MAX TRACKS             52000000
         LR    R7,RDEB                                                  52200000
         SH    R7,WFM016                POSITION AT (-16)               52400000
         MVC   DXDAADDR+K1(K7),DEB+K1-DEB(R7)  BBCCHHR OF DSCB          52600000
*                                       TO SEEK WRD                     52800000
         MVI   DXDAADDR,K0              SET -M-TO ZERO                  53000000
*                                                                       53200000
*        GENERATE CHANNEL PROGRAM TO READ DSCB FRMT 1                   53400000
*                                                                       53600000
         XC    DXCCW1(K24),DXCCW1       ZERO CCWS 1 THRU 3              53800000
         LA    R1,DXDAADDR+K3           ADDR OF CCHHR                   54000000
         ST    R1,DXCCW1                SRCH I.D.TO CCW 1               54200000
         LA    R1,DXCCW1                ADDR  OF SRCH CMD TO TIC        54400000
         ST    R1,DXCCW2                STORE IT                        54600000
         LA    R1,DXDSCB                READ AREA ADDRESS               54800000
         ST    R1,DXCCW3                TO READ M/T CMD.                55000000
         OC    DXCCW1(K24),WFMCCWS      OR IN SKELETON CCWS-WKAREA.     55200000
         BAL   R7,EDO02400              BRANCH TO I/O ROUTINE           55400000
         EJECT                                                          55450002
*                                                                       57600000
*        UPDATE THE DSCB AND REWRITE IT                                 58000002
*                                                                       58200002
*              MBBCCHHR TO TTR CONVERT ROUTINE (IECPRLTV) WILL BE USED  58400002
*                                                                       58800002
*              THE FOLLOWING IS THE REGISTER USAGE OF THAT ROUTINE      59000002
*                                                                       59200002
*                                  REG 0    RESULTANT TTR0              59600000
*                                  REG 1    DEB ADDRESS                 59800000
*                                  REG 2    ADDR OF MBBCCHHR            60000000
*                                  REG 3-8  NOT USED                    60200000
*                                  REG 9-13 VOLATILE-DESTROYED          60400000
*                                  REG 14   RETURN ADDRESS              60600000
*                                  REG 15   ENTRY POINT-BASE REGISTER   60800000
*                                                                       61000002
EDO01800 EQU   *                        GET TTR FROM DCBFDAD     Y02132 61212002
         L     R8,DXCCW7                SAVE MAIN UCB ADDR              61400000
         STM   RDCB,RD,DXCCW5           SAVE REGS                       61600000
         LR    R1,RDEB                  ADDR OF USER'S DEB TO PARM REG  61800000
         LA    RDCB,DCBFDAD             ADDR OF MBBCCHHR TO PARM REG    62000000
         L     RF,CVTPTR                PICK UP ADDRESS OF CONVERT RTN  62200000
         L     RF,CVTPRLTV              FROM THE CVT                    62400000
         BALR  RET,RF                   CONVERT MBBCCHHR TO TTR0        62600000
         LM    RDCB,RD,DXCCW5           RESTORE REGS                    62800000
         ST    R8,DXCCW7                RESTORE ADDR FOR NEXT LOAD      63000000
         ST    R0,DXCCW5                STORE LAST BLK TTR              63200000
         MVC   DSCLSTAR+K3(K2),DCBTRBAL  NUM OF BYTES ON TRACK REMAININ 63400000
EDO01900 EQU   *                        TRBAL, LAST VOL BIT UPDATED     63600002
         MVC   DSCLSTAR(K3),DXCCW5      MOVE IN LAST BLK PTR            63800000
         NI    DSCDSIND,ALLBITS-LASTNTRY  TURN OFF LAST VOL IND.        64000002
         OI    DXATDACC,DXATTRAK        LAST TRK USED AND TRK    Y02144 64050002
*                                       BALANCE FIELDS UPDATED   Y02144 64100002
         EJECT                                                          64102002
*                                                                       64104002
*        REWRITE DSCB                                                   64104402
*                                                                       64104802
         TM    UCBJBNR,UCBVRDEV         TEST FOR VIO UCB         Y02132 64105002
         BNO   EDO01950                 BR IF NOT                Y02132 64110002
*                                                                Y02132 64115002
         MODESET EXTKEY=SCHED           ASSUME SCHEDULER KEY     Y02132 64120002
*                                                                Y02132 64125002
*        WRITE VIO FORMAT ONE DSCB TO SWA                        Y02132 64130002
*                                                                Y02132 64135002
         MVC   VDSDSCB-VDSUCB+L'JFCBDSNM(DSCEXT2-DSCFMTID,RUCB),DXDSCB  64140002
*                                                                Y02132 64145002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02132 64150002
*                                                                Y02132 64155002
         B     EDO01975                 CONTINUE PROCESSING      Y02132 64160002
EDO01950 EQU   *                        BUILD CHANNEL PROGRAM           64165002
*                                                                       64200000
*        WRITE FORMAT 1 DSCB ONTO VTOC                                  64400002
*                                                                       64600000
         MVI   DXCCW3,CCWWRTDA          MOVE  WRITE OP CODE TO CCW      64800000
         MVI   DXCCW3+K4,CCWCMDCH       CHAIN COMMAND TO RDBACK CHECK   65000000
         MVC   DXCCW4(K24),DXCCW1       MOVE BASIC CCW'S RDBACK CHECK   65200000
         LA    R1,DXCCW4                                                65400000
         ST    R1,DXCCW5                ADDR FOR TIC                    65600000
         MVI   DXCCW5,CCWTIC                                            65800000
         MVI   DXCCW6,CCWRDDA           READ COMMAND                    66000000
         MVI   DXCCW6+K4,X10            SKIP FLAG ON- NO DATA           66200002
*                                       TRANSFER FOR RDBACK CHECK       66400002
         BAL   R7,EDO02400              BRANCH TO I/O ROUTINE           66600000
EDO01975 EQU   *                        SET AUDIT TRAIL          Y02132 66605002
         OI    DXATDACC,DXATUPDB        UPDATED DSCB WRITTEN     Y02144 66650002
*                                                                       66800000
*        WRITE COMPLETE HERE                                            67000000
*                                                                       67200000
         EJECT                                                          67250002
EDO02000 EQU   *                        DETERMINE EXIT MODULE           67400002
*                                                                Y02134 67450002
         LA    RET,K4                   LOAD BRANCH CODE         Y02134 67450402
         LA    R7,ID4N4P                GET NEW VOLUME           Y02134 67452002
*                                                                Y02134 67454002
         TM    JFCBLTYP,JFCSL+JFCBUL    TEST FOR USER LABELS     Y02134 67460002
         BNO   EDO02100                 BRANCH, BYPASS USER LBLS Y02134 67470002
*                                                                Y02134 67480002
         LA    R7,ID4N4Z                USER LABEL PROCESS       Y02134 67490002
*                                                                Y02134 67492002
EDO02100 EQU   *                        CHECK FOR SMF            Y02134 67494002
*                                                                Y02134 67496002
         TM    DXXPATHS,WTGSMF          IS SMF REQUIRED          Y02134 67500002
         BNO   EDO02200                 BRANCH TO BYPASS SMF     Y02134 67550002
*                                                                Y02134 67600002
         MVC   DXRETMOD,DXXIDTTR-DXXIDTTR(R7) SAVE RETURN LOAD   Y02134 67650002
         LA    R7,ID4N3B                SMF PROCESSING           Y02134 67700002
*                                                                Y02134 67750002
EDO02200 EQU   *                        GIVE NEXT MODULE CONTROL Y02134 67800002
*                                                                Y02134 67850002
         LA    RWTGC,DXXENTRY           SET R8 FOR RES RTN              69400000
         LA    RWTG,DXXAREA             POINT TO EOV WTG                69600000
         IECRES LOAD,MODID=(R7),BRCODE=(RET),BRANCH=QUEUED       Y02134 69850002
         EJECT                                                          69900002
*                                                                       70000000
*        I/O ROUTINE -READS AND WRITES FRMT 1 DSCB                      70200000
*                                                                       70400000
EDO02400 EQU   *                        EXCP, WAIT, TEST FOR I/O ERROR  70600002
         EXCP  DXIOB                    EXECUTE CHANNEL PROGRAM         70800000
         WAIT  ,ECB=DXECB               WAIT FOR COMPLETION             71000000
         TM    DXECB,ECBCOD7F           TEST COMPLETION CODE            71200000
         BOR   R7                       OK,RETURN                       71400002
EDO02425 EQU   *                        GET INTERNAL ABCODE      Y02132 71405002
         LA    R0,EABD190               ABEND 737                       71600000
EDO02450 EQU   *                        GIVE PROBLEM DETERMINATION      71800002
         LA    RWTGC,DXXENTRY           SET R8 FOR RES RTN              72000000
         LA    RWTG,DXXAREA             POINT TO EOV WTG                72200000
         DMABCOND (0),ID4N0P                                     Y02134 72400002
         EJECT                                                          72450002
*                                                                       75600000
*        CONSTANTS                                                      75800000
*                                                                       76000000
WFM016   DC    H'16'                    HALF WORD 16                    76200000
WFMCCWS  DC    X'3100000060000005'      SRCH EQUAL ID                   76400000
         DC    X'0800000000000000'      TIC                             76600000
         DC    X'8600000000000060'      READ DATA M/T                   76800000
WFMCCW1  DC    X'4000000508'            LAST 5 CHAR FOR SRCH ID EQ      77000000
WFMCCW2  DC    X'400000001D'            USED FOR WRITE FILE MARK        77200000
WFMCCW3  DC    X'20000008'              USED FOR WRITE FILE MARK        77400000
         EJECT                                                          77450002
*                                                                       77600000
*        XCTL  TABLE FOR IFG0554N                                       77800000
*                                                                       78000000
         XCTLTABL ID=(ID4N4P,4P,ID4N4Z,4Z,ID4N3B,3B,ID4N0P,0P),  Y02134X78400002
               SVC=055,BRT=YES,LENGTH=                           Y02080 78450002
         IECDSECS CVT,TCB,TIOT,SMF,DCB,DEB,UCB,MAIN,USERLAB,     Y02080X78600002
               WTG,PREFX,EXPAND=YES                              Y02080 78650002
         IECEQU                                                         78652002
         IDDVDSCB                                                Y02132 78655002
         END                                                            79000000
