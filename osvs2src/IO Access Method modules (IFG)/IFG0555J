         TITLE 'IFG0555J, ALIAS IFG0196P/EOV, OPEN - DA OUTPUT USER HEAX00100021
               DER LABELS'                                              00200021
         COPY  LCGASMSW                                                 00300000
IFG0555J CSECT                                                          00500021
         ENTRY IFG0196P                                          Y02080 00550002
IFG0196P EQU   IFG0555J                 ALLIAS ENTRY POINT       Y02080 00560002
*********************************************************************** 00610002
*                                                                     * 00660002
*                                                                     * 00710002
*          VS2 RELEASE 02 DELETIONS                                   * 00760002
*                                                                     * 00810002
*                                                                     * 00860002
*********************************************************************** 00910002
*                                                                     * 00960002
* MODULE NAME = IFG0555J (OS/VS2)                                     * 01010002
*                                                                     * 01060002
* DESCRIPTIVE NAME = EOV/OPEN DA OUTPUT USER HEADER LABELS            * 01110002
*                                                                     * 01160002
* COPYRIGHT = NONE                                                    * 01210002
*                                                                     * 01260002
* STATUS = RELEASE 2, LEVEL 0                                         * 01310002
*                                                                     * 01360002
* FUNCTION =                                                          * 01410002
*        THIS MODULE WRITES USER HEADER/TRAILER LABELS FOR OPEN-      * 01460002
*        EOV UNDER CONTROL OF THE CALLER'S OUTPUT USER HEADER/TRAILER * 01510002
*        LABEL ROUTINE, OR FORMATS THE USER LABEL TRACK IF NO USER    * 01560002
*        LABEL EXIT ROUTINE EXISTS AND THE DATA SET IS BEING PRO-     * 01610002
*        CESSED FOR OUTPUT AND LABEL = SUL.                           * 01660002
*        1) A 152 BYTE USER LABEL WORK AREA IS OBTAINED FOR EOV FROM  * 01710002
*        FETCH PROTECTED SUBPOOL 229 IN DATA MANAGEMENT KEY, AND      * 01760002
*        A 96 BYTE USER LABEL WORK AREA IS OBTAINED FOR THE CALLER    * 01810002
*        FROM FETCH PROTECTED SUBPOOL 229 IN THE CALLER'S KEY.        * 01860002
*        2) USER LABELS ARE PRESENTED TO END OF VOLUME AND WRITTEN    * 01910002
*        UNTIL 8 LABELS ARE WRITTEN OR THE CALLER INDICATES THROUGH   * 01960002
*        A RETURN CODE TO TERMINATE PROCESSING.                       * 02010002
*        3) THE CALLER RETURNS TO THIS MODULE (AFTER PROCESSING EACH  * 02060002
*        USER LABEL) WITH A RETURN CODE IN REGISTER 15:               * 02110002
*        0 - DO NOT WRITE LABEL BUT TERMINATE PROCESSING UL           * 02160002
*        4 - WRITE LABEL AND TERMINATE PROCESSING                     * 02210002
*        8 - WRITE LABEL AND CONTINUE PROCESSING                      * 02260002
*        4) IF NO USER LABEL TRACK WAS ALLOCATED, THE CALLER'S EXIT   * 02310002
*        ROUTINE IS ENTERED WITH THE BUFFER POINTER SET TO ZERO.      * 02360002
*        5) IF AN I/O ERROR OCCURS WHEN WRITING USER LABEL, THE       * 02410002
*        CALLER'S ROUTINE IS ENTERED AGAIN WITH BIT 0 OF THE          * 02460002
*        FLAG BYTE SET TO 1, AND A POINTER TO THE STATUS INFORMATION  * 02510002
*        IN THE WORK AREA IOB. ON RETURN, THE RETURN CODE IS IG-      * 02560002
*        NORED AND NORMAL PROCESSING RESUMES FOR EOV. HOWEVER, FOR    * 02610002
*        OPEN, THE DCBOFLGS BUSY BIT IS TURNED OFF TO TERMINATE       * 02660002
*        THE OPEN OF THE DCB. CONTROL IS PASSED TO THE END OF OPEN    * 02710002
*        TO FREE MAIN WORK AREAS AND TO RETURN TO THE CALLER OF OPEN  * 02760002
*        WITHOUT SETTING THE DCBOFLGS OPEN BIT.                       * 02810002
*                                                                     * 02860002
* NOTES = SEE BELOW                                                   * 02910002
*                                                                     * 02960002
*    DEPENDENCIES =                                                   * 03010002
*            CLASS ONE CHARACTER CODE.  THE EBCDIC CHARACTER CODE     * 03060002
*            WAS USED FOR ASSEMBLY.  THE MODULE MUST BE REASSEMBLED   * 03110002
*            IF A DIFFERENT CHARACTER SET IS USED FOR EXECUTION.      * 03160002
*                                                                     * 03210002
*    RESTRICTIONS = NONE                                              * 03260002
*                                                                     * 03310002
*    REGISTER CONVENTIONS =                                           * 03360002
*            R2 POINTS TO DCB                                         * 03410002
*            R4 POINTS TO OPEN WORK AREA                              * 03460002
*            R5 POINTS TO THE RESIDENT ROUTINE                        * 03510002
*            R6 POINTS TO THE WTG TABLE                               * 03560002
*            R7 POINTS TO THE CURRENT PARAMETER LIST ENTRY            * 03610002
*            R8 POINTS TO THE CURRENT WTG TABLE ENTRY                 * 03660002
*            R9 POINTS TO THE DD ENTRY IN THE TIOT                    * 03710002
*            R10 POINTS TO THE UCB                                    * 03760002
*                                                                     * 03810002
*    PATCH LABEL = SEE THIRD FROM LAST LABEL BEFORE ORG STATEMENT AT  * 03860002
*                  END OF LISTING.                                    * 03910002
*                                                                     * 03960002
* MODULE TYPE = CONTROL (OPEN, CLOSE, EOV DATA MANAGEMENT)            * 04010002
*                                                                     * 04060002
*    PROCESSOR = ASSEMBLER XF                                         * 04110002
*                                                                     * 04160002
*    MODULE SIZE = SEE EXTERNAL SYMBOL DICTIONARY OR LOC FIELD ON     * 04210002
*                  ORG STATEMENT AT END OF LISTING                    * 04260002
*                                                                     * 04310002
*    ATTRIBUTES = REENTRANT, REFRESHABLE,READ-ONLY, ENABLED,          * 04360002
*                 PRIVILEGED, SUPERVISOR STATE, DATA MANAGEMENT KEY,  * 04410002
*                 LINK PACK AREA RESIDENT/PAGEABLE                    * 04460002
*                                                                     * 04510002
* ENTRY POINT =                                                       * 04560002
*        IFG0555J                                                     * 04610002
*        IFG0196P - ALIAS                                             * 04660002
*                                                                     * 04710002
*    PURPOSE = SEE FUNCTION                                           * 04760002
*                                                                     * 04810002
*    LINKAGE =                                                        * 04860002
*        THIS MODULE IS TRANSFERRED CONTROL THROUGH THE IECRES-LOAD   * 04910002
*        MACRO INSTRUCTION.                                           * 04960002
*                                                                     * 05010002
* INPUT =                                                             * 05060002
*        GIVEN CONTROL IN PROTECT KEY 5.                              * 05110002
*        REGISTER 2 POINTS TO THE COPIED DCB.                         * 05160002
*        DEBDCBAD POINTS TO THE COPIED DCB.                           * 05210002
*        REGISTER 4 POINTS TO THE EOV WORKAREA                        * 05260002
*                                                                     * 05310002
* OUTPUT =                                                            * 05360002
*        THE NEXT MODULE IS GIVEN CONTROL IN PROTECT KEY 5 WITH       * 05410002
*        REGISTER 2 POINTING TO THE COPIED DCB,                       * 05460002
*        DEBDCBAD POINTING TO THE COPIED DCB,                         * 05510002
*        AND REGISTER 4 POINTING TO THE EOV WORKAREA,                 * 05560002
*                                                                     * 05610002
* EXIT-NORMAL =                                                       * 05660002
*        DXRETMOD - RETURN TO MODULE WHICH CALLED 555J                * 05710002
*                                                                     * 05760002
* EXIT-ERROR =                                                        * 05810002
*        IFG0198N - I/O ERROR PROCESSING USER LABELS                  * 05860002
*                                                                     * 05910002
* EXTERNAL REFERENCES = SEE BELOW                                     * 05960002
*                                                                     * 06010002
*    ROUTINES =                                                       * 06060002
*        IFG019RA THROUGH THE IECRES MACRO.                           * 06110002
*                                                                     * 06160002
*    DATA AREAS =                                                     * 06210002
*        EOV WORKAREA.                                                * 06260002
*                                                                     * 06310002
*    CONTROL BLOCK =                                                  * 06360002
*        CVT                                                          * 06410002
*        DEB                                                          * 06460002
*        PSA                                                          * 06510002
*        TCB                                                          * 06560002
*        RB                                                           * 06610002
*                                                                     * 06660002
* TABLES =                                                            * 06710002
*                                                                     * 06760002
* MACROS =                                                            * 06810002
*        MODESET                                                      * 06860002
*        IECRES LOAD                                                  * 06910002
*        IECRES GET                                                   * 06960002
*        IECRES INIT                                                  * 07010002
*        IECRES FREE                                                  * 07060002
*        IECRES UEXIT                                                 * 07110002
*        EXCP                                                         * 07160002
*        WAIT                                                         * 07210002
*        SETLOCK                                                      * 07260002
*                                                                     * 07310002
* CHANGE ACTIVITY =                                                   * 07360002
*        SEE CHANGES/DELETIONS SECTION JUST AFTER CSECT CARD.         * 07410002
*                                                                     * 07460002
*********************************************************************** 07510002
         EJECT                                                          07560002
         IECDSECS CVT,TCB,RB,DCB,       DEFINE DESIRED DSCTS TO BE     X21600021
               MAIN,DEB,USERLAB,RRPL,   EXPANDED AT THE END      Y02144X21700002
               USERTOT,WTG,PREFX,PSA                             Y02082 21750002
*                                                                       21900021
         IECEQU ,                       DEFINE EQUATES                  22000021
*                                                                       22100021
         USING IHADCB,RDCB              DEFINE BASE TO USER'S DCB       22200021
         USING FORCORE,RCORE            DEFINE BASE TO MAIN WORK AREA   22300021
         USING WTG,RWTG                 DEFINE BASE TO XCTL/WTG TABLE   22400021
         USING ULDMWK,RUCB              BASE FOR EOV UL W.A.     Y02082 22450002
*                                                                       22600021
         BALR  RBASE,0                  ESTABLISH BASE REGISTER         22700021
         USING *,RBASE                  DEFINE BASE REGISTER            22800021
*                                                                       22900021
*********************************************************************** 23000021
*                                                                       23100021
*    OBTAIN STORAGE FOR EOV'S USER LABEL WORK AREA AND THE       Y02082 23150002
*    USER'S USER LABEL WORK AREA                                 Y02082 23200002
*                                                                Y02082 23250002
         IECRES GET,LV=USERLDM,PREFIX=YES,STM=(2,14,WTGPREFX),   Y02082*23300002
               SP=K229,ID=ULWA                                   Y02144 23350002
*                                                                       23600021
         LR    RUCB,R1                  SET BASE FOR ULWK DSECT         23700021
*                                                                       23900021
         IECRES GET,LV=USERLU,PREFIX=NO,STM=(2,14,WTGPREFX),     Y02082*23950002
               SP=K229,KEY=USER                                  Y02082 23960002
         MODESET EXTKEY=DATAMGT         RESUME O/C/E KEY         Y02082 23962002
         USING ULUWK,R9                 BASE FOR USER'S UL W.A.  Y02082 23970002
         LR    R9,R1                    GOTTEN CORE ADDRESS      Y02082 23980002
         MVC   DXCCW11,DXCCW8           SAVE SAVED REGS 9-10 IN 0-1     24000021
*                                                                       24100021
         CLI   WTGMODNM+K5,C'9'         IS THIS OPEN (IFG0196P)         24200021
         BNE   ULHDR08A                 BR IF NO                        24300021
         MVC   DXVOLMT2(K5),DXCCW7      SAVE DSCB CCHHR ADDR     Y02134 24400002
*                                                                       24500021
ULHDR08A EQU   *                        NOT OPEN                        24600002
*                                                                       24700021
*        DETERMINE IF A USER LABEL EXTENT HAS BEEN ALLOCATED FOR THIS   24800021
*        DATA SET.                                                      24900021
*                                                                       25000021
         CLI   DSCEXTYP,ULEXT           IS 1ST EXTENT FOR USER LABELS   25100021
         BNE   ULNOEXT                  BR IF NO, GO TO USER            25200021
*                                                                       25300021
*********************************************************************** 25400021
*                                                                       25500021
*        EXTENT EXISTS - PROCESS USER LABELS                            25600021
*                                                                       25700021
         MVC   DXDAADDR+K3(K4),DSCLOWLM  CCHH FROM START OF 1ST EXTENT  25800021
         MVI   DXDAADDR+K7,K0           START SEARCH ID AT R0           25900021
*                                                                       26000021
*                                                                       26100021
*  SET UP CHANNEL PROGRAM TO WRITE A HEADER LABEL.                      26200021
*  EACH HEADER LABEL WRITTEN IS FOLLOWED BY TWO FILE MARKS -            26300021
*  UHL(N+1) AND UTL0.                                                   26400021
*                                                                       26500021
*        SEARCH ID EQ                                                   26600021
*        TIC *-8                                                        26700021
*        WRITE COUNT,KEY,DATA           ULWK1, UHLN,     LABEL          26800021
*        WRITE COUNT,KEY,(DATA)         ULWK5, UHL(N+1), FILE MARK      26900021
*        WRITE COUNT,KEY,(DATA)         ULWK2, UTL0,     FILE MARK      27000021
*        SEARCH ID EQ                                                   27100021
*        TIC *-8                                                        27200021
*        READ  COUNT,KEY,DATA           READ BACK UHLN CHECK            27300021
*                                                                       27400021
         XC    DXCCW1(K64),DXCCW1       CLEAR CCW AREA                  27500021
         LA    R1,DXDAADDR+K3                                           27600021
         ST    R1,DXCCW1                SEARCH ID FROM IOBDADAD+3       27700021
         LA    R1,DXCCW1                                                27800021
         ST    R1,DXCCW2                TIC TO CCW1                     27900021
         LA    R1,ULWK8                 WRITE C,K,DATA (UHL1)           28000021
         ST    R1,DXCCW3                FROM ULWK8                      28100021
         LA    R1,ULWK5                 WRITE C,K (UHL2)                28200021
         ST    R1,DXCCW4                FROM ULWK5                      28300021
*                                                                       28400021
         LA    R1,ULWK2                                                 28500021
         ST    R1,DXCCW5                WRITE FILE MARK FROM ULWK2      28600021
         OC    DXCCW1(K40),ULCP26P      OR IN CMND, FLAGS, LENGTH       28700021
*                                                                       28800021
         MVC   DXCCW6(K24),DXCCW1       APPEND WRITE CHECK TO CHNL PGM  28900021
         LA    R1,DXCCW6                                                29000021
         ST    R1,DXCCW7                TIC BACK TO CCW6                29100021
         MVI   DXCCW7,CCWTIC            RESTORE TIC OP                  29200021
         MVI   DXCCW8,ULHRDCKD          MAKE OP READ                    29300002
         MVI   DXCCW8+K4,ULHSKIPB       SET SKIP BIT ON, CHAIN OFF      29400002
*                                                                       29500021
*        STRUCTURE COUNT AND KEY FIELDS IN WORK AREA.                   29600021
*                                                                       29700021
         MVC   ULWK8,DXDAADDR+K3        CCHH TO COUNT FIELD IN WK AREA  29800021
         MVC   ULWK9(K8),UHLCON6P       RKDD, KEY TO WORK AREA FOR UHLN 29900021
*                                                                       30000021
         MVC   ULWK5(K12),ULWK8         CT, KEY FOR UHL(N+1)  FILE MARK 30100021
         MVC   ULWK2(K8),ULWK8          CT FOR UTLO  FILE MARK          30200021
         MVC   ULWK4,UTLCON6P           KEY FOR UTLO                    30300021
*                                                                       30400021
*        DETERMINE IF ACTIVE EXIT LIST ENTRY EXISTS.                    30500021
*                                                                       30600021
         LA    RC,0(RC)                 ZERO HIGH ORDER BYTE            30700021
         LTR   RC,RC                    CHECK FOR ACTIVE EXIT           30800021
         BZ    ULHDR17                  BR IF NO                        30900021
*                                                                       31000021
*********************************************************************** 31100021
*                                                                       31200021
*        COMPLETE STRUCTURING OF WORK AREA FOR WRITING HEADER LABEL     31300021
*                                                                       31400021
ULHDR09  EQU   *                        INITIALIZE WORK AREA            31500002
         MVI   ULWK9+K3,K80             DATA LENGTH=80 FOR LABEL        31600021
         SR    R1,R1                    CLEAR REG.                      31700021
         IC    R1,ULWK9                 PICK UP R FROM CT FIELD OF LBL  31800021
         LA    R1,K1(R1)                INCR R BY 1                     31900021
         STC   R1,ULWK6                 R+1  UHL(N+1)                   32000021
         LA    R1,K1(R1)                INCR R BY 1                     32100021
         STC   R1,ULWK3                 R+2  UTL0                       32200021
         IC    R1,ULWK10+K3             PICK UP N FROM LABEL KEY        32300021
         LA    R1,K1(R1)                INCR N BY 1                     32400021
         STC   R1,ULWK7+K3              N+1                             32500021
         CLI   ULWK10+K3,C'8'           CHECK NO. LABELS GT 8           32600021
         BH    ULHDROUT                 BR IF YES TO SET UP RETURN      32700021
*                                                                       32800021
         L     R1,ULWK10                PLACE UHLN IN REG        Y02082 32850002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 32900002
*                                                                Y02082 32950002
         ST    R1,ULBUFR                PRIME USER BUFFER UHLN   Y02082 32960002
*                                                                       33000021
*        SET UP AND EXECUTE SYNCHRONOUS EXIT TO USER'S ROUTINE FOR      33100021
*        LABEL CONSTRUCTION.                                            33200021
*                                                                       33300021
         BAL   RD,ULSYNC6P              GO EXIT TO USER'S ROUTINE       33400021
* RETURNS IN DATAMGT KEY                                         Y02082 33450002
         L     R1,ULWK10                GET UTLX/UHLX            YM1175 33500002
         MODESET KEYADDR=DXUKEY,WORKREG=12 ASSUME USER KEY       YM1175 33560002
         ST    R1,ULBUFR                PLACE IN USER'S BUFFER   YM1175 33570002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      YM1175 33580002
         LTR   RF,RF                    CHECK RETURN CODE FOR ZERO      33600021
         BZ    ULHDR13                  CODE=0, NO LABEL CREATED-BRANCH 33700021
         ST    RF,ULWK1                 SAVE RETURN CODE                33800021
         CLI   ULWK1+K3,K4              CHECK FOR RETURN CODE=4         33900021
         BE    ULHDR099                 RETURN CODE IS 4,CONTINUE       34000021
         CLI   ULWK1+K3,K8              CHECK FOR RETURN CODE=8         34100021
         BNE   ULHDR13                  RET CODE NOT 4,8-INVALID        34200021
*                                       RETURNED,NO FURTHER PROCESSING  34300021
ULHDR099 EQU   *                        RETURN CODE = 4                 34400002
         OI    DXCCW2+K4,X01            SET SWITCH INDIC NOT FIRST      34500021
*                                                                Y02082 34550002
*    COPY LABEL FROM USER BUFFER TO EOV BUFFER                   Y02082 34560002
*                                                                Y02082 34570002
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 34580002
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y20082 34590002
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 34592002
*    GET LOCAL LOCK                                              Y02082 34594002
         SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                  Y02082*34596002
               RELATED=('PREVENT FREE USER CORE-RELEASE BELOW')  Y02082 34598002
*                                                                Y02082 34598402
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 34598802
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 34599202
*    VERIFY USER STILL HOLDS USER LABEL WORK AREA CORE           Y02082 34599602
         OC    ULUWK(USERLU),ULUWK      PROGRAM CHECK IF NOT     Y02082 34599702
         MODESET EXTKEY=ZERO            ASSUME KEY ZERO          Y02082 34599802
         MVC   ULDMBUFR,ULBUFR          COPY LABEL FROM USER     Y02082 34599902
         L     RF,WTGPREFX              POINT TO PREFIX          Y02082 34633202
         STM   R0,RET,IECREGSV-IECPREFX(RF) SAVE REGS THRU LOCK  Y02082 34643202
*    RELEASE LOCAL LOCK                                          Y02082 34653202
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=('SEE ABOVE')        Y02082 34663202
         LM    R0,RET,IECREGSV-IECPREFX(RF) RESTORE REGS         Y02082 34665202
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 34665602
         BAL   RC,ULEXCP6P              GO WRITE LABEL                  34666702
*                                                                       34700021
         TM    DXECB,ECBNOERR           CHECK FOR I/O ERROR             34800021
         BZ    ULHDR10                  BR IF YES                       34900021
*                                                                       35000021
         CLI   ULWK1+K3,K4              CHECK RET CODE FOR MORE LABELS  35100021
         BE    ULHDROUT                 NO, PREV LABEL WAS LAST         35200021
*                                                                       35300021
         MVC   DXDAADDR+K7(K1),ULWK9    R OF LABEL JUST WRITTEN TO IOB  35400021
         MVC   ULWK8(K12),ULWK5         CT,KEY OF UHL(N+1) BECOMES CT,  35500021
*                                       KEY OF NEXT USER LABEL          35600021
         B     ULHDR09                  BR TO PROCESS NEXT LABEL        35700021
*                                                                       35800021
*********************************************************************** 35900021
*                                                                       36000021
*  I/O ERROR OCURRED WHILE WRITING USER LABELS.                         36100021
*                                                                       36200021
ULHDR10  EQU   *                        I/O ERROR WRITING LABEL         36300002
         LA    R1,DXIOB                 INSERT POINTER TO STATUS INFO   36400021
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 36450002
         ST    R1,ULERRPTR              IN PARAMETER LIST               36500021
         OI    ULERRPTR,ERROR           FLAG ERROR                      36600021
         BAL   RD,ULSYNC61              GO TO SYNCH TO USER             36700021
* RETURNS IN DATAMGT KEY                                         Y02082 36750002
*                                                                       36800021
ULHDR105 EQU   *                        RETURN FROM SYNCH               36900002
         CLI   WTGMODNM+K5,C'9'         IS THIS OPEN (IFG0196P)         37000021
         BNE   ULHDROUT                 BR IF NO                        37100002
*                                                                       37200021
         NI    DCBOFLGS,X'FF'-DCBOBUSY  TURN OFF DCBOFLGS BUSY BIT TO   37300021
*                                       STOP OPEN                       37400021
         B     ULHDROUT                 BR TO SET UP RETURN             37500021
*                                                                       37600021
*********************************************************************** 37700021
*                                                                       37800021
ULHDR13  EQU   *                        INVALID RETURN CODE             37900002
         TM    DXCCW2+K4,X01            IS IT FIRST TIME                38000021
         BO    ULHDROUT                 BR IF NO                        38100021
*                                                                       38200021
         MVI   ULWK6,K1                 R=1     UHL                     38300021
         MVI   ULWK7+K3,CHAR1           N=1     UHL                     38400002
*                                                                       38500021
*        IF THE USER REQUESTS, VIA THE RETURN CODE, THAT NO USER        38600021
*        HEADER LABELS BE WRITTEN OR                                    38700021
*        IF THE EXIT IS INACTIVE, BUT AN EXTENT HAS BEEN ALLOCATED FOR  38800021
*        USER LABELS, OPEN AND EOV MUST WRITE TWO FILE MARKS (UHL1      38900021
*        AND UTL0).                                                     39000021
*                                                                       39100021
ULHDR17  EQU   *                        WRITE 2 FILE MARKS              39200002
         MVI   ULWK3,K2                 R=2 FOR UTL0                    39300021
         MVC   DXCCW3(K16),DXCCW4       SET CP TO WRITE 2 FILEMARKS     39400021
         NI    DXCCW4+K4,X'FF'-CCWCMDCH  TURN OFF CC FLAG IN LAST CCW   39500021
*                                                                       39600021
         BAL   RC,ULEXCP6P              GO WRITE FILEMARKS              39700021
         TM    DXECB,ECBNOERR           CHECK FOR I/O ERROR             39800021
         BO    ULHDROUT                 BR IF NO ERROR                  39900021
*                                                                       40000021
         L     R1,DXREGC                OBTAIN DCB EXIT LIST ENTRY      40100021
         LA    R1,0(R1)                 ZERO CODE BYTE                  40200021
         LTR   R1,R1                    IS USER EXIT ACTIVE             40300021
         BNZ   ULHDR10                  BR IF YES TO GO TO EXIT RTN     40400021
         B     ULHDR105                 BR TO END LABEL PROCESSING      40500021
*                                                                       40600021
*********************************************************************** 40700021
*                                                                       40800021
*        NO USER LABEL TRACK WAS ALLOCATED.  EXIT TO USER'S ROUTINE     40900021
*        WITH POINTER TO LABEL BUFFER ZEROED.                           41000021
*                                                                       41100021
ULNOEXT  EQU   *                        EXIT TO USER'S ROUTINE          41200002
         MODESET KEYADDR=DXUKEY,WORKREG=15 ASSUME USER KEY       Y02082 41250002
         XC    ULERRPTR,ULERRPTR        CLEAR ANY ERROR INDICATOR       41300021
         SR    R1,R1                    BUFFER POINTER TO ZERO          41400021
         BAL   RD,ULSYNC62              GO SYNCH TO USER                41500021
* RETURNS IN DATAMGT KEY                                         Y02082 41550002
*                                                                       41600021
*********************************************************************** 41700021
*                                                                       41800021
ULHDROUT EQU   *                        SET RETURN FOR HEADER PROCESSNG 41900021
*                                                                       42100021
*        FREE  WORKAREA AND LABEL BUFFER AND XCTL TO I/O SUPPORT        42200021
*        MODULE WHICH CALLED THIS MODULE.                               42300021
*                                                                       42400021
         IECRES FREE,A=(R9),PREFIX=NO,SP=K229,LV=USERLU,         Y02082*42450002
               KEY=USER,STM=(2,14,WTGPREFX)                      Y02082 42500002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 42550002
         IECRES FREE,A=(RUCB),PREFIX=YES,STM=(2,14,WTGPREFX)     Y02082 42600002
*                                                                       42700021
         LM    RB,RET,DXREGB            RESTORE REGS 11-14              42800021
         LM    RTIOT,RUCB,DXREG0        RESTORE REGS 9-10 FROM 0-1      42900021
*                                                                       43000021
         CLI   WTGMODNM+K5,C'9'         IS THIS OPEN (IFG0196P)         43100021
         BNE   ULHDR08B                 BR IF NO                        43200021
         MVC   DXCCW7(K5),DXVOLMT2      RESTORE DSCB CCHHR       Y02134 43300002
         TM    DCBOFLGS,DCBOBUSY        IS DCB STILL BEING OPENED       43400021
         BO    ULHDR08B                 BR IF YES                       43500021
*                                                                       43600021
         IECRES LOAD,MODNM=LOAD8N6P,BRCODE=4,BRANCH=QUEUED       Y02080 43750002
*                                      XCTL TO OPEN FINAL STRING Y02080 43760002
*                                                                       43800021
ULHDR08B EQU   *                        RETURN TO CALLING MOD           43962002
         IECRES LOAD,MODID=DXRETMOD,BRCODE=(14),BRANCH=QUEUED    Y02134 43994802
*                                                                       44000021
*********************************************************************** 44100021
*                                                                       44200021
*        CLOSED SUBROUTINE TO ISSUE I/O OPERATIONS                      44300021
*                                                                       44400021
ULEXCP6P EQU   *                        I/O ROUTINE                     44500002
         EXCP  DXIOB                    WRITE USER HEADER LABEL         44600021
*                                                                       44700021
         WAIT  ECB=DXECB                WAIT FOR WRITE TO COMPLETE      44800021
*                                                                       44900021
         BR    RC                       RETURN FROM I/O SUBROUTINE      45000021
*                                                                       45100021
*********************************************************************** 45200021
*                                                                       45300021
*        CLOSED SUBROUTINE TO PASS CONTROL TO USER EXIT          Y02082 45400002
*        REGISTER CONTENTS ARE AS FOLLOWS-                       Y02082 45800002
*                        R0 - CONTAINS NO MEANINGFUL INFO               45900021
*                        R1 - PTR TO PARAMETER LIST                     46000021
*                    R2-R13 - USER'S CONTENTS BEFORE I/O SUPPORT        46100021
*                       R14 - RETURN ADDRESS (SET BY SYNCH)             46200021
*                       R15 - USER'S EXIT ROUTINE ADDRESS               46300021
*                                                                       46400021
ULSYNC6P EQU   *                        SYNCH ENTRY 1                   46500002
         XC    ULERRPTR,ULERRPTR        ZERO ERROR INDICATORS           46600021
ULSYNC61 EQU   *                        SYNCH ENTRY 2                   46700002
         LA    R1,ULBUFR                PTR TO LABEL BUFFER             46800021
ULSYNC62 EQU   *                        SYNCH ENTRY 3                   46900002
         ST    R1,ULPARM                PTR TO LABEL BUFFER      Y02082 46950002
         L     R1,DXUDCBAD              GET USER'S DCB ADDR      Y02082 47000002
         ST    R1,ULPARM+K4             PUT IN PARM LIST         Y02082 47050002
         XC    ULTOTPTR,ULTOTPTR        ZERO TOTALING AREA              47100021
         TM    DCBDSORG,DCBORGDA        CK FOR DIRECT ORGANIZATION      47200021
         BO    ULSYNCH3                 BR IF DIRECT                    47300021
         CLI   WTGMODNM+K5,C'9'         IS THIS OPEN (IFG0196P)         47400021
         BE    ULSYNCH3                 BR IF YES, SKIP USER TOTALING   47500021
         TM    DCBMACRF,DCBMEXCP        TEST IF EXCP                    47600021
         BO    ULSYNCH3                 BR IF YES, SKIP USER TOTALING   47700021
         TM    DCBOPTCD,DCBOPTT         TEST IF USER TOTALING           47800021
         BZ    ULSYNCH3                 HAS BEEN REQUESTED, BR IF NO    47900021
*                                                                       48000021
         L     RDEB,DCBDEBAD            GET ADDR OF USER'S DEB   Y01021 48100000
         SR    R1,R1                    CLEAR WORK REG                  48200021
         IC    R1,DEBNMEXT-DEB(,RDEB)   GET NUMBER OF EXTENTS           48300021
         SLL   R1,K4                    MULTIPLY BY 16                  48400021
         L     RDEB,K36(R1,RDEB)        GET ADDR TOTALING WORK AREA     48500021
*                                       DEB ADDR+32+4+LENGTH EXTENTS    48600021
         USING TOTSAVWA,RDEB            SET BASE - TOTALING AREA        48700021
         MVC   ULTOTPTR,TOTEOVPT        CURRENT IMAGE AREA ADDR TO      48800021
*                                       USER LBL PARM LIST              48900021
         DROP  RDEB                     DROP TOTALING AREA BASE         49000021
*                                                                       49100021
ULSYNCH3 EQU   *                        NO USER TOTALING                49200002
         MODESET EXTKEY=DATAMGT                                  Y02082 49202002
         NI    DCBOFLGS,X'FF'-DCBOLOCK  SET LOCK BIT = 0         Y02082 49210002
*                                                                Y02082 49250002
* COPY THE DCB FROM THE WORK AREA TO USER'S STORAGE              Y02082 49260002
*                                                                Y02082 49270002
         IECRES INIT,DCBCOPY=FRWKAR,STM=(3,14,WTGPREFX)          Y02082 49280002
*                                                                Y02082 49290002
         MODESET KEYADDR=DXUKEY,WORKREG=1  ASSUME USER'S KEY     Y02082 49292002
         LA    R1,ULPARM                POINT TO PARAMETER LIST         49300021
         MODESET EXTKEY=DATAMGT                                  Y02082 49350002
         IECRES UEXIT,EXITAD=DXREGC,STM=(2,13,WTGPREFX)          Y02082 49400002
         L     RDCB,DXUDCBAD            PT TO CALLER'S DCB       YM3005 49450002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME CALLER'S KEY    YM3005 49500002
         OI    DCBOFLGS,DCBOLOCK        INDICATE RETURN FR USER  Y02082 49550002
         LA    R0,ALLBITS-DCBOBUSY      ISOLATE BUSY BIT MASK    YM3005 49600002
         IC    R1,DCBOFLGS              GET CALLER'S OFLGS       YM3005 49650002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      YM3005 49700002
         L     RDCB,DXPDCBAD            PT TO COPIED DCB         YM3005 49750002
         OR    R0,R1                    ISOLATE CALLER BUSY BIT  YM3005 49800002
         IC    R1,DCBOFLGS              GET COPIED DCBOFLGS      YM3005 49850002
         NR    R1,R0                    UPDTE BUSY BIT TO CALLER YM3005 49900002
         STC   R1,DCBOFLGS              UPDATE OFLGS FIELD       YM3005 49950002
         L     RDEB,DCBDEBAD            GET ADDR OF USER'S DEB   Y01021 51530002
         OI    DCBOFLGS,DCBOLOCK        SET LOCK BIT = 1                51600021
         L     R0,ULWK10                PLACE UHLN IN REG        Y02082 51650002
         MODESET KEYADDR=DXUKEY,WORKREG=1 ASSUME USER KEY        Y02082 51700002
*                                                                Y02082 51750002
         ST    R0,ULBUFR                REPLACE UHLN IN USER BUFFY02082 51760002
         MODESET EXTKEY=DATAMGT         DATA MANAGEMENT KEY      Y02082 51770002
         BR    RD                       RETURN FROM SYNCH EXIT SUBR     51800021
         EJECT                                                          51900002
*********************************************************************** 52200021
*                                                                       52300021
*        CONSTANTS                                                      52400021
*                                                                       52500021
UHLCON6P DC    0F'0',X'01040000'        RKDD - R0, COUNT, KEY FOR UHL   52600021
         DC    C'UHL1'                  KEY                             52700021
UTLCON6P DC    C'UTL0'                  KEY FOR SEARCH ARGUMENT         52800021
*                                                                       52900021
*  CCW'S TO WRITE USER HEADER LABELS FOLLOWED BY UHL(N+1) UTL0 FILE MKS 53000021
ULCP26P  DC    X'3100000040000005'      SEARCH ID EQ                    53100021
         DC    X'0800000000000000'      TIC *-8                         53200021
         DC    X'1D0000004000005C'      WRITE CKD    UHLN     LABEL     53300021
         DC    X'1D0000004000000C'      WRITE CKD    UHL(N+1) FILE MARK 53400021
         DC    X'1D0000004000000C'      WRITE CKD    UTL0     FILE MARK 53500021
*                                                                       53510002
ULHRDCKD EQU   X'1E'                    READ COUNT, KEY, AND DATA       53550002
ULHSKIPB EQU   X'10'                    SET SKIP BIT ON                 53560002
*                                                                       53600021
         XCTLTABL ID=(LOAD8N6P,IFG0198N),                        Y02080X53700002
               BRT=YES,LENGTH=                                   Y02080 53750002
*                                                                       53800021
         IECDSECS EXPAND=YES            EXPAND DESIRED DSECTS HERE      53900021
*                                                                       54000021
         END                                                            54100021
