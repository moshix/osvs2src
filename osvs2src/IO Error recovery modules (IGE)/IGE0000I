        TITLE 'IGE0000I     LOAD 1     1/2 INCH MAGNETIC TAPE ERPS'     00050003
IGE0000I START X'00'                   LOAD 1                           00100003
*                                                                       00150003
*********************************************************************** 00200003
*                                                                     * 00250003
* STATUS:                                                             * 00300003
*    CHANGE LEVEL:  VS2/REL3                                          * 00350003
*                                                                     * 00400003
* FUNCTION/OPERATION:                                                 * 00450003
*    THIS LOAD IS ENTERED EACH TIME ERP'S ARE CALLED                  * 00500003
*    1.  XCTL TO LOAD 2, PART 9, IF ICC/CCC CHANNEL ERROR             * 00550003
*    2.  GO TO PART 5 TO DO STAT UPDATE IF FIRST ENTRY FOR AN ERROR   * 00600003
*    3.  GO TO PART 3 IF ROR IN PROGRESS                              * 00650003
*    4.  XCTL TO LOAD 2, PART 1, IF:                                  * 00700003
*        A.  ERROR ON REPOSITIONING                                   * 00750003
*        B.  IOB INTERCEPT                                            * 00800003
*        C.  UNSOLICITED DEVICE END FROM A NEW DEVICE TYPE            * 00850003
*        D.  NOISE BLOCK FOUND ON READ (<12 BYTES)                    * 00900003
*    5.  SET CCW START ADDRESS DEPENDING ON CCW CHAINING FLAGS        * 00950003
*    6.  SET REPOSITIONING COMMAND OP CODE FOR READ/WRITE ERRORS      * 01000003
*    7.  HANDLE FIRST 40 READ RETRIES WITH REPOSITIONING AND          * 01050003
*        CLEANER ACTIONS.  GO TO PART 3 IF ROR NEEDED.                * 01100003
*    8.  HANDLE WRITE-TYPE RETRIES WITH REPOSITIONING,                * 01150003
*        XCTL TO WTO IF A PERMANENT ERROR.                            * 01200003
*    9.  XCTL TO LOAD 2, PART 4, IF ERROR OTHER THAN DATA CHECK       * 01250003
*        ON READ OR WRITE TYPE COMMANDS.                              * 01300003
*    10. GO TO PART 4 IF NO ERROR IS APPARENT OR ERROR IS RECOVERED   * 01350003
*    11. IF IDAL BIT IS ON IN ERROR CCW, GO TO PART 6 TO CREATE       * 01400003
*        ERP IDAL LIST FOR ROR.                                       * 01450003
* ENTRY POINTS:                                                       * 01500003
*         ER2401A - CALLED BY I/O SUPERVISOR                          * 01550003
*         IGE0100I LOAD 2                                             * 01600003
*                                                                     * 01650003
* INPUT:                                                              * 01700003
*    REGISTER 1 CONTAINS A POINTER TO THE IOSB                        * 01750003
*                                                                     * 01800003
* OUTPUT:  N/A                                                        * 01850003
*                                                                     * 01900003
* EXTERNAL ROUTINES:                                                  * 01950003
*         INTERPRETER ROUTINE - CHECKS SENSE AND STATUS BYTES         * 02000003
*                                                                     * 02050003
* EXITS - NORMAL:                                                     * 02100003
*         1.  SVC 15/3 EXIT TO IOS TO REPOSITION TAPE & REEXECUTE     * 02150003
*         2.  XCTL TO IGE0100I (LOAD 2)                               * 02200003
*         3.  XCTL TO IGE0025C (WTO ROUTINE)                          * 02250003
*         4.  XCTL TO IGE0025F (OBR ROUTINE)                          * 02300003
*                                                                     * 02350003
* EXITS - ERROR:  N/A                                                 * 02400003
*                                                                     * 02450003
* ATTRIBUTES:                                                         * 02500003
*    REENTRANT                                                        * 02550003
*                                                                     * 02600003
* NOTES:                                                              * 02650003
*    VS2/REL2 - LOADS 1, 3, 4 AND 5 OF PREVIOUS RELEASES HAVE BEEN    * 02700003
*    COMBINED TO CREATE LOAD 1 OF THIS RELEASE.  PART 6 WAS ADDED     * 02750003
*    IN ORDER TO CREATE AN ERP IDAL LIST FOR ROR.                     * 02800003
*    THIS LOAD INCLUDES:                                              * 02850003
*        1.  ERROR HANDLING FOR OTHER THAN ERP-ORIGINATED ERRORS      * 02900003
*        2.  READ OPPOSITE RECOVERY                                   * 02950003
*        3.  STATISTICS UPDATE                                        * 03000003
*                                                                     * 03050003
*    PTM YM6412  REPOSITION BIT NOT TURNED OFF ON PERM ERR EXIT       * 03100003
*                                                                     * 03150003
*    PTM 7116 SENSE DATA OVERLAYS I/O COMMAND DURING RECOVERY         * 03200003
*                                                                     * 03250003
*    CODE CHANGES FOR 16 BIT UCB ADDRESSING                  @Z30AB01 * 03300003
*                                                                     * 03350003
*    APAR FIX TO ZERO & THES BOTH BYTES ON WLI               @ZA00656 * 03360003
*    CHANGE TO NOT OVERLAY FIRST 4 BYTES PAST EWA            @ZA05117 * 03362003
*    MOVE TIE BYTE TO IOSB                                   @ZA08849 * 03364003
*    SET UP IOSB FOR 7 TRACK PARITY SWITCH                   @ZA05130 * 03368003
*    GET FAILING CCW ADDR INSTEAD OF FIRST CCW ADDR.         @ZA08853 * 03368403
*    APAR OZ08856 MOVE CORRECT BYTES FOR BLKCNT TO EWA       @ZA08856 * 03368803
*    REMOVE FIX FOR OX08853 TO PREVENT BAD IDAL              @ZA14734 * 03370003
*    FIX FOR LOW CORE OVERLAY PROBLEM                        @ZA14748 * 03380003
*    FIX FOR E00-0C4 ABEND PROBLEM                           @ZA14752 * 03385037
*    PREVENT OVERLAYING SQA FOR CCW COUNT > X'7FFF'          @ZA17538 * 03387037
*    PREVENT LOSING BLOCKS WITH CHAIN SCHEDULING & DDR       @ZA16828 * 03388037
*    ZERO SDR OVERFLOW COUNTER (A244000)                     @ZA27822 * 03388437
*    SDR RECORD FOR DATA CHAINING (A752040-752050            @ZA30317 * 03388837
*    LOADPOINT ON PE REPOSITIONING (A269000-269500)          @ZA30781 * 03389237
*    TURN ON EWADDMSG FOR WTO                                @ZA31011 * 03390037
*    DELETE OZ30781 CODE                                     @ZA32492 * 03395037
*********************************************************************** 03400003
*                                                                       03450003
         EJECT                                                          03500003
*                                                                       03550003
*           R E G I S T E R   A S S I G N M E N T S                     03600003
*                                                                       03650003
R0       EQU   0                       WORK REG                         03700003
IOSREG   EQU   1                       IOSB ADDRESS                     03750003
R1       EQU   1                       WORK REG                         03800003
ERPREG   EQU   2                       ERP IDAL ADDRESS                 03850003
UXREG    EQU   2                       UCB EXTENSION ADDRESS            03900003
R3       EQU   3                       WORK REG                         03950003
CCWREG   EQU   3                       CCW ADDRESS                      04000003
R4       EQU   4                       WORK REG                         04050003
R5       EQU   5                       WORK REG                         04100003
EXITREG  EQU   5                       EXIT REG - SVC 15/3              04150003
SDRREG   EQU   6                       SDR TABLE ADDRESS                04200003
UCBREG   EQU   7                       UCB ADDRESS                      04250003
R8       EQU   8                       WORK REG (STAT UPDATE)           04300003
BALREG   EQU   8                       BALR RETURN REG                  04350003
R9       EQU   9                       WORK REG                         04400003
SAVREG   EQU   9                       SAVE REG                         04450003
EWAREG   EQU   10                      EXTENDED WORK AREA ADDR          04500003
RETREG   EQU   11                      BALR RETURN REG                  04550003
USEREG   EQU   11                      USER IDAL ADDR                   04600003
R12      EQU   12                      WORK REGISTER                    04650003
R13      EQU   13                      WORK REG                         04700003
TABREG   EQU   13                      SDR TABLE ADDRESS                04750003
LNKREG   EQU   14                      LINK REG                         04800003
XCTLREG  EQU   14                      XCTL ROUTINE ADDRESS             04850003
SDRR14   EQU   14                      WORK REG FOR SDR ADDRESS         04900003
BASREG   EQU   15                      BASE REG                         04950003
         EJECT                                                          05000003
*                                                                       05050003
*                U S E R   C C W   D S E C T                            05100003
*                                                                       05150003
CCW      DSECT                         ERROR CCW IN USER'S CHAIN        05200003
CCWOP    DS    CL1                     CCW COMMAND CODE                 05250003
         ORG   CCWOP                   **                               05300003
CCWADR   DS    CL4                     CCW DATA ADDRESS                 05350003
CCWFLS   DS    CL2                     CCW FLAGS                        05400003
CCWCNT   DS    CL2                     CCW BYTE COUNT                   05450003
*                                                                       05500003
*   CCW REFERENCES                                                      05550003
*                                                                       05600003
CCWIDAL  EQU   X'04'                   IDAL LIST BEING USED             05650003
CCWSILI  EQU   X'20'                   SUPPRESS INCORRECT LENGTH BIT    05700003
*                                                                       05750003
*                U S E R   I D A L   D S E C T                          05800003
*                                                                       05850003
USERIDAL DSECT                         USER IDAL LIST                   05900003
UIDAL    DS    9F                      IDAL ENTRIES                     05950003
*                                                                       06000003
*                 E R P   I D A L   D S E C T                           06050003
*                                                                       06100003
ERPIDAL  DSECT                         ERP IDAL LIST                    06150003
EIDAL    DS    9F                      IDAL ENTRIES                     06200003
         EJECT                                                          06250003
IGE0000I CSECT                                                          06300003
*                                                                       06400003
*                 E   Q   U   A   T   E   S                             06450003
*                                                                       06500003
*   EWACNTR1 - ERROR COUNT 1 REFERENCES                                 06550003
*                                                                       06600003
CLNCNT0  EQU   X'07'                   CLEANER CONTROL COUNT ZERO       06650003
CLNCNT3  EQU   X'03'                   NO. BSRS FOR RB CLEANER          06700003
CLNCNT4  EQU   X'04'                   NO. BSRS FOR RF CLEANER          06750003
OVRCNT5  EQU   X'50'                   OVERRUN COUNT MAXIMUM VALUE      06800003
HEXF8    EQU   X'F8'                   SET CLEANER COUNT TO 0           06850003
HEX88    EQU   X'88'                   SET CLEANER & BUS OUT TO 0       06900003
*                                                                       06950003
*   EWACNTR2 - ERROR COUNT 2 REFERENCES                                 07000003
*                                                                       07050003
X1       EQU   X'01'                   ONE READ ERROR                   07100003
X4       EQU   X'04'                   MULTIPLE OF 4                    07150003
ERGCNT   EQU   X'70'                   ERASE GAP COUNT                  07200003
NUMB15   EQU   X'0F'                   15 RETRIES                       07250003
NUMB40   EQU   X'94'                   40 RETRIES                       07300003
*                                                                       07350003
*   EWACNTR3 - ERROR COUNT 3 REFERENCES (FLAG BITS)                     07400003
*                                                                       07450003
EWTUEX   EQU   X'80'                   UNIT EXCEPTION FLAG              07500003
EWTNB    EQU   X'40'                   NOISE BIT                        07550003
EWTRST   EQU   X'20'                   START FLAG                       07600003
EWTROC   EQU   X'10'                   USE ROR CCW                      07650003
EWTBIT   EQU   X'08'                   COUNTER INCREMENT BIT            07700003
EWTLWR   EQU   X'04'                   LOOP WRITE TO READ FLAG          07750003
EWTEXIT  EQU   X'02'                   TEMPORARY ERROR EXIT FLAG        07800003
EWTDEP   EQU   X'01'                   DEVICE END POST BIT              07850003
*                                                                       07900003
*   EWAFLG3 - FLAG 3 REFERENCES                                         07950003
*                                                                       08000003
EWTROR   EQU   X'80'                   READ OPPOSITE IN PROGRESS        08050003
EWTRTN2  EQU   X'40'                   RETURN FROM LOAD 2               08100003
EWTTPC   EQU   X'20'                   TAPE CLEANING BIT                08150003
EWTBKS   EQU   X'10'                   BACKSPACE ERASE CLEANING FLAG    08200003
EWTOVER  EQU   X'08'                   SDR OVERFLOW                     08250003
EWTPT4A  EQU   X'04'                   ENTRY FOR LOAD 2, PART 4A        08300003
EWTPT4B  EQU   X'02'                   ENTRY FOR LOAD 2, PART 4B        08350003
EWTRBLD  EQU   X'01'                   REBUILD IDAL LIST                08400003
*                                                                       08450003
*   EWA SENSE REFERENCES                                                08500003
*                                                                       08550003
BIRCH    EQU   X'08'                   BYTE 6 & 9 BIRCH TEST   @YL02128 08600003
INVAL    EQU   X'03'                   INVALID CODE                     08650003
NRZIMODE EQU   X'10'                   BYTE 6 NRZI TEST BIT    @YL02128 08700003
SNSTST   EQU   X'F4'                   TEST FOR:  CR,IR,BO,EQ,OR        08750003
TIE      EQU   X'FF'                   TEST FOR TIE BYTE NOT ZERO       08800003
*                                                                       08850003
*   DEB REFERENCES                                                      08900003
*                                                                       08950003
DEBDCB   EQU   24                      DCB POINTER                      09000003
DEBEMU   EQU   4                       EMULATOR BIT                     09050003
DEBMOD   EQU   32                      MODE SET MODIFIER                09100003
DEBOFL   EQU   8                       DEBOFLGS                         09150003
DEBPAR   EQU   16                      PARITY FLIP MASK                 09200003
DEBRER   EQU   X'01'                   REDUCED ERROR RECOVERY BIT       09250003
*                                                                       09300003
*   DCB REFERENCES                                                      09350003
*                                                                       09400003
DCBMOD   EQU   16                      RECORDING TECHNIQUE              09450003
DCBDCF   EQU   X'13'                   DATA CONVERTER FEATURE           09500003
*                                                                       09550003
*   ROR CCW REFERENCES                                                  09600003
*                                                                       09650003
RORSDT   EQU   X'10'                   SUPPRESS DATA TRANSFER BIT       09700003
RORSDT1  EQU   X'14'                   SDT AND IDAL BITS                09750003
RORSILI  EQU   X'20'                   SUPPRESS INCORRECT LENGTH BIT    09800003
ROR0F    EQU   X'0F'                   TURN OFF FLAG BITS               09850003
*                                                                       09900003
*   COMMANDS                                                            09950003
*                                                                       10000003
CMDERG   EQU   X'17'                   ERASE GAP                        10050003
CMDBSR   EQU   X'27'                   BACK SPACE RECORD                10100003
CMDFSR   EQU   X'37'                   FORWARD SPACE RECORD             10150003
CMDRDB   EQU   X'0C'                   READ BACKWARDS                   10200003
CMDSNS   EQU   X'04'                   SENSE COMMAND           @YM07116 10250003
CMDWRT   EQU   X'01'                   WRITE                            10300003
CMDCTL   EQU   X'03'                   CONTROL                          10350003
CMDREW   EQU   X'07'                   REWIND                           10400003
CMDWTM   EQU   X'1F'                   WRITE TAPE MARK                  10450003
CMDRED   EQU   X'02'                   READ                             10500003
CMDTIC   EQU   X'08'                   TIC                              10550003
CMDLWR   EQU   X'8B'                   LOOP WRITE TO READ               10600003
CMDRDF   EQU   X'02'                   READ FORWARD                     10650003
*                                                                       10700003
*   STATUS INDICATORS                                                   10750003
*                                                                       10800003
CSWUCK   EQU   X'02'                   UNIT CHECK                       10850003
CSWCCC   EQU   X'04'                   CHANNEL CONTROL CHECK            10900003
CSWICC   EQU   X'02'                   INTERFACE CONTROL CHECK          10950003
CSWCDC   EQU   X'08'                   CHANNEL DATA CHECK               11000003
CSWCUB   EQU   X'50'                   CU BUSY                          11050003
CSWICL   EQU   X'40'                   INCORRECT LENGTH                 11100003
CSWDVE   EQU   X'04'                   DEVICE END                       11150003
CSWUEX   EQU   X'01'                   UNIT EXCEPTION                   11200003
CSWSTB   EQU   X'39'                   CDC, CHC, PGC, PTC               11250003
         EJECT                                                          11300003
*                                                                       11350003
*   MISCELLANEOUS REFERENCES                                            11400003
*                                                                       11450003
BLKCNT   EQU   12                      BLK COUNT OFFSET FROM DCB        11500003
CDCNT    EQU   7                       CHANNEL DATA CHECK               11550003
CDFULL   EQU   X'0F'                   CHANNEL DATA COUNT FULL          11600003
CHDAT    EQU   X'08'                   CHANNEL DATA CHECK               11650003
CHEND    EQU   X'08'                   CHANNEL END                      11700003
CNTEND   EQU   X'FF'                   END OF COUNTER FLAG              11750003
CNT0     EQU   X'F0'                   RESET CLEANER COUNT TO 0         11800003
CTROK    EQU   X'80'                   FAKE COUNTER INDICATOR           11850003
CVTPTRV  EQU   288                     CVT OFFSET FOR TRANSLATE RTN     11900003
C1       EQU   1                       COUNT OF 1                       11950003
C2       EQU   2                       COUNT OF 2                       12000003
C3       EQU   3                       COUNT OF 3              @Z30AB01 12050003
C4       EQU   4                       COUNT OF 4                       12100003
C5       EQU   5                       COUNT OF 5                       12150003
C6       EQU   6                       COUNT OF 6                       12200003
C7       EQU   7                       COUNT OF 7              @YM07116 12250003
C8       EQU   8                       COUNT OF 8                       12300003
C11      EQU   11                      COUNT OF 11             @YM07116 12350003
C13      EQU   13                      COUNT OF 13                      12400003
C16      EQU   16                      COUNT OF 16                      12450003
C20      EQU   20                      COUNT OF 20                      12500003
C36      EQU   36                      COUNT OF 36                      12550003
C56      EQU   56                      COUNT OF 56                      12600003
C68      EQU   68                      COUNT OF 68                      12650003
C104     EQU   104                     COUNT OF 104                     12700003
C256     EQU   256                     COUNT OF 256                     12750003
C512     EQU   512                     COUNT OF 512                     12800003
ELEVEN   EQU   11                      COUNT OF 11                      12850003
EXCPER   EQU   15                      ERROR EXCP                       12900003
FULL     EQU   X'FF'                   FULL COUNT                       12950003
HEX24    EQU   X'18'                   COUNT OF 24                      13000003
HIBIT    EQU   128                     SET HI-ORDER BIT IN A BYTE       13050003
IOSREP   EQU   X'10'                   REPOSITION TAPE FLAG             13100003
IOSCRC   EQU   X'08'                   CRC FLAG                         13150003
LOAD2    EQU   1009                    LOAD 2 ADDRESS                   13200003
LOC16    EQU   16                      COMMUNICATION TABLE ADDRESS      13250003
ON       EQU   X'80'                   SET HI-ORDER BIT ON              13300003
PARON    EQU   X'01'                   TIE COUNTER PARITY BIT           13350003
RDFULL   EQU   X'F0'                   READ COUNT FULL                  13400003
RETURN   EQU   3                       RETURN - SVC 3                   13450003
ROR      EQU   7                       ROR OFFSET                       13500003
SDRPI    EQU   8                       PE ID BURST SDR COUNT            13550003
SDR20    EQU   X'01'                   20-BYTE SDR FLAG                 13600003
SERLOG   EQU   256                     ADDRESS OF OBR                   13650003
SNSCT    EQU   4                       COUNT OF SENSE BYTES             13700003
STATAB   EQU   112                     STATISTICS TABLE ADDRESS         13750003
STI      EQU   1                       STAT TABLE INDEX                 13800003
VECTXL   EQU   44                      VECTOR TO XCTL ROUTINE           13850003
WORD     EQU   32                      NUMBER OF BITS IN WORD           13900003
WRFULL   EQU   X'0F'                   WRITE COUNT FULL                 13950003
WTORTN   EQU   253                     LOAD NAME TO WTO ROUTINE         14000003
ZERO     EQU   X'00'                   ZERO                             14050003
*                                                                       14100003
*                                                                       14150003
         EJECT                                                          14200003
         USING *,BASREG                                                 14250003
ERP1     B     ER2401A                 BRANCH AROUND DECLARES           14300003
         DC    C'** IGE0000I-TAPE ERP 08-21-74 **'    **                14350003
*                                                                       14400003
*********************************************************************** 14450003
*                        C O N S T A N T S                            * 14500003
*********************************************************************** 14550003
*                                                                       14600003
         DS    0F                      ALIGN                            14650003
MASK     DC    X'0000FFFF'             COMPARE MASK                     14700003
MASK1    DC    X'0000001F'             SDR COUNTER LENGTH MASK          14750003
MASK2    DC    X'0000003F'             SENSE BYTE NUMBER MASK           14800003
SDRCON   DC    X'00000239'             MASK TO CHECK STATUS BITS        14850003
ONE      DC    X'00000001'             COUNT OF 1                       14900003
FOUR     DC    X'00000004'             COUNT OF 4                       14950003
FZERO    DC    X'00000000'             COUNT OF 0                       15000003
F2047    DC    X'000007FF'             COUNT OF 2047                    15050003
ONEPAGE  DC    X'00000800'             COUNT OF 2048                    15100003
EIGHT    DC    AL2(8)                  HALFWORD OF 8                    15150003
TEN      DC    AL2(10)                 HALFWORD OF 10                   15200003
TWELVE   DC    AL2(12)                 HALFWORD OF 12                   15250003
H512     DC    H'512'                  HALFWORD OF 512                  15300003
         EJECT                                                          15350003
*                                                                       15400003
*   STAT UPDATE TABLE                                                   15450003
*                                                                       15500003
         DS    0F                      ALIGN                            15550003
TAB2400  EQU   *                                                        15600003
         DC    X'0480'                 TEMP READS                       15650003
         DC    X'0480'                 TEMP WRITES                      15700003
         DC    X'2400'                 INTERVENTION REQUIRED            15750003
         DC    X'4400'                 BUS OUT                          15800003
         DC    X'6400'                 EQUIPMENT CHECK                  15850003
         DC    X'A400'                 OVERRUN                          15900003
         DC    X'C400'                 WORD COUNT ZERO                  15950003
         DC    X'E400'                 DATA CONVERTER CHECK             16000003
         DC    X'0403'                 R/W VRC                          16050003
         DC    X'2403'                 LRCR                             16100003
         DC    X'4403'                 SKEW                             16150003
         DC    X'6403'                 CRC                              16200003
         DC    X'8403'                 SKEW REG VRC                     16250003
         DC    X'0401'                 NOISE                            16300003
         DC    X'0480'                 ROR                              16350003
         DC    X'0480'                 CHANNEL DATA CHECK               16400003
         DC    X'00FF'                 END                              16450003
*                                                                       16500003
TAB3420  EQU   *                                                        16550003
         DC    X'0880'                 SDR COUNTER FLAG BYTE            16600003
         DC    X'0801'                 NOISE                            16650003
         DC    X'0803'                 R/W VRC                          16700003
         DC    X'2803'                 MTE/LRCR                         16750003
         DC    X'6803'                 EDC/CRC                          16800003
         DC    X'8803'                 ENV CK/VRC                       16850003
         DC    X'A400'                 OVERRUN                          16900003
         DC    X'4403'                 SKEW                             16950003
         DC    X'E403'                 C COMPARE                        17000003
         DC    X'6404'                 WRT TRIG VRC                     17050003
         DC    X'1080'                 PE ID BURST / TIE MASK           17100003
         DC    X'4405'                 WTM CK                           17150003
         DC    X'8405'                 START RD CK                      17200003
         DC    X'A405'                 PARTIAL REC                      17250003
         DC    X'C405'                 EXCESS POSTAMBLE                 17300003
         DC    X'0408'                 IBG DROP IN WRT                  17350003
         DC    X'2408'                 FEED THRU CK                     17400003
         DC    X'4408'                 SPARE                            17450003
         DC    X'6408'                 EARLY BEGIN RD CK                17500003
         DC    X'8408'                 EARLY END RD CK                  17550003
         DC    X'A408'                 SLOW BEGIN RD CK                 17600003
         DC    X'C408'                 SLOW END RD CK                   17650003
         DC    X'E408'                 VELOCITY RETRY                   17700003
         DC    X'0409'                 SPARE                            17750003
         DC    X'2409'                 VELOCITY CHANGE DURING WR        17800003
         DC    X'4409'                 SPARE                            17850003
         DC    X'6409'                 SPARE                            17900003
         DC    X'C803'                 BACKWARD                         17950003
         DC    X'4400'                 BUS OUT CHECK                    18000003
         DC    X'0404'                 ALU HARDWARE ERROR               18050003
         DC    X'00FF'                 END                              18100003
         DS    0F                      ALIGN                            18150003
         EJECT                                                          18200003
*********************************************************************** 18250003
*                          P A R T   1                                * 18300003
*********************************************************************** 18350003
*                                                                     * 18400003
*    THIS IS ENTRY TO THE 2400/3400 SERIES MAG TAPE ERROR ROUTINE     * 18450003
*                                                                     * 18500003
*********************************************************************** 18550003
*                                                                     * 18600003
*    WHEN ENTERED, THE IOSEX AND THE IOSERR FLAGS WILL BE SET TO 1    * 18650003
*    BY THE ERROR ROUTINE.                                            * 18700003
*                                                                     * 18750003
*    ON RETURN, THESE TWO FLAGS SHOULD BE INTERPRETED AS FOLLOWS:     * 18800003
*        IOSEX ON AND IOSERR ON  - ERP IN CONTROL                     * 18850003
*        IOSEX ON AND IOSERR OFF - PERMANENT ERROR                    * 18900003
*        IOSEX OFF AND IOSERR OFF - ERROR CORRECTED                   * 18950003
*                                                                     * 19000003
*********************************************************************** 19050003
*                                                                       19100003
         USING IOSB,IOSREG                                       Y02032 19150003
         USING UCB,UCBREG                                               19200003
         USING EWA,EWAREG                                        Y02032 19250003
         USING CCW,CCWREG                                        Y02032 19300003
         USING UCBMT,UXREG                                       Y02032 19350003
ER2401A  EQU   *                                                        19400003
         L     UCBREG,IOSUCB           GET UCB ADR FROM IOSB     Y02032 19450003
         SH    UCBREG,H512             POINT TO UCB PREFIX       Y02032 19500003
         L     EWAREG,IOSERP           GET EWA ADDR FROM IOSB    Y02032 19550003
         OI    IOSFLA,IOSEX            TURN ON EXCEPTION FLAG    Y02032 19600003
         TM    EWAFLG1,EWABDSNS        TEST FOR SENSE FAILURE  @YM07116 19650003
         BO    A003                    BRANCH ON SENSE FAILURE @YM07116 19700003
*                                                                       19708037
*   TEST FOR ICC OR CCC.  IF ON, GO TO LOAD 2, PART 9          @ZA14752 19716037
*                                                                       19724037
         TM    IOSTSB,CSWCCC+CSWICC    IS ICC OR CCC ON?       @ZA14752 19732037
         BNZ   A2020                   YES - GO TO LOAD 2, PART 9       19740037
         L     CCWREG,IOSCSW-C1        GET CCW ADDRESS         @YM07116 19750003
         LA    CCWREG,0(CCWREG)        ZERO HI-ORDER BYTE      @YM07116 19800003
         SH    CCWREG,EIGHT            POINT TO FAILING CCW    @YM07116 19850003
         LTR   CCWREG,CCWREG           IS ADDRESS MINUS?       @YM07116 19900003
         BM    A003                    BRANCH YES              @YM07116 19950003
         CLI   0(CCWREG),CMDSNS        IS FAILING CCW A SNS    @YM07116 20000003
         BNE   A003                    BRANCH NO               @YM07116 20050003
         TM    IOSCC,IOSCC3            IS COND CODE 3          @YM07116 20100003
         BO    A003                    BRANCH YES              @YM07116 20150003
         TM    IOSCC,IOSCC1            IS COND CODE 1          @YM07116 20200003
         BZ    A001                    BRANCH NO               @YM07116 20250003
         MVC   0(C1,CCWREG),IOSFMSK    MOVE MODE SET TO CCW OP @YM07116 20300003
A001     EQU   *                                                        20350003
         TM    IOSFLA,IOSREP           IS IT ERP REPOSITION?   @YM07116 20400003
         BZ    A002                    BRANCH NO               @YM07116 20450003
         MVC   0(C1,CCWREG),IOSMDB     MOVE REPO OP TO CCW OP  @YM07116 20500003
A002     EQU   *                                                        20550003
         XC    C1(C7,CCWREG),C1(CCWREG) ZERO REST OF CCW       @YM07116 20600003
         MVC   IOSMDM(1),EWTSNS2       MOVE TIE BYTE TO IOSB   @ZA08849 20620003
A003     EQU   *                                                        20650003
         TM    UCBTBYT4,UCB3400        3400 TYPE DEVICE        @YM07116 20700003
         BNO   A004                    NO, BRANCH              @YM07116 20750003
         L     R8,UCBXTN               GET ADDR OF VES COUNTER @YM07116 20800003
         LA    R8,C11(R8)              STEP TO MODE SET BYTE   @YM07116 20850003
         MVC   0(C1,R8),IOSFMSK        MOVE IN MODE SET        @YM07116 20900003
*                                                                       20950003
*   CHECK FOR UNSOLICITED DEVICE END OR IOB INTERCEPT                   21000003
*                                                                       21050003
A004     EQU   *                                                        21100003
         TM    IOSFLC,IOSVERIF         UNSOLICITED DEVICE END    Y02032 21150003
         BO    A2020                   YES - XCTL TO LOAD 2             21200003
         CLI   IOSCOD,IOSFINTC         IOB INTERCEPT?            Y02032 21250003
         BE    A2020                   YES - XCTL TO LOAD 2             21300003
*                                                                       21350003
*   GET SDR TABLE ADDRESS                                               21400003
*                                                                       21450003
BEGIN    EQU   *                                                        21500003
         LA    R13,C512(UCBREG)        POINT TO UCB BASE                21550003
         L     R8,LOC16                GET ADDRESS OF CVT               21600003
         L     R8,STATAB(R8)           ADDRESS OF SDR TABLE             21650003
         SR    R9,R9                   ZERO WORK REG                    21700003
         L     R4,UCBEXTPT             GET ADDR OF UCB COMMON EXTN.     21750003
         LA    R4,0(R4)                GET 3-BYTE ADDRESS               21800003
         IC    R9,STI(R4)              GET INDEX                        21850003
         LR    SDRREG,R8               SAVE SDR TABLE ADDRESS           21900003
A005     EQU   *                                                        21950003
         CLM   R13,C3,0(R8)            SDR AREA SECTION?       @Z30AB01 22000003
         BNH   A010                    YES-GET OUT OF LOOP     @Z30AB01 22050003
         LA    R8,C2(R8)               INCREMENT TO NEXT SECTION        22100003
         LA    R9,C256(R9)             STEP INDEX                       22150003
         B     A005                    NOT FOUND - LOOP AGAIN           22200003
A010     EQU   *                                                        22250003
         MH    R9,TEN                  TIMES 10                         22300003
         AR    SDRREG,R9               ENTRY FOR THIS UNIT              22350003
         EJECT                                                          22400003
*                                                                       22450003
*   SET UP REMAINING ADDRESSES                                          22500003
*                                                                       22550003
*   IF THIS IS AN EXCP REQUEST, WE GET THE DEB ADDRESS FROM THE         22600003
*   RQE AND THE DCB ADDRESS FROM THE DEB, OTHERWISE THEY ARE ZERO       22650003
*                                                                       22700003
         CLI   IOSDVRID,IOSXCPID       WAS THIS AN EXCP REQUEST? Y02032 22750003
         BNE   A015                    NO-GO ZERO ADDRESS FIELDS Y02032 22800003
         L     R13,IOSUSE              YES-GET RQE ADR FROM IOSB Y02032 22850003
         L     R13,C8(R13)             GET DEB ADR FROM RQE      Y02032 22900003
         ST    R13,EWTDEB              SAVE DEB ADR IN EWA       Y02032 22950003
         L     R13,DEBDCB(R13)         GET DCB ADR FROM DEB      Y02032 23000003
         ST    R13,EWTDCB              STORE IN EWA SAVE AREA    Y02032 23050003
         B     A020                    GO GET REMAINING ADDR.    Y02032 23100003
A015     EQU   *                                                        23150003
         SR    R13,R13                 ZERO WORK REG             Y02032 23200003
         ST    R13,EWTDEB              ZERO DEB ADDRESS          Y02032 23250003
         ST    R13,EWTDCB              ZERO DCB ADDRESS          Y02032 23300003
*                                                                       23350003
A020     EQU   *                                                        23400003
         L     UXREG,UCBXTN            GET ADR OF UCB EXTENSION  Y02032 23450003
         LA    UXREG,0(UXREG)          GET 3-BYTE ADDRESS               23500003
         LA    EXITREG,RETN            GET ERROR EXCP ADDR - SVC 15/3   23550003
*                                                                       23600003
         L     CCWREG,IOSCSW-C1        GET CCW ADDR FROM STATUS         23650003
         LA    CCWREG,0(CCWREG)        GET 3-BYTE ADDRESS               23700003
         SH    CCWREG,EIGHT            SUBTRACT 8                       23750003
         LTR   CCWREG,CCWREG           NEGATIVE ADDRESS?                23800003
         BM    A1000                   YES - SET X'4B' & GO TO LOAD 2   23850003
*                                                                       23900003
         TM    EWACNTR3,EWTEXIT        IS TEMP EXIT BIT ON?             23950003
         BO    D130                    YES - GO UPDATE COUNTERS         24000003
*                                                                       24050003
*   TEST FOR FIRST ENTRY INTO LOAD 1                                    24100003
*   DO STAT UPDATE IF FIRST ENTRY                                       24150003
*                                                                       24200003
A100     EQU   *                                                        24250003
         TM    IOSFLA,IOSERR           FIRST ENTRY TO ERP        S21048 24300003
         BO    A120                    NO - DON'T DO STAT UPDATE S21048 24350003
*                                                                       24400003
         NI    EWAFLG3,X'FF'-EWTOVER   ZERO SDR OVERFLOW       @ZA27822 24420037
         XC    EWTIDAL(C68),EWTIDAL    SET EWT WORK AREA TO 0    Y02032 24450003
         XC    EWTRRCCW(C8),EWTRRCCW   SET EWT WORK AREA TO 0    Y02032 24500003
         XC    EWTRES(C16),EWTRES      SET EWT WORK AREA TO 0  @ZA05117 24550003
*                                                                       24600003
         OI    IOSFLA,IOSEX+IOSERR     SET ERP IN CONTROL               24650003
         TM    IOSOPT,IOSDEP           DEVICE END POST BIT ON?   Y02032 24700003
         BZ    A105                    NO - LEAVE DEP SAVE BIT OFF      24750003
         OI    EWACNTR3,EWTDEP         YES - TURN ON DEP SAVE BIT       24800003
*                                                                       24850003
*   GO TO PART 5 TO DO STAT UPDATE IF ANY OF THE FOLLOWING ARE ON:      24900003
*        UNIT CHECK                                                     24950003
*        PROGRAM CHECK                                                  25000003
*        PROTECTION CHECK                                               25050003
*        CHANNEL DATA CHECK                                             25100003
*        CHAINING CHECK                                                 25150003
*                                                                       25200003
A105     EQU   *                                                        25250003
         LH    R0,IOSTATUS             GET STATUS                       25300003
         N     R0,SDRCON               ANY BITS ON?              S21048 25350003
         BNZ   PART5                   YES - GO TO STAT UPDATE   S21048 25400003
*                                                                       25450003
*                                                                       25500037
A120     EQU   *                                                        25600037
*                                                                       25750003
         TM    EWAFLG3,EWTROR          TEST FOR READ OPPOSITE    Y02032 25800003
         BO    PART3                   YES - BRANCH TO PART 3, ROR      25850003
*                                                                       25900003
         TM    EWACNTR3,EWTLWR         WAS LOOP WRITE TO READ DONE?     25950003
         BNO   A130                    NO - GO CHECK REPOSITION         26000003
*                                                                       26050003
         NI    EWACNTR3,X'FF'-EWTLWR   RESET LWR FLAG                   26100003
         L     R13,EWTVIRT             GET ADDR OF USER CCW      Y02032 26150003
         ST    R13,IOSVST              RESTORE START ADR (VIRT)  Y02032 26200003
         LRA   R13,0(R13)              GET REAL ADDRESS          Y02032 26250003
         ST    R13,IOSRST              RESTORE START ADR (REAL)  Y02032 26300003
         B     A600                    GO BACKSPACE/ERASE GAP    Y02032 26350003
*                                                                       26400003
A130     EQU   *                                                        26450003
         TM    IOSFLA,IOSREP           WAS TAPE BEING REPOSITIONED?     26500003
         BZ    A170                    NO - GO CONTINUE CHECKS          26550003
         EJECT                                                          26600003
*                                                                       26650003
*   R E P O S I T I O N I N G                                           26700003
*                                                                       26750003
A145     EQU   *                                                        26800003
         TM    IOSTSA,CSWUCK           TEST FOR ERROR ON REPOSITION     26850003
         BZ    A150                    NO - BR AROUND LOAD 2 TEST       26900003
*                                                                       26950003
*                                                                       27070037
*   ERROR ON REPOSITIONING - TEST FOR RETURN FROM LOAD 2                27080037
*                                                                       27090037
A145A    TM    EWAFLG3,EWTRTN2         RETURN FROM LOAD 2?       Y02032 27100037
         BO    A160                    YES - GO CHK FOR CLEAN OR ERASE  27150003
         B     A2020                   NO  - XCTL TO LOAD 2             27200003
*                                                                       27250003
A150     EQU   *                                                        27300003
         TM    IOSTSA,CSWCUB           CONTROL UNIT BUSY?               27350003
         BCR   1,EXITREG               YES - RESTART, SVC 15/3          27400003
*                                                                       27450003
A160     NI    EWAFLG3,X'FF'-EWTRTN2   RESET LOAD 2 SWITCH       Y02032 27500003
*                                                                       27550003
*   TEST FOR TAPE CLEAN OR TAPE ERASE                                   27600003
*                                                                       27650003
         TM    EWAFLG3,EWTTPC+EWTBKS   IS THIS CLEANING OR ERASE?       27700003
         BC    5,A400                  YES - BRANCH                     27750003
         TM    EWACNTR1,CLNCNT0        IS CLEANER CONTROL COUNT ZERO?   27800003
         BC    5,C485                  NO - SVC 15/3                    27850003
*                                                                       27900003
A165     EQU   *                                                        27950003
         NI    IOSFLA,X'FF'-IOSREP     SET TAPE REPOSITION BIT OFF      28000003
*                                                                       28050003
*   RESTORE DEVICE END POST BIT                                         28100003
*                                                                       28150003
A166     TM    EWACNTR3,EWTDEP         WAS ORIGINAL DEV END POST ON?    28200003
         BO    A168                    YES - LEAVE IT ON                28250003
         NI    IOSOPT,X'FF'-IOSDEP     NO - TURN IT OFF                 28300003
A168     EQU   *                                                        28350003
         BR    EXITREG                 GO RETRY - SVC 15/3              28400003
         EJECT                                                          28450003
*                                                                       28500003
*   N O T   R E P O S I T I O N I N G                                   28550003
*                                                                       28600003
A170     EQU   *                                                        28650003
         NI    IOSFLA,X'FF'-IOSCRC     TURN OFF CRC                     28700003
*                                                                       28750003
*   TEST FOR INITIAL SELECTION                                          28800003
*                                                                       28850003
         TM    IOSCC,IOSCC3            SIO CONDITION CODE = 3?          28900003
         BO    A570                    YES - GO XCTL TO WTO             28950003
         BM    A210                    BR IF COND CODE = 1 (INIT SEL)   29000003
*                                                                       29050003
*   TEST FOR CHAINING                                                   29100003
*                                                                       29150003
         TM    IOSFLA,IOSACHN          DATA OR COMMAND CHAINING?        29200003
         BZ    A200                    NEITHER - GO SET REP DIRECTION   29250003
         BO    A525                    BOTH - GO EXIT ERP               29300003
*                                                                       29350003
*   DATA CHAINING OR COMMAND CHAINING                                   29400003
*                                                                       29450003
         TM    IOSFLA,IOSCCHN          COMMAND CHAINING?                29500003
         BO    A180                    YES - BR AROUND DATA CHAINING    29550003
*                                                                       29600003
*   DATA CHAINING ONLY - START AT TOP OF CHANNEL PROGRAM                29650003
*                                                                       29700003
         L     CCWREG,IOSVST           GET START ADDRESS (VIRTUAL)      29750003
         B     A200                    GO SET DIRECTION                 29800003
*                                                                       29850003
*   COMMAND CHAINING                                                    29900003
*                                                                       29950003
A180     TM    EWACNTR3,EWTRST         FIRST ENTRY (START FLAG OFF)?    30000003
* *                                                                     30050037
*   SAVE ORIGINAL FAILING CCW ADDRESS IN CASE OF MULTIPLE               30070037
*   FAILURES IN THE SAME CCW CHAIN.                                     30090037
**                                                                      30110037
         BNE   A181                    NO, BRANCH AROUND      @ZA16828  30130037
         ST    CCWREG,EWADCNT          SAVE CCW ORIGINAL CCW  @ZA16828  30150037
         B     A190                    GO SET RESTART         @ZA16828  30170037
*                                                                       30190037
*   NOT FIRST ENTRY                                                     30210037
*                                                                       30230037
A181     NI    IOSMDB,ZERO             CLEAR MOD BYTE                   30250037
         LR    R13,CCWREG              SET WORK REG TO CCW ADDRESS      30300003
         S     R13,IOSVST              COMPARE TO RESTART ADDRESS       30350003
         BZ    A200                    EQUAL - BRANCH TO SET DIRECTION  30400003
*                                                                       30450003
*   COMMAND CHAINING AND CHAIN BROKE IN DIFFERENT PLACE                 30500003
*                                                                       30550003
         XC    EWACNTR1(C2),EWACNTR1   CLEAR ERROR COUNTS        Y02032 30600003
A190     EQU   *                                                        30650003
         OI    EWACNTR3,EWTRST         SET RESTART FLAG          Y02032 30700003
         ST    CCWREG,IOSVST           SET ADDRESS TO RESTART           30750003
         LRA   R13,CCW                 TRANSLATE VIRT START ADDR Y02032 30800003
         ST    R13,IOSRST              STORE IN REAL START ADDR  Y02032 30850003
*                                                                       30900003
*   SET REPOSITION DIRECTION FOR ALL READ/WRITE ERRORS                  30950003
*                                                                       31000003
A200     EQU   *                                                        31050003
         LTR   CCWREG,CCWREG           NEGATIVE ADDRESS?         A29974 31100003
         BM    A1000                   YES - SET X'4B' & GO TO LOAD 2   31150003
         MVI   IOSMDB,CMDBSR           SET TO BACKSPACE          A29974 31200003
         CLI   CCWOP,CMDRDB            IS IT READ BACK?                 31250003
         BNE   A210                    NO - LEAVE BSR                   31300003
         MVI   IOSMDB,CMDFSR           SET TO FORWARD SPACE             31350003
*                                                                       31400003
*   TEST FOR UNIT CHECK                                                 31450003
*                                                                       31500003
A210     EQU   *                                                        31550003
         TM    IOSTSA,CSWUCK           UNIT CHECK?                      31600003
         BO    A220                    YES - GO TEST SENSE              31650003
         CLI   IOSTSA,CSWCUB           IS CONTROL UNIT BUSY?            31700003
         BNE   PART4                   NO - GO TEST CSW, PART 4         31750003
         BR    EXITREG                 ERROR EXCP - SVC 15/3            31800003
         EJECT                                                          31850003
*                                                                       31900003
*                        U N I T   C H E C K                            31950003
*                                                                       32000003
*   TEST SENSE BITS ACCORDING TO PRIORITY                               32050003
*                                                                       32100003
A220     EQU   *                                                        32150003
         TM    EWTSNS0,SNSTST          PRIORITY TEST OF SENSE    Y02032 32200003
*                                      CR, IR, BO, EQ, OR               32250003
         BC    5,A2010                 ANY OR ALL TO LOAD 2, PART 4     32300003
         TM    EWTSNS1,EWTLP           BACKED INTO LOAD POINT ON READ?  32350003
         BO    A2010                   YES - BRANCH TO LOAD 2, PART 4   32400003
         TM    EWTSNS0,EWTDATA         DATA CHECK?               Y02032 32450003
         BO    A230                    YES - BR AROUND CHANNEL DATA CK  32500003
*                                                                       32550003
*   TEST FOR CHANNEL DATA CHECK                                         32600003
*                                                                       32650003
         TM    IOSTSB,CSWCDC           CHANNEL DATA CHECK?              32700003
         BO    A2000                   YES - BR TO LOAD 2, PART 4B      32750003
         TM    EWTSNS5,EWTPEID         IS IT PE ID CHECK         Y02032 32800003
         BNO   A2010                   NO - BR TO LOAD 2, PART 4        32850003
*                                                                       32900003
*                         D A T A   C H E C K                           32950003
*                                                                       33000003
A230     EQU   *                                                        33050003
         TM    CCWOP,CMDWRT            WRITE OR CONTROL?         A29974 33100003
         BO    A580                    YES - GO CHECK 15 RETRIES        33150003
*                                                                       33200003
*   TEST NOISE BIT                                                      33250003
*   ALWAYS ON FOR PE, INDICATING THAT IT IS NOT A NOISE BLOCK           33300003
*                                                                       33350003
         TM    EWTSNS1,EWTNOISE        NOISE BIT ON?             Y02032 33400003
         BO    A260                    YES - CHECK FOR RETRIES          33450003
*                                                                       33500003
*   CHECK BLOCK LENGTH FOR SHORT BLOCK                                  33550003
*                                                                       33600003
         TM    IOSFLA,IOSDCHN          DATA CHAINING?                   33650003
         BZ    A250                    NO - GO CHECK RESIDUAL           33700003
*                                                                       33750003
*   TEST FOR NOISE WHEN DATA CHAINING.  CCWREG IS START ADDRESS         33800003
*                                                                       33850003
         LA    CCWREG,CCWADR           GET ADDRESS ONLY (START)         33900003
         L     R13,IOSCSW-C1           GET INTERRUPT + 8                33950003
         LA    R13,0(R13)              GET ADDRESS ONLY                 34000003
         SH    R13,EIGHT               SUBTRACT 8                       34050003
         CR    CCWREG,R13              ERROR ON FIRST CCW?              34100003
         BL    A260                    NO - BR AROUND NOISE TEST        34150003
         CLC   CCWCNT,TWELVE           1ST CCW COUNT GREATER THAN 11?   34200003
         BL    A2020                   NO - NOISE BLOCK, BR TO LOAD 2   34250003
*                                                                       34300003
*   TEST COUNT - RESIDUAL FOR NOISE BLOCK                               34350003
*                                                                       34400003
A250     EQU   *                                                        34450003
         LH    R13,CCWCNT              GET CCW COUNT                    34500003
         SH    R13,IOSCSWRC            LESS RESIDUE IN CSW              34550003
         N     R13,MASK                ZERO HIGH ORDER BITS             34600003
         SH    R13,TWELVE              SUBTRACT MINIMUM SIZE            34650003
         BM    A2020                   SHORT BLOCK - GO TO LOAD 2       34700003
*                                                                       34750003
*   TEST IF TAPE CLEANING TO BE USED                                    34800003
*                                                                       34850003
A260     EQU   *                                                        34900003
         L     R13,EWTDEB              GET DEB ADDR              Y02032 34950003
         CL    R13,FZERO               VALID DEB ADDR?           Y02032 35000003
         BE    A270                    NO - SKIP EMULATOR        Y02032 35050003
         TM    DEBOFL(R13),DEBEMU      IS EMULATOR BIT ON?              35100003
         BZ    A270                    NO - BR AROUND PARITY FLIP       35150003
         XI    DEBMOD(R13),DEBPAR      YES - FLIP PARITY                35200003
         MVC   IOSFMSK(1),DEBMOD(R13)  PUT MODESET TO IOSB     @ZA05130 35210003
A270     EQU   *                                                        35250003
         TM    EWACNTR2,X4             IS THIS A MULTIPLE OF 4?  Y02032 35300003
         BZ    A300                    NO - CONTINUE                    35350003
*                                                                       35400003
*   IS REDUCED ERROR RECOVERY SPECIFIED?                                35450003
*                                                                       35500003
         CL    R13,FZERO               VALID DEB ADDR?           Y02032 35550003
         BE    A280                    NO - SKIP RER             Y02032 35600003
         TM    DEBOFL(R13),DEBRER      IS RER BIT ON?                   35650003
         BZ    A280                    NO - CONTINUE                    35700003
         BAL   RETREG,A575             YES-GO UPDATE PR VES COUNTER     35750003
*                                                                       35800003
*   PERMANENT ERROR EXIT                                                35850003
*                                                                       35900003
A275     EQU   *                                                        35950003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA SET PERM ERR EXIT   @YM06412 36000003
         BR    EXITREG                 EXIT VIA SVC 15/3                36050003
         EJECT                                                          36100003
*                                                                       36150003
*                       C L E A N I N G                                 36200003
*                                                                       36250003
*   NOT REDUCED ERROR RECOVERY - TEST FOR LAST READ RETRY               36300003
*                                                                       36350003
A280     EQU   *                                                        36400003
         TM    EWACNTR2,NUMB40         40TH RETRY?                      36450003
         BO    PART3                   YES - BRANCH TO PART 3, ROR      36500003
*                                                                       36550003
*   THIS SECTION IS ENTERED EVERY 4TH RETRY ON A READ ERROR TO          36600003
*   PERFORM A CARRY OPERATION AND INITIATE TAPE CLEANING                36650003
*                                                                       36700003
         LH    R13,UCBCLN              GET ESV CLEANER COUNT            36750003
         CH    R13,MASK+C2             IS COUNTER FULL?                 36800003
         BE    A290                    YES - BR AROUND INCREMENT        36850003
         LA    R13,C1(R13)             ADD ONE TO COUNT                 36900003
         STH   R13,UCBCLN              STORE UPDATED COUNT              36950003
*                                                                       37000003
*   INCREMENT READ DATA CHECK COUNT                                     37050003
*                                                                       37100003
A290     EQU   *                                                        37150003
         SR    R13,R13                 ZERO REGISTER                    37200003
         IC    R13,EWACNTR2            GET ERROR COUNT                  37250003
         LA    R13,C13(R13)            PERFORM CARRY                    37300003
         STC   R13,EWACNTR2            STORE UPDATED COUNT       Y02032 37350003
         OI    EWAFLG3,EWTTPC          SET TAPE CLEAN BIT        Y02032 37400003
         OI    IOSFLA,IOSREP+IOSCRC    SET REPOSITION AND CRC FLAGS     37450003
         OI    IOSOPT,IOSDEP           SET DEVICE END POST BIT   Y02032 37500003
*                                                                       37550003
*   SET UP FOR BACK SPACES (4 IF RDF, 3 IF RDB)                         37600003
*                                                                       37650003
         OI    EWACNTR1,CLNCNT4        ASSUME READ FORWARD       Y02032 37700003
         CLI   CCWOP,CMDRDB            READ BACKWARDS?                  37750003
         BCR   7,EXITREG               NO - SVC 15/3                    37800003
         NI    EWACNTR1,CNT0           SET COUNT TO ZERO         Y02032 37850003
         OI    EWACNTR1,CLNCNT3        SET COUNT TO 3            Y02032 37900003
         OI    EWAFLG3,EWTBKS          SET BACKSPACE ERASE FLAG  Y02032 37950003
         MVI   IOSMDB,CMDBSR           SET BSR COMMAND                  38000003
         BR    EXITREG                 EXIT - SVC 15/3                  38050003
*                                                                       38100003
*   N O   C L E A N I N G                                               38150003
*                                                                       38200003
A300     EQU   *                                                        38250003
         MVI   EWTRRCMD,ZERO           ZERO ROR COMMAND                 38300003
         OI    IOSFLA,IOSREP+IOSCRC    SET TAPE REPOSITION & CRC        38350003
         OI    IOSOPT,IOSDEP           SET DEVICE END POST BIT   Y02032 38400003
         IC    R13,EWACNTR2            GET CURRENT COUNT         Y02032 38450003
         LA    R13,C1(R13)             ADD ONE TO COUNT                 38500003
         STC   R13,EWACNTR2            STORE UPDATED COUNT       Y02032 38550003
         BR    EXITREG                 GO REPOSITION - SVC 15/3         38600003
*                                                                       38650003
*   NOT DATA CHECK ON READ - CHECK SENSE                                38700003
*                                                                       38750003
A400     EQU   *                                                        38800003
         TM    EWAFLG3,EWTTPC          IS TAPE CLEANING USED?    Y02032 38850003
         BO    A510                    YES - GO TEST FOR END OF CLEANER 38900003
         NI    EWAFLG3,X'FF'-EWTBKS    SET BKS ERASE FLAG OFF    Y02032 38950003
         MVI   IOSMDB,CMDERG           SET CONTROL COMMAND TO ERASE     39000003
         BR    EXITREG                 TO ERROR EXCP - SVC 15/3         39050003
*                                                                       39100003
*   TEST FOR END OF CLEANER BSR (DECREMENT COUNT OR SET FSR)            39150003
*                                                                       39200003
A510     EQU   *                                                        39250003
         TM    EWACNTR1,CLNCNT0        IS CLEANER CTL COUNT ZERO?       39300003
         BC    5,C485                  NO - DECREMENT COUNT, SVC 15/3   39350003
         MVI   IOSMDB,CMDFSR           SET CONTROL COMMAND TO FSR       39400003
         OI    EWACNTR1,CLNCNT3        SET CONTROL COUNT TO 3    Y02032 39450003
         TM    EWAFLG3,EWTBKS          IS BACKSPACE ERASE FLAG ON?      39500003
         BZ    A520                    NO - GO RESET CONTROL FLAGS      39550003
*                                                                       39600003
         NI    EWACNTR1,HEXF8          SET COUNT TO 0            Y02032 39650003
         OI    EWACNTR1,CLNCNT4        SET COUNT TO 4            Y02032 39700003
*                                                                       39750003
A520     EQU   *                                                        39800003
         NI    EWAFLG3,X'FF'-EWTTPC-EWTBKS   CLEAR FLAGS         Y02032 39850003
         BR    EXITREG                 EXIT VIA SVC 15/3                39900003
         EJECT                                                          39950003
*                                                                       40000003
*                L O G O U T                                            40050003
*                                                                       40100003
A525     EQU   *                                                        40150003
         TM    CCWOP,CMDWRT            WRITE OR CONTROL?                40200003
         BO    A530                    YES-GO UPDATE PW VES CNTR        40250003
         BAL   RETREG,A575             NO-GO UPDATE PR VES CONTR        40300003
         B     A560                    GO LOG OUT                       40350003
*                                                                       40400003
*   UPDATE PERMANENT WRITE VES COUNTER                                  40450003
*                                                                       40500003
A530     EQU   *                                                        40550003
         TM    UCBPW,FULL              IS PERM. WRITE COUNT FULL?       40600003
         BO    A560                    YES - SKIP UPDATE                40650003
         IC    R4,UCBPW                NO - GET PERM WRITE COUNT        40700003
         LA    R4,C1(R4)               ADD ONE TO COUNT                 40750003
         STC   R4,UCBPW                STORE BACK                       40800003
*                                                                       40850003
*   SET MESSAGE BIT                                                     40900003
*                                                                       40950003
A560     EQU   *                                                        41000003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA  SET PERM ERR EXIT  @YM06412 41050003
         OI    IOSFLB,IOSMSG+IOSLOG    SET MESSAGE TYPE & LOGOUT        41100003
**                                                                      41103037
*   RESTORE ORIGINAL FAILING CCW ADDRESS                                41106037
**                                                                      41109037
         TM    IOSFLA,IOSCCHN          COMMAND CHAINING ?     @ZA16828  41112037
         BNO   A570                    NO, BRANCH AROUND      @ZA16828  41115037
         L     R13,EWADCNT             GET FIRST FAILING CCW  @ZA16828  41118037
         LTR   R13,R13                 CCW POINTER ZERO ?     @ZA16828  41121037
         BZ    A570                    YES, BRANCH AROUND     @ZA16828  41124037
         LA    R13,0(R13)              ZERO HIGH ORDER BYTES  @ZA16828  41127037
         ST    R13,IOSVST              RESTORE VIRTUAL START  @ZA16828  41130037
         LRA   R13,0(R13)              GET REAL ADDRESS       @ZA16828  41133037
         ST    R13,IOSRST              RESTORE REAL START     @ZA16828  41136037
A570     EQU   *                                                        41150003
         LA    R13,WTORTN              LOAD WTO ADDRESS                 41200003
         B     XCTL1                   XCTL TO WTO                      41250003
*                                                                       41300003
*   UPDATE PERMANENT READ VES COUNTER                                   41350003
*                                                                       41400003
A575     EQU   *                                                        41450003
         TM    UCBPR,FULL              IS READ COUNT FULL?              41500003
         BO    A577                    YES - SKIP UPDATE                41550003
         IC    R4,UCBPR                GET PERM READ COUNT              41600003
         LA    R4,C1(R4)               ADD ONE TO COUNT                 41650003
         STC   R4,UCBPR                STORE BACK                       41700003
A577     BR    RETREG                  RETURN                           41750003
         EJECT                                                          41800003
*                                                                       41850003
*                  D A T A   C H E C K                                  41900003
*                                                                       41950003
*                   WRITE OR CONTROL                                    42000003
*                                                                       42050003
A580     EQU   *                                                        42100003
         TM    EWACNTR2,NUMB15         15 RETRIES?               Y02032 42150003
         BO    A530                    YES - BRANCH TO PERM ERROR       42200003
*                                                                       42250003
         IC    R13,EWACNTR2            GET ERROR COUNT           Y02032 42300003
         LA    R13,C1(R13)             ADD ONE TO COUNT                 42350003
         STC   R13,EWACNTR2            STORE UPDATED COUNT       Y02032 42400003
         TM    EWACNTR2,NUMB15         14 RETRIES?               Y02032 42450003
         BO    A620                    YES - BR TO LOOP WR/RD    S21048 42500003
*                                                                       42550003
         TM    CCWOP,CMDCTL            IS THIS A CONTROL COMMAND?       42600003
         BNO   A585                    NO - GO TEST PE ID BURST         42650003
*                                                                       42700003
         CLI   CCWOP,CMDWTM            IS CTL COMMAND A WTM?            42750003
         BE    A585                    YES - GO TEST PE ID BURST        42800003
*                                                                       42850003
         TM    EWTSNS5,EWTPEID         IS IT PE ID BURST?        Y02032 42900003
         BO    A587                    YES - GO SET TO REWIND           42950003
*                                                                       43000003
*   ERG DATA CHECK - CHECK FOR 4 (3 RETRIES)                            43050003
*                                                                       43100003
         TM    EWACNTR2,CLNCNT4        HAD 3 RETRIES?            Y02032 43150003
         BCR   14,EXITREG              NO - RETRY, SVC 15/3             43200003
         B     A530                    YES - PERM ERROR, GO WRITE MSG   43250003
*                                                                       43300003
A585     EQU   *                                                        43350003
         TM    EWTSNS5,EWTPEID         PE ID BURST CHECK?        Y02032 43400003
         BZ    A600                    NO - GO CHECK FOR REWIND  S21048 43450003
A587     EQU   *                                                        43500003
         MVI   IOSMDB,CMDREW           SET REWIND COMMAND        S21048 43550003
A590     EQU   *                                                        43600003
         OI    IOSFLA,IOSREP           SET REPOSITION BIT               43650003
         OI    IOSOPT,IOSDEP           SET DEVICE END POST BIT   Y02032 43700003
A595     EQU   *                                                        43750003
         BR    EXITREG                 GO REWIND/RETRY - SVC 15/3       43800003
*                                                                       43850003
*   SET FOR ERG AND REPOSITION                                          43900003
*                                                                       43950003
A600     EQU   *                                                        44000003
         CLI   IOSMDB,CMDREW           WAS COMMAND A REWIND?     S21048 44050003
         BE    A610                    YES-BR AROUND ERASE LOGIC S21048 44100003
*                                                                       44150003
         OI    EWAFLG3,EWTBKS          SET BACKSPACE ERASE FLAG  Y02032 44200003
         NI    EWACNTR2,X'FF'-ERGCNT   RESET ERG D.C. COUNT      Y02032 44250003
         LH    R13,UCBERG              GET ERG COUNT                    44300003
         CH    R13,MASK+C2             IS COUNT FULL?                   44350003
         BE    A610                    YES - BR AROUND ERG COUNTER      44400003
*                                                                       44450003
         LA    R13,C1(R13)             ADD ONE TO COUNT                 44500003
         STH   R13,UCBERG              STORE UPDATED COUNT              44550003
A610     EQU   *                                                        44600003
         TM    EWACNTR3,EWTROC         ROR COMMAND IN USE?       Y02032 44650003
         BZ    A590                    NO - GO SET REP, SVC 15/3 S21048 44700003
*                                                                       44750003
         NI    EWACNTR3,X'FF'-EWTROC   RESET USE ROR COMMAND     Y02032 44800003
         TM    IOSTSA,CSWUCK           IS UNIT CHECK ON?         M0907  44850003
         BZ    A590                    NO - GO RETRY             A52064 44900003
*                                                                       44950003
         OI    IOSFLA,IOSREP           SET REPOSITION BIT        Y02032 45000003
         OI    IOSOPT,IOSDEP           SET DEVICE END POST BIT   Y02032 45050003
         OI    EWAFLG3,EWTOVER         SET SDR OVERFLOW FLAG ON  Y02032 45100003
         LA    R13,SERLOG              GET ADDRESS OF OBR        S21048 45150003
         B     XCTL1                   GO TO OBR                        45200003
*                                                                       45250003
A620     EQU   *                                                        45300003
         CLI   CCWOP,CMDWRT            IS COMMAND A WRITE?       S21048 45350003
         BNE   A585                    NO - GO TEST FOR PE ID BURST     45400003
*                                                                       45450003
         TM    UCBTBYT4,UCB3400        3400 TAPE UNIT?           S21048 45500003
         BNO   A585                    NO - GO TEST FOR PE ID BURST     45550003
*                                                                       45600003
*   SET LOOP WRITE TO READ                                              45650003
*                                                                       45700003
         MVC   EWTRRCCW,CCW            MOVE IN USER CCW          S21048 45750003
         MVI   EWTRRCMD,CMDLWR         SET LOOP WRT/RD OP CODE   S21048 45800003
         OI    EWACNTR3,EWTLWR         SET LOOP WRITE TO READ FLAG      45850003
         OI    EWTRRFLS,RORSILI        SUPPRESS INCORRECT LENGTH Y02032 45900003
         NI    EWTRRFLS,X'FF'-IOSACHN  TURN OFF CHAINING FLAGS          45950003
         OI    EWACNTR3,EWTROC         SET USE ROR COMMAND       S21048 46000003
*                                                                       46050003
*   SET UP RORCCW ADDRESS FOR IOS                                       46100003
*                                                                       46150003
         MVC   EWTVIRT,IOSVST          SAVE START ADDR (VIRT)           46200003
         LA    R13,EWTRRCCW            GET ADDR OF RORCCW (VIRT)        46250003
         ST    R13,IOSVST              STORE IOSB VIRT START ADDR       46300003
         LRA   R13,EWTRRCCW            GET ADDR OF RORCCW (REAL)        46350003
         ST    R13,IOSRST              STORE IOSB REAL START ADDR       46400003
*                                                                       46450003
         TM    EWTSNS5,EWTPEID         PE ID BURST CHECK?        S21048 46500003
         BZ    A595                    NO  - GO SVC 15/3                46550003
         MVI   IOSMDB,CMDREW           SET REWIND COMMAND        S21048 46600003
         BR    EXITREG                 GO REWIND - SVC 15/3             46650003
         EJECT                                                          46700003
A1000    EQU   *                                                        46750003
         MVI   IOSCOD,IOSTAPEC         X'4B' IN IOB ECB CODE     A29974 46800003
*                                      INDICATES ERP ERROR              46850003
         B     A2020                   GO TO LOAD 2, PART 1             46900003
*                                                                       46950003
*   TRANSFER CONTROL TO LOAD 2                                          47000003
*                                                                       47050003
A2000    EQU   *                                                        47100003
         OI    EWAFLG3,EWTPT4B         SET UP FOR ENTRY TO PART 4B      47150003
         B     A2020                   GO TO LOAD 2                     47200003
A2010    EQU   *                                                        47250003
         OI    EWAFLG3,EWTPT4A         SET UP FOR ENTRY TO PART 4A      47300003
A2020    EQU   *                                                        47350003
         LA    R13,LOAD2               GET LOAD 2 ADDRESS               47400003
         B     XCTL4                   GO XCTL                          47450003
*                                                                       47500003
XCTL1    EQU   *                       SET UP OBR INFO IN EWA    Y02032 47550003
         L     R5,EWTDCB               GET DCB ADDR              Y02032 47600003
         LA    R4,EWTVOLID             GET ADDR OF OBR AREA      Y02032 47650003
         ST    R4,EWADCNT              STORE ADDR IN EWA         Y02032 47700003
         MVI   EWADCNT,HEX24           MOVE IN #BYTES OF OBR     Y02032 47750003
         MVC   EWTVES,UCBCTD           GET VES INFO              Y02032 47800003
         CL    R5,FZERO                VALID DCB?                Y02032 47850003
         BE    XCTL2                   NO - SKIP BLOCK COUNT     Y02032 47900003
         OI    EWAFLG1,EWADDMSG        SET WTO FLAG ON         @ZA31011 47902037
         CLC   BLKCNT(4,R5),MASK       IS BLKCNT = TO 65K?     @ZA08856 47903037
         BNH   MOVIT                   BR IF BLKCNT IS LESS    @ZA08856 47904037
         MVC   EWTBLK,MASK+2           MOVE FFFF TO RECORD     @ZA08856 47905037
         B     XCTL3                   GO XCTL                 @ZA08856 47908003
MOVIT    EQU   *                                                        47910003
         MVC   EWTBLK,BLKCNT+C2(R5)    YES - GET BLOCK COUNT     Y02032 47950003
         B     XCTL3                   GO XCTL                   Y02032 48000003
*                                                                       48050003
XCTL2    EQU   *                                                        48100003
         MVC   EWTBLK,FZERO            SET BLOCK COUNT TO 0      Y02032 48150003
*                                                                       48200003
XCTL3    EQU   *                                                        48250003
         MVC   EWTVOLID,UCBVOLI        GET VOL SER               Y02032 48300003
XCTL4    EQU   *                                                        48350003
         L     XCTLREG,LOC16           GET ADDRESS OF CVT               48400003
         L     XCTLREG,VECTXL(XCTLREG) GET ADDRESS FOR XCTL ROUTINE     48450003
         BR    XCTLREG                 BRANCH TO XCTL                   48500003
*                                                                       48550003
*   ALL EXITS VIA SVC 15/3 COME HERE                                    48600003
*                                                                       48650003
RETN     EQU   *                                                        48700003
         SVC   EXCPER                  SVC 15 - ERROR EXCP              48750003
         SVC   RETURN                  SVC 3  - EXIT                    48800003
*************   E N D   O F   P A R T   1   *************               48850003
         EJECT                                                          48900003
*********************************************************************** 48950003
*                             P A R T   3                             * 49000003
*                                                                     * 49050003
*                       READ OPPOSITE RECOVERY                        * 49100003
*********************************************************************** 49150003
*                                                                     * 49200003
*        ISSUE A READ COMMAND IN THE OPPOSITE DIRECTION               * 49250003
*        WITH THE SUPPRESS DATA TRANSFER BIT ON.  REPEAT              * 49300003
*        40 TIMES OR UNTIL THE BLOCK IS READ SUCCESSFULLY.            * 49350003
*                                                                     * 49400003
*        AFTER EVERY FOURTH RETRY, GO THROUGH A TAPE                  * 49450003
*        CLEANING SEQUENCE.                                           * 49500003
*                                                                     * 49550003
*        ROR IS NOT POSSIBLE IF:                                      * 49600003
*              1.  DATA CHAINING                                      * 49650003
*              2.  OPERATING IN 7-TRACK DATA CONVERT MODE             * 49700003
*              3.  SUPPRESS DATA TRANSFER BIT IS SET IN FAILING CCW   * 49750003
*********************************************************************** 49800003
PART3    EQU   *                                                        49850003
*                                                                       49900003
*   TEST FOR READ OPPOSITE IN PROGRESS                                  49950003
*                                                                       50000003
         TM    EWAFLG3,EWTROR          ROR BIT ON?               Y02032 50050003
         BO    C160                    YES - GO TEST FOR ERROR          50100003
*                                                                       50150003
*   IF RORCCW IS NOT ZERO, WE HAD A PERMANENT ROR ERROR                 50200003
*                                                                       50250003
         CLI   EWTRRCMD,ZERO           IS COMMAND ZERO?                 50300003
         BNE   C120                    NO - BR TO PERM ERROR            50350003
*                                                                       50400003
*   THIS IS FIRST ENTRY FOR ROR ON A READ OR READ BACK                  50450003
*   DATA CHECK.  TEST FOR CONDITIONS NOT APPLICABLE                     50500003
         TM    EWTSNS1,EWT7TK          IS THIS 7-TRACK?          Y02032 50550003
         BZ    C110                    NO-GO TEST FOR SUPP DATA XFER    50600003
*                                                                       50650003
*   TEST FOR DATA CONVERTER MODE SET                                    50700003
*                                                                       50750003
         L     R13,EWTDCB              GET ADDRESS OF DCB        Y02032 50800003
         CL    R13,FZERO               VALID DCB ADDR?           Y02032 50850003
         BE    C110                    NO - SKIP DATA CON TEST   Y02032 50900003
         CLI   DCBMOD(R13),DCBDCF      DATA CONVERTER BEING USED?       50950003
         BE    C120                    YES-SKIP TEST FOR SUPP DATA TR.  51000003
*                                                                       51050003
*   TEST FOR SUPPRESS DATA TRANSFER IN ORIGINAL CCW                     51100003
*                                                                       51150003
C110     EQU   *                                                        51200003
         TM    CCWFLS,RORSDT           SUPPRESS DATA TRANSFER?   A29974 51250003
         BO    C120                    YES - BRANCH TO PERM ERROR       51300003
*                                                                       51350003
*   TEST FOR CCW COUNT GREATER THAN X'7FFF'                             51358037
*                                                                       51366037
         CLI   CCWCNT,HIBIT            COUNT TOO HIGH          @ZA17538 51374037
         BNL   C120                    YES, PERMANENT ERROR    @ZA17538 51382037
*                                                                       51390037
*   TEST FOR DATA CHAINING                                              51400003
*                                                                       51450003
         TM    IOSFLA,IOSDCHN          DATA CHAINING?                   51500003
         BZ    C140                    NO - GO SET UP RORCCW            51550003
C120     EQU   *                                                        51600003
         BAL   RETREG,A575             GO UPDATE PR VES COUNTER         51650003
C130     EQU   *                                                        51700003
         B     A560                    BRANCH TO PERM ERROR      S21048 51750003
         EJECT                                                          51800003
*                                                                       51850003
*                        F I R S T   E N T R Y                          51900003
*                                                                       51950003
*             SET UP INITIAL RORCCW ON FIRST ENTRY ONLY                 52000003
*                                                                       52050003
C140     EQU   *                                                        52100003
         MVC   EWTRRCCW,CCW            MOVE USER CCW TO RORCCW   Y02032 52150003
         CLC   EWTRRCNT,IOSCSWRC       USER BYTE CNT = RESIDUAL CNT?    52200003
         BE    C120                    YES - PERMANENT ERROR     Y02032 52250003
*                                                                       52300003
*   SET UP IOSB START ADDRESSES (REAL & VIRT) WITH ADDRESS OF           52350003
*   RORCCW TO BE USED DURING ROR                                        52400003
*                                                                       52450003
         MVC   EWTVIRT,IOSVST          SAVE START ADDR (VIRT)    Y02032 52500003
         LA    R13,EWTRRCCW            GET ADDR OF RORCCW (VIRT) Y02032 52550003
         ST    R13,IOSVST              STORE IOSB VIRT START ADR Y02032 52600003
         LRA   R13,EWTRRCCW            GET ADDR OF RORCCW (REAL) Y02032 52650003
         ST    R13,IOSRST              STORE IOSB REAL START ADR Y02032 52700003
*                                                                       52750003
         XC    IOSCSWRC,IOSCSWRC       ZERO RESIDUAL COUNT       Y02032 52800003
         BAL   BALREG,PART6            GO SET UP ADDRESSABILITY         52850003
*                                                                       52900003
*   UPDATE SDR                                                          52950003
*                                                                       53000003
C142     EQU   *                                                        53050003
         TM    UCBTBYT4,UCB3400        3400 TAPE UNIT?                  53100003
         BO    C145                    YES - SKIP ROR COUNT             53150003
*                                                                       53200003
         IC    R4,ROR(SDRREG)          GET ROR COUNT                    53250003
         LA    R4,C16(R4)              ADD ONE TO COUNT                 53300003
         STC   R4,ROR(SDRREG)          STORE BACK                       53350003
         TM    ROR(SDRREG),RDFULL      IS COUNT FULL?                   53400003
         BNO   C145                    NO - SKIP OVERFLOW               53450003
*                                                                       53500003
         OI    EWAFLG3,EWTOVER         YES - SET SDR OVERFLOW    Y02032 53550003
C145     EQU   *                                                        53600003
         XC    EWACNTR1(C2),EWACNTR1   ZERO ERROR COUNTERS       Y02032 53650003
         OI    EWACNTR2,X1             SET READ COUNT TO ONE     Y02032 53700003
         B     C510                    GO READ OPPOSITE                 53750003
         EJECT                                                          53800003
*                                                                       53850003
*                      R O R   I N   P R O G R E S S                    53900003
*                                                                       53950003
*   TEST FOR ERROR ON RETRY OR SPACE                                    54000003
*                                                                       54050003
C160     EQU   *                                                        54100003
         TM    EWAFLG3,EWTRBLD         REBUILD IDAL LIST?        Y02032 54150003
         BNO   C165                    NO  - BRANCH AROUND       Y02032 54200003
         BAL   BALREG,F030             YES - GO TO PART 6        Y02032 54250003
C165     EQU   *                                                        54300003
         TM    IOSTSA,CSWUCK           UNIT CHECK?                      54350003
         BO    C230                    YES - BRANCH                     54400003
*                                                                       54450003
*   TEST FOR CONTROL UNIT BUSY                                          54500003
*                                                                       54550003
         TM    IOSTSA,CSWCUB           CU BUSY?                         54600003
         BCR   1,EXITREG               YES - GO RETRY, SVC 15/3         54650003
*                                                                       54700003
*   TEST FOR RETRY OR SPACE                                             54750003
*                                                                       54800003
         TM    EWACNTR3,EWTROC         IOS USE RORCCW BIT ON?    Y02032 54850003
         BZ    C410                    NO - GO RETRY                    54900003
         NI    EWACNTR3,X'FF'-EWTROC   RESET IOS USE RORCCW      Y02032 54950003
         OI    IOSFLA,IOSREP+IOSCRC    SET REPOSITION BIT & CRC  Y02032 55000003
         OI    IOSOPT,IOSDEP           SET DEVICE END POST BIT   Y02032 55050003
*                                                                       55100003
*   WE HAVE JUST READ OPPOSITE.  IF SUPPRESS DATA TRANSFER              55150003
*   BIT IS OFF, WE HAVE RECOVERED THE UC-DC CONDITION.                  55200003
*                                                                       55250003
         TM    IOSTSB,CSWCDC           CHANNEL DATA CHECK?              55300003
         BO    C285                    YES - GO RESET USE RORCCW BIT    55350003
*                                                                       55400003
         TM    EWTRRFLS,RORSDT         SUPPRESS DATA TRANSFER?          55450003
         BO    C180                    YES - GO BUILD FINAL RORCCW      55500003
*                                                                       55550003
         TM    IOSTSA,CSWUEX           UNIT EXCEPTION?                  55600003
         BZ    C170                    NO - BRANCH                      55650003
         OI    EWACNTR3,EWTUEX         SET UNIT EXCEPTION FLAG   Y02032 55700003
*                                                                       55750003
C170     EQU   *                                                        55800003
         MVI   EWTRRCMD,ZERO           ZERO COMMAND (SWITCH)            55850003
         BR    EXITREG                 GO SPACE OVER RECORD             55900003
         EJECT                                                          55950003
*                                                                       56000003
*            B U I L D   F I N A L   R O R C C W                        56050003
*                                                                       56100003
C180     EQU   *                                                        56150003
         LH    R4,EWTRRCNT             GET ORIGINAL COUNT               56200003
         N     R4,MASK                 RESET HIGH ORDER BITS            56250003
         TM    IOSTSB,CSWICL           INCORRECT LENGTH?                56300003
         BZ    C200                    NO - BRANCH AROUND               56350003
*                                                                       56400003
         CLC   IOSCSWRC,FZERO          IS RESIDUAL COUNT ZERO           56450003
         BNE   C190                    NO - BRANCH AROUND               56500003
*                                                                       56550003
         MVI   EWACNTR2,NUMB40         SET MAXIMUM COUNT TO 40   Y02032 56600003
         B     C380                    BRANCH TO ONE FINAL RETRY        56650003
*                                                                       56700003
*   CCW COUNT IS GREATER THAN OR EQUAL TO THE BLOCK SIZE                56750003
*                                                                       56800003
C190     EQU   *                                                        56850003
         BAL   BALREG,F010             GO SET UP ADDRESSES       Y02032 56900003
*                                                                       56950003
C200     EQU   *                                                        57000003
         NI    EWTRRFLS,X'FF'-RORSDT   ENABLE DATA TRANSFER             57050003
         BR    EXITREG                 GO SPACE - SVC 15/3              57100003
         EJECT                                                          57150003
*                                                                       57200003
*                      U N I T   C H E C K                              57250003
*                                                                       57300003
*   EQUIPMENT CHECK IS A VALID ERROR ONLY WITH DEVICE END               57350003
*                                                                       57400003
C230     EQU   *                       E Q U I P M E N T   C H E C K    57450003
         TM    EWTSNS0,EWTEQU          EQUIPMENT CHECK?          Y02032 57500003
         BZ    C250                    NO - GO CONTINUE TEST            57550003
         TM    IOSTSA,CSWDVE           DEVICE END?                      57600003
         BNO   C250                    NO - GO CONTINUE TEST            57650003
*                                                                       57700003
*   RESTORE START ADDRESSES AND XCTL TO WTO                             57750003
*                                                                       57800003
C240     EQU   *                                                        57850003
         L     R13,EWTVIRT             GET ADDR OF USER CCW      Y02032 57900003
         ST    R13,IOSVST              RESTORE START ADR (VIRT)  Y02032 57950003
         LRA   R13,0(R13)              GET REAL ADDRESS          Y02032 58000003
         ST    R13,IOSRST              RESTORE START ADR (REAL)  Y02032 58050003
         B     A560                    GO XCTL TO WTO                   58100003
*                                                                       58150003
C250     EQU   *                       B U S   O U T   C H E C K        58200003
         TM    EWTSNS0,EWTBUSO         BUS OUT CHECK?            Y02032 58250003
         BNO   C270                    NO - GO CONTINUE TEST            58300003
         TM    EWACNTR1,OVRCNT5        LAST RETRY (5)?           Y02032 58350003
         BO    C260                    YES - SKIP COUNT UPDATE          58400003
*                                                                       58450003
*   UPDATE RETRY COUNT                                                  58500003
*                                                                       58550003
         IC    R13,EWACNTR1            GET RETRY COUNT           Y02032 58600003
         LA    R13,C16(R13)            ADD ONE TO COUNT                 58650003
         STC   R13,EWACNTR1            STORE NEW COUNT           Y02032 58700003
*                                                                       58750003
         CLI   CCWOP,CMDCTL            NOP COMMAND?                     58800003
         BCR   7,EXITREG               NO - GO RETRY                    58850003
         B     C410                    YES - SPACE OK, CONTINUE         58900003
*                                                                       58950003
C260     EQU   *                                                        59000003
         TM    EWACNTR3,EWTROC         USE RORCCW BIT ON?        Y02032 59050003
         BO    C417                    YES - BR TO PERM ERROR           59100003
C265     EQU   *                                                        59150003
         MVI   EWACNTR2,NUMB40         SET MAXIMUM COUNT TO 40   Y02032 59200003
         B     C380                    BRANCH TO ONE MORE READ          59250003
*                                                                       59300003
C270     EQU   *                       I N T E R V E N T I O N   R E Q  59350003
         TM    EWTSNS0,EWTINT          INTERVENTION REQUIRED?           59400003
         BNO   C280                    NO - GO CONTINUE TEST            59450003
         TM    IOSTSA,CSWDVE           DEVICE END?                      59500003
         BZ    A570                    NO - BRANCH TO PRINT MSG         59550003
*                                                                       59600003
C280     EQU   *                       O V E R R U N                    59650003
         TM    EWTSNS0,EWTOVRN         OVERRUN?                  Y02032 59700003
         BNO   C290                    NO - GO CONTINUE TEST            59750003
C285     EQU   *                                                        59800003
         NI    EWACNTR3,X'FF'-EWTROC   RESET USE RORCCW BIT      Y02032 59850003
         OI    IOSFLA,IOSREP           SET REPOSITION BIT        Y02032 59900003
         TM    EWACNTR1,OVRCNT5        LAST RETRY (5)?           Y02032 59950003
         BO    C265                    YES - GO SET TO PERM READ        60000003
*                                                                       60050003
*   UPDATE RETRY COUNT                                                  60100003
*                                                                       60150003
         IC    R13,EWACNTR1            GET RETRY COUNT           Y02032 60200003
         LA    R13,C16(R13)            ADD ONE TO COUNT                 60250003
         STC   R13,EWACNTR1            STORE NEW COUNT           Y02032 60300003
         BR    EXITREG                 GO RETRY OR SPACE                60350003
*                                                                       60400003
C290     EQU   *                       L O A D   P O I N T              60450003
         TM    EWTSNS1,EWTLP           LOAD POINT?               Y02032 60500003
         BO    A2020                   YES - GO TO PART 2 OF LOAD 2     60550003
*                                                                       60600003
*                                      D A T A   C H E C K              60650003
         TM    EWTSNS0,EWTDATA         DATA CHECK?               Y02032 60700003
         BNO   C310                    NO - GO CONTINUE TEST            60750003
         TM    EWTSNS1,EWTNOISE        NOISE BIT ON?             Y02032 60800003
         BO    C300                    YES - SKIP NOISE BLOCK TEST      60850003
*                                                                       60900003
*   TEST FOR NOISE BLOCK                                                60950003
*                                                                       61000003
         LH    R0,EWTRRCNT             GET RORCCW COUNT                 61050003
         N     R0,MASK                 RESET HIGH ORDER BITS            61100003
         SH    R0,IOSCSWRC             LESS RESIDUAL IN CSW             61150003
         SH    R0,TWELVE               SUBTRACT MINIMUM SIZE            61200003
         BC    11,C300                 BRANCH IF OK                     61250003
         B     A2020                   ELSE GO TO PART 2, LOAD 2        61300003
*                                                                       61350003
*   THE BLOCK WAS NOT NOISE                                             61400003
*                                                                       61450003
C300     EQU   *                                                        61500003
         NI    EWACNTR3,X'FF'-EWTROC   RESET USE RORCCW BIT      Y02032 61550003
*                                                                       61600003
*   ARE WE READY FOR A CLEANER?                                         61650003
*                                                                       61700003
         OI    IOSFLA,IOSREP           SET REPOSITION BIT        Y02032 61750003
         OI    IOSOPT,IOSDEP           SET DEVICE END POST BIT   Y02032 61800003
         TM    EWACNTR2,X4             MULTIPLE OF 4?            Y02032 61850003
         BO    C370                    YES - GO SET UP CLEANER          61900003
*                                                                       61950003
         IC    R13,EWACNTR2            GET CURRENT COUNT         Y02032 62000003
         LA    R13,C1(R13)             ADD ONE TO COUNT                 62050003
         STC   R13,EWACNTR2            STORE NEW COUNT           Y02032 62100003
         BR    EXITREG                 GO SPACE                         62150003
*                                                                       62200003
*   TEST FOR CHANNEL DATA CHECK WHEN INT. REQ. IS IGNORED               62250003
*                                                                       62300003
C310     EQU   *                       C H A N N E L   D A T A   C H K  62350003
         TM    IOSTSB,CSWCDC           CHANNEL DATA CHECK?              62400003
         BZ    C240                    NO - GO HANDLE PERM ERROR        62450003
         B     C285                    YES - GO RETRY                   62500003
         EJECT                                                          62550003
*                                                                       62600003
*                    C L E A N E R                                      62650003
*                                                                       62700003
*          SET UP FOR CLEANER UNLESS WE ARE DONE                        62750003
*                                                                       62800003
C370     EQU   *                                                        62850003
         TM    EWACNTR2,NUMB40         LAST RETRY?               Y02032 62900003
         BNO   C390                    NO - GO SET UP CLEANER           62950003
*                                                                       63000003
*   END OF RECOVERY ATTEMPTS - SET UP TO READ ORIGINAL                  63050003
*                                                                       63100003
C380     EQU   *                                                        63150003
         L     R13,EWTVIRT             GET ADDR OF USER CCW      Y02032 63200003
         ST    R13,IOSVST              RESTORE START ADR (VIRT)  Y02032 63250003
         LRA   R13,0(R13)              GET REAL ADDRESS          Y02032 63300003
         ST    R13,IOSRST              RESTORE START ADDR(REAL)  Y02032 63350003
         TM    IOSFLA,IOSCCHN          COMMAND CHAINING?                63400003
         BO    C460                    YES - GO SET RESTART FLAG        63450003
         B     C470                    NO-SET REP & CRC, FINISH CHAIN   63500003
*                                                                       63550003
*   SET UP CLEANER                                                      63600003
*                                                                       63650003
C390     EQU   *                                                        63700003
         IC    R13,EWACNTR2            GET COUNT                 Y02032 63750003
         LA    R13,C13(R13)            CARRY TO TENS POSITION           63800003
         STC   R13,EWACNTR2            STORE UPDATED COUNT       Y02032 63850003
         OI    EWAFLG3,EWTTPC          SET TAPE CLEAN BIT        Y02032 63900003
         LH    R13,UCBCLN              GET ESV CLEANER COUNT            63950003
         CH    R13,MASK+C2             IS COUNT FULL?                   64000003
         BE    C400                    YES - BR AROUND COUNT INCREMENT  64050003
         LA    R13,C1(R13)             ADD ONE TO COUNT                 64100003
         STH   R13,UCBCLN              STORE BACK                       64150003
*                                                                       64200003
*   SET UP NUMBER OF BACK SPACES                                        64250003
*                                                                       64300003
C400     EQU   *                                                        64350003
         OI    EWACNTR1,CLNCNT4        ASSUME RD FWD - SET COUNT TO 4   64400003
         CLI   EWTRRCMD,CMDRED         IS IT READ FORWARD?              64450003
         BCR   8,EXITREG               YES - START CLEANER              64500003
*                                                                       64550003
         MVI   IOSMDB,CMDBSR           NO - SET BACK SPACE              64600003
         NI    EWACNTR1,HEXF8          SET COUNT TO 0            Y02032 64650003
         OI    EWACNTR1,CLNCNT3        SET COUNT TO 3 FOR RD BACK CLEAN 64700003
         OI    EWAFLG3,EWTBKS          SET BKSP ERASE CLEANER    Y02032 64750003
         BR    EXITREG                 START CLEANER                    64800003
*                                                                       64850003
*   END OF CLEANER                                                      64900003
         EJECT                                                          64950003
*                                                                       65000003
*   WE HAVE JUST SPACED OVER THE ERROR BLOCK.                           65050003
*   IF THE RORCCW COMMAND IS ZERO, WE HAVE RECOVERED.                   65100003
*                                                                       65150003
C410     EQU   *                                                        65200003
         CLI   EWTRRCMD,ZERO           IS THE COMMAND ZERO?             65250003
         BNE   C480                    NO - BR TO CONTINUE ROR          65300003
         EJECT                                                          65350003
*                                                                       65400003
*                      R E C O V E R Y                                  65450003
*                                                                       65500003
*        CLEAN UP AFTER RECOVERY IN OPPOSITE DIRECTION                  65550003
*                                                                       65600003
         NI    IOSFLA,X'FF'-IOSREP-IOSCRC     RESET REP & CRC           65650003
*                                                                       65700003
*   RESTORE DEVICE END POST BIT                                         65750003
*                                                                       65800003
         TM    EWACNTR3,EWTDEP         WAS IT ON ORIGINALLY?     Y02032 65850003
         BO    C415                    YES - LEAVE IT ON         Y02032 65900003
         NI    IOSOPT,X'FF'-IOSDEP     NO  - TURN IT OFF         Y02032 65950003
C415     EQU   *                                                        66000003
         NI    EWAFLG3,X'FF'-EWTROR    RESET ROR IN PROGRESS     Y02032 66050003
         TM    IOSTSB,CSWICL           INCORRECT LENGTH?         Y02032 66100003
         BO    C417                    YES - LEAVE CNTR SET      Y02032 66150003
         NI    EWACNTR1,HEX88          SET BUS OUT & CLNR CNT TO 0      66200003
*                                                                       66250003
C417     EQU   *                                                        66300003
         L     R13,EWTVIRT             GET ADDR OF USER CCW      Y02032 66350003
         ST    R13,IOSVST              RESTORE START ADR (VIRT)  Y02032 66400003
         LRA   R13,0(R13)              GET REAL ADDRESS          Y02032 66450003
         ST    R13,IOSRST              RESTORE START ADR (REAL)  Y02032 66500003
*                                                                       66550003
*   PERMANENT BUS OUT ON RORCCW COMES HERE                              66600003
*                                                                       66650003
C420     EQU   *                                                        66700003
         L     CCWREG,IOSVST           GET START ADDRESS                66750003
         LA    R13,C8(CCWREG)          GET ERR CCW ADDRESS + 8          66800003
         IC    R4,IOSCSW-C1            GET IOSCC                        66850003
         ST    R13,IOSCSW-C1           STORE ERR CCW ADDRESS + 8        66900003
         STC   R4,IOSCSW-C1            RESTORE IOSCC                    66950003
*                                                                       67000003
*   TEST FOR PERMANENT BUS OUT                                          67050003
*                                                                       67100003
         TM    EWACNTR1,OVRCNT5        PERMANENT BUS OUT (5 RETRIES)?   67150003
         BO    C240                    YES - BR TO PERMANENT ERROR      67200003
*                                                                       67250003
*   CONTINUE CLEANUP                                                    67300003
*                                                                       67350003
         LH    R0,CCWCNT               GET ORIGINAL COUNT               67400003
         N     R0,MASK                 ZERO HIGH ORDER BITS             67450003
         SH    R0,EWTRRCNT             SUBTRACT RORCCW COUNT            67500003
         STH   R0,IOSCSWRC             SET RESIDUAL COUNT               67550003
         BZ    C440                    BRANCH IF RESIDUAL IS ZERO       67600003
*                                                                       67650003
         TM    CCWFLS,CCWSILI          SILI BIT ON?                     67700003
         BO    C440                    YES - BR AROUND INCORRECT LENGTH 67750003
         OI    IOSTSB,CSWICL           NO - SET INCORRECT LENGTH        67800003
*                                                                       67850003
C440     EQU   *                                                        67900003
         TM    EWACNTR3,EWTUEX         UNIT EXCEPTION FLAG ON?   Y02032 67950003
         BO    PART4                   YES - GO TO PART 4               68000003
*                                                                       68050003
         TM    IOSTSB,CSWICL           INCORRECT LENGTH?                68100003
         BO    PART4                   YES - GO TO PART 4               68150003
*                                                                       68200003
         TM    IOSFLA,IOSCCHN          COMMAND CHAINING?                68250003
         BZ    PART4                   NO - GO TO PART 4                68300003
*                                                                       68350003
         TM    CCWFLS,IOSCCHN          CCW CHAINED?                     68400003
         BZ    PART4                   NO - GO TO PART 4                68450003
*                                                                       68500003
*   SET UP TO FINISH CHAIN                                              68550003
*                                                                       68600003
         LA    CCWREG,C8(CCWREG)       GET NEXT CCW ADDR                68650003
         CLI   CCWOP,CMDTIC            NEXT COMMAND A TIC?              68700003
         BNE   C450                    NO - BRANCH AROUND TIC           68750003
*                                                                       68800003
*   TRANSLATE REAL ADDRESS IN TIC TO VIRTUAL                            68850003
*                                                                       68900003
         LR    R4,IOSREG               SAVE IOSB ADDRESS                68950003
         L     R1,CCWADR               GET ADDRESS FROM TIC             69000003
         LA    R1,0(R1)                ZERO HI-ORDER BYTE               69050003
         LR    R8,BASREG               SAVE BASE ADDRESS                69100003
         L     BASREG,LOC16            GET ADDRESS OF CVT               69150003
         L     BASREG,CVTPTRV(BASREG)  GET ADDR OF TRANSLATE RTN.       69200003
         BALR  LNKREG,BASREG           LINK TO TRANSLATE ROUTINE        69250003
         LR    CCWREG,R1               GET VIRTUAL CCW ADDRESS          69300003
         LR    BASREG,R8               RESTORE BASE REGISTER            69350003
         LR    IOSREG,R4               RESTORE IOSB REGISTER            69400003
*                                                                       69450003
C450     EQU   *                                                        69500003
         ST    CCWREG,IOSVST           SET CONTINUE CCW ADDRESS         69550003
         LRA   R13,CCW                 TRANSLATE VIRT START ADR  Y02032 69600003
         ST    R13,IOSRST              STORE IN REAL START ADR   Y02032 69650003
         NI    EWAFLG3,EWTOVER         RESET ALL BUT SDR OVERFLOW       69700003
         XC    EWACNTR1,EWACNTR1       RESET ERROR COUNTERS      Y02032 69750003
*                                                                       69800003
C460     OI    EWACNTR3,EWTRST         SET RESTART FLAG ON       Y02032 69850003
*                                                                       69900003
C470     EQU   *                                                        69950003
         NI    IOSFLA,X'FF'-IOSREP-IOSCRC     RESET REP & CRC           70000003
         NI    EWAFLG3,X'FF'-EWTROR    RESET ROR IN PROGRESS     Y02032 70050003
         B     A166                    GO FINISH CHAIN - SVC 15/3       70100003
*                                                                       70150003
*   END OF RECOVERY                                                     70200003
         EJECT                                                          70250003
*                                                                       70300003
*   WE HAVE JUST SPACED.  CHECK FOR CLEANER IN PROGRESS                 70350003
*                                                                       70400003
C480     EQU   *                                                        70450003
         TM    EWACNTR1,CLNCNT0        IS CLEANER CONTROL COUNT ZERO?   70500003
         BZ    C490                    YES - BR AROUND COUNT UPDATE     70550003
*                                                                       70600003
*   DECREMENT CLEANER CONTROL COUNT                                     70650003
*                                                                       70700003
C485     EQU   *                                                        70750003
         IC    R0,EWACNTR1             GET CONTROL COUNT         Y02032 70800003
         BCTR  R0,R0                   DECREMENT                        70850003
         STC   R0,EWACNTR1             STORE NEW COUNT           Y02032 70900003
         BR    EXITREG                 CONTINUE - SVC 15/3              70950003
*                                                                       71000003
*   TEST FOR END OF CLEANER BSRS                                        71050003
*                                                                       71100003
C490     EQU   *                                                        71150003
         TM    EWAFLG3,EWTTPC          CLEANER BIT ON?           Y02032 71200003
         BZ    C510                    NO - GO SET UP TO READ OPPOSITE  71250003
*                                                                       71300003
*   CHANGE CLEANER DIRECTION                                            71350003
*                                                                       71400003
         MVI   IOSMDB,CMDFSR           SET FORWARD SPACE                71450003
         OI    EWACNTR1,CLNCNT4        SET COUNT TO 4            Y02032 71500003
         TM    EWAFLG3,EWTBKS          READ BACK CLEANER?        Y02032 71550003
         BO    C500                    YES - BRANCH AROUND              71600003
*                                                                       71650003
         NI    EWACNTR1,HEXF8          SET COUNT TO 0            Y02032 71700003
         OI    EWACNTR1,CLNCNT3        SET COUNT TO 3 - RD BK    Y02032 71750003
*                                                                       71800003
C500     EQU   *                                                        71850003
         NI    EWAFLG3,X'FF'-EWTTPC-EWTBKS      CLEAR FLAGS      Y02032 71900003
         BR    EXITREG                 EXIT VIA SVC 15/3                71950003
*                                                                       72000003
*   SET SPACE DIRECTION AND SET UP TO READ OPPOSITE                     72050003
*   RESTORE DEVICE END POST BIT                                         72100003
*                                                                       72150003
C510     EQU   *                                                        72200003
         OI    EWACNTR3,EWTROC         SET USE RORCCW BIT        Y02032 72250003
         OI    IOSFLA,IOSCRC           SET CRC                          72300003
         NI    IOSFLA,X'FF'-IOSREP     RESET REPOSITION                 72350003
*                                                                       72400003
         TM    EWACNTR3,EWTDEP         WAS DEP BIT ON ORIGINALLY?       72450003
         BO    C520                    YES - LEAVE IT ON         Y02032 72500003
         NI    IOSOPT,X'FF'-IOSDEP     NO  - TURN IT OFF         Y02032 72550003
*                                                                       72600003
C520     EQU   *                                                        72650003
         MVI   IOSMDB,CMDFSR           SET FORWARD SPACE                72700003
         CLI   EWTRRCMD,CMDRDB         RORCCW READ BACK?                72750003
         BE    RETN                    YES - EXIT VIA SVC 15/3          72800003
         MVI   IOSMDB,CMDBSR           NO - SET BACK SPACE              72850003
         BR    EXITREG                 SVC 15/3                         72900003
*************    E N D   O F   P A R T    3    *************            72950003
         EJECT                                                          73000003
*********************************************************************** 73050003
*                          P A R T   4                                * 73100003
*                                                                     * 73150003
*                       TEMPORARY ERRORS                              * 73200003
*********************************************************************** 73250003
*        THIS SECTION HANDLES THE FOLLOWING CONDITIONS                * 73300003
*              1.  UNIT EXCEPTION (NO ERROR)                          * 73350003
*              2.  INCORRECT LENGTH (NO ERROR)                        * 73400003
*              3.  TEMPORARY ERRORS - RECOVERED                       * 73450003
*        BY UPDATING SDR COUNTERS AND VES COUNTERS, THEN              * 73500003
*        EXITING THE ERP VIA OBR, WTO OR SVC 15/3.                    * 73550003
*********************************************************************** 73600003
*                                                                       73650003
*   TEST STATUS INFORMATION                                             73700003
*                                                                       73750003
PART4    EQU   *                                                        73800003
         TM    IOSTSB,CSWSTB           CDC, CHC, PGC, OR PTC?           73850003
         BC    5,A2000                 YES - GO TO LOAD 2, PART 4B      73900003
*                                                                       73950003
         TM    IOSTSA,CSWUEX           UNIT EXCEPTION?                  74000003
         BO    D260                    YES - GO CHECK IF 1ST ENTRY ERR  74050003
*                                                                       74100003
         TM    IOSTSB,CSWICL           INCORRECT LENGTH?                74150003
         BO    D260                    YES - GO CHECK IF 1ST ENTRY ERR  74200003
*                                                                       74250003
*   END OF TEST - RECOVERED                                             74300003
*                                                                       74350003
D130     EQU   *                                                        74400003
*                                                                       74402003
*              ZERO ERROR COUNTERS (2 BYTES)                   @ZA00656 74410003
*                                                                       74412003
         XC  EWACNTR1(2),EWACNTR1                              @ZA00656 74420003
         NI    EWACNTR3,X'FF'-EWTRST   RESET RESTART BIT         S21048 74500003
         NI    IOSFLA,X'FF'-IOSERR-IOSEX   SET FOR TEMP ERROR EXIT      74550003
*                                                                       74600003
*                                                                       74900003
         CLI   CCWOP,X'17'             ERG?                      S21048 74950003
         BE    D240                    YES-GO UPDTE SDR CNTRS    S21048 75000003
*                                                                       75050003
         TM    EWTSNS1,EWTWRT          WAS IT A WRITE TYPE CMD?  S21048 75100003
         BO    D240                    YES-GO UPDTE SDR CNTRS    S21048 75150003
*                                                                       75200003
         TM    IOSFLA,IOSDCHN          DATA CHAINING?          @ZA30317 75210037
         BO    D200                    YES-GO UPDTE SDR CNTRS  @ZA30317 75220037
         CLI   CCWOP,CMDRDF            IS IT RDF OR CHAINED READ?       75250003
         BC    12,D200                 YES-GO UPDTE SDR CNTRS    S21048 75300003
*                                                                       75350003
         CLI   CCWOP,CMDRDB            IS IT A RDB?                     75400003
         BNE   D300                    NO - GO EXIT ERP                 75450003
*                                                                       75500003
*   TEMPORARY READ EXIT ROUTINE                                         75550003
*                                                                       75600003
D200     EQU   *                                                        75650003
         TM    UCBTBYT4,UCB3400        3400 TAPE UNIT?                  75700003
         BO    D210                    YES - GO UPDATE VES COUNTERS     75750003
*                                                                       75800003
         IC    R4,0(SDRREG)            GET TEMP RD/WT COUNT      S21048 75850003
         LA    R4,C16(R4)              STEP READ COUNT           S21048 75900003
         STC   R4,0(SDRREG)            STORE BACK                S21048 75950003
         TM    0(SDRREG),RDFULL        IS COUNT FULL?            S21048 76000003
         BM    D210                    NO - SKIP OVERFLOW        S21048 76050003
         OI    EWAFLG3,EWTOVER         YES - SET SDR OVERFLOW    S21048 76100003
*                                                                       76150003
D210     EQU   *                                                        76200003
         TM    UCBTR,FULL              IS TEMP READ COUNT FULL?  S21048 76250003
         BO    D300                    YES - GO EXIT ERP         S21048 76300003
*                                                                       76350003
         IC    R4,UCBTR                GET TEMP READ COUNT       S21048 76400003
         LA    R4,C1(R4)               ADD ONE TO COUNT          S21048 76450003
         STC   R4,UCBTR                STORE BACK                S21048 76500003
         B     D300                    GO EXIT ERP                      76550003
*                                                                       76600003
*   TEMPORARY WRITE EXIT ROUTINE                                        76650003
*                                                                       76700003
D240     EQU   *                                                        76750003
         TM    UCBTBYT4,UCB3400        3400 TAPE UNIT?           S21048 76800003
         BO    D250                    YES - GO UPDATE VES COUNTERS     76850003
*                                                                       76900003
         IC    R4,0(SDRREG)            GET TEMP RD/WT COUNT      S21048 76950003
         LA    R4,C1(R4)               STEP WRITE COUNT          S21048 77000003
         STC   R4,0(SDRREG)            STORE BACK                S21048 77050003
         TM    0(SDRREG),WRFULL        IS COUNT FULL?            S21048 77100003
         BM    D250                    NO - SKIP OVERFLOW        S21048 77150003
         OI    EWAFLG3,EWTOVER         YES - SET SDR OVERFLOW    S21048 77200003
*                                                                       77250003
D250     EQU   *                                                        77300003
         TM    UCBTW,FULL              IS COUNT FULL?            S21048 77350003
         BO    D300                    YES - GO EXIT ERP         S21048 77400003
*                                                                       77450003
         IC    R4,UCBTW                GET WRITE COUNT           S21048 77500003
         LA    R4,C1(R4)               ADD ONE TO COUNT          S21048 77550003
         STC   R4,UCBTW                STORE BACK                S21048 77600003
         B     D300                    GO EXIT ERP                      77650003
*                                                                       77700003
*   UNIT EXCEPTION OR INCORRECT LENGTH -                                77750003
*   IF EWACNTR1 IS ZERO, THIS IS A FIRST ENTRY ERROR                    77800003
*                                                                       77850003
D260     EQU   *                                                        77900003
*                                                                       77910003
*              TEST ERROR COUNTERS (2 BYTES) FOR ZERO          @ZA00656 77920003
*                                                                       77930003
         NC    EWACNTR1(2),EWACNTR1                            @ZA00656 77940003
         BNZ   D130                    NO - CONTINUE                    78000003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA SET PERM ERR EXIT   @YM06412 78050003
         MVI   EWAFLG3,ZERO            CLEAR ERROR FLAGS         Y02032 78100003
         EJECT                                                          78150003
*                             E X I T                                   78200003
*                    TEMPORARY READS AND WRITES                         78250003
*                                                                       78300003
D300     EQU   *                                                        78350003
         TM    IOSFLB,IOSLOG           LOG ON?                   S21048 78400003
         BO    D310                    YES - EXIT VIA OBR               78450003
         TM    EWAFLG3,EWTOVER         SDR OVERFLOW ON?          Y02032 78500003
         BZ    RETN                    NO - EXIT VIA SVC 15/3           78550003
D310     EQU   *                                                        78600003
         LA    R13,SERLOG              GET ADDRESS OF OBR        S21048 78650003
         B     XCTL1                   XCTL TO OBR               S21048 78700003
         EJECT                                                          78750003
*********************************************************************** 78800003
*                            P A R T   5                              * 78850003
*                                                                     * 78900003
*                         STATISTICS UPDATE                           * 78950003
*********************************************************************** 79000003
*                                                                     * 79050003
*        UPDATE SDR COUNTERS AND SET AN OVERFLOW FLAG IF ANY          * 79100003
*        COUNTER IS STEPPED FULL.  A RECORDING WILL BE MADE           * 79150003
*        AT ERP EXIT TIME IF OVERFLOW IS ON.                          * 79200003
*********************************************************************** 79250003
PART5    EQU   *                                                        79300003
         TM    IOSTSA,CHEND+CSWUCK     CHANNEL END & UNIT CHECK?        79350003
         BNO   E110                    NO - GO FIND SDR COUNTER ADDR    79400003
*                                                                       79450003
         LH    R4,UCBSIO               YES - GET SIO COUNT              79500003
         LA    R4,C1(R4)               ADD ONE                          79550003
         STH   R4,UCBSIO               STORE BACK                       79600003
*                                                                       79650003
*   TEST FOR NEW DEVICES AND GET CORRECT                                79700003
*   SDR COUNTER TABLE FOR THE DEVICE                                    79750003
*                                                                       79800003
E110     EQU   *                                                        79850003
         TM    UCBTBYT4,UCB3400        3400 TAPE UNIT?                  79900003
         BO    E160                    YES - BR TO 3420 UPDATE          79950003
*                                                                       80000003
*   DO UPDATE FOR 2400 SDR COUNTERS                                     80050003
*                                                                       80100003
         TM    IOSTSA,CSWUCK           IS UNIT CHECK ON?                80150003
         BZ    E150                    NO - BR AROUND STAT UPDATE       80200003
         LA    TABREG,TAB2400          ADDR OF 2400 SDR DATA TABLE      80250003
         BAL   RETREG,STATUPD          GO UPDATE SDR                    80300003
*                                                                       80350003
*   DO AN UPDATE TO THE CHANNEL DATA CHECK SDR COUNTER                  80400003
*   IF THE CHANNEL DATA CHECK BIT IS ON IN STATUS                       80450003
*                                                                       80500003
E150     EQU   *                                                        80550003
         TM    IOSTSB,CHDAT            CHANNEL DATA CK ON IN STATUS?    80600003
         BZ    BEGIN                   NO - GO TO BEGINNING OF LOAD 1   80650003
*                                                                       80700003
         SR    R13,R13                 ZERO WORK REG                    80750003
         IC    R13,CDCNT(SDRREG)       GET SDR COUNTER FOR CDC          80800003
         LA    R13,C1(R13)             ADD ONE                          80850003
         STC   R13,CDCNT(SDRREG)       STORE BACK                       80900003
         TM    CDCNT(SDRREG),CDFULL    IS COUNT FULL?                   80950003
         BNO   BEGIN                   NO - GO TO BEGINNING OF LOAD 1   81000003
*                                                                       81050003
         OI    EWAFLG3,EWTOVER         SET SDR OVERFLOW BIT ON   Y02032 81100003
         B     BEGIN                   GO TO BEGINNING OF LOAD 1        81150003
         EJECT                                                          81200003
*                                                                       81250003
*   DO UPDATE TO SDR COUNTERS FOR NEW DEVICES (3420)                    81300003
*                                                                       81350003
E160     EQU   *                                                        81400003
         OI    0(SDRREG),SDR20         SET 20-BYTE SDR FLAG             81450003
         TM    IOSTSA,CSWUCK           UNIT CHECK?                      81500003
         BZ    BEGIN                   NO - GO TO BEGINNING OF LOAD 1   81550003
         CLI   EWTSNS0,EWTINT          INTERVENTION REQUIRED?  @YL02128 81600003
         BE    BEGIN                   YES, NO SDR RECORDING   @YL02128 81650003
         LA    TABREG,TAB3420          ADDR OF 3420 SDR DATA TABLE      81700003
         BAL   RETREG,STATUPD          GO UPDATE SDR                    81750003
*                                                                       81800003
*   DO UPDATE TO SDR COUNTERS FOR PE ID BURST CHECK                     81850003
*                                                                       81900003
         TM    EWTSNS5,EWTPEID         PE ID BURST CHECK ON?     Y02032 81950003
         BZ    E170                    NO - BR AROUND SDR COUNT         82000003
         OI    SDRPI(SDRREG),ON        SET SDR COUNT                    82050003
*                                                                       82100003
*   DO UPDATE TO SDR COUNTERS FOR TRACK IN ERROR BYTE                   82150003
*                                                                       82200003
E170     EQU   *                                                        82250003
         TM    EWTSNS2,TIE             TIE BYTE BIT TEST                82300003
         BO    BEGIN                   BR ON BYTE FULL                  82350003
         BNZ   E171                    NOT '00' OR 'FF'                 82400003
         OI    SDRPI(SDRREG),PARON     SET PARITY BIT                   82450003
         B     E180                    SET REST OF RECORD               82500003
E171     CLI   EWTSNS2,INVAL           IS TIE BYTE INVALID?    @YA00088 82550003
         BNE   E180                    BR VALID TO RECORD      @YA00088 82600003
         TM    EWTSNS9,BIRCH           3803-II CONTROL UNIT?   @YL02128 82650003
         BZ    BEGIN                   NO, DO NOT RECORD       @YL02128 82700003
         TM    EWTSNS6,BIRCH           BIRCH DRIVE?            @YL02128 82750003
         BZ    BEGIN                   NO, DO NOT RECORD       @YL02128 82800003
         TM    EWTSNS6,NRZIMODE        IS IT NRZI MODE?        @YL02128 82850003
         BO    BEGIN                   YES, DO NOT RECORD      @YL02128 82900003
*                                                                       82950003
E180     EQU   *                                                        83000003
         OC    SDRPI+C1(C1,SDRREG),EWTSNS2    PUT IN SDR COUNTER        83050003
         B     BEGIN                   GO TO PART 1                     83100003
         EJECT                                                          83150003
*********************************************************************** 83200003
*             S T A T   U P D A T E   R O U T I N E                   * 83250003
*                                                                     * 83300003
*        EACH DEVICE TYPE HAS ITS OWN TABLE CONTAINED IN THIS ERP     * 83350003
*        LOAD TO DEFINE ITS OWN SDR TABLE.  YOU LINK TO THE STAT      * 83400003
*        UPDATE ROUTINE VIA REG. 12 AND WITH THE DEFINE TABLE         * 83450003
*        ADDRESS CONTAINED IN REG 13.                                 * 83500003
*                                                                     * 83550003
*        AS EACH COUNT IS ADDED, THE COUNTER IS CHECKED FOR           * 83600003
*        OVERFLOW.  A RECORDING WILL BE MADE AT ERP EXIT TIME         * 83650003
*        IF OVERFLOW IS ON.                                           * 83700003
*                                                                     * 83750003
*        EACH COUNTER IN AN SDR TABLE IS DEFINED BY 2 BYTES IN        * 83800003
*        A DEVICE-DEPENDENT TABLE.                                    * 83850003
*                                                                     * 83900003
*              BYTE A  0-2 = SENSE BIT POSITION                       * 83950003
*                      3-7 = SDR COUNTER LENGTH                       * 84000003
*                                                                     * 84050003
*              BYTE B  0   = IF ON, SKIP - AN UNUSED COUNTER          * 84100003
*                      1   = N/A                                      * 84150003
*                      2-7 = SENSE BYTE POSITION                      * 84200003
*                      0-7 = IF FULL BYTE=FF, END OF COUNTERS         * 84250003
*********************************************************************** 84300003
*                                                                       84350003
STATUPD  EQU   *                                                        84400003
         LR    SDRR14,SDRREG           MOVE SDR ADDR INTO WORK REG      84450003
         XC    EWTTST,EWTTST           INITIALIZE TO ZERO        Y02032 84500003
*                                                                       84550003
*   INITIALIZE FOR START OF UPDATE TO COUNTERS                          84600003
*                                                                       84650003
         LA    R3,WORD                 NUMB OF BITS PER FULL WORD       84700003
         SR    R4,R4                   ZERO SHIFT WORK REG              84750003
         MVC   EWTWORD(C4),0(SDRR14)   MOVE WORD TO BOUNDARY     Y02032 84800003
         L     R5,EWTWORD              GET FIRST WORD OF COUNTERS       84850003
*                                                                       84900003
*   DO SDR UPDATE                                                       84950003
*                                                                       85000003
STAT130  EQU   *                                                        85050003
         L     R12,UCBEXTPT            GET ADDR OF UCB COMMON EXTN.     85100003
         LA    R12,0(R12)              GET 3-BYTE ADDRESS               85150003
         IC    R8,SNSCT(R12)           GET SENSE COUNT                  85200003
         BCTR  R8,R0                   REDUCE SENSE COUNT BY 1          85250003
         LA    R0,HIBIT                R0 = 00 00 00 80 (1000 0000)     85300003
         SR    R9,R9                   ZERO REG                         85350003
         IC    R9,0(TABREG)            GET SENSE BIT POSITION           85400003
         SRL   R9,C5                   RIGHT JUSTIFY BITS               85450003
         LTR   R9,R9                   IS IT ZERO?                      85500003
         BZ    STAT150                 BR IF ZERO - SNS BIT 0           85550003
*                                                                       85600003
STAT140  EQU   *                                                        85650003
         SRL   R0,C1                   SHIFT 1000 0000 RIGHT 1 TIME     85700003
         BCT   R9,STAT140              BRANCH TILL DONE                 85750003
*                                                                       85800003
STAT150  EQU   *                                                        85850003
         STC   R0,EWTTST               SAVE R0 (SNS BIT POS POINTER)    85900003
         TM    C1(TABREG),CNTEND       IS THIS END OF COUNTERS?         85950003
         BCR   1,RETREG                YES - BRANCH BACK TO BALR        86000003
*                                                                       86050003
         NI    EWACNTR3,X'FF'-EWTBIT   ZERO 'BIT ON' FLAG        Y02032 86100003
         TM    C1(TABREG),CTROK        IS THIS COUNTER FOR REAL?        86150003
         BO    STAT160                 NO - BR, IT'S A FULL WORD FILLER 86200003
         SR    R9,R9                   ZERO REG                         86250003
         IC    R9,C1(TABREG)           GET SENSE BYTE NUMBER            86300003
         N     R9,MASK2                MASK2 = 00 00 00 3F              86350003
         CR    R9,R8                   IS SENSE BYTE COUNT VALID?       86400003
         BH    STAT160                 NO - BRANCH AROUND SENSE         86450003
         LA    R0,EWTSNS               GET SENSE ADDRESS         Y02032 86500003
         AR    R9,R0                   ADD TO SENSE ADDRESS             86550003
         NC    EWTTST(C1),0(R9)        WAS SENSE BIT ON?                86600003
         BZ    STAT160                 NO - BR AROUND BIT ON FLAG       86650003
         OI    EWACNTR3,EWTBIT         SET 'BIT ON' FLAG ON      Y02032 86700003
*                                                                       86750003
STAT160  EQU   *                                                        86800003
         SR    R9,R9                   ZERO REG                         86850003
         IC    R9,0(TABREG)            GET COUNTER LENGTH               86900003
         N     R9,MASK1                MASK1 = 00 00 00 1F              86950003
         SR    R8,R8                   ZERO REG                         87000003
*                                                                       87050003
STAT170  EQU   *                                                        87100003
         SLL   R8,C1                   SHIFT REG ONE TIME               87150003
         SLDL  R4,C1                   SHIFT COUNTER R5 TO R4 LO-ORDER  87200003
         LA    R8,C1(R8)               AND GENERATE MASK IN R8          87250003
         BCTR  R3,ZERO                 REDUCE FULL WORD BIT COUNTER     87300003
         BCT   R9,STAT170              SHIFT UNTIL WHOLE COUNTER        87350003
*                                                                       87400003
         TM    EWACNTR3,EWTBIT         DO WE ADD TO COUNTER      Y02032 87450003
         BZ    STAT180                 NO - BR AROUND COUNTER INCREMENT 87500003
         A     R4,ONE                  ADD 1 TO COUNTER                 87550003
         ST    R8,EWTMASK              SAVE COUNTER MASK         Y02032 87600003
         NR    R8,R4                   SAVE ONLY COUNTER IN 48          87650003
         C     R8,EWTMASK              IS COUNTER FULL?          Y02032 87700003
         BNE   STAT180                 NO - BR AROUND OVERFLOW FLAG     87750003
         OI    EWAFLG3,EWTOVER         YES - SET SDR OVERFLOW FLAG      87800003
*                                                                       87850003
STAT180  EQU   *                                                        87900003
         LTR   R3,R3                   IS FULL WORD DONE?               87950003
         BNZ   STAT190                 NO - BR AROUND RESET FULL WORD   88000003
         ST    R4,EWTWORD              STORE UPDATED COUNTERS BACK      88050003
         MVC   0(C4,SDRR14),EWTWORD    MOVE WORD BACK            Y02032 88100003
         LA    SDRR14,C4(SDRR14)       STEP TO NEXT FULL WORD           88150003
         LA    R3,WORD                 NUMBER OF BITS PER FULL WORD     88200003
         SR    R4,R4                   ZERO SHIFT WORK REGISTER         88250003
         MVC   EWTWORD(C4),0(SDRR14)   MOVE WORD TO BOUNDARY     Y02032 88300003
         L     R5,EWTWORD              PUT WORD IN WORK REG      Y02032 88350003
*                                                                       88400003
STAT190  EQU   *                                                        88450003
         LA    TABREG,C2(TABREG)       STEP TABLE TO NEXT COUNTER       88500003
         B     STAT130                 BRANCH TO NEXT COUNTER           88550003
         EJECT                                                          88600003
*********************************************************************** 88650003
*                            P A R T   6                              * 88700003
*                                                                     * 88750003
*                           ADDRESSABILITY                            * 88800003
*                        CREATE ERP IDAL LIST                         * 88850003
*********************************************************************** 88900003
*                                                                     * 88950003
*        THIS SECTION IS ENTERED TO SET UP ADDRESSABILITY.            * 89000003
*        IF BIT 37 OF THE CCW IS ON, THIS INDICATES THAT AN           * 89050003
*        IDAL LIST IS BEING USED & AN ERP IDAL LIST MUST BE           * 89100003
*        CREATED FOR ROR.                                             * 89150003
*********************************************************************** 89200003
PART6    EQU   *                                                        89250003
         NI    EWTRRFLS,ROR0F          TURN OFF FLAG BITS        Y02032 89300003
         OI    EWTRRFLS,RORSDT         SET FLAG TO SKIP DATA XFER       89350003
         MVI   EWTRRCCW,CMDRDB         SET READ BACKWARD         Y02032 89400003
*                                                                       89450003
*   TEST ORIGINAL DIRECTION                                             89500003
*                                                                       89550003
         CLI   CCWOP,CMDRED            IS IT READ?                      89600003
         BE    F005                    YES - BRANCH AROUND              89650003
         MVI   EWTRRCMD,CMDRED         NO - SET READ IN ROR CCW         89700003
F005     EQU   *                                                        89750003
         OI    EWAFLG3,EWTROR          SET READ OPPOSITE REC.    Y02032 89800003
F010     EQU   *                                                        89850003
         L     R13,EWTVIRT             GET ADDR OF FAILING CCW @ZA14734 89910003
         TM    C4(R13),CCWIDAL         IS IDAL BIT ON IN CCW?    Y02032 89950003
         BO    F030                    YES - GO SET UP IDALS     Y02032 90000003
*                                                                       90050003
         LH    R4,EWTRRCNT             GET ORIGINAL COUNT               90100003
         N     R4,MASK                 RESET HIGH ORDER BITS            90150003
         SH    R4,IOSCSWRC             SUBTRACT RESIDUAL                90200003
         STH   R4,EWTRRCNT             STORE ACTUAL COUNT               90250003
*                                                                       90300003
         IC    R0,EWTRRCMD             SAVE COMMAND              Y02032 90350003
         L     R13,EWTVIRT             GET ADDR OF FAILING CCW @ZA14734 90400003
         L     R13,0(R13)              GET DATA ADDR FROM CCW    Y02032 90450003
         LA    R13,0(R13)              ZERO HI-ORDER BYTE        Y02032 90500003
         BCTR  R4,R0                   REDUCE COUNT BY 1         Y02032 90550003
*                                                                       90600003
         CLI   EWTRRCMD,CMDRED         READ FORWARD?                    90650003
         BNE   F012                    NO - GO BUILD READ BKWD ADDR     90700003
*                                                                       90750003
*   BUILD READ FORWARD ADDRESS (ADDRESS-COUNT+1)                        90800003
*                                                                       90850003
         SR    R13,R4                  ADDRESS - (COUNT-1)              90900003
         B     F014                    GO SPACE                         90950003
*                                                                       91000003
*   BUILD READ BACKWARD ADDRESS  (ADDRESS+COUNT-1)                      91050003
*                                                                       91100003
F012     EQU   *                                                        91150003
         AR    R13,R4                  ADDRESS + (COUNT-1)              91200003
F014     EQU   *                                                        91250003
         ST    R13,EWTRRADR            STORE ADDRESS                    91300003
         STC   R0,EWTRRCMD             RESTORE COMMAND                  91350003
         BR    BALREG                  RETURN                           91400003
*                                                                       91450003
*   CALCULATE CSW RESIDUAL COUNT WHEN REBUILDING                        91500003
*   IDAL AFTER ISSUING SVC 35 (WTO WIPES OUT IDAL)                      91550003
*                                                                       91600003
F020     EQU   *                                                        91650003
         L     R13,EWTVIRT             GET ADDR OF FAILING CCW @ZA14734 91700003
         LH    R4,C6(R13)              GET USER CCW BYTE COUNT   Y02032 91750003
         SH    R4,EWTRRCNT             SUBTRACT ROR BYTE COUNT   Y02032 91800003
         STH   R4,IOSCSWRC             STORE NEW RESIDUAL IN CSW Y02032 91850003
*                                                                       91900003
*   INITIALIZE REGISTERS AND WORK AREAS                                 91950003
*                                                                       92000003
F030     EQU   *                                                        92050003
         USING USERIDAL,USEREG                                          92100003
         USING ERPIDAL,ERPREG                                           92150003
         LA    ERPREG,EWTIDAL          GET ERP IDAL ADDR (VIRT)  Y02032 92200003
         LRA   R5,EWTIDAL              GET ERP IDAL ADDR (REAL)  Y02032 92250003
         IC    R4,EWTRRCMD             SAVE ROR COMMAND          Y02032 92300003
         ST    R5,EWTRRADR             STORE REAL ADDR IN RORCCW Y02032 92350003
         STC   R4,EWTRRCMD             RESTORE COMMAND           Y02032 92400003
*                                                                       92450003
*   TRANSLATE USER IDAL ADDRESS TO VIRTUAL                              92500003
*                                                                       92550003
         LR    R4,IOSREG               SAVE IOSB ADDRESS         Y02032 92600003
         L     R1,EWTVIRT              GET ADDR OF ORIG CCW      Y02032 92650003
         L     R1,0(R1)                GET USER IDAL ADDR (REAL) Y02032 92700003
         LA    R1,0(R1)                ZERO HI-ORDER BYTE        Y02032 92750003
         LR    R5,BASREG               SAVE BASE ADDRESS (R15)   Y02032 92800003
         L     BASREG,LOC16            GET ADDRESS OF CVT        Y02032 92850003
         L     BASREG,CVTPTRV(BASREG)  GET ADDR OF TRANS RTN     Y02032 92900003
         BALR  LNKREG,BASREG           LINK TO TRANS RTN         Y02032 92950003
         LR    USEREG,R1               GET USER IDAL ADDR (VIRT) Y02032 93000003
         LR    BASREG,R5               RESTORE BASE REGISTER     Y02032 93050003
         LR    IOSREG,R4               RESTORE IOSB REGISTER     Y02032 93100003
*                                                                       93150003
*   CALCULATE NUMBER OF BYTES TRANSFERRED                               93200003
*                                                                       93250003
         L     R13,EWTVIRT             GET ADDR OF FAILING CCW @ZA14734 93300003
         LH    R4,C6(R13)              GET CCW BYTE COUNT        Y02032 93350003
         SH    R4,IOSCSWRC             SUBTRACT RESIDUAL FROM BYTE CNT  93450003
         STH   R4,EWTRRCNT             PUT # BYTES XFERRED IN ROR CCW   93500003
*                                                                       93550003
*   WAS USER DOING A FORWARD OR BACKWARD READ?                          93600003
*                                                                       93650003
         L     R5,UIDAL                GET 1ST ENTRY IN USER IDAL LIST  93700003
         CLI   EWTRRCMD,CMDRDB         READ BACKWARD?            Y02032 93750003
         BNE   F100                    YES - GO CONTINUE SETUP   Y02032 93800003
         A     R5,ONEPAGE              NO - ADD 2048 TO FIRST ENTRY     93850003
*                                                                       93900003
*   FIND NUMBER OF BYTES IN USER FIRST PAGE                             93950003
*                                                                       94000003
F100     EQU   *                                                        94050003
         SRA   R5,ELEVEN               ROUND OFF TO PAGE BY SHIFTING    94100003
         SLA   R5,ELEVEN               OFF BITS 20 - 31          Y02032 94150003
         S     R5,UIDAL                SUBTRACT FIRST ENTRY      Y02032 94200003
         LPR   R5,R5                   GET ABSOLUTE VALUE        Y02032 94250003
*                                                                       94300003
         CLI   EWTRRCMD,CMDRDB         WAS USER CMD READ BKWD?   Y02032 94350003
         BE    F200                    NO - NOBIFP VALID, BRANCH        94400003
         A     R5,ONE                  YES - ADD 1 TO NOBIFP     Y02032 94450003
*                                                                       94500003
F200     EQU   *                                                        94550003
         ST    R5,EWTNBFP              SAVE # BYTES IN 1ST PAGE  Y02032 94600003
*                                                                       94650003
*   FIND NUMBER OF USER IDAL ENTRIES IN THE LIST                        94700003
*   R4 CONTAINS NUMBER OF BYTES TRANSFERRED                             94750003
*                                                                       94800003
         CL    R4,EWTNBFP              ONLY ONE ENTRY REQUIRED          94850003
         BH    F250                    NO - CONTINUE CALC IDAL          94900003
         ST    R4,EWTNBFP              SAVE BYTES FOR ONE IDAL          94950003
         MVC   EWTRES,FZERO            SET RESIDUAL CNT TO ZERO         95000003
         L     R4,FZERO                SET INDEX TO ZERO                95050003
         B     F400                    GET OUT OF LOOP                  95100003
*                                                                       95150003
F250     EQU    *                                                       95200003
         S     R4,EWTNBFP              CALCULATE RESIDUAL COUNT  Y02032 95250003
         ST    R4,EWTRES               SAVE RESIDUAL COUNT       Y02032 95300003
         L     R4,FZERO                SET INDEX TO 0            Y02032 95350003
*                                                                       95400003
F300     EQU   *                                                        95450003
         A     R4,FOUR                 ADD FOUR TO USER INDEX    Y02032 95500003
         CLC   EWTRES,ONEPAGE          RESIDUAL <= 2048?         Y02032 95550003
*                                      (MEANS ALL ENTRIES FOUND) Y02032 95600003
         BNH   F400                    YES - GET OUT OF LOOP     Y02032 95650003
*                                                                       95700003
         L     R13,EWTRES              NO - GET RESIDUAL COUNT   Y02032 95750003
         S     R13,ONEPAGE             SUBTRACT 2048             Y02032 95800003
         ST    R13,EWTRES              SAVE RESIDUAL COUNT       Y02032 95850003
         B     F300                    LOOP BACK                 Y02032 95900003
         EJECT                                                          95950003
*                                                                       96000003
*                   C R E A T E   E R P   I D A L                       96050003
*                                                                       96100003
F400     EQU   *                                                        96150003
         CLI   EWTRRCMD,CMDRDB         WAS COMMAND READ BACK?    Y02032 96200003
         BE    F410                    NO - VALUES VALID, BR     Y02032 96250003
*                                                                       96300003
         L     R13,EWTRES              YES - GET RESIDUAL CNT    Y02032 96350003
         LCR   R13,R13                 SET TO NEGATIVE FOR RDB   Y02032 96400003
         ST    R13,EWTRES              SAVE                      Y02032 96450003
*                                                                       96500003
         L     R13,EWTNBFP             GET # BYTES IN 1ST PAGE   Y02032 96550003
         LCR   R13,R13                 SET TO NEGATIVE FOR RDB   Y02032 96600003
         ST    R13,EWTNBFP             SAVE                      Y02032 96650003
*                                                                       96700003
         L     R13,ONE                 GET VALUE - 1             Y02032 96750003
         LCR   R13,R13                 SET TO NEGATIVE FOR RDB   Y02032 96800003
         ST    R13,EWTC1               SAVE                      Y02032 96850003
*                                                                       96900003
         L     R13,F2047               GET VALUE - 2047          Y02032 96950003
         LCR   R13,R13                 SET TO NEGATIVE FOR RDB   Y02032 97000003
         ST    R13,EWTC7FF             SAVE                      Y02032 97050003
         B     F500                    CONTINUE TO SETUP IDAL           97100003
*                                                                       97150003
F410     EQU   *                                                        97200003
         MVC   EWTC1,ONE               SET CONSTANT TO ONE              97250003
         MVC   EWTC7FF,F2047           SET CONSTANT TO 2047             97300003
*                                                                       97350003
*   SUBTRACT VALUE FROM RESIDUAL COUNT TO GET FINAL COUNT               97400003
*   SUBTRACT VALUE FROM NOBIFP TO GET COUNT FOR FINAL ERP IDAL ENTRY    97450003
*                                                                       97500003
F500     EQU   *                                                        97550003
         L     R13,EWTRES              GET RESIDUAL COUNT        Y02032 97600003
         S     R13,EWTC1               SUBTRACT NEG OR POS 1     Y02032 97650003
         ST    R13,EWTRES              SAVE                      Y02032 97700003
*                                                                       97750003
         L     R13,EWTNBFP             GET # BYTES IN 1ST PAGE   Y02032 97800003
         S     R13,EWTC1               SUBTRACT NEG OR POS 1     Y02032 97850003
         ST    R13,EWTNBFP             SAVE                      Y02032 97900003
*                                                                       97950003
         CL    R4,FZERO                IS THIS THE LAST ENTRY?   Y02032 98000003
         BE    F700                    YES - GO CALC LAST ERP ENTRY     98050003
*                                                                       98100003
*   CALCULATE ENTRY FOR ERP IDAL LIST                                   98150003
*                                                                       98200003
         L     R13,UIDAL(R4)           GET LAST ENTRY FROM USER IDAL    98250003
         A     R13,EWTRES              ADD RESIDUAL COUNT        Y02032 98300003
*                                                                       98350003
F600     EQU   *                                                        98400003
         ST    R13,EIDAL               MOVE IN CALC. ERP ENTRY   Y02032 98450003
         S     R4,FOUR                 SUB. FOUR FROM USER INDEX Y02032 98500003
         LA    ERPREG,C4(ERPREG)       INCR TO NEXT ERP ENTRY    Y02032 98550003
*                                                                       98600003
*   IS THIS THE LAST ERP IDAL ENTRY TO BE CREATED?                      98650003
*                                                                       98700003
         CL    R4,FZERO                IS THIS THE LAST ENTRY?   Y02032 98750003
         BE    F700                    YES - GO CALC LAST ERP ENTRY     98800003
*                                                                       98850003
*   CALCULATE NEXT ERP IDAL ENTRY                                       98900003
*                                                                       98950003
         L     R13,UIDAL(R4)           GET NEXT USER ENTRY       Y02032 99000003
         A     R13,EWTC7FF             ADD 2047                  Y02032 99050003
         B     F600                    BRANCH BACK THRU LOOP     Y02032 99100003
*                                                                       99150003
*   CALCULATE LAST ERP IDAL ENTRY                                       99200003
*                                                                       99250003
F700     EQU   *                                                        99300003
         L     R13,UIDAL(R4)           GET LAST USER ENTRY       Y02032 99350003
         A     R13,EWTNBFP             ADD # BYTES IN 1ST PAGE   Y02032 99400003
         ST    R13,EIDAL               PUT IN LAST ERP IDAL ENTRY       99450003
         L     UXREG,UCBXTN            RESET REG TO UCB EXT.     Y02032 99500003
         LA    UXREG,0(UXREG)          GET 3-BYTE ADDRESS        Y02032 99550003
         NI    EWAFLG3,X'FF'-EWTRBLD   RESET REBUILD IDAL BIT    Y02032 99600003
         LA    EXITREG,RETN            RESTORE SVC 15/3 ADDR     Y02032 99650003
         BR    BALREG                  RETURN                    Y02032 99700003
*************    E N D   O F   P A R T   6    *************             99750003
PATCH    DC    (4096-(PATCH-ERP1))X'00'                                 99800037
         EJECT                                                          99900003
         IECDERWA  EWT                                                  99950003
         EJECT                                                          99960003
         IECDIOSB                                                       99970003
         EJECT                                                          99980003
         IEFUCBOB  PREFIX=YES                                           99990003
         END                                                            99992003
