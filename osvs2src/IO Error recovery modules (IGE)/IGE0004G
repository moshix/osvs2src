004G     TITLE ' IGE0004G - TCAM/EXCP START-STOP ERP CONTROL MODULE '   00100010
IGE0004G CSECT                                                          00200010
         SPACE 3                                                        00200510
*CHANGE ACTIVITY= AS FOLLOWS:                                    S21903 00201010
*A135000,595000                                                 SA51090 00201110
*C252000-253000,256000-257000,259000                            SA51090 00201210
*A375000,399000                                                 SA55381 00201310
*C372000                                                        SA55381 00201410
*D298000,348000-350000,376000-396000,411000,479000              SA55381 00201510
*D538000-539000,541000,543000,549000-550000,556000-557000       SA55381 00201610
*D562000,566000-569000,575000-576000,578000-581000,588000       SA55381 00201710
*C354000                                                         A42406 00201810
*A116000,137000,144000,150000,347100,453100,605000               S21903 00201910
*C378000,477000,515000                                           S21903 00202010
*D139000,298000,400000-401000,479000,518000-519000,538000-539000 S21903 00202110
*D543000,549000-550000,552000-553000,556000-557000,562000        S21903 00202210
*D566000-569000,575000-576000,578000-581000,588000,592000        S21903 00202310
*A595100-595500                                                  S22025 00202410
*C005000,232000-234000,271000,340000                             S22025 00202510
*D353140-353770,354200,354800                                    S22025 00202610
*A595100-595500                                                  S22025 00202710
*C005000,232000-234000,271000,340000                             S22025 00202810
*D353140-353770,354200,354800                                    S22025 00202910
*C465500                                                        SA58994 00203010
*C159000,165000-166000                                          SA58998 00203110
*C166200                                                        SA61774 00203210
*D159000                                                        SA61774 00203310
*A138000                                                        SA62387 00203410
*C112000                                                        SA62387 00203510
*A127000,534000,597000                                           X02004 00203610
*C120000-121000,123000-124000,131000,135000-138000,144100-144700,X02004 00203710
*C605600-605800                                                  X02004 00203810
*D117000,140000                                                  X02004 00203910
*A305500                                                        SA68236 00204010
*C144790-144811,144850                                         @ZA00227 00244010
*A334000-350000,605900                                         @ZA00227 00284010
*A1500000                                                      @SA72456 00284110
*C362000,C372000,C376000,C399400                               @OS76278 00284210
*C200000,C561000                                               @OZ14171 00284310
* A120000,124000,135000,144100,144300,144400                   @G36XREV 00294310
* C007000,144150,144350                                        @G36XREV 00304310
* D142230,144050,144250,144802                                 @G36XREV 00314310
*                                                                       00324310
         SPACE 3                                                        00350010
*********************************************************************** 00400010
*                                                                     * 00500010
*  MODULE NAME = IGE0004G                                             * 00510010
*                                                                     * 00520010
*  DESCRIPTIVE NAME = TCAM START/STOP ERP  ( FIRST LOAD )             * 00530010
*                                                                     * 00540010
*  COPYRIGHT = 'NONE'                                                 * 00550010
*                                                                     * 00600010
*STATUS:  CHANGE LEVEL 10                                      @G36XREV 00700010
*                                                                     * 00800010
*FUNCTION -- ALL ERP MLDULES ATTEMPT TO RECOVER FROM ALL ERRORS.      * 00900010
*   CERTAIN TEXT ERRORS REQUIRE RETURN TO LINE END TO SCHEDULE A      * 01000010
*   SUBSEQUENT RECALL OPERATION.                                      * 01100010
*                                                                     * 01200010
*ENTRY POINTS -- FIRST EXECUTABLE INSTRUCTION.                        * 01300010
*                                                                     * 01400010
*INPUT --                                                             * 01500010
*   R1 - POINTER TO I/O SUPERVISOR BLOCK                         Y02027 01600010
*   R15 - ENTRY POINT ADDRESS                                         * 01700010
*                                                                     * 01800010
*OUTPUT -- R1 POINTS TO I/O SUPERVISOR BLOCK                     Y02027 01900010
*                                                                     * 02000010
*EXTERNAL ROUTINES -- 'IEDQTNT' - TO GET TERMINAL ENTRY ADDRESS       * 02100010
*                                                                     * 02200010
*EXITS-NORMAL -- R1 POINTS TO I/O SUPERVISOR BLOCK               Y02027 02300010
*        SVC   15   'ERP IN CONTROL (IOSERR)' AND 'EXCEPTIONAL   Y02027 02350010
*                CONDITION(IOSEX)'. RETURN TO IOS TO RETRY THE   Y02027 02400010
*                   ERROR.                                       Y02027 02450010
*        SVC   3                                                      * 02500010
*                                                                     * 02600010
*        SVC   15   'NO ERROR FLAGS'. RETURN TO LINE END         Y02027 02700010
*                   APPENDAGE. ERROR CLEARED                     Y02027 02750010
*        SVC   3                                                      * 02800010
*                                                                     * 02900010
*   TO SCHEDULE NEXT LOAD OF ERP                                      * 03000010
*        L     13,DECIMAL VALUE OF NEXT LOAD                          * 03100010
*        L   14,X'10'    CVT ADDRESS                                  * 03200010
*        L     14,X'2C'(14)    ADDRESS OF XCTL ROUTINE                * 03300010
*        BR    14   EXIT TO XCTL                                      * 03400010
*                                                                     * 03500010
*EXITS-ERROR -- R1 POINTS TO I/O SUPERVISOR BLOCK                Y02027 03600010
*        SVC   15   'EXCEPTIONAL CONDITION(IOSEX)'. RETURN TO    Y02027 03660010
*                   LINE END APPENDAGE. ERROR PERMANENT.         Y02027 03720010
*        SVC   3                                                      * 03800010
*                                                                     * 03900010
*        L     13,DECIMAL VALUE OF NEXT LOAD                          * 04000010
*        L   14,X'10'    CVT ADDRESS                                  * 04100010
*        L     14,X'2C'(14)    ADDRESS OF XCTL ROUTINE                * 04200010
*        BR    14   EXIT TO XCTL                                      * 04300010
*                                                                     * 04400010
*   TO SCHEDULE ERROR POST                                            * 04500010
*                                                                     * 04600010
*TABLES/WORK AREAS --                                                 * 04700010
*   TAVTD                                                             * 04800010
*   TTRMD                                                             * 04900010
*   TCCWD                                                             * 05000010
*   TLCBD                                                             * 05100010
*   DCBD                                                              * 05200010
*   TSCBD                                                             * 05300010
*   IECDIOSB                                                     Y02027 05350010
*                                                                     * 05400010
*ATTRIBUTES -- SERIALLY REUSABLE, REFRESHABLE, SUPERVISOR KEY,   Y02027 05500010
*              SUPERVISOR MODE, ENABLED                          Y02027 05550010
*                                                                     * 05600010
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 05700010
*   PARTICUALR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER      * 05800010
*   SET.                                                              * 05900010
*                                                                     * 06000010
*   R1 REMAINS TRANSPARENT TO ALL LOADS OF ERP.                       * 06100010
*                                                                     * 06200010
*   EXIT FROM ERP IS MADE WHENEVER THE RETRY COUNT IS EXHAUSTED, OR   * 06300010
*   A SHOULD NOT OCCUR ERROR IS PRESETNED.  TEXT ERRORS NOT           * 06400010
*   RECOVERABLE BY ERP ARE POSTED TO LINE END APPENDAGE WITH ERROR    * 06500010
*   (VIA SVC 15).                                                     * 06600010
*                                                                     * 06700010
*   IF ANOTHER ERP LOAD IS PERFORMING INTERMITTENT ERP RECOVERY, EXIT * 06800010
*   IS MADE TO THE SPECIAL RETURN ERP LOADS.  THIS IS INDICATED BY A  * 06900010
*   NON-ZERO VALUE IN LCBINCAM+1.  RETRY COUNT IS MAINTAINED IN       * 07000010
*   LCBINCAM.                                                         * 07100010
*                                                                     * 07200010
*   ON FIRST OCCURRENCE OF AN ERROR, THE CSW, SENSE BYTE, AND TP OP   * 07300010
*   CODE ARE SAVED IN LCBCSWSV, LCBSENS1, AND LCBRESTR+1              * 07400010
*   RESPECTIVELY.  IF THE ERROR IS CLEARED THROUGH ERP ACTION, THE    * 07500010
*   TEMPORARY ERROR COUNTER IN THE TERMINAL ENTRY IS UPDATED.  FOR    * 07600010
*   2740/2, THE LEADING GRAPHIC RESPONSE IS SAVED IN LCBSENS1.        * 07700010
*                                                                     * 07800010
*   THE USER HAS THE OPTION TO RECORD THESE INTERMITTENT ERRORS VIA   * 07900010
*   THE OPERATOR CONTROL FACILITY WHCIH SETS THE MASK IN LCBERMSK     * 08000010
*   (LINE BASIS) OR TRMSENSE (TERMINAL BASIS).  LINE MASK TAKES       * 08100010
*   PRECEDENCE OVER TERMINAL MASK.  THE LOW ORDER 4 BITS INDICATE     * 08200010
*   THE NUMBER OF RECORDINGS TO BE PERFORMED FOR THIS TYPE OF ERROR.  * 08300010
*   (THE COUNT IS DECREMENTED FOR EACH RECORDING.)                    * 08400010
*                                                                     * 08500010
*   THE RECORDING MASK IS AS FOLLOWS:                                 * 08600010
*   X'10' - TIME OUT                                                  * 08700010
*   X'20' - LOST DATA                                                 * 08800010
*   X'30' - OVERRUN                                                   * 08900010
*   X'40' - DATA CHECK                                                * 09000010
*   X'50' - EQUIPMENT CHECK                                           * 09100010
*   X'60' - BUSOUT CHECK                                              * 09200010
*   X'70' - INTERVENTION REQUIRED                                     * 09300010
*   X'80' - COMMAND REJECT                                            * 09400010
*   X'90' - UNIT EXCEPTION                                            * 09450010
*   X'F0' - INTENSIVE MODE (ANY OF ABOVE)                             * 09500010
*   X'A0' - 2740/2 GRAPHIC RESPONSE                                   * 09600010
*   PARAMETERS PASSED TO OBR/SDR RECORDING MODULE:                    * 09700010
*   LCBERCCW+16 - 1 BYTE INDICATES TYPE OF RECORDING                  * 09800010
*      X'00' - OBR                                                    * 09900010
*      X'80' - RECORD INTERMITTENT ERROR                              * 10000010
*      X'40' - OVERFLOW OF SIO COUNTER OR TEMPORARY ERROR COUNTER     * 10100010
*      X'20' - CLOSE DOWN RECORDING                                   * 10200010
*   LCBERCCW+17 - 3 BYTES ADDRESS OF TERMINAL COUNTERS                * 10300010
*   LCBERCCW+20 - 1 BYTE - SIZE OF TERMINAL NAME                      * 10400010
*   LCBERCCW+21 - 3 BYTES - ADDRESS OF TERMINAL NAME                  * 10500010
*                                                                     * 10600010
*   NOTE THAT ANY CHANGES IN THE OFFSET FROM LCBFLAG1 TO LCBERCCW+16  * 10700010
*   MUST BE PRESENTED TO THE OWNERS OF OBR/SDR MODULES.               * 10800010
*********************************************************************** 10900010
         EJECT                                                          11000010
         USING IEDQCCW,RCCW                                             11100010
         USING IEDQLCB,RLCB                                     SA62387 11200010
         USING IHADCB,RDCB                                              11300010
         USING IEDQAVTD,RAVT                                            11400010
         USING IEDQSCB,RSCB                                             11500010
         USING IEDQTRM,RTERM                                            11600010
         USING IOSB,RIOSB                                        Y02027 11620010
         USING CVTDSECT,RCVT                                     Y02027 11650010
         USING EWA,RERPWA                                        Y02027 11720010
*              REGISTERS                                                11800010
R0       EQU   0                                                        11900010
RIOSB    EQU   1                        ADDR OF I/O SUPVR BLK    Y02027 12000010
RPARM    EQU   1                        PARAMETER REG          @G36XREV 12050010
RLCB     EQU   2                        LCB ADDRESS              X02004 12100010
RUCB     EQU   3                        UCB REGISTER                    12200010
RDEB     EQU   3                        DEB ADDRESS              X02004 12250010
RDCB     EQU   4                        DCB ADDRESS              X02004 12300010
RA       EQU   5                       WORK REGISTER             X02004 12400010
R5       EQU   5                        WORK REG               @G36XREV 12420010
RCVT     EQU   5                        ADDR OF CVT              Y02027 12450010
RWKA     EQU   6                        WORK REGISTER                   12500010
RWKB     EQU   7                        WORK REGISTER                   12600010
RTST     EQU   7                         ADDRESS OF RQE          Y02027 12650010
RTERM    EQU   8                        TERMINAL BASE                   12700010
*                                       IN CCW CONVERT SUB-ROUT  X02004 12730010
RCCW2    EQU   8                        SECOND CCW ADDRESS.      X02004 12760010
RWKC     EQU   9                        WORK REGISTER                   12800010
RCCW     EQU   10                       CCQW BASE                       12900010
RAVT     EQU   11                       AVT BASE                        13000010
RBASE    EQU   12                       BASE REGISTER.           X02004 13100010
RLINK    EQU   13                       LINKAGE FOR SUBSEQUENT LOAD     13200010
RSAVE    EQU   13                       SAVE REGISTER FOR IOSB   Y02027 13250010
RXCTL    EQU   14                       XCTL REGISTER                   13300010
RERPWA   EQU   14                       ADDR OF ERP WORK AREA    Y02027 13350010
R15      EQU   15                       ADDRESSABILITY REGISTER         13400010
RSCB     EQU   15                       SCB REGISTER             X02004 13500010
RNTRY    EQU   15                       ENTRY REG@G36XREV               13505010
         EJECT                                                          13510010
         USING *,R15                    TEMPORARY BASE.          X02004 13520010
IGE0004G IEDHJN ID                                                      13528010
         L     RTST,IOSUSE               PICKUP ADDR OF RQE      Y02027 13584010
         LM    RLCB,RDEB,IOBPTR(RTST)   IOB AND DEB ADDRESSES    Y02027 13600010
         L     RDCB,LCBDCBPT-LCBFLAG1(RLCB)   DCB ADDRESS        X02004 13609010
         LA    R15,ZERO(RDEB)           COPY DEB ADDRESS         X02004 13618010
         LA    RDEB,DEBNMSUB-DEBEOEA    OFFSET TO DEB START      X02004 13627010
         SR    R15,RDEB                 ADDRESS OF SIO APPENDAGE X02004 13636010
         L     R15,SIOPTR(,R15)         ADDRESS OF SIO APPENDAGE X02004 13645010
SETERP   SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,RELATED=CHANNEL PROGRAM,X13646010
               IGE0004H(SETERP),IGG019QE(SETERP),IEDQGT(SETTRAN),      X13647010
               IEDQGA(SETASSC,SETCONC),'PCI LINEEND,AND START I/O      X13648010
               APPENDAGES ARE LOCKED ON THIS RESOURCE THRU THE EXCP    X13649010
               PROCESSOR ISSUING SETLOCK (ERP,BUFFER ASSOCIATION AND   X13650010
               TRANSPARENT CCW BUILD MUST ISSUE SETLOCK'                13651010
         BAL   RBASE,INTENTRY(R15)      LINK TO SIO APPENDAGE -  X02004 13654010
*                                       SECOND ENTRY TO TRANSLATEX02004 13663010
*                                       REAL TO VIRTUAL          X02004 13672010
         SPACE 1                                                 X02004 13681010
         USING *,RBASE                  USE NEW BASE             X02004 13690010
         L     RTST,IOSUSE              PICKUP ADDRESS OF RQE    Y02027 13704010
         L     RCVT,CVTPTR              PICKUP ADDR OF CVT       Y02027 13710010
         L     RAVT,CVTAQAVT            DISPATHER WORK AREA      X02004 13720010
         L     RAVT,ZERO(,RAVT)         AVT ADDRESS              X02004 13730010
         USING IEDQSCB,RSCB                                      X02004 13740010
         SH    RLCB,LCBSIZE             ADJUST BASE             SA62387 13900010
**************************************************************** Y02027 14202010
*        THE FOLLOWING CODE MAPS THE NECESSARY FIELDS FROM THE   Y02027 14204010
*        I/O SUPERVISOR BLOCK TO THE LINE CONTROL BLOCK FOR EXCP Y02027 14206010
*        COMPATABILITY DURING RETRY I/O OPERATIONS FROM ERP      Y02027 14208010
**************************************************************** Y02027 14210010
         MVC   LCBCSW(SEVEN),IOSCSW     MAP CSW FROM IOSB TO LCB Y02027 14212010
         MVC   LCBSENS0(TWO),IOSSNS     MAP SENSE INFO FROM IOSB Y02027 14214010
*                                       TO LCB                   Y02027 14216010
         MVC   LCBSIOCC(ONE),IOSCC      MAP START I/O CONDITION  Y02027 14218010
*                                       CODE FROM IOSB TO LCB    Y02027 14220010
         LR    RWKA,RBASE               SAVE BASE OVER SETLOCK @ZM46665 14223010
         LA    R0,LOAD904G              SET BRANCH REGISTER      Y02027 14226010
         CLI   LCBINCAM+1,AVTEFF        CLOSE DOWN ENTRY                14230010
         BE    NOTRACE                  BRANCH YES               Y02027 14260010
         LA    R0,HIORET                SET BRANCH REGISTER      Y02027 14265010
         CLI   LCBECBCC,HIO             WAS HIO DONE                    14270010
         BE    NOTRACE                  BRANCH YES               Y02027 14280010
         LA    R0,CONTINUE              SET BRANCH REGISTER      Y02027 14290010
         TM    IOSFLA,IOSERR            ERP ALREADY IN CONTROL   Y02027 14300010
         BNO   NOTRACE                  BRANCH NOT ERP           Y02027 14400010
         LA    R0,SPECIAL               SET BRANCH REGISTER      Y02027 14410010
         SLR   RNTRY,RNTRY              CLEAR, HI BYTE 0 FOR Q0@G36XREV 14412010
         ICM   RNTRY,AD,AVTIOT+1        IS I/O TRACE ACTIVE    @G36XREV 14415010
         BZ    NOTRACE                  BRANCH NO                Y02027 14420010
         OI    LCBFLAG1,IOSERR+IOSEX    SET FOR IGG019Q0         Y02027 14430010
         LR    R5,RIOSB                 SAVE IOSB ADDR         @G36XREV 14431010
         L     RPARM,IOSUSE             RQE ADDR PARM TO Q0    @G36XREV 14432010
         LA    RPARM,0(RPARM)           CLEAR HIGH BYTE        @G36XREV 14433010
         BALR  RXCTL,RNTRY              LINK TO IGG019Q0       @G36XREV 14435010
         SPACE 1                                                 Y02027 14440010
         LR    RIOSB,R5                 RESTORE IOSB BASE      @G36XREV 14442010
         NI    LCBFLAG1,X'FF'-(IOSERR+IOSEX) RESET FLAGS         Y02027 14445010
         SPACE 1                                                 X02004 14450010
NOTRACE  EQU   *                                                 S21903 14470010
RESETERP SETLOCK RELEASE,TYPE=LOCAL,RELATED=CHANNEL PROGRAM,           X14473010
               IGE0004G(SETERP)                                         14476010
         LR    RBASE,RWKA               RESTORE BASE AFTER LOCK@ZM46665 14476510
         OI    IOSFLA,IOSERR+IOSEX      INDICATE ERP IN CONTROL  Y02027 14477010
         L     RCVT,CVTPTR              PICK UP ADDR OF CVT    @ZA00227 14479010
         L     RUCB,CVTAQAVT            PICK UP TCX            @ZA00227 14479310
         USING IEDQTCX,RUCB                                    @ZA00227 14479610
         L     RAVT,TCXAVT              AVT ADDRESS            @ZA00227 14479910
         TM    LCBSIOCC,CC3             SIO COMP 3             @ZA00227 14480510
         BO    PATHAVAL                 YES, CHECK ALT. PATH   @ZA00227 14480810
NOPATH   EQU   *                                               @ZA00227 14481110
         SR    RLINK,RLINK              SET FOR INDEXING         Y02027 14482010
         L     RUCB,IOSUCB              UCB ADDRESS            @ZA00227 14485010
         LR    R15,R0                   SET BRANCH REGISTER      Y02027 14488010
         BR    R15                      TO PROPER ROUTINE        Y02027 14491010
SPECIAL  EQU   *                                                 Y02027 14494010
         SPACE                                                          14500010
         TM    LCBINCAM+1,AVTEFF        ANY SPECIAL RETURNS             14600010
         BNZ   LOAD504G                 READ SKIP AND WRITE BREAK       14800010
         SPACE                                                          14900010
CONTINUE EQU   *                                                        15000010
         MVI   LCBINCAM+1,AVTEZERO      ZERO RETURN INDICATOR  @SA72456 15005010
         L     RERPWA,IOSERP            PICKUP ADDR OF ERP WORK  Y02027 15010010
*                                       AREA                     Y02027 15020010
         L     RSCB,LCBSCBA-1           SCB BASE                 S21903 15050010
         TM    LCBSIOCC,CC3             SIO COMP CODE 3                 15400010
         BO    LOAD204G                 YES-CONTROL UNIT NOT UP         15500010
         SPACE                                                          15600010
         BZ    CHECKCAT                 BRANCH CC=0 CONTINE TESTING     15700010
         SPACE                                                          15800010
         OI    EWTCFLG,EWTCSEL          INDICATE INTIAL          Y02027 15850010
*                                       SELECTION ERROR          Y02027 15900010
         L     RWKA,LCBSTART-1          START ADDRESS                   15950010
         LA    RWKA,EIGHT(R0,RWKA)      BUMP BY 8                       16000010
         STCM  RWKA,SEVEN,LCBCSW         TRUE FAILING CCW + 8    Y02027 16100010
CHECKCAT EQU   *                        CATASTROPIC ERRORS              16200010
*                                         WTO MODULE                    16300010
         SR    RCCW,RCCW                 CLEAR FOR ICM           Y02027 16400010
         ICM   RCCW,SEVEN,LCBCSW         ADDRESS FAILURE CCW + 8 Y02027 16450010
         LA    RWKC,TPTEXT              INDICATE TEXT CCW        S21903 16530010
         SH    RCCW,H8                 BACK UP TO FAILURE CCW   SA58998 16560010
         BM    TEXTCCW                 ZERO CSW ADDRESS         SA61774 16620010
*                                      RCCW (A) MAY GO NEG.     SA61774 16660010
*                                      AT THIS POINT WITH       SA61774 16700010
*                                      DEVICE END STATUS THIS   SA61774 16740010
*                                      IS NORMAL FOR GOOD       SA61774 16780010
*                                      COMP AFTER A RESTART     SA61774 16820010
*                                      WRITE ON 3270 LOCAL      SA61774 16860010
         LA    RWKA,LCBCPA              START OF CHAN PROGRAM AREA      16900010
         SR    RWKA,RCCW                INTERRUPT BEFORE LCBCPA         17000010
         BP    TEXTCCW                  BRANCH IF TEXT CCW              17100010
         SPACE                                                          17200010
         SR    RWKB,RWKB                CLEAR WORK REGISTER             17300010
         IC    RWKB,DCBEIOBX            SIZE OF AN LCB                  17400010
         LA    RWKB,ZERO(RLCB,RWKB)     POINT TO END OF LCBCPA          17500010
         SR    RWKB,RCCW                INTERRUPT OUT OF LCBCPA         17600010
         BNP   TEXTCCW                  BRANCH IF TEXT CCW              17700010
         SPACE                                                          17800010
         LPR   RWKA,RWKA                MAKE DIFFERENCE POSITIVE        17900010
         SRL   RWKA,THREE               DIVIDE BY 8 FOR INDEXING        18000010
         IC    RWKC,LCBTPCD(RWKA)       CORRESPONDING TP OP CODE S21903 18100010
TEXTCCW  EQU   *                                                        18300010
         STC   RWKC,LCBRESTR            TEST CASTROPHIC ERRORS   S21903 18500010
         CLI   LCBINCAM,AVTEZERO        RETRY COUNT EQ 0                18700010
         BNE   NOT1ST                   NO                              18800010
         SPACE                                                          18900010
         MVC   LCBSNSV,LCBSENS0         SABE SENSE BYTE                 19000010
         MVC   LCBCSWSV,LCBCSW          SAVE CURRENT CSW                19200010
         MVC   LCBRESTR+1(1),LCBRESTR   SAVE FIRST TP OP CODE           19300010
         MVC   EWTCCSW(SEVEN),LCBCSW    MOVE CSW INTO THE ERP    Y02027 19340010
*                                       WORK AREA                Y02027 19380010
         MVC   EWTCCCW(EIGHT),ZERO(RCCW) MOVE CCW INTO THE ERP   Y02027 19420010
*                                       WORK AREA                Y02027 19460010
NOT1ST   EQU   *                                                        19500010
         TM    LCBCSW+4,CONTCHK+INTCHK  SEVERE CHANNEL ERRORS           19600010
         BNZ   LOAD804G                 BRANCH IF ANY                   19700010
         TM    LCBCSW+4,CHDATCHK        CHANNEL DATA CHECK              19800010
         BO    UNUSUAL                  YES                             19900010
         TM    LCBCSW+3,ATSMBY          ATTENTION,STATUS MOD,  @OZ14171 20000010
*                                         CONTROL UNIT END, BUSY        20100010
         BZ    TRYNEXT                  BRANCH NONE OF THESE            20200010
         CLI   TTY3(RUCB),GRAPHICS      LOCAL DEVICE?            S99228 20220010
         BNE   UNUSUAL                  BRANCH NO                S99228 20240010
         CLI   TTY4(RUCB),LCL3277       3270 DEVICE?             S99228 20260010
         BNL   AUDTV                    BRANCH YES               S99228 20280010
UNUSUAL  EQU   *                                                        20300010
         MVI   LCBINCAM+1,UNUSRET       ST RETURN INDICATOR             20400010
         B     LOAD504G                 NEXT LOAD                       20500010
TRYNEXT  EQU   *                        TEST 2ND STATUS BYTE            20600010
         TM    LCBCSW+4,CHCKPROT        CHAINING CECK ,PROT CHECK       20700010
         BNZ   UNUSUAL                  YES                             20800010
         SPACE 2                                                        20900010
         TM    LCBCSW+4,PC              PROGRAM CHECK                   21100010
         BZ    NOPC                     NO                              21200010
         CLI   CCWOPCDE,CCWTIC          TIC                             21300010
         BNE   UNUSUAL                  NO                              21400010
         SPACE                                                          21500010
         SH    RCCW,H8                  BACK UP TO TEST CCW             21600010
NOPC     EQU   *                                                        21700010
         TM    LCBCSW+3,UNITCHK         UNIT CHECK                      21800010
         BZ    TRYUNEX                  BRANCH NO                       21900010
         BAL   RWKC,AUDTV               TEST FOR ADIO OR 2260L          22000010
         SPACE 2                                                        22100010
         CLI   CCWOPCDE,CCWREAD         READ OR WRITE CCW               22300010
         BH    TESTPOLL                 FALL THROUGH-READ OR WRITE      22400010
         CLI   LCBRESTR,TPRDRESP        RESPONSE TO POLLING             22500010
         BNE   NOPOLRSP                 NO                              22600010
         SPACE                                                          22700010
         CLI   LCBCPA+24,CCWPOLL        THIS RESPONSE TO AUTOPOLL       22800010
         BE    LOAD404G                 YES                             22900010
         SPACE                                                          23000010
NOPOLRSP EQU   *                                                        23100010
         TM    LCBSENS0,EQCKLD          EQUIPMENT CHECK OR       S22025 23200010
*                                       LOST DATA ?              S22025 23230010
         BNZ   LOAD104G                 BRANCH IF EITHER         S22025 23260010
         TM    LCBSENS0,TO              TIME OUT ?               S22025 23290010
         BO    LOAD204G                 BRANCH = YES             S22025 23320010
         TM    LCBSENS0,BOIR            BUS OUT OR INTERVENTION  S22025 23350010
*                                            REQUIRED ?          S22025 23380010
         BNZ   LOAD104G                 BRANCH IF EITHER         S22025 23410010
         SPACE                                                          23500010
         LA    RWKA,LCBCPA+16           ASSUME START AT TOP             23600010
         TM    LCBSENS0,DATCHK          DATA CHECK SET                  23607010
         BZ    TRYOVRN                  NO, TEST FOR OVERRUN            23614010
         SPACE                                                          23621010
         TM    CCWOPCDE,CCWWRITE        WRITE COMMAND                   23628010
         BO    PERMEXIT            BRANCH YES                           23635010
         SPACE                                                          23642010
         CLI   LCBRESTR,TPRDSKIP        TEXT RELATED ERROR              23649010
         BL    NODCTXT                  BRANCH IF NO                    23656010
         SPACE                                                          23663010
TXTERR   EQU   *                                                        23670010
         MVI   LCBINCAM+1,TEXTRTRY      SET 104G OFFSET                 23677010
         B     LOAD104G                 NEXT LOAD                       23684010
         SPACE                                                          23700010
TESTPOLL EQU   *                                                        23800010
         CLI   CCWOPCDE,CCWINHIB        INHIBIT COMMAND                 23900010
         BE    NOPOLRSP                 BRANCH YES                      24000010
         SPACE                                                          24100010
         CLI   CCWOPCDE,CCWBREAK        BREAK COMMAND                   24200010
         BE    NOPOLRSP                 BRANH YES                       24300010
         CLI   CCWOPCDE,CCWPOLL         POLL COMMAND                    24400010
         BE    LOAD404G                 BRANCH YES NEXT LOAD            24500010
         SPACE                                                          24600010
         B     LOAD304G                 HANDLE UNIT CHECKS FOR NON      24700010
*                                         READ, WRITE, POLL CCW'S       24800010
TRYUNEX  EQU   *                                                        24900010
         TM    LCBCSW+3,UNEX            UNIT EXCEPTION SET              25000010
         BZ    ERRCLEAR                 NO, ERROR IS CLEARED            25100010
         CLI   TTY3(RUCB),GRAPHICS      LOCAL DEVICE?            S99228 25110010
         BNE   REGUNEX                  BRANCH NO                S99228 25120010
         CLI   TTY4(RUCB),LCL3277       3270 LOCAL DEVICE?       S99228 25130010
         BNL   AUDTV                    BRANCH YES               S99228 25140010
REGUNEX  EQU   *                                                 S99228 25150010
         LA    RWKC,ERRCLEAR            SET EXIT ADDRESS        SA51090 25200010
         CLI   CCWOPCDE,CCWREAD         IS THIS A READ COMMAND  SA51090 25260010
         BE    AUDTEST                  IF SO, IS THIS AUDIO    SA51090 25320010
         LA    RWKC,EXAUDTV             SET EXIT ADDRESS                25400010
AUDTV    EQU   *                                                        25500010
         CLI   DEVCLASS(RUCB),X40       COMMUNICATIONS CLASS    SA51090 25600010
         BNE   LOAD604G                 NO, IT IS 2260 LOCAL    SA51090 25700010
         SPACE                                                          25800010
AUDTEST  EQU   *                                                SA51090 25900010
         CLI   UNITYPE(RUCB),ZERO       AUDIO CONTROL UNIT      SA51090 25950010
         BE    LOAD604G                 YES                             26000010
         BR    RWKC                     RETURN                          26100010
EXAUDTV  EQU   *                                                        26200010
         SPACE                                                          26300010
         CLI   CCWOPCDE,CCWINHIB        INHIBIT COMMAND                 26400010
         BE    ERRCLEAR                 YES                             26500010
         SPACE                                                          26600010
         CLI   CCWOPCDE,CCWBREAK        BRWAK COMMAND                   26700010
         BE    LOAD104G                 YES                             26800010
         SPACE                                                          26900010
         CLI   CCWOPCDE,CCWWRITE        WRITE COMMAND                   27000010
         BE    LOAD204G                 BRANCH = YES             S22025 27100010
         B     LOAD304G                 NON READ WRITE CCW'S            27200010
         SPACE                                                          29200010
NODCTXT  EQU   *                                                        29300010
         CLI   LCBRESTR,TPTWXID         TWX ID RESPONSE                 29400010
         BE    TRYRETRY                 YES                             29500010
         CLI   LCBRESTR,TPRDRESP        RESPONSE TO POLLING             29600010
         BE    NOTTEXT                  BRANCH NOT TEXT                 29700010
         CLI   LCBRESTR,TPRDRSPD        RESPONSE TO ADDRESSING          29900010
         BE    NOTTEXT                  BRANCH NOT TEXT                 30000010
         CLI   LCBRESTR,TPRDRPEB        RESPONSE TO EOB                 30100010
         BE    TXTERR                   YES, USE COMMON CODE            30200010
         SPACE                                                          30300010
SNO      EQU   *                                                        30400010
         OI    SCBERR4,SCBCTLUN         CONTROL UNIT ERROR              30410010
         MVI   LCBINCAM+1,POSNO         RETURN INDEX FOR 504G           30420010
         B     LOAD504G                 NEXT MODULE                     30430010
TRYOVRN  EQU   *                                                        30450010
         TM    LCBSENS0,OVERRUN         OVERRUN OR COMD REJECT          30500010
         BZ    SNO                      SHOULD NOT OCCUR         S22025 30550010
         OI    SCBERR4,SCBCTLUN         SET OVERRUN             SA68236 30570010
         SPACE                                                          30600010
         TM    CCWOPCDE,CCWWRITE        WRITE COMMAND                   30650010
         BO    SNO                      BRANCH YES                      30700010
         CLI   LCBRESTR,TPTWXID         TWX ID RESPONSE                 30750010
         BE    TRYRETRY                 YES                             30800010
         CLI   LCBRESTR,TPRDSKIP        TEXT RELATED ERROR              30900010
         BNL   TXTERR                   BRANCH IF YES                   30950010
         SPACE 2                                                        31000010
NOTTEXT  EQU   *                                                        31900010
         CLI   LCBCPA+16,CCWDISAB       DIAL START                      32000010
         BNE   TRYRETRY                 BRANCH NO                       32100010
         SPACE                                                          32200010
         LA    RWKA,16(,RWKA)           BUMP PAST DIAL CCW'S            32300010
TRYRETRY EQU   *                                                        32400010
         CLI   LCBINCAM,RETRY           RETRY LINT REACHED              32500010
         BE    PERMEXIT                 YES                             32600010
         IC    RWKB,LCBINCAM            RETRY COUNT                     32800010
         LA    RWKB,1(,RWKB)            BUMP                            32900010
         STC   RWKB,LCBINCAM            SAVE BACK                       33000010
         ST    RWKA,LCBSTART-1          START ADDRESS                   33100010
         MVI   LCBSENS0,AVTEZERO        CLEAR SENSE FIELD FOR RETRY     33200010
         B     APPRET                   RETRY THE OPERATION      Y02027 33300010
PATHAVAL EQU   *                                               @ZA00227 33400010
CC3LOOP  EQU   *                                               @ZA00227 33500010
         TS    TCXCC3TS                 RESERVE SAVE AREA IN TCXOZ00227 33600010
         BNZ   CC3LOOP                  LOOP TILL TCX AVAILABLE@ZA00227 33700010
         STM   R15,RIOSB,TCXERPSV       SAVE REGS DESTROYED    @ZA00227 33800010
         LA    RLINK,TCXESAVE           SAVE AREA FOR IECVIOPM @ZA00227 33900010
         L     RIOSB,IOSUCB             UCB ADDRESS            @ZA00227 34000010
         LA    RIOSB,ZERO(RIOSB)        CLEAR HIGH BYTE        @ZA00227 34100010
         ST    RIOSB,TCXERPPM           SET PARM LIST          @ZA00227 34200010
         LA    RIOSB,TCXERPPM           ADDRESS OF PARM LIST   @ZA00227 34300010
         LINK     EP=IECVIOPM,MF=(E,(1)) CHECK AVAIL PATHS     @ZA00227 34400010
         LTR   R15,R15                  PATH AVAILABLE         @ZA00227 34500010
         LM    R15,RIOSB,TCXERPSV       RESTORE REGS           @ZA00227 34600010
         MVI   TCXCC3TS,AVTEZERO        CLEAR TS LOCK          @ZA00227 34700010
         BNZ   NOPATH                   NO,BRANCH              @ZA00227 34800010
         NI    LCBSIOCC,AVTEFF-CC3      RESET CONDITION CODE   @ZA00227 34900010
         B     APPRET                   RETRY OTHER PATH       @ZA00227 35000010
         SPACE 5                                                        35307010
ERRCLEAR EQU   *                                                        35400010
         NI    IOSFLA,AVTEFF-(IOSERR+IOSEX) RESET ' ERP IN CTL'  Y02027 35500010
*                                       AND 'PERMANENT ERROR'    Y02027 35530010
*                                       INDICATORS               Y02027 35560010
         MVI   SCBERR4,0                CLEAR ERROR INDICATION          35600010
         MVI   LCBINCAM,AVTEZERO        CLEAR RETRY OCUNT               35700010
         TM    LCBCSWSV+3,UNITCHK+UNEX  UNIT CHECK OR UNIT EXCEPTION    35800010
         BNZ   TRYREC                   YES, CONTINUE CHECKING          35900010
         SPACE                                                          36000010
         CLI   LCBRCB,X0F               2740/2 RECRORD                  36100010
         BNE   APPRET                   BRANCH NO              @OS76278 36200010
         SPACE                                                          36300010
         MVC   EWTCGRA(ONE),LCBERCCW+TWELVE SAVE MOD 2 RESPONSE  Y02027 36400010
         B     TERM                     CONTINUE PROCESSING             36500010
         SPACE                                                          36600010
TRYREC   EQU   *                                                        36700010
         SR    RA,RA                    CLEAR WORK REGISTER             36800010
         CH    RA,LCBTTCIN              SPECIFIC CONNECTION             36900010
         BNE   TERM                     BRANCH IF LINE ENRTY            37000010
         TM    LCBSTAT2,LCBDIAL         DIAL LINE                       37100010
         BZ    APPRET                   FORGET OBR/SDR         @OS76278 37200010
         LH    RWKC,LCBLNENT            LINE ENTRY USED                 37300010
         LTR   RWKC,RWKC                LINE ENTRY PRESENT              37400010
         BNZ   TERM1                    BRANCH NOT DIAL                 37500010
         B     APPRET                   FORGET OBR/SDR         @OS76278 37600010
TERM     EQU   *                                                        39700010
         LH    RWKC,LCBTTCIN            CURRENTLY CONNECTED             39800010
TERM1    EQU   *                                                        39900010
         CLI   LCBRESTR,TPRDIDNQ        FORGET OBRSDR RECORDING SA55381 39910010
         BL    RECORDS                    FOR READ ID/ENQ, READ SA55381 39920010
         CLI   LCBRESTR,TPTWXID           ID/ACK, ABORT FOR     SA55381 39930010
         BNH   APPRET                     SEND/RECEIVE, AND    @OS76278 39940010
*                                         READ TWX-ID           SA55381 39950010
         SPACE 1                                                SA55381 39960010
RECORDS  EQU   *                                                SA55381 39970010
         L     RWKB,AVTRNMPT            ADDRESS OF CODE A BASE          40200010
         USING IEDQTNTD,RWKB                                            40300010
         BAL   RWKA,TNTDCODE            LINK TO IT                      40400010
         LA    RTERM,TRMSIO             RESTET BASE  ADJUST FOR DIAL    40500010
         USING TRMSIO,RTERM                                             40600010
         SR    RA,RA                    CLEAR WORK REGISTER      Y02027 40700010
         IC    RA,TNTENLEN              SIZE OF EACH NAME        Y02027 40800010
         LA    RWKC,79(RWKB,RWKC)       ADDRESS OF TERM ADDRESS         40900010
         SR    RWKC,RA                  SUB SIZE TO GET ADDRESS  Y02027 41000010
*                                       OF NAME                  Y02027 41100010
         MVI   EWTCTRM,BLANK                                     Y02027 41200010
         MVC   EWTCTRM+ONE(SEVEN),EWTCTRM BLANK OUT TERMINAL     Y02027 41220010
*                                       NAME FIELD IN EWA        Y02027 41240010
         BCTR  RA,ZERO                  REDUCE NAME CONT BY ONE  Y02027 41260010
*                                       FOR EXECUTE INSTRUCTION  Y02027 41280010
         EX    RA,MOVENAME              MOVE THE TERMINAL NAME   Y02027 41300010
*                                       TO THE ERP WORK AREA     Y02027 41350010
         ST    RTERM,LCBERCCW+16        ADDRESS OF COUNTERS             41400010
         CLC   1(1,RTERM),2(RTERM)      CHECK COUNTS                    41420010
         BH    NOADD                    OKAY                            41440010
         MVC   1(1,RTERM),2(RTERM)      SET REALISTIC COUNT             41460010
NOADD    EQU   *                                                        41480010
         SR    RA,RA                    CLEAR WORK REGISTER             41540010
         IC    RWKA,TRMTEMPR            COUNT FO TEMP ERRORS            41600010
         LA    RWKA,1(,RWKA)            BUMP COUNT                      41700010
         STC   RWKA,TRMTEMPR            DAVE BACK                       41800010
         IC    RA,LCBERMSK              ASSUME LINE MASK USED           41900010
         LA    RWKB,LCBERMSK            ASSUME LINE MASK                42000010
         TM    LCBERMSK,X0F             LINE MASK SET                   42100010
         BNZ   UPDATE                   BRANCH YES                      42200010
         SPACE                                                          42300010
         IC    RA,TRMSENSE              MASK BYTE                       42400010
         LA    RWKB,TRMSENSE            ADJUST FOR TERMINAL LMASK       42500010
UPDATE   EQU   *                                                        42600010
         TM    0(RWKB),X0F              ANY RECORDING TO BE DONE        42700010
         BZ    NORECORD                 BRANCH NO                       42800010
         STC   RA,LCBERCCW              SAVE MASK IN WORK AREA          42900010
         TM    0(RWKB),ANYERR           INTENSIVE MOSDE SET             43000010
         BZ    NORECORD                 BRANCH NO MASK SET              43100010
         SPACE                                                          43200010
         BO    GOSDR                    BRANCH INTENSIVE                43300010
         SPACE                                                          43400010
         NI    LCBERCCW,XF0             CLEAR COUNT FIELD               43450010
         CLI   LCBERCCW,MOD2            MODEL TWO RECORDING             43500010
         BNE   NOTMOD2                  NO                              43550010
         CLI   LCBRESTR,TPRDRSPD        ADDRESSING RESPONSE             43700010
         BNE   NORECORD                 NO                              43800010
         SPACE                                                          43900010
         B     DECRCNT                  DECREMENT COUNT , GO TO /BR     44000010
         SPACE                                                          44200010
NOTMOD2  EQU   *                                                        44300010
         XC    EWTCGRA(ONE),EWTCGRA     CLEAR GRAPHIC RESPONSE   Y02027 44330010
*                                       CHARACTER                Y02027 44360010
         CLI   LCBERCCW,UNEXMSK         CHECK FOR INTENSIVE MODE S22025 44400010
         BH    NORECORD                 BRANCH IF YES            S22025 44500010
         SPACE                                                          44600010
         LR    RWKA,RA                  SAVE MASK                       44700010
         BL    TESTUNCK                 TEST SENSE BYTE                 44800010
         SPACE                                                          44900010
         TM    LCBCSWSV+3,UNEX          UNIT EXCEPTION ERROR            45000010
         BNZ   GOSDR                    RECORD ERROR             S21903 45050010
NORECORD EQU   *                                                        45100010
         CLI   TRMTEMPR,AVTEFF          OVERFLOW CONDITION              45110010
         BE    OVERFL                   BRANCH IF IOHALT         Y02027 45120010
         SPACE                                                          45130010
         CLC   TRMSIO,AVTCLRHI+2        SIO COUNTER OVERFLOW     S21903 45133010
         BNE   APPRET                   BRANCH NO                       45136010
OVERFL   EQU   *                                                        45140010
         OI    EWTCFLG,EWTCOVF          INDICATE SIO COUNTER     Y02027 45150010
*                                       OVERFLOW                 Y02027 45155010
         B     LOADSDR                  USE COMMON CODE                 45160010
HIORET   EQU   *                                                        45170010
         NI    IOSFLA,X'FF'-(IOSERR+IOSEX) RESET ERP IN CNYRL    Y02027 45180010
APPRET   EQU   *                                                        45200010
*********************************************************************** 45200310
*                                                                     * 45200610
*        THE FOLLOWING CODE IS ADDED FOR AOS.                         * 45200910
*                                                                     * 45201210
         BAL   RXCTL,HIOSUB             CHECK FOR IOHALT         Y02027 45201510
         SPACE 1                                                 Y02027 45201810
         TM    IOSFLA,IOSERR+IOSEX      ARE WE DOING A RETRY     Y02027 45202110
         BNO   NOTRETRY                 BRANCH IF NO.            X01004 45202410
         L     RTST,IOSUSE              PICKUP ADDR OF RQE       Y02027 45202710
         LR    RSAVE,RIOSB              SAVE IOSB ADDRESS        Y02027 45203010
         LA    RLCB,LCBFLAG1            IOB ADDRESS TO SIO       Y02027 45203310
*                                       FOR USE BY SIO APPENDAGE.X01004 45203610
         L     RTERM,EIGHT(,RTST)       GET DEB ADDRESS FROM RQE X01004 45203910
         LA    R15,DEBNMSUB-IEDQDEB     GET APDG. TABLE SIZE     Y02027 45204210
         SLR   RTERM,R15                POINT TO APDG. TABLE     Y02027 45204510
         L     RTERM,SIOPTR(,RTERM)     GET ADDRESS OF SIO APDG. X01004 45204810
*                                       FROM APDG. VECTOR TABLE. X01004 45205110
         SR    R15,R15                  CLEAR R15 TO TELL SIO    X01004 45205410
*                                       APDG. IT'S A SUBROUTINE. X01004 45205710
         BAL   RXCTL,SIOENTRY(,RTERM)   LINK TO SIO APPENDAGE AT X01004 45206010
*                                       OFFSET +16 TO CONVERT    X01004 45206310
*                                       CCW'S TO REAL.           X01004 45206610
         LR    RIOSB,RSAVE              RESTORE IOSB ADDR        Y02027 45206910
*                                                                     * 45207210
*        END OF CODE ADDED FOR AOS.                                   * 45207510
*                                                                     * 45207810
*********************************************************************** 45208110
NOTRETRY EQU   *                                                 X01004 45208410
         SVC   EREXCP                                                   45210010
         SPACE                                                          45220010
         SVC   RETURN                                                   45230010
         SPACE 2                                                        45240010
TESTUNCK EQU   *                                                        45400010
         SRL   RWKA,4                   AHKFT MASK FOR INDEX            45500010
         IC    RWKA,TABLE-1(RWKA)       GET ASSOCIATED SENSE MASK       45600010
         EX    RWKA,TMMASK              THIS THE ERROR                  45700010
         BZ    NORECORD                 BRANCH NO                       45800010
GOSDR    EQU   *                                                        45900010
         MVC   LCBRESTR(1),LCBRESTR+1   TP OP CODE OF 1ST FAILURE       46000010
DECRCNT  EQU   *                                                        46050010
         BCTR  RA,0                     DECREMENT RECORDING COUNT       46100010
         STC   RA,0(RWKB)               SAVE MASK BACK                  46200010
         SPACE                                                          46300010
         STC   RA,EWTCMSK               MOVE RECORDING MASK TO   Y02027 46400010
*                                       RECORD                   Y02027 46430010
         OI    EWTCFLG,EWTCTEM          INDICATE TEMPORARY ERROR Y02027 46460010
LOADSDR  EQU   *                                                        46500010
         MVC   EWTCSIO(THREE),TRMSIO    MOVE START I/O AND TEMP  Y02027 46550010
*                                       ERROR COUNTERS TO THE    Y02027 46552010
*                                       ERP WORK AREA            Y02027 46554010
         XC    TRMSIO(THREE),TRMSIO     CLEAR ERROR COUNTERS IN  Y02027 46556010
*                                       THE TERMINAL TABLE       Y02027 46558010
         MVC   EWTCTPF(ONE),LCBRESTR    MOVE 1ST TP OP CODE TO   Y02027 46560010
*                                       OBR/SDR RECORD           Y02027 46562010
         MVC   EWTCTPL(ONE),LCBRESTR+ONE MOVE LAST TP OP CODE TO Y02027 46564010
*                                       OBR/SDR RECORD           Y02027 46566010
         MVC   EWTCSNF(ONE),LCBSNSV     MOVE 1ST BYTE OF SENSE   Y02027 46568010
*                                       DATA TO OBR/SDR RECORD   Y02027 46570010
         MVC   EWTCSNL(ONE),LCBSENS0    MOVE LAST BYTE OF SENSE  Y02027 46572010
*                                       DATA TO OBR/SDR DATA     Y02027 46574010
         LA    RWKA,EWTCSIO             INDICATE ADDR OF START   Y02027 46576010
         STCM  RWKA,SEVEN,EWADDISP      DEVICE DEPENDENT INFO    Y02027 46578010
*                                       FOR OBR/SDR              Y02027 46580010
         MVI   EWADCNT,OBRDATA          INDICATE SIZE OF DEVICE  Y02027 46582010
*                                       DEPENDENT DATA FOR OBR   Y02027 46584010
         OI    IOSFLB,IOSLOG            INDICATE REQUEST FOR     Y02027 46586010
*                                       OBR/SDR                  Y02027 46588010
         LA    RLINK,SDRLOAD            SDR ID                          46600010
         L     RCVT,CVTPTR              CVT ADDRESS              Y02027 46630010
         L     RXCTL,CVTXTLER           XCTL ENTRY ADDRESS       Y02027 46660010
HIOSUB   EQU   *                                                 Y02027 46700010
**************************************************************** Y02027 46705010
*        THE FOLLOWING CODE MAPS THE NECESSARY FIELDS FROM THE   Y02027 46710010
*        LINE CONTROL BLOCK TO THE I/O SUPERVISOR BLOCK FOR EXCP Y02027 46715010
*        COMPATABILITY DURING RETRY OPERATIONS FROM ERP          Y02027 46720010
**************************************************************** Y02027 46725010
         MVC   IOSCSW(SEVEN),LCBCSW     MAP CSW FROM LCB TO IOSB Y02027 46730010
         MVC   IOSSNS(TWO),LCBSENS0     MAP SENSE INFO FROM LCB  Y02027 46735010
*                                       INTO IOSB                Y02027 46740010
         MVC   IOSCC(ONE),LCBSIOCC      MAP START I/O CONDITION  Y02027 46745010
*                                       CODE FROM LCB TO IOSB    Y02027 46750010
         CLI   LCBECBCC,HIOCC           IOHALT ISSUED            Y02027 46755010
         BNER  RXCTL                    BRANCH NO - RETURN       Y02027 46760010
         SPACE 1                                                 Y02027 46765010
         NI    IOSFLA,X'FF'-(IOSERR+IOSEX) RESET ERP IN CTL      Y02027 46770010
         MVI   LCBINCAM+1,HIOCC         SET FOR LINEEND          Y02027 46775010
         BR    RXCTL                    LINK/RETURN TO CALLER           46780010
         SPACE                                                          46800010
PERMEXIT EQU   *                                                        48500010
         MVI   LCBINCAM+1,POPERM        RETURN TO 504G                  48600010
         B     LOAD504G                 NEXT MODULE                     48700010
         SPACE                                                          48800010
         EJECT                                                          49300010
*   THE FOLLOWING CODE INITIALIZES REGISTER 13 (LINKAGE REGISTER).      49400010
* THE VALUE OF RLINK INDICATES TO IOS THE NEXT ERP MODULE TO BE         49500010
* LOADED                                                                49600010
LOAD904G EQU   *                                                        49700010
         LA    RLINK,D1000(R0,RLINK)    INDEX FOR NEXT LOAD             49800010
LOAD804G EQU   *                                                        49900010
         LA    RLINK,2000(,RLINK)       INDEX - NEXT LOAD               50000010
LOAD604G EQU   *                                                        50100010
         LA    RLINK,D1000(R0,RLINK)    INDEX-NEXT LOAD                 50200010
LOAD504G EQU   *                                                        50300010
         LA    RLINK,D1000(R0,RLINK)    INDEX-NEXT LOAD                 50400010
LOAD404G EQU   *                                                        50500010
         LA    RLINK,D1000(R0,RLINK)    INDEX-NEXT LOAD                 50600010
LOAD304G EQU   *                                                        50700010
         LA    RLINK,D1000(R0,RLINK)    INDEX-NEXT LOAD                 50800010
LOAD204G EQU   *                                                        50900010
         LA    RLINK,D1000(R0,RLINK)    INDEX-NEXT LOAD                 51000010
LOAD104G EQU   *                                                        51100010
         LA    RLINK,D1000(R0,RLINK)    INDEX-NEXT LOAD                 51200010
         LA    RLINK,X4G(R0,RLINK)      4G LAST TWO CHARACTERS OF       51300010
         L     RCVT,CVTPTR              PICKUP ADDR OF CVT       Y02027 51400010
         L     RXCTL,CVTXTLER           XCTL ROUTINE ADDRESS     S21903 51500010
         BR    RXCTL                    CALL NEXT ERP LOAD              51600010
         EJECT                                                          51630010
*              CONSTANTS                                                51660010
LCBSIZE  DC    AL2(LCBFLAG1-IEDQLCB)    AIZE OF LCB UP TO IOB           51700010
H8       DC    H'8'                     USED TO BACK UP CCW OR   S22025 51940010
*                                       CSW POINTER              S22025 52010010
TMMASK   EQU   *                                                        52100010
         TM    LCBSNSV,0                TEST FR OBR,SDR RECRODING       52200010
MOVENAME MVC   EWTCTRM(ZERO),ZERO(RWKC) MOVE TERMINAL NAME INTO  Y02027 52300010
*                                       THE ERP WORK AREA        Y02027 52400010
TABLE    EQU   *                                                        52600010
         DC    X'01'                    TIME OUT                        52700010
         DC    X'02'                    LOST DATA                       52800010
         DC    X'04'                    OVERRUN                         52900010
         DC    X'08'                    DATA CHECK                      53000010
         DC    X'10'                    EQUIPMENT CHECK                 53100010
         DC    X'20'                    BUS OUT                         53200010
         DC    X'40'                    INTERVENTION REQUIRED           53300010
         DC    X'80'                    COMMAND REJECT                  53400010
         SPACE 3                                                        53410010
* EQUATES.                                                              53420010
AD       EQU   7                        MASK FOR ICM             Y02027 53425010
         SPACE                                                          53430010
SIOPTR   EQU   4                        OFFSET TO SIO APPENDAGE  X02004 53440010
INTENTRY EQU   4                        SECOND ENTRY OFFSET IN   X02004 53450010
*                                       IGG019QE                 X02004 53460010
IOBPTR   EQU   4                        OFFSET OF IOB ADDRESS IN X02004 53470010
*                                       RQE.                     X02004 53480010
ALL      EQU   15                       ICM MASK - ALL 4 BYTES.  X02004 53490010
HIOCC    EQU   X'48'                    HALT I/O COMPLETION CODE Y02027 53500010
SDRLOAD  EQU   256                      SDR MODULE ID                   54000010
OVERRUN  EQU   X'04'                    OVERRUN MASK IN SENSE BYTE      54200010
UNEXMSK  EQU   X'90'                    UNIT EXCEPTION MASK             54400010
ANYERR   EQU   X'F0'                    INTENSIVE MODE MASK             54500010
X0F      EQU   X'0F'                    WORK MASK FOR RECORDINGS        54600010
XF0      EQU   X'F0'                    UCB CONTROL UNIT MASK           54700010
RETRY    EQU   X'02'                    RETRY LIMIT                     55100010
IOBOFFST EQU   4                        IOB OFFSET IN RQE               55400010
ERPCTL   EQU   X'24'                    MASK ERP IN CONTROL             55500010
CHDATCHK EQU   X'08'                    MASK-CHANNEL DATA CHECK         55800010
CONTCHK  EQU   X'04'                    MASK-CHANNEL CONTROL CHECK      55900010
INTCHK   EQU   X'02'                    MASK-INTERFACE CHECK            56000010
ATSMBY   EQU   X'D0'                    MASK-UNUSUAL STATUS    @OZ14171 56100010
UNITCHK  EQU   X'02'                                                    56300010
UCBOFFST EQU   2                        OFFSET TO UCB ADDRESS -RQE      56400010
EIGHT    EQU   8                                                        56500010
THREE    EQU   3                                                        57000010
MOD2     EQU   X'A0'                    RECORD MASK FOR MODEL 2         57200010
TEXTRTRY EQU   4                        RTURN FOR 104G                  57300010
CC3      EQU   X'30'                    SIO CONDITION CODE TEST         57400010
ZERO     EQU   0                                                        57700010
ONE      EQU   1                                                 Y02027 57760010
TWO      EQU   2                                                 Y02027 57820010
TWELVE   EQU   12                                                Y02027 57880010
BLANK    EQU   X'40'                                             Y02027 57940010
OBRDATA  EQU   18                       SIZE OF DEVICE DEPENDENT Y02027 58000010
*                                       DATA FOR OBR/SDR         Y02027 58060010
SEVEN    EQU   7                                                 Y02027 58120010
DATCHK   EQU   X'08'                    DAT ACHECK IN SENDE             58200010
UNEX     EQU   X'01'                    UNIT EXCEPTION-CSW STATUS       58300010
EREXCP   EQU   15                       ERROR EXCP                      58400010
RETURN   EQU   3                                                        58500010
D1000    EQU   1000                                                     58600010
HIO      EQU   X'48'                    ECB COMPLETION FOR HIO          58700010
X4G      EQU   47                       INDEX VALUE FOR ERP LINKAGE     58900010
CHCKPROT EQU   X'11'                    CHAING OR PROT CHECK            59000010
PC       EQU   X'20'                    PROGRAM CHECK                   59100010
POSNO    EQU   16                       RETURN INDICATOR - 504G         59300010
UNUSRET  EQU   12                       INDEX FOR 504G                  59400010
POPERM   EQU   20                       RETURN INDEX FOR 504G           59500010
DEBPTR   EQU   9                        OFFSET OF DEB ADDR. IN RQE.     59500310
SIOENTRY EQU   34                       OFFSET OF SUBRTNE. ENTRY Y02027 59501210
*                                       POINT IN SIO APPENDAGE.         59501510
DEVCLASS EQU   18                       DEVICE CLASS OF UCB     SA51090 59502010
TTY3     EQU   X'12'                    UCBTYPE2 OFFSET          S99228 59502110
UNITYPE  EQU   19                       UNIT TYPE OF UCB        SA51090 59504010
TTY4     EQU   X'13'                    UCBTYPE3 OFFSET          S99228 59504110
X40      EQU   X'40'                                            SA51090 59506010
GRAPHICS EQU   X'10'                    GRAPHICS DEVICE          S99228 59506110
LCL3277  EQU   X'09'                    3270 LOCAL MODEL CODE    S99228 59508010
EQCKLD   EQU   X'12'                    EQUIPMENT CHECK OR LOST  S22025 59510010
*                                       DATA IN SENSE            S22025 59520010
TO       EQU   X'01'                    TIME OUT IN SENSE        S22025 59530010
BOIR     EQU   X'60'                    BUS OUT OR INTERVENTION  S22025 59540010
*                                            REQUIRED IN SENSE   S22025 59550010
         EJECT                                                          59600010
         TTRMD                                                          59700010
         TDEBD                                                   X02004 59760010
         EJECT                                                          59820010
         TCCWD                                                          59900010
         TLCBD                                                          60000010
         TTNTD                                                          60100010
         DCBD  DSORG=TX                                                 60200010
         TAVTD                                                          60300010
         TSCBD                                                          60400010
         TTPD                                                           60500010
         IECDIOSB                                                Y02027 60510010
         IHAPSA                                                         60520010
         EJECT                                                          60530010
CVTDSECT CVT   DSECT=YES                                         X02004 60560010
         IECDERWA EWTC                                                  60580010
         TTCXD                                                 @ZA00227 60590010
         END                                                            60600010
