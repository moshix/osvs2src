         TITLE 'IGE0100I       LOAD 2       1/2 INCH MAG TAPE ERP''S'   00050003
         MACRO                                                          00060003
         DATEM                                                          00070003
         LCLC  &FILL                                                    00080003
&FILL    SETC  'CL8'.''''.'&SYSDATE'.''''                               00090003
         DC    &FILL                                                    00092003
         MEND                                                           00094003
IGE0100I START X'00'                   LOAD 2                           00100003
*                                                                       00150003
*********************************************************************** 00200003
*                                                                     * 00250003
* STATUS:                                                             * 00300003
*    CHANGE LEVEL:  VS2/REL3                                          * 00350003
*                                                                     * 00400003
* FUNCTION/OPERATION:                                                 * 00450003
*    PART 1 - ERP ERRORS                                              * 00500003
*        1.  PRINT A MESSAGE AND REISSUE SIO IF ERG.  CONTINUE IF     * 00550003
*            NOISE ON USER READ OR NOISE ON ERP READ.                 * 00600003
*        2.  PRINT A MESSAGE AND REISSUE SIO IF AN UNSOLICITED        * 00650003
*            DEVICE END FROM A NEW DEVICE TYPE.                       * 00700003
*        3.  PRINT A MESSAGE AND EXIT WITH PERMANENT ERROR IF AN      * 00750003
*            IOB INTERCEPT ON DATA SECURITY ERASE ON A NEW            * 00800003
*            DEVICE TYPE.                                             * 00850003
*        4.  EXIT WITH PERMANENT ERROR IF OTHER IOB INTERCEPT         * 00900003
*            CONDITION                                                * 00950003
*        5.  HANDLE UNIT CHECK DURING REPOSITIONING                   * 01000003
*    PART 4 - TAPE ERRORS                                             * 01050003
*        1.  HANDLE ERRORS OTHER THAN NORMAL DATA CHECK ON READ       * 01100003
*            OR WRITE TYPE COMMANDS AND REPOSITIONING ERRORS.         * 01150003
*        2.  ENTERED FROM LOAD 1 FOR:                                 * 01200003
*            A.  UNIT CHECK AND NO SENSE DATA                         * 01250003
*            B.  UNIT CHECK AND SENSE - CR, IR, BO, EQ, OR            * 01300003
*            C.  LOAD POINT ON READ                                   * 01350003
*            D.  CHANNEL DATA CHECK                                   * 01400003
*    PART 9 - ICC AND CCC                                             * 01450003
*        1.  ANALYZE THE ERROR RECOVERY INTERFACE BLOCK (ERPIB)       * 01500003
*            TO DETERMINE WHETHER OR NOT A CHANNEL ERROR CONDITION    * 01550003
*            CAN BE RETRIED.                                          * 01600003
*        2.  IF SO, THE CHANNEL PROGRAM IS RETRIED ONLY ONCE.         * 01650003
*        3.  IF THE ERROR IS NOT RECOVERED ON RETRY OR IS A NON-      * 01700003
*            RETRIABLE TYPE, THEN IT IS TO BE CONSIDERED A            * 01750003
*            PERMANENT ERROR.  THE LOGOUT BIT IS SET AND CONTROL      * 01800003
*            IS TRANSFERRED TO THE WRITE-TO-OPERATOR ROUTINE.         * 01850003
*                                                                     * 01900003
* ENTRY POINTS:                                                       * 01950003
*        ER2402 IS CALLED BY IGE0000I (LOAD 1) VIA XCTL               * 02000003
*                                                                     * 02050003
* INPUT:                                                              * 02100003
*    REGISTER 1 CONTAINS A POINTER TO THE IOSB                        * 02150003
*                                                                     * 02200003
* OUTPUT:                                                             * 02250003
*    SEVEN SPECIAL CONSOLE MESSAGES - VIA SVC 35                      * 02300003
*        ERRMSG1   'ERROR ON ERG'                                     * 02350003
*        ERRMSG2   'NOISE - USER'                                     * 02400003
*        ERRMSG3   'NOISE - ERP '                                     * 02450003
*        ERRMSG4   'UNEX INTRPT '                                     * 02500003
*        ERRMSG5   'DSE FAILED  '                                     * 02550003
*        ERRMSG6   'CTRL BLK ERR'                                     * 02600003
*        ERRMSG7   'UNEX LOAD PT'                                     * 02650003
*                                                                     * 02700003
* EXTERNAL ROUTINES:                                                  * 02750003
*    INTERPRETER ROUTINE - CHECKS SENSE & STATUS BITS                 * 02800003
*                                                                     * 02850003
* EXITS - NORMAL:                                                     * 02900003
*         1.  SVC 15/3 EXIT TO IOS TO REPOSITION TAPE AND TO          * 02950003
*             REEXECUTE THE CHANNEL PROGRAM.                          * 03000003
*         2.  XCTL TO IGE0000I (LOAD 1)                               * 03050003
*         3.  XCTL TO IGE0025C (WTO ROUTINE)                          * 03100003
*         4.  XCTL TO IGE0025F (OBR ROUTINE)                          * 03150003
*                                                                     * 03200003
* EXITS - ERROR:  N/A                                                 * 03250003
*                                                                     * 03300003
* TABLES/WORK AREAS:                                                  * 03350003
*    THE ERPIB TABLE IS ANALYZED TO DETERMINE IF THE ERROR            * 03400003
*    CONDITION CAN BE RETRIED.                                        * 03450003
*                                                                     * 03500003
* ATTRIBUTES:                                                         * 03550003
*    REENTRANT                                                        * 03600003
*                                                                     * 03650003
* NOTES:                                                              * 03700003
*    VS2/REL2 - LOADS 2, 4, 8 & 9 OF PREVIOUS RELEASES HAVE           * 03750003
*    BEEN COMBINED TO CREATE LOAD 2 OF THIS RELEASE.                  * 03800003
*    THIS LOAD INCLUDES:                                              * 03850003
*        1.  HANDLING ALL ERP-GENERATED ERRORS                        * 03900003
*        2.  HANDLING TAPE ERRORS OTHER THAN NORMAL DATA CHECK        * 03950003
*            ON READ OR WRITE.                                        * 04000003
*        3.  INTERFACE CONTROL CHECK                                  * 04050003
*        4.  CHANNEL CONTROL CHECK                                    * 04100003
*                                                                     * 04150003
*    PTM YM6412  REPOSITION BIT NOT TURNED OFF ON PERM ERR EXIT       * 04200003
*    APAR FIX TO IOSGEN MACRO USAGE                          @OZ00664 * 04210003
*    APAR FIX TO IOSGEN MACRO USAGE                          @ZA05134 * 04220003
*    FIX FOR LOW CORE OVERLAY PROBLEM                        @ZA14748 * 04230003
*    ROUTE AND DESCRIPTOR CODES                              @ZA30415 * 04240037
*    TURN ON EWADDMSG FOR WTO                                @ZA31011 * 04245037
*********************************************************************** 04250003
         EJECT                                                          04300003
*              R E G I S T E R   A S S I G N M E N T S                  04350003
*                                                                       04400003
R0       EQU   0                       WORK REG                         04450003
R1       EQU   1                       WORK REG                         04500003
IOSREG   EQU   1                       IOSB REG                         04550003
MSGREG   EQU   2                       MESSAGE REGISTER                 04600003
CCWREG   EQU   3                       CCW ADDRESS REG                  04650003
R4       EQU   4                       WORK REGISTER                    04700003
R5       EQU   5                       WORK REGISTER                    04750003
UCBREG   EQU   7                       UCB ADDRESS REGISTER             04800003
UXREG    EQU   8                       UCB EXTENSION ADDRESS            04850003
SAVREG   EQU   9                       SAVE REGISTER                    04900003
EWAREG   EQU   10                      EXTENDED WORK AREA               04950003
R11      EQU   11                      WORK REGISTER                    05000003
R13      EQU   13                      WORK REGISTER                    05050003
LNKREG   EQU   14                      LINK REGISTER                    05100003
XCTLREG  EQU   14                      RETURN REGISTER FOR XCTL         05150003
BASREG   EQU   15                      BASE REGISTER                    05200003
         EJECT                                                          05250003
*                                                                       05300003
*                U S E R   C C W   D S E C T                            05350003
*                                                                       05400003
CCW      DSECT                         ERROR CCW IN USER'S CHAIN        05450003
CCWOP    DS    CL1                     CCW COMMAND CODE                 05500003
         ORG   CCWOP                   **                               05550003
CCWADR   DS    CL4                     CCW DATA ADDRESS                 05600003
CCWFLS   DS    CL2                     CCW FLAGS                        05650003
CCWCNT   DS    CL2                     CCW BYTE COUNT                   05700003
         EJECT                                                          05750003
*                                                                       05800003
*   EWACNT1 - ERROR COUNT 1 REFERENCES                                  05850003
*                                                                       05900003
OVRCNT5  EQU   X'50'                   OVERRUN COUNT MAX. VALUE         05950003
WRTIND   EQU   X'80'                   INDICATOR TO STAT ROUTINE        06000003
ERPCTL   EQU   X'08'                   ERP CONTROL FLAG                 06050003
ICCFLG   EQU   X'80'                   ICC/CCC FLAG                     06100003
*                                                                       06150003
*                                                                       06160003
*   EWAFLG3 - EWA FLAG 3 REFERENCES                                     06200003
*                                                                       06250003
EWTROR   EQU   X'80'                   READ OPPOSITE IN PROGRESS        06300003
EWTRTN2  EQU   X'40'                   RETURN FROM LOAD 2               06350003
EWTTPC   EQU   X'20'                   TAPE CLEANING BIT                06400003
EWTBKS   EQU   X'10'                   BACKSPACE ERASE CLEANING FLAG    06450003
EWTOVER  EQU   X'08'                   SDR OVERFLOW                     06500003
EWTPT4A  EQU   X'04'                   ENTRY FOR LOAD 2, PART 4A        06550003
EWTPT4B  EQU   X'02'                   ENTRY FOR LOAD 2, PART 4B        06600003
EWTRBLD  EQU   X'01'                   REBUILD IDAL LIST                06650003
*                                                                       06700003
*   EWACNTR3 - EWA COUNTER 3 REFERENCES                                 06750003
*                                                                       06800003
EWTUEX   EQU   X'80'                   UNIT EXCEPTION FLAG              06850003
EWTNB    EQU   X'40'                   NOISE BIT                        06900003
EWTRST   EQU   X'20'                   RESTART FLAG                     06950003
EWTROC   EQU   X'10'                   USE ROR CCW                      07000003
EWTEXIT  EQU   X'02'                   TEMPORARY ERROR EXIT FLAG        07050003
EWTDEP   EQU   X'01'                   DEVICE END POST BIT              07100003
*                                                                       07150003
*   DEB REFERENCES                                                      07200003
*                                                                       07250003
DEBOFL   EQU   8                       DEBOFLGS                         07300003
*                                                                       07350003
*   DCB REFERENCES                                                      07400003
*                                                                       07450003
DCBBLK   EQU   12                      DCB BLOCK COUNT                  07500003
*                                                                       07550003
*   COMMANDS                                                            07600003
*                                                                       07650003
CMDCTL   EQU   X'03'                   CONTROL                          07700003
CMDERG   EQU   X'17'                   ERASE GAP                        07750003
CMDBSR   EQU   X'27'                   BACK SPACE RECORD                07800003
CMDRDB   EQU   X'0C'                   READ BACKWARDS                   07850003
CMDRWU   EQU   X'0F'                   REWIND UNLOAD                    07900003
CMDWRT   EQU   X'01'                   WRITE                            07950003
CMDTIC   EQU   X'08'                   TIC                              08000003
CMDTIE   EQU   X'1B'                   TIE                              08050003
CMDREW   EQU   X'07'                   REWIND                           08100003
CMDRED   EQU   X'02'                   READ COMMAND                     08150003
CMDWTM   EQU   X'1F'                   WRITE TAPE MARK                  08200003
CMDBSF   EQU   X'2F'                   BACKSPACE FILE                   08250003
CMDFSR   EQU   X'37'                   FORWARD SPACE RECORD             08300003
CMDFSF   EQU   X'3F'                   FORWARD SPACE FILE               08350003
CMDNOP   EQU   X'03'                   NOP                              08400003
CMDMD1   EQU   X'03'                   MODE SETS (LO-ORDER 4 BITS)      08450003
CMDBIT4  EQU   X'08'                   MODE SET (BIT 4)                 08500003
CMDBIT5  EQU   X'04'                   MODE SET (BIT 5)                 08550003
CMDSNS   EQU   X'04'                   SENSE                            08600003
*                                                                       08650003
*   STATUS INDICATORS                                                   08700003
*                                                                       08750003
CSWDVE   EQU   X'04'                   DEVICE END                       08800003
CSWUCK   EQU   X'02'                   UNIT CHECK                       08850003
CSWUEX   EQU   X'01'                   UNIT EXCEPTION                   08900003
CSWCDC   EQU   X'08'                   CHANNEL DATA CHECK               08950003
CSWCCC   EQU   X'04'                   CHANNEL CONTROL CHECK            09000003
CSWICC   EQU   X'02'                   INTERFACE CONTROL CHECK          09050003
         EJECT                                                          09100003
*                                                                       09150003
*                  M I S C E L L A N E O U S                            09200003
*                                                                       09250003
APPEND   EQU   X'01'                   APPENDAGE BIT                    09300003
BLANK    EQU   X'40'                   EBCDIC BLANK                     09350003
BLKCNT   EQU   12                      BLK COUNT OFFSET FROM DCB        09400003
CNT3     EQU   X'40'                   3 RETRIES                        09450003
C1       EQU   1                       COUNT OF 1                       09500003
C2       EQU   2                       COUNT OF 2                       09550003
C3       EQU   3                       COUNT OF 3                       09600003
C4       EQU   4                       COUNT OF 4                       09650003
C5       EQU   5                       COUNT OF 5                       09700003
C6       EQU   6                       COUNT OF 6                       09750003
C8       EQU   8                       COUNT OF 8                       09800003
C16      EQU   16                      COUNT OF 16                      09850003
C61      EQU   61                      COUNT OF 61                      09900003
C288     EQU   288                     COUNT OF 288                     09950003
EMUL     EQU   X'10'                   EMULATOR BIT                     10000003
EXCPER   EQU   15                      ERROR EXCP                       10050003
FULL     EQU   X'FF'                   COUNTER FULL                     10100003
HEXC7    EQU   X'C7'                   HEX 'C7'                         10150003
HEX24    EQU   X'18'                   COUNT OF 24                      10200003
HEX80    EQU   X'80'                   HEX '80'                         10250003
HEXF9    EQU   X'F9'                   HEX 'F9'                         10300003
IOSCRC   EQU   X'08'                   CRC FLAG                         10350003
IOSREP   EQU   X'10'                   REPOSITION FLAG                  10400003
LOAD1    EQU   9                       LOAD NAME FOR LOAD 1             10450003
LOC16    EQU   16                      COMMUNICATION VECTOR TABLE       10500003
MASK     DC    X'0000FFFF'             COMPARE MASK                     10510003
PROG     EQU   X'FF'                   ERP IN PROGRESS                  10550003
RETURN   EQU   3                       EXIT SVC                         10600003
SERLOG   EQU   256                     LOAD NAME TO OBR                 10650003
TRCOMMA  EQU   X'EE'                   WILL TRANSLATE TO ','            10700003
VECTXL   EQU   44                      VECTOR TO XCTL ROUTINE           10750003
VECT68   EQU   68                      INTERPRETER ROUTINE              10800003
WTORTN   EQU   253                     LOAD NAME TO WTO ROUTINE         10850003
ZERO     EQU   X'00'                   ZERO                             10900003
*                                                                       10950003
*                                                                       11000003
         EJECT                                                          11050003
*                                                                       11100003
*           MISCELLANEOUS - FOR PART 9                                  11150003
*                                                                       11200003
*   ERPIB BYTE 4 REFERENCES                                             11250003
*                                                                       11300003
IBUNR1   EQU   X'31'                   UNR OR TIO OR HIO                11350003
IBSIB1   EQU   X'C0'                   SIO OR I/O RUPT BITS             11400003
IBSIO1   EQU   X'80'                   SIO BIT                          11450003
IBSNS1   EQU   X'04'                   VALID SENSE                      11500003
*                                                                       11550003
*   ERPIB BYTE 6 REFERENCES                                             11600003
*                                                                       11650003
IBALL2   EQU   X'1C'                   VALIDITY BITS                    11700003
*                                                                       11750003
*   ERPIB BYTE 7 REFERENCES                                             11800003
*                                                                       11850003
IB3001   EQU   X'01'                   00 001                           11900003
IB3002   EQU   X'02'                   00 010                           11950003
IB3003   EQU   X'03'                   00 011                           12000003
IB3004   EQU   X'04'                   00 100                           12050003
IB3005   EQU   X'05'                   00 101                           12100003
IB3041   EQU   X'41'                   01 001                           12150003
IB3042   EQU   X'42'                   01 010                           12200003
IB3043   EQU   X'43'                   01 011                           12250003
IB3045   EQU   X'45'                   01 101                           12300003
IB3081   EQU   X'81'                   10 001                           12350003
IB3082   EQU   X'82'                   10 010                           12400003
IB30C0   EQU   X'C0'                   11 000                           12450003
IGE0100I CSECT                                                          12500003
* A-000000-999999                                                Y026XZ 12550003
         EJECT                                                          12600003
*********************************************************************** 12650003
*                             P A R T   1                             * 12700003
*                                                                     * 12750003
*                             ERP  ERRORS                             * 12800003
*********************************************************************** 12850003
         USING *,BASREG                                                 12900003
         USING IOSB,IOSREG                                              12950003
         USING EWA,EWAREG                                               13000003
         USING UCB,UCBREG                                               13050003
         USING UCBMT,UXREG                                              13100003
         USING CCW,CCWREG                                               13150003
ERP2     B     ER2402                  BRANCH AROUND DECLARE            13200003
         DC    C'** IGE0100I-TAPE ERP 08-21-74 **'       **             13250003
         DS    0F                      ALIGN                            13300003
ER2402   EQU   *                                                        13350003
         L     UCBREG,IOSUCB           GET UCB ADDRESS FROM IOSB        13400003
         SH    UCBREG,H512             POINT TO UCB PREFIX       Y02032 13450003
         L     UXREG,UCBXTN            GET ADDR OF UCB EXTENSION        13500003
*                                                                       13550003
         L     EWAREG,IOSERP           GET EWA ADDR FROM IOSB    Y02032 13600003
         L     CCWREG,IOSCSW-C1        GET ADDRESS TO CCW               13650003
         LA    CCWREG,0(CCWREG)        CLEAR HIGH ORDER BYTE     A29974 13700003
         SH    CCWREG,EIGHT            POINT TO FAILING COMMAND         13750003
*                                                                       13800003
         TM    IOSTSB,CSWCCC+CSWICC    IS ICC OR CCC ON?                13850003
         BC    7,PART9                 YES - GO TO PART 9               13900003
*                                                                       13950003
         TM    EWAFLG3,EWTPT4A         ENTRY TO PART 4A?         Y02032 14000003
         BO    PART4A                  YES - GO TO PART 4               14050003
*                                                                       14100003
         TM    EWAFLG3,EWTPT4B         ENTRY TO PART 4B?         Y02032 14150003
         BO    PART4B                  YES - GO TO PART 4B              14200003
*                                                                       14250003
         CLI   IOSCOD,IOSTAPEC         X'4B' IN COMPLETION CODE? A29974 14300003
         BE    B223                    YES - GO TO PERM ERROR    A29974 14350003
         LA    MSGREG,ERRMSG4          GET ERROR MSG ADDR        S21048 14400003
*                                                                       14450003
         TM    IOSFLC,IOSVERIF         UNSOLICITED DEVICE END?   S21048 14500003
         BO    B325                    YES-GO SET UP WTO MACRO   S21048 14550003
*                                                                       14600003
         CLI   IOSCOD,IOSFINTC         IOB INTERCEPT                    14650003
         BNE   B200                    NO - CONTINUE                    14700003
*                                                                       14750003
*   I O B   I N T E R C E P T                                           14800003
*                                                                       14850003
         TM    UCBTBYT4,UCB3400        3400 TAPE UNIT?                  14900003
         BNO   B100                    NO - BRANCH AROUND DSE    S21048 14950003
         LA    MSGREG,ERRMSG5          SET FOR DSE FAIL MSG      S21048 15000003
         TM    EWTSNS7,EWTDSE          DSE ERR BIT ON IN SENSE?  S21048 15050003
         BO    B325                    YES-GO SET UP WTO MACRO   S21048 15100003
*                                                                       15150003
B100     EQU   *                                                        15200003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA   RESET ERP FLAGS   @YM06412 15250003
         MVI   IOSCOD,IOSINTC          SET INTERCEPT CODE TO X'44'      15300003
         B     B370                    EXIT ERP VIA SVC 15/3 OR OBR     15350003
         EJECT                                                          15400003
*                                                                       15450003
*                        U N I T   C H E C K                            15500003
*                                                                       15550003
*        HAVE UNIT CHECK - CHECK SENSE IN SEQUENCE                      15600003
*        1.  DATA CHECK, NOT REPOSITIONING, IS NOISE RECORD             15650003
*        2.  ALL OTHER CONDITIONS ARE UNIT CHECK DURING REPOSITIONING   15700003
*              BUS OUT                 POSSIBLE ANYTIME                 15750003
*              INTERVENTION REQUIRED   POSSIBLE ANYTIME                 15800003
*              LOAD POINT              BSR ONLY                         15850003
*              DATA CHECK              ERG ONLY                         15900003
*              OVERRUN ERG                                              15950003
*              ANY OTHER SENSE         LOGOUT                           16000003
*        3.  EQUIPMENT CHECK IS VALID ERROR ONLY WITH DEVICE END        16050003
*                                                                       16100003
*        REGS 0,9,11,12,14,15 ARE AFFECTED BY INTERPRETER               16150003
*                                                                       16200003
B200     EQU   *                                                        16250003
         TM    EWTSNS0,EWTEQU          EQUIPMENT CHECK?          Y02032 16300003
         BZ    B205                    NO - CONTINUE TEST        Y02032 16350003
         TM    IOSTSA,CSWDVE           DEVICE END?               Y02032 16400003
         BO    D840                    YES - XCTL TO WTO         Y02032 16450003
*                                                                       16500003
B205     EQU   *                                                        16550003
         LR    SAVREG,BASREG           SAVE REG 15                      16600003
         L     BASREG,LOC16            GET ADDR OF CVT                  16650003
         L     BASREG,VECT68(BASREG)   GET INTERPRETER ADDRESS          16700003
B210     EQU   *                                                        16750003
         BALR  LNKREG,BASREG           LINK TO INTERPRETER RTN          16800003
*                                                                       16850003
         DC    X'02'                   BUS OUT CHECK                    16900003
         DC    AL1(B220-B210-2)        *                                16950003
         DC    X'01'                   INTERVENTION REQUIRED            17000003
         DC    AL1(B240-B210-4)        *                                17050003
         DC    X'00'                   COMMAND REJECT                   17100003
         DC    AL1(B250-B210-6)        *                                17150003
         DC    X'05'                   OVERRUN                          17200003
         DC    AL1(B220-B210-8)        *                                17250003
         DC    X'0C'                   LOAD POINT                       17300003
         DC    AL1(B260-B210-10)       *                                17350003
         DC    X'04'                   DATA CHECK                       17400003
         DC    AL1(B270-B210-12)       *                                17450003
         DC    X'2F'                   END OF TEST                      17500003
         DC    AL1(B250-B210-14)       *                                17550003
*                                                                       17600003
*   B U S   O U T   C H E C K ,   O V E R R U N                         17650003
*                                                                       17700003
B220     EQU   *                                                        17750003
         TM    EWACNTR1,OVRCNT5        5 BUS OUTS?               Y02032 17800003
         BO    D840                    YES - XCTL TO WTO                17850003
*                                                                       17900003
         IC    R13,EWACNTR1            GET COUNT                 Y02032 17950003
         LA    R13,C16(R13)            ADD ONE TO COUNT                 18000003
         STC   R13,EWACNTR1            STORE COUNT               Y02032 18050003
*                                                                       18100003
         LTR   CCWREG,CCWREG           NEGATIVE ADDRESS?         A29974 18150003
         BNM   B225                    NO - CONTINUE             A29974 18200003
B222     EQU   *                                                        18250003
         MVI   IOSCOD,IOSTAPEC         PUT X'4B' IN IOSB CODE    A29974 18300003
B223     EQU   *                                                        18350003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA  MARK AS PERM ERROR @YM06412 18400003
         LA    MSGREG,ERRMSG6          SET FOR CONTROL BLK MSG   A29974 18450003
         B     B327                    GO SET UP MSG FOR WTO     A29974 18500003
*                                                                       18550003
B225     EQU   *                                                        18600003
         CLI   CCWOP,CMDCTL            BUS OUT ON NOP?           A29974 18650003
         BNE   B405                    NO - BSR DONE - SVC 15/3         18700003
*                                                                       18750003
*   HAD BUS OUT ON NOP COMMAND FETCH.                                   18800003
*   GO TO LOAD 1 - IGNORE BUS OUT.                                      18850003
*                                                                       18900003
         OI    EWAFLG3,EWTRTN2         SET LOAD 2 RETURN BIT     Y02032 18950003
         LA    R13,LOAD1               GET LOAD 1 ADDRESS               19000003
         B     XCTL3                   XCTL TO LOAD 1                   19050003
*                                                                       19100003
*   I N T E R V E N T I O N   R E Q U I R E D                           19150003
*                                                                       19200003
B240     EQU   *                                                        19250003
         TM    IOSTSA,CSWDVE           DEVICE END?                      19300003
         BO    B245                    YES - SET UP MESSAGE      Y02032 19350003
*                                                                       19400003
         TM    EWTSNS1,EWTSTA+EWTSTB   NON-EXISTENT UNIT?        Y02032 19450003
         BZ    D840                    YES - PERM ERROR, XCTL TO WTO    19500003
         B     D870                    NO - XCTL TO WTO          Y02032 19550003
*                                                                       19600003
B245     EQU   *                                                        19650003
         LA    MSGREG,ERRMSG1          SET FOR 'ERASE GAP' MSG          19700003
         TM    IOSSNS,EWTDATA          IS IT DATA CHECK?         Y02032 19750003
         BO    B270                    YES - MUST BE ERG                19800003
*                                                                       19850003
*   E Q U I P   C H E C K,    D A T A   C H E C K,                      19900003
*   C O M M A N D   R E J E C T   OR NONE                               19950003
*                                                                       20000003
B250     EQU   *                                                        20050003
         B     D840                    XCTL TO WTO                      20100003
*                                                                       20150003
*   L O A D   P O I N T                                                 20200003
*                                                                       20250003
B260     EQU   *                                                        20300003
         TM    EWAFLG3,EWTTPC          TAPE CLEANER ACTION       Y02032 20350003
         BO    B380                    YES - GO SET UP TO REPOSITION    20400003
*                                                                       20450003
         MVI   IOSCOD,IOSTAPEC         PUT X'4B' IN IOSB CODE    A29972 20500003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA  MARK PERM ERROR    @YM06412 20550003
         LA    MSGREG,ERRMSG7          SET FOR LOAD POINT MSG    A29972 20600003
         B     B330                    GO SET UP MESSAGE         A29972 20650003
*                                                                       20700003
B270     EQU   *                                                        20750003
         TM    EWAFLG3,EWTROR          ROR IN PROGRESS?          Y02032 20800003
         BO    B280                    YES - CONTINUE                   20850003
         TM    IOSFLA,IOSREP           REPOSITIONING?                   20900003
         BO    B310                    YES - GO UPDATE ERG COUNT        20950003
*                                                                       21000003
B280     EQU   *                                                        21050003
         TM    UCBNB,FULL              IS NOISE COUNT FULL?             21100003
         BO    B290                    YES - BRANCH AROUND COUNT        21150003
         IC    R13,UCBNB               GET NOISE COUNT                  21200003
         LA    R13,C1(R13)             ADD ONE TO COUNT                 21250003
         STC   R13,UCBNB               STORE BACK                       21300003
*                                                                       21350003
B290     EQU   *                                                        21400003
         L     R13,EWTDEB              GET DEB ADDRESS           Y02032 21450003
         CL    R13,FZERO               VALID DEB ADDR            Y02032 21500003
         BE    B300                    NO - SKIP EMULATOR        Y02032 21550003
         TM    DEBOFL(R13),EMUL        IS EMULATOR BIT ON?              21600003
         BZ    B300                    NO - SKIP PERMANENT ERROR BIT    21650003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA  PERMANENT ERROR    @YM06412 21700003
*                                                                       21750003
*   TEST FOR PREVIOUS MESSAGE                                           21800003
*                                                                       21850003
B300     EQU   *                                                        21900003
         TM    EWACNTR3,EWTNB          PREVIOUS MESSAGE?         Y02032 21950003
         BO    B370                    YES - DON'T WRITE MESSAGE        22000003
         OI    EWACNTR3,EWTNB          NO - SET MESSAGE SWITCH   Y02032 22050003
         LA    MSGREG,ERRMSG2          SET FOR USER MESSAGE             22100003
         TM    EWACNTR2,PROG           IS ERP IN PROGRESS?       Y02032 22150003
         BZ    B330                    NO - BRANCH TO WRITE MESSAGE     22200003
         LA    MSGREG,ERRMSG3          YES - SET FOR ERP MESSAGE        22250003
         B     B330                    BRANCH TO WRITE MESSAGE          22300003
*                                                                       22350003
*   UPDATE ERG DATA CHECK COUNT                                         22400003
*                                                                       22450003
B310     EQU   *                                                        22500003
         IC    R13,EWACNTR2            GET ERG COUNTER           Y02032 22550003
         LA    R13,C16(R13)            ADD ONE TO COUNT                 22600003
         STC   R13,EWACNTR2            STORE UPDATED COUNT       Y02032 22650003
         LH    R13,UCBERG              GET ERG COUNT                    22700003
         CH    R13,ALLF                IS COUNT FULL?                   22750003
         BE    B320                    YES - BRANCH AROUND COUNT        22800003
         LA    R13,C1(R13)             ADD ONE TO COUNT                 22850003
         STH   R13,UCBERG              STORE UPDATED COUNT              22900003
*                                                                       22950003
B320     EQU   *                                                        23000003
         LA    MSGREG,ERRMSG1          SET FOR ERG - CONT MESSAGE       23050003
         TM    EWACNTR2,CNT3           THREE RETRIES?            Y02032 23100003
         BO    D840                    YES - XCTL TO WTO                23150003
         B     B330                    NO - SET UP FOR WTO MACRO        23200003
         EJECT                                                          23250003
*                                                                       23300003
*   BUILD OPERATOR MESSAGES AND ISSUE WTO                               23350003
*                                                                       23400003
B325     EQU   *                                                        23450003
         OI    IOSFLA,IOSEX+IOSERR     SET ERP IN CONTROL        S21048 23500003
*                                                                       23550003
B327     EQU   *                                                        23600003
         MVC   EWTWTO(C61),WTOMSG      MOVE MSG AREA TO EWA      Y02032 23650003
         MVC   EWTOPCDE(C2),NULLOP     PUT '***' IN OPCODE       S21048 23700003
         B     B340                    BR - SET UP MESSAGE       S21048 23750003
*                                                                       23800003
B330     EQU   *                                                        23850003
         LTR   CCWREG,CCWREG           NEGATIVE ADDRESS?         A29974 23900003
         BM    B222                    YES - GO SET X'4B'        A29974 23950003
         MVC   EWTWTO(C61),WTOMSG      MOVE MSG AREA TO EWA      Y02032 24000003
         UNPK  EWTOPCDE,CCWOP(C2)      UNPACK OPCODE AND 1 BYTE  Y02032 24050003
*                                                                       24100003
B340     EQU   *                                                        24150003
         OI    EWACNTR2,APPEND         SET SWITCH FOR APPENDAGE  Y02032 24200003
         MVC   EWTUNID(C3),UCBNAME     MOVE TO MESSAGE AREA      Y02032 24250003
*                                                                       24300003
*   MOVE IN MESSAGE TEXT AS POINTED TO BY MSGREG                        24350003
*                                                                       24400003
         MVC   EWTTEXT,0(MSGREG)       MOVE IN MESSAGE           Y02032 24450003
*                                                                       24500003
*   TRANSLATE ALL FIELDS TO PRINTABLE FORM                              24550003
*                                                                       24600003
         MVI   EWTOPCDE+C2,TRCOMMA     TRANSLATE CODE FOR COMMA  Y02032 24650003
*                                                                       24700003
         UNPK  EWTSTAT,IOSTATUS(C3)    UNPACK STATUS + 1 BYTE    Y02032 24750003
         MVI   EWTSTAT+C4,TRCOMMA      TRANSLATE CODE FOR COMMA  Y02032 24800003
*                                                                       24850003
         UNPK  EWTSENSE,IOSSNS(C3)     UNPACK SENSE AND 1 BYTE   Y02032 24900003
         MVI   EWTSENSE+C4,TRCOMMA     TRANSLATE CODE FOR COMMA  Y02032 24950003
*                                                                       25000003
         L     R13,EWTDCB              GET DCB ADDR FROM EWA     Y02032 25050003
         CL    R13,FZERO               VALID DCB ADDR?           Y02032 25100003
         BE    B350                    NO - SKIP BLK COUNT       Y02032 25150003
         UNPK  EWTLOC,DCBBLK(C5,R13)   UNPACK DCB BLOCK COUNT    Y02032 25200003
B350     EQU   *                                                        25250003
         MVI   EWTLOC+C8,TRCOMMA       TRANSLATE CODE FOR COMMA  Y02032 25300003
*                                                                       25350003
         TR    EWTOPCDE(L'EWTOPCDE+L'EWTSTAT+L'EWTSENSE+L'EWTLOC),TRANS 25400003
*                                                                       25450003
*   MOVE IN VOLUME SERIAL NUMBER IF AVAILABLE                           25500003
*                                                                       25550003
         MVC   EWTVOL(C6),UCBVOLI      MOVE IT TO MESSAGE AREA   Y02032 25600003
         CLI   UCBVOLI,ZERO            IS IT A VALID VOL SER?           25650003
         BNE   B360                    YES - BRANCH TO CONTINUE         25700003
*                                                                       25750003
         MVI   EWTVOL,BLANK            NO - MOVE IN BLANKS       Y02032 25800003
         MVC   EWTVOL+C1(C5),EWTVOL    MOVE BLANKS               Y02032 25850003
*                                                                       25900003
*   WRITE THE MESSAGE TO THE OPERATOR AND CONTINUE                      25950003
*                                                                       26000003
B360     EQU   *                                                        26050003
         LR    R11,BASREG              SAVE REG 15                      26100003
         LR    R4,IOSREG               SAVE REG 1                A40906 26150003
         LA    IOSREG,EWTWTO           POINT AT THE MESSAGE      Y02032 26200003
         WTO   MF=(E,(1))              WRITE ON CONSOLE                 26250003
         OI    EWAFLG3,EWTRBLD         FLAG TO REBUILD IDAL LIST S21048 26300003
*                                                                       26350003
         LR    BASREG,R11              RESTORE REG 15                   26400003
         LR    IOSREG,R4               RESTORE REG 1                    26450003
         CLI   IOSCOD,IOSTAPEC         X'4B' COMPLETION CODE?    A29974 26500003
         BE    B370                    YES - SVC 15/3            A29974 26550003
*                                                                       26600003
         CLI   IOSCOD,IOSFINTC         WAS IT AN INTERCEPT?      S21048 26650003
         BNE   B370                    NO - EXIT VIA SVC 15/3    S21048 26700003
*                                                                       26750003
         OI    IOSFLB,IOSLOG           SET LOGOUT                S21048 26800003
         MVI   IOSCOD,IOSINTC          SET INTERCEPT CODE - 44   S21048 26850003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA  SET ERP PERM ERR   @YM06412 26900003
*                                                                       26950003
B370     EQU   *                                                        27000003
         TM    IOSFLC,IOSVERIF         UNSOLICITED DEVICE END?   S21048 27050003
         BZ    B375                    NO - BR AROUND RESET      S21048 27100003
*                                                                       27150003
         LR    R4,UCBREG               SET UP POINTER TO UCB-24  Y02032 27200003
         L     R13,F24                 TO RESET UNSOL. DEV. END  Y02032 27250003
         SR    R4,R13                  SUBTRACT 24               Y02032 27300003
         NI    0(R4),X'FF'-UCBUDE      RESET UNSOL. DEVICE END IN UCB   27350003
         NI    IOSFLC,X'FF'-IOSVERIF   RESET UNSOL. DEVICE END IN IOSB  27400003
*                                                                       27450003
B375     EQU   *                                                        27500003
         TM    EWAFLG3,EWTOVER         IS OVERFLOW ON?           S21048 27550003
         BO    D2040                   YES - XCTL TO OBR         S21048 27600003
         B     B405                    NO - EXIT VIA SVC 15/3           27650003
*                                                                       27700003
*   SET UP TO REPOSITION OFF LOAD POINT                                 27750003
*                                                                       27800003
B380     EQU   *                                                        27850003
         SR    R4,R4                   CLEAR REGISTER                   27900003
         IC    R4,EWACNTR1             GET POSITIONING COUNT     Y02032 27950003
         LA    R13,C3                  MAX COUNT (RF ALWAYS DECR 1)     28000003
         SR    R13,R4                  NUMBER OF BACK SPACES            28050003
         BZ    B410                    ZERO - DONE, EXIT                28100003
*                                                                       28150003
         TM    EWAFLG3,EWTBKS          RD BK TAPE CLEANING?      Y02032 28200003
         BO    B390                    YES - SKIP                       28250003
         BCTR  R13,R0                  READ FWD - ONE LESS RECORD       28300003
*                                                                       28350003
B390     MVI   IOSMDB,CMDFSR           REVERSE DIRECTION                28400003
B400     STC   R13,EWACNTR1            RESTORE POSITIONING COUNT        28450003
         NI    EWAFLG3,X'FF'-EWTTPC-EWTBKS  RESET CLEAN & BKS CLEAN     28500003
*                                                                       28550003
B405     EQU   *                                                        28600003
         SVC   EXCPER                  SVC 15                           28650003
         SVC   RETURN                  SVC 3                            28700003
*                                                                       28750003
B410     EQU   *                                                        28800003
         TM    EWAFLG3,EWTBKS          READ BACK TAPE CLEANING?  Y02032 28850003
         BO    B390                    YES - ONE MORE RECORD TO GO      28900003
         NI    IOSFLA,X'FF'-IOSREP     NO - DONE, NO MORE POSITIONING   28950003
*                                                                       29000003
*   RESTORE DEVICE END POST BIT                                         29050003
*                                                                       29100003
         TM    EWACNTR3,EWTDEP         WAS IT ON ORIGINALLY?     Y02032 29150003
         BO    B415                    YES - LEAVE IT ON         Y02032 29200003
         NI    IOSOPT,X'FF'-IOSDEP     NO  - TURN IT OFF         Y02032 29250003
B415     EQU   *                                                        29300003
         TM    EWAFLG3,EWTROR          ROR IN PROGRESS?          Y02032 29350003
         BNO   B390                    NO - GO REVERSE DIRECTION        29400003
*                                                                       29450003
         OI    EWACNTR3,EWTROC         SET IOS USE RORCCW        Y02032 29500003
         B     B400                    GO READ OFF LOAD POINT           29550003
*************   E N D   O F   P A R T   1   *************               29600003
         EJECT                                                          29650003
*********************************************************************** 29700003
*                            P A R T   4                              * 29750003
*                                                                     * 29800003
*                          ERROR HANDLING                             * 29850003
*********************************************************************** 29900003
*        THIS PART HANDLES ERRORS OTHER THAN NORMAL DATA CHECK        * 29950003
*        ON READ OR WRITE TYPE COMMANDS AND REPOSITIONING ERRORS.     * 30000003
*********************************************************************** 30050003
*                                                                       30100003
*   NOT REPOSITIONING                                                   30150003
*   TEST SENSE INFORMATION                                              30200003
*   REGS 0,9,11,12,14,15 ARE AFFECTED BY INTERPRETER ROUTINE            30250003
*   EQUIPMENT CHECK IS A VALID ERROR ONLY WITH DEVICE END               30300003
*                                                                       30350003
PART4A   EQU   *                                                        30400003
         NI    EWAFLG3,X'FF'-EWTPT4A   TURN OFF ENTRY BIT        Y02032 30450003
         TM    EWTSNS0,EWTEQU          EQUIPMENT CHECK?          Y02032 30500003
         BZ    D100                    NO - CONTINUE TEST        Y02032 30550003
         TM    IOSTSA,CSWDVE           DEVICE END?               Y02032 30600003
         BO    D840                    YES - XCTL TO WTO         Y02032 30650003
D100     EQU   *                                                        30700003
         LR    SAVREG,BASREG           SAVE BASE REG                    30750003
         L     BASREG,LOC16            GET ADDR OF CVT                  30800003
         L     BASREG,VECT68(BASREG)   GET ADDR TO INTERPRETER ROUTINE  30850003
*                                                                       30900003
D120     EQU   *                                                        30950003
         BALR  LNKREG,BASREG           LINK TO INTERPRETER RTN          31000003
*                                                                       31050003
         DC    X'02'                   BUS OUT CHECK                    31100003
         DC    AL1(D700-D120-2)        *                                31150003
         DC    X'01'                   INTERVENTION REQUIRED            31200003
         DC    AL1(D190-D120-4)        *                                31250003
         DC    X'00'                   COMMAND REJECT                   31300003
         DC    AL1(D170-D120-6)        *                                31350003
         DC    X'05'                   OVERRUN                          31400003
         DC    AL1(D700-D120-8)        *                                31450003
         DC    X'0C'                   TAPE LOAD POINT                  31500003
         DC    AL1(D220-D120-10)       *                                31550003
         DC    X'07'                   DATA CONVERTER CHECK             31600003
         DC    AL1(D160-D120-12)       *                                31650003
         DC    X'0F'                   NOT CAPABLE                      31700003
         DC    AL1(D170-D120-14)       *                                31750003
         DC    X'2F'                   END OF TEST                      31800003
         DC    AL1(D150-D120-16)       *                                31850003
*                                                                       31900003
*   TEST REMAINING SENSE WHEN INTERVENTION REQUIRED IS IGNORED          31950003
*   REGS 0,9,11,12,14,15 ARE AFFECTED BY INTERPRETER ROUTINE            32000003
*                                                                       32050003
D130     EQU   *                                                        32100003
         LR    SAVREG,BASREG           SAVE BASE REG                    32150003
         L     BASREG,LOC16            GET ADDR OF CVT                  32200003
         L     BASREG,VECT68(BASREG)   GET ADDR TO INTERPRETER ROUTINE  32250003
D140     EQU   *                                                        32300003
         BALR  LNKREG,BASREG           LINK TO INTERPRETER RTN          32350003
*                                                                       32400003
         DC    X'05'                   OVERRUN                          32450003
         DC    AL1(D700-D140-2)        *                                32500003
         DC    X'07'                   DATA CONVERTER CHECK             32550003
         DC    AL1(D160-D140-4)        *                                32600003
         DC    X'0F'                   NOT CAPABLE                      32650003
         DC    AL1(D170-D140-6)        *                                32700003
         DC    X'2F'                   END OF TEST                      32750003
         DC    AL1(D150-D140-8)        *                                32800003
         EJECT                                                          32850003
*                                                                       32900003
*   ENTER HERE FOR LOGOUT                                               32950003
*                                                                       33000003
D150     EQU   *                                                        33050003
         B     D840                    BRANCH TO SET LOGOUT             33100003
*                                                                       33150003
*   DATA CONVERTER CHECK                                                33200003
*                                                                       33250003
D160     EQU   *                                                        33300003
         B     D860                    GO XCTL TO WTO                   33350003
*                                                                       33400003
*   COMMAND REJECT AND NOT CAPABLE                                      33450003
*                                                                       33500003
D170     EQU   *                                                        33550003
         B     D860                    BRANCH TO SET MESSAGE TYPE       33600003
*                                                                       33650003
*   I N T E R V E N T I O N   R E Q U I R E D                           33700003
*        NON EXISTENT    -  I/O ERR     -  LOGOUT                       33750003
*        NO DEVICE END   -  MESSAGE     -  WTO AND REISSUE              33800003
*        INTERCEPTED 7E  -  NO MESSAGE  -  UCB NOT READY, 7F, RETURN    33850003
*        REWIND UNLOAD   -  NO MESSAGE  -  UCB NOT READY, 7F, UC OFF    33900003
*                                       -  RESTRT FLAG OFF, IOSB NO ERR 33950003
*        IGNORE INT REQ  -  NO MESSAGE  -  FINISH SENSE CHECK           34000003
*                                                                       34050003
D190     EQU   *                                                        34100003
         OI    EWACNTR1,ERPCTL         SET ERP CONTROL FLAG      Y02032 34150003
         TM    IOSCC,IOSCC3            NON-EXISTENT CONTROL UNIT?       34200003
         BO    D870                    YES - BRANCH TO WTO              34250003
*                                                                       34300003
         TM    EWTSNS1,EWTSTA+EWTSTB   STATUS A & B BOTH OFF?    Y02032 34350003
         BZ    D840                    YES - BR, ERROR, NO DRIVE        34400003
*                                                                       34450003
         TM    IOSTSA,CSWDVE           DEVICE END?                      34500003
         BZ    D870                    NO - BRANCH TO WTO & REISSUE     34550003
*                                                                       34600003
         LTR   CCWREG,CCWREG           NEGATIVE ADDRESS?         A29974 34650003
         BM    B222                    YES - GO SET X'4B'        A29974 34700003
         CLI   CCWOP,CMDRWU            REWIND UNLOAD?                   34750003
         BE    D200                    YES - GO SET IOSB TO NO ERROR    34800003
*                                                                       34850003
         TM    EWTSNS0,EWTCREJ         COMMAND REJECT?           Y02032 34900003
         BO    D860                    YES - GO SET MESSAGE TYPE        34950003
*                                                                       35000003
         TM    IOSTSB,CSWCDC           CHANNEL DATA CHECK?              35050003
         BO    D700                    YES - GO CHECK STATUS            35100003
         NI    EWTSNS0,X'FF'-EWTINT    TURN OFF INT REQ IN EWA   Y02032 35150003
         NI    IOSSNS,X'FF'-EWTINT     TURN OFF INT.REQ. IN IOSB Y02032 35200003
         LA    R13,LOAD1               GET LOAD 1 ADDRESS        Y02032 35250003
         B     XCTL3                   XCTL TO LOAD 1            Y02032 35300003
*                                                                       35350003
*   REWIND UNLOAD - NO ERROR                                            35400003
*                                                                       35450003
D200     EQU   *                                                        35500003
         NI    IOSFLA,X'FF'-IOSEX-IOSERR    SET IOSB TO NO ERROR        35550003
         NI    IOSTSA,X'FF'-CSWUCK     SET UNIT CHECK OFF               35600003
*                                                                       35650003
         MVI   IOSCOD,IOSNRMC          SET NORMAL COMPLETION CODE (7F)  35700003
*                                                                       35750003
*   SET UCB NOT READY FLAG, USING IOSGEN                                35800003
*                                                                       35850003
         LA    R13,EWTIDAL             POINT TO WORK AREA FOR IOSGEN    35900003
         AH    UCBREG,H512             POINT TO UCB PROPER     @OZ00664 35910003
         IOSGEN UCBFLG,UCB=(UCBREG),VAR=ON,TABLE=UCBNRY,REG=UNCOND      35950003
         SH    UCBREG,H512             POINT TO UCB PREFIX     @ZA05134 35960003
         B     D2025                   EXIT VIA SVC 15/3                36000003
*                                                                       36050003
*   LOAD POINT                                                          36100003
*                                                                       36150003
D220     EQU   *                                                        36200003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA  SET IOSB PERM ERR  @YM06412 36250003
         B     D2025                   EXIT VIA SVC 15/3                36300003
         EJECT                                                          36350003
*********************************************************************** 36400003
*                          P A R T   4 B                              * 36450003
*********************************************************************** 36500003
PART4B   EQU   *                                                        36550003
         NI    EWAFLG3,X'FF'-EWTPT4B   TURN OFF ENTRY BIT        Y02032 36600003
*                                                                       36650003
*   TEST STATUS INFORMATION                                             36700003
*   REGS 0,9,11,12,14,15 ARE USED BY INTERPRETER ROUTINE                36750003
*                                                                       36800003
D700     EQU   *                                                        36850003
*                                                                       36900003
         LR    SAVREG,BASREG           SAVE REG 15                      36950003
         L     BASREG,LOC16            GET ADDR OF CVT                  37000003
         L     BASREG,VECT68(BASREG)   GET ADDR OF INTERPRETER ROUTINE  37050003
D710     EQU   *                                                        37100003
         BALR  LNKREG,BASREG           LINK TO INTERPRETER RTN          37150003
*                                                                       37200003
         DC    X'16'                   UNIT CHECK                       37250003
         DC    AL1(D780-D710-2)        *                                37300003
         DC    X'1C'                   CHANNEL DATA CHECK               37350003
         DC    AL1(D770-D710-4)        *                                37400003
         DC    X'1F'                   CHAINING CHECK                   37450003
         DC    AL1(D770-D710-6)        *                                37500003
         DC    X'1A'                   PROGRAM CHECK                    37550003
         DC    AL1(D760-D710-8)        *                                37600003
         DC    X'1B'                   PROTECTION CHECK                 37650003
         DC    AL1(D760-D710-10)       *                                37700003
         DC    X'2F'                   END OF TEST - RECOVERED          37750003
         DC    AL1(D720-D710-12)       *                                37800003
*                                                                       37850003
*   RECOVERED                                                           37900003
*                                                                       37950003
D720     EQU   *                                                        38000003
         XC    EWACNTR1(C2),EWACNTR1   ZERO ERROR COUNTS                38050003
         NI    EWACNTR3,X'FF'-EWTRST   RESET RESTART BIT                38100003
         NI    IOSFLA,X'FF'-IOSEX-IOSERR   SET FOR TEMP ERROR EXIT      38150003
         OI    EWACNTR3,EWTEXIT        SET TEMP EXIT BIT ON             38200003
*                                                                       38250003
         LTR   CCWREG,CCWREG           NEGATIVE ADDRESS?                38300003
         BM    B222                    YES-SET '4B' & EXIT, PERM ERR    38350003
*                                                                       38400003
         LA    R13,LOAD1               GET LOAD 1 ADDRESS               38450003
         B     XCTL3                   XCTL TO LOAD 1                   38500003
*                                                                       38550003
*   PROGRAM CHECK OR PROTECTION CHECK                                   38600003
*                                                                       38650003
D760     EQU   *                                                        38700003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA RESET ERP CTL FLAGS @YM06412 38750003
         MVI   EWAFLG3,ZERO            CLEAR ERROR FLAGS                38800003
         B     D2025                   EXIT VIA SVC 15/3                38850003
*                                                                       38900003
*   CHAINING CHECK OR CHANNEL DATA CHECK                                38950003
*                                                                       39000003
D770     EQU   *                                                        39050003
         MVI   IOSSNS,ZERO             ZERO SENSE                       39100003
*                                                                       39150003
*   UNIT CHECK (BUS OUT OR OVERRUN)                                     39200003
*                                                                       39250003
D780     EQU   *                                                        39300003
         TM    EWACNTR1,OVRCNT5        IS OVERRUN COUNT 5?       Y02032 39350003
         BO    D840                    YES - SET LOGOUT & EXIT          39400003
         IC    R13,EWACNTR1            GET OVERRUN COUNT         Y02032 39450003
         LA    R13,C16(R13)            ADD ONE TO COUNT                 39500003
         STC   R13,EWACNTR1            STORE COUNT BACK          Y02032 39550003
*                                                                       39600003
         LTR   CCWREG,CCWREG           NEGATIVE ADDRESS?         A29974 39650003
         BM    B222                    YES - SET X'4B' & GO TO PART 1   39700003
*                                                                       39750003
         TM    IOSSNS,EWTBUSO          BUS OUT?                  Y02032 39800003
         BZ    D800                    NO - GO CHECK FOR OVERRUN        39850003
*                                                                       39900003
*   BUS OUT                                                             39950003
*                                                                       40000003
         TM    IOSTSA,CSWDVE           DEVICE END?                      40050003
         BZ    D790                    NO - GO CHECK TRACK IN ERROR     40100003
*                                                                       40150003
         CLI   CCWOP,CMDWRT            WRITE COMMAND?                   40200003
         BE    D810                    YES - GO REPOSITION              40250003
*                                                                       40300003
D790     EQU   *                                                        40350003
         CLI   CCWOP,CMDTIE            TRACK IN ERROR?                  40400003
         BNE   B405                    NO - GO RETRY                    40450003
         B     D820                    YES - GO TEST CHAINING           40500003
*                                                                       40550003
*   OVERRUN                                                             40600003
*                                                                       40650003
D800     EQU   *                                                        40700003
         CLI   CCWOP,CMDTIE            TRACK IN ERROR?                  40750003
         BE    D820                    YES - GO TEST CHAINING           40800003
*                                                                       40850003
D810     EQU   *                                                        40900003
         OI    IOSFLA,IOSREP           SET REPOSITION                   40950003
         OI    IOSOPT,IOSDEP           SET DEVICE END POST BIT   Y02032 41000003
         B     B405                    GO REPOSITION                    41050003
*                                                                       41100003
D820     EQU   *                                                        41150003
         TM    CCWFLS,IOSCCHN          COMMAND CHAINING?                41200003
         BO    D840                    YES - SET LOGOUT & XCTL TO WTO   41250003
         B     B405                    GO RETRY - SVC 15/3              41300003
         EJECT                                                          41350003
*                                                                       41400003
*   G E N E R A L   E X I T   A R E A                                   41450003
*                                                                       41500003
D840     EQU   *                                                        41550003
         OI    IOSFLB,IOSLOG           SET LOGOUT                       41600003
D860     EQU   *                                                        41650003
         OI    IOSFLB,IOSMSG           SET MESSAGE TYPE                 41700003
         NI    IOSFLA,X'FF'-IOSERR-IOSSMDA SET PERM ERROR EXIT @YM06412 41750003
D870     EQU   *                                                        41800003
         LA    R13,WTORTN              LOAD NAME FOR WTO                41850003
         B     XCTL1                   GO TO XCTL ROUTINE               41900003
*                                                                       41950003
D2025    EQU   *                                                        42000003
         TM    IOSFLB,IOSLOG           LOG OR OVERFLOW ON?              42050003
         BO    D2040                   YES - EXIT VIA OBR               42100003
         TM    EWAFLG3,EWTOVER         SDR OVERFLOW ON?          Y02032 42150003
         BZ    B405                    NO - EXIT VIA SVC 15/3           42200003
*                                                                       42250003
D2040    EQU   *                                                        42300003
         LA    R13,SERLOG              GET ADDRESS OF OBR               42350003
XCTL1    EQU   *                       SET UP OBR INFO IN EWA    Y02032 42400003
         L     R5,EWTDCB               GET DCB ADDR              Y02032 42450003
         LA    R4,EWTVOLID             GET ADDR OF OBR AREA      Y02032 42500003
         ST    R4,EWADCNT              STORE ADDR IN EWA         Y02032 42550003
         MVI   EWADCNT,HEX24           MOVE IN #BYTES OF OBR     Y02032 42600003
         MVC   EWTVES,UCBCTD           GET VES INFO              Y02032 42650003
         CL    R5,FZERO                VALID DCB?                Y02032 42700003
         BE    XCTL2                   NO - SKIP BLOCK COUNT     Y02032 42750003
         OI    EWAFLG1,EWADDMSG        SET WTO FLAG ON         @ZA31011 42760037
         CLC   BLKCNT(4,R5),MASK       IS BLKCNT = TO 65K?     @ZA08856 42766037
         BNH   MOVIT                   BR IF BLKCNT IS LESS    @ZA08856 42772037
         MVC   EWTBLK,MASK+2           MOVE FFFF TO RECORD     @ZA08856 42778037
         B     XCTL3                   GO XCTL                 @ZA08856 42792003
MOVIT    EQU   *                                                        42794003
         MVC   EWTBLK,BLKCNT+C2(R5)    YES - GET BLOCK COUNT   @ZA08856 42800003
         B     XCTL3                   GO XCTL                   Y02032 42850003
XCTL2    EQU   *                                                        42900003
         MVC   EWTBLK,FZERO            SET BLOCK COUNT TO 0      Y02032 42950003
XCTL3    EQU   *                                                        43000003
         MVC   EWTVOLID,UCBVOLI        GET VOL SER               Y02032 43050003
         L     XCTLREG,LOC16           GET ADDR OF CVT                  43100003
         L     XCTLREG,VECTXL(XCTLREG) GET ADDR FOR XCTL ROUTINE        43150003
         BR    XCTLREG                 BR TO XCTL                       43200003
         EJECT                                                          43250003
*********************************************************************** 43300003
*                            P A R T   9                              * 43350003
*                                                                     * 43400003
*                            ICC  &  CCC                              * 43450003
*********************************************************************** 43500003
*        ANALYZE THE ERROR RECOVERY INTERFACE BLOCK (ERPIB) TO        * 43550003
*        DETERMINE WHETHER OR NOT A CHANNEL ERROR CONDITION CAN       * 43600003
*        BE RETRIED.  IF SO, THE CHANNEL PROGRAM IS RETRIED ONLY      * 43650003
*        ONCE.  IF THE ERROR IS NOT RECOVERED ON RETRY OR IS OF       * 43700003
*        A TYPE THAT CANNOT BE RETRIED, THEN IT IS TO BE CONSIDERED   * 43750003
*        A PERMANENT ERROR, THE LOGOUT BIT IS SET, AND CONTROL        * 43800003
*        IS TRANSFERRED TO THE WRITE-TO-OPERATOR ROUTINE (IGE0025C)   * 43850003
*********************************************************************** 43900003
*                                                                       43950003
PART9    EQU   *                                                        44000003
*                                                                       44050003
*   CHECK ICC/CCC FLAG.  IF RETRY OF ICC/CCC CAUSED                     44100003
*   ICC OR CCC, WE WILL NOT RETRY AGAIN.                                44150003
*                                                                       44200003
         TM    EWACNTR1,ICCFLG         ICC/CCC FLAG ON?          Y02032 44250003
         BO    F390                    YES - BRANCH TO PERM ERROR       44300003
*                                                                       44350003
*   IS IOB INTERCEPTED?                                                 44400003
*                                                                       44450003
         CLI   IOSCOD,IOSFINTC         INTERCEPTED - 7E?                44500003
         BE    F380                    YES - GO SET CODE, PERM ERROR    44550003
*                                                                       44600003
*   TEST OF ERPIB NO-RETRY BITS                                         44650003
*                                                                       44700003
         TM    EWARGFG1,IBUNR1         ANY NO-RETRY BIT ON?      Y02032 44750003
         BC    7,F390                  YES - BRANCH TO PERM ERROR       44800003
*                                                                       44850003
*   EITHER SIO OR I/O INTERRUPT STORED A CSW, NOT BOTH?                 44900003
*                                                                       44950003
         TM    EWARGFG1,IBSIB1         SIO OR I/O INTERRUPT BIT?        45000003
         BC    9,F390                  BRANCH BOTH ON OR BOTH OFF       45050003
*                                      PERMANENT ERROR                  45100003
*                                                                       45150003
*   DID SIO INSTRUCTION STORE A CSW?                                    45200003
*                                                                       45250003
         TM    EWARGFG1,IBSIO1         SIO FAIL?                 Y02032 45300003
         BO    F370                    YES - BRANCH TO RETRY            45350003
*                                                                       45400003
*   TEST FOR ANY VALIDITY INDICATOR OFF                                 45450003
*                                                                       45500003
         TM    EWAXCSW1,IBALL2         ANY OFF?                  Y02032 45550003
         BC    12,F390                 YES - BRANCH TO PERM ERROR       45600003
*                                                                       45650003
*   TEST FOR ERROR ON NORMAL ERP REPOSITIONING                          45700003
*                                                                       45750003
         TM    IOSFLA,IOSREP           REPOSITIONING?                   45800003
         BO    F390                    YES - BRANCH TO PERM ERROR       45850003
*                                                                       45900003
*   TEST FOR UNIT CHECK                                                 45950003
*                                                                       46000003
         TM    IOSTSA,CSWUCK           UNIT CHECK?                      46050003
         BZ    F310                    NO - GO RESET CRC BIT            46100003
*                                                                       46150003
*   TEST FOR EQUIPMENT CHECK                                            46200003
*   OTHER SENSE BITS IGNORED                                            46250003
*                                                                       46300003
         TM    IOSSNS,EWTEQU           EQUIPMENT CHECK?          Y02032 46350003
         BO    F390                    YES - BRANCH TO PERM ERROR       46400003
*                                                                       46450003
*   RESET CRC BIT                                                       46500003
*                                                                       46550003
F310     EQU   *                                                        46600003
         NI    IOSFLA,X'FF'-IOSCRC     RESET CRC BIT                    46650003
*                                                                       46700003
*   TEST FOR CHAIN BITS - COMMAND AND/OR DATA CHAINING?                 46750003
*                                                                       46800003
         TM    IOSFLA,IOSACHN          DC OR CC?                        46850003
         BZ    F314                    NEITHER - GO SET DIRECTION       46900003
         BO    F390                    BOTH - BRANCH TO PERM ERROR      46950003
*                                                                       47000003
*   TEST FOR COMMAND CHAINING                                           47050003
*                                                                       47100003
         TM    IOSFLA,IOSCCHN          COMMAND CHAINING?                47150003
         BO    F312                    YES - BR AROUND DATA CHAINING    47200003
*                                                                       47250003
*   DATA CHAINING ONLY - START AT TOP OF CHANNEL PROGRAM                47300003
*                                                                       47350003
         L     CCWREG,IOSVST           GET START ADDRESS (VIRTUAL)      47400003
         B     F314                    GO SET DIRECTION                 47450003
*                                                                       47500003
*   COMMAND CHAINING                                                    47550003
*                                                                       47600003
F312     EQU   *                                                        47650003
         TM    EWACNTR3,EWTRST         1ST ENTRY (RESTART FLAG OFF)?    47700003
         BZ    F313                    YES - GO SET RESTART             47750003
*                                                                       47800003
*   NOT FIRST ENTRY                                                     47850003
*                                                                       47900003
         NI    IOSMDB,ZERO             CLEAR MOD BYTE                   47950003
         LR    R13,CCWREG              SET WORK REG TO CCW ADDRESS      48000003
         S     R13,IOSVST              COMPARE TO RESTART ADDRESS       48050003
         BZ    F314                    EQUAL - GO SET DIRECTION         48100003
*                                                                       48150003
*   COMMAND CHAINING AND CHAIN BROKE IN DIFFERENT PLACE                 48200003
*                                                                       48250003
         XC    EWACNTR1(C2),EWACNTR1   CLEAR ERROR COUNTS        Y02032 48300003
F313     EQU   *                                                        48350003
         OI    EWACNTR3,EWTRST         SET RESTART FLAG          Y02032 48400003
         ST    CCWREG,IOSVST           SET ADDRESS TO RESTART           48450003
         LRA   R13,CCW                 TRANSLATE VIRTUAL RESTART ADDR   48500003
         ST    R13,IOSRST              STORE IN REAL RESTART ADDRESS    48550003
*                                                                       48600003
F314     EQU   *                                                        48650003
         NI    EWAXCSW2,HEXC7          ZERO UNUSED BITS          Y02032 48700003
         TM    EWAXCSW2,IB30C0         TERM CODE = '11'?         Y02032 48750003
         BO    F390                    YES - BRANCH TO PERM ERROR       48800003
*                                                                       48850003
         CLI   CCWOP,CMDRED            IS COMMAND A READ?               48900003
         BE    G200                    YES - GO CHECK TERM & SEQ CODES  48950003
*                                                                       49000003
         CLI   CCWOP,CMDRDB            READ BACKWARDS?                  49050003
         BE    G200                    YES - GO CHECK CODES             49100003
*                                                                       49150003
         CLI   CCWOP,CMDWRT            WRITE?                           49200003
         BE    G200                    YES - GO CHECK CODES             49250003
*                                                                       49300003
         CLI   CCWOP,CMDERG            ERASE GAP?                       49350003
         BE    G200                    YES - GO CHECK CODES             49400003
*                                                                       49450003
         CLI   CCWOP,CMDWTM            WRITE TAPE MARK?                 49500003
         BE    G200                    YES - GO CHECK CODES             49550003
*                                                                       49600003
         CLI   CCWOP,CMDBSR            BACK SPACE RECORD?               49650003
         BE    G200                    YES - GO CHECK CODES             49700003
*                                                                       49750003
         CLI   CCWOP,CMDBSF            BACK SPACE FILE?                 49800003
         BE    G200                    YES - GO CHECK CODES             49850003
*                                                                       49900003
         CLI   CCWOP,CMDSNS            SENSE?                           49950003
         BE    G000                    YES - GO CHECK CODES             50000003
*                                                                       50050003
         CLI   CCWOP,CMDTIC            TRANSFER IN CHANNEL?             50100003
         BE    F390                    YES - BRANCH TO PERM ERROR       50150003
*                                                                       50200003
         CLI   CCWOP,CMDFSR            FORWARD SPACE RECORD?            50250003
         BE    G200                    YES - GO CHECK CODES             50300003
*                                                                       50350003
         CLI   CCWOP,CMDFSF            FORWARD SPACE FILE?              50400003
         BE    G200                    YES - GO CHECK CODES             50450003
*                                                                       50500003
         CLI   CCWOP,CMDREW            REWIND?                          50550003
         BE    G100                    YES - GO CHECK CODES             50600003
*                                                                       50650003
         CLI   CCWOP,CMDRWU            REWIND UNLOAD?                   50700003
         BE    G100                    YES - GO CHECK CODES             50750003
*                                                                       50800003
         CLI   CCWOP,CMDNOP            NO-OP?                           50850003
         BE    G100                    YES - GO CHECK CODES             50900003
*                                                                       50950003
         TM    CCWOP,CMDMD1            MODE SET, TIE OR LWR?            51000003
         BNO   F390                    NO - BRANCH AROUND               51050003
         TM    CCWOP,CMDBIT4           TEST FOR LO-ORDER = 'X3'         51100003
         BO    F315                    NO - GO CHECK FOR 'XB'           51150003
         TM    CCWOP,CMDBIT5           2ND TEST FOR 'X3'                51200003
         BZ    G100                    'X3' - GO CHECK CODES            51250003
         B     F390                    NOT 'X3' OR 'XB' - BR AROUND     51300003
F315     EQU   *                                                        51350003
         TM    CCWOP,CMDBIT5           TEST FOR LO-ORDER = 'XB'         51400003
         BZ    G100                    YES - GO CHECK CODES             51450003
         B     F390                    NO - BRANCH TO PERM ERROR        51500003
         EJECT                                                          51550003
*********************************************************************** 51600003
*                               2 4 0 0                               * 51650003
*        THIS SECTION HANDLES ICC AND CCC FOR 2400 DEVICE TYPE        * 51700003
*********************************************************************** 51750003
*                                                                     * 51800003
*        DETERMINE IF RETRY IS POSSIBLE BASED UPON                    * 51850003
*        SEQUENCE CODE AND TERMINATION CODE.                          * 51900003
*                                                                     * 51950003
*        BITS 2, 3 AND 4 OF ERPIB BYTE ARE UNUSED.                    * 52000003
*                                                                     * 52050003
*        THE FOLLOWING COMMANDS ARE CONSIDERED FOR                    * 52100003
*        FURTHER RECOVERY:                                            * 52150003
*              01, 02, 0C, 03, 07, 0F, 17, 1F, 27, 37 AND 3F          * 52200003
*********************************************************************** 52250003
F316     EQU   *                                                        52300003
*                                                                       52350003
*   SET REPOSITION DIRECTION FOR ALL READ/WRITE ERRORS                  52400003
*                                                                       52450003
         MVI   IOSMDB,CMDBSR           SET TO BACKSPACE                 52500003
         CLI   CCWOP,CMDRDB            IS IT READ BACK?                 52550003
         BNE   F316A                   NO - BR AROUND FORWARD SPACE     52600003
         MVI   IOSMDB,CMDFSR           SET TO FORWARD SPACE             52650003
F316A    EQU   *                                                        52700003
         CLI   EWAXCSW2,IB3001         T CODE=00 & R CODE=001?   Y02032 52750003
         BE    F370                    YES - GO SET BUS OUT             52800003
*                                                                       52850003
         CLI   EWAXCSW2,IB3002         T CODE=00 & R CODE=010?   Y02032 52900003
         BE    F325                    YES - GO CHECK TYPE OF COMMAND   52950003
*                                                                       53000003
         CLI   EWAXCSW2,IB3003         T CODE=00 & R CODE=011?   Y02032 53050003
         BE    F330                    YES - GO CHECK TYPE OF COMMAND   53100003
*                                                                       53150003
         CLI   EWAXCSW2,IB3004         T CODE=00 & R CODE=100?   Y02032 53200003
         BE    F370                    YES - GO SET BUS OUT             53250003
*                                                                       53300003
         CLI   EWAXCSW2,IB3005         T CODE=00 & R CODE=101?   Y02032 53350003
         BE    F330                    YES - GO CHECK TYPE OF COMMAND   53400003
*                                                                       53450003
         CLI   EWAXCSW2,IB3043         T CODE=01 & R CODE=011?   Y02032 53500003
         BE    F330                    YES - GO CHECK TYPE OF COMMAND   53550003
*                                                                       53600003
         CLI   EWAXCSW2,IB3045         T CODE=01 & R CODE=101?   Y02032 53650003
         BE    F330                    YES - GO CHECK TYPE OF COMMAND   53700003
*                                                                       53750003
         CLI   EWAXCSW2,IB3082         T CODE=10 & R CODE=010?   Y02032 53800003
         BE    F335                    YES - GO CHECK TYPE OF COMMAND   53850003
*                                                                       53900003
*   BRANCH TO PERMANENT ERROR.  ALL OTHER TERMINATION CODE              53950003
*   AND RETRY CODE COMBINATIONS ARE NOT RECOVERABLE.                    54000003
*                                                                       54050003
         B     F390                    BRANCH TO PERMANENT ERROR        54100003
F325     EQU   *                                                        54150003
         CLI   CCWOP,CMDWRT            WRITE COMMAND?                   54200003
         BE    F370                    YES - GO SET BUS OUT             54250003
*                                                                       54300003
         TM    CCWOP,CMDCTL            CONTROL COMMAND?                 54350003
         BNO   F345                    NO - BRANCH TO REPOSITION        54400003
*                                                                       54450003
*   IF THIS ONE CHAINED, CONTINUE WITH NEXT                             54500003
*                                                                       54550003
F327     EQU   *                                                        54600003
         TM    CCWFLS,IOSCCHN          COMMAND CHAINED?                 54650003
         BZ    F350                    NO - DONE, NO ERROR, BRANCH      54700003
*                                                                       54750003
         LA    CCWREG,C8(CCWREG)       POINT TO NEXT COMMAND            54800003
         CLI   CCWOP,CMDTIC            NEXT COMMAND A TIC?              54850003
         BNE   F328                    NO - USE THIS ADDRESS            54900003
*                                      YES - TRANSLATE 'TIC TO' ADDR    54950003
         MVC   IOSRST,CCWADR           STORE REAL START ADDR     Y02032 55000003
         LR    R4,IOSREG               SAVE IOSB ADDRESS         Y02032 55050003
         L     R1,CCWADR               GET 'TIC TO' ADDRESS      Y02032 55100003
         LA    R1,0(R1)                GET 3-BYTE ADDRESS        Y02032 55150003
         LR    R11,BASREG              SAVE BASE ADDR (R15)      Y02032 55200003
         L     BASREG,LOC16            GET ADDRESS OF CVT        Y02032 55250003
         L     BASREG,C288(BASREG)     GET ADDR OF TRANSLATE RTN Y02032 55300003
         BALR  LNKREG,BASREG           LINK TO TRANSLATE RTN     Y02032 55350003
         LR    CCWREG,R1               GET CCW ADDRESS (VIRT)    Y02032 55400003
         LR    BASREG,R11              RESTORE BASE REG          Y02032 55450003
         LR    IOSREG,R4               RESTORE IOSB REG          Y02032 55500003
*                                                                       55550003
F328     EQU   *                                                        55600003
         ST    CCWREG,IOSVST           SET AS RESTART (NO REPOS)        55650003
         LRA   R13,CCW                 GET REAL RESTART ADDRESS         55700003
         ST    R13,IOSRST              STORE IN IOSB                    55750003
         B     F370                    GO SET BUS OUT                   55800003
*                                                                       55850003
F330     EQU   *                                                        55900003
         TM    CCWOP,CMDCTL            CONTROL COMMAND?                 55950003
         BO    F327                    YES - GO CHECK FOR CMD CHAINING  56000003
         B     F345                    NO  - BRANCH TO REPOSITION       56050003
*                                                                       56100003
F335     EQU   *                                                        56150003
         CLI   CCWOP,CMDWRT            WRITE COMMAND?                   56200003
         BE    F370                    YES - GO SET ICC/CCC             56250003
         B     F390                    NO  - BRANCH TO PERM ERROR       56300003
*                                                                       56350003
*   REPOSITIONING REQUIRED                                              56400003
*                                                                       56450003
F345     EQU   *                                                        56500003
         CLI   CCWOP,CMDWRT            WRITE COMMAND?                   56550003
         BNE   F348                    NO - GO SET ICC/CCC & REPOSIT.   56600003
*                                                                       56650003
         OI    EWACNTR2,WRTIND         SET WRITE INDICATOR       Y02032 56700003
         TM    IOSTSA,CSWUEX           TEST FOR UNIT EXCEPTION          56750003
         BZ    F348                    NO - GO SET BUS OUT & REPOSIT.   56800003
         OI    EWACNTR3,EWTUEX         YES - SET UNIT EXCEPTION  Y02032 56850003
*                                                                       56900003
F348     EQU   *                                                        56950003
         OI    EWACNTR1,ICCFLG         SET ICC/CCC FLAG          Y02032 57000003
         OI    IOSFLA,IOSREP           SET REPOSITION                   57050003
         OI    IOSOPT,IOSDEP           SET DEVICE END POST BIT   Y02032 57100003
         B     F370                    GO RETRY                         57150003
*                                                                       57200003
*   OPERATION COMPLETE - NO ERROR - IGNORE ICC OR CCC                   57250003
*                                                                       57300003
F350     EQU   *                                                        57350003
         NI    EWACNTR2,HEX80          CLEAR ERROR COUNT         Y02032 57400003
         NI    EWACNTR1,ZERO           CLEAR ERROR COUNT         Y02032 57450003
*                                                                       57500003
*   TEST FOR END OF TAPE BEFORE BSR                                     57550003
*                                                                       57600003
         TM    EWACNTR3,EWTUEX         HAD UNIT EXCEPTION?       Y02032 57650003
         BZ    F352                    NO - BRANCH AROUND               57700003
         OI    IOSTSA,CSWUEX           YES - SET UNIT EXCEPTION IN CSW  57750003
         NI    EWACNTR3,X'FF'-EWTUEX   RESET UNIT EXCEPTION FLAG Y02032 57800003
*                                                                       57850003
F352     EQU   *                                                        57900003
         NI    IOSFLA,X'FF'-IOSERR-IOSEX    SET FLAGS FOR TEMP ERROR    57950003
         NI    EWACNTR3,X'FF'-EWTRST   RESET RESTART FLAG        Y02032 58000003
         XC    EWAERPIB,EWAERPIB       ZERO ERPIB                Y02032 58050003
*                                                                       58100003
*   TURN OFF ICC AND CCC                                                58150003
         NI    IOSTSB,HEXF9            TURN OFF ICC AND CCC             58200003
*                                                                       58250003
*   TEST FOR REWIND UNLOAD                                              58300003
*                                                                       58350003
         CLI   CCWOP,CMDRWU            RUN COMMAND?                     58400003
         BE    F356                    YES - BR AROUND ERROR FLAGS      58450003
*                                                                       58500003
         MVI   EWAFLG3,ZERO            CLEAR ERROR FLAGS         Y02032 58550003
         B     B405                    EXIT VIA SVC 15/3                58600003
*                                                                       58650003
F356     EQU   *                                                        58700003
         NI    IOSTSA,X'FF'-CSWUCK     TURN OFF UNIT CHECK              58750003
         MVI   IOSCOD,IOSNRMC          SET NORMAL COMPLETION CODE - 7F  58800003
*                                                                       58850003
*   SET UCB NOT READY FLAG                                              58900003
*                                                                       58950003
         LA    R13,EWTIDAL             POINT TO WORK AREA FOR IOSGEN    58960003
         AH    UCBREG,H512             POINT TO UCB PROPER     @ZA05134 59010003
         IOSGEN UCBFLG,UCB=(UCBREG),VAR=ON,TABLE=UCBNRY,REG=UNCOND      59050003
         B     B405                    EXIT VIA SVC 15/3                59100003
         EJECT                                                          59150003
*                                                                       59200003
*                         R E T R Y                                     59250003
*                                                                       59300003
F370     EQU   *                                                        59350003
         OI    EWACNTR1,ICCFLG         SET ICC/CCC FLAG          Y02032 59400003
         XC    EWAERPIB,EWAERPIB       ZERO ERPIB                       59450003
         B     B405                    GO TO SVC 15/3                   59500003
*                                                                       59550003
*              P E R M A N E N T   E R R O R                            59600003
*                                                                       59650003
F380     MVI   IOSCOD,IOSINTC          SET INTERCEPT CODE - X'44'       59700003
*                                                                       59750003
F390     XC    EWAERPIB,EWAERPIB       ZERO ERPIB                       59800003
         B     D840                    EXIT VIA XCTL TO WTO             59850003
         EJECT                                                          59900003
*********************************************************************** 59950003
*                              3 4 0 0                                * 60000003
*        THIS SECTION HANDLES ICC AND CCC FOR NEW DEVICE TYPE         * 60050003
*********************************************************************** 60100003
*                                                                     * 60150003
*        DETERMINE IF RETRY IS POSSIBLE BASED UPON                    * 60200003
*        SEQUENCE CODE AND TERMINATION CODE.                          * 60250003
*                                                                     * 60300003
*        BITS 2, 3 AND 4 OF ERPIB BYTE ARE UNUSED.                    * 60350003
*                                                                     * 60400003
*        THE FOLLOWING COMMANDS ARE CONSIDERED FOR                    * 60450003
*        FURTHER RECOVERY:                                            * 60500003
*              01, 02, 0C, 03, 07, 0F, 17, 1F, 27, 37, 3F, 04         * 60550003
*                                                                     * 60600003
*********************************************************************** 60650003
*                                                                       60700003
*   SENSE COMMAND                                                       60750003
*   THE FOLLOWING COMBINATIONS OF TERMINATION                           60800003
*   CODE AND SEQUENCE CODE CAN BE RETRIED:                              60850003
*              00-001   00-010   00-011   00-101                        60900003
*              01-001   01-010   01-011   01-101                        60950003
*                                                                       61000003
G000     EQU   *                                                        61050003
         CLI   UCBTBYT4,UCB2400        2400 DEVICE?                     61100003
         BE    F390                    YES - BRANCH TO PERM ERROR       61150003
*                                                                       61200003
         CLI   EWAXCSW2,IB3001         CODE = 00-001?            Y02032 61250003
         BE    F370                    YES - GO RETRY                   61300003
*                                                                       61350003
         CLI   EWAXCSW2,IB3002         CODE = 00-010?            Y02032 61400003
         BE    F370                    YES - GO RETRY                   61450003
*                                                                       61500003
         CLI   EWAXCSW2,IB3003         CODE = 00-011?            Y02032 61550003
         BE    F370                    YES - GO RETRY                   61600003
*                                                                       61650003
         CLI   EWAXCSW2,IB3005         CODE = 00-101?            Y02032 61700003
         BE    F370                    YES - GO RETRY                   61750003
*                                                                       61800003
         CLI   EWAXCSW2,IB3041         CODE = 01-001?            Y02032 61850003
         BE    F370                    YES - GO RETRY                   61900003
*                                                                       61950003
         CLI   EWAXCSW2,IB3042         CODE = 01-010?            Y02032 62000003
         BE    F370                    YES - GO RETRY                   62050003
*                                                                       62100003
         CLI   EWAXCSW2,IB3043         CODE = 01-011?            Y02032 62150003
         BE    F370                    YES - GO RETRY                   62200003
*                                                                       62250003
         CLI   EWAXCSW2,IB3045         CODE = 01-101?            Y02032 62300003
         BE    F370                    YES - GO RETRY                   62350003
         B     F390                    NO - BRANCH TO PERM ERROR        62400003
*                                                                       62450003
*   COMMAND - REW, RUN, NOP, TIE, LWR, MODE SETS                        62500003
*   THE FOLLOWING COMBINATIONS OF TERMINATION                           62550003
*   CODE AND SEQUENCE CODE CAN BE RETRIED:                              62600003
*              00-001   00-010                                          62650003
*              01-001   01-010                                          62700003
*              10-001   10-010                                          62750003
*                                                                       62800003
G100     EQU   *                                                        62850003
         CLI   UCBTBYT4,UCB2400        2400 DEVICE?                     62900003
         BE    F316                    YES - GO CHECK 2400 CODES        62950003
*                                                                       63000003
         CLI   EWAXCSW2,IB3002         CODE = 00-010?            Y02032 63050003
         BE    F370                    YES - GO RETRY                   63100003
*                                                                       63150003
         CLI   EWAXCSW2,IB3042         CODE = 01-010?            Y02032 63200003
         BE    F370                    YES - GO RETRY                   63250003
*                                                                       63300003
         CLI   EWAXCSW2,IB3082         CODE = 10-010?            Y02032 63350003
         BE    F370                    YES - GO RETRY                   63400003
*                                                                       63450003
*   COMMAND - RD, RDB, WRT, ERG, WTM, BSR, BSF, FSR, FSF                63500003
*   THE FOLLOWING COMBINATIONS OF TERMINATION                           63550003
*   CODE AND SEQUENCE CODE CAN BE RETRIED:                              63600003
*              00-001                                                   63650003
*              01-001                                                   63700003
*              10-001                                                   63750003
*                                                                       63800003
G200     EQU   *                                                        63850003
         CLI   UCBTBYT4,UCB2400        2400 DEVICE?                     63900003
         BE    F316                    YES - GO CHECK 2400 CODES        63950003
*                                                                       64000003
         CLI   EWAXCSW2,IB3001         CODE = 00-001?            Y02032 64050003
         BE    F370                    YES - GO RETRY                   64100003
*                                                                       64150003
         CLI   EWAXCSW2,IB3041         CODE = 01-001?            Y02032 64200003
         BE    F370                    YES - GO RETRY                   64250003
*                                                                       64300003
         CLI   EWAXCSW2,IB3081         CODE = 10-001?            Y02032 64350003
         BE    F370                    YES - GO RETRY                   64400003
         B     F390                    NO - BRANCH TO PERM ERROR        64450003
         EJECT                                                          64500003
*********************************************************************** 64550003
*                 WRITE TO OPERATOR MESSAGE                           * 64600003
*********************************************************************** 64650003
WTOMSG   DS    0F                      OUTPUT MESSAGE                   64700003
LENGTH   DC    AL2(MSGEND-MSGNO)       MESSAGE LENGTH                   64750003
         DC    X'8000'                 MCS FLAGS                 A43378 64800003
MSGNO    DC    CL8'IEA000I '           MESSAGE ID                       64850003
UNITID   DC    CL4'XXX,'               UNIT ADDRESS                     64900003
MSGTEXT  DC    CL13'            ,'     MESSAGE TEXT                     64950003
OPCODE   DC    CL3'XX,'                CCW OP CODE                      65000003
STATUS   DC    CL5'XXXX,'              CCW STATUS                       65050003
SENSE    DC    CL5'XXXX,'              SENSE DATA                       65100003
LOC      DC    CL9'XXXXXXXX,'          DCB BLOCK COUNT, INDICATES       65150003
*                                      APPROXIMATE POSITION ON TAPE.    65200003
VOLSER   DC    CL6'XXXXXX'             VOLUME SERIAL NUMBER      A40906 65250003
ROUTE    DC    X'20001040'             DESCRIPTOR AND ROUTING @ZA30415  65300037
MSGEND   EQU   *                                                        65350003
ERRMSG1  DC    CL13'ERROR ON ERG,'     MESSAGE 1                 A40267 65400003
ERRMSG2  DC    CL13'NOISE - USER,'     MESSAGE 2                 A40267 65450003
ERRMSG3  DC    CL13'NOISE - ERP ,'     MESSAGE 3                 A40267 65500003
ERRMSG4  DC    CL13'UNEX INTRPT ,'     MESSAGE 4                 S21048 65550003
ERRMSG5  DC    CL13'DSE FAILED  ,'     MESSAGE 5                 S21048 65600003
ERRMSG6  DC    CL13'CTRL BLK ERR,'     MESSAGE 6                 A29974 65650003
ERRMSG7  DC    CL13'UNEX LOAD PT,'     MESSAGE 7                 A29972 65700003
*                                                                       65750003
*   TRANSLATE TABLE                                                     65800003
*                                                                       65850003
TRANS    EQU   *-X'ED'                 STARTING ADDR OF TRANS TABLE     65900003
TABLE    DC    C'*, 0123456789ABCDEF'  TRANSLATE TABLE                  65950003
NULLOP   DC    X'EDED'                 WILL TRANSLATE TO '**'           66000003
*                                                                       66050003
*                                                                       66100003
         DS    0H                      ALIGN                            66150003
EIGHT    DC    AL2(8)                  HALFWORD OF 8                    66200003
ALLF     DC    X'FFFF'                 COMPARE MASK                     66250003
F24      DC    F'24'                   FULLWORD OF 24            Y02032 66300003
FZERO    DC    X'00000000'             FULLWORD OF 0                    66350003
H512     DC    H'512'                  HALFWORD OF 512           Y02032 66400003
         ORG   ERP2+4067               **                               66450003
         DC    C'**   E N D   L O A D   2   **'     **                  66500003
         IECDERWA  EWT                                           Y02032 66550003
         EJECT                                                          66600003
         IECDIOSB                                                Y02032 66650003
         EJECT                                                          66700003
         IEFUCBOB  PREFIX=YES                                    Y02032 66750003
         EJECT                                                          66800003
CVT      DSECT                                                          66850003
         CVT                                                            66900003
         EJECT                                                          66950003
         IECDIOCM                                                       67000003
         END                                                            67050003
