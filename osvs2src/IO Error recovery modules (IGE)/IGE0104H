104H   TITLE 'IGE0104H BSC UNIT CHECK - UNIT EXCEPTION -READ-WRITE'     00200010
IGE0104H CSECT                                                          00400010
         SPACE 3                                                        00420010
*CHANGE-ACTIVITY = AS FOLLOWS:                                          00440010
******************** MICROFICHE FLAGS *********************** SUPT CODE 00460010
*                                                                       00480010
*A344000,482000                                                  S22025 00500010
*C462000,558000,742000,748000,750000                             S22025 00530010
*D824000                                                         S22025 00560010
*C262000                                                       @SA72489 00570010
*C262400                                                       @SA73351 00580010
*C612000,616000                                                @SA72446 00586010
*A820000                                                       @SA72446 00592010
*D702000-704000,A210000,C438000-444000,A821000,A840000         @OY10984 00592110
*C414000,424000,A730000,736000,746000                          @OY12439 00592210
*C443800,D438600-443600,821060-821120,840500                   @OY14057 00592310
*C018000,356000,494000                                         @G36XREV 00595310
*                                                                     * 00600010
*********************************************************************** 00800010
*                                                                     * 01000010
*MODULE-NAME = IGE0104H                                                 01200010
*                                                                     * 01300010
*DESCRIPTIVE-NAME = ERP FOR BSC UNIT CHECK/UNIT EXCEPTION             * 01400010
*                                                                     * 01500010
*COPYRIGHTS = 'NONE'                                                  * 01600010
*                                                                     * 01700010
*  STATUS:  CHANGE LEVEL 10                                    @G36XREV 01800010
*                                                                     * 02200010
*FUNCTION -- TO ATTEMPT RETRY ON A FAILING CCW SEQUENCE AND TO TAKE   * 02400010
*   INTERMEDIATE ERP ACTION IF REQUIRED                               * 02600010
*                                                                     * 02800010
*ENTRY POINTS -- FIRST EXECUTABLE INSTRUCTION.                        * 03000010
*                                                                     * 03200010
*INPUT --                                                             * 03400010
*   R1 - POINTER TO I/O SUPERVISOR BLOCK                         Y02027 03600010
*   R15 - ENTRY POINT ADDRESS                                         * 03800010
*                                                                     * 04000010
*OUTPUT -- R1 POINTS TO I/O SUPERVISOR BLOCK                     Y02027 04200010
*                                                                     * 04400010
*EXTERNAL ROUTINE -- IGG019QE (AOS/TCAM SIO APPENDAGE) -- TO CONVERT  * 04500010
*   VIRTUAL CCW ADDRESSES TO REAL BEFORE RETRY.                       * 04600010
*                                                                     * 04800010
*A052000-053000,059000,078000,110000,115000,151000,170600-171200,Y02027 04830010
*A183000,189500,651000,752600-753200,841000                      Y02027 04860010
*C036000,042000,050000-051000,058000,076000-077000,114000,158000,Y02027 04890010
*C690000,690300,690420-690480,691440                             Y02027 04920010
*D212000                                                         Y02027 04950010
*EXITS-NORMAL -- R1 POINTS TO I/O SUPERVISOR BLOCK               Y02027 05000010
*        SVC   15   'ERP IN CONTROL (IOSERR)' AND 'EXCEPTIONAL   Y02027 05100010
*                CONDITION(IOSEX)'. RETURN TO IOS TO RETRY THE   Y02027 05200010
*                   ERROR.                                       Y02027 05300010
*        SVC   3                                                      * 05400010
*                                                                     * 05600010
*        SVC   15   'NO ERROR FLAGS'. RETURN TO LINE END         Y02027 05800010
*                   APPENDAGE. ERROR CLEARED                     Y02027 05900010
*        SVC   3                                                      * 06000010
*                                                                     * 06200010
*   TO SCHEDULE NEXT LOAD OF ERP                                      * 06400010
*        L     13,DECIMAL VALUE OF NEXT LOAD                          * 06600010
*        L   14,X'10'    CVT ADDRESS                                  * 06800010
*        L     14,X'2C'(14)    ADDRESS OF XCTL ROUTINE                * 07000010
*        BR    14   EXIT TO XCTL                                      * 07200010
*                                                                     * 07400010
*EXITS-ERROR -- R1 POINTS TO I/O SUPERVISOR BLOCK                Y02027 07600010
*        SVC   15   'EXCEPTIONAL CONDITION(IOSEX)'. RETURN TO    Y02027 07700010
*                   LINE END APPENDAGE. ERROR PERMANENT.         Y02027 07800010
*        SVC   3                                                      * 08000010
*                                                                     * 08200010
*        L     13,DECIMAL VALUE OF NEXT LOAD                          * 08400010
*        L   14,X'10'    CVT ADDRESS                                  * 08600010
*        L     14,X'2C'(14)    ADDRESS OF XCTL ROUTINE                * 08800010
*        BR    14   EXIT TO XCTL                                      * 09000010
*                                                                     * 09200010
*   TO SCHEDULE ERROR POST                                            * 09400010
*                                                                     * 09600010
*TABLES/WORK AREAS --                                                 * 09800010
*   TAVTD                                                             * 10000010
*   TTRMD                                                             * 10200010
*   TCCWD                                                             * 10400010
*   TLCBD                                                             * 10600010
*   DCBD                                                              * 10800010
*   TSCBD                                                             * 11000010
*   IECDIOSB                                                     Y02027 11100010
*                                                                     * 11200010
*ATTRIBUTES -- SERIALLY REUSABLE, REFRESHABLE, SUPERVISOR KEY,   Y02027 11400010
*              SUPERVISOR MODE, ENABLED                          Y02027 11500010
*                                                                     * 11600010
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 11800010
*   PARTICUALR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER      * 12000010
*   SET.                                                              * 12200010
*                                                                     * 12400010
*   R1 REMAINS TRANSPARENT TO ALL LOADS OF ERP.                       * 12600010
*                                                                     * 12800010
*   IF INTERMEDIATE ERP ACTION IS REQUIRED, THE SEQUENCE IS BUILT     * 13000010
*   IN LCBERCCW AND A RETURN INDICATOR IS SET IN LCBINCAM+1 FOR       * 13200010
*   IGE0404H.                                                         * 13400010
*                                                                     * 13600010
*********************************************************************** 13800010
         EJECT                                                          14000010
         USING LCBFLAG1,RLCB                                            14200010
         USING IEDQCCW,RCCW                                             14400010
         USING IEDQSCB,RSCB                                             14600010
         USING IHADCB,RDCB                                              14800010
         USING IEDQAVTD,RAVT                                            15000010
         USING IOSB,RIOSB                                        Y02027 15100010
         USING *,R15                                                    15200010
*        R E G I S T E R S                                              15400010
R0       EQU   0                                                        15600010
RIOSB    EQU   1                        ADDR OF I/O SUPVR BLOCK  Y02027 15800010
RLCB     EQU   2                        LCB CBASE                       16000010
RCCW     EQU   5                        CCW BASE                        16200010
RSCB     EQU   3                        SCB BASE                        16400010
RDCB     EQU   4                        DCB BASE                        16600010
RWKA     EQU   6                        WORK REGISTER                   16800010
RWKB     EQU   7                        WORK REGISTER                   17000010
RTST     EQU   7                        ADDR OF REQUEST QUEUE    Y02027 17060010
*                                       ELEMENT                  Y02027 17120010
RTERM    EQU   8                        TERMINAL BASE                   17200010
RWKC     EQU   9                        WORK REGISTER                   17400010
RWKD     EQU   10                       WORK REGISTER                   17600010
RAVT     EQU   11                       AAVT BASE                       17800010
RCUR     EQU   12                       WORK REGISTER                   18000010
RLINK    EQU   13                       LINKAGE FOR SUBSEQUENT LOAD     18200010
RSAVE    EQU   13                       SAVE REGISTER FOR IOSB   Y02027 18300010
RXCTL    EQU   14                       XCTL REGISTER                   18400010
R15      EQU   15                       ADDRESSABILITY REGISTER         18600010
         EJECT                                                          18800010
         L     RTST,IOSUSE              PICKUP ADDR OF RQE       Y02027 18950010
         L     RLCB,IOBOFFST(,RTST)     ADDRESS OF IOB Z(LCB)           19000010
         L     RSCB,LCBSCBA-1           SCB B ASE                       19200010
         L     RDCB,LCBDCBPT            DCB  BASE                       19400010
         L     RCCW,LCBCSW-1            FAILING CCW                     19600010
         SH    RCCW,H8                  BACK UP TO FAILING CCW          19800010
         LA    RCCW,0(,RCCW)            CLEAR HI ORDER BYTE             20000010
         CLI   CCWOPCDE,CCWTIC          TIC (CHANNEL PROGAM CHECK)      20200010
         BNE   NOPC                     NO                              20400010
         SH    RCCW,H8                  BACK U TO TEXT CCW              20600010
         MVI   LCBCSW+6,0               CLEAR RESIDUAL COUNT            20800010
NOPC     EQU   *                                                        21000010
         L     RXCTL,CVTPTR             CVT ADDRESS            @OY10984 21100010
         L     RAVT,AVTCVTPT(,RXCTL)    LOAD LIST ADDRESS      @OY10984 21200010
         L     RAVT,AVTEZERO(,RAVT)     AVT BASE               @OY10984 21300010
         LR    RCUR,RCCW                ASSUME RESTART POINT            21400010
         TM    LCBCSW+3,UNITCHK         UNIT CHEKC SET                  21600010
         BZ    UXWRITE                  NO UNIT EXCEPTION ON WRITE      21800010
         SPACE                                                          22000010
         TM    LCBSENS0,EQCHK           EQUIPMENT CHECK                 22200010
         BZ    TRYLD                    NO, TRY LOST DATA               22400010
         SPACE                                                          22600010
         CLI   LCBRESTR,TPRDSKIP        TEXT RELATED CCW                22800010
         BNL   TXTSNO                   BRANCH IF YES                   23000010
         SPACE                                                          23200010
         CLI   LCBRESTR,TPRDLC          READ LLC OUT                    23400010
         BNE   TRYRETRY                 BRANCH NO                       23600010
TXTSNO   EQU   *                                                        23800010
         OI    SCBERR4,SCBUNDFN         SHOULD NOT OCCUR                24000010
         B     TXTRESET                 WRITE EOT TO RESET LINE         24200010
         SPACE 2                                                        24400010
TRYLD    EQU   *                                                        24600010
         TM    LCBSENS0,LOSTD           LOST DATA SET                   24800010
         BZ    TOTEST                   NO, TRY TIME OUT                25000010
         SPACE                                                          25200010
         CLI   CCWOPCDE,CCWWRITE        WRITE COMMAND                   25400010
         BE    SNOEXIT                  YES 'SHOULD NOT OCCUR'          25600010
         SPACE                                                          25800010
         CLI   LCBRESTR,TPRDENQ         READ ENQ COMMAND                26000010
         BNE   TRYENQ                   NO, CHECK ENQ RESPONSE @SA72489 26200010
         CLC   CCWCOUNT,LCBCSW+5        RESIDUAL COUNT=ORIGINAL@SA72489 26220010
         BE    TRYRETRY                 YES, CHECK RETRY COUNT @SA73351 26240010
         NI    LCBCSW+3,AVTEFF-UNITCHK  RESET UNIT CHECK ERROR @SA72489 26260010
         NI    IOSFLA,AVTEFF-(IOSERR+IOSEX) RESET ERP IN CONT  @SA72489 26280010
         B     NOTRETRY                 RETURN TO LINE END     @SA72489 26300010
*                                       WITH GOOD COMPLETION   @SA72489 26320010
TRYENQ   EQU   *                                               @SA72489 26340010
         SPACE 2                                                        26400010
         CLI   LCBRESTR,TPRSPENQ        RESPOSNE TO ENQ                 26600010
         BNE   LDRSPEB                  NO                              26800010
         SPACE                                                          27000010
DIALTEST EQU   *                                                        27200010
         LA    RCUR,LCBCPA+16           ASSUME NOT DIAL                 27400010
         TM    LCBCPA+24,X'20'          DIAL SEQUENCE                   27600010
         BZ    TRYRETRY                 BRANCH N/                       27800010
         SPACE                                                          28000010
         LA    RCUR,24(,RCUR)           BUMP PAST DIAL SEQUENCE         28200010
         B     TRYRETRY                 RETRY AFTER DIAL SEQUENC        28400010
         SPACE                                                          28600010
LDRSPEB  EQU   *                                                        28800010
         CLI   LCBRESTR,TPRDRPEB        RESPONSE TO ETB                 29000010
         BNE   LDTEXT                   NO, CHECK IF TEXT               29200010
         SPACE                                                          29400010
WRENQ    EQU   *                                                        29600010
         LA    RWKC,ENQCH               PARAMETER                       29800010
         BAL   RWKD,CCWBLD              BUILD WRITE ENQ                 30000010
         MVI   LCBINCAM+1,LDRSPRET      SET 404H RETURN                 30200010
         MVI   LCBERCCW+4,CCWCC+CCWSLI  SET FLAGS                       30400010
         ST    RCCW,LCBERCCW+8          SET TIC TO FAILING CCW          30600010
         MVI   LCBERCCW+8,CCWTIC        SET TIC COMMAND CODE            30800010
         B     COMEXIT                  USE COMMON CIIT                 31000010
         SPACE 2                                                        31200010
LDTEXT   EQU   *                                                        31400010
         CLI   LCBRESTR,TPRDLC          READ LC OUT                     31600010
         BE    TRYRETRY                 YES                             31800010
         SPACE                                                          32000010
         CLI   LCBRESTR,TPTEXT          TEXT CCW                        32200010
         BNE   NOTEXT                   NO                              32400010
         SPACE                                                          32600010
         MVI   LCBINCAM+1,LDTXTRET      SET 404H RERURN                 32800010
         MVC   LCBERCCW+4(4),SKIPCNT    SET LARGE COHNT                 33000010
         B     READEXIT                 COMMON EXIT                     33200010
         SPACE                                                          33400010
NOTEXT   EQU   *                                                        33600010
         CLI   LCBRESTR,TPRDRSPD        ERSPONSE TO ADDRESSING          33800010
         BNE   TRYIDAK                  BRANCH NO                       34000010
         SPACE                                                          34200010
         LH    RWKC,LCBTTCIN            CURRENTRLY CONNECTED            34400010
         LTR   RWKC,RWKC                IS THE SOURCE ON A DIAL  S22025 34440010
*                                         LINE SET               S22025 34480010
         BZ    TXTRESET                 NO, RESET THE LINE AND   S22025 34520010
*                                         TREAT AS A PERM ERROR  S22025 34560010
         BAL   RWKD,FINDTERM            GET TERMINAL ADDRESS            34600010
         USING IEDQTRM,RTERM                                            34800010
         SR    RWKB,RWKB                CLEAR INDEX EGISTER             35000010
         IC    RWKB,TRMCHCIN            INDEX TO CHARACTDRISTICS        35200010
         BCTR  RWKB,0                   DECREMENTFRO INDEX              35400010
         MH    RWKB,AVTDCTLN            LENGTH OF DCT ENTRY    @G36XREV 35500010
         A     RWKB,AVTCSTCS            POINT TO CHARACTERISTIC         35800010
         TM    2(RWKB),X'10'            STATION CONTROL-MULTIPT         36000010
         BO    DIALTEST                 YES, RE-SELECT                  36200010
         SPACE                                                          36400010
         TM    3(RWKB),X'20'            END-END CONTROL                 36600010
         BZ    DIALTEST                 NO, RE-SELECT                   36800010
         SPACE                                                          37000010
         B     WRENQ                    TREAT SAME AS TRESPONSE TO      37200010
*                                         TO TEXT                       37400010
TRYIDAK  EQU   *                                                        37600010
         CLI   LCBRESTR,TPRDIDAK        READ ID ACK                     37800010
         BE    DIALTEST                 BRANCH YES                      38000010
         SPACE                                                          38200010
         B     TRYRETRY                 RETRY ID ENQ                    38400010
         SPACE 5                                                        38600010
TOTEST   EQU   *                                                        38800010
         TM    LCBSENS0,TIMEOUT         TIMEOUT SET                     39000010
         BZ    INTRTEST                 NO                              39200010
         CLI   CCWOPCDE,CCWREAD         READ CCW                        39400010
         BNE   TOWRITE                  NO, IT'S A WRITE                39600010
         SPACE                                                          39800010
         CLI   LCBRESTR,TPRDLC          READ LCOUT                      40000010
         BE    TXTRTRY                  RETRY COMMAND                   40200010
         SPACE                                                          40400010
         CLI   LCBRESTR,TPTEXT          READ TEXT                       40600010
         BNE   NOTEXT1                  NO                              40800010
         SPACE                                                          41000010
         CLC   CCWCOUNT,LCBCSW+5   RESIDUAL COUT=ORIGINAL               41200010
         BNE   LOAD204H                 NO, 204H WILL HANDLE   @OY12439 41400010
         SPACE                                                          41600010
         L     RWKD,LCBCPA+12      RESTART CCW                          41800010
         LA    RWKD,0(,RWKD)       CLEAR HI ORDER BYTE                  42000010
         CLR   RWKD,RCCW           NO DATA TRANSFERRED                  42200010
         BNE   LOAD204H                 YES, 204H WILL HANDLE  @OY12439 42400010
         SPACE                                                          42600010
TXTRTRY  EQU   *                                                        42800010
         CLI   LCBINCAM,RETRY           RERRY COUNT                     43000010
         BL    TRYRETRY                 NO RETRY                        43200010
         SPACE                                                          43400010
TXTRESET EQU   *                                                        43600010
         MVI   LCBINCAM+ONE,TXTRST      404H RETURN            @OY10984 43800010
         SR    RWKC,RWKC                SET EOT OFFSET FOR SCT @OY10984 43820010
         STH   RWKC,LCBERCCW+4          CLEAR CHAIN FLAGS      @OY10984 43840010
         BAL   RWKD,CCWBLD              BUILD WRITE EOT        @OY14057 44380010
         B     COMEXIT                  COMMON CODE                     44600010
         SPACE                                                          44800010
NOTEXT1  EQU   *                                                        45000010
TRYRSPTX EQU   *                                                        45200010
         CLI   LCBRESTR,TPRDRPEB        RESPONSE TO ETB                 45400010
         BNE   TRYADDR                  TRY RESP TO ADDRESSING          45600010
TOTXT    EQU   *                                                        45800010
         LA    RWKC,ENQCH               INDEX PARAMETER                 46000010
         BAL   RWKD,CCWBLD              BUILB CCW IN LCBERCCW    S22025 46200010
         MVI   LCBINCAM+1,TORSPRET SET RETURN FOR 404H                  46400010
         MVI   LCBERCCW+4,CCWCC+CCWSLI  SET FLAGS                       46600010
         ST    RCCW,LCBERCCW+8          SET FOR TIC ADDRESS             46800010
         MVI   LCBERCCW+8,CCWTIC        SET TIC COMMAND CODE            47000010
         B     COMEXIT             USE COMMON EXIT                      47200010
         SPACE                                                          47400010
TRYADDR  EQU   *                                                        47600010
         CLI   LCBRESTR,TPRDRSPD        RESPONSE TO ADDRESSING          47800010
         BNE   SNOEXIT                  SHOULD NOT OCCUR                48000010
         LH    RWKC,LCBTTCIN            CURRENTLY CONNECTED             48200010
         LTR   RWKC,RWKC                IS THE SOURCE ON A DIAL  S22025 48240010
*                                         LINE SET               S22025 48280010
         BZ    TXTRESET                 NO, RESET THE LINE AND   S22025 48320010
*                                         TREAT AS A PERM ERROR  S22025 48360010
         BAL   RWKD,FINDTERM            GET TERMINAL ADDRESS            48400010
         USING IEDQTRM,RTERM                                            48600010
         SR    RWKB,RWKB                CLEAR FOR INDEX                 48800010
         IC    RWKB,TRMCHCIN            INDEX TO CHARACTERISTICS        49000010
         BCTR  RWKB,0                   DECREMENT FOR INDEX             49200010
         MH    RWKB,AVTDCTLN            LENGTH OF DCT ENTRY@G36XREV     49400010
         A     RWKB,AVTCSTCS            POINT TO CHARACTERISTICS        49600010
         TM    2(RWKB),X'10'            STATION CONTROL-MULTIPT         49800010
         BZ    NOMPT                    BRANCH NOT MULTIPT              50000010
         LA    RCUR,LCBCPA+16           RESTART AT TOP                  50200010
         B     TRYRETRY                 ATTEMPT RETRY                   50400010
NOMPT    EQU   *                                                        50600010
         SPACE                                                          50800010
         TM    3(RWKB),X'20'            END-END CONTROL                 51000010
         BNZ   TOTXT                    TREAT SAME AS TEXT TIMEOT       51200010
         SPACE                                                          51400010
         SH    RCUR,H8                  BACK UP TO WRITE ENQ            51600010
         B     TRYRETRY                 ATTEMPT RETRY                   51800010
         SPACE                                                          52000010
TOWRITE  EQU   *                                                        52200010
         TM    SCBSTATE,SCBTRANP        TRANSPARENT SNED                52400010
         BZ    SNOEXIT                  NO NO DLE ENQ REQUIRED          52600010
         LA    RWKC,DLEENQCH            INDEX PARAMTERE                 52800010
         BAL   RWKD,CCWBLD              BILD SEQUENCE                   53000010
         MVI   LCBERCCW+4,0             NO FLAGS                        53200010
         MVI   LCBINCAM+1,TOWRRET       SET 404H RETURN                 53400010
         B     COMEXIT                  COMMON EXIT                     53600010
         SPACE 5                                                        53800010
INTRTEST EQU   *                                                        54000010
         TM    LCBSENS0,INTREQ          INTERVENTION REQUIRED           54200010
         BZ    TRYBO                    NO, TRY BUSOUT                  54400010
         CLI   CCWOPCDE,CCWWRITE        WRITE COMMAND                   54600010
         BNE   TXTSNO                   BRANCH IF READ                  54800010
         SPACE                                                          55000010
         CLI   CCW+8,CCWDISAB           THIS A WRITE DLE EOT            55200010
         BNE   PERMEXIT                 NO,                             55400010
         LA    RCUR,8(,RCCW)            BUMP TO DISABLE                 55600010
         B     TRYRETRY                 RETRY AT DISABLE         S22025 55800010
         SPACE 2                                                        56000010
         SPACE 5                                                        56200010
TRYBO    EQU   *                                                        56400010
         CLI   CCWOPCDE,CCWREAD         READ                            56600010
         BE    TXTRTRY                  RETRY COMMAND                   56800010
         SPACE                                                          57000010
         CLC   CCWCOUNT,LCBCSW+5        ORIGINAL COUNT=RESIDUAL         57200010
         BE    TRYRETRY                 YES, RETRY                      57400010
         SPACE                                                          57600010
         TM    SCBSTATE,SCBTRANP        TRANSPARENT                     57800010
         BZ    SNOEXIT                  NO, SHOULD NOT OCCUR            58000010
         SPACE                                                          58200010
         LA    RWKC,DLEENQCH            SUBROUTINE PARAMETER            58400010
         BAL   RWKD,CCWBLD              BUILD WRITE DLEENQ              58600010
         MVI   LCBERCCW+4,0             NO FLAGS                        58800010
         MVI   LCBINCAM+1,BOXPRET                                       59000010
         B     COMEXIT                  COMMON EXIT                     59200010
         SPACE 2                                                        59400010
         SPACE 5                                                        59600010
UXWRITE  EQU   *                                                        59800010
         CLI   LCBRESTR,TPWRAKNK        WRITE TEXT RESPONSE             60000010
         BNE   NOTRESP                  BRNCH NO                        60200010
         MVI   LCBINCAM+1,UNEXRET       ASSUME WRTE TEXT RESPONSE       60400010
         B     READBLD                  BUILD READ                      60600010
         SPACE                                                          60800010
NOTRESP  EQU   *                                                        61000010
         LA    RCUR,NEXTCCW(RCUR)       ASSUME WRITE ENQ       @SA72446 61200010
         CLI   LCBRESTR,TPWRENQ         WRITE ENQ                       61400010
         BE    COMEXIT                  BRANCH IF YES          @SA72446 61600010
         SPACE                                                          61800010
         MVI   LCBINCAM+1,SKIPRET       SET READ SKIP RETURN            62000010
         MVC   LCBERCCW+4(4),SKPFLGCT   SET FLAGS AND COUNT             62200010
         B     READEXIT                 USE COMMON EXIT                 62400010
READBLD  EQU   *                                                        62600010
         MVC   LCBERCCW+4,SETCNT        SET READ COUNT                  62800010
READEXIT EQU   *                                                        63000010
         MVC   LCBCSWSV,LCBCSW          SAVE ENDING STATUS              63200010
         LA    RWKA,LCBERCCW+8          DATA ADDRESS                    63400010
         ST    RWKA,LCBERCCW            SET IN CCCW                     63600010
         MVI   LCBERCCW,CCWREAD         SET COMMAND CODE                63800010
         LA    RCUR,LCBERCCW            SET START ADDRESS               64000010
         B     COMEXIT                  UE COMMON EXIT                  64200010
         SPACE 5                                                        64400010
CCWBLD   EQU   *                                                        64600010
         MVC   LCBCSWSV,LCBCSW          SAVE CURRENT STATUS             64800010
         MVC   LCBSNSV,LCBSENS0         SAVE SENSE BYTE                 65000010
         LR    RWKA,RIOSB               SAVE IOSB ADDRESS        Y02027 65100010
         L     RWKA,DCBSCTAD-1          SCT ADDRESS                     65200010
         SR    RWKB,RWKB                CLEAR INDEX REGISTER            65400010
         IC    RWKB,0(RWKC,RWKA)        INDEX TO SEQUENCE               65600010
         IC    RWKC,0(RWKB,RWKA)        GET COUNT                       65800010
         STH   RWKC,LCBERCCW+6          SET COUNT                       66000010
         LA    RWKA,1(RWKA,RWKB)        POINT TO SEQUENCE               66200010
         ST    RWKA,LCBERCCW            SET IN CCW                      66400010
         MVI   LCBERCCW,CCWWRITE        SET COMMAND CODE                66600010
         LA    RCUR,LCBERCCW            FOR EXIT CODE                   66800010
         BR    RWKD                     RETURN                          67000010
         SPACE 5                                                        67200010
TRYRETRY EQU   *                                                        67400010
         CLI   LCBINCAM,RETRY           RETRY LIMIT RECHED              67600010
         BE    PERMEXIT                 YES,EXIT TO POST ERROR          67800010
         IC    RWKB,LCBINCAM            RETRY COUNT                     68000010
         LA    RWKB,1(,RWKB)            BUMP                            68200010
         STC   RWKB,LCBINCAM            SET BACK                        68400010
COMEXIT  EQU   *                                                        68600010
         ST    RCUR,LCBSTART-1          RESTART                         68800010
         MVI   LCBSENS0,AVTEZERO        CLEAR SENSE FOR RETRY    Y02027 69000010
*********************************************************************** 69006010
*                                                                     * 69012010
*        THE FOLLOWING CODE IS ADDED FOR AOS.                         * 69018010
*                                                                     * 69024010
         CLI   LCBECBCC,HIOCC           IOHALT ISSUED            Y02027 69024810
         BNE   SVCS                     BRANCH NO                Y02027 69025610
         SPACE 1                                                 Y02027 69026410
         NI    IOSFLA,X'FF'-(IOSERR+IOSEX) RESET ERP IN CTL      Y02027 69027210
         MVI   LCBINCAM+1,HIOCC         SET FOR LINEEND          Y02027 69028010
SVCS     EQU   *                                                 Y02027 69028810
         TM    IOSFLA,IOSERR+IOSEX      ARE WE DOING A RETRY     Y02027 69030010
         BNO   NOTRETRY                 BRANCH IF NO.            X01004 69036010
         LR    RSAVE,RIOSB              SAVE IOSB ADDRESS        Y02027 69042010
         L     RTST,IOSUSE              PICKUP ADDR OF RQE       Y02027 69048010
         SR    RLCB,RLCB                CLEAR FOR ICM.                  69054010
         ICM   RLCB,SEVEN,IOBPTR(RTST)  GET IOB ADDR FROM RQE,   X01004 69060010
*                                       FOR USE BY SIO APPENDAGE.       69066010
         SR    RTERM,RTERM              CLEAR FOR ICM.                  69072010
         ICM   RTERM,SEVEN,DEBPTR(RTST)  GET DEB ADDR FROM RQE   X01004 69078010
         LA    R15,DEBNMSUB-IEDQDEB     GET APDG. TABLE SIZE     Y02027 69084010
         SLR   RTERM,R15                POINT TO APDG. TABLE     Y02027 69090010
         L     RTERM,SIOPTR(ZERO,RTERM)  GET ADDR OF SIO APPEND- X01004 69096010
*                                       AGE FROM APPENDAGE VECTOR       69102010
*                                       TABLE.                          69108010
         SR    R15,R15                  CLEAR R15 TO TELL SIO AP-       69114010
*                                       PENDAGE IT'S A SUBROUTINE.      69120010
         BAL   RXCTL,SIOENTRY(ZERO,RTERM)  LNK TO SIO APPNDG AT  X01004 69126010
*                                       OFFSET +16 TO CONVERT CCW'S     69132010
*                                       FROM VIRTUAL TO REAL.           69138010
         LR    RIOSB,RSAVE              RESTORE IOSB ADDR        Y02027 69144010
*                                                                     * 69150010
*        END OF CODE ADDED FOR AOS.                                   * 69156010
*                                                                     * 69162010
*********************************************************************** 69168010
NOTRETRY EQU   *                                                 X01004 69174010
**************************************************************** Y02027 69176010
*        THE FOLLOWING CODE MAPS THE NECESSARY FIELDS FROM THE   Y02027 69178010
*        LINE CONTROL BLOCK TO THE I/O SUPERVISOR BLOCK FOR EXCP Y02027 69180010
*        COMPATABILITY DURING RETRY OPERATIONS FROM ERP          Y02027 69182010
**************************************************************** Y02027 69184010
         MVC   IOSCSW(SEVEN),LCBCSW     MAP CSW FROM LCB TO IOSB Y02027 69186010
         MVC   IOSSNS(TWO),LCBSENS0     MAP SENSE INFO FROM LCB  Y02027 69188010
*                                       INTO IOSB                Y02027 69190010
         MVC   IOSCC(ONE),LCBSIOCC      MAP START I/O CONDITION  Y02027 69192010
*                                       CODE FROM LCB TO IOSB    Y02027 69194010
         SVC   EREXCP                                                   69200010
         SPACE                                                          69400010
         SVC   RETURN                                                   69600010
         SPACE 2                                                        69800010
FINDTERM EQU   *                                                        70000010
         L     RWKB,AVTRNMPT            ADDRESS OF CODE BASE            70600010
         USING IEDQTNTD,RWKB                                            70800010
         BAL   RWKA,TNTDCODE            LINK TO IT                      71000010
         BR    RWKD                     REUTRN                          71200010
         SPACE 2                                                        71400010
PERMEXIT EQU   *                                                        71600010
         MVI   LCBINCAM+1,POPERM        RETRY EXHAUST                   71800010
         B     LOADMOD                  COMMON CODE                     72000010
         SPACE                                                          72200010
SNOEXIT  EQU   *                                                        72400010
         MVI   LCBINCAM+1,POSNO         'SHOULD NOT OCCUR' REUTRN       72600010
LOADMOD  EQU   *                                                        72800010
         LH    RLINK,POSTMOD            POST MODULE                     73000010
LOADMOD1 EQU   *                                               @OY12439 73100010
         L     RXCTL,CVTPTR             CVT ADDRESS                     73200010
         L     RXCTL,XCTLADD(,RXCTL)    ADDRESS OF XCTL                 73400010
        BR    RXCTL                    LINK TO XCTL                     73600010
LOAD204H EQU   *                                               @OY12439 73630010
         CLI   LCBINCAM,RETRY           RETRY COUNT EXCEEDED   @OY12439 73660010
         BNL   TXTRESET                 YES, BRANCH            @OY12439 73690010
         LH    RLINK,MOD204H            IGE0204H INDEX         @OY12439 73720010
         B     LOADMOD1                 EXIT TO IGE0204H       @OY12439 73750010
         EJECT                                                          73800010
*        C O N S T A N T S                                              74000010
SKPFLGCT DC    AL1(CCWSKIP),AL3(65000)  FLAG & CT. FOR READ SKIP S22025 74200010
SETCNT   DC    A(16)                    READ COUNT                      74400010
POSTMOD  DC    AL2(5048)                POST MODULE ID                  74600010
MOD204H  DC    AL2(2048)                IGE0204H INDEX         @OY12439 74700010
H8       DC    H'8'                     LENGTH OF CCW            S22025 74800010
SKIPCNT  DC    AL1(CCWSKIP),X'00FFFF'   FLAG AND LARGE COUNT     S22025 75000010
WRENQRET EQU   8                        404H RETURN WRITE ENQ           75200010
ZERO     EQU   0                        LENGTH EQUATES USED IN   X01004 75260010
ONE      EQU   1                                                 Y02027 75270010
TWO      EQU   2                                                 Y02027 75280010
HIOCC    EQU   X'48'                    HALT I/O COMPLETION      Y02027 75290010
SEVEN    EQU   7                        ADDRESSING AND DISPLACMNTY02027 75320010
RSPNQRET EQU   16                       404H RETURN ENQ RESPONSE        75400010
BOXPRET  EQU   36                       404H RETURN                     75600010
DLEENQCH EQU   17                       INDEX INTO SCT                  75800010
TORSPRET EQU   24                  RETURN INDICATOR FOR 404H            76000010
TOWRRET  EQU   32                       404H RETURN                     76200010
POSNO    EQU   4                        RETURN FOR 504H                 76400010
POPERM   EQU   8                        RETURN FOR 504H                 76600010
UNEXMSK  EQU   X'90'                    SELECTIVE RECORDING MASK        76800010
UNEXRET  EQU   12                       404H UNEX TEXT RESPONSE         77000010
LDRSPRET EQU   4                        404H RETURN                     77200010
RETRY    EQU   6                        RETRY COUNT                     77400010
CVTPTR   EQU   X'10'                    POINTER TO CVT                  77600010
XCTLADD  EQU   X'2C'                    OFFSET IN CVT-XCTL ROUTINE      77800010
IOBOFFST EQU   4                        IOB OFFSET IN RQE               78000010
ERPCTL   EQU   X'20'                    ERP IN CONTRO BIT               78200010
UNITCHK  EQU   X'02'                    UNIT CHECK MASK IN CSW          78400010
TIMEOUT  EQU   X'01'                    TIMEOUT ERROR MASK IN SENSE     78600010
LDTXTRET EQU   44                       404H RETURN                     78800010
UCBOFFST EQU   2                        OFFSET TO UCB ADDRESS -RQE      79000010
EREXCP   EQU   15                       ERROR EXCP                      79200010
RETURN   EQU   3                        MASK FOR RETURN SVC             79400010
INTREQ   EQU   X'40'                    MASK FOR INTERVENTION REQ       79600010
BUSOUT   EQU   X'20'                    MASK FOR BUSOUT                 79800010
EQCHK    EQU   X'10'                    EQUIPMENT CHECK MSSK            80000010
LOSTD    EQU   X'02'                    LOST DATA MASK                  80200010
X24      EQU   X'24'                    MASK FOR ERP IN CONTROL         80400010
CHEND    EQU   X'80'                    MASK FOR CHANNEL END            80600010
DEVEND   EQU   X'04'                    MASK FOR DEVICE END             80800010
ENQCH    EQU   7                        OFFSET INTO SCT                 81000010
RDENQ1   EQU   16                       RETURN FO R 404H                81200010
LDRSPETB EQU   4                        RETURN INDICATOR                81400010
SKIPRET  EQU   20                       RETURN FOR 404H                 81600010
X01      EQU   X'01'                    FLAG FOR IO GENERATOR           81800010
TXTRST   EQU   40                       404H RETURN                     82000010
NEXTCCW  EQU   8                        LENGTH OF A CCW        @SA72446 82010010
IOBPTR   EQU   5                        OFFSET OF IOB ADDR. IN RQE.     82020010
DEBPTR   EQU   9                        OFFSET OF DEB ADDR. IN RQE.     82040010
SIOPTR   EQU   4                        OFFSET OF SIO APDG. ADDRESS     82100010
*                                       IN APDG. VECTOR TABLE.          82120010
SIOENTRY EQU   34                       OFFSET OF SUBRTNE. ENTRY Y02027 82140010
*                                       POINT IN SIO APPENDAGE.         82160010
         EJECT                                                          82170010
         TDEBD                          DEB DSECT                       82180010
         EJECT                                                          82200010
         TSCBD                                                          82600010
         TCCWD                                                          82800010
         TLCBD                                                          83000010
         TTNTD                                                          83200010
         DCBD  DSORG=TX                                                 83400010
         TAVTD                                                          83600010
         TTRMD                                                          83800010
         TTPD                                                           84000010
         IECDIOSB                                                Y02027 84100010
         END                                                            84200010
