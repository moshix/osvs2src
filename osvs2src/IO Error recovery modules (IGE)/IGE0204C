         TITLE 'IGE0204C - BSC ERP ERROR POST ROUTINE'                  00150002
IGE0204C CSECT                                                          00200002
*********************************************************************** 00250002
*                                                                     * 00300002
* MODULE NAME:                                                        * 00350002
*    IGE0204C                                                         * 00400002
*                                                                     * 00450002
* DESCRIPTIVE NAME:                                                   * 00500002
*    BTAM BSC ERROR POST ERP                                          * 00550002
*                                                                     * 00600002
* COPYRIGHT:                                                          * 00650002
*    NONE                                                             * 00700002
*                                                                     * 00750002
* STATUS:                                                             * 00800002
*    CHANGE LEVEL 001                                                 * 00850002
*                                                                     * 00900002
* FUNCTION:                                                           * 00950002
*    THIS ROUTINE SETS UP THE IOB FIELDS USED IN PRINTING OPERATOR    * 01000002
*    MESSAGES AND ERROR MESSAGES GENERATED BY TERMINALS FOR           * 01050002
*    SYS1.LOGREC.                                                     * 01100002
*                                                                     * 01150002
* NOTES:                                                              * 01200002
*    DEPENDENCIES:                                                    * 01250002
*        NONE                                                         * 01300002
*    RESTRICTIONS:                                                    * 01350002
*        THIS ERP IS ONLY FOR DEVICES SUPPORTED BY BTAM.              * 01400002
*    REGISTER CONVENTIONS:                                            * 01450002
*        SEE 'REGISTER DEFINITION' BELOW                              * 01500002
*                                                                     * 01550002
* PATCHLABEL:                                                         * 01600002
*    PACHAREA (124 BYTES)                                             * 01650002
*                                                                     * 01700002
* MODULE TYPE:                                                        * 01750002
*    PROCEDURE                                                        * 01800002
*    PROCESSOR:                                                       * 01850002
*        BAL                                                          * 01900002
*    MODULE SIZE:                                                     * 01950002
*        1253 BYTES                                                   * 02000002
*    ATTRIBUTES:                                                      * 02050002
*        REENTRANT, ENABLED, KEY 0, SUPERVISOR STATE, NO LOCKS HELD.  * 02100002
*                                                                     * 02150002
* ENTRY POINT:                                                        * 02200002
*    IGE0204C                                                         * 02250002
*    PURPOSE:                                                         * 02300002
*        SEE 'FUNCTION'                                               * 02350002
*    LINKAGE:                                                         * 02400002
*        THIS MODULE IS SCHEDULED FOR EXECUTION BY THE INPUT/OUTPUT   * 02450002
*        SUPERVISOR. IT RUNS UNDER AN SIRB.                           * 02500002
*    INPUT:                                                           * 02550002
*        REG 1 = ADDRESS OF IOSB                                      * 02600002
*        SOH % C MESSAGE FORMAT ON ENTRY TO ERROR POST                * 02650002
*     ***************************************************************** 02700002
*     *               *               *               *               * 02750002
* +0  *      SOH      *       %       *       C       *      DLE      * 02800002
*     *               *               *               *               * 02850002
*     ***************************************************************** 02900002
*     *               *               *                               * 02950002
* +4  *      STX      * ROUTING CODE  *    17 OR 60 BYTES OF TEXT     * 03000002
*     *               *               *                               * 03050002
*     ***************************************************************** 03100002
* NOTE=DLE MAY OR MAY NOT BE PRESENT.                                 * 03150002
*                                                                     * 03200002
*       SOH % E MESSAGE FORMAT ON ENTRY TO ERROR POST                 * 03250002
*     ***************************************************************** 03300002
*     *       *       *       *       *       *       *       *       * 03350002
* +0  *  SOH  *   %   *   E   *  DLE  *  STX  * X'08' * UNUSED* UNUSED* 03400002
*     *       *       *       *       *       *       *       *       * 03450002
*     ***************************************************************** 03500002
*     *               *                                               * 03550002
* +8  *  TERMINAL ID  * 35 BYTES OF ERROR DATA...1 TO 6 35BYTE RECORDS* 03600002
*     *               *                                               * 03650002
*     ***************************************************************** 03700002
* NOTE=DLE MAY BE ABSENT -- SOH % E STX BLANK X'08'.............      * 03750002
*                                                                     * 03800002
*    OUTPUT:                                                          * 03850002
*       ALTERED CHANNEL PROGRAM                                       * 03900002
*       SOH % E MESSAGE FORMAT WHEN PASSED TO EREP (TPR ROUTINE)      * 03950002
*     ***************************************************************** 04000002
*     *               *       *               *       *      CHAN     * 04050002
* +0  *    LENGTH     *   E   *    X'2043'    * X'08' *      UNIT     * 04100002
*     *               *       *               *       *      ADDR     * 04150002
*     ***************************************************************** 04200002
*     *               *                                               * 04250002
* +8  *  TERMINAL ID  * ERROR DATA AS RECEIVED (1 TO 6 35BYTE RECORDS)* 04300002
*     *               *                                               * 04350002
*     ***************************************************************** 04400002
*                                                                     * 04450002
* EXITS-NORMAL:                                                       * 04500002
*    APPROPRIATE BTAM ERROR HANDLER VIA BRANCH ENTRY TO XCTL.         * 04600002
*        ALL LOADS START WITH IGE0. THE FIRST LOAD IS IGE0004A.       * 04650002
*        SUBSEQUENT LOADS ARE NUMBERED 1000 HIGHER THAN THE PREVIOUS  * 04700002
*        LOAD. THE ELEVENTH LOAD IS IGE0004B AND ALL SUBSEQUENT       * 04750002
*        LOADS ARE 1000 GREATER.                                      * 04800002
*        NO REGISTERS ARE SAVED BY THE ERROR ROUTINES AND ONLY        * 04850002
*        REGISTER 1 MAINTAINS TRANSPARENCY BETWEEN LOADS.             * 04900002
*                                                                     * 04950002
* EXITS-ERROR:                                                        * 05000002
*    NONE                                                             * 05050002
*                                                                     * 05100002
* EXTERNAL REFERENCES:                                                * 05150002
*    ROUTINES:                                                        * 05200002
*        SVC 35 WTO                                                   * 05250002
*    DATA AREAS                                                       * 05400002
*        IOB (MAPPED BY IEZIOB)                                       * 05450002
*        VIRTUAL CHANNEL PROGRAM                                      * 05500002
*        ERP WORKAREA (MAPPED BY IECDERWA)                            * 05550002
*    CONTROL BLOCKS                                                   * 05600002
*        UCB                                                          * 05650002
*        DCB                                                          * 05700002
*        DECB                                                         * 05750002
*        IOSB         (MAPPED BY IECDIOSB)                            * 05800002
*        CVT          (MAPPED BY CVT)                                 * 05850002
*        IOB          (MAPPED BY IEZIOB)                              * 05900002
*        RQE          (MAPPED BY IECDRQE)                             * 05950002
*                                                                     * 06000002
* TABLES-WORKAREAS:                                                   * 06050002
*    ERP WORKAREA                                                     * 06100002
*    IOB CHANNEL PROGRAM AREA IN IOB BTAM EXTENSION                   * 06150002
*                                                                     * 06200002
* MACROS:                                                             * 06250002
*    WTO                                                              * 06300002
*                                                                     * 06350002
* CHANGE ACTIVITY:                                                    * 06400002
*    YA01233  (IN BASE)                                               * 06410002
*    YM02566K (8/6/73)                                                * 06450002
*    YM02595K (9/20/73)                                               * 06500002
*    YM02594K (9/24/73)                                               * 06550002
*    YM05652K (1/24/74)                                               * 06560002
*    YM05680K (1/24/74)                                               * 06570002
*    ZA00504  (5/9/74)                                                * 06580000
*    AZ04158  (10/03/75)          AZ06405  (10/07/75)                   06586000
*    AZ13213  (09/23/76)          AZ14140  (10/28/76)                 * 06593000
*    AZ14138  (12/07/76)          AZ20105  (05/13/77)                 * 06600000
*********************************************************************** 06650002
         EJECT                                                          06700002
         USING *,BASEREG                                                06750002
         LR    BASEREG,ERREG5      SET BASE REG                         06800002
         B     BEGIN               BRANCH AROUND ID            @ZA00504 06810000
         DC    C' IGE0204C '       MODULE ID                   @ZA00504 06820000
         DC    C' 4129 '           DATE LAST CHANGE            @ZA00504 06830000
         DC    CL8'&SYSDATE'       DATE LAST ASSEMBLY          @ZA00504 06840000
BEGIN    DS    0H                                              @ZA00504 06842000
         USING RQE,ERREG5                                               06850002
         USING IECTDECB,DECBRG                                          06900002
         USING IHADCB,DCBREG                                            06950002
         USING IOSB,IOSBREG                                             07000002
         USING IOBSTDRD,IOBRG                                           07050002
         USING EWA,EWAREG                                               07100002
         L     ERREG5,IOSUSE       BASE RQE                             07150002
         L     EWAREG,IOSERP       BASE ERP WORKAREA                    07200002
         L     IOBRG,RQEIOB        BASE IOB                             07250002
         L     DECBRG,IOBECBPT     BASE DECB                            07300002
         L     DCBREG,IOBDCBPT     BASE DCB                             07350002
         L     UCBREG,IOSUCB       BASE UCB                             07400002
         DROP  ERREG5                                                   07450002
         L     CCWREG,IOBERCCW+L16   ADDRESS OF ERP CCW                 07500002
         TM    DCBBFTEK,DYNBF      DYNAMIC BUFFERING?                   07550002
         BNO   BSCEP0              NO,BRANCH                            07600002
         L     CCWREG,IOBFL3       GET IOB CSW                          07650002
BSCEP0   EQU   *                                               YM02566K 07700002
         LA    CCWREG,ZERO(CCWREG)   CLEAR OUT FLAG BYTE                07750002
         SH    CCWREG,ERRCN8       FAILING CCW                          07800002
         LA    DCBREG,ZERO(DCBREG)                                      07850002
         L     ERREG1,IOBERINF  GET DATA AREA ADDR SET BY 19MB @ZA13213 07900000
         CLC   ZERO(L3,ERREG1),OBRRTN   RETURN FROM TPER ROUTINE?       07950002
         BE    BSCEP052                                                 08000002
         CLC   ZERO(L2,ERREG1),DCBBSONL   SOH % MESSAGE?                08050002
         BE    BSCEP04                                                  08100002
BSCEPREG EQU   *                                                        08150002
         CLI   IOBERRCT,ERRMAXCT   RETRIES EXHAUSTED                    08200002
         BNL   BSCEP00             YES NORMAL POST                      08250002
         CLI   IOBERRCT+L1,RTRNCDEP   SPECIAL RETURN                    08300002
         BE    BSCEP03             IF SO, BRANCH                        08350002
         CLI   IOBWORK,ZERO        ERP CCW                              08400002
         BNE   BSCEP00             NO NORMAL POST                       08450002
         CLI   DECTYPE,WRTCONN     IS OPERATION WRITE CONNECT           08500002
         BNE   BSCEP03             NO, PROCESS AS USUAL                 08550002
         TM    IOBSENS0,LOSTDATA                                        08600002
         BO    BSCEP03B            YES, RETRY                           08650002
         L     ERREG1,IOBERCCW+L8   ADDRESS OF CCW THAT FAILED          08700002
         ST    ERREG1,IOBSTART     SET UP FOR EXCP                      08750002
         B     BSCEP03B                                                 08850002
BSCEP03  EQU   *                                                        08900002
         L     CCWREG,IOBFL3                                            08950002
         LA    CCWREG,ZERO(CCWREG)   CLEAR OUT FLAG BYTE                09000002
         SH    CCWREG,ERRCN8       GET ADDR OF FAILING CCW              09050002
         CLI   ZERO(CCWREG),CCWWRITE   WRITE COMMAND                    09100002
         BNE   BSCEP000            NO CHK SPEC RTRN                     09150002
         MVI   IOBERRCT+L1,RTRNCDEP   SET SPECIAL RTRN                  09250002
BSCEP03A L     ERREG1,IOBERCCW+L8   PICK UP READ CCW                    09300002
         ST    ERREG1,IOBSTART     MODIFY START ADDRESS                 09350002
BSCEP03B EQU   *                                                        09450002
         OI    IOSFLA,IOSERR       SET ERP IN CONTROL                   09500002
         OI    IOBFLAG1,IOBERRTN   ALSO IN IOB                          09550002
         MVI   EWAIND1,EWAISVCF    SVC 15                      YM05652K 09560002
         B     RETRY               ERROR EXCP                           09600002
BSCEP000 NI    IOBSENS0,L255-LOSTDATA   EXPECTED ERROR                  09650002
         MVI   IOBERRCT+L1,ZERO    ZIP RETURN CODE                      09700002
         CLI   IOBSENS0,ZERO       ANY SENSE ERRORS                     09750002
         BE    BSCEP002            NO CLEAR UC FROM CSW                 09800002
         TM    IOBSENS0,TOERROR    ERROR TIME OUT                       09850002
         BNO   BSCEP00             NO POST IN ERROR                     09900002
         TM    L4(CCWREG),SKIP     SKIP BIT ON                          09950002
         BO    BSCEP03A            YES RESTART WRITE                    10000002
         IC    ERREG2,IOBERRCT     BUMP RETRY                           10050002
         LA    ERREG2,L1(ERREG2)   COUNT BY ONE                         10100002
         STC   ERREG2,IOBERRCT     AND RETRY                            10150002
         MVI   EWAIND1,EWAISVCF    SVC 15                      YM05652K 10160002
         B     RETRY               ERROR EXCP                           10200002
BSCEP002 EQU   *                                                        10250002
         NI    IOBCSW+L3,L255-IOBCSWUC   TURN OFF UNIT CHECK   YM02566K 10300002
BSCEP001 EQU   *                                                        10400002
         MVI   EWAIND1,EWAILD00    EXIT TO 004C                YM02594K 10450002
         LA    NAMEREG,ERLOD00     GO TO 004C                  YM05680K 10460002
         B     XCTLOUT             GO TO IGE0004C              YM05680K 10500002
BSCEP00  EQU   *                                                        10550002
         NC    DECPOLPT+L1(L3),DECPOLPT+L1   POLLING CHARS AVAIL        10600002
         BZ    BSCEP00B            NO CHECK ADDRESSING                  10650002
         L     ERREG2,DECENTRY     PICK UP CHAR POINTER                 10700002
BSCEP00A MVC   IOBRESTR+L2(L2),ZERO(ERREG2)   MOVE IN CHARACTERS        10750002
         B     BSCEP01             CONTINUE FLOW                        10800002
BSCEP00B NC    DECADRPT+L1(L3),DECADRPT+L1   ADDRESSING CHARS AVAIL     10850002
         BZ    BSCEP01             NO CONTINUE MESSAGE CONSTRUCTION     10900002
         L     ERREG2,DECADRPT     PICK UP CHAR POINTER                 10950002
         B     BSCEP00A            CONTINUE FLOW                        11000002
BSCEP01  EQU   *                                                        11050002
         TM    DCBBFTEK,DYNBF      DYNAMIC BUFFERING?                   11100002
         BNO   BSCEP01A            NO, USE ORIGINAL FAILURE             11150002
         TM    TPOPCODE(CCWREG),X3F   IS IT ERP CCW                     11200002
         BNZ   BSCEP01B            NO, USE CURRENT FAILURE              11250002
         L     ERREG4,IOBERCCW+L16   TIC-ED TO CCW                      11300002
         LA    ERREG4,ZERO(ERREG4)   ZAP HIGH BYTE                      11350002
         SH    ERREG4,ERRCN8       BEGINNING OF CCW                     11400002
         TM    TPOPCODE(ERREG4),X30   PRIOR TO TEXT                     11450002
         BZ    BSCEP01A            YES, USE ORIGINAL FAILURE            11500002
         CLI   L8(CCWREG),X08      IND ERP CCW TIC                      11550002
         BE    BSCEP01X            YES, USE TIC-ED TO CCW               11600002
         CLI   L8(CCWREG),X03      2ND ERP CCW NOP                      11650002
         BNE   BSCEP01A            NO, USE ORIGINAL CCW                 11700002
BSCEP01X MVC   IOBERCCW+L17(L3),L9(CCWREG)   ALTER ORIGINAL CCW         11750002
         L     ERREG4,IOBERCCW+L16   ALTER ORIGINAL CSW                 11800002
         AH    ERREG4,ERRCN8                                            11850002
         ST    ERREG4,IOBERCCW+L16   MAKE IT LOOK LIKE CSW              11900002
BSCEP01A EQU   *                                                        11950002
         MVC   IOBSENS0(L1),IOBERCCW+L16   RESTORE SENSE INFO           12000002
         MVC   IOBCSW(L7),IOBERCCW+L17   RESTORE CSW INFO               12050002
BSCEP01B EQU   *                                                        12150002
         MVC   IOBRESTR(L1),TPOPCODE(CCWREG)   INSERT TP OP CODE        12200002
         MVC   IOBSENS1(L1),DECTYPE+L1    R/W OP TYPE          @ZA04158 12250000
         MVC   IOBRESTR+L1(L1),DECFLAGS   DECB FLAG BYTE       @ZA04158 12270000
         MVI   IOBWORK+L1,ZERO     ZERO OUT WORK FIELD                  12300000
         TM    IOBSENS0,TOERROR    ERROR TIME OUT                       12350002
         BZ    BSCEP01C            NO, ISSUE WTO                        12400002
         TM    DECTYPE,NOLERB      SUPPRESS WTO REQUESTED               12450002
         BO    BSCEP02             YES EXIT VIA IOS                     12500002
BSCEP01C EQU   *                                                        12550002
         TM    UCBTYP(UCBREG),X0A    CHECK FOR BSC1            @ZA14138 12558000
         BNZ   BSCEP01D            NO, CONTINUE                @ZA14138 12566000
         TM    DECFLAGS,SLAVCONT     CHECK FOR CONTENTION      @ZA14138 12574000
         BO    RETRY               IF SO GO POST               @ZA20105 12582000
BSCEP01D EQU   *                                               @ZA14138 12590000
         OI    IOSFLB,IOSLOG       INDICATE LOGOUT REQUESTED            12600002
         MVI   EWAIND1,EWAIWTOL    TELL 904B TO GO TO IOS WTO  YM02594K 12700002
         B     RETRY               GO TO 904B                  YM02594K 12750002
BSCEP02  NI    IOSFLA,L255-IOSERR   SET PERM ERROR IND                  12800002
         NI    IOBFLAG1,L255-IOBERRTN   ALSO IN IOB                     12850002
         MVI   EWAIND1,EWAISVCF    SVC 15                      YM05652K 12860002
         B     RETRY               ERROR EXCP                           12900002
BSCEP04  EQU   *                                                        12950002
         LH    ERREG4,L6(CCWREG)   GET ORIGINAL COUNT                   13000002
         SH    ERREG4,IOBCSW+L5    SUBTRACT RESIDUAL COUNT              13050002
         BCTR  ERREG4,ZERO         ADJUST FOR ENDING CHAR               13100002
         TM    DCBXMODE,INTBLCHK   ITB MODE?                            13150002
         BZ    BSCEP040                                                 13200002
         BCTR  ERREG4,ZERO         ADJUST FOR CHECK CHAR                13250002
BSCEP040 LA    ERREG2,L4(ERREG1)   POINT PAST HEADER                    13300002
         SH    CCWREG,ERRCN8       BACK UP ONE CCW                      13350002
         TM    UCBTYP+L1(UCBREG),X40   MULTIPOINT LINE?                 13400002
         BZ    BSCEP041                                                 13450002
         TM    DECTYPE+L1,READINIT   READ INITIAL?                      13500002
         BNZ   BSCEP041                                                 13550002
         L     ERREG3,ZERO(CCWREG)   PICK UP AREA ADDRESS               13600002
         AH    ERREG3,ERRCN1       INCREMENT ADDRESS BY ONE             13650002
         C     ERREG3,L8(CCWREG)   IS COUNT ADJUSTED?                   13700002
         BE    BSCEP041            YES, NOT FIRST TIME THRU             13750002
         LA    ERREG4,L1(ERREG4)   ADJUST FOR OTHER READ                13800002
BSCEP041 CLI   L2(ERREG1),EBC      EBCDIC C?                            13850002
         BNE   BSCEP05             PROCESS E TYPE MSG                   13900002
BSCEP04C CLC   L3(L1,ERREG1),DCBBSDLE   DLE INCLUDED?                   13950002
         BNE   BSCEP04D                                                 14000002
         LA    ERREG2,L1(ERREG2)   ADJUST FOR DLE                       14050002
         BCTR  ERREG4,ZERO         ADJUST COUNT                         14100002
BSCEP04D SH    ERREG4,ERRCN5       ADJUST FOR OTHER FRAM CHAR           14150002
BSCEP042 EQU   *                                                        14200002
         LA    CCWREG,L8(CCWREG)                                        14250002
         LR    ERREG3,ERREG1                                            14300002
         CH    ERREG4,SHORTMSG     THIS A SHORT MSG?                    14350002
         BH    BSCEP043            NO, SET FOR LONG MSG                 14400002
         MVC   EWAIAREA(LWTO1),WTO1   MOVE TO EWA                       14450002
         LA    ERREG1,EWAIAREA     GET ADDR OF SHORT TXT MSG            14500002
         B     BSCEP044            SET UP MSG                           14550002
BSCEP043 EQU   *                                                        14600002
         MVC   EWAIAREA(LWTO2),WTO2   MOVE TO EWA                       14650002
         LA    ERREG1,EWAIAREA     GET ADDR OF LONG TST MSG             14700002
         CH    ERREG4,RITESIZE     MSG TOO LONG?                        14750002
         BNH   BSCEP044            NO CONTINUE                          14800002
         LH    ERREG4,RITESIZE     SET LENGTH TO RIGHT SIZE             14850002
BSCEP044 MVC   L12(L3,ERREG1),L13(UCBREG)   PUT LINE ADDR ON MSG        14900002
         BCTR  ERREG4,ZERO         DECREMENT FOR MOVE                   14950002
         EX    ERREG4,MOVE         MOVE TEXT INTO MSG                   15000002
         LA    ERREG4,L13(ERREG4)   RESET COUNT & INCL HDR              15050002
         AR    ERREG4,ERREG1       ADD LENGTH TO PARM LIST PTR          15100002
         AH    ERREG4,ERRCN4       ADD NUMBER OF BYTES IN HDRR          15150002
         LA    ERREG4,L2(ERREG4)   ADD LENGTH OF DESCRIP FLD            15200002
         NI    ZERO(ERREG4),NULL   ZERO ROUTE CODE IN MSG               15250002
         NI    L1(ERREG4),NULL                                          15300002
         TM    ZERO(ERREG2),BIT7   ROUTE CODE 2 SPECIFIED?              15350002
         BNO   BSCEP045            NO, CHECK 8                          15400002
         OI    ZERO(ERREG4),CDE2   INDICATE MASTER CONSOLE              15450002
BSCEP045 TM    ZERO(ERREG2),BIT6   ROUTE CODE 8                         15500002
         BNO   BSCEP046            NO, CHECK 10                         15550002
         OI    ZERO(ERREG4),CDE8   INDICATE TP CONSOLE                  15600002
BSCEP046 TM    ZERO(ERREG2),BIT5   ROUTE CODE 10?                       15650002
         BNO   BSCEP047            NO, CONTINUE                         15700002
         OI    L1(ERREG4),CDE10    IND SYS MAINT COLSOLE                15750002
BSCEP047 LR    ERREG2,IOSBREG      SAVE IOSB PTR                        15800002
         LR    IOSBREG,ERREG1      GET PTR TO MSG                       15850002
         WTO   MF=(E,(1))          WRITE CONSOLE MSG                    15900002
         LR    IOSBREG,ERREG2      RESTORE IOSB PTR                     15950002
         L     ERREG1,IOBERINF     GET DATA ADDRESS                     16000002
BSCEP052 EQU   *                                                        16050002
         SH    CCWREG,ERRCN8                                            16100002
         TM    UCBTYP+L1(UCBREG),X40   MULTIPOINT LINE                  16150002
         BZ    BSCEP049                                                 16200002
         TM    DECTYPE+L1,READINIT   READ INITIAL                       16250002
         BNZ   BSCEP049                                                 16300002
         L     ERREG2,ZERO(CCWREG)   PICK UP AREA ADDRESS               16350002
         LA    ERREG2,L1(ERREG2)   INCREMENT BY ONE                     16400002
         CLM   ERREG2,L7,L9(CCWREG)   BEEN THRU BEFORE?        @ZA14140 16450000
         BE    BSCEP04E                                                 16500002
         STCM  ERREG2,L7,L9(CCWREG)   STORE NEW ADDRESS        @ZA00504 16550000
         LH    ERREG2,L14(CCWREG)   GET ORIGINAL COUNT                  16600002
         LA    ERREG2,L1(ERREG2)   ADD ONE TO COUNT                     16650002
         STH   ERREG2,L14(CCWREG)   STORE NEW COUNT                     16700002
BSCEP04E BCTR  ERREG1,ZERO         BACK UP PAST INDEX BYTE              16800002
BSCEP049 SR    ERREG2,ERREG2       CLEAR REGISTER                       16850002
         IC    ERREG2,IOBSNDPT     GET SEND ACK POINTER                 16900002
         AR    ERREG2,DCBREG       ADD DCB ADDRESS                      16950002
         A     ERREG2,WRTRSPCW     ADD COMMAND CODE AND OFFSET          17000002
         ST    ERREG2,IOBERCCW     SET UP FIRST HALF OF WRT             17050002
         MVC   IOBERCCW+L4(L4),WRTRSPCW+L4   SET UP NEXT HALF           17100002
         AH    CCWREG,ERRCN8       GO TO READ CCW                       17150002
         ST    CCWREG,IOBERCCW+L8   SET TIC ADDRESS                     17200002
         LA    ERREG2,CCWTIC       GET COMMAND CODE                     17250002
         STC   ERREG2,IOBERCCW+L8   SET COMMAND CODE                    17300002
         TM    DCBBFTEK,DYNBF      DYNAMIC BUFFERING USED?              17400002
         BZ    BSCEP04A            NO, RESTART CHAN PROGM?              17450002
         OI    L4(CCWREG),X88      SET ON DATA CHAIN AND PCI            17500002
         SH    ERREG1,ERRCN4                                            17550002
         MVI   ZERO(ERREG1),ZERO                                        17600002
         MVC   L8(L8,CCWREG),RDSKIP   MOVE IN READ SKIP CCW             17650002
         MVC   L16(L8,CCWREG),ZERO(CCWREG)   MOVE 1ST CCW TO THIRD CCW  17700002
         MVC   L24(L8,CCWREG),L8(CCWREG)   MOVE 2ND TO 4TH              17750002
         MVC   L17(L3,CCWREG),L1(ERREG1)   MOVE PTR TO NEXT BUFFER      17800002
         L     ERREG2,L16(CCWREG)   GET ADDR OF NEXT BUFFER             17850002
         AH    ERREG2,ERRCN4       ADD LINK FIELD                       17900002
         ST    ERREG2,L16(CCWREG)   STORE AREA ADDR IN 3RD CCW          17950002
         OI    L5(CCWREG),X40      SET ON 1ST PCI BIT IN 1ST CCW        18000002
         O     CCWREG,L24(CCWREG)   PLACE ADDR OF 1ST IN 4TH CCW        18050002
         ST    CCWREG,L24(CCWREG)                                       18100002
         LR    ERREG2,CCWREG       POINT TO 1ST READ                    18150002
         LA    ERREG2,L16(ERREG2)   INCREMENT TO 3RD CCW                18200002
         ST    ERREG2,L8(CCWREG)   PLACE ADDR OF 3RD IN 2ND CCW         18250002
         MVC   L24(L1,CCWREG),L8(CCWREG)                                18300002
         LH    ERREG2,DCBBUFL      GET BUFFER LENGTH                    18400002
         SH    ERREG2,ERRCN4       SUBTRACT LINK FIELD                  18450002
         STH   ERREG2,L22(CCWREG)   STORE IN THIRD CCW                  18500002
         OI    L37(CCWREG),X80     INDICATE LAST CCW                    18550002
BSCEP04A LA    CCWREG,IOBERCCW     GET START ADDRESS                    18600002
         ST    CCWREG,IOBSTART     UPDATE STARTING POINT                18650002
         OI    IOSFLA,IOSERR+IOSEX   SET FLAGS TO RETRY                 18750002
         OI    IOBFLAG1,IOBERRTN+IOBIOERR   ASLO IN IOB                 18800002
         MVI   EWAIND1,EWAISVCF    SVC 15                      YM05652K 18810002
RETRY    EQU   *                                                        18850002
         L     NAMEREG,TRANSRTN    LOAD NAME OF 904B           YM02594K 18900002
XCTLOUT  EQU   *                                                        18950002
         L     ERRETR,CVTPTR       POINT TO CVT                         19000002
         USING CVTMAP,ERRETR                                            19050002
         L     ERRETR,CVTXTLER     POINT TO XCTL ROUTINE                19100002
         DROP  ERRETR                                                   19150002
         BR    ERRETR              XCTL                                 19200002
BSCEP05  EQU   *                                                        19250002
         CLI   L2(ERREG1),EBE      E TYPE MSG RECEIVED?                 19300002
         BNE   BSCEPREG                                                 19350002
         STC   ERREG4,L1(ERREG1)   PUT LENGTH IN BUFFER                 19400002
         SRL   ERREG4,L8                                                19450002
         STC   ERREG4,ZERO(ERREG1)                                      19500002
         LA    ERREG4,ERLOD12      GET RETURN ID                        19550002
         STC   ERREG4,L4(ERREG1)   PUT ID IN BUFFER                     19600002
         SRL   ERREG4,L8                                                19650002
         STC   ERREG4,L3(ERREG1)                                        19700002
         MVC   L6(L2,ERREG1),L4(UCBREG)   MOVE IN LINE ADDRESS          19750002
         ST    ERREG1,IOBERCCW     STORE BUFFER POINTER                 19800002
         MVI   EWAIND1,EWAILD15    EXIT TO LOAD 15             YM02594K 19850002
         MVC   EWAIAREA(L4),IOBERINF   MOVE SOH% POINTER TO EWA         19950002
         B     RETRY               GO TO 904B                           20000002
         EJECT                                                          20700002
**********                                                              20750002
*                                                                       20800002
*        EXECUTED INSTRUCTIONS                                          20850002
*                                                                       20900002
**********                                                              20950002
MOVE     EQU   *                                                        21000002
         MVC   L16(ZERO,ERREG1),L1(ERREG2)                              21050002
**********                                                              21100002
*                                                                       21150002
*        CONSTANTS                                                      21200002
*                                                                       21250002
**********                                                              21300002
TRANSRTN DC    F'9042'             NAME OF BTAM TRANSLATE ROUTINE       21350002
WTO1     WTO   'IEC815I                      ',MF=L,ROUTCDE=(2),       X21850002
               DESC=(3)                                                 21900002
LWTO1    EQU   *-WTO1              LENGTH OF PARAMETER LIST             21950002
WTO2     WTO   'IEC815I                                                X22000002
                                ',MF=L,ROUTCDE=(2),DESC=(3)             22050002
LWTO2    EQU   *-WTO2              LENGTH OF PARAMETER LIST             22100002
WRTRSPCW DC    X'0100004060080002'                                      22160002
RDSKIP   DC    X'02000000B81200C0'                                      22170002
ERRCN1   DC    H'1'                                                     22180002
ERRCN8   DC    H'8'                                                     22190002
ERLOD15  DC    H'6256'                                                  22192002
ERRCN4   DC    H'4'                                                     22194002
SHORTMSG DC    H'17'                                                    22196002
RITESIZE DC    H'60'                                                    22198002
ERRCN5   DC    H'5'                                                     22198402
OBRRTN   DC    C'TPR'                                                   22198802
PACHAREA DC    31C'204C'           PATCH AREA FOR MAINTENANCE           22200002
**********                                                              22250002
*                                                                       22300002
*        MISCELLANEOUS EQUATES                                          22350002
*                                                                       22400002
**********                                                              22450002
ERLOD00  EQU   X'2B'               IGE0004C NAME FOR XCTL      YM05680K 22460002
IOBCSWUC EQU   X'02'               UNIT CHECK MASK             YM02566K 22500002
SKIP     EQU   X'10'                                                    22550002
NOLERB   EQU   X'40'                                                    22600002
TOERROR  EQU   X'01'                                                    22650002
ZERO     EQU   X'00'               LENGTH AND DISPLACEMENT              22700002
L1       EQU   1                   LENGTH AND DISPLACEMENT              22750002
L2       EQU   2                   LENGTH AND DISPLACEMENT              22800002
L3       EQU   3                   LENGTH AND DISPLACEMENT              22850002
L4       EQU   4                   LENGTH AND DISPLACEMENT              22900002
L5       EQU   5                   LENGTH AND DISPLACEMENT              22950002
L6       EQU   6                   LENGTH AND DISPLACEMENT              23000002
L7       EQU   7                   LENGTH AND DISPLACEMENT              23050002
L8       EQU   8                   LENGTH AND DISPLACEMENT              23100002
L9       EQU   9                   LENGTH AND DISPLACEMENT              23150002
L12      EQU   12                  LENGTH AND DISPLACEMENT              23200002
L13      EQU   13                  LENGTH AND DISPLACEMENT              23250002
L14      EQU   14                  LENGTH AND DISPLACEMENT              23300002
L16      EQU   16                  LENGTH AND DISPLACEMENT              23350002
L17      EQU   17                  LENGTH AND DISPLACEMENT              23400002
L22      EQU   22                  LENGTH AND DISPLACEMENT              23450002
L24      EQU   24                  LENGTH AND DISPLACEMENT              23500002
L37      EQU   37                  LENGTH AND DISPLACEMENT              23550002
X3F      EQU   X'3F'                                                    23600002
X30      EQU   X'30'                                                    23650002
X08      EQU   X'08'                                                    23700002
X03      EQU   X'03'                                                    23750002
X40      EQU   X'40'                                                    23800002
X88      EQU   X'88'                                                    23850002
X80      EQU   X'80'                                                    23900002
BIT5     EQU   4                                                        23910002
BIT6     EQU   2                                                        23920002
BIT7     EQU   1                                                        23930002
DCBIOBSZ EQU   X'24'               IOB SIZE IN DCB                      23950002
TPOPCODE EQU   5                                                        24000002
ERRMAXCT EQU   7                                                        24050002
CCWWRITE EQU   1                                                        24100002
RTRNCDEP EQU   X'1A'                                                    24150002
LOSTDATA EQU   2                                                        24350002
L255     EQU   X'FF'               AND MASK                             24400002
WRTCONN  EQU   X'1C'               OP TYPE FOR WRITE CONNECT            24450002
IOBRHA   EQU   X'10'                                                    24550002
WTORTN   EQU   253                                                      24600002
ERLOD12  EQU   2043                ERROR POST                           24650002
UCBTYP   EQU   16                                                       24700002
EBE      EQU   C'E'                                                     24750002
EBC      EQU   C'C'                                                     24800002
CCWTIC   EQU   X'08'                                                    24850002
NULL     EQU   X'00'                                                    24900002
CDE2     EQU   X'40'                                                    24950002
CDE8     EQU   X'01'                                                    25000002
CDE10    EQU   X'40'                                                    25050002
INTBLCHK EQU   X'40'                                                    25100002
DYNBF    EQU   X'08'                                                    25150002
READINIT EQU   X'FE'                                                    25200002
SLAVCONT EQU   X'10'                                           @ZA14138 25210000
X0A      EQU   X'0A'                                           @ZA14138 25220000
**********                                                              25250002
*                                                                       25300002
*        REGISTER DEFINITIONS                                           25350002
*                                                                       25400002
**********                                                              25450002
ERREG3   EQU   0                   WORK REG                             25500002
IOSBREG  EQU   1                   IOSB BASE/PARAMETER REG              25550002
ERREG2   EQU   2                   WORK REG                             25600002
EWAREG   EQU   3                   ERP WORKAREA BASE                    25650002
CCWREG   EQU   4                   CCW ADDRESS REG                      25700002
DECBRG   EQU   5                   DECB BASE                            25750002
DCBREG   EQU   6                   DCB BASE                             25800002
UCBREG   EQU   7                   UCB BASE                             25850002
BASEREG  EQU   8                   PROGRAM BASE                         25900002
ERREG1   EQU   9                   WORK REG                             25950002
IOBRG    EQU   10                  IOB BASE                             26000002
ERREG4   EQU   11                  WORK REG                             26050002
ERRLNK   EQU   12                  LINK REG                             26100002
NAMEREG  EQU   13                  LINK REG                             26150002
ERRETR   EQU   14                  LINK REG                             26200002
ERREG5   EQU   15                  LINK REG/WORK REG                    26250002
         EJECT                                                          26300002
         IECTDECB                                                       26350002
         EJECT                                                          26400002
         DCBD  DSORG=BX,DEVD=BS                                         26450002
         EJECT                                                          26500002
         IECDRQE                                                        26550002
         EJECT                                                          26600002
         IEZIOB                                                         26650002
         EJECT                                                          26700002
CVT      DSECT                                                          26750002
         CVT                                                            26800002
         EJECT                                                          26850002
         IECDERWA                                                       26900002
**********                                                              26950002
*                                                                       27000002
*        THE FOLLOWING DEFINITIONS ARE LOCAL FOR BTAM ERPS ONLY.        27050002
*                                                                       27100002
**********                                                              27150002
         ORG   EWAIERP                                                  27200002
EWAITRAN DS    F                   ADDRESS OF IECVTCCW         YM02594K 27250002
EWAITCCW DS    F                   PARALLEL TCCW               YM02594K 27300002
EWAIOVST DS    F                   ORIGINAL IOSVST CONTENTS    YM02594K 27350002
EWAIND0  DS    B                   FLAG BYTE                            27400002
EWAIVISR EQU   X'10'               V=R REQUEST                          28000002
EWAIPMAP EQU   X'08'               PARALLEL MAPPING DONE       YM02594K 28050002
EWAIGPRO EQU   X'04'               GETMAIN IN PROCESS          YM02594K 28100002
EWAIFPRO EQU   X'02'               FREEMAIN IN PROCESS         YM02594K 28150002
EWAIND1  DS    B                   FLAG BYTE                            28200002
EWAILD00 EQU   X'80'               EXIT TO 004C                YM02594K 28250002
EWAILD15 EQU   X'40'               EXIT TO LOAD 15             YM02594K 28300002
EWAIWTOL EQU   X'20'               EXIT TO IOS WTO             YM02594K 28350002
EWAISTAT EQU   X'10'               EXIT TO STAT UPDATE         YM05652K 28360002
EWAISVCF EQU   X'08'               SVC 15/SVC 3                YM05652K 28370002
EWAIND2  DS    B                   FLAG BYTE                            28400002
EWAIND3  DS    B                   FLAG BYTE                            28450002
EWAIAREA DS    20F                 SAVE AREA FOR MA OR AREA FOR WTO     28500002
EWAISAVE DS    2F                  TEMPORARY SAVE AREA                  28550002
EWAIEXIT DS    4F                  ESATE PARAMETER LIST                 28600002
*********  END OF BTAM LOCAL DEFINITIONS **********                     28610002
         EJECT                                                          28650002
         IECDIOSB                                                       28700002
         END                                                            28750002
