204H     TITLE 'IGE0204H DATA CHECK, OVERRUN, COMMAND REJECTRD/WR'      00200020
IGE0204H CSECT                                                          00210022
         SPACE 3                                                        00220022
*CHANGE-ACTIVITY = AS FOLLOWS:                                          00230022
******************** MICROFICHE FLAGS *********************** SUPT CODE 00240022
*                                                                       00250022
*A024200-025000,492000,656000                                    S22025 00270022
*C764000-766000                                                  S22025 00340022
*D018000-020000,028000-032000,818000                             S22025 00410022
*A188600-189200,390600-391200,814400-815600                      X01004 00440005
*C610000,618000                                                 SA65419 00450052
*C390000,552000-555600                                           X01004 00470005
*A492000,656000                                                         00500022
*D552400-553600,554800-555600,814400                             X02004 00530005
*C552000-554000                                                  X02004 00560005
*C220000,A804000                                               @SA74968 00570009
*A388600                                                       @ZA05034 00580009
*C244000                                                       @XA11313 00590009
*C658000-664000,A814000,A836000@OY10984                                 00590181
*C244000-245600                                                @OY12439 00590291
*A312000                                                       @OS76716 00590391
*C663800,D658600-663600,814040-814080,836500                   @OY14057 00590491
*C019000,504000                                                @G36XREV 00594400
*A626000,628000                                                @OY19601 00596411
*                                                                     * 00600020
*********************************************************************** 00800020
*                                                                     * 01000020
*MODULE-NAME = IGE0204H                                               * 01200022
*                                                                     * 01300022
*DESCRIPTIVE-NAME = ERP FOR BSC DATA CHECK, OVERRUN, COMMAND REJECT   * 01400022
*                   ON READ AND WRITE CCW'S                           * 01500022
*                                                                     * 01600022
*COPYRIGHTS = 'NONE'                                                  * 01700022
*                                                                     * 01800022
*STATUS: CHANGE LEVEL 10                                       @G36XREV 01900000
*                                                                     * 02400020
*FUNCTION -- TO ATTEMPT RETRY ON FAILING CCW SEQUENCE AND TO     S22025 02420022
*   TAKE INTERMEDIATE ERP ACTION IF REQUIRED.  ALL ERP MODULES   S22025 02440022
*   ATTEMPT TO RECOVER FROM ALL ERRORS.  CERTAIN TEXT ERRORS     S22025 02460022
*   REQUIRE RETURN TO LINE END TO SCHEDULE A SUBSEQUENT RECALL   S22025 02480022
*   OPERATION                                                    S22025 02500022
*                                                                     * 02520022
*ENTRY POINTS -- FIRST EXECUTABLE INSTRUCTION.                        * 02600020
*                                                                     * 03400020
*                                                                     * 03600020
*INPUT --                                                             * 03800020
*   R1 - POINTER TO I/O SUPERVISOR BLOCK                         Y02027 04000006
*   R15 - ENTRY POINT ADDRESS                                         * 04200020
*                                                                     * 04400020
*OUTPUT -- R1 POINTS TO I/O SUPERVISOR BLOCK                     Y02027 04600006
*                                                                     * 04800020
*EXTERNAL ROUTINE -- IGG019QE (AOS/TCAM SIO APPENDAGE) -- TO CONVERT  * 04900006
*   VIRTUAL CCW ADDRESSES TO REAL BEFORE RETRY.                       * 05000006
*                                                                     * 05200020
*EXITS-NORMAL -- R1 POINTS TO I/O SUPERVISOR BLOCK               Y02027 05400006
*        SVC   15   'ERP IN CONTROL (IOSERR)' AND 'EXCEPTIONAL   Y02027 05500006
*                CONDITION(IOSEX)'. RETURN TO IOS TO RETRY THE   Y02027 05600006
*                   ERROR.                                       Y02027 05700006
*        SVC   3                                                      * 05800020
*                                                                     * 06000020
*        SVC   15   'NO ERROR FLAGS'. RETURN TO LINE END         Y02027 06200006
*                   APPENDAGE. ERROR CLEARED                     Y02027 06300006
*        SVC   3                                                      * 06400020
*                                                                     * 06600020
*   TO SCHEDULE NEXT LOAD OF ERP                                      * 06800020
*        L     13,DECIMAL VALUE OF NEXT LOAD                          * 07000020
*        L   14,X'10'    CVT ADDRESS                                  * 07200020
*        L     14,X'2C'(14)    ADDRESS OF XCTL ROUTINE                * 07400020
*        BR    14   EXIT TO XCTL                                      * 07600020
*                                                                     * 07800020
*EXITS-ERROR -- R1 POINTS TO I/O SUPERVISOR BLOCK                Y02027 08000006
*        SVC   15   'EXCEPTIONAL CONDITION(IOSEX)'. RETURN TO    Y02027 08100006
*                   LINE END APPENDAGE. ERROR PERMANENT.         Y02027 08200006
*        SVC   3                                                      * 08400020
*                                                                     * 08600020
*        L     13,DECIMAL VALUE OF NEXT LOAD                          * 08800020
*        L   14,X'10'    CVT ADDRESS                                  * 09000020
*        L     14,X'2C'(14)    ADDRESS OF XCTL ROUTINE                * 09200020
*        BR    14   EXIT TO XCTL                                      * 09400020
*                                                                     * 09600020
*   TO SCHEDULE ERROR POST                                            * 09800020
*                                                                     * 10000020
*TABLES/WORK AREAS --                                                 * 10200020
*   TAVTD                                                             * 10400020
*   TTRMD                                                             * 10600020
*   TCCWD                                                             * 10800020
*   TLCBD                                                             * 11000020
*   DCBD                                                              * 11200020
*   TSCBD                                                             * 11400020
*   IECDIOSB                                                     Y02027 11500006
*                                                                     * 11600020
*ATTRIBUTES -- SERIALLY REUSABLE, REFRESHABLE, SUPERVISOR KEY,   Y02027 11800006
*              SUPERVISOR MODE, ENABLED                          Y02027 11900006
*                                                                     * 12000020
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 12200020
*   PARTICUALR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER      * 12400020
*   SET.                                                              * 12600020
*                                                                     * 12800020
*   R1 REMAINS TRANSPARENT TO ALL LOADS OF ERP.                       * 13000020
*   IF INTERMEDIATE ERP ACTION IS REQUIRED, THE SEQUENCE IS BUILT     * 13200020
*   IN LCBERCCW AND A RETURN INDICATOR IS SET IN LCBINCAM+1 FOR       * 13400020
*   IGE0404H.                                                         * 13600020
*                                                                     * 13800020
*********************************************************************** 14000020
         EJECT                                                          14200020
         USING IEDQCCW,RCCW                                             14400020
         USING IEDQLCB,RLCB                                             14600020
         USING IEDQSCB,RSCB                                             14800020
         USING IHADCB,RDCB                                              15000020
         USING IEDQAVTD,RAVT                                            15200020
         USING IOSB,RIOSB                                        Y02027 15300006
         USING *,R15                                                    15400020
R0       EQU   0                                                        15600020
RIOSB    EQU   1                        ADDR OF I/O SUPVR BLOCK  Y02027 15800006
RLCB     EQU   2                        LCB CBASE                       16000020
RCCW     EQU   5                        CCW BASE                        16200020
RWKD     EQU   3                        WORK REGISTER                   16400020
RDCB     EQU   4                        DCB BASE                        16600020
RWKA     EQU   6                        WORK REGISTER                   16800020
RWKB     EQU   7                        WORK REGISTER                   17000020
RTERM    EQU   8                        TERMINAL BASE                   17200020
RWKC     EQU   9                        WORK REGISTER                   17400020
RTST     EQU   9                        ADDR OF REQST QUEUE ELEM Y02027 17500006
RSCB     EQU   10                       SCB BASE                        17600020
RAVT     EQU   11                       AAVT BASE                       17800020
R2       EQU   12                       WORK REGISTER                   18000020
RLNK     EQU   13                       WORK AND LINAGE REGISTER        18200020
RSAVE    EQU   13                       SAVE REGISTER FOR IOSB   Y02027 18260006
RXCTL    EQU   14                       XCTL REGISTER                   18400020
R15      EQU   15                       ADDRESSABILITY REGISTER         18600020
         EJECT                                                          18800020
IGE0204H  IEDHJN  ENTER                                          X01004 18860005
         L     RTST,IOSUSE              PICKUP ADDR OF RQE       Y02027 18890006
         SPACE                                                          18920005
         L     RLCB,IOBOFFST(,RTST)     ADDRESS OF IOB Z(LCB)           19000020
         SH    RLCB,LCBBKUP             SET BASE                        19200020
         L     RDCB,LCBDCBPT            SET DCB BASE                    19400020
         L     RSCB,LCBSCBA-1           CURRENT SCB                     19600020
         L     RCCW,LCBCSW-1       FAILING CCW+8                        19800020
         SH    RCCW,H8             BACK UP TO FAILING CCW               20000020
         CLI   CCWOPCDE,CCWTIC          TIC (CHANNEL PROGAM CHECK)      20200020
         BNE   NOPC                     NO                              20400020
         SH    RCCW,H8                  BACK U TO TEXT CCW              20600020
         MVI   LCBCSW+6,0               CLEAR RESIDUAL COUNT            20800020
NOPC     EQU   *                                                        21000020
         L     RAVT,CVTPTR              CVT ADDRESS                     21200020
         L     RAVT,AVTCVTPT(,RAVT)     AVT LOAD LIST                   21400020
         L     RAVT,0(,RAVT)            AVT BASE SET                    21600020
         LR    RLNK,RCCW                ASSUME RESTART ON FAILING       21800020
         TM    LCBSENS0,DATCHK+TMOUT    DATA CHK OR TIMEOUT    @SA74968 22000009
         BZ    ITSOVRN                  NO, IT'SOVERRUN                 22200020
         SPACE                                                          22400020
         CLI   CCWOPCDE,CCWWRITE        WRITE COMMAND                   22600020
         BE    SNO                      YES, SNO ERROR                  22800020
         CLI   LCBRESTR,TPRDLC          READ LC OUT                     23000020
         BE    DCTXT                    YES                             23200020
         SPACE                                                          23400020
         CLI   LCBRESTR,TPTEXT          TEXT ERROR                      23600020
         BNE   NODCTXT                  NO                              23800020
DCTXT    EQU   *                                                        24000020
         CLI   LCBINCAM,RETRY           RETRY EXHAUSTED                 24200020
         BNL   PERMEXIT                 YES, PERM ERROR        @OY12439 24400091
         TM    LCBCSW+3,UNEX            UNIT EXCEPTION                  24600020
         BNZ   NORETRY                  YES, RETRY NOT POSSIBLE         24800020
         USING IEDQPRF,RWKA                                             25000020
         LA    RCCW,0(,RCCW)            THIS THE INTERRUPT              25200020
         L     RWKB,LCBCPA+12           POSSIBLE RESTART TEXT CCW       25400020
         L     RWKA,LCBLSPCI-1          BUFFER ADDRESS                  25800020
         TM    PRFSTAT1,PRFNHDRN        IS IT A HEADER                  25801020
         BO    NOTFIRST                 BRANCH IF NO                    25802020
         SPACE                                                          25803020
         CLC   LCBLSPCI(3),LCBCPA+13    WORKING ON FIRST UNIT           25804020
         BNE   NOTFIRST                 NO, ALREADY RCV'D A BLOCK       25805020
         SPACE                                                          25806020
         TM    PRFFLAGS,CCWSLI          WAS CONTINUE OP DONE ON1ST      25807020
*                                         UNIT OF BUFFER                25808020
         BO    BLDBUFF                  BRANCH IF NO                    25809020
*        I/O GENERATOR  TURNS OF SLI ON CONTINUE OPERATIONS             25810020
NOTFIRST EQU   *                                                        25811020
         SPACE                                                          25818020
         LA    RWKB,AVTEZERO(,RWKB)     CLEAR HI ORDER BYTE             25823020
LOOPBUFF EQU   *                                                        25828020
         LA    RWKA,AVTEZERO(,RWKA)     "LEAR HI ORDER BYTE             25833020
*              RWKB POINTS TO FIRST CCW IN CHAIN AFTER LAST EOB         25838020
*        RESTART.  IT MIGHT HAVE BEEN FRRED BY PCI.  A TEST IS ALSO     25843020
*        MADE TO DETERMINE IF IT HAS BEEN FREED AND RE-ASSIGNED.        25848020
         CLR   RWKB,RWKA                LAST EOB RESTART THIS BUFFER    25853020
         BE    TESTWRAP                 BRANCH IF YES, SEE IF IT        25858020
*                                         HAS BEEN RE-ASSIGNED          25863020
         SPACE                                                          25868020
         CLR   RWKA,RCCW                END OF SEARCH (RESTART CCW      25873020
*                                         NO LONGER IN BUFFER CHAIN     25878020
         BE    CHKRETRY                 BRANCH IF YES, CHECK RETRIES    25883020
         SPACE                                                          25888020
         L     RWKA,PRFTIC              GET NEXT UNIT (BUFFER)          25893020
         B     LOOPBUFF                 TEST NEX CCW IN CHAIN           25898020
         SPACE 2                                                        25903020
TESTWRAP EQU   *                                                        25908020
*              THE FOLLOWING TEST CHECK SIF RESTART CCW HAS BEEN        25913020
*        RE-ASSIGNED.                                                   25918020
         TM    CCWFLAGS-CCW(RWKB),CCWSLI I/O GENERATOR TURNS OFF SLI    25923020
*                                         ON A RESTART OR RECALL        25928020
         BO    CHKRETRY                 BRANCH IF BUFFER HAS BEEN       25933020
*                                       RE-USED. A RE-CALL IS NEEDED    25938020
         SPACE                                                          25943020
         B     WRNAK                    ATTEMPT RETRY                   25948020
         SPACE 3                                                        25953020
BLDBUFF  EQU   *                                                        25980020
         SPACE                                                          30600020
*        HEADER BUFFER MUST BE RECONSTRUCTEDTO ACCOUNT                  30800020
*  FOR POLLING ,IDLES, AND LCIN,                                        31000020
         SPACE                                                          31100020
         SR    RWKC,RWKC                CLEAR WORK REGISTER             31200020
         STH   RWKC,PRFSIZE             RESET PRFSIZE          @OS76716 31300091
         IC    RWKC,LCBISZE             IDLES                           31400020
         LA    RWKC,PRFSHDR-PRFSUNIT(,RWKC)                             31600020
         LH    RWKB,AVTKEYLE            GET UNIT SIZE                   31800020
         CH    RWKB,DCBBUFSI            COMPARE WITH BUFFER SIZEE       32000020
         BNH   SETSIZE                  BRANCH LESS OR EQUAL            32200020
         LH    RWKB,DCBBUFSI            GET BUFFER SIZE                 32400020
SETSIZE  EQU   *                                                        32600020
         SR    RWKB,RWKC                SET COUNT                       32800020
         STH   RWKB,PRFCOUNT                                            33000020
         LA    RWKC,PRFSUNIT-IEDQPRF(RWKC,RWKA)                         33200020
         IC    R0,PRFIOADR-1            SAVE OP CODE                    33400020
         ST    RWKC,PRFIOADR-1          SET ADDRESS                     33600020
         STC   R0,PRFIOADR-1            SET  OP CODE                    33800020
         LR    RWKB,RWKA                GET BUFFER ADDRESS              34000020
WRNAK    EQU   *                                                        34200020
         SR    RWKC,RWKC                CLEAR WORK REGISTER             34400020
         L     R2,DCBSCTAD-1            SCT ADDRESS                     34600020
         IC    RWKC,NAKCH(,R2)          GET SEQUENCE                    34800020
         LA    RWKC,1(RWKC,R2)          GET NAK ADDRESS                 35000020
         ST    RWKC,LCBCPA+16           SET WRITE NAK ADDDRESS          35200020
         MVI   LCBCPA+16,CCWWRITE       SET WRITE COMMAND               35400020
         MVI   LCBCPA+20,CCWCC+CCWSLI   SET FLGAS                       35600020
         MVI   LCBCPA+23,1              SET COUNT                       35800020
         LA    RWKA,LCBCPA+24           ASSUME NO LC OUT                36000020
         TM    SCBBSCFM,TRANSP          TRANSPARENT MODE                36200020
         BZ    NOTRANP                  NO                              36400020
         SPACE                                                          36600020
         MVI   LCBCPA+31,2              SET COUNT                       36800020
LCOUT    EQU   *                                                        37000020
         MVI   LCBCPA+28,CCWCD+CCWSLI                                   37200020
         LA    RWKC,LCBERCCW+12         DATA ADDRESS                    37400020
         ST    RWKC,LCBCPA+24           SET IN CCCW                     37600020
         MVI   LCBTPCD+3,TPRDLC         SET TP OP CODE                  37800020
         MVI   LCBCPA+24,CCWREAD        SET COMMAND CODE                38000020
         LA    RWKA,8(,RWKA)            BUMP TO NXT CCW                 38200020
         B     BUFFEXIT                 EXIT                            38400020
         SPACE                                                          38600020
NOTRANP  EQU   *                                                        38800020
         TM    SCBBSCFM,NONTR           NONTRANSPARENT SET              38860020
         BZ    BUFFEXIT                 BR NO,NOT SET YET      @ZA05034 38890009
         L     RTST,IOSUSE              PICKUP RQE ADDR          Y02027 38920006
         L     RWKC,DEBPTR-1(RTST)      GET DEB ADDR FROM RQE    X01004 39000005
         LA    RWKC,Z(RWKC)             CLEAR HIGH-ORDER BYTE    Y02027 39060006
         SH    RWKC,APPENSZ             POINT TO APPENDAGE TABLE Y02027 39080006
*                                       PREFIXING THE DEB        Y02027 39100006
         TM    0(RWKC),LCIN             LCIN SPECIFIED           X01004 39120005
         BO    BUFFEXIT                 YES                             39400020
         SPACE                                                          39600020
         MVI   LCBCPA+31,1              SET COUNT                       39800020
         B     LCOUT                    LCOUT                           40000020
         SPACE                                                          40200020
BUFFEXIT EQU   *                                                        40400020
         NI    LCBMSGFM,ACKI+NAK+OLT    RESET SCAN BITS                 40600020
         ST    RWKB,0(,RWKA)            SET IN TIC ADDRESS              40800020
         NI    CCWFLAGS-CCW(RWKB),AVTEFF-CCWSLI SET WRAP SWITCH         40900020
         MVI   0(RWKA),CCWTIC           SET TIC COMMAND CODE            41000020
         LA    RLNK,LCBCPA+16           FOR RESTART                     41200020
         B     SETCOUNT                 BUMP RETRY OCOUT AND EXIT       41400020
NORETRY  EQU   *                                                        41600020
         OI    LCBCHAIN,LCBNORTY        SET NO RETRY POSSIBLE           41800020
         B     PERMEXIT                 PERM ERROR                      42000020
         EJECT                                                          42100020
TXTERR   EQU   *                                                        43200020
CHKRETRY EQU   *                                                        43400020
         CLI   LCBINCAM,RETRY           RETRY EXHAUSTED                 43600020
         BE    PERMEXIT                 YES                             43800020
         NI    IOSFLA,AVTEFF-IOSERR     POST PERMANENT ERROR     Y02027 44000006
*                                       TO ABNORMAL END APPENDAG Y02027 44100006
         B     CONVERT                  BRANCH TO SET UP FOR RETRY.     44400006
NODCTXT  EQU   *                                                        44800020
         CLI   LCBRESTR,TPRDENQ         READ ENQ                        45000020
         BE    TRYRETRY                 YES, F ATTEMPT RETRY            45200020
         SPACE                                                          45400020
         CLI   LCBRESTR,TPRDIDNQ        READ ID ENQ                     45600020
         BE    TRYRETRY                 RETRY READ                      45800020
         SPACE                                                          46000020
         CLI   LCBRESTR,TPRDIDAK        READ ID ACK                     46200020
         BNE   TRYADDR                  NO, TRY ADDRESSING A ERROR      46400020
         SPACE                                                          46600020
DIALTEST EQU   *                                                        46800020
         LA    RLNK,LCBCPA+16           ASSUME RESTART POINT            47000020
         TM    LCBCPA+24,X'20'          DIAL SEQUENCE                   47200020
         BZ    TRYRETRY                 NO, RETRY                       47400020
         LA    RLNK,24(,RLNK)           BUMP PAST DIAL SEQUENCE         47600020
         B     TRYRETRY                 ATTEMPT RETRY                   47800020
         SPACE 2                                                        48000020
TRYADDR  EQU   *                                                        48200020
         CLI   LCBRESTR,TPRDRSPD        ADDRESSING RESPOSNE             48400020
         BNE   TRYRSPQ                  NO, TRY RSP ENQ                 48600020
         SPACE                                                          48800020
ADDERR   EQU   *                                                        49000020
         LH    RWKC,LCBTTCIN            CURRENTLY CONNECTED             49200020
         LTR   RWKC,RWKC                IS THE SOURCE ON A DIAL  S22025 49240022
*                                         LINE SET               S22025 49280022
         BZ    RESET                    NO, RESET THE LINE AND   S22025 49320022
*                                         TREAT AS A PERM ERROR  S22025 49360022
         BAL   RWKD,FINDTERM            GET TERMINAL ADDRESS            49400020
         USING IEDQTRM,RTERM                                            49600020
         SR    RWKB,RWKB                CLEAR FOR INDEX                 49800020
         IC    RWKB,TRMCHCIN            INDEX TO CHARACTERISTICS        50000020
         BCTR  RWKB,0                   DECREMENT FOR INDEX             50200020
         MH    RWKB,AVTDCTLN            MULTIPLY BY DCT LENGTH @G36XREV 50400000
         AL    RWKB,AVTCSTCS            CHARCTERISTICS BASE             50600020
         TM    2(RWKB),X'10'            MULTIPOINT                      50800020
         BO    DIALTEST                 RESTART FROM TOP                51000020
         SPACE                                                          51200020
         TM    3(RWKB),X'20'            END-END CONTROL                 51400020
         BNZ   WRENQ                    TREAT SAME AS TEXT RESPONSE     51600020
BACKUP   EQU   *                                                        51800020
         SPACE                                                          52000020
         SH    RLNK,H8                  BACK UP TO WRITE ENQ            52200020
         B     TRYRETRY                 ATTEMPT RETRY                   52400020
TRYRSPQ  EQU   *                                                        52600020
         CLI   LCBRESTR,TPRSPENQ        RESPONSE TO ENQ                 52800020
         BE    BACKUP                   BRANCH YES                      53000020
         SPACE                                                          53200020
         CLI   LCBRESTR,TPRDRESP        POLLING RESPONSE                53400020
         BE    DIALTEST                 YES, RESTART AT TOP             53600020
         CLI   LCBRESTR,TPRDRPEB        TEXT RESPONE                    53800020
         BNE   SNO                      NO                              54000020
WRENQ    EQU   *                                                        54200020
         LA    RWKC,ENQCH               INDEX PARAMETER                 54400020
         BAL   RWKD,CCWBLD              LINK TO ROUTINE                 54600020
         MVI   LCBINCAM+1,DCRET         SET 404H RETURN                 54800020
         MVI   LCBERCCW+4,CCWCC+CCWSLI  SET FLAGS                       55000020
         ST    RCCW,LCBERCCW+8          SET TIC TO FAILING CCW          55200005
         MVI   LCBERCCW+8,CCWTIC        SET TIC COMMAND CODE            55400005
         B     COMEXIT                  USE COMMON EXIT                 55600020
         SPACE                                                          55800020
ITSOVRN  EQU   *                                                        56000020
         TM    LCBSENS0,OVERRUN         OVERRUN SET                     56200020
         BZ    ITSCMDRJ                 NO, ITS COMMAND REJECT          56400020
         CLI   CCWOPCDE,CCWWRITE        WIRTE COMMAND                   56600020
         BE    SNO                      SHOULD NOT OCCUR                56800020
         SPACE                                                          57000020
         CLI   LCBRESTR,TPRDRPEB        RESPONSE TO ETB                 57200020
         BE    WRENQ                    YES                             57400020
         SPACE                                                          57600020
         CLI   LCBRESTR,TPRDENQ         READ ENQ                        57800020
         BE    TRYRETRY                 YES, RESTRY POSSIBLE            58000020
         SPACE                                                          58200020
         CLI   LCBRESTR,TPRDIDNQ        READ ID ENQ                     58400020
         BE    TRYRETRY                 YES                             58600020
         SPACE                                                          58800020
         CLI   LCBRESTR,TPRDRSPD        RESPONSE TO ADDRESSING/ENQ      59000020
         BE    ADDERR                   YES, RECOVERY SAME AS DC        59200020
         SPACE                                                          59400020
         CLI   LCBRESTR,TPRDIDAK        READ ID AK                      59600020
         BE    DIALTEST                 YES                             59800020
         SPACE                                                          60000020
         CLI   LCBRESTR,TPRSPENQ        RESPONSE TO ENQ                 60200020
         BE    DIALTEST                 YES                             60400020
         SPACE                                                          60600020
         CLI   LCBRESTR,TPRDLC          READ LC OUT                     60800020
         BE    DCTXT                    BR YES, WRITE NAK       SA65419 61000052
         CLI   LCBRESTR,TPRDRESP        POLLING RESPONSE                61200020
         BE    DIALTEST                 YES, RESTART AT TOP             61400020
         CLI   LCBRESTR,TPTEXT          TEXT ERROR                      61600020
         BE    DCTXT                    BR YES, WRITE NAK       SA65419 61800052
         SPACE                                                          62000020
         B     SNO                      'SHOULD NOT OCCUR'              62200020
         SPACE 5                                                        62400020
ITSCMDRJ EQU   *                                                        62600020
         CLI   LCBRESTR,TPOPEN          OPCON WRITE DLEEOT     @OY19601 62650011
         BE    OPCONDE                  BRANCH YES             @OY19601 62700011
         CLI   LCBRESTR,TPWRDLET        WRITE DLE EOT                   62800020
         BNE   SDDLEENQ                 NO, WRITE DLE ENQ               63000020
OPCONDE  EQU   *                                               @OY19601 63050011
         LA    RLNK,8(,RLNK)            RESTART ON DISABLE              63200020
         B     TRYRETRY                 ATTEMPT ETRY                    63400020
SDDLEENQ EQU   *                                                        63600020
         LA    RWKC,DLEENQCH            INDEX PARAMETER                 63800020
         BAL   RWKD,CCWBLD              BUILD WR DLE ENQ                64000020
         MVI   LCBERCCW+4,0             NO FLAGS                        64200020
         MVI   LCBINCAM+1,DLENQRET      SET 404H RETURN                 64400020
         B     COMEXIT                  USE COMMON EXIT                 64600020
         SPACE 5                                                        64800020
TXTRTRY  EQU   *                                                        65000020
         CLI   LCBINCAM,RETRY           RETRY LIMIT REACHED             65200020
         BL    TRYRETRY                 NO                              65400020
         SPACE                                                          65600020
RESET    EQU   *                                                 S22025 65700022
         MVI   LCBINCAM+ONE,TXTRESET    404H RETURN            @OY10984 65800081
         SR    RWKC,RWKC                SET EOT OFFSET FOR SCT @OY10984 65820081
         STH   RWKC,LCBERCCW+4          CLEAR CHAIN FLAGS      @OY10984 65840081
         BAL   RWKD,CCWBLD              BUILD WRITE EOT        @OY14057 66380091
         B     COMEXIT                  COMMON CODE                     66600020
         SPACE 3                                                        66800020
TRYRETRY EQU   *                                                        67000020
         CLI   LCBINCAM,RETRY           CHECK RETRY COUNT               67200020
         BE    PERMEXIT                 LIMTI REACHED                   67400020
SETCOUNT EQU   *                                                        67600020
         IC    RWKB,LCBINCAM            RETRY COUNT                     67800020
         LA    RWKB,1(,RWKB)            BUMP                            68000020
         STC   RWKB,LCBINCAM            SET BACK                        68200020
COMEXIT  EQU   *                                                        68400020
         ST    RLNK,LCBSTART-1          SET STARTING CCW ADDRESS        68600020
         MVI   LCBSENS0,AVTEZERO        CLEAR SENSE FOR ETRY            68800020
*********************************************************************** 68806006
*                                                                     * 68812006
*        THE FOLLOWING CODE IS ADDED FOR AOS.                         * 68818006
*                                                                     * 68824006
CONVERT  EQU   *                                                        68830006
         CLI   LCBECBCC,HIOCC           IOHALT ISSUED            Y02027 68830306
         BNE   SVCS                     BRANCH NO                Y02027 68830606
         SPACE 1                                                 Y02027 68830906
         NI    IOSFLA,X'FF'-(IOSERR+IOSEX) RESET ERP IN CTL      Y02027 68831206
         MVI   LCBINCAM+1,HIOCC         SET FOR LINEEND          Y02027 68831506
SVCS     EQU   *                                                 Y02027 68831806
**************************************************************** Y02027 68832106
*        THE FOLLOWING CODE MAPS THE NECESSARY FIELDS FROM THE   Y02027 68832406
*        LINE CONTROL BLOCK TO THE I/O SUPERVISOR BLOCK FOR EXCP Y02027 68832706
*        COMPATABILITY DURING RETRY OPERATIONS FROM ERP          Y02027 68833006
**************************************************************** Y02027 68833306
         MVC   IOSCSW(SEVEN),LCBCSW     MAP CSW FROM LCB TO IOSB Y02027 68833606
         MVC   IOSSNS(TWO),LCBSENS0     MAP SENSE INFO FROM LCB  Y02027 68833906
*                                       INTO IOSB                Y02027 68834206
         MVC   IOSCC(ONE),LCBSIOCC      MAP START I/O CONDITION  Y02027 68834506
*                                       CODE FROM LCB TO IOSB    Y02027 68834806
         TM    IOSFLA,IOSERR+IOSEX      ARE WE DOING A RETRY     Y02027 68836006
         BNO   NOTRETRY                 BRANCH IF NO.            X01004 68842006
         LR    RSAVE,RIOSB              SAVE IOSB ADDRESS        Y02027 68848006
         L     RTST,IOSUSE              PICKUP ADDR OF RQE       Y02027 68854006
         SR    RLCB,RLCB                CLEAR FOR ICM.                  68860006
         ICM   RLCB,7,IOBPTR(RTST)      GET IOB ADDRESS FROM RQE,       68866006
*                                       FOR USE BY SIO APPENDAGE.       68872006
         SR    RTERM,RTERM              CLEAR FOR ICM.                  68878006
         ICM   RTERM,7,DEBPTR(RTST)     GET DEB ADDRESS FROM RQE.       68884006
         LA    R15,DEBNMSUB-IEDQDEB     GET APDG. TABLE SIZE     Y02027 68890006
         SLR   RTERM,R15                POINT TO APDG. TABLE     Y02027 68896006
         L     RTERM,SIOPTR(Z,RTERM)    GET ADDRESS OF SIO APDG. X01004 68902006
*                                       FROM APDG. VECTOR TABLE.        68908006
         SR    R15,R15                  CLEAR R15 TO TELL SIO APDG.     68914006
*                                       IT'S A SUBROUTINE.              68920006
         BAL   RXCTL,SIOENTRY(Z,RTERM)  LINK TO SIO APPENDAGE    X01004 68926006
*                                       AT OFFSET                X01004 68932006
*                                       +16 TO CONVERT CCW'S FROM       68938006
*                                       VIRTUAL TO REAL.                68944006
         LR    RIOSB,RSAVE              RESTORE IOSB ADDR        Y02027 68950006
*                                                                     * 68956006
*        END OF CODE ADDED FOR AOS.                                   * 68962006
*                                                                     * 68968006
*********************************************************************** 68974006
NOTRETRY EQU   *                                                 X01004 68980006
         SVC   EREXCP                                                   69000020
         SPACE                                                          69200020
         SVC   RETURN                                                   69400020
         SPACE                                                          69600020
PERMEXIT EQU   *                                                        69800020
         MVI   LCBINCAM+1,PERMRET       SET RETURN INDICATOR            70000020
         B     LOADMOD                  GO TO 504H                      70200020
SNO      EQU   *                                                        70400020
         MVI   LCBINCAM+1,SNORET        SET RETURN INDICATOR FOR        70600020
*                                         504H                          70800020
LOADMOD  EQU   *                                                        71000020
         LH    RLNK,POSTMOD            MODULE ID                        71200020
         L     RXCTL,CVTPTR             GET CVT ADDRESS                 71400020
         L     RXCTL,XCTLADD(,RXCTL)    SCTL ROUTINE ADDRESS            71600020
         BR    RXCTL                    LINK TO POSTMODULE              71800020
         SPACE                                                          72000020
CCWBLD   EQU   *                                                        72200020
         MVC   LCBCSWSV,LCBCSW          SAVE CURRENT STATUS             72400020
         MVC   LCBSNSV,LCBSENS0         SAVE CURRENT SENSE              72600020
         L     RWKA,DCBSCTAD-1          C SCT ADDRESS                   72800020
         SR    RWKB,RWKB                CLEAR INDEX REGISER             73000020
         IC    RWKB,0(RWKC,RWKA)        POINT TO SEQUENCE               73200020
         IC    RWKC,0(RWKB,RWKA)        GET COUNT BYTE                  73400020
         STH   RWKC,LCBERCCW+6          SET COUNT                       73600020
         LA    RWKA,1(RWKB,RWKA)        POINT TO SEQUENCE               73800020
         ST    RWKA,LCBERCCW            SET IN CCW                      74000020
         MVI   LCBERCCW,CCWWRITE        SET COMMAND CODE                74200020
         LA    RLNK,LCBERCCW            FOR EXIT CODE                   74400020
         BR    RWKD                     RETURN                          74600020
         SPACE 3                                                        74800020
         SPACE 2                                                        75000020
FINDTERM EQU   *                                                        75200020
         L     RWKB,AVTRNMPT            ADDRESS OF CODE BASE            75400020
         USING IEDQTNTD,RWKB                                            75600020
         BAL   RWKA,TNTDCODE            LINK TO IT                      75800020
         BR    RWKD                     RETURN                          76000020
         SPACE 2                                                        76200020
H8       DC    H'8'                     USED TO ADJUST CCW PTR   S22025 76300022
LCBBKUP  DC    AL2(LCBFLAG1-IEDQLCB)    ADJUSTMENT TO BACK UP TO S22025 76400022
*                                       BEGINNING OF LCB         S22025 76500022
POSTMOD  DC    AL2(5048)                POST MODULE ID                  76800020
         DS    0H                                                Y02027 76860006
APPENSZ  DC    AL2(DEBNMSUB-IEDQDEB)    APPENDAGE TABLE SIZE     Y02027 76920006
RETRY    EQU   6                        RETRY COUNT                     77000020
CVTPTR   EQU   X'10'                    POINTER TO CVT                  77200020
XCTLADD  EQU   X'2C'                    OFFSET IN CVT-XCTL ROUTINE      77400020
IOBOFFST EQU   4                        IOB OFFSET IN RQE               77600020
OVERRUN  EQU   X'04'                    OVERRUN MASK                    77800020
ERPCTL   EQU   X'20'                    ERP IN CONTRO BIT               78000020
ENQCH    EQU   7                        INDEX INTO SCT                  78200020
NAKCH    EQU   6                        INDEX TO SEQUENCE               78400020
DLEENQCH EQU   17                       INDEX TO SEQUENCE               78600020
PERMRET  EQU   8                        504H TETURN                     78800020
EREXCP   EQU   15                       ERROR EXCP                      79000020
DCRET    EQU   4                        404H RETURN                     79200020
ONE      EQU   1                                                 Y02027 79240006
TWO      EQU   2                                                 Y02027 79280006
SEVEN    EQU   7                                                 Y02027 79320006
HIOCC    EQU   X'48'                    HALT I/O COMPLETION      Y02027 79360006
RETURN   EQU   3                        MASK FOR RETURN SVC             79400020
UNEX     EQU   X'01'                    UNIT E CEPTION MASK             79600020
ACKI     EQU   X'40'                    ACK COUNTER MASK                79800020
NAK      EQU   X'80'                    NAK MASK                        80000020
OLT      EQU   X'01'                    ONL LINE TEST MASK              80200020
DATCHK   EQU   X'08'                    DATA CHECK MASK                 80400020
TMOUT    EQU   X'01'                    TIME OUT SENSE         @SA74968 80500009
RCVPCI   EQU   X'22'                    PCI RECEIE OPTIONS              80600020
SNORET   EQU   4                        504H RETURN                     80800020
TXTRESET EQU   40                       404H RETURN INDICATOR           81000020
DLENQRET EQU   28                       404H RETURN                     81200020
NONTR    EQU   X'40'                    SCB FLAG FOR RECEIPT OF BSC     81300020
TRANSP   EQU   X'80'                    TRANSPARENT MODE RECEIVE        81400020
SIOPTR   EQU   4                        OFFSET OF SIO APDG. ADDRESS     81412006
*                                       IN APDG. VECTOR TABLE.          81416006
SIOENTRY EQU   34                       OFFSET OF SUBRTNE. ENTRY Y02027 81420006
*                                       POINT IN SIO APPENDAGE.         81424006
RETRYFLG EQU   X'24'                    RETRY FLAG IN LCBFLAG1.  X01004 81428006
Z        EQU   0                                                 X01004 81432006
IOBPTR   EQU   5                        OFFSET OF IOB ADDR. IN RQE      81452006
DEBPTR   EQU   9                        OFFSET OF DEB ADDR. IN RQE.     81480005
LCIN     EQU   X'80'                    LCIN SPECIFIED           X01004 81560005
         EJECT                                                          81570006
         TDEBD                          DEB DSECT                       81580006
         EJECT                                                          81600020
         TCCWD                                                          82000020
         TTNTD                                                          82200020
         TAVTD                                                          82400020
         DCBD  DSORG=TX                                                 82600020
         TLCBD                                                          82800020
         TSCBD                                                          83000020
         TTRMD                                                          83200020
         TTPD                                                           83400020
         TPRFD                                                          83600020
         IECDIOSB                                                Y02027 83700006
         END                                                            83800020
