404H     TITLE 'IGE0404H ERP CCW RETURN MODULE'                         00200010
IGE0404H CSECT                                                          00400010
         SPACE 3                                                 S21903 00400210
*  CHANGE ACTIVITY AS FOLLOWS                                           00400410
******************** MICROFICHE FLAGS *********************** SUPT CODE 00400610
*A378000                                                         S21101 00401010
*D606000-818000                                                  S21101 00401110
*A304000,860000                                                  S99244 00401210
*C308000-310000                                                  S99244 00401310
*D236000,304000,404000,480000,492000,828000-830000,834000-836000 S99244 00401410
*D842000-860000,888000,898000-900000,910000,916000-928000        S99244 00401510
*D932000-940000,948000,962000                                    S99244 00401610
*C058000,076000,110000,126000,128000,160000,174000,182000,       S21903 00401710
*C196000,198000,220000,222000,230000,268000,270000,298000,       S21903 00401810
*C326000,328000,332000,400000,406000,446000,462000,484000,       S21903 00401910
*C504000,514000,552000,562000,566000,572000,576000,580000,       S21903 00402010
*C586000,602000,832000,833000,836000,838000,842000,878000,       S21903 00402110
*C896000,912000,944000                                           S21903 00402210
*D948000                                                         S21903 00402310
*      CLEAN-UP                                                  S21903 00402410
*C198900                                                        SA63037 00402510
*A 346020-346520,594100-594400,944100-945700                     X01004 00402610
*C 036000,198900,310000,424000,468000,820000                     X01004 00402710
*D 232000,236000-258000,312000-316000,426000-428000              X01004 00402810
*D 470000-472000,822000,824000                                   X01004 00402910
*A042000-043000,049000,068000,101000,105000,147000,166600-167200,Y02027 00403010
*A179000,492000,601000,962000                                    Y02027 00403110
*C102600,032000,040000-041000,048000,066000-067000,104000,154000,Y02027 00403210
*C186000,346000-346060,346420,346540-346600,347380,600000        Y02027 00403310
*A502000                                                       @SA69101 00403610
*A199500                                                       @YA06328 00433610
*A347000                                                       @XA08979 00463610
*D199570,199920                                                @SA74861 00493610
*A506000,588000                                                @SA74968 00523610
*A230000                                                       @ZA05036 00553610
*A402000                                                       @OS76308 00553710
*A346000                                                       @OS76482 00553810
*A183320,460000                                                @OS76482 00553910
*C264000-280000,A183680,A960000                                @OY10984 00554010
*A264800                                                       @OY12966 00554110
*C277600-278000                                                @OY12966 00554210
*C264400-278800,D183780,960600-961200                          @OY14057 00554310
*C346020                                                       @OY15006 00554410
*C308000-310400,A958000                                        @OX17153 00574410
         SPACE 3                                                 S21903 00600010
*********************************************************************** 00800010
*                                                                     * 01000010
*TITLE -- 'IGE0404H', BSC INTERMEDIATE ERP CCW RETURN                 * 01200010
*                                                                     * 01400010
*  MODULE NAME = IGE0404H                                             * 01600010
*                                                                     * 01620010
*  DESCRIPTIVE NAME = BSC INTERMEDIATE ERP CCW RETURN                 * 01640010
*                                                                     * 01660010
*  COPYRIGHT = 'NONE'                                                 * 01680010
*                                                                     * 01700010
*  STATUS:  CHANGE LEVEL 6                                            * 01720010
*                                                                     * 01800010
*FUNCTION -- TO SERVICE INTERRUPTS ON INTERMEDIATE ERP CCW'S.         * 02000010
*                                                                     * 02200010
*INPUT --                                                             * 02400010
*   R1 - POINTER TO I/O SUPERVISOR BLOCK                         Y02027 02600010
*   R15 - ENTRY POINT ADDRESS                                         * 02800010
*                                                                     * 03000010
*OUTPUT -- R1 POINTS TO I/O SUPERVISOR BLOCK                     Y02027 03200010
*                                                                     * 03400010
*EXTERNAL ROUTINE -- IGG019QE (AOS/TCAM SIO APPENDAGE) -- TO CONVERT  * 03600010
*   VIRTUAL CCW ADDRESSES TO REAL BEFORE RETRY.                         03700010
*                                                                     * 03800010
*EXITS-NORMAL -- R1 POINTS TO I/O SUPERVISOR BLOCK               Y02027 04000010
*        SVC   15   'ERP IN CONTROL (IOSERR)' AND 'EXCEPTIONAL   Y02027 04100010
*                CONDITION(IOSEX)'. RETURN TO IOS TO RETRY THE   Y02027 04200010
*                   ERROR.                                       Y02027 04300010
*        SVC   3                                                      * 04400010
*                                                                     * 04600010
*        SVC   15   'NO ERROR FLAGS'. RETURN TO LINE END         Y02027 04800010
*                   APPENDAGE. ERROR CLEARED                     Y02027 04900010
*        SVC   3                                                      * 05000010
*                                                                     * 05200010
*   TO SCHEDULE NEXT LOAD OF ERP                                      * 05400010
*        L     13,DECIMAL VALUE OF NEXT LOAD                          * 05600010
*        L     14,X'10'   CVT ADDRESS                           S21903* 05800010
*        L     14,X'2C'(14)    ADDRESS OF XCTL ROUTINE                * 06000010
*        BR    14   EXIT TO XCTL                                      * 06200010
*                                                                     * 06400010
*EXITS-ERROR -- R1 POINTS TO I/O SUPERVISOR BLOCK                Y02027 06600010
*        SVC   15   'EXCEPTIONAL CONDITION(IOSEX)'. RETURN TO    Y02027 06700010
*                   LINE END APPENDAGE. ERROR PERMANENT.         Y02027 06800010
*        SVC   3                                                      * 07000010
*                                                                     * 07200010
*        L     13,DECIMAL VALUE OF NEXT LOAD                          * 07400010
*        L     14,X'10'   CVT ADDRESS                           S21903* 07600010
*        L     14,X'2C'(14)    ADDRESS OF XCTL ROUTINE                * 07800010
*        BR    14   EXIT TO XCTL                                      * 08000010
*                                                                     * 08200010
*   TO SCHEDULE ERROR POST                                            * 08400010
*                                                                     * 08600010
*TABLES/WORK AREAS --                                                 * 08800010
*   TAVTD                                                             * 09000010
*   TTRMD                                                             * 09200010
*   TCCWD                                                             * 09400010
*   TLCBD                                                             * 09600010
*   DCBD                                                              * 09800010
*   TSCBD                                                             * 10000010
*   IECDIOSB                                                     Y02027 10100010
*                                                                     * 10200010
*ATTRIBUTES -- SERIALLY REUSABLE, REFRESHABLE, SUPERVISOR KEY,   Y02027 10400010
*              SUPERVISOR MODE, ENABLED                          Y02027 10500010
*                                                                     * 10600010
*NOTES -- THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A         * 10800010
*   PARTICULAR INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER      * 11000010
*   SET.                                                              * 11200010
*                                                                     * 11400010
*   R1 REMAINS TRANSPARENT TO ALL LOADS OF ERP.                       * 11600010
*                                                                     * 11800010
*   IF AN INTERMEDIATE ERP SEQUENCE ENDED IN ERROR, IT IS RETRIED     * 12000010
*   USING THE ERP RETRY COUNT IN LCBERRCT.                            * 12200010
*                                                                     * 12400010
*   IF THE ERROR IS CLEARED, EXIT IS MADE TO LINE END APPENDAGE.      * 12600010
*   IF THE ERROR IS PERMANENT, EXIT IS MADE TO IGE0504H.              * 12800010
*                                                                     * 13000010
*********************************************************************** 13200010
         EJECT                                                          13400010
         USING IEDQCCW,RCCW                                             13600010
         USING IEDQTRM,RTERM                                            13800010
         USING IEDQLCB,RLCB                                             14000010
         USING IHADCB,RDCB                                              14200010
         USING IEDQAVTD,RAVT                                            14400010
         USING IEDQSCB,RSCB                                             14600010
         USING IOSB,RIOSB                                        Y02027 14700010
         USING *,R15                                                    14800010
         SPACE 3                                                 S99244 14900010
*        R E G I S T E R S                                              15000010
R0       EQU   0                        WORK REGISTER                   15200010
RIOSB    EQU   1                        ADDR OF I/O SUPVR BLOCK  Y02027 15400010
RLCB     EQU   2                        LCB CBASE                       15600010
RCCW     EQU   5                        CCW BASE                        15800010
RSCB     EQU   3                        SCB BASE REGISTER        S21903 16000010
RDCB     EQU   4                        DCB BASE                        16200010
RWKA     EQU   6                        WORK REGISTER                   16400010
RWKB     EQU   7                        WORK REGISTER                   16600010
RTST     EQU   7                        ADDR OF REQUEST QUEUE    Y02027 16660010
*                                       ELEMENT                  Y02027 16720010
RTERM    EQU   8                        TERMINAL BASE                   16800010
RWKC     EQU   9                        WORK REGISTER                   17000010
RWKD     EQU   10                       WORK REGISTER                   17200010
RAVT     EQU   11                       AVT BASE                 S21903 17400010
RB       EQU   12                       WORK REGISTER                   17600010
RLINK    EQU   13                       LINKAGE FOR SUBSEQUENT LOAD     17800010
RSAVE    EQU   13                       SAVE REGISTER FOR IOSB   Y02027 17900010
RXCTL    EQU   14                       XCTL REGISTER                   18000010
R15      EQU   15                       ADDRESSABILITY REGISTER         18200010
THREE    EQU   3                        INVLIST OFFSET TO FLAGS  S99244 18206010
MASTER   EQU   X'20'                    CONTENTION FLAG IN INV   S99244 18212010
ACK0CH   EQU   4                        INDEX INTO SPECIAL CHARACTER    18218010
ACK0     EQU   X'41'                    ACK-0 FLAG FOR ACKRECEIVED      18224010
ACK1     EQU   X'42'                    ACK-0 FLAG FOR ACKRECEIVED      18230010
ACKI     EQU   X'40'                    ACK COUNTER MASK                18236010
RVICH    EQU   15                       INDEX INTO SCT SEQUENCE         18242010
NAKCH    EQU   6                        INDEX INTO SCT SEQUENCE         18248010
WACKCH   EQU   14                       INDEX INTO SCT SEQUENCE         18254010
REOT     EQU   X'04'                    MASK FOR EOT RECEIVED           18260010
RNAK     EQU   X'08'                    MASK FOR NAK RESPONSE    S21903 18266010
RWACK    EQU   X'10'                    RESPONSE RECEIVED               18272010
RRVI     EQU   X'20'                    RESPONSE RECEIVED               18278010
EOTCH    EQU   0                        INDEX TO SCT                    18284010
RETRY    EQU   6                        RETRY COUNT                     18290010
CVTPTR   EQU   X'10'                    POINTER TO CVT                  18296010
XCTLADD  EQU   X'2C'                    OFFSET IN CVT-XCTL ROUTINE      18302010
IOBOFFST EQU   4                        IOB OFFSET IN RQE               18308010
ERPCTL   EQU   X'20'                    ERP IN CONTROL BIT       S21903 18314010
EREXCP   EQU   15                       ERROR EXCP                      18320010
RETURN   EQU   3                        MASK FOR RETURN SVC             18326010
RENQ     EQU   X'80'                    ENQ WORK MASK                   18332010
RSKRET   EQU   X'2C'                                           @OS76482 18335010
ENQCH    EQU   7                        OFFSET INTO SCT                 18338010
XBF      EQU   X'BF'                    MASK FOR CHANNEL ERRORS  S21903 18344010
XF2      EQU   X'F2'                    MASK FOR DEVICE ERRORS          18350010
X24      EQU   X'24'                    MASK TO CLEAR ERROR FLAGS       18356010
UNEX     EQU   X'01'                    UNIT EXCEPTION MASK             18362010
POPERM   EQU   8                        504H RETURN INDICATOR    S21903 18368010
         EJECT                                                          18400010
         L     RTST,IOSUSE              PICKUP ADDR OF RQE       Y02027 18600010
         L     RLCB,IOBOFFST(,RTST)     ADDRESS OF IOB Z(LCB)           18800010
         SH    RLCB,LCBSIZE             ADJUST BASE                     19000010
         L     RSCB,LCBSCBA-1           SCB BASE                 S21903 19200010
         L     RDCB,LCBDCBPT            DCB BASE                        19400010
         L     RCCW,LCBCSW-1            FAILING CCW+8            S21903 19600010
         SH    RCCW,H8                  BACK UP TO FAILING CCW   S21903 19800010
         TM    LCBCSW+3,UNEX            UNIT EXCEPTION SET              19810010
         BZ    NOTUNEX                  NO                              19820010
         SPACE                                                          19830010
         CLI   CCWOPCDE,CCWWRITE        WRITE COMMAND                   19840010
         BNE   NOTUNEX                  NO                              19850010
         SPACE                                                          19860010
         ST    RLCB,LCBERCCW+16         FOR READ SKIP                   19870010
         MVI   LCBERCCW+16,CCWREAD      SET COMMAND CODE                19880010
         MVC   LCBERCCW+20(4),SKIP     SET FLAGS AND COUNT      SA63037 19890010
         LA    RWKA,LCBERCCW+16         FOR IOS START                   19900010
         ST    RWKA,LCBSTART-1          SET PARAMETER                   19910010
         BAL   RWKD,CHKCOUNT            CHECK ERROR COUNT               19920010
NOTUNEX  EQU   *                                                        19930010
         LA    RWKA,LCBERCCW            FOR POSSIBLE RESTART            19940010
         ST    RWKA,LCBSTART-1          SET FOR IOS                     19950010
         SR    RWKA,RWKA                CLEAR INDEX REGISTER            20000010
         IC    RWKA,LCBINCAM+1          RETURN INDICATOR                20200010
         B     TABLE1-4(RWKA)           USE BRANCH TABLE                20400010
TABLE1   EQU   *                                                        20600010
         B     LOSTRET                  LOSTDTA,OVERRUN, DATA CHECK     20800010
*                                         ON RESPONSE TO TEXT           21000010
         B     WRENQRET                 UX ON WRITE ENQ                 21200010
         B     UNEXRET                  UNEX WRITE RESPONSE             21400010
         B     WRRSPNQ                  UNEX WRITE RESPOSNE TO ENQ      21600010
         B     SKIPRET                  UX AN OTHER WRITES              21800010
         B     TORSPTXT                 TIME OUT RESPONSE TO TEXTS21903 22000010
         B     CMDRJRET                 CMD REJECT RESP. TO TEXT S21903 22200010
         B     TOWRITE                  TIME OUT ON WRITE               22400010
         B     BOXPRET                  BUSOUT TRANSPARENT TEXT         22600010
         B     RESETRET                 WR EOT AFTER PERM ERROR         22800010
*                                       IN READ RESPONSE CCW            23000010
         B     LDTEXT                   LOST DATA READ TEXT    @ZA05036 23200010
         EJECT                                                          23400010
LOSTRET  EQU   *                                                        23800010
*  THE ERP CCW SEQUENCE IS WRITE ENQ, TIC TO READ ESPONSE               24000010
         BAL   RWKD,ERRETRY             CHECK ERP CCW STATUS            24200010
         B     ERPCT                    BUILD WRITE EOT                 24400010
         BAL   RWKD,CHACK               CHECK RESPONSE                  24600010
         SPACE                                                          24800010
         CLI   LCBRCB,0                 ANY VALID RESPONSE              25000010
         BE    TESTCNT                  BRANCH NO                       25200010
         SPACE                                                          25400010
         B     CLEARED                  RESET RETRY COUNT               25600010
         SPACE 10                                                       25800010
LDTEXT   EQU   *                                                        26000010
ERPCT    EQU   *                                                        26200010
         MVI   LCBERRCT,0               CLEAR ERP ERROR COUNT  @OY10984 26400010
         SR    RWKA,RWKA                CLEAR FOR INSERT       @OY14057 26440010
         SR    RWKB,RWKB                CLEAR FOR INSERT       @OY14057 26640010
         L     RB,DCBSCTAD-ONE          GET SCT ADDRESS        @OY14057 26840010
         IC    RWKA,EOTCH(RB)           EOT SEQUENCE INDEX     @OY14057 27040010
         IC    RWKB,0(RWKA,RB)          GET COUNT              @OY14057 27240010
         LA    RWKA,ONE(RWKA,RB)        POINT TO SEQUENCE      @OY14057 27440010
         STM   RWKA,RWKB,LCBERCCW       SET DATA ADDR AND COUNT@OY14057 27640010
         MVI   LCBERCCW,CCWWRITE        WRITE COMMAND CODE     @OY10984 27920010
         LA    RWKA,LCBERCCW            START ADDRESS          @OY10984 27960010
         MVI   LCBINCAM+1,40            SET 404H RETURN                 28200010
         B     COMEXIT                  RESTART                         28400010
         SPACE 2                                                        28600010
         SPACE 3                                                        28800010
WRENQRET EQU   *                                                        29000010
         BAL   RWKD,ERRETRY             CHECK ERROR RETRY COUNT         29200010
         B     PERMEXIT                 EXIT                            29400010
         BAL   RWKD,CHACK               CHECK IF ENQ RECEIVED           29600010
         TM    LCBRCB,RENQ              ENQ RECEIVED             S21903 29800010
         BZ    BACKUP                   NO, RETRY WRITE ENQ             30000010
         SPACE                                                          30200010
         TM    LCBSTAT2,LCBDIAL         DIAL LINE                S99244 30400010
         BO    BACKUP                   YES, RETRY WRITE ENQ     S99244 30420010
         SR    RWKA,RWKA                CLEAR FOR INDEXING       S99244 30440010
         IC    RWKA,LCBUCBX             GET RELATIVE LINE NO     S99244 30460010
         SLL   RWKA,2                   MULTIPLY BY FOUR         S99244 30480010
         L     RWKA,DCBINVLI(RWKA)      INVITATION LIST ADDR     S99244 30500010
         TM    THREE(RWKA),MASTER       MASTER SPECIFIED         S99244 30520010
         BO    BACKUP                   YES, BR TO TREAT AS SUCH S99244 30540010
*        CONTENTION EXISTS. THE FOLLOWING CODE WILL RESCHEDULE   S99244 30560010
*        THIS SEND OPERATION AFTER A RECEIVE OPERATION IS DONE   S99244 30580010
         MVC   LCBCSW,LCBCSWSV          RESTORE ORIGINAL CSW            30600010
         NC    LCBTTCIN,LCBTTCIN        IS DESTINATION DETERMND@OX17153 30800010
         BZ    NOLMT                    NO, NOT BUFFER BUSY    @OX17153 30810010
         LH    RWKC,LCBTTCIN            TERMINAL OFFSET        @OX17153 30820010
         LA    RWKB,AVTRNMPT            TNT CODE BASE          @OX17153 30830010
         USING IEDQTNTD,RWKB                                   @OX17153 30880010
         BAL   RWKA,TNTDCODE            FIND TERMINAL TYPE     @OX17153 30890010
         USING IEDQTRM,RTERM                                   @OX17153 30900010
         L     RTERM,TRMDESTQ-1         GET QCB ASSRESS        @OX17153 30910010
         USING IEDQQCB,RTERM                                   @OX17153 30960010
         OI    QCBELCHN+2,QCBCNTEN      SET FLAG FOR LINEEND TO@OX17153 30970010
*                                         CLEANUP LCB AND SCHED@OX17153 30980010
*                                         TO INITIATE A RECEIVE@OX17153 30990010
*                                         OPERATION            @OX17153 31040010
         DROP  RTERM,RWKB                                      @OX17153 31060010
NOLMT    EQU   *                                               @OX17153 31080010
         NI    IOSFLA,X'FF'-(IOSERR+IOSEX) RESET ERP IN CNTRL    Y02027 31120010
         B     SETERR                   BRANCH TO INDICATE       X01004 31320010
*                                       SELECTION ERROR.         X01004 31520010
         SPACE 10                                                       31800010
TORSPTXT EQU   *                                                        32000010
         BAL   RWKD,ERRETRY             CHECK ERROR  ON ERP CCW         32200010
         B     ERPCT                    WRITE EOT                       32400010
         BAL   RWKD,CHACK               CHECK RESPONSE RECEIVED  S21903 32600010
         MVC   LCBPRI,LCBMSGFM          SAVE ACK COUNTER         S21903 32800010
         XI    LCBPRI,ACKI              FLIP ACK COUNTER                33000010
         TM    LCBPRI,ACKI              TEST ACK EXPECTED        S21903 33200010
         BZ    ITSACK1                  BRANCH ACK 1 EXPECTED           33400010
         TM    LCBRCB,ACK0              SET ACK0 CONDITION CODE         33600010
TESTACK  EQU   *                                                        33800010
         BO    CLEARED                  RESET RETRY COUNT               34000010
         BZ    TSTRVI                   CHECK OTHER POSSIBLE RESP       34200010
         SPACE                                                          34400010
         CLI   LCBRESTR,TPRDRSPD        RESPONSE TO ADDRESSING          34430010
         BE    BACKUP                   BRANCH IF YES                   34460010
         CLI   LCBINCAM,RETRY           RETRY LIMIT REACHED             34490010
         BNL   ERPCT                    BRANCH IF YES                   34520010
         MVI   LCBINCAM+1,0             RESET RETURN INDICATOR          34550010
         NI    IOSFLA,AVTEFF-IOSERR     POST PERMANENT ERROR     Y02027 34600010
         MVC   LCBCSW,LCBCSWSV          RESTORE ORIG CCW       @OY15006 34602010
         MVC   LCBSENS0,LCBSNSV         RESTORE ORIG SENSE     @OY15006 34603010
SETERR   EQU   *                                                 X01004 34604010
*                                       TO ABNORMAL END APPENDAG Y02027 34608010
*********************************************************************** 34612010
*                                                                     * 34616010
*        THE FOLLOWING CODE IS ADDED FOR AOS.                         * 34620010
*                                                                     * 34624010
CONVERT  EQU   *                                                 X01004 34628010
         CLI   LCBECBCC,HIOCC           IOHALT ISSUED            Y02027 34632010
         BNE   SVCS                     BRANCH NO                Y02027 34636010
         SPACE 1                                                 Y02027 34640010
         NI    IOSFLA,X'FF'-(IOSERR+IOSEX) RESET ERP IN CTL      Y02027 34644010
         MVI   LCBINCAM+1,HIOCC         SET FOR LINEEND          Y02027 34648010
SVCS     EQU   *                                                 Y02027 34652010
**************************************************************** Y02027 34656010
*        THE FOLLOWING CODE MAPS THE NECESSARY FIELDS FROM THE   Y02027 34660010
*        LINE CONTROL BLOCK TO THE I/O SUPERVISOR BLOCK FOR EXCP Y02027 34664010
*        COMPATABILITY DURING RETRY OPERATIONS FROM ERP          Y02027 34668010
**************************************************************** Y02027 34672010
         MVC   IOSCSW(SEVEN),LCBCSW     MAP CSW FROM LCB TO IOSB Y02027 34676010
         MVC   IOSSNS(TWO),LCBSENS0     MAP SENSE INFO FROM LCB  Y02027 34680010
*                                       INTO IOSB                Y02027 34684010
         MVC   IOSCC(ONE),LCBSIOCC      MAP START I/O CONDITION  Y02027 34688010
*                                       CODE FROM LCB TO IOSB    Y02027 34692010
         TM    IOSFLA,IOSERR+IOSEX      ARE WE DOING A RETRY     Y02027 34696010
         BNO   NOTRETRY                 BRANCH IF NO.            X01004 34700010
         MVI   LCBSENS0,AVTEZERO        CLEAR SENSE BYTE       @XA08979 34701010
         MVI   IOSSNS,AVTEZERO          CLEAR IOSB SENSE       @XA08979 34702010
         LR    RSAVE,RIOSB              SAVE IOSB ADDRESS        Y02027 34704010
         L     RTST,IOSUSE              PICKUP ADDR OF RQE       Y02027 34708010
         L     RLCB,IOBOFFST(,RTST)     GET IOB ADDRESS FROM RQE X01004 34712010
*                                       FOR USE BY SIO APPENDAGE X01004 34716010
         L     RTERM,DEBPTR(,RTST)      GET DEB ADDRESS FROM RQE X01004 34720010
         LA    R15,DEBNMSUB-IEDQDEB     GET APDG. TABLE SIZE     Y02027 34724010
         SLR   RTERM,R15                POINT TO APDG. TABLE     Y02027 34728010
         L     RTERM,SIOPTR(ZERO,RTERM)  GET ADDR OF SIO APDG.   X01004 34732010
*                                       FROM APDG. VECTOR TABLE. X01004 34736010
         SR    R15,R15                  CLEAR R15 TO TELL SIO    X01004 34740010
*                                       APDG. IT'S A SUBROUTINE. X01004 34744010
         BAL   RXCTL,SIOENTRY(ZERO,RTERM)  LNK TO SIO APDG AT    X01004 34748010
*                                       OFFSET +16 TO CONVERT    X01004 34752010
*                                       CCW'S TO REAL.           X01004 34756010
         LR    RIOSB,RSAVE              RESTORE IOSB ADDR        Y02027 34760010
*                                                                     * 34764010
*        END OF CODE ADDED FOR AOS.                                   * 34768010
*                                                                     * 34772010
*********************************************************************** 34776010
NOTRETRY EQU   *                                                 X01004 34780010
         SVC   EREXCP                                                   34800010
         SVC   RETURN                                                   35000010
ITSACK1  EQU   *                                                        35200010
         TM    LCBRCB,ACK1              SET ACK1 CONDITION CODE         35400010
         B     TESTACK                  USE COMMON BRANCHES             35600010
TSTRVI   EQU   *                                                        35800010
         TM    LCBRCB,RRVI+RNAK+RWACK+REOT VALID RESPONSE               36000010
         BNZ   ERRCLEAR                 YES                             36200010
TESTCNT  EQU   *                                                        36400010
         CLI   LCBERRCT,RETRY           ERP RETRY COUNT                 36600010
         BL    BUMPIT                   TRY AGAIN                       36800010
         SPACE                                                          37000010
         B     ERPCT                    RESET THE LINE                  37200010
         SPACE 10                                                       37400010
RESETRET EQU   *                                                        37600010
TOWRITE  EQU   *                                                        37700010
CMDRJRET EQU   *                                                        37800010
         NI    SCBBSCFM,AVTEFF-SCBNOEOT RESET BSC DIAL SEND PRI  S21101 37850010
*                                         FLAG WHICH INDICATES THS21101 37900010
*                                         NO EOT WAS SENT        S21101 37950010
         OI    LCBCHAIN,LCBNORTY        SET NO RETRY                    38000010
         BAL   RWKD,ERRETRY             CHECK STATUS ON ERP CCW         38200010
         B     PERMEXIT                 NORMAL RETURN                   38400010
         B     PERMEXIT                 EXIT                            38600010
         SPACE 10                                                       38800010
WRRSPNQ  EQU   *                                                        39000010
UNEXRET  EQU   *                                                        39200010
         MVI   LCBERRCT,AVTEZERO        CLEAR ERP RETRY COUNTER         39400010
SKIPRET  EQU   *                                                        39600010
BACKUP   EQU   *                                                        39800010
         L     RWKA,LCBCSWSV-1          ORIGINAL FAILING CCW     S21903 40000010
         SH    RWKA,H8                  BACK UP TO WRITE RESPONSE       40200010
         CLI   LCBRESTR,TPRDRSPD        RESPONSE TO ADDRESSING?@OS76308 40280010
         BNE   NOTADDR                  NO, LEAVE AS IS        @OS76308 40360010
         SH    RWKA,H8                  BACK UP TO WRITE ADDR  @OS76308 40440010
NOTADDR  EQU   *                                               @OS76308 40520010
         MVI   LCBINCAM+1,0             RESET RETURN FIELD       S21903 40600010
         MVI   LCBERRCT,0               RESET ERP RETRY COUNT           40800010
         CLI   LCBINCAM,RETRY           RETRY LIMIT REACHED             41000010
         BNL   PERMEXIT                 YES                             41200010
         IC    RWKB,LCBINCAM            GET CURRENT COUNT               41400010
         LA    RWKB,1(,RWKB)            BUMP                            41600010
         STC   RWKB,LCBINCAM            SET BACK                        41800010
COMEXIT  EQU   *                                                        42000010
         ST    RWKA,LCBSTART-1          RESTART POINT                   42200010
         B     CONVERT                  BRANCH TO SET UP RETRY.  X01004 42400010
         SPACE 10                                                       43000010
BOXPRET  EQU   *                                                        43200010
         MVI   LCBCSWSV+3,X'0C'         SET NORMAL ENDING               43400010
         MVC   LCBCSW,LCBCSWSV          RESET 'CURRENT' CSW             43600010
         B     ERRCLEAR                 EXIT TO APPENDAGE               43800010
         SPACE 10                                                       44000010
ERRETRY  EQU   *                                                        44200010
         TM    LCBCSW+4,XBF             CHANNEL ERRORS                  44400010
         BNZ   CHKCOUNT                 BRANCH IF ERRORS         S21903 44600010
         SPACE                                                          44800010
         TM    LCBCSW+3,XF2             DEVICE ERRORS                   45000010
         BC    8,4(RWKD)                BRANCH YES                      45200010
CHKCOUNT EQU   *                                                        45400010
         CLI   LCBERRCT,RETRY           ERP RETRY COUNT                 45600010
         BCR   11,RWKD                  YES                             45800010
BUMPIT   EQU   *                                                        46000010
         L     RWKA,LCBSTART-1          GET CCW ADDRESS        @OS76482 46030010
         TM    CCWFLAGS-IEDQCCW(RWKA),CCWSKIP IS SKIP FLAG ON  @OS76482 46060010
         BZ    OUT                      BRANCH NO              @OS76482 46090010
         MVI   LCBINCAM+1,RSKRET        ABORT AFTER READ SKIP  @OS76482 46120010
OUT      EQU   *                                               @OS76482 46150010
         IC    RWKA,LCBERRCT            ERP RETRY COUNT          S21903 46200010
         LA    RWKA,1(,RWKA)            BUMP                            46400010
         STC   RWKA,LCBERRCT            SET BACK                        46600010
         B     CONVERT                  BRANCH TO SET UP RETRY.  X01004 46800010
         SPACE 2                                                        47600010
PERMEXIT EQU   *                                                        48200010
         MVC   LCBCSW,LCBCSWSV          RESTORE ORIGINAL CSW     S21903 48400010
         MVC   LCBSENS0,LCBSNSV         ORIGINAL SENSE                  48600010
         MVI   LCBINCAM+1,POPERM        504H RETURN                     48800010
         LH    RLINK,POSTMOD            504H ID                         49000010
         L     RXCTL,CVTPTR             PICKUP CVT ADDRESS       Y02027 49200010
         L     RXCTL,XCTLADD(,RXCTL)    XCTL ADDRESS                    49400010
         BR    RXCTL                    CALL ROUTINE                    49600010
         SPACE 2                                                        49800010
         EJECT                                                          50000010
CHACK    EQU   *                                                        50200010
         TM    CCWOPCDE,CCWTIC          IS IT A TIC            @SA69101 50240010
         BNO   CHACK1                   NO, BRANCH             @SA69101 50280010
         SH    RCCW,H8                  BACK-UP TO FAILING CCW @SA69101 50320010
CHACK1   EQU   *                                               @SA69101 50360010
         LH    RWKA,CCWCOUNT            ORIGINAL COUNT           S21903 50400010
         SH    RWKA,LCBCSW+5            SUBTRACT RESIDUAL COUNT         50600010
         BZ    NOCHACK                  IS RESIDUAL EQ TO ORIG @SA74968 50660010
*                                       BRANCH YES             @SA74968 50720010
         BCTR  RWKA,0                   DECREMENT                       50800010
         BCTR  RWKA,0                   NOW TWO                         51000010
         L     RWKC,CCWADDR-1           DATA ADDRESS                    51200010
         AR    RWKC,RWKA                POINT TO 2 CHAR RESPONSE S21903 51400010
         SR    RWKA,RWKA                CLEAR FOR INDEXING              51600010
         L     RWKB,DCBSCTAD-1          SCT ADDRESS                     51800010
         IC    RWKA,ACK0CH(,RWKB)       INDEX TO SEQUENCE               52000010
         LA    RB,1(RWKA,RWKB)          BUMP TO SEQUENCE                52200010
         MVI   LCBRCB,ACK0              ASSUMED ACK0 RECEIVED           52400010
         CLC   0(2,RWKC),0(RB)          TEST FOR SEQUENCE               52600010
         BCR   8,RWKD                   RETURN                          52800010
         SPACE                                                          53000010
         LA    RB,3(,RB)                BUMP TO ACK-1 SEQUENCE          53200010
         MVI   LCBRCB,ACK1              ASSUME ACK-1 RECEIVED           53400010
         CLC   0(2,RWKC),0(RB)          TEST FOR ACK-1                  53600010
         BCR   8,RWKD                   BRANCH YES                      53800010
         IC    RWKA,ENQCH(,RWKB)        INDEX TO SEQUENCE               54000010
         LA    RB,1(RWKA,RWKB)          BUMP TO ENQ                     54200010
         MVI   LCBRCB,RENQ              ASSUME ENQ RECEIVED             54400010
         CLC   1(1,RWKC),0(RB)          ENQ RECEIVED                    54600010
         BCR   8,RWKD                   RETURN                          54800010
         IC    RWKA,NAKCH(,RWKB)        INDEX\3 >)1+)(")                55000010
         LA    RB,1(RWKA,RWKB)          POINT TO SEQUENCE        S21903 55200010
         MVI   LCBRCB,RNAK              ASSUME NAK                      55400010
         CLC   1(1,RWKC),0(RB)          NAK RECEIVED                    55600010
         BCR   8,RWKD                   YES                             55800010
         IC    RWKA,WACKCH(,RWKB)       INDEX TO WACK                   56000010
         LA    RB,1(RWKA,RWKB)          POINT TO SEQUENCE        S21903 56200010
         MVI   LCBRCB,RWACK             SET RESPONSE                    56400010
         CLC   0(2,RWKC),0(RB)          THIS THE RESPONSE        S21903 56600010
         BCR   8,RWKD                   YES                             56800010
         IC    RWKA,RVICH(,RWKB)        INDEX TO RVI                    57000010
         LA    RB,1(RWKA,RWKB)          POINT TO SEQUENCE        S21903 57200010
         MVI   LCBRCB,RRVI              ASSUME RVI                      57400010
         CLC   0(2,RWKC),0(RB)          THIS THE RESPONSE        S21903 57600010
         BCR   8,RWKD                   YES                             57800010
         IC    RWKA,EOTCH(,RWKB)        EOT INDEX                S21903 58000010
         LA    RB,1(RWKA,RWKB)          POINT TO SEQUENCE               58200010
         CLC   1(1,RWKC),0(RB)          EOT RECEIVED                    58400010
         MVI   LCBRCB,REOT              ASSUME EOT RECEIVED      S21903 58600010
         BCR   8,RWKD                   BRANCH IF EOT                   58800010
NOCHACK  EQU   *                                               @SA74968 58900010
         SPACE                                                          59000010
         MVI   LCBRCB,0                 INVALID RESPONSE                59200010
         BR    RWKD                     RETURN                          59400010
CLEARED  EQU   *                                                        59460010
         MVI   LCBINCAM,0               RESET RETRY COUNT               59520010
         EJECT                                                          59600010
ERRCLEAR EQU   *                                                        59800010
         NI    IOSFLA,AVTEFF-(IOSERR+IOSEX) SET NORMAL ENDING    Y02027 60000010
*                                       STATUS                   Y02027 60100010
         MVI   LCBINCAM+1,0             RESET RETURN INDICATOR   S21903 60200010
         B     CONVERT                  BRANCH TO SET UP RETRY.  X01004 82000010
         EJECT                                                          82600010
H8       DC    H'8'                     CONSTANT                 S21903 83200010
SKIP     DC    AL1(CCWSKIP),X'00FFFF'   CONSTANT                 S21903 83300010
LCBSIZE  DC    AL2(LCBFLAG1-IEDQLCB)    CONSTANT                 S21903 83800010
POSTMOD  DC    AL2(5048)                POST MODULE ID                  84000010
DEBPTR   EQU   8                        OFFSET OF DEB ADDR. IN   X01004 84600010
*                                       RQE.                     X01004 85200010
SIOPTR   EQU   4                        OFFSET OF SIO APDG. ADDR X01004 87000010
*                                       IN APDG. VECTOR TABLE.   X01004 87600010
SIOENTRY EQU   34                       OFFSET OF SUBRTNE. ENTRY Y02027 88200010
*                                       ENTRY POINT IN SIO APDG. X01004 88800010
ZERO     EQU   0                        LENGTH                          89400010
FOUR     EQU   4                        EQUATES                         90000010
SEVEN    EQU   7                        FOR                             90600010
TWENTY   EQU   20                       ADDRESSING                      91200010
ONE      EQU   1                         EQUATE OF 1             Y02027 91800010
TWO      EQU   2                         EQUATE OF 2             Y02027 92400010
HIOCC    EQU   X'48'                    HALT I/O COMPLETION      Y02027 93000010
         EJECT                                                          93500010
         TDEBD                          DEB DSECT                Y02027 94000010
         EJECT                                                          94600010
         TTRMD                                                          95000010
         TTPD                                                           95100010
         TCCWD                                                          95200010
         TLCBD                                                          95400010
         DCBD  DSORG=TX                                                 95600010
         TSCBD                                                          95800010
         TQCBD                                                 @OX17153 95850010
         TTNTD                                                 @OX17153 95900010
         TAVTD                                                          96000010
         IECDIOSB                                                Y02027 96200010
   END                                                                  96400010
