         TITLE 'IGE0904B - BTAM ERP TRANSLATE MODULE'                   00600002
IGE0904B CSECT                                                          00650002
*********************************************************************** 00700002
*                                                                     * 00750002
* MODULE NAME:                                                        * 00800002
*    IGE0904B                                                         * 00850002
*                                                                     * 00900002
* DESCRIPTIVE NAME:                                                   * 00950002
*    BTAM ERROR RECOVERY TRANSLATE PROCEDURE                          * 01000002
*                                                                     * 01050002
* COPYRIGHT:                                                          * 01100002
*    NONE                                                             * 01150002
*                                                                     * 01200002
* STATUS:                                                             * 01250002
*    CHANGE LEVEL 001                                                 * 01300002
*                                                                     * 01350002
* FUNCTION:                                                           * 01400002
*    MAKE CORRESPONDING CHANGES TO REAL CCWS AFTER VIRTUAL ONES       * 01450002
*    HAVE BEEN ALTERED.                                               * 01500002
*                                                                     * 01550002
* NOTES:                                                              * 01600002
*    DEPENDENCIES:                                                    * 01650002
*        NONE                                                         * 01700002
*    RESTRICTIONS:                                                    * 01750002
*        THIS ERP IS ONLY FOR DEVICES SUPPORTED BY BTAM.              * 01800002
*    REGISTER CONVENTIONS:                                            * 01850002
*        SEE 'REGISTER DEFINITION' BELOW                              * 01900002
*                                                                     * 01950002
* PATCHLABEL:                                                         * 02000002
*    PACHAREA                                                         * 02050000
*                                                                     * 02100002
* MODULE TYPE:                                                        * 02150002
*    PROCEDURE                                                        * 02200002
*    PROCESSOR:                                                       * 02250002
*        BAL                                                          * 02300002
*    ATTRIBUTES:                                                      * 02450002
*        REENTRANT, ENABLED, KEY 0, SUPERVISOR STATE, LOCAL LOCKS     * 02500002
*        HELD AROUND TRANSLATOR CALLS                                 * 02550002
*                                                                     * 02600002
* ENTRY POINT:                                                        * 02650002
*    IGE0904B                                                         * 02700002
*    PURPOSE:                                                         * 02750002
*        SEE 'FUNCTION'                                               * 02800002
*    LINKAGE:                                                         * 02850002
*        THIS MODULE IS SCHEDULED FOR EXECUTION BY THE INPUT/OUTPUT   * 02900002
*        SUPERVISOR. IT RUNS UNDER AN SIRB.                           * 02950002
*    INPUT:                                                           * 03000002
*        REG 1 = ADDRESS OF IOSB                                      * 03050002
*    OUTPUT:                                                          * 03100002
*        REAL CHANNEL PROGRAM FOR RETRY.                              * 03150000
*                                                                     * 03200002
* EXITS-NORMAL:                                                       * 03250002
*    SUPERVISOR VIA SVC 3                                             * 03300002
*    LINKAGE TO TP RECORDER (IGE0625F)                                * 03302000
*    LINKAGE TO STAT. UPDATE ROUTINE (IGE0025D)                       * 03304000
*    LINKAGE TO WTO ROUTINE (IGE0025C)                                * 03306000
*                                                                     * 03350002
* EXITS-ERROR:                                                        * 03400002
*    NONE                                                             * 03450002
*                                                                     * 03500002
* EXTERNAL REFERENCES:                                                * 03550002
*    ROUTINES:                                                        * 03600002
*        ESTAE                                                        * 03650002
*        SETLOCK                                                      * 03700002
*        SETRP                                                        * 03750002
*        GETMAIN                                                      * 03800002
*        FREEMAIN                                                     * 03850002
*        SVC 15 ERROR EXCP                                            * 03900002
*        IOS CCW TRANSLATOR                                           * 03950002
*    DATA AREAS                                                       * 04000002
*        IOB (MAPPED BY IEZIOB)                                       * 04050002
*        ERP WORKAREA (MAPPED BY IECDERWA)                            * 04100002
*    CONTROL BLOCKS                                                   * 04150002
*        IOSB         (MAPPED BY IECDIOSB)                            * 04200002
*        CVT          (MAPPED BY CVT)                                 * 04250002
*        IOB          (MAPPED BY IEZIOB)                              * 04300002
*        RQE          (MAPPED BY IECDRQE)                             * 04350002
*        TCCW         (MAPPED BY IECDTCCW)                            * 04400002
*        SDWA         (MAPPED BY IHASDWA)                             * 04450002
*                                                                     * 04500002
* TABLES-WORKAREAS:                                                   * 04550002
*    ERP WORKAREA                                                     * 04600002
*    IOB CHANNEL PROGRAM AREA IN IOB BTAM EXTENSION                   * 04650002
*    ERP EXTENSION TO IOB                                             * 04660000
*                                                                     * 04700002
* MACROS:                                                             * 04750002
*    FREEMAIN                                                         * 04800002
*    GETMAIN                                                          * 04850002
*    ESATE                                                            * 04900002
*    SETLOCK                                                          * 04950002
*    SETRP                                                            * 05000002
*                                                                     * 05050002
* CHANGE ACTIVITY:                                                    * 05100002
*    YM02595K (9/20/73)                                               * 05150002
*    YM02594K (9/24/73)   (COMPLETE REWRITE)                          * 05200002
*    YM04094K (11/9/73)                                               * 05210002
*    YM05673K (1/7/74)                                                * 05220002
*    YM05652K (1/25/74)                                               * 05230002
*    YM05680K (1/25/74)                                               * 05240002
*    YM05697K (2/12/74)                                               * 05242000
*    YM07715K (4/10/74)                                               * 05244000
*    ZA03207 (03/24/75)                                               * 05246003
*    ZA04156 (04/29/75)          AZ04166 (08/25/75)                   * 05248003
*    AZ04853 (08/27/75)          AZ04874 (09/23/75)                     05248403
*    AZ07662 (11/25/75)          AZ07668 (01/23/76)                   * 05248803
*    AZ08475 (01/14/76)          AZ08084 (06/21/76)                     05249203
*    AZ12160  (08/06/76)         AZ13203 (09/08/76)                   * 05249600
*    AZ14034  (09/14/76)         AZ14061 (10/11/76)                   * 05250000
*    AZ14136  (10/26/76)         AZ15404 (11/23/76)                   * 05270000
*    AZ17698  (04/04/77)         AZ20113 (09/14/77)                   * 05275000
*********************************************************************** 05300002
         EJECT                                                          05350002
         USING *,BASEREG                                                05400002
         LR    BASEREG,ERREG5      BASE MODULE                          05450002
         USING RQE,RQEREG                                               05500002
         USING IOSB,IOSBREG                                             05550002
         USING IOBSTDRD,IOBRG                                           05600002
         USING EWA,EWAREG                                               05650002
         B     BEGIN               BRANCH AROUND ID            @ZA12160 05651000
         DC    C'IGE0904B'         MODULE ID                   @ZA12160 05652000
         DC    CL8'&SYSDATE'       ASSEMBLY DATE               @ZA12160 05653000
         DC    C'UZ14366'                                      @ZA20133 05654000
         DS    0H                                              @ZA12160 05655000
BEGIN    LR    IOSBREG,PARMREG     BASE IOSB                   @ZA12160 05658000
         L     RQEREG,IOSUSE       BASE RQE                             05750002
         L     EWAREG,IOSERP       BASE ERP WORK AREA                   05800002
         L     IOBRG,RQEIOB        BASE IOB                             05850002
         LA    IOBRG,ZERO(IOBRG) CLEAR HI ORDER BYTE           @ZA03207 05860003
         MVC   EWAIEXIT(L16),EXITADDR   MOVE ESTAE LIST TO ERP WA       05900002
         LA    PARMREG,EWAIEXIT    POINT TO ESTAE LIST                  05950002
*            ONE LINE REMOVED BY------------------------------>@ZA15404 06000000
         MVI   IOBSENS1,ZERO       CLEAR UNUSED SENSE BYTE     YM04094K 06010002
         MVC   IOSSNS(L2),IOBSENS0   MOVE SENSE TO IOSB                 06050002
*                                                                       06100002
*                                  THE FOLLOWING MOVE IS FOR THE WHOLE  06150002
*                                  CSW IN AN ATTEMPT TO FAKE EXCP       06200002
*                                  COMPATIBILITY INTERFACE IOB MAPPING  06250002
*                                  ON FINAL EXIT TO APPENDAGE. THIS     06300002
*                                  WILL HAVE TO BE CHANGED WHEN EXCP    06350002
*                                  STARTS TO VALIDITY CHECK THE CSW     06400002
*                                  CONTENTS.                            06450002
*                                                                       06500002
         MVC   IOSCSW(L7),IOBIOCSW   MOVE CSW COMPLETELY                06600002
START    EQU   *                                                        06650002
         L     ERREG1,RQEUCB       SET UP UCB ADDRESSABILITY   @ZA08084 06650303
         TM    L19(ERREG1),NINETY  BISYNC DEVICE               @ZA08084 06650603
         BO    START1              YES,CHECK V=R               @ZA08084 06650903
         L     ERREG1,IOBECBPT     SET UP DECB ADDRESSABILITY  @ZA08084 06651203
         CLI   L5(ERREG1),READTI   IS THIS A READ INITIAL      @ZA08084 06651503
         BE    START0              BRANCH, YES                 @ZA20113 06651600
         CLI   L5(ERREG1),READTIR  IS THIS READ TIR            @ZA20113 06651700
         BNE   START1              NO,CHECK V=R                @ZA08084 06651803
START0   L     ERREG1,IOBSTART     GET CCW START ADDRESS PTR   @ZA20113 06652100
         CLI   L16(ERREG1),L8      IS THIS A TIC               @ZA08084 06652403
         BNE   START1              NO,CHECK V=R                @ZA08084 06652703
         CLI   L22(ERREG1),L2      SPEC. ERROR COUNT=02        @ZA08084 06653003
         BE    START1              YES,CHECK V=R               @ZA08084 06653303
         CLI   L22(ERREG1),ZERO    SPEC. ERROR COUNT=0         @ZA08084 06653603
         MVI   L22(ERREG1),L1      SET TO 1                    @ZA08084 06653903
         BE    EXCPCOND            YES,CHECK FOR EXCP. COND.   @ZA08084 06654203
         MVI   L22(ERREG1),L2      SET TO 2                    @ZA08084 06654503
EXCPCOND TM    IOBFLAG1,L4         EXCEPTIONAL CONDITION ON    @ZA08084 06654803
         BNO   START1              NO,CHECK V=R                @ZA08084 06655103
         TM    IOBFLAG1,L2         ERP IN CONTROL              @ZA08084 06655403
         BNO   START1              NO,CHECK V=R                @ZA08084 06655703
         CLI   EWAIND1,EWAIWTOL    WTO BIT ON                  @ZA08084 06656003
         BE    START1              YES,CHECK V=R               @ZA08084 06656303
         NI    IOSFLA,L255-IOSEX-IOSERR  SET NORM COMP IN IOSB @ZA08084 06656603
         NI    IOBFLAG1,L255-IOSEX-IOSERR  ALSO IN IOB         @ZA08084 06656903
         MVI   IOBWORK+L1,SPMBFLAG SET SPEC FLAG FOR MB        @ZA08084 06657203
         MVI   EWAIND1,EWAISVCF    SET UP FOR SVC 15           @ZA08084 06657503
START1   TM    RQETYPE,RQE1TO1        DOES V EQUAL R ?         @ZA08084 06660003
         BO    RESET1                 YES SKIP TRANSLATION     @ZA04166 06670003
         TM    IOBFLAG1,IOBERRTN+IOBIOERR   IS THIS A RETRY SITUATION   06700002
         BO    RETRY               YES                                  06750002
         TM    EWAIND0,EWAIPMAP    ANY PARALLEL MAPPING DONE            06800002
         BNO   RESET               NO                                   06850002
         L     PARMREG,EWAITCCW    ADDR OF TCCW             L5 @ZA04156 06900003
         BAL   ERREG7,CHANGE1      DO THE UNFIX             L5 @ZA04156 06940003
RESET    EQU   *                                                        07800002
         BAL   ERREG1,ERPEXT  GET ADDR OF CURR EXT ENTRY    L5 @ZA04156 07857003
         CLC   ZERO(L4,ERRETR),FULL0  ENTRY EXIST?          L5 @ZA04156 07864003
         BE    RESET1                 NO,NOTHING TO UNFIX   L5 @ZA04156 07871003
         L     PARMREG,ZERO(ERRETR)   ADDR OF TCCW          L5 @ZA04156 07878003
         BAL   ERREG7,CHANGE1         UNFIX IT              L5 @ZA04156 07885003
RESET1   EQU   *                                            L5 @ZA04156 07892003
*        ONE LINE OF CODE DELETED BY APAR ---------->          @ZA07668 07892600
         L     ERREG4,IOBSTART     GET RESTART CCW ADDRESS     @ZA13203 07892700
         TM    IOBFLAG1,IOBERRTN+IOBIOERR  RETRY SITUATION?    @ZA13203 07892800
         BO    STOREIT                     YES                 @ZA13203 07892900
         XC    EWAITCCW(L4),EWAITCCW CLEAR OUR TCCW ADDRESS    @ZA13203 07893000
         L     ERREG4,EWAIOVST     GET ORIGINAL IOSVST                  07900002
STOREIT  ST    ERREG4,IOSVST       UPDATE IOSVST FIELD         @ZA13203 07950000
         LRA   ERREG4,ZERO(ERREG4)   GET REAL EQUIVALENT                08000002
         ST    ERREG4,IOSRST       UPDATE IOSRST FIELD                  08050000
CLEANUP  EQU   *                                                        08100002
*              ONE LINE REMOVED BY---------------------------->@ZA15404 08150000
         LR    PARMREG,IOSBREG     RESTORE IOSB AS PARAMETER            08200002
*                                                                       08250002
*                                  EXIT TO IOS WTO MUST BE MADE BEFORE  08300002
*                                  EXIT TO STAT UPDATE. WTO GOES TO     08350002
*                                  STAT UPDATE, BUT STAT UPDATE DOES    08400002
*                                  NOT GO TO WTO.                       08450002
*                                  ERROR LOAD 15 IS AN IOS MODULE.      08500002
*                                  EXIT TO IGE0004C MUST BE MADE AS     08550002
*                                  IF A NEW ENTRY CONDITION BUT         08600002
*                                  MUST BE SELF CONTAINED.              08650002
*                                                                       08700002
*                                  PREPARE FOR POSSIBLE OPERATOR MSG    08702002
         OI    EWAFLG1,EWADDMSG    TP SIZED MESSAGE                     08710002
         CLI   EWAIND1,EWAILD15   EXIT TO LOAD 15 TP RECORDER  @ZA14136 08713000
         BE    EXIT15              YES                         @ZA14136 08716000
         MVC   EWAITRAN(L2),IOBSENS0   MOVE SENSE FOR MESSAGE  @ZA12160 08720000
         MVC   EWTCTID(L2),IOBRESTR+L2  MOVE TERM ID FOR MSG   @ZA08475 08730003
*        ONE LINE OF CODE DELETED BY APAR ------------------>  @ZA14034 08732000
         CLI   EWAIND1,EWAIWTOL    EXIT TO IOS WTO             YM05652K 08950002
         BE    WTOEXIT             YES                         YM05652K 09000002
         CLI   EWAIND1,EWAISTAT    EXIT TO STAT UPDATE         YM05652K 09050002
         BNE   IOSEXIT             NO, GO TO SVC 15 AND SVC 3  YM05652K 09100002
*                                  EWASTUP ALREADY SET BY OTHER LOADS   09150002
         LA    NAMEREG,STATUP      LOAD ROUTINE NAME                    09200002
         B     XCTLOUT             XCTL                        @ZA07662 09250003
EXIT15   EQU   *                                                        09300002
         MVI   EWAIND1,ZERO         RESET FLAG                 YM05652K 09350002
         OI    EWAFLG2,EWAMDR       MDR RECORDING REQUESTED    YM05673K 09360002
         NI    IOSFLB,L255-IOSLOG   NO OBR WANTED              YM05673K 09370002
         MVC   EWAIBUFF(L4),IOBERCCW   MOVE POINTER TO EWA     YM05673K 09380002
         LH    NAMEREG,ERLOD15     GET MODULE NAME                      09400002
         B     XCTLOUT             GO TO IT                    @ZA07662 09450003
WTOEXIT  EQU   *                                                        09700002
         MVC   EWTCTPL(L2),IOBRESTR  MOVE IN TP OP CODE AND    @ZA14034 09710000
*                               MOVE IN DECFLAGS FOR MESG      @ZA14034 09720000
         L     NAMEREG,IOSUCB      SET UP UCB ADDRESSIBILITY   @ZA14061 09730000
         MVC   EWACHA(L2),L4(NAMEREG) MOVE UNIT ADDR FOR MESG. @ZA14061 09740000
         MVI   EWAIND1,ZERO        RESET FLAG                  YM05652K 09750002
         LA    NAMEREG,WTORTN      GET NAME OF IOS WTO                  09800002
XCTLOUT1 NI    IOSFLA,L255-IOSERR  TURN OFF IOSB ERP IN CNTRL  @ZA04874 09810003
         NI    IOBFLAG1,L255-IOBERRTN    ALSO IN IOB           @ZA04874 09820003
XCTLOUT  EQU   *                                                        09850002
         USING CVTMAP,ERRETR                                            09900002
         L     ERRETR,CVTPTR       POINT TO CVT                         09950002
         L     ERRETR,CVTXTLER     POINT TO XCTL ROUTINE                10000002
         BR    ERRETR              GO TO IT                             10050002
         DROP  ERRETR                                                   10100002
IOSEXIT  EQU   *                                                        10150002
         CLI   EWAIND1,EWAISVCF    SVC 15 FLAG SET             YM05652K 10160002
         BNE   IOSEXIT1            NO, FORCE PERM ERROR        YM05652K 10170002
*                                  THIS IS AN ERP ERROR        YM05652K 10172002
IOSEXIT2 EQU   *                                               YM05652K 10180002
         MVI   EWAIND1,ZERO        CLEAR FLAG                  YM05652K 10190002
         SVC   15                  ERROR EXCP                           10200002
         SVC   3                   RETURN TO IOS                        10250002
IOSEXIT1 EQU   *                                               YM05652K 10260002
         NI    IOSFLA,L255-IOSERR  TURN OFF IOSB ERP IN CNTRL  @ZA04874 10270003
         NI    IOBFLAG1,L255-IOBERRTN   ALSO IN IOB            @ZA04874 10275003
         B     IOSEXIT2            ISSUE SVC                   YM05652K 10280002
RETRY    EQU   *                                                        10300002
         TM    EWAIND0,EWAIPMAP    PARALLEL MAPPING DONE                10400002
         BNO   CHANGE              NO,NOTHING TO UNFIX      L5 @ZA04156 10450003
         L     PARMREG,EWAITCCW    ADDR OF TCCW             L5 @ZA04156 10460003
         BAL   ERREG7,CHANGE1      DO UNFIX                 L5 @ZA04156 10470003
CHANGE   EQU   *                                                        10500002
         BAL   ERREG1,ERPEXT  GET ADR OF CURR EXT ENTRY     L5 @ZA04156 10510003
         CLC   ZERO(L4,ERRETR),FULL0         ENTRY EXIST?   L5 @ZA04156 10515003
         BE    CHANGE3             NO,NOTHING TO UNFIX      L5 @ZA04156 10520003
         L     PARMREG,ZERO(ERRETR)          ADR OF TCCW    L5 @ZA04156 10525003
         BAL   ERREG7,CHANGE1      DO UNFIX                 L5 @ZA04156 10530003
CHANGE3  EQU   *                                            L5 @ZA04156 10535003
         OI    EWAIND0,EWAIGPRO    GETMAIN IN PROCESS                   10550002
         L     ERREG3,GET480       LD PARMS                 L5 @ZA04156 10600003
         GETMAIN    R,LV=(0)                                L5 @ZA04156 10610003
         NI    EWAIND0,L255-EWAIGPRO   RESET FLAG                       10650002
         ST    PARMREG,EWAITCCW    STORE NEW TCCW                       10700002
         USING TCCW,PARMREG                                             10750002
         XC    ZERO(L160,PARMREG),ZERO(PARMREG)   ZERO TCCW             10800002
         LA    ERREG7,L160(PARMREG)   POINT TO BEB                      10850002
         XC    ZERO(L160,ERREG7),ZERO(ERREG7)   CLEAR BEB               10900002
         ST    ERREG7,TCCWBEB      STORE BEB ADDR IN TCCW               10950002
         LA    ERREG7,L160(ERREG7)   POINT TO FIXLIST                   11000002
         XC    ZERO(L160,ERREG7),ZERO(ERREG7)   CLEAR FIXLIST           11050002
         ST    ERREG7,TCCWFIX      STORE FIXLIST ADDR IN TCCW           11100002
         MVC   TCCWUCB(L3),IOSUCB+L1   UCB ADDR TO TCCW                 11150002
         MVC   TCCWTCB(L4),RQETCB   TCB ADDR TO TCCW                    11200002
         OI    EWAIND0,EWAIPMAP    MAPPING DONE                         11250002
         L     ERREG7,IOBSTART     TRANSLATE FROM IOBSTART , THIS WILL  11300002
*                                  BE IOBERCCW IF BUILT                 11350002
         LA    ERREG7,ZERO(ERREG7)   CLEAR OUT FLAGS                    11400002
         ST    ERREG7,TCCWFVC      FIRST VIRT CCW ADDR TO TCCW          11450002
         LR    ERREG3,ERREG7       SET AS PARAMETER                     11500002
         SR    ERREG6,ERREG6       CLEAR REGISTER              @ZA04853 11530003
*            2 LINES DELETED BY THE FOLLOWING APAR             @ZA03207 11560003
RETCCW   EQU   *                                                        11650002
GETLOCK2 SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        X11700002
               RELATED=(ERP,IGE0904B(FREELOC2))                         11750002
         CH    ERREG6,HALF12       MORE CORE NEED ?            @ZA04853 11753003
         BE    RETXLAT        YES BRANCH TO TRANSLATOR         @ZA04853 11756003
         MVI   TCCWOPTN,TCCWXLAT TRANSLATE AND FIX             @ZA03207 11760003
RETXLAT  L     ERREG5,EWAITRAN     POINT TO TRANSLATOR         @ZA04853 11800003
         BALR  ERRETR,ERREG5       GO TO HIM                            11850002
         LR    ERREG6,ERREG5       SAVE RETURN CODE            @ZA04853 11851003
         BAL   ERREG1,ERPEXT     GET ADDR OF CURRENT ERP       @ZA03207 11852003
*                                EXT ENTRY                     @ZA03207 11854003
         MVC   ZERO(L4,ERRETR),EWAITCCW  PUT TCCW ADDR INTO    @ZA03207 11856003
*                           ERP EXT ENTRY FOR THIS IOB         @ZA03207 11858003
FREELOC2 SETLOCK RELEASE,TYPE=LOCAL,RELATED=(ERP,IGE0904B(GETLOCK2))    11900002
         CH    ERREG6,HALF12       RETURN FOR MORE CORE        @ZA03207 11950003
         BE    CHANGE0             YES, DO GETMAIN                      12000002
         L     NAMEREG,TCCWFRC     GET FIRST REAL CCW ADDR     YM05697K 12010000
         LRA   NAMEREG,ZERO(NAMEREG)    REAL ADDR OF REAL CCW  YM05697K 12020000
         ST    NAMEREG,IOSRST      STORE 1ST REAL CCW ADDRESS  YM05697K 12050000
         B     CLEANUP             EXIT                                 12100002
         DROP  PARMREG                                                  12150002
CHANGE0  EQU   *                                                        12200002
         OI    EWAIND0,EWAIGPRO    GETMAIN IN PROCESS                   12250002
         L     ERREG3,GET160       LD PARMS                 L5 @ZA04156 12300003
         GETMAIN  R,LV=(0)                                  L5 @ZA04156 12310003
         NI    EWAIND0,L255-EWAIGPRO   RESET FLAG                       12350002
         XC    ZERO(L160,PARMREG),ZERO(PARMREG)   CLEAR CORE            12400002
         LR    ERREG3,PARMREG      PUT IN PARAMETER REG                 12450002
         L     PARMREG,EWAITCCW    POINT TO TCCW                        12500002
         B     RETCCW              GO TO TRANSLATOR AGAIN               12550002
CHANGE1  EQU   *                                                        12600002
GETLOCK3 SETLOCK OBTAIN,TYPE=LOCAL,MODE=UNCOND,                        X12650002
               RELATED=(ERP,IGE0904B(FREELOC3))                         12700002
         SR    ERREG3,ERREG3       CLEAR OUT PARM REG                   12750002
         USING TCCW,PARMREG                                             12850002
         MVI   TCCWOPTN,TCCWUNFX   CLEAR OPTIONS FIELD         @ZA03207 12900003
         DROP  PARMREG                                                  13000002
         L     ERREG5,EWAITRAN     GET ADDRESS OF TRANSLATOR            13050002
         BALR  ERRETR,ERREG5       GO TO HIM                            13100002
         BAL   ERREG1,ERPEXT     GET ADDR OF CURRENT ERP       @ZA03207 13110003
*                                EXTENSION ENTRY               @ZA03207 13120003
         XC    ZERO(L4,ERRETR),ZERO(ERRETR) CLEAR OUT THE      @ZA03207 13130003
*                           ERP EXT ENTRY (TCCW ADDR)          @ZA03207 13140003
FREELOC3 SETLOCK RELEASE,TYPE=LOCAL,RELATED=(ERP,IGE0904B(GETLOCK3))    13150002
CHANGE2  EQU   *                                                        13200002
         LTR   PARMREG,PARMREG     END OF CHAIN                         13250002
         BCR   8,ERREG7            YES,RETURN               L5 @ZA04156 13300003
         L     ERREG2,ZERO(PARMREG)   SAVE LINK POINTER                 13350002
         BAL   ERRETR,FREERTN      FREEMAIN ONE BLOCK                   13400002
         LR    PARMREG,ERREG2      RESET CHAIN BASE                     13450002
         B     CHANGE2             TEST FOR END                         13500002
FREERTN  EQU   *                                                        13550002
         LR    ERREG6,ERRETR       SAVE RETURN ADDRESS                  13600002
         OI    EWAIND0,EWAIFPRO    FREEMAIN IN PROGRESS                 13650002
         L     ERREG3,GET160       LD PARMS                 L5 @ZA04156 13700003
         FREEMAIN  R,LV=(0),A=(1)                           L5 @ZA04156 13710003
         NI    EWAIND0,L255-EWAIFPRO   RESET FLAG                       13750002
         BR    ERREG6              RETURN TO CALLER                     13800002
*                                                                       13810003
*       THIS SUBROUTINE WILL LOCATE THE ADDRESS OF THE CURRENT          13820003
*       ERP EXTENSION ENTRY AND PASS IT BACK TO THE CALLER IN           13830003
*       REG ERRETR.                                                     13840003
*                                                                       13842003
ERPEXT   L     NAMEREG,IOBDCBPT  GET DCB ADDR                  @ZA03207 13844003
         USING IHADCB,NAMEREG    DCB DSECT ADDRESSABILITY      @ZA03207 13846003
         L     ERRETR,DCBIOBAD   GET 1ST IOB ADDR MINUS LENGTH @ZA03207 13848003
         SR    ERREG2,ERREG2     CLEAR REG FOR IOB SIZE        @ZA03207 13848403
         IC    ERREG2,DCBEIOBX   GET IOB SIZE                  @ZA03207 13848803
         SR    ERREG5,ERREG5     IOB RLN INDICATOR             @ZA03207 13849203
NOTFOUND LA    ERRETR,ZERO(ERREG2,ERRETR)  IOB ADDR            @ZA03207 13849603
         LA    ERREG5,L1(ERREG5)  INCREMENT RLN INDICATOR      @ZA03207 13849703
         CR    ERRETR,IOBRG      IS THIS THE IOB FOR ERP       @ZA03207 13849803
         BNE   NOTFOUND          NO, ADDR NEXT IOB             @ZA03207 13849903
         SLL   ERREG5,L2         MULT INDEX BY 4 TO GET        @ZA03207 13878603
*                                DISPLACEMENT INTO ERP EXT     @ZA03207 13880603
         L     ERRETR,DCBIOBAD   1ST IOB ADDR MINUS LENGTH     @ZA03207 13882603
         L     NAMEREG,DCBDEBAD  ADDR OF DEB                   @ZA03207 13883003
         DROP  NAMEREG           DROP DCB ADDRESSABILITY       @ZA03207 13883103
         USING DEBBASIC,NAMEREG  DEB DSECT ADDRESSABILITY      @ZA03207 13883203
         IC    NAMEREG,DEBNMEXT  NUMBER OF IOB'S               @ZA03207 13888803
         DROP  NAMEREG           DROP DEB ADDRESSABILITY       @ZA03207 13890803
         N     NAMEREG,FULL255   CLEAR BYTES 0,1, AND 2        @ZA03207 13892803
NEXT     LA    ERRETR,ZERO(ERREG2,ERRETR) IOB ADDR             @ZA03207 13893203
         BCT   NAMEREG,NEXT      FALL THRU WHEN ERRETR POINTS  @ZA03207 13893603
*                                TO THE LAST IOB               @ZA03207 13894003
         LA    ERRETR,ZERO(ERREG2,ERRETR) ADDR ERP EXT         @ZA03207 13894103
         MVC   0(4,ERRETR),EWAITRAN       ADDR OF TRANSLATOR   @ZA03207 13895503
*                                  IN 0TH ENTRY OF ERP EXT     @ZA03207 13897503
         AR    ERRETR,ERREG5     ADDR CURRENT ENTRY IN THE     @ZA03207 13898603
*                                ERP EXTENSION                 @ZA03207 13900003
         BR    ERREG1            RETURN TO CALLER              @ZA03207 13908203
*                                                                       13918203
*                                                                       13920203
*                                                                       13920603
EXITEXIT EQU   *                                                        13922203
         DROP  BASEREG                                                  13936103
         BALR  BASEREG,ZERO                                             13950002
         USING *,BASEREG                                                14000002
         LR    ERREG7,ERRETR       SAVE RETURN ADDRESS                  14050002
         SETLOCK RELEASE,TYPE=LOCAL,RELATED=(ERP,IGE0904B(GETLOCK))     14100002
*                                  PROCEED WITH ABEND                   14150002
         SETRP                                                          14200002
         LR    ERRETR,ERREG7       RESET RETURN REG FOR RTM             14250002
         BR    ERREG7              RETURN TO TASK RECOVERY              14300002
         EJECT                                                          14350002
**********                                                              14400002
*                                                                       14450002
*        CONSTANTS                                                      14500002
*                                                                       14550002
**********                                                              14600002
EXITADDR ESTAE EXITEXIT,MF=L                                            14650002
ERLOD15  DC    H'6256'             TP RECORDER                          14700002
HALF12   DC    H'12'               CONSTANT FOR RETURN CODE CHECK       14750002
FULL255  DC    F'255'            FULL WORD OF 255              @ZA03207 14760003
GET160   DC    X'FD0000A0'                                  L5 @ZA17698 14770000
GET480   DC    X'FD0001E0'                                  L5 @ZA17698 14777000
FULL0    DC    F'0'                                         L5 @ZA04156 14784003
PACHAREA DC    40C'904B'           PATCH AREA FOR MAINTENANCE           14800003
         SPACE 2                                                        14850002
**********                                                              14900002
*                                                                       14950002
*        MISCELLANEOUS EQUATES                                          15000002
*                                                                       15050002
**********                                                              15100002
STATUP   EQU   254                 STATISTICS UPDATE ROUTINE NAME       15150002
WTORTN   EQU   253                 NAME OF IOS WTO ROUTINE              15200002
ERLOD00  EQU   43                  NAME OF 004C ERP                     15250002
SPMBFLAG EQU   X'9F'                                           @ZA08084 15270003
READTI   EQU   X'01'                                           @ZA08084 15290003
READTIR  EQU   X'81'                                           @ZA20113 15296000
NINETY   EQU   X'90'                                           @ZA08084 15310003
*                                                                       15350002
*                                                                       15400002
* SUBPOOL WAS 245 BUT NEED SOMETHING TCB RELATED, NOT RCT RELATED       15450002
*                                                                       15500002
*                                                                       15550002
L255     EQU   255                 AND MASK                             15600002
ZERO     EQU   0                   LENGTH AND DISPLACEMENT              15650002
L1       EQU   1                   LENGTH AND DISPLACEMENT              15700002
L2       EQU   2                   LENGTH AND DISPLACEMENT              15750002
L3       EQU   3                   LENGTH AND DISPLACEMENT              15800002
L4       EQU   4                   LENGTH AND DISPLACEMENT              15850002
L5       EQU   5                   LENGTH AND DISPLACEMENT              15900002
L6       EQU   6                   LENGTH AND DISPLACEMENT              15950002
L7       EQU   7                   LENGTH AND DISPLACEMENT              16000002
L8       EQU   8                   LENGTH AND DISPLACEMENT              16050002
L16      EQU   16                  LENGTH AND DISPLACEMENT              16100002
L19      EQU   19                                              @ZA08084 16110003
L22      EQU   22                                              @ZA08084 16120003
L160     EQU   160                 LENGTH AND DISPLACEMENT              16150002
         SPACE 2                                                        16250002
**********                                                              16300002
*                                                                       16350002
*        REGISTER DEFINITION                                            16400002
*                                                                       16450002
**********                                                              16500002
ERREG3   EQU   0                   WORK REG                             16550002
PARMREG  EQU   1                   PARAMETER REG                        16600002
ERREG2   EQU   2                   WORK REG                             16650002
EWAREG   EQU   3                   ERP WORKAREA BASE                    16700002
ERREG7   EQU   4                   CCW ADDRESS REG                      16750002
IOSBREG  EQU   5                   IOSB BASE                            16800002
RQEREG   EQU   6                   RQE BASE                             16850002
ERREG6   EQU   7                   WORK REG                             16900002
BASEREG  EQU   8                   PROGRAM BASE                         16950002
ERREG1   EQU   9                   WORK REG                             17000002
IOBRG    EQU   10                  IOB BASE                             17050002
ERREG4   EQU   11                  WORK REG                             17100002
ERRLNK   EQU   12                  LINK REG                             17150002
NAMEREG  EQU   13                  LINK REG                             17200002
ERRETR   EQU   14                  LINK REG/RETURN REG                  17250002
ERREG5   EQU   15                  LINK REG/WORK REG                    17300002
         EJECT                                                 @ZA03207 17310003
         DCBD DSORG=BX,DEVD=BS                                 @ZA03207 17320003
         EJECT                                                 @ZA03207 17330003
         IEZDEB LIST=YES                                       @ZA03207 17340003
         EJECT                                                          17350002
         IHAPSA                                                         17400002
         EJECT                                                          17450002
         IHASDWA                                                        17500002
         EJECT                                                          17550002
         IECDTCCW                                                       17600002
         EJECT                                                          17650002
         IECDRQE                                                        17700002
         EJECT                                                          17750002
         IEZIOB                                                         17800002
         EJECT                                                          17850002
CVT      DSECT                                                          17900002
         CVT                                                            17950002
         EJECT                                                          18000002
         IECDERWA  EWTC                                        @ZA08475 18050003
**********                                                              18100002
*                                                                       18150002
*        THE FOLLOWING DEFINITIONS ARE LOCAL FOR BTAM ERPS ONLY.        18200002
*                                                                       18250002
**********                                                              18300002
         ORG   EWAIERP                                                  18350002
EWAITRAN DS    F                   ADDRESS OF IECVTCCW         YM02594K 18400002
EWAITCCW DS    F                   PARALLEL TCCW               YM02594K 18450002
EWAIOVST DS    F                   ORIGINAL IOSVST CONTENTS    YM02594K 18500002
EWAIND0  DS    B                   FLAG BYTE                            18550002
EWAIVISR EQU   X'10'               V=R REQUEST                          19150002
EWAIPMAP EQU   X'08'               PARALLEL MAPPING DONE       YM02594K 19200002
EWAIGPRO EQU   X'04'               GETMAIN IN PROCESS          YM02594K 19250002
EWAIFPRO EQU   X'02'               FREEMAIN IN PROCESS         YM02594K 19300002
EWAIND1  DS    B                   FLAG BYTE                            19350002
EWAILD00 EQU   X'80'               EXIT TO 004C                YM02594K 19400002
EWAILD15 EQU   X'40'               EXIT TO LOAD 15             YM02594K 19450002
EWAIWTOL EQU   X'20'               EXIT TO IOS WTO             YM02594K 19500002
EWAISTAT EQU   X'10'               EXIT TO STAT UPDATE         YM05652K 19510002
EWAISVCF EQU   X'08'               SVC 15/SVC 3                YM05652K 19520002
EWAIND2  DS    B                   FLAG BYTE                            19550002
EWAIND3  DS    B                   FLAG BYTE                            19600002
EWAIAREA DS    20F                 SAVE AREA FOR MA OR AREA FOR WTO     19650002
EWAIBUFF EQU   EWAIAREA+X'18'      MDR RECORD POINTER AT X'48' YM05673K 19660002
EWAISAVE DS    2F                  TEMPORARY SAVE AREA                  19700002
EWAIEXIT DS    4F                  ESATE PARAMETER LIST                 19750002
*********  END OF BTAM LOCAL DEFINITIONS **********                     19800002
         EJECT                                                          19850002
         IECDIOSB                                                       19900002
         END                                                            19950002
