         TITLE 'IGE0904H - OBR/SDR INTERFACE FOR TPER RECORDING'        00200010
*                                                                     * 00400010
IGE0904H CSECT                                                          00600010
         SPACE 3                                                        00610010
*  CHANGE ACTIVITY AS FOLLOWS                                           00620010
******************** MICROFICHE FLAGS *********************** SUPT CODE 00630010
*A146000,292000,382000,488000,513000,582000,782000               S99228 00660010
*D513000,532000                                                  S99228 00660110
*A016000-028600,361000,404600-405200,439000,488800-489200        S99238 00660210
*A512700-513500,568800-569200,62100-626600,700200-701500         S99238 00660310
*A710600-711200,782200-783200                                    S99238 00660410
*C24200,250000-332000,440000-442000,710000,750000                S99238 00660510
*D016000-028000,334000-342000,438000                             S99238 00660610
*A488180                                                        SA60011 00660710
*A006000,330000                                                 SA61058 00660810
*C006600-007700,008000,012000                                   SA61058 00660910
*C488000                                                         S21903 00661010
*A144000,226000,752000,786000                                   SA65392 00661110
*C162000                                                        SA65392 00661210
*D230000,496000,701125,701280,736000,740000-742000              SA65392 00661310
*D746000-748000,776000,780000,782720,783000,788000,798000       SA65392 00661410
*C696000                                                        SA66340 00661510
         SPACE 3                                                        00800010
*C660000,696000                                                  Y01004 00860010
*D 782640-782720                                                 X02004 00920010
*A226030,226060                                                @ZA00237 00940010
*C536000,580000,700500                                         @ZA00237 00960010
*D772000                                                       @ZA00237 00980010
*A782600                                                       @ZA02623 00984010
*C227000                                                       @ZA02623 00988010
*A227100                                                       @YA10697 00992010
*D232000-234000                                                @YA10697 00996010
*C226800,A226900                                               @OZ24288 00998010
*********************************************************************** 01000010
*  TITLE: IGE0904H - OBR/SDR INTERFACE FOR TPER RECORDING             * 01200010
*                                                                     * 01220010
*  MODULE NAME = IGE0904H                                             * 01240010
*                                                                     * 01260010
*  DESCRIPTIVE NAME = OBR/SDR INTERFACE FOR TPER RECORDING            * 01280010
*                                                                     * 01300010
*  COPYRIGHT = 'NONE'                                                 * 01320010
*                                                                     * 01340010
*  STATUS:  CHANGE LEVEL 6                                            * 01360010
*                                                                     * 01400010
* FUNCTION -- THIS MODULE HANDLES SOH % ERROR MESSAGES FOR PROPERS99238 01600010
*    RECORDING.  IT INTERFACES TO OBR/SDR RECORDING MODULES TO   S99238 01690010
*    RECORD THE ERROR MESSAGES THAT ARE TO BE LOGGED ON          S99238 01780010
*    SYS1.LOGREC.  ERROR MESSAGES THAT ARE TO BE WRITTEN TO THE  S99238 01870010
*    OPERATOR ARE WRITTEN OUT OF THIS MODULE VIA WTO.  A SCAN OF S99238 01960010
*    THE BUFFER IS MADE TO DETERMINE IF IT IS A VALID SOH %      S99238 02050010
*    MESSAGE, IF IT IS NOT THE MESSAGE IS NOT RECORDED AND       S99238 02140010
*    CONTROL IS GIVEN BACK TO THE SYSTEM.  IF IT IS A VALID SOH% S99238 02230010
*    ERROR MESSAGE A SCAN OF THE BUFFERS ARE MADE TO DETERMINE   S99238 02320010
*    HOW MUCH DATA IS TO BE RECORDED.  A GETMAIN IS ISSUED TO    S99238 02410010
*    GET ENOUGH CORE FOR RECORDING (INCLUDING PROPER HEADER      S99238 02500010
*    RECORD).  THE GOTTEN CORE IS FORMATTED ACCORDING TO THE     S99238 02590010
*    TYPE OF SOH % MESSAGE, THE DATA TO BE RECORDED IS MOVED     S99238 02680010
*    INTO THE GOTTEN CORE AND CONTROL IS PASSED TO THE PROPER    S99238 02770010
*    RECORDING MODULES.                                          S99238 02860010
*                                                                     * 03000010
* ENTRY POINTS -- FIRST EXECUTABLE INSTRUCTION                        * 03200010
*                                                                     * 03400010
* INPUT --                                                            * 03600010
*   R1 - POINTER TO I/O SUPERVISOR BLOCK                         Y02027 03800010
*    R15 - ENTRY POINT ADDRESS                                        * 04000010
*                                                                     * 04200010
*OUTPUT -- R1 POINTS TO I/O SUPERVISOR BLOCK                     Y02027 04400010
*                                                                     * 04600010
* EXTERNAL REFERENCES -- NONE                                         * 04800010
*                                                                     * 05000010
*EXITS-NORMAL -- R1 POINTS TO I/O SUPERVISOR BLOCK               Y02027 05200010
*        SVC   15   'NO ERROR FLAGS'. RETURN TO LINE END         Y02027 05400010
*                   APPENDAGE. ERROR CLEARED                     Y02027 05600010
*         SVC   3                                                     * 05800010
*                                                                     * 06000010
*         TO SCHEDULE NEXT LOAD                                       * 06200010
*         L     13,DECIMAL VALUE OF NEXT LOAD                         * 06400010
*         L     14,X'10'     CVT ADDRESS                              * 06600010
*         L     14,X'2C'(14) ADDRESS OF XCTL ROUTINE                  * 06800010
*         BR    14           EXIT TO XCTL                             * 07000010
*                                                                     * 07200010
* EXITS, ERROR -- NONE                                                * 07400010
*                                                                     * 07600010
* TABLES/WORK AREAS --                                                * 07800010
*    TAVTD                                                            * 08000010
*    TTRMD                                                            * 08200010
*    TCCWD                                                            * 08400010
*    TLCBD                                                            * 08600010
*    DCBD                                                             * 08800010
*    TSCBD                                                            * 09000010
*    TPRFD                                                            * 09200010
*    TPERD                                                            * 09400010
*   IECDIOSB                                                     Y02027 09500010
*                                                                     * 09600010
*ATTRIBUTES -- SERIALLY REUSABLE, REFRESHABLE, SUPERVISOR KEY,   Y02027 09800010
*              SUPERVISOR MODE, ENABLED                          Y02027 09900010
*                                                                     * 10000010
* CHARACTER CODE DEPENDENCY --                                        * 10200010
*                                                                     * 10400010
*    THE OPERATION OF THIS MODULE DOES NOT DEPEND UPON A PARTICULAR   * 10600010
*    INTERNAL REPRESENTATION OF THE EXTERNAL CHARACTER SET.           * 10800010
*                                                                     * 11000010
* NOTES --                                                              11200010
*    PARAMETERS PASSED TO TPER RECORDING MODULE:                      * 11400010
*                                                                     * 11600010
*   EWTCBUFF - THE ADDRESS OF THE TPER BUFFER. THE BUFFER IS     Y02027 11800010
*    FORMATTED BY THIS MODULE BEFORE CALLING TPER.                    * 12000010
*                                                                     * 12200010
*    TPER PROCESSING FLAG (LCBOBRRD) SHOULD NOT BE ON WHEN THIS       * 12400010
*    MODULE IS ENTERED.                                               * 12600010
*                                                                     * 12800010
*********************************************************************** 13000010
         EJECT                                                          13200010
         USING IEDQLCB,RLCB             LCB                             13600010
         USING IHADCB,RDCB              DCB                             13800010
         USING IEDQAVTD,RAVT            AVT                             14000010
         USING IEDQTRM,RTERM            TERMINAL ENTRY                  14200010
         USING IEDQSCB,RSCB             SCB                             14400010
         USING DEBTCBAD,RDEB            DEB                     SA65392 14500010
         USING *,R10                    BASE REGISTER                   14600010
         USING TPERD,RWKD               TPER RECORD ADDRESS      S99228 14700010
         USING IOSB,RTST                                         Y02027 14730010
         USING EWA,RERPWA                                        Y02027 14760010
         LR    R10,RWKD                 ADDRESSABILITY                  14800010
*                                                                       15000010
*        REGISTERS                                                      15200010
*                                                                       15400010
R0       EQU   0                                                        15600010
RTST     EQU   1                        ADDR OF I/O SUPVR BLOCK  Y02027 15800010
RLCB     EQU   2                        LCB BASE                        16000010
RDEB     EQU   3                        DEB REGISTER            SA65392 16200010
RWKF     EQU   3                        WORK REGISTER                   16400010
RDCB     EQU   4                        DCB BASE                        16600010
RWKE     EQU   4                        WORK REGISTER                   16800010
RCCW     EQU   5                        CCW BASE                        17000010
RWKA     EQU   6                        WORK REGISTER                   17200010
RWKB     EQU   7                        WORK REGISTER                   17400010
RTERM    EQU   8                        TERMINAL BASE                   17600010
RWKC     EQU   9                        WORK REGISTER                   17800010
R10      EQU   10                       BASE REGISTER                   18000010
RAVT     EQU   11                       AVT BASE                        18200010
RSCB     EQU   12                       CURRENT SCB                     18400010
RLINK    EQU   13                       LINKAGE FOR NEXT LOAD           18600010
RXCTL    EQU   14                       XCTL REGISTER                   18800010
RERPWA   EQU   14                       ADDR OF ERP WORK AREA    Y02027 18900010
RWKD     EQU   15                       WORK REGISTER                   19000010
R15      EQU   15                                                       19200010
         EJECT                                                          19400010
*********************************************************************** 19600010
*                                                                     * 19800010
*        DSECT ADDRESSABILITY                                         * 20000010
*                                                                     * 20200010
*********************************************************************** 20400010
IGE0904H IEDHJN TPERREC                 MODULE ID AND DATE       S99238 20500010
         L     RWKB,IOSUSE              PICKUP ADDR OF RQE       Y02027 20520010
         L     RERPWA,IOSERP            PICKUP ADDR OF ERP WORK  Y02027 20540010
*                                       AREA                     Y02027 20560010
         L     RLCB,IOBOFFST(,RWKB)      LCB ADDRESS             Y02027 20600010
         SH    RLCB,LCBSIZE             ADJUST BASE                     20800010
         L     RSCB,LCBSCBA-1           CURRENT SCB                     21000010
         L     RCCW,LCBCSW-1            FAILING CCW                     21200010
         SH    RCCW,H8                  BACK TO TO FAILING CCW          21400010
         L     RDCB,LCBDCBPT            DCB BASE                        21600010
         L     RAVT,CVTPTR              CVT ADDR                        21800010
         L     RAVT,AVTCVTPT(,RAVT)     LOAD LIST ADDR                  22200010
         L     RAVT,AVTEZERO(,RAVT)     AVT BASE                        22400010
         LR    RLINK,RTST               SAVE RQE ADDR.                  22600010
         DROP  RTST                                            @ZA00237 22603010
         USING IOSB,RLINK                                      @ZA00237 22606010
         L     RDEB,DCBDEBAD            DEB ADDRESSIBILITY      SA65392 22610010
         SR    RWKA,RWKA                CLEAR WORK REGISTER     SA65392 22620010
         LR    RWKB,RWKA                CLEAR WORK REGISTER     SA65392 22630010
         IC    RWKA,DEBNMEXT            NUMBER OF EXTENTS       SA65392 22640010
         SLL   RWKA,TWO                 SIZE OF UCB ADDRESSES   SA65392 22650010
         L     RWKA,DEBUCBAD(RWKA)      THRESHHOLD AREA         SA65392 22660010
         IC    RWKB,LCBUCBX             RLN MINUS ONE           SA65392 22670010
         SLL   RWKB,THREE               THRESHOLD INDEX        @OZ24288 22680010
         AR    RWKA,RWKB                THRESHHOLD COUNTERS     SA65392 22690010
         SRL   RWKB,1                   ADD HALF AGAIN FOR     @OZ24288 22693010
         AR    RWKA,RWKB                ERRMSG SAVE AREA       @OZ24288 22696010
         IC    RWKB,THREE(RWKA)         GET TIMEOUT COUNT      @ZA02623 22700010
         LA    RWKB,ONE(RWKB)           INCREMENT               SA65392 22710010
         TM    LCBTSTSW,LCBSECON        IS THIS SECOND ENTRY?  @YA10697 22713010
         BO    FREECORE                 YES, FREE CORE         @YA10697 22716010
         STC   RWKB,THREE(RWKA)         SET NEW VALUE           SA65392 22720010
         CLC   THREE(ONE,RWKA),AVTHRESH+THREE MAXIMUM TIMEOUTS  SA65392 22730010
         BL    EXIT                     BRANCH NO, NO MESSAGE   SA65392 22740010
         MVI   THREE(RWKA),ZERO         INITIALIZE COUNTER      SA65392 22750010
         EJECT                                                          22800010
*                                                                       23600010
*********************************************************************** 23800010
*                                                                     * 24000010
*        SCAN BUFFER(S) FOR STX AND EXIT IF NOT FOUND            S99238 24200010
*                                                                     * 24600010
*********************************************************************** 24800010
         L     RWKA,LCBLSPCI-1          LAST SERVICED PCI        S99238 25000010
         USING IEDQPRF,RWKA                                      S99238 25200010
         SPACE                                                          25400010
         L     RWKC,DCBSCTAD-1          SPECIAL CHAR TABLE ADDR  S99238 25600010
         LR    RWKD,RWKA                LOAD BUFFER ADDRESS      S99238 25800010
         SR    RWKB,RWKB                CLEAR REGISTER           S99238 26000010
         IC    RWKB,STXENQCH(,RWKC)     GET OFFSET TO SEQUENCE   S99238 26200010
         LA    RWKB,X01(RWKB,RWKC)      POINT TO SEQUENCE        S99238 26400010
         LA    R0,SEVEN                 MAXIMUM SCAN LENGTH      S99238 26600010
         CH    R0,PRFCOUNT              SEVEN DATA BYTES IN UNIT?S99238 26800010
         BH    ADJUST                   NO                       S99238 27000010
         SPACE                                                          27200010
         LR    RWKF,R0                  YES, SET MAX SCAN LNGTH  S99238 27400010
         SPACE                                                          27600010
         B     ENTER                    ENTER SCAN LOOP          S99238 27800010
ADJUST   EQU   *                                                 S99238 28000010
         LH    RWKF,PRFCOUNT            SET LOOP CONTROL         S99238 28200010
         N     RWKF,AVTCLRHI            CLEAR HIGH               S99238 28400010
         SPACE                                                          28600010
ENTER    EQU   *                                                 S99238 28800010
         SR    R0,RWKF                  NO. OF BYTES SCANNED     S99238 29000010
         L     RWKD,PRFIOADR-1          LOAD DATA ADDR           S99238 29200010
         TM    LCBFLAG3,LCBSOHR         SOH%R MESSAGE?           S99228 29220010
         BZ    LOOP                     BRANCH NO                S99228 29240010
         LA    RWKD,ZERO(R0,RWKD)       CLEAR HIGH ORDER BYTE    S99228 29260010
BACKUP   EQU   *                                                 S99228 29280010
         CLI   ZERO(RWKD),X01           SOH CHARACTER?           S99228 29300010
         BE    LOOP                     BRANCH YES               S99228 29320010
         BCT   RWKD,BACKUP              CHECK NEXT CHARACTER     S99228 29340010
LOOP     EQU   *                                                 S99238 29400010
         CLC   X01(X01,RWKB),0(RWKD)    IS THIS BYTE STX         S99238 29600010
         BE    FOUND                    YES, ACCUMULATE DATA     S99238 29800010
         SPACE                                                          30000010
         LA    RWKD,X01(RWKD)           NO, BUMP DATA ADDR       S99238 30200010
         BCT   RWKF,LOOP                SCAN COMPLETE            S99238 30400010
         SPACE                                                          30600010
         LTR   R0,R0                    ANY BYTES LEFT           S99238 30800010
         BZ    BYPASS                   NO, ERROR RETURN         S99238 31000010
         SPACE                                                          31200010
         TM    PRFTIC+3,X02             LAST UNIT OR BUFFER      S99238 31400010
         BO    BYPASS                   YES, RETURN              S99238 31600010
         SPACE                                                          31800010
         L     RWKA,PRFTIC              GET ADDR OF NEXT UNIT    S99238 32000010
         LR    RWKF,R0                  SET REMAINING BYTES      S99238 32200010
         B     ENTER                    RE-ENTER LOOP            S99238 32400010
         SPACE                                                          32600010
FOUND    EQU   *                                                 S99238 32800010
         LA    RWKD,X01(RWKD)           ADDRESS OF ID            S99238 33000010
         LA    RWKA,0(RWKA)             CLEAR HI ORDER BYTE     SA61058 33100010
         LR    R0,RWKA                  SAVE START DATA ADDR     S99238 33200010
*********************************************************************** 34400010
*                                                                     * 34600010
*        DETERMINE THE AMOUNT OF DATA TO RECORD                       * 34800010
*                                                                     * 35000010
*********************************************************************** 35200010
         SR    RWKB,RWKB                ZERO ACCUMULATOR                35400010
         LA    RCCW,0(RCCW)             CLEAR HIGH ORDER BYTE           35600010
TOTAL    EQU   *                                                        35800010
         LA    RWKA,0(RWKA)             CLEAR HIGH ORDER                36000010
         AH    RWKB,PRFCOUNT            ACCUM AMT DATA IN UNIT   S99238 36100010
         CR    RWKA,RCCW                IS THIS THE LAST BUFFER UNIT    36200010
         BE    FINALSUM                 YES, HANDLE LAST UNIT           36400010
*                                                                       36600010
         L     RWKA,PRFTIC              ADDRESS OF NEXT BUFFER UNIT     37000010
         B     TOTAL                    PROCESS THIS UNIT               37200010
*                                                                       37400010
FINALSUM EQU   *                                                        37600010
         SH    RWKB,LCBCSW+FIVE         CALC ACTUAL DATA IN UNIT S99238 37800010
         LA    RWKB,HDRLEN(RWKB)        ALLOW CORE FOR TPER HDR         38200010
         TM    LCBFLAG3,LCBSOHR         SOH % R MESSAGE?         S99228 38300010
         BNO   ENUF                     BRANCH NO                S99228 38400010
         SPACE                                                          38500010
         LA    RWKB,FIVE(R0,RWKB)       INCREMENT GETMAIN COUNT  S99228 38800010
ENUF     EQU   *                                                        39400010
*********************************************************************** 39600010
*                                                                     * 39800010
*        GET TPER BUFFER                                              * 40000010
*                                                                     * 40200010
*********************************************************************** 40400010
         LR    RWKC,RWKD                SAVE ADDRESS OF ID       S99238 40460010
         LR    RWKA,R0                  RESTORE BEGINNING OF DATAS99238 40520010
         BAL   RWKF,GETMAIN             GET CORE FOR TPER BUFFER        40600010
*                                                                       40800010
         BNZ   ERRCORE                  CORE UNAVAIL. ,TRY ERROR RECORD 41000010
*                                                                       41200010
         BAL   RWKF,BUILD              INIT TPER BUFFER                 41400010
*                                                                       41600010
*********************************************************************** 41800010
*                                                                     * 42000010
*        MOVE DEVICE DEPENDENT DATA TO GOTTEN TPER BUFFER             * 42200010
*                                                                     * 42400010
*********************************************************************** 42600010
         L     RWKF,EWTCBUFF            GET TOTAL LENGTH OF TPER Y02027 42800010
*                                       BUFFER                   Y02027 42900010
         LH    RWKF,0(RWKF)                                             43000010
         LA    R0,HDRLEN                ADJUST BY LENGTH OF TPER HDR    43200010
         SR    RWKF,R0                  AMOUNT OF DEVICE DATA TO BE     43400010
*                                       MOVED                           43600010
         L     RWKC,PRFIOADR-1          LOAD ADDR OF DATA IN UNITS99238 43900010
         LH    R0,PRFCOUNT              LOAD NO. BYTES IN UNIT   S99238 44000010
         AR    RWKC,R0                  ADJUST ADDRESS           S99238 44100010
         SR    RWKC,RWKE                ANY DATA LEFT IN UNIT    S99238 44200010
         BNP   UPDATE                   NO DEVICE DATA IN THIS UNIT     44400010
*                                                                       44600010
MOVE     EQU   *                                                        44800010
         CR    RWKA,RCCW                LAST UNIT                       45000010
         BE    LASTMVE                  YES, FINISH MOVING THE DATA     45200010
*                                                                       45400010
         BCTR  RWKC,0                   DECREMENT COUNT                 45600010
         EX    RWKC,DATAMVE             MOVE DATA TO TPER BUFFER        45800010
         LA    RWKC,X01(RWKC)           UPDATE COUNT MOVED              46000010
         LA    RWKD,0(RWKC,RWKD)        UPDATE POINTER IN TPER BUFFER   46200010
         SR    RWKF,RWKC                DECREMENT TOTAL COUNT BY THE    46400010
*                                       COUNT JUST MOVED                46600010
UPDATE   EQU   *                                                        46800010
         L     RWKA,PRFTIC              GET ADDRESS OF NEXT BUFFER UNIT 47000010
         LA    RWKA,0(RWKA)             CLEAR HIGH ORDER                47200010
         L     RWKE,PRFIOADR-1          ADDR OF DATA IN THIS BUFF UNIT  47400010
         LH    RWKC,PRFCOUNT            AMT OF DATA IN THIS BUFFER UNIT 47600010
         B     MOVE                     MOVE DATA IN THIS BUFFER UNIT   47800010
*                                                                       48000010
LASTMVE  EQU   *                                                        48200010
         BCTR  RWKF,0                   MOVE REMAINING DATA             48400010
         EX    RWKF,DATAMVE             MOVE DATA TO TPER BUFFER        48600010
         NI    IOSFLB,AVTEFF-IOSLOG     TURN OFF LOG BIT.        Y02027 48800010
         SPACE 1                                                        48802010
         TM    LCBFLAG3,LCBSOHR         SOH%R MESSAGE?           S99228 48804010
         BZ    RETEST                   BRANCH NO                S99228 48806010
         L     RWKE,LCBDCBPT            LOAD DCB ADDRESS         S99228 48808010
         L     RWKE,DCBTRANS-X01        LOAD TRANS TABLE ADDR    S99228 48810010
         L     R0,ZERO(R0,RWKE)         LOAD OUTPUT TRANS TABLE  S99228 48812010
*                                       ADDRESS                  S99228 48814010
         LTR   R0,R0                    EBCDIC MESSAGE?          S99228 48816010
         BZ    TPERLINK                 BRANCH TO XCTL           S99228 48818010
         L     RWKD,EWTCBUFF            LOAD DSECT BASE          Y02027 48819010
         LA    RWKE,FOUR(R0,RWKE)       LOAD ADDR INPUT TRANS TBLS99228 48820010
         TR    TPERDVED(FOUR),ZERO(RWKE)  TRANSLATE MESSAGE      S99228 48822010
         B     TPERLINK                 BRANCH TO XCTL           S99228 48824010
RETEST   EQU   *                                                 S99228 48826010
         SPACE                                                          48840010
         TM    LCBFLAG3,LCBSOHC+LCBSOHR IS THIS SOH % E          S99238 48880010
         BZ    TPERLINK                 YES                      S99238 48890010
         SPACE                                                          48900010
         TM    LCBFLAG3,LCBSOHC         IS THIS A SOH % C MSG    S99238 48910010
         BO    WTO                      YES, BRANCH FOR WRITE    S99238 48920010
         SPACE                                                          48930010
         SPACE                                                          48960010
TPERLINK EQU   *                                                        49000010
         LR    RTST,RLINK               RESTORE RQE ADDR                49200010
         LH    RLINK,H6256              TPER XCTL ID                    49400010
         OI    EWAFLG2,EWAMDR           INDICATE MDR RECORDING   Y02027 49500010
         L     RXCTL,CVTPTR             PICKUP ADDR OF CVT       Y02027 49600010
         L     RXCTL,XCTLADD(,RXCTL)    XCTL ADDRESS                    49800010
         BR    RXCTL                    LINK TO XCTL                    50000010
*                                                                       50200010
*********************************************************************** 50400010
*                                                                     * 50600010
*        GET CORE FOR ERROR MSG                                       * 50800010
*                                                                     * 51000010
*********************************************************************** 51200010
         SPACE                                                          51250010
ERRCORE  EQU   *                                                 S99238 51270010
         TM    LCBFLAG3,LCBSOHC+LCBSOHR SOH%C OR SOH%R MSG?      S99228 51300010
         BO    BYPASS                   YES, RETURN              S99238 51350010
         LA    RWKB,EMSGLEN             ERROR RECORD GETMAIN LENGTH     51600010
*                                       INCLUDING HALF WORD SAVE AREA   51800010
*                                       AND STD TPER HDR                52000010
         BAL   RWKF,GETMAIN             GET CORE FOR TPER ERROR RECORD  52200010
         BNZ   BYPASS                   NO CORE, BYPASS RECORDIMG       52400010
*                                                                       52600010
         BAL   RWKF,BUILD              INITIALIZE THE BUFFER            52800010
*                                                                       53000010
         MVC   TPERSERN,0(RWKE)         MOVE THE SERIAL NUMBER          53400010
         L     RWKA,IOSUCB              PICKUP UCB ADDR        @ZA00237 53600010
         MVC   TPERCUU(TWO),FOUR(RWKA)  PUT CUU IN TPER RECORD          53800010
         B     TPERLINK                 LINK TO TPER                    54000010
*                                                                       54200010
         DROP  RWKA                                                     54400010
*********************************************************************** 54600010
*                                                                     * 54800010
*        INITIALIZE TPER BUFFER WITH CONTROL INFORMATION              * 55000010
*                                                                     * 55200010
*********************************************************************** 55400010
BUILD    EQU   *                                                        55600010
         L     RWKD,EWTCBUFF            ADDRESS OF GOTTEN CORE   Y02027 55800010
         STH   RWKB,TPERTLEN            SAVE TOTAL LENGTH OF CORE       56000010
         LA    RWKD,FOUR(RWKD)          START OF TPER BUFFER            56200010
         ST    RWKD,EWTCBUFF            SAVE ADDR OF TPER BUFFER Y02027 56400010
         OI    LCBTSTSW,LCBSECON        SET SECOND ENTRY SWITCH         56600010
         SH    RWKB,AVTHA4              LENGTH OF TPER BUFFER           56800010
         SPACE                                                          56840010
         TM    LCBFLAG3,LCBSOHC         SOH % C MESSAGE          S99238 56880010
         BO    BUILDC                   YES, SET OF BUFFER       S99238 56920010
         SPACE                                                          56960010
         BCTR  RWKB,0                   DECREMENT LENGTH                57000010
         EX    RWKB,CLEAR               CLEAR CORE                      57200010
         LA    RWKB,X01(RWKB)           ADD ONE                         57400010
         STH   RWKB,TPERBLEN            SAVE LENGTH OF TPER BUFFER      57600010
         MVC   TPERXCTL(2),H9048        INITIALIZE XCTL INFORMATION     57800010
         L     RWKE,IOSUCB              PICKUP UCB ADDR        @ZA00237 58000010
         MVC   TPERCUU(TWO),FOUR(RWKE)  PUT CUU IN TPER RECORD   S99238 58200010
         TM    LCBFLAG3,LCBSOHR         SOH%R MESSAGE?           S99228 58700010
         BZ    IDINDATA                 BRANCH NO                S99228 59200010
         MVI   TPERRDID,SOHRID          SET SOH%R RECORD ID      S99228 59700010
         LA    RWKD,HDRLEN(RWKD)        ADJUST FOR HEADER        S99228 60200010
         LR    RWKE,RWKC                SAVE DATA ADDRESS        S99228 60700010
         BR    RWKF                     RETURN TO CALLER         S99228 61200010
IDINDATA EQU   *                                                 S99228 61700010
         MVC   TPERRDID,0(RWKC)         MOVE RECORD ID TO TPER BUFFER   62600010
         LA    RWKD,HDRLEN(RWKD)        ADJUST FOR SOH % E HDR   S99238 62610010
         CLI   0(RWKC),X'08'            2715 RECORD              S99238 62620010
         BNE   STANDARD                 NO                       S99238 62630010
         LA    RWKC,X02(RWKC)           BUMP PAST BLANKS         S99238 62640010
STANDARD EQU   *                                                 S99238 62650010
         LA    RWKE,X01(RWKC)           BUMP PAST ID             S99238 62660010
         BR    RWKF                     RETURN TO CALLER                62800010
*                                                                       63000010
*********************************************************************** 63400010
*                                                                     * 63600010
*        FREE CORE GOTTEN FOR TPER BUFFER ON INITIAL ENTRY            * 63800010
*                                                                     * 64000010
*********************************************************************** 64200010
FREECORE EQU   *                                                        64400010
         L     RWKA,EWTCBUFF            ADDRESS OF TPER BUFFER   Y02027 64600010
         LA    RWKA,0(RWKA)             CLEAR HIGH ORDER                64800010
         SH    RWKA,AVTHA4              START OF GOTTEN CORE            65000010
         LH    RWKB,0(RWKA)             LENGTH OF GOTTEN CORE           65200010
         LA    RWKB,SEVEN(RWKB)         ROUND UP TO A MULTIPLE OF 8     65400010
         SRL   RWKB,THREE               FOR FREEMAIN                    65600010
         SLL   RWKB,THREE               (CLEAR LOW ORDER BITS)          65800010
         FREEMAIN R,LV=(RWKB),A=(RWKA),SP=234  FREE TPER BUFFER. Y01004 66000010
         NI    LCBTSTSW,AVTEFF-LCBSECON RESET SECOND ENTRY SWITCH       66200010
BYPASS   EQU   *                                                        66400010
EXIT     EQU   *                                                        66600010
         NI    LCBFLAG3,AVTEFF-LCBOBRRD RESET TPER PROCESSING           66800010
         OI    SCBERR2,SCBSOHE          SET SOH %E ERROR BIT            67000010
         NI    IOSFLA,AVTEFF-(IOSERR+IOSEX) INDICATE ERROR IS    Y02027 67200010
*                                       CLEARED                  Y02027 67300010
         LR    RTST,RLINK               RESTORE RQE ADDR                67400010
         SVC   EREXCP                   RETURN TO LINE,ERROR CLEARED    67600010
         SVC   RETURN                   EXIT                            67800010
*                                                                       68000010
*********************************************************************** 68200010
*                                                                     * 68400010
*        GETMAIN ROUTINE                                              * 68600010
*                                                                     * 68800010
*********************************************************************** 69000010
GETMAIN  EQU   *                                                        69200010
         LA    RWKD,EWTCBUFF            LOCATION TO SAVE ADDRESS Y02027 69400010
*                                       OF GOTTEN CORE           Y02027 69500010
         GETMAIN EC,LV=(RWKB),A=(RWKD),SP=234,MF=(E,AVTGETMN)   SA66340 69600010
         LTR   R15,R15                  SET COND. CODE BEFORE RETURNING 69800010
         BR    RWKF                     RETURN                          70000010
         EJECT                                                          70010010
BUILDC   EQU   *                                                 S99238 70020010
         MVI   0(RWKD),BLANK            SET BLANK IN BUFFER      S99238 70021010
         BCTR  RWKB,0                   SUBTRACT ONE             S99238 70022010
         BCTR  RWKB,0                   SUBTRACT ONE             S99238 70023010
         EX    RWKB,BLANKS              BLANK OUTPUT BUFFER      S99238 70024010
         STH   RWKB,0(RWKD)             STORE LENGTH IN BUFFER   S99238 70030010
         MVC   TWO(10,RWKD),WTOFLAGS    SET FLAGS & MSG ID NO.   S99238 70040010
         L     RWKE,IOSUCB              PICKUP UCB ADDR        @ZA00237 70050010
         MVC   CUUOFF(3,RWKD),EBCDCUU(RWKE) EBCIDIC CUU ADDR     S99238 70060010
         LA    RWKD,SOHCHDR(RWKD)       ADJUST FOR SOH % C HDR   S99238 70065010
         LR    RWKB,RWKC                SAVE ROUTE CODE ADDR     S99238 70070010
         LA    RWKE,X01(RWKC)           BUMP PAST ROUTE CODE     S99238 70075010
         BR    RWKF                     RETURN TO CALLER         S99238 70080010
WTO      EQU   *                                                 S99238 70090010
         LA    RWKD,1(RWKF,RWKD)        UPDATE POINTER           S99238 70100010
         MVC   0(4,RWKD),WTOENDFG       MOVE WTO END FLAGS       S99238 70110010
         LR    R0,RWKD                  SET FOR SUBTRACT         S99238 70110510
         LA    RWKD,X02(RWKD)           ADD DESCRIPTOR LENGTH    S99238 70111010
         SPACE                                                          70111510
         OI    0(RWKD),CDE2             INDICATE MASTER CONSOLE  S99238 70112010
         TM    0(RWKB),BIT6             ROUTE CODE 8 SPECIFIED   S99238 70113010
         BNO   TEST10                   NO, TEST FOR 10          S99238 70113510
         OI    0(RWKD),CDE8             INDICATE TP CONSOLE      S99238 70114010
         NI    0(RWKD),AVTEFF-CDE2      TURN OFF MASTER CONSOLE  S99238 70114510
         B     SETUPWRT                 SET UP FOR WRITE         S99238 70115010
TEST10   EQU   *                                                 S99238 70115510
         TM    0(RWKB),BIT5             ROUTE CODE 10 SPECIFIED  S99238 70116010
         BNO   SETUPWRT                 SET UP FOR WRITE         S99238 70116510
         OI    1(RWKD),CDE10            INDICATE SYS MAINT CON   S99238 70117010
         NI    0(RWKD),AVTEFF-CDE2      TURN OFF MASTER CONSOLE  S99238 70117510
SETUPWRT EQU   *                                                 S99238 70118010
         L     RWKB,EWTCBUFF            PICKUP BUFFER ADDRESS    Y02027 70120010
         LA    RWKB,0(RWKB)             CLEAR HIGH               S99238 70122010
         SR    R0,RWKB                  GET CORRECT LENGTH       S99238 70124010
         STH   R0,0(RWKB)               SET MSG LENGTH           S99238 70126010
         WTO   MF=(E,(RWKB))            WRITE MSG ON CONSOLE     S99238 70130010
         NI    LCBFLAG3,AVTEFF-LCBSOHC  RESET C MSG BIT          S99238 70140010
         B     FREECORE                 PREPARE FOR EXIT         S99238 70150010
*                                                                       70200010
*                                                                       70400010
CLEAR    XC    TPERBLEN(0),TPERBLEN     CLEAR BUFFER                    70600010
*                                                                       70800010
DATAMVE  MVC   0(0,RWKD),0(RWKE)        MOVE DATA                S99238 71000010
*                                                                       71060010
BLANKS   MVC   X01(0,RWKD),0(RWKD)      MOVE BLANKS              S99238 71120010
*                                                                       71200010
         EJECT                                                          71400010
*********************************************************************** 71600010
*                                                                     * 71800010
*        CONSTANTS AND EQUATES                                        * 72000010
*                                                                       72200010
*********************************************************************** 72400010
H8       DC    H'8'                     CONSTANT OF EIGHT               72600010
H6256    DC    H'6256'                  XCTL INFO FOR IGE0625F          72800010
H9048    DC    H'9048'                  XCTL INFO FOR IGE0904H          73000010
LCBSIZE  DC    AL2(LCBFLAG1-IEDQLCB)    DISP. OF IOB IN LCB             73200010
PATCH    DC    10F'0'                   PATCH AREA                      73400010
STXENQCH EQU   11                       OFFSET TO STX ENQ SEQ.          73800010
LCBSECON EQU   X'01'                    GETMAIN SWITCH                  74400010
HDRLEN   EQU   26                       LENGTH OF TPER HEADER    S99238 75000010
EMSGLEN  EQU   32                       LENGTH OF ERROR MSG             75200010
ONE      EQU   1                        ONE                     SA65392 75300010
TWO      EQU   2                        TWO                             75400010
SEVEN    EQU   7                        SEVEN                           75600010
THREE    EQU   3                        THREE                           75800010
LINEEND  EQU   X'C2'                    SW TO RETURN CONTROL TO LINEEND 76000010
X01      EQU   1                        ONE                             76200010
EREXCP   EQU   15                       ERROR EXCP                      76400010
RETURN   EQU   3                        SVC 3                           76600010
XCTLADD  EQU   X'2C'                    DISP OF XCTL ADDRESS IN CVT     76800010
IOBOFFST EQU   4                        OFFSET OF IOB ADDR IN RQE       77000010
CVTPTR   EQU   16                       CVT POINTER ADDRESS             77400010
FIVE     EQU   5                        FIVE                            77800010
FOUR     EQU   4                        FOUR                            78200010
ZERO     EQU   0                                                 S99228 78206010
SOHRID   EQU   X'03'                    SOH%R TPER RECORD ID     S99228 78212010
X02      EQU   X'02'                    END OF  UNIT OR BUFFER   S99238 78220010
CUUOFF   EQU   12                       CUU OFFSET IN BUFFER     S99238 78240010
EBCDCUU  EQU   13                       OFFSET TO EBCIDIC CUU    S99238 78244010
SOHCHDR  EQU   15                       LENGTH OF SOH % C HDR    S99238 78248010
CDE2     EQU   X'40'                    MASTER CONSOLE           S99238 78252010
CDE8     EQU   X'01'                    TP CONSOLE               S99238 78256010
CDE10    EQU   X'40'                    MAINTANCE CONSOLE        S99238 78260010
BIT5     EQU   X'04'                    CODE 8                 @ZA02623 78265010
BIT6     EQU   X'02'                    CODE 2                 @ZA02623 78270010
BLANK    EQU   X'40'                    BLANK FOR CLEARING BUFFERS99238 78276010
WTOFLAGS DC    X'8000'                  MCS FLAGS                S99238 78280010
WTOENDFG DC    X'10000000'              DESCR AND ROUTE FLAGS    S99238 78320010
         EJECT                                                          78400010
         TAVTD                                                          78600010
         TDEBD                                                          78720010
         DCBD  DSORG=TX                                                 79000010
         TLCBD                                                          79200010
         TPRFD                                                          79400010
         TSCBD                                                          79600010
         TTRMD                                                          80000010
         IECDIOSB                                                Y02027 80060010
         IECDERWA EWTC                                                  80120010
TPERD    DSECT                                                          80200010
TPERTLEN DS    H                        TOTAL LENGTH OF GOTTEN CORE     80400010
         DS    H                        UNUSED                          80600010
*  THE FOLLOWING IS A DSECT OF THE BUFFER PASSED TO TPER, THE ADDRESS   80800010
* IS SAVED AT LCBTSTSW                                                  81000010
         ORG   TPERD                    RESET TO ZERO                   81200010
TPERBLEN DS    H                        LENGTH OF TPER BUFFER           81400010
TPERSW   DS    XL1                      SWITCHES                        81600010
TPERXCTL DS    XL2                      XCTL INFO                       81800010
TPERRDID DS    X                        RECORD IDENTITY                 82000010
         DS    18C                      USED FOR STD HEADER INFO        82200010
TPERCUU  DS    XL2                      CUU ADDRESS                     82400010
TPERDVED EQU   *                        START OF DEVICE DEPENDENT DATA  82600010
TPERSERN DS    XL2                      DEVICE SERIAL NO.               82800010
         END                                                            83000010
