         TITLE 'BLSR3270--BLSR327B--BUILD 3277 ORDER STREAM'            00005057
*---------------------------------------------------------------------* 00010057
*                                                                     * 00020057
*BLSR327B--BUILD 3277 ORDER STREAM--USE SAME BUFFER USED FOR TGET     * 00030057
*                                                                     * 00040057
*---------------------------------------------------------------------* 00050057
         SPACE                                                          00066057
BLSR327B LA    R8,LB000100        INITIALIZE RETURN REGISTER            00074057
         SPACE 2                                                        00082057
*---------------------------------------------------------------------* 00100000
*INITIALIZE THE OUTPUT BUFFER                                         * 00105057
*---------------------------------------------------------------------* 00110057
         SPACE                                                          00120057
LB000020 LA    RA,SCRNBUFR        ->TGET/TPUT BUFFER                    00130057
         TM    FLAG0,FLAG0FMT     ENTIRE SCREEN TO BE WRITTEN?          00140057
         BNO   LB000050           NO                                    00150057
         MVI   ERLN4,0            YES - RESET ERROR INDICATOR           00166057
         MVC   0(ERSWRTLN,RA),ERSWRT SEND ERASE/WRITE SEQUENCE          00174057
         LA    RA,ERSWRTLN(0,RA)  CORRECT BUFFER ADDRESS                00182057
LB000050 MVC   0(ESCWRTLN,RA),ESCWRITE                                  00188057
         TRT   NEWWCC(1),T3270TAB PICK UP CORRECT 3270 CHAR             00200057
         STC   R2,0(0,RA)         NOTE - R1 ALSO DESTROYED BY TRT       00216057
         LA    RA,ESCWRTLN(0,RA)  CORRECT BUFFER ADDRESS                00224057
         BR    R8                                                       00232057
         SPACE 2                                                        00238057
*---------------------------------------------------------------------* 00250057
*ADD ORDERS TO FORMAT THE SCREEN                                      * 00266057
*---------------------------------------------------------------------* 00274057
         SPACE                                                          00282057
LB000100 TM    FLAG0,FLAG0FMT     SELDOM NECESSARY, HOPEFULLY           00288057
         BNO   LB000200                                                 00300057
         MVC   0(ERASELEN,RA),ERASEALL  ERASE ENTIRE SCREEN             00316057
         LA    RA,ERASELEN(0,RA)                                        00324057
LB000200 MVC   0(RWL1ORLN,RA),RWL1ORDS  ALWAYS REWRITE                  00332057
         LA    RA,RWL1ORLN(0,RA)        -LINE 1                         00338057
         TM    FLAG0,FLAG0FMT           COMPLETE REWRITE?               00350057
         BNO   LB000500                 -NO                             00366057
         MVC   0(R2T4ORLN,RA),R2T4ORDS  LINE 2-3 ORDERS                 00374057
         MVC   R2T4ORLN(RWL4ORLN,RA),RWL4ORDS LINE 4 ORDERS             00382057
         LA    RA,R2T4ORLN+RWL4ORLN(0,RA) CORRECT BUFFER ADDRESS        00388057
         MVC   0(RWL5ORLN,RA),RWL5ORDS  LINE 5 ORDERS                   00400057
         LA    RA,RWL5ORLN(0,RA)  CORRECT BUFFER ADDRESS                00416057
         CLI   WKASKNUM,0         ANY ADDRESSES IN THE STACK?           00424057
         BE    LB000300           NO, NONE TO WRITE OUT                 00432057
         OI    FLAG0,FLAG0RW2     YES, NOTE IT FOR LATER                00438057
LB000300 CLI   WKANBNUM,0         HOW ABOUT THE NOTE LIST?              00450057
         BE    LB000400           NO                                    00466057
         OI    FLAG0,FLAG0RW3     YES, MARK IT FOR LATER                00474057
LB000400 MVI   FLAG1,FLAG1ADR+FLAG1ASI+FLAG1FMT+FLAG1ARE+FLAG1LIN+FLAG1*00482057
               SKP                BETTER LET HIM SEE ALL OF IT          00488057
         OC    WKALNCTL(19),=19AL1(WKALNCTW) MARK ALL TO BE WRITN       00500057
         SLR   RF,RF              IS SUBCMD/CLIST STRING NULL?          00516057
         ICM   RF,B'0001',WKABLSRN THIS IS COUNT OF CHARS               00524057
         BZ    LB000420           YES, NO STRING TO PUT OUT             00532057
         BCTR  RF,0               DECREMENT COUNT FOR EX                00538057
         MVC   0(ORDLNSBA,RA),RW5UCMOR POINT TO SCREEN ADDR             00550057
         EX    RF,IB005200        AND PUT DATA IN STREAM                00566057
         LA    RA,ORDLNSBA+1(RF,RA) CORRECT BUFFER ADDR                 00574057
         SPACE                                                          00582057
LB000420 BAL   R8,LA000500        PUT OUT THIS PART OF THE SCREEN       00588057
         LA    RA,SCRNBUFR        ->TGET/TPUT BUFFER                    00600057
         BAL   R8,LB000050        RESET OUTPUT BUFFER                   00616057
         EJECT                                                          00624057
*---------------------------------------------------------------------* 00632057
*ADD ORDERS TO DISPLAY MESSAGE                                        * 00638057
*---------------------------------------------------------------------* 00650057
         SPACE                                                          00666057
LB000500 L     R1,ZZ1P            ->ZZ1 (R1 NOT PERMANENT AS BASE)      00674057
         CLI   FLAG2,0            ANY MESSAGE NEEDED?                   00682057
         BE    LB000600           - NO                                  00688057
         MVC   0(ORDLNSBA,RA),RW1UMGOR ORDERS INTO SCREEN BUFFER        00700057
         LA    RA,ORDLNSBA(0,RA)      CORRECT BUFFER ADDR               00716057
         MVC   0(MSGSTKLN,RA),MSGSTK  MSG INTO BUFFER                   00724057
         LA    RA,MSGSTKLN(0,RA)      CORRECT BUFFER ADDR               00732057
         SPACE 2                                                        00738057
*---------------------------------------------------------------------* 00750057
*ADD ORDERS TO DISPLAY THE STACK, LINES 2, 3, AND 4 ON THE SCREEN     * 00766057
*---------------------------------------------------------------------* 00774057
         SPACE                                                          00782057
LB000600 TM    FLAG0,FLAG0RW2     ANY UPDATE NEEDED?                    00788057
         BNO   LB000900           NO                                    00800057
         MVC   0(ORDLNSBA,RA),RW2SBAOR POINT TO FIRST STACK ENTRY       00816057
         LA    RA,ORDLNSBA(0,RA)                                        00824057
         SLR   R8,R8              CLEAR FOR IC OF ACTIVE STACK ENTRY#   00832057
         IC    R8,WKASKNUM        FOR LOOP CONTROL                      00838057
         LTR   R8,R8              COULD HAVE JUST DELETED ALL ENTRIES   00850057
         BZ    LB000800           SO WILL NULL THEM OUT                 00866057
         LA    R9,WKASTACK        POINT TO MY COPY OF STACK             00874057
LB000700 UNPK  0(7,RA),1(4,R9)    POINTER=>ZONED HEXADECIMAL            00882057
         TR    0(6,RA),ZZ1TRHEX(R1) ZONED HEXADECIMAL=>EBCDIC           00888057
         MVI   6(RA),ORDERPT      TAB TO NEXT STACK FIELD               00900057
         LA    RA,7(0,RA)         UPDATE SCREEN ADDRESS                 00916057
         LA    R9,4(0,R9)         UPDATE STACK AREA ADDRESS             00924057
         BCT   R8,LB000700        LOOP TILL COUNT EXHAUSTED             00932057
         BCTR  RA,0               DON'T NEED LAST PT ORDER              00938057
LB000800 CLI   WKASKNUM,11        DO WE NEED THIS ERASE?                00950057
         BE    LB000900           NO                                    00966057
         MVC   0(ORDLNEUA,RA),ERASR2OR ORDERS INTO SCREEN BUFFR         00974057
         LA    RA,ORDLNEUA(0,RA)                                        00982057
LB000900 TM    FLAG0,FLAG0RW4     DO WE NEED LINE 4 ORDERS?             00988057
         BNO   LB000950           NO                                    01000057
         OI    FLAG1,FLAG1FMT+FLAG1ARE+FLAG1LIN REWRITE CONSTANTS       01016057
         MVC   0(RWL4ORLN,RA),RWL4ORDS LINE 4 ORDERS                    01024057
         LA    RA,RWL4ORLN(0,RA)  CORRECT BUFFER ADDRESS                01032057
LB000950 TM    FLAG0,FLAG0RW3     NEED TO UPDATE?                       01038057
         BNO   LB001200           NO                                    01050057
         MVC   0(ORDLNSBA,RA),RW3SBAOR ORDERS INTO BUFFER               01066057
         LA    RA,ORDLNSBA(0,RA)                                        01074057
         SLR   R8,R8              FOR IC                                01082057
         ICM   R8,B'0001',WKANBNUM NUMBER OF ACTIVE LIST ENTRIES        01088057
         BZ    LB001100           NO, NULL ROW                          01100057
         LA    R9,WKANB1          YES, POINT TO FIRST NOTE              01116057
LB001000 MVC   0(6,RA),0(R9)      DATA INTO ORDERS STREAM               01124057
         MVI   6(RA),ORDERPT      TAB TO NEXT FIELD                     01132057
         LA    RA,7(0,RA)         NEXT BUFFER POSITION                  01138057
         LA    R9,8(0,R9)         NEXT NOTE LIST ENTRY                  01150057
         BCT   R8,LB001000        TILL COUNT EXHAUSTED                  01166057
         BCTR  RA,0               DON'T NEED LAST PT                    01174057
         MVI   SCRPO,SCRPOAD1     REMEMBER WHERE WE ARE                 01182057
LB001100 CLI   WKANBNUM,11        ALREADY AT END                        01188057
         BE    LB001200           YES                                   01200057
         MVC   0(ORDLNEUA,RA),ERASR3OR NO, SET ORDERS UP                01216057
         LA    RA,ORDLNEUA(0,RA)                                        01224057
         MVI   SCRPO,SCRPOER3     NOT SAME AS SCRPOAD1---DIF RA         01232057
         EJECT                                                          01238057
*---------------------------------------------------------------------* 01250057
*ADD ORDERS TO DISPLAY LINE 4 ON THE SCREEN                           * 01266057
*---------------------------------------------------------------------* 01274057
         SPACE                                                          01282057
LB001200 TM    FLAG1,FLAG1ADR+FLAG1ASI+FLAG1FMT+FLAG1ARE+FLAG1LIN+FLAG1*01288057
               SKP                ANYTHING ON ROW 4 TO PUT OUT?         01300057
         BZ    LB003100           NO                                    01316057
         TM    FLAG1,FLAG1ADR     MUST ADDR BE UPDATED?                 01324057
         BNO   LB001500           NO                                    01332057
         CLI   SCRPO,SCRPOER3     ALREADY AT ADDR FIELD?                01338057
         BE    LB001400           YES                                   01350057
         CLI   SCRPO,SCRPOAD1     ARE WE ALMOST THERE?                  01366057
         BNE   LB001300           NO                                    01374057
         LA    RA,1(0,RA)         PAST PT IN BUFFER ALREADY             01382057
         B     LB001400           PUT DATA INTO SCREEN BUFFER           01388057
LB001300 MVC   0(ORDLNSBA,RA),RW4UADOR                                  01400057
         LA    RA,ORDLNSBA(0,RA)                                        01416057
LB001400 UNPK  0(7,RA),WKAADDR+1(4) POINTER=>ZONED HEXADECIMAL          01424057
         TR    0(6,RA),ZZ1TRHEX(R1) ZONED HEXADECIMAL=>EBCDIC           01432057
         MVI   SCRPO,SCRPOAD9     REMEMBER WHERE WE ARE                 01438057
         LA    RA,6(0,RA)         IN BUFFER, TOO                        01450057
LB001500 TM    FLAG1,FLAG1ASI     DO WE?                                01466057
         BNO   LB001800           NO                                    01474057
         CLI   SCRPO,SCRPOAD9     NEED AN SBA HERE?                     01482057
         BNE   LB001600           NO                                    01488057
         MVI   0(RA),ORDERPT      YES, TAB TO ASID FIELD                01500057
         LA    RA,1(0,RA)         UPDATE BUFFER ADDRESS                 01516057
         B     LB001700           GO DO IT                              01524057
LB001600 MVC   0(ORDLNSBA,RA),RW4UASOR POINT TO ASID FIELD              01532057
         LA    RA,ORDLNSBA(0,RA)                                        01538057
LB001700 UNPK  0(5,RA),WKAASID(3) BIT=>ZONED HEXADECIMAL                01550057
         TR    0(4,RA),ZZ1TRHEX(R1) ZONED HEXADECIMAL=>EBCDIC           01566057
         LA    RA,4(0,RA)                                               01574057
         MVI   SCRPO,SCRPOAS9     REMEMBER WHERE WE ARE                 01582057
LB001800 TM    FLAG1,FLAG1FMT     FORMAT NEED UPDATING? (X OR C)        01588057
         BNO   LB002100           NO, AREA ID NEXT ON SCREEN            01600057
         CLI   SCRPO,SCRPOAS9     IN THE RIGHT SPOT NOW?                01616057
         BNE   LB001900           NO                                    01624057
         MVI   0(RA),ORDERPT      YES, TAB TO FMT FIELD                 01632057
         LA    RA,1(0,RA)                                               01638057
         B     LB002000                                                 01650057
LB001900 MVC   0(ORDLNSBA,RA),RW4UFMOR NECESSARY ORDERS                 01666057
         LA    RA,ORDLNSBA(0,RA)                                        01674057
LB002000 MVC   0(1,RA),WKAFMT     FORMAT INTO DATA STREAM               01682057
         LA    RA,1(0,RA)                                               01688057
         MVI   SCRPO,SCRPOFM9     REMEMBER WHERE WE ARE                 01700057
LB002100 TM    FLAG1,FLAG1ARE     NEED AREA THIS TIME?                  01716057
         BNO   LB002400           NO                                    01724057
         CLI   SCRPO,SCRPOFM9     CORRECTLY POSITIONED?                 01732057
         BNE   LB002200           NO                                    01738057
         MVI   0(RA),ORDERPT      YES, TAB TO AREA FIELD                01750057
         LA    RA,1(0,RA)                                               01766057
         B     LB002300                                                 01774057
LB002200 MVC   0(ORDLNSBA,RA),RW4UAROR NECESSARY ORDERS                 01782057
         LA    RA,ORDLNSBA(0,RA)                                        01788057
LB002300 MVC   0(1,RA),WKAAREA    AREA INTO DATA STREAM                 01800057
         LA    RA,1(0,RA)                                               01816057
         MVI   SCRPO,SCRPOWI9     REMEMBER WHERE WE ARE                 01824057
LB002400 TM    FLAG1,FLAG1LIN     NEED LINES/AREA THIS TIME?            01832057
         BNO   LB002800           NO                                    01838057
         CLI   SCRPO,SCRPOWI9     CORRECTLY POSITIONED?                 01850057
         BNE   LB002500           NO                                    01866057
         MVI   0(RA),ORDERPT      YES, TAB TO AREA FIELD                01874057
         LA    RA,1(0,RA)                                               01882057
         B     LB002600                                                 01888057
LB002500 MVC   0(ORDLNSBA,RA),RW4ULNOR NECESSARY ORDERS                 01900057
         LA    RA,ORDLNSBA(0,RA)                                        01916057
LB002600 LA    R8,4               NUMBER OF ENTRIES                     01924057
         SLR   RF,RF              CLEAR FOR IC                          01932057
         LA    R9,WKALINES        START SOURCE ADDRESS                  01938057
LB002700 IC    RF,0(0,R9)         BINARY NUMBER OF LINES                01950057
         CVD   RF,PACKDEC         INTO PACKED DECIMAL                   01966057
         UNPK  0(2,RA),PACKDEC+6(2) INTO DATA STREAM                    01974057
         OI    1(RA),C'0'         MAKE LAST DIGIT NUMBERIC              01982057
         MVI   2(RA),ORDERPT      TAB TO NEXT FIELD ON SCREEN           01988057
         LA    R9,1(0,R9)         UPDATE TO NEXT AREA                   02000057
         LA    RA,3(0,RA)                                               02016057
         BCT   R8,LB002700        PUT THEM ALL IN                       02024057
         BCTR  RA,0               IN CASE WE DON'T NEED PT TO SKIP      02032057
         MVI   SCRPO,SCRPOPT9     REMEMBER WHERE WE ARE                 02038057
LB002800 TM    FLAG1,FLAG1SKP     NEED SKIP VALUE THIS TIME?            02050057
         BNO   LB003100           NO, END OF ROW 4 OF SCREEN            02066057
         CLI   SCRPO,SCRPOPT9     CORRECTLY POSITIONED?                 02074057
         BNE   LB002900           NO                                    02082057
         LA    RA,1(0,RA)                                               02088057
         B     LB003000           TO SET UP THE SKIP VALUE              02100057
LB002900 MVC   0(ORDLNSBA,RA),RW4USPOR POINT TO SKIP FIELD              02116057
         LA    RA,ORDLNSBA(0,RA)                                        02124057
LB003000 UNPK  0(7,RA),WKASKIP+1  POINTER=>ZONED HEXADECIMAL            02132057
         TR    0(6,RA),ZZ1TRHEX(R1) ZONED HEXADECIMAL=>EBCDIC           02138057
         LA    RA,6(0,RA)                                               02150057
         EJECT                                                          02166057
*---------------------------------------------------------------------* 02174057
*ADD ORDERS TO DISPLAY AREAS A, B, C, AND D                           * 02182057
*                                                                     * 02188057
*        THIS ROUTINE IS DRIVEN BY A 19-BYTE VECTOR IN THE WORKAREA,  * 02200057
*        SET BY THE FIELD DEFINITION ANALYSIS ROUTINE AND UPDATED BY  * 02216057
*        THE VARIOUS 'COMMAND' PROCESSORS.  A CHANGE IN FIELD         * 02224057
*        DEFINITION WILL CAUSE ALL LOWER LINES IN THE SCREEN TO BE    * 02232057
*        REWRITTEN; A CHANGE IN THE ACTIVE AREA, OR A NEW EFFECTIVE   * 02238057
*        ADDRESS, WILL CAUSE ONLY THE ACTIVE AREA TO BE UPDATED.      * 02250057
*                                                                     * 02266057
*---------------------------------------------------------------------* 02274057
         SPACE                                                          02282057
LB003100 MVI   SCRPO,0            POSITION NO LONGER USEFUL             02288057
         SLR   R6,R6              TO START LOOP                         02300057
         SLR   R2,R2              FOR IC'S IN LOOP                      02316057
         MVC   WKAVCTB(4*4),WKAVCTA COPY CURRENT START ADDRESSES        02324057
         NI    FLAG0,255-(FLAG0POK+FLAG0NUL) OFF TO START WITH          02332057
LB003200 IC    R2,WKALNCTL(R6)    VECTOR INTO AREA TABLE                02338057
         LA    RF,255-WKALNCTW    UPDATE FLAG                           02350057
         CLR   R2,RF              NEED TO UPDATE THIS LINE?             02366057
         BNH   LB004600           NO                                    02374057
         NR    R2,RF              NULL LINE REQUIRED?                   02382057
         BZ    LB004300           YES                                   02388057
         SPACE 2                                                        02400057
*---------------------------------------------------------------------* 02416057
*        THINK WE NEED TO WRITE SOMETHING-- BUT WHAT? FIRST MAKE SURE * 02424057
*        THERE REALLY IS SOMETHING IN THIS AREA TO WRITE. IF SO,      * 02432057
*        CHECK THAT BUFFER ADDRESS IS CORRECT, AND THAT WE DON'T      * 02438057
*        NEED TO COMPLETE A NULL LINE OR AREA.                        * 02450057
*---------------------------------------------------------------------* 02466057
         SPACE                                                          02474057
         BCTR  R2,0               FORM ZERO ORIGIN INDEX                02482057
         SLL   R2,2               *(2**2=4) FOR WORD ARRAY              02488057
         LA    RF,WKAVCTA(R2)     PROPER CONTROL WORD FOR THIS AREA     02500057
         TM    35(RF),WKAVCTAI    HAS FIELD EVER BEEN USED?             02516057
         BO    LB004300           NO, CAN'T HAVE DATA TO WRITE THERE    02524057
         SPACE 2                                                        02532057
*---------------------------------------------------------------------* 02538057
*        AN ACTIVE AREA NEEDS UPDATING --- PERFORM SCREEN BUFFER      * 02550057
*        ADDRESS HOUSEKEEPING.                                        * 02566057
*---------------------------------------------------------------------* 02574057
         SPACE                                                          02582057
         TM    FLAG0,FLAG0POK+FLAG0NUL HOW DOES BUFFER LOOK NOW?        02588057
         BM    LB003500           POSITIONED OK, AND NEED NO NULLS      02600057
         LA    RE,0(R6,R6)        FORM INDEX INTO BUFFER ADDR TAB       02616057
         MVI   0(RA),ORDERSBA     ASSUME SET BUFFER ADDR ORDER NEEDED   02624057
         BZ    LB003300           DON'T NEED NULLS                      02632057
         MVC   0(2,RA),PROTAREA   ESTABLISH PROTECTED FIELD             02638057
         LA    RA,2(RA)           CORRECT BUFFER ADDRESS                02650057
         MVI   0(RA),ORDERRA      NEED REPEAT-TO-ADDRESS ORDER          02666057
LB003300 LH    RE,BUFADTAB(RE)    BUFFER ADDRESS TO USE                 02674057
         STCM  RE,B'0011',1(RA)   PUT IT INTO SCREEN STREAM             02682057
         BZ    LB003400                                                 02688057
         MVI   3(RA),0            INSERT NULL INTO STREAM               02700057
         LA    RA,1(0,RA)         ACCOUNT FOR NULL INSERTED             02716057
         NI    FLAG0,255-FLAG0NUL RESET NULL NEEDED                     02724057
LB003400 LA    RA,ORDLNSBA(0,RA)  HOUSEKEEPING COMPLETE                 02732057
         OI    FLAG0,FLAG0POK     SAY SO                                02738057
         SPACE 2                                                        02750057
*---------------------------------------------------------------------* 02766057
*        SET UP CORRECT ATTRIBUTE BYTE FOR THIS LINE. INTENSIFY THE   * 02774057
*        FIRST LINE IN EACH WINDOW                                    * 02782057
*---------------------------------------------------------------------* 02788057
         SPACE                                                          02800057
LB003500 MVC   SAVELATR,NORMAREA+1  ASSUME INTENSIFY NOT NEEDED         02816057
         MVC   0(2,RA),NORMAREA   DEFINE THE START OF A FIELD           02824057
         CLC   0(4,RF),4*4(RF)    AT FIRST LINE OF FIELD?               02832057
         BNE   LB003600           -NO                                   02838057
         MVI   SAVELATR,INTENSE   -YES, SAVE FOR LATER FIELDS           02850057
         MVC   1(1,RA),SAVELATR   SET CORRECT ATTRIBUTE                 02866057
LB003600 CLI   34(RF),C'C'        CHARACTER FORMATTING NEEDED?          02874057
         BE    LB004800           YES                                   02882057
         SPACE 2                                                        02888057
*---------------------------------------------------------------------* 02900057
*        FORMAT A HEXADECIMAL DISPLAY LINE                            * 02916057
*---------------------------------------------------------------------* 02924057
         SPACE                                                          02932057
         L     RE,4*4(RF)         PICK UP CURRENT ADDRESS               02938057
         ST    RE,PACKDEC         INTO WORK AREA FOR UNPACKING, ETC     02950057
         N     RE,=X'FFFFFFE0'    ROUND DOWN TO BOUNDARY                02966057
         ST    RE,PACKDEC+4       ADDRESS TO ASK PRDMP FOR              02974057
         LR    R0,RE              SAVE PARAMETER FOR PRDMP STG ACCESS   02982057
         L     R1,ZZ1P            ->ZZ1                                 02988057
         UNPK  2(7,RA),PACKDEC+5(4) POINTER=>ZONED HEXADECIMAL          03000057
         TR    2(6,RA),ZZ1TRHEX(R1) ZONED HEXADECIMAL=>EBCDIC           03010057
         SPACE 2                                                        03020057
*---------------------------------------------------------------------* 03030057
*        RETRIEVE DUMP DATA                                           * 03040057
*---------------------------------------------------------------------* 03050057
         SPACE                                                          03066057
         L     R1,ZZ2P            ->ZZ2                                 03074057
         MVC   ZZ2AMDA(2,R1),32(RF) ASID                                03082057
         L     RF,ZZ2AMDS(0,R1)   ->BLSRACCL                            03088057
         BALR  RE,RF              CALL BLSRACCL                         03100057
         LTR   RF,RF              DATA IN DUMP?                         03116057
         BNZ   LB004200           NO                                    03124057
         LR    R9,R0              ->DUMP DATA BUFFER                    03132057
         L     R0,PACKDEC         CALCULATE INDENTATION ON LINE         03138057
         S     R0,PACKDEC+4       FROM NUMBER OF BYTES                  03150057
         SRA   R0,2               WORDS = BYTES/(4=2**2)                03166057
         LA    RE,LB003800        SET RETURN ADDR FROM INDENT SUBRTNE   03174057
         BNZ   LB003700           R0 NOT ZERO - MUST DO INDENT          03182057
         XC    8(1,RA),8(RA)      NULL ONE BYTE AFTER SF,               03188057
         LA    RA,9(0,RA)         ATTR, AND DATA ADDR. UP               03200057
         BR    RE                 STREAM ADDRESS, AND BYPASS SUBR.      03216057
         SPACE 2                                                        03224057
*---------------------------------------------------------------------* 03232057
*        CALCULATE BUFFER ADDRESS TO INDENT TO                        * 03238057
*              USED AS SUBROUTINE BY CHARACTER DATA FORMAT, TOO       * 03250057
*---------------------------------------------------------------------* 03266057
         SPACE                                                          03274057
LB003700 MVI   8(RA),ORDERRA      START REPT-TO-ADDR ORDER SEQUENCE     03282057
         LR    R5,R0              INPUT IS NUMBER OF 'WORDS' TO INDENT  03288057
         MH    R5,=H'9'           8 BYTES + 1 SEPARATOR PER 'WORD'      03300057
         AH    R5,=H'8'           ADDR FIELD TAKES 1 ATTR, 6 BYTES, 1   03316057
*                                 SEPARATOR                             03324057
         LA    R4,5(0,R6)         ZERO ORIGIN ROW NUMBER                03332057
         MH    R4,=H'80'          EIGHTY POSITIONS PER ROW              03338057
         ALR   R4,R5              FORM BINARY SCREEN POSITION, 0-ORIGN  03350057
         SRDL  R4,6               DIVIDE BY (64=2**6)                   03366057
         SRL   R5,26              AND SAVE REMAINDER                    03374057
         IC    R4,T3270TAB(R4)                                          03382057
         IC    R5,T3270TAB(R5)                                          03388057
         STC   R4,9(0,RA)         FIRST ADDR BYTE                       03400057
         STC   R5,10(0,RA)        SECOND ADDR BYTE                      03416057
         MVI   11(RA),0           NULL CHARACTER INTO STREAM            03424057
         LA    RA,12(0,RA)        UPDATE SCREEN BUFFER ADDR             03432057
         BR    RE                 RETURN TO CHAR FMT, OR TO NSI         03438057
LB003800 LA    R8,8               MAX WORDS PER LINE                    03450057
         SLR   R8,R0              LESS NUMBER SKIPPED                   03466057
         SLL   R0,2               WORDS*(4=2**2) = BYTES TO SKIP        03474057
         ALR   R9,R0              WHERE TO FETCH DUMP DATA FROM         03482057
         L     R1,ZZ1P            ->ZZ1                                 03488057
LB003900 MVC   0(2,RA),NORMAREA   DEFINE THE START OF A FIELD           03500057
         MVC   1(1,RA),SAVELATR   SET CORRECT ATTRIBUTE                 03516057
         UNPK  2(9,RA),0(5,R9)    BIT=>ZONED HEXADECIMAL                03524057
         TR    2(8,RA),ZZ1TRHEX(R1) ZONED HEXADECIMAL=>EBCDIC           03532057
         LA    RA,10(0,RA)        NEXT BUFFER POSITION                  03538057
         LA    R9,4(0,R9)         NEXT DUMP DATA POSITION               03550057
         BCT   R8,LB003900        DO ALL WORDS FOR THIS LINE            03566057
         SPACE 2                                                        03574057
*---------------------------------------------------------------------* 03582057
*        FINISHED PROCESSING CURRENT LINE--UPDATE INDEX AND CONTINUE  * 03588057
*        LOOP                                                         * 03600057
*---------------------------------------------------------------------* 03616057
         SPACE                                                          03624057
LB004100 CH    R6,=H'18'          OUT OF VECTOR?                        03632057
         BNL   LB004150           YES                                   03638057
         IC    R2,WKALNCTL(R6)    VECTOR INTO AREA TABLE                03650057
         LA    RF,255-WKALNCTW    CLEAR OUT REWRITE                     03666057
         NR    R2,RF               FLAG                                 03674057
         BZ    LB004125           NULL LINE                             03682057
         BCTR  R2,0               FORM ZERO ORIGIN INDEX                03688057
         SLL   R2,2               *(2**2=4) FOR WORD ARRAY              03700057
         LA    RF,WKAVCTA(R2)     PROPER CONTROL WORD FOR THIS AREA     03716057
         L     RE,4*4(RF)         PICK UP CURRENT ADDRESS               03724057
         CLI   34(RF),C'X'        IS IT HEX?                            03732057
         BNE   LB004110           NO                                    03738057
         N     RE,=X'FFFFFFE0'    ROUND DOWN TO HEX BOUNDARY            03750057
         LA    RE,32(0,RE)        ADD HEX BOUNDARY VALUE=LINE LENGTH    03766057
         B     LB004120                                                 03774057
LB004110 N     RE,=X'FFFFFFC0'    ROUND DOWN TO CHAR BOUNDARY           03782057
         LA    RE,64(0,RE)        ADD CHAR BOUNDARY VALUE=LINE LENGTH   03788057
LB004120 ST    RE,16(0,RF)        SAVE FOR NEXT PASS THIS AREA          03800057
LB004125 LA    R6,1(0,R6)         INCREMENT ROW INDEX                   03816057
         B     LB003200           CONTINUE ROW LOOP                     03824057
LB004150 TM    FLAG0,FLAG0NUL     NEED TO NULL REST OF SCREEN?          03832057
         BNO   LB005300           NO                                    03838057
         MVC   0(2,RA),PROTAREA   ESTABLISH PROTECTED FIELD             03850057
         MVC   2(ORDLNRA,RA),RW6RAORD NULL TO 0,0                       03866057
         LA    RA,ORDLNRA+2(0,RA) CORRECT BUFFER ADDRESS                03874057
         B     LB005300                                                 03882057
         SPACE 2                                                        03888057
*---------------------------------------------------------------------* 03900057
*        UNABLE TO ACCESS DATA FOR THIS LINE - ADDRESS OF DATA IS     * 03916057
*        ALREADY IN SCREEN STREAM                                     * 03924057
*---------------------------------------------------------------------* 03932057
         SPACE                                                          03938057
LB004200 MVC   8(4,RA),=C' N/A'   RIGHT NEXT TO ADDRESS                 03950057
         LA    RA,12(0,RA)        UPDATE BUFFER PTR                     03966057
         OI    FLAG0,FLAG0NUL+FLAG0POK                                  03974057
         B     LB004100                                                 03982057
         SPACE 2                                                        03988057
*---------------------------------------------------------------------* 04000057
*        NEED TO WRITE A NULL LINE--EITHER A SEPARATOR BETWEEN FIELDS * 04016057
*        OR A LINE IN AN UNUSED AREA                                  * 04024057
*---------------------------------------------------------------------* 04032057
         SPACE                                                          04038057
LB004300 TM    FLAG0,FLAG0POK+FLAG0NUL ALREADY NULLING SCREEN?          04050057
         BO    LB004100           YES                                   04066057
         BM    LB004400           NO, BUT POSITION IS OK                04074057
         MVI   0(RA),ORDERSBA     SBA TO THIS LINE ADDR                 04082057
         LA    RE,0(R6,R6)        FORM INDEX INTO ARRAY                 04088057
         LH    RE,BUFADTAB(RE)    AND ACCESS 3270 LINE ADDR             04100057
         STCM  RE,B'0011',1(RA)   ADDR INTO STREAM                      04116057
         LA    RA,ORDLNSBA(0,RA)  UPDATE BUFFER ADDRESS                 04124057
LB004400 OI    FLAG0,FLAG0POK+FLAG0NUL POS. OK, NULLS NEEDED            04132057
         B     LB004100           CHECK NEXT ROW                        04138057
         SPACE 2                                                        04150057
*---------------------------------------------------------------------* 04166057
*        AT A LINE NOT TO BE UPDATED. CHECK IF NULLIFICATION NEEDED   * 04174057
*        AT THIS POINT, AND IF SO, IF LINE CONTAINS USEFUL DATA TO    * 04182057
*        BE LEFT ON THE SCREEN.                                       * 04188057
*---------------------------------------------------------------------* 04200057
         SPACE                                                          04216057
LB004600 TM    FLAG0,FLAG0POK+FLAG0NUL ANYTHING PENDING?                04224057
         BZ    LB004100           NO                                    04232057
         BO    LB004700           YES, CHECK IF ANY DATA ON SCREEN      04238057
         NI    FLAG0,255-FLAG0POK BUFFER NO LONGER SET UP               04250057
         B     LB004100                                                 04266057
         SPACE 2                                                        04274057
*---------------------------------------------------------------------* 04282057
*        BOTH FLAG0NUL AND FLAG0POK ON, CHECK IF WE CAN LEAVE         * 04288057
*        THEM ON, OR MUST WE BYPASS THIS SCREEN LINE.                 * 04300057
*---------------------------------------------------------------------* 04316057
         SPACE                                                          04324057
LB004700 LTR   R2,R2              IS THIS LINE ALREADY NULL?            04332057
         BZ    LB004100           YES                                   04338057
         BCTR  R2,0               NO, FORM INDEX VALUE INTO AREA        04350057
         SLL   R2,2               *(4=2**2) CONTROL VECTORS             04366057
         LA    RF,WKAVCTA(R2)                                           04374057
         TM    35(RF),WKAVCTAI    ANYTHING IN THE AREA?                 04382057
         BO    LB004100           NO                                    04388057
         MVC   0(2,RA),PROTAREA   ESTABLISH PROTECTED FIELD             04400057
         LA    RA,2(RA)           CORRECT BUFFER AREA                   04416057
         MVI   0(RA),ORDERRA      INSERT REPEAT-TO ADDRESS ORDER        04424057
         LA    RE,0(R6,R6)        FORM INDEX TO BUFADTAB                04432057
         LH    RE,BUFADTAB(RE)    PICK UP SCREEN ADDR                   04438057
         STCM  RE,B'0011',1(RA)   PUT IT INTO SCREEN STREAM             04450057
         MVI   3(RA),0            PUT A NULL TO COMPLETE ORD SEQ        04466057
         LA    RA,ORDLNRA(0,RA)   UPDATE BUFFER PTR                     04474057
         NI    FLAG0,255-(FLAG0POK+FLAG0NUL) RESET SWITCHES             04482057
         B     LB004100           CHECK NEXT LINE                       04488057
         SPACE 2                                                        04500057
*---------------------------------------------------------------------* 04516057
*        FORMAT A CHARACTER LINE ON THE SCREEN                        * 04524057
*---------------------------------------------------------------------* 04532057
         SPACE                                                          04538057
LB004800 L     RE,4*4(0,RF)       CURRENT ADDR FOR THIS AREA            04550057
         ST    RE,PACKDEC         INTO WORK AREA                        04566057
         N     RE,=X'FFFFFFC0'    DOWN TO PROPER BOUNDARY               04574057
         ST    RE,PACKDEC+4       ADDRESS TO REQUEST                    04582057
         LR    R0,RE              PARM FOR PRINT-DUMP                   04588057
         L     R1,ZZ1P            ->ZZ1                                 04600057
         UNPK  2(7,RA),PACKDEC+5(4) ADDRESS INTO SCREEN STREAM          04616057
         TR    2(6,RA),ZZ1TRHEX(R1) ZONED HEXADECIMAL=>EBCDIC           04624057
         L     R1,ZZ2P            ->ZZ2                                 04632057
         MVC   ZZ2AMDA(2,R1),32(RF) ASID                                04638057
         L     RF,ZZ2AMDS(0,R1)   ->BLSRACCL                            04650057
         BALR  RE,RF              CALL BLSRACCL                         04666057
         LTR   RF,RF              DUMP DATA AVAILABLE?                  04674057
         BNZ   LB004200           NO                                    04682057
         LR    R9,R0              PRESERVE 'REAL' DATA ADDR             04688057
         L     R0,PACKDEC         CALCULATE INDENTATION, IF ANY         04700057
         S     R0,PACKDEC+4       FROM BYTES TO SKIP                    04716057
         SRA   R0,3               BYTES/(8=2**3) = 'WORDS' TO SKIP      04724057
         BNZ   LB004900           SOME                                  04732057
         XC    8(2,RA),8(RA)      NULL TWO POSITIONS                    04738057
         LA    RA,10(0,RA)        POINT TO NEXT STREAM POSITION         04750057
         B     LB005000                                                 04766057
LB004900 BAL   RE,LB003700        SET UP SKIP ORDERS                    04774057
         MVI   0(RA),0            INSERT NULL FOR FIRST SEPARATOR       04782057
         LA    RA,1(RA)           CORRECT BUFFER ADDRESS                04788057
LB005000 LA    R8,8               SET UP TRANSLATE LOOP                 04800057
         SLR   R8,R0              WORDS LEFT AFTER INDENT               04816057
         SLL   R0,3               *(8=2**3) = BYTES TO SKIP             04824057
         ALR   R9,R0              WHERE TO FETCH FIRST DATA FROM        04832057
         L     R1,ZZ1P            ->ZZ1                                 04838057
LB005100 MVC   0(8,RA),0(R9)      DATA INTO SCREEN STREAM               04850057
         TR    0(8,RA),ZZ1TREBC(R1) NON-ALPHAMERIC TO BLANKS            04866057
         MVI   8(RA),C'|'         INSERT SEPARATOR BETWEEN 'WORDS'      04874057
         LA    R9,8(0,R9)         UPDATE DATA SOURCE ADDRESS            04882057
         LA    RA,9(0,RA)         UPDATE DATA TARGET ADDRESS            04888057
         BCT   R8,LB005100        PROCESS ALL 'WORDS' THIS LINE         04900057
         BCTR  RA,0               DON'T NEED FINAL SEPARATOR            04916057
         B     LB004100           GET A NEW DATA ROW                    04924057
IB005200 MVC   ORDLNSBA(0,RA),WKABLSRC *** SUBJ OF EX INSTR ***         04932057
         SPACE 2                                                        04938057
*---------------------------------------------------------------------* 04950057
*ADD AN INSERT-CURSOR ORDER                                           * 04960057
*---------------------------------------------------------------------* 04968057
         SPACE                                                          04976057
LB005300 MVC   0(4,RA),WKACORDS                                         04984057
         LA    RA,4(0,RA)         CORRECT BUFFER ADDRESS                04992057
         LA    R8,LA000700        SET UP TPUT RETURN ADDRESS            05010057
